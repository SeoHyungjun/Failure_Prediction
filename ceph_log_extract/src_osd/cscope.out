cscope 15 $HOME/Failure_Prediction/ceph_log_extract/src_osd               0002756966
	@osd/ClassHandler.cc

4 
	~"šşude/ty³s.h
"

5 
	~"CÏssHªdËr.h
"

6 
	~"commÚ/”ºo.h
"

7 
	~"commÚ/ûph_cÚ‹xt.h
"

9 
	~<dlfú.h
>

11 
	~<m­
>

13 #ià
defšed
(
__F»eBSD__
)

14 
	~<sys/·¿m.h
>

17 
	~"commÚ/cÚfig.h
"

18 
	~"commÚ/debug.h
"

20 
	#dout_subsys
 
ûph_subsys_osd


	)

21 #undeà
dout_´efix


22 
	#dout_´efix
 *
_dout


	)

25 
	#CLS_PREFIX
 "libşs_"

	)

26 
	#CLS_SUFFIX
 ".so"

	)

29 
	gCÏssHªdËr
::
	$add_embedded_şass
(cÚ¡ 
¡ršg
& 
úame
)

31 
	`as£¹
(
mu‹x
.
	`is_locked
());

32 
CÏssD©a
 *
şs
 = 
	`_g‘_şass
(
úame
, 
çl£
);

33 
	`as£¹
(
şs
->
¡©us
 =ğ
CÏssD©a
::
CLASS_UNKNOWN
);

34 
şs
->
¡©us
 = 
CÏssD©a
::
CLASS_INITIALIZING
;

35 
	}
}

37 
	gCÏssHªdËr
::
	$İ’_şass
(cÚ¡ 
¡ršg
& 
úame
, 
CÏssD©a
 **
pşs
)

39 
Mu‹x
::
Lock”
 
	`lock
(
mu‹x
);

40 
CÏssD©a
 *
şs
 = 
	`_g‘_şass
(
úame
, 
Œue
);

41 ià(!
şs
)

42  -
EPERM
;

43 ià(
şs
->
¡©us
 !ğ
CÏssD©a
::
CLASS_OPEN
) {

44 
r
 = 
	`_lßd_şass
(
şs
);

45 ià(
r
)

46  
r
;

48 *
pşs
 = 
şs
;

50 
	}
}

52 
	gCÏssHªdËr
::
	$İ’_®l_şas£s
()

54 
	`ldout
(
cù
, 10è<< 
__func__
 << 
d’dl
;

55 
DIR
 *
dœ
 = ::
	`İ’dœ
(
cù
->
_cÚf
->
osd_şass_dœ
.
	`c_¡r
());

56 ià(!
dœ
)

57  -
”ºo
;

59 
dœ’t
 *
pde
 = 
nuÎ±r
;

60 
r
 = 0;

61 (
pde
 = ::
	`»addœ
(
dœ
))) {

62 ià(
pde
->
d_Çme
[0] == '.')

64 ià(
	`¡¾’
(
pde
->
d_Çme
è> (
CLS_PREFIX
è- 1 + (
CLS_SUFFIX
) - 1 &&

65 
	`¡ºcmp
(
pde
->
d_Çme
, 
CLS_PREFIX
, (CLS_PREFIX) - 1) == 0 &&

66 
	`¡rcmp
(
pde
->
d_Çme
 + 
	`¡¾’
Õde->d_Çmeè- ((
CLS_SUFFIX
) - 1), CLS_SUFFIX) == 0) {

67 
úame
[
PATH_MAX
 + 1];

68 
	`¡ºıy
(
úame
, 
pde
->
d_Çme
 + (
CLS_PREFIX
) - 1, (cname) -1);

69 
úame
[
	`¡¾’
(úameè- ((
CLS_SUFFIX
) - 1)] = '\0';

70 
	`ldout
(
cù
, 10è<< 
__func__
 << " found " << 
úame
 << 
d’dl
;

71 
CÏssD©a
 *
şs
;

73 
r
 = 
	`İ’_şass
(
úame
, &
şs
);

74 ià(
r
 < 0 &&„ !ğ-
EPERM
)

75 
out
;

78 
out
:

79 
	`şo£dœ
(
dœ
);

80  
r
;

81 
	}
}

83 
	gCÏssHªdËr
::
	$shutdown
()

85 auto& 
şs
 : 
şas£s
) {

86 ià(
şs
.
£cÚd
.
hªdË
) {

87 
	`dlşo£
(
şs
.
£cÚd
.
hªdË
);

90 
şas£s
.
	`ş—r
();

91 
	}
}

100 
boŞ
 
	gCÏssHªdËr
::
	$š_şass_li¡
(cÚ¡ 
¡d
::
¡ršg
& 
úame
,

101 cÚ¡ 
¡d
::
¡ršg
& 
li¡
)

103 
¡d
::
i¡ršg¡»am
 
	`ss
(
li¡
);

104 
¡d
::
i¡»am_™”©Ü
<¡d::
¡ršg
> 
begš
{
ss
};

105 
¡d
::
i¡»am_™”©Ü
<¡d::
¡ršg
> 
’d
{};

107 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> 
rg‘s
{
úame
, "*"};

109 autØ
™
 = 
¡d
::
	`fšd_fœ¡_of
(
begš
, 
’d
,

110 
rg‘s
.
	`begš
(),¬g‘s.
	`’d
());

112  
™
 !ğ
’d
;

113 
	}
}

115 
	gCÏssHªdËr
::
CÏssD©a
 *
CÏssHªdËr
::
	$_g‘_şass
(cÚ¡ 
¡ršg
& 
úame
,

116 
boŞ
 
check_®lowed
)

118 
CÏssD©a
 *
şs
;

119 
m­
<
¡ršg
, 
CÏssD©a
>::
™”©Ü
 
™”
 = 
şas£s
.
	`fšd
(
úame
);

121 ià(
™”
 !ğ
şas£s
.
	`’d
()) {

122 
şs
 = &
™”
->
£cÚd
;

124 ià(
check_®lowed
 && !
	`š_şass_li¡
(
úame
, 
cù
->
_cÚf
->
osd_şass_lßd_li¡
)) {

125 
	`ldout
(
cù
, 0è<< "_g‘_şas nÙ…”m™‹dØlßd " << 
úame
 << 
d’dl
;

126  
NULL
;

128 
şs
 = &
şas£s
[
úame
];

129 
	`ldout
(
cù
, 10è<< "_g‘_şas addšg‚ew cÏs Çm" << 
úame
 << " " << 
şs
 << 
d’dl
;

130 
şs
->
Çme
 = 
úame
;

131 
şs
->
hªdËr
 = 
this
;

132 
şs
->
wh™–i¡ed
 = 
	`š_şass_li¡
(
úame
, 
cù
->
_cÚf
->
osd_şass_deçuÉ_li¡
);

134  
şs
;

135 
	}
}

137 
	gCÏssHªdËr
::
	$_lßd_şass
(
CÏssD©a
 *
şs
)

140 ià(
şs
->
¡©us
 =ğ
CÏssD©a
::
CLASS_OPEN
)

143 ià(
şs
->
¡©us
 =ğ
CÏssD©a
::
CLASS_UNKNOWN
 ||

144 
şs
->
¡©us
 =ğ
CÏssD©a
::
CLASS_MISSING
) {

145 
âame
[
PATH_MAX
];

146 
	`¢´štf
(
âame
, (âame), "%s/" 
CLS_PREFIX
 "%s" 
CLS_SUFFIX
,

147 
cù
->
_cÚf
->
osd_şass_dœ
.
	`c_¡r
(),

148 
şs
->
Çme
.
	`c_¡r
());

149 
	`ldout
(
cù
, 10è<< "_lßd_şas " << 
şs
->
Çme
 << " from " << 
âame
 << 
d’dl
;

151 
şs
->
hªdË
 = 
	`dlİ’
(
âame
, 
RTLD_NOW
);

152 ià(!
şs
->
hªdË
) {

153 
¡©
 
¡
;

154 
r
 = ::
	`¡©
(
âame
, &
¡
);

155 ià(
r
 < 0) {

156 
r
 = -
”ºo
;

157 
	`ldout
(
cù
, 0è<< 
__func__
 << " could‚Ù sˆşas " << 
âame


158 << ": " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

160 
	`ldout
(
cù
, 0è<< "_lßd_şas could‚Ù o³Àşas " << 
âame


161 << " (dlİ’ faed): " << 
	`dË¼Ü
(è<< 
d’dl
;

162 
r
 = -
EIO
;

164 
şs
->
¡©us
 = 
CÏssD©a
::
CLASS_MISSING
;

165  
r
;

168 
şs_d•s_t
 *(*
şs_d•s
)();

169 
şs_d•s
 = (
şs_d•s_t
 *(*)())
	`dlsym
(
şs
->
hªdË
, "class_deps");

170 ià(
şs_d•s
) {

171 
şs_d•s_t
 *
d•s
 = 
	`şs_d•s
();

172 
d•s
) {

173 ià(!
d•s
->
Çme
)

175 
CÏssD©a
 *
şs_d•
 = 
	`_g‘_şass
(
d•s
->
Çme
, 
çl£
);

176 
şs
->
d•’d’c›s
.
	`š£¹
(
şs_d•
);

177 ià(
şs_d•
->
¡©us
 !ğ
CÏssD©a
::
CLASS_OPEN
)

178 
şs
->
missšg_d•’d’c›s
.
	`š£¹
(
şs_d•
);

179 
d•s
++;

185 
£t
<
CÏssD©a
*>::
™”©Ü
 
p
 = 
şs
->
missšg_d•’d’c›s
.
	`begš
();

186 
p
 !ğ
şs
->
missšg_d•’d’c›s
.
	`’d
()) {

187 
CÏssD©a
 *
dc
 = *
p
;

188 
r
 = 
	`_lßd_şass
(
dc
);

189 ià(
r
 < 0) {

190 
şs
->
¡©us
 = 
CÏssD©a
::
CLASS_MISSING_DEPS
;

191  
r
;

194 
	`ldout
(
cù
, 10è<< "_lßd_şas " << 
şs
->
Çme
 << " s©isf›d d•’d’cy " << 
dc
->Çm<< 
d’dl
;

195 
şs
->
missšg_d•’d’c›s
.
	`”a£
(
p
++);

199 (*
şs_š™
)(èğ((*)())
	`dlsym
(
şs
->
hªdË
, "__cls_init");

200 ià(
şs_š™
) {

201 
şs
->
¡©us
 = 
CÏssD©a
::
CLASS_INITIALIZING
;

202 
	`şs_š™
();

205 
	`ldout
(
cù
, 10è<< "_lßd_şas " << 
şs
->
Çme
 << " sucûss" << 
d’dl
;

206 
şs
->
¡©us
 = 
CÏssD©a
::
CLASS_OPEN
;

208 
	}
}

212 
	gCÏssHªdËr
::
CÏssD©a
 *
CÏssHªdËr
::
	$»gi¡”_şass
(cÚ¡ *
úame
)

214 
	`as£¹
(
mu‹x
.
	`is_locked
());

216 
CÏssD©a
 *
şs
 = 
	`_g‘_şass
(
úame
, 
çl£
);

217 
	`ldout
(
cù
, 10è<< "»gi¡”_şas " << 
úame
 << " stu " << 
şs
->
¡©us
 << 
d’dl
;

219 ià(
şs
->
¡©us
 !ğ
CÏssD©a
::
CLASS_INITIALIZING
) {

220 
	`ldout
(
cù
, 0è<< "şas " << 
úame
 << " i¢'ˆlßded; i thşas »gi¡”šg und”hwrÚg‚ame?" << 
d’dl
;

221  
NULL
;

223  
şs
;

224 
	}
}

226 
	gCÏssHªdËr
::
	$uÄegi¡”_şass
(
CÏssHªdËr
::
CÏssD©a
 *
şs
)

229 
	}
}

231 
CÏssHªdËr
::
CÏssM‘hod
 *CÏssHªdËr::
CÏssD©a
::
	$»gi¡”_m‘hod
(cÚ¡ *
mÇme
,

232 
æags
,

233 
şs_m‘hod_ÿÎ_t
 
func
)

236 ià(!
æags
) {

237 
	`ld”r
(
hªdËr
->
cù
è<< "»gi¡”_m‘hod " << 
Çme
 << "." << 
mÇme


238 << " fÏg " << 
æags
 << " " << (*)
func


239 << " FAILED -- fÏg mu¡ bnÚ-z”o" << 
d’dl
;

240  
NULL
;

242 
	`ldout
(
hªdËr
->
cù
, 10è<< "»gi¡”_m‘hod " << 
Çme
 << "." << 
mÇme
 << " fÏg " << 
æags
 << " " << (*)
func
 << 
d’dl
;

243 
CÏssM‘hod
& 
m‘hod
 = 
m‘hods_m­
[
mÇme
];

244 
m‘hod
.
func
 = func;

245 
m‘hod
.
Çme
 = 
mÇme
;

246 
m‘hod
.
æags
 = flags;

247 
m‘hod
.
şs
 = 
this
;

248  &
m‘hod
;

249 
	}
}

251 
	gCÏssHªdËr
::
CÏssM‘hod
 *
CÏssHªdËr
::
CÏssD©a
::
	$»gi¡”_cxx_m‘hod
(cÚ¡ *
mÇme
,

252 
æags
,

253 
şs_m‘hod_cxx_ÿÎ_t
 
func
)

256 
	`ldout
(
hªdËr
->
cù
, 10è<< "»gi¡”_cxx_m‘hod " << 
Çme
 << "." << 
mÇme
 << " fÏg " << 
æags
 << " " << (*)
func
 << 
d’dl
;

257 
CÏssM‘hod
& 
m‘hod
 = 
m‘hods_m­
[
mÇme
];

258 
m‘hod
.
cxx_func
 = 
func
;

259 
m‘hod
.
Çme
 = 
mÇme
;

260 
m‘hod
.
æags
 = flags;

261 
m‘hod
.
şs
 = 
this
;

262  &
m‘hod
;

263 
	}
}

265 
	gCÏssHªdËr
::
CÏssF‹r
 *
CÏssHªdËr
::
CÏssD©a
::
	$»gi¡”_cxx_f‹r
(

266 cÚ¡ 
¡d
::
¡ršg
 &
f‹r_Çme
,

267 
şs_cxx_f‹r_çùÜy_t
 
â
)

269 
CÏssF‹r
 &
f‹r
 = 
f‹rs_m­
[
f‹r_Çme
];

270 
f‹r
.
â
 = fn;

271 
f‹r
.
Çme
 = 
f‹r_Çme
;

272 
f‹r
.
şs
 = 
this
;

273  &
f‹r
;

274 
	}
}

276 
	gCÏssHªdËr
::
CÏssM‘hod
 *
CÏssHªdËr
::
CÏssD©a
::
	$_g‘_m‘hod
(cÚ¡ *
mÇme
)

278 
m­
<
¡ršg
, 
CÏssHªdËr
::
CÏssM‘hod
>::
™”©Ü
 
™”
 = 
m‘hods_m­
.
	`fšd
(
mÇme
);

279 ià(
™”
 =ğ
m‘hods_m­
.
	`’d
())

280  
NULL
;

281  &(
™”
->
£cÚd
);

282 
	}
}

284 
	gCÏssHªdËr
::
CÏssD©a
::
	$g‘_m‘hod_æags
(cÚ¡ *
mÇme
)

286 
Mu‹x
::
Lock”
 
	`l
(
hªdËr
->
mu‹x
);

287 
CÏssM‘hod
 *
m‘hod
 = 
	`_g‘_m‘hod
(
mÇme
);

288 ià(!
m‘hod
)

289  -
ENOENT
;

290  
m‘hod
->
æags
;

291 
	}
}

293 
	gCÏssHªdËr
::
CÏssD©a
::
	$uÄegi¡”_m‘hod
(
CÏssHªdËr
::
CÏssM‘hod
 *
m‘hod
)

296 
m­
<
¡ršg
, 
CÏssM‘hod
>::
™”©Ü
 
™”
 = 
m‘hods_m­
.
	`fšd
(
m‘hod
->
Çme
);

297 ià(
™”
 =ğ
m‘hods_m­
.
	`’d
())

299 
m‘hods_m­
.
	`”a£
(
™”
);

300 
	}
}

302 
	gCÏssHªdËr
::
CÏssM‘hod
::
	$uÄegi¡”
()

304 
şs
->
	`uÄegi¡”_m‘hod
(
this
);

305 
	}
}

307 
	gCÏssHªdËr
::
CÏssD©a
::
	$uÄegi¡”_f‹r
(
CÏssHªdËr
::
CÏssF‹r
 *
f‹r
)

310 
m­
<
¡ršg
, 
CÏssF‹r
>::
™”©Ü
 
™”
 = 
f‹rs_m­
.
	`fšd
(
f‹r
->
Çme
);

311 ià(
™”
 =ğ
f‹rs_m­
.
	`’d
())

313 
f‹rs_m­
.
	`”a£
(
™”
);

314 
	}
}

316 
	gCÏssHªdËr
::
CÏssF‹r
::
	$uÄegi¡”
()

318 
şs
->
	`uÄegi¡”_f‹r
(
this
);

319 
	}
}

321 
	gCÏssHªdËr
::
CÏssM‘hod
::
	$exec
(
şs_m‘hod_cÚ‹xt_t
 
ùx
, 
bufã¾i¡
& 
šd©a
, bufã¾i¡& 
outd©a
)

323 
»t
;

324 ià(
cxx_func
) {

326 
»t
 = 
	`cxx_func
(
ùx
, &
šd©a
, &
outd©a
);

329 *
out
 = 
NULL
;

330 
Ş’
 = 0;

331 
»t
 = 
	`func
(
ùx
, 
šd©a
.
	`c_¡r
(), ind©a.
	`Ëngth
(), &
out
, &
Ş’
);

332 ià(
out
) {

334 
bufãr
::
±r
 
bp
 = bufãr::
	`şaim_m®loc
(
Ş’
, 
out
);

335 
outd©a
.
	`push_back
(
bp
);

338  
»t
;

339 
	}
}

	@osd/ClassHandler.h

3 #iâdeà
CEPH_CLASSHANDLER_H


4 
	#CEPH_CLASSHANDLER_H


	)

6 
	~"šşude/ty³s.h
"

7 
	~"objşass/objşass.h
"

8 
	~"commÚ/Mu‹x.h
"

11 
şass
 
	gC•hCÚ‹xt
;

13 şas 
	cCÏssHªdËr


15 
	mpublic
:

16 
C•hCÚ‹xt
 *
cù
;

18 
	mCÏssD©a
;

20 
	sCÏssM‘hod
 {

21 
	mCÏssHªdËr
::
CÏssD©a
 *
şs
;

22 
¡ršg
 
	mÇme
;

23 
	mæags
;

24 
şs_m‘hod_ÿÎ_t
 
	mfunc
;

25 
şs_m‘hod_cxx_ÿÎ_t
 
	mcxx_func
;

27 
exec
(
şs_m‘hod_cÚ‹xt_t
 
ùx
, 
bufã¾i¡
& 
šd©a
, bufã¾i¡& 
outd©a
);

28 
uÄegi¡”
();

30 
g‘_æags
() {

31 
	mMu‹x
::
Lock”
 
l
(
şs
->
hªdËr
->
mu‹x
);

32  
	mæags
;

35 
CÏssM‘hod
(è: 
şs
(0), 
æags
(0), 
func
(0), 
cxx_func
(0) {}

38 
	sCÏssF‹r
 {

39 
	gCÏssHªdËr
::
CÏssD©a
 *
şs
 = 
nuÎ±r
;

40 
	g¡d
::
¡ršg
 
Çme
;

41 
şs_cxx_f‹r_çùÜy_t
 
	gâ
;

43 
uÄegi¡”
();

45 
CÏssF‹r
(è: 
â
(0)

49 
	sCÏssD©a
 {

50 
	eStus
 {

51 
	gCLASS_UNKNOWN
,

52 
	gCLASS_MISSING
,

53 
	gCLASS_MISSING_DEPS
,

54 
	gCLASS_INITIALIZING
,

55 
	gCLASS_OPEN
,

56 } 
	g¡©us
;

58 
¡ršg
 
	gÇme
;

59 
CÏssHªdËr
 *
	ghªdËr
;

60 *
	ghªdË
;

62 
boŞ
 
	gwh™–i¡ed
 = 
çl£
;

64 
	gm­
<
	g¡ršg
, 
	gCÏssM‘hod
> 
	gm‘hods_m­
;

65 
	gm­
<
	g¡ršg
, 
	gCÏssF‹r
> 
	gf‹rs_m­
;

67 
	g£t
<
	gCÏssD©a
 *> 
	gd•’d’c›s
;

68 
	g£t
<
	gCÏssD©a
 *> 
	gmissšg_d•’d’c›s
;

70 
CÏssM‘hod
 *
_g‘_m‘hod
(cÚ¡ *
mÇme
);

72 
CÏssD©a
(è: 
¡©us
(
CLASS_UNKNOWN
),

73 
hªdËr
(
NULL
),

74 
hªdË
(
NULL
) {}

75 ~
CÏssD©a
() { }

77 
CÏssM‘hod
 *
»gi¡”_m‘hod
(cÚ¡ *
mÇme
, 
æags
, 
şs_m‘hod_ÿÎ_t
 
func
);

78 
CÏssM‘hod
 *
»gi¡”_cxx_m‘hod
(cÚ¡ *
mÇme
, 
æags
, 
şs_m‘hod_cxx_ÿÎ_t
 
func
);

79 
uÄegi¡”_m‘hod
(
CÏssM‘hod
 *
m‘hod
);

81 
CÏssF‹r
 *
»gi¡”_cxx_f‹r
(

82 cÚ¡ 
¡d
::
¡ršg
 &
f‹r_Çme
,

83 
şs_cxx_f‹r_çùÜy_t
 
â
);

84 
uÄegi¡”_f‹r
(
CÏssF‹r
 *
m‘hod
);

86 
CÏssM‘hod
 *
g‘_m‘hod
(cÚ¡ *
mÇme
) {

87 
	gMu‹x
::
Lock”
 
l
(
hªdËr
->
mu‹x
);

88  
_g‘_m‘hod
(
mÇme
);

90 
g‘_m‘hod_æags
(cÚ¡ *
mÇme
);

92 
CÏssF‹r
 *
g‘_f‹r
(cÚ¡ 
¡d
::
¡ršg
 &
f‹r_Çme
)

94 
Mu‹x
::
Lock”
 
l
(
hªdËr
->
mu‹x
);

95 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gCÏssF‹r
>::
™”©Ü
 
i
 = 
f‹rs_m­
.
fšd
(
f‹r_Çme
);

96 ià(
	gi
 =ğ
f‹rs_m­
.
’d
()) {

97  
NULL
;

99  &(
	gi
->
	g£cÚd
);

104 
	g´iv©e
:

105 
m­
<
¡ršg
, 
	gCÏssD©a
> 
	gşas£s
;

107 
CÏssD©a
 *
_g‘_şass
(cÚ¡ 
¡ršg
& 
úame
, 
boŞ
 
check_®lowed
);

108 
_lßd_şass
(
CÏssD©a
 *
şs
);

110 
boŞ
 
š_şass_li¡
(cÚ¡ 
¡d
::
¡ršg
& 
úame
,

111 cÚ¡ 
¡d
::
¡ršg
& 
li¡
);

113 
	gpublic
:

114 
Mu‹x
 
mu‹x
;

116 
ex¶ic™
 
	$CÏssHªdËr
(
C•hCÚ‹xt
 *
cù_
è: 
	`cù
(cù_), 
	`mu‹x
("CÏssHªdËr"è{
	}
}

118 
İ’_®l_şas£s
();

120 
add_embedded_şass
(cÚ¡ 
¡ršg
& 
úame
);

121 
İ’_şass
(cÚ¡ 
¡ršg
& 
úame
, 
CÏssD©a
 **
pşs
);

123 
CÏssD©a
 *
»gi¡”_şass
(cÚ¡ *
úame
);

124 
uÄegi¡”_şass
(
CÏssD©a
 *
şs
);

126 
shutdown
();

	@osd/ECBackend.cc

15 
	~<io¡»am
>

16 
	~<s¡»am
>

18 
	~"ECBack’d.h
"

19 
	~"mes§ges/MOSDPGPush.h
"

20 
	~"mes§ges/MOSDPGPushR•ly.h
"

21 
	~"mes§ges/MOSDECSubOpWr™e.h
"

22 
	~"mes§ges/MOSDECSubOpWr™eR•ly.h
"

23 
	~"mes§ges/MOSDECSubOpR—d.h
"

24 
	~"mes§ges/MOSDECSubOpR—dR•ly.h
"

25 
	~"ECMsgTy³s.h
"

27 
	~"Prim¬yLogPG.h
"

29 
	#dout_cÚ‹xt
 
cù


	)

30 
	#dout_subsys
 
ûph_subsys_osd


	)

31 
	#DOUT_PREFIX_ARGS
 
this


	)

32 #undeà
dout_´efix


33 
	#dout_´efix
 
	`_´efix
(
_dout
, 
this
)

	)

34 
	go¡»am
& 
	$_´efix
(
¡d
::
o¡»am
 *
_dout
, 
ECBack’d
 *
pgb
) {

35  
pgb
->
	`g‘_·»Á
()->
	`g’_dbg_´efix
(*
_dout
);

36 
	}
}

38 
	gECRecov”yHªdË
 : 
public
 
PGBack’d
::
Recov”yHªdË
 {

39 
li¡
<
ECBack’d
::
Recov”yOp
> 
İs
;

42 
	go¡»am
 &
	gİ”©Ü
<<(o¡»am &
	glhs
, cÚ¡ 
	gECBack’d
::
p–še_¡©e_t
 &
rhs
) {

43 
rhs
.
p–še_¡©e
) {

44 
ECBack’d
::
p–še_¡©e_t
::
CACHE_VALID
:

45  
lhs
 << "CACHE_VALID";

46 
	gECBack’d
::
p–še_¡©e_t
::
CACHE_INVALID
:

47  
lhs
 << "CACHE_INVALID";

49 
as£¹
(0 == "invalid…ipeline state");

51  
	glhs
;

54 
	go¡»am
 &
	gİ”©Ü
<<(o¡»am &
	glhs
, cÚ¡ 
	gm­
<
	gpg_sh¬d_t
, 
	gbufã¾i¡
> &
	grhs
)

56 
	glhs
 << "[";

57 
	gm­
<
	gpg_sh¬d_t
, 
	gbufã¾i¡
>::
cÚ¡_™”©Ü
 
i
 = 
rhs
.
begš
();

58 
	gi
 !ğ
rhs
.
’d
();

59 ++
	gi
) {

60 ià(
	gi
 !ğ
rhs
.
begš
())

61 
lhs
 << ", ";

62 
	glhs
 << 
make_·œ
(
i
->
fœ¡
, i->
£cÚd
.
Ëngth
());

64  
	glhs
 << "]";

67 
	go¡»am
 &
	gİ”©Ü
<<(o¡»am &
	glhs
, cÚ¡ 
	gm­
<, 
	gbufã¾i¡
> &
	grhs
)

69 
	glhs
 << "[";

70 
	gm­
<, 
	gbufã¾i¡
>::
cÚ¡_™”©Ü
 
i
 = 
rhs
.
begš
();

71 
	gi
 !ğ
rhs
.
’d
();

72 ++
	gi
) {

73 ià(
	gi
 !ğ
rhs
.
begš
())

74 
lhs
 << ", ";

75 
	glhs
 << 
make_·œ
(
i
->
fœ¡
, i->
£cÚd
.
Ëngth
());

77  
	glhs
 << "]";

80 
	go¡»am
 &
	gİ”©Ü
<<(

81 
	go¡»am
 &
	glhs
,

82 cÚ¡ 
	gboo¡
::
tu¶e
<
ušt64_t
, 
	gušt64_t
, 
	gm­
<
	gpg_sh¬d_t
, 
	gbufã¾i¡
> > &
	grhs
)

84  
	glhs
 << "(" << 
	grhs
.
	gg‘
<0>() << ", "

85 << 
	grhs
.
	gg‘
<1>() << ", " <<„hs.get<2>() << ")";

88 
	go¡»am
 &
	gİ”©Ü
<<(o¡»am &
	glhs
, cÚ¡ 
	gECBack’d
::
»ad_»que¡_t
 &
rhs
)

90  
lhs
 << "»ad_»que¡_tÑo_»ad=[" << 
rhs
.
to_»ad
 << "]"

91 << ",‚“d=" << 
rhs
.
Ãed


92 << ", wªt_©Œs=" << 
rhs
.
wªt_©Œs


96 
	go¡»am
 &
	gİ”©Ü
<<(o¡»am &
	glhs
, cÚ¡ 
	gECBack’d
::
»ad_»suÉ_t
 &
rhs
)

98 
lhs
 << "»ad_»suÉ_tÔ=" << 
rhs
.
r


99 << ",ƒ¼Üs=" << 
rhs
.
”rÜs
;

100 ià(
	grhs
.
	g©Œs
) {

101 
	glhs
 << ",‡‰rs=" << 
	grhs
.
	g©Œs
.
g‘
();

103 
	glhs
 << ",‚oattrs";

105  
	glhs
 << ",„‘uºed=" << 
	grhs
.
	g»tuºed
 << ")";

108 
	go¡»am
 &
	gİ”©Ü
<<(o¡»am &
	glhs
, cÚ¡ 
	gECBack’d
::
R—dOp
 &
rhs
)

110 
lhs
 << "R—dOpÑid=" << 
rhs
.
tid
;

111 ià(
	grhs
.
	gİ
 &&„hs.İ->
g‘_»q
()) {

112 
	glhs
 << ", op=";

113 
	grhs
.
	gİ
->
g‘_»q
()->
´št
(
lhs
);

115  
	glhs
 << ",o_»ad=" << 
	grhs
.
	gto_»ad


116 << ", com¶‘e=" << 
	grhs
.
	gcom¶‘e


117 << ",…riÜ™y=" << 
	grhs
.
	g´iÜ™y


118 << ", obj_to_sourû=" << 
	grhs
.
	gobj_to_sourû


119 << ", sourû_to_obj=" << 
	grhs
.
	gsourû_to_obj


120 << ", in_´og»ss=" << 
	grhs
.
	gš_´og»ss
 << ")";

123 
	gECBack’d
::
R—dOp
::
	$dump
(
FÜm©‹r
 *
f
) const

125 
f
->
	`dump_unsigÃd
("tid", 
tid
);

126 ià(
İ
 && op->
	`g‘_»q
()) {

127 
f
->
	`dump_¡»am
("İ"è<< *(
İ
->
	`g‘_»q
());

129 
f
->
	`dump_¡»am
("to_»ad"è<< 
to_»ad
;

130 
f
->
	`dump_¡»am
("com¶‘e"è<< 
com¶‘e
;

131 
f
->
	`dump_št
("´iÜ™y", 
´iÜ™y
);

132 
f
->
	`dump_¡»am
("obj_to_sourû"è<< 
obj_to_sourû
;

133 
f
->
	`dump_¡»am
("sourû_to_obj"è<< 
sourû_to_obj
;

134 
f
->
	`dump_¡»am
("š_´og»ss"è<< 
š_´og»ss
;

135 
	}
}

137 
	go¡»am
 &
	gİ”©Ü
<<(o¡»am &
	glhs
, cÚ¡ 
	gECBack’d
::
Op
 &
rhs
)

139 
lhs
 << "Op(" << 
rhs
.
hoid


140 << " v=" << 
rhs
.
v”siÚ


141 << "t=" << 
rhs
.
Œim_to


142 << "id=" << 
rhs
.
tid


143 << "„eqid=" << 
rhs
.
»qid
;

144 ià(
	grhs
.
	gş›Á_İ
 &&„hs.ş›Á_İ->
g‘_»q
()) {

145 
	glhs
 << " client_op=";

146 
	grhs
.
	gş›Á_İ
->
g‘_»q
()->
´št
(
lhs
);

148 
	glhs
 << "„Şl_fÜw¬d_to=" << 
	grhs
.
	grŞl_fÜw¬d_to


149 << "emp_added=" << 
	grhs
.
	g‹mp_added


150 << "emp_ş—»d=" << 
	grhs
.
	g‹mp_ş—»d


151 << "…’dšg_»ad=" << 
	grhs
.
	g³ndšg_»ad


152 << "„emÙe_»ad=" << 
	grhs
.
	g»mÙe_»ad


153 << "„emÙe_»ad_»suÉ=" << 
	grhs
.
	g»mÙe_»ad_»suÉ


154 << "…’dšg_­¶y=" << 
	grhs
.
	g³ndšg_­¶y


155 << "…’dšg_comm™=" << 
	grhs
.
	g³ndšg_comm™


156 << "…Ïn.to_»ad=" << 
	grhs
.
	g¶ª
.
	gto_»ad


157 << "…Ïn.wl_wr™e=" << 
	grhs
.
	g¶ª
.
	gwl_wr™e


159  
	glhs
;

162 
	go¡»am
 &
	gİ”©Ü
<<(o¡»am &
	glhs
, cÚ¡ 
	gECBack’d
::
Recov”yOp
 &
rhs
)

164  
lhs
 << "RecoveryOp("

165 << "hoid=" << 
rhs
.
hoid


166 << " v=" << 
rhs
.
v


167 << " missšg_Ú=" << 
rhs
.
missšg_Ú


168 << " missšg_Ú_sh¬ds=" << 
rhs
.
missšg_Ú_sh¬ds


169 << "„ecov”y_šfo=" << 
rhs
.
»cov”y_šfo


170 << "„ecov”y_´og»ss=" << 
rhs
.
»cov”y_´og»ss


171 << " obø»fcouÁ=" << 
rhs
.
obc
.
u£_couÁ
()

172 << " s‹=" << 
ECBack’d
::
Recov”yOp
::
to¡r
(
rhs
.
¡©e
)

173 << " wa™šg_Ú_pushes=" << 
rhs
.
wa™šg_Ú_pushes


174 << "ƒx‹Á_»que¡ed=" << 
rhs
.
ex‹Á_»que¡ed


178 
	gECBack’d
::
Recov”yOp
::
	$dump
(
FÜm©‹r
 *
f
) const

180 
f
->
	`dump_¡»am
("hoid"è<< 
hoid
;

181 
f
->
	`dump_¡»am
("v"è<< 
v
;

182 
f
->
	`dump_¡»am
("missšg_Ú"è<< 
missšg_Ú
;

183 
f
->
	`dump_¡»am
("missšg_Ú_sh¬ds"è<< 
missšg_Ú_sh¬ds
;

184 
f
->
	`dump_¡»am
("»cov”y_šfo"è<< 
»cov”y_šfo
;

185 
f
->
	`dump_¡»am
("»cov”y_´og»ss"è<< 
»cov”y_´og»ss
;

186 
f
->
	`dump_¡»am
("¡©e"è<< 
	`to¡r
(
¡©e
);

187 
f
->
	`dump_¡»am
("wa™šg_Ú_pushes"è<< 
wa™šg_Ú_pushes
;

188 
f
->
	`dump_¡»am
("ex‹Á_»que¡ed"è<< 
ex‹Á_»que¡ed
;

189 
	}
}

191 
	gECBack’d
::
	$ECBack’d
(

192 
PGBack’d
::
Li¡’”
 *
pg
,

193 cÚ¡ 
cŞl_t
 &
cŞl
,

194 
ObjeùStÜe
::
CŞËùiÚHªdË
 &
ch
,

195 
ObjeùStÜe
 *
¡Üe
,

196 
C•hCÚ‹xt
 *
cù
,

197 
E¿su»CodeIÁ”çûRef
 
ec_im¶
,

198 
ušt64_t
 
¡re_width
)

199 : 
	`PGBack’d
(
cù
, 
pg
, 
¡Üe
, 
cŞl
, 
ch
),

200 
	`ec_im¶
(
ec_im¶
),

201 
	`sšfo
(
ec_im¶
->
	`g‘_d©a_chunk_couÁ
(), 
¡re_width
) {

202 
	`as£¹
((
ec_im¶
->
	`g‘_d©a_chunk_couÁ
() *

203 
ec_im¶
->
	`g‘_chunk_size
(
¡re_width
)) == stripe_width);

204 
	}
}

206 
	gPGBack’d
::
Recov”yHªdË
 *
ECBack’d
::
	$İ’_»cov”y_İ
()

208  
Ãw
 
ECRecov”yHªdË
;

209 
	}
}

211 
	gECBack’d
::
_çed_push
(cÚ¡ 
hobjeù_t
 &
hoid
,

212 
·œ
<
Recov”yMes§ges
 *, 
ECBack’d
::
»ad_»suÉ_t
 &> &
š
)

214 
ECBack’d
::
»ad_»suÉ_t
 &
»s
 = 
š
.
£cÚd
;

215 
dout
(10è<< 
	g__func__
 << ": R—dƒ¼Ü " << 
	ghoid
 << "„="

216 << 
	g»s
.
	gr
 << "ƒ¼Üs=" <<„es.
	g”rÜs
 << 
	gd’dl
;

217 
dout
(10è<< 
	g__func__
 << ": cªûlšg„ecov”y o°fÜ obj " << 
	ghoid


218 << 
	gd’dl
;

219 
as£¹
(
»cov”y_İs
.
couÁ
(
hoid
));

220 
ev”siÚ_t
 
	gv
 = 
»cov”y_İs
[
hoid
].
v
;

221 
	g»cov”y_İs
.
”a£
(
hoid
);

223 
	gli¡
<
	gpg_sh¬d_t
> 
	gæ
;

224 auto&& 
	gi
 : 
»s
.
”rÜs
) {

225 
æ
.
push_back
(
i
.
fœ¡
);

227 
g‘_·»Á
()->
çed_push
(
æ
, 
hoid
);

228 
g‘_·»Á
()->
backfl_add_missšg
(
hoid
, 
v
);

229 
g‘_·»Á
()->
fšish_deg¿ded_objeù
(
hoid
);

232 
	gOnRecov”yR—dCom¶‘e
 :

233 
public
 
G’CÚ‹xt
<
·œ
<
Recov”yMes§ges
*, 
	gECBack’d
::
»ad_»suÉ_t
& > &> {

234 
ECBack’d
 *
pg
;

235 
hobjeù_t
 
	ghoid
;

236 
OnRecov”yR—dCom¶‘e
(
ECBack’d
 *
pg
, cÚ¡ 
hobjeù_t
 &
hoid
)

237 : 
pg
Õg), 
hoid
(hoid) {}

238 
fšish
(
·œ
<
Recov”yMes§ges
 *, 
ECBack’d
::
»ad_»suÉ_t
 &> &
š
è
ov”ride
 {

239 
ECBack’d
::
»ad_»suÉ_t
 &
»s
 = 
š
.
£cÚd
;

240 ià(!(
	g»s
.
	gr
 =ğ0 && 
»s
.
”rÜs
.
em±y
())) {

241 
pg
->
_çed_push
(
hoid
, 
š
);

244 
as£¹
(
»s
.
»tuºed
.
size
() == 1);

245 
	gpg
->
hªdË_»cov”y_»ad_com¶‘e
(

246 
hoid
,

247 
»s
.
»tuºed
.
back
(),

248 
»s
.
©Œs
,

249 
š
.
fœ¡
);

253 
	sRecov”yMes§ges
 {

254 
	mm­
<
	mhobjeù_t
,

255 
	mECBack’d
::
»ad_»que¡_t
> 
»ads
;

256 
	mm­
<
	mhobjeù_t
, 
	m£t
<>> 
	mwªt_to_»ad
;

257 
»ad
(

258 
ECBack’d
 *
ec
,

259 cÚ¡ 
hobjeù_t
 &
hoid
, 
ušt64_t
 
off
, ušt64_ˆ
Ën
,

260 
£t
<> &&
_wªt_to_»ad
,

261 cÚ¡ 
m­
<
pg_sh¬d_t
, 
veùÜ
<
·œ
<, >>> &
Ãed
,

262 
boŞ
 
©Œs
) {

263 
	mli¡
<
	mboo¡
::
tu¶e
<
ušt64_t
, 
	mušt64_t
, 
	mušt32_t
> > 
	mto_»ad
;

264 
	mto_»ad
.
push_back
(
boo¡
::
make_tu¶e
(
off
, 
Ën
, 0));

265 
as£¹
(!
»ads
.
couÁ
(
hoid
));

266 
	mwªt_to_»ad
.
š£¹
(
make_·œ
(
hoid
, 
¡d
::
move
(
_wªt_to_»ad
)));

267 
	m»ads
.
š£¹
(

268 
make_·œ
(

269 
hoid
,

270 
ECBack’d
::
»ad_»que¡_t
(

271 
to_»ad
,

272 
Ãed
,

273 
©Œs
,

274 
Ãw
 
OnRecov”yR—dCom¶‘e
(

275 
ec
,

276 
hoid
))));

279 
	mm­
<
	mpg_sh¬d_t
, 
	mveùÜ
<
	mPushOp
> > 
	mpushes
;

280 
	mm­
<
	mpg_sh¬d_t
, 
	mveùÜ
<
	mPushR•lyOp
> > 
	mpush_»¶›s
;

281 
	mObjeùStÜe
::
T¿n§ùiÚ
 
t
;

282 
Recov”yMes§ges
() {}

283 ~
Recov”yMes§ges
(){}

286 
	gECBack’d
::
	$hªdË_»cov”y_push
(

287 cÚ¡ 
PushOp
 &
İ
,

288 
Recov”yMes§ges
 *
m
)

290 ià(
	`g‘_·»Á
()->
	`check_ç§ã_fuÎ
()) {

291 
	`dout
(10è<< 
__func__
 << " Ouˆoà¥aû (ç§ãè´oûssšg…ush„eque¡." << 
d’dl
;

292 
	`ûph_abÜt
();

295 
boŞ
 
ÚeshÙ
 = 
İ
.
befÜe_´og»ss
.
fœ¡
 && op.
aá”_´og»ss
.
d©a_com¶‘e
;

296 
ghobjeù_t
 
tobj
;

297 ià(
ÚeshÙ
) {

298 
tobj
 = 
	`ghobjeù_t
(
İ
.
soid
, 
ghobjeù_t
::
NO_GEN
,

299 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
);

301 
tobj
 = 
	`ghobjeù_t
(
	`g‘_·»Á
()->
	`g‘_‹mp_»cov”y_objeù
(
İ
.
soid
,

302 
İ
.
v”siÚ
),

303 
ghobjeù_t
::
NO_GEN
,

304 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
);

305 ià(
İ
.
befÜe_´og»ss
.
fœ¡
) {

306 
	`dout
(10è<< 
__func__
 << ": Adding oid "

307 << 
tobj
.
hobj
 << " iÀth‹m°cŞËùiÚ" << 
d’dl
;

308 
	`add_‹mp_obj
(
tobj
.
hobj
);

312 ià(
İ
.
befÜe_´og»ss
.
fœ¡
) {

313 
m
->
t
.
	`»move
(
cŞl
, 
tobj
);

314 
m
->
t
.
	`touch
(
cŞl
, 
tobj
);

317 ià(!
İ
.
d©a_šşuded
.
	`em±y
()) {

318 
ušt64_t
 
¡¬t
 = 
İ
.
d©a_šşuded
.
	`¿nge_¡¬t
();

319 
ušt64_t
 
’d
 = 
İ
.
d©a_šşuded
.
	`¿nge_’d
();

320 
	`as£¹
(
İ
.
d©a
.
	`Ëngth
(è=ğ(
’d
 - 
¡¬t
));

322 
m
->
t
.
	`wr™e
(

323 
cŞl
,

324 
tobj
,

325 
¡¬t
,

326 
İ
.
d©a
.
	`Ëngth
(),

327 
İ
.
d©a
);

329 
	`as£¹
(
İ
.
d©a
.
	`Ëngth
() == 0);

332 ià(
İ
.
befÜe_´og»ss
.
fœ¡
) {

333 
	`as£¹
(
İ
.
©Œ£t
.
	`couÁ
(
	`¡ršg
("_")));

334 
m
->
t
.
	`£‰rs
(

335 
cŞl
,

336 
tobj
,

337 
İ
.
©Œ£t
);

340 ià(
İ
.
aá”_´og»ss
.
d©a_com¶‘e
 && !
ÚeshÙ
) {

341 
	`dout
(10è<< 
__func__
 << ": Removing oid "

342 << 
tobj
.
hobj
 << " fromh‹m°cŞËùiÚ" << 
d’dl
;

343 
	`ş—r_‹mp_obj
(
tobj
.
hobj
);

344 
m
->
t
.
	`»move
(
cŞl
, 
	`ghobjeù_t
(

345 
İ
.
soid
, 
ghobjeù_t
::
NO_GEN
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
));

346 
m
->
t
.
	`cŞËùiÚ_move_»Çme
(

347 
cŞl
, 
tobj
,

348 
cŞl
, 
	`ghobjeù_t
(

349 
İ
.
soid
, 
ghobjeù_t
::
NO_GEN
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
));

351 ià(
İ
.
aá”_´og»ss
.
d©a_com¶‘e
) {

352 ià((
	`g‘_·»Á
()->
	`pgb_is_´im¬y
())) {

353 
	`as£¹
(
»cov”y_İs
.
	`couÁ
(
İ
.
soid
));

354 
	`as£¹
(
»cov”y_İs
[
İ
.
soid
].
obc
);

355 
	`g‘_·»Á
()->
	`Ú_loÿl_»cov”
(

356 
İ
.
soid
,

357 
İ
.
»cov”y_šfo
,

358 
»cov”y_İs
[
İ
.
soid
].
obc
,

359 
çl£
,

360 &
m
->
t
);

362 
	`g‘_·»Á
()->
	`Ú_loÿl_»cov”
(

363 
İ
.
soid
,

364 
İ
.
»cov”y_šfo
,

365 
	`ObjeùCÚ‹xtRef
(),

366 
çl£
,

367 &
m
->
t
);

370 
m
->
push_»¶›s
[
	`g‘_·»Á
()->
	`´im¬y_sh¬d
()].
	`push_back
(
	`PushR•lyOp
());

371 
m
->
push_»¶›s
[
	`g‘_·»Á
()->
	`´im¬y_sh¬d
()].
	`back
().
soid
 = 
İ
.soid;

372 
	}
}

374 
	gECBack’d
::
	$hªdË_»cov”y_push_»¶y
(

375 cÚ¡ 
PushR•lyOp
 &
İ
,

376 
pg_sh¬d_t
 
äom
,

377 
Recov”yMes§ges
 *
m
)

379 ià(!
»cov”y_İs
.
	`couÁ
(
İ
.
soid
))

381 
Recov”yOp
 &
rİ
 = 
»cov”y_İs
[
İ
.
soid
];

382 
	`as£¹
(
rİ
.
wa™šg_Ú_pushes
.
	`couÁ
(
äom
));

383 
rİ
.
wa™šg_Ú_pushes
.
	`”a£
(
äom
);

384 
	`cÚtšue_»cov”y_İ
(
rİ
, 
m
);

385 
	}
}

387 
	gECBack’d
::
hªdË_»cov”y_»ad_com¶‘e
(

388 cÚ¡ 
hobjeù_t
 &
hoid
,

389 
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
m­
<
pg_sh¬d_t
, 
bufã¾i¡
> > &
to_»ad
,

390 
boo¡
::
İtiÚ®
<
m­
<
¡ršg
, 
bufã¾i¡
> > 
©Œs
,

391 
Recov”yMes§ges
 *
m
)

393 
dout
(10è<< 
	g__func__
 << ":„‘uºed " << 
	ghoid
 << " "

394 << "(" << 
	gto_»ad
.
	gg‘
<0>()

395 << ", " << 
	gto_»ad
.
	gg‘
<1>()

396 << ", " << 
	gto_»ad
.
	gg‘
<2>()

398 << 
	gd’dl
;

399 
as£¹
(
»cov”y_İs
.
couÁ
(
hoid
));

400 
	gRecov”yOp
 &
	gİ
 = 
»cov”y_İs
[
hoid
];

401 
as£¹
(
İ
.
»tuºed_d©a
.
em±y
());

402 
	gm­
<, 
	gbufã¾i¡
*> 
	grg‘
;

403 
	g£t
<
	gsh¬d_id_t
>::
™”©Ü
 
i
 = 
İ
.
missšg_Ú_sh¬ds
.
begš
();

404 
	gi
 !ğ
İ
.
missšg_Ú_sh¬ds
.
’d
();

405 ++
	gi
) {

406 
	grg‘
[*
i
] = &(
İ
.
»tuºed_d©a
[*i]);

408 
	gm­
<, 
	gbufã¾i¡
> 
	gäom
;

409 
	gm­
<
	gpg_sh¬d_t
, 
	gbufã¾i¡
>::
™”©Ü
 
i
 = 
to_»ad
.
g‘
<2>().
begš
();

410 
	gi
 !ğ
to_»ad
.
g‘
<2>().
’d
();

411 ++
	gi
) {

412 
	gäom
[
i
->
fœ¡
.
sh¬d
].
şaim
(i->
£cÚd
);

414 
dout
(10è<< 
	g__func__
 << ": " << 
	gäom
 << 
	gd’dl
;

415 
	gr
;

416 
	gr
 = 
ECUt
::
decode
(
sšfo
, 
ec_im¶
, 
äom
, 
rg‘
);

417 
as£¹
(
r
 == 0);

418 ià(
	g©Œs
) {

419 
	gİ
.
	gx©Œs
.
sw­
(*
©Œs
);

421 ià(!
	gİ
.
	gobc
) {

428 
	gm­
<
	g¡ršg
, 
	gbufã¾i¡
>::
™”©Ü
 
™
 = 
İ
.
x©Œs
.
begš
();

429 
	g™
 !ğ
İ
.
x©Œs
.
’d
();

430 ++
	g™
) {

431 
	g™
->
	g£cÚd
.
»bud
();

435 
	gm­
<
	g¡ršg
, 
	gbufã¾i¡
> 
§n™ized_©Œs
(
İ
.
x©Œs
);

436 
	g§n™ized_©Œs
.
”a£
(
ECUt
::
g‘_hšfo_key
());

437 
	gİ
.
	gobc
 = 
g‘_·»Á
()->
g‘_obc
(
hoid
, 
§n™ized_©Œs
);

438 
as£¹
(
İ
.
obc
);

439 
	gİ
.
	g»cov”y_šfo
.
	gsize
 = 
İ
.
obc
->
obs
.
oi
.
size
;

440 
	gİ
.
	g»cov”y_šfo
.
	goi
 = 
İ
.
obc
->
obs
.
oi
;

443 
	gECUt
::
HashInfo
 
hšfo
(
ec_im¶
->
g‘_chunk_couÁ
());

444 ià(
	gİ
.
	gobc
->
	gobs
.
	goi
.
	gsize
 > 0) {

445 
as£¹
(
İ
.
x©Œs
.
couÁ
(
ECUt
::
g‘_hšfo_key
()));

446 
	gbufã¾i¡
::
™”©Ü
 
bp
 = 
İ
.
x©Œs
[
ECUt
::
g‘_hšfo_key
()].
begš
();

447 
decode
(
hšfo
, 
bp
);

449 
	gİ
.
	ghšfo
 = 
un¡abË_hashšfo_»gi¡ry
.
lookup_Ü_ü—‹
(
hoid
, 
hšfo
);

451 
as£¹
(
İ
.
x©Œs
.
size
());

452 
as£¹
(
İ
.
obc
);

453 
cÚtšue_»cov”y_İ
(
İ
, 
m
);

456 
	gS’dPushR•l›s
 : 
public
 
CÚ‹xt
 {

457 
PGBack’d
::
Li¡’”
 *
l
;

458 
•och_t
 
	g•och
;

459 
	gm­
<, 
	gMOSDPGPushR•ly
*> 
	g»¶›s
;

460 
S’dPushR•l›s
(

461 
PGBack’d
::
Li¡’”
 *
l
,

462 
•och_t
 
•och
,

463 
m­
<, 
MOSDPGPushR•ly
*> &
š
è: 
l
Ö), 
•och
(epoch) {

464 
	g»¶›s
.
sw­
(
š
);

466 
fšish
(è
	gov”ride
 {

467 
	gm­
<, 
	gMOSDPGPushR•ly
*>::
™”©Ü
 
i
 = 
»¶›s
.
begš
();

468 
	gi
 !ğ
»¶›s
.
’d
();

469 ++
	gi
) {

470 
	gl
->
£nd_mes§ge_osd_şu¡”
(
i
->
fœ¡
, i->
£cÚd
, 
•och
);

472 
	g»¶›s
.
ş—r
();

474 ~
S’dPushR•l›s
(è
	gov”ride
 {

475 
	gm­
<, 
	gMOSDPGPushR•ly
*>::
™”©Ü
 
i
 = 
»¶›s
.
begš
();

476 
	gi
 !ğ
»¶›s
.
’d
();

477 ++
	gi
) {

478 
	gi
->
	g£cÚd
->
put
();

480 
	g»¶›s
.
ş—r
();

484 
	gECBack’d
::
	$di¥©ch_»cov”y_mes§ges
(
Recov”yMes§ges
 &
m
, 
´iÜ™y
)

486 
m­
<
pg_sh¬d_t
, 
veùÜ
<
PushOp
> >::
™”©Ü
 
i
 = 
m
.
pushes
.
	`begš
();

487 
i
 !ğ
m
.
pushes
.
	`’d
();

488 
m
.
pushes
.
	`”a£
(
i
++)) {

489 
MOSDPGPush
 *
msg
 = 
Ãw
 
	`MOSDPGPush
();

490 
msg
->
	`£t_´iÜ™y
(
´iÜ™y
);

491 
msg
->
m­_•och
 = 
	`g‘_·»Á
()->
	`g‘_•och
();

492 
msg
->
mš_•och
 = 
	`g‘_·»Á
()->
	`g‘_Ï¡_³”šg_»£t_•och
();

493 
msg
->
äom
 = 
	`g‘_·»Á
()->
	`whßmi_sh¬d
();

494 
msg
->
pgid
 = 
	`¥g_t
(
	`g‘_·»Á
()->
	`g‘_šfo
().pgid.pgid, 
i
->
fœ¡
.
sh¬d
);

495 
msg
->
pushes
.
	`sw­
(
i
->
£cÚd
);

496 
msg
->
	`compu‹_co¡
(
cù
);

497 
	`g‘_·»Á
()->
	`£nd_mes§ge
(

498 
i
->
fœ¡
.
osd
,

499 
msg
);

501 
m­
<, 
MOSDPGPushR•ly
*> 
»¶›s
;

502 
m­
<
pg_sh¬d_t
, 
veùÜ
<
PushR•lyOp
> >::
™”©Ü
 
i
 =

503 
m
.
push_»¶›s
.
	`begš
();

504 
i
 !ğ
m
.
push_»¶›s
.
	`’d
();

505 
m
.
push_»¶›s
.
	`”a£
(
i
++)) {

506 
MOSDPGPushR•ly
 *
msg
 = 
Ãw
 
	`MOSDPGPushR•ly
();

507 
msg
->
	`£t_´iÜ™y
(
´iÜ™y
);

508 
msg
->
m­_•och
 = 
	`g‘_·»Á
()->
	`g‘_•och
();

509 
msg
->
mš_•och
 = 
	`g‘_·»Á
()->
	`g‘_Ï¡_³”šg_»£t_•och
();

510 
msg
->
äom
 = 
	`g‘_·»Á
()->
	`whßmi_sh¬d
();

511 
msg
->
pgid
 = 
	`¥g_t
(
	`g‘_·»Á
()->
	`g‘_šfo
().pgid.pgid, 
i
->
fœ¡
.
sh¬d
);

512 
msg
->
»¶›s
.
	`sw­
(
i
->
£cÚd
);

513 
msg
->
	`compu‹_co¡
(
cù
);

514 
»¶›s
.
	`š£¹
(
	`make_·œ
(
i
->
fœ¡
.
osd
, 
msg
));

517 ià(!
»¶›s
.
	`em±y
()) {

518 (
m
.
t
).
	`»gi¡”_Ú_com¶‘e
(

519 
	`g‘_·»Á
()->
	`bËss_cÚ‹xt
(

520 
Ãw
 
	`S’dPushR•l›s
(

521 
	`g‘_·»Á
(),

522 
	`g‘_·»Á
()->
	`g‘_•och
(),

523 
»¶›s
)));

524 
	`g‘_·»Á
()->
	`queue_Œª§ùiÚ
(
¡d
::
	`move
(
m
.
t
));

527 ià(
m
.
»ads
.
	`em±y
())

529 
	`¡¬t_»ad_İ
(

530 
´iÜ™y
,

531 
m
.
wªt_to_»ad
,

532 
m
.
»ads
,

533 
	`OpReque¡Ref
(),

534 
çl£
, 
Œue
);

535 
	}
}

537 
	gECBack’d
::
	$cÚtšue_»cov”y_İ
(

538 
Recov”yOp
 &
İ
,

539 
Recov”yMes§ges
 *
m
)

541 
	`dout
(10è<< 
__func__
 << ": cÚtšušg " << 
İ
 << 
d’dl
;

543 
İ
.
¡©e
) {

544 
Recov”yOp
::
IDLE
: {

546 
İ
.
¡©e
 = 
Recov”yOp
::
READING
;

547 
	`as£¹
(!
İ
.
»cov”y_´og»ss
.
d©a_com¶‘e
);

548 
£t
<> 
	`wªt
(
İ
.
missšg_Ú_sh¬ds
.
	`begš
(), op.missšg_Ú_sh¬ds.
	`’d
());

549 
ušt64_t
 
äom
 = 
İ
.
»cov”y_´og»ss
.
d©a_»cov”ed_to
;

550 
ušt64_t
 
amouÁ
 = 
	`g‘_»cov”y_chunk_size
();

552 ià(
İ
.
»cov”y_´og»ss
.
fœ¡
 && op.
obc
) {

554 
İ
.
hšfo
 = 
	`g‘_hash_šfo
(İ.
hoid
);

555 
	`as£¹
(
İ
.
hšfo
);

556 
İ
.
x©Œs
 = op.
obc
->
©Œ_ÿche
;

557 
	`’code
(*(
İ
.
hšfo
), op.
x©Œs
[
ECUt
::
	`g‘_hšfo_key
()]);

560 
m­
<
pg_sh¬d_t
, 
veùÜ
<
·œ
<, >>> 
to_»ad
;

561 
r
 = 
	`g‘_mš_ava_to_»ad_sh¬ds
(

562 
İ
.
hoid
, 
wªt
, 
Œue
, 
çl£
, &
to_»ad
);

563 ià(
r
 != 0) {

565 
	`as£¹
(!
İ
.
»cov”y_´og»ss
.
fœ¡
);

566 
	`dout
(10è<< 
__func__
 << ": cªûlšg„ecov”y o°fÜ obj " << 
İ
.
hoid


567 << 
d’dl
;

568 
	`g‘_·»Á
()->
	`ÿnûl_puÎ
(
İ
.
hoid
);

569 
»cov”y_İs
.
	`”a£
(
İ
.
hoid
);

572 
m
->
	`»ad
(

573 
this
,

574 
İ
.
hoid
,

575 
İ
.
»cov”y_´og»ss
.
d©a_»cov”ed_to
,

576 
amouÁ
,

577 
¡d
::
	`move
(
wªt
),

578 
to_»ad
,

579 
İ
.
»cov”y_´og»ss
.
fœ¡
 && !İ.
obc
);

580 
İ
.
ex‹Á_»que¡ed
 = 
	`make_·œ
(

581 
äom
,

582 
amouÁ
);

583 
	`dout
(10è<< 
__func__
 << ": IDLE„‘uº " << 
İ
 << 
d’dl
;

586 
Recov”yOp
::
READING
: {

588 
	`as£¹
(
İ
.
x©Œs
.
	`size
());

589 
	`as£¹
(
İ
.
»tuºed_d©a
.
	`size
());

590 
İ
.
¡©e
 = 
Recov”yOp
::
WRITING
;

591 
ObjeùRecov”yProg»ss
 
aá”_´og»ss
 = 
İ
.
»cov”y_´og»ss
;

592 
aá”_´og»ss
.
d©a_»cov”ed_to
 +ğ
İ
.
ex‹Á_»que¡ed
.
£cÚd
;

593 
aá”_´og»ss
.
fœ¡
 = 
çl£
;

594 ià(
aá”_´og»ss
.
d©a_»cov”ed_to
 >ğ
İ
.
obc
->
obs
.
oi
.
size
) {

595 
aá”_´og»ss
.
d©a_»cov”ed_to
 =

596 
sšfo
.
	`logiÿl_to_Ãxt_¡re_off£t
(

597 
İ
.
obc
->
obs
.
oi
.
size
);

598 
aá”_´og»ss
.
d©a_com¶‘e
 = 
Œue
;

600 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
mi
 = 
İ
.
missšg_Ú
.
	`begš
();

601 
mi
 !ğ
İ
.
missšg_Ú
.
	`’d
();

602 ++
mi
) {

603 
	`as£¹
(
İ
.
»tuºed_d©a
.
	`couÁ
(
mi
->
sh¬d
));

604 
m
->
pushes
[*
mi
].
	`push_back
(
	`PushOp
());

605 
PushOp
 &
pİ
 = 
m
->
pushes
[*
mi
].
	`back
();

606 
pİ
.
soid
 = 
İ
.
hoid
;

607 
pİ
.
v”siÚ
 = 
İ
.
v
;

608 
pİ
.
d©a
 = 
İ
.
»tuºed_d©a
[
mi
->
sh¬d
];

609 
	`dout
(10è<< 
__func__
 << ": befÜe_´og»ss=" << 
İ
.
»cov”y_´og»ss


610 << ",‡á”_´og»ss=" << 
aá”_´og»ss


611 << ",…İ.d©a.Ëngth()=" << 
pİ
.
d©a
.
	`Ëngth
()

612 << ", size=" << 
İ
.
obc
->
obs
.
oi
.
size
 << 
d’dl
;

613 
	`as£¹
(

614 
pİ
.
d©a
.
	`Ëngth
() ==

615 
sšfo
.
	`®igÃd_logiÿl_off£t_to_chunk_off£t
(

616 
aá”_´og»ss
.
d©a_»cov”ed_to
 -

617 
İ
.
»cov”y_´og»ss
.
d©a_»cov”ed_to
)

619 ià(
pİ
.
d©a
.
	`Ëngth
())

620 
pİ
.
d©a_šşuded
.
	`š£¹
(

621 
sšfo
.
	`®igÃd_logiÿl_off£t_to_chunk_off£t
(

622 
İ
.
»cov”y_´og»ss
.
d©a_»cov”ed_to
),

623 
pİ
.
d©a
.
	`Ëngth
()

625 ià(
İ
.
»cov”y_´og»ss
.
fœ¡
) {

626 
pİ
.
©Œ£t
 = 
İ
.
x©Œs
;

628 
pİ
.
»cov”y_šfo
 = 
İ
.recovery_info;

629 
pİ
.
befÜe_´og»ss
 = 
İ
.
»cov”y_´og»ss
;

630 
pİ
.
aá”_´og»ss
 =‡fter_progress;

631 ià(*
mi
 !ğ
	`g‘_·»Á
()->
	`´im¬y_sh¬d
())

632 
	`g‘_·»Á
()->
	`begš_³”_»cov”
(

633 *
mi
,

634 
İ
.
hoid
);

636 
İ
.
»tuºed_d©a
.
	`ş—r
();

637 
İ
.
wa™šg_Ú_pushes
 = op.
missšg_Ú
;

638 
İ
.
»cov”y_´og»ss
 = 
aá”_´og»ss
;

639 
	`dout
(10è<< 
__func__
 << ": READING„‘uº " << 
İ
 << 
d’dl
;

642 
Recov”yOp
::
WRITING
: {

643 ià(
İ
.
wa™šg_Ú_pushes
.
	`em±y
()) {

644 ià(
İ
.
»cov”y_´og»ss
.
d©a_com¶‘e
) {

645 
İ
.
¡©e
 = 
Recov”yOp
::
COMPLETE
;

646 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
İ
.
missšg_Ú
.
	`begš
();

647 
i
 !ğ
İ
.
missšg_Ú
.
	`’d
();

648 ++
i
) {

649 ià(*
i
 !ğ
	`g‘_·»Á
()->
	`´im¬y_sh¬d
()) {

650 
	`dout
(10è<< 
__func__
 << ": on_³”_»cov” oÀ" << *
i


651 << ", obj " << 
İ
.
hoid
 << 
d’dl
;

652 
	`g‘_·»Á
()->
	`Ú_³”_»cov”
(

653 *
i
,

654 
İ
.
hoid
,

655 
İ
.
»cov”y_šfo
);

658 
objeù_¡©_sum_t
 
¡©
;

659 
¡©
.
num_by‹s_»cov”ed
 = 
İ
.
»cov”y_šfo
.
size
;

660 
¡©
.
num_keys_»cov”ed
 = 0;

661 
¡©
.
num_objeùs_»cov”ed
 = 1;

662 
	`g‘_·»Á
()->
	`Ú_glob®_»cov”
(
İ
.
hoid
, 
¡©
, 
çl£
);

663 
	`dout
(10è<< 
__func__
 << ": WRITING„‘uº " << 
İ
 << 
d’dl
;

664 
»cov”y_İs
.
	`”a£
(
İ
.
hoid
);

667 
İ
.
¡©e
 = 
Recov”yOp
::
IDLE
;

668 
	`dout
(10è<< 
__func__
 << ": WRITING cÚtšu" << 
İ
 << 
d’dl
;

675 
Recov”yOp
::
COMPLETE
:

677 
	`ûph_abÜt
();

681 
	}
}

683 
	gECBack’d
::
	$run_»cov”y_İ
(

684 
Recov”yHªdË
 *
_h
,

685 
´iÜ™y
)

687 
ECRecov”yHªdË
 *
h
 = 
¡©ic_ÿ¡
<ECRecov”yHªdË*>(
_h
);

688 
Recov”yMes§ges
 
m
;

689 
li¡
<
Recov”yOp
>::
™”©Ü
 
i
 = 
h
->
İs
.
	`begš
();

690 
i
 !ğ
h
->
İs
.
	`’d
();

691 ++
i
) {

692 
	`dout
(10è<< 
__func__
 << ": s¹šg " << *
i
 << 
d’dl
;

693 
	`as£¹
(!
»cov”y_İs
.
	`couÁ
(
i
->
hoid
));

694 
Recov”yOp
 &
İ
 = 
»cov”y_İs
.
	`š£¹
(
	`make_·œ
(
i
->
hoid
, *i)).
fœ¡
->
£cÚd
;

695 
	`cÚtšue_»cov”y_İ
(
İ
, &
m
);

698 
	`di¥©ch_»cov”y_mes§ges
(
m
, 
´iÜ™y
);

699 
	`£nd_»cov”y_d–‘es
(
´iÜ™y
, 
h
->
d–‘es
);

700 
d–‘e
 
_h
;

701 
	}
}

703 
	gECBack’d
::
	$»cov”_objeù
(

704 cÚ¡ 
hobjeù_t
 &
hoid
,

705 
ev”siÚ_t
 
v
,

706 
ObjeùCÚ‹xtRef
 
h—d
,

707 
ObjeùCÚ‹xtRef
 
obc
,

708 
Recov”yHªdË
 *
_h
)

710 
ECRecov”yHªdË
 *
h
 = 
¡©ic_ÿ¡
<ECRecov”yHªdË*>(
_h
);

711 
h
->
İs
.
	`push_back
(
	`Recov”yOp
());

712 
h
->
İs
.
	`back
().
v
 = v;

713 
h
->
İs
.
	`back
().
hoid
 = hoid;

714 
h
->
İs
.
	`back
().
obc
 = obc;

715 
h
->
İs
.
	`back
().
»cov”y_šfo
.
soid
 = 
hoid
;

716 
h
->
İs
.
	`back
().
»cov”y_šfo
.
v”siÚ
 = 
v
;

717 ià(
obc
) {

718 
h
->
İs
.
	`back
().
»cov”y_šfo
.
size
 = 
obc
->
obs
.
oi
.size;

719 
h
->
İs
.
	`back
().
»cov”y_šfo
.
oi
 = 
obc
->
obs
.oi;

721 ià(
hoid
.
	`is_¢­
()) {

722 ià(
obc
) {

723 
	`as£¹
(
obc
->
ssc
);

724 
h
->
İs
.
	`back
().
»cov”y_šfo
.
ss
 = 
obc
->
ssc
->
¢­£t
;

725 } ià(
h—d
) {

726 
	`as£¹
(
h—d
->
ssc
);

727 
h
->
İs
.
	`back
().
»cov”y_šfo
.
ss
 = 
h—d
->
ssc
->
¢­£t
;

729 
	`as£¹
(0 == "neither obc‚or head set for‡ snap object");

732 
h
->
İs
.
	`back
().
»cov”y_´og»ss
.
om­_com¶‘e
 = 
Œue
;

733 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
i
 =

734 
	`g‘_·»Á
()->
	`g‘_aùšg_»cov”y_backfl_sh¬ds
().
	`begš
();

735 
i
 !ğ
	`g‘_·»Á
()->
	`g‘_aùšg_»cov”y_backfl_sh¬ds
().
	`’d
();

736 ++
i
) {

737 
	`dout
(10è<< "checkšg " << *
i
 << 
d’dl
;

738 ià(
	`g‘_·»Á
()->
	`g‘_sh¬d_missšg
(*
i
).
	`is_missšg
(
hoid
)) {

739 
h
->
İs
.
	`back
().
missšg_Ú
.
	`š£¹
(*
i
);

740 
h
->
İs
.
	`back
().
missšg_Ú_sh¬ds
.
	`š£¹
(
i
->
sh¬d
);

743 
	`dout
(10è<< 
__func__
 << ": buˆİ " << 
h
->
İs
.
	`back
(è<< 
d’dl
;

745 
	}
}

747 
boŞ
 
	gECBack’d
::
	$ÿn_hªdË_whe_šaùive
(

748 
OpReque¡Ref
 
_İ
)

750  
çl£
;

751 
	}
}

753 
boŞ
 
	gECBack’d
::
	$_hªdË_mes§ge
(

754 
OpReque¡Ref
 
_İ
)

756 
	`dout
(10è<< 
__func__
 << ": " << *
_İ
->
	`g‘_»q
(è<< 
d’dl
;

757 
´iÜ™y
 = 
_İ
->
	`g‘_»q
()->
	`g‘_´iÜ™y
();

758 
_İ
->
	`g‘_»q
()->
	`g‘_ty³
()) {

759 
MSG_OSD_EC_WRITE
: {

763 
MOSDECSubOpWr™e
 *
İ
 = 
¡©ic_ÿ¡
<MOSDECSubOpWrite*>(

764 
_İ
->
	`g‘_nÚcÚ¡_»q
());

765 
·»Á
->
	`maybe_´“m±_»¶iÿ_süub
(
İ
->İ.
soid
);

766 
	`hªdË_sub_wr™e
(
İ
->İ.
äom
, 
_İ
, op->İ, _İ->
pg_Œaû
);

767  
Œue
;

769 
MSG_OSD_EC_WRITE_REPLY
: {

770 cÚ¡ 
MOSDECSubOpWr™eR•ly
 *
İ
 = 
¡©ic_ÿ¡
<const MOSDECSubOpWriteReply*>(

771 
_İ
->
	`g‘_»q
());

772 
	`hªdË_sub_wr™e_»¶y
(
İ
->İ.
äom
, op->İ, 
_İ
->
pg_Œaû
);

773  
Œue
;

775 
MSG_OSD_EC_READ
: {

776 cÚ¡ 
MOSDECSubOpR—d
 *
İ
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDECSubOpR—d*>(
_İ
->
	`g‘_»q
());

777 
MOSDECSubOpR—dR•ly
 *
»¶y
 = 
Ãw
 MOSDECSubOpReadReply;

778 
»¶y
->
pgid
 = 
	`g‘_·»Á
()->
	`´im¬y_¥g_t
();

779 
»¶y
->
m­_•och
 = 
	`g‘_·»Á
()->
	`g‘_•och
();

780 
»¶y
->
mš_•och
 = 
	`g‘_·»Á
()->
	`g‘_š‹rv®_¡¬t_•och
();

781 
	`hªdË_sub_»ad
(
İ
->İ.
äom
, op->İ, &(
»¶y
->İ), 
_İ
->
pg_Œaû
);

782 
»¶y
->
Œaû
 = 
_İ
->
pg_Œaû
;

783 
	`g‘_·»Á
()->
	`£nd_mes§ge_osd_şu¡”
(

784 
İ
->İ.
äom
.
osd
, 
»¶y
, 
	`g‘_·»Á
()->
	`g‘_•och
());

785  
Œue
;

787 
MSG_OSD_EC_READ_REPLY
: {

790 
MOSDECSubOpR—dR•ly
 *
İ
 = 
¡©ic_ÿ¡
<MOSDECSubOpReadReply*>(

791 
_İ
->
	`g‘_nÚcÚ¡_»q
());

792 
Recov”yMes§ges
 
rm
;

793 
	`hªdË_sub_»ad_»¶y
(
İ
->İ.
äom
, op->İ, &
rm
, 
_İ
->
pg_Œaû
);

794 
	`di¥©ch_»cov”y_mes§ges
(
rm
, 
´iÜ™y
);

795  
Œue
;

797 
MSG_OSD_PG_PUSH
: {

798 cÚ¡ 
MOSDPGPush
 *
İ
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDPGPush *>(
_İ
->
	`g‘_»q
());

799 
Recov”yMes§ges
 
rm
;

800 
veùÜ
<
PushOp
>::
cÚ¡_™”©Ü
 
i
 = 
İ
->
pushes
.
	`begš
();

801 
i
 !ğ
İ
->
pushes
.
	`’d
();

802 ++
i
) {

803 
	`hªdË_»cov”y_push
(*
i
, &
rm
);

805 
	`di¥©ch_»cov”y_mes§ges
(
rm
, 
´iÜ™y
);

806  
Œue
;

808 
MSG_OSD_PG_PUSH_REPLY
: {

809 cÚ¡ 
MOSDPGPushR•ly
 *
İ
 = 
¡©ic_ÿ¡
<const MOSDPGPushReply *>(

810 
_İ
->
	`g‘_»q
());

811 
Recov”yMes§ges
 
rm
;

812 
veùÜ
<
PushR•lyOp
>::
cÚ¡_™”©Ü
 
i
 = 
İ
->
»¶›s
.
	`begš
();

813 
i
 !ğ
İ
->
»¶›s
.
	`’d
();

814 ++
i
) {

815 
	`hªdË_»cov”y_push_»¶y
(*
i
, 
İ
->
äom
, &
rm
);

817 
	`di¥©ch_»cov”y_mes§ges
(
rm
, 
´iÜ™y
);

818  
Œue
;

821  
çl£
;

823  
çl£
;

824 
	}
}

826 
	gSubWr™eComm™‹d
 : 
public
 
CÚ‹xt
 {

827 
ECBack’d
 *
pg
;

828 
OpReque¡Ref
 
	gmsg
;

829 
ûph_tid_t
 
	gtid
;

830 
ev”siÚ_t
 
	gv”siÚ
;

831 
ev”siÚ_t
 
	gÏ¡_com¶‘e
;

832 cÚ¡ 
	gZT¿ûr
::
T¿û
 
Œaû
;

833 
SubWr™eComm™‹d
(

834 
ECBack’d
 *
pg
,

835 
OpReque¡Ref
 
msg
,

836 
ûph_tid_t
 
tid
,

837 
ev”siÚ_t
 
v”siÚ
,

838 
ev”siÚ_t
 
Ï¡_com¶‘e
,

839 cÚ¡ 
ZT¿ûr
::
T¿û
 &
Œaû
)

840 : 
pg
Õg), 
msg
(msg), 
tid
(tid),

841 
v”siÚ
(v”siÚ), 
Ï¡_com¶‘e
Öa¡_com¶‘e), 
Œaû
(trace) {}

842 
fšish
(è
	gov”ride
 {

843 ià(
	gmsg
)

844 
	gmsg
->
m¬k_ev’t
("sub_op_committed");

845 
	gpg
->
sub_wr™e_comm™‹d
(
tid
, 
v”siÚ
, 
Ï¡_com¶‘e
, 
Œaû
);

848 
	gECBack’d
::
	$sub_wr™e_comm™‹d
(

849 
ûph_tid_t
 
tid
, 
ev”siÚ_t
 
v”siÚ
,ƒv”siÚ_ˆ
Ï¡_com¶‘e
,

850 cÚ¡ 
ZT¿ûr
::
T¿û
 &
Œaû
) {

851 ià(
	`g‘_·»Á
()->
	`pgb_is_´im¬y
()) {

852 
ECSubWr™eR•ly
 
»¶y
;

853 
»¶y
.
tid
 =id;

854 
»¶y
.
Ï¡_com¶‘e
 =†ast_complete;

855 
»¶y
.
comm™‹d
 = 
Œue
;

856 
»¶y
.
­¶›d
 = 
Œue
;

857 
»¶y
.
äom
 = 
	`g‘_·»Á
()->
	`whßmi_sh¬d
();

858 
	`hªdË_sub_wr™e_»¶y
(

859 
	`g‘_·»Á
()->
	`whßmi_sh¬d
(),

860 
»¶y
, 
Œaû
);

862 
	`g‘_·»Á
()->
	`upd©e_Ï¡_com¶‘e_Údisk
(
Ï¡_com¶‘e
);

863 
MOSDECSubOpWr™eR•ly
 *
r
 = 
Ãw
 MOSDECSubOpWriteReply;

864 
r
->
pgid
 = 
	`g‘_·»Á
()->
	`´im¬y_¥g_t
();

865 
r
->
m­_•och
 = 
	`g‘_·»Á
()->
	`g‘_•och
();

866 
r
->
mš_•och
 = 
	`g‘_·»Á
()->
	`g‘_š‹rv®_¡¬t_•och
();

867 
r
->
İ
.
tid
 =id;

868 
r
->
İ
.
Ï¡_com¶‘e
 =†ast_complete;

869 
r
->
İ
.
comm™‹d
 = 
Œue
;

870 
r
->
İ
.
­¶›d
 = 
Œue
;

871 
r
->
İ
.
äom
 = 
	`g‘_·»Á
()->
	`whßmi_sh¬d
();

872 
r
->
	`£t_´iÜ™y
(
CEPH_MSG_PRIO_HIGH
);

873 
r
->
Œaû
 =race;

874 
r
->
Œaû
.
	`ev’t
("sending sub op commit");

875 
	`g‘_·»Á
()->
	`£nd_mes§ge_osd_şu¡”
(

876 
	`g‘_·»Á
()->
	`´im¬y_sh¬d
().
osd
, 
r
, g‘_·»Á()->
	`g‘_•och
());

878 
	}
}

880 
	gECBack’d
::
	$hªdË_sub_wr™e
(

881 
pg_sh¬d_t
 
äom
,

882 
OpReque¡Ref
 
msg
,

883 
ECSubWr™e
 &
İ
,

884 cÚ¡ 
ZT¿ûr
::
T¿û
 &
Œaû
)

886 ià(
msg
)

887 
msg
->
	`m¬k_ev’t
("sub_op_started");

888 
Œaû
.
	`ev’t
("handle_sub_write");

889 ià(!
	`g‘_·»Á
()->
	`pgb_is_´im¬y
())

890 
	`g‘_·»Á
()->
	`upd©e_¡©s
(
İ
.
¡©s
);

891 
ObjeùStÜe
::
T¿n§ùiÚ
 
loÿÉ
;

892 ià(!
İ
.
‹mp_added
.
	`em±y
()) {

893 
	`add_‹mp_objs
(
İ
.
‹mp_added
);

895 ià(
İ
.
backfl_Ü_async_»cov”y
) {

896 
£t
<
hobjeù_t
>::
™”©Ü
 
i
 = 
İ
.
‹mp_»moved
.
	`begš
();

897 
i
 !ğ
İ
.
‹mp_»moved
.
	`’d
();

898 ++
i
) {

899 
	`dout
(10è<< 
__func__
 << ":„emovšg objeù " << *
i


900 << " sšû wwÚ'ˆg‘hŒª§ùiÚ" << 
d’dl
;

901 
loÿÉ
.
	`»move
(

902 
cŞl
,

903 
	`ghobjeù_t
(

904 *
i
,

905 
ghobjeù_t
::
NO_GEN
,

906 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
));

909 
	`ş—r_‹mp_objs
(
İ
.
‹mp_»moved
);

910 
	`dout
(30è<< 
__func__
 << " missšg befÜ" << 
	`g‘_·»Á
()->
	`g‘_log
().
	`g‘_missšg
().
	`g‘_™ems
(è<< 
d’dl
;

911 
pg_missšg_Œack”_t
 
pmissšg
 = 
	`g‘_·»Á
()->
	`g‘_loÿl_missšg
();

912 ià(
pmissšg
.
	`is_missšg
(
İ
.
soid
)) {

913 
	`dout
(30è<< 
__func__
 << " is_missšg " << 
pmissšg
.
	`is_missšg
(
İ
.
soid
è<< 
d’dl
;

914 autØ&&
e
: 
İ
.
log_’Œ›s
) {

915 
	`dout
(30è<< "‡dd_Ãxt_ev’ˆ’Œy " << 
e
 << 
d’dl
;

916 
	`g‘_·»Á
()->
	`add_loÿl_Ãxt_ev’t
(
e
);

917 
	`dout
(30è<< "ƒÁry is_d–‘" << 
e
.
	`is_d–‘e
(è<< 
d’dl
;

920 
	`g‘_·»Á
()->
	`log_İ”©iÚ
(

921 
İ
.
log_’Œ›s
,

922 
İ
.
upd©ed_h™_£t_hi¡Üy
,

923 
İ
.
Œim_to
,

924 
İ
.
rŞl_fÜw¬d_to
,

925 !
İ
.
backfl_Ü_async_»cov”y
,

926 
loÿÉ
);

928 ià(!
	`g‘_·»Á
()->
	`pg_is_und”sized
() &&

929 ()
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
 >=

930 
ec_im¶
->
	`g‘_d©a_chunk_couÁ
())

931 
İ
.
t
.
	`£t_çdvi£_æag
(
CEPH_OSD_OP_FLAG_FADVISE_DONTNEED
);

933 
loÿÉ
.
	`»gi¡”_Ú_comm™
(

934 
	`g‘_·»Á
()->
	`bËss_cÚ‹xt
(

935 
Ãw
 
	`SubWr™eComm™‹d
(

936 
this
, 
msg
, 
İ
.
tid
,

937 
İ
.
©_v”siÚ
,

938 
	`g‘_·»Á
()->
	`g‘_šfo
().
Ï¡_com¶‘e
, 
Œaû
)));

939 
veùÜ
<
ObjeùStÜe
::
T¿n§ùiÚ
> 
s
;

940 
s
.
	`»£rve
(2);

941 
s
.
	`push_back
(
¡d
::
	`move
(
İ
.
t
));

942 
s
.
	`push_back
(
¡d
::
	`move
(
loÿÉ
));

943 
	`g‘_·»Á
()->
	`queue_Œª§ùiÚs
(
s
, 
msg
);

944 
	`dout
(30è<< 
__func__
 << " missšg‡á”" << 
	`g‘_·»Á
()->
	`g‘_log
().
	`g‘_missšg
().
	`g‘_™ems
(è<< 
d’dl
;

945 ià(
İ
.
©_v”siÚ
 !ğ
	`ev”siÚ_t
()) {

947 
	`g‘_·»Á
()->
	`İ_­¶›d
(
İ
.
©_v”siÚ
);

949 
	}
}

951 
	gECBack’d
::
	$hªdË_sub_»ad
(

952 
pg_sh¬d_t
 
äom
,

953 cÚ¡ 
ECSubR—d
 &
İ
,

954 
ECSubR—dR•ly
 *
»¶y
,

955 cÚ¡ 
ZT¿ûr
::
T¿û
 &
Œaû
)

957 
Œaû
.
	`ev’t
("handle sub„ead");

958 
sh¬d_id_t
 
sh¬d
 = 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().shard;

959 autØ
i
 = 
İ
.
to_»ad
.
	`begš
();

960 
i
 !ğ
İ
.
to_»ad
.
	`’d
();

961 ++
i
) {

962 
r
 = 0;

963 
ECUt
::
HashInfoRef
 
hšfo
;

964 
subchunk_size
 = 
sšfo
.
	`g‘_chunk_size
(è/ 
ec_im¶
->
	`g‘_sub_chunk_couÁ
();

965 ià(!
	`g‘_·»Á
()->
	`g‘_poŞ
().
	`®lows_ecov”wr™es
()) {

967 
hšfo
 = 
	`g‘_hash_šfo
(
i
->
fœ¡
);

968 ià(!
hšfo
) {

969 
r
 = -
EIO
;

970 
	`g‘_·»Á
()->
	`şog_”rÜ
(è<< "CÜru±iÚ d‘eùed: objeù " << 
i
->
fœ¡


972 
	`dout
(5è<< 
__func__
 << ": NØhšfØfÜ " << 
i
->
fœ¡
 << 
d’dl
;

973 
”rÜ
;

976 autØ
j
 = 
i
->
£cÚd
.
	`begš
(); j !ği->£cÚd.
	`’d
(); ++j) {

977 
bufã¾i¡
 
bl
;

978 ià((
İ
.
subchunks
.
	`fšd
(
i
->
fœ¡
)->
£cÚd
.
	`size
() == 1) &&

979 (
İ
.
subchunks
.
	`fšd
(
i
->
fœ¡
)->
£cÚd
.
	`äÚt
().second ==

980 
ec_im¶
->
	`g‘_sub_chunk_couÁ
())) {

981 
	`dout
(25è<< 
__func__
 << " ca£1:„—dšghcom¶‘chunk/sh¬d." << 
d’dl
;

982 
r
 = 
¡Üe
->
	`»ad
(

983 
ch
,

984 
	`ghobjeù_t
(
i
->
fœ¡
, 
ghobjeù_t
::
NO_GEN
, 
sh¬d
),

985 
j
->
g‘
<0>(),

986 
j
->
g‘
<1>(),

987 
bl
, 
j
->
g‘
<2>());

989 
	`dout
(25è<< 
__func__
 << " ca£2: gošgØdØäagm’‹d„—d." << 
d’dl
;

990 
m
 = 0; m < ()
j
->
g‘
<1>(); m +ğ
sšfo
.
	`g‘_chunk_size
()) {

991 autØ&&
k
:
İ
.
subchunks
.
	`fšd
(
i
->
fœ¡
)->
£cÚd
) {

992 
bufã¾i¡
 
bl0
;

993 
r
 = 
¡Üe
->
	`»ad
(

994 
ch
,

995 
	`ghobjeù_t
(
i
->
fœ¡
, 
ghobjeù_t
::
NO_GEN
, 
sh¬d
),

996 
j
->
g‘
<0>(è+ 
m
 + (
k
.
fœ¡
)*
subchunk_size
,

997 (
k
.
£cÚd
)*
subchunk_size
,

998 
bl0
, 
j
->
g‘
<2>());

999 
bl
.
	`şaim_­³nd
(
bl0
);

1004 ià(
r
 < 0) {

1005 
	`g‘_·»Á
()->
	`şog_”rÜ
(è<< "E¼Ü " << 
r


1007 << 
i
->
fœ¡
;

1008 
	`dout
(5è<< 
__func__
 << ": E¼Ü " << 
r


1009 << "„—dšg " << 
i
->
fœ¡
 << 
d’dl
;

1010 
”rÜ
;

1012 
	`dout
(20è<< 
__func__
 << "„—d„eque¡=" << 
j
->
g‘
<1>(è<< "„=" << 
r
 << "†’=" << 
bl
.
	`Ëngth
(è<< 
d’dl
;

1013 
»¶y
->
bufãrs_»ad
[
i
->
fœ¡
].
	`push_back
(

1014 
	`make_·œ
(

1015 
j
->
g‘
<0>(),

1016 
bl
)

1020 ià(!
	`g‘_·»Á
()->
	`g‘_poŞ
().
	`®lows_ecov”wr™es
()) {

1025 
	`as£¹
(
hšfo
->
	`has_chunk_hash
());

1026 ià((
bl
.
	`Ëngth
(è=ğ
hšfo
->
	`g‘_tÙ®_chunk_size
()) &&

1027 (
j
->
g‘
<0>() == 0)) {

1028 
	`dout
(20è<< 
__func__
 << ": Checkšg hash oà" << 
i
->
fœ¡
 << 
d’dl
;

1029 
bufãrhash
 
	`h
(-1);

1030 
h
 << 
bl
;

1031 ià(
h
.
	`dige¡
(è!ğ
hšfo
->
	`g‘_chunk_hash
(
sh¬d
)) {

1032 
	`g‘_·»Á
()->
	`şog_”rÜ
(è<< "Bad hash fÜ " << 
i
->
fœ¡
 << " digest 0x"

1033 << 
hex
 << 
h
.
	`dige¡
(è<< "ƒx³ùed 0x" << 
hšfo
->
	`g‘_chunk_hash
(
sh¬d
è<< 
dec
;

1034 
	`dout
(5è<< 
__func__
 << ": Bad hash fÜ " << 
i
->
fœ¡
 << " digest 0x"

1035 << 
hex
 << 
h
.
	`dige¡
(è<< "ƒx³ùed 0x" << 
hšfo
->
	`g‘_chunk_hash
(
sh¬d
è<< 
dec
 << 
d’dl
;

1036 
r
 = -
EIO
;

1037 
”rÜ
;

1043 
”rÜ
:

1046 
»¶y
->
bufãrs_»ad
.
	`”a£
(
i
->
fœ¡
);

1047 
»¶y
->
”rÜs
[
i
->
fœ¡
] = 
r
;

1049 
£t
<
hobjeù_t
>::
™”©Ü
 
i
 = 
İ
.
©Œs_to_»ad
.
	`begš
();

1050 
i
 !ğ
İ
.
©Œs_to_»ad
.
	`’d
();

1051 ++
i
) {

1052 
	`dout
(10è<< 
__func__
 << ": fulfilling‡ttr„equest on "

1053 << *
i
 << 
d’dl
;

1054 ià(
»¶y
->
”rÜs
.
	`couÁ
(*
i
))

1056 
r
 = 
¡Üe
->
	`g‘©Œs
(

1057 
ch
,

1058 
	`ghobjeù_t
(

1059 *
i
, 
ghobjeù_t
::
NO_GEN
, 
sh¬d
),

1060 
»¶y
->
©Œs_»ad
[*
i
]);

1061 ià(
r
 < 0) {

1062 
»¶y
->
bufãrs_»ad
.
	`”a£
(*
i
);

1063 
»¶y
->
”rÜs
[*
i
] = 
r
;

1066 
»¶y
->
äom
 = 
	`g‘_·»Á
()->
	`whßmi_sh¬d
();

1067 
»¶y
->
tid
 = 
İ
.tid;

1068 
	}
}

1070 
	gECBack’d
::
	$hªdË_sub_wr™e_»¶y
(

1071 
pg_sh¬d_t
 
äom
,

1072 cÚ¡ 
ECSubWr™eR•ly
 &
İ
,

1073 cÚ¡ 
ZT¿ûr
::
T¿û
 &
Œaû
)

1075 
m­
<
ûph_tid_t
, 
Op
>::
™”©Ü
 
i
 = 
tid_to_İ_m­
.
	`fšd
(
İ
.
tid
);

1076 
	`as£¹
(
i
 !ğ
tid_to_İ_m­
.
	`’d
());

1077 ià(
İ
.
comm™‹d
) {

1078 
Œaû
.
	`ev’t
("sub write committed");

1079 
	`as£¹
(
i
->
£cÚd
.
³ndšg_comm™
.
	`couÁ
(
äom
));

1080 
i
->
£cÚd
.
³ndšg_comm™
.
	`”a£
(
äom
);

1081 ià(
äom
 !ğ
	`g‘_·»Á
()->
	`whßmi_sh¬d
()) {

1082 
	`g‘_·»Á
()->
	`upd©e_³”_Ï¡_com¶‘e_Údisk
(
äom
, 
İ
.
Ï¡_com¶‘e
);

1085 ià(
İ
.
­¶›d
) {

1086 
Œaû
.
	`ev’t
("sub write‡pplied");

1087 
	`as£¹
(
i
->
£cÚd
.
³ndšg_­¶y
.
	`couÁ
(
äom
));

1088 
i
->
£cÚd
.
³ndšg_­¶y
.
	`”a£
(
äom
);

1091 ià(
i
->
£cÚd
.
³ndšg_comm™
.
	`em±y
() &&

1092 
i
->
£cÚd
.
Ú_®l_comm™
 &&

1094 
i
->
£cÚd
.
³ndšg_­¶y
.
	`em±y
()) {

1095 
	`dout
(10è<< 
__func__
 << " C®lšg on_®l_comm™ oÀ" << 
i
->
£cÚd
 << 
d’dl
;

1096 
i
->
£cÚd
.
Ú_®l_comm™
->
	`com¶‘e
(0);

1097 
i
->
£cÚd
.
Ú_®l_comm™
 = 0;

1098 
i
->
£cÚd
.
Œaû
.
	`ev’t
("ec write‡ll committed");

1100 
	`check_İs
();

1101 
	}
}

1103 
	gECBack’d
::
	$hªdË_sub_»ad_»¶y
(

1104 
pg_sh¬d_t
 
äom
,

1105 
ECSubR—dR•ly
 &
İ
,

1106 
Recov”yMes§ges
 *
m
,

1107 cÚ¡ 
ZT¿ûr
::
T¿û
 &
Œaû
)

1109 
Œaû
.
	`ev’t
("ec sub„ead„eply");

1110 
	`dout
(10è<< 
__func__
 << ":„•ly " << 
İ
 << 
d’dl
;

1111 
m­
<
ûph_tid_t
, 
R—dOp
>::
™”©Ü
 
™”
 = 
tid_to_»ad_m­
.
	`fšd
(
İ
.
tid
);

1112 ià(
™”
 =ğ
tid_to_»ad_m­
.
	`’d
()) {

1114 
	`dout
(20è<< 
__func__
 << ": drİ³d " << 
İ
 << 
d’dl
;

1117 
R—dOp
 &
rİ
 = 
™”
->
£cÚd
;

1118 autØ
i
 = 
İ
.
bufãrs_»ad
.
	`begš
();

1119 
i
 !ğ
İ
.
bufãrs_»ad
.
	`’d
();

1120 ++
i
) {

1121 
	`as£¹
(!
İ
.
”rÜs
.
	`couÁ
(
i
->
fœ¡
));

1122 ià(!
rİ
.
to_»ad
.
	`couÁ
(
i
->
fœ¡
)) {

1124 
	`dout
(20è<< 
__func__
 << "o_»ad skpšg" << 
d’dl
;

1127 
li¡
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
> >::
cÚ¡_™”©Ü
 
»q_™”
 =

1128 
rİ
.
to_»ad
.
	`fšd
(
i
->
fœ¡
)->
£cÚd
.to_»ad.
	`begš
();

1129 
li¡
<

1130 
boo¡
::
tu¶e
<

1131 
ušt64_t
, ušt64_t, 
m­
<
pg_sh¬d_t
, 
bufã¾i¡
> > >::
™”©Ü
 
r™”
 =

1132 
rİ
.
com¶‘e
[
i
->
fœ¡
].
»tuºed
.
	`begš
();

1133 
li¡
<
·œ
<
ušt64_t
, 
bufã¾i¡
> >::
™”©Ü
 
j
 = 
i
->
£cÚd
.
	`begš
();

1134 
j
 !ğ
i
->
£cÚd
.
	`’d
();

1135 ++
j
, ++
»q_™”
, ++
r™”
) {

1136 
	`as£¹
(
»q_™”
 !ğ
rİ
.
to_»ad
.
	`fšd
(
i
->
fœ¡
)->
£cÚd
.to_»ad.
	`’d
());

1137 
	`as£¹
(
r™”
 !ğ
rİ
.
com¶‘e
[
i
->
fœ¡
].
»tuºed
.
	`’d
());

1138 
·œ
<
ušt64_t
, ušt64_t> 
adju¡ed
 =

1139 
sšfo
.
	`®igÃd_off£t_Ën_to_chunk
(

1140 
	`make_·œ
(
»q_™”
->
g‘
<0>(),„eq_iter->get<1>()));

1141 
	`as£¹
(
adju¡ed
.
fœ¡
 =ğ
j
->first);

1142 
r™”
->
g‘
<2>()[
äom
].
	`şaim
(
j
->
£cÚd
);

1145 autØ
i
 = 
İ
.
©Œs_»ad
.
	`begš
();

1146 
i
 !ğ
İ
.
©Œs_»ad
.
	`’d
();

1147 ++
i
) {

1148 
	`as£¹
(!
İ
.
”rÜs
.
	`couÁ
(
i
->
fœ¡
));

1149 ià(!
rİ
.
to_»ad
.
	`couÁ
(
i
->
fœ¡
)) {

1151 
	`dout
(20è<< 
__func__
 << "o_»ad skpšg" << 
d’dl
;

1154 
rİ
.
com¶‘e
[
i
->
fœ¡
].
©Œs
 = 
m­
<
¡ršg
, 
bufã¾i¡
>();

1155 (*(
rİ
.
com¶‘e
[
i
->
fœ¡
].
©Œs
)).
	`sw­
(i->
£cÚd
);

1157 autØ
i
 = 
İ
.
”rÜs
.
	`begš
();

1158 
i
 !ğ
İ
.
”rÜs
.
	`’d
();

1159 ++
i
) {

1160 
rİ
.
com¶‘e
[
i
->
fœ¡
].
”rÜs
.
	`š£¹
(

1161 
	`make_·œ
(

1162 
äom
,

1163 
i
->
£cÚd
));

1164 
	`dout
(20è<< 
__func__
 << " sh¬d=" << 
äom
 << "ƒ¼Ü=" << 
i
->
£cÚd
 << 
d’dl
;

1167 
m­
<
pg_sh¬d_t
, 
£t
<
ûph_tid_t
> >::
™”©Ü
 
s™”
 =

1168 
sh¬d_to_»ad_m­
.
	`fšd
(
äom
);

1169 
	`as£¹
(
s™”
 !ğ
sh¬d_to_»ad_m­
.
	`’d
());

1170 
	`as£¹
(
s™”
->
£cÚd
.
	`couÁ
(
İ
.
tid
));

1171 
s™”
->
£cÚd
.
	`”a£
(
İ
.
tid
);

1173 
	`as£¹
(
rİ
.
š_´og»ss
.
	`couÁ
(
äom
));

1174 
rİ
.
š_´og»ss
.
	`”a£
(
äom
);

1175 
is_com¶‘e
 = 0;

1178 ià(
rİ
.
do_»dundªt_»ads
 ||„İ.
š_´og»ss
.
	`em±y
()) {

1179 
m­
<
hobjeù_t
, 
»ad_»suÉ_t
>::
cÚ¡_™”©Ü
 
™”
 =

1180 
rİ
.
com¶‘e
.
	`begš
();

1181 
™”
 !ğ
rİ
.
com¶‘e
.
	`’d
();

1182 ++
™”
) {

1183 
£t
<> 
have
;

1184 
m­
<
pg_sh¬d_t
, 
bufã¾i¡
>::
cÚ¡_™”©Ü
 
j
 =

1185 
™”
->
£cÚd
.
»tuºed
.
	`äÚt
().
g‘
<2>().
	`begš
();

1186 
j
 !ğ
™”
->
£cÚd
.
»tuºed
.
	`äÚt
().
g‘
<2>().
	`’d
();

1187 ++
j
) {

1188 
have
.
	`š£¹
(
j
->
fœ¡
.
sh¬d
);

1189 
	`dout
(20è<< 
__func__
 << " havsh¬d=" << 
j
->
fœ¡
.
sh¬d
 << 
d’dl
;

1191 
m­
<, 
veùÜ
<
·œ
<, >>> 
dummy_mšimum
;

1192 
”r
;

1193 ià((
”r
 = 
ec_im¶
->
	`mšimum_to_decode
(
rİ
.
wªt_to_»ad
[
™”
->
fœ¡
], 
have
, &
dummy_mšimum
)) < 0) {

1194 
	`dout
(20è<< 
__func__
 << " mšimum_to_decodçed" << 
d’dl
;

1195 ià(
rİ
.
š_´og»ss
.
	`em±y
()) {

1199 ià(!
rİ
.
do_»dundªt_»ads
) {

1200 
r
 = 
	`£nd_®l_»maššg_»ads
(
™”
->
fœ¡
, 
rİ
);

1201 ià(
r
 == 0) {

1212 
rİ
.
com¶‘e
[
™”
->
fœ¡
].
r
 = 
”r
;

1213 ++
is_com¶‘e
;

1216 
	`as£¹
(
rİ
.
com¶‘e
[
™”
->
fœ¡
].
r
 == 0);

1217 ià(!
rİ
.
com¶‘e
[
™”
->
fœ¡
].
”rÜs
.
	`em±y
()) {

1218 ià(
cù
->
_cÚf
->
osd_»ad_ec_check_fÜ_”rÜs
) {

1219 
	`dout
(10è<< 
__func__
 << ": NÙ ignÜšgƒ¼Üs, u£ oÃ sh¬dƒ¼=" << 
”r
 << 
d’dl
;

1220 
”r
 = 
rİ
.
com¶‘e
[
™”
->
fœ¡
].
”rÜs
.
	`begš
()->
£cÚd
;

1221 
rİ
.
com¶‘e
[
™”
->
fœ¡
].
r
 = 
”r
;

1223 
	`g‘_·»Á
()->
	`şog_w¬n
() << "Error(s) ignored for "

1224 << 
™”
->
fœ¡
 << "ƒnough copies‡vailable";

1225 
	`dout
(10è<< 
__func__
 << " E¼Ü(sèignÜed fÜ " << 
™”
->
fœ¡


1226 << "ƒnough cİ› avaabË" << 
d’dl
;

1227 
rİ
.
com¶‘e
[
™”
->
fœ¡
].
”rÜs
.
	`ş—r
();

1230 ++
is_com¶‘e
;

1234 ià(
rİ
.
š_´og»ss
.
	`em±y
(è|| 
is_com¶‘e
 =ğrİ.
com¶‘e
.
	`size
()) {

1235 
	`dout
(20è<< 
__func__
 << " Com¶‘e: " << 
rİ
 << 
d’dl
;

1236 
rİ
.
Œaû
.
	`ev’t
("ec„ead complete");

1237 
	`com¶‘e_»ad_İ
(
rİ
, 
m
);

1239 
	`dout
(10è<< 
__func__
 << "„—dİ‚Ù com¶‘e: " << 
rİ
 << 
d’dl
;

1241 
	}
}

1243 
	gECBack’d
::
	$com¶‘e_»ad_İ
(
R—dOp
 &
rİ
, 
Recov”yMes§ges
 *
m
)

1245 
m­
<
hobjeù_t
, 
»ad_»que¡_t
>::
™”©Ü
 
»q™”
 =

1246 
rİ
.
to_»ad
.
	`begš
();

1247 
m­
<
hobjeù_t
, 
»ad_»suÉ_t
>::
™”©Ü
 
»s™”
 =

1248 
rİ
.
com¶‘e
.
	`begš
();

1249 
	`as£¹
(
rİ
.
to_»ad
.
	`size
(è=ğrİ.
com¶‘e
.size());

1250 ; 
»q™”
 !ğ
rİ
.
to_»ad
.
	`’d
(); ++»q™”, ++
»s™”
) {

1251 ià(
»q™”
->
£cÚd
.
cb
) {

1252 
·œ
<
Recov”yMes§ges
 *, 
»ad_»suÉ_t
 &> 
	`¬g
(

1253 
m
, 
»s™”
->
£cÚd
);

1254 
»q™”
->
£cÚd
.
cb
->
	`com¶‘e
(
¬g
);

1255 
»q™”
->
£cÚd
.
cb
 = 
nuÎ±r
;

1258 
tid_to_»ad_m­
.
	`”a£
(
rİ
.
tid
);

1259 
	}
}

1261 
	gFšishR—dOp
 : 
public
 
G’CÚ‹xt
<
Th»adPoŞ
::
TPHªdË
&> {

1262 
ECBack’d
 *
ec
;

1263 
ûph_tid_t
 
	gtid
;

1264 
FšishR—dOp
(
ECBack’d
 *
ec
, 
ûph_tid_t
 
tid
) :ƒc(ec),id(tid) {}

1265 
fšish
(
Th»adPoŞ
::
TPHªdË
 &
hªdË
è
ov”ride
 {

1266 autØ
rİ™”
 = 
ec
->
tid_to_»ad_m­
.
fšd
(
tid
);

1267 
as£¹
(
rİ™”
 !ğ
ec
->
tid_to_»ad_m­
.
’d
());

1268 
	g´iÜ™y
 = 
rİ™”
->
£cÚd
.
´iÜ™y
;

1269 
Recov”yMes§ges
 
	grm
;

1270 
	gec
->
com¶‘e_»ad_İ
(
rİ™”
->
£cÚd
, &
rm
);

1271 
	gec
->
di¥©ch_»cov”y_mes§ges
(
rm
, 
´iÜ™y
);

1275 
	gECBack’d
::
	$f‹r_»ad_İ
(

1276 cÚ¡ 
OSDM­Ref
& 
osdm­
,

1277 
R—dOp
 &
İ
)

1279 
£t
<
hobjeù_t
> 
to_ÿnûl
;

1280 
m­
<
pg_sh¬d_t
, 
£t
<
hobjeù_t
> >::
™”©Ü
 
i
 = 
İ
.
sourû_to_obj
.
	`begš
();

1281 
i
 !ğ
İ
.
sourû_to_obj
.
	`’d
();

1282 ++
i
) {

1283 ià(
osdm­
->
	`is_down
(
i
->
fœ¡
.
osd
)) {

1284 
to_ÿnûl
.
	`š£¹
(
i
->
£cÚd
.
	`begš
(), i->£cÚd.
	`’d
());

1285 
İ
.
š_´og»ss
.
	`”a£
(
i
->
fœ¡
);

1290 ià(
to_ÿnûl
.
	`em±y
())

1293 
m­
<
pg_sh¬d_t
, 
£t
<
hobjeù_t
> >::
™”©Ü
 
i
 = 
İ
.
sourû_to_obj
.
	`begš
();

1294 
i
 !ğ
İ
.
sourû_to_obj
.
	`’d
();

1296 
£t
<
hobjeù_t
>::
™”©Ü
 
j
 = 
i
->
£cÚd
.
	`begš
();

1297 
j
 !ğ
i
->
£cÚd
.
	`’d
();

1299 ià(
to_ÿnûl
.
	`couÁ
(*
j
))

1300 
i
->
£cÚd
.
	`”a£
(
j
++);

1302 ++
j
;

1304 ià(
i
->
£cÚd
.
	`em±y
()) {

1305 
İ
.
sourû_to_obj
.
	`”a£
(
i
++);

1307 
	`as£¹
(!
osdm­
->
	`is_down
(
i
->
fœ¡
.
osd
));

1308 ++
i
;

1312 
£t
<
hobjeù_t
>::
™”©Ü
 
i
 = 
to_ÿnûl
.
	`begš
();

1313 
i
 !ğ
to_ÿnûl
.
	`’d
();

1314 ++
i
) {

1315 
	`g‘_·»Á
()->
	`ÿnûl_puÎ
(*
i
);

1317 
	`as£¹
(
İ
.
to_»ad
.
	`couÁ
(*
i
));

1318 
»ad_»que¡_t
 &
»q
 = 
İ
.
to_»ad
.
	`fšd
(*
i
)->
£cÚd
;

1319 
	`dout
(10è<< 
__func__
 << ": cªûlšg " << 
»q


1320 << " fÜ obj " << *
i
 << 
d’dl
;

1321 
	`as£¹
(
»q
.
cb
);

1322 
d–‘e
 
»q
.
cb
;

1323 
»q
.
cb
 = 
nuÎ±r
;

1325 
İ
.
to_»ad
.
	`”a£
(*
i
);

1326 
İ
.
com¶‘e
.
	`”a£
(*
i
);

1327 
»cov”y_İs
.
	`”a£
(*
i
);

1330 ià(
İ
.
š_´og»ss
.
	`em±y
()) {

1331 
	`g‘_·»Á
()->
	`scheduË_»cov”y_wÜk
(

1332 
	`g‘_·»Á
()->
	`bËss_uÆocked_g’cÚ‹xt
(

1333 
Ãw
 
	`FšishR—dOp
(
this
, 
İ
.
tid
)));

1335 
	}
}

1337 
	gECBack’d
::
	$check_»cov”y_sourûs
(cÚ¡ 
OSDM­Ref
& 
osdm­
)

1339 
£t
<
ûph_tid_t
> 
tids_to_f‹r
;

1340 
m­
<
pg_sh¬d_t
, 
£t
<
ûph_tid_t
> >::
™”©Ü


1341 
i
 = 
sh¬d_to_»ad_m­
.
	`begš
();

1342 
i
 !ğ
sh¬d_to_»ad_m­
.
	`’d
();

1344 ià(
osdm­
->
	`is_down
(
i
->
fœ¡
.
osd
)) {

1345 
tids_to_f‹r
.
	`š£¹
(
i
->
£cÚd
.
	`begš
(), i->£cÚd.
	`’d
());

1346 
sh¬d_to_»ad_m­
.
	`”a£
(
i
++);

1348 ++
i
;

1351 
£t
<
ûph_tid_t
>::
™”©Ü
 
i
 = 
tids_to_f‹r
.
	`begš
();

1352 
i
 !ğ
tids_to_f‹r
.
	`’d
();

1353 ++
i
) {

1354 
m­
<
ûph_tid_t
, 
R—dOp
>::
™”©Ü
 
j
 = 
tid_to_»ad_m­
.
	`fšd
(*
i
);

1355 
	`as£¹
(
j
 !ğ
tid_to_»ad_m­
.
	`’d
());

1356 
	`f‹r_»ad_İ
(
osdm­
, 
j
->
£cÚd
);

1358 
	}
}

1360 
	gECBack’d
::
	$Ú_chªge
()

1362 
	`dout
(10è<< 
__func__
 << 
d’dl
;

1364 
com¶‘ed_to
 = 
	`ev”siÚ_t
();

1365 
comm™‹d_to
 = 
	`ev”siÚ_t
();

1366 
p–še_¡©e
.
	`ş—r
();

1367 
wa™šg_»ads
.
	`ş—r
();

1368 
wa™šg_¡©e
.
	`ş—r
();

1369 
wa™šg_comm™
.
	`ş—r
();

1370 autØ&&
İ
: 
tid_to_İ_m­
) {

1371 
ÿche
.
	`»Ëa£_wr™e_pš
(
İ
.
£cÚd
.
pš
);

1373 
tid_to_İ_m­
.
	`ş—r
();

1375 
m­
<
ûph_tid_t
, 
R—dOp
>::
™”©Ü
 
i
 = 
tid_to_»ad_m­
.
	`begš
();

1376 
i
 !ğ
tid_to_»ad_m­
.
	`’d
();

1377 ++
i
) {

1378 
	`dout
(10è<< 
__func__
 << ": cªûÎšg " << 
i
->
£cÚd
 << 
d’dl
;

1379 
m­
<
hobjeù_t
, 
»ad_»que¡_t
>::
™”©Ü
 
j
 =

1380 
i
->
£cÚd
.
to_»ad
.
	`begš
();

1381 
j
 !ğ
i
->
£cÚd
.
to_»ad
.
	`’d
();

1382 ++
j
) {

1383 
d–‘e
 
j
->
£cÚd
.
cb
;

1384 
j
->
£cÚd
.
cb
 = 
nuÎ±r
;

1387 
tid_to_»ad_m­
.
	`ş—r
();

1388 
š_´og»ss_ş›Á_»ads
.
	`ş—r
();

1389 
sh¬d_to_»ad_m­
.
	`ş—r
();

1390 
	`ş—r_»cov”y_¡©e
();

1391 
	}
}

1393 
	gECBack’d
::
	$ş—r_»cov”y_¡©e
()

1395 
»cov”y_İs
.
	`ş—r
();

1396 
	}
}

1398 
	gECBack’d
::
	$dump_»cov”y_šfo
(
FÜm©‹r
 *
f
) const

1400 
f
->
	`İ’_¬¿y_£ùiÚ
("recovery_ops");

1401 
m­
<
hobjeù_t
, 
Recov”yOp
>::
cÚ¡_™”©Ü
 
i
 = 
»cov”y_İs
.
	`begš
();

1402 
i
 !ğ
»cov”y_İs
.
	`’d
();

1403 ++
i
) {

1404 
f
->
	`İ’_objeù_£ùiÚ
("op");

1405 
i
->
£cÚd
.
	`dump
(
f
);

1406 
f
->
	`şo£_£ùiÚ
();

1408 
f
->
	`şo£_£ùiÚ
();

1409 
f
->
	`İ’_¬¿y_£ùiÚ
("read_ops");

1410 
m­
<
ûph_tid_t
, 
R—dOp
>::
cÚ¡_™”©Ü
 
i
 = 
tid_to_»ad_m­
.
	`begš
();

1411 
i
 !ğ
tid_to_»ad_m­
.
	`’d
();

1412 ++
i
) {

1413 
f
->
	`İ’_objeù_£ùiÚ
("read_op");

1414 
i
->
£cÚd
.
	`dump
(
f
);

1415 
f
->
	`şo£_£ùiÚ
();

1417 
f
->
	`şo£_£ùiÚ
();

1418 
	}
}

1420 
	gECBack’d
::
subm™_Œª§ùiÚ
(

1421 cÚ¡ 
hobjeù_t
 &
hoid
,

1422 cÚ¡ 
objeù_¡©_sum_t
 &
d–_¡©s
,

1423 cÚ¡ 
ev”siÚ_t
 &
©_v”siÚ
,

1424 
PGT¿n§ùiÚUPŒ
 &&
t
,

1425 cÚ¡ 
ev”siÚ_t
 &
Œim_to
,

1426 cÚ¡ 
ev”siÚ_t
 &
rŞl_fÜw¬d_to
,

1427 cÚ¡ 
veùÜ
<
pg_log_’Œy_t
> &
log_’Œ›s
,

1428 
boo¡
::
İtiÚ®
<
pg_h™_£t_hi¡Üy_t
> &
h£t_hi¡Üy
,

1429 
CÚ‹xt
 *
Ú_®l_comm™
,

1430 
ûph_tid_t
 
tid
,

1431 
osd_»qid_t
 
»qid
,

1432 
OpReque¡Ref
 
ş›Á_İ


1435 
as£¹
(!
tid_to_İ_m­
.
couÁ
(
tid
));

1436 
Op
 *
	gİ
 = &(
tid_to_İ_m­
[
tid
]);

1437 
	gİ
->
	ghoid
 = 
hoid
;

1438 
	gİ
->
	gd–_¡©s
 = 
d–_¡©s
;

1439 
	gİ
->
	gv”siÚ
 = 
©_v”siÚ
;

1440 
	gİ
->
	gŒim_to
 = 
Œim_to
;

1441 
	gİ
->
	grŞl_fÜw¬d_to
 = 
¡d
::
max
(
rŞl_fÜw¬d_to
, 
comm™‹d_to
);

1442 
	gİ
->
	glog_’Œ›s
 = 
log_’Œ›s
;

1443 
	g¡d
::
sw­
(
İ
->
upd©ed_h™_£t_hi¡Üy
, 
h£t_hi¡Üy
);

1444 
	gİ
->
	gÚ_®l_comm™
 = 
Ú_®l_comm™
;

1445 
	gİ
->
	gtid
 = 
tid
;

1446 
	gİ
->
	g»qid
 = 
»qid
;

1447 
	gİ
->
	gş›Á_İ
 = 
ş›Á_İ
;

1448 ià(
	gş›Á_İ
)

1449 
	gİ
->
	gŒaû
 = 
ş›Á_İ
->
pg_Œaû
;

1451 
dout
(10è<< 
	g__func__
 << ": o°" << *
	gİ
 << " s¹šg" << 
	gd’dl
;

1452 
¡¬t_rmw
(
İ
, 
¡d
::
move
(
t
));

1455 
	gECBack’d
::
ÿÎ_wr™e_Üd”ed
(
¡d
::
funùiÚ
<()> &&
cb
) {

1456 ià(!
wa™šg_¡©e
.
em±y
()) {

1457 
wa™šg_¡©e
.
back
().
Ú_wr™e
.
em¶aû_back
(
¡d
::
move
(
cb
));

1458 } ià(!
	gwa™šg_»ads
.
em±y
()) {

1459 
	gwa™šg_»ads
.
back
().
	gÚ_wr™e
.
em¶aû_back
(
¡d
::
move
(
cb
));

1462 
cb
();

1466 
	gECBack’d
::
g‘_®l_ava_sh¬ds
(

1467 cÚ¡ 
hobjeù_t
 &
hoid
,

1468 cÚ¡ 
£t
<
pg_sh¬d_t
> &
”rÜ_sh¬ds
,

1469 
£t
<> &
have
,

1470 
m­
<
sh¬d_id_t
, 
pg_sh¬d_t
> &
sh¬ds
,

1471 
boŞ
 
fÜ_»cov”y
)

1473 
	g£t
<
	gpg_sh¬d_t
>::
cÚ¡_™”©Ü
 
i
 =

1474 
g‘_·»Á
()->
g‘_aùšg_sh¬ds
().
begš
();

1475 
	gi
 !ğ
g‘_·»Á
()->
g‘_aùšg_sh¬ds
().
’d
();

1476 ++
	gi
) {

1477 
dout
(10è<< 
	g__func__
 << ": checkšg‡ùšg " << *
	gi
 << 
	gd’dl
;

1478 cÚ¡ 
	gpg_missšg_t
 &
	gmissšg
 = 
g‘_·»Á
()->
g‘_sh¬d_missšg
(*
i
);

1479 ià(
	g”rÜ_sh¬ds
.
fšd
(*
i
è!ğ
”rÜ_sh¬ds
.
’d
())

1481 ià(!
	gmissšg
.
is_missšg
(
hoid
)) {

1482 
as£¹
(!
have
.
couÁ
(
i
->
sh¬d
));

1483 
	ghave
.
š£¹
(
i
->
sh¬d
);

1484 
as£¹
(!
sh¬ds
.
couÁ
(
i
->
sh¬d
));

1485 
	gsh¬ds
.
š£¹
(
make_·œ
(
i
->
sh¬d
, *i));

1489 ià(
	gfÜ_»cov”y
) {

1490 
	g£t
<
	gpg_sh¬d_t
>::
cÚ¡_™”©Ü
 
i
 =

1491 
g‘_·»Á
()->
g‘_backfl_sh¬ds
().
begš
();

1492 
	gi
 !ğ
g‘_·»Á
()->
g‘_backfl_sh¬ds
().
’d
();

1493 ++
	gi
) {

1494 ià(
	g”rÜ_sh¬ds
.
fšd
(*
i
è!ğ
”rÜ_sh¬ds
.
’d
())

1496 ià(
	ghave
.
couÁ
(
i
->
sh¬d
)) {

1497 
as£¹
(
sh¬ds
.
couÁ
(
i
->
sh¬d
));

1500 
dout
(10è<< 
	g__func__
 << ": checkšg backfÈ" << *
	gi
 << 
	gd’dl
;

1501 
as£¹
(!
sh¬ds
.
couÁ
(
i
->
sh¬d
));

1502 cÚ¡ 
	gpg_šfo_t
 &
	gšfo
 = 
g‘_·»Á
()->
g‘_sh¬d_šfo
(*
i
);

1503 cÚ¡ 
	gpg_missšg_t
 &
	gmissšg
 = 
g‘_·»Á
()->
g‘_sh¬d_missšg
(*
i
);

1504 ià(
	ghoid
 < 
	gšfo
.
	gÏ¡_backfl
 &&

1505 !
	gmissšg
.
is_missšg
(
hoid
)) {

1506 
	ghave
.
š£¹
(
i
->
sh¬d
);

1507 
	gsh¬ds
.
š£¹
(
make_·œ
(
i
->
sh¬d
, *i));

1511 
	gm­
<
	ghobjeù_t
, 
	g£t
<
	gpg_sh¬d_t
>>::
cÚ¡_™”©Ü
 
m™”
 =

1512 
g‘_·»Á
()->
g‘_missšg_loc_sh¬ds
().
fšd
(
hoid
);

1513 ià(
	gm™”
 !ğ
g‘_·»Á
()->
g‘_missšg_loc_sh¬ds
().
’d
()) {

1514 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
m™”
->
£cÚd
.
begš
();

1515 
	gi
 !ğ
m™”
->
£cÚd
.
’d
();

1516 ++
	gi
) {

1517 
dout
(10è<< 
	g__func__
 << ": checkšg missšg_loø" << *
	gi
 << 
	gd’dl
;

1518 autØ
	gm
 = 
g‘_·»Á
()->
maybe_g‘_sh¬d_missšg
(*
i
);

1519 ià(
	gm
) {

1520 
as£¹
(!(*
m
).
is_missšg
(
hoid
));

1522 ià(
	g”rÜ_sh¬ds
.
fšd
(*
i
è!ğ
”rÜ_sh¬ds
.
’d
())

1524 
	ghave
.
š£¹
(
i
->
sh¬d
);

1525 
	gsh¬ds
.
š£¹
(
make_·œ
(
i
->
sh¬d
, *i));

1531 
	gECBack’d
::
g‘_mš_ava_to_»ad_sh¬ds
(

1532 cÚ¡ 
hobjeù_t
 &
hoid
,

1533 cÚ¡ 
£t
<> &
wªt
,

1534 
boŞ
 
fÜ_»cov”y
,

1535 
boŞ
 
do_»dundªt_»ads
,

1536 
m­
<
pg_sh¬d_t
, 
veùÜ
<
·œ
<, >>> *
to_»ad
)

1539 
as£¹
(!
fÜ_»cov”y
 || !
do_»dundªt_»ads
);

1541 
	g£t
<> 
	ghave
;

1542 
	gm­
<
	gsh¬d_id_t
, 
	gpg_sh¬d_t
> 
	gsh¬ds
;

1543 
	g£t
<
	gpg_sh¬d_t
> 
	g”rÜ_sh¬ds
;

1545 
g‘_®l_ava_sh¬ds
(
hoid
, 
”rÜ_sh¬ds
, 
have
, 
sh¬ds
, 
fÜ_»cov”y
);

1547 
	gm­
<, 
	gveùÜ
<
	g·œ
<, >>> 
	gÃed
;

1548 
	gr
 = 
ec_im¶
->
mšimum_to_decode
(
wªt
, 
have
, &
Ãed
);

1549 ià(
	gr
 < 0)

1550  
	gr
;

1552 ià(
	gdo_»dundªt_»ads
) {

1553 
	gveùÜ
<
	g·œ
<, >> 
	gsubchunks_li¡
;

1554 
	gsubchunks_li¡
.
push_back
(
make_·œ
(0, 
ec_im¶
->
g‘_sub_chunk_couÁ
()));

1555 autØ&&
	gi
: 
have
) {

1556 
Ãed
[
i
] = 
subchunks_li¡
;

1560 ià(!
	gto_»ad
)

1563 autØ&&
	gi
:
Ãed
) {

1564 
as£¹
(
sh¬ds
.
couÁ
(
sh¬d_id_t
(
i
.
fœ¡
)));

1565 
	gto_»ad
->
š£¹
(
make_·œ
(
sh¬ds
[
sh¬d_id_t
(
i
.
fœ¡
)], i.
£cÚd
));

1570 
	gECBack’d
::
g‘_»maššg_sh¬ds
(

1571 cÚ¡ 
hobjeù_t
 &
hoid
,

1572 cÚ¡ 
£t
<> &
ava
,

1573 cÚ¡ 
£t
<> &
wªt
,

1574 cÚ¡ 
»ad_»suÉ_t
 &
»suÉ
,

1575 
m­
<
pg_sh¬d_t
, 
veùÜ
<
·œ
<, >>> *
to_»ad
,

1576 
boŞ
 
fÜ_»cov”y
)

1578 
as£¹
(
to_»ad
);

1580 
	g£t
<> 
	ghave
;

1581 
	gm­
<
	gsh¬d_id_t
, 
	gpg_sh¬d_t
> 
	gsh¬ds
;

1582 
	g£t
<
	gpg_sh¬d_t
> 
	g”rÜ_sh¬ds
;

1583 autØ&
	gp
 : 
»suÉ
.
”rÜs
) {

1584 
”rÜ_sh¬ds
.
š£¹
(
p
.
fœ¡
);

1587 
g‘_®l_ava_sh¬ds
(
hoid
, 
”rÜ_sh¬ds
, 
have
, 
sh¬ds
, 
fÜ_»cov”y
);

1589 
	gm­
<, 
	gveùÜ
<
	g·œ
<, >>> 
	gÃed
;

1590 
	gr
 = 
ec_im¶
->
mšimum_to_decode
(
wªt
, 
have
, &
Ãed
);

1591 ià(
	gr
 < 0) {

1592 
dout
(0è<< 
	g__func__
 << "‚Ùƒnough sh¬d ËáØŒy fÜ " << 
	ghoid


1593 << "„—d„esuÉ wa " << 
	g»suÉ
 << 
	gd’dl
;

1594  -
	gEIO
;

1597 
	g£t
<> 
	gsh¬ds_Ëá
;

1598 autØ
	gp
 : 
Ãed
) {

1599 ià(
ava
.
fšd
(
p
.
fœ¡
è=ğava.
’d
()) {

1600 
sh¬ds_Ëá
.
š£¹
(
p
.
fœ¡
);

1604 
	gveùÜ
<
	g·œ
<, >> 
	gsubchunks
;

1605 
	gsubchunks
.
push_back
(
make_·œ
(0, 
ec_im¶
->
g‘_sub_chunk_couÁ
()));

1606 
	g£t
<>::
™”©Ü
 
i
 = 
sh¬ds_Ëá
.
begš
();

1607 
	gi
 !ğ
sh¬ds_Ëá
.
’d
();

1608 ++
	gi
) {

1609 
as£¹
(
sh¬ds
.
couÁ
(
sh¬d_id_t
(*
i
)));

1610 
as£¹
(
ava
.
fšd
(*
i
è=ğava.
’d
());

1611 
	gto_»ad
->
š£¹
(
make_·œ
(
sh¬ds
[
sh¬d_id_t
(*
i
)], 
subchunks
));

1616 
	gECBack’d
::
¡¬t_»ad_İ
(

1617 
´iÜ™y
,

1618 
m­
<
hobjeù_t
, 
£t
<>> &
wªt_to_»ad
,

1619 
m­
<
hobjeù_t
, 
»ad_»que¡_t
> &
to_»ad
,

1620 
OpReque¡Ref
 
_İ
,

1621 
boŞ
 
do_»dundªt_»ads
,

1622 
boŞ
 
fÜ_»cov”y
)

1624 
ûph_tid_t
 
	gtid
 = 
g‘_·»Á
()->
g‘_tid
();

1625 
as£¹
(!
tid_to_»ad_m­
.
couÁ
(
tid
));

1626 autØ&
	gİ
 = 
tid_to_»ad_m­
.
em¶aû
(

1627 
tid
,

1628 
R—dOp
(

1629 
´iÜ™y
,

1630 
tid
,

1631 
do_»dundªt_»ads
,

1632 
fÜ_»cov”y
,

1633 
_İ
,

1634 
¡d
::
move
(
wªt_to_»ad
),

1635 
¡d
::
move
(
to_»ad
))).
fœ¡
->
£cÚd
;

1636 
dout
(10è<< 
	g__func__
 << ": s¹šg " << 
	gİ
 << 
	gd’dl
;

1637 ià(
	g_İ
) {

1638 
	gİ
.
	gŒaû
 = 
_İ
->
pg_Œaû
;

1639 
	gİ
.
	gŒaû
.
ev’t
("startƒc„ead");

1641 
do_»ad_İ
(
İ
);

1644 
	gECBack’d
::
	$do_»ad_İ
(
R—dOp
 &
İ
)

1646 
´iÜ™y
 = 
İ
.priority;

1647 
ûph_tid_t
 
tid
 = 
İ
.tid;

1649 
	`dout
(10è<< 
__func__
 << ": s¹šg„—d " << 
İ
 << 
d’dl
;

1651 
m­
<
pg_sh¬d_t
, 
ECSubR—d
> 
mes§ges
;

1652 
m­
<
hobjeù_t
, 
»ad_»que¡_t
>::
™”©Ü
 
i
 = 
İ
.
to_»ad
.
	`begš
();

1653 
i
 !ğ
İ
.
to_»ad
.
	`’d
();

1654 ++
i
) {

1655 
boŞ
 
Ãed_©Œs
 = 
i
->
£cÚd
.
wªt_©Œs
;

1657 autØ
j
 = 
i
->
£cÚd
.
Ãed
.
	`begš
();

1658 
j
 !ğ
i
->
£cÚd
.
Ãed
.
	`’d
();

1659 ++
j
) {

1660 ià(
Ãed_©Œs
) {

1661 
mes§ges
[
j
->
fœ¡
].
©Œs_to_»ad
.
	`š£¹
(
i
->first);

1662 
Ãed_©Œs
 = 
çl£
;

1664 
mes§ges
[
j
->
fœ¡
].
subchunks
[
i
->fœ¡] = j->
£cÚd
;

1665 
İ
.
obj_to_sourû
[
i
->
fœ¡
].
	`š£¹
(
j
->first);

1666 
İ
.
sourû_to_obj
[
j
->
fœ¡
].
	`š£¹
(
i
->first);

1668 
li¡
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
> >::
cÚ¡_™”©Ü
 
j
 =

1669 
i
->
£cÚd
.
to_»ad
.
	`begš
();

1670 
j
 !ğ
i
->
£cÚd
.
to_»ad
.
	`’d
();

1671 ++
j
) {

1672 
·œ
<
ušt64_t
, ušt64_t> 
chunk_off_Ën
 =

1673 
sšfo
.
	`®igÃd_off£t_Ën_to_chunk
(
	`make_·œ
(
j
->
g‘
<0>(), j->get<1>()));

1674 autØ
k
 = 
i
->
£cÚd
.
Ãed
.
	`begš
();

1675 
k
 !ğ
i
->
£cÚd
.
Ãed
.
	`’d
();

1676 ++
k
) {

1677 
mes§ges
[
k
->
fœ¡
].
to_»ad
[
i
->fœ¡].
	`push_back
(

1678 
boo¡
::
	`make_tu¶e
(

1679 
chunk_off_Ën
.
fœ¡
,

1680 
chunk_off_Ën
.
£cÚd
,

1681 
j
->
g‘
<2>()));

1683 
	`as£¹
(!
Ãed_©Œs
);

1687 
m­
<
pg_sh¬d_t
, 
ECSubR—d
>::
™”©Ü
 
i
 = 
mes§ges
.
	`begš
();

1688 
i
 !ğ
mes§ges
.
	`’d
();

1689 ++
i
) {

1690 
İ
.
š_´og»ss
.
	`š£¹
(
i
->
fœ¡
);

1691 
sh¬d_to_»ad_m­
[
i
->
fœ¡
].
	`š£¹
(
İ
.
tid
);

1692 
i
->
£cÚd
.
tid
 =id;

1693 
MOSDECSubOpR—d
 *
msg
 = 
Ãw
 MOSDECSubOpRead;

1694 
msg
->
	`£t_´iÜ™y
(
´iÜ™y
);

1695 
msg
->
pgid
 = 
	`¥g_t
(

1696 
	`g‘_·»Á
()->
	`whßmi_¥g_t
().
pgid
,

1697 
i
->
fœ¡
.
sh¬d
);

1698 
msg
->
m­_•och
 = 
	`g‘_·»Á
()->
	`g‘_•och
();

1699 
msg
->
mš_•och
 = 
	`g‘_·»Á
()->
	`g‘_š‹rv®_¡¬t_•och
();

1700 
msg
->
İ
 = 
i
->
£cÚd
;

1701 
msg
->
İ
.
äom
 = 
	`g‘_·»Á
()->
	`whßmi_sh¬d
();

1702 
msg
->
İ
.
tid
 =id;

1703 ià(
İ
.
Œaû
) {

1705 
msg
->
Œaû
.
	`š™
("eøsub„—d", 
nuÎ±r
, &
İ
.trace);

1706 
msg
->
Œaû
.
	`keyv®
("sh¬d", 
i
->
fœ¡
.
sh¬d
.
id
);

1708 
	`g‘_·»Á
()->
	`£nd_mes§ge_osd_şu¡”
(

1709 
i
->
fœ¡
.
osd
,

1710 
msg
,

1711 
	`g‘_·»Á
()->
	`g‘_•och
());

1713 
	`dout
(10è<< 
__func__
 << ": s¹ed " << 
İ
 << 
d’dl
;

1714 
	}
}

1716 
	gECUt
::
HashInfoRef
 
ECBack’d
::
g‘_hash_šfo
(

1717 cÚ¡ 
hobjeù_t
 &
hoid
, 
boŞ
 
checks
, cÚ¡ 
m­
<
¡ršg
,
bufã½Œ
> *
©Œs
)

1719 
dout
(10è<< 
	g__func__
 << ": G‘tšg‡‰¸Ú " << 
	ghoid
 << 
	gd’dl
;

1720 
	gECUt
::
HashInfoRef
 
»f
 = 
un¡abË_hashšfo_»gi¡ry
.
lookup
(
hoid
);

1721 ià(!
	g»f
) {

1722 
dout
(10è<< 
	g__func__
 << ":‚Ù iÀÿch" << 
	ghoid
 << 
	gd’dl
;

1723 
¡©
 
	g¡
;

1724 
	gr
 = 
¡Üe
->
¡©
(

1725 
ch
,

1726 
ghobjeù_t
(
hoid
, ghobjeù_t::
NO_GEN
, 
g‘_·»Á
()->
whßmi_sh¬d
().
sh¬d
),

1727 &
¡
);

1728 
	gECUt
::
HashInfo
 
hšfo
(
ec_im¶
->
g‘_chunk_couÁ
());

1730 ià(
	gr
 >= 0) {

1731 
dout
(10è<< 
__func__
 << ": found oÀdisk, siz" << 
¡
.
¡_size
 << 
d’dl
;

1732 
bufã¾i¡
 
	gbl
;

1733 ià(
	g©Œs
) {

1734 
	gm­
<
	g¡ršg
, 
	gbufã½Œ
>::
cÚ¡_™”©Ü
 
k
 = 
©Œs
->
fšd
(
ECUt
::
g‘_hšfo_key
());

1735 ià(
	gk
 =ğ
©Œs
->
’d
()) {

1736 
dout
(5è<< 
__func__
 << " " << 
hoid
 << " missšg hšfØ©Œ" << 
d’dl
;

1738 
	gbl
.
push_back
(
k
->
£cÚd
);

1741 
	gr
 = 
¡Üe
->
g‘©Œ
(

1742 
ch
,

1743 
ghobjeù_t
(
hoid
, ghobjeù_t::
NO_GEN
, 
g‘_·»Á
()->
whßmi_sh¬d
().
sh¬d
),

1744 
ECUt
::
g‘_hšfo_key
(),

1745 
bl
);

1746 ià(
	gr
 < 0) {

1747 
dout
(5è<< 
	g__func__
 << ": g‘©Œ faed: " << 
ıp_¡»¼Ü
(
r
è<< 
	gd’dl
;

1748 
	gbl
.
ş—r
();

1751 ià(
	gbl
.
Ëngth
() > 0) {

1752 
	gbufã¾i¡
::
™”©Ü
 
bp
 = 
bl
.
begš
();

1753 
	gŒy
 {

1754 
decode
(
hšfo
, 
bp
);

1755 } 
ÿtch
(...) {

1756 
dout
(0è<< 
	g__func__
 << ": Cª'ˆdecodhšfØfÜ " << 
	ghoid
 << 
	gd’dl
;

1757  
	gECUt
::
HashInfoRef
();

1759 ià(
	gchecks
 && 
	ghšfo
.
g‘_tÙ®_chunk_size
(è!ğ(
ušt64_t
)
¡
.
¡_size
) {

1760 
dout
(0è<< 
__func__
 << ": Mismatch ofotal_chunk_size "

1761 << 
hšfo
.
g‘_tÙ®_chunk_size
(è<< 
d’dl
;

1762  
	gECUt
::
HashInfoRef
();

1764 } ià(
	g¡
.
	g¡_size
 > 0) {

1765  
	gECUt
::
HashInfoRef
();

1768 
	g»f
 = 
un¡abË_hashšfo_»gi¡ry
.
lookup_Ü_ü—‹
(
hoid
, 
hšfo
);

1770  
	g»f
;

1773 
	gECBack’d
::
	$¡¬t_rmw
(
Op
 *
İ
, 
PGT¿n§ùiÚUPŒ
 &&
t
)

1775 
	`as£¹
(
İ
);

1777 
İ
->
¶ª
 = 
ECT¿n§ùiÚ
::
	`g‘_wr™e_¶ª
(

1778 
sšfo
,

1779 
¡d
::
	`move
(
t
),

1780 [&](cÚ¡ 
hobjeù_t
 &
i
) {

1781 
ECUt
::
HashInfoRef
 
»f
 = 
	`g‘_hash_šfo
(
i
, 
çl£
);

1782 ià(!
»f
) {

1783 
d”r
 << 
__func__
 << ": g‘_hash_šfo(" << 
i
 << ")"

1786 << " cÚ‹xt" << 
d’dl
;

1787 
	`ûph_abÜt
();

1789  
»f
;

1791 
	`g‘_·»Á
()->
	`g‘_dµ
());

1793 
	`dout
(10è<< 
__func__
 << ": " << *
İ
 << 
d’dl
;

1795 
wa™šg_¡©e
.
	`push_back
(*
İ
);

1796 
	`check_İs
();

1797 
	}
}

1799 
boŞ
 
	gECBack’d
::
	$Œy_¡©e_to_»ads
()

1801 ià(
wa™šg_¡©e
.
	`em±y
())

1802  
çl£
;

1804 
Op
 *
İ
 = &(
wa™šg_¡©e
.
	`äÚt
());

1805 ià(
İ
->
	`»quœes_rmw
(è&& 
p–še_¡©e
.
	`ÿche_šv®id
()) {

1806 
	`as£¹
(
	`g‘_·»Á
()->
	`g‘_poŞ
().
	`®lows_ecov”wr™es
());

1807 
	`dout
(20è<< 
__func__
 << ": blockšg " << *
İ


1809 << 
p–še_¡©e


1810 << 
d’dl
;

1811  
çl£
;

1814 ià(
İ
->
	`šv®id©es_ÿche
()) {

1815 
	`dout
(20è<< 
__func__
 << ": invalidating cache‡fterhis op"

1816 << 
d’dl
;

1817 
p–še_¡©e
.
	`šv®id©e
();

1818 
İ
->
usšg_ÿche
 = 
çl£
;

1820 
İ
->
usšg_ÿche
 = 
p–še_¡©e
.
	`ÿchšg_’abËd
();

1823 
wa™šg_¡©e
.
	`pİ_äÚt
();

1824 
wa™šg_»ads
.
	`push_back
(*
İ
);

1826 ià(
İ
->
usšg_ÿche
) {

1827 
ÿche
.
	`İ’_wr™e_pš
(
İ
->
pš
);

1829 
ex‹Á_£t
 
em±y
;

1830 autØ&&
h·œ
: 
İ
->
¶ª
.
wl_wr™e
) {

1831 autØ
to_»ad_¶ª_™”
 = 
İ
->
¶ª
.
to_»ad
.
	`fšd
(
h·œ
.
fœ¡
);

1832 cÚ¡ 
ex‹Á_£t
 &
to_»ad_¶ª
 =

1833 
to_»ad_¶ª_™”
 =ğ
İ
->
¶ª
.
to_»ad
.
	`’d
() ?

1834 
em±y
 :

1835 
to_»ad_¶ª_™”
->
£cÚd
;

1837 
ex‹Á_£t
 
»mÙe_»ad
 = 
ÿche
.
	`»£rve_ex‹Ás_fÜ_rmw
(

1838 
h·œ
.
fœ¡
,

1839 
İ
->
pš
,

1840 
h·œ
.
£cÚd
,

1841 
to_»ad_¶ª
);

1843 
ex‹Á_£t
 
³ndšg_»ad
 = 
to_»ad_¶ª
;

1844 
³ndšg_»ad
.
	`subŒaù
(
»mÙe_»ad
);

1846 ià(!
»mÙe_»ad
.
	`em±y
()) {

1847 
İ
->
»mÙe_»ad
[
h·œ
.
fœ¡
] = 
¡d
::
	`move
(remote_read);

1849 ià(!
³ndšg_»ad
.
	`em±y
()) {

1850 
İ
->
³ndšg_»ad
[
h·œ
.
fœ¡
] = 
¡d
::
	`move
(pending_read);

1854 
İ
->
»mÙe_»ad
 = op->
¶ª
.
to_»ad
;

1857 
	`dout
(10è<< 
__func__
 << ": " << *
İ
 << 
d’dl
;

1859 ià(!
İ
->
»mÙe_»ad
.
	`em±y
()) {

1860 
	`as£¹
(
	`g‘_·»Á
()->
	`g‘_poŞ
().
	`®lows_ecov”wr™es
());

1861 
	`objeùs_»ad_async_no_ÿche
(

1862 
İ
->
»mÙe_»ad
,

1863 [
this
, 
İ
](
m­
<
hobjeù_t
,
·œ
<, 
ex‹Á_m­
> > &&
»suÉs
) {

1864 autØ&&
i
: 
»suÉs
) {

1865 
İ
->
»mÙe_»ad_»suÉ
.
	`em¶aû
(
i
.
fœ¡
, i.
£cÚd
.second);

1867 
	`check_İs
();

1871  
Œue
;

1872 
	}
}

1874 
boŞ
 
	gECBack’d
::
	$Œy_»ads_to_comm™
()

1876 ià(
wa™šg_»ads
.
	`em±y
())

1877  
çl£
;

1878 
Op
 *
İ
 = &(
wa™šg_»ads
.
	`äÚt
());

1879 ià(
İ
->
	`»ad_š_´og»ss
())

1880  
çl£
;

1881 
wa™šg_»ads
.
	`pİ_äÚt
();

1882 
wa™šg_comm™
.
	`push_back
(*
İ
);

1884 
	`dout
(10è<< 
__func__
 << ": s¹šg comm™ oÀ" << *
İ
 << 
d’dl
;

1885 
	`dout
(20è<< 
__func__
 << ": " << 
ÿche
 << 
d’dl
;

1887 
	`g‘_·»Á
()->
	`­¶y_¡©s
(

1888 
İ
->
hoid
,

1889 
İ
->
d–_¡©s
);

1891 ià(
İ
->
usšg_ÿche
) {

1892 autØ&&
h·œ
: 
İ
->
³ndšg_»ad
) {

1893 
İ
->
»mÙe_»ad_»suÉ
[
h·œ
.
fœ¡
].
	`š£¹
(

1894 
ÿche
.
	`g‘_»maššg_ex‹Ás_fÜ_rmw
(

1895 
h·œ
.
fœ¡
,

1896 
İ
->
pš
,

1897 
h·œ
.
£cÚd
));

1899 
İ
->
³ndšg_»ad
.
	`ş—r
();

1901 
	`as£¹
(
İ
->
³ndšg_»ad
.
	`em±y
());

1904 
m­
<
sh¬d_id_t
, 
ObjeùStÜe
::
T¿n§ùiÚ
> 
Œªs
;

1905 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
i
 =

1906 
	`g‘_·»Á
()->
	`g‘_aùšg_»cov”y_backfl_sh¬ds
().
	`begš
();

1907 
i
 !ğ
	`g‘_·»Á
()->
	`g‘_aùšg_»cov”y_backfl_sh¬ds
().
	`’d
();

1908 ++
i
) {

1909 
Œªs
[
i
->
sh¬d
];

1912 
İ
->
Œaû
.
	`ev’t
("startƒc write");

1914 
m­
<
hobjeù_t
,
ex‹Á_m­
> 
wr™‹n
;

1915 ià(
İ
->
¶ª
.
t
) {

1916 
ECT¿n§ùiÚ
::
	`g’”©e_Œª§ùiÚs
(

1917 
İ
->
¶ª
,

1918 
ec_im¶
,

1919 
	`g‘_·»Á
()->
	`g‘_šfo
().
pgid
.pgid,

1920 
sšfo
,

1921 
İ
->
»mÙe_»ad_»suÉ
,

1922 
İ
->
log_’Œ›s
,

1923 &
wr™‹n
,

1924 &
Œªs
,

1925 &(
İ
->
‹mp_added
),

1926 &(
İ
->
‹mp_ş—»d
),

1927 
	`g‘_·»Á
()->
	`g‘_dµ
());

1930 
	`dout
(20è<< 
__func__
 << ": " << 
ÿche
 << 
d’dl
;

1931 
	`dout
(20è<< 
__func__
 << ": wr™‹n: " << 
wr™‹n
 << 
d’dl
;

1932 
	`dout
(20è<< 
__func__
 << ": op: " << *
İ
 << 
d’dl
;

1934 ià(!
	`g‘_·»Á
()->
	`g‘_poŞ
().
	`®lows_ecov”wr™es
()) {

1935 autØ&&
i
: 
İ
->
log_’Œ›s
) {

1936 ià(
i
.
	`»quœes_k¿k’
()) {

1937 
d”r
 << 
__func__
 << ":†ogƒÁry " << 
i
 << "„equires kraken"

1938 << " buˆov”wr™e ¬nÙƒÇbËd!" << 
d’dl
;

1939 
	`ûph_abÜt
();

1944 
m­
<
hobjeù_t
,
ex‹Á_£t
> 
wr™‹n_£t
;

1945 autØ&&
i
: 
wr™‹n
) {

1946 
wr™‹n_£t
[
i
.
fœ¡
] = i.
£cÚd
.
	`g‘_š‹rv®_£t
();

1948 
	`dout
(20è<< 
__func__
 << ": wr™‹n_£t: " << 
wr™‹n_£t
 << 
d’dl
;

1949 
	`as£¹
(
wr™‹n_£t
 =ğ
İ
->
¶ª
.
wl_wr™e
);

1951 ià(
İ
->
usšg_ÿche
) {

1952 autØ&&
h·œ
: 
wr™‹n
) {

1953 
	`dout
(20è<< 
__func__
 << ": " << 
h·œ
 << 
d’dl
;

1954 
ÿche
.
	`´e£Á_rmw_upd©e
(
h·œ
.
fœ¡
, 
İ
->
pš
, h·œ.
£cÚd
);

1957 
İ
->
»mÙe_»ad
.
	`ş—r
();

1958 
İ
->
»mÙe_»ad_»suÉ
.
	`ş—r
();

1960 
ObjeùStÜe
::
T¿n§ùiÚ
 
em±y
;

1961 
boŞ
 
should_wr™e_loÿl
 = 
çl£
;

1962 
ECSubWr™e
 
loÿl_wr™e_İ
;

1963 
£t
<
pg_sh¬d_t
> 
backfl_sh¬ds
 = 
	`g‘_·»Á
()->
	`g‘_backfl_sh¬ds
();

1964 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
i
 =

1965 
	`g‘_·»Á
()->
	`g‘_aùšg_»cov”y_backfl_sh¬ds
().
	`begš
();

1966 
i
 !ğ
	`g‘_·»Á
()->
	`g‘_aùšg_»cov”y_backfl_sh¬ds
().
	`’d
();

1967 ++
i
) {

1968 
İ
->
³ndšg_­¶y
.
	`š£¹
(*
i
);

1969 
İ
->
³ndšg_comm™
.
	`š£¹
(*
i
);

1970 
m­
<
sh¬d_id_t
, 
ObjeùStÜe
::
T¿n§ùiÚ
>::
™”©Ü
 
™”
 =

1971 
Œªs
.
	`fšd
(
i
->
sh¬d
);

1972 
	`as£¹
(
™”
 !ğ
Œªs
.
	`’d
());

1973 
boŞ
 
should_£nd
 = 
	`g‘_·»Á
()->
	`should_£nd_İ
(*
i
, 
İ
->
hoid
);

1974 cÚ¡ 
pg_¡©_t
 &
¡©s
 =

1975 (
should_£nd
 || !
backfl_sh¬ds
.
	`couÁ
(*
i
)) ?

1976 
	`g‘_šfo
().
¡©s
 :

1977 
·»Á
->
	`g‘_sh¬d_šfo
().
	`fšd
(*
i
)->
£cÚd
.
¡©s
;

1979 
ECSubWr™e
 
	`sİ
(

1980 
	`g‘_·»Á
()->
	`whßmi_sh¬d
(),

1981 
İ
->
tid
,

1982 
İ
->
»qid
,

1983 
İ
->
hoid
,

1984 
¡©s
,

1985 
should_£nd
 ? 
™”
->
£cÚd
 : 
em±y
,

1986 
İ
->
v”siÚ
,

1987 
İ
->
Œim_to
,

1988 
İ
->
rŞl_fÜw¬d_to
,

1989 
İ
->
log_’Œ›s
,

1990 
İ
->
upd©ed_h™_£t_hi¡Üy
,

1991 
İ
->
‹mp_added
,

1992 
İ
->
‹mp_ş—»d
,

1993 !
should_£nd
);

1995 
ZT¿ûr
::
T¿û
 
Œaû
;

1996 ià(
İ
->
Œaû
) {

1998 
Œaû
.
	`š™
("eøsub wr™e", 
nuÎ±r
, &
İ
->trace);

1999 
Œaû
.
	`keyv®
("sh¬d", 
i
->
sh¬d
.
id
);

2002 ià(*
i
 =ğ
	`g‘_·»Á
()->
	`whßmi_sh¬d
()) {

2003 
should_wr™e_loÿl
 = 
Œue
;

2004 
loÿl_wr™e_İ
.
	`şaim
(
sİ
);

2006 
MOSDECSubOpWr™e
 *
r
 = 
Ãw
 
	`MOSDECSubOpWr™e
(
sİ
);

2007 
r
->
pgid
 = 
	`¥g_t
(
	`g‘_·»Á
()->
	`´im¬y_¥g_t
().pgid, 
i
->
sh¬d
);

2008 
r
->
m­_•och
 = 
	`g‘_·»Á
()->
	`g‘_•och
();

2009 
r
->
mš_•och
 = 
	`g‘_·»Á
()->
	`g‘_š‹rv®_¡¬t_•och
();

2010 
r
->
Œaû
 =race;

2011 
	`g‘_·»Á
()->
	`£nd_mes§ge_osd_şu¡”
(

2012 
i
->
osd
, 
r
, 
	`g‘_·»Á
()->
	`g‘_•och
());

2015 ià(
should_wr™e_loÿl
) {

2016 
	`hªdË_sub_wr™e
(

2017 
	`g‘_·»Á
()->
	`whßmi_sh¬d
(),

2018 
İ
->
ş›Á_İ
,

2019 
loÿl_wr™e_İ
,

2020 
İ
->
Œaû
);

2023 autØ
i
 = 
İ
->
Ú_wr™e
.
	`begš
();

2024 
i
 !ğ
İ
->
Ú_wr™e
.
	`’d
();

2025 
İ
->
Ú_wr™e
.
	`”a£
(
i
++)) {

2026 (*
i
)();

2029  
Œue
;

2030 
	}
}

2032 
boŞ
 
	gECBack’d
::
	$Œy_fšish_rmw
()

2034 ià(
wa™šg_comm™
.
	`em±y
())

2035  
çl£
;

2036 
Op
 *
İ
 = &(
wa™šg_comm™
.
	`äÚt
());

2037 ià(
İ
->
	`wr™e_š_´og»ss
())

2038  
çl£
;

2039 
wa™šg_comm™
.
	`pİ_äÚt
();

2041 
	`dout
(10è<< 
__func__
 << ": " << *
İ
 << 
d’dl
;

2042 
	`dout
(20è<< 
__func__
 << ": " << 
ÿche
 << 
d’dl
;

2044 ià(
İ
->
rŞl_fÜw¬d_to
 > 
com¶‘ed_to
)

2045 
com¶‘ed_to
 = 
İ
->
rŞl_fÜw¬d_to
;

2046 ià(
İ
->
v”siÚ
 > 
comm™‹d_to
)

2047 
comm™‹d_to
 = 
İ
->
v”siÚ
;

2049 ià(
	`g‘_osdm­
()->
»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_KRAKEN
) {

2050 ià(
İ
->
v”siÚ
 > 
	`g‘_·»Á
()->
	`g‘_log
().
	`g‘_ÿn_rŞlback_to
() &&

2051 
wa™šg_»ads
.
	`em±y
() &&

2052 
wa™šg_comm™
.
	`em±y
()) {

2054 autØ
tid
 = 
	`g‘_·»Á
()->
	`g‘_tid
();

2055 
Op
 *
nİ
 = &(
tid_to_İ_m­
[
tid
]);

2056 
nİ
->
hoid
 = 
İ
->hoid;

2057 
nİ
->
Œim_to
 = 
İ
->trim_to;

2058 
nİ
->
rŞl_fÜw¬d_to
 = 
İ
->
v”siÚ
;

2059 
nİ
->
tid
 =id;

2060 
nİ
->
»qid
 = 
İ
->reqid;

2061 
wa™šg_»ads
.
	`push_back
(*
nİ
);

2065 ià(
İ
->
usšg_ÿche
) {

2066 
ÿche
.
	`»Ëa£_wr™e_pš
(
İ
->
pš
);

2068 
tid_to_İ_m­
.
	`”a£
(
İ
->
tid
);

2070 ià(
wa™šg_»ads
.
	`em±y
() &&

2071 
wa™šg_comm™
.
	`em±y
()) {

2072 
p–še_¡©e
.
	`ş—r
();

2073 
	`dout
(20è<< 
__func__
 << ": clearing…ipeline_state "

2074 << 
p–še_¡©e


2075 << 
d’dl
;

2077  
Œue
;

2078 
	}
}

2080 
	gECBack’d
::
	$check_İs
()

2082 
	`Œy_¡©e_to_»ads
() ||

2083 
	`Œy_»ads_to_comm™
() ||

2084 
	`Œy_fšish_rmw
());

2085 
	}
}

2087 
	gECBack’d
::
	$objeùs_»ad_sync
(

2088 cÚ¡ 
hobjeù_t
 &
hoid
,

2089 
ušt64_t
 
off
,

2090 
ušt64_t
 
Ën
,

2091 
ušt32_t
 
İ_æags
,

2092 
bufã¾i¡
 *
bl
)

2094  -
EOPNOTSUPP
;

2095 
	}
}

2097 
	gECBack’d
::
objeùs_»ad_async
(

2098 cÚ¡ 
hobjeù_t
 &
hoid
,

2099 cÚ¡ 
li¡
<
·œ
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
>,

2100 
·œ
<
bufã¾i¡
*, 
CÚ‹xt
*> > > &
to_»ad
,

2101 
CÚ‹xt
 *
Ú_com¶‘e
,

2102 
boŞ
 
ç¡_»ad
)

2104 
	gm­
<
	ghobjeù_t
,
	g¡d
::
li¡
<
boo¡
::
tu¶e
<
ušt64_t
, 
	gušt64_t
, 
	gušt32_t
> > >

2105 
	g»ads
;

2107 
ušt32_t
 
	gæags
 = 0;

2108 
ex‹Á_£t
 
	ges
;

2109 
	gli¡
<
	g·œ
<
	gboo¡
::
tu¶e
<
ušt64_t
, 
	gušt64_t
, 
	gušt32_t
>,

2110 
	g·œ
<
	gbufã¾i¡
*, 
	gCÚ‹xt
*> > >::
cÚ¡_™”©Ü
 
i
 =

2111 
to_»ad
.
begš
();

2112 
	gi
 !ğ
to_»ad
.
’d
();

2113 ++
	gi
) {

2114 
	g·œ
<
	gušt64_t
, ušt64_t> 
	gtmp
 =

2115 
sšfo
.
off£t_Ën_to_¡re_bounds
(

2116 
make_·œ
(
i
->
fœ¡
.
g‘
<0>(), i->first.get<1>()));

2118 
	ges
.
uniÚ_š£¹
(
tmp
.
fœ¡
,mp.
£cÚd
);

2119 
	gæags
 |ğ
i
->
fœ¡
.
g‘
<2>();

2122 ià(!
	ges
.
em±y
()) {

2123 autØ&
	goff£ts
 = 
»ads
[
hoid
];

2124 autØ
	gj
 = 
es
.
begš
();

2125 
	gj
 !ğ
es
.
’d
();

2126 ++
	gj
) {

2127 
	goff£ts
.
push_back
(

2128 
boo¡
::
make_tu¶e
(

2129 
j
.
g‘_¡¬t
(),

2130 
j
.
g‘_Ën
(),

2131 
æags
));

2135 
	scb
 {

2136 
ECBack’d
 *
	gec
;

2137 
hobjeù_t
 
	ghoid
;

2138 
	gli¡
<
	g·œ
<
	gboo¡
::
tu¶e
<
ušt64_t
, 
	gušt64_t
, 
	gušt32_t
>,

2139 
	g·œ
<
	gbufã¾i¡
*, 
	gCÚ‹xt
*> > > 
	gto_»ad
;

2140 
	gunique_±r
<
	gCÚ‹xt
> 
	gÚ_com¶‘e
;

2141 
cb
(cÚ¡ cb&èğ
d–‘e
;

2142 
cb
(cb &&) = ;

2143 
cb
(
ECBack’d
 *
ec
,

2144 cÚ¡ 
hobjeù_t
 &
hoid
,

2145 cÚ¡ 
li¡
<
·œ
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
>,

2146 
·œ
<
bufã¾i¡
*, 
CÚ‹xt
*> > > &
to_»ad
,

2147 
CÚ‹xt
 *
Ú_com¶‘e
)

2148 : 
ec
(ec),

2149 
hoid
(hoid),

2150 
to_»ad
(to_read),

2151 
Ú_com¶‘e
(on_complete) {}

2152 
İ”©Ü
()(
	gm­
<
	ghobjeù_t
,
	g·œ
<, 
	gex‹Á_m­
> > &&
	g»suÉs
) {

2153 autØ
	gdµ
 = 
ec
->
g‘_·»Á
()->
g‘_dµ
();

2154 
ldµ_dout
(
dµ
, 20è<< "objeùs_»ad_async_cb: gÙ: " << 
	g»suÉs


2155 << 
	gd’dl
;

2156 
ldµ_dout
(
dµ
, 20è<< "objeùs_»ad_async_cb: cache: " << 
	gec
->
	gÿche


2157 << 
	gd’dl
;

2159 autØ&
	ggÙ
 = 
»suÉs
[
hoid
];

2161 
	gr
 = 0;

2162 autØ&&
	g»ad
: 
to_»ad
) {

2163 ià(
gÙ
.
fœ¡
 < 0) {

2164 ià(
»ad
.
£cÚd
.second) {

2165 
»ad
.
£cÚd
.£cÚd->
com¶‘e
(
gÙ
.
fœ¡
);

2167 ià(
	gr
 == 0)

2168 
r
 = 
gÙ
.
fœ¡
;

2170 
as£¹
(
»ad
.
£cÚd
.
fœ¡
);

2171 
ušt64_t
 
	goff£t
 = 
»ad
.
fœ¡
.
g‘
<0>();

2172 
ušt64_t
 
	gËngth
 = 
»ad
.
fœ¡
.
g‘
<1>();

2173 autØ
	g¿nge
 = 
gÙ
.
£cÚd
.
g‘_cÚššg_¿nge
(
off£t
, 
Ëngth
);

2174 
as£¹
(
¿nge
.
fœ¡
 !ğ¿nge.
£cÚd
);

2175 
as£¹
(
¿nge
.
fœ¡
.
g‘_off
(è<ğ
off£t
);

2176 
as£¹
(

2177 (
off£t
 + 
Ëngth
) <=

2178 (
¿nge
.
fœ¡
.
g‘_off
(è+„ªge.fœ¡.
g‘_Ën
()));

2179 
	g»ad
.
	g£cÚd
.
	gfœ¡
->
sub¡r_of
(

2180 
¿nge
.
fœ¡
.
g‘_v®
(),

2181 
off£t
 - 
¿nge
.
fœ¡
.
g‘_off
(),

2182 
Ëngth
);

2183 ià(
	g»ad
.
	g£cÚd
.second) {

2184 
	g»ad
.
	g£cÚd
.£cÚd->
com¶‘e
(
Ëngth
);

2185 
	g»ad
.
	g£cÚd
.£cÚd = 
nuÎ±r
;

2189 
	gto_»ad
.
ş—r
();

2190 ià(
	gÚ_com¶‘e
) {

2191 
	gÚ_com¶‘e
.
»Ëa£
()->
com¶‘e
(
r
);

2194 ~
cb
() {

2195 autØ&&
	gi
: 
to_»ad
) {

2196 
d–‘e
 
i
.
£cÚd
.second;

2198 
	gto_»ad
.
ş—r
();

2201 
objeùs_»ad_ªd_»cÚ¡ruù
(

2202 
»ads
,

2203 
ç¡_»ad
,

2204 
make_g’_Ïmbda_cÚ‹xt
<

2205 
m­
<
hobjeù_t
,
·œ
<, 
ex‹Á_m­
> > &&, 
cb
>(

2206 
cb
(
this
,

2207 
hoid
,

2208 
to_»ad
,

2209 
Ú_com¶‘e
)));

2212 
	gC®lCl›ÁCÚ‹xts
 :

2213 
public
 
G’CÚ‹xt
<
·œ
<
Recov”yMes§ges
*, 
	gECBack’d
::
»ad_»suÉ_t
& > &> {

2214 
hobjeù_t
 
hoid
;

2215 
ECBack’d
 *
	gec
;

2216 
	gECBack’d
::
Cl›ÁAsyncR—dStus
 *
¡©us
;

2217 
	gli¡
<
	gboo¡
::
tu¶e
<
ušt64_t
, 
	gušt64_t
, 
	gušt32_t
> > 
	gto_»ad
;

2218 
C®lCl›ÁCÚ‹xts
(

2219 
hobjeù_t
 
hoid
,

2220 
ECBack’d
 *
ec
,

2221 
ECBack’d
::
Cl›ÁAsyncR—dStus
 *
¡©us
,

2222 cÚ¡ 
li¡
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
> > &
to_»ad
)

2223 : 
hoid
(hoid), 
ec
Óc), 
¡©us
(¡©us), 
to_»ad
(to_read) {}

2224 
fšish
(
·œ
<
Recov”yMes§ges
 *, 
ECBack’d
::
»ad_»suÉ_t
 &> &
š
è
ov”ride
 {

2225 
ECBack’d
::
»ad_»suÉ_t
 &
»s
 = 
š
.
£cÚd
;

2226 
ex‹Á_m­
 
	g»suÉ
;

2227 ià(
	g»s
.
	gr
 != 0)

2228 
out
;

2229 
as£¹
(
»s
.
»tuºed
.
size
(è=ğ
to_»ad
.size());

2230 
as£¹
(
»s
.
”rÜs
.
em±y
());

2231 autØ&&
	g»ad
: 
to_»ad
) {

2232 
·œ
<
ušt64_t
, 
	gušt64_t
> 
	gadju¡ed
 =

2233 
ec
->
sšfo
.
off£t_Ën_to_¡re_bounds
(

2234 
make_·œ
(
»ad
.
g‘
<0>(),„ead.get<1>()));

2235 
as£¹
(
»s
.
»tuºed
.
äÚt
().
g‘
<0>(è=ğ
adju¡ed
.
fœ¡
 &&

2236 
»s
.
»tuºed
.
äÚt
().
g‘
<1>(è=ğ
adju¡ed
.
£cÚd
);

2237 
	gm­
<, 
	gbufã¾i¡
> 
	gto_decode
;

2238 
bufã¾i¡
 
	gbl
;

2239 
	gm­
<
	gpg_sh¬d_t
, 
	gbufã¾i¡
>::
™”©Ü
 
j
 =

2240 
»s
.
»tuºed
.
äÚt
().
g‘
<2>().
begš
();

2241 
	gj
 !ğ
»s
.
»tuºed
.
äÚt
().
g‘
<2>().
’d
();

2242 ++
	gj
) {

2243 
	gto_decode
[
j
->
fœ¡
.
sh¬d
].
şaim
(j->
£cÚd
);

2245 
	gr
 = 
ECUt
::
decode
(

2246 
ec
->
sšfo
,

2247 
ec
->
ec_im¶
,

2248 
to_decode
,

2249 &
bl
);

2250 ià(
	gr
 < 0) {

2251 
	g»s
.
	gr
 = 
r
;

2252 
	gout
;

2254 
bufã¾i¡
 
	gŒimmed
;

2255 
	gŒimmed
.
sub¡r_of
(

2256 
bl
,

2257 
»ad
.
g‘
<0>(è- 
adju¡ed
.
fœ¡
,

2258 
¡d
::
mš
(
»ad
.
g‘
<1>(),

2259 
bl
.
Ëngth
(è- (
»ad
.
g‘
<0>(è- 
adju¡ed
.
fœ¡
)));

2260 
	g»suÉ
.
š£¹
(

2261 
»ad
.
g‘
<0>(), 
Œimmed
.
Ëngth
(), 
¡d
::
move
(trimmed));

2262 
	g»s
.
	g»tuºed
.
pİ_äÚt
();

2264 
	gout
:

2265 
¡©us
->
com¶‘e_objeù
(
hoid
, 
»s
.
r
, 
¡d
::
move
(
»suÉ
));

2266 
	gec
->
kick_»ads
();

2270 
	gECBack’d
::
objeùs_»ad_ªd_»cÚ¡ruù
(

2271 cÚ¡ 
m­
<
hobjeù_t
,

2272 
¡d
::
li¡
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
> >

2273 > &
»ads
,

2274 
boŞ
 
ç¡_»ad
,

2275 
G’CÚ‹xtURef
<
m­
<
hobjeù_t
,
·œ
<, 
ex‹Á_m­
> > &&> &&
func
)

2277 
	gš_´og»ss_ş›Á_»ads
.
em¶aû_back
(

2278 
»ads
.
size
(), 
¡d
::
move
(
func
));

2279 ià(!
	g»ads
.
size
()) {

2280 
kick_»ads
();

2284 
	gm­
<
	ghobjeù_t
, 
	g£t
<>> 
	gobj_wªt_to_»ad
;

2285 
	g£t
<> 
	gwªt_to_»ad
;

2286 
g‘_wªt_to_»ad_sh¬ds
(&
wªt_to_»ad
);

2288 
	gm­
<
	ghobjeù_t
, 
	g»ad_»que¡_t
> 
	gfÜ_»ad_İ
;

2289 autØ&&
	gto_»ad
: 
»ads
) {

2290 
m­
<
pg_sh¬d_t
, 
	gveùÜ
<
	g·œ
<, >>> 
	gsh¬ds
;

2291 
	gr
 = 
g‘_mš_ava_to_»ad_sh¬ds
(

2292 
to_»ad
.
fœ¡
,

2293 
wªt_to_»ad
,

2294 
çl£
,

2295 
ç¡_»ad
,

2296 &
sh¬ds
);

2297 
as£¹
(
r
 == 0);

2299 
C®lCl›ÁCÚ‹xts
 *
	gc
 = 
Ãw
 CallClientContexts(

2300 
to_»ad
.
fœ¡
,

2301 
this
,

2302 &(
š_´og»ss_ş›Á_»ads
.
back
()),

2303 
to_»ad
.
£cÚd
);

2304 
	gfÜ_»ad_İ
.
š£¹
(

2305 
make_·œ
(

2306 
to_»ad
.
fœ¡
,

2307 
»ad_»que¡_t
(

2308 
to_»ad
.
£cÚd
,

2309 
sh¬ds
,

2310 
çl£
,

2311 
c
)));

2312 
	gobj_wªt_to_»ad
.
š£¹
(
make_·œ
(
to_»ad
.
fœ¡
, 
wªt_to_»ad
));

2315 
¡¬t_»ad_İ
(

2316 
CEPH_MSG_PRIO_DEFAULT
,

2317 
obj_wªt_to_»ad
,

2318 
fÜ_»ad_İ
,

2319 
OpReque¡Ref
(),

2320 
ç¡_»ad
, 
çl£
);

2325 
	gECBack’d
::
	$£nd_®l_»maššg_»ads
(

2326 cÚ¡ 
hobjeù_t
 &
hoid
,

2327 
R—dOp
 &
rİ
)

2329 
£t
<> 
®»ady_»ad
;

2330 cÚ¡ 
£t
<
pg_sh¬d_t
>& 
Ùs
 = 
rİ
.
obj_to_sourû
[
hoid
];

2331 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
Ùs
.
	`begš
(); i !ğÙs.
	`’d
(); ++i)

2332 
®»ady_»ad
.
	`š£¹
(
i
->
sh¬d
);

2333 
	`dout
(10è<< 
__func__
 << " have/”rÜ sh¬ds=" << 
®»ady_»ad
 << 
d’dl
;

2334 
m­
<
pg_sh¬d_t
, 
veùÜ
<
·œ
<, >>> 
sh¬ds
;

2335 
r
 = 
	`g‘_»maššg_sh¬ds
(
hoid
, 
®»ady_»ad
, 
rİ
.
wªt_to_»ad
[hoid],

2336 
rİ
.
com¶‘e
[
hoid
], &
sh¬ds
,„İ.
fÜ_»cov”y
);

2337 ià(
r
)

2338  
r
;

2340 
li¡
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
> > 
off£ts
 =

2341 
rİ
.
to_»ad
.
	`fšd
(
hoid
)->
£cÚd
.to_read;

2342 
G’CÚ‹xt
<
·œ
<
Recov”yMes§ges
 *, 
»ad_»suÉ_t
& > &> *
c
 =

2343 
rİ
.
to_»ad
.
	`fšd
(
hoid
)->
£cÚd
.
cb
;

2345 
rİ
.
to_»ad
.
	`”a£
(
hoid
);

2346 
rİ
.
to_»ad
.
	`š£¹
(
	`make_·œ
(

2347 
hoid
,

2348 
	`»ad_»que¡_t
(

2349 
off£ts
,

2350 
sh¬ds
,

2351 
çl£
,

2352 
c
)));

2353 
	`do_»ad_İ
(
rİ
);

2355 
	}
}

2357 
	gECBack’d
::
objeùs_g‘_©Œs
(

2358 cÚ¡ 
hobjeù_t
 &
hoid
,

2359 
m­
<
¡ršg
, 
bufã¾i¡
> *
out
)

2361 
	gr
 = 
¡Üe
->
g‘©Œs
(

2362 
ch
,

2363 
ghobjeù_t
(
hoid
, ghobjeù_t::
NO_GEN
, 
g‘_·»Á
()->
whßmi_sh¬d
().
sh¬d
),

2364 *
out
);

2365 ià(
	gr
 < 0)

2366  
	gr
;

2368 
	gm­
<
	g¡ršg
, 
	gbufã¾i¡
>::
™”©Ü
 
i
 = 
out
->
begš
();

2369 
	gi
 !ğ
out
->
’d
();

2371 ià(
	gECUt
::
is_hšfo_key_¡ršg
(
i
->
fœ¡
))

2372 
out
->
”a£
(
i
++);

2374 ++
	gi
;

2376  
	gr
;

2379 
	gECBack’d
::
	$rŞlback_­³nd
(

2380 cÚ¡ 
hobjeù_t
 &
hoid
,

2381 
ušt64_t
 
Şd_size
,

2382 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

2384 
	`as£¹
(
Şd_size
 % 
sšfo
.
	`g‘_¡re_width
() == 0);

2385 
t
->
	`Œunÿ‹
(

2386 
cŞl
,

2387 
	`ghobjeù_t
(
hoid
, 
ghobjeù_t
::
NO_GEN
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
),

2388 
sšfo
.
	`®igÃd_logiÿl_off£t_to_chunk_off£t
(

2389 
Şd_size
));

2390 
	}
}

2392 
	gECBack’d
::
	$be_d“p_süub
(

2393 cÚ¡ 
hobjeù_t
 &
poid
,

2394 
SüubM­
 &
m­
,

2395 
SüubM­Bud”
 &
pos
,

2396 
SüubM­
::
objeù
 &
o
)

2398 
	`dout
(10è<< 
__func__
 << " " << 
poid
 << "…o " << 
pos
 << 
d’dl
;

2399 
r
;

2400 
boŞ
 
sk_d©a_dige¡
 = 
¡Üe
->
	`has_butš_csum
() &&

2401 
g_cÚf
->
osd_sk_d©a_dige¡
;

2403 
ušt32_t
 
çdvi£_æags
 = 
CEPH_OSD_OP_FLAG_FADVISE_SEQUENTIAL
 |

2404 
CEPH_OSD_OP_FLAG_FADVISE_DONTNEED
;

2406 
utime_t
 
¦“±ime
;

2407 
¦“±ime
.
	`£t_äom_doubË
(
cù
->
_cÚf
->
osd_debug_d“p_süub_¦“p
);

2408 ià(
¦“±ime
 !ğ
	`utime_t
()) {

2409 
	`lg’”ic_d”r
(
cù
è<< 
__func__
 << " sË•šg fÜ " << 
¦“±ime
 << 
d’dl
;

2410 
¦“±ime
.
	`¦“p
();

2413 ià(
pos
.
d©a_pos
 == 0) {

2414 
pos
.
d©a_hash
 = 
	`bufãrhash
(-1);

2417 
ušt64_t
 
¡ride
 = 
cù
->
_cÚf
->
osd_d“p_süub_¡ride
;

2418 ià(
¡ride
 % 
sšfo
.
	`g‘_chunk_size
())

2419 
¡ride
 +ğ
sšfo
.
	`g‘_chunk_size
() - (stride % sinfo.get_chunk_size());

2421 
bufã¾i¡
 
bl
;

2422 
r
 = 
¡Üe
->
	`»ad
(

2423 
ch
,

2424 
	`ghobjeù_t
(

2425 
poid
, 
ghobjeù_t
::
NO_GEN
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
),

2426 
pos
.
d©a_pos
,

2427 
¡ride
, 
bl
,

2428 
çdvi£_æags
);

2429 ià(
r
 < 0) {

2430 
	`dout
(20è<< 
__func__
 << " " << 
poid
 << " got "

2431 << 
r
 << " oÀ»ad,„—d_”rÜ" << 
d’dl
;

2432 
o
.
»ad_”rÜ
 = 
Œue
;

2435 ià(
bl
.
	`Ëngth
(è% 
sšfo
.
	`g‘_chunk_size
()) {

2436 
	`dout
(20è<< 
__func__
 << " " << 
poid
 << " got "

2437 << 
r
 << " oÀ»ad,‚Ù chunk siz" << 
sšfo
.
	`g‘_chunk_size
() << "‡ligned"

2438 << 
d’dl
;

2439 
o
.
»ad_”rÜ
 = 
Œue
;

2442 ià(
r
 > 0 && !
sk_d©a_dige¡
) {

2443 
pos
.
d©a_hash
 << 
bl
;

2445 
pos
.
d©a_pos
 +ğ
r
;

2446 ià(
r
 =ğ()
¡ride
) {

2447  -
EINPROGRESS
;

2450 
ECUt
::
HashInfoRef
 
hšfo
 = 
	`g‘_hash_šfo
(
poid
, 
çl£
, &
o
.
©Œs
);

2451 ià(!
hšfo
) {

2452 
	`dout
(0è<< "_sÿn_li¡ " << 
poid
 << " could‚Ù„‘r›vhash info" << 
d’dl
;

2453 
o
.
»ad_”rÜ
 = 
Œue
;

2454 
o
.
dige¡_´e£Á
 = 
çl£
;

2457 ià(!
	`g‘_·»Á
()->
	`g‘_poŞ
().
	`®lows_ecov”wr™es
()) {

2458 
	`as£¹
(
hšfo
->
	`has_chunk_hash
());

2459 ià(
hšfo
->
	`g‘_tÙ®_chunk_size
(è!ğ()
pos
.
d©a_pos
) {

2460 
	`dout
(0è<< "_sÿn_li¡ " << 
poid
 << " got incorrect size on„ead 0x"

2461 << 
¡d
::
hex
 << 
pos


2462 << "ƒx³ùed 0x" << 
hšfo
->
	`g‘_tÙ®_chunk_size
(è<< 
¡d
::
dec


2463 << 
d’dl
;

2464 
o
.
ec_size_mism©ch
 = 
Œue
;

2468 ià(!
sk_d©a_dige¡
 &&

2469 
hšfo
->
	`g‘_chunk_hash
(
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
) !=

2470 
pos
.
d©a_hash
.
	`dige¡
()) {

2471 
	`dout
(0è<< "_sÿn_li¡ " << 
poid
 << " got incorrect hash on„ead 0x"

2472 << 
¡d
::
hex
 << 
pos
.
d©a_hash
.
	`dige¡
() << " !=ƒxpected 0x"

2473 << 
hšfo
->
	`g‘_chunk_hash
(
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
)

2474 << 
¡d
::
dec
 << 
d’dl
;

2475 
o
.
ec_hash_mism©ch
 = 
Œue
;

2485 
o
.
dige¡
 = 
hšfo
->
	`g‘_chunk_hash
(0);

2486 
o
.
dige¡_´e£Á
 = 
Œue
;

2491 
o
.
dige¡
 = 0;

2492 
o
.
dige¡_´e£Á
 = 
Œue
;

2496 
o
.
om­_dige¡
 = -1;

2497 
o
.
om­_dige¡_´e£Á
 = 
Œue
;

2499 
	}
}

	@osd/ECBackend.h

15 #iâdeà
ECBACKEND_H


16 
	#ECBACKEND_H


	)

18 
	~<boo¡/šŒusive/£t.hµ
>

19 
	~<boo¡/šŒusive/li¡.hµ
>

21 
	~"OSD.h
"

22 
	~"PGBack’d.h
"

23 
	~"”asu»-code/E¿su»CodeIÁ”çû.h
"

24 
	~"ECUt.h
"

25 
	~"ECT¿n§ùiÚ.h
"

26 
	~"Ex‹ÁCache.h
"

29 
	gECSubWr™e
;

30 
	gECSubWr™eR•ly
;

31 
	gECSubR—d
;

32 
	gECSubR—dR•ly
;

34 
	gRecov”yMes§ges
;

35 şas 
	cECBack’d
 : 
public
 
PGBack’d
 {

36 
public
:

37 
Recov”yHªdË
 *
	$İ’_»cov”y_İ
(è
ov”ride
;

39 
	$run_»cov”y_İ
(

40 
Recov”yHªdË
 *
h
,

41 
´iÜ™y


42 è
ov”ride
;

44 
	$»cov”_objeù
(

45 cÚ¡ 
hobjeù_t
 &
hoid
,

46 
ev”siÚ_t
 
v
,

47 
ObjeùCÚ‹xtRef
 
h—d
,

48 
ObjeùCÚ‹xtRef
 
obc
,

49 
Recov”yHªdË
 *
h


50 è
ov”ride
;

52 
boŞ
 
	$_hªdË_mes§ge
(

53 
OpReque¡Ref
 
İ


54 è
ov”ride
;

55 
boŞ
 
	$ÿn_hªdË_whe_šaùive
(

56 
OpReque¡Ref
 
İ


57 è
ov”ride
;

58 
ä›nd
 
SubWr™eAµl›d
;

59 
ä›nd
 
SubWr™eComm™‹d
;

60 
	`sub_wr™e_comm™‹d
(

61 
ûph_tid_t
 
tid
,

62 
ev”siÚ_t
 
v”siÚ
,

63 
ev”siÚ_t
 
Ï¡_com¶‘e
,

64 cÚ¡ 
ZT¿ûr
::
T¿û
 &
Œaû
);

65 
	`hªdË_sub_wr™e
(

66 
pg_sh¬d_t
 
äom
,

67 
OpReque¡Ref
 
msg
,

68 
ECSubWr™e
 &
İ
,

69 cÚ¡ 
ZT¿ûr
::
T¿û
 &
Œaû


71 
	`hªdË_sub_»ad
(

72 
pg_sh¬d_t
 
äom
,

73 cÚ¡ 
ECSubR—d
 &
İ
,

74 
ECSubR—dR•ly
 *
»¶y
,

75 cÚ¡ 
ZT¿ûr
::
T¿û
 &
Œaû


77 
	`hªdË_sub_wr™e_»¶y
(

78 
pg_sh¬d_t
 
äom
,

79 cÚ¡ 
ECSubWr™eR•ly
 &
İ
,

80 cÚ¡ 
ZT¿ûr
::
T¿û
 &
Œaû


82 
	`hªdË_sub_»ad_»¶y
(

83 
pg_sh¬d_t
 
äom
,

84 
ECSubR—dR•ly
 &
İ
,

85 
Recov”yMes§ges
 *
m
,

86 cÚ¡ 
ZT¿ûr
::
T¿û
 &
Œaû


90 
	$check_»cov”y_sourûs
(cÚ¡ 
OSDM­Ref
& 
osdm­
è
ov”ride
;

92 
	$Ú_chªge
(è
ov”ride
;

93 
	$ş—r_»cov”y_¡©e
(è
ov”ride
;

95 
	$dump_»cov”y_šfo
(
FÜm©‹r
 *
f
ècÚ¡ 
ov”ride
;

97 
	`ÿÎ_wr™e_Üd”ed
(
¡d
::
funùiÚ
<()> &&
cb
è
ov”ride
;

99 
	`subm™_Œª§ùiÚ
(

100 cÚ¡ 
hobjeù_t
 &
hoid
,

101 cÚ¡ 
objeù_¡©_sum_t
 &
d–_¡©s
,

102 cÚ¡ 
ev”siÚ_t
 &
©_v”siÚ
,

103 
PGT¿n§ùiÚUPŒ
 &&
t
,

104 cÚ¡ 
ev”siÚ_t
 &
Œim_to
,

105 cÚ¡ 
ev”siÚ_t
 &
rŞl_fÜw¬d_to
,

106 cÚ¡ 
veùÜ
<
pg_log_’Œy_t
> &
log_’Œ›s
,

107 
boo¡
::
İtiÚ®
<
pg_h™_£t_hi¡Üy_t
> &
h£t_hi¡Üy
,

108 
CÚ‹xt
 *
Ú_®l_comm™
,

109 
ûph_tid_t
 
tid
,

110 
osd_»qid_t
 
»qid
,

111 
OpReque¡Ref
 
İ


112 è
ov”ride
;

114 
	$objeùs_»ad_sync
(

115 cÚ¡ 
hobjeù_t
 &
hoid
,

116 
ušt64_t
 
off
,

117 
ušt64_t
 
Ën
,

118 
ušt32_t
 
İ_æags
,

119 
bufã¾i¡
 *
bl
è
ov”ride
;

139 
	`objeùs_»ad_ªd_»cÚ¡ruù
(

140 cÚ¡ 
m­
<
hobjeù_t
, 
¡d
::
li¡
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
> >

141 > &
»ads
,

142 
boŞ
 
ç¡_»ad
,

143 
G’CÚ‹xtURef
<
m­
<
hobjeù_t
,
·œ
<, 
ex‹Á_m­
> > &&> &&
func
);

145 
ä›nd
 
C®lCl›ÁCÚ‹xts
;

146 
	sCl›ÁAsyncR—dStus
 {

147 
objeùs_to_»ad
;

148 
G’CÚ‹xtURef
<
m­
<
hobjeù_t
,
·œ
<, 
ex‹Á_m­
> > &&> 
func
;

149 
m­
<
hobjeù_t
,
·œ
<, 
ex‹Á_m­
> > 
»suÉs
;

150 
ex¶ic™
 
	`Cl›ÁAsyncR—dStus
(

151 
objeùs_to_»ad
,

152 
G’CÚ‹xtURef
<
m­
<
hobjeù_t
,
·œ
<, 
ex‹Á_m­
> > &&> &&
func
)

153 : 
	`objeùs_to_»ad
(
objeùs_to_»ad
), 
	`func
(
¡d
::
	`move
(
func
)) {}

154 
	`com¶‘e_objeù
(

155 cÚ¡ 
hobjeù_t
 &
hoid
,

156 
”r
,

157 
ex‹Á_m­
 &&
bufãrs
) {

158 
	`as£¹
(
objeùs_to_»ad
);

159 --
objeùs_to_»ad
;

160 
	`as£¹
(!
»suÉs
.
	`couÁ
(
hoid
));

161 
»suÉs
.
	`em¶aû
(
hoid
, 
	`make_·œ
(
”r
, 
¡d
::
	`move
(
bufãrs
)));

163 
boŞ
 
	`is_com¶‘e
() const {

164  
objeùs_to_»ad
 == 0;

166 
	`run
() {

167 
func
.
	`»Ëa£
()->
	`com¶‘e
(
¡d
::
	`move
(
»suÉs
));

170 
li¡
<
Cl›ÁAsyncR—dStus
> 
š_´og»ss_ş›Á_»ads
;

171 
	`objeùs_»ad_async
(

172 cÚ¡ 
hobjeù_t
 &
hoid
,

173 cÚ¡ 
li¡
<
·œ
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
>,

174 
·œ
<
bufã¾i¡
*, 
CÚ‹xt
*> > > &
to_»ad
,

175 
CÚ‹xt
 *
Ú_com¶‘e
,

176 
boŞ
 
ç¡_»ad
 = 
çl£
è
ov”ride
;

178 
‹m¶©e
 <
ty³Çme
 
Func
>

179 
	`objeùs_»ad_async_no_ÿche
(

180 cÚ¡ 
m­
<
hobjeù_t
,
ex‹Á_£t
> &
to_»ad
,

181 
Func
 &&
Ú_com¶‘e
) {

182 
m­
<
hobjeù_t
,
¡d
::
li¡
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
> > > 
_to_»ad
;

183 autØ&&
h·œ
: 
to_»ad
) {

184 autØ&
l
 = 
_to_»ad
[
h·œ
.
fœ¡
];

185 autØ
ex‹Á
: 
h·œ
.
£cÚd
) {

186 
l
.
	`em¶aû_back
(
ex‹Á
.
fœ¡
,ƒx‹Á.
£cÚd
, 0);

189 
	`objeùs_»ad_ªd_»cÚ¡ruù
(

190 
_to_»ad
,

191 
çl£
,

192 
make_g’_Ïmbda_cÚ‹xt
<

193 
m­
<
hobjeù_t
,
·œ
<, 
ex‹Á_m­
> > &&, 
Func
>(

194 
¡d
::
fÜw¬d
<
Func
>(
Ú_com¶‘e
)));

195 
	}
}

196 
	$kick_»ads
() {

197 
š_´og»ss_ş›Á_»ads
.
	`size
() &&

198 
š_´og»ss_ş›Á_»ads
.
	`äÚt
().
	`is_com¶‘e
()) {

199 
š_´og»ss_ş›Á_»ads
.
	`äÚt
().
	`run
();

200 
š_´og»ss_ş›Á_»ads
.
	`pİ_äÚt
();

202 
	}
}

204 
	g´iv©e
:

205 
ä›nd
 
ECRecov”yHªdË
;

206 
ušt64_t
 
	$g‘_»cov”y_chunk_size
() const {

207  
	`round_up_to
(
cù
->
_cÚf
->
osd_»cov”y_max_chunk
,

208 
sšfo
.
	`g‘_¡re_width
());

209 
	}
}

211 
g‘_wªt_to_»ad_sh¬ds
(
£t
<> *
wªt_to_»ad
) const {

212 cÚ¡ 
	gveùÜ
<> &
	gchunk_m­pšg
 = 
ec_im¶
->
g‘_chunk_m­pšg
();

213 
	gi
 = 0; i < ()
	gec_im¶
->
g‘_d©a_chunk_couÁ
(); ++i) {

214 
	gchunk
 = ()
chunk_m­pšg
.
size
(è> 
i
 ? chunk_mapping[i] : i;

215 
	gwªt_to_»ad
->
š£¹
(
chunk
);

249 
	sRecov”yOp
 {

250 
hobjeù_t
 
	ghoid
;

251 
ev”siÚ_t
 
	gv
;

252 
	g£t
<
	gpg_sh¬d_t
> 
	gmissšg_Ú
;

253 
	g£t
<
	gsh¬d_id_t
> 
	gmissšg_Ú_sh¬ds
;

255 
ObjeùRecov”yInfo
 
	g»cov”y_šfo
;

256 
ObjeùRecov”yProg»ss
 
	g»cov”y_´og»ss
;

258 
	e¡©e_t
 { 
	gIDLE
, 
	gREADING
, 
	gWRITING
, 
	gCOMPLETE
 } 
	g¡©e
;

260 cÚ¡ * 
to¡r
(
¡©e_t
 
¡©e
) {

261 
	g¡©e
) {

262 
	gECBack’d
::
Recov”yOp
::
IDLE
:

265 
	gECBack’d
::
Recov”yOp
::
READING
:

268 
	gECBack’d
::
Recov”yOp
::
WRITING
:

271 
	gECBack’d
::
Recov”yOp
::
COMPLETE
:

275 
ûph_abÜt
();

281 
	gm­
<, 
	gbufã¾i¡
> 
	g»tuºed_d©a
;

282 
	gm­
<
	g¡ršg
, 
	gbufã¾i¡
> 
	gx©Œs
;

283 
	gECUt
::
HashInfoRef
 
hšfo
;

284 
ObjeùCÚ‹xtRef
 
	gobc
;

285 
	g£t
<
	gpg_sh¬d_t
> 
	gwa™šg_Ú_pushes
;

288 
	g·œ
<
	gušt64_t
, ušt64_t> 
	gex‹Á_»que¡ed
;

290 
dump
(
FÜm©‹r
 *
f
) const;

292 
Recov”yOp
(è: 
¡©e
(
IDLE
) {}

294 
ä›nd
 
	go¡»am
 &
	gİ”©Ü
<<(o¡»am &
	glhs
, cÚ¡ 
	gRecov”yOp
 &
	grhs
);

295 
	gm­
<
	ghobjeù_t
, 
	gRecov”yOp
> 
	g»cov”y_İs
;

297 
cÚtšue_»cov”y_İ
(

298 
Recov”yOp
 &
İ
,

299 
Recov”yMes§ges
 *
m
);

300 
di¥©ch_»cov”y_mes§ges
(
Recov”yMes§ges
 &
m
, 
´iÜ™y
);

301 
ä›nd
 
	gOnRecov”yR—dCom¶‘e
;

302 
hªdË_»cov”y_»ad_com¶‘e
(

303 cÚ¡ 
hobjeù_t
 &
hoid
,

304 
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
m­
<
pg_sh¬d_t
, 
bufã¾i¡
> > &
to_»ad
,

305 
boo¡
::
İtiÚ®
<
m­
<
¡ršg
, 
bufã¾i¡
> > 
©Œs
,

306 
Recov”yMes§ges
 *
m
);

307 
hªdË_»cov”y_push
(

308 cÚ¡ 
PushOp
 &
İ
,

309 
Recov”yMes§ges
 *
m
);

310 
hªdË_»cov”y_push_»¶y
(

311 cÚ¡ 
PushR•lyOp
 &
İ
,

312 
pg_sh¬d_t
 
äom
,

313 
Recov”yMes§ges
 *
m
);

314 
g‘_®l_ava_sh¬ds
(

315 cÚ¡ 
hobjeù_t
 &
hoid
,

316 cÚ¡ 
£t
<
pg_sh¬d_t
> &
”rÜ_sh¬ds
,

317 
£t
<> &
have
,

318 
m­
<
sh¬d_id_t
, 
pg_sh¬d_t
> &
sh¬ds
,

319 
boŞ
 
fÜ_»cov”y
);

321 
	gpublic
:

343 
	s»ad_»suÉ_t
 {

344 
r
;

345 
	gm­
<
	gpg_sh¬d_t
, > 
	g”rÜs
;

346 
	gboo¡
::
İtiÚ®
<
m­
<
¡ršg
, 
	gbufã¾i¡
> > 
	g©Œs
;

347 
	gli¡
<

348 
	gboo¡
::
tu¶e
<

349 
ušt64_t
, 
	gušt64_t
, 
	gm­
<
	gpg_sh¬d_t
, 
	gbufã¾i¡
> > > 
	g»tuºed
;

350 
»ad_»suÉ_t
(è: 
r
(0) {}

352 
	s»ad_»que¡_t
 {

353 cÚ¡ 
	gli¡
<
	gboo¡
::
tu¶e
<
ušt64_t
, 
	gušt64_t
, 
	gušt32_t
> > 
	gto_»ad
;

354 cÚ¡ 
	gm­
<
	gpg_sh¬d_t
, 
	gveùÜ
<
	g·œ
<, >>> 
	gÃed
;

355 cÚ¡ 
boŞ
 
	gwªt_©Œs
;

356 
	gG’CÚ‹xt
<
	g·œ
<
	gRecov”yMes§ges
 *, 
	g»ad_»suÉ_t
& > &> *
	gcb
;

357 
»ad_»que¡_t
(

358 cÚ¡ 
li¡
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
> > &
to_»ad
,

359 cÚ¡ 
m­
<
pg_sh¬d_t
, 
veùÜ
<
·œ
<, >>> &
Ãed
,

360 
boŞ
 
wªt_©Œs
,

361 
G’CÚ‹xt
<
·œ
<
Recov”yMes§ges
 *, 
»ad_»suÉ_t
& > &> *
cb
)

362 : 
to_»ad
Ño_»ad), 
Ãed
Ò“d), 
wªt_©Œs
(want_attrs),

363 
cb
(cb) {}

365 
ä›nd
 
	go¡»am
 &
	gİ”©Ü
<<(o¡»am &
	glhs
, cÚ¡ 
	g»ad_»que¡_t
 &
	grhs
);

367 
	sR—dOp
 {

368 
	g´iÜ™y
;

369 
ûph_tid_t
 
	gtid
;

370 
OpReque¡Ref
 
	gİ
;

374 
boŞ
 
	gdo_»dundªt_»ads
;

377 
boŞ
 
	gfÜ_»cov”y
;

379 
	gZT¿ûr
::
T¿û
 
Œaû
;

381 
	gm­
<
	ghobjeù_t
, 
	g£t
<>> 
	gwªt_to_»ad
;

382 
	gm­
<
	ghobjeù_t
, 
	g»ad_»que¡_t
> 
	gto_»ad
;

383 
	gm­
<
	ghobjeù_t
, 
	g»ad_»suÉ_t
> 
	gcom¶‘e
;

385 
	gm­
<
	ghobjeù_t
, 
	g£t
<
	gpg_sh¬d_t
>> 
	gobj_to_sourû
;

386 
	gm­
<
	gpg_sh¬d_t
, 
	g£t
<
	ghobjeù_t
> > 
	gsourû_to_obj
;

388 
dump
(
FÜm©‹r
 *
f
) const;

390 
	g£t
<
	gpg_sh¬d_t
> 
	gš_´og»ss
;

392 
R—dOp
(

393 
´iÜ™y
,

394 
ûph_tid_t
 
tid
,

395 
boŞ
 
do_»dundªt_»ads
,

396 
boŞ
 
fÜ_»cov”y
,

397 
OpReque¡Ref
 
İ
,

398 
m­
<
hobjeù_t
, 
£t
<>> &&
_wªt_to_»ad
,

399 
m­
<
hobjeù_t
, 
»ad_»que¡_t
> &&
_to_»ad
)

400 : 
´iÜ™y
ÕriÜ™y), 
tid
Ñid), 
İ
(İ), 
do_»dundªt_»ads
(do_redundant_reads),

401 
fÜ_»cov”y
(fÜ_»cov”y), 
wªt_to_»ad
(
¡d
::
move
(
_wªt_to_»ad
)),

402 
to_»ad
(
¡d
::
move
(
_to_»ad
)) {

403 autØ&&
h·œ
: 
to_»ad
) {

404 autØ&
»tuºed
 = 
com¶‘e
[
h·œ
.
fœ¡
].returned;

405 autØ&&
	gex‹Á
: 
h·œ
.
£cÚd
.
to_»ad
) {

406 
»tuºed
.
push_back
(

407 
boo¡
::
make_tu¶e
(

408 
ex‹Á
.
g‘
<0>(),

409 
ex‹Á
.
g‘
<1>(),

410 
m­
<
pg_sh¬d_t
, 
bufã¾i¡
>()));

414 
R—dOp
(èğ
d–‘e
;

415 
R—dOp
(const ReadOp &) = ;

416 
R—dOp
(ReadOp &&) = ;

418 
ä›nd
 
	gFšishR—dOp
;

419 
f‹r_»ad_İ
(

420 cÚ¡ 
OSDM­Ref
& 
osdm­
,

421 
R—dOp
 &
İ
);

422 
com¶‘e_»ad_İ
(
R—dOp
 &
rİ
, 
Recov”yMes§ges
 *
m
);

423 
ä›nd
 
	go¡»am
 &
	gİ”©Ü
<<(o¡»am &
	glhs
, cÚ¡ 
	gR—dOp
 &
	grhs
);

424 
	gm­
<
	gûph_tid_t
, 
	gR—dOp
> 
	gtid_to_»ad_m­
;

425 
	gm­
<
	gpg_sh¬d_t
, 
	g£t
<
	gûph_tid_t
> > 
	gsh¬d_to_»ad_m­
;

426 
¡¬t_»ad_İ
(

427 
´iÜ™y
,

428 
m­
<
hobjeù_t
, 
£t
<>> &
wªt_to_»ad
,

429 
m­
<
hobjeù_t
, 
»ad_»que¡_t
> &
to_»ad
,

430 
OpReque¡Ref
 
İ
,

431 
boŞ
 
do_»dundªt_»ads
, boŞ 
fÜ_»cov”y
);

433 
do_»ad_İ
(
R—dOp
 &
rİ
);

434 
£nd_®l_»maššg_»ads
(

435 cÚ¡ 
hobjeù_t
 &
hoid
,

436 
R—dOp
 &
rİ
);

452 
	gOp
 : 
boo¡
::
šŒusive
::
li¡_ba£_hook
<> {

454 
hobjeù_t
 
hoid
;

455 
objeù_¡©_sum_t
 
	gd–_¡©s
;

456 
ev”siÚ_t
 
	gv”siÚ
;

457 
ev”siÚ_t
 
	gŒim_to
;

458 
	gboo¡
::
İtiÚ®
<
pg_h™_£t_hi¡Üy_t
> 
upd©ed_h™_£t_hi¡Üy
;

459 
	gveùÜ
<
	gpg_log_’Œy_t
> 
	glog_’Œ›s
;

460 
ûph_tid_t
 
	gtid
;

461 
osd_»qid_t
 
	g»qid
;

462 
	gZT¿ûr
::
T¿û
 
Œaû
;

464 
ev”siÚ_t
 
	grŞl_fÜw¬d_to
;

467 
	gm­
<
	ghobjeù_t
, 
	gObjeùCÚ‹xtRef
> 
	gobc_m­
;

470 
	g¡d
::
li¡
<
¡d
::
funùiÚ
<()> > 
Ú_wr™e
;

473 
	g£t
<
	ghobjeù_t
> 
	g‹mp_added
;

474 
	g£t
<
	ghobjeù_t
> 
	g‹mp_ş—»d
;

476 
	gECT¿n§ùiÚ
::
Wr™ePÏn
 
¶ª
;

477 
boŞ
 
»quœes_rmw
(ècÚ¡ {  !
	g¶ª
.
	gto_»ad
.
em±y
(); }

478 
boŞ
 
šv®id©es_ÿche
(ècÚ¡ {  
	g¶ª
.
	gšv®id©es_ÿche
; }

481 
boŞ
 
	gusšg_ÿche
 = 
çl£
;

484 
	gm­
<
	ghobjeù_t
,
	gex‹Á_£t
> 
	g³ndšg_»ad
;

485 
	gm­
<
	ghobjeù_t
,
	gex‹Á_£t
> 
	g»mÙe_»ad
;

486 
	gm­
<
	ghobjeù_t
,
	gex‹Á_m­
> 
	g»mÙe_»ad_»suÉ
;

487 
boŞ
 
»ad_š_´og»ss
() const {

488  !
	g»mÙe_»ad
.
em±y
(è&& 
	g»mÙe_»ad_»suÉ
.empty();

492 
	g£t
<
	gpg_sh¬d_t
> 
	g³ndšg_comm™
;

496 
	g£t
<
	gpg_sh¬d_t
> 
	g³ndšg_­¶y
;

497 
boŞ
 
wr™e_š_´og»ss
() const {

498  !
	g³ndšg_comm™
.
em±y
(è|| !
	g³ndšg_­¶y
.empty();

502 
OpReque¡Ref
 
	gş›Á_İ
;

505 
	gEx‹ÁCache
::
wr™e_pš
 
pš
;

508 
CÚ‹xt
 *
	gÚ_®l_comm™
 = 
nuÎ±r
;

509 ~
Op
() {

510 
d–‘e
 
	gÚ_®l_comm™
;

513 
usšg
 
	gİ_li¡
 = 
boo¡
::
šŒusive
::
li¡
<
Op
>;

514 
ä›nd
 
	go¡»am
 &
	gİ”©Ü
<<(o¡»am &
	glhs
, cÚ¡ 
	gOp
 &
	grhs
);

516 
Ex‹ÁCache
 
	gÿche
;

517 
	gm­
<
	gûph_tid_t
, 
	gOp
> 
	gtid_to_İ_m­
;

539 şas 
	cp–še_¡©e_t
 {

541 
	gCACHE_VALID
 = 0,

542 
	gCACHE_INVALID
 = 1

543 } 
	gp–še_¡©e
 = 
CACHE_VALID
;

544 
	gpublic
:

545 
boŞ
 
ÿchšg_’abËd
() const {

546  
p–še_¡©e
 =ğ
CACHE_VALID
;

548 
boŞ
 
ÿche_šv®id
() const {

549  !
ÿchšg_’abËd
();

551 
šv®id©e
() {

552 
	gp–še_¡©e
 = 
CACHE_INVALID
;

554 
ş—r
() {

555 
	gp–še_¡©e
 = 
CACHE_VALID
;

557 
ä›nd
 
	go¡»am
 &
	gİ”©Ü
<<(o¡»am &
	glhs
, cÚ¡ 
	gp–še_¡©e_t
 &
	grhs
);

558 } 
	gp–še_¡©e
;

561 
İ_li¡
 
	gwa™šg_¡©e
;

562 
İ_li¡
 
	gwa™šg_»ads
;

563 
İ_li¡
 
	gwa™šg_comm™
;

564 
ev”siÚ_t
 
	gcom¶‘ed_to
;

565 
ev”siÚ_t
 
	gcomm™‹d_to
;

566 
¡¬t_rmw
(
Op
 *
İ
, 
PGT¿n§ùiÚUPŒ
 &&
t
);

567 
boŞ
 
Œy_¡©e_to_»ads
();

568 
boŞ
 
Œy_»ads_to_comm™
();

569 
boŞ
 
Œy_fšish_rmw
();

570 
check_İs
();

572 
E¿su»CodeIÁ”çûRef
 
	gec_im¶
;

580 şas 
	cECRecP»d
 : 
public
 
IsPGRecov”abËP»diÿ‹
 {

581 
£t
<> 
wªt
;

582 
E¿su»CodeIÁ”çûRef
 
	gec_im¶
;

583 
	gpublic
:

584 
ex¶ic™
 
ECRecP»d
(
E¿su»CodeIÁ”çûRef
 
ec_im¶
) :ƒc_impl(ec_impl) {

585 
i
 = 0; 
	gi
 < 
	gec_im¶
->
g‘_chunk_couÁ
(); ++i) {

586 
	gwªt
.
š£¹
(
i
);

589 
boŞ
 
İ”©Ü
()(cÚ¡ 
	g£t
<
	gpg_sh¬d_t
> &
	g_have
ècÚ¡ 
	gov”ride
 {

590 
	g£t
<> 
	ghave
;

591 
	g£t
<
	gpg_sh¬d_t
>::
cÚ¡_™”©Ü
 
i
 = 
_have
.
begš
();

592 
	gi
 !ğ
_have
.
’d
();

593 ++
	gi
) {

594 
	ghave
.
š£¹
(
i
->
sh¬d
);

596 
	gm­
<, 
	gveùÜ
<
	g·œ
<, >>> 
	gmš
;

597  
	gec_im¶
->
mšimum_to_decode
(
wªt
, 
have
, &
mš
) == 0;

600 
IsPGRecov”abËP»diÿ‹
 *
	$g‘_is_»cov”abË_´ediÿ‹
(ècÚ¡ 
ov”ride
 {

601  
Ãw
 
	`ECRecP»d
(
ec_im¶
);

602 
	}
}

609 şas 
	cECR—dP»d
 : 
public
 
IsPGR—dabËP»diÿ‹
 {

610 
pg_sh¬d_t
 
whßmi
;

611 
ECRecP»d
 
	g»c_´ed
;

612 
	gpublic
:

613 
ECR—dP»d
(

614 
pg_sh¬d_t
 
whßmi
,

615 
E¿su»CodeIÁ”çûRef
 
ec_im¶
è: 
whßmi
(whßmi), 
»c_´ed
(ec_impl) {}

616 
boŞ
 
İ”©Ü
()(cÚ¡ 
	g£t
<
	gpg_sh¬d_t
> &
	g_have
ècÚ¡ 
	gov”ride
 {

617  
	g_have
.
couÁ
(
whßmi
è&& 
»c_´ed
(
_have
);

620 
IsPGR—dabËP»diÿ‹
 *
	$g‘_is_»adabË_´ediÿ‹
(ècÚ¡ 
ov”ride
 {

621  
Ãw
 
	`ECR—dP»d
(
	`g‘_·»Á
()->
	`whßmi_sh¬d
(), 
ec_im¶
);

622 
	}
}

625 cÚ¡ 
	gECUt
::
¡re_šfo_t
 
sšfo
;

627 
	gSh¬edPŒRegi¡ry
<
	ghobjeù_t
, 
	gECUt
::
HashInfo
> 
un¡abË_hashšfo_»gi¡ry
;

628 
	gECUt
::
HashInfoRef
 
g‘_hash_šfo
(cÚ¡ 
hobjeù_t
 &
hoid
, 
boŞ
 
checks
 = 
Œue
,

629 cÚ¡ 
m­
<
¡ršg
,
bufã½Œ
> *
©Œ
 = 
NULL
);

631 
	gpublic
:

632 
ECBack’d
(

633 
PGBack’d
::
Li¡’”
 *
pg
,

634 cÚ¡ 
cŞl_t
 &
cŞl
,

635 
ObjeùStÜe
::
CŞËùiÚHªdË
 &
ch
,

636 
ObjeùStÜe
 *
¡Üe
,

637 
C•hCÚ‹xt
 *
cù
,

638 
E¿su»CodeIÁ”çûRef
 
ec_im¶
,

639 
ušt64_t
 
¡re_width
);

642 
g‘_mš_ava_to_»ad_sh¬ds
(

643 cÚ¡ 
hobjeù_t
 &
hoid
,

644 cÚ¡ 
£t
<> &
wªt
,

645 
boŞ
 
fÜ_»cov”y
,

646 
boŞ
 
do_»dundªt_»ads
,

647 
m­
<
pg_sh¬d_t
, 
veùÜ
<
·œ
<, >>> *
to_»ad


650 
g‘_»maššg_sh¬ds
(

651 cÚ¡ 
hobjeù_t
 &
hoid
,

652 cÚ¡ 
£t
<> &
ava
,

653 cÚ¡ 
£t
<> &
wªt
,

654 cÚ¡ 
»ad_»suÉ_t
 &
»suÉ
,

655 
m­
<
pg_sh¬d_t
, 
veùÜ
<
·œ
<, >>> *
to_»ad
,

656 
boŞ
 
fÜ_»cov”y
);

658 
objeùs_g‘_©Œs
(

659 cÚ¡ 
hobjeù_t
 &
hoid
,

660 
m­
<
¡ršg
, 
bufã¾i¡
> *
out
è
	gov”ride
;

662 
	$rŞlback_­³nd
(

663 cÚ¡ 
hobjeù_t
 &
hoid
,

664 
ušt64_t
 
Şd_size
,

665 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
è
ov”ride
;

667 
boŞ
 
	$auto_»·œ_suµÜ‹d
(ècÚ¡ 
ov”ride
 {  
Œue
; 
	}
}

669 
	$be_d“p_süub
(

670 cÚ¡ 
hobjeù_t
 &
poid
,

671 
SüubM­
 &
m­
,

672 
SüubM­Bud”
 &
pos
,

673 
SüubM­
::
objeù
 &
o
è
ov”ride
;

674 
ušt64_t
 
	$be_g‘_Údisk_size
(
ušt64_t
 
logiÿl_size
è
ov”ride
 {

675  
sšfo
.
	`logiÿl_to_Ãxt_chunk_off£t
(
logiÿl_size
);

676 
	}
}

677 
_çed_push
(cÚ¡ 
hobjeù_t
 &
hoid
,

678 
·œ
<
Recov”yMes§ges
 *, 
ECBack’d
::
»ad_»suÉ_t
 &> &
š
);

680 
	go¡»am
 &
	gİ”©Ü
<<(o¡»am &
	glhs
, cÚ¡ 
	gECBack’d
::
p–še_¡©e_t
 &
rhs
);

	@osd/ECMsgTypes.cc

15 
	~"ECMsgTy³s.h
"

17 
	gECSubWr™e
::
	$’code
(
bufã¾i¡
 &
bl
) const

19 
	`ENCODE_START
(4, 1, 
bl
);

20 
	`’code
(
äom
, 
bl
);

21 
	`’code
(
tid
, 
bl
);

22 
	`’code
(
»qid
, 
bl
);

23 
	`’code
(
soid
, 
bl
);

24 
	`’code
(
¡©s
, 
bl
);

25 
	`’code
(
t
, 
bl
);

26 
	`’code
(
©_v”siÚ
, 
bl
);

27 
	`’code
(
Œim_to
, 
bl
);

28 
	`’code
(
log_’Œ›s
, 
bl
);

29 
	`’code
(
‹mp_added
, 
bl
);

30 
	`’code
(
‹mp_»moved
, 
bl
);

31 
	`’code
(
upd©ed_h™_£t_hi¡Üy
, 
bl
);

32 
	`’code
(
rŞl_fÜw¬d_to
, 
bl
);

33 
	`’code
(
backfl_Ü_async_»cov”y
, 
bl
);

34 
	`ENCODE_FINISH
(
bl
);

35 
	}
}

37 
	gECSubWr™e
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

39 
	`DECODE_START
(4, 
bl
);

40 
	`decode
(
äom
, 
bl
);

41 
	`decode
(
tid
, 
bl
);

42 
	`decode
(
»qid
, 
bl
);

43 
	`decode
(
soid
, 
bl
);

44 
	`decode
(
¡©s
, 
bl
);

45 
	`decode
(
t
, 
bl
);

46 
	`decode
(
©_v”siÚ
, 
bl
);

47 
	`decode
(
Œim_to
, 
bl
);

48 
	`decode
(
log_’Œ›s
, 
bl
);

49 
	`decode
(
‹mp_added
, 
bl
);

50 
	`decode
(
‹mp_»moved
, 
bl
);

51 ià(
¡ruù_v
 >= 2) {

52 
	`decode
(
upd©ed_h™_£t_hi¡Üy
, 
bl
);

54 ià(
¡ruù_v
 >= 3) {

55 
	`decode
(
rŞl_fÜw¬d_to
, 
bl
);

57 
rŞl_fÜw¬d_to
 = 
Œim_to
;

59 ià(
¡ruù_v
 >= 4) {

60 
	`decode
(
backfl_Ü_async_»cov”y
, 
bl
);

63 
backfl_Ü_async_»cov”y
 = 
t
.
	`em±y
();

65 
	`DECODE_FINISH
(
bl
);

66 
	}
}

68 
	g¡d
::
o¡»am
 &
İ”©Ü
<<(

69 
¡d
::
o¡»am
 &
lhs
, cÚ¡ 
	gECSubWr™e
 &
	grhs
)

71 
	glhs
 << "ECSubWr™eÑid=" << 
	grhs
.
	gtid


72 << ",„eqid=" << 
	grhs
.
	g»qid


73 << ",‡t_v”siÚ=" << 
	grhs
.
	g©_v”siÚ


74 << ",rim_to=" << 
	grhs
.
	gŒim_to


75 << ",„Şl_fÜw¬d_to=" << 
	grhs
.
	grŞl_fÜw¬d_to
;

76 ià(
	grhs
.
	gupd©ed_h™_£t_hi¡Üy
)

77 
	glhs
 << ", has_updated_hit_set_history";

78 ià(
	grhs
.
	gbackfl_Ü_async_»cov”y
)

79 
	glhs
 << ", backfill_or_async_recovery";

80  
	glhs
 << ")";

83 
	gECSubWr™e
::
	$dump
(
FÜm©‹r
 *
f
) const

85 
f
->
	`dump_unsigÃd
("tid", 
tid
);

86 
f
->
	`dump_¡»am
("»qid"è<< 
»qid
;

87 
f
->
	`dump_¡»am
("©_v”siÚ"è<< 
©_v”siÚ
;

88 
f
->
	`dump_¡»am
("Œim_to"è<< 
Œim_to
;

89 
f
->
	`dump_¡»am
("rŞl_fÜw¬d_to"è<< 
rŞl_fÜw¬d_to
;

90 
f
->
	`dump_boŞ
("has_updated_hit_set_history",

91 
¡©ic_ÿ¡
<
boŞ
>(
upd©ed_h™_£t_hi¡Üy
));

92 
f
->
	`dump_boŞ
("backfl_Ü_async_»cov”y", 
backfl_Ü_async_»cov”y
);

93 
	}
}

95 
	gECSubWr™e
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
ECSubWr™e
*> &
o
)

97 
o
.
push_back
(
Ãw
 
ECSubWr™e
());

98 
	go
.
back
()->
	gtid
 = 1;

99 
	go
.
back
()->
	g©_v”siÚ
 = 
ev”siÚ_t
(2, 100);

100 
	go
.
back
()->
	gŒim_to
 = 
ev”siÚ_t
(1, 40);

101 
	go
.
push_back
(
Ãw
 
ECSubWr™e
());

102 
	go
.
back
()->
	gtid
 = 4;

103 
	go
.
back
()->
	g»qid
 = 
osd_»qid_t
(
’t™y_Çme_t
::
CLIENT
(123), 1, 45678);

104 
	go
.
back
()->
	g©_v”siÚ
 = 
ev”siÚ_t
(10, 300);

105 
	go
.
back
()->
	gŒim_to
 = 
ev”siÚ_t
(5, 42);

106 
	go
.
push_back
(
Ãw
 
ECSubWr™e
());

107 
	go
.
back
()->
	gtid
 = 9;

108 
	go
.
back
()->
	g»qid
 = 
osd_»qid_t
(
’t™y_Çme_t
::
CLIENT
(123), 1, 45678);

109 
	go
.
back
()->
	g©_v”siÚ
 = 
ev”siÚ_t
(10, 300);

110 
	go
.
back
()->
	gŒim_to
 = 
ev”siÚ_t
(5, 42);

111 
	go
.
back
()->
	grŞl_fÜw¬d_to
 = 
ev”siÚ_t
(8, 250);

114 
	gECSubWr™eR•ly
::
	$’code
(
bufã¾i¡
 &
bl
) const

116 
	`ENCODE_START
(1, 1, 
bl
);

117 
	`’code
(
äom
, 
bl
);

118 
	`’code
(
tid
, 
bl
);

119 
	`’code
(
Ï¡_com¶‘e
, 
bl
);

120 
	`’code
(
comm™‹d
, 
bl
);

121 
	`’code
(
­¶›d
, 
bl
);

122 
	`ENCODE_FINISH
(
bl
);

123 
	}
}

125 
	gECSubWr™eR•ly
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

127 
	`DECODE_START
(1, 
bl
);

128 
	`decode
(
äom
, 
bl
);

129 
	`decode
(
tid
, 
bl
);

130 
	`decode
(
Ï¡_com¶‘e
, 
bl
);

131 
	`decode
(
comm™‹d
, 
bl
);

132 
	`decode
(
­¶›d
, 
bl
);

133 
	`DECODE_FINISH
(
bl
);

134 
	}
}

136 
	g¡d
::
o¡»am
 &
İ”©Ü
<<(

137 
¡d
::
o¡»am
 &
lhs
, cÚ¡ 
	gECSubWr™eR•ly
 &
	grhs
)

139  
	glhs


140 << "ECSubWr™eR•lyÑid=" << 
	grhs
.
	gtid


141 << ",†a¡_com¶‘e=" << 
	grhs
.
	gÏ¡_com¶‘e


142 << ", comm™‹d=" << 
	grhs
.
	gcomm™‹d


143 << ",‡µl›d=" << 
	grhs
.
	g­¶›d
 << ")";

146 
	gECSubWr™eR•ly
::
	$dump
(
FÜm©‹r
 *
f
) const

148 
f
->
	`dump_unsigÃd
("tid", 
tid
);

149 
f
->
	`dump_¡»am
("Ï¡_com¶‘e"è<< 
Ï¡_com¶‘e
;

150 
f
->
	`dump_boŞ
("comm™‹d", 
comm™‹d
);

151 
f
->
	`dump_boŞ
("­¶›d", 
­¶›d
);

152 
	}
}

154 
	gECSubWr™eR•ly
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
ECSubWr™eR•ly
*>& 
o
)

156 
o
.
push_back
(
Ãw
 
ECSubWr™eR•ly
());

157 
	go
.
back
()->
	gtid
 = 20;

158 
	go
.
back
()->
	gÏ¡_com¶‘e
 = 
ev”siÚ_t
(100, 2000);

159 
	go
.
back
()->
	gcomm™‹d
 = 
Œue
;

160 
	go
.
push_back
(
Ãw
 
ECSubWr™eR•ly
());

161 
	go
.
back
()->
	gtid
 = 80;

162 
	go
.
back
()->
	gÏ¡_com¶‘e
 = 
ev”siÚ_t
(50, 200);

163 
	go
.
back
()->
	g­¶›d
 = 
Œue
;

166 
	gECSubR—d
::
	$’code
(
bufã¾i¡
 &
bl
, 
ušt64_t
 
ã©u»s
) const

168 ià((
ã©u»s
 & 
CEPH_FEATURE_OSD_FADVISE_FLAGS
) == 0) {

169 
	`ENCODE_START
(2, 1, 
bl
);

170 
	`’code
(
äom
, 
bl
);

171 
	`’code
(
tid
, 
bl
);

172 
m­
<
hobjeù_t
, 
li¡
<
·œ
<
ušt64_t
, ušt64_t> >> 
tmp
;

173 
m­
<
hobjeù_t
, 
li¡
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
> >>::
cÚ¡_™”©Ü
 
m
 = 
to_»ad
.
	`begš
();

174 
m
 !ğ
to_»ad
.
	`’d
(); ++m) {

175 
li¡
<
·œ
<
ušt64_t
, ušt64_t> > 
i¡
;

176 
li¡
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
> >::
cÚ¡_™”©Ü
 
l
 = 
m
->
£cÚd
.
	`begš
();

177 
l
 !ğ
m
->
£cÚd
.
	`’d
(); ++l) {

178 
i¡
.
	`push_back
(
¡d
::
	`make_·œ
(
l
->
g‘
<0>(),†->get<1>()));

180 
tmp
[
m
->
fœ¡
] = 
i¡
;

182 
	`’code
(
tmp
, 
bl
);

183 
	`’code
(
©Œs_to_»ad
, 
bl
);

184 
	`’code
(
subchunks
, 
bl
);

185 
	`ENCODE_FINISH
(
bl
);

189 
	`ENCODE_START
(3, 2, 
bl
);

190 
	`’code
(
äom
, 
bl
);

191 
	`’code
(
tid
, 
bl
);

192 
	`’code
(
to_»ad
, 
bl
);

193 
	`’code
(
©Œs_to_»ad
, 
bl
);

194 
	`’code
(
subchunks
, 
bl
);

195 
	`ENCODE_FINISH
(
bl
);

196 
	}
}

198 
	gECSubR—d
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

200 
	`DECODE_START
(3, 
bl
);

201 
	`decode
(
äom
, 
bl
);

202 
	`decode
(
tid
, 
bl
);

203 ià(
¡ruù_v
 == 1) {

204 
m­
<
hobjeù_t
, 
li¡
<
·œ
<
ušt64_t
, ušt64_t> >>
tmp
;

205 
	`decode
(
tmp
, 
bl
);

206 
m­
<
hobjeù_t
, 
li¡
<
·œ
<
ušt64_t
, ušt64_t> >>::
cÚ¡_™”©Ü
 
m
 = 
tmp
.
	`begš
();

207 
m
 !ğ
tmp
.
	`’d
(); ++m) {

208 
li¡
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
> > 
i¡
;

209 
li¡
<
·œ
<
ušt64_t
, ušt64_t> > ::
cÚ¡_™”©Ü
 
l
 = 
m
->
£cÚd
.
	`begš
();

210 
l
 !ğ
m
->
£cÚd
.
	`’d
(); ++l) {

211 
i¡
.
	`push_back
(
boo¡
::
	`make_tu¶e
(
l
->
fœ¡
,†->
£cÚd
, 0));

213 
to_»ad
[
m
->
fœ¡
] = 
i¡
;

216 
	`decode
(
to_»ad
, 
bl
);

218 
	`decode
(
©Œs_to_»ad
, 
bl
);

219 ià(
¡ruù_v
 > 2 && sŒuù_v > 
¡ruù_com·t
) {

220 
	`decode
(
subchunks
, 
bl
);

222 autØ&
i
 : 
to_»ad
) {

223 
subchunks
[
i
.
fœ¡
].
	`push_back
(
	`make_·œ
(0, 1));

226 
	`DECODE_FINISH
(
bl
);

227 
	}
}

229 
	g¡d
::
o¡»am
 &
İ”©Ü
<<(

230 
¡d
::
o¡»am
 &
lhs
, cÚ¡ 
	gECSubR—d
 &
	grhs
)

232  
	glhs


233 << "ECSubR—dÑid=" << 
	grhs
.
	gtid


234 << ",o_»ad=" << 
	grhs
.
	gto_»ad


235 << ", subchunks=" << 
	grhs
.
	gsubchunks


236 << ",‡‰rs_to_»ad=" << 
	grhs
.
	g©Œs_to_»ad
 << ")";

239 
	gECSubR—d
::
	$dump
(
FÜm©‹r
 *
f
) const

241 
f
->
	`dump_¡»am
("äom"è<< 
äom
;

242 
f
->
	`dump_unsigÃd
("tid", 
tid
);

243 
f
->
	`İ’_¬¿y_£ùiÚ
("objects");

244 
m­
<
hobjeù_t
, 
li¡
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
> >>::
cÚ¡_™”©Ü
 
i
 =

245 
to_»ad
.
	`begš
();

246 
i
 !ğ
to_»ad
.
	`’d
();

247 ++
i
) {

248 
f
->
	`İ’_objeù_£ùiÚ
("object");

249 
f
->
	`dump_¡»am
("oid"è<< 
i
->
fœ¡
;

250 
f
->
	`İ’_¬¿y_£ùiÚ
("extents");

251 
li¡
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
> >::
cÚ¡_™”©Ü
 
j
 =

252 
i
->
£cÚd
.
	`begš
();

253 
j
 !ğ
i
->
£cÚd
.
	`’d
();

254 ++
j
) {

255 
f
->
	`İ’_objeù_£ùiÚ
("extent");

256 
f
->
	`dump_unsigÃd
("off", 
j
->
g‘
<0>());

257 
f
->
	`dump_unsigÃd
("Ën", 
j
->
g‘
<1>());

258 
f
->
	`dump_unsigÃd
("æags", 
j
->
g‘
<2>());

259 
f
->
	`şo£_£ùiÚ
();

261 
f
->
	`şo£_£ùiÚ
();

262 
f
->
	`şo£_£ùiÚ
();

264 
f
->
	`şo£_£ùiÚ
();

266 
f
->
	`İ’_¬¿y_£ùiÚ
("object_attrs_requested");

267 
£t
<
hobjeù_t
>::
cÚ¡_™”©Ü
 
i
 = 
©Œs_to_»ad
.
	`begš
();

268 
i
 !ğ
©Œs_to_»ad
.
	`’d
();

269 ++
i
) {

270 
f
->
	`İ’_objeù_£ùiÚ
("object");

271 
f
->
	`dump_¡»am
("oid"è<< *
i
;

272 
f
->
	`şo£_£ùiÚ
();

274 
f
->
	`şo£_£ùiÚ
();

275 
	}
}

277 
	gECSubR—d
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
ECSubR—d
*>& 
o
)

279 
hobjeù_t
 
hoid1
(
sobjeù_t
("asdf", 1));

280 
hobjeù_t
 
hoid2
(
sobjeù_t
("asdf2", 
CEPH_NOSNAP
));

281 
	go
.
push_back
(
Ãw
 
ECSubR—d
());

282 
	go
.
back
()->
	gäom
 = 
pg_sh¬d_t
(2, 
sh¬d_id_t
(-1));

283 
	go
.
back
()->
	gtid
 = 1;

284 
	go
.
back
()->
	gto_»ad
[
hoid1
].
push_back
(
boo¡
::
make_tu¶e
(100, 200, 0));

285 
	go
.
back
()->
	gto_»ad
[
hoid1
].
push_back
(
boo¡
::
make_tu¶e
(400, 600, 0));

286 
	go
.
back
()->
	gto_»ad
[
hoid2
].
push_back
(
boo¡
::
make_tu¶e
(400, 600, 0));

287 
	go
.
back
()->
	g©Œs_to_»ad
.
š£¹
(
hoid1
);

288 
	go
.
push_back
(
Ãw
 
ECSubR—d
());

289 
	go
.
back
()->
	gäom
 = 
pg_sh¬d_t
(2, 
sh¬d_id_t
(-1));

290 
	go
.
back
()->
	gtid
 = 300;

291 
	go
.
back
()->
	gto_»ad
[
hoid1
].
push_back
(
boo¡
::
make_tu¶e
(300, 200, 0));

292 
	go
.
back
()->
	gto_»ad
[
hoid2
].
push_back
(
boo¡
::
make_tu¶e
(400, 600, 0));

293 
	go
.
back
()->
	gto_»ad
[
hoid2
].
push_back
(
boo¡
::
make_tu¶e
(2000, 600, 0));

294 
	go
.
back
()->
	g©Œs_to_»ad
.
š£¹
(
hoid2
);

297 
	gECSubR—dR•ly
::
	$’code
(
bufã¾i¡
 &
bl
) const

299 
	`ENCODE_START
(1, 1, 
bl
);

300 
	`’code
(
äom
, 
bl
);

301 
	`’code
(
tid
, 
bl
);

302 
	`’code
(
bufãrs_»ad
, 
bl
);

303 
	`’code
(
©Œs_»ad
, 
bl
);

304 
	`’code
(
”rÜs
, 
bl
);

305 
	`ENCODE_FINISH
(
bl
);

306 
	}
}

308 
	gECSubR—dR•ly
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

310 
	`DECODE_START
(1, 
bl
);

311 
	`decode
(
äom
, 
bl
);

312 
	`decode
(
tid
, 
bl
);

313 
	`decode
(
bufãrs_»ad
, 
bl
);

314 
	`decode
(
©Œs_»ad
, 
bl
);

315 
	`decode
(
”rÜs
, 
bl
);

316 
	`DECODE_FINISH
(
bl
);

317 
	}
}

319 
	g¡d
::
o¡»am
 &
İ”©Ü
<<(

320 
¡d
::
o¡»am
 &
lhs
, cÚ¡ 
	gECSubR—dR•ly
 &
	grhs
)

322  
	glhs


323 << "ECSubR—dR•lyÑid=" << 
	grhs
.
	gtid


324 << ",‡‰rs_»ad=" << 
	grhs
.
	g©Œs_»ad
.
size
()

328 
	gECSubR—dR•ly
::
	$dump
(
FÜm©‹r
 *
f
) const

330 
f
->
	`dump_¡»am
("äom"è<< 
äom
;

331 
f
->
	`dump_unsigÃd
("tid", 
tid
);

332 
f
->
	`İ’_¬¿y_£ùiÚ
("buffers_read");

333 
m­
<
hobjeù_t
, 
li¡
<
·œ
<
ušt64_t
, 
bufã¾i¡
> >>::
cÚ¡_™”©Ü
 
i
 =

334 
bufãrs_»ad
.
	`begš
();

335 
i
 !ğ
bufãrs_»ad
.
	`’d
();

336 ++
i
) {

337 
f
->
	`İ’_objeù_£ùiÚ
("object");

338 
f
->
	`dump_¡»am
("oid"è<< 
i
->
fœ¡
;

339 
f
->
	`İ’_¬¿y_£ùiÚ
("data");

340 
li¡
<
·œ
<
ušt64_t
, 
bufã¾i¡
> >::
cÚ¡_™”©Ü
 
j
 =

341 
i
->
£cÚd
.
	`begš
();

342 
j
 !ğ
i
->
£cÚd
.
	`’d
();

343 ++
j
) {

344 
f
->
	`İ’_objeù_£ùiÚ
("extent");

345 
f
->
	`dump_unsigÃd
("off", 
j
->
fœ¡
);

346 
f
->
	`dump_unsigÃd
("buf_Ën", 
j
->
£cÚd
.
	`Ëngth
());

347 
f
->
	`şo£_£ùiÚ
();

349 
f
->
	`şo£_£ùiÚ
();

350 
f
->
	`şo£_£ùiÚ
();

352 
f
->
	`şo£_£ùiÚ
();

354 
f
->
	`İ’_¬¿y_£ùiÚ
("attrs_returned");

355 
m­
<
hobjeù_t
, m­<
¡ršg
, 
bufã¾i¡
>>::
cÚ¡_™”©Ü
 
i
 =

356 
©Œs_»ad
.
	`begš
();

357 
i
 !ğ
©Œs_»ad
.
	`’d
();

358 ++
i
) {

359 
f
->
	`İ’_objeù_£ùiÚ
("object_attrs");

360 
f
->
	`dump_¡»am
("oid"è<< 
i
->
fœ¡
;

361 
f
->
	`İ’_¬¿y_£ùiÚ
("attrs");

362 
m­
<
¡ršg
, 
bufã¾i¡
>::
cÚ¡_™”©Ü
 
j
 = 
i
->
£cÚd
.
	`begš
();

363 
j
 !ğ
i
->
£cÚd
.
	`’d
();

364 ++
j
) {

365 
f
->
	`İ’_objeù_£ùiÚ
("attr");

366 
f
->
	`dump_¡ršg
("©Œ", 
j
->
fœ¡
);

367 
f
->
	`dump_unsigÃd
("v®_Ën", 
j
->
£cÚd
.
	`Ëngth
());

368 
f
->
	`şo£_£ùiÚ
();

370 
f
->
	`şo£_£ùiÚ
();

371 
f
->
	`şo£_£ùiÚ
();

373 
f
->
	`şo£_£ùiÚ
();

375 
f
->
	`İ’_¬¿y_£ùiÚ
("errors");

376 
m­
<
hobjeù_t
, >::
cÚ¡_™”©Ü
 
i
 = 
”rÜs
.
	`begš
();

377 
i
 !ğ
”rÜs
.
	`’d
();

378 ++
i
) {

379 
f
->
	`İ’_objeù_£ùiÚ
("error_pair");

380 
f
->
	`dump_¡»am
("oid"è<< 
i
->
fœ¡
;

381 
f
->
	`dump_št
("”rÜ", 
i
->
£cÚd
);

382 
f
->
	`şo£_£ùiÚ
();

384 
f
->
	`şo£_£ùiÚ
();

385 
	}
}

387 
	gECSubR—dR•ly
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
ECSubR—dR•ly
*>& 
o
)

389 
hobjeù_t
 
hoid1
(
sobjeù_t
("asdf", 1));

390 
hobjeù_t
 
hoid2
(
sobjeù_t
("asdf2", 
CEPH_NOSNAP
));

391 
bufã¾i¡
 
	gbl
;

392 
	gbl
.
­³nd_z”o
(100);

393 
bufã¾i¡
 
	gbl2
;

394 
	gbl2
.
­³nd_z”o
(200);

395 
	go
.
push_back
(
Ãw
 
ECSubR—dR•ly
());

396 
	go
.
back
()->
	gäom
 = 
pg_sh¬d_t
(2, 
sh¬d_id_t
(-1));

397 
	go
.
back
()->
	gtid
 = 1;

398 
	go
.
back
()->
	gbufãrs_»ad
[
hoid1
].
push_back
(
make_·œ
(20, 
bl
));

399 
	go
.
back
()->
	gbufãrs_»ad
[
hoid1
].
push_back
(
make_·œ
(2000, 
bl2
));

400 
	go
.
back
()->
	gbufãrs_»ad
[
hoid2
].
push_back
(
make_·œ
(0, 
bl
));

401 
	go
.
back
()->
	g©Œs_»ad
[
hoid1
]["foo"] = 
bl
;

402 
	go
.
back
()->
	g©Œs_»ad
[
hoid1
]["_"] = 
bl2
;

403 
	go
.
push_back
(
Ãw
 
ECSubR—dR•ly
());

404 
	go
.
back
()->
	gäom
 = 
pg_sh¬d_t
(2, 
sh¬d_id_t
(-1));

405 
	go
.
back
()->
	gtid
 = 300;

406 
	go
.
back
()->
	gbufãrs_»ad
[
hoid2
].
push_back
(
make_·œ
(0, 
bl2
));

407 
	go
.
back
()->
	g©Œs_»ad
[
hoid2
]["foo"] = 
bl
;

408 
	go
.
back
()->
	g©Œs_»ad
[
hoid2
]["_"] = 
bl2
;

409 
	go
.
back
()->
	g”rÜs
[
hoid1
] = -2;

	@osd/ECMsgTypes.h

15 #iâdeà
ECBMSGTYPES_H


16 
	#ECBMSGTYPES_H


	)

18 
	~"osd_ty³s.h
"

19 
	~"šşude/bufãr.h
"

20 
	~"os/ObjeùStÜe.h
"

21 
	~"boo¡/tu¶e/tu¶e.hµ
"

23 
	sECSubWr™e
 {

24 
pg_sh¬d_t
 
	mäom
;

25 
ûph_tid_t
 
	mtid
;

26 
osd_»qid_t
 
	m»qid
;

27 
hobjeù_t
 
	msoid
;

28 
pg_¡©_t
 
	m¡©s
;

29 
	mObjeùStÜe
::
T¿n§ùiÚ
 
t
;

30 
ev”siÚ_t
 
	m©_v”siÚ
;

31 
ev”siÚ_t
 
	mŒim_to
;

32 
ev”siÚ_t
 
	mrŞl_fÜw¬d_to
;

33 
	mveùÜ
<
	mpg_log_’Œy_t
> 
	mlog_’Œ›s
;

34 
	m£t
<
	mhobjeù_t
> 
	m‹mp_added
;

35 
	m£t
<
	mhobjeù_t
> 
	m‹mp_»moved
;

36 
	mboo¡
::
İtiÚ®
<
pg_h™_£t_hi¡Üy_t
> 
upd©ed_h™_£t_hi¡Üy
;

37 
boŞ
 
	mbackfl_Ü_async_»cov”y
 = 
çl£
;

38 
ECSubWr™e
(è: 
tid
(0) {}

39 
ECSubWr™e
(

40 
pg_sh¬d_t
 
äom
,

41 
ûph_tid_t
 
tid
,

42 
osd_»qid_t
 
»qid
,

43 
hobjeù_t
 
soid
,

44 cÚ¡ 
pg_¡©_t
 &
¡©s
,

45 cÚ¡ 
ObjeùStÜe
::
T¿n§ùiÚ
 &
t
,

46 
ev”siÚ_t
 
©_v”siÚ
,

47 
ev”siÚ_t
 
Œim_to
,

48 
ev”siÚ_t
 
rŞl_fÜw¬d_to
,

49 
veùÜ
<
pg_log_’Œy_t
> 
log_’Œ›s
,

50 
boo¡
::
İtiÚ®
<
pg_h™_£t_hi¡Üy_t
> 
upd©ed_h™_£t_hi¡Üy
,

51 cÚ¡ 
£t
<
hobjeù_t
> &
‹mp_added
,

52 cÚ¡ 
£t
<
hobjeù_t
> &
‹mp_»moved
,

53 
boŞ
 
backfl_Ü_async_»cov”y
)

54 : 
äom
(äom), 
tid
Ñid), 
»qid
(reqid),

55 
soid
(soid), 
¡©s
(¡©s), 
t
(t),

56 
©_v”siÚ
(at_version),

57 
Œim_to
Ñrim_to), 
rŞl_fÜw¬d_to
(roll_forward_to),

58 
log_’Œ›s
(log_entries),

59 
‹mp_added
(temp_added),

60 
‹mp_»moved
(temp_removed),

61 
upd©ed_h™_£t_hi¡Üy
(updated_hit_set_history),

62 
backfl_Ü_async_»cov”y
(backfill_or_async_recovery)

64 
şaim
(
ECSubWr™e
 &
Ùh”
) {

65 
	mäom
 = 
Ùh”
.
äom
;

66 
	mtid
 = 
Ùh”
.
tid
;

67 
	m»qid
 = 
Ùh”
.
»qid
;

68 
	msoid
 = 
Ùh”
.
soid
;

69 
	m¡©s
 = 
Ùh”
.
¡©s
;

70 
	mt
.
sw­
(
Ùh”
.
t
);

71 
	m©_v”siÚ
 = 
Ùh”
.
©_v”siÚ
;

72 
	mŒim_to
 = 
Ùh”
.
Œim_to
;

73 
	mrŞl_fÜw¬d_to
 = 
Ùh”
.
rŞl_fÜw¬d_to
;

74 
	mlog_’Œ›s
.
sw­
(
Ùh”
.
log_’Œ›s
);

75 
	m‹mp_added
.
sw­
(
Ùh”
.
‹mp_added
);

76 
	m‹mp_»moved
.
sw­
(
Ùh”
.
‹mp_»moved
);

77 
	mupd©ed_h™_£t_hi¡Üy
 = 
Ùh”
.
upd©ed_h™_£t_hi¡Üy
;

78 
	mbackfl_Ü_async_»cov”y
 = 
Ùh”
.
backfl_Ü_async_»cov”y
;

80 
’code
(
bufã¾i¡
 &
bl
) const;

81 
decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

82 
dump
(
FÜm©‹r
 *
f
) const;

83 
g’”©e_‹¡_š¡ªûs
(
li¡
<
ECSubWr™e
*>& 
o
);

84 
	m´iv©e
:

86 
ECSubWr™e
(ECSubWr™e& 
Ùh”
);

87 cÚ¡ 
	mECSubWr™e
& 
	mİ”©Ü
=(cÚ¡ 
ECSubWr™e
& 
Ùh”
);

89 
	$WRITE_CLASS_ENCODER
(
ECSubWr™e
)

91 
	sECSubWr™eR•ly
 {

92 
pg_sh¬d_t
 
äom
;

93 
ûph_tid_t
 
tid
;

94 
ev”siÚ_t
 
Ï¡_com¶‘e
;

95 
boŞ
 
comm™‹d
;

96 
boŞ
 
­¶›d
;

97 
	`ECSubWr™eR•ly
(è: 
	`tid
(0), 
	`comm™‹d
(
çl£
), 
	`­¶›d
(false) {}

98 
	`’code
(
bufã¾i¡
 &
bl
) const;

99 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

100 
	`dump
(
FÜm©‹r
 *
f
) const;

101 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
ECSubWr™eR•ly
*>& 
o
);

103 
	$WRITE_CLASS_ENCODER
(
ECSubWr™eR•ly
)

105 
	sECSubR—d
 {

106 
pg_sh¬d_t
 
äom
;

107 
ûph_tid_t
 
tid
;

108 
m­
<
hobjeù_t
, 
li¡
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
> >> 
to_»ad
;

109 
£t
<
hobjeù_t
> 
©Œs_to_»ad
;

110 
m­
<
hobjeù_t
, 
veùÜ
<
·œ
<, >>> 
subchunks
;

111 
	`’code
(
bufã¾i¡
 &
bl
, 
ušt64_t
 
ã©u»s
) const;

112 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

113 
	`dump
(
FÜm©‹r
 *
f
) const;

114 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
ECSubR—d
*>& 
o
);

116 
	$WRITE_CLASS_ENCODER_FEATURES
(
ECSubR—d
)

118 
	sECSubR—dR•ly
 {

119 
pg_sh¬d_t
 
äom
;

120 
ûph_tid_t
 
tid
;

121 
m­
<
hobjeù_t
, 
li¡
<
·œ
<
ušt64_t
, 
bufã¾i¡
> >> 
bufãrs_»ad
;

122 
m­
<
hobjeù_t
, m­<
¡ršg
, 
bufã¾i¡
>> 
©Œs_»ad
;

123 
m­
<
hobjeù_t
, > 
”rÜs
;

124 
	`’code
(
bufã¾i¡
 &
bl
) const;

125 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

126 
	`dump
(
FÜm©‹r
 *
f
) const;

127 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
ECSubR—dR•ly
*>& 
o
);

129 
	$WRITE_CLASS_ENCODER
(
ECSubR—dR•ly
)

131 
¡d
::
o¡»am
 &
İ”©Ü
<<(

132 
¡d
::
o¡»am
 &
lhs
, cÚ¡ 
ECSubWr™e
 &
rhs
);

133 
¡d
::
o¡»am
 &
İ”©Ü
<<(

134 
¡d
::
o¡»am
 &
lhs
, cÚ¡ 
ECSubWr™eR•ly
 &
rhs
);

135 
¡d
::
o¡»am
 &
İ”©Ü
<<(

136 
¡d
::
o¡»am
 &
lhs
, cÚ¡ 
ECSubR—d
 &
rhs
);

137 
¡d
::
o¡»am
 &
İ”©Ü
<<(

138 
¡d
::
o¡»am
 &
lhs
, cÚ¡ 
ECSubR—dR•ly
 &
rhs
);

	@osd/ECTransaction.cc

15 
	~<io¡»am
>

16 
	~<veùÜ
>

17 
	~<s¡»am
>

19 
	~"ECT¿n§ùiÚ.h
"

20 
	~"ECUt.h
"

21 
	~"os/ObjeùStÜe.h
"

22 
	~"commÚ/šlše_v¬ŸÁ.h
"

25 
’code_ªd_wr™e
(

26 
pg_t
 
pgid
,

27 cÚ¡ 
hobjeù_t
 &
oid
,

28 cÚ¡ 
ECUt
::
¡re_šfo_t
 &
sšfo
,

29 
E¿su»CodeIÁ”çûRef
 &
ecim¶
,

30 cÚ¡ 
£t
<> &
wªt
,

31 
ušt64_t
 
off£t
,

32 
bufã¾i¡
 
bl
,

33 
ušt32_t
 
æags
,

34 
ECUt
::
HashInfoRef
 
hšfo
,

35 
ex‹Á_m­
 &
wr™‹n
,

36 
m­
<
sh¬d_id_t
, 
ObjeùStÜe
::
T¿n§ùiÚ
> *
Œª§ùiÚs
,

37 
DoutP»fixProvid”
 *
dµ
) {

38 cÚ¡ 
ušt64_t
 
	gbefÜe_size
 = 
hšfo
->
g‘_tÙ®_logiÿl_size
(
sšfo
);

39 
as£¹
(
sšfo
.
logiÿl_off£t_is_¡re_®igÃd
(
off£t
));

40 
as£¹
(
sšfo
.
logiÿl_off£t_is_¡re_®igÃd
(
bl
.
Ëngth
()));

41 
as£¹
(
bl
.
Ëngth
());

43 
	gm­
<, 
	gbufã¾i¡
> 
	gbufãrs
;

44 
	gr
 = 
ECUt
::
’code
(

45 
sšfo
, 
ecim¶
, 
bl
, 
wªt
, &
bufãrs
);

46 
as£¹
(
r
 == 0);

48 
	gwr™‹n
.
š£¹
(
off£t
, 
bl
.
Ëngth
(), bl);

50 
ldµ_dout
(
dµ
, 20è<< 
	g__func__
 << ": " << 
	goid


52 << 
	goff£t
 + 
	gbl
.
Ëngth
()

53 << 
	gd’dl
;

55 ià(
	goff£t
 >ğ
befÜe_size
) {

56 
as£¹
(
off£t
 =ğ
befÜe_size
);

57 
	ghšfo
->
­³nd
(

58 
sšfo
.
®igÃd_logiÿl_off£t_to_chunk_off£t
(
off£t
),

59 
bufãrs
);

62 autØ&&
	gi
 : *
Œª§ùiÚs
) {

63 
as£¹
(
bufãrs
.
couÁ
(
i
.
fœ¡
));

64 
	gbufã¾i¡
 &
	g’c_bl
 = 
bufãrs
[
i
.
fœ¡
];

65 ià(
	goff£t
 >ğ
befÜe_size
) {

66 
i
.
£cÚd
.
£t_®loc_hšt
(

67 
cŞl_t
(
¥g_t
(
pgid
, 
i
.
fœ¡
)),

68 
ghobjeù_t
(
oid
, ghobjeù_t::
NO_GEN
, 
i
.
fœ¡
),

70 
CEPH_OSD_ALLOC_HINT_FLAG_SEQUENTIAL_WRITE
 |

71 
CEPH_OSD_ALLOC_HINT_FLAG_APPEND_ONLY
);

73 
	gi
.
	g£cÚd
.
wr™e
(

74 
cŞl_t
(
¥g_t
(
pgid
, 
i
.
fœ¡
)),

75 
ghobjeù_t
(
oid
, ghobjeù_t::
NO_GEN
, 
i
.
fœ¡
),

76 
sšfo
.
logiÿl_to_´ev_chunk_off£t
(

77 
off£t
),

78 
’c_bl
.
Ëngth
(),

79 
’c_bl
,

80 
æags
);

84 
boŞ
 
	gECT¿n§ùiÚ
::
	$»quœes_ov”wr™e
(

85 
ušt64_t
 
´ev_size
,

86 cÚ¡ 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
 &
İ
) {

88 ià(
İ
.
Œunÿ‹
 && op.Œunÿ‹->
fœ¡
 == 0)

89  
çl£
;

90  
İ
.
	`is_nÚe
() &&

91 ((!
İ
.
bufãr_upd©es
.
	`em±y
() &&

92 (
İ
.
bufãr_upd©es
.
	`begš
().
	`g‘_off
(è< 
´ev_size
)) ||

93 (
İ
.
Œunÿ‹
 &&

94 (
İ
.
Œunÿ‹
->
fœ¡
 < 
´ev_size
)));

95 
	}
}

97 
	gECT¿n§ùiÚ
::
g’”©e_Œª§ùiÚs
(

98 
Wr™ePÏn
 &
¶ª
,

99 
E¿su»CodeIÁ”çûRef
 &
ecim¶
,

100 
pg_t
 
pgid
,

101 cÚ¡ 
ECUt
::
¡re_šfo_t
 &
sšfo
,

102 cÚ¡ 
m­
<
hobjeù_t
,
ex‹Á_m­
> &
·¹Ÿl_ex‹Ás
,

103 
veùÜ
<
pg_log_’Œy_t
> &
’Œ›s
,

104 
m­
<
hobjeù_t
,
ex‹Á_m­
> *
wr™‹n_m­
,

105 
m­
<
sh¬d_id_t
, 
ObjeùStÜe
::
T¿n§ùiÚ
> *
Œª§ùiÚs
,

106 
£t
<
hobjeù_t
> *
‹mp_added
,

107 
£t
<
hobjeù_t
> *
‹mp_»moved
,

108 
DoutP»fixProvid”
 *
dµ
)

110 
as£¹
(
wr™‹n_m­
);

111 
as£¹
(
Œª§ùiÚs
);

112 
as£¹
(
‹mp_added
);

113 
as£¹
(
‹mp_»moved
);

114 
as£¹
(
¶ª
.
t
);

115 autØ&
	gt
 = *(
¶ª
.
t
);

117 autØ&
	ghash_šfos
 = 
¶ª
.
hash_šfos
;

119 
	gm­
<
	ghobjeù_t
, 
	gpg_log_’Œy_t
*> 
	gobj_to_log
;

120 autØ&&
	gi
: 
’Œ›s
) {

121 
obj_to_log
.
š£¹
(
make_·œ
(
i
.
soid
, &i));

124 
	gt
.
§ã_ü—‹_Œav”£
(

125 [&](
·œ
<cÚ¡ 
hobjeù_t
, 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
> &
İaœ
) {

126 cÚ¡ 
hobjeù_t
 &
oid
 = 
İaœ
.
fœ¡
;

127 autØ&
İ
 = 
İaœ
.
£cÚd
;

128 autØ&
obc_m­
 = 
t
.obc_map;

129 autØ&
wr™‹n
 = (*
wr™‹n_m­
)[
oid
];

131 autØ
™”
 = 
obj_to_log
.
fšd
(
oid
);

132 
pg_log_’Œy_t
 *
’Œy
 = 
™”
 !ğ
obj_to_log
.
’d
(è? i‹r->
£cÚd
 : 
nuÎ±r
;

134 
ObjeùCÚ‹xtRef
 
obc
;

135 autØ
ob™”
 = 
t
.
obc_m­
.
fšd
(
oid
);

136 ià(
ob™”
 !ğ
t
.
obc_m­
.
’d
()) {

137 
obc
 = 
ob™”
->
£cÚd
;

139 ià(
’Œy
) {

140 
as£¹
(
obc
);

142 
as£¹
(
oid
.
is_‹mp
());

145 
ECUt
::
HashInfoRef
 
hšfo
;

147 autØ
™”
 = 
hash_šfos
.
fšd
(
oid
);

148 
as£¹
(
™”
 !ğ
hash_šfos
.
’d
());

149 
hšfo
 = 
™”
->
£cÚd
;

152 ià(
oid
.
is_‹mp
()) {

153 ià(
İ
.
is_äesh_objeù
()) {

154 
‹mp_added
->
š£¹
(
oid
);

155 } ià(
İ
.
is_d–‘e
()) {

156 
‹mp_»moved
->
š£¹
(
oid
);

160 ià(
’Œy
 &&

161 
’Œy
->
is_modify
() &&

162 
İ
.
upd©ed_¢­s
) {

163 
bufã¾i¡
 
bl
(
İ
.
upd©ed_¢­s
->
£cÚd
.
size
() * 8 + 8);

164 
’code
(
İ
.
upd©ed_¢­s
->
£cÚd
, 
bl
);

165 
’Œy
->
¢­s
.
sw­
(
bl
);

166 
’Œy
->
¢­s
.
»assign_to_mempoŞ
(
mempoŞ
::
mempoŞ_osd_pglog
);

169 
ldµ_dout
(
dµ
, 20) << "generate_transactions: "

170 << 
İaœ
.
fœ¡


172 << 
hšfo
->
g‘_tÙ®_logiÿl_size
(
sšfo
)

174 << 
İ
.
bufãr_upd©es


175 << 
d’dl
;

176 ià(
İ
.
Œunÿ‹
) {

177 
ldµ_dout
(
dµ
, 20) << "generate_transactions: "

179 << *(
İ
.
Œunÿ‹
)

180 << 
d’dl
;

183 ià(
’Œy
 && 
İ
.
upd©ed_¢­s
) {

184 
’Œy
->
mod_desc
.
upd©e_¢­s
(
İ
.
upd©ed_¢­s
->
fœ¡
);

187 
m­
<
¡ršg
, 
boo¡
::
İtiÚ®
<
bufã¾i¡
> > 
x©Œ_rŞlback
;

188 
as£¹
(
hšfo
);

189 
bufã¾i¡
 
Şd_hšfo
;

190 
’code
(*
hšfo
, 
Şd_hšfo
);

191 
x©Œ_rŞlback
[
ECUt
::
g‘_hšfo_key
()] = 
Şd_hšfo
;

193 ià(
İ
.
is_nÚe
(è&& op.
Œunÿ‹
 && op.Œunÿ‹->
fœ¡
 == 0) {

194 
as£¹
(
İ
.
Œunÿ‹
->
fœ¡
 == 0);

195 
as£¹
(
İ
.
Œunÿ‹
->
fœ¡
 ==

196 
İ
.
Œunÿ‹
->
£cÚd
);

197 
as£¹
(
’Œy
);

198 
as£¹
(
obc
);

200 ià(
İ
.
Œunÿ‹
->
fœ¡
 !ğİ.Œunÿ‹->
£cÚd
) {

201 
İ
.
Œunÿ‹
->
fœ¡
 = op.Œunÿ‹->
£cÚd
;

203 
İ
.
Œunÿ‹
 = 
boo¡
::
nÚe
;

206 
İ
.
d–‘e_fœ¡
 = 
Œue
;

207 
İ
.
š™_ty³
 = 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
::
In™
::
C»©e
();

209 ià(
obc
) {

214 
İ
.
©Œ_upd©es
.
š£¹
(

215 
obc
->
©Œ_ÿche
.
begš
(),

216 
obc
->
©Œ_ÿche
.
’d
());

220 ià(
İ
.
d–‘e_fœ¡
) {

223 autØ
j
 = 
İ
.
©Œ_upd©es
.
begš
();

224 
j
 !ğ
İ
.
©Œ_upd©es
.
’d
();

226 ià(
j
->
£cÚd
) {

227 ++
j
;

229 
İ
.
©Œ_upd©es
.
”a£
(
j
++);

233 ià(
obc
) {

234 
x©Œ_rŞlback
.
š£¹
(

235 
obc
->
©Œ_ÿche
.
begš
(),

236 
obc
->
©Œ_ÿche
.
’d
());

237 
obc
->
©Œ_ÿche
.
ş—r
();

239 ià(
’Œy
) {

240 
’Œy
->
mod_desc
.
rmobjeù
ÓÁry->
v”siÚ
.version);

241 autØ&&
¡
: *
Œª§ùiÚs
) {

242 
¡
.
£cÚd
.
cŞËùiÚ_move_»Çme
(

243 
cŞl_t
(
¥g_t
(
pgid
, 
¡
.
fœ¡
)),

244 
ghobjeù_t
(
oid
, ghobjeù_t::
NO_GEN
, 
¡
.
fœ¡
),

245 
cŞl_t
(
¥g_t
(
pgid
, 
¡
.
fœ¡
)),

246 
ghobjeù_t
(
oid
, 
’Œy
->
v”siÚ
.v”siÚ, 
¡
.
fœ¡
));

249 autØ&&
¡
: *
Œª§ùiÚs
) {

250 
¡
.
£cÚd
.
»move
(

251 
cŞl_t
(
¥g_t
(
pgid
, 
¡
.
fœ¡
)),

252 
ghobjeù_t
(
oid
, ghobjeù_t::
NO_GEN
, 
¡
.
fœ¡
));

255 
hšfo
->
ş—r
();

258 ià(
İ
.
is_äesh_objeù
(è&& 
’Œy
) {

259 
’Œy
->
mod_desc
.
ü—‹
();

262 
m©ch
(

263 
İ
.
š™_ty³
,

264 [&](cÚ¡ 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
::
In™
::
NÚe
 &) {},

265 [&](cÚ¡ 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
::
In™
::
C»©e
 &
İ
) {

266 autØ&&
¡
: *
Œª§ùiÚs
) {

267 
¡
.
£cÚd
.
touch
(

268 
cŞl_t
(
¥g_t
(
pgid
, 
¡
.
fœ¡
)),

269 
ghobjeù_t
(
oid
, ghobjeù_t::
NO_GEN
, 
¡
.
fœ¡
));

272 [&](cÚ¡ 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
::
In™
::
ClÚe
 &
İ
) {

273 autØ&&
¡
: *
Œª§ùiÚs
) {

274 
¡
.
£cÚd
.
şÚe
(

275 
cŞl_t
(
¥g_t
(
pgid
, 
¡
.
fœ¡
)),

276 
ghobjeù_t
(
İ
.
sourû
, ghobjeù_t::
NO_GEN
, 
¡
.
fœ¡
),

277 
ghobjeù_t
(
oid
, ghobjeù_t::
NO_GEN
, 
¡
.
fœ¡
));

280 autØ
s™”
 = 
hash_šfos
.
fšd
(
İ
.
sourû
);

281 
as£¹
(
s™”
 !ğ
hash_šfos
.
’d
());

282 
hšfo
->
upd©e_to
(*(
s™”
->
£cÚd
));

284 ià(
obc
) {

285 autØ
cobc™”
 = 
obc_m­
.
fšd
(
İ
.
sourû
);

286 
as£¹
(
cobc™”
 !ğ
obc_m­
.
’d
());

287 
obc
->
©Œ_ÿche
 = 
cobc™”
->
£cÚd
->attr_cache;

290 [&](cÚ¡ 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
::
In™
::
R’ame
 &
İ
) {

291 
as£¹
(
İ
.
sourû
.
is_‹mp
());

292 autØ&&
¡
: *
Œª§ùiÚs
) {

293 
¡
.
£cÚd
.
cŞËùiÚ_move_»Çme
(

294 
cŞl_t
(
¥g_t
(
pgid
, 
¡
.
fœ¡
)),

295 
ghobjeù_t
(
İ
.
sourû
, ghobjeù_t::
NO_GEN
, 
¡
.
fœ¡
),

296 
cŞl_t
(
¥g_t
(
pgid
, 
¡
.
fœ¡
)),

297 
ghobjeù_t
(
oid
, ghobjeù_t::
NO_GEN
, 
¡
.
fœ¡
));

299 autØ
s™”
 = 
hash_šfos
.
fšd
(
İ
.
sourû
);

300 
as£¹
(
s™”
 !ğ
hash_šfos
.
’d
());

301 
hšfo
->
upd©e_to
(*(
s™”
->
£cÚd
));

302 ià(
obc
) {

303 autØ
cobc™”
 = 
obc_m­
.
fšd
(
İ
.
sourû
);

304 
as£¹
(
cobc™”
 =ğ
obc_m­
.
’d
());

305 
obc
->
©Œ_ÿche
.
ş—r
();

310 
as£¹
(!(
İ
.
ş—r_om­
));

311 
as£¹
(!(
İ
.
om­_h—d”
));

312 
as£¹
(
İ
.
om­_upd©es
.
em±y
());

314 ià(!
İ
.
©Œ_upd©es
.
em±y
()) {

315 
m­
<
¡ršg
, 
bufã¾i¡
> 
to_£t
;

316 autØ&&
j
: 
İ
.
©Œ_upd©es
) {

317 ià(
j
.
£cÚd
) {

318 
to_£t
[
j
.
fœ¡
] = *(j.
£cÚd
);

320 autØ&&
¡
 : *
Œª§ùiÚs
) {

321 
¡
.
£cÚd
.
rm©Œ
(

322 
cŞl_t
(
¥g_t
(
pgid
, 
¡
.
fœ¡
)),

323 
ghobjeù_t
(
oid
, ghobjeù_t::
NO_GEN
, 
¡
.
fœ¡
),

324 
j
.
fœ¡
);

327 ià(
obc
) {

328 autØ
c™”
 = 
obc
->
©Œ_ÿche
.
fšd
(
j
.
fœ¡
);

329 ià(
’Œy
) {

330 ià(
c™”
 !ğ
obc
->
©Œ_ÿche
.
’d
()) {

332 
x©Œ_rŞlback
.
š£¹
(

333 
make_·œ
(

334 
j
.
fœ¡
,

335 
boo¡
::
İtiÚ®
<
bufã¾i¡
>(
c™”
->
£cÚd
)));

338 
x©Œ_rŞlback
.
š£¹
(

339 
make_·œ
(

340 
j
.
fœ¡
,

341 
boo¡
::
nÚe
));

344 ià(
j
.
£cÚd
) {

345 
obc
->
©Œ_ÿche
[
j
.
fœ¡
] = *(j.
£cÚd
);

346 } ià(
c™”
 !ğ
obc
->
©Œ_ÿche
.
’d
()) {

347 
obc
->
©Œ_ÿche
.
”a£
(
c™”
);

350 
as£¹
(!
’Œy
);

353 autØ&&
¡
 : *
Œª§ùiÚs
) {

354 
¡
.
£cÚd
.
£‰rs
(

355 
cŞl_t
(
¥g_t
(
pgid
, 
¡
.
fœ¡
)),

356 
ghobjeù_t
(
oid
, ghobjeù_t::
NO_GEN
, 
¡
.
fœ¡
),

357 
to_£t
);

359 
as£¹
(!
x©Œ_rŞlback
.
em±y
());

361 ià(
’Œy
 && !
x©Œ_rŞlback
.
em±y
()) {

362 
’Œy
->
mod_desc
.
£‰rs
(
x©Œ_rŞlback
);

365 ià(
İ
.
®loc_hšt
) {

372 
ušt64_t
 
objeù_size
 = 
sšfo
.
logiÿl_to_Ãxt_chunk_off£t
(

373 
İ
.
®loc_hšt
->
ex³ùed_objeù_size
);

374 
ušt64_t
 
wr™e_size
 = 
sšfo
.
logiÿl_to_Ãxt_chunk_off£t
(

375 
İ
.
®loc_hšt
->
ex³ùed_wr™e_size
);

377 autØ&&
¡
 : *
Œª§ùiÚs
) {

378 
¡
.
£cÚd
.
£t_®loc_hšt
(

379 
cŞl_t
(
¥g_t
(
pgid
, 
¡
.
fœ¡
)),

380 
ghobjeù_t
(
oid
, ghobjeù_t::
NO_GEN
, 
¡
.
fœ¡
),

381 
objeù_size
,

382 
wr™e_size
,

383 
İ
.
®loc_hšt
->
æags
);

387 
ex‹Á_m­
 
to_wr™e
;

388 autØ
³xt™”
 = 
·¹Ÿl_ex‹Ás
.
fšd
(
oid
);

389 ià(
³xt™”
 !ğ
·¹Ÿl_ex‹Ás
.
’d
()) {

390 
to_wr™e
 = 
³xt™”
->
£cÚd
;

393 
veùÜ
<
·œ
<
ušt64_t
, ušt64_t> > 
rŞlback_ex‹Ás
;

394 cÚ¡ 
ušt64_t
 
Üig_size
 = 
hšfo
->
g‘_tÙ®_logiÿl_size
(
sšfo
);

396 
ušt64_t
 
Ãw_size
 = 
Üig_size
;

397 
ušt64_t
 
­³nd_aá”
 = 
Ãw_size
;

398 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ":‚ew_siz¡¬ˆ" << 
Ãw_size
 << 
d’dl
;

399 ià(
İ
.
Œunÿ‹
 && op.Œunÿ‹->
fœ¡
 < 
Ãw_size
) {

400 
as£¹
(!
İ
.
is_äesh_objeù
());

401 
Ãw_size
 = 
sšfo
.
logiÿl_to_Ãxt_¡re_off£t
(

402 
İ
.
Œunÿ‹
->
fœ¡
);

403 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ":‚ew_sizeruncate down "

404 << 
Ãw_size
 << 
d’dl
;

405 ià(
Ãw_size
 !ğ
İ
.
Œunÿ‹
->
fœ¡
) {

406 
bufã¾i¡
 
bl
;

407 
bl
.
­³nd_z”o
(
Ãw_size
 - 
İ
.
Œunÿ‹
->
fœ¡
);

408 
to_wr™e
.
š£¹
(

409 
İ
.
Œunÿ‹
->
fœ¡
,

410 
bl
.
Ëngth
(),

411 
bl
);

412 
­³nd_aá”
 = 
sšfo
.
logiÿl_to_´ev_¡re_off£t
(

413 
İ
.
Œunÿ‹
->
fœ¡
);

415 
­³nd_aá”
 = 
Ãw_size
;

417 
to_wr™e
.
”a£
(

418 
Ãw_size
,

419 
¡d
::
num”ic_lim™s
<
ušt64_t
>::
max
(è- 
Ãw_size
);

421 ià(
’Œy
 && !
İ
.
is_äesh_objeù
()) {

422 
ušt64_t
 
»¡Üe_äom
 = 
sšfo
.
logiÿl_to_´ev_chunk_off£t
(

423 
İ
.
Œunÿ‹
->
fœ¡
);

424 
ušt64_t
 
»¡Üe_Ën
 = 
sšfo
.
®igÃd_logiÿl_off£t_to_chunk_off£t
(

425 
Üig_size
 -

426 
sšfo
.
logiÿl_to_´ev_¡re_off£t
(
İ
.
Œunÿ‹
->
fœ¡
));

427 
as£¹
(
rŞlback_ex‹Ás
.
em±y
());

429 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ": savingƒxtent "

430 << 
make_·œ
(
»¡Üe_äom
, 
»¡Üe_Ën
)

431 << 
d’dl
;

432 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ":runcatingo "

433 << 
Ãw_size


434 << 
d’dl
;

435 
rŞlback_ex‹Ás
.
em¶aû_back
(

436 
make_·œ
(
»¡Üe_äom
, 
»¡Üe_Ën
));

437 autØ&&
¡
 : *
Œª§ùiÚs
) {

438 
¡
.
£cÚd
.
touch
(

439 
cŞl_t
(
¥g_t
(
pgid
, 
¡
.
fœ¡
)),

440 
ghobjeù_t
(
oid
, 
’Œy
->
v”siÚ
.v”siÚ, 
¡
.
fœ¡
));

441 
¡
.
£cÚd
.
şÚe_¿nge
(

442 
cŞl_t
(
¥g_t
(
pgid
, 
¡
.
fœ¡
)),

443 
ghobjeù_t
(
oid
, ghobjeù_t::
NO_GEN
, 
¡
.
fœ¡
),

444 
ghobjeù_t
(
oid
, 
’Œy
->
v”siÚ
.v”siÚ, 
¡
.
fœ¡
),

445 
»¡Üe_äom
,

446 
»¡Üe_Ën
,

447 
»¡Üe_äom
);

451 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ":‚ot savingƒxtents, fresh object"

452 << 
d’dl
;

454 autØ&&
¡
 : *
Œª§ùiÚs
) {

455 
¡
.
£cÚd
.
Œunÿ‹
(

456 
cŞl_t
(
¥g_t
(
pgid
, 
¡
.
fœ¡
)),

457 
ghobjeù_t
(
oid
, ghobjeù_t::
NO_GEN
, 
¡
.
fœ¡
),

458 
sšfo
.
®igÃd_logiÿl_off£t_to_chunk_off£t
(
Ãw_size
));

462 
ušt32_t
 
çdvi£_æags
 = 0;

463 autØ&&
ex‹Á
: 
İ
.
bufãr_upd©es
) {

464 
usšg
 
BufãrUpd©e
 = 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
::BufferUpdate;

465 
bufã¾i¡
 
bl
;

466 
m©ch
(

467 
ex‹Á
.
g‘_v®
(),

468 [&](cÚ¡ 
BufãrUpd©e
::
Wr™e
 &
İ
) {

469 
bl
 = 
İ
.
bufãr
;

470 
çdvi£_æags
 |ğ
İ
.fadvise_flags;

472 [&](cÚ¡ 
BufãrUpd©e
::
Z”o
 &) {

473 
bl
.
­³nd_z”o
(
ex‹Á
.
g‘_Ën
());

475 [&](cÚ¡ 
BufãrUpd©e
::
ClÚeRªge
 &) {

476 
as£¹
(

481 
ušt64_t
 
off
 = 
ex‹Á
.
g‘_off
();

482 
ušt64_t
 
Ën
 = 
ex‹Á
.
g‘_Ën
();

483 
ušt64_t
 
’d
 = 
off
 + 
Ën
;

484 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ":‡dding buffer_update "

485 << 
make_·œ
(
off
, 
Ën
)

486 << 
d’dl
;

487 
as£¹
(
Ën
 > 0);

488 ià(
off
 > 
Ãw_size
) {

489 
as£¹
(
off
 > 
­³nd_aá”
);

490 
bl
.
´•’d_z”o
(
off
 - 
Ãw_size
);

491 
Ën
 +ğ
off
 - 
Ãw_size
;

492 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ":…repending zeroeso‡lign "

493 << 
off
 << "->" << 
Ãw_size


494 << 
d’dl
;

495 
off
 = 
Ãw_size
;

497 ià(!
sšfo
.
logiÿl_off£t_is_¡re_®igÃd
(
’d
è&& (’d > 
­³nd_aá”
)) {

498 
ušt64_t
 
®igÃd_’d
 = 
sšfo
.
logiÿl_to_Ãxt_¡re_off£t
(

499 
’d
);

500 
ušt64_t
 

 = 
®igÃd_’d
 - 
’d
;

501 
bl
.
­³nd_z”o
(

);

502 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ":‡ppending zeroeso‡lignƒnd "

503 << 
’d
 << "->" <<ƒnd+



504 << ",†’: " << 
Ën
 << "->" <<†’+



505 << 
d’dl
;

506 
’d
 +ğ

;

507 
Ën
 +ğ

;

510 
to_wr™e
.
š£¹
(
off
, 
Ën
, 
bl
);

511 ià(
’d
 > 
Ãw_size
)

512 
Ãw_size
 = 
’d
;

515 ià(
İ
.
Œunÿ‹
 &&

516 
İ
.
Œunÿ‹
->
£cÚd
 > 
Ãw_size
) {

517 
as£¹
(
İ
.
Œunÿ‹
->
£cÚd
 > 
­³nd_aá”
);

518 
ušt64_t
 
Œunÿ‹_to
 =

519 
sšfo
.
logiÿl_to_Ãxt_¡re_off£t
(

520 
İ
.
Œunÿ‹
->
£cÚd
);

521 
ušt64_t
 
z”Ûs
 = 
Œunÿ‹_to
 - 
Ãw_size
;

522 
bufã¾i¡
 
bl
;

523 
bl
.
­³nd_z”o
(
z”Ûs
);

524 
to_wr™e
.
š£¹
(

525 
Ãw_size
,

526 
z”Ûs
,

527 
bl
);

528 
Ãw_size
 = 
Œunÿ‹_to
;

529 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ":runcating outo "

530 << 
Œunÿ‹_to


531 << 
d’dl
;

534 
£t
<> 
wªt
;

535 
i
 = 0; i < 
ecim¶
->
g‘_chunk_couÁ
(); ++i) {

536 
wªt
.
š£¹
(
i
);

538 autØ
to_ov”wr™e
 = 
to_wr™e
.
š‹r£ù
(0, 
­³nd_aá”
);

539 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ":o_overwrite: "

540 << 
to_ov”wr™e


541 << 
d’dl
;

542 autØ&&
ex‹Á
: 
to_ov”wr™e
) {

543 
as£¹
(
ex‹Á
.
g‘_off
(è+ƒx‹Á.
g‘_Ën
(è<ğ
­³nd_aá”
);

544 
as£¹
(
sšfo
.
logiÿl_off£t_is_¡re_®igÃd
(
ex‹Á
.
g‘_off
()));

545 
as£¹
(
sšfo
.
logiÿl_off£t_is_¡re_®igÃd
(
ex‹Á
.
g‘_Ën
()));

546 ià(
’Œy
) {

547 
ušt64_t
 
»¡Üe_äom
 = 
sšfo
.
®igÃd_logiÿl_off£t_to_chunk_off£t
(

548 
ex‹Á
.
g‘_off
());

549 
ušt64_t
 
»¡Üe_Ën
 = 
sšfo
.
®igÃd_logiÿl_off£t_to_chunk_off£t
(

550 
ex‹Á
.
g‘_Ën
());

551 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ": overwriting "

552 << 
»¡Üe_äom
 << "~" << 
»¡Üe_Ën


553 << 
d’dl
;

554 ià(
rŞlback_ex‹Ás
.
em±y
()) {

555 autØ&&
¡
 : *
Œª§ùiÚs
) {

556 
¡
.
£cÚd
.
touch
(

557 
cŞl_t
(
¥g_t
(
pgid
, 
¡
.
fœ¡
)),

558 
ghobjeù_t
(
oid
, 
’Œy
->
v”siÚ
.v”siÚ, 
¡
.
fœ¡
));

561 
rŞlback_ex‹Ás
.
em¶aû_back
(
make_·œ
(
»¡Üe_äom
, 
»¡Üe_Ën
));

562 autØ&&
¡
 : *
Œª§ùiÚs
) {

563 
¡
.
£cÚd
.
şÚe_¿nge
(

564 
cŞl_t
(
¥g_t
(
pgid
, 
¡
.
fœ¡
)),

565 
ghobjeù_t
(
oid
, ghobjeù_t::
NO_GEN
, 
¡
.
fœ¡
),

566 
ghobjeù_t
(
oid
, 
’Œy
->
v”siÚ
.v”siÚ, 
¡
.
fœ¡
),

567 
»¡Üe_äom
,

568 
»¡Üe_Ën
,

569 
»¡Üe_äom
);

572 
’code_ªd_wr™e
(

573 
pgid
,

574 
oid
,

575 
sšfo
,

576 
ecim¶
,

577 
wªt
,

578 
ex‹Á
.
g‘_off
(),

579 
ex‹Á
.
g‘_v®
(),

580 
çdvi£_æags
,

581 
hšfo
,

582 
wr™‹n
,

583 
Œª§ùiÚs
,

584 
dµ
);

587 autØ
to_­³nd
 = 
to_wr™e
.
š‹r£ù
(

588 
­³nd_aá”
,

589 
¡d
::
num”ic_lim™s
<
ušt64_t
>::
max
(è- 
­³nd_aá”
);

590 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ":o_append: "

591 << 
to_­³nd


592 << 
d’dl
;

593 autØ&&
ex‹Á
: 
to_­³nd
) {

594 
as£¹
(
sšfo
.
logiÿl_off£t_is_¡re_®igÃd
(
ex‹Á
.
g‘_off
()));

595 
as£¹
(
sšfo
.
logiÿl_off£t_is_¡re_®igÃd
(
ex‹Á
.
g‘_Ën
()));

596 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ":‡ppending "

597 << 
ex‹Á
.
g‘_off
(è<< "~" <<ƒx‹Á.
g‘_Ën
()

598 << 
d’dl
;

599 
’code_ªd_wr™e
(

600 
pgid
,

601 
oid
,

602 
sšfo
,

603 
ecim¶
,

604 
wªt
,

605 
ex‹Á
.
g‘_off
(),

606 
ex‹Á
.
g‘_v®
(),

607 
çdvi£_æags
,

608 
hšfo
,

609 
wr™‹n
,

610 
Œª§ùiÚs
,

611 
dµ
);

614 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ": " << 
oid


616 << 
Ãw_size


617 << 
d’dl
;

618 ià(!
rŞlback_ex‹Ás
.
em±y
(è&& 
’Œy
) {

619 ià(
’Œy
) {

620 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ": " << 
oid


622 << 
rŞlback_ex‹Ás


623 << 
d’dl
;

624 
’Œy
->
mod_desc
.
rŞlback_ex‹Ás
(

625 
’Œy
->
v”siÚ
.v”siÚ, 
rŞlback_ex‹Ás
);

627 
hšfo
->
£t_tÙ®_chunk_size_ş—r_hash
(

628 
sšfo
.
®igÃd_logiÿl_off£t_to_chunk_off£t
(
Ãw_size
));

630 
as£¹
(
hšfo
->
g‘_tÙ®_logiÿl_size
(
sšfo
è=ğ
Ãw_size
);

633 ià(
’Œy
 && !
to_­³nd
.
em±y
()) {

634 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ": marking‡ppend "

635 << 
­³nd_aá”


636 << 
d’dl
;

637 
’Œy
->
mod_desc
.
­³nd
(
­³nd_aá”
);

640 ià(!
İ
.
is_d–‘e
()) {

641 
bufã¾i¡
 
hbuf
;

642 
’code
(*
hšfo
, 
hbuf
);

643 autØ&&
i
 : *
Œª§ùiÚs
) {

644 
i
.
£cÚd
.
£‰r
(

645 
cŞl_t
(
¥g_t
(
pgid
, 
i
.
fœ¡
)),

646 
ghobjeù_t
(
oid
, ghobjeù_t::
NO_GEN
, 
i
.
fœ¡
),

647 
ECUt
::
g‘_hšfo_key
(),

648 
hbuf
);

	@osd/ECTransaction.h

15 #iâdeà
ECTRANSACTION_H


16 
	#ECTRANSACTION_H


	)

18 
	~"OSD.h
"

19 
	~"PGBack’d.h
"

20 
	~"ECUt.h
"

21 
	~"”asu»-code/E¿su»CodeIÁ”çû.h
"

22 
	~"PGT¿n§ùiÚ.h
"

23 
	~"Ex‹ÁCache.h
"

25 
Çme¥aû
 
	gECT¿n§ùiÚ
 {

26 
	sWr™ePÏn
 {

27 
PGT¿n§ùiÚUPŒ
 
	gt
;

28 
boŞ
 
	gšv®id©es_ÿche
 = 
çl£
;

29 
	gm­
<
	ghobjeù_t
,
	gex‹Á_£t
> 
	gto_»ad
;

30 
	gm­
<
	ghobjeù_t
,
	gex‹Á_£t
> 
	gwl_wr™e
;

32 
	gm­
<
	ghobjeù_t
,
	gECUt
::
HashInfoRef
> 
hash_šfos
;

35 
boŞ
 
»quœes_ov”wr™e
(

36 
ušt64_t
 
´ev_size
,

37 cÚ¡ 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
 &
İ
);

39 
	g‹m¶©e
 <
ty³Çme
 
	gF
>

40 
Wr™ePÏn
 
g‘_wr™e_¶ª
(

41 cÚ¡ 
ECUt
::
¡re_šfo_t
 &
sšfo
,

42 
PGT¿n§ùiÚUPŒ
 &&
t
,

43 
F
 &&
g‘_hšfo
,

44 
DoutP»fixProvid”
 *
dµ
) {

45 
Wr™ePÏn
 
	g¶ª
;

46 
	gt
->
§ã_ü—‹_Œav”£
(

47 [&](
·œ
<cÚ¡ 
hobjeù_t
, 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
> &
i
) {

48 
ECUt
::
HashInfoRef
 
hšfo
 = 
g‘_hšfo
(
i
.
fœ¡
);

49 
¶ª
.
hash_šfos
[
i
.
fœ¡
] = 
hšfo
;

51 
ušt64_t
 
´ojeùed_size
 =

52 
hšfo
->
g‘_´ojeùed_tÙ®_logiÿl_size
(
sšfo
);

54 ià(
i
.
£cÚd
.
d–‘es_fœ¡
()) {

55 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ": delete, setting…rojected size"

56 << "Ø0" << 
d’dl
;

57 
´ojeùed_size
 = 0;

60 
hobjeù_t
 
sourû
;

61 ià(
i
.
£cÚd
.
has_sourû
(&
sourû
)) {

62 
¶ª
.
šv®id©es_ÿche
 = 
Œue
;

64 
ECUt
::
HashInfoRef
 
shšfo
 = 
g‘_hšfo
(
sourû
);

65 
´ojeùed_size
 = 
shšfo
->
g‘_´ojeùed_tÙ®_logiÿl_size
(
sšfo
);

66 
¶ª
.
hash_šfos
[
sourû
] = 
shšfo
;

69 autØ&
wl_wr™e
 = 
¶ª
.wl_wr™e[
i
.
fœ¡
];

70 ià(
i
.
£cÚd
.
Œunÿ‹
 &&

71 
i
.
£cÚd
.
Œunÿ‹
->
fœ¡
 < 
´ojeùed_size
) {

72 ià(!(
sšfo
.
logiÿl_off£t_is_¡re_®igÃd
(

73 
i
.
£cÚd
.
Œunÿ‹
->
fœ¡
))) {

74 
¶ª
.
to_»ad
[
i
.
fœ¡
].
uniÚ_š£¹
(

75 
sšfo
.
logiÿl_to_´ev_¡re_off£t
(
i
.
£cÚd
.
Œunÿ‹
->
fœ¡
),

76 
sšfo
.
g‘_¡re_width
());

78 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ": uÇligÃdrunÿ‹" << 
d’dl
;

80 
wl_wr™e
.
uniÚ_š£¹
(

81 
sšfo
.
logiÿl_to_´ev_¡re_off£t
(
i
.
£cÚd
.
Œunÿ‹
->
fœ¡
),

82 
sšfo
.
g‘_¡re_width
());

84 
´ojeùed_size
 = 
sšfo
.
logiÿl_to_Ãxt_¡re_off£t
(

85 
i
.
£cÚd
.
Œunÿ‹
->
fœ¡
);

88 
ex‹Á_£t
 
¿w_wr™e_£t
;

89 autØ&&
ex‹Á
: 
i
.
£cÚd
.
bufãr_upd©es
) {

90 
usšg
 
BufãrUpd©e
 = 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
::BufferUpdate;

91 ià(
boo¡
::
g‘
<
BufãrUpd©e
::
ClÚeRªge
>(&(
ex‹Á
.
g‘_v®
()))) {

92 
as£¹
(

96 
¿w_wr™e_£t
.
š£¹
(
ex‹Á
.
g‘_off
(),ƒx‹Á.
g‘_Ën
());

99 autØ
Üig_size
 = 
´ojeùed_size
;

100 autØ
ex‹Á
 = 
¿w_wr™e_£t
.
begš
();

101 
ex‹Á
 !ğ
¿w_wr™e_£t
.
’d
();

102 ++
ex‹Á
) {

103 
ušt64_t
 
h—d_¡¬t
 =

104 
sšfo
.
logiÿl_to_´ev_¡re_off£t
(
ex‹Á
.
g‘_¡¬t
());

105 
ušt64_t
 
h—d_fšish
 =

106 
sšfo
.
logiÿl_to_Ãxt_¡re_off£t
(
ex‹Á
.
g‘_¡¬t
());

107 ià(
h—d_¡¬t
 > 
´ojeùed_size
) {

108 
h—d_¡¬t
 = 
´ojeùed_size
;

110 ià(
h—d_¡¬t
 !ğ
h—d_fšish
 &&

111 
h—d_¡¬t
 < 
Üig_size
) {

112 
as£¹
(
h—d_fšish
 <ğ
Üig_size
);

113 
as£¹
(
h—d_fšish
 - 
h—d_¡¬t
 =ğ
sšfo
.
g‘_¡re_width
());

114 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ":„eading…artial head stripe "

115 << 
h—d_¡¬t
 << "~" << 
sšfo
.
g‘_¡re_width
()

116 << 
d’dl
;

117 
¶ª
.
to_»ad
[
i
.
fœ¡
].
uniÚ_š£¹
(

118 
h—d_¡¬t
, 
sšfo
.
g‘_¡re_width
());

121 
ušt64_t
 
_¡¬t
 =

122 
sšfo
.
logiÿl_to_´ev_¡re_off£t
(

123 
ex‹Á
.
g‘_¡¬t
(è+ƒx‹Á.
g‘_Ën
());

124 
ušt64_t
 
_fšish
 =

125 
sšfo
.
logiÿl_to_Ãxt_¡re_off£t
(

126 
ex‹Á
.
g‘_¡¬t
(è+ƒx‹Á.
g‘_Ën
());

127 ià(
_¡¬t
 !ğ
_fšish
 &&

128 (
h—d_¡¬t
 =ğ
h—d_fšish
 || 
_¡¬t
 != head_start) &&

129 
_¡¬t
 < 
Üig_size
) {

130 
as£¹
(
_fšish
 <ğ
Üig_size
);

131 
as£¹
(
_fšish
 - 
_¡¬t
 =ğ
sšfo
.
g‘_¡re_width
());

132 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ":„eading…artialail stripe "

133 << 
_¡¬t
 << "~" << 
sšfo
.
g‘_¡re_width
()

134 << 
d’dl
;

135 
¶ª
.
to_»ad
[
i
.
fœ¡
].
uniÚ_š£¹
(

136 
_¡¬t
, 
sšfo
.
g‘_¡re_width
());

139 ià(
h—d_¡¬t
 !ğ
_fšish
) {

140 
as£¹
(

141 
sšfo
.
logiÿl_off£t_is_¡re_®igÃd
(

142 
_fšish
 - 
h—d_¡¬t
)

144 
wl_wr™e
.
uniÚ_š£¹
(

145 
h—d_¡¬t
, 
_fšish
 - head_start);

146 ià(
_fšish
 > 
´ojeùed_size
)

147 
´ojeùed_size
 = 
_fšish
;

149 
as£¹
(
_fšish
 <ğ
´ojeùed_size
);

153 ià(
i
.
£cÚd
.
Œunÿ‹
 &&

154 
i
.
£cÚd
.
Œunÿ‹
->£cÚd > 
´ojeùed_size
) {

155 
ušt64_t
 
Œunÿtšg_to
 =

156 
sšfo
.
logiÿl_to_Ãxt_¡re_off£t
(
i
.
£cÚd
.
Œunÿ‹
->second);

157 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ":runcating outo "

158 << 
Œunÿtšg_to


159 << 
d’dl
;

160 
wl_wr™e
.
uniÚ_š£¹
(
´ojeùed_size
,

161 
Œunÿtšg_to
 - 
´ojeùed_size
);

162 
´ojeùed_size
 = 
Œunÿtšg_to
;

165 
ldµ_dout
(
dµ
, 20è<< 
__func__
 << ": " << 
i
.
fœ¡


167 << 
´ojeùed_size


168 << 
d’dl
;

169 
hšfo
->
£t_´ojeùed_tÙ®_logiÿl_size
(

170 
sšfo
,

171 
´ojeùed_size
);

177 
as£¹
(
¶ª
.
to_»ad
.
couÁ
(
i
.
fœ¡
) == 0 ||

178 (!
¶ª
.
to_»ad
.
©
(
i
.
fœ¡
).
em±y
() &&

179 !
i
.
£cÚd
.
has_sourû
()));

181 
	g¶ª
.
	gt
 = 
¡d
::
move
(
t
);

182  
	g¶ª
;

185 
g’”©e_Œª§ùiÚs
(

186 
Wr™ePÏn
 &
¶ª
,

187 
E¿su»CodeIÁ”çûRef
 &
ecim¶
,

188 
pg_t
 
pgid
,

189 cÚ¡ 
ECUt
::
¡re_šfo_t
 &
sšfo
,

190 cÚ¡ 
m­
<
hobjeù_t
,
ex‹Á_m­
> &
·¹Ÿl_ex‹Ás
,

191 
veùÜ
<
pg_log_’Œy_t
> &
’Œ›s
,

192 
m­
<
hobjeù_t
,
ex‹Á_m­
> *
wr™‹n
,

193 
m­
<
sh¬d_id_t
, 
ObjeùStÜe
::
T¿n§ùiÚ
> *
Œª§ùiÚs
,

194 
£t
<
hobjeù_t
> *
‹mp_added
,

195 
£t
<
hobjeù_t
> *
‹mp_»moved
,

196 
DoutP»fixProvid”
 *
dµ
);

	@osd/ECUtil.cc

3 
	~<”ºo.h
>

4 
	~"šşude/’codšg.h
"

5 
	~"ECUt.h
"

7 
usšg
 
Çme¥aû
 
	g¡d
;

9 
	gECUt
::
decode
(

10 cÚ¡ 
¡re_šfo_t
 &
sšfo
,

11 
E¿su»CodeIÁ”çûRef
 &
ec_im¶
,

12 
m­
<, 
bufã¾i¡
> &
to_decode
,

13 
bufã¾i¡
 *
out
) {

14 
as£¹
(
to_decode
.
size
());

16 
ušt64_t
 
	gtÙ®_d©a_size
 = 
to_decode
.
begš
()->
£cÚd
.
Ëngth
();

17 
as£¹
(
tÙ®_d©a_size
 % 
sšfo
.
g‘_chunk_size
() == 0);

19 
as£¹
(
out
);

20 
as£¹
(
out
->
Ëngth
() == 0);

22 
	gm­
<, 
	gbufã¾i¡
>::
™”©Ü
 
i
 = 
to_decode
.
begš
();

23 
	gi
 !ğ
to_decode
.
’d
();

24 ++
	gi
) {

25 
as£¹
(
i
->
£cÚd
.
Ëngth
(è=ğ
tÙ®_d©a_size
);

28 ià(
	gtÙ®_d©a_size
 == 0)

31 
ušt64_t
 
	gi
 = 0; i < 
	gtÙ®_d©a_size
; i +ğ
sšfo
.
g‘_chunk_size
()) {

32 
m­
<, 
bufã¾i¡
> 
chunks
;

33 
	gm­
<, 
	gbufã¾i¡
>::
™”©Ü
 
j
 = 
to_decode
.
begš
();

34 
	gj
 !ğ
to_decode
.
’d
();

35 ++
	gj
) {

36 
	gchunks
[
j
->
fœ¡
].
sub¡r_of
(j->
£cÚd
, 
i
, 
sšfo
.
g‘_chunk_size
());

38 
bufã¾i¡
 
	gbl
;

39 
	gr
 = 
ec_im¶
->
decode_cÚÿt
(
chunks
, &
bl
);

40 
as£¹
(
r
 == 0);

41 
as£¹
(
bl
.
Ëngth
(è=ğ
sšfo
.
g‘_¡re_width
());

42 
	gout
->
şaim_­³nd
(
bl
);

47 
	gECUt
::
decode
(

48 cÚ¡ 
¡re_šfo_t
 &
sšfo
,

49 
E¿su»CodeIÁ”çûRef
 &
ec_im¶
,

50 
m­
<, 
bufã¾i¡
> &
to_decode
,

51 
m­
<, 
bufã¾i¡
*> &
out
) {

53 
as£¹
(
to_decode
.
size
());

55 autØ&&
	gi
 : 
to_decode
) {

56 if(
i
.
£cÚd
.
Ëngth
() == 0)

60 
	g£t
<> 
	gÃed
;

61 
	gm­
<, 
	gbufã¾i¡
*>::
™”©Ü
 
i
 = 
out
.
begš
();

62 
	gi
 !ğ
out
.
’d
();

63 ++
	gi
) {

64 
as£¹
(
i
->
£cÚd
);

65 
as£¹
(
i
->
£cÚd
->
Ëngth
() == 0);

66 
	gÃed
.
š£¹
(
i
->
fœ¡
);

69 
	g£t
<> 
	gava
;

70 autØ&&
	gi
 : 
to_decode
) {

71 
as£¹
(
i
.
£cÚd
.
Ëngth
() != 0);

72 
	gava
.
š£¹
(
i
.
fœ¡
);

75 
	gm­
<, 
	gveùÜ
<
	g·œ
<, >>> 
	gmš
;

76 
	gr
 = 
ec_im¶
->
mšimum_to_decode
(
Ãed
, 
ava
, &
mš
);

77 
as£¹
(
r
 == 0);

79 
	gchunks_couÁ
 = 0;

80 
	g»·œ_d©a_³r_chunk
 = 0;

81 
	gsubchunk_size
 = 
sšfo
.
g‘_chunk_size
()/
ec_im¶
->
g‘_sub_chunk_couÁ
();

83 autØ&&
	gi
 : 
to_decode
) {

84 autØ
found
 = 
mš
.
fšd
(
i
.
fœ¡
);

85 ià(
	gfound
 !ğ
mš
.
’d
()) {

86 
»·œ_subchunk_couÁ
 = 0;

87 auto& 
	gsubchunks
 : 
mš
[
i
.
fœ¡
]) {

88 
»·œ_subchunk_couÁ
 +ğ
subchunks
.
£cÚd
;

90 
	g»·œ_d©a_³r_chunk
 = 
»·œ_subchunk_couÁ
 * 
subchunk_size
;

91 
	gchunks_couÁ
 = ()
i
.
£cÚd
.
Ëngth
(è/ 
»·œ_d©a_³r_chunk
;

96 
	gi
 = 0; i < 
	gchunks_couÁ
; i++) {

97 
	gm­
<, 
	gbufã¾i¡
> 
	gchunks
;

98 autØ
	gj
 = 
to_decode
.
begš
();

99 
	gj
 !ğ
to_decode
.
’d
();

100 ++
	gj
) {

101 
	gchunks
[
j
->
fœ¡
].
sub¡r_of
(j->
£cÚd
,

102 
i
*
»·œ_d©a_³r_chunk
,

103 
»·œ_d©a_³r_chunk
);

105 
	gm­
<, 
	gbufã¾i¡
> 
	gout_bls
;

106 
	gr
 = 
ec_im¶
->
decode
(
Ãed
, 
chunks
, &
out_bls
, 
sšfo
.
g‘_chunk_size
());

107 
as£¹
(
r
 == 0);

108 autØ
	gj
 = 
out
.
begš
(); j !ğout.
’d
(); ++j) {

109 
as£¹
(
out_bls
.
couÁ
(
j
->
fœ¡
));

110 
as£¹
(
out_bls
[
j
->
fœ¡
].
Ëngth
(è=ğ
sšfo
.
g‘_chunk_size
());

111 
	gj
->
	g£cÚd
->
şaim_­³nd
(
out_bls
[
j
->
fœ¡
]);

114 autØ&&
	gi
 : 
out
) {

115 
as£¹
(
i
.
£cÚd
->
Ëngth
(è=ğ
chunks_couÁ
 * 
sšfo
.
g‘_chunk_size
());

120 
	gECUt
::
’code
(

121 cÚ¡ 
¡re_šfo_t
 &
sšfo
,

122 
E¿su»CodeIÁ”çûRef
 &
ec_im¶
,

123 
bufã¾i¡
 &
š
,

124 cÚ¡ 
£t
<> &
wªt
,

125 
m­
<, 
bufã¾i¡
> *
out
) {

127 
ušt64_t
 
	glogiÿl_size
 = 
š
.
Ëngth
();

129 
as£¹
(
logiÿl_size
 % 
sšfo
.
g‘_¡re_width
() == 0);

130 
as£¹
(
out
);

131 
as£¹
(
out
->
em±y
());

133 ià(
	glogiÿl_size
 == 0)

136 
ušt64_t
 
	gi
 = 0; i < 
	glogiÿl_size
; i +ğ
sšfo
.
g‘_¡re_width
()) {

137 
m­
<, 
bufã¾i¡
> 
’coded
;

138 
bufã¾i¡
 
	gbuf
;

139 
	gbuf
.
sub¡r_of
(
š
, 
i
, 
sšfo
.
g‘_¡re_width
());

140 
	gr
 = 
ec_im¶
->
’code
(
wªt
, 
buf
, &
’coded
);

141 
as£¹
(
r
 == 0);

142 
	gm­
<, 
	gbufã¾i¡
>::
™”©Ü
 
i
 = 
’coded
.
begš
();

143 
	gi
 !ğ
’coded
.
’d
();

144 ++
	gi
) {

145 
as£¹
(
i
->
£cÚd
.
Ëngth
(è=ğ
sšfo
.
g‘_chunk_size
());

146 (*
	gout
)[
i
->
fœ¡
].
şaim_­³nd
(i->
£cÚd
);

150 
	gm­
<, 
	gbufã¾i¡
>::
™”©Ü
 
i
 = 
out
->
begš
();

151 
	gi
 !ğ
out
->
’d
();

152 ++
	gi
) {

153 
as£¹
(
i
->
£cÚd
.
Ëngth
(è% 
sšfo
.
g‘_chunk_size
() == 0);

154 
as£¹
(

155 
sšfo
.
®igÃd_chunk_off£t_to_logiÿl_off£t
(
i
->
£cÚd
.
Ëngth
()) ==

156 
logiÿl_size
);

161 
	gECUt
::
HashInfo
::
­³nd
(
ušt64_t
 
Şd_size
,

162 
m­
<, 
bufã¾i¡
> &
to_­³nd
) {

163 
as£¹
(
Şd_size
 =ğ
tÙ®_chunk_size
);

164 
ušt64_t
 
	gsize_to_­³nd
 = 
to_­³nd
.
begš
()->
£cÚd
.
Ëngth
();

165 ià(
has_chunk_hash
()) {

166 
as£¹
(
to_­³nd
.
size
(è=ğ
cumuÏtive_sh¬d_hashes
.size());

167 
	gm­
<, 
	gbufã¾i¡
>::
™”©Ü
 
i
 = 
to_­³nd
.
begš
();

168 
	gi
 !ğ
to_­³nd
.
’d
();

169 ++
	gi
) {

170 
as£¹
(
size_to_­³nd
 =ğ
i
->
£cÚd
.
Ëngth
());

171 
as£¹
(()
i
->
fœ¡
 < 
cumuÏtive_sh¬d_hashes
.
size
());

172 
ušt32_t
 
	gÃw_hash
 = 
i
->
£cÚd
.
üc32c
(
cumuÏtive_sh¬d_hashes
[i->
fœ¡
]);

173 
	gcumuÏtive_sh¬d_hashes
[
i
->
fœ¡
] = 
Ãw_hash
;

176 
	gtÙ®_chunk_size
 +ğ
size_to_­³nd
;

179 
	gECUt
::
HashInfo
::
	$’code
(
bufã¾i¡
 &
bl
) const

181 
	`ENCODE_START
(1, 1, 
bl
);

182 
	`’code
(
tÙ®_chunk_size
, 
bl
);

183 
	`’code
(
cumuÏtive_sh¬d_hashes
, 
bl
);

184 
	`ENCODE_FINISH
(
bl
);

185 
	}
}

187 
	gECUt
::
HashInfo
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

189 
	`DECODE_START
(1, 
bl
);

190 
	`decode
(
tÙ®_chunk_size
, 
bl
);

191 
	`decode
(
cumuÏtive_sh¬d_hashes
, 
bl
);

192 
´ojeùed_tÙ®_chunk_size
 = 
tÙ®_chunk_size
;

193 
	`DECODE_FINISH
(
bl
);

194 
	}
}

196 
	gECUt
::
HashInfo
::
	$dump
(
FÜm©‹r
 *
f
) const

198 
f
->
	`dump_unsigÃd
("tÙ®_chunk_size", 
tÙ®_chunk_size
);

199 
f
->
	`İ’_¬¿y_£ùiÚ
("cumulative_shard_hashes");

200 
i
 = 0; i !ğ
cumuÏtive_sh¬d_hashes
.
	`size
(); ++i) {

201 
f
->
	`İ’_objeù_£ùiÚ
("hash");

202 
f
->
	`dump_unsigÃd
("sh¬d", 
i
);

203 
f
->
	`dump_unsigÃd
("hash", 
cumuÏtive_sh¬d_hashes
[
i
]);

204 
f
->
	`şo£_£ùiÚ
();

206 
f
->
	`şo£_£ùiÚ
();

207 
	}
}

209 
Çme¥aû
 
	gECUt
 {

210 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
out
, cÚ¡ 
	gHashInfo
& 
	ghi
)

212 
o¡ršg¡»am
 
	ghashes
;

213 autØ
	ghash
: 
hi
.
cumuÏtive_sh¬d_hashes
)

214 
hashes
 << " " << 
hex
 << 
hash
;

215  
	gout
 << "tcs=" << 
	ghi
.
	gtÙ®_chunk_size
 << 
	ghashes
.
¡r
();

219 
	gECUt
::
HashInfo
::
g’”©e_‹¡_š¡ªûs
(
li¡
<HashInfo*>& 
o
)

221 
o
.
push_back
(
Ãw
 
HashInfo
(3));

223 
bufã¾i¡
 
	gbl
;

224 
	gbl
.
­³nd_z”o
(20);

225 
	gm­
<, 
	gbufã¾i¡
> 
	gbufãrs
;

226 
	gbufãrs
[0] = 
bl
;

227 
	gbufãrs
[1] = 
bl
;

228 
	gbufãrs
[2] = 
bl
;

229 
	go
.
back
()->
­³nd
(0, 
bufãrs
);

230 
	go
.
back
()->
­³nd
(20, 
bufãrs
);

232 
	go
.
push_back
(
Ãw
 
HashInfo
(4));

235 cÚ¡ 
¡ršg
 
	gHINFO_KEY
 = "hinfo_key";

237 
boŞ
 
	gECUt
::
	$is_hšfo_key_¡ršg
(cÚ¡ 
¡ršg
 &
key
)

239  
key
 =ğ
HINFO_KEY
;

240 
	}
}

242 cÚ¡ 
	g¡ršg
 &
	gECUt
::
	$g‘_hšfo_key
()

244  
HINFO_KEY
;

245 
	}
}

	@osd/ECUtil.h

15 #iâdeà
ECUTIL_H


16 
	#ECUTIL_H


	)

18 
	~<o¡»am
>

19 
	~"”asu»-code/E¿su»CodeIÁ”çû.h
"

20 
	~"šşude/bufãr_fwd.h
"

21 
	~"šşude/as£¹.h
"

22 
	~"šşude/’codšg.h
"

23 
	~"commÚ/FÜm©‹r.h
"

25 
Çme¥aû
 
	gECUt
 {

27 şas 
	c¡re_šfo_t
 {

28 cÚ¡ 
ušt64_t
 
	g¡re_width
;

29 cÚ¡ 
ušt64_t
 
	gchunk_size
;

30 
	gpublic
:

31 
¡re_šfo_t
(
ušt64_t
 
¡re_size
, ušt64_ˆ
¡re_width
)

32 : 
¡re_width
(stripe_width),

33 
chunk_size
(
¡re_width
 / 
¡re_size
) {

34 
as£¹
(
¡re_width
 % 
¡re_size
 == 0);

36 
boŞ
 
logiÿl_off£t_is_¡re_®igÃd
(
ušt64_t
 
logiÿl
) const {

37  (
	glogiÿl
 % 
	g¡re_width
) == 0;

39 
ušt64_t
 
g‘_¡re_width
() const {

40  
	g¡re_width
;

42 
ušt64_t
 
g‘_chunk_size
() const {

43  
	gchunk_size
;

45 
ušt64_t
 
logiÿl_to_´ev_chunk_off£t
(ušt64_ˆ
off£t
) const {

46  (
	goff£t
 / 
	g¡re_width
è* 
	gchunk_size
;

48 
ušt64_t
 
logiÿl_to_Ãxt_chunk_off£t
(ušt64_ˆ
off£t
) const {

49  ((
	goff£t
 + 
	g¡re_width
 - 1)/ sŒe_widthè* 
	gchunk_size
;

51 
ušt64_t
 
logiÿl_to_´ev_¡re_off£t
(ušt64_ˆ
off£t
) const {

52  
	goff£t
 - (off£ˆ% 
	g¡re_width
);

54 
ušt64_t
 
logiÿl_to_Ãxt_¡re_off£t
(ušt64_ˆ
off£t
) const {

55  ((
	goff£t
 % 
	g¡re_width
) ?

56 (
	goff£t
 - (off£ˆ% 
	g¡re_width
) + stripe_width) :

57 
off£t
);

59 
ušt64_t
 
®igÃd_logiÿl_off£t_to_chunk_off£t
(ušt64_ˆ
off£t
) const {

60 
as£¹
(
off£t
 % 
¡re_width
 == 0);

61  (
	goff£t
 / 
	g¡re_width
è* 
	gchunk_size
;

63 
ušt64_t
 
®igÃd_chunk_off£t_to_logiÿl_off£t
(ušt64_ˆ
off£t
) const {

64 
as£¹
(
off£t
 % 
chunk_size
 == 0);

65  (
	goff£t
 / 
	gchunk_size
è* 
	g¡re_width
;

67 
	g¡d
::
·œ
<
ušt64_t
, 
	gušt64_t
> 
®igÃd_off£t_Ën_to_chunk
(

68 
¡d
::
·œ
<
ušt64_t
, ušt64_t> 
š
) const {

69  
	g¡d
::
make_·œ
(

70 
®igÃd_logiÿl_off£t_to_chunk_off£t
(
š
.
fœ¡
),

71 
®igÃd_logiÿl_off£t_to_chunk_off£t
(
š
.
£cÚd
));

73 
	g¡d
::
·œ
<
ušt64_t
, 
	gušt64_t
> 
off£t_Ën_to_¡re_bounds
(

74 
¡d
::
·œ
<
ušt64_t
, ušt64_t> 
š
) const {

75 
ušt64_t
 
	goff
 = 
logiÿl_to_´ev_¡re_off£t
(
š
.
fœ¡
);

76 
ušt64_t
 
	gËn
 = 
logiÿl_to_Ãxt_¡re_off£t
(

77 (
š
.
fœ¡
 - 
off
è+ in.
£cÚd
);

78  
	g¡d
::
make_·œ
(
off
, 
Ën
);

82 
decode
(

83 cÚ¡ 
¡re_šfo_t
 &
sšfo
,

84 
E¿su»CodeIÁ”çûRef
 &
ec_im¶
,

85 
¡d
::
m­
<, 
bufã¾i¡
> &
to_decode
,

86 
bufã¾i¡
 *
out
);

88 
decode
(

89 cÚ¡ 
¡re_šfo_t
 &
sšfo
,

90 
E¿su»CodeIÁ”çûRef
 &
ec_im¶
,

91 
¡d
::
m­
<, 
bufã¾i¡
> &
to_decode
,

92 
¡d
::
m­
<, 
bufã¾i¡
*> &
out
);

94 
’code
(

95 cÚ¡ 
¡re_šfo_t
 &
sšfo
,

96 
E¿su»CodeIÁ”çûRef
 &
ec_im¶
,

97 
bufã¾i¡
 &
š
,

98 cÚ¡ 
¡d
::
£t
<> &
wªt
,

99 
¡d
::
m­
<, 
bufã¾i¡
> *
out
);

101 şas 
	cHashInfo
 {

102 
ušt64_t
 
	gtÙ®_chunk_size
 = 0;

103 
	g¡d
::
veùÜ
<
ušt32_t
> 
cumuÏtive_sh¬d_hashes
;

106 
ušt64_t
 
	g´ojeùed_tÙ®_chunk_size
 = 0;

107 
	gpublic
:

108 
HashInfo
() {}

109 
ex¶ic™
 
HashInfo
(
num_chunks
) :

110 
cumuÏtive_sh¬d_hashes
(
num_chunks
, -1) {}

111 
­³nd
(
ušt64_t
 
Şd_size
, 
¡d
::
m­
<, 
bufã¾i¡
> &
to_­³nd
);

112 
ş—r
() {

113 
	gtÙ®_chunk_size
 = 0;

114 
	gcumuÏtive_sh¬d_hashes
 = 
¡d
::
veùÜ
<
ušt32_t
>(

115 
cumuÏtive_sh¬d_hashes
.
size
(),

118 
’code
(
bufã¾i¡
 &
bl
) const;

119 
decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

120 
dump
(
FÜm©‹r
 *
f
) const;

121 
g’”©e_‹¡_š¡ªûs
(
¡d
::
li¡
<
HashInfo
*>& 
o
);

122 
ušt32_t
 
g‘_chunk_hash
(
sh¬d
) const {

123 
as£¹
(()
sh¬d
 < 
cumuÏtive_sh¬d_hashes
.
size
());

124  
	gcumuÏtive_sh¬d_hashes
[
sh¬d
];

126 
ušt64_t
 
g‘_tÙ®_chunk_size
() const {

127  
	gtÙ®_chunk_size
;

129 
ušt64_t
 
g‘_´ojeùed_tÙ®_chunk_size
() const {

130  
	g´ojeùed_tÙ®_chunk_size
;

132 
ušt64_t
 
g‘_tÙ®_logiÿl_size
(cÚ¡ 
¡re_šfo_t
 &
sšfo
) const {

133  
g‘_tÙ®_chunk_size
() *

134 (
	gsšfo
.
g‘_¡re_width
()/sšfo.
g‘_chunk_size
());

136 
ušt64_t
 
g‘_´ojeùed_tÙ®_logiÿl_size
(cÚ¡ 
¡re_šfo_t
 &
sšfo
) const {

137  
g‘_´ojeùed_tÙ®_chunk_size
() *

138 (
	gsšfo
.
g‘_¡re_width
()/sšfo.
g‘_chunk_size
());

140 
£t_´ojeùed_tÙ®_logiÿl_size
(

141 cÚ¡ 
¡re_šfo_t
 &
sšfo
,

142 
ušt64_t
 
logiÿl_size
) {

143 
as£¹
(
sšfo
.
logiÿl_off£t_is_¡re_®igÃd
(
logiÿl_size
));

144 
	g´ojeùed_tÙ®_chunk_size
 = 
sšfo
.
®igÃd_logiÿl_off£t_to_chunk_off£t
(

145 
logiÿl_size
);

147 
£t_tÙ®_chunk_size_ş—r_hash
(
ušt64_t
 
Ãw_chunk_size
) {

148 
	gcumuÏtive_sh¬d_hashes
.
ş—r
();

149 
	gtÙ®_chunk_size
 = 
Ãw_chunk_size
;

151 
boŞ
 
has_chunk_hash
() const {

152  !
	gcumuÏtive_sh¬d_hashes
.
em±y
();

154 
upd©e_to
(cÚ¡ 
HashInfo
 &
rhs
) {

155 autØ
	g±cs
 = 
´ojeùed_tÙ®_chunk_size
;

156 *
	gthis
 = 
rhs
;

157 
	g´ojeùed_tÙ®_chunk_size
 = 
±cs
;

159 
ä›nd
 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
out
, cÚ¡ 
	gHashInfo
& 
	ghi
);

162 
	gûph
::
	tsh¬ed_±r
<
	tHashInfo
> 
	tHashInfoRef
;

164 
boŞ
 
is_hšfo_key_¡ršg
(cÚ¡ 
¡d
::
¡ršg
 &
key
);

165 cÚ¡ 
	g¡d
::
¡ršg
 &
g‘_hšfo_key
();

167 
WRITE_CLASS_ENCODER
(
ECUt
::
HashInfo
)

	@osd/ExtentCache.cc

15 
	~"Ex‹ÁCache.h
"

17 
	gEx‹ÁCache
::
ex‹Á
::
	$_lšk_pš_¡©e
(
pš_¡©e
 &pin_state)

19 
	`as£¹
(
·»Á_ex‹Á_£t
);

20 
	`as£¹
(!
·»Á_pš_¡©e
);

21 
·»Á_pš_¡©e
 = &
pš_¡©e
;

22 
pš_¡©e
.
pš_li¡
.
	`push_back
(*
this
);

23 
	}
}

25 
	gEx‹ÁCache
::
ex‹Á
::
	$_uÆšk_pš_¡©e
()

27 
	`as£¹
(
·»Á_ex‹Á_£t
);

28 
	`as£¹
(
·»Á_pš_¡©e
);

29 autØ
l™”
 = 
pš_¡©e
::
li¡
::
	`s_™”©Ü_to
(*
this
);

30 
·»Á_pš_¡©e
->
pš_li¡
.
	`”a£
(
l™”
);

31 
·»Á_pš_¡©e
 = 
nuÎ±r
;

32 
	}
}

34 
	gEx‹ÁCache
::
ex‹Á
::
	$uÆšk
()

36 
	`as£¹
(
·»Á_ex‹Á_£t
);

37 
	`as£¹
(
·»Á_pš_¡©e
);

39 
	`_uÆšk_pš_¡©e
();

43 autØ
s™”
 = 
objeù_ex‹Á_£t
::
£t
::
	`s_™”©Ü_to
(*
this
);

44 autØ&
£t
 = 
objeù_ex‹Á_£t
::£t::
	`cÚš”_äom_™”©Ü
(
s™”
);

45 
	`as£¹
(&
£t
 =ğ&(
·»Á_ex‹Á_£t
->
ex‹Á_£t
));

46 
£t
.
	`”a£
(
s™”
);

49 
·»Á_ex‹Á_£t
 = 
nuÎ±r
;

50 
	`as£¹
(!
·»Á_pš_¡©e
);

51 
	}
}

53 
	gEx‹ÁCache
::
ex‹Á
::
	$lšk
(

54 
objeù_ex‹Á_£t
 &
ex‹Á_£t
,

55 
pš_¡©e
 &pin_state)

57 
	`as£¹
(!
·»Á_ex‹Á_£t
);

58 
·»Á_ex‹Á_£t
 = &
ex‹Á_£t
;

59 
ex‹Á_£t
.ex‹Á_£t.
	`š£¹
(*
this
);

61 
	`_lšk_pš_¡©e
(
pš_¡©e
);

62 
	}
}

64 
	gEx‹ÁCache
::
ex‹Á
::
	$move
(

65 
pš_¡©e
 &
to
)

67 
	`_uÆšk_pš_¡©e
();

68 
	`_lšk_pš_¡©e
(
to
);

69 
	}
}

71 
	gEx‹ÁCache
::
	$»move_ªd_de¡roy_if_em±y
(
objeù_ex‹Á_£t
 &
e£t
)

73 ià(
e£t
.
ex‹Á_£t
.
	`em±y
()) {

74 autØ
s™”
 = 
ÿche_£t
::
	`s_™”©Ü_to
(
e£t
);

75 autØ&
£t
 = 
ÿche_£t
::
	`cÚš”_äom_™”©Ü
(
s™”
);

76 
	`as£¹
(&
£t
 =ğ&
³r_objeù_ÿches
);

79 
³r_objeù_ÿches
.
	`”a£
(
e£t
);

80 
d–‘e
 &
e£t
;

82 
	}
}

84 
	gEx‹ÁCache
::
objeù_ex‹Á_£t
 &
Ex‹ÁCache
::
	$g‘_Ü_ü—‹
(

85 cÚ¡ 
hobjeù_t
 &
oid
)

87 
ÿche_£t
::
š£¹_comm™_d©a
 
d©a
;

88 autØ
p
 = 
³r_objeù_ÿches
.
	`š£¹_check
(
oid
, 
	`Cmp
(), 
d©a
);

89 ià(
p
.
£cÚd
) {

90 autØ*
e£t
 = 
Ãw
 
	`objeù_ex‹Á_£t
(
oid
);

91 
³r_objeù_ÿches
.
	`š£¹_comm™
(*
e£t
, 
d©a
);

92  *
e£t
;

94  *(
p
.
fœ¡
);

96 
	}
}

98 
	gEx‹ÁCache
::
objeù_ex‹Á_£t
 *
Ex‹ÁCache
::
	$g‘_if_exi¡s
(

99 cÚ¡ 
hobjeù_t
 &
oid
)

101 
ÿche_£t
::
š£¹_comm™_d©a
 
d©a
;

102 autØ
p
 = 
³r_objeù_ÿches
.
	`š£¹_check
(
oid
, 
	`Cmp
(), 
d©a
);

103 ià(
p
.
£cÚd
) {

104  
nuÎ±r
;

106  &*(
p
.
fœ¡
);

108 
	}
}

110 
	g¡d
::
·œ
<

111 
Ex‹ÁCache
::
objeù_ex‹Á_£t
::
£t
::
™”©Ü
,

112 
	gEx‹ÁCache
::
objeù_ex‹Á_£t
::
£t
::
™”©Ü


113 > 
Ex‹ÁCache
::
objeù_ex‹Á_£t
::
	$g‘_cÚššg_¿nge
(

114 
ušt64_t
 
off
, ušt64_ˆ
Ën
)

117 autØ
f¡
 = 
ex‹Á_£t
.
	`uµ”_bound
(
off
, 
	`ušt_cmp
());

118 ià(
f¡
 !ğ
ex‹Á_£t
.
	`begš
())

119 --
f¡
;

120 ià(
f¡
 !ğ
ex‹Á_£t
.
	`’d
(è&& 
off
 >ğ(f¡->
off£t
 + f¡->
	`g‘_Ëngth
()))

121 ++
f¡
;

124 autØ
l¡
 = 
ex‹Á_£t
.
	`low”_bound
(
off
 + 
Ën
, 
	`ušt_cmp
());

125  
¡d
::
	`make_·œ
(
f¡
, 
l¡
);

126 
	}
}

128 
ex‹Á_£t
 
	gEx‹ÁCache
::
	$»£rve_ex‹Ás_fÜ_rmw
(

129 cÚ¡ 
hobjeù_t
 &
oid
,

130 
wr™e_pš
 &
pš
,

131 cÚ¡ 
ex‹Á_£t
 &
to_wr™e
,

132 cÚ¡ 
ex‹Á_£t
 &
to_»ad
)

134 ià(
to_wr™e
.
	`em±y
(è&& 
to_»ad
.empty()) {

135  
	`ex‹Á_£t
();

137 
ex‹Á_£t
 
mu¡_»ad
;

138 autØ&
e£t
 = 
	`g‘_Ü_ü—‹
(
oid
);

139 
ex‹Á_£t
 
missšg
;

140 autØ&&
»s
: 
to_wr™e
) {

141 
e£t
.
	`Œav”£_upd©e
(

142 
pš
,

143 
»s
.
fœ¡
,

144 
»s
.
£cÚd
,

145 [&](
ušt64_t
 
off
, ušt64_ˆ
Ën
,

146 
ex‹Á
 *
ext
, 
objeù_ex‹Á_£t
::
upd©e_aùiÚ
 *
aùiÚ
) {

147 
aùiÚ
->aùiÚ = 
objeù_ex‹Á_£t
::
upd©e_aùiÚ
::
UPDATE_PIN
;

148 ià(!
ext
) {

149 
missšg
.
	`š£¹
(
off
, 
Ën
);

153 
mu¡_»ad
.
	`š‹r£ùiÚ_of
(

154 
to_»ad
,

155 
missšg
);

156  
mu¡_»ad
;

157 
	}
}

159 
ex‹Á_m­
 
	gEx‹ÁCache
::
	$g‘_»maššg_ex‹Ás_fÜ_rmw
(

160 cÚ¡ 
hobjeù_t
 &
oid
,

161 
wr™e_pš
 &
pš
,

162 cÚ¡ 
ex‹Á_£t
 &
to_g‘
)

164 ià(
to_g‘
.
	`em±y
()) {

165  
	`ex‹Á_m­
();

167 
ex‹Á_m­
 
»t
;

168 autØ&
e£t
 = 
	`g‘_Ü_ü—‹
(
oid
);

169 autØ&&
»s
: 
to_g‘
) {

170 
bufã¾i¡
 
bl
;

171 
ušt64_t
 
cur
 = 
»s
.
fœ¡
;

172 
e£t
.
	`Œav”£_upd©e
(

173 
pš
,

174 
»s
.
fœ¡
,

175 
»s
.
£cÚd
,

176 [&](
ušt64_t
 
off
, ušt64_ˆ
Ën
,

177 
ex‹Á
 *
ext
, 
objeù_ex‹Á_£t
::
upd©e_aùiÚ
 *
aùiÚ
) {

178 
	`as£¹
(
off
 =ğ
cur
);

179 
cur
 = 
off
 + 
Ën
;

180 
aùiÚ
->aùiÚ = 
objeù_ex‹Á_£t
::
upd©e_aùiÚ
::
NONE
;

181 
	`as£¹
(
ext
 &&ƒxt->
bl
 &&ƒxt->
	`pšÃd_by_wr™e
());

182 
bl
.
	`sub¡r_of
(

183 *(
ext
->
bl
),

184 
off
 - 
ext
->
off£t
,

185 
Ën
);

186 
»t
.
	`š£¹
(
off
, 
Ën
, 
bl
);

189  
»t
;

190 
	}
}

192 
	gEx‹ÁCache
::
	$´e£Á_rmw_upd©e
(

193 cÚ¡ 
hobjeù_t
 &
oid
,

194 
wr™e_pš
 &
pš
,

195 cÚ¡ 
ex‹Á_m­
 &
ex‹Ás
)

197 ià(
ex‹Ás
.
	`em±y
()) {

200 autØ&
e£t
 = 
	`g‘_Ü_ü—‹
(
oid
);

201 autØ&&
»s
: 
ex‹Ás
) {

202 
e£t
.
	`Œav”£_upd©e
(

203 
pš
,

204 
»s
.
	`g‘_off
(),

205 
»s
.
	`g‘_Ën
(),

206 [&](
ušt64_t
 
off
, ušt64_ˆ
Ën
,

207 
ex‹Á
 *
ext
, 
objeù_ex‹Á_£t
::
upd©e_aùiÚ
 *
aùiÚ
) {

208 
aùiÚ
->aùiÚ = 
objeù_ex‹Á_£t
::
upd©e_aùiÚ
::
NONE
;

209 
	`as£¹
(
ext
 &&ƒxt->
	`pšÃd_by_wr™e
());

210 
aùiÚ
->
bl
 = 
	`bufã¾i¡
();

211 
aùiÚ
->
bl
->
	`sub¡r_of
(

212 
»s
.
	`g‘_v®
(),

213 
off
 - 
»s
.
	`g‘_off
(),

214 
Ën
);

217 
	}
}

219 
	go¡»am
 &
	gEx‹ÁCache
::
	$´št
(
o¡»am
 &
out
) const

221 
out
 << "Ex‹ÁCache(" << 
¡d
::
’dl
;

222 autØ
es™”
 = 
³r_objeù_ÿches
.
	`begš
();

223 
es™”
 !ğ
³r_objeù_ÿches
.
	`’d
();

224 ++
es™”
) {

225 
out
 << " Ex‹Ás(" << 
es™”
->
oid
 << ")[" << 
¡d
::
’dl
;

226 autØ
ex™”
 = 
es™”
->
ex‹Á_£t
.
	`begš
();

227 
ex™”
 !ğ
es™”
->
ex‹Á_£t
.
	`’d
();

228 ++
ex™”
) {

229 
out
 << " Ex‹Á(" << 
ex™”
->
off£t


230 << "~" << 
ex™”
->
	`g‘_Ëngth
()

231 << ":" << 
ex™”
->
	`pš_tid
()

232 << ")" << 
¡d
::
’dl
;

235  
out
 << ")" << 
¡d
::
’dl
;

236 
	}
}

238 
	go¡»am
 &
	gİ”©Ü
<<(o¡»am &
	glhs
, cÚ¡ 
	gEx‹ÁCache
 &
	gÿche
)

240  
	gÿche
.
´št
(
lhs
);

	@osd/ExtentCache.h

15 #iâdeà
EXTENT_CACHE_H


16 
	#EXTENT_CACHE_H


	)

18 
	~<m­
>

19 
	~<li¡
>

20 
	~<veùÜ
>

21 
	~<ut™y
>

22 
	~<boo¡/İtiÚ®.hµ
>

23 
	~<boo¡/šŒusive/£t.hµ
>

24 
	~<boo¡/šŒusive/li¡.hµ
>

25 
	~"šşude/š‹rv®_£t.h
"

26 
	~"commÚ/š‹rv®_m­.h
"

27 
	~"šşude/bufãr.h
"

28 
	~"commÚ/hobjeù.h
"

98 
	sbl_¥l™_m”ge
 {

99 
bufã¾i¡
 
¥l™
(

100 
ušt64_t
 
off£t
,

101 
ušt64_t
 
Ëngth
,

102 
bufã¾i¡
 &
bl
) const {

103 
bufã¾i¡
 
	mout
;

104 
	mout
.
sub¡r_of
(
bl
, 
off£t
, 
Ëngth
);

105  
	mout
;

107 
boŞ
 
ÿn_m”ge
(cÚ¡ 
bufã¾i¡
 &
Ëá
, cÚ¡ bufã¾i¡ &
right
) const {

108  
	mŒue
;

110 
bufã¾i¡
 
m”ge
(bufã¾i¡ &&
Ëá
, bufã¾i¡ &&
right
) const {

111 
bufã¾i¡
 
	mbl
;

112 
	mbl
.
şaim
(
Ëá
);

113 
	mbl
.
şaim_­³nd
(
right
);

114  
	mbl
;

116 
ušt64_t
 
Ëngth
(cÚ¡ 
bufã¾i¡
 &
b
ècÚ¡ {  
	mb
.length(); }

118 
usšg
 
	gex‹Á_£t
 = 
š‹rv®_£t
<
ušt64_t
>;

119 
usšg
 
	gex‹Á_m­
 = 
š‹rv®_m­
<
ušt64_t
, 
	gbufã¾i¡
, 
	gbl_¥l™_m”ge
>;

121 şas 
	cEx‹ÁCache
 {

122 
	mobjeù_ex‹Á_£t
;

123 
	mpš_¡©e
;

124 
	m´iv©e
:

126 
	sex‹Á
 {

127 
objeù_ex‹Á_£t
 *
·»Á_ex‹Á_£t
 = 
nuÎ±r
;

128 
pš_¡©e
 *
	m·»Á_pš_¡©e
 = 
nuÎ±r
;

129 
	mboo¡
::
šŒusive
::
£t_memb”_hook
<> 
ex‹Á_£t_memb”
;

130 
	mboo¡
::
šŒusive
::
li¡_memb”_hook
<> 
pš_li¡_memb”
;

132 
ušt64_t
 
	moff£t
;

133 
ušt64_t
 
	mËngth
;

134 
	mboo¡
::
İtiÚ®
<
bufã¾i¡
> 
bl
;

136 
ušt64_t
 
g‘_Ëngth
() const {

137  
	mËngth
;

140 
boŞ
 
is_³ndšg
() const {

141  
	mbl
 =ğ
boo¡
::
nÚe
;

144 
boŞ
 
pšÃd_by_wr™e
() const {

145 
as£¹
(
·»Á_pš_¡©e
);

146  
	m·»Á_pš_¡©e
->
is_wr™e
();

149 
ušt64_t
 
pš_tid
() const {

150 
as£¹
(
·»Á_pš_¡©e
);

151  
	m·»Á_pš_¡©e
->
	mtid
;

154 
ex‹Á
(
ušt64_t
 
off£t
, 
bufã¾i¡
 
_bl
)

155 : 
off£t
(off£t), 
Ëngth
(
_bl
.Ëngth()), 
bl
(_bl) {}

157 
ex‹Á
(
ušt64_t
 
off£t
, ušt64_ˆ
Ëngth
)

158 : 
off£t
(off£t), 
Ëngth
(length) {}

160 
boŞ
 
	mİ”©Ü
<(cÚ¡ 
	mex‹Á
 &
	mrhs
) const {

161  
	moff£t
 < 
	mrhs
.offset;

163 
	m´iv©e
:

165 
_lšk_pš_¡©e
(
pš_¡©e
 &pin_state);

166 
_uÆšk_pš_¡©e
();

167 
	mpublic
:

168 
uÆšk
();

169 
lšk
(
objeù_ex‹Á_£t
 &
·»Á_ex‹Á_£t
, 
pš_¡©e
 &pin_state);

170 
move
(
pš_¡©e
 &
to
);

173 
	gobjeù_ex‹Á_£t
 : 
boo¡
::
šŒusive
::
£t_ba£_hook
<> {

174 
hobjeù_t
 
oid
;

175 
ex¶ic™
 
objeù_ex‹Á_£t
(cÚ¡ 
hobjeù_t
 &
oid
) : oid(oid) {}

177 
usšg
 
£t_memb”_İtiÚs
 = 
boo¡
::
šŒusive
::
memb”_hook
<

178 
ex‹Á
,

179 
	gboo¡
::
šŒusive
::
£t_memb”_hook
<>,

180 &
	gex‹Á
::
ex‹Á_£t_memb”
>;

181 
usšg
 
	g£t
 = 
boo¡
::
šŒusive
::
£t
<
ex‹Á
, 
	g£t_memb”_İtiÚs
>;

182 
£t
 
	gex‹Á_£t
;

184 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	gobjeù_ex‹Á_£t
 &
	grhs
) const {

185  
	goid
 < 
	grhs
.oid;

188 
	sušt_cmp
 {

189 
boŞ
 
İ”©Ü
()(
ušt64_t
 
	glhs
, cÚ¡ 
	gex‹Á
 &
	grhs
) const {

190  
	glhs
 < 
	grhs
.
	goff£t
;

192 
boŞ
 
İ”©Ü
()(cÚ¡ 
	gex‹Á
 &
	glhs
, 
ušt64_t
 
	grhs
) const {

193  
	glhs
.
	goff£t
 < 
	grhs
;

196 
	g¡d
::
·œ
<
£t
::
™”©Ü
, 
	g£t
::™”©Ü> 
g‘_cÚššg_¿nge
(

197 
ušt64_t
 
off£t
, ušt64_ˆ
Ëngth
);

199 
”a£
(
ušt64_t
 
off£t
, ušt64_ˆ
Ëngth
);

201 
	supd©e_aùiÚ
 {

202 
	ety³
 {

203 
	gNONE
,

204 
	gUPDATE_PIN


206 
ty³
 
	gaùiÚ
 = 
NONE
;

207 
	gboo¡
::
İtiÚ®
<
bufã¾i¡
> 
bl
;

209 
	g‹m¶©e
 <
ty³Çme
 
	gF
>

210 
Œav”£_upd©e
(

211 
pš_¡©e
 &
pš
,

212 
ušt64_t
 
off£t
,

213 
ušt64_t
 
Ëngth
,

214 
F
 &&
f
) {

215 autØ
	g¿nge
 = 
g‘_cÚššg_¿nge
(
off£t
, 
Ëngth
);

217 ià(
	g¿nge
.
	gfœ¡
 =ğ
¿nge
.
£cÚd
 ||„ªge.
fœ¡
->
off£t
 > offset) {

218 
ušt64_t
 
ex’
 = 
¿nge
.
fœ¡
 =ğ¿nge.
£cÚd
 ?

219 
Ëngth
 : 
¿nge
.
fœ¡
->
off£t
 - offset;

221 
upd©e_aùiÚ
 
	gaùiÚ
;

222 
f
(
off£t
, 
ex’
, 
nuÎ±r
, &
aùiÚ
);

223 
as£¹
(!
aùiÚ
.
bl
 ||‡ùiÚ.bl->
Ëngth
(è=ğ
ex’
);

224 ià(
	gaùiÚ
.aùiÚ =ğ
upd©e_aùiÚ
::
UPDATE_PIN
) {

225 
ex‹Á
 *
ext
 = 
aùiÚ
.
bl
 ?

226 
Ãw
 
ex‹Á
(
off£t
, *
aùiÚ
.
bl
) :

227 
Ãw
 
ex‹Á
(
off£t
, 
ex’
);

228 
	gext
->
lšk
(*
this
, 
pš
);

230 
as£¹
(!
aùiÚ
.
bl
);

234 autØ
	gp
 = 
¿nge
.
fœ¡
;… !ğ¿nge.
£cÚd
;) {

235 
ex‹Á
 *
	gext
 = &*
p
;

236 ++
	gp
;

238 
ušt64_t
 
	gextoff
 = 
¡d
::
max
(
ext
->
off£t
, offset);

239 
ušt64_t
 
	gex’
 = 
¡d
::
mš
(

240 
ext
->
Ëngth
 - (
extoff
 -ƒxt->
off£t
),

241 
off£t
 + 
Ëngth
 - 
extoff
);

243 
upd©e_aùiÚ
 
	gaùiÚ
;

244 
f
(
extoff
, 
ex’
, 
ext
, &
aùiÚ
);

245 
as£¹
(!
aùiÚ
.
bl
 ||‡ùiÚ.bl->
Ëngth
(è=ğ
ex’
);

246 
ex‹Á
 *
	gfš®_ex‹Á
 = 
nuÎ±r
;

247 ià(
	gaùiÚ
.aùiÚ =ğ
upd©e_aùiÚ
::
NONE
) {

248 
fš®_ex‹Á
 = 
ext
;

250 
pš_¡©e
 *
	gps
 = 
ext
->
·»Á_pš_¡©e
;

251 
	gext
->
uÆšk
();

252 ià((
	gext
->
	goff£t
 < offset) &&

253 (
	gext
->
	goff£t
 +ƒxt->
g‘_Ëngth
() > offset)) {

254 
ex‹Á
 *
	gh—d
 = 
nuÎ±r
;

255 ià(
	gext
->
	gbl
) {

256 
bufã¾i¡
 
	gbl
;

257 
	gbl
.
sub¡r_of
(

258 *(
ext
->
bl
),

260 
off£t
 - 
ext
->offset);

261 
	gh—d
 = 
Ãw
 
ex‹Á
(
ext
->
off£t
, 
bl
);

263 
	gh—d
 = 
Ãw
 
ex‹Á
(

264 
ext
->
off£t
, offset -ƒxt->offset);

266 
	gh—d
->
lšk
(*
this
, *
ps
);

268 ià((
	gext
->
	goff£t
 +ƒxt->
	gËngth
 > offset +†ength) &&

269 (
	goff£t
 + 
	gËngth
 > 
	gext
->offset)) {

270 
ušt64_t
 
	gÆ’
 =

271 (
ext
->
off£t
 +ƒxt->
g‘_Ëngth
()è- (off£ˆ+ 
Ëngth
);

272 
ex‹Á
 *
	g
 = 
nuÎ±r
;

273 ià(
	gext
->
	gbl
) {

274 
bufã¾i¡
 
	gbl
;

275 
	gbl
.
sub¡r_of
(

276 *(
ext
->
bl
),

277 
ext
->
g‘_Ëngth
(è- 
Æ’
,

278 
Æ’
);

279 
	g
 = 
Ãw
 
ex‹Á
(
off£t
 + 
Ëngth
, 
bl
);

281 
	g
 = 
Ãw
 
ex‹Á
(
off£t
 + 
Ëngth
, 
Æ’
);

283 
	g
->
lšk
(*
this
, *
ps
);

285 ià(
	gaùiÚ
.aùiÚ =ğ
upd©e_aùiÚ
::
UPDATE_PIN
) {

286 ià(
ext
->
bl
) {

287 
bufã¾i¡
 
bl
;

288 
	gbl
.
sub¡r_of
(

289 *(
ext
->
bl
),

290 
extoff
 - 
ext
->
off£t
,

291 
ex’
);

292 
	gfš®_ex‹Á
 = 
Ãw
 
Ex‹ÁCache
::
ex‹Á
(

293 
extoff
,

294 
bl
);

296 
	gfš®_ex‹Á
 = 
Ãw
 
Ex‹ÁCache
::
ex‹Á
(

297 
extoff
, 
ex’
);

299 
	gfš®_ex‹Á
->
lšk
(*
this
, 
pš
);

301 
d–‘e
 
	gext
;

304 ià(
	gaùiÚ
.
	gbl
) {

305 
as£¹
(
fš®_ex‹Á
);

306 
as£¹
(
fš®_ex‹Á
->
Ëngth
 =ğ
aùiÚ
.
bl
->length());

307 
	gfš®_ex‹Á
->
	gbl
 = *(
aùiÚ
.
bl
);

310 
ušt64_t
 
	gÃxt_off
 = 
p
 =ğ
¿nge
.
£cÚd
 ?

311 
off£t
 + 
Ëngth
 : 
p
->offset;

312 ià(
	gextoff
 + 
	gex’
 < 
	gÃxt_off
) {

313 
ušt64_t
 
	goff
 = 
extoff
 + 
ex’
;

314 
ušt64_t
 
	gËn
 = 
Ãxt_off
 - 
off
;

316 
upd©e_aùiÚ
 
	gaùiÚ
;

317 
f
(
off
, 
Ën
, 
nuÎ±r
, &
aùiÚ
);

318 
as£¹
(!
aùiÚ
.
bl
 ||‡ùiÚ.bl->
Ëngth
(è=ğ
Ën
);

319 ià(
	gaùiÚ
.aùiÚ =ğ
upd©e_aùiÚ
::
UPDATE_PIN
) {

320 
ex‹Á
 *
ext
 = 
aùiÚ
.
bl
 ?

321 
Ãw
 
ex‹Á
(
off
, *
aùiÚ
.
bl
) :

322 
Ãw
 
ex‹Á
(
off
, 
Ën
);

323 
	gext
->
lšk
(*
this
, 
pš
);

325 
as£¹
(!
aùiÚ
.
bl
);

331 
	sCmp
 {

332 
boŞ
 
İ”©Ü
()(cÚ¡ 
	ghobjeù_t
 &
	goid
, cÚ¡ 
	gobjeù_ex‹Á_£t
 &
	grhs
) const {

333  
	goid
 < 
	grhs
.oid;

335 
boŞ
 
İ”©Ü
()(cÚ¡ 
	gobjeù_ex‹Á_£t
 &
	glhs
, cÚ¡ 
	ghobjeù_t
 &
	goid
) const {

336  
	glhs
.
	goid
 < oid;

340 
	gobjeù_ex‹Á_£t
 &
g‘_Ü_ü—‹
(cÚ¡ 
hobjeù_t
 &
oid
);

341 
objeù_ex‹Á_£t
 *
g‘_if_exi¡s
(cÚ¡ 
hobjeù_t
 &
oid
);

343 
»move_ªd_de¡roy_if_em±y
(
objeù_ex‹Á_£t
 &
£t
);

344 
usšg
 
	gÿche_£t
 = 
boo¡
::
šŒusive
::
£t
<
objeù_ex‹Á_£t
>;

345 
ÿche_£t
 
	g³r_objeù_ÿches
;

347 
ušt64_t
 
	gÃxt_wr™e_tid
 = 1;

348 
ušt64_t
 
	gÃxt_»ad_tid
 = 1;

349 
	spš_¡©e
 {

350 
ušt64_t
 
	gtid
 = 0;

351 
	epš_ty³_t
 {

352 
	gNONE
,

353 
	gWRITE
,

355 
pš_ty³_t
 
	gpš_ty³
 = 
NONE
;

356 
boŞ
 
is_wr™e
(ècÚ¡ {  
	gpš_ty³
 =ğ
WRITE
; }

358 
pš_¡©e
(cÚ¡…š_¡©&
Ùh”
èğ
d–‘e
;

359 
	gpš_¡©e
 &
	gİ”©Ü
=(cÚ¡ 
pš_¡©e
 &
Ùh”
èğ
d–‘e
;

360 
pš_¡©e
Õš_¡©&&
Ùh”
èğ
d–‘e
;

361 
pš_¡©e
() = ;

363 
usšg
 
	gli¡_memb”_İtiÚs
 = 
boo¡
::
šŒusive
::
memb”_hook
<

364 
ex‹Á
,

365 
	gboo¡
::
šŒusive
::
li¡_memb”_hook
<>,

366 &
	gex‹Á
::
pš_li¡_memb”
>;

367 
usšg
 
	gli¡
 = 
boo¡
::
šŒusive
::
li¡
<
ex‹Á
, 
	gli¡_memb”_İtiÚs
>;

368 
li¡
 
	gpš_li¡
;

369 ~
pš_¡©e
() {

370 
as£¹
(
pš_li¡
.
em±y
());

371 
as£¹
(
tid
 == 0);

372 
as£¹
(
pš_ty³
 =ğ
NONE
);

374 
_İ’
(
ušt64_t
 
š_tid
, 
pš_ty³_t
 
š_ty³
) {

375 
as£¹
(
pš_ty³
 =ğ
NONE
);

376 
as£¹
(
š_tid
 > 0);

377 
	gtid
 = 
š_tid
;

378 
	gpš_ty³
 = 
š_ty³
;

382 
	$»Ëa£_pš
(
pš_¡©e
 &
p
) {

383 autØ
™”
 = 
p
.
pš_li¡
.
	`begš
(); i‹¸!ğp.pš_li¡.
	`’d
(); ) {

384 
unique_±r
<
ex‹Á
> 
	`ex‹Á
(&*
™”
);

385 
™”
++;

386 
	`as£¹
(
ex‹Á
->
·»Á_ex‹Á_£t
);

387 autØ&
e£t
 = *(
ex‹Á
->
·»Á_ex‹Á_£t
);

388 
ex‹Á
->
	`uÆšk
();

389 
	`»move_ªd_de¡roy_if_em±y
(
e£t
);

391 
p
.
tid
 = 0;

392 
p
.
pš_ty³
 = 
pš_¡©e
::
NONE
;

393 
	}
}

395 
	gpublic
:

396 şas 
	cwr™e_pš
 : 
´iv©e
 
pš_¡©e
 {

397 
ä›nd
 
şass
 
Ex‹ÁCache
;

398 
	g´iv©e
:

399 
İ’
(
ušt64_t
 
š_tid
) {

400 
_İ’
(
š_tid
, 
pš_¡©e
::
WRITE
);

402 
	gpublic
:

403 
wr™e_pš
(è: 
pš_¡©e
() {}

406 
	$İ’_wr™e_pš
(
wr™e_pš
 &
pš
) {

407 
pš
.
	`İ’
(
Ãxt_wr™e_tid
++);

408 
	}
}

430 
ex‹Á_£t
 
»£rve_ex‹Ás_fÜ_rmw
(

431 cÚ¡ 
hobjeù_t
 &
oid
,

432 
wr™e_pš
 &
pš
,

433 cÚ¡ 
ex‹Á_£t
 &
to_wr™e
,

434 cÚ¡ 
ex‹Á_£t
 &
to_»ad
);

450 
ex‹Á_m­
 
g‘_»maššg_ex‹Ás_fÜ_rmw
(

451 cÚ¡ 
hobjeù_t
 &
oid
,

452 
wr™e_pš
 &
pš
,

453 cÚ¡ 
ex‹Á_£t
 &
to_g‘
);

472 
´e£Á_rmw_upd©e
(

473 cÚ¡ 
hobjeù_t
 &
oid
,

474 
wr™e_pš
 &
pš
,

475 cÚ¡ 
ex‹Á_m­
 &
ex‹Ás
);

480 
	$»Ëa£_wr™e_pš
(

481 
wr™e_pš
 &
pš
) {

482 
	`»Ëa£_pš
(
pš
);

483 
	}
}

485 
	go¡»am
 &
	$´št
(

486 
o¡»am
 &
out
) const;

487 
	}
};

489 
	go¡»am
 &
	gİ”©Ü
<<(o¡»am &
	glhs
, cÚ¡ 
	gEx‹ÁCache
 &
	gÿche
);

	@osd/HitSet.cc

15 
	~"H™S‘.h
"

16 
	~"commÚ/FÜm©‹r.h
"

20 
	gH™S‘
::
	$H™S‘
(cÚ¡ 
H™S‘
::
P¬ams
& 
·¿ms
)

21 : 
	$£®ed
(
çl£
)

23 
·¿ms
.
	`g‘_ty³
()) {

24 
TYPE_BLOOM
:

26 
BloomH™S‘
::
P¬ams
 *
p
 =

27 
¡©ic_ÿ¡
<
BloomH™S‘
::
P¬ams
*>(
·¿ms
.
im¶
.
	`g‘
());

28 
im¶
.
	`»£t
(
Ãw
 
	`BloomH™S‘
(
p
));

32 
TYPE_EXPLICIT_HASH
:

33 
im¶
.
	`»£t
(
Ãw
 
	`Ex¶ic™HashH™S‘
(
¡©ic_ÿ¡
<
Ex¶ic™HashH™S‘
::
P¬ams
*>(
·¿ms
.im¶.
	`g‘
())));

36 
TYPE_EXPLICIT_OBJECT
:

37 
im¶
.
	`»£t
(
Ãw
 
	`Ex¶ic™ObjeùH™S‘
(
¡©ic_ÿ¡
<
Ex¶ic™ObjeùH™S‘
::
P¬ams
*>(
·¿ms
.im¶.
	`g‘
())));

41 
	`as£¹
 (0 == "unknown HitSetype");

43 
	}
}

45 
	gH™S‘
::
	$’code
(
bufã¾i¡
 &
bl
) const

47 
	`ENCODE_START
(1, 1, 
bl
);

48 
	`’code
(
£®ed
, 
bl
);

49 ià(
im¶
) {

50 
	`’code
((
__u8
)
im¶
->
	`g‘_ty³
(), 
bl
);

51 
im¶
->
	`’code
(
bl
);

53 
	`’code
((
__u8
)
TYPE_NONE
, 
bl
);

55 
	`ENCODE_FINISH
(
bl
);

56 
	}
}

58 
	gH™S‘
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

60 
	`DECODE_START
(1, 
bl
);

61 
	`decode
(
£®ed
, 
bl
);

62 
__u8
 
ty³
;

63 
	`decode
(
ty³
, 
bl
);

64 (
im¶_ty³_t
)
ty³
) {

65 
TYPE_EXPLICIT_HASH
:

66 
im¶
.
	`»£t
(
Ãw
 
Ex¶ic™HashH™S‘
);

68 
TYPE_EXPLICIT_OBJECT
:

69 
im¶
.
	`»£t
(
Ãw
 
Ex¶ic™ObjeùH™S‘
);

71 
TYPE_BLOOM
:

72 
im¶
.
	`»£t
(
Ãw
 
BloomH™S‘
);

74 
TYPE_NONE
:

75 
im¶
.
	`»£t
(
NULL
);

78 
throw
 
bufãr
::
	`m®fÜmed_šput
("unrecognized HitMapype");

80 ià(
im¶
)

81 
im¶
->
	`decode
(
bl
);

82 
	`DECODE_FINISH
(
bl
);

83 
	}
}

85 
	gH™S‘
::
	$dump
(
FÜm©‹r
 *
f
) const

87 
f
->
	`dump_¡ršg
("ty³", 
	`g‘_ty³_Çme
());

88 
f
->
	`dump_¡ršg
("£®ed", 
£®ed
 ? "yes" : "no");

89 ià(
im¶
)

90 
im¶
->
	`dump
(
f
);

91 
	}
}

93 
	gH™S‘
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
H™S‘
*>& 
o
)

95 
o
.
push_back
(
Ãw
 
H™S‘
);

96 
	go
.
push_back
(
Ãw
 
H™S‘
Òew 
BloomH™S‘
(10, .1, 1)));

97 
	go
.
back
()->
š£¹
(
hobjeù_t
());

98 
	go
.
back
()->
š£¹
(
hobjeù_t
("asdf", "", 
CEPH_NOSNAP
, 123, 1, ""));

99 
	go
.
back
()->
š£¹
(
hobjeù_t
("qw”", "", 
CEPH_NOSNAP
, 456, 1, ""));

100 
	go
.
push_back
(
Ãw
 
H™S‘
Òew 
Ex¶ic™HashH™S‘
));

101 
	go
.
back
()->
š£¹
(
hobjeù_t
());

102 
	go
.
back
()->
š£¹
(
hobjeù_t
("asdf", "", 
CEPH_NOSNAP
, 123, 1, ""));

103 
	go
.
back
()->
š£¹
(
hobjeù_t
("qw”", "", 
CEPH_NOSNAP
, 456, 1, ""));

104 
	go
.
push_back
(
Ãw
 
H™S‘
Òew 
Ex¶ic™ObjeùH™S‘
));

105 
	go
.
back
()->
š£¹
(
hobjeù_t
());

106 
	go
.
back
()->
š£¹
(
hobjeù_t
("asdf", "", 
CEPH_NOSNAP
, 123, 1, ""));

107 
	go
.
back
()->
š£¹
(
hobjeù_t
("qw”", "", 
CEPH_NOSNAP
, 456, 1, ""));

110 
	gH™S‘
::
P¬ams
::
	$P¬ams
(cÚ¡ 
P¬ams
& 
o
)

112 ià(
o
.
	`g‘_ty³
(è!ğ
TYPE_NONE
) {

113 
	`ü—‹_im¶
(
o
.
	`g‘_ty³
());

116 
bufã¾i¡
 
bl
;

117 
o
.
im¶
->
	`’code
(
bl
);

118 
bufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
	`begš
();

119 
im¶
->
	`decode
(
p
);

121 
	}
}

123 cÚ¡ 
	gH™S‘
::
P¬ams
& 
H™S‘
::P¬ams::
İ”©Ü
=(cÚ¡ P¬ams& 
o
)

125 
ü—‹_im¶
(
o
.
g‘_ty³
());

126 ià(
	go
.
	gim¶
) {

129 
bufã¾i¡
 
	gbl
;

130 
	go
.
	gim¶
->
’code
(
bl
);

131 
	gbufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
begš
();

132 
	gim¶
->
decode
(
p
);

134  *
	gthis
;

137 
	gH™S‘
::
P¬ams
::
	$’code
(
bufã¾i¡
 &
bl
) const

139 
	`ENCODE_START
(1, 1, 
bl
);

140 ià(
im¶
) {

141 
	`’code
((
__u8
)
im¶
->
	`g‘_ty³
(), 
bl
);

142 
im¶
->
	`’code
(
bl
);

144 
	`’code
((
__u8
)
TYPE_NONE
, 
bl
);

146 
	`ENCODE_FINISH
(
bl
);

147 
	}
}

149 
boŞ
 
	gH™S‘
::
P¬ams
::
	$ü—‹_im¶
(
im¶_ty³_t
 
ty³
)

151 (
im¶_ty³_t
)
ty³
) {

152 
TYPE_EXPLICIT_HASH
:

153 
im¶
.
	`»£t
(
Ãw
 
Ex¶ic™HashH™S‘
::
P¬ams
);

155 
TYPE_EXPLICIT_OBJECT
:

156 
im¶
.
	`»£t
(
Ãw
 
Ex¶ic™ObjeùH™S‘
::
P¬ams
);

158 
TYPE_BLOOM
:

159 
im¶
.
	`»£t
(
Ãw
 
BloomH™S‘
::
P¬ams
);

161 
TYPE_NONE
:

162 
im¶
.
	`»£t
(
NULL
);

165  
çl£
;

167  
Œue
;

168 
	}
}

170 
	gH™S‘
::
P¬ams
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

172 
	`DECODE_START
(1, 
bl
);

173 
__u8
 
ty³
;

174 
	`decode
(
ty³
, 
bl
);

175 ià(!
	`ü—‹_im¶
((
im¶_ty³_t
)
ty³
))

176 
throw
 
bufãr
::
	`m®fÜmed_šput
("unrecognized HitMapype");

177 ià(
im¶
)

178 
im¶
->
	`decode
(
bl
);

179 
	`DECODE_FINISH
(
bl
);

180 
	}
}

182 
	gH™S‘
::
P¬ams
::
	$dump
(
FÜm©‹r
 *
f
) const

184 
f
->
	`dump_¡ršg
("ty³", 
H™S‘
::
	`g‘_ty³_Çme
(
	`g‘_ty³
()));

185 ià(
im¶
)

186 
im¶
->
	`dump
(
f
);

187 
	}
}

189 
	gH™S‘
::
P¬ams
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
H™S‘
::P¬ams*>& 
o
)

191 
	#loİ_h™£t_·¿ms
(
kšd
) \

193 
li¡
<
kšd
::
P¬ams
*> 
·¿ms
; \

194 
kšd
::
P¬ams
::
	`g’”©e_‹¡_š¡ªûs
(
·¿ms
); \

195 
li¡
<
kšd
::
P¬ams
*>::
™”©Ü
 
i
 = 
·¿ms
.
	`begš
(); \

196 
i
 !ğ
·¿ms
.
	`’d
(); ++i) \

197 
o
.
	`push_back
(
Ãw
 
	`P¬ams
(*
i
)); \

198 }

	)

199 
	go
.
push_back
(
Ãw
 
P¬ams
);

200 
	go
.
push_back
(
Ãw
 
P¬ams
Òew 
BloomH™S‘
::Params));

201 
loİ_h™£t_·¿ms
(
BloomH™S‘
);

202 
	go
.
push_back
(
Ãw
 
P¬ams
Òew 
Ex¶ic™HashH™S‘
::Params));

203 
loİ_h™£t_·¿ms
(
Ex¶ic™HashH™S‘
);

204 
	go
.
push_back
(
Ãw
 
P¬ams
Òew 
Ex¶ic™ObjeùH™S‘
::Params));

205 
loİ_h™£t_·¿ms
(
Ex¶ic™ObjeùH™S‘
);

208 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gH™S‘
::
P¬ams
& 
p
) {

209 
out
 << 
H™S‘
::
g‘_ty³_Çme
(
p
.
g‘_ty³
());

210 ià(
	gp
.
	gim¶
) {

211 
	gout
 << "{";

212 
	gp
.
	gim¶
->
dump_¡»am
(
out
);

214 
	gout
 << "}";

215  
	gout
;

219 
	gEx¶ic™HashH™S‘
::
	$dump
(
FÜm©‹r
 *
f
) const {

220 
f
->
	`dump_unsigÃd
("š£¹_couÁ", 
couÁ
);

221 
f
->
	`İ’_¬¿y_£ùiÚ
("hash_set");

222 
ûph
::
unÜd”ed_£t
<
ušt32_t
>::
cÚ¡_™”©Ü
 
p
 = 
h™s
.
	`begš
();

223 
p
 !ğ
h™s
.
	`’d
();

224 ++
p
)

225 
f
->
	`dump_unsigÃd
("hash", *
p
);

226 
f
->
	`şo£_£ùiÚ
();

227 
	}
}

229 
	gEx¶ic™ObjeùH™S‘
::
	$dump
(
FÜm©‹r
 *
f
) const {

230 
f
->
	`dump_unsigÃd
("š£¹_couÁ", 
couÁ
);

231 
f
->
	`İ’_¬¿y_£ùiÚ
("set");

232 
ûph
::
unÜd”ed_£t
<
hobjeù_t
>::
cÚ¡_™”©Ü
 
p
 = 
h™s
.
	`begš
();

233 
p
 !ğ
h™s
.
	`’d
();

234 ++
p
) {

235 
f
->
	`İ’_objeù_£ùiÚ
("object");

236 
p
->
	`dump
(
f
);

237 
f
->
	`şo£_£ùiÚ
();

239 
f
->
	`şo£_£ùiÚ
();

240 
	}
}

242 
	gBloomH™S‘
::
P¬ams
::
	$dump
(
FÜm©‹r
 *
f
) const {

243 
f
->
	`dump_æßt
("çl£_pos™ive_´obab™y", 
	`g‘_åp
());

244 
f
->
	`dump_št
("rg‘_size", 
rg‘_size
);

245 
f
->
	`dump_št
("£ed", 
£ed
);

246 
	}
}

248 
	gBloomH™S‘
::
	$dump
(
FÜm©‹r
 *
f
) const {

249 
f
->
	`İ’_objeù_£ùiÚ
("bloom_filter");

250 
bloom
.
	`dump
(
f
);

251 
f
->
	`şo£_£ùiÚ
();

252 
	}
}

	@osd/HitSet.h

15 #iâdeà
CEPH_OSD_HITSET_H


16 
	#CEPH_OSD_HITSET_H


	)

18 
	~<boo¡/scİed_±r.hµ
>

20 
	~"šşude/’codšg.h
"

21 
	~"šşude/unÜd”ed_£t.h
"

22 
	~"commÚ/bloom_f‹r.hµ
"

23 
	~"commÚ/hobjeù.h
"

33 şas 
	cH™S‘
 {

34 
	mpublic
:

36 
TYPE_NONE
 = 0,

37 
	mTYPE_EXPLICIT_HASH
 = 1,

38 
	mTYPE_EXPLICIT_OBJECT
 = 2,

39 
	mTYPE_BLOOM
 = 3

40 } 
	tim¶_ty³_t
;

42 cÚ¡ *
	$g‘_ty³_Çme
(
im¶_ty³_t
 
t
) {

43 
t
) {

44 
TYPE_NONE
:  "none";

45 
TYPE_EXPLICIT_HASH
:  "explicit_hash";

46 
TYPE_EXPLICIT_OBJECT
:  "explicit_object";

47 
TYPE_BLOOM
:  "bloom";

50 
	}
}

51 cÚ¡ *
	$g‘_ty³_Çme
() const {

52 ià(
im¶
)

53  
	`g‘_ty³_Çme
(
im¶
->
	`g‘_ty³
());

54  
	`g‘_ty³_Çme
(
TYPE_NONE
);

55 
	}
}

58 şas 
	cIm¶
 {

59 
	gpublic
:

60 
vœtu®
 
im¶_ty³_t
 
g‘_ty³
() const = 0;

61 
vœtu®
 
boŞ
 
is_fuÎ
() const = 0;

62 
vœtu®
 
š£¹
(cÚ¡ 
hobjeù_t
& 
o
) = 0;

63 
vœtu®
 
boŞ
 
cÚšs
(cÚ¡ 
hobjeù_t
& 
o
) const = 0;

64 
vœtu®
 
š£¹_couÁ
() const = 0;

65 
vœtu®
 
­´ox_unique_š£¹_couÁ
() const = 0;

66 
vœtu®
 
’code
(
bufã¾i¡
 &
bl
) const = 0;

67 
vœtu®
 
decode
(
bufã¾i¡
::
™”©Ü
& 
p
) = 0;

68 
vœtu®
 
dump
(
FÜm©‹r
 *
f
) const = 0;

69 
vœtu®
 
Im¶
* 
şÚe
() const = 0;

70 
vœtu®
 
£®
() {}

71 
	gvœtu®
 ~
Im¶
() {}

74 
	gboo¡
::
scİed_±r
<
Im¶
> 
im¶
;

75 
boŞ
 
	g£®ed
;

77 şas 
	cP¬ams
 {

79 
boŞ
 
ü—‹_im¶
(
im¶_ty³_t
 
t
);

81 
	gpublic
:

82 şas 
	cIm¶
 {

83 
public
:

84 
vœtu®
 
im¶_ty³_t
 
g‘_ty³
() const = 0;

85 
vœtu®
 
	gH™S‘
::
Im¶
 *
g‘_Ãw_im¶
() const = 0;

86 
vœtu®
 
’code
(
bufã¾i¡
 &
bl
) const {}

87 
vœtu®
 
decode
(
bufã¾i¡
::
™”©Ü
& 
p
) {}

88 
vœtu®
 
dump
(
FÜm©‹r
 *
f
) const {}

89 
vœtu®
 
dump_¡»am
(
o¡»am
& 
o
) const {}

90 
vœtu®
 ~
Im¶
() {}

93 
P¬ams
() {}

94 
ex¶ic™
 
P¬ams
(
Im¶
 *
i
è: 
im¶
(i) {}

95 
vœtu®
 ~
P¬ams
() {}

97 
boo¡
::
scİed_±r
<
P¬ams
::
Im¶
> 
im¶
;

99 
im¶_ty³_t
 
g‘_ty³
() const {

100 ià(
	gim¶
)

101  
	gim¶
->
g‘_ty³
();

102  
	gTYPE_NONE
;

105 
P¬ams
(cÚ¡ P¬ams& 
o
);

106 cÚ¡ 
	gP¬ams
& 
	gİ”©Ü
=(cÚ¡ 
P¬ams
& 
o
);

108 
’code
(
bufã¾i¡
 &
bl
) const;

109 
decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

110 
dump
(
FÜm©‹r
 *
f
) const;

111 
g’”©e_‹¡_š¡ªûs
(
li¡
<
H™S‘
::
P¬ams
*>& 
o
);

113 
ä›nd
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gH™S‘
::
P¬ams
& 
p
);

116 
	$H™S‘
(è: 
	`im¶
(
NULL
), 
	$£®ed
(
çl£
è{
	}
}

117 
ex¶ic™
 
	$H™S‘
(
Im¶
 *
i
è: 
	`im¶
(i), 
	$£®ed
(
çl£
è{
	}
}

118 
ex¶ic™
 
H™S‘
(cÚ¡ H™S‘::
P¬ams
& 
·¿ms
);

120 
	$H™S‘
(cÚ¡ 
H™S‘
& 
o
) {

121 
£®ed
 = 
o
.sealed;

122 ià(
o
.
im¶
)

123 
im¶
.
	`»£t
(
o
.im¶->
	`şÚe
());

125 
im¶
.
	`»£t
(
NULL
);

126 
	}
}

127 cÚ¡ 
	gH™S‘
& 
	gİ”©Ü
=(cÚ¡ 
H™S‘
& 
o
) {

128 
£®ed
 = 
o
.sealed;

129 ià(
	go
.
	gim¶
)

130 
	gim¶
.
»£t
(
o
.
im¶
->
şÚe
());

132 
	gim¶
.
»£t
(
NULL
);

133  *
	gthis
;

137 
boŞ
 
	$is_fuÎ
() const {

138  
im¶
->
	`is_fuÎ
();

139 
	}
}

141 
	$š£¹
(cÚ¡ 
hobjeù_t
& 
o
) {

142 
im¶
->
	`š£¹
(
o
);

143 
	}
}

145 
boŞ
 
	$cÚšs
(cÚ¡ 
hobjeù_t
& 
o
) const {

146  
im¶
->
	`cÚšs
(
o
);

147 
	}
}

149 
	$š£¹_couÁ
() const {

150  
im¶
->
	`š£¹_couÁ
();

151 
	}
}

152 
	$­´ox_unique_š£¹_couÁ
() const {

153  
im¶
->
	`­´ox_unique_š£¹_couÁ
();

154 
	}
}

155 
	$£®
() {

156 
	`as£¹
(!
£®ed
);

157 
£®ed
 = 
Œue
;

158 
im¶
->
	`£®
();

159 
	}
}

161 
	$’code
(
bufã¾i¡
 &
bl
) const;

162 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

163 
	$dump
(
FÜm©‹r
 *
f
) const;

164 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
H™S‘
*>& 
o
);

166 
´iv©e
:

167 
	`»£t_to_ty³
(
im¶_ty³_t
 
ty³
);

168 
	}
};

169 
	$WRITE_CLASS_ENCODER
(
H™S‘
)

170 
	$WRITE_CLASS_ENCODER
(
H™S‘
::
P¬ams
)

172 
boo¡
::
	tsh¬ed_±r
<
	tH™S‘
> 
	tH™S‘Ref
;

174 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
H™S‘
::
P¬ams
& 
p
);

179 şas 
	cEx¶ic™HashH™S‘
 : 
public
 
H™S‘
::
Im¶
 {

180 
ušt64_t
 
couÁ
;

181 
ûph
::
unÜd”ed_£t
<
ušt32_t
> 
h™s
;

182 
public
:

183 şas 
	cP¬ams
 : 
public
 
H™S‘
::
P¬ams
::
Im¶
 {

184 
public
:

185 
H™S‘
::
im¶_ty³_t
 
	`g‘_ty³
(ècÚ¡ 
ov”ride
 {

186  
H™S‘
::
TYPE_EXPLICIT_HASH
;

188 
H™S‘
::
Im¶
 *
	`g‘_Ãw_im¶
(ècÚ¡ 
ov”ride
 {

189  
Ãw
 
Ex¶ic™HashH™S‘
;

191 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
P¬ams
*>& 
o
) {

192 
o
.
	`push_back
(
Ãw
 
P¬ams
);

196 
	$Ex¶ic™HashH™S‘
(è: 
	$couÁ
(0è{
	}
}

197 
ex¶ic™
 
	$Ex¶ic™HashH™S‘
(cÚ¡ 
Ex¶ic™HashH™S‘
::
P¬ams
 *
p
è: 
	$couÁ
(0è{
	}
}

198 
	$Ex¶ic™HashH™S‘
(cÚ¡ 
Ex¶ic™HashH™S‘
 &
o
è: 
	`couÁ
(o.
couÁ
),

199 
	$h™s
(
o
.
h™s
è{
	}
}

201 
	gH™S‘
::
Im¶
 *
	$şÚe
(ècÚ¡ 
ov”ride
 {

202  
Ãw
 
	`Ex¶ic™HashH™S‘
(*
this
);

203 
	}
}

205 
	gH™S‘
::
im¶_ty³_t
 
	$g‘_ty³
(ècÚ¡ 
ov”ride
 {

206  
H™S‘
::
TYPE_EXPLICIT_HASH
;

207 
	}
}

208 
boŞ
 
	$is_fuÎ
(ècÚ¡ 
ov”ride
 {

209  
çl£
;

210 
	}
}

211 
	$š£¹
(cÚ¡ 
hobjeù_t
& 
o
è
ov”ride
 {

212 
h™s
.
	`š£¹
(
o
.
	`g‘_hash
());

213 ++
couÁ
;

214 
	}
}

215 
boŞ
 
	$cÚšs
(cÚ¡ 
hobjeù_t
& 
o
ècÚ¡ 
ov”ride
 {

216  
h™s
.
	`couÁ
(
o
.
	`g‘_hash
());

217 
	}
}

218 
	$š£¹_couÁ
(ècÚ¡ 
ov”ride
 {

219  
couÁ
;

220 
	}
}

221 
	$­´ox_unique_š£¹_couÁ
(ècÚ¡ 
ov”ride
 {

222  
h™s
.
	`size
();

223 
	}
}

224 
	$’code
(
bufã¾i¡
 &
bl
ècÚ¡ 
ov”ride
 {

225 
	`ENCODE_START
(1, 1, 
bl
);

226 
	`’code
(
couÁ
, 
bl
);

227 
	`’code
(
h™s
, 
bl
);

228 
	`ENCODE_FINISH
(
bl
);

229 
	}
}

230 
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
è
ov”ride
 {

231 
	`DECODE_START
(1, 
bl
);

232 
	`decode
(
couÁ
, 
bl
);

233 
	`decode
(
h™s
, 
bl
);

234 
	`DECODE_FINISH
(
bl
);

235 
	}
}

236 
	$dump
(
FÜm©‹r
 *
f
ècÚ¡ 
ov”ride
;

237 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
Ex¶ic™HashH™S‘
*>& 
o
) {

238 
o
.
	`push_back
(
Ãw
 
Ex¶ic™HashH™S‘
);

239 
o
.
	`push_back
(
Ãw
 
Ex¶ic™HashH™S‘
);

240 
o
.
	`back
()->
	`š£¹
(
	`hobjeù_t
());

241 
o
.
	`back
()->
	`š£¹
(
	`hobjeù_t
("asdf", "", 
CEPH_NOSNAP
, 123, 1, ""));

242 
o
.
	`back
()->
	`š£¹
(
	`hobjeù_t
("qw”", "", 
CEPH_NOSNAP
, 456, 1, ""));

243 
	}
}

245 
	$WRITE_CLASS_ENCODER
(
Ex¶ic™HashH™S‘
)

250 şas 
	cEx¶ic™ObjeùH™S‘
 : 
public
 
H™S‘
::
Im¶
 {

251 
ušt64_t
 
couÁ
;

252 
ûph
::
unÜd”ed_£t
<
hobjeù_t
> 
h™s
;

253 
public
:

254 şas 
	cP¬ams
 : 
public
 
H™S‘
::
P¬ams
::
Im¶
 {

255 
public
:

256 
H™S‘
::
im¶_ty³_t
 
	`g‘_ty³
(ècÚ¡ 
ov”ride
 {

257  
H™S‘
::
TYPE_EXPLICIT_OBJECT
;

259 
H™S‘
::
Im¶
 *
	`g‘_Ãw_im¶
(ècÚ¡ 
ov”ride
 {

260  
Ãw
 
Ex¶ic™ObjeùH™S‘
;

262 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
P¬ams
*>& 
o
) {

263 
o
.
	`push_back
(
Ãw
 
P¬ams
);

267 
	$Ex¶ic™ObjeùH™S‘
(è: 
	$couÁ
(0è{
	}
}

268 
ex¶ic™
 
	$Ex¶ic™ObjeùH™S‘
(cÚ¡ 
Ex¶ic™ObjeùH™S‘
::
P¬ams
 *
p
è: 
	$couÁ
(0è{
	}
}

269 
	$Ex¶ic™ObjeùH™S‘
(cÚ¡ 
Ex¶ic™ObjeùH™S‘
 &
o
è: 
	`couÁ
(o.
couÁ
),

270 
	$h™s
(
o
.
h™s
è{
	}
}

272 
	gH™S‘
::
Im¶
 *
	$şÚe
(ècÚ¡ 
ov”ride
 {

273  
Ãw
 
	`Ex¶ic™ObjeùH™S‘
(*
this
);

274 
	}
}

276 
	gH™S‘
::
im¶_ty³_t
 
	$g‘_ty³
(ècÚ¡ 
ov”ride
 {

277  
H™S‘
::
TYPE_EXPLICIT_OBJECT
;

278 
	}
}

279 
boŞ
 
	$is_fuÎ
(ècÚ¡ 
ov”ride
 {

280  
çl£
;

281 
	}
}

282 
	$š£¹
(cÚ¡ 
hobjeù_t
& 
o
è
ov”ride
 {

283 
h™s
.
	`š£¹
(
o
);

284 ++
couÁ
;

285 
	}
}

286 
boŞ
 
	$cÚšs
(cÚ¡ 
hobjeù_t
& 
o
ècÚ¡ 
ov”ride
 {

287  
h™s
.
	`couÁ
(
o
);

288 
	}
}

289 
	$š£¹_couÁ
(ècÚ¡ 
ov”ride
 {

290  
couÁ
;

291 
	}
}

292 
	$­´ox_unique_š£¹_couÁ
(ècÚ¡ 
ov”ride
 {

293  
h™s
.
	`size
();

294 
	}
}

295 
	$’code
(
bufã¾i¡
 &
bl
ècÚ¡ 
ov”ride
 {

296 
	`ENCODE_START
(1, 1, 
bl
);

297 
	`’code
(
couÁ
, 
bl
);

298 
	`’code
(
h™s
, 
bl
);

299 
	`ENCODE_FINISH
(
bl
);

300 
	}
}

301 
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
è
ov”ride
 {

302 
	`DECODE_START
(1, 
bl
);

303 
	`decode
(
couÁ
, 
bl
);

304 
	`decode
(
h™s
, 
bl
);

305 
	`DECODE_FINISH
(
bl
);

306 
	}
}

307 
	$dump
(
FÜm©‹r
 *
f
ècÚ¡ 
ov”ride
;

308 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
Ex¶ic™ObjeùH™S‘
*>& 
o
) {

309 
o
.
	`push_back
(
Ãw
 
Ex¶ic™ObjeùH™S‘
);

310 
o
.
	`push_back
(
Ãw
 
Ex¶ic™ObjeùH™S‘
);

311 
o
.
	`back
()->
	`š£¹
(
	`hobjeù_t
());

312 
o
.
	`back
()->
	`š£¹
(
	`hobjeù_t
("asdf", "", 
CEPH_NOSNAP
, 123, 1, ""));

313 
o
.
	`back
()->
	`š£¹
(
	`hobjeù_t
("qw”", "", 
CEPH_NOSNAP
, 456, 1, ""));

314 
	}
}

316 
	$WRITE_CLASS_ENCODER
(
Ex¶ic™ObjeùH™S‘
)

321 şas 
	cBloomH™S‘
 : 
public
 
H™S‘
::
Im¶
 {

322 
com´essibË_bloom_f‹r
 
bloom
;

324 
public
:

325 
H™S‘
::
im¶_ty³_t
 
	$g‘_ty³
(ècÚ¡ 
ov”ride
 {

326  
H™S‘
::
TYPE_BLOOM
;

329 şas 
	cP¬ams
 : 
public
 
H™S‘
::
P¬ams
::
Im¶
 {

330 
public
:

331 
H™S‘
::
im¶_ty³_t
 
	`g‘_ty³
(ècÚ¡ 
ov”ride
 {

332  
H™S‘
::
TYPE_BLOOM
;

334 
H™S‘
::
Im¶
 *
	`g‘_Ãw_im¶
(ècÚ¡ 
ov”ride
 {

335  
Ãw
 
BloomH™S‘
;

338 
ušt32_t
 
åp_miüo
;

339 
ušt64_t
 
rg‘_size
;

340 
ušt64_t
 
£ed
;

342 
	`P¬ams
()

343 : 
	`åp_miüo
(0), 
	`rg‘_size
(0), 
	`£ed
(0) {}

344 
	`P¬ams
(
åp
, 
ušt64_t
 
t
, ušt64_ˆ
s
)

345 : 
	`åp_miüo
(
åp
 * 1000000.0), 
	`rg‘_size
(
t
), 
	`£ed
(
s
) {}

346 
	`P¬ams
(cÚ¡ 
P¬ams
 &
o
)

347 : 
	`åp_miüo
(
o
.
åp_miüo
),

348 
	`rg‘_size
(
o
.
rg‘_size
),

349 
	`£ed
(
o
.
£ed
) {}

350 ~
	`P¬ams
(è
ov”ride
 {}

352 
	`g‘_åp
() const {

353  ()
åp_miüo
 / 1000000.0;

355 
	`£t_åp
(
f
) {

356 
åp_miüo
 = ()(
	`Îrš
(
f
 * 1000000.0));

359 
	`’code
(
bufã¾i¡
& 
bl
ècÚ¡ 
ov”ride
 {

360 
	`ENCODE_START
(1, 1, 
bl
);

361 
	`’code
(
åp_miüo
, 
bl
);

362 
	`’code
(
rg‘_size
, 
bl
);

363 
	`’code
(
£ed
, 
bl
);

364 
	`ENCODE_FINISH
(
bl
);

366 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
bl
è
ov”ride
 {

367 
	`DECODE_START
(1, 
bl
);

368 
	`decode
(
åp_miüo
, 
bl
);

369 
	`decode
(
rg‘_size
, 
bl
);

370 
	`decode
(
£ed
, 
bl
);

371 
	`DECODE_FINISH
(
bl
);

373 
	`dump
(
FÜm©‹r
 *
f
ècÚ¡ 
ov”ride
;

374 
	`dump_¡»am
(
o¡»am
& 
o
ècÚ¡ 
ov”ride
 {

375 
o
 << "false_positive_probability: "

376 << 
	`g‘_åp
(è<< ",¬g‘_size: " << 
rg‘_size


377 << ", s“d: " << 
£ed
;

379 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
P¬ams
*>& 
o
) {

380 
o
.
	`push_back
(
Ãw
 
P¬ams
);

381 
o
.
	`push_back
(
Ãw
 
P¬ams
);

382 (*
o
.
	`rbegš
())->
åp_miüo
 = 123456;

383 (*
o
.
	`rbegš
())->
rg‘_size
 = 300;

384 (*
o
.
	`rbegš
())->
£ed
 = 99;

386 
	}
};

388 
	$BloomH™S‘
(è{
	}
}

389 
	$BloomH™S‘
(
š£¹s
, 
åp
, 
£ed
)

390 : 
	$bloom
(
š£¹s
, 
åp
, 
£ed
)

391 {
	}
}

392 
ex¶ic™
 
	$BloomH™S‘
(cÚ¡ 
BloomH™S‘
::
P¬ams
 *
p
è: 
	`bloom
Õ->
rg‘_size
,

393 
p
->
	`g‘_åp
(),

394 
p
->
£ed
)

395 {
	}
}

397 
	$BloomH™S‘
(cÚ¡ 
BloomH™S‘
 &
o
) {

399 
bufã¾i¡
 
bl
;

400 
o
.
	`’code
(
bl
);

401 
bufã¾i¡
::
™”©Ü
 
bli
 = 
bl
.
	`begš
();

402 
this
->
	`decode
(
bli
);

403 
	}
}

405 
	gH™S‘
::
Im¶
 *
	$şÚe
(ècÚ¡ 
ov”ride
 {

406  
Ãw
 
	`BloomH™S‘
(*
this
);

407 
	}
}

409 
boŞ
 
	$is_fuÎ
(ècÚ¡ 
ov”ride
 {

410  
bloom
.
	`is_fuÎ
();

411 
	}
}

413 
	$š£¹
(cÚ¡ 
hobjeù_t
& 
o
è
ov”ride
 {

414 
bloom
.
	`š£¹
(
o
.
	`g‘_hash
());

415 
	}
}

416 
boŞ
 
	$cÚšs
(cÚ¡ 
hobjeù_t
& 
o
ècÚ¡ 
ov”ride
 {

417  
bloom
.
	`cÚšs
(
o
.
	`g‘_hash
());

418 
	}
}

419 
	$š£¹_couÁ
(ècÚ¡ 
ov”ride
 {

420  
bloom
.
	`–em’t_couÁ
();

421 
	}
}

422 
	$­´ox_unique_š£¹_couÁ
(ècÚ¡ 
ov”ride
 {

423  
bloom
.
	`­´ox_unique_–em’t_couÁ
();

424 
	}
}

425 
	$£®
(è
ov”ride
 {

427 
pc
 = 
bloom
.
	`d’s™y
() * 2.0;

428 ià(
pc
 < 1.0)

429 
bloom
.
	`com´ess
(
pc
);

430 
	}
}

432 
	$’code
(
bufã¾i¡
 &
bl
ècÚ¡ 
ov”ride
 {

433 
	`ENCODE_START
(1, 1, 
bl
);

434 
	`’code
(
bloom
, 
bl
);

435 
	`ENCODE_FINISH
(
bl
);

436 
	}
}

437 
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
è
ov”ride
 {

438 
	`DECODE_START
(1, 
bl
);

439 
	`decode
(
bloom
, 
bl
);

440 
	`DECODE_FINISH
(
bl
);

441 
	}
}

442 
	$dump
(
FÜm©‹r
 *
f
ècÚ¡ 
ov”ride
;

443 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
BloomH™S‘
*>& 
o
) {

444 
o
.
	`push_back
(
Ãw
 
BloomH™S‘
);

445 
o
.
	`push_back
(
Ãw
 
	`BloomH™S‘
(10, .1, 1));

446 
o
.
	`back
()->
	`š£¹
(
	`hobjeù_t
());

447 
o
.
	`back
()->
	`š£¹
(
	`hobjeù_t
("asdf", "", 
CEPH_NOSNAP
, 123, 1, ""));

448 
o
.
	`back
()->
	`š£¹
(
	`hobjeù_t
("qw”", "", 
CEPH_NOSNAP
, 456, 1, ""));

449 
	}
}

451 
	$WRITE_CLASS_ENCODER
(
BloomH™S‘
)

	@osd/OSD.cc

16 
	~"accÚfig.h
"

18 
	~<û¼no
>

19 
	~<cùy³
>

20 
	~<f¡»am
>

21 
	~<io¡»am
>

22 
	~<®gÜ™hm
>

24 
	~<ex³rim’l/™”©Ü
>

26 
	~<uni¡d.h
>

28 
	~<sys/¡©.h
>

29 
	~<sigÇl.h
>

30 
	~<boo¡/scİed_±r.hµ
>

32 #ifdeà
HAVE_SYS_PARAM_H


33 
	~<sys/·¿m.h
>

36 #ifdeà
HAVE_SYS_MOUNT_H


37 
	~<sys/mouÁ.h
>

40 
	~"osd/PG.h
"

42 
	~"šşude/ty³s.h
"

43 
	~"šşude/com·t.h
"

45 
	~"OSD.h
"

46 
	~"OSDM­.h
"

47 
	~"W©ch.h
"

48 
	~"osdc/Objeù”.h
"

50 
	~"commÚ/”ºo.h
"

51 
	~"commÚ/ûph_¬g·r£.h
"

52 
	~"commÚ/ûph_time.h
"

53 
	~"commÚ/v”siÚ.h
"

54 
	~"commÚ/pick_add»ss.h
"

55 
	~"commÚ/SubProûss.h
"

56 
	~"commÚ/PlugšRegi¡ry.h
"

58 
	~"os/ObjeùStÜe.h
"

59 #ifdeà
HAVE_LIBFUSE


60 
	~"os/Fu£StÜe.h
"

63 
	~"Prim¬yLogPG.h
"

65 
	~"msg/Mes£ng”.h
"

66 
	~"msg/Mes§ge.h
"

68 
	~"mÚ/MÚCl›Á.h
"

70 
	~"mes§ges/MLog.h
"

72 
	~"mes§ges/MG’”icMes§ge.h
"

73 
	~"mes§ges/MOSDPšg.h
"

74 
	~"mes§ges/MOSDFau».h
"

75 
	~"mes§ges/MOSDM¬kMeDown.h
"

76 
	~"mes§ges/MOSDFuÎ.h
"

77 
	~"mes§ges/MOSDOp.h
"

78 
	~"mes§ges/MOSDOpR•ly.h
"

79 
	~"mes§ges/MOSDBackoff.h
"

80 
	~"mes§ges/MOSDB—cÚ.h
"

81 
	~"mes§ges/MOSDR•Op.h
"

82 
	~"mes§ges/MOSDR•OpR•ly.h
"

83 
	~"mes§ges/MOSDBoÙ.h
"

84 
	~"mes§ges/MOSDPGTemp.h
"

86 
	~"mes§ges/MOSDM­.h
"

87 
	~"mes§ges/MMÚG‘OSDM­.h
"

88 
	~"mes§ges/MOSDPGNÙify.h
"

89 
	~"mes§ges/MOSDPGQu”y.h
"

90 
	~"mes§ges/MOSDPGLog.h
"

91 
	~"mes§ges/MOSDPGRemove.h
"

92 
	~"mes§ges/MOSDPGInfo.h
"

93 
	~"mes§ges/MOSDPGC»©e.h
"

94 
	~"mes§ges/MOSDPGC»©e2.h
"

95 
	~"mes§ges/MOSDPGTrim.h
"

96 
	~"mes§ges/MOSDPGSÿn.h
"

97 
	~"mes§ges/MBackflRe£rve.h
"

98 
	~"mes§ges/MRecov”yRe£rve.h
"

99 
	~"mes§ges/MOSDFÜûRecov”y.h
"

100 
	~"mes§ges/MOSDECSubOpWr™e.h
"

101 
	~"mes§ges/MOSDECSubOpWr™eR•ly.h
"

102 
	~"mes§ges/MOSDECSubOpR—d.h
"

103 
	~"mes§ges/MOSDECSubOpR—dR•ly.h
"

104 
	~"mes§ges/MOSDPGC»©ed.h
"

105 
	~"mes§ges/MOSDPGUpd©eLogMissšg.h
"

106 
	~"mes§ges/MOSDPGUpd©eLogMissšgR•ly.h
"

108 
	~"mes§ges/MOSDP“ršgOp.h
"

110 
	~"mes§ges/MOSDAlive.h
"

112 
	~"mes§ges/MOSDSüub.h
"

113 
	~"mes§ges/MOSDSüub2.h
"

114 
	~"mes§ges/MOSDR•Süub.h
"

116 
	~"mes§ges/MMÚCommªd.h
"

117 
	~"mes§ges/MCommªd.h
"

118 
	~"mes§ges/MCommªdR•ly.h
"

120 
	~"mes§ges/MPGSts.h
"

121 
	~"mes§ges/MPGStsAck.h
"

123 
	~"mes§ges/MW©chNÙify.h
"

124 
	~"mes§ges/MOSDPGPush.h
"

125 
	~"mes§ges/MOSDPGPushR•ly.h
"

126 
	~"mes§ges/MOSDPGPuÎ.h
"

128 
	~"commÚ/³rf_couÁ”s.h
"

129 
	~"commÚ/Tim”.h
"

130 
	~"commÚ/LogCl›Á.h
"

131 
	~"commÚ/AsyncRe£rv”.h
"

132 
	~"commÚ/H—¹b—tM­.h
"

133 
	~"commÚ/admš_sock‘.h
"

134 
	~"commÚ/ûph_cÚ‹xt.h
"

136 
	~"glob®/sigÇl_hªdËr.h
"

137 
	~"glob®/pidfe.h
"

139 
	~"šşude/cŞÜ.h
"

140 
	~"³rfglue/ıu_´of”.h
"

141 
	~"³rfglue/h—p_´of”.h
"

143 
	~"osd/OpReque¡.h
"

145 
	~"auth/AuthAuthÜizeHªdËr.h
"

146 
	~"auth/RÙ©šgKeyRšg.h
"

148 
	~"objşass/objşass.h
"

150 
	~"commÚ/cmd·r£.h
"

151 
	~"šşude/¡r_li¡.h
"

152 
	~"šşude/ut.h
"

154 
	~"šşude/as£¹.h
"

155 
	~"commÚ/cÚfig.h
"

156 
	~"commÚ/Ev’tT¿û.h
"

158 
	~"jsÚ_¥œ™/jsÚ_¥œ™_»ad”.h
"

159 
	~"jsÚ_¥œ™/jsÚ_¥œ™_wr™”.h
"

161 #ifdeà
WITH_LTTNG


162 
	#TRACEPOINT_DEFINE


	)

163 
	#TRACEPOINT_PROBE_DYNAMIC_LINKAGE


	)

164 
	~"Œacšg/osd.h
"

165 #undeà
TRACEPOINT_PROBE_DYNAMIC_LINKAGE


166 #undeà
TRACEPOINT_DEFINE


168 
	#Œaûpošt
(...)

	)

171 
	#dout_cÚ‹xt
 
cù


	)

172 
	#dout_subsys
 
ûph_subsys_osd


	)

173 #undeà
dout_´efix


174 
	#dout_´efix
 
	`_´efix
(
_dout
, 
whßmi
, 
	`g‘_osdm­_•och
())

	)

177 cÚ¡ 
	gOSD
::
OSD_TICK_INTERVAL
 = 1.0;

179 
	go¡»am
& 
	$_´efix
(
¡d
::
o¡»am
* 
_dout
, 
whßmi
, 
•och_t
 
•och
) {

180  *
_dout
 << "osd." << 
whßmi
 << " " << 
•och
 << " ";

181 
	}
}

185 
Com·tS‘
 
	gOSD
::
	$g‘_osd_š™Ÿl_com·t_£t
() {

186 
Com·tS‘
::
F—tu»S‘
 
ûph_osd_ã©u»_com·t
;

187 
Com·tS‘
::
F—tu»S‘
 
ûph_osd_ã©u»_ro_com·t
;

188 
Com·tS‘
::
F—tu»S‘
 
ûph_osd_ã©u»_šcom·t
;

189 
ûph_osd_ã©u»_šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_BASE
);

190 
ûph_osd_ã©u»_šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_PGINFO
);

191 
ûph_osd_ã©u»_šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_OLOC
);

192 
ûph_osd_ã©u»_šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_LEC
);

193 
ûph_osd_ã©u»_šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_CATEGORIES
);

194 
ûph_osd_ã©u»_šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_HOBJECTPOOL
);

195 
ûph_osd_ã©u»_šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_BIGINFO
);

196 
ûph_osd_ã©u»_šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_LEVELDBINFO
);

197 
ûph_osd_ã©u»_šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_LEVELDBLOG
);

198 
ûph_osd_ã©u»_šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_SNAPMAPPER
);

199 
ûph_osd_ã©u»_šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_HINTS
);

200 
ûph_osd_ã©u»_šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_PGMETA
);

201 
ûph_osd_ã©u»_šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_MISSING
);

202 
ûph_osd_ã©u»_šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_FASTINFO
);

203 
ûph_osd_ã©u»_šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_RECOVERY_DELETES
);

204  
	`Com·tS‘
(
ûph_osd_ã©u»_com·t
, 
ûph_osd_ã©u»_ro_com·t
,

205 
ûph_osd_ã©u»_šcom·t
);

206 
	}
}

209 
Com·tS‘
 
	gOSD
::
	$g‘_osd_com·t_£t
() {

210 
Com·tS‘
 
com·t
 = 
	`g‘_osd_š™Ÿl_com·t_£t
();

212 
com·t
.
šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_SHARDS
);

213  
com·t
;

214 
	}
}

216 
	gOSDS”viû
::
	$OSDS”viû
(
OSD
 *
osd
) :

217 
	`osd
(
osd
),

218 
	`cù
(
osd
->
cù
),

219 
	`whßmi
(
osd
->
whßmi
), 
	`¡Üe
(osd->
¡Üe
),

220 
	`log_ş›Á
(
osd
->
log_ş›Á
), 
	`şog
(osd->
şog
),

221 
	`pg_»cov”y_¡©s
(
osd
->
pg_»cov”y_¡©s
),

222 
	`şu¡”_mes£ng”
(
osd
->
şu¡”_mes£ng”
),

223 
	`ş›Á_mes£ng”
(
osd
->
ş›Á_mes£ng”
),

224 
	`logg”
(
osd
->
logg”
),

225 
	`»cov”y¡©e_³rf
(
osd
->
»cov”y¡©e_³rf
),

226 
	`mÚc
(
osd
->
mÚc
),

227 
	`şass_hªdËr
(
osd
->
şass_hªdËr
),

228 
	`osd_max_objeù_size
(*
cù
->
_cÚf
, "osd_max_object_size"),

229 
	`osd_sk_d©a_dige¡
(*
cù
->
_cÚf
, "osd_skip_data_digest"),

230 
	`publish_lock
("OSDService::publish_lock"),

231 
	`´e_publish_lock
("OSDService::pre_publish_lock"),

232 
	`max_Şde¡_m­
(0),

233 
	`³”_m­_•och_lock
("OSDService::peer_map_epoch_lock"),

234 
	`sched_süub_lock
("OSDS”viû::sched_süub_lock"), 
	`süubs_³ndšg
(0),

235 
	`süubs_aùive
(0),

236 
	`ag’t_lock
("OSDService::agent_lock"),

237 
	`ag’t_v®id_™”©Ü
(
çl£
),

238 
	`ag’t_İs
(0),

239 
	`æush_mode_high_couÁ
(0),

240 
	`ag’t_aùive
(
Œue
),

241 
	`ag’t_th»ad
(
this
),

242 
	`ag’t_¡İ_æag
(
çl£
),

243 
	`ag’t_tim”_lock
("OSDService::agent_timer_lock"),

244 
	`ag’t_tim”
(
osd
->
ş›Á_mes£ng”
->
cù
, 
ag’t_tim”_lock
),

245 
	`Ï¡_»ÿlib¿‹
(
	`ûph_şock_now
()),

246 
	`´omÙe_max_objeùs
(0),

247 
	`´omÙe_max_by‹s
(0),

248 
	`objeù”
(
Ãw
 
	`Objeù”
(
osd
->
ş›Á_mes£ng”
->
cù
, osd->
objeù”_mes£ng”
, osd->
mÚc
, 
NULL
, 0, 0)),

249 
	`m_objeù”_fšish”s
(
cù
->
_cÚf
->
osd_objeù”_fšish”s
),

250 
	`w©ch_lock
("OSDService::watch_lock"),

251 
	`w©ch_tim”
(
osd
->
ş›Á_mes£ng”
->
cù
, 
w©ch_lock
),

252 
	`Ãxt_nÙif_id
(0),

253 
	`»cov”y_»que¡_lock
("OSDService::recovery_request_lock"),

254 
	`»cov”y_»que¡_tim”
(
cù
, 
»cov”y_»que¡_lock
, 
çl£
),

255 
	`»cov”y_¦“p_lock
("OSDService::recovery_sleep_lock"),

256 
	`»cov”y_¦“p_tim”
(
cù
, 
»cov”y_¦“p_lock
, 
çl£
),

257 
	`»£rv”_fšish”
(
cù
),

258 
	`loÿl_»£rv”
(
cù
, &
»£rv”_fšish”
, cù->
_cÚf
->
osd_max_backfls
,

259 
cù
->
_cÚf
->
osd_mš_»cov”y_´iÜ™y
),

260 
	`»mÙe_»£rv”
(
cù
, &
»£rv”_fšish”
, cù->
_cÚf
->
osd_max_backfls
,

261 
cù
->
_cÚf
->
osd_mš_»cov”y_´iÜ™y
),

262 
	`pg_‹mp_lock
("OSDService::pg_temp_lock"),

263 
	`¢­_¦“p_lock
("OSDService::snap_sleep_lock"),

264 
	`¢­_¦“p_tim”
(

265 
osd
->
ş›Á_mes£ng”
->
cù
, 
¢­_¦“p_lock
, 
çl£
 ),

266 
	`süub_¦“p_lock
("OSDService::scrub_sleep_lock"),

267 
	`süub_¦“p_tim”
(

268 
osd
->
ş›Á_mes£ng”
->
cù
, 
süub_¦“p_lock
, 
çl£
 ),

269 
	`¢­_»£rv”
(
cù
, &
»£rv”_fšish”
,

270 
cù
->
_cÚf
->
osd_max_Œimmšg_pgs
),

271 
	`»cov”y_lock
("OSDService::recovery_lock"),

272 
	`»cov”y_İs_aùive
(0),

273 
	`»cov”y_İs_»£rved
(0),

274 
	`»cov”y_·u£d
(
çl£
),

275 
	`m­_ÿche_lock
("OSDService::map_cache_lock"),

276 
	`m­_ÿche
(
cù
, cù->
_cÚf
->
osd_m­_ÿche_size
),

277 
	`m­_bl_ÿche
(
cù
->
_cÚf
->
osd_m­_ÿche_size
),

278 
	`m­_bl_šc_ÿche
(
cù
->
_cÚf
->
osd_m­_ÿche_size
),

279 
	`¡©_lock
("OSDService::stat_lock"),

280 
	`fuÎ_¡©us_lock
("OSDService::full_status_lock"),

281 
	`cur_¡©e
(
NONE
),

282 
	`cur_¿tio
(0),

283 
	`•och_lock
("OSDService::epoch_lock"),

284 
	`boÙ_•och
(0), 
	`up_•och
(0), 
	`bšd_•och
(0),

285 
	`is_¡İpšg_lock
("OSDService::is_stopping_lock")

286 #ifdeà
PG_DEBUG_REFS


287 , 
	`pgid_lock
("OSDService::pgid_lock")

290 
objeù”
->
	`š™
();

292 
i
 = 0; i < 
m_objeù”_fšish”s
; i++) {

293 
o¡ršg¡»am
 
¡r
;

294 
¡r
 << "objeù”-fšish”-" << 
i
;

295 
Fšish”
 *
fš
 = 
Ãw
 
	`Fšish”
(
osd
->
ş›Á_mes£ng”
->
cù
, 
¡r
.
	`¡r
(), "finisher");

296 
objeù”_fšish”s
.
	`push_back
(
fš
);

298 
	}
}

300 
	gOSDS”viû
::~
	$OSDS”viû
()

302 
d–‘e
 
objeù”
;

304 autØ
f
 : 
objeù”_fšish”s
) {

305 
d–‘e
 
f
;

306 
f
 = 
NULL
;

308 
	}
}

312 #ifdeà
PG_DEBUG_REFS


313 
	gOSDS”viû
::
	$add_pgid
(
¥g_t
 
pgid
, 
PG
 *
pg
){

314 
Mu‹x
::
Lock”
 
	`l
(
pgid_lock
);

315 ià(!
pgid_Œack”
.
	`couÁ
(
pgid
)) {

316 
live_pgs
[
pgid
] = 
pg
;

318 
pgid_Œack”
[
pgid
]++;

319 
	}
}

320 
	gOSDS”viû
::
	$»move_pgid
(
¥g_t
 
pgid
, 
PG
 *
pg
)

322 
Mu‹x
::
Lock”
 
	`l
(
pgid_lock
);

323 
	`as£¹
(
pgid_Œack”
.
	`couÁ
(
pgid
));

324 
	`as£¹
(
pgid_Œack”
[
pgid
] > 0);

325 
pgid_Œack”
[
pgid
]--;

326 ià(
pgid_Œack”
[
pgid
] == 0) {

327 
pgid_Œack”
.
	`”a£
(
pgid
);

328 
live_pgs
.
	`”a£
(
pgid
);

330 
	}
}

331 
	gOSDS”viû
::
	$dump_live_pgids
()

333 
Mu‹x
::
Lock”
 
	`l
(
pgid_lock
);

334 
d”r
 << "livpgids:" << 
d’dl
;

335 
m­
<
¥g_t
, >::
cÚ¡_™”©Ü
 
i
 = 
pgid_Œack”
.
	`cbegš
();

336 
i
 !ğ
pgid_Œack”
.
	`ûnd
();

337 ++
i
) {

338 
d”r
 << "\t" << *
i
 << 
d’dl
;

339 
live_pgs
[
i
->
fœ¡
]->
	`dump_live_ids
();

341 
	}
}

346 
	gOSDS”viû
::
id’tify_¥l™_chd»n
(

347 
OSDM­Ref
 
Şd_m­
,

348 
OSDM­Ref
 
Ãw_m­
,

349 
¥g_t
 
pgid
,

350 
£t
<
¥g_t
> *
Ãw_chd»n
)

352 ià(!
	gŞd_m­
->
have_pg_poŞ
(
pgid
.
poŞ
())) {

355 
	gŞd_pgnum
 = 
Şd_m­
->
g‘_pg_num
(
pgid
.
poŞ
());

356 
	gÃw_pgnum
 = 
g‘_possibly_d–‘ed_poŞ_pg_num
(

357 
Ãw_m­
, 
pgid
.
poŞ
());

358 
dout
(20è<< 
	g__func__
 << " old " << 
	gŞd_pgnum
 << "ƒ" << 
	gŞd_m­
->
g‘_•och
()

359 << "‚ew " << 
	gÃw_pgnum
 << "ƒ" << 
	gÃw_m­
->
g‘_•och
()

360 << 
	gd’dl
;

361 ià(
	gpgid
.
ps
(è< 
	g¡©ic_ÿ¡
<>(
	gŞd_pgnum
)) {

362 
	g£t
<
	g¥g_t
> 
	gchd»n
;

363 ià(
	gpgid
.
is_¥l™
(
Şd_pgnum
, 
Ãw_pgnum
, &
chd»n
)) {

364 
dout
(20è<< 
	g__func__
 << " " << 
	gpgid
 << " chd»À" << 
	gchd»n
 << 
	gd’dl
;

365 
	gÃw_chd»n
->
š£¹
(
chd»n
.
begš
(), chd»n.
’d
());

367 } ià(
	gpgid
.
ps
(è>ğ
¡©ic_ÿ¡
<>(
Ãw_pgnum
)) {

368 
dout
(20è<< 
__func__
 << " " << 
pgid
 << " i po¡-¥l™, skpšg" << 
d’dl
;

374 
	gOSDS”viû
::
	$Ãed_h—¹b—t_³”_upd©e
()

376 
osd
->
	`Ãed_h—¹b—t_³”_upd©e
();

377 
	}
}

379 
	gOSDS”viû
::
	$¡¬t_shutdown
()

382 
Mu‹x
::
Lock”
 
	`l
(
ag’t_tim”_lock
);

383 
ag’t_tim”
.
	`shutdown
();

387 
Mu‹x
::
Lock”
 
	`l
(
»cov”y_¦“p_lock
);

388 
»cov”y_¦“p_tim”
.
	`shutdown
();

390 
	}
}

392 
	gOSDS”viû
::
	$shutdown_»£rv”
()

394 
»£rv”_fšish”
.
	`wa™_fÜ_em±y
();

395 
»£rv”_fšish”
.
	`¡İ
();

396 
	}
}

398 
	gOSDS”viû
::
	$shutdown
()

401 
Mu‹x
::
Lock”
 
	`l
(
w©ch_lock
);

402 
w©ch_tim”
.
	`shutdown
();

405 
objeù”
->
	`shutdown
();

406 autØ
f
 : 
objeù”_fšish”s
) {

407 
f
->
	`wa™_fÜ_em±y
();

408 
f
->
	`¡İ
();

412 
Mu‹x
::
Lock”
 
	`l
(
»cov”y_»que¡_lock
);

413 
»cov”y_»que¡_tim”
.
	`shutdown
();

417 
Mu‹x
::
Lock”
 
	`l
(
¢­_¦“p_lock
);

418 
¢­_¦“p_tim”
.
	`shutdown
();

422 
Mu‹x
::
Lock”
 
	`l
(
süub_¦“p_lock
);

423 
süub_¦“p_tim”
.
	`shutdown
();

426 
osdm­
 = 
	`OSDM­Ref
();

427 
Ãxt_osdm­
 = 
	`OSDM­Ref
();

428 
	}
}

430 
	gOSDS”viû
::
	$š™
()

432 
»£rv”_fšish”
.
	`¡¬t
();

433 autØ
f
 : 
objeù”_fšish”s
) {

434 
f
->
	`¡¬t
();

436 
objeù”
->
	`£t_ş›Á_šÿº©iÚ
(0);

439 
objeù”
->
	`g‘_logg”
()->
	`£t_´io_adju¡
(-3);

441 
w©ch_tim”
.
	`š™
();

442 
ag’t_tim”
.
	`š™
();

443 
¢­_¦“p_tim”
.
	`š™
();

444 
süub_¦“p_tim”
.
	`š™
();

446 
ag’t_th»ad
.
	`ü—‹
("osd_srv_agent");

448 ià(
cù
->
_cÚf
->
osd_»cov”y_d–ay_¡¬t
)

449 
	`deãr_»cov”y
(
cù
->
_cÚf
->
osd_»cov”y_d–ay_¡¬t
);

450 
	}
}

452 
	gOSDS”viû
::
	$fš®_š™
()

454 
objeù”
->
	`¡¬t
(
osdm­
.
	`g‘
());

455 
	}
}

457 
	gOSDS”viû
::
	$aùiv©e_m­
()

460 
ag’t_lock
.
	`Lock
();

461 
ag’t_aùive
 =

462 !
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_NOTIERAGENT
) &&

463 
osd
->
	`is_aùive
();

464 
ag’t_cÚd
.
	`SigÇl
();

465 
ag’t_lock
.
	`UÆock
();

466 
	}
}

468 
	gOSDS”viû
::
	$»que¡_osdm­_upd©e
(
•och_t
 
e
)

470 
osd
->
	`osdm­_subsüibe
(
e
, 
çl£
);

471 
	}
}

473 şas 
	cAg’tTimeoutCB
 : 
public
 
CÚ‹xt
 {

474 
PGRef
 
pg
;

475 
	mpublic
:

476 
ex¶ic™
 
	$Ag’tTimeoutCB
(
PGRef
 
_pg
è: 
	$pg
(
_pg
) {}

477 
	$fšish
(è
ov”ride
 {

478 
pg
->
	`ag’t_choo£_mode_»¡¬t
();

479 
	}
}

482 
	gOSDS”viû
::
	$ag’t_’Œy
()

484 
	`dout
(10è<< 
__func__
 << " s¹" << 
d’dl
;

485 
ag’t_lock
.
	`Lock
();

487 !
ag’t_¡İ_æag
) {

488 ià(
ag’t_queue
.
	`em±y
()) {

489 
	`dout
(20è<< 
__func__
 << "ƒm±y queue" << 
d’dl
;

490 
ag’t_cÚd
.
	`Wa™
(
ag’t_lock
);

493 
ušt64_t
 
Ëv–
 = 
ag’t_queue
.
	`rbegš
()->
fœ¡
;

494 
£t
<
PGRef
>& 
tİ
 = 
ag’t_queue
.
	`rbegš
()->
£cÚd
;

495 
	`dout
(10è<< 
__func__


496 << "›r " << 
ag’t_queue
.
	`size
()

497 << ",İ i " << 
Ëv–


498 << " w™h…g " << 
tİ
.
	`size
()

499 << ", op " << 
ag’t_İs
 << "/"

500 << 
cù
->
_cÚf
->
osd_ag’t_max_İs


501 << (
ag’t_aùive
 ? "‡ctive" : " NOT ACTIVE")

502 << 
d’dl
;

503 
	`dout
(20è<< 
__func__
 << " oid " << 
ag’t_oids
 << 
d’dl
;

504 
max
 = 
cù
->
_cÚf
->
osd_ag’t_max_İs
 - 
ag’t_İs
;

505 
ag’t_æush_quÙa
 = 
max
;

506 ià(!
æush_mode_high_couÁ
)

507 
ag’t_æush_quÙa
 = 
cù
->
_cÚf
->
osd_ag’t_max_low_İs
 - 
ag’t_İs
;

508 ià(
ag’t_æush_quÙa
 <ğ0 || 
tİ
.
	`em±y
(è|| !
ag’t_aùive
) {

509 
ag’t_cÚd
.
	`Wa™
(
ag’t_lock
);

513 ià(!
ag’t_v®id_™”©Ü
 || 
ag’t_queue_pos
 =ğ
tİ
.
	`’d
()) {

514 
ag’t_queue_pos
 = 
tİ
.
	`begš
();

515 
ag’t_v®id_™”©Ü
 = 
Œue
;

517 
PGRef
 
pg
 = *
ag’t_queue_pos
;

518 
	`dout
(10è<< "high_couÁ " << 
æush_mode_high_couÁ


519 << "‡g’t_İ " << 
ag’t_İs


520 << " flush_quÙ¨" << 
ag’t_æush_quÙa
 << 
d’dl
;

521 
ag’t_lock
.
	`UÆock
();

522 ià(!
pg
->
	`ag’t_wÜk
(
max
, 
ag’t_æush_quÙa
)) {

523 
	`dout
(10è<< 
__func__
 << " " << 
pg
->
pg_id


524 << "‚Øag’t_wÜk, d–ay fÜ " << 
cù
->
_cÚf
->
osd_ag’t_d–ay_time


525 << " secÚds" << 
d’dl
;

527 
osd
->
logg”
->
	`šc
(
l_osd_t›r_d–ay
);

529 
ag’t_tim”_lock
.
	`Lock
();

530 
CÚ‹xt
 *
cb
 = 
Ãw
 
	`Ag’tTimeoutCB
(
pg
);

531 
ag’t_tim”
.
	`add_ev’t_aá”
(
cù
->
_cÚf
->
osd_ag’t_d–ay_time
, 
cb
);

532 
ag’t_tim”_lock
.
	`UÆock
();

534 
ag’t_lock
.
	`Lock
();

536 
ag’t_lock
.
	`UÆock
();

537 
	`dout
(10è<< 
__func__
 << " fšish" << 
d’dl
;

538 
	}
}

540 
	gOSDS”viû
::
	$ag’t_¡İ
()

543 
Mu‹x
::
Lock”
 
	`l
(
ag’t_lock
);

546 
	`as£¹
(
ag’t_İs
 == 0);

548 ià(!
ag’t_queue
.
	`em±y
()) {

549 
£t
<
PGRef
>& 
tİ
 = 
ag’t_queue
.
	`rbegš
()->
£cÚd
;

550 
d”r
 << "ag’ˆqueunÙƒm±y, fÜƒxam¶" << (*
tİ
.
	`begš
())->
	`g‘_pgid
(è<< 
d’dl
;

551 
	`as£¹
(0 == "agent queue‚otƒmpty");

554 
ag’t_¡İ_æag
 = 
Œue
;

555 
ag’t_cÚd
.
	`SigÇl
();

557 
ag’t_th»ad
.
	`još
();

558 
	}
}

562 
	gOSDS”viû
::
	$´omÙe_thrÙe_»ÿlib¿‹
()

564 
utime_t
 
now
 = 
	`ûph_şock_now
();

565 
dur
 = 
now
 - 
Ï¡_»ÿlib¿‹
;

566 
Ï¡_»ÿlib¿‹
 = 
now
;

567 
´ob
 = 
´omÙe_´obab™y_mlis
;

569 
ušt64_t
 
rg‘_obj_£c
 = 
cù
->
_cÚf
->
osd_t›r_´omÙe_max_objeùs_£c
;

570 
ušt64_t
 
rg‘_by‹s_£c
 = 
cù
->
_cÚf
->
osd_t›r_´omÙe_max_by‹s_£c
;

572 
mš_´ob
 = 1;

574 
ušt64_t
 
©‹m±s
, 
obj
, 
by‹s
;

575 
´omÙe_couÁ”
.
	`§m¶e_ªd_©‹nu©e
(&
©‹m±s
, &
obj
, &
by‹s
);

576 
	`dout
(10è<< 
__func__
 << " " << 
©‹m±s
 << "‡ttempts,…romoted "

577 << 
obj
 << " objeù ªd " << 
	`by‹_u_t
(
by‹s
) << ";arget "

578 << 
rg‘_obj_£c
 << " obj/sec or "

579 << 
	`by‹_u_t
(
rg‘_by‹s_£c
) << "/sec"

580 << 
d’dl
;

583 
Ãw_´ob
;

584 ià(
©‹m±s
 && 
dur
 > 0) {

585 
ušt64_t
 
avg_size
 = 1;

586 ià(
obj
)

587 
avg_size
 = 
¡d
::
max
<
ušt64_t
>(
by‹s
 / 
obj
, 1);

588 
po
 = ()
rg‘_obj_£c
 * 
dur
 * 1000.0 / ()
©‹m±s
;

589 
pb
 = ()
rg‘_by‹s_£c
 / ()
avg_size
 * 
dur
 * 1000.0

590 / ()
©‹m±s
;

591 
	`dout
(20è<< 
__func__
 << "…Ø" << 
po
 << "…b " << 
pb
 << "‡vg_size "

592 << 
avg_size
 << 
d’dl
;

593 ià(
rg‘_obj_£c
 && 
rg‘_by‹s_£c
)

594 
Ãw_´ob
 = 
¡d
::
	`mš
(
po
, 
pb
);

595 ià(
rg‘_obj_£c
)

596 
Ãw_´ob
 = 
po
;

597 ià(
rg‘_by‹s_£c
)

598 
Ãw_´ob
 = 
pb
;

600 
Ãw_´ob
 = 1000;

602 
Ãw_´ob
 = 1000;

604 
	`dout
(20è<< 
__func__
 << "‚ew_´ob " << 
Ãw_´ob
 << 
d’dl
;

607 
¿tio
 = 1.0;

608 
aùu®
 = 0;

609 ià(
©‹m±s
 && 
obj
) {

610 
aùu®
 = 
obj
 * 1000 / 
©‹m±s
;

611 
¿tio
 = ()
aùu®
 / ()
´ob
;

612 
Ãw_´ob
 = (êew_´ob / 
¿tio
;

614 
Ãw_´ob
 = 
¡d
::
	`max
Òew_´ob, 
mš_´ob
);

615 
Ãw_´ob
 = 
¡d
::
	`mš
(new_prob, 1000u);

618 
´ob
 = (´ob + 
Ãw_´ob
) / 2;

619 
´ob
 = 
¡d
::
	`max
Õrob, 
mš_´ob
);

620 
´ob
 = 
¡d
::
	`mš
(prob, 1000u);

621 
	`dout
(10è<< 
__func__
 << "‡ùu® " << 
aùu®


622 << ",‡ùu®/´ob„©iØ" << 
¿tio


623 << ",‡dju¡ed‚ew_´ob " << 
Ãw_´ob


624 << ",…rob " << 
´omÙe_´obab™y_mlis
 << " -> " << 
´ob


625 << 
d’dl
;

626 
´omÙe_´obab™y_mlis
 = 
´ob
;

629 
´omÙe_max_objeùs
 = 
rg‘_obj_£c
 * 
OSD
::
OSD_TICK_INTERVAL
 * 2;

630 
´omÙe_max_by‹s
 = 
rg‘_by‹s_£c
 * 
OSD
::
OSD_TICK_INTERVAL
 * 2;

631 
	}
}

635 
	gOSDS”viû
::
	$g‘_ç§ã_fuÎ_¿tio
()

637 
fuÎ_¿tio
 = 
cù
->
_cÚf
->
osd_ç§ã_fuÎ_¿tio
;

638 ià(
fuÎ_¿tio
 > 1.0) full_ratio /= 100.0;

639  
fuÎ_¿tio
;

640 
	}
}

642 
	gOSDS”viû
::
	$check_fuÎ_¡©us
(
¿tio
)

644 
Mu‹x
::
Lock”
 
	`l
(
fuÎ_¡©us_lock
);

646 
cur_¿tio
 = 
¿tio
;

652 
OSDM­Ref
 
osdm­
 = 
	`g‘_osdm­
();

653 ià(!
osdm­
 || osdm­->
	`g‘_•och
() == 0) {

654 
cur_¡©e
 = 
NONE
;

657 
Ã¬fuÎ_¿tio
 = 
osdm­
->
	`g‘_Ã¬fuÎ_¿tio
();

658 
backflfuÎ_¿tio
 = 
¡d
::
	`max
(
osdm­
->
	`g‘_backflfuÎ_¿tio
(), 
Ã¬fuÎ_¿tio
);

659 
fuÎ_¿tio
 = 
¡d
::
	`max
(
osdm­
->
	`g‘_fuÎ_¿tio
(), 
backflfuÎ_¿tio
);

660 
ç§ã_¿tio
 = 
¡d
::
	`max
(
	`g‘_ç§ã_fuÎ_¿tio
(), 
fuÎ_¿tio
);

662 ià(
osdm­
->
»quœe_osd_»Ëa£
 < 
CEPH_RELEASE_LUMINOUS
) {

665 
fuÎ_¿tio
 = 
ç§ã_¿tio
;

666 
backflfuÎ_¿tio
 = 
ç§ã_¿tio
;

667 
Ã¬fuÎ_¿tio
 = 
ç§ã_¿tio
;

668 } ià(
fuÎ_¿tio
 <= 0 ||

669 
backflfuÎ_¿tio
 <= 0 ||

670 
Ã¬fuÎ_¿tio
 <= 0) {

671 
d”r
 << 
__func__
 << " fuÎ_¿tio, backflfuÎ_¿tiØÜ‚—rfuÎ_¿tiØi <ğ0" << 
d’dl
;

674 
fuÎ_¿tio
 = 
ç§ã_¿tio
;

675 
backflfuÎ_¿tio
 = 
ç§ã_¿tio
;

676 
Ã¬fuÎ_¿tio
 = 
ç§ã_¿tio
;

679 
¡ršg
 
šjeù
;

680 
s_Çmes
 
Ãw_¡©e
;

681 ià(
šjeùfuÎ_¡©e
 > 
NONE
 && 
šjeùfuÎ
) {

682 
Ãw_¡©e
 = 
šjeùfuÎ_¡©e
;

683 
šjeù
 = "(Injected)";

684 } ià(
¿tio
 > 
ç§ã_¿tio
) {

685 
Ãw_¡©e
 = 
FAILSAFE
;

686 } ià(
¿tio
 > 
fuÎ_¿tio
) {

687 
Ãw_¡©e
 = 
FULL
;

688 } ià(
¿tio
 > 
backflfuÎ_¿tio
) {

689 
Ãw_¡©e
 = 
BACKFILLFULL
;

690 } ià(
¿tio
 > 
Ã¬fuÎ_¿tio
) {

691 
Ãw_¡©e
 = 
NEARFULL
;

693 
Ãw_¡©e
 = 
NONE
;

695 
	`dout
(20è<< 
__func__
 << " cu¸¿tiØ" << 
¿tio


696 << ".‚—rfuÎ_¿tiØ" << 
Ã¬fuÎ_¿tio


697 << ". backflfuÎ_¿tiØ" << 
backflfuÎ_¿tio


698 << ", fuÎ_¿tiØ" << 
fuÎ_¿tio


699 << ", fa§ã_¿tiØ" << 
ç§ã_¿tio


700 << ",‚ew s‹ " << 
	`g‘_fuÎ_¡©e_Çme
(
Ãw_¡©e
)

701 << " " << 
šjeù


702 << 
d’dl
;

705 ià(
cur_¡©e
 !ğ
Ãw_¡©e
) {

706 
	`dout
(10è<< 
__func__
 << " " << 
	`g‘_fuÎ_¡©e_Çme
(
cur_¡©e
)

707 << " -> " << 
	`g‘_fuÎ_¡©e_Çme
(
Ãw_¡©e
è<< 
d’dl
;

708 ià(
Ãw_¡©e
 =ğ
FAILSAFE
) {

709 
şog
->
	`”rÜ
() << "full status failsafeƒngaged, dropping updates,‚ow "

710 << ()
	`roundf
(
¿tio
 * 100) << "% full";

711 } ià(
cur_¡©e
 =ğ
FAILSAFE
) {

712 
şog
->
	`”rÜ
() << "full status failsafe disengaged,‚o†onger dropping "

713 << "upd©es,‚ow " << ()
	`roundf
(
¿tio
 * 100) << "% full";

715 
cur_¡©e
 = 
Ãw_¡©e
;

717 
	}
}

719 
boŞ
 
	gOSDS”viû
::
	$Ãed_fuÎÃss_upd©e
()

721 
OSDM­Ref
 
osdm­
 = 
	`g‘_osdm­
();

722 
s_Çmes
 
cur
 = 
NONE
;

723 ià(
osdm­
->
	`exi¡s
(
whßmi
)) {

724 ià(
osdm­
->
	`g‘_¡©e
(
whßmi
è& 
CEPH_OSD_FULL
) {

725 
cur
 = 
FULL
;

726 } ià(
osdm­
->
	`g‘_¡©e
(
whßmi
è& 
CEPH_OSD_BACKFILLFULL
) {

727 
cur
 = 
BACKFILLFULL
;

728 } ià(
osdm­
->
	`g‘_¡©e
(
whßmi
è& 
CEPH_OSD_NEARFULL
) {

729 
cur
 = 
NEARFULL
;

732 
s_Çmes
 
wªt
 = 
NONE
;

733 ià(
	`is_fuÎ
())

734 
wªt
 = 
FULL
;

735 ià(
	`is_backflfuÎ
())

736 
wªt
 = 
BACKFILLFULL
;

737 ià(
	`is_Ã¬fuÎ
())

738 
wªt
 = 
NEARFULL
;

739  
wªt
 !ğ
cur
;

740 
	}
}

742 
boŞ
 
	gOSDS”viû
::
	$_check_fuÎ
(
DoutP»fixProvid”
 *
dµ
, 
s_Çmes
 
ty³
) const

744 
Mu‹x
::
Lock”
 
	`l
(
fuÎ_¡©us_lock
);

746 ià(
šjeùfuÎ
 && 
šjeùfuÎ_¡©e
 >ğ
ty³
) {

749 ià(
šjeùfuÎ
 > 0)

750 --
šjeùfuÎ
;

751 
	`ldµ_dout
(
dµ
, 10è<< 
__func__
 << " Injeùed " << 
	`g‘_fuÎ_¡©e_Çme
(
ty³
) << " OSD ("

752 << (
šjeùfuÎ
 < 0 ? "£t" : 
¡d
::
	`to_¡ršg
(injectfull)) << ")"

753 << 
d’dl
;

754  
Œue
;

756 ià(
cur_¡©e
 >ğ
ty³
)

757 
	`ldµ_dout
(
dµ
, 10è<< 
__func__
 << " cu¼’ˆu§gi " << 
cur_¿tio
 << 
d’dl
;

759  
cur_¡©e
 >ğ
ty³
;

760 
	}
}

762 
boŞ
 
	gOSDS”viû
::
	$check_ç§ã_fuÎ
(
DoutP»fixProvid”
 *
dµ
) const

764  
	`_check_fuÎ
(
dµ
, 
FAILSAFE
);

765 
	}
}

767 
boŞ
 
	gOSDS”viû
::
	$check_fuÎ
(
DoutP»fixProvid”
 *
dµ
) const

769  
	`_check_fuÎ
(
dµ
, 
FULL
);

770 
	}
}

772 
boŞ
 
	gOSDS”viû
::
	$check_backfl_fuÎ
(
DoutP»fixProvid”
 *
dµ
) const

774  
	`_check_fuÎ
(
dµ
, 
BACKFILLFULL
);

775 
	}
}

777 
boŞ
 
	gOSDS”viû
::
	$check_Ã¬fuÎ
(
DoutP»fixProvid”
 *
dµ
) const

779  
	`_check_fuÎ
(
dµ
, 
NEARFULL
);

780 
	}
}

782 
boŞ
 
	gOSDS”viû
::
	$is_ç§ã_fuÎ
() const

784 
Mu‹x
::
Lock”
 
	`l
(
fuÎ_¡©us_lock
);

785  
cur_¡©e
 =ğ
FAILSAFE
;

786 
	}
}

788 
boŞ
 
	gOSDS”viû
::
	$is_fuÎ
() const

790 
Mu‹x
::
Lock”
 
	`l
(
fuÎ_¡©us_lock
);

791  
cur_¡©e
 >ğ
FULL
;

792 
	}
}

794 
boŞ
 
	gOSDS”viû
::
	$is_backflfuÎ
() const

796 
Mu‹x
::
Lock”
 
	`l
(
fuÎ_¡©us_lock
);

797  
cur_¡©e
 >ğ
BACKFILLFULL
;

798 
	}
}

800 
boŞ
 
	gOSDS”viû
::
	$is_Ã¬fuÎ
() const

802 
Mu‹x
::
Lock”
 
	`l
(
fuÎ_¡©us_lock
);

803  
cur_¡©e
 >ğ
NEARFULL
;

804 
	}
}

806 
	gOSDS”viû
::
	$£t_šjeùfuÎ
(
s_Çmes
 
ty³
, 
št64_t
 
couÁ
)

808 
Mu‹x
::
Lock”
 
	`l
(
fuÎ_¡©us_lock
);

809 
šjeùfuÎ_¡©e
 = 
ty³
;

810 
šjeùfuÎ
 = 
couÁ
;

811 
	}
}

813 
osd_¡©_t
 
	gOSDS”viû
::
£t_osd_¡©
(cÚ¡ 
¡Üe_¡©fs_t
 &
¡buf
,

814 
veùÜ
<>& 
hb_³”s
,

815 
num_pgs
)

817 
ušt64_t
 
	gby‹s
 = 
¡buf
.
tÙ®
;

818 
ušt64_t
 
	gu£d
 = 
by‹s
 - 
¡buf
.
avaabË
;

819 
ušt64_t
 
	gava
 = 
¡buf
.
avaabË
;

821 
	gosd
->
	glogg”
->
£t
(
l_osd_¡©_by‹s
, 
by‹s
);

822 
	gosd
->
	glogg”
->
£t
(
l_osd_¡©_by‹s_u£d
, 
u£d
);

823 
	gosd
->
	glogg”
->
£t
(
l_osd_¡©_by‹s_ava
, 
ava
);

826 
	gMu‹x
::
Lock”
 
l
(
¡©_lock
);

827 
	gosd_¡©
.
	ghb_³”s
.
sw­
(
hb_³”s
);

828 
	gosd
->
	gİ_Œack”
.
g‘_age_ms_hi¡og¿m
(&
osd_¡©
.
İ_queue_age_hi¡
);

829 
	gosd_¡©
.
	gkb
 = 
by‹s
 >> 10;

830 
	gosd_¡©
.
	gkb_u£d
 = 
u£d
 >> 10;

831 
	gosd_¡©
.
	gkb_ava
 = 
ava
 >> 10;

832 
	gosd_¡©
.
	gnum_pgs
 = 
num_pgs
;

833  
	gosd_¡©
;

837 
	gOSDS”viû
::
upd©e_osd_¡©
(
veùÜ
<>& 
hb_³”s
)

840 
¡Üe_¡©fs_t
 
¡buf
;

841 
	gr
 = 
osd
->
¡Üe
->
¡©fs
(&
¡buf
);

842 ià(
	gr
 < 0) {

843 
	gd”r
 << "¡©fs(èçed: " << 
ıp_¡»¼Ü
(
r
è<< 
	gd’dl
;

847 autØ
	gÃw_¡©
 = 
£t_osd_¡©
(
¡buf
, 
hb_³”s
, 
osd
->
num_pgs
);

848 
dout
(20è<< "upd©e_osd_¡© " << 
	gÃw_¡©
 << 
	gd’dl
;

849 
as£¹
(
Ãw_¡©
.
kb
);

850 
	g¿tio
 = (()
Ãw_¡©
.
kb_u£d
è/ ((êew_¡©.
kb
);

851 
check_fuÎ_¡©us
(
¿tio
);

854 
boŞ
 
	gOSDS”viû
::
check_osdm­_fuÎ
(cÚ¡ 
£t
<
pg_sh¬d_t
> &
missšg_Ú
)

856 
OSDM­Ref
 
osdm­
 = 
g‘_osdm­
();

857 autØ
	gsh¬d
 : 
missšg_Ú
) {

858 ià(
osdm­
->
g‘_¡©e
(
sh¬d
.
osd
è& 
CEPH_OSD_FULL
)

859  
Œue
;

861  
	gçl£
;

864 
	gOSDS”viû
::
	$£nd_mes§ge_osd_şu¡”
(
³”
, 
Mes§ge
 *
m
, 
•och_t
 
äom_•och
)

866 
OSDM­Ref
 
Ãxt_m­
 = 
	`g‘_Ãxtm­_»£rved
();

868 
	`as£¹
(
äom_•och
 <ğ
Ãxt_m­
->
	`g‘_•och
());

870 ià(
Ãxt_m­
->
	`is_down
(
³”
) ||

871 
Ãxt_m­
->
	`g‘_šfo
(
³”
).
up_äom
 > 
äom_•och
) {

872 
m
->
	`put
();

873 
	`»Ëa£_m­
(
Ãxt_m­
);

876 cÚ¡ 
’t™y_š¡_t
& 
³”_š¡
 = 
Ãxt_m­
->
	`g‘_şu¡”_š¡
(
³”
);

877 
CÚÃùiÚRef
 
³”_cÚ
 = 
osd
->
şu¡”_mes£ng”
->
	`g‘_cÚÃùiÚ
(
³”_š¡
);

878 
	`sh¬e_m­_³”
(
³”
, 
³”_cÚ
.
	`g‘
(), 
Ãxt_m­
);

879 
³”_cÚ
->
	`£nd_mes§ge
(
m
);

880 
	`»Ëa£_m­
(
Ãxt_m­
);

881 
	}
}

883 
CÚÃùiÚRef
 
	gOSDS”viû
::
	$g‘_cÚ_osd_şu¡”
(
³”
, 
•och_t
 
äom_•och
)

885 
OSDM­Ref
 
Ãxt_m­
 = 
	`g‘_Ãxtm­_»£rved
();

887 
	`as£¹
(
äom_•och
 <ğ
Ãxt_m­
->
	`g‘_•och
());

889 ià(
Ãxt_m­
->
	`is_down
(
³”
) ||

890 
Ãxt_m­
->
	`g‘_šfo
(
³”
).
up_äom
 > 
äom_•och
) {

891 
	`»Ëa£_m­
(
Ãxt_m­
);

892  
NULL
;

894 
CÚÃùiÚRef
 
cÚ
 = 
osd
->
şu¡”_mes£ng”
->
	`g‘_cÚÃùiÚ
(
Ãxt_m­
->
	`g‘_şu¡”_š¡
(
³”
));

895 
	`»Ëa£_m­
(
Ãxt_m­
);

896  
cÚ
;

897 
	}
}

899 
	g·œ
<
	gCÚÃùiÚRef
,CÚÃùiÚRef> 
	gOSDS”viû
::
	$g‘_cÚ_osd_hb
(
³”
, 
•och_t
 
äom_•och
)

901 
OSDM­Ref
 
Ãxt_m­
 = 
	`g‘_Ãxtm­_»£rved
();

903 
	`as£¹
(
äom_•och
 <ğ
Ãxt_m­
->
	`g‘_•och
());

905 
·œ
<
CÚÃùiÚRef
,CÚÃùiÚRef> 
»t
;

906 ià(
Ãxt_m­
->
	`is_down
(
³”
) ||

907 
Ãxt_m­
->
	`g‘_šfo
(
³”
).
up_äom
 > 
äom_•och
) {

908 
	`»Ëa£_m­
(
Ãxt_m­
);

909  
»t
;

911 
»t
.
fœ¡
 = 
osd
->
hb_back_ş›Á_mes£ng”
->
	`g‘_cÚÃùiÚ
(
Ãxt_m­
->
	`g‘_hb_back_š¡
(
³”
));

912 ià(
Ãxt_m­
->
	`g‘_hb_äÚt_addr
(
³”
è!ğ
	`’t™y_addr_t
())

913 
»t
.
£cÚd
 = 
osd
->
hb_äÚt_ş›Á_mes£ng”
->
	`g‘_cÚÃùiÚ
(
Ãxt_m­
->
	`g‘_hb_äÚt_š¡
(
³”
));

914 
	`»Ëa£_m­
(
Ãxt_m­
);

915  
»t
;

916 
	}
}

919 
	gOSDS”viû
::
queue_wªt_pg_‹mp
(
pg_t
 
pgid
,

920 cÚ¡ 
veùÜ
<>& 
wªt
,

921 
boŞ
 
fÜûd
)

923 
	gMu‹x
::
Lock”
 
l
(
pg_‹mp_lock
);

924 autØ
	gp
 = 
pg_‹mp_³ndšg
.
fšd
(
pgid
);

925 ià(
	gp
 =ğ
pg_‹mp_³ndšg
.
’d
() ||

926 
p
->
£cÚd
.
aùšg
 !ğ
wªt
 ||

927 
fÜûd
) {

928 
pg_‹mp_wª‹d
[
pgid
] = {
wªt
, 
fÜûd
};

932 
	gOSDS”viû
::
	$»move_wªt_pg_‹mp
(
pg_t
 
pgid
)

934 
Mu‹x
::
Lock”
 
	`l
(
pg_‹mp_lock
);

935 
pg_‹mp_wª‹d
.
	`”a£
(
pgid
);

936 
pg_‹mp_³ndšg
.
	`”a£
(
pgid
);

937 
	}
}

939 
	gOSDS”viû
::
	$_£Á_pg_‹mp
()

941 #ifdeà
HAVE_STDLIB_MAP_SPLICING


942 
pg_‹mp_³ndšg
.
	`m”ge
(
pg_‹mp_wª‹d
);

944 
pg_‹mp_³ndšg
.
	`š£¹
(
	`make_move_™”©Ü
(
	`begš
(
pg_‹mp_wª‹d
)),

945 
	`make_move_™”©Ü
(
	`’d
(
pg_‹mp_wª‹d
)));

947 
pg_‹mp_wª‹d
.
	`ş—r
();

948 
	}
}

950 
	gOSDS”viû
::
	$»queue_pg_‹mp
()

952 
Mu‹x
::
Lock”
 
	`l
(
pg_‹mp_lock
);

955 
Şd_wª‹d
 = 
pg_‹mp_wª‹d
.
	`size
();

956 
Şd_³ndšg
 = 
pg_‹mp_³ndšg
.
	`size
();

957 
	`_£Á_pg_‹mp
();

958 
pg_‹mp_wª‹d
.
	`sw­
(
pg_‹mp_³ndšg
);

959 
	`dout
(10è<< 
__func__
 << " " << 
Şd_wª‹d
 << " + " << 
Şd_³ndšg
 << " -> "

960 << 
pg_‹mp_wª‹d
.
	`size
(è<< 
d’dl
;

961 
	}
}

963 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
out
,

964 cÚ¡ 
	gOSDS”viû
::
pg_‹mp_t
& 
pg_‹mp
)

966 
out
 << 
pg_‹mp
.
aùšg
;

967 ià(
	gpg_‹mp
.
	gfÜûd
) {

968 
	gout
 << " (forced)";

970  
	gout
;

973 
	gOSDS”viû
::
	$£nd_pg_‹mp
()

975 
Mu‹x
::
Lock”
 
	`l
(
pg_‹mp_lock
);

976 ià(
pg_‹mp_wª‹d
.
	`em±y
())

978 
	`dout
(10è<< "£nd_pg_‹m°" << 
pg_‹mp_wª‹d
 << 
d’dl
;

979 
MOSDPGTemp
 *
ms
[2] = {
nuÎ±r
,‚ullptr};

980 auto& [
pgid
, 
pg_‹mp
] : 
pg_‹mp_wª‹d
) {

981 auto& 
m
 = 
ms
[
pg_‹mp
.
fÜûd
];

982 ià(!
m
) {

983 
m
 = 
Ãw
 
	`MOSDPGTemp
(
osdm­
->
	`g‘_•och
());

984 
m
->
fÜûd
 = 
pg_‹mp
.forced;

986 
m
->
pg_‹mp
.
	`em¶aû
(
pgid
,…g_‹mp.
aùšg
);

988 autØ
m
 : 
ms
) {

989 ià(
m
) {

990 
mÚc
->
	`£nd_mÚ_mes§ge
(
m
);

993 
	`_£Á_pg_‹mp
();

994 
	}
}

996 
	gOSDS”viû
::
	$£nd_pg_ü—‹d
(
pg_t
 
pgid
)

998 
	`dout
(20è<< 
__func__
 << 
d’dl
;

999 ià(
osdm­
->
»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_LUMINOUS
) {

1000 
mÚc
->
	`£nd_mÚ_mes§ge
(
Ãw
 
	`MOSDPGC»©ed
(
pgid
));

1002 
	}
}

1007 
•och_t
 
	gOSDS”viû
::
	$g‘_³”_•och
(
³”
)

1009 
Mu‹x
::
Lock”
 
	`l
(
³”_m­_•och_lock
);

1010 
m­
<,
•och_t
>::
™”©Ü
 
p
 = 
³”_m­_•och
.
	`fšd
(
³”
);

1011 ià(
p
 =ğ
³”_m­_•och
.
	`’d
())

1013  
p
->
£cÚd
;

1014 
	}
}

1016 
•och_t
 
	gOSDS”viû
::
	$nÙe_³”_•och
(
³”
, 
•och_t
 
e
)

1018 
Mu‹x
::
Lock”
 
	`l
(
³”_m­_•och_lock
);

1019 
m­
<,
•och_t
>::
™”©Ü
 
p
 = 
³”_m­_•och
.
	`fšd
(
³”
);

1020 ià(
p
 !ğ
³”_m­_•och
.
	`’d
()) {

1021 ià(
p
->
£cÚd
 < 
e
) {

1022 
	`dout
(10è<< "nÙe_³”_•och osd." << 
³”
 << " ha " << 
e
 << 
d’dl
;

1023 
p
->
£cÚd
 = 
e
;

1025 
	`dout
(30è<< "nÙe_³”_•och osd." << 
³”
 << " ha " << 
p
->
£cÚd
 << " >ğ" << 
e
 << 
d’dl
;

1027  
p
->
£cÚd
;

1029 
	`dout
(10è<< "nÙe_³”_•och osd." << 
³”
 << "‚ow ha " << 
e
 << 
d’dl
;

1030 
³”_m­_•och
[
³”
] = 
e
;

1031  
e
;

1033 
	}
}

1035 
	gOSDS”viû
::
	$fÜg‘_³”_•och
(
³”
, 
•och_t
 
as_of
)

1037 
Mu‹x
::
Lock”
 
	`l
(
³”_m­_•och_lock
);

1038 
m­
<,
•och_t
>::
™”©Ü
 
p
 = 
³”_m­_•och
.
	`fšd
(
³”
);

1039 ià(
p
 !ğ
³”_m­_•och
.
	`’d
()) {

1040 ià(
p
->
£cÚd
 <ğ
as_of
) {

1041 
	`dout
(10è<< "fÜg‘_³”_•och osd." << 
³”
 << "‡s_oà" << 
as_of


1042 << " had " << 
p
->
£cÚd
 << 
d’dl
;

1043 
³”_m­_•och
.
	`”a£
(
p
);

1045 
	`dout
(10è<< "fÜg‘_³”_•och osd." << 
³”
 << "‡s_oà" << 
as_of


1046 << " ha " << 
p
->
£cÚd
 << " -‚Ù fÜg‘tšg" << 
d’dl
;

1049 
	}
}

1051 
boŞ
 
	gOSDS”viû
::
	$should_sh¬e_m­
(
’t™y_Çme_t
 
Çme
, 
CÚÃùiÚ
 *
cÚ
,

1052 
•och_t
 
•och
, cÚ¡ 
OSDM­Ref
& 
osdm­
,

1053 cÚ¡ 
•och_t
 *
£Á_•och_p
)

1055 
	`dout
(20) << "should_share_map "

1056 << 
Çme
 << " " << 
cÚ
->
	`g‘_³”_addr
()

1057 << " " << 
•och
 << 
d’dl
;

1060 ià(
Çme
.
	`is_ş›Á
()) {

1061 
boŞ
 
mes§ge_£ndm­
 = 
•och
 < 
osdm­
->
	`g‘_•och
();

1062 ià(
mes§ge_£ndm­
 && 
£Á_•och_p
) {

1063 
	`dout
(20) << "client session†ast_sent_epoch: "

1064 << *
£Á_•och_p


1065 << " v”su osdm­ƒpoch " << 
osdm­
->
	`g‘_•och
(è<< 
d’dl
;

1066 ià(*
£Á_•och_p
 < 
osdm­
->
	`g‘_•och
()) {

1067  
Œue
;

1072 ià(
cÚ
->
	`g‘_mes£ng”
(è=ğ
osd
->
şu¡”_mes£ng”
 &&

1073 
cÚ
 !ğ
osd
->
şu¡”_mes£ng”
->
	`g‘_loİback_cÚÃùiÚ
() &&

1074 
osdm­
->
	`is_up
(
Çme
.
	`num
()) &&

1075 (
osdm­
->
	`g‘_şu¡”_addr
(
Çme
.
	`num
()è=ğ
cÚ
->
	`g‘_³”_addr
() ||

1076 
osdm­
->
	`g‘_hb_back_addr
(
Çme
.
	`num
()è=ğ
cÚ
->
	`g‘_³”_addr
())) {

1078 
•och_t
 
has
 = 
¡d
::
	`max
(
	`g‘_³”_•och
(
Çme
.
	`num
()), 
•och
);

1081 ià(
has
 < 
osdm­
->
	`g‘_•och
()) {

1082 
	`dout
(10è<< 
Çme
 << " " << 
cÚ
->
	`g‘_³”_addr
()

1083 << " ha Şd m­ " << 
•och
 << " < "

1084 << 
osdm­
->
	`g‘_•och
(è<< 
d’dl
;

1085  
Œue
;

1089  
çl£
;

1090 
	}
}

1092 
	gOSDS”viû
::
	$sh¬e_m­
(

1093 
’t™y_Çme_t
 
Çme
,

1094 
CÚÃùiÚ
 *
cÚ
,

1095 
•och_t
 
•och
,

1096 
OSDM­Ref
& 
osdm­
,

1097 
•och_t
 *
£Á_•och_p
)

1099 
	`dout
(20) << "share_map "

1100 << 
Çme
 << " " << 
cÚ
->
	`g‘_³”_addr
()

1101 << " " << 
•och
 << 
d’dl
;

1103 ià(!
osd
->
	`is_aùive
()) {

1108 
boŞ
 
wªt_sh¬ed
 = 
	`should_sh¬e_m­
(
Çme
, 
cÚ
, 
•och
,

1109 
osdm­
, 
£Á_•och_p
);

1111 ià(
wªt_sh¬ed
){

1112 ià(
Çme
.
	`is_ş›Á
()) {

1113 
	`dout
(10è<< 
Çme
 << " ha Şd m­ " << 
•och


1114 << " < " << 
osdm­
->
	`g‘_•och
(è<< 
d’dl
;

1116 ià(
£Á_•och_p
) {

1117 *
£Á_•och_p
 = 
osdm­
->
	`g‘_•och
();

1119 
	`£nd_šüem’l_m­
(
•och
, 
cÚ
, 
osdm­
);

1120 } ià(
cÚ
->
	`g‘_mes£ng”
(è=ğ
osd
->
şu¡”_mes£ng”
 &&

1121 
osdm­
->
	`is_up
(
Çme
.
	`num
()) &&

1122 (
osdm­
->
	`g‘_şu¡”_addr
(
Çme
.
	`num
()è=ğ
cÚ
->
	`g‘_³”_addr
() ||

1123 
osdm­
->
	`g‘_hb_back_addr
(
Çme
.
	`num
()è=ğ
cÚ
->
	`g‘_³”_addr
())) {

1124 
	`dout
(10è<< 
Çme
 << " " << 
cÚ
->
	`g‘_³”_addr
()

1125 << " ha Şd m­ " << 
•och
 << " < "

1126 << 
osdm­
->
	`g‘_•och
(è<< 
d’dl
;

1127 
	`nÙe_³”_•och
(
Çme
.
	`num
(), 
osdm­
->
	`g‘_•och
());

1128 
	`£nd_šüem’l_m­
(
•och
, 
cÚ
, 
osdm­
);

1131 
	}
}

1133 
	gOSDS”viû
::
	$sh¬e_m­_³”
(
³”
, 
CÚÃùiÚ
 *
cÚ
, 
OSDM­Ref
 
m­
)

1135 ià(!
m­
)

1136 
m­
 = 
	`g‘_osdm­
();

1139 
•och_t
 
³
 = 
	`g‘_³”_•och
(
³”
);

1140 ià(
³
) {

1141 ià(
³
 < 
m­
->
	`g‘_•och
()) {

1142 
	`£nd_šüem’l_m­
(
³
, 
cÚ
, 
m­
);

1143 
	`nÙe_³”_•och
(
³”
, 
m­
->
	`g‘_•och
());

1145 
	`dout
(20è<< "sh¬e_m­_³” " << 
cÚ
 << "‡Ì—dy ha •och " << 
³
 << 
d’dl
;

1147 
	`dout
(20è<< "sh¬e_m­_³” " << 
cÚ
 << " dÚ'ˆknowƒpoch, došg‚Ùhšg" << 
d’dl
;

1152 
	}
}

1154 
boŞ
 
	gOSDS”viû
::
	$ÿn_šc_süubs_³ndšg
()

1156 
boŞ
 
ÿn_šc
 = 
çl£
;

1157 
Mu‹x
::
Lock”
 
	`l
(
sched_süub_lock
);

1159 ià(
süubs_³ndšg
 + 
süubs_aùive
 < 
cù
->
_cÚf
->
osd_max_süubs
) {

1160 
	`dout
(20è<< 
__func__
 << " " << 
süubs_³ndšg
 << " -> " << (scrubs_pending+1)

1161 << " (max " << 
cù
->
_cÚf
->
osd_max_süubs
 << ",‡ùiv" << 
süubs_aùive


1162 << ")" << 
d’dl
;

1163 
ÿn_šc
 = 
Œue
;

1165 
	`dout
(20è<< 
__func__
 << " " << 
süubs_³ndšg
 << " + " << 
süubs_aùive


1166 << "‡ùiv>ğmax " << 
cù
->
_cÚf
->
osd_max_süubs
 << 
d’dl
;

1169  
ÿn_šc
;

1170 
	}
}

1172 
boŞ
 
	gOSDS”viû
::
	$šc_süubs_³ndšg
()

1174 
boŞ
 
»suÉ
 = 
çl£
;

1176 
sched_süub_lock
.
	`Lock
();

1177 ià(
süubs_³ndšg
 + 
süubs_aùive
 < 
cù
->
_cÚf
->
osd_max_süubs
) {

1178 
	`dout
(20è<< "šc_süubs_³ndšg " << 
süubs_³ndšg
 << " -> " << (scrubs_pending+1)

1179 << " (max " << 
cù
->
_cÚf
->
osd_max_süubs
 << ",‡ùiv" << 
süubs_aùive
 << ")" << 
d’dl
;

1180 
»suÉ
 = 
Œue
;

1181 ++
süubs_³ndšg
;

1183 
	`dout
(20è<< "šc_süubs_³ndšg " << 
süubs_³ndšg
 << " + " << 
süubs_aùive
 << "‡ùiv>ğmax " << 
cù
->
_cÚf
->
osd_max_süubs
 << 
d’dl
;

1185 
sched_süub_lock
.
	`UÆock
();

1187  
»suÉ
;

1188 
	}
}

1190 
	gOSDS”viû
::
	$dec_süubs_³ndšg
()

1192 
sched_süub_lock
.
	`Lock
();

1193 
	`dout
(20è<< "dec_süubs_³ndšg " << 
süubs_³ndšg
 << " -> " << (scrubs_pending-1)

1194 << " (max " << 
cù
->
_cÚf
->
osd_max_süubs
 << ",‡ùiv" << 
süubs_aùive
 << ")" << 
d’dl
;

1195 --
süubs_³ndšg
;

1196 
	`as£¹
(
süubs_³ndšg
 >= 0);

1197 
sched_süub_lock
.
	`UÆock
();

1198 
	}
}

1200 
	gOSDS”viû
::
	$šc_süubs_aùive
(
boŞ
 
»£rved
)

1202 
sched_süub_lock
.
	`Lock
();

1203 ++(
süubs_aùive
);

1204 ià(
»£rved
) {

1205 --(
süubs_³ndšg
);

1206 
	`dout
(20è<< "šc_süubs_aùiv" << (
süubs_aùive
-1) << " -> " << scrubs_active

1207 << " (max " << 
cù
->
_cÚf
->
osd_max_süubs


1208 << ",…’dšg " << (
süubs_³ndšg
+1è<< " -> " << süubs_³ndšg << ")" << 
d’dl
;

1209 
	`as£¹
(
süubs_³ndšg
 >= 0);

1211 
	`dout
(20è<< "šc_süubs_aùiv" << (
süubs_aùive
-1) << " -> " << scrubs_active

1212 << " (max " << 
cù
->
_cÚf
->
osd_max_süubs


1213 << ",…’dšg " << 
süubs_³ndšg
 << ")" << 
d’dl
;

1215 
sched_süub_lock
.
	`UÆock
();

1216 
	}
}

1218 
	gOSDS”viû
::
	$dec_süubs_aùive
()

1220 
sched_süub_lock
.
	`Lock
();

1221 
	`dout
(20è<< "dec_süubs_aùiv" << 
süubs_aùive
 << " -> " << (scrubs_active-1)

1222 << " (max " << 
cù
->
_cÚf
->
osd_max_süubs
 << ",…’dšg " << 
süubs_³ndšg
 << ")" << 
d’dl
;

1223 --
süubs_aùive
;

1224 
	`as£¹
(
süubs_aùive
 >= 0);

1225 
sched_süub_lock
.
	`UÆock
();

1226 
	}
}

1228 
	gOSDS”viû
::
	$»Œ›ve_•ochs
(
•och_t
 *
_boÙ_•och
,ƒpoch_ˆ*
_up_•och
,

1229 
•och_t
 *
_bšd_•och
) const

1231 
Mu‹x
::
Lock”
 
	`l
(
•och_lock
);

1232 ià(
_boÙ_•och
)

1233 *
_boÙ_•och
 = 
boÙ_•och
;

1234 ià(
_up_•och
)

1235 *
_up_•och
 = 
up_•och
;

1236 ià(
_bšd_•och
)

1237 *
_bšd_•och
 = 
bšd_•och
;

1238 
	}
}

1240 
	gOSDS”viû
::
	$£t_•ochs
(cÚ¡ 
•och_t
 *
_boÙ_•och
, cÚ¡ƒpoch_ˆ*
_up_•och
,

1241 cÚ¡ 
•och_t
 *
_bšd_•och
)

1243 
Mu‹x
::
Lock”
 
	`l
(
•och_lock
);

1244 ià(
_boÙ_•och
) {

1245 
	`as£¹
(*
_boÙ_•och
 =ğ0 || *_boÙ_•och >ğ
boÙ_•och
);

1246 
boÙ_•och
 = *
_boÙ_•och
;

1248 ià(
_up_•och
) {

1249 
	`as£¹
(*
_up_•och
 =ğ0 || *_up_•och >ğ
up_•och
);

1250 
up_•och
 = *
_up_•och
;

1252 ià(
_bšd_•och
) {

1253 
	`as£¹
(*
_bšd_•och
 =ğ0 || *_bšd_•och >ğ
bšd_•och
);

1254 
bšd_•och
 = *
_bšd_•och
;

1256 
	}
}

1258 
boŞ
 
	gOSDS”viû
::
	$´•¬e_to_¡İ
()

1260 
Mu‹x
::
Lock”
 
	`l
(
is_¡İpšg_lock
);

1261 ià(
	`g‘_¡©e
(è!ğ
NOT_STOPPING
)

1262  
çl£
;

1264 
OSDM­Ref
 
osdm­
 = 
	`g‘_osdm­
();

1265 ià(
osdm­
 && osdm­->
	`is_up
(
whßmi
)) {

1266 
	`dout
(0è<< 
__func__
 << "–lšg mÚ w¬shu‰šg down" << 
d’dl
;

1267 
	`£t_¡©e
(
PREPARING_TO_STOP
);

1268 
mÚc
->
	`£nd_mÚ_mes§ge
(
Ãw
 
	`MOSDM¬kMeDown
(mÚc->
	`g‘_fsid
(),

1269 
osdm­
->
	`g‘_š¡
(
whßmi
),

1270 
osdm­
->
	`g‘_•och
(),

1271 
Œue


1273 
utime_t
 
now
 = 
	`ûph_şock_now
();

1274 
utime_t
 
timeout
;

1275 
timeout
.
	`£t_äom_doubË
(
now
 + 
cù
->
_cÚf
->
osd_mÚ_shutdown_timeout
);

1276 (
	`ûph_şock_now
(è< 
timeout
) &&

1277 (
	`g‘_¡©e
(è!ğ
STOPPING
)) {

1278 
is_¡İpšg_cÚd
.
	`Wa™UÁ
(
is_¡İpšg_lock
, 
timeout
);

1281 
	`dout
(0è<< 
__func__
 << " s¹šg shutdown" << 
d’dl
;

1282 
	`£t_¡©e
(
STOPPING
);

1283  
Œue
;

1284 
	}
}

1286 
	gOSDS”viû
::
	$gÙ_¡İ_ack
()

1288 
Mu‹x
::
Lock”
 
	`l
(
is_¡İpšg_lock
);

1289 ià(
	`g‘_¡©e
(è=ğ
PREPARING_TO_STOP
) {

1290 
	`dout
(0è<< 
__func__
 << " s¹šg shutdown" << 
d’dl
;

1291 
	`£t_¡©e
(
STOPPING
);

1292 
is_¡İpšg_cÚd
.
	`SigÇl
();

1294 
	`dout
(10è<< 
__func__
 << " ignÜšg msg" << 
d’dl
;

1296 
	}
}

1298 
MOSDM­
 *
	gOSDS”viû
::
	$bud_šüem’l_m­_msg
(
•och_t
 
sšû
,ƒpoch_ˆ
to
,

1299 
OSDSu³rblock
& 
sblock
)

1301 
MOSDM­
 *
m
 = 
Ãw
 
	`MOSDM­
(
mÚc
->
	`g‘_fsid
(),

1302 
osdm­
->
	`g‘_’codšg_ã©u»s
());

1303 
m
->
Şde¡_m­
 = 
max_Şde¡_m­
;

1304 
m
->
Ãwe¡_m­
 = 
sblock
.newest_map;

1306 
•och_t
 
e
 = 
to
;ƒ > 
sšû
;ƒ--) {

1307 
bufã¾i¡
 
bl
;

1308 ià(
e
 > 
m
->
Şde¡_m­
 && 
	`g‘_šc_m­_bl
Ó, 
bl
)) {

1309 
m
->
šüem’l_m­s
[
e
].
	`şaim
(
bl
);

1310 } ià(
	`g‘_m­_bl
(
e
, 
bl
)) {

1311 
m
->
m­s
[
e
].
	`şaim
(
bl
);

1314 
d”r
 << "sšû " << 
sšû
 << "Ø" << 
to


1315 << " olde¡ " << 
m
->
Şde¡_m­
 << "‚ewe¡ " << m->
Ãwe¡_m­


1316 << 
d’dl
;

1317 
m
->
	`put
();

1318 
m
 = 
NULL
;

1322  
m
;

1323 
	}
}

1325 
	gOSDS”viû
::
	$£nd_m­
(
MOSDM­
 *
m
, 
CÚÃùiÚ
 *
cÚ
)

1327 
cÚ
->
	`£nd_mes§ge
(
m
);

1328 
	}
}

1330 
	gOSDS”viû
::
	$£nd_šüem’l_m­
(
•och_t
 
sšû
, 
CÚÃùiÚ
 *
cÚ
,

1331 
OSDM­Ref
& 
osdm­
)

1333 
•och_t
 
to
 = 
osdm­
->
	`g‘_•och
();

1334 
	`dout
(10è<< "£nd_šüem’l_m­ " << 
sšû
 << " -> " << 
to


1335 << "Ø" << 
cÚ
 << " " << cÚ->
	`g‘_³”_addr
(è<< 
d’dl
;

1337 
MOSDM­
 *
m
 = 
NULL
;

1338 !
m
) {

1339 
OSDSu³rblock
 
	`sblock
(
	`g‘_su³rblock
());

1340 ià(
sšû
 < 
sblock
.
Şde¡_m­
) {

1342 
MOSDM­
 *
m
 = 
Ãw
 
	`MOSDM­
(
mÚc
->
	`g‘_fsid
(),

1343 
osdm­
->
	`g‘_’codšg_ã©u»s
());

1344 
m
->
Şde¡_m­
 = 
max_Şde¡_m­
;

1345 
m
->
Ãwe¡_m­
 = 
sblock
.newest_map;

1346 
	`g‘_m­_bl
(
to
, 
m
->
m­s
[to]);

1347 
	`£nd_m­
(
m
, 
cÚ
);

1351 ià(
to
 > 
sšû
 && (
št64_t
)ÑØ- sšûè> 
cù
->
_cÚf
->
osd_m­_sh¬e_max_•ochs
) {

1352 
	`dout
(10è<< " " << (
to
 - 
sšû
è<< " > max " << 
cù
->
_cÚf
->
osd_m­_sh¬e_max_•ochs


1353 << ", oÆy s’dšg mo¡„eûÁ" << 
d’dl
;

1354 
sšû
 = 
to
 - 
cù
->
_cÚf
->
osd_m­_sh¬e_max_•ochs
;

1357 ià(
to
 - 
sšû
 > (
•och_t
)
cù
->
_cÚf
->
osd_m­_mes§ge_max
)

1358 
to
 = 
sšû
 + 
cù
->
_cÚf
->
osd_m­_mes§ge_max
;

1359 
m
 = 
	`bud_šüem’l_m­_msg
(
sšû
, 
to
, 
sblock
);

1361 
	`£nd_m­
(
m
, 
cÚ
);

1362 
	}
}

1364 
boŞ
 
	gOSDS”viû
::
	$_g‘_m­_bl
(
•och_t
 
e
, 
bufã¾i¡
& 
bl
)

1366 
boŞ
 
found
 = 
m­_bl_ÿche
.
	`lookup
(
e
, &
bl
);

1367 ià(
found
) {

1368 ià(
logg”
)

1369 
logg”
->
	`šc
(
l_osd_m­_bl_ÿche_h™
);

1370  
Œue
;

1372 ià(
logg”
)

1373 
logg”
->
	`šc
(
l_osd_m­_bl_ÿche_miss
);

1374 
found
 = 
¡Üe
->
	`»ad
(
m‘a_ch
,

1375 
OSD
::
	`g‘_osdm­_pobjeù_Çme
(
e
), 0, 0, 
bl
,

1376 
CEPH_OSD_OP_FLAG_FADVISE_WILLNEED
) >= 0;

1377 ià(
found
) {

1378 
	`_add_m­_bl
(
e
, 
bl
);

1380  
found
;

1381 
	}
}

1383 
boŞ
 
	gOSDS”viû
::
	$g‘_šc_m­_bl
(
•och_t
 
e
, 
bufã¾i¡
& 
bl
)

1385 
Mu‹x
::
Lock”
 
	`l
(
m­_ÿche_lock
);

1386 
boŞ
 
found
 = 
m­_bl_šc_ÿche
.
	`lookup
(
e
, &
bl
);

1387 ià(
found
) {

1388 ià(
logg”
)

1389 
logg”
->
	`šc
(
l_osd_m­_bl_ÿche_h™
);

1390  
Œue
;

1392 ià(
logg”
)

1393 
logg”
->
	`šc
(
l_osd_m­_bl_ÿche_miss
);

1394 
found
 = 
¡Üe
->
	`»ad
(
m‘a_ch
,

1395 
OSD
::
	`g‘_šc_osdm­_pobjeù_Çme
(
e
), 0, 0, 
bl
,

1396 
CEPH_OSD_OP_FLAG_FADVISE_WILLNEED
) >= 0;

1397 ià(
found
) {

1398 
	`_add_m­_šc_bl
(
e
, 
bl
);

1400  
found
;

1401 
	}
}

1403 
	gOSDS”viû
::
	$_add_m­_bl
(
•och_t
 
e
, 
bufã¾i¡
& 
bl
)

1405 
	`dout
(10è<< "add_m­_bÈ" << 
e
 << " " << 
bl
.
	`Ëngth
(è<< " by‹s" << 
d’dl
;

1407 ià(
bl
.
	`g‘_num_bufãrs
() > 1) {

1408 
bl
.
	`»bud
();

1410 
bl
.
	`Œy_assign_to_mempoŞ
(
mempoŞ
::
mempoŞ_osd_m­bl
);

1411 
m­_bl_ÿche
.
	`add
(
e
, 
bl
);

1412 
	}
}

1414 
	gOSDS”viû
::
	$_add_m­_šc_bl
(
•och_t
 
e
, 
bufã¾i¡
& 
bl
)

1416 
	`dout
(10è<< "add_m­_šc_bÈ" << 
e
 << " " << 
bl
.
	`Ëngth
(è<< " by‹s" << 
d’dl
;

1418 ià(
bl
.
	`g‘_num_bufãrs
() > 1) {

1419 
bl
.
	`»bud
();

1421 
bl
.
	`Œy_assign_to_mempoŞ
(
mempoŞ
::
mempoŞ_osd_m­bl
);

1422 
m­_bl_šc_ÿche
.
	`add
(
e
, 
bl
);

1423 
	}
}

1425 
	gOSDS”viû
::
	$g‘_d–‘ed_poŞ_pg_num
(
št64_t
 
poŞ
)

1427 
Mu‹x
::
Lock”
 
	`l
(
m­_ÿche_lock
);

1428 autØ
p
 = 
d–‘ed_poŞ_pg_nums
.
	`fšd
(
poŞ
);

1429 ià(
p
 !ğ
d–‘ed_poŞ_pg_nums
.
	`’d
()) {

1430  
p
->
£cÚd
;

1432 
	`dout
(20è<< 
__func__
 << " " << 
poŞ
 << "†ßdšg" << 
d’dl
;

1433 
ghobjeù_t
 
oid
 = 
OSD
::
	`make_fš®_poŞ_šfo_oid
(
poŞ
);

1434 
bufã¾i¡
 
bl
;

1435 
r
 = 
¡Üe
->
	`»ad
(
m‘a_ch
, 
oid
, 0, 0, 
bl
);

1436 
	`ûph_as£¹
(
r
 >= 0);

1437 autØ
bÍ
 = 
bl
.
	`begš
();

1438 
pg_poŞ_t
 
pi
;

1439 ::
	`decode
(
pi
, 
bÍ
);

1440 
d–‘ed_poŞ_pg_nums
[
poŞ
] = 
pi
.
	`g‘_pg_num
();

1441 
	`dout
(20è<< 
__func__
 << " " << 
poŞ
 << " gÙ " << 
pi
.
	`g‘_pg_num
(è<< 
d’dl
;

1442  
pi
.
	`g‘_pg_num
();

1443 
	}
}

1445 
OSDM­Ref
 
	gOSDS”viû
::
	$_add_m­
(
OSDM­
 *
o
)

1447 
•och_t
 
e
 = 
o
->
	`g‘_•och
();

1449 ià(
cù
->
_cÚf
->
osd_m­_dedup
) {

1451 
OSDM­Ref
 
fÜ_dedup
 = 
m­_ÿche
.
	`low”_bound
(
e
);

1452 ià(
fÜ_dedup
) {

1453 
OSDM­
::
	`dedup
(
fÜ_dedup
.
	`g‘
(), 
o
);

1456 
boŞ
 
exi¡ed
;

1457 
OSDM­Ref
 
l
 = 
m­_ÿche
.
	`add
(
e
, 
o
, &
exi¡ed
);

1458 ià(
exi¡ed
) {

1459 
d–‘e
 
o
;

1461  
l
;

1462 
	}
}

1464 
OSDM­Ref
 
	gOSDS”viû
::
	$Œy_g‘_m­
(
•och_t
 
•och
)

1466 
Mu‹x
::
Lock”
 
	`l
(
m­_ÿche_lock
);

1467 
OSDM­Ref
 
»tv®
 = 
m­_ÿche
.
	`lookup
(
•och
);

1468 ià(
»tv®
) {

1469 
	`dout
(30è<< "g‘_m­ " << 
•och
 << " -ÿched" << 
d’dl
;

1470 ià(
logg”
) {

1471 
logg”
->
	`šc
(
l_osd_m­_ÿche_h™
);

1473  
»tv®
;

1475 ià(
logg”
) {

1476 
logg”
->
	`šc
(
l_osd_m­_ÿche_miss
);

1477 
•och_t
 
lb
 = 
m­_ÿche
.
	`ÿched_key_low”_bound
();

1478 ià(
•och
 < 
lb
) {

1479 
	`dout
(30è<< "g‘_m­ " << 
•och
 << " - miss, b–ow†ow” bound" << 
d’dl
;

1480 
logg”
->
	`šc
(
l_osd_m­_ÿche_miss_low
);

1481 
logg”
->
	`šc
(
l_osd_m­_ÿche_miss_low_avg
, 
lb
 - 
•och
);

1485 
OSDM­
 *
m­
 = 
Ãw
 OSDMap;

1486 ià(
•och
 > 0) {

1487 
	`dout
(20è<< "g‘_m­ " << 
•och
 << " -†ßdšg‡nd decodšg " << 
m­
 << 
d’dl
;

1488 
bufã¾i¡
 
bl
;

1489 ià(!
	`_g‘_m­_bl
(
•och
, 
bl
è|| bl.
	`Ëngth
() == 0) {

1490 
d”r
 << "çedØlßd OSD m­ fÜƒpoch " << 
•och
 << ", gÙ " << 
bl
.
	`Ëngth
(è<< " by‹s" << 
d’dl
;

1491 
d–‘e
 
m­
;

1492  
	`OSDM­Ref
();

1494 
m­
->
	`decode
(
bl
);

1496 
	`dout
(20è<< "g‘_m­ " << 
•och
 << " -„‘uº in™ŸÈ" << 
m­
 << 
d’dl
;

1498  
	`_add_m­
(
m­
);

1499 
	}
}

1504 
	gOSDS”viû
::
	$»¶y_İ_”rÜ
(
OpReque¡Ref
 
İ
, 
”r
)

1506 
	`»¶y_İ_”rÜ
(
İ
, 
”r
, 
	`ev”siÚ_t
(), 0);

1507 
	}
}

1509 
	gOSDS”viû
::
	$»¶y_İ_”rÜ
(
OpReque¡Ref
 
İ
, 
”r
, 
ev”siÚ_t
 
v
,

1510 
v”siÚ_t
 
uv
)

1512 cÚ¡ 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDOp*>(
İ
->
	`g‘_»q
());

1513 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
CEPH_MSG_OSD_OP
);

1514 
æags
;

1515 
æags
 = 
m
->
	`g‘_æags
(è& (
CEPH_OSD_FLAG_ACK
|
CEPH_OSD_FLAG_ONDISK
);

1517 
MOSDOpR•ly
 *
»¶y
 = 
Ãw
 
	`MOSDOpR•ly
(
m
, 
”r
, 
osdm­
->
	`g‘_•och
(), 
æags
, 
Œue
);

1518 
»¶y
->
	`£t_»¶y_v”siÚs
(
v
, 
uv
);

1519 
m
->
	`g‘_cÚÃùiÚ
()->
	`£nd_mes§ge
(
»¶y
);

1520 
	}
}

1522 
	gOSDS”viû
::
	$hªdË_misdœeùed_İ
(
PG
 *
pg
, 
OpReque¡Ref
 
İ
)

1524 ià(!
cù
->
_cÚf
->
osd_debug_misdœeùed_İs
) {

1528 cÚ¡ 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDOp*>(
İ
->
	`g‘_»q
());

1529 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
CEPH_MSG_OSD_OP
);

1531 
	`as£¹
(
m
->
	`g‘_m­_•och
(è>ğ
pg
->
	`g‘_hi¡Üy
().
§me_´im¬y_sšû
);

1533 ià(
pg
->
	`is_ec_pg
()) {

1550 
	`as£¹
(
m
->
	`g‘_m­_•och
(è<ğ
su³rblock
.
Ãwe¡_m­
);

1551 
OSDM­Ref
 
İm­
 = 
	`Œy_g‘_m­
(
m
->
	`g‘_m­_•och
());

1552 ià(!
İm­
) {

1553 
	`dout
(7è<< 
__func__
 << ": " << *
pg
 << "‚o†onger have map for "

1554 << 
m
->
	`g‘_m­_•och
(è<< ", drİpšg" << 
d’dl
;

1557 
pg_t
 
_pgid
 = 
m
->
	`g‘_¿w_pg
();

1558 
¥g_t
 
pgid
;

1559 ià((
m
->
	`g‘_æags
(è& 
CEPH_OSD_FLAG_PGOP
) == 0)

1560 
_pgid
 = 
İm­
->
	`¿w_pg_to_pg
(_pgid);

1561 ià(
İm­
->
	`g‘_´im¬y_sh¬d
(
_pgid
, &
pgid
) &&

1562 
pgid
.
sh¬d
 !ğ
pg
->
pg_id
.shard) {

1563 
	`dout
(7è<< 
__func__
 << ": " << *
pg
 << "…rimary changed since "

1564 << 
m
->
	`g‘_m­_•och
(è<< ", drİpšg" << 
d’dl
;

1569 
	`dout
(7è<< *
pg
 << " misdœeùed o°š " << 
m
->
	`g‘_m­_•och
(è<< 
d’dl
;

1570 
şog
->
	`w¬n
(è<< 
m
->
	`g‘_sourû_š¡
(è<< " misdœeùed " << m->
	`g‘_»qid
()

1571 << "…g " << 
m
->
	`g‘_¿w_pg
()

1572 << "Øosd." << 
whßmi


1573 << "‚Ù " << 
pg
->
	`g‘_aùšg
()

1574 << " iÀe" << 
m
->
	`g‘_m­_•och
(è<< "/" << 
osdm­
->
	`g‘_•och
();

1575 
	}
}

1577 
	gOSDS”viû
::
	$’queue_back
(
OpQueueI‹m
&& 
qi
)

1579 
osd
->
İ_sh¬dedwq
.
	`queue
(
¡d
::
	`move
(
qi
));

1580 
	}
}

1582 
	gOSDS”viû
::
	$’queue_äÚt
(
OpQueueI‹m
&& 
qi
)

1584 
osd
->
İ_sh¬dedwq
.
	`queue_äÚt
(
¡d
::
	`move
(
qi
));

1585 
	}
}

1587 
	gOSDS”viû
::
queue_»cov”y_cÚ‹xt
(

1588 
PG
 *
pg
,

1589 
G’CÚ‹xt
<
Th»adPoŞ
::
TPHªdË
&> *
c
)

1591 
•och_t
 
e
 = 
g‘_osdm­_•och
();

1592 
’queue_back
(

1593 
OpQueueI‹m
(

1594 
unique_±r
<
OpQueueI‹m
::
OpQueu—bË
>(

1595 
Ãw
 
PGRecov”yCÚ‹xt
(
pg
->
g‘_pgid
(), 
c
, 
e
)),

1596 
cù
->
_cÚf
->
osd_»cov”y_co¡
,

1597 
cù
->
_cÚf
->
osd_»cov”y_´iÜ™y
,

1598 
ûph_şock_now
(),

1600 
e
));

1603 
	gOSDS”viû
::
	$queue_fÜ_¢­_Œim
(
PG
 *
pg
)

1605 
	`dout
(10è<< "queuešg " << *
pg
 << " fÜ sÇ±rim" << 
d’dl
;

1606 
	`’queue_back
(

1607 
	`OpQueueI‹m
(

1608 
unique_±r
<
OpQueueI‹m
::
OpQueu—bË
>(

1609 
Ãw
 
	`PGSÇpTrim
(
pg
->
	`g‘_pgid
(),…g->
	`g‘_osdm­_•och
())),

1610 
cù
->
_cÚf
->
osd_¢­_Œim_co¡
,

1611 
cù
->
_cÚf
->
osd_¢­_Œim_´iÜ™y
,

1612 
	`ûph_şock_now
(),

1614 
pg
->
	`g‘_osdm­_•och
()));

1615 
	}
}

1617 
	gOSDS”viû
::
	$queue_fÜ_süub
(
PG
 *
pg
, 
boŞ
 
w™h_high_´iÜ™y
)

1619 
süub_queue_´iÜ™y
 = 
pg
->
süubb”
.
´iÜ™y
;

1620 ià(
w™h_high_´iÜ™y
 && 
süub_queue_´iÜ™y
 < 
cù
->
_cÚf
->
osd_ş›Á_İ_´iÜ™y
) {

1621 
süub_queue_´iÜ™y
 = 
cù
->
_cÚf
->
osd_ş›Á_İ_´iÜ™y
;

1623 cÚ¡‡utØ
•och
 = 
pg
->
	`g‘_osdm­_•och
();

1624 
	`’queue_back
(

1625 
	`OpQueueI‹m
(

1626 
unique_±r
<
OpQueueI‹m
::
OpQueu—bË
>(
Ãw
 
	`PGSüub
(
pg
->
	`g‘_pgid
(), 
•och
)),

1627 
cù
->
_cÚf
->
osd_süub_co¡
,

1628 
süub_queue_´iÜ™y
,

1629 
	`ûph_şock_now
(),

1631 
•och
));

1632 
	}
}

1634 
	gOSDS”viû
::
	$queue_fÜ_pg_d–‘e
(
¥g_t
 
pgid
, 
•och_t
 
e
)

1636 
	`dout
(10è<< 
__func__
 << " oÀ" << 
pgid
 << "ƒ " << 
e
 << 
d’dl
;

1637 
	`’queue_back
(

1638 
	`OpQueueI‹m
(

1639 
unique_±r
<
OpQueueI‹m
::
OpQueu—bË
>(

1640 
Ãw
 
	`PGD–‘e
(
pgid
, 
e
)),

1641 
cù
->
_cÚf
->
osd_pg_d–‘e_co¡
,

1642 
cù
->
_cÚf
->
osd_pg_d–‘e_´iÜ™y
,

1643 
	`ûph_şock_now
(),

1645 
e
));

1646 
	}
}

1648 
	gOSDS”viû
::
	$fšish_pg_d–‘e
(
PG
 *
pg
, 
Şd_pg_num
)

1651 ià(
pg
->
	`is_´im¬y
())

1652 
logg”
->
	`dec
(
l_osd_pg_´im¬y
);

1653 ià(
pg
->
	`is_»¶iÿ
())

1654 
logg”
->
	`dec
(
l_osd_pg_»¶iÿ
);

1656 
logg”
->
	`dec
(
l_osd_pg_¡¿y
);

1658 
osd
->
	`uÄegi¡”_pg
(
pg
);

1659 autØ
sh¬d
 : 
osd
->
sh¬ds
) {

1660 
sh¬d
->
	`uÅrime_¥l™_chd»n
(
pg
->
pg_id
, 
Şd_pg_num
);

1662 
	}
}

1664 
	gOSDS”viû
::
_queue_fÜ_»cov”y
(

1665 
¡d
::
·œ
<
•och_t
, 
PGRef
> 
p
,

1666 
ušt64_t
 
»£rved_pushes
)

1668 
as£¹
(
»cov”y_lock
.
is_locked_by_me
());

1669 
’queue_back
(

1670 
OpQueueI‹m
(

1671 
unique_±r
<
OpQueueI‹m
::
OpQueu—bË
>(

1672 
Ãw
 
PGRecov”y
(

1673 
p
.
£cÚd
->
g‘_pgid
(),….
fœ¡
, 
»£rved_pushes
)),

1674 
cù
->
_cÚf
->
osd_»cov”y_co¡
,

1675 
cù
->
_cÚf
->
osd_»cov”y_´iÜ™y
,

1676 
ûph_şock_now
(),

1678 
p
.
fœ¡
));

1684 #undeà
dout_´efix


1685 
	#dout_´efix
 *
_dout


	)

1688 
Çme¥aû
 
	gûph
 {

1689 
Çme¥aû
 
	gosd_cmds
 {

1691 
h—p
(
C•hCÚ‹xt
& 
cù
, cÚ¡ 
cmdm­_t
& 
cmdm­
, 
FÜm©‹r
& 
f
, 
¡d
::
o¡»am
& 
os
);

1695 
	gOSD
::
	$mkfs
(
C•hCÚ‹xt
 *
cù
, 
ObjeùStÜe
 *
¡Üe
, cÚ¡ 
¡ršg
 &
dev
,

1696 
uuid_d
 
fsid
, 
whßmi
)

1698 
»t
;

1700 
OSDSu³rblock
 
sb
;

1701 
bufã¾i¡
 
sbbl
;

1702 
ObjeùStÜe
::
CŞËùiÚHªdË
 
ch
;

1705 
¡Üe
->
	`£t_fsid
(
cù
->
_cÚf
->
osd_uuid
);

1707 
»t
 = 
¡Üe
->
	`mkfs
();

1708 ià(
»t
) {

1709 
d”r
 << "OSD::mkfs: ObjectStore::mkfs failed withƒrror "

1710 << 
	`ıp_¡»¼Ü
(
»t
è<< 
d’dl
;

1711 
ä“_¡Üe
;

1714 
¡Üe
->
	`£t_ÿche_sh¬ds
(1);

1716 
»t
 = 
¡Üe
->
	`mouÁ
();

1717 ià(
»t
) {

1718 
d”r
 << "OSD::mkfs: couldn't mount ObjectStore:ƒrror "

1719 << 
	`ıp_¡»¼Ü
(
»t
è<< 
d’dl
;

1720 
ä“_¡Üe
;

1723 
ch
 = 
¡Üe
->
	`İ’_cŞËùiÚ
(
cŞl_t
::
	`m‘a
());

1724 ià(
ch
) {

1725 
»t
 = 
¡Üe
->
	`»ad
(
ch
, 
OSD_SUPERBLOCK_GOBJECT
, 0, 0, 
sbbl
);

1726 ià(
»t
 < 0) {

1727 
d”r
 << "OSD::mkfs: havm‘¨cŞËùiÚ buˆnØsu³rblock" << 
d’dl
;

1728 
ä“_¡Üe
;

1731 
	`dout
(0è<< " havsu³rblock" << 
d’dl
;

1732 
bufã¾i¡
::
™”©Ü
 
p
;

1733 
p
 = 
sbbl
.
	`begš
();

1734 
	`decode
(
sb
, 
p
);

1735 ià(
whßmi
 !ğ
sb
.whoami) {

1736 
d”r
 << "´ovided osd id " << 
whßmi
 << " !ğsu³rblock' " << 
sb
.whoami

1737 << 
d’dl
;

1738 
»t
 = -
EINVAL
;

1739 
umouÁ_¡Üe
;

1741 ià(
fsid
 !ğ
sb
.
şu¡”_fsid
) {

1742 
d”r
 << "´ovided clu¡” fsid " << 
fsid


1743 << " !ğsu³rblock' " << 
sb
.
şu¡”_fsid
 << 
d’dl
;

1744 
»t
 = -
EINVAL
;

1745 
umouÁ_¡Üe
;

1749 
sb
.
şu¡”_fsid
 = 
fsid
;

1750 
sb
.
osd_fsid
 = 
¡Üe
->
	`g‘_fsid
();

1751 
sb
.
whßmi
 = whoami;

1752 
sb
.
com·t_ã©u»s
 = 
	`g‘_osd_š™Ÿl_com·t_£t
();

1754 
bufã¾i¡
 
bl
;

1755 
	`’code
(
sb
, 
bl
);

1757 
ObjeùStÜe
::
CŞËùiÚHªdË
 
ch
 = 
¡Üe
->
	`ü—‹_Ãw_cŞËùiÚ
(

1758 
cŞl_t
::
	`m‘a
());

1759 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

1760 
t
.
	`ü—‹_cŞËùiÚ
(
cŞl_t
::
	`m‘a
(), 0);

1761 
t
.
	`wr™e
(
cŞl_t
::
	`m‘a
(), 
OSD_SUPERBLOCK_GOBJECT
, 0, 
bl
.
	`Ëngth
(), bl);

1762 
»t
 = 
¡Üe
->
	`queue_Œª§ùiÚ
(
ch
, 
¡d
::
	`move
(
t
));

1763 ià(
»t
) {

1764 
d”r
 << "OSD::mkfs:ƒrror while writing OSD_SUPERBLOCK_GOBJECT: "

1765 << "queue_Œª§ùiÚ„‘uºed " << 
	`ıp_¡»¼Ü
(
»t
è<< 
d’dl
;

1766 
umouÁ_¡Üe
;

1770 
»t
 = 
	`wr™e_m‘a
(
cù
, 
¡Üe
, 
sb
.
şu¡”_fsid
, sb.
osd_fsid
, 
whßmi
);

1771 ià(
»t
) {

1772 
d”r
 << "OSD::mkfs: failedo write fsid file:ƒrror "

1773 << 
	`ıp_¡»¼Ü
(
»t
è<< 
d’dl
;

1774 
umouÁ_¡Üe
;

1777 
umouÁ_¡Üe
:

1778 
¡Üe
->
	`umouÁ
();

1779 
ä“_¡Üe
:

1780 
d–‘e
 
¡Üe
;

1781  
»t
;

1782 
	}
}

1784 
	gOSD
::
	$wr™e_m‘a
(
C•hCÚ‹xt
 *
cù
, 
ObjeùStÜe
 *
¡Üe
, 
uuid_d
& 
şu¡”_fsid
, uuid_d& 
osd_fsid
, 
whßmi
)

1786 
v®
[80];

1787 
r
;

1789 
	`¢´štf
(
v®
, (v®), "%s", 
CEPH_OSD_ONDISK_MAGIC
);

1790 
r
 = 
¡Üe
->
	`wr™e_m‘a
("magic", 
v®
);

1791 ià(
r
 < 0)

1792  
r
;

1794 
	`¢´štf
(
v®
, (v®), "%d", 
whßmi
);

1795 
r
 = 
¡Üe
->
	`wr™e_m‘a
("whßmi", 
v®
);

1796 ià(
r
 < 0)

1797  
r
;

1799 
şu¡”_fsid
.
	`´št
(
v®
);

1800 
r
 = 
¡Üe
->
	`wr™e_m‘a
("ûph_fsid", 
v®
);

1801 ià(
r
 < 0)

1802  
r
;

1804 
¡ršg
 
key
 = 
cù
->
_cÚf
->
g‘_v®
<string>("key");

1805 ià(
key
.
	`size
()) {

1806 
r
 = 
¡Üe
->
	`wr™e_m‘a
("osd_key", 
key
);

1807 ià(
r
 < 0)

1808  
r
;

1810 
¡ršg
 
keyfe
 = 
cù
->
_cÚf
->
g‘_v®
<string>("keyfile");

1811 ià(!
keyfe
.
	`em±y
()) {

1812 
bufã¾i¡
 
keybl
;

1813 
¡ršg
 
”r
;

1814 
r
 = 
keybl
.
	`»ad_fe
(
keyfe
.
	`c_¡r
(), &
”r
);

1815 ià(
r
 < 0) {

1816 
d”r
 << 
__func__
 << " faedØ»ad keyf" << 
keyfe
 << ": "

1817 << 
”r
 << ": " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

1818  
r
;

1820 
r
 = 
¡Üe
->
	`wr™e_m‘a
("osd_key", 
keybl
.
	`to_¡r
());

1821 ià(
r
 < 0)

1822  
r
;

1826 
r
 = 
¡Üe
->
	`wr™e_m‘a
("ready", "ready");

1827 ià(
r
 < 0)

1828  
r
;

1831 
	}
}

1833 
	gOSD
::
	$³ek_m‘a
(
ObjeùStÜe
 *
¡Üe
, 
¡d
::
¡ršg
& 
magic
,

1834 
uuid_d
& 
şu¡”_fsid
, uuid_d& 
osd_fsid
, & 
whßmi
)

1836 
¡ršg
 
v®
;

1838 
r
 = 
¡Üe
->
	`»ad_m‘a
("magic", &
v®
);

1839 ià(
r
 < 0)

1840  
r
;

1841 
magic
 = 
v®
;

1843 
r
 = 
¡Üe
->
	`»ad_m‘a
("whßmi", &
v®
);

1844 ià(
r
 < 0)

1845  
r
;

1846 
whßmi
 = 
	`©oi
(
v®
.
	`c_¡r
());

1848 
r
 = 
¡Üe
->
	`»ad_m‘a
("ûph_fsid", &
v®
);

1849 ià(
r
 < 0)

1850  
r
;

1851 
r
 = 
şu¡”_fsid
.
	`·r£
(
v®
.
	`c_¡r
());

1852 ià(!
r
)

1853  -
EINVAL
;

1855 
r
 = 
¡Üe
->
	`»ad_m‘a
("fsid", &
v®
);

1856 ià(
r
 < 0) {

1857 
osd_fsid
 = 
	`uuid_d
();

1859 
r
 = 
osd_fsid
.
	`·r£
(
v®
.
	`c_¡r
());

1860 ià(!
r
)

1861  -
EINVAL
;

1865 
	}
}

1868 #undeà
dout_´efix


1869 
	#dout_´efix
 
	`_´efix
(
_dout
, 
whßmi
, 
	`g‘_osdm­_•och
())

	)

1873 
	gOSD
::
	$OSD
(
C•hCÚ‹xt
 *
cù_
, 
ObjeùStÜe
 *
¡Üe_
,

1874 
id
,

1875 
Mes£ng”
 *
š‹º®_mes£ng”
,

1876 
Mes£ng”
 *
ex‹º®_mes£ng”
,

1877 
Mes£ng”
 *
hb_ş›Á_äÚt
,

1878 
Mes£ng”
 *
hb_ş›Á_back
,

1879 
Mes£ng”
 *
hb_äÚt_£rv”m
,

1880 
Mes£ng”
 *
hb_back_£rv”m
,

1881 
Mes£ng”
 *
osdc_mes£ng”
,

1882 
MÚCl›Á
 *
mc
,

1883 cÚ¡ 
¡d
::
¡ršg
 &
dev
, cÚ¡ std::¡ršg &
jdev
) :

1884 
	`Di¥©ch”
(
cù_
),

1885 
	`osd_lock
("OSD::osd_lock"),

1886 
	`tick_tim”
(
cù
, 
osd_lock
),

1887 
	`tick_tim”_lock
("OSD::tick_timer_lock"),

1888 
	`tick_tim”_w™hout_osd_lock
(
cù
, 
tick_tim”_lock
),

1889 
	`authÜize_hªdËr_şu¡”_»gi¡ry
(
Ãw
 
	`AuthAuthÜizeHªdËrRegi¡ry
(
cù
,

1890 
cù
->
_cÚf
->
auth_suµÜ‹d
.
	`em±y
() ?

1891 
cù
->
_cÚf
->
auth_şu¡”_»quœed
 :

1892 
cù
->
_cÚf
->
auth_suµÜ‹d
)),

1893 
	`authÜize_hªdËr_£rviû_»gi¡ry
(
Ãw
 
	`AuthAuthÜizeHªdËrRegi¡ry
(
cù
,

1894 
cù
->
_cÚf
->
auth_suµÜ‹d
.
	`em±y
() ?

1895 
cù
->
_cÚf
->
auth_£rviû_»quœed
 :

1896 
cù
->
_cÚf
->
auth_suµÜ‹d
)),

1897 
	`şu¡”_mes£ng”
(
š‹º®_mes£ng”
),

1898 
	`ş›Á_mes£ng”
(
ex‹º®_mes£ng”
),

1899 
	`objeù”_mes£ng”
(
osdc_mes£ng”
),

1900 
	`mÚc
(
mc
),

1901 
	`mgrc
(
cù_
, 
ş›Á_mes£ng”
),

1902 
	`logg”
(
NULL
),

1903 
	`»cov”y¡©e_³rf
(
NULL
),

1904 
	`¡Üe
(
¡Üe_
),

1905 
	`log_ş›Á
(
cù
, 
ş›Á_mes£ng”
, &
mc
->
mÚm­
, 
LogCl›Á
::
NO_FLAGS
),

1906 
	`şog
(
log_ş›Á
.
	`ü—‹_chªÃl
()),

1907 
	`whßmi
(
id
),

1908 
	`dev_·th
(
dev
), 
	`jouº®_·th
(
jdev
),

1909 
	`¡Üe_is_rÙ©iÚ®
(
¡Üe
->
	`is_rÙ©iÚ®
()),

1910 
	`Œaû_’dpošt
("0.0.0.0", 0, "osd"),

1911 
	`asok_hook
(
NULL
),

1912 
	`m_osd_pg_•och_max_Ïg_çùÜ
(
cù
->
_cÚf
->
g‘_v®
<>(

1914 
	`osd_com·t
(
	`g‘_osd_com·t_£t
()),

1915 
	`osd_İ_
(
cù
, "OSD::osd_op_tp", "tp_osd_tp",

1916 
	`g‘_num_İ_th»ads
()),

1917 
	`commªd_
(
cù
, "OSD::command_tp", "tp_osd_cmd", 1),

1918 
	`£ssiÚ_wa™šg_lock
("OSD::session_waiting_lock"),

1919 
	`osdm­_subsüibe_lock
("OSD::osdmap_subscribe_lock"),

1920 
	`h—¹b—t_lock
("OSD::heartbeat_lock"),

1921 
	`h—¹b—t_¡İ
(
çl£
),

1922 
	`h—¹b—t_Ãed_upd©e
(
Œue
),

1923 
	`hb_äÚt_ş›Á_mes£ng”
(
hb_ş›Á_äÚt
),

1924 
	`hb_back_ş›Á_mes£ng”
(
hb_ş›Á_back
),

1925 
	`hb_äÚt_£rv”_mes£ng”
(
hb_äÚt_£rv”m
),

1926 
	`hb_back_£rv”_mes£ng”
(
hb_back_£rv”m
),

1927 
	`day_lßdavg
(0.0),

1928 
	`h—¹b—t_th»ad
(
this
),

1929 
	`h—¹b—t_di¥©ch”
(
this
),

1930 
	`İ_Œack”
(
cù
, cù->
_cÚf
->
osd_’abË_İ_Œack”
,

1931 
cù
->
_cÚf
->
osd_num_İ_Œack”_sh¬d
),

1932 
	`‹¡_İs_hook
(
NULL
),

1933 
	`İ_queue
(
	`g‘_io_queue
()),

1934 
	`İ_´io_cutoff
(
	`g‘_io_´io_cut
()),

1935 
	`İ_sh¬dedwq
(

1936 
this
,

1937 
cù
->
_cÚf
->
osd_İ_th»ad_timeout
,

1938 
cù
->
_cÚf
->
osd_İ_th»ad_suicide_timeout
,

1939 &
osd_İ_
),

1940 
	`m­_lock
("OSD::map_lock"),

1941 
	`Ï¡_pg_ü—‹_•och
(0),

1942 
	`mÚ_»pÜt_lock
("OSD::mon_report_lock"),

1943 
	`up_thru_wª‹d
(0),

1944 
	`»que¡ed_fuÎ_fœ¡
(0),

1945 
	`»que¡ed_fuÎ_Ï¡
(0),

1946 
	`commªd_wq
(

1947 
this
,

1948 
cù
->
_cÚf
->
osd_commªd_th»ad_timeout
,

1949 
cù
->
_cÚf
->
osd_commªd_th»ad_suicide_timeout
,

1950 &
commªd_
),

1951 
	$£rviû
(
this
)

1953 
mÚc
->
	`£t_mes£ng”
(
ş›Á_mes£ng”
);

1954 
İ_Œack”
.
	`£t_com¶ašt_ªd_th»shŞd
(
cù
->
_cÚf
->
osd_İ_com¶ašt_time
,

1955 
cù
->
_cÚf
->
osd_İ_log_th»shŞd
);

1956 
İ_Œack”
.
	`£t_hi¡Üy_size_ªd_du¿tiÚ
(
cù
->
_cÚf
->
osd_İ_hi¡Üy_size
,

1957 
cù
->
_cÚf
->
osd_İ_hi¡Üy_du¿tiÚ
);

1958 
İ_Œack”
.
	`£t_hi¡Üy_¦ow_İ_size_ªd_th»shŞd
(
cù
->
_cÚf
->
osd_İ_hi¡Üy_¦ow_İ_size
,

1959 
cù
->
_cÚf
->
osd_İ_hi¡Üy_¦ow_İ_th»shŞd
);

1960 #ifdeà
WITH_BLKIN


1961 
¡d
::
¡ršg¡»am
 
ss
;

1962 
ss
 << "osd." << 
whßmi
;

1963 
Œaû_’dpošt
.
	`cİy_Çme
(
ss
.
	`¡r
());

1967 
num_sh¬ds
 = 
	`g‘_num_İ_sh¬ds
();

1968 
ušt32_t
 
i
 = 0; i < 
num_sh¬ds
; i++) {

1969 
OSDSh¬d
 *
Úe_sh¬d
 = 
Ãw
 
	`OSDSh¬d
(

1970 
i
,

1971 
cù
,

1972 
this
,

1973 
cù
->
_cÚf
->
osd_İ_pq_max_tok’s_³r_´iÜ™y
,

1974 
cù
->
_cÚf
->
osd_İ_pq_mš_co¡
,

1975 
İ_queue
);

1976 
sh¬ds
.
	`push_back
(
Úe_sh¬d
);

1978 
	}
}

1980 
	gOSD
::~
	$OSD
()

1982 !
sh¬ds
.
	`em±y
()) {

1983 
d–‘e
 
sh¬ds
.
	`back
();

1984 
sh¬ds
.
	`pİ_back
();

1986 
d–‘e
 
authÜize_hªdËr_şu¡”_»gi¡ry
;

1987 
d–‘e
 
authÜize_hªdËr_£rviû_»gi¡ry
;

1988 
d–‘e
 
şass_hªdËr
;

1989 
cù
->
	`g‘_³rfcouÁ”s_cŞËùiÚ
()->
	`»move
(
»cov”y¡©e_³rf
);

1990 
cù
->
	`g‘_³rfcouÁ”s_cŞËùiÚ
()->
	`»move
(
logg”
);

1991 
d–‘e
 
»cov”y¡©e_³rf
;

1992 
d–‘e
 
logg”
;

1993 
d–‘e
 
¡Üe
;

1994 
	}
}

1996 
şs_š™Ÿlize
(
CÏssHªdËr
 *
ch
);

1998 
	gOSD
::
	$hªdË_sigÇl
(
signum
)

2000 
	`as£¹
(
signum
 =ğ
SIGINT
 || signum =ğ
SIGTERM
);

2001 
d”r
 << "*** GÙ sigÇÈ" << 
	`sig_¡r
(
signum
è<< " ***" << 
d’dl
;

2002 
	`shutdown
();

2003 
	}
}

2005 
	gOSD
::
	$´e_š™
()

2007 
Mu‹x
::
Lock”
 
	`lock
(
osd_lock
);

2008 ià(
	`is_¡İpšg
())

2011 ià(
¡Üe
->
	`‹¡_mouÁ_š_u£
()) {

2012 
d”r
 << "OSD::´e_š™: objeù stÜ'" << 
dev_·th
 << "' is "

2013 << "cu¼’y iÀu£. (I ûph-osd‡Ì—dy„uÂšg?)" << 
d’dl
;

2014  -
EBUSY
;

2017 
cù
->
_cÚf
->
	`add_ob£rv”
(
this
);

2019 
	}
}

2023 şas 
	cOSDSock‘Hook
 : 
public
 
AdmšSock‘Hook
 {

2024 
OSD
 *
osd
;

2025 
	mpublic
:

2026 
ex¶ic™
 
	$OSDSock‘Hook
(
OSD
 *
o
è: 
	$osd
(
o
) {}

2027 
boŞ
 
	$ÿÎ
(
¡d
::
¡ršg_v›w
 
admš_commªd
, cÚ¡ 
cmdm­_t
& 
cmdm­
,

2028 
¡d
::
¡ršg_v›w
 
fÜm©
, 
bufã¾i¡
& 
out
è
ov”ride
 {

2029 
¡ršg¡»am
 
ss
;

2030 
boŞ
 
r
 = 
osd
->
	`asok_commªd
(
admš_commªd
, 
cmdm­
, 
fÜm©
, 
ss
);

2031 
out
.
	`­³nd
(
ss
);

2032  
r
;

2033 
	}
}

2036 
	g¡d
::
£t
<
št64_t
> 
OSD
::
	$g‘_m­³d_poŞs
()

2038 
¡d
::
£t
<
št64_t
> 
poŞs
;

2039 
¡d
::
veùÜ
<
¥g_t
> 
pgids
;

2040 
	`_g‘_pgids
(&
pgids
);

2041 cÚ¡‡utØ&
pgid
 : 
pgids
) {

2042 
poŞs
.
	`š£¹
(
pgid
.
	`poŞ
());

2044  
poŞs
;

2045 
	}
}

2047 
boŞ
 
	gOSD
::
	$asok_commªd
(
¡d
::
¡ršg_v›w
 
admš_commªd
, cÚ¡ 
cmdm­_t
& 
cmdm­
,

2048 
¡d
::
¡ršg_v›w
 
fÜm©
, 
o¡»am
& 
ss
)

2050 
FÜm©‹r
 *
f
 = FÜm©‹r::
	`ü—‹
(
fÜm©
, "json-pretty", "json-pretty");

2051 ià(
admš_commªd
 == "status") {

2052 
f
->
	`İ’_objeù_£ùiÚ
("status");

2053 
f
->
	`dump_¡»am
("şu¡”_fsid"è<< 
su³rblock
.
şu¡”_fsid
;

2054 
f
->
	`dump_¡»am
("osd_fsid"è<< 
su³rblock
.
osd_fsid
;

2055 
f
->
	`dump_unsigÃd
("whßmi", 
su³rblock
.
whßmi
);

2056 
f
->
	`dump_¡ršg
("¡©e", 
	`g‘_¡©e_Çme
(
	`g‘_¡©e
()));

2057 
f
->
	`dump_unsigÃd
("Şde¡_m­", 
su³rblock
.
Şde¡_m­
);

2058 
f
->
	`dump_unsigÃd
("Ãwe¡_m­", 
su³rblock
.
Ãwe¡_m­
);

2059 
f
->
	`dump_unsigÃd
("num_pgs", 
num_pgs
);

2060 
f
->
	`şo£_£ùiÚ
();

2061 } ià(
admš_commªd
 == "flush_journal") {

2062 
¡Üe
->
	`æush_jouº®
();

2063 } ià(
admš_commªd
 == "dump_ops_in_flight" ||

2064 
admš_commªd
 == "ops" ||

2065 
admš_commªd
 == "dump_blocked_ops" ||

2066 
admš_commªd
 == "dump_historic_ops" ||

2067 
admš_commªd
 == "dump_historic_ops_by_duration" ||

2068 
admš_commªd
 == "dump_historic_slow_ops") {

2070 cÚ¡ 
¡ršg
 
”rÜ_¡r
 = "op_trackerracking is‚otƒnabled‚ow, so‚o ops‡reracked currently, \
hose get stuck. Pleaseƒnable \"osd_enable_op_tracker\",‡ndheracker \
 startorack‚ew ops„eceived‡fterwards.";

2074 
£t
<
¡ršg
> 
f‹rs
;

2075 
veùÜ
<
¡ršg
> 
f‹r_¡r
;

2076 ià(
	`cmd_g‘v®
(
cù
, 
cmdm­
, "f‹r¡r", 
f‹r_¡r
)) {

2077 
	`cİy
(
f‹r_¡r
.
	`begš
(), f‹r_¡r.
	`’d
(),

2078 
	`š£¹”
(
f‹rs
, f‹rs.
	`’d
()));

2081 ià(
admš_commªd
 == "dump_ops_in_flight" ||

2082 
admš_commªd
 == "ops") {

2083 ià(!
İ_Œack”
.
	`dump_İs_š_æight
(
f
, 
çl£
, 
f‹rs
)) {

2084 
ss
 << 
”rÜ_¡r
;

2087 ià(
admš_commªd
 == "dump_blocked_ops") {

2088 ià(!
İ_Œack”
.
	`dump_İs_š_æight
(
f
, 
Œue
, 
f‹rs
)) {

2089 
ss
 << 
”rÜ_¡r
;

2092 ià(
admš_commªd
 == "dump_historic_ops") {

2093 ià(!
İ_Œack”
.
	`dump_hi¡Üic_İs
(
f
, 
çl£
, 
f‹rs
)) {

2094 
ss
 << 
”rÜ_¡r
;

2097 ià(
admš_commªd
 == "dump_historic_ops_by_duration") {

2098 ià(!
İ_Œack”
.
	`dump_hi¡Üic_İs
(
f
, 
Œue
, 
f‹rs
)) {

2099 
ss
 << 
”rÜ_¡r
;

2102 ià(
admš_commªd
 == "dump_historic_slow_ops") {

2103 ià(!
İ_Œack”
.
	`dump_hi¡Üic_¦ow_İs
(
f
, 
f‹rs
)) {

2104 
ss
 << 
”rÜ_¡r
;

2107 } ià(
admš_commªd
 == "dump_op_pq_state") {

2108 
f
->
	`İ’_objeù_£ùiÚ
("pq");

2109 
İ_sh¬dedwq
.
	`dump
(
f
);

2110 
f
->
	`şo£_£ùiÚ
();

2111 } ià(
admš_commªd
 == "dump_blacklist") {

2112 
li¡
<
·œ
<
’t™y_addr_t
,
utime_t
> > 
bl
;

2113 
OSDM­Ref
 
curm­
 = 
£rviû
.
	`g‘_osdm­
();

2115 
f
->
	`İ’_¬¿y_£ùiÚ
("blacklist");

2116 
curm­
->
	`g‘_bÏckli¡
(&
bl
);

2117 
li¡
<
·œ
<
’t™y_addr_t
,
utime_t
> >::
™”©Ü
 
™
 = 
bl
.
	`begš
();

2118 
™
 !ğ
bl
.
	`’d
(); ++it) {

2119 
f
->
	`İ’_objeù_£ùiÚ
("entry");

2120 
f
->
	`İ’_objeù_£ùiÚ
("entity_addr_t");

2121 
™
->
fœ¡
.
	`dump
(
f
);

2122 
f
->
	`şo£_£ùiÚ
();

2123 
™
->
£cÚd
.
	`loÿÉime
(
f
->
	`dump_¡»am
("expire_time"));

2124 
f
->
	`şo£_£ùiÚ
();

2126 
f
->
	`şo£_£ùiÚ
();

2127 } ià(
admš_commªd
 == "dump_watchers") {

2128 
li¡
<
obj_w©ch_™em_t
> 
w©ch”s
;

2130 
veùÜ
<
PGRef
> 
pgs
;

2131 
	`_g‘_pgs
(&
pgs
);

2132 auto& 
pg
 : 
pgs
) {

2133 
li¡
<
obj_w©ch_™em_t
> 
pg_w©ch”s
;

2134 
pg
->
	`g‘_w©ch”s
(&
pg_w©ch”s
);

2135 
w©ch”s
.
	`¥liû
(w©ch”s.
	`’d
(), 
pg_w©ch”s
);

2138 
f
->
	`İ’_¬¿y_£ùiÚ
("watchers");

2139 
li¡
<
obj_w©ch_™em_t
>::
™”©Ü
 
™
 = 
w©ch”s
.
	`begš
();

2140 
™
 !ğ
w©ch”s
.
	`’d
(); ++it) {

2142 
f
->
	`İ’_objeù_£ùiÚ
("watch");

2144 
f
->
	`dump_¡ršg
("Çme¥aû", 
™
->
obj
.
n¥aû
);

2145 
f
->
	`dump_¡ršg
("objeù", 
™
->
obj
.
oid
.
Çme
);

2147 
f
->
	`İ’_objeù_£ùiÚ
("entity_name");

2148 
™
->
wi
.
Çme
.
	`dump
(
f
);

2149 
f
->
	`şo£_£ùiÚ
();

2151 
f
->
	`dump_unsigÃd
("cook›", 
™
->
wi
.
cook›
);

2152 
f
->
	`dump_unsigÃd
("timeout", 
™
->
wi
.
timeout_£cÚds
);

2154 
f
->
	`İ’_objeù_£ùiÚ
("entity_addr_t");

2155 
™
->
wi
.
addr
.
	`dump
(
f
);

2156 
f
->
	`şo£_£ùiÚ
();

2158 
f
->
	`şo£_£ùiÚ
();

2161 
f
->
	`şo£_£ùiÚ
();

2162 } ià(
admš_commªd
 == "dump_reservations") {

2163 
f
->
	`İ’_objeù_£ùiÚ
("reservations");

2164 
f
->
	`İ’_objeù_£ùiÚ
("local_reservations");

2165 
£rviû
.
loÿl_»£rv”
.
	`dump
(
f
);

2166 
f
->
	`şo£_£ùiÚ
();

2167 
f
->
	`İ’_objeù_£ùiÚ
("remote_reservations");

2168 
£rviû
.
»mÙe_»£rv”
.
	`dump
(
f
);

2169 
f
->
	`şo£_£ùiÚ
();

2170 
f
->
	`şo£_£ùiÚ
();

2171 } ià(
admš_commªd
 == "get_latest_osdmap") {

2172 
	`g‘_Ï‹¡_osdm­
();

2173 } ià(
admš_commªd
 == "heap") {

2174 autØ
»suÉ
 = 
ûph
::
osd_cmds
::
	`h—p
(*
cù
, 
cmdm­
, *
f
, 
ss
);

2177 
f
->
	`İ’_objeù_£ùiÚ
("result");

2178 
f
->
	`dump_¡ršg
("”rÜ", 
	`ıp_¡»¼Ü
(
»suÉ
));

2179 
f
->
	`dump_boŞ
("sucûss", 
»suÉ
 >= 0);

2180 
f
->
	`şo£_£ùiÚ
();

2181 } ià(
admš_commªd
 == "set_heap_property") {

2182 
¡ršg
 
´İ”ty
;

2183 
št64_t
 
v®ue
 = 0;

2184 
¡ršg
 
”rÜ
;

2185 
boŞ
 
sucûss
 = 
çl£
;

2186 ià(!
	`cmd_g‘v®
(
cù
, 
cmdm­
, "´İ”ty", 
´İ”ty
)) {

2187 
”rÜ
 = "unableo get…roperty";

2188 
sucûss
 = 
çl£
;

2189 } ià(!
	`cmd_g‘v®
(
cù
, 
cmdm­
, "v®ue", 
v®ue
)) {

2190 
”rÜ
 = "unableo get value";

2191 
sucûss
 = 
çl£
;

2192 } ià(
v®ue
 < 0) {

2193 
”rÜ
 = "negative value‚ot‡llowed";

2194 
sucûss
 = 
çl£
;

2195 } ià(!
	`ûph_h—p_£t_num”ic_´İ”ty
(
´İ”ty
.
	`c_¡r
(), (
size_t
)
v®ue
)) {

2196 
”rÜ
 = "invalid…roperty";

2197 
sucûss
 = 
çl£
;

2199 
sucûss
 = 
Œue
;

2201 
f
->
	`İ’_objeù_£ùiÚ
("result");

2202 
f
->
	`dump_¡ršg
("”rÜ", 
”rÜ
);

2203 
f
->
	`dump_boŞ
("sucûss", 
sucûss
);

2204 
f
->
	`şo£_£ùiÚ
();

2205 } ià(
admš_commªd
 == "get_heap_property") {

2206 
¡ršg
 
´İ”ty
;

2207 
size_t
 
v®ue
 = 0;

2208 
¡ršg
 
”rÜ
;

2209 
boŞ
 
sucûss
 = 
çl£
;

2210 ià(!
	`cmd_g‘v®
(
cù
, 
cmdm­
, "´İ”ty", 
´İ”ty
)) {

2211 
”rÜ
 = "unableo get…roperty";

2212 
sucûss
 = 
çl£
;

2213 } ià(!
	`ûph_h—p_g‘_num”ic_´İ”ty
(
´İ”ty
.
	`c_¡r
(), &
v®ue
)) {

2214 
”rÜ
 = "invalid…roperty";

2215 
sucûss
 = 
çl£
;

2217 
sucûss
 = 
Œue
;

2219 
f
->
	`İ’_objeù_£ùiÚ
("result");

2220 
f
->
	`dump_¡ršg
("”rÜ", 
”rÜ
);

2221 
f
->
	`dump_boŞ
("sucûss", 
sucûss
);

2222 
f
->
	`dump_št
("v®ue", 
v®ue
);

2223 
f
->
	`şo£_£ùiÚ
();

2224 } ià(
admš_commªd
 == "dump_objectstore_kv_stats") {

2225 
¡Üe
->
	`g‘_db_¡©i¡ics
(
f
);

2226 } ià(
admš_commªd
 == "dump_scrubs") {

2227 
£rviû
.
	`dumps_süub
(
f
);

2228 } ià(
admš_commªd
 == "calc_objectstore_db_histogram") {

2229 
¡Üe
->
	`g’”©e_db_hi¡og¿m
(
f
);

2230 } ià(
admš_commªd
 == "flush_store_cache") {

2231 
¡Üe
->
	`æush_ÿche
();

2232 } ià(
admš_commªd
 == "dump_pgstate_history") {

2233 
f
->
	`İ’_objeù_£ùiÚ
("pgstate_history");

2234 
veùÜ
<
PGRef
> 
pgs
;

2235 
	`_g‘_pgs
(&
pgs
);

2236 auto& 
pg
 : 
pgs
) {

2237 
f
->
	`dump_¡»am
("pg"è<< 
pg
->
pg_id
;

2238 
pg
->
	`dump_pg¡©e_hi¡Üy
(
f
);

2240 
f
->
	`şo£_£ùiÚ
();

2241 } ià(
admš_commªd
 == "compact") {

2242 
	`dout
(1è<< "Œigg”šg mªu® com·ùiÚ" << 
d’dl
;

2243 autØ
¡¬t
 = 
ûph
::
cßr£_mÚo_şock
::
	`now
();

2244 
¡Üe
->
	`com·ù
();

2245 autØ
’d
 = 
ûph
::
cßr£_mÚo_şock
::
	`now
();

2246 
du¿tiÚ
 = 
¡d
::
chrÚo
::du¿tiÚ<>(
’d
-
¡¬t
).
	`couÁ
();

2247 
	`dout
(1) << "finished manual compaction in "

2248 << 
du¿tiÚ


2249 << " secÚds" << 
d’dl
;

2250 
f
->
	`İ’_objeù_£ùiÚ
("compact_result");

2251 
f
->
	`dump_æßt
("–­£d_time", 
du¿tiÚ
);

2252 
f
->
	`şo£_£ùiÚ
();

2253 } ià(
admš_commªd
 == "get_mapped_pools") {

2254 
f
->
	`İ’_¬¿y_£ùiÚ
("mapped_pools");

2255 
£t
<
št64_t
> 
poŞli¡
 = 
	`g‘_m­³d_poŞs
();

2256 autØ
poŞ
 : 
poŞli¡
) {

2257 
f
->
	`dump_št
("poŞ_id", 
poŞ
);

2259 
f
->
	`şo£_£ùiÚ
();

2260 } ià(
admš_commªd
 == "smart") {

2261 
	`´obe_sm¬t
(
ss
);

2262 } ià(
admš_commªd
 == "list_devices") {

2263 
£t
<
¡ršg
> 
devÇmes
;

2264 
¡Üe
->
	`g‘_deviûs
(&
devÇmes
);

2265 
f
->
	`İ’_objeù_£ùiÚ
("list_devices");

2266 autØ
dev
 : 
devÇmes
) {

2267 ià(
dev
.
	`fšd
("dm-") == 0) {

2270 
f
->
	`dump_¡ršg
("deviû", "/dev/" + 
dev
);

2272 
f
->
	`şo£_£ùiÚ
();

2274 
	`as£¹
(0 == "broken‡sok„egistration");

2276 
f
->
	`æush
(
ss
);

2277 
d–‘e
 
f
;

2278  
Œue
;

2279 
	}
}

2281 şas 
	cTe¡OpsSock‘Hook
 : 
public
 
AdmšSock‘Hook
 {

2282 
OSDS”viû
 *
£rviû
;

2283 
ObjeùStÜe
 *
	m¡Üe
;

2284 
	mpublic
:

2285 
	$Te¡OpsSock‘Hook
(
OSDS”viû
 *
s
, 
ObjeùStÜe
 *
¡
è: 
	`£rviû
(s), 
	$¡Üe
(
¡
) {}

2286 
boŞ
 
	$ÿÎ
(
¡d
::
¡ršg_v›w
 
commªd
, cÚ¡ 
cmdm­_t
& 
cmdm­
,

2287 
¡d
::
¡ršg_v›w
 
fÜm©
, 
bufã¾i¡
& 
out
è
ov”ride
 {

2288 
¡ršg¡»am
 
ss
;

2289 
	`‹¡_İs
(
£rviû
, 
¡Üe
, 
commªd
, 
cmdm­
, 
ss
);

2290 
out
.
	`­³nd
(
ss
);

2291  
Œue
;

2292 
	}
}

2293 
‹¡_İs
(
OSDS”viû
 *
£rviû
, 
ObjeùStÜe
 *
¡Üe
,

2294 
¡d
::
¡ršg_v›w
 
commªd
, cÚ¡ 
cmdm­_t
& 
cmdm­
, 
o¡»am
 &
ss
);

2298 şas 
	cOSD
::
C_Tick
 : 
public
 
CÚ‹xt
 {

2299 
OSD
 *
osd
;

2300 
	mpublic
:

2301 
ex¶ic™
 
	$C_Tick
(
OSD
 *
o
è: 
	$osd
(
o
) {}

2302 
	$fšish
(
r
è
ov”ride
 {

2303 
osd
->
	`tick
();

2304 
	}
}

2307 şas 
	cOSD
::
C_Tick_W™houtOSDLock
 : 
public
 
CÚ‹xt
 {

2308 
OSD
 *
osd
;

2309 
	mpublic
:

2310 
ex¶ic™
 
	$C_Tick_W™houtOSDLock
(
OSD
 *
o
è: 
	$osd
(
o
) {}

2311 
	$fšish
(
r
è
ov”ride
 {

2312 
osd
->
	`tick_w™hout_osd_lock
();

2313 
	}
}

2316 
	gOSD
::
	$’abË_di§bË_fu£
(
boŞ
 
¡İ
)

2318 #ifdeà
HAVE_LIBFUSE


2319 
r
;

2320 
¡ršg
 
mÁ·th
 = 
cù
->
_cÚf
->
osd_d©a
 + "/fuse";

2321 ià(
fu£_¡Üe
 && (
¡İ
 || !
cù
->
_cÚf
->
osd_objeù¡Üe_fu£
)) {

2322 
	`dout
(1è<< 
__func__
 << " di§blšg" << 
d’dl
;

2323 
fu£_¡Üe
->
	`¡İ
();

2324 
d–‘e
 
fu£_¡Üe
;

2325 
fu£_¡Üe
 = 
NULL
;

2326 
r
 = ::
	`rmdœ
(
mÁ·th
.
	`c_¡r
());

2327 ià(
r
 < 0) {

2328 
r
 = -
”ºo
;

2329 
d”r
 << 
__func__
 << " faedØrmdœ " << 
mÁ·th
 << ": "

2330 << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

2331  
r
;

2335 ià(!
fu£_¡Üe
 && 
cù
->
_cÚf
->
osd_objeù¡Üe_fu£
) {

2336 
	`dout
(1è<< 
__func__
 << "ƒÇblšg" << 
d’dl
;

2337 
r
 = ::
	`mkdœ
(
mÁ·th
.
	`c_¡r
(), 0700);

2338 ià(
r
 < 0)

2339 
r
 = -
”ºo
;

2340 ià(
r
 < 0 &&„ !ğ-
EEXIST
) {

2341 
d”r
 << 
__func__
 << " uÇbËØü—‹ " << 
mÁ·th
 << ": "

2342 << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

2343  
r
;

2345 
fu£_¡Üe
 = 
Ãw
 
	`Fu£StÜe
(
¡Üe
, 
mÁ·th
);

2346 
r
 = 
fu£_¡Üe
->
	`¡¬t
();

2347 ià(
r
 < 0) {

2348 
d”r
 << 
__func__
 << " uÇbËØ¡¬ˆfu£: " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

2349 
d–‘e
 
fu£_¡Üe
;

2350 
fu£_¡Üe
 = 
NULL
;

2351  
r
;

2356 
	}
}

2358 
	gOSD
::
	$g‘_num_İ_sh¬ds
()

2360 ià(
cù
->
_cÚf
->
osd_İ_num_sh¬ds
)

2361  
cù
->
_cÚf
->
osd_İ_num_sh¬ds
;

2362 ià(
¡Üe_is_rÙ©iÚ®
)

2363  
cù
->
_cÚf
->
osd_İ_num_sh¬ds_hdd
;

2365  
cù
->
_cÚf
->
osd_İ_num_sh¬ds_ssd
;

2366 
	}
}

2368 
	gOSD
::
	$g‘_num_İ_th»ads
()

2370 ià(
cù
->
_cÚf
->
osd_İ_num_th»ads_³r_sh¬d
)

2371  
	`g‘_num_İ_sh¬ds
(è* 
cù
->
_cÚf
->
osd_İ_num_th»ads_³r_sh¬d
;

2372 ià(
¡Üe_is_rÙ©iÚ®
)

2373  
	`g‘_num_İ_sh¬ds
(è* 
cù
->
_cÚf
->
osd_İ_num_th»ads_³r_sh¬d_hdd
;

2375  
	`g‘_num_İ_sh¬ds
(è* 
cù
->
_cÚf
->
osd_İ_num_th»ads_³r_sh¬d_ssd
;

2376 
	}
}

2378 
	gOSD
::
	$g‘_osd_»cov”y_¦“p
()

2380 ià(
cù
->
_cÚf
->
osd_»cov”y_¦“p
)

2381  
cù
->
_cÚf
->
osd_»cov”y_¦“p
;

2382 ià(!
¡Üe_is_rÙ©iÚ®
 && !
jouº®_is_rÙ©iÚ®
)

2383  
cù
->
_cÚf
->
osd_»cov”y_¦“p_ssd
;

2384 ià(
¡Üe_is_rÙ©iÚ®
 && !
jouº®_is_rÙ©iÚ®
)

2385  
cù
->
_cÚf
->
g‘_v®
<>("osd_recovery_sleep_hybrid");

2387  
cù
->
_cÚf
->
osd_»cov”y_¦“p_hdd
;

2388 
	}
}

2390 
	gOSD
::
	$š™
()

2392 
Com·tS‘
 
š™Ÿl
, 
diff
;

2393 
Mu‹x
::
Lock”
 
	`lock
(
osd_lock
);

2394 ià(
	`is_¡İpšg
())

2397 
tick_tim”
.
	`š™
();

2398 
tick_tim”_w™hout_osd_lock
.
	`š™
();

2399 
£rviû
.
»cov”y_»que¡_tim”
.
	`š™
();

2400 
£rviû
.
»cov”y_¦“p_tim”
.
	`š™
();

2403 
	`dout
(2è<< "š™ " << 
dev_·th


2404 << " (look lik" << (
¡Üe_is_rÙ©iÚ®
 ? "hdd" : "ssd") << ")"

2405 << 
d’dl
;

2406 
	`dout
(2è<< "jouº® " << 
jouº®_·th
 << 
d’dl
;

2407 
	`as£¹
(
¡Üe
);

2409 
¡Üe
->
	`£t_ÿche_sh¬ds
(
	`g‘_num_İ_sh¬ds
());

2411 
r
 = 
¡Üe
->
	`mouÁ
();

2412 ià(
r
 < 0) {

2413 
d”r
 << "OSD:š™: uÇbËØmouÁ objeù stÜe" << 
d’dl
;

2414  
r
;

2416 
jouº®_is_rÙ©iÚ®
 = 
¡Üe
->
	`is_jouº®_rÙ©iÚ®
();

2417 
	`dout
(2è<< "jouº®†ook lik" << (
jouº®_is_rÙ©iÚ®
 ? "hdd" : "ssd")

2418 << 
d’dl
;

2420 
	`’abË_di§bË_fu£
(
çl£
);

2422 
	`dout
(2è<< "boÙ" << 
d’dl
;

2424 
£rviû
.
m‘a_ch
 = 
¡Üe
->
	`İ’_cŞËùiÚ
(
cŞl_t
::
	`m‘a
());

2427 
lßdavgs
[3];

2428 ià(
	`g‘lßdavg
(
lßdavgs
, 3) == 3) {

2429 
day_lßdavg
 = 
lßdavgs
[2];

2431 
d”r
 << "OSD::š™(è: couldn'ˆ»ad†ßdavgs\n" << 
d’dl
;

2432 
day_lßdavg
 = 1.0;

2435 
rÙ©šg_auth_©‹m±s
 = 0;

2439 
hobjeù_t
 
l
;

2440 
l
.
oid
.
Çme
 = 
	`¡ršg
(
cù
->
_cÚf
->
osd_max_objeù_Çme_Ën
, 'n');

2441 
l
.
	`£t_key
(
	`¡ršg
(
cù
->
_cÚf
->
osd_max_objeù_Çme_Ën
, 'k'));

2442 
l
.
n¥aû
 = 
	`¡ršg
(
cù
->
_cÚf
->
osd_max_objeù_Çme¥aû_Ën
, 's');

2443 
r
 = 
¡Üe
->
	`v®id©e_hobjeù_key
(
l
);

2444 ià(
r
 < 0) {

2445 
d”r
 << "back’d (" << 
¡Üe
->
	`g‘_ty³
() << ") is unableo support max "

2446 << "objeù‚ame[¥aû]†’" << 
d’dl
;

2447 
d”r
 << " osd max object‚ame†en = "

2448 << 
cù
->
_cÚf
->
osd_max_objeù_Çme_Ën
 << 
d’dl
;

2449 
d”r
 << " osd max object‚amespace†en = "

2450 << 
cù
->
_cÚf
->
osd_max_objeù_Çme¥aû_Ën
 << 
d’dl
;

2451 
d”r
 << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

2452 ià(
cù
->
_cÚf
->
osd_check_max_objeù_Çme_Ën_Ú_¡¬tup
) {

2453 
out
;

2455 
d”r
 << "osd_check_max_object_name_len_on_startup = false, starting‡nyway"

2456 << 
d’dl
;

2458 
	`dout
(20è<< "cÚfigu»d osd_max_objeù_Çme[¥aû]_ËÀlook ok" << 
d’dl
;

2463 
r
 = 
	`»ad_su³rblock
();

2464 ià(
r
 < 0) {

2465 
d”r
 << "OSD::š™(è: uÇbËØ»ad osd su³rblock" << 
d’dl
;

2466 
r
 = -
EINVAL
;

2467 
out
;

2470 ià(
osd_com·t
.
	`com·»
(
su³rblock
.
com·t_ã©u»s
) < 0) {

2471 
d”r
 << "Thdisk u£ ã©u» unsuµÜ‹d byhexecubË." << 
d’dl
;

2472 
d”r
 << " ondisk f—tu» " << 
su³rblock
.
com·t_ã©u»s
 << 
d’dl
;

2473 
d”r
 << " d«mÚ f—tu» " << 
osd_com·t
 << 
d’dl
;

2475 ià(
osd_com·t
.
	`wr™—bË
(
su³rblock
.
com·t_ã©u»s
)) {

2476 
Com·tS‘
 
diff
 = 
osd_com·t
.
	`unsuµÜ‹d
(
su³rblock
.
com·t_ã©u»s
);

2477 
d”r
 << "™ i ¡Èwr™—bË,hough. Missšg f—tu»s: " << 
diff
 << 
d’dl
;

2478 
r
 = -
EOPNOTSUPP
;

2479 
out
;

2482 
Com·tS‘
 
diff
 = 
osd_com·t
.
	`unsuµÜ‹d
(
su³rblock
.
com·t_ã©u»s
);

2483 
d”r
 << "CªnÙ wr™tØdisk! Missšg f—tu»s: " << 
diff
 << 
d’dl
;

2484 
r
 = -
EOPNOTSUPP
;

2485 
out
;

2489 
	`as£¹_w¬n
(
whßmi
 =ğ
su³rblock
.whoami);

2490 ià(
whßmi
 !ğ
su³rblock
.whoami) {

2491 
d”r
 << "OSD::init: superblock says osd"

2492 << 
su³rblock
.
whßmi
 << " buˆI‡m osd." << whßm˜<< 
d’dl
;

2493 
r
 = -
EINVAL
;

2494 
out
;

2498 
	`as£¹_w¬n
(!
osdm­
);

2499 ià(
osdm­
) {

2500 
d”r
 << "OSD::š™: uÇbËØ»ad cu¼’ˆosdm­" << 
d’dl
;

2501 
r
 = -
EINVAL
;

2502 
out
;

2504 
osdm­
 = 
	`g‘_m­
(
su³rblock
.
cu¼’t_•och
);

2508 
veùÜ
<
cŞl_t
> 
ls
;

2509 
r
 = 
¡Üe
->
	`li¡_cŞËùiÚs
(
ls
);

2510 
	`ûph_as£¹
(
r
 >= 0);

2511 autØ
c
 : 
ls
) {

2512 
¥g_t
 
pgid
;

2513 ià(
c
.
	`is_pg
(&
pgid
) &&

2514 !
osdm­
->
	`have_pg_poŞ
(
pgid
.
	`poŞ
())) {

2515 
ghobjeù_t
 
oid
 = 
	`make_fš®_poŞ_šfo_oid
(
pgid
.
	`poŞ
());

2516 ià(!
¡Üe
->
	`exi¡s
(
£rviû
.
m‘a_ch
, 
oid
)) {

2517 
d”r
 << 
__func__
 << " missing…g_pool_t for deleted…ool "

2518 << 
pgid
.
	`poŞ
() << " for…g " <<…gid

2520 << "pg d–‘iÚØcom¶‘befÜupg¿dšg" << 
d’dl
;

2521 
	`ûph_abÜt
();

2527 
š™Ÿl
 = 
	`g‘_osd_š™Ÿl_com·t_£t
();

2528 
diff
 = 
su³rblock
.
com·t_ã©u»s
.
	`unsuµÜ‹d
(
š™Ÿl
);

2529 ià(
su³rblock
.
com·t_ã©u»s
.
	`m”ge
(
š™Ÿl
)) {

2532 
	`dout
(5è<< "Upg¿dšg su³rblock‡ddšg: " << 
diff
 << 
d’dl
;

2533 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

2534 
	`wr™e_su³rblock
(
t
);

2535 
r
 = 
¡Üe
->
	`queue_Œª§ùiÚ
(
£rviû
.
m‘a_ch
, 
¡d
::
	`move
(
t
));

2536 ià(
r
 < 0)

2537 
out
;

2541 ià(!
¡Üe
->
	`exi¡s
(
£rviû
.
m‘a_ch
, 
OSD
::
	`make_¢­m­³r_oid
())) {

2542 
	`dout
(10è<< "š™ c»©šg/touchšg sÇpm­³¸objeù" << 
d’dl
;

2543 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

2544 
t
.
	`touch
(
cŞl_t
::
	`m‘a
(), 
OSD
::
	`make_¢­m­³r_oid
());

2545 
r
 = 
¡Üe
->
	`queue_Œª§ùiÚ
(
£rviû
.
m‘a_ch
, 
¡d
::
	`move
(
t
));

2546 ià(
r
 < 0)

2547 
out
;

2550 
şass_hªdËr
 = 
Ãw
 
	`CÏssHªdËr
(
cù
);

2551 
	`şs_š™Ÿlize
(
şass_hªdËr
);

2553 ià(
cù
->
_cÚf
->
osd_İ’_şas£s_Ú_¡¬t
) {

2554 
r
 = 
şass_hªdËr
->
	`İ’_®l_şas£s
();

2555 ià(
r
)

2556 
	`dout
(1è<< "w¬nšg: gÙ‡À”rÜ†ßdšg oÃ o¸mÜşas£s: " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

2559 
	`check_osdm­_ã©u»s
();

2561 
	`ü—‹_»cov”y¡©e_³rf
();

2564 
•och_t
 
bšd_•och
 = 
osdm­
->
	`g‘_•och
();

2565 
£rviû
.
	`£t_•ochs
(
NULL
, NULL, &
bšd_•och
);

2568 
	`ş—r_‹mp_objeùs
();

2571 auto& 
sh¬d
 : 
sh¬ds
) {

2572 
Mu‹x
::
Lock”
 
	`l
(
sh¬d
->
osdm­_lock
);

2573 
sh¬d
->
sh¬d_osdm­
 = 
osdm­
;

2577 
	`lßd_pgs
();

2579 
	`dout
(2è<< "su³rblock: I‡m osd." << 
su³rblock
.
whßmi
 << 
d’dl
;

2580 
	`dout
(0è<< "usšg " << 
İ_queue
 << " op queue with…riority op cut off‡t " <<

2581 
İ_´io_cutoff
 << "." << 
d’dl
;

2583 
	`ü—‹_logg”
();

2586 
ş›Á_mes£ng”
->
	`add_di¥©ch”_h—d
(
this
);

2587 
şu¡”_mes£ng”
->
	`add_di¥©ch”_h—d
(
this
);

2589 
hb_äÚt_ş›Á_mes£ng”
->
	`add_di¥©ch”_h—d
(&
h—¹b—t_di¥©ch”
);

2590 
hb_back_ş›Á_mes£ng”
->
	`add_di¥©ch”_h—d
(&
h—¹b—t_di¥©ch”
);

2591 
hb_äÚt_£rv”_mes£ng”
->
	`add_di¥©ch”_h—d
(&
h—¹b—t_di¥©ch”
);

2592 
hb_back_£rv”_mes£ng”
->
	`add_di¥©ch”_h—d
(&
h—¹b—t_di¥©ch”
);

2594 
objeù”_mes£ng”
->
	`add_di¥©ch”_h—d
(
£rviû
.
objeù”
);

2596 
mÚc
->
	`£t_wªt_keys
(
CEPH_ENTITY_TYPE_MON
 | 
CEPH_ENTITY_TYPE_OSD


2597 | 
CEPH_ENTITY_TYPE_MGR
);

2598 
r
 = 
mÚc
->
	`š™
();

2599 ià(
r
 < 0)

2600 
out
;

2602 
mgrc
.
	`£t_pg¡©s_cb
([
this
](){  
	`cŞËù_pg_¡©s
(); });

2603 
mgrc
.
	`š™
();

2604 
ş›Á_mes£ng”
->
	`add_di¥©ch”_h—d
(&
mgrc
);

2607 
mÚc
->
	`£t_log_ş›Á
(&
log_ş›Á
);

2608 
	`upd©e_log_cÚfig
();

2610 
£rviû
.
	`š™
();

2611 
£rviû
.
	`publish_m­
(
osdm­
);

2612 
£rviû
.
	`publish_su³rblock
(
su³rblock
);

2613 
£rviû
.
max_Şde¡_m­
 = 
su³rblock
.
Şde¡_m­
;

2615 
osd_İ_
.
	`¡¬t
();

2616 
commªd_
.
	`¡¬t
();

2619 
h—¹b—t_th»ad
.
	`ü—‹
("osd_srv_heartbt");

2622 
tick_tim”
.
	`add_ev’t_aá”
(
cù
->
_cÚf
->
osd_h—¹b—t_š‹rv®
, 
Ãw
 
	`C_Tick
(
this
));

2624 
Mu‹x
::
Lock”
 
	`l
(
tick_tim”_lock
);

2625 
tick_tim”_w™hout_osd_lock
.
	`add_ev’t_aá”
(
cù
->
_cÚf
->
osd_h—¹b—t_š‹rv®
, 
Ãw
 
	`C_Tick_W™houtOSDLock
(
this
));

2628 
osd_lock
.
	`UÆock
();

2630 
r
 = 
mÚc
->
	`auth’tiÿ‹
();

2631 ià(
r
 < 0) {

2632 
d”r
 << 
__func__
 << "‡uth’tiÿtiÚ faed: " << 
	`ıp_¡»¼Ü
(
r
)

2633 << 
d’dl
;

2634 
	`ex™
(1);

2637 
mÚc
->
	`wa™_auth_rÙ©šg
(30.0) < 0) {

2638 
d”r
 << "uÇbËØobš„Ù©šg s”viû keys;„‘ryšg" << 
d’dl
;

2639 ++
rÙ©šg_auth_©‹m±s
;

2640 ià(
rÙ©šg_auth_©‹m±s
 > 
g_cÚf
->
max_rÙ©šg_auth_©‹m±s
) {

2641 
d”r
 << 
__func__
 << " wa™_auth_rÙ©šgimed out" << 
d’dl
;

2642 
	`ex™
(1);

2646 
r
 = 
	`upd©e_üush_deviû_şass
();

2647 ià(
r
 < 0) {

2648 
d”r
 << 
__func__
 << " unableo update_crush_device_class: "

2649 << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

2650 
	`ex™
(1);

2653 
r
 = 
	`upd©e_üush_loÿtiÚ
();

2654 ià(
r
 < 0) {

2655 
d”r
 << 
__func__
 << " unableo update_crush_location: "

2656 << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

2657 
	`ex™
(1);

2660 
osd_lock
.
	`Lock
();

2661 ià(
	`is_¡İpšg
())

2666 
£rviû
.
	`fš®_š™
();

2668 
	`check_cÚfig
();

2670 
	`dout
(10è<< "’suršg…g havcÚsumed…riÜ m­s" << 
d’dl
;

2671 
	`cÚsume_m­
();

2673 
	`dout
(0è<< "dÚw™h in™, s¹šg boÙ…roûss" << 
d’dl
;

2676 
mÚc
->
	`sub_wªt
("osd_pg_ü—‹s", 
Ï¡_pg_ü—‹_•och
, 0);

2679 
mÚc
->
	`sub_wªt
("mgrmap", 0, 0);

2684 
mÚc
->
	`»Ãw_subs
();

2686 
	`¡¬t_boÙ
();

2690 
out
:

2691 
	`’abË_di§bË_fu£
(
Œue
);

2692 
¡Üe
->
	`umouÁ
();

2693 
d–‘e
 
¡Üe
;

2694 
¡Üe
 = 
NULL
;

2695  
r
;

2696 
	}
}

2698 
	gOSD
::
	$fš®_š™
()

2700 
AdmšSock‘
 *
admš_sock‘
 = 
cù
->
	`g‘_admš_sock‘
();

2701 
asok_hook
 = 
Ãw
 
	`OSDSock‘Hook
(
this
);

2702 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("¡©us", "¡©us", 
asok_hook
,

2704 
	`as£¹
(
r
 == 0);

2705 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("flush_journal", "flush_journal",

2706 
asok_hook
,

2708 
	`as£¹
(
r
 == 0);

2709 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("dump_ops_in_flight",

2712 
asok_hook
,

2714 
	`as£¹
(
r
 == 0);

2715 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("ops",

2718 
asok_hook
,

2720 
	`as£¹
(
r
 == 0);

2721 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("dump_blocked_ops",

2724 
asok_hook
,

2726 
	`as£¹
(
r
 == 0);

2727 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("dump_historic_ops",

2730 
asok_hook
,

2732 
	`as£¹
(
r
 == 0);

2733 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("dump_historic_slow_ops",

2736 
asok_hook
,

2738 
	`as£¹
(
r
 == 0);

2739 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("dump_historic_ops_by_duration",

2742 
asok_hook
,

2744 
	`as£¹
(
r
 == 0);

2745 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("dump_op_pq_state", "dump_op_pq_state",

2746 
asok_hook
,

2748 
	`as£¹
(
r
 == 0);

2749 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("dump_blacklist", "dump_blacklist",

2750 
asok_hook
,

2752 
	`as£¹
(
r
 == 0);

2753 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("dump_watchers", "dump_watchers",

2754 
asok_hook
,

2757 
	`as£¹
(
r
 == 0);

2758 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("dump_reservations", "dump_reservations",

2759 
asok_hook
,

2761 
	`as£¹
(
r
 == 0);

2762 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("get_latest_osdmap", "get_latest_osdmap",

2763 
asok_hook
,

2766 
	`as£¹
(
r
 == 0);

2768 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
( "heap",

2771 
asok_hook
,

2774 
	`as£¹
(
r
 == 0);

2776 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("set_heap_property",

2780 
asok_hook
,

2782 
	`as£¹
(
r
 == 0);

2784 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("get_heap_property",

2787 
asok_hook
,

2789 
	`as£¹
(
r
 == 0);

2791 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("dump_objectstore_kv_stats",

2793 
asok_hook
,

2795 
	`as£¹
(
r
 == 0);

2797 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("dump_scrubs",

2799 
asok_hook
,

2801 
	`as£¹
(
r
 == 0);

2803 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("calc_objectstore_db_histogram",

2805 
asok_hook
,

2807 
	`as£¹
(
r
 == 0);

2809 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("flush_store_cache",

2811 
asok_hook
,

2813 
	`as£¹
(
r
 == 0);

2814 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("dump_pgstate_history", "dump_pgstate_history",

2815 
asok_hook
,

2817 
	`as£¹
(
r
 == 0);

2819 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("compact", "compact",

2820 
asok_hook
,

2823 
	`as£¹
(
r
 == 0);

2825 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("get_mapped_pools", "get_mapped_pools",

2826 
asok_hook
,

2829 
	`as£¹
(
r
 == 0);

2831 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("smart", "smart",

2832 
asok_hook
,

2835 
	`as£¹
(
r
 == 0);

2837 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
("list_devices", "list_devices",

2838 
asok_hook
,

2841 
‹¡_İs_hook
 = 
Ãw
 
	`Te¡OpsSock‘Hook
(&(
this
->
£rviû
),his->
¡Üe
);

2844 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
(

2851 
‹¡_İs_hook
,

2853 
	`as£¹
(
r
 == 0);

2854 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
(

2860 
‹¡_İs_hook
,

2862 
	`as£¹
(
r
 == 0);

2863 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
(

2869 
‹¡_İs_hook
,

2871 
	`as£¹
(
r
 == 0);

2873 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
(

2878 
‹¡_İs_hook
,

2880 
	`as£¹
(
r
 == 0);

2882 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
(

2888 
‹¡_İs_hook
,

2890 
	`as£¹
(
r
 == 0);

2892 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
(

2898 
‹¡_İs_hook
,

2900 
	`as£¹
(
r
 == 0);

2902 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
(

2908 
‹¡_İs_hook
,

2910 
	`as£¹
(
r
 == 0);

2911 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
(

2915 
‹¡_İs_hook
,

2917 
	`as£¹
(
r
 == 0);

2918 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
(

2922 
‹¡_İs_hook
,

2924 
	`as£¹
(
r
 == 0);

2925 
r
 = 
admš_sock‘
->
	`»gi¡”_commªd
(

2930 
‹¡_İs_hook
,

2932 
	`as£¹
(
r
 == 0);

2933 
	}
}

2935 
	gOSD
::
	$ü—‹_logg”
()

2937 
	`dout
(10è<< "ü—‹_logg”" << 
d’dl
;

2939 
P”fCouÁ”sBud”
 
	`osd_¶b
(
cù
, "osd", 
l_osd_fœ¡
, 
l_osd_Ï¡
);

2942 
P”fHi¡og¿mCommÚ
::
axis_cÚfig_d
 
İ_hi¡_x_axis_cÚfig
{

2944 
P”fHi¡og¿mCommÚ
::
SCALE_LOG2
,

2951 
P”fHi¡og¿mCommÚ
::
axis_cÚfig_d
 
İ_hi¡_y_axis_cÚfig
{

2953 
P”fHi¡og¿mCommÚ
::
SCALE_LOG2
,

2961 
osd_¶b
.
	`£t_´io_deçuÉ
(
P”fCouÁ”sBud”
::
PRIO_USEFUL
);

2963 
osd_¶b
.
	`add_u64
(

2964 
l_osd_İ_w
, "op_wip",

2966 
osd_¶b
.
	`add_u64_couÁ”
(

2967 
l_osd_İ
, "op",

2969 "İs", 
P”fCouÁ”sBud”
::
PRIO_CRITICAL
);

2970 
osd_¶b
.
	`add_u64_couÁ”
(

2971 
l_osd_İ_šb
, "op_in_bytes",

2973 "wr", 
P”fCouÁ”sBud”
::
PRIO_INTERESTING
, 
	`un™_t
(
BYTES
));

2974 
osd_¶b
.
	`add_u64_couÁ”
(

2975 
l_osd_İ_outb
, "op_out_bytes",

2977 "rd", 
P”fCouÁ”sBud”
::
PRIO_INTERESTING
, 
	`un™_t
(
BYTES
));

2978 
osd_¶b
.
	`add_time_avg
(

2979 
l_osd_İ_Ït
, "op_latency",

2982 
osd_¶b
.
	`add_time_avg
(

2983 
l_osd_İ_´oûss_Ït
, "op_process_latency",

2985 
osd_¶b
.
	`add_time_avg
(

2986 
l_osd_İ_´•¬e_Ït
, "op_prepare_latency",

2989 
osd_¶b
.
	`add_u64_couÁ”
(

2990 
l_osd_İ_r
, "op_r", "Client„ead operations");

2991 
osd_¶b
.
	`add_u64_couÁ”
(

2992 
l_osd_İ_r_outb
, "İ_r_out_by‹s", "Cl›Á d©¨»ad", 
NULL
, 
P”fCouÁ”sBud”
::
PRIO_USEFUL
, 
	`un™_t
(
BYTES
));

2993 
osd_¶b
.
	`add_time_avg
(

2994 
l_osd_İ_r_Ït
, "op_r_latency",

2996 
osd_¶b
.
	`add_u64_couÁ”_hi¡og¿m
(

2997 
l_osd_İ_r_Ït_outb_hi¡
, "op_r_latency_out_bytes_histogram",

2998 
İ_hi¡_x_axis_cÚfig
, 
İ_hi¡_y_axis_cÚfig
,

3000 
osd_¶b
.
	`add_time_avg
(

3001 
l_osd_İ_r_´oûss_Ït
, "op_r_process_latency",

3003 
osd_¶b
.
	`add_time_avg
(

3004 
l_osd_İ_r_´•¬e_Ït
, "op_r_prepare_latency",

3006 
osd_¶b
.
	`add_u64_couÁ”
(

3007 
l_osd_İ_w
, "op_w", "Client write operations");

3008 
osd_¶b
.
	`add_u64_couÁ”
(

3009 
l_osd_İ_w_šb
, "op_w_in_bytes", "Client data written");

3010 
osd_¶b
.
	`add_time_avg
(

3011 
l_osd_İ_w_Ït
, "op_w_latency",

3013 
osd_¶b
.
	`add_u64_couÁ”_hi¡og¿m
(

3014 
l_osd_İ_w_Ït_šb_hi¡
, "op_w_latency_in_bytes_histogram",

3015 
İ_hi¡_x_axis_cÚfig
, 
İ_hi¡_y_axis_cÚfig
,

3017 
osd_¶b
.
	`add_time_avg
(

3018 
l_osd_İ_w_´oûss_Ït
, "op_w_process_latency",

3020 
osd_¶b
.
	`add_time_avg
(

3021 
l_osd_İ_w_´•¬e_Ït
, "op_w_prepare_latency",

3023 
osd_¶b
.
	`add_u64_couÁ”
(

3024 
l_osd_İ_rw
, "op_rw",

3026 
osd_¶b
.
	`add_u64_couÁ”
(

3027 
l_osd_İ_rw_šb
, "op_rw_in_bytes",

3028 "Cl›Á„—d-modify-wr™İ”©iÚ wr™š", 
NULL
, 
P”fCouÁ”sBud”
::
PRIO_USEFUL
, 
	`un™_t
(
BYTES
));

3029 
osd_¶b
.
	`add_u64_couÁ”
(

3030 
l_osd_İ_rw_outb
,"op_rw_out_bytes",

3031 "Cl›Á„—d-modify-wr™İ”©iÚ »ad ouˆ", 
NULL
, 
P”fCouÁ”sBud”
::
PRIO_USEFUL
, 
	`un™_t
(
BYTES
));

3032 
osd_¶b
.
	`add_time_avg
(

3033 
l_osd_İ_rw_Ït
, "op_rw_latency",

3035 
osd_¶b
.
	`add_u64_couÁ”_hi¡og¿m
(

3036 
l_osd_İ_rw_Ït_šb_hi¡
, "op_rw_latency_in_bytes_histogram",

3037 
İ_hi¡_x_axis_cÚfig
, 
İ_hi¡_y_axis_cÚfig
,

3039 
osd_¶b
.
	`add_u64_couÁ”_hi¡og¿m
(

3040 
l_osd_İ_rw_Ït_outb_hi¡
, "op_rw_latency_out_bytes_histogram",

3041 
İ_hi¡_x_axis_cÚfig
, 
İ_hi¡_y_axis_cÚfig
,

3043 
osd_¶b
.
	`add_time_avg
(

3044 
l_osd_İ_rw_´oûss_Ït
, "op_rw_process_latency",

3046 
osd_¶b
.
	`add_time_avg
(

3047 
l_osd_İ_rw_´•¬e_Ït
, "op_rw_prepare_latency",

3052 
osd_¶b
.
	`£t_´io_deçuÉ
(
P”fCouÁ”sBud”
::
PRIO_DEBUGONLY
);

3054 
osd_¶b
.
	`add_time_avg
(
l_osd_İ_befÜe_queue_İ_Ït
, "op_before_queue_op_lat",

3056 
osd_¶b
.
	`add_time_avg
(
l_osd_İ_befÜe_dequeue_İ_Ït
, "op_before_dequeue_op_lat",

3059 
osd_¶b
.
	`add_u64_couÁ”
(

3060 
l_osd_sİ
, "subop", "Suboperations");

3061 
osd_¶b
.
	`add_u64_couÁ”
(

3062 
l_osd_sİ_šb
, "subİ_š_by‹s", "Subİ”©iÚ tÙ® size", 
NULL
, 0, 
	`un™_t
(
BYTES
));

3063 
osd_¶b
.
	`add_time_avg
(
l_osd_sİ_Ït
, "subop_latency", "Suboperations†atency");

3065 
osd_¶b
.
	`add_u64_couÁ”
(
l_osd_sİ_w
, "subop_w", "Replicated writes");

3066 
osd_¶b
.
	`add_u64_couÁ”
(

3067 
l_osd_sİ_w_šb
, "subİ_w_š_by‹s", "R•liÿ‹d wr™‹Àd©¨size", 
NULL
, 0, 
	`un™_t
(
BYTES
));

3068 
osd_¶b
.
	`add_time_avg
(

3069 
l_osd_sİ_w_Ït
, "subop_w_latency", "Replicated writes†atency");

3070 
osd_¶b
.
	`add_u64_couÁ”
(

3071 
l_osd_sİ_puÎ
, "subop_pull", "Suboperations…ull„equests");

3072 
osd_¶b
.
	`add_time_avg
(

3073 
l_osd_sİ_puÎ_Ït
, "subop_pull_latency", "Suboperations…ull†atency");

3074 
osd_¶b
.
	`add_u64_couÁ”
(

3075 
l_osd_sİ_push
, "subop_push", "Suboperations…ush messages");

3076 
osd_¶b
.
	`add_u64_couÁ”
(

3077 
l_osd_sİ_push_šb
, "subİ_push_š_by‹s", "Subİ”©iÚ pushed size", 
NULL
, 0, 
	`un™_t
(
BYTES
));

3078 
osd_¶b
.
	`add_time_avg
(

3079 
l_osd_sİ_push_Ït
, "subop_push_latency", "Suboperations…ush†atency");

3081 
osd_¶b
.
	`add_u64_couÁ”
(
l_osd_puÎ
, "pull", "Pull„equests sent");

3082 
osd_¶b
.
	`add_u64_couÁ”
(
l_osd_push
, "push", "Push messages sent");

3083 
osd_¶b
.
	`add_u64_couÁ”
(
l_osd_push_outb
, "push_out_by‹s", "Pushed size", 
NULL
, 0, 
	`un™_t
(
BYTES
));

3085 
osd_¶b
.
	`add_u64_couÁ”
(

3086 
l_osd_rİ
, "recovery_ops",

3088 "rİ", 
P”fCouÁ”sBud”
::
PRIO_INTERESTING
);

3090 
osd_¶b
.
	`add_u64
(
l_osd_lßdavg
, "loadavg", "CPU†oad");

3091 
osd_¶b
.
	`add_u64
(
l_osd_buf
, "bufãr_by‹s", "TÙ®‡Îoÿ‹d bufã¸size", 
NULL
, 0, 
	`un™_t
(
BYTES
));

3092 
osd_¶b
.
	`add_u64
(
l_osd_hi¡Üy_®loc_by‹s
, "hi¡Üy_®loc_Mby‹s", 
NULL
, 0, 
	`un™_t
(
BYTES
));

3093 
osd_¶b
.
	`add_u64
(
l_osd_hi¡Üy_®loc_num
, "history_alloc_num");

3094 
osd_¶b
.
	`add_u64
(

3095 
l_osd_ÿched_üc
, "cached_crc", "Total‚umber getting crc from crc_cache");

3096 
osd_¶b
.
	`add_u64
(

3097 
l_osd_ÿched_üc_adju¡ed
, "cached_crc_adjusted",

3099 
osd_¶b
.
	`add_u64
(
l_osd_mis£d_üc
, "missed_crc",

3102 
osd_¶b
.
	`add_u64
(
l_osd_pg
, "numpg", "Placement groups",

3103 "pgs", 
P”fCouÁ”sBud”
::
PRIO_USEFUL
);

3104 
osd_¶b
.
	`add_u64
(

3105 
l_osd_pg_´im¬y
, "numpg_primary",

3107 
osd_¶b
.
	`add_u64
(

3108 
l_osd_pg_»¶iÿ
, "numpg_replica",

3110 
osd_¶b
.
	`add_u64
(

3111 
l_osd_pg_¡¿y
, "numpg_stray",

3113 
osd_¶b
.
	`add_u64
(

3114 
l_osd_pg_»movšg
, "numpg_removing",

3116 
P”fCouÁ”sBud”
::
PRIO_USEFUL
);

3117 
osd_¶b
.
	`add_u64
(

3118 
l_osd_hb_to
, "heartbeat_to_peers", "Heartbeat (ping)…eers we sendo");

3119 
osd_¶b
.
	`add_u64_couÁ”
(
l_osd_m­
, "map_messages", "OSD map messages");

3120 
osd_¶b
.
	`add_u64_couÁ”
(
l_osd_m­e
, "map_message_epochs", "OSD mapƒpochs");

3121 
osd_¶b
.
	`add_u64_couÁ”
(

3122 
l_osd_m­e_dup
, "map_message_epoch_dups", "OSD map duplicates");

3123 
osd_¶b
.
	`add_u64_couÁ”
(

3124 
l_osd_wa™šg_fÜ_m­
, "messages_delayed_for_map",

3127 
osd_¶b
.
	`add_u64_couÁ”
(

3128 
l_osd_m­_ÿche_h™
, "osd_map_cache_hit", "osdmap cache hit");

3129 
osd_¶b
.
	`add_u64_couÁ”
(

3130 
l_osd_m­_ÿche_miss
, "osd_map_cache_miss", "osdmap cache miss");

3131 
osd_¶b
.
	`add_u64_couÁ”
(

3132 
l_osd_m­_ÿche_miss_low
, "osd_map_cache_miss_low",

3134 
osd_¶b
.
	`add_u64_avg
(

3135 
l_osd_m­_ÿche_miss_low_avg
, "osd_map_cache_miss_low_avg",

3137 
osd_¶b
.
	`add_u64_couÁ”
(

3138 
l_osd_m­_bl_ÿche_h™
, "osd_map_bl_cache_hit",

3140 
osd_¶b
.
	`add_u64_couÁ”
(

3141 
l_osd_m­_bl_ÿche_miss
, "osd_map_bl_cache_miss",

3144 
osd_¶b
.
	`add_u64
(

3145 
l_osd_¡©_by‹s
, "stat_bytes", "OSD size", "size",

3146 
P”fCouÁ”sBud”
::
PRIO_USEFUL
, 
	`un™_t
(
BYTES
));

3147 
osd_¶b
.
	`add_u64
(

3148 
l_osd_¡©_by‹s_u£d
, "stat_bytes_used", "Used space", "used",

3149 
P”fCouÁ”sBud”
::
PRIO_USEFUL
, 
	`un™_t
(
BYTES
));

3150 
osd_¶b
.
	`add_u64
(
l_osd_¡©_by‹s_ava
, "¡©_by‹s_ava", "AvaabË s·û", 
NULL
, 0, 
	`un™_t
(
BYTES
));

3152 
osd_¶b
.
	`add_u64_couÁ”
(

3153 
l_osd_cİyäom
, "copyfrom", "Rados \"copy-from\" operations");

3155 
osd_¶b
.
	`add_u64_couÁ”
(
l_osd_t›r_´omÙe
, "tier_promote", "Tier…romotions");

3156 
osd_¶b
.
	`add_u64_couÁ”
(
l_osd_t›r_æush
, "tier_flush", "Tier flushes");

3157 
osd_¶b
.
	`add_u64_couÁ”
(

3158 
l_osd_t›r_æush_ç
, "tier_flush_fail", "Failedier flushes");

3159 
osd_¶b
.
	`add_u64_couÁ”
(

3160 
l_osd_t›r_Œy_æush
, "tier_try_flush", "Tier flush‡ttempts");

3161 
osd_¶b
.
	`add_u64_couÁ”
(

3162 
l_osd_t›r_Œy_æush_ç
, "tier_try_flush_fail",

3164 
osd_¶b
.
	`add_u64_couÁ”
(

3165 
l_osd_t›r_eviù
, "tier_evict", "Tierƒvictions");

3166 
osd_¶b
.
	`add_u64_couÁ”
(

3167 
l_osd_t›r_wh™eout
, "tier_whiteout", "Tier whiteouts");

3168 
osd_¶b
.
	`add_u64_couÁ”
(

3169 
l_osd_t›r_dœty
, "tier_dirty", "Dirtyier flag set");

3170 
osd_¶b
.
	`add_u64_couÁ”
(

3171 
l_osd_t›r_ş—n
, "tier_clean", "Dirtyier flag cleaned");

3172 
osd_¶b
.
	`add_u64_couÁ”
(

3173 
l_osd_t›r_d–ay
, "tier_delay", "Tier delays (agent waiting)");

3174 
osd_¶b
.
	`add_u64_couÁ”
(

3175 
l_osd_t›r_´oxy_»ad
, "tier_proxy_read", "Tier…roxy„eads");

3176 
osd_¶b
.
	`add_u64_couÁ”
(

3177 
l_osd_t›r_´oxy_wr™e
, "tier_proxy_write", "Tier…roxy writes");

3179 
osd_¶b
.
	`add_u64_couÁ”
(

3180 
l_osd_ag’t_wake
, "agent_wake", "Tiering‡gent wake up");

3181 
osd_¶b
.
	`add_u64_couÁ”
(

3182 
l_osd_ag’t_sk
, "agent_skip", "Objects skipped by‡gent");

3183 
osd_¶b
.
	`add_u64_couÁ”
(

3184 
l_osd_ag’t_æush
, "agent_flush", "Tiering‡gent flushes");

3185 
osd_¶b
.
	`add_u64_couÁ”
(

3186 
l_osd_ag’t_eviù
, "agent_evict", "Tiering‡gentƒvictions");

3188 
osd_¶b
.
	`add_u64_couÁ”
(

3189 
l_osd_objeù_ùx_ÿche_h™
, "object_ctx_cache_hit", "Object context cache hits");

3190 
osd_¶b
.
	`add_u64_couÁ”
(

3191 
l_osd_objeù_ùx_ÿche_tÙ®
, "object_ctx_cache_total", "Object context cache†ookups");

3193 
osd_¶b
.
	`add_u64_couÁ”
(
l_osd_İ_ÿche_h™
, "op_cache_hit");

3194 
osd_¶b
.
	`add_time_avg
(

3195 
l_osd_t›r_æush_Ït
, "osd_tier_flush_lat", "Object flush†atency");

3196 
osd_¶b
.
	`add_time_avg
(

3197 
l_osd_t›r_´omÙe_Ït
, "osd_tier_promote_lat", "Object…romote†atency");

3198 
osd_¶b
.
	`add_time_avg
(

3199 
l_osd_t›r_r_Ït
, "osd_tier_r_lat", "Object…roxy„ead†atency");

3201 
osd_¶b
.
	`add_u64_couÁ”
(

3202 
l_osd_pg_šfo
, "osd_pg_info", "PG updated its info (using‡ny method)");

3203 
osd_¶b
.
	`add_u64_couÁ”
(

3204 
l_osd_pg_ç¡šfo
, "osd_pg_fastinfo",

3206 
osd_¶b
.
	`add_u64_couÁ”
(

3207 
l_osd_pg_bigšfo
, "osd_pg_biginfo", "PG updated its biginfo‡ttr");

3209 
logg”
 = 
osd_¶b
.
	`ü—‹_³rf_couÁ”s
();

3210 
cù
->
	`g‘_³rfcouÁ”s_cŞËùiÚ
()->
	`add
(
logg”
);

3211 
	}
}

3213 
	gOSD
::
	$ü—‹_»cov”y¡©e_³rf
()

3215 
	`dout
(10è<< "ü—‹_»cov”y¡©e_³rf" << 
d’dl
;

3217 
P”fCouÁ”sBud”
 
	`rs_³rf
(
cù
, "»cov”y¡©e_³rf", 
rs_fœ¡
, 
rs_Ï¡
);

3219 
rs_³rf
.
	`add_time_avg
(
rs_š™Ÿl_Ï‹ncy
, "initial_latency", "Initial„ecovery state†atency");

3220 
rs_³rf
.
	`add_time_avg
(
rs_¡¬‹d_Ï‹ncy
, "started_latency", "Started„ecovery state†atency");

3221 
rs_³rf
.
	`add_time_avg
(
rs_»£t_Ï‹ncy
, "reset_latency", "Reset„ecovery state†atency");

3222 
rs_³rf
.
	`add_time_avg
(
rs_¡¬t_Ï‹ncy
, "start_latency", "Start„ecovery state†atency");

3223 
rs_³rf
.
	`add_time_avg
(
rs_´im¬y_Ï‹ncy
, "primary_latency", "Primary„ecovery state†atency");

3224 
rs_³rf
.
	`add_time_avg
(
rs_³”šg_Ï‹ncy
, "peering_latency", "Peering„ecovery state†atency");

3225 
rs_³rf
.
	`add_time_avg
(
rs_backflšg_Ï‹ncy
, "backfilling_latency", "Backfilling„ecovery state†atency");

3226 
rs_³rf
.
	`add_time_avg
(
rs_wa™»mÙebackfÌe£rved_Ï‹ncy
, "waitremotebackfillreserved_latency", "Wait„emote backfill„eserved„ecovery state†atency");

3227 
rs_³rf
.
	`add_time_avg
(
rs_wa™loÿlbackfÌe£rved_Ï‹ncy
, "waitlocalbackfillreserved_latency", "Wait†ocal backfill„eserved„ecovery state†atency");

3228 
rs_³rf
.
	`add_time_avg
(
rs_nÙbackflšg_Ï‹ncy
, "notbackfilling_latency", "Notbackfilling„ecovery state†atency");

3229 
rs_³rf
.
	`add_time_avg
(
rs_»²Ù»cov”šg_Ï‹ncy
, "repnotrecovering_latency", "Repnotrecovering„ecovery state†atency");

3230 
rs_³rf
.
	`add_time_avg
(
rs_»pwa™»cov”y»£rved_Ï‹ncy
, "repwaitrecoveryreserved_latency", "Rep wait„ecovery„eserved„ecovery state†atency");

3231 
rs_³rf
.
	`add_time_avg
(
rs_»pwa™backfÌe£rved_Ï‹ncy
, "repwaitbackfillreserved_latency", "Rep wait backfill„eserved„ecovery state†atency");

3232 
rs_³rf
.
	`add_time_avg
(
rs_»´ecov”šg_Ï‹ncy
, "reprecovering_latency", "RepRecovering„ecovery state†atency");

3233 
rs_³rf
.
	`add_time_avg
(
rs_aùiv©šg_Ï‹ncy
, "activating_latency", "Activating„ecovery state†atency");

3234 
rs_³rf
.
	`add_time_avg
(
rs_wa™loÿÌecov”y»£rved_Ï‹ncy
, "waitlocalrecoveryreserved_latency", "Wait†ocal„ecovery„eserved„ecovery state†atency");

3235 
rs_³rf
.
	`add_time_avg
(
rs_wa™»mÙ”ecov”y»£rved_Ï‹ncy
, "waitremoterecoveryreserved_latency", "Wait„emote„ecovery„eserved„ecovery state†atency");

3236 
rs_³rf
.
	`add_time_avg
(
rs_»cov”šg_Ï‹ncy
, "recovering_latency", "Recovering„ecovery state†atency");

3237 
rs_³rf
.
	`add_time_avg
(
rs_»cov”ed_Ï‹ncy
, "recovered_latency", "Recovered„ecovery state†atency");

3238 
rs_³rf
.
	`add_time_avg
(
rs_ş—n_Ï‹ncy
, "clean_latency", "Clean„ecovery state†atency");

3239 
rs_³rf
.
	`add_time_avg
(
rs_aùive_Ï‹ncy
, "active_latency", "Active„ecovery state†atency");

3240 
rs_³rf
.
	`add_time_avg
(
rs_»¶iÿaùive_Ï‹ncy
, "replicaactive_latency", "Replicaactive„ecovery state†atency");

3241 
rs_³rf
.
	`add_time_avg
(
rs_¡¿y_Ï‹ncy
, "stray_latency", "Stray„ecovery state†atency");

3242 
rs_³rf
.
	`add_time_avg
(
rs_g‘šfo_Ï‹ncy
, "getinfo_latency", "Getinfo„ecovery state†atency");

3243 
rs_³rf
.
	`add_time_avg
(
rs_g‘log_Ï‹ncy
, "getlog_latency", "Getlog„ecovery state†atency");

3244 
rs_³rf
.
	`add_time_avg
(
rs_wa™aùšgchªge_Ï‹ncy
, "waitactingchange_latency", "Waitactingchange„ecovery state†atency");

3245 
rs_³rf
.
	`add_time_avg
(
rs_šcom¶‘e_Ï‹ncy
, "incomplete_latency", "Incomplete„ecovery state†atency");

3246 
rs_³rf
.
	`add_time_avg
(
rs_down_Ï‹ncy
, "down_latency", "Down„ecovery state†atency");

3247 
rs_³rf
.
	`add_time_avg
(
rs_g‘missšg_Ï‹ncy
, "getmissing_latency", "Getmissing„ecovery state†atency");

3248 
rs_³rf
.
	`add_time_avg
(
rs_wa™u±hru_Ï‹ncy
, "waitupthru_latency", "Waitupthru„ecovery state†atency");

3249 
rs_³rf
.
	`add_time_avg
(
rs_nÙ»cov”šg_Ï‹ncy
, "notrecovering_latency", "Notrecovering„ecovery state†atency");

3251 
»cov”y¡©e_³rf
 = 
rs_³rf
.
	`ü—‹_³rf_couÁ”s
();

3252 
cù
->
	`g‘_³rfcouÁ”s_cŞËùiÚ
()->
	`add
(
»cov”y¡©e_³rf
);

3253 
	}
}

3255 
	gOSD
::
	$shutdown
()

3257 ià(!
£rviû
.
	`´•¬e_to_¡İ
())

3259 
osd_lock
.
	`Lock
();

3260 ià(
	`is_¡İpšg
()) {

3261 
osd_lock
.
	`UÆock
();

3264 
d”r
 << "shutdown" << 
d’dl
;

3266 
	`£t_¡©e
(
STATE_STOPPING
);

3269 ià(
cù
->
_cÚf
->
g‘_v®
<
boŞ
>("osd_debug_shutdown")) {

3270 
cù
->
_cÚf
->
	`£t_v®
("debug_osd", "100");

3271 
cù
->
_cÚf
->
	`£t_v®
("debug_journal", "100");

3272 
cù
->
_cÚf
->
	`£t_v®
("debug_filestore", "100");

3273 
cù
->
_cÚf
->
	`£t_v®
("debug_bluestore", "100");

3274 
cù
->
_cÚf
->
	`£t_v®
("debug_ms", "100");

3275 
cù
->
_cÚf
->
	`­¶y_chªges
(
NULL
);

3279 
mgrc
.
	`shutdown
();

3281 
£rviû
.
	`¡¬t_shutdown
();

3285 
İ_sh¬dedwq
.
	`d¿š
();

3289 
veùÜ
<
PGRef
> 
pgs
;

3290 
	`_g‘_pgs
(&
pgs
);

3291 autØ
pg
 : 
pgs
) {

3292 
pg
->
	`shutdown
();

3297 
İ_sh¬dedwq
.
	`d¿š
();

3299 
fšished
.
	`ş—r
();

3303 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("status");

3304 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("flush_journal");

3305 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("dump_ops_in_flight");

3306 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("ops");

3307 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("dump_blocked_ops");

3308 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("dump_historic_ops");

3309 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("dump_historic_ops_by_duration");

3310 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("dump_historic_slow_ops");

3311 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("dump_op_pq_state");

3312 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("dump_blacklist");

3313 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("dump_watchers");

3314 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("dump_reservations");

3315 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("get_latest_osdmap");

3316 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("heap");

3317 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("set_heap_property");

3318 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("get_heap_property");

3319 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("dump_objectstore_kv_stats");

3320 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("dump_scrubs");

3321 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("calc_objectstore_db_histogram");

3322 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("flush_store_cache");

3323 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("dump_pgstate_history");

3324 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("compact");

3325 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("get_mapped_pools");

3326 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("smart");

3327 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("list_devices");

3328 
d–‘e
 
asok_hook
;

3329 
asok_hook
 = 
NULL
;

3331 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("setomapval");

3332 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("rmomapkey");

3333 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("setomapheader");

3334 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("getomap");

3335 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("truncobj");

3336 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("injectdataerr");

3337 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("injectmdataerr");

3338 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("set_recovery_delay");

3339 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("trigger_scrub");

3340 
cù
->
	`g‘_admš_sock‘
()->
	`uÄegi¡”_commªd
("injectfull");

3341 
d–‘e
 
‹¡_İs_hook
;

3342 
‹¡_İs_hook
 = 
NULL
;

3344 
osd_lock
.
	`UÆock
();

3346 
h—¹b—t_lock
.
	`Lock
();

3347 
h—¹b—t_¡İ
 = 
Œue
;

3348 
h—¹b—t_cÚd
.
	`SigÇl
();

3349 
h—¹b—t_lock
.
	`UÆock
();

3350 
h—¹b—t_th»ad
.
	`još
();

3352 
osd_İ_
.
	`d¿š
();

3353 
osd_İ_
.
	`¡İ
();

3354 
	`dout
(10è<< "İ sh¬ded°¡İ³d" << 
d’dl
;

3356 
commªd_
.
	`d¿š
();

3357 
commªd_
.
	`¡İ
();

3358 
	`dout
(10è<< "commªd°¡İ³d" << 
d’dl
;

3360 
	`dout
(10è<< "¡İpšg‡g’t" << 
d’dl
;

3361 
£rviû
.
	`ag’t_¡İ
();

3363 
osd_lock
.
	`Lock
();

3365 
	`»£t_h—¹b—t_³”s
();

3367 
tick_tim”
.
	`shutdown
();

3370 
Mu‹x
::
Lock”
 
	`l
(
tick_tim”_lock
);

3371 
tick_tim”_w™hout_osd_lock
.
	`shutdown
();

3375 
	`dout
(10è<< "nÙšg cËª unmouÁ iÀ•och " << 
osdm­
->
	`g‘_•och
(è<< 
d’dl
;

3376 
su³rblock
.
mouÁed
 = 
£rviû
.
	`g‘_boÙ_•och
();

3377 
su³rblock
.
ş—n_thru
 = 
osdm­
->
	`g‘_•och
();

3378 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

3379 
	`wr™e_su³rblock
(
t
);

3380 
r
 = 
¡Üe
->
	`queue_Œª§ùiÚ
(
£rviû
.
m‘a_ch
, 
¡d
::
	`move
(
t
));

3381 ià(
r
) {

3382 
d”r
 << "OSD::shutdown:ƒrror writing superblock: "

3383 << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

3387 
£rviû
.
	`shutdown_»£rv”
();

3390 #ifdeà
PG_DEBUG_REFS


3391 
£rviû
.
	`dump_live_pgids
();

3393 
Œue
) {

3394 
veùÜ
<
PGRef
> 
pgs
;

3395 
	`_g‘_pgs
(&
pgs
, 
Œue
);

3396 ià(
pgs
.
	`em±y
()) {

3399 auto& 
pg
 : 
pgs
) {

3400 ià(
pg
->
	`is_d–‘ed
()) {

3403 
	`dout
(20è<< " kickšg…g " << 
pg
 << 
d’dl
;

3404 
pg
->
	`lock
();

3405 ià(
pg
->
	`g‘_num_»f
() != 1) {

3406 
d”r
 << "pgid " << 
pg
->
	`g‘_pgid
() << " has„ef count of "

3407 << 
pg
->
	`g‘_num_»f
(è<< 
d’dl
;

3408 #ifdeà
PG_DEBUG_REFS


3409 
pg
->
	`dump_live_ids
();

3411 ià(
cù
->
_cÚf
->
osd_shutdown_pg»f_as£¹
) {

3412 
	`ûph_abÜt
();

3415 
pg
->
ch
.
	`»£t
();

3416 
pg
->
	`uÆock
();

3419 #ifdeà
PG_DEBUG_REFS


3420 
£rviû
.
	`dump_live_pgids
();

3422 
cù
->
_cÚf
->
	`»move_ob£rv”
(
this
);

3424 
£rviû
.
m‘a_ch
.
	`»£t
();

3426 
	`dout
(10è<< "syncšg stÜe" << 
d’dl
;

3427 
	`’abË_di§bË_fu£
(
Œue
);

3429 ià(
cù
->
_cÚf
->
osd_jouº®_æush_Ú_shutdown
) {

3430 
	`dout
(10è<< "æushšg jouº®" << 
d’dl
;

3431 
¡Üe
->
	`æush_jouº®
();

3434 
¡Üe
->
	`umouÁ
();

3435 
d–‘e
 
¡Üe
;

3436 
¡Üe
 = 0;

3437 
	`dout
(10è<< "StÜsynûd" << 
d’dl
;

3439 
mÚc
->
	`shutdown
();

3440 
osd_lock
.
	`UÆock
();

3442 
osdm­
 = 
	`OSDM­Ref
();

3443 autØ
s
 : 
sh¬ds
) {

3444 
Mu‹x
::
Lock”
 
	`l
(
s
->
osdm­_lock
);

3445 
s
->
sh¬d_osdm­
 = 
	`OSDM­Ref
();

3447 
£rviû
.
	`shutdown
();

3448 
İ_Œack”
.
	`Ú_shutdown
();

3450 
şass_hªdËr
->
	`shutdown
();

3451 
ş›Á_mes£ng”
->
	`shutdown
();

3452 
şu¡”_mes£ng”
->
	`shutdown
();

3453 
hb_äÚt_ş›Á_mes£ng”
->
	`shutdown
();

3454 
hb_back_ş›Á_mes£ng”
->
	`shutdown
();

3455 
objeù”_mes£ng”
->
	`shutdown
();

3456 
hb_äÚt_£rv”_mes£ng”
->
	`shutdown
();

3457 
hb_back_£rv”_mes£ng”
->
	`shutdown
();

3459  
r
;

3460 
	}
}

3462 
	gOSD
::
	$mÚ_cmd_maybe_osd_ü—‹
(
¡ršg
 &
cmd
)

3464 
boŞ
 
ü—‹d
 = 
çl£
;

3465 
Œue
) {

3466 
	`dout
(10è<< 
__func__
 << " cmd: " << 
cmd
 << 
d’dl
;

3467 
veùÜ
<
¡ršg
> 
vcmd
{
cmd
};

3468 
bufã¾i¡
 
šbl
;

3469 
C_SaãrCÚd
 
w
;

3470 
¡ršg
 
outs
;

3471 
mÚc
->
	`¡¬t_mÚ_commªd
(
vcmd
, 
šbl
, 
NULL
, &
outs
, &
w
);

3472 
r
 = 
w
.
	`wa™
();

3473 ià(
r
 < 0) {

3474 ià(
r
 =ğ-
ENOENT
 && !
ü—‹d
) {

3475 
¡ršg
 
Ãwcmd
 = "{\"´efix\": \"osd c»©e\", \"id\": " + 
	`¡ršgify
(
whßmi
)

3476 + ", \"uuid\": \"" + 
	`¡ršgify
(
su³rblock
.
osd_fsid
) + "\"}";

3477 
veùÜ
<
¡ršg
> 
vÃwcmd
{
Ãwcmd
};

3478 
bufã¾i¡
 
šbl
;

3479 
C_SaãrCÚd
 
w
;

3480 
¡ršg
 
outs
;

3481 
mÚc
->
	`¡¬t_mÚ_commªd
(
vÃwcmd
, 
šbl
, 
NULL
, &
outs
, &
w
);

3482 
r
 = 
w
.
	`wa™
();

3483 ià(
r
 < 0) {

3484 
d”r
 << 
__func__
 << " fail: osd does‚otƒxist‡nd created failed: "

3485 << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

3486  
r
;

3488 
ü—‹d
 = 
Œue
;

3491 
d”r
 << 
__func__
 << " fa: '" << 
outs
 << "': " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

3492  
r
;

3498 
	}
}

3500 
	gOSD
::
	$upd©e_üush_loÿtiÚ
()

3502 ià(!
cù
->
_cÚf
->
osd_üush_upd©e_Ú_¡¬t
) {

3503 
	`dout
(10è<< 
__func__
 << " osd_üush_upd©e_Ú_¡¬ˆğçl£" << 
d’dl
;

3507 
weight
[32];

3508 ià(
cù
->
_cÚf
->
osd_üush_š™Ÿl_weight
 >= 0) {

3509 
	`¢´štf
(
weight
, (weight), "%.4lf", 
cù
->
_cÚf
->
osd_üush_š™Ÿl_weight
);

3511 
¡Üe_¡©fs_t
 
¡
;

3512 
r
 = 
¡Üe
->
	`¡©fs
(&
¡
);

3513 ià(
r
 < 0) {

3514 
d”r
 << "¡©fs: " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

3515  
r
;

3517 
	`¢´štf
(
weight
, (weight), "%.4lf",

3518 
¡d
::
	`max
(.00001,

3519 (
¡
.
tÙ®
) /

3523 
¡d
::
muÉim­
<
¡ršg
,¡ršg> 
loc
 = 
cù
->
üush_loÿtiÚ
.
	`g‘_loÿtiÚ
();

3524 
	`dout
(10è<< 
__func__
 << " crush†oÿtiÚ i " << 
loc
 << 
d’dl
;

3526 
¡ršg
 
cmd
 =

3527 
	`¡ršg
("{\"prefix\": \"osd crush create-or-move\", ") +

3528 
	`¡ršg
("\"id\": "è+ 
	`¡ršgify
(
whßmi
) + string(", ") +

3529 
	`¡ršg
("\"weight\":"è+ 
weight
 + string(", ") +

3530 
	`¡ršg
("\"args\": [");

3531 
muÉim­
<
¡ršg
,¡ršg>::
™”©Ü
 
p
 = 
loc
.
	`begš
();… !ğloc.
	`’d
(); ++p) {

3532 ià(
p
 !ğ
loc
.
	`begš
())

3533 
cmd
 += ", ";

3534 
cmd
 +ğ"\"" + 
p
->
fœ¡
 + "=" +…->
£cÚd
 + "\"";

3536 
cmd
 += "]}";

3538  
	`mÚ_cmd_maybe_osd_ü—‹
(
cmd
);

3539 
	}
}

3541 
	gOSD
::
	$upd©e_üush_deviû_şass
()

3543 ià(!
cù
->
_cÚf
->
osd_şass_upd©e_Ú_¡¬t
) {

3544 
	`dout
(10è<< 
__func__
 << " osd_şass_upd©e_Ú_¡¬ˆğçl£" << 
d’dl
;

3548 
¡ršg
 
deviû_şass
;

3549 
r
 = 
¡Üe
->
	`»ad_m‘a
("üush_deviû_şass", &
deviû_şass
);

3550 ià(
r
 < 0 || 
deviû_şass
.
	`em±y
()) {

3551 
deviû_şass
 = 
¡Üe
->
	`g‘_deçuÉ_deviû_şass
();

3554 ià(
deviû_şass
.
	`em±y
()) {

3555 
	`dout
(20è<< 
__func__
 << "‚Ødeviû cÏs ¡Üed†oÿÎy" << 
d’dl
;

3559 
¡ršg
 
cmd
 =

3560 
	`¡ršg
("{\"prefix\": \"osd crush set-device-class\", ") +

3561 
	`¡ršg
("\"şass\": \""è+ 
deviû_şass
 + string("\", ") +

3562 
	`¡ršg
("\"ids\": [\""è+ 
	`¡ršgify
(
whßmi
) + string("\"]}");

3564 
r
 = 
	`mÚ_cmd_maybe_osd_ü—‹
(
cmd
);

3565 ià(
r
 =ğ-
EBUSY
) {

3569  
r
;

3571 
	}
}

3573 
	gOSD
::
	$wr™e_su³rblock
(
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
)

3575 
	`dout
(10è<< "wr™e_su³rblock " << 
su³rblock
 << 
d’dl
;

3578 ià(!
su³rblock
.
com·t_ã©u»s
.
šcom·t
.
	`cÚšs
(
CEPH_OSD_FEATURE_INCOMPAT_BASE
))

3579 
su³rblock
.
com·t_ã©u»s
.
šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_BASE
);

3581 
bufã¾i¡
 
bl
;

3582 
	`’code
(
su³rblock
, 
bl
);

3583 
t
.
	`wr™e
(
cŞl_t
::
	`m‘a
(), 
OSD_SUPERBLOCK_GOBJECT
, 0, 
bl
.
	`Ëngth
(), bl);

3584 
	}
}

3586 
	gOSD
::
	$»ad_su³rblock
()

3588 
bufã¾i¡
 
bl
;

3589 
r
 = 
¡Üe
->
	`»ad
(
£rviû
.
m‘a_ch
, 
OSD_SUPERBLOCK_GOBJECT
, 0, 0, 
bl
);

3590 ià(
r
 < 0)

3591  
r
;

3593 
bufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
	`begš
();

3594 
	`decode
(
su³rblock
, 
p
);

3596 
	`dout
(10è<< "»ad_su³rblock " << 
su³rblock
 << 
d’dl
;

3599 
	}
}

3601 
	gOSD
::
	$ş—r_‹mp_objeùs
()

3603 
	`dout
(10è<< 
__func__
 << 
d’dl
;

3604 
veùÜ
<
cŞl_t
> 
ls
;

3605 
¡Üe
->
	`li¡_cŞËùiÚs
(
ls
);

3606 
veùÜ
<
cŞl_t
>::
™”©Ü
 
p
 = 
ls
.
	`begš
();… !ğls.
	`’d
(); ++p) {

3607 
¥g_t
 
pgid
;

3608 ià(!
p
->
	`is_pg
(&
pgid
))

3612 
	`dout
(20è<< " cË¬šgemp š " << *
p
 << "…gid " << 
pgid
 << 
d’dl
;

3614 
veùÜ
<
ghobjeù_t
> 
‹mps
;

3615 
ghobjeù_t
 
Ãxt
;

3617 
veùÜ
<
ghobjeù_t
> 
objeùs
;

3618 autØ
ch
 = 
¡Üe
->
	`İ’_cŞËùiÚ
(*
p
);

3619 
	`as£¹
(
ch
);

3620 
¡Üe
->
	`cŞËùiÚ_li¡
(
ch
, 
Ãxt
, 
ghobjeù_t
::
	`g‘_max
(),

3621 
¡Üe
->
	`g‘_id—l_li¡_max
(),

3622 &
objeùs
, &
Ãxt
);

3623 ià(
objeùs
.
	`em±y
())

3625 
veùÜ
<
ghobjeù_t
>::
™”©Ü
 
q
;

3626 
q
 = 
objeùs
.
	`begš
(); q !ğobjeùs.
	`’d
(); ++q) {

3628 ià(
q
->
hobj
.
	`is_‹mp
(è|| (q->hobj.
poŞ
 == -1)) {

3629 
‹mps
.
	`push_back
(*
q
);

3636 ià(
q
 !ğ
objeùs
.
	`’d
())

3639 ià(!
‹mps
.
	`em±y
()) {

3640 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

3641 
»moved
 = 0;

3642 
veùÜ
<
ghobjeù_t
>::
™”©Ü
 
q
 = 
‹mps
.
	`begš
(); q !ğ‹mps.
	`’d
(); ++q) {

3643 
	`dout
(20è<< "„emovšg " << *
p
 << " objeù " << *
q
 << 
d’dl
;

3644 
t
.
	`»move
(*
p
, *
q
);

3645 ià(++
»moved
 > 
cù
->
_cÚf
->
osd_rg‘_Œª§ùiÚ_size
) {

3646 
¡Üe
->
	`queue_Œª§ùiÚ
(
£rviû
.
m‘a_ch
, 
¡d
::
	`move
(
t
));

3647 
t
 = 
ObjeùStÜe
::
	`T¿n§ùiÚ
();

3648 
»moved
 = 0;

3651 ià(
»moved
) {

3652 
¡Üe
->
	`queue_Œª§ùiÚ
(
£rviû
.
m‘a_ch
, 
¡d
::
	`move
(
t
));

3656 
	}
}

3658 
	gOSD
::
	$»cursive_»move_cŞËùiÚ
(
C•hCÚ‹xt
* 
cù
,

3659 
ObjeùStÜe
 *
¡Üe
, 
¥g_t
 
pgid
,

3660 
cŞl_t
 
tmp
)

3662 
OSDriv”
 
	`driv”
(

3663 
¡Üe
,

3664 
	`cŞl_t
(),

3665 
	`make_¢­m­³r_oid
());

3667 
ObjeùStÜe
::
CŞËùiÚHªdË
 
ch
 = 
¡Üe
->
	`İ’_cŞËùiÚ
(
tmp
);

3668 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

3669 
SÇpM­³r
 
	`m­³r
(
cù
, &
driv”
, 0, 0, 0, 
pgid
.
sh¬d
);

3671 
ghobjeù_t
 
Ãxt
;

3672 
max
 = 
cù
->
_cÚf
->
osd_rg‘_Œª§ùiÚ_size
;

3673 
veùÜ
<
ghobjeù_t
> 
objeùs
;

3674 
objeùs
.
	`»£rve
(
max
);

3675 
Œue
) {

3676 
objeùs
.
	`ş—r
();

3677 
¡Üe
->
	`cŞËùiÚ_li¡
(
ch
, 
Ãxt
, 
ghobjeù_t
::
	`g‘_max
(),

3678 
max
, &
objeùs
, &
Ãxt
);

3679 
	`g’”ic_dout
(10è<< 
__func__
 << " " << 
objeùs
 << 
d’dl
;

3680 ià(
objeùs
.
	`em±y
())

3682 auto& 
p
: 
objeùs
) {

3683 
OSDriv”
::
OST¿n§ùiÚ
 
	`_t
(
driv”
.
	`g‘_Œª§ùiÚ
(&
t
));

3684 
r
 = 
m­³r
.
	`»move_oid
(
p
.
hobj
, &
_t
);

3685 ià(
r
 !ğ0 &&„ !ğ-
ENOENT
)

3686 
	`ûph_abÜt
();

3687 
t
.
	`»move
(
tmp
, 
p
);

3689 
r
 = 
¡Üe
->
	`queue_Œª§ùiÚ
(
ch
, 
¡d
::
	`move
(
t
));

3690 
	`as£¹
(
r
 == 0);

3691 
t
 = 
ObjeùStÜe
::
	`T¿n§ùiÚ
();

3693 
t
.
	`»move_cŞËùiÚ
(
tmp
);

3694 
r
 = 
¡Üe
->
	`queue_Œª§ùiÚ
(
ch
, 
¡d
::
	`move
(
t
));

3695 
	`as£¹
(
r
 == 0);

3697 
C_SaãrCÚd
 
wa™”
;

3698 ià(!
ch
->
	`æush_comm™
(&
wa™”
)) {

3699 
wa™”
.
	`wa™
();

3701 
	}
}

3707 
PG
* 
	gOSD
::
	$_make_pg
(

3708 
OSDM­Ref
 
ü—‹m­
,

3709 
¥g_t
 
pgid
)

3711 
	`dout
(10è<< 
__func__
 << " " << 
pgid
 << 
d’dl
;

3712 
pg_poŞ_t
 
pi
;

3713 
m­
<
¡ršg
,¡ršg> 
ec_´ofe
;

3714 
¡ršg
 
Çme
;

3715 ià(
ü—‹m­
->
	`have_pg_poŞ
(
pgid
.
	`poŞ
())) {

3716 
pi
 = *
ü—‹m­
->
	`g‘_pg_poŞ
(
pgid
.
	`poŞ
());

3717 
Çme
 = 
ü—‹m­
->
	`g‘_poŞ_Çme
(
pgid
.
	`poŞ
());

3718 ià(
pi
.
	`is_”asu»
()) {

3719 
ec_´ofe
 = 
ü—‹m­
->
	`g‘_”asu»_code_´ofe
(
pi
.
”asu»_code_´ofe
);

3723 
ghobjeù_t
 
oid
 = 
	`make_fš®_poŞ_šfo_oid
(
pgid
.
	`poŞ
());

3724 
bufã¾i¡
 
bl
;

3725 
r
 = 
¡Üe
->
	`»ad
(
£rviû
.
m‘a_ch
, 
oid
, 0, 0, 
bl
);

3726 ià(
r
 < 0) {

3727 
d”r
 << 
__func__
 << " missšg…oŞ " << 
pgid
.
	`poŞ
() << "ombstone"

3728 << 
d’dl
;

3729  
nuÎ±r
;

3731 
	`ûph_as£¹
(
r
 >= 0);

3732 autØ
p
 = 
bl
.
	`begš
();

3733 
	`decode
(
pi
, 
p
);

3734 
	`decode
(
Çme
, 
p
);

3735 ià(
p
.
	`’d
()) {

3736 
d”r
 << 
__func__
 << " missšgƒc_´ofäom…oŞ " << 
pgid
.
	`poŞ
()

3737 << "omb¡Úe" << 
d’dl
;

3738  
nuÎ±r
;

3740 
	`decode
(
ec_´ofe
, 
p
);

3742 
PGPoŞ
 
	`poŞ
(
cù
, 
ü—‹m­
, 
pgid
.poŞ(), 
pi
, 
Çme
);

3743 
PG
 *
pg
;

3744 ià(
pi
.
ty³
 =ğ
pg_poŞ_t
::
TYPE_REPLICATED
 ||

3745 
pi
.
ty³
 =ğ
pg_poŞ_t
::
TYPE_ERASURE
)

3746 
pg
 = 
Ãw
 
	`Prim¬yLogPG
(&
£rviû
, 
ü—‹m­
, 
poŞ
, 
ec_´ofe
, 
pgid
);

3748 
	`ûph_abÜt
();

3749  
pg
;

3750 
	}
}

3752 
	gOSD
::
_g‘_pgs
(
veùÜ
<
PGRef
> *
v
, 
boŞ
 
ş—r_too
)

3754 
	gv
->
ş—r
();

3755 auto& 
	gs
 : 
sh¬ds
) {

3756 
Mu‹x
::
Lock”
 
l
(
s
->
sh¬d_lock
);

3757 auto& 
	gj
 : 
s
->
pg_¦Ùs
) {

3758 ià(
j
.
£cÚd
->
pg
 &&

3759 !
j
.
£cÚd
->
pg
->
is_d–‘ed
()) {

3760 
v
->
push_back
(
j
.
£cÚd
->
pg
);

3761 ià(
	gş—r_too
) {

3762 
	gs
->
_d‘ach_pg
(
j
.
£cÚd
.
g‘
());

3769 
	gOSD
::
_g‘_pgids
(
veùÜ
<
¥g_t
> *
v
)

3771 
v
->
ş—r
();

3772 auto& 
	gs
 : 
sh¬ds
) {

3773 
Mu‹x
::
Lock”
 
l
(
s
->
sh¬d_lock
);

3774 auto& 
	gj
 : 
s
->
pg_¦Ùs
) {

3775 ià(
j
.
£cÚd
->
pg
 &&

3776 !
j
.
£cÚd
->
pg
->
is_d–‘ed
()) {

3777 
v
->
push_back
(
j
.
fœ¡
);

3783 
	gOSD
::
	$»gi¡”_pg
(
PGRef
 
pg
)

3785 
¥g_t
 
pgid
 = 
pg
->
	`g‘_pgid
();

3786 
ušt32_t
 
sh¬d_šdex
 = 
pgid
.
	`hash_to_sh¬d
(
num_sh¬ds
);

3787 autØ
sd©a
 = 
sh¬ds
[
sh¬d_šdex
];

3788 
Mu‹x
::
Lock”
 
	`l
(
sd©a
->
sh¬d_lock
);

3789 autØ
r
 = 
sd©a
->
pg_¦Ùs
.
	`em¶aû
(
pgid
, 
make_unique
<
OSDSh¬dPGSlÙ
>());

3790 
	`as£¹
(
r
.
£cÚd
);

3791 autØ*
¦Ù
 = 
r
.
fœ¡
->
£cÚd
.
	`g‘
();

3792 
	`dout
(20è<< 
__func__
 << " " << 
pgid
 << " " << 
pg
 << 
d’dl
;

3793 
sd©a
->
	`_©ch_pg
(
¦Ù
, 
pg
.
	`g‘
());

3794 
	}
}

3796 
	gOSD
::
	$uÄegi¡”_pg
(
PG
 *
pg
)

3798 autØ
sd©a
 = 
pg
->
osd_sh¬d
;

3799 
	`as£¹
(
sd©a
);

3800 
Mu‹x
::
Lock”
 
	`l
(
sd©a
->
sh¬d_lock
);

3801 autØ
p
 = 
sd©a
->
pg_¦Ùs
.
	`fšd
(
pg
->
pg_id
);

3802 ià(
p
 !ğ
sd©a
->
pg_¦Ùs
.
	`’d
() &&

3803 
p
->
£cÚd
->
pg
) {

3804 
	`dout
(20è<< 
__func__
 << " " << 
pg
->
pg_id
 << " " <<…g << 
d’dl
;

3805 
sd©a
->
	`_d‘ach_pg
(
p
->
£cÚd
.
	`g‘
());

3807 
	`dout
(20è<< 
__func__
 << " " << 
pg
->
pg_id
 << "‚Ù found" << 
d’dl
;

3809 
	}
}

3811 
PGRef
 
	gOSD
::
	$_lookup_pg
(
¥g_t
 
pgid
)

3813 
ušt32_t
 
sh¬d_šdex
 = 
pgid
.
	`hash_to_sh¬d
(
num_sh¬ds
);

3814 autØ
sd©a
 = 
sh¬ds
[
sh¬d_šdex
];

3815 
Mu‹x
::
Lock”
 
	`l
(
sd©a
->
sh¬d_lock
);

3816 autØ
p
 = 
sd©a
->
pg_¦Ùs
.
	`fšd
(
pgid
);

3817 ià(
p
 =ğ
sd©a
->
pg_¦Ùs
.
	`’d
()) {

3818  
nuÎ±r
;

3820  
p
->
£cÚd
->
pg
;

3821 
	}
}

3823 
PGRef
 
	gOSD
::
	$_lookup_lock_pg
(
¥g_t
 
pgid
)

3825 
PGRef
 
pg
 = 
	`_lookup_pg
(
pgid
);

3826 ià(!
pg
) {

3827  
nuÎ±r
;

3829 
pg
->
	`lock
();

3830 ià(!
pg
->
	`is_d–‘ed
()) {

3831  
pg
;

3833 
pg
->
	`uÆock
();

3834  
nuÎ±r
;

3835 
	}
}

3837 
PGRef
 
	gOSD
::
	$lookup_lock_pg
(
¥g_t
 
pgid
)

3839  
	`_lookup_lock_pg
(
pgid
);

3840 
	}
}

3842 
	gOSD
::
	$lßd_pgs
()

3844 
	`as£¹
(
osd_lock
.
	`is_locked
());

3845 
	`dout
(0è<< "lßd_pgs" << 
d’dl
;

3847 
veùÜ
<
cŞl_t
> 
ls
;

3848 
r
 = 
¡Üe
->
	`li¡_cŞËùiÚs
(
ls
);

3849 ià(
r
 < 0) {

3850 
d”r
 << "çedØli¡…gs: " << 
	`ıp_¡»¼Ü
(-
r
è<< 
d’dl
;

3853 
num
 = 0;

3854 
veùÜ
<
cŞl_t
>::
™”©Ü
 
™
 = 
ls
.
	`begš
();

3855 
™
 !ğ
ls
.
	`’d
();

3856 ++
™
) {

3857 
¥g_t
 
pgid
;

3858 ià(
™
->
	`is_‹mp
(&
pgid
) ||

3859 (
™
->
	`is_pg
(&
pgid
è&& 
PG
::
	`_has_»mov®_æag
(
¡Üe
,…gid))) {

3860 
	`dout
(10è<< "lßd_pg " << *
™
 << " cË¬šgemp" << 
d’dl
;

3861 
	`»cursive_»move_cŞËùiÚ
(
cù
, 
¡Üe
, 
pgid
, *
™
);

3865 ià(!
™
->
	`is_pg
(&
pgid
)) {

3866 
	`dout
(10è<< "lßd_pg ignÜšg uÄecognized " << *
™
 << 
d’dl
;

3870 
	`dout
(10è<< "pgid " << 
pgid
 << " cŞÈ" << 
	`cŞl_t
Õgidè<< 
d’dl
;

3871 
•och_t
 
m­_•och
 = 0;

3872 
r
 = 
PG
::
	`³ek_m­_•och
(
¡Üe
, 
pgid
, &
m­_•och
);

3873 ià(
r
 < 0) {

3874 
d”r
 << 
__func__
 << " uÇbËØ³ek‡ˆ" << 
pgid
 << " metadata, skipping"

3875 << 
d’dl
;

3879 
PGRef
 
pg
;

3880 ià(
m­_•och
 > 0) {

3881 
OSDM­Ref
 
pgosdm­
 = 
£rviû
.
	`Œy_g‘_m­
(
m­_•och
);

3882 ià(!
pgosdm­
) {

3883 ià(!
osdm­
->
	`have_pg_poŞ
(
pgid
.
	`poŞ
())) {

3884 
d”r
 << 
__func__
 << ": could‚Ù fšd m­ fÜƒpoch " << 
m­_•och


3885 << " oÀpg " << 
pgid
 << ", buthe…ool is‚ot…resent inhe "

3888 << "tØş—À™ u°Ï‹r." << 
d’dl
;

3891 
d”r
 << 
__func__
 << ": havpgid " << 
pgid
 << "‡tƒpoch "

3892 << 
m­_•och
 << ", but missing map. Crashing."

3893 << 
d’dl
;

3894 
	`as£¹
(0 == "Missing map in†oad_pgs");

3897 
pg
 = 
	`_make_pg
(
pgosdm­
, 
pgid
);

3899 
pg
 = 
	`_make_pg
(
osdm­
, 
pgid
);

3901 ià(!
pg
) {

3902 
	`»cursive_»move_cŞËùiÚ
(
cù
, 
¡Üe
, 
pgid
, *
™
);

3908 
pg
->
	`lock
();

3909 
pg
->
ch
 = 
¡Üe
->
	`İ’_cŞËùiÚ
Õg->
cŞl
);

3912 
pg
->
	`»ad_¡©e
(
¡Üe
);

3914 ià(
pg
->
	`dÃ
()) {

3915 
	`dout
(10è<< "lßd_pg " << *
™
 << " d–‘šg dÃ" << 
d’dl
;

3916 
pg
->
ch
 = 
nuÎ±r
;

3917 
pg
->
	`uÆock
();

3918 
	`»cursive_»move_cŞËùiÚ
(
cù
, 
¡Üe
, 
pgid
, *
™
);

3922 
£t
<
¥g_t
> 
Ãw_chd»n
;

3923 
£rviû
.
	`id’tify_¥l™_chd»n
(
pg
->
	`g‘_osdm­
(), 
osdm­
,…g->
pg_id
,

3924 &
Ãw_chd»n
);

3925 ià(!
Ãw_chd»n
.
	`em±y
()) {

3926 autØ
sh¬d
 : 
sh¬ds
) {

3927 
sh¬d
->
	`´ime_¥l™s
(
osdm­
, &
Ãw_chd»n
);

3929 
	`as£¹
(
Ãw_chd»n
.
	`em±y
());

3932 
pg
->
	`»g_Ãxt_süub
();

3934 
	`dout
(10è<< 
__func__
 << "†ßded " << *
pg
 << 
d’dl
;

3935 
pg
->
	`uÆock
();

3937 
	`»gi¡”_pg
(
pg
);

3938 ++
num
;

3940 
	`dout
(0è<< 
__func__
 << " o³Ãd " << 
num
 << "…gs" << 
d’dl
;

3941 
	}
}

3944 
PGRef
 
	gOSD
::
	$hªdË_pg_ü—‹_šfo
(cÚ¡ 
OSDM­Ref
& 
osdm­
,

3945 cÚ¡ 
PGC»©eInfo
 *
šfo
)

3947 
¥g_t
 
pgid
 = 
šfo
->pgid;

3949 ià(
	`maybe_wa™_fÜ_max_pg
(
osdm­
, 
pgid
, 
šfo
->
by_mÚ
)) {

3950 
	`dout
(10è<< 
__func__
 << " h™ max…g, drİpšg" << 
d’dl
;

3951  
nuÎ±r
;

3954 
PG
::
Recov”yCtx
 
rùx
 = 
	`ü—‹_cÚ‹xt
();

3956 
OSDM­Ref
 
¡¬tm­
 = 
	`g‘_m­
(
šfo
->
•och
);

3957 
up_´im¬y
, 
aùšg_´im¬y
;

3958 
veùÜ
<> 
up
, 
aùšg
;

3959 
¡¬tm­
->
	`pg_to_up_aùšg_osds
(

3960 
pgid
.pgid, &
up
, &
up_´im¬y
, &
aùšg
, &
aùšg_´im¬y
);

3962 cÚ¡ 
pg_poŞ_t
* 
µ
 = 
¡¬tm­
->
	`g‘_pg_poŞ
(
pgid
.
	`poŞ
());

3963 ià(
µ
->
	`has_æag
(
pg_poŞ_t
::
FLAG_EC_OVERWRITES
) &&

3964 
¡Üe
->
	`g‘_ty³
() != "bluestore") {

3965 
şog
->
	`w¬n
(è<< "pg " << 
pgid


3970 
PG
::
	`_ü—‹
(*
rùx
.
Œª§ùiÚ
, 
pgid
,…gid.
	`g‘_¥l™_b™s
(
µ
->
	`g‘_pg_num
()));

3971 
PG
::
	`_š™
(*
rùx
.
Œª§ùiÚ
, 
pgid
, 
µ
);

3973 
rŞe
 = 
¡¬tm­
->
	`ÿlc_pg_rŞe
(
whßmi
, 
aùšg
,‡ùšg.
	`size
());

3974 ià(!
µ
->
	`is_»¶iÿ‹d
(è&& 
rŞe
 !ğ
pgid
.
sh¬d
) {

3975 
rŞe
 = -1;

3978 
PGRef
 
pg
 = 
	`_make_pg
(
¡¬tm­
, 
pgid
);

3979 
pg
->
ch
 = 
¡Üe
->
	`ü—‹_Ãw_cŞËùiÚ
Õg->
cŞl
);

3981 
pg
->
	`lock
(
Œue
);

3984 
	`as£¹
(!
pg
->
	`is_d–‘ed
());

3986 
pg
->
	`š™
(

3987 
rŞe
,

3988 
up
,

3989 
up_´im¬y
,

3990 
aùšg
,

3991 
aùšg_´im¬y
,

3992 
šfo
->
hi¡Üy
,

3993 
šfo
->
·¡_š‹rv®s
,

3994 
çl£
,

3995 
rùx
.
Œª§ùiÚ
);

3997 
pg
->
	`hªdË_š™Ÿlize
(&
rùx
);

3998 
pg
->
	`hªdË_aùiv©e_m­
(&
rùx
);

4000 
	`di¥©ch_cÚ‹xt
(
rùx
, 
pg
.
	`g‘
(), 
osdm­
, 
nuÎ±r
);

4002 
	`dout
(10è<< 
__func__
 << "‚ew…g " << *
pg
 << 
d’dl
;

4003  
pg
;

4004 
	}
}

4006 
boŞ
 
	gOSD
::
	$maybe_wa™_fÜ_max_pg
(cÚ¡ 
OSDM­Ref
& 
osdm­
,

4007 
¥g_t
 
pgid
,

4008 
boŞ
 
is_mÚ_ü—‹
)

4010 cÚ¡‡utØ
max_pgs_³r_osd
 =

4011 (
cù
->
_cÚf
->
g‘_v®
<
ušt64_t
>("mon_max_pg_per_osd") *

4012 
cù
->
_cÚf
->
g‘_v®
<>("osd_max_pg_per_osd_hard_ratio"));

4014 ià(
num_pgs
 < 
max_pgs_³r_osd
) {

4015  
çl£
;

4018 [[
gnu
::
unu£d
]]‡uto&& 
³ndšg_ü—‹s_lock”
 = 
	`gu¬dedly_lock
(
³ndšg_ü—‹s_lock
);

4019 ià(
is_mÚ_ü—‹
) {

4020 
³ndšg_ü—‹s_äom_mÚ
++;

4022 
boŞ
 
is_´im¬y
 = 
osdm­
->
	`g‘_pg_aùšg_¿nk
(
pgid
.pgid, 
whßmi
) == 0;

4023 
³ndšg_ü—‹s_äom_osd
.
	`em¶aû
(
pgid
.pgid, 
is_´im¬y
);

4025 
	`dout
(1è<< 
__func__
 << " w™hhŞd c»©iÚ oàpg " << 
pgid


4026 << ": " << 
num_pgs
 << " >ğ"<< 
max_pgs_³r_osd
 << 
d’dl
;

4027  
Œue
;

4028 
	}
}

4033 
	gveùÜ
<
	gšt32_t
> 
twiddË
(cÚ¡ 
veùÜ
<>& 
aùšg
) {

4034 ià(
	gaùšg
.
size
() > 1) {

4035  {
	gaùšg
[0]};

4037 
	gveùÜ
<
	gšt32_t
> 
twiddËd
(
aùšg
.
begš
(),‡ùšg.
’d
());

4038 
	gtwiddËd
.
push_back
(-1);

4039  
	gtwiddËd
;

4043 
	gOSD
::
	$»sume_ü—tšg_pg
()

4045 
boŞ
 
do_sub_pg_ü—‹s
 = 
çl£
;

4046 
boŞ
 
have_³ndšg_ü—‹s
 = 
çl£
;

4048 cÚ¡‡utØ
max_pgs_³r_osd
 =

4049 (
cù
->
_cÚf
->
g‘_v®
<
ušt64_t
>("mon_max_pg_per_osd") *

4050 
cù
->
_cÚf
->
g‘_v®
<>("osd_max_pg_per_osd_hard_ratio"));

4051 ià(
max_pgs_³r_osd
 <ğ
num_pgs
) {

4055 
¥¬e_pgs
 = 
max_pgs_³r_osd
 - 
num_pgs
;

4056 [[
gnu
::
unu£d
]]‡uto&& 
lock”
 = 
	`gu¬dedly_lock
(
³ndšg_ü—‹s_lock
);

4057 ià(
³ndšg_ü—‹s_äom_mÚ
 > 0) {

4058 
	`dout
(20è<< 
__func__
 << "…ending_creates_from_mon "

4059 << 
³ndšg_ü—‹s_äom_mÚ
 << 
d’dl
;

4060 
do_sub_pg_ü—‹s
 = 
Œue
;

4061 ià(
³ndšg_ü—‹s_äom_mÚ
 >ğ
¥¬e_pgs
) {

4062 
¥¬e_pgs
 = 
³ndšg_ü—‹s_äom_mÚ
 = 0;

4064 
¥¬e_pgs
 -ğ
³ndšg_ü—‹s_äom_mÚ
;

4065 
³ndšg_ü—‹s_äom_mÚ
 = 0;

4068 autØ
pg
 = 
³ndšg_ü—‹s_äom_osd
.
	`cbegš
();

4069 
¥¬e_pgs
 > 0 && 
pg
 !ğ
³ndšg_ü—‹s_äom_osd
.
	`ûnd
()) {

4070 
	`dout
(20è<< 
__func__
 << "…g " << 
pg
->
fœ¡
 << 
d’dl
;

4071 
veùÜ
<> 
aùšg
;

4072 
osdm­
->
	`pg_to_up_aùšg_osds
(
pg
->
fœ¡
, 
nuÎ±r
,‚uÎ±r, &
aùšg
,‚ullptr);

4073 
£rviû
.
	`queue_wªt_pg_‹mp
(
pg
->
fœ¡
, 
	`twiddË
(
aùšg
), 
Œue
);

4074 
pg
 = 
³ndšg_ü—‹s_äom_osd
.
	`”a£
(pg);

4075 
do_sub_pg_ü—‹s
 = 
Œue
;

4076 
¥¬e_pgs
--;

4078 
have_³ndšg_ü—‹s
 = (
³ndšg_ü—‹s_äom_mÚ
 > 0 ||

4079 !
³ndšg_ü—‹s_äom_osd
.
	`em±y
());

4082 
boŞ
 
do_»Ãw_subs
 = 
çl£
;

4083 ià(
do_sub_pg_ü—‹s
) {

4084 ià(
mÚc
->
	`sub_wªt
("osd_pg_ü—‹s", 
Ï¡_pg_ü—‹_•och
, 0)) {

4085 
	`dout
(4è<< 
__func__
 << ":„esolicit…g creates from mon since "

4086 << 
Ï¡_pg_ü—‹_•och
 << 
d’dl
;

4087 
do_»Ãw_subs
 = 
Œue
;

4090 
v”siÚ_t
 
¡¬t
 = 
osdm­
->
	`g‘_•och
() + 1;

4091 ià(
have_³ndšg_ü—‹s
) {

4093 ià(
mÚc
->
	`sub_wªt
("osdm­", 
¡¬t
, 0)) {

4094 
	`dout
(4è<< 
__func__
 << ":„esolicit osdmap from mon since "

4095 << 
¡¬t
 << 
d’dl
;

4096 
do_»Ãw_subs
 = 
Œue
;

4098 } ià(
do_sub_pg_ü—‹s
) {

4101 ià(
mÚc
->
	`sub_wªt_šüem’t
("osdm­", 
¡¬t
, 
CEPH_SUBSCRIBE_ONETIME
)) {

4102 
	`dout
(4è<< 
__func__
 << ":„e-subscribe osdmap(onetime) since "

4103 << 
¡¬t
 << 
d’dl
;

4104 
do_»Ãw_subs
 = 
Œue
;

4108 ià(
do_»Ãw_subs
) {

4109 
mÚc
->
	`»Ãw_subs
();

4112 
£rviû
.
	`£nd_pg_‹mp
();

4113 
	}
}

4115 
	gOSD
::
	$bud_š™Ÿl_pg_hi¡Üy
(

4116 
¥g_t
 
pgid
,

4117 
•och_t
 
ü—‹d
,

4118 
utime_t
 
ü—‹d_¡amp
,

4119 
pg_hi¡Üy_t
 *
h
,

4120 
Pa¡IÁ”v®s
 *
pi
)

4122 
	`dout
(10è<< 
__func__
 << " " << 
pgid
 << " c»©ed " << 
ü—‹d
 << 
d’dl
;

4123 
h
->
•och_ü—‹d
 = 
ü—‹d
;

4124 
h
->
•och_poŞ_ü—‹d
 = 
ü—‹d
;

4125 
h
->
§me_š‹rv®_sšû
 = 
ü—‹d
;

4126 
h
->
§me_up_sšû
 = 
ü—‹d
;

4127 
h
->
§me_´im¬y_sšû
 = 
ü—‹d
;

4128 
h
->
Ï¡_süub_¡amp
 = 
ü—‹d_¡amp
;

4129 
h
->
Ï¡_d“p_süub_¡amp
 = 
ü—‹d_¡amp
;

4130 
h
->
Ï¡_ş—n_süub_¡amp
 = 
ü—‹d_¡amp
;

4132 
OSDM­Ref
 
Ï¡m­
 = 
£rviû
.
	`g‘_m­
(
ü—‹d
);

4133 
up_´im¬y
, 
aùšg_´im¬y
;

4134 
veùÜ
<> 
up
, 
aùšg
;

4135 
Ï¡m­
->
	`pg_to_up_aùšg_osds
(

4136 
pgid
.pgid, &
up
, &
up_´im¬y
, &
aùšg
, &
aùšg_´im¬y
);

4138 
o¡ršg¡»am
 
debug
;

4139 
•och_t
 
e
 = 
ü—‹d
 + 1;ƒ <ğ
osdm­
->
	`g‘_•och
(); ++e) {

4140 
OSDM­Ref
 
osdm­
 = 
£rviû
.
	`g‘_m­
(
e
);

4141 
Ãw_up_´im¬y
, 
Ãw_aùšg_´im¬y
;

4142 
veùÜ
<> 
Ãw_up
, 
Ãw_aùšg
;

4143 
osdm­
->
	`pg_to_up_aùšg_osds
(

4144 
pgid
.pgid, &
Ãw_up
, &
Ãw_up_´im¬y
, &
Ãw_aùšg
, &
Ãw_aùšg_´im¬y
);

4147 
mš_size_´ediÿ‹_t
 : 
public
 
IsPGRecov”abËP»diÿ‹
 {

4148 cÚ¡ 
pg_poŞ_t
 *
pi
;

4149 
boŞ
 
	`İ”©Ü
()(cÚ¡ 
£t
<
pg_sh¬d_t
> &
have
) const {

4150  
have
.
	`size
(è>ğ
pi
->
mš_size
;

4152 
ex¶ic™
 
	`mš_size_´ediÿ‹_t
(cÚ¡ 
pg_poŞ_t
 *
i
è: 
	`pi
(i) {}

4153 } 
	`mš_size_´ediÿ‹
(
osdm­
->
	`g‘_pg_poŞ
(
pgid
.pgid.
	`poŞ
()));

4155 
boŞ
 
Ãw_š‹rv®
 = 
Pa¡IÁ”v®s
::
	`check_Ãw_š‹rv®
(

4156 
aùšg_´im¬y
,

4157 
Ãw_aùšg_´im¬y
,

4158 
aùšg
, 
Ãw_aùšg
,

4159 
up_´im¬y
,

4160 
Ãw_up_´im¬y
,

4161 
up
, 
Ãw_up
,

4162 
h
->
§me_š‹rv®_sšû
,

4163 
h
->
Ï¡_•och_ş—n
,

4164 
osdm­
,

4165 
Ï¡m­
,

4166 
pgid
.pgid,

4167 &
mš_size_´ediÿ‹
,

4168 
pi
,

4169 &
debug
);

4170 ià(
Ãw_š‹rv®
) {

4171 
h
->
§me_š‹rv®_sšû
 = 
e
;

4172 ià(
up
 !ğ
Ãw_up
) {

4173 
h
->
§me_up_sšû
 = 
e
;

4175 ià(
aùšg_´im¬y
 !ğ
Ãw_aùšg_´im¬y
) {

4176 
h
->
§me_´im¬y_sšû
 = 
e
;

4178 ià(
pgid
.pgid.
	`is_¥l™
(
Ï¡m­
->
	`g‘_pg_num
Õgid.pgid.
	`poŞ
()),

4179 
osdm­
->
	`g‘_pg_num
(
pgid
.pgid.
	`poŞ
()),

4180 
nuÎ±r
)) {

4181 
h
->
Ï¡_•och_¥l™
 = 
e
;

4183 
up
 = 
Ãw_up
;

4184 
aùšg
 = 
Ãw_aùšg
;

4185 
up_´im¬y
 = 
Ãw_up_´im¬y
;

4186 
aùšg_´im¬y
 = 
Ãw_aùšg_´im¬y
;

4188 
Ï¡m­
 = 
osdm­
;

4190 
	`dout
(20è<< 
__func__
 << " " << 
debug
.
	`¡r
(è<< 
d’dl
;

4191 
	`dout
(10è<< 
__func__
 << " " << *
h
 << " " << *
pi


4192 << " [" << (
pi
->
	`em±y
(è? 
·œ
<
•och_t
,epoch_t>(0,0) :

4193 
pi
->
	`g‘_bounds
()) << ")"

4194 << 
d’dl
;

4195 
	}
}

4201 
boŞ
 
	gOSD
::
´ojeù_pg_hi¡Üy
(
¥g_t
 
pgid
, 
pg_hi¡Üy_t
& 
h
, 
•och_t
 
äom
,

4202 cÚ¡ 
veùÜ
<>& 
cu¼’tup
,

4203 
cu¼’tuµrim¬y
,

4204 cÚ¡ 
veùÜ
<>& 
cu¼’ùšg
,

4205 
cu¼’ùšg´im¬y
)

4207 
dout
(15è<< "´ojeù_pg_hi¡Üy " << 
	gpgid


4208 << " from " << 
	gäom
 << "Ø" << 
	gosdm­
->
g‘_•och
()

4209 << ", s¹ " << 
	gh


4210 << 
	gd’dl
;

4212 
•och_t
 
	ge
;

4213 
	ge
 = 
osdm­
->
g‘_•och
();

4214 
	ge
 > 
	gäom
;

4215 
	ge
--) {

4217 
OSDM­Ref
 
	gŞdm­
 = 
£rviû
.
Œy_g‘_m­
(
e
-1);

4218 ià(!
	gŞdm­
) {

4219 
dout
(15è<< 
	g__func__
 << ": found m­ g­,„‘uºšg f®£" << 
	gd’dl
;

4220  
	gçl£
;

4222 
as£¹
(
Şdm­
->
have_pg_poŞ
(
pgid
.
poŞ
()));

4224 
	guµrim¬y
, 
	gaùšg´im¬y
;

4225 
	gveùÜ
<> 
	gup
, 
	gaùšg
;

4226 
	gŞdm­
->
pg_to_up_aùšg_osds
(

4227 
pgid
.pgid,

4228 &
up
,

4229 &
uµrim¬y
,

4230 &
aùšg
,

4231 &
aùšg´im¬y
);

4234 ià((
	gaùšg´im¬y
 !ğ
cu¼’ùšg´im¬y
 ||

4235 
uµrim¬y
 !ğ
cu¼’tuµrim¬y
 ||

4236 
aùšg
 !ğ
cu¼’ùšg
 ||

4237 
up
 !ğ
cu¼’tup
è&& 
e
 > 
h
.
§me_š‹rv®_sšû
) {

4238 
dout
(15è<< "´ojeù_pg_hi¡Üy " << 
pgid
 << "‡ùšg|u°chªged iÀ" << 
e


4239 << " from " << 
aùšg
 << "/" << 
up


4240 << " " << 
aùšg´im¬y
 << "/" << 
uµrim¬y


4241 << " -> " << 
cu¼’ùšg
 << "/" << 
cu¼’tup


4242 << " " << 
cu¼’ùšg´im¬y
 << "/" << 
cu¼’tuµrim¬y


4243 << 
d’dl
;

4244 
	gh
.
	g§me_š‹rv®_sšû
 = 
e
;

4247 ià(
	gpgid
.
is_¥l™
(
Şdm­
->
g‘_pg_num
(
pgid
.
poŞ
()),

4248 
osdm­
->
g‘_pg_num
(
pgid
.
poŞ
()),

4249 0è&& 
	ge
 > 
	gh
.
	g§me_š‹rv®_sšû
) {

4250 
	gh
.
	g§me_š‹rv®_sšû
 = 
e
;

4253 ià((
	gup
 !ğ
cu¼’tup
 || 
uµrim¬y
 !ğ
cu¼’tuµrim¬y
)

4254 && 
e
 > 
h
.
§me_up_sšû
) {

4255 
dout
(15è<< "´ojeù_pg_hi¡Üy " << 
pgid
 << " u°chªged iÀ" << 
e


4256 << " from " << 
up
 << " " << 
uµrim¬y


4257 << " -> " << 
cu¼’tup
 << " " << 
cu¼’tuµrim¬y
 << 
d’dl
;

4258 
	gh
.
	g§me_up_sšû
 = 
e
;

4262 ià(
	gOSDM­
::
´im¬y_chªged
(

4263 
aùšg´im¬y
,

4264 
aùšg
,

4265 
cu¼’ùšg´im¬y
,

4266 
cu¼’ùšg
) &&

4267 
	ge
 > 
	gh
.
	g§me_´im¬y_sšû
) {

4268 
dout
(15è<< "´ojeù_pg_hi¡Üy " << 
	gpgid
 << "…rim¬y chªged iÀ" << 
	ge
 << 
	gd’dl
;

4269 
	gh
.
	g§me_´im¬y_sšû
 = 
e
;

4272 ià(
	gh
.
	g§me_š‹rv®_sšû
 >ğ
e
 && 
h
.
§me_up_sšû
 >ğ&& h.
§me_´im¬y_sšû
 >=ƒ)

4278 ià(
	ge
 =ğ
h
.
•och_ü—‹d
) {

4279 ià(!
h
.
§me_š‹rv®_sšû
)

4280 
h
.
§me_š‹rv®_sšû
 = 
e
;

4281 ià(!
	gh
.
	g§me_up_sšû
)

4282 
	gh
.
	g§me_up_sšû
 = 
e
;

4283 ià(!
	gh
.
	g§me_´im¬y_sšû
)

4284 
	gh
.
	g§me_´im¬y_sšû
 = 
e
;

4287 
dout
(15è<< "´ojeù_pg_hi¡Üyƒnd " << 
	gh
 << 
	gd’dl
;

4288  
	gŒue
;

4293 
	gOSD
::
	$_add_h—¹b—t_³”
(
p
)

4295 ià(
p
 =ğ
whßmi
)

4297 
H—¹b—tInfo
 *
hi
;

4299 
m­
<,
H—¹b—tInfo
>::
™”©Ü
 
i
 = 
h—¹b—t_³”s
.
	`fšd
(
p
);

4300 ià(
i
 =ğ
h—¹b—t_³”s
.
	`’d
()) {

4301 
·œ
<
CÚÃùiÚRef
,CÚÃùiÚRef> 
cÚs
 = 
£rviû
.
	`g‘_cÚ_osd_hb
(
p
, 
osdm­
->
	`g‘_•och
());

4302 ià(!
cÚs
.
fœ¡
)

4304 
hi
 = &
h—¹b—t_³”s
[
p
];

4305 
hi
->
³”
 = 
p
;

4306 
H—¹b—tSessiÚ
 *
s
 = 
Ãw
 
	`H—¹b—tSessiÚ
(
p
);

4307 
hi
->
cÚ_back
 = 
cÚs
.
fœ¡
.
	`g‘
();

4308 
hi
->
cÚ_back
->
	`£t_´iv
(
s
->
	`g‘
());

4309 ià(
cÚs
.
£cÚd
) {

4310 
hi
->
cÚ_äÚt
 = 
cÚs
.
£cÚd
.
	`g‘
();

4311 
hi
->
cÚ_äÚt
->
	`£t_´iv
(
s
->
	`g‘
());

4312 
	`dout
(10è<< "_add_h—¹b—t_³”:‚ew…“¸osd." << 
p


4313 << " " << 
hi
->
cÚ_back
->
	`g‘_³”_addr
()

4314 << " " << 
hi
->
cÚ_äÚt
->
	`g‘_³”_addr
()

4315 << 
d’dl
;

4317 
hi
->
cÚ_äÚt
.
	`»£t
(
NULL
);

4318 
	`dout
(10è<< "_add_h—¹b—t_³”:‚ew…“¸osd." << 
p


4319 << " " << 
hi
->
cÚ_back
->
	`g‘_³”_addr
()

4320 << 
d’dl
;

4322 
s
->
	`put
();

4324 
hi
 = &
i
->
£cÚd
;

4326 
hi
->
•och
 = 
osdm­
->
	`g‘_•och
();

4327 
	}
}

4329 
	gOSD
::
	$_»move_h—¹b—t_³”
(
n
)

4331 
m­
<,
H—¹b—tInfo
>::
™”©Ü
 
q
 = 
h—¹b—t_³”s
.
	`fšd
(
n
);

4332 
	`as£¹
(
q
 !ğ
h—¹b—t_³”s
.
	`’d
());

4333 
	`dout
(20è<< "„emovšg h—¹b—ˆ³” osd." << 
n


4334 << " " << 
q
->
£cÚd
.
cÚ_back
->
	`g‘_³”_addr
()

4335 << " " << (
q
->
£cÚd
.
cÚ_äÚt
 ? q->£cÚd.cÚ_äÚt->
	`g‘_³”_addr
(è: 
	`’t™y_addr_t
())

4336 << 
d’dl
;

4337 
q
->
£cÚd
.
cÚ_back
->
	`m¬k_down
();

4338 ià(
q
->
£cÚd
.
cÚ_äÚt
) {

4339 
q
->
£cÚd
.
cÚ_äÚt
->
	`m¬k_down
();

4341 
h—¹b—t_³”s
.
	`”a£
(
q
);

4342 
	}
}

4344 
	gOSD
::
	$Ãed_h—¹b—t_³”_upd©e
()

4346 ià(
	`is_¡İpšg
())

4348 
	`dout
(20è<< "Ãed_h—¹b—t_³”_upd©e" << 
d’dl
;

4349 
	`h—¹b—t_£t_³”s_Ãed_upd©e
();

4350 
	}
}

4352 
	gOSD
::
	$maybe_upd©e_h—¹b—t_³”s
()

4354 
	`as£¹
(
osd_lock
.
	`is_locked
());

4356 ià(
	`is_wa™šg_fÜ_h—Éhy
()) {

4357 
utime_t
 
now
 = 
	`ûph_şock_now
();

4358 ià(
Ï¡_h—¹b—t_»§m¶e
 =ğ
	`utime_t
()) {

4359 
Ï¡_h—¹b—t_»§m¶e
 = 
now
;

4360 
	`h—¹b—t_£t_³”s_Ãed_upd©e
();

4361 } ià(!
	`h—¹b—t_³”s_Ãed_upd©e
()) {

4362 
utime_t
 
dur
 = 
now
 - 
Ï¡_h—¹b—t_»§m¶e
;

4363 ià(
dur
 > 
cù
->
_cÚf
->
osd_h—¹b—t_g¿û
) {

4364 
	`dout
(10è<< "maybe_upd©e_h—¹b—t_³” fÜcšg upd©aá” " << 
dur
 << " secÚds" << 
d’dl
;

4365 
	`h—¹b—t_£t_³”s_Ãed_upd©e
();

4366 
Ï¡_h—¹b—t_»§m¶e
 = 
now
;

4367 
	`»£t_h—¹b—t_³”s
();

4372 ià(!
	`h—¹b—t_³”s_Ãed_upd©e
())

4374 
	`h—¹b—t_ş—r_³”s_Ãed_upd©e
();

4376 
Mu‹x
::
Lock”
 
	`l
(
h—¹b—t_lock
);

4378 
	`dout
(10è<< "maybe_upd©e_h—¹b—t_³” upd©šg" << 
d’dl
;

4382 ià(
	`is_aùive
()) {

4383 
veùÜ
<
PGRef
> 
pgs
;

4384 
	`_g‘_pgs
(&
pgs
);

4385 auto& 
pg
 : 
pgs
) {

4386 
pg
->
	`w™h_h—¹b—t_³”s
([&](
³”
) {

4387 ià(
osdm­
->
	`is_up
(
³”
)) {

4388 
	`_add_h—¹b—t_³”
(
³”
);

4395 
£t
<> 
wªt
, 
exŒas
;

4396 cÚ¡ 
Ãxt
 = 
osdm­
->
	`g‘_Ãxt_up_osd_aá”
(
whßmi
);

4397 ià(
Ãxt
 >= 0)

4398 
wªt
.
	`š£¹
(
Ãxt
);

4399 
´ev
 = 
osdm­
->
	`g‘_´evious_up_osd_befÜe
(
whßmi
);

4400 ià(
´ev
 >ğ0 &&…»v !ğ
Ãxt
)

4401 
wªt
.
	`š£¹
(
´ev
);

4403 
£t
<>::
™”©Ü
 
p
 = 
wªt
.
	`begš
();… !ğwªt.
	`’d
(); ++p) {

4404 
	`dout
(10è<< "‡ddšg‚eighbÜ…“¸osd." << *
p
 << 
d’dl
;

4405 
exŒas
.
	`š£¹
(*
p
);

4406 
	`_add_h—¹b—t_³”
(*
p
);

4410 
m­
<,
H—¹b—tInfo
>::
™”©Ü
 
p
 = 
h—¹b—t_³”s
.
	`begš
();

4411 
p
 !ğ
h—¹b—t_³”s
.
	`’d
()) {

4412 ià(!
osdm­
->
	`is_up
(
p
->
fœ¡
)) {

4413 
o
 = 
p
->
fœ¡
;

4414 ++
p
;

4415 
	`_»move_h—¹b—t_³”
(
o
);

4418 ià(
p
->
£cÚd
.
•och
 < 
osdm­
->
	`g‘_•och
()) {

4419 
exŒas
.
	`š£¹
(
p
->
fœ¡
);

4421 ++
p
;

4425 
n
 = 
Ãxt
;‚ >= 0; ) {

4426 ià(()
h—¹b—t_³”s
.
	`size
(è>ğ
cù
->
_cÚf
->
osd_h—¹b—t_mš_³”s
)

4428 ià(!
exŒas
.
	`couÁ
(
n
è&& !
wªt
.couÁÒè&&‚ !ğ
whßmi
) {

4429 
	`dout
(10è<< "‡ddšg„ªdom…“¸osd." << 
n
 << 
d’dl
;

4430 
exŒas
.
	`š£¹
(
n
);

4431 
	`_add_h—¹b—t_³”
(
n
);

4433 
n
 = 
osdm­
->
	`g‘_Ãxt_up_osd_aá”
(n);

4434 ià(
n
 =ğ
Ãxt
)

4439 
£t
<>::
™”©Ü
 
p
 = 
exŒas
.
	`begš
();

4440 ()
h—¹b—t_³”s
.
	`size
(è> 
cù
->
_cÚf
->
osd_h—¹b—t_mš_³”s
 && 
p
 !ğ
exŒas
.
	`’d
();

4441 ++
p
) {

4442 ià(
wªt
.
	`couÁ
(*
p
))

4444 
	`_»move_h—¹b—t_³”
(*
p
);

4447 
	`dout
(10è<< "maybe_upd©e_h—¹b—t_³” " << 
h—¹b—t_³”s
.
	`size
(è<< "…“rs,ƒxŒa " << 
exŒas
 << 
d’dl
;

4448 
	}
}

4450 
	gOSD
::
	$»£t_h—¹b—t_³”s
()

4452 
	`as£¹
(
osd_lock
.
	`is_locked
());

4453 
	`dout
(10è<< "»£t_h—¹b—t_³”s" << 
d’dl
;

4454 
Mu‹x
::
Lock”
 
	`l
(
h—¹b—t_lock
);

4455 !
h—¹b—t_³”s
.
	`em±y
()) {

4456 
H—¹b—tInfo
& 
hi
 = 
h—¹b—t_³”s
.
	`begš
()->
£cÚd
;

4457 
hi
.
cÚ_back
->
	`m¬k_down
();

4458 ià(
hi
.
cÚ_äÚt
) {

4459 
hi
.
cÚ_äÚt
->
	`m¬k_down
();

4461 
h—¹b—t_³”s
.
	`”a£
(h—¹b—t_³”s.
	`begš
());

4463 
çu»_queue
.
	`ş—r
();

4464 
	}
}

4466 
	gOSD
::
	$hªdË_osd_pšg
(
MOSDPšg
 *
m
)

4468 ià(
su³rblock
.
şu¡”_fsid
 !ğ
m
->
fsid
) {

4469 
	`dout
(20è<< "hªdË_osd_pšg from " << 
m
->
	`g‘_sourû_š¡
()

4470 << " bad fsid " << 
m
->
fsid
 << " !ğ" << 
su³rblock
.
şu¡”_fsid
 << 
d’dl
;

4471 
m
->
	`put
();

4475 
äom
 = 
m
->
	`g‘_sourû
().
	`num
();

4477 
h—¹b—t_lock
.
	`Lock
();

4478 ià(
	`is_¡İpšg
()) {

4479 
h—¹b—t_lock
.
	`UÆock
();

4480 
m
->
	`put
();

4484 
OSDM­Ref
 
curm­
 = 
£rviû
.
	`g‘_osdm­
();

4485 ià(!
curm­
) {

4486 
h—¹b—t_lock
.
	`UÆock
();

4487 
m
->
	`put
();

4491 
m
->
İ
) {

4493 
MOSDPšg
::
PING
:

4495 ià(
cù
->
_cÚf
->
osd_debug_drİ_pšg_´obab™y
 > 0) {

4496 autØ
h—¹b—t_drİ
 = 
debug_h—¹b—t_drİs_»maššg
.
	`fšd
(
äom
);

4497 ià(
h—¹b—t_drİ
 !ğ
debug_h—¹b—t_drİs_»maššg
.
	`’d
()) {

4498 ià(
h—¹b—t_drİ
->
£cÚd
 == 0) {

4499 
debug_h—¹b—t_drİs_»maššg
.
	`”a£
(
h—¹b—t_drİ
);

4501 --
h—¹b—t_drİ
->
£cÚd
;

4502 
	`dout
(5è<< "Drİpšg h—¹b—ˆäom " << 
äom


4503 << ", " << 
h—¹b—t_drİ
->
£cÚd


4504 << "„emaššgØdrİ" << 
d’dl
;

4507 } ià(
cù
->
_cÚf
->
osd_debug_drİ_pšg_´obab™y
 >

4508 (((()(
	`¿nd
()%100))/100.0))) {

4509 
h—¹b—t_drİ
 =

4510 
debug_h—¹b—t_drİs_»maššg
.
	`š£¹
(
¡d
::
	`make_·œ
(
äom
,

4511 
cù
->
_cÚf
->
osd_debug_drİ_pšg_du¿tiÚ
)).
fœ¡
;

4512 
	`dout
(5è<< "Drİpšg h—¹b—ˆäom " << 
äom


4513 << ", " << 
h—¹b—t_drİ
->
£cÚd


4514 << "„emaššgØdrİ" << 
d’dl
;

4519 ià(!
cù
->
	`g‘_h—¹b—t_m­
()->
	`is_h—Éhy
()) {

4520 
	`dout
(10è<< "š‹º® h—¹b—ˆnÙ h—Éhy, drİpšg…šg„eque¡" << 
d’dl
;

4524 
Mes§ge
 *
r
 = 
Ãw
 
	`MOSDPšg
(
mÚc
->
	`g‘_fsid
(),

4525 
curm­
->
	`g‘_•och
(),

4526 
MOSDPšg
::
PING_REPLY
, 
m
->
¡amp
,

4527 
cù
->
_cÚf
->
osd_h—¹b—t_mš_size
);

4528 
m
->
	`g‘_cÚÃùiÚ
()->
	`£nd_mes§ge
(
r
);

4530 ià(
curm­
->
	`is_up
(
äom
)) {

4531 
£rviû
.
	`nÙe_³”_•och
(
äom
, 
m
->
m­_•och
);

4532 ià(
	`is_aùive
()) {

4533 
CÚÃùiÚRef
 
cÚ
 = 
£rviû
.
	`g‘_cÚ_osd_şu¡”
(
äom
, 
curm­
->
	`g‘_•och
());

4534 ià(
cÚ
) {

4535 
£rviû
.
	`sh¬e_m­_³”
(
äom
, 
cÚ
.
	`g‘
());

4538 } ià(!
curm­
->
	`exi¡s
(
äom
) ||

4539 
curm­
->
	`g‘_down_©
(
äom
è> 
m
->
m­_•och
) {

4541 
Mes§ge
 *
r
 = 
Ãw
 
	`MOSDPšg
(
mÚc
->
	`g‘_fsid
(),

4542 
curm­
->
	`g‘_•och
(),

4543 
MOSDPšg
::
YOU_DIED
,

4544 
m
->
¡amp
,

4545 
cù
->
_cÚf
->
osd_h—¹b—t_mš_size
);

4546 
m
->
	`g‘_cÚÃùiÚ
()->
	`£nd_mes§ge
(
r
);

4551 
MOSDPšg
::
PING_REPLY
:

4553 
m­
<,
H—¹b—tInfo
>::
™”©Ü
 
i
 = 
h—¹b—t_³”s
.
	`fšd
(
äom
);

4554 ià(
i
 !ğ
h—¹b—t_³”s
.
	`’d
()) {

4555 ià(
m
->
	`g‘_cÚÃùiÚ
(è=ğ
i
->
£cÚd
.
cÚ_back
) {

4556 
	`dout
(25è<< "hªdË_osd_pšg gÙ„•ly from osd." << 
äom


4557 << " fœ¡_tx " << 
i
->
£cÚd
.
fœ¡_tx


4558 << "†a¡_tx " << 
i
->
£cÚd
.
Ï¡_tx


4559 << "†a¡_rx_back " << 
i
->
£cÚd
.
Ï¡_rx_back
 << " -> " << 
m
->
¡amp


4560 << "†a¡_rx_äÚˆ" << 
i
->
£cÚd
.
Ï¡_rx_äÚt


4561 << 
d’dl
;

4562 
i
->
£cÚd
.
Ï¡_rx_back
 = 
m
->
¡amp
;

4564 ià(
i
->
£cÚd
.
cÚ_äÚt
 =ğ
NULL
)

4565 
i
->
£cÚd
.
Ï¡_rx_äÚt
 = 
m
->
¡amp
;

4566 } ià(
m
->
	`g‘_cÚÃùiÚ
(è=ğ
i
->
£cÚd
.
cÚ_äÚt
) {

4567 
	`dout
(25è<< "hªdË_osd_pšg gÙ„•ly from osd." << 
äom


4568 << " fœ¡_tx " << 
i
->
£cÚd
.
fœ¡_tx


4569 << "†a¡_tx " << 
i
->
£cÚd
.
Ï¡_tx


4570 << "†a¡_rx_back " << 
i
->
£cÚd
.
Ï¡_rx_back


4571 << "†a¡_rx_äÚˆ" << 
i
->
£cÚd
.
Ï¡_rx_äÚt
 << " -> " << 
m
->
¡amp


4572 << 
d’dl
;

4573 
i
->
£cÚd
.
Ï¡_rx_äÚt
 = 
m
->
¡amp
;

4576 
utime_t
 
cutoff
 = 
	`ûph_şock_now
();

4577 
cutoff
 -ğ
cù
->
_cÚf
->
osd_h—¹b—t_g¿û
;

4578 ià(
i
->
£cÚd
.
	`is_h—Éhy
(
cutoff
)) {

4580 autØ
çu»_queue_’Œy
 = 
çu»_queue
.
	`fšd
(
äom
);

4581 ià(
çu»_queue_’Œy
 !ğ
çu»_queue
.
	`’d
()) {

4582 
	`dout
(10) << "handle_osd_ping canceling queued "

4583 << "çu»„•ÜˆfÜ osd." << 
äom
 << 
d’dl
;

4584 
çu»_queue
.
	`”a£
(
çu»_queue_’Œy
);

4587 autØ
çu»_³ndšg_’Œy
 = 
çu»_³ndšg
.
	`fšd
(
äom
);

4588 ià(
çu»_³ndšg_’Œy
 !ğ
çu»_³ndšg
.
	`’d
()) {

4589 
	`dout
(10) << "handle_osd_ping canceling in-flight "

4590 << "çu»„•ÜˆfÜ osd." << 
äom
 << 
d’dl
;

4591 
	`£nd_¡l_®ive
(
curm­
->
	`g‘_•och
(),

4592 
çu»_³ndšg_’Œy
->
£cÚd
.second);

4593 
çu»_³ndšg
.
	`”a£
(
çu»_³ndšg_’Œy
);

4598 ià(
m
->
m­_•och
 &&

4599 
curm­
->
	`is_up
(
äom
)) {

4600 
£rviû
.
	`nÙe_³”_•och
(
äom
, 
m
->
m­_•och
);

4601 ià(
	`is_aùive
()) {

4602 
CÚÃùiÚRef
 
cÚ
 = 
£rviû
.
	`g‘_cÚ_osd_şu¡”
(
äom
, 
curm­
->
	`g‘_•och
());

4603 ià(
cÚ
) {

4604 
£rviû
.
	`sh¬e_m­_³”
(
äom
, 
cÚ
.
	`g‘
());

4611 
MOSDPšg
::
YOU_DIED
:

4612 
	`dout
(10è<< "hªdË_osd_pšg " << 
m
->
	`g‘_sourû_š¡
()

4613 << " say ˜am dowÀš " << 
m
->
m­_•och
 << 
d’dl
;

4614 
	`osdm­_subsüibe
(
curm­
->
	`g‘_•och
()+1, 
çl£
);

4618 
h—¹b—t_lock
.
	`UÆock
();

4619 
m
->
	`put
();

4620 
	}
}

4622 
	gOSD
::
	$h—¹b—t_’Œy
()

4624 
Mu‹x
::
Lock”
 
	`l
(
h—¹b—t_lock
);

4625 ià(
	`is_¡İpšg
())

4627 !
h—¹b—t_¡İ
) {

4628 
	`h—¹b—t
();

4630 
wa™
 = .5 + (()(
	`¿nd
(è% 10)/10.0è* ()
cù
->
_cÚf
->
osd_h—¹b—t_š‹rv®
;

4631 
utime_t
 
w
;

4632 
w
.
	`£t_äom_doubË
(
wa™
);

4633 
	`dout
(30è<< "h—¹b—t_’Œy sË•šg fÜ " << 
wa™
 << 
d’dl
;

4634 
h—¹b—t_cÚd
.
	`Wa™IÁ”v®
(
h—¹b—t_lock
, 
w
);

4635 ià(
	`is_¡İpšg
())

4637 
	`dout
(30è<< "h—¹b—t_’Œy wokup" << 
d’dl
;

4639 
	}
}

4641 
	gOSD
::
	$h—¹b—t_check
()

4643 
	`as£¹
(
h—¹b—t_lock
.
	`is_locked
());

4644 
utime_t
 
now
 = 
	`ûph_şock_now
();

4647 
utime_t
 
cutoff
 = 
now
;

4648 
cutoff
 -ğ
cù
->
_cÚf
->
osd_h—¹b—t_g¿û
;

4649 
m­
<,
H—¹b—tInfo
>::
™”©Ü
 
p
 = 
h—¹b—t_³”s
.
	`begš
();

4650 
p
 !ğ
h—¹b—t_³”s
.
	`’d
();

4651 ++
p
) {

4653 ià(
p
->
£cÚd
.
fœ¡_tx
 =ğ
	`utime_t
()) {

4654 
	`dout
(25è<< "h—¹b—t_check whav’'ˆ£Á…šgØosd." << 
p
->
fœ¡


4655 << "y‘, skpšg" << 
d’dl
;

4659 
	`dout
(25è<< "h—¹b—t_check osd." << 
p
->
fœ¡


4660 << " fœ¡_tx " << 
p
->
£cÚd
.
fœ¡_tx


4661 << "†a¡_tx " << 
p
->
£cÚd
.
Ï¡_tx


4662 << "†a¡_rx_back " << 
p
->
£cÚd
.
Ï¡_rx_back


4663 << "†a¡_rx_äÚˆ" << 
p
->
£cÚd
.
Ï¡_rx_äÚt


4664 << 
d’dl
;

4665 ià(
p
->
£cÚd
.
	`is_unh—Éhy
(
cutoff
)) {

4666 ià(
p
->
£cÚd
.
Ï¡_rx_back
 =ğ
	`utime_t
() ||

4667 
p
->
£cÚd
.
Ï¡_rx_äÚt
 =ğ
	`utime_t
()) {

4668 
d”r
 << "h—¹b—t_check:‚Ø»¶y from " << 
p
->
£cÚd
.
cÚ_äÚt
->
	`g‘_³”_addr
().
	`g‘_sockaddr
()

4669 << " osd." << 
p
->
fœ¡
 << "ƒver onƒither front or back, first…ing sent "

4670 << 
p
->
£cÚd
.
fœ¡_tx
 << " (cutofà" << 
cutoff
 << ")" << 
d’dl
;

4672 
çu»_queue
[
p
->
fœ¡
] =…->
£cÚd
.
Ï¡_tx
;

4674 
d”r
 << "h—¹b—t_check:‚Ø»¶y from " << 
p
->
£cÚd
.
cÚ_äÚt
->
	`g‘_³”_addr
().
	`g‘_sockaddr
()

4675 << " osd." << 
p
->
fœ¡
 << " sšû back " <<…->
£cÚd
.
Ï¡_rx_back


4676 << " frÚˆ" << 
p
->
£cÚd
.
Ï¡_rx_äÚt


4677 << " (cutofà" << 
cutoff
 << ")" << 
d’dl
;

4679 
çu»_queue
[
p
->
fœ¡
] = 
¡d
::
	`mš
Õ->
£cÚd
.
Ï¡_rx_back
,…->£cÚd.
Ï¡_rx_äÚt
);

4683 
	}
}

4685 
	gOSD
::
	$h—¹b—t
()

4687 
	`dout
(30è<< "h—¹b—t" << 
d’dl
;

4690 
lßdavgs
[1];

4691 
hb_š‹rv®
 = 
cù
->
_cÚf
->
osd_h—¹b—t_š‹rv®
;

4692 
n_§m¶es
 = 86400;

4693 ià(
hb_š‹rv®
 > 1) {

4694 
n_§m¶es
 /ğ
hb_š‹rv®
;

4695 ià(
n_§m¶es
 < 1)

4696 
n_§m¶es
 = 1;

4699 ià(
	`g‘lßdavg
(
lßdavgs
, 1) == 1) {

4700 
logg”
->
	`£t
(
l_osd_lßdavg
, 100 * 
lßdavgs
[0]);

4701 
day_lßdavg
 = (day_lßdavg * (
n_§m¶es
 - 1è+ 
lßdavgs
[0]) /‚_samples;

4702 
	`dout
(30è<< "h—¹b—t: day_lßdavg " << 
day_lßdavg
 << 
d’dl
;

4705 
	`dout
(30è<< "h—¹b—ˆcheckšg sts" << 
d’dl
;

4708 
veùÜ
<> 
hb_³”s
;

4709 
m­
<,
H—¹b—tInfo
>::
™”©Ü
 
p
 = 
h—¹b—t_³”s
.
	`begš
();

4710 
p
 !ğ
h—¹b—t_³”s
.
	`’d
();

4711 ++
p
)

4712 
hb_³”s
.
	`push_back
(
p
->
fœ¡
);

4713 
£rviû
.
	`upd©e_osd_¡©
(
hb_³”s
);

4715 
	`dout
(5è<< "h—¹b—t: " << 
£rviû
.
	`g‘_osd_¡©
(è<< 
d’dl
;

4717 
utime_t
 
now
 = 
	`ûph_şock_now
();

4720 
m­
<,
H—¹b—tInfo
>::
™”©Ü
 
i
 = 
h—¹b—t_³”s
.
	`begš
();

4721 
i
 !ğ
h—¹b—t_³”s
.
	`’d
();

4722 ++
i
) {

4723 
³”
 = 
i
->
fœ¡
;

4724 
i
->
£cÚd
.
Ï¡_tx
 = 
now
;

4725 ià(
i
->
£cÚd
.
fœ¡_tx
 =ğ
	`utime_t
())

4726 
i
->
£cÚd
.
fœ¡_tx
 = 
now
;

4727 
	`dout
(30è<< "h—¹b—ˆ£ndšg…šgØosd." << 
³”
 << 
d’dl
;

4728 
i
->
£cÚd
.
cÚ_back
->
	`£nd_mes§ge
(
Ãw
 
	`MOSDPšg
(
mÚc
->
	`g‘_fsid
(),

4729 
£rviû
.
	`g‘_osdm­_•och
(),

4730 
MOSDPšg
::
PING
, 
now
,

4731 
cù
->
_cÚf
->
osd_h—¹b—t_mš_size
));

4733 ià(
i
->
£cÚd
.
cÚ_äÚt
)

4734 
i
->
£cÚd
.
cÚ_äÚt
->
	`£nd_mes§ge
(
Ãw
 
	`MOSDPšg
(
mÚc
->
	`g‘_fsid
(),

4735 
£rviû
.
	`g‘_osdm­_•och
(),

4736 
MOSDPšg
::
PING
, 
now
,

4737 
cù
->
_cÚf
->
osd_h—¹b—t_mš_size
));

4740 
logg”
->
	`£t
(
l_osd_hb_to
, 
h—¹b—t_³”s
.
	`size
());

4743 
	`dout
(30è<< "h—¹b—ˆlÚ–y?" << 
d’dl
;

4744 ià(
h—¹b—t_³”s
.
	`em±y
()) {

4745 ià(
now
 - 
Ï¡_mÚ_h—¹b—t
 > 
cù
->
_cÚf
->
osd_mÚ_h—¹b—t_š‹rv®
 && 
	`is_aùive
()) {

4746 
Ï¡_mÚ_h—¹b—t
 = 
now
;

4747 
	`dout
(10è<< "˜havnØh—¹b—ˆ³”s; checkšg mÚ fÜ‚ew m­" << 
d’dl
;

4748 
	`osdm­_subsüibe
(
osdm­
->
	`g‘_•och
(è+ 1, 
çl£
);

4752 
	`dout
(30è<< "h—¹b—ˆdÚe" << 
d’dl
;

4753 
	}
}

4755 
boŞ
 
	gOSD
::
	$h—¹b—t_»£t
(
CÚÃùiÚ
 *
cÚ
)

4757 
H—¹b—tSessiÚ
 *
s
 = 
¡©ic_ÿ¡
<H—¹b—tSessiÚ*>(
cÚ
->
	`g‘_´iv
());

4758 ià(
s
) {

4759 
h—¹b—t_lock
.
	`Lock
();

4760 ià(
	`is_¡İpšg
()) {

4761 
h—¹b—t_lock
.
	`UÆock
();

4762 
s
->
	`put
();

4763  
Œue
;

4765 
m­
<,
H—¹b—tInfo
>::
™”©Ü
 
p
 = 
h—¹b—t_³”s
.
	`fšd
(
s
->
³”
);

4766 ià(
p
 !ğ
h—¹b—t_³”s
.
	`’d
() &&

4767 (
p
->
£cÚd
.
cÚ_back
 =ğ
cÚ
 ||

4768 
p
->
£cÚd
.
cÚ_äÚt
 =ğ
cÚ
)) {

4769 
	`dout
(10è<< "h—¹b—t_»£ˆçed hb cÚ " << 
cÚ
 << " fÜ osd." << 
p
->
£cÚd
.
³”


4770 << ",„eİ’šg" << 
d’dl
;

4771 ià(
cÚ
 !ğ
p
->
£cÚd
.
cÚ_back
) {

4772 
p
->
£cÚd
.
cÚ_back
->
	`m¬k_down
();

4774 
p
->
£cÚd
.
cÚ_back
.
	`»£t
(
NULL
);

4775 ià(
p
->
£cÚd
.
cÚ_äÚt
 && 
cÚ
 !=…->second.con_front) {

4776 
p
->
£cÚd
.
cÚ_äÚt
->
	`m¬k_down
();

4778 
p
->
£cÚd
.
cÚ_äÚt
.
	`»£t
(
NULL
);

4779 
·œ
<
CÚÃùiÚRef
,CÚÃùiÚRef> 
ÃwcÚ
 = 
£rviû
.
	`g‘_cÚ_osd_hb
(
p
->
£cÚd
.
³”
,…->£cÚd.
•och
);

4780 ià(
ÃwcÚ
.
fœ¡
) {

4781 
p
->
£cÚd
.
cÚ_back
 = 
ÃwcÚ
.
fœ¡
.
	`g‘
();

4782 
p
->
£cÚd
.
cÚ_back
->
	`£t_´iv
(
s
->
	`g‘
());

4783 ià(
ÃwcÚ
.
£cÚd
) {

4784 
p
->
£cÚd
.
cÚ_äÚt
 = 
ÃwcÚ
.£cÚd.
	`g‘
();

4785 
p
->
£cÚd
.
cÚ_äÚt
->
	`£t_´iv
(
s
->
	`g‘
());

4788 
	`dout
(10è<< "h—¹b—t_»£ˆçed hb cÚ " << 
cÚ
 << " fÜ osd." << 
p
->
£cÚd
.
³”


4789 << ",„aûd w™h osdm­ upd©e, closšg ouˆ³”" << 
d’dl
;

4790 
h—¹b—t_³”s
.
	`”a£
(
p
);

4793 
	`dout
(10è<< "h—¹b—t_»£ˆşosšg (Şdèçed hb cÚ " << 
cÚ
 << 
d’dl
;

4795 
h—¹b—t_lock
.
	`UÆock
();

4796 
s
->
	`put
();

4798  
Œue
;

4799 
	}
}

4805 
	gOSD
::
	$tick
()

4807 
	`as£¹
(
osd_lock
.
	`is_locked
());

4808 
	`dout
(10è<< "tick" << 
d’dl
;

4810 ià(
	`is_aùive
(è|| 
	`is_wa™šg_fÜ_h—Éhy
()) {

4811 
	`maybe_upd©e_h—¹b—t_³”s
();

4814 ià(
	`is_wa™šg_fÜ_h—Éhy
()) {

4815 
	`¡¬t_boÙ
();

4818 
	`do_wa™”s
();

4820 
tick_tim”
.
	`add_ev’t_aá”
(
OSD_TICK_INTERVAL
, 
Ãw
 
	`C_Tick
(
this
));

4821 
	}
}

4823 
	gOSD
::
	$tick_w™hout_osd_lock
()

4825 
	`as£¹
(
tick_tim”_lock
.
	`is_locked
());

4826 
	`dout
(10è<< "tick_w™hout_osd_lock" << 
d’dl
;

4828 
logg”
->
	`£t
(
l_osd_buf
, 
bufãr
::
	`g‘_tÙ®_®loc
());

4829 
logg”
->
	`£t
(
l_osd_hi¡Üy_®loc_by‹s
, 
	`shiá_round_up
(
bufãr
::
	`g‘_hi¡Üy_®loc_by‹s
(), 20));

4830 
logg”
->
	`£t
(
l_osd_hi¡Üy_®loc_num
, 
bufãr
::
	`g‘_hi¡Üy_®loc_num
());

4831 
logg”
->
	`£t
(
l_osd_ÿched_üc
, 
bufãr
::
	`g‘_ÿched_üc
());

4832 
logg”
->
	`£t
(
l_osd_ÿched_üc_adju¡ed
, 
bufãr
::
	`g‘_ÿched_üc_adju¡ed
());

4833 
logg”
->
	`£t
(
l_osd_mis£d_üc
, 
bufãr
::
	`g‘_mis£d_üc
());

4837 ià(
	`is_aùive
(è|| 
	`is_wa™šg_fÜ_h—Éhy
()) {

4838 
h—¹b—t_lock
.
	`Lock
();

4839 
	`h—¹b—t_check
();

4840 
h—¹b—t_lock
.
	`UÆock
();

4842 
m­_lock
.
	`g‘_»ad
();

4843 
Mu‹x
::
Lock”
 
	`l
(
mÚ_»pÜt_lock
);

4846 
utime_t
 
now
 = 
	`ûph_şock_now
();

4847 ià(
£rviû
.
	`Ãed_fuÎÃss_upd©e
() ||

4848 
now
 - 
Ï¡_mÚ_»pÜt
 > 
cù
->
_cÚf
->
osd_mÚ_»pÜt_š‹rv®
) {

4849 
Ï¡_mÚ_»pÜt
 = 
now
;

4850 
	`£nd_fuÎ_upd©e
();

4851 
	`£nd_çu»s
();

4853 
m­_lock
.
	`put_»ad
();

4855 
•och_t
 
max_wa™šg_•och
 = 0;

4856 autØ
s
 : 
sh¬ds
) {

4857 
max_wa™šg_•och
 = 
¡d
::
	`max
(max_waiting_epoch,

4858 
s
->
	`g‘_max_wa™šg_•och
());

4860 ià(
max_wa™šg_•och
 > 
	`g‘_osdm­
()->
	`g‘_•och
()) {

4861 
	`dout
(20è<< 
__func__
 << " max_wa™šg_•och " << 
max_wa™šg_•och


4862 << ",„eque¡šg‚ew m­" << 
d’dl
;

4863 
	`osdm­_subsüibe
(
su³rblock
.
Ãwe¡_m­
 + 1, 
çl£
);

4867 ià(
	`is_aùive
()) {

4868 ià(!
	`süub_¿ndom_backoff
()) {

4869 
	`sched_süub
();

4871 
£rviû
.
	`´omÙe_thrÙe_»ÿlib¿‹
();

4872 
	`»sume_ü—tšg_pg
();

4873 
boŞ
 
Ãed_£nd_b—cÚ
 = 
çl£
;

4874 cÚ¡‡utØ
now
 = 
ûph
::
cßr£_mÚo_şock
::
	`now
();

4877 
Mu‹x
::
Lock”
 
l
{
mš_Ï¡_•och_ş—n_lock
};

4878 cÚ¡‡utØ
–­£d
 = 
now
 - 
Ï¡_£Á_b—cÚ
;

4879 ià(
chrÚo
::
du¿tiÚ_ÿ¡
<chrÚo::
£cÚds
>(
–­£d
).
	`couÁ
() >

4880 
cù
->
_cÚf
->
osd_b—cÚ_»pÜt_š‹rv®
) {

4881 
Ãed_£nd_b—cÚ
 = 
Œue
;

4884 ià(
Ãed_£nd_b—cÚ
) {

4885 
	`£nd_b—cÚ
(
now
);

4889 
mgrc
.
	`upd©e_d«mÚ_h—Éh
(
	`g‘_h—Éh_m‘rics
());

4890 
£rviû
.
	`kick_»cov”y_queue
();

4891 
tick_tim”_w™hout_osd_lock
.
	`add_ev’t_aá”
(
OSD_TICK_INTERVAL
, 
Ãw
 
	`C_Tick_W™houtOSDLock
(
this
));

4892 
	}
}

4904 
	gTe¡OpsSock‘Hook
::
	$‹¡_İs
(
OSDS”viû
 *
£rviû
, 
ObjeùStÜe
 *
¡Üe
,

4905 
¡d
::
¡ršg_v›w
 
commªd
,

4906 cÚ¡ 
cmdm­_t
& 
cmdm­
, 
o¡»am
 &
ss
)

4911 ià(
commªd
 == "setomapval" || command == "rmomapkey" ||

4912 
commªd
 == "setomapheader" || command == "getomap" ||

4913 
commªd
 == "truncobj" || command == "injectmdataerr" ||

4914 
commªd
 == "injectdataerr"

4916 
pg_t
 
¿wpg
;

4917 
št64_t
 
poŞ
;

4918 
OSDM­Ref
 
curm­
 = 
£rviû
->
	`g‘_osdm­
();

4919 
r
 = -1;

4921 
¡ršg
 
poŞ¡r
;

4923 
	`cmd_g‘v®
(
£rviû
->
cù
, 
cmdm­
, "poŞ", 
poŞ¡r
);

4924 
poŞ
 = 
curm­
->
	`lookup_pg_poŞ_Çme
(
poŞ¡r
);

4926 ià(
poŞ
 < 0 && 
	`isdig™
(
poŞ¡r
[0]))

4927 
poŞ
 = 
	`©Şl
(
poŞ¡r
.
	`c_¡r
());

4928 ià(
poŞ
 < 0) {

4929 
ss
 << "Inv®id…oŞ '" << 
poŞ¡r
 << "''";

4933 
¡ršg
 
objÇme
, 
n¥aû
;

4934 
	`cmd_g‘v®
(
£rviû
->
cù
, 
cmdm­
, "objÇme", 
objÇme
);

4935 
¡d
::
size_t
 
found
 = 
objÇme
.
	`fšd_fœ¡_of
('/');

4936 ià(
found
 !ğ
¡ršg
::
Åos
) {

4937 
n¥aû
 = 
objÇme
.
	`sub¡r
(0, 
found
);

4938 
objÇme
 = objÇme.
	`sub¡r
(
found
+1);

4940 
objeù_loÿtÜ_t
 
	`Şoc
(
poŞ
, 
n¥aû
);

4941 
r
 = 
curm­
->
	`objeù_loÿtÜ_to_pg
(
	`objeù_t
(
objÇme
), 
Şoc
, 
¿wpg
);

4943 ià(
r
 < 0) {

4944 
ss
 << "Invalid‚amespace/objname";

4948 
št64_t
 
sh¬did
;

4949 
	`cmd_g‘v®
(
£rviû
->
cù
, 
cmdm­
, "sh¬did", 
sh¬did
, 
	`št64_t
(
sh¬d_id_t
::
NO_SHARD
));

4950 
hobjeù_t
 
	`obj
(
	`objeù_t
(
objÇme
), 
	`¡ršg
(""), 
CEPH_NOSNAP
, 
¿wpg
.
	`ps
(), 
poŞ
, 
n¥aû
);

4951 
ghobjeù_t
 
	`gobj
(
obj
, ghobjeù_t::
NO_GEN
, 
	`sh¬d_id_t
(
	`ušt8_t
(
sh¬did
)));

4952 
¥g_t
 
	`pgid
(
curm­
->
	`¿w_pg_to_pg
(
¿wpg
), 
	`sh¬d_id_t
(
sh¬did
));

4953 ià(
curm­
->
	`pg_is_ec
(
¿wpg
)) {

4954 ià((
commªd
 != "injectdataerr") && (command != "injectmdataerr")) {

4955 
ss
 << "Must‚ot call onƒc…ool,ƒxcept injectdataerr or injectmdataerr";

4960 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

4962 ià(
commªd
 == "setomapval") {

4963 
m­
<
¡ršg
, 
bufã¾i¡
> 
Ãw©Œs
;

4964 
bufã¾i¡
 
v®
;

4965 
¡ršg
 
key
, 
v®¡r
;

4966 
	`cmd_g‘v®
(
£rviû
->
cù
, 
cmdm­
, "key", 
key
);

4967 
	`cmd_g‘v®
(
£rviû
->
cù
, 
cmdm­
, "v®", 
v®¡r
);

4969 
v®
.
	`­³nd
(
v®¡r
);

4970 
Ãw©Œs
[
key
] = 
v®
;

4971 
t
.
	`om­_£tkeys
(
	`cŞl_t
(
pgid
), 
	`ghobjeù_t
(
obj
), 
Ãw©Œs
);

4972 
r
 = 
¡Üe
->
	`queue_Œª§ùiÚ
(
£rviû
->
m‘a_ch
, 
¡d
::
	`move
(
t
));

4973 ià(
r
 < 0)

4974 
ss
 << "”rÜ=" << 
r
;

4976 
ss
 << "ok";

4977 } ià(
commªd
 == "rmomapkey") {

4978 
¡ršg
 
key
;

4979 
£t
<
¡ršg
> 
keys
;

4980 
	`cmd_g‘v®
(
£rviû
->
cù
, 
cmdm­
, "key", 
key
);

4982 
keys
.
	`š£¹
(
key
);

4983 
t
.
	`om­_rmkeys
(
	`cŞl_t
(
pgid
), 
	`ghobjeù_t
(
obj
), 
keys
);

4984 
r
 = 
¡Üe
->
	`queue_Œª§ùiÚ
(
£rviû
->
m‘a_ch
, 
¡d
::
	`move
(
t
));

4985 ià(
r
 < 0)

4986 
ss
 << "”rÜ=" << 
r
;

4988 
ss
 << "ok";

4989 } ià(
commªd
 == "setomapheader") {

4990 
bufã¾i¡
 
Ãwh—d”
;

4991 
¡ršg
 
h—d”¡r
;

4993 
	`cmd_g‘v®
(
£rviû
->
cù
, 
cmdm­
, "h—d”", 
h—d”¡r
);

4994 
Ãwh—d”
.
	`­³nd
(
h—d”¡r
);

4995 
t
.
	`om­_£th—d”
(
	`cŞl_t
(
pgid
), 
	`ghobjeù_t
(
obj
), 
Ãwh—d”
);

4996 
r
 = 
¡Üe
->
	`queue_Œª§ùiÚ
(
£rviû
->
m‘a_ch
, 
¡d
::
	`move
(
t
));

4997 ià(
r
 < 0)

4998 
ss
 << "”rÜ=" << 
r
;

5000 
ss
 << "ok";

5001 } ià(
commªd
 == "getomap") {

5003 
bufã¾i¡
 
hdrbl
;

5004 
m­
<
¡ršg
, 
bufã¾i¡
> 
keyv®s
;

5005 autØ
ch
 = 
¡Üe
->
	`İ’_cŞËùiÚ
(
	`cŞl_t
(
pgid
));

5006 ià(!
ch
) {

5007 
ss
 << "uÇbËØİ’ cŞËùiÚ fÜ " << 
pgid
;

5008 
r
 = -
ENOENT
;

5010 
r
 = 
¡Üe
->
	`om­_g‘
(
ch
, 
	`ghobjeù_t
(
obj
), &
hdrbl
, &
keyv®s
);

5011 ià(
r
 >= 0) {

5012 
ss
 << "h—d”=" << 
	`¡ršg
(
hdrbl
.
	`c_¡r
(), hdrbl.
	`Ëngth
());

5013 
m­
<
¡ršg
, 
bufã¾i¡
>::
™”©Ü
 
™
 = 
keyv®s
.
	`begš
();

5014 
™
 !ğ
keyv®s
.
	`’d
(); ++it)

5015 
ss
 << " key=" << (*
™
).
fœ¡
 << " val="

5016 << 
	`¡ršg
((*
™
).
£cÚd
.
	`c_¡r
(), (*™).£cÚd.
	`Ëngth
());

5018 
ss
 << "”rÜ=" << 
r
;

5021 } ià(
commªd
 == "truncobj") {

5022 
št64_t
 
Œunş’
;

5023 
	`cmd_g‘v®
(
£rviû
->
cù
, 
cmdm­
, "Ën", 
Œunş’
);

5024 
t
.
	`Œunÿ‹
(
	`cŞl_t
(
pgid
), 
	`ghobjeù_t
(
obj
), 
Œunş’
);

5025 
r
 = 
¡Üe
->
	`queue_Œª§ùiÚ
(
£rviû
->
m‘a_ch
, 
¡d
::
	`move
(
t
));

5026 ià(
r
 < 0)

5027 
ss
 << "”rÜ=" << 
r
;

5029 
ss
 << "ok";

5030 } ià(
commªd
 == "injectdataerr") {

5031 
¡Üe
->
	`šjeù_d©a_”rÜ
(
gobj
);

5032 
ss
 << "ok";

5033 } ià(
commªd
 == "injectmdataerr") {

5034 
¡Üe
->
	`šjeù_md©a_”rÜ
(
gobj
);

5035 
ss
 << "ok";

5039 ià(
commªd
 == "set_recovery_delay") {

5040 
št64_t
 
d–ay
;

5041 
	`cmd_g‘v®
(
£rviû
->
cù
, 
cmdm­
, "utime", 
d–ay
, (
št64_t
)0);

5042 
o¡ršg¡»am
 
oss
;

5043 
oss
 << 
d–ay
;

5044 
r
 = 
£rviû
->
cù
->
_cÚf
->
	`£t_v®
("osd_recovery_delay_start",

5045 
oss
.
	`¡r
().
	`c_¡r
());

5046 ià(
r
 != 0) {

5047 
ss
 << "set_recovery_delay:ƒrror setting "

5048 << "osd_»cov”y_d–ay_¡¬ˆtØ'" << 
d–ay
 << "':ƒrror "

5049 << 
r
;

5052 
£rviû
->
cù
->
_cÚf
->
	`­¶y_chªges
(
NULL
);

5053 
ss
 << "set_recovery_delay: set osd_recovery_delay_start "

5054 << "tØ" << 
£rviû
->
cù
->
_cÚf
->
osd_»cov”y_d–ay_¡¬t
;

5057 ià(
commªd
 == "trigger_scrub") {

5058 
¥g_t
 
pgid
;

5059 
OSDM­Ref
 
curm­
 = 
£rviû
->
	`g‘_osdm­
();

5061 
¡ršg
 
pgid¡r
;

5063 
	`cmd_g‘v®
(
£rviû
->
cù
, 
cmdm­
, "pgid", 
pgid¡r
);

5064 ià(!
pgid
.
	`·r£
(
pgid¡r
.
	`c_¡r
())) {

5065 
ss
 << "Invalid…gid specified";

5069 
PGRef
 
pg
 = 
£rviû
->
osd
->
	`_lookup_lock_pg
(
pgid
);

5070 ià(
pg
 =ğ
nuÎ±r
) {

5071 
ss
 << "Cª'ˆfšd…g " << 
pgid
;

5075 ià(
pg
->
	`is_´im¬y
()) {

5076 
pg
->
	`uÄeg_Ãxt_süub
();

5077 cÚ¡ 
pg_poŞ_t
 *
p
 = 
curm­
->
	`g‘_pg_poŞ
(
pgid
.
	`poŞ
());

5078 
poŞ_süub_max_š‹rv®
 = 0;

5079 
p
->
İts
.
	`g‘
(
poŞ_İts_t
::
SCRUB_MAX_INTERVAL
, &
poŞ_süub_max_š‹rv®
);

5080 
süub_max_š‹rv®
 = 
poŞ_süub_max_š‹rv®
 > 0 ?

5081 
poŞ_süub_max_š‹rv®
 : 
g_cÚf
->
osd_süub_max_š‹rv®
;

5083 
utime_t
 
¡amp
 = 
	`ûph_şock_now
();

5084 
¡amp
 -ğ
süub_max_š‹rv®
;

5085 
¡amp
 -= 100.0;

5086 
pg
->
	`£t_Ï¡_süub_¡amp
(
¡amp
);

5087 
pg
->
	`»g_Ãxt_süub
();

5088 
ss
 << "ok";

5090 
ss
 << "Not…rimary";

5092 
pg
->
	`uÆock
();

5095 ià(
commªd
 == "injectfull") {

5096 
št64_t
 
couÁ
;

5097 
¡ršg
 
ty³
;

5098 
OSDS”viû
::
s_Çmes
 
¡©e
;

5099 
	`cmd_g‘v®
(
£rviû
->
cù
, 
cmdm­
, "ty³", 
ty³
, 
	`¡ršg
("full"));

5100 
	`cmd_g‘v®
(
£rviû
->
cù
, 
cmdm­
, "couÁ", 
couÁ
, (
št64_t
)-1);

5101 ià(
ty³
 =ğ"nÚe" || 
couÁ
 == 0) {

5102 
ty³
 = "none";

5103 
couÁ
 = 0;

5105 
¡©e
 = 
£rviû
->
	`g‘_fuÎ_¡©e
(
ty³
);

5106 ià(
¡©e
 =ğ
OSDS”viû
::
s_Çmes
::
INVALID
) {

5107 
ss
 << "Invalidype use (none,‚earfull, backfillfull, full, failsafe)";

5110 
£rviû
->
	`£t_šjeùfuÎ
(
¡©e
, 
couÁ
);

5113 
ss
 << "IÁ”ÇÈ”rÜ - commªd=" << 
commªd
;

5114 
	}
}

5118 
	gOSD
::
	$ms_hªdË_cÚÃù
(
CÚÃùiÚ
 *
cÚ
)

5120 
	`dout
(10è<< 
__func__
 << " cÚ " << 
cÚ
 << 
d’dl
;

5121 ià(
cÚ
->
	`g‘_³”_ty³
(è=ğ
CEPH_ENTITY_TYPE_MON
) {

5122 
Mu‹x
::
Lock”
 
	`l
(
osd_lock
);

5123 ià(
	`is_¡İpšg
())

5125 
	`dout
(10è<< 
__func__
 << " oÀmÚ" << 
d’dl
;

5127 ià(
	`is_´eboÙ
()) {

5128 
	`¡¬t_boÙ
();

5129 } ià(
	`is_boÙšg
()) {

5130 
	`_£nd_boÙ
();

5132 
m­_lock
.
	`g‘_»ad
();

5133 
Mu‹x
::
Lock”
 
	`l2
(
mÚ_»pÜt_lock
);

5135 
utime_t
 
now
 = 
	`ûph_şock_now
();

5136 
Ï¡_mÚ_»pÜt
 = 
now
;

5139 
	`£nd_fuÎ_upd©e
();

5140 
	`£nd_®ive
();

5141 
£rviû
.
	`»queue_pg_‹mp
();

5142 
£rviû
.
	`£nd_pg_‹mp
();

5143 
	`»queue_çu»s
();

5144 
	`£nd_çu»s
();

5146 
m­_lock
.
	`put_»ad
();

5147 ià(
	`is_aùive
()) {

5148 
	`£nd_b—cÚ
(
ûph
::
cßr£_mÚo_şock
::
	`now
());

5153 ià(
»que¡ed_fuÎ_fœ¡
) {

5154 
	`»»que¡_fuÎ_m­s
();

5157 
	}
}

5159 
	gOSD
::
	$ms_hªdË_ç¡_cÚÃù
(
CÚÃùiÚ
 *
cÚ
)

5161 ià(
cÚ
->
	`g‘_³”_ty³
(è!ğ
CEPH_ENTITY_TYPE_MON
 &&

5162 
cÚ
->
	`g‘_³”_ty³
(è!ğ
CEPH_ENTITY_TYPE_MGR
) {

5163 
SessiÚ
 *
s
 = 
¡©ic_ÿ¡
<SessiÚ*>(
cÚ
->
	`g‘_´iv
());

5164 ià(!
s
) {

5165 
s
 = 
Ãw
 
	`SessiÚ
(
cù
);

5166 
cÚ
->
	`£t_´iv
(
s
->
	`g‘
());

5167 
s
->
cÚ
 = con;

5168 
	`dout
(10è<< "‚ew sessiÚ (outgošgè" << 
s
 << " cÚ=" << s->
cÚ


5169 << "‡ddr=" << 
s
->
cÚ
->
	`g‘_³”_addr
(è<< 
d’dl
;

5171 
	`as£¹
(
cÚ
->
	`g‘_³”_ty³
(è=ğ
CEPH_ENTITY_TYPE_OSD
);

5172 
s
->
’t™y_Çme
.
	`£t_ty³
(
CEPH_ENTITY_TYPE_OSD
);

5174 
s
->
	`put
();

5176 
	}
}

5178 
	gOSD
::
	$ms_hªdË_ç¡_acû±
(
CÚÃùiÚ
 *
cÚ
)

5180 ià(
cÚ
->
	`g‘_³”_ty³
(è!ğ
CEPH_ENTITY_TYPE_MON
 &&

5181 
cÚ
->
	`g‘_³”_ty³
(è!ğ
CEPH_ENTITY_TYPE_MGR
) {

5182 
SessiÚ
 *
s
 = 
¡©ic_ÿ¡
<SessiÚ*>(
cÚ
->
	`g‘_´iv
());

5183 ià(!
s
) {

5184 
s
 = 
Ãw
 
	`SessiÚ
(
cù
);

5185 
cÚ
->
	`£t_´iv
(
s
->
	`g‘
());

5186 
s
->
cÚ
 = con;

5187 
	`dout
(10è<< "Ãw sessiÚ (šcomšg)" << 
s
 << " cÚ=" << 
cÚ


5188 << "‡ddr=" << 
cÚ
->
	`g‘_³”_addr
()

5189 << " mu¡ hav¿ûd w™h cÚÃù" << 
d’dl
;

5190 
	`as£¹
(
cÚ
->
	`g‘_³”_ty³
(è=ğ
CEPH_ENTITY_TYPE_OSD
);

5191 
s
->
’t™y_Çme
.
	`£t_ty³
(
CEPH_ENTITY_TYPE_OSD
);

5193 
s
->
	`put
();

5195 
	}
}

5197 
boŞ
 
	gOSD
::
	$ms_hªdË_»£t
(
CÚÃùiÚ
 *
cÚ
)

5199 
SessiÚ
 *
£ssiÚ
 = 
¡©ic_ÿ¡
<SessiÚ*>(
cÚ
->
	`g‘_´iv
());

5200 
	`dout
(2è<< "ms_hªdË_»£ˆcÚ " << 
cÚ
 << " sessiÚ " << 
£ssiÚ
 << 
d’dl
;

5201 ià(!
£ssiÚ
)

5202  
çl£
;

5203 
£ssiÚ
->
w¡©e
.
	`»£t
(
cÚ
);

5204 
£ssiÚ
->
cÚ
.
	`»£t
(
NULL
);

5208 
	`£ssiÚ_hªdË_»£t
(
£ssiÚ
);

5209 
£ssiÚ
->
	`put
();

5210  
Œue
;

5211 
	}
}

5213 
boŞ
 
	gOSD
::
	$ms_hªdË_»fu£d
(
CÚÃùiÚ
 *
cÚ
)

5215 ià(!
cù
->
_cÚf
->
osd_ç¡_ç_Ú_cÚÃùiÚ_»fu£d
)

5216  
çl£
;

5218 
SessiÚ
 *
£ssiÚ
 = 
¡©ic_ÿ¡
<SessiÚ*>(
cÚ
->
	`g‘_´iv
());

5219 
	`dout
(2è<< "ms_hªdË_»fu£d cÚ " << 
cÚ
 << " sessiÚ " << 
£ssiÚ
 << 
d’dl
;

5220 ià(!
£ssiÚ
)

5221  
çl£
;

5222 
ty³
 = 
cÚ
->
	`g‘_³”_ty³
();

5224 ià(
mÚc
 && (
ty³
 =ğ
CEPH_ENTITY_TYPE_OSD
)) {

5225 
OSDM­Ref
 
osdm­
 = 
	`g‘_osdm­
();

5226 ià(
osdm­
) {

5227 
id
 = 
osdm­
->
	`id’tify_osd_Ú_®l_chªÃls
(
cÚ
->
	`g‘_³”_addr
());

5228 ià(
id
 >ğ0 && 
osdm­
->
	`is_up
(id)) {

5231 
mÚc
->
	`£nd_mÚ_mes§ge
(
Ãw
 
	`MOSDFau»
(mÚc->
	`g‘_fsid
(),

5232 
osdm­
->
	`g‘_š¡
(
id
),

5233 
cù
->
_cÚf
->
osd_h—¹b—t_g¿û
 + 1,

5234 
osdm­
->
	`g‘_•och
(),

5235 
MOSDFau»
::
FLAG_IMMEDIATE
 | MOSDFau»::
FLAG_FAILED


5240 
£ssiÚ
->
	`put
();

5241  
Œue
;

5242 
	}
}

5244 
	gC_OSD_G‘V”siÚ
 : 
public
 
CÚ‹xt
 {

5245 
OSD
 *
osd
;

5246 
ušt64_t
 
	gŞde¡
, 
	gÃwe¡
;

5247 
ex¶ic™
 
C_OSD_G‘V”siÚ
(
OSD
 *
o
è: 
osd
(o), 
Şde¡
(0), 
Ãwe¡
(0) {}

5248 
fšish
(
r
è
	gov”ride
 {

5249 ià(
	gr
 >= 0)

5250 
osd
->
_gÙ_mÚ_•ochs
(
Şde¡
, 
Ãwe¡
);

5254 
	gOSD
::
	$¡¬t_boÙ
()

5256 ià(!
	`_is_h—Éhy
()) {

5258 
	`dout
(1è<< "nÙ h—Éhy; wa™šgØboÙ" << 
d’dl
;

5259 ià(!
	`is_wa™šg_fÜ_h—Éhy
())

5260 
	`¡¬t_wa™šg_fÜ_h—Éhy
();

5262 
	`h—¹b—t_kick
();

5265 
	`dout
(1è<< 
__func__
 << 
d’dl
;

5266 
	`£t_¡©e
(
STATE_PREBOOT
);

5267 
	`dout
(10è<< "¡¬t_boÙ - havm­ " << 
su³rblock
.
Şde¡_m­


5268 << ".." << 
su³rblock
.
Ãwe¡_m­
 << 
d’dl
;

5269 
C_OSD_G‘V”siÚ
 *
c
 = 
Ãw
 
	`C_OSD_G‘V”siÚ
(
this
);

5270 
mÚc
->
	`g‘_v”siÚ
("osdm­", &
c
->
Ãwe¡
, &c->
Şde¡
, c);

5271 
	}
}

5273 
	gOSD
::
	$_gÙ_mÚ_•ochs
(
•och_t
 
Şde¡
,ƒpoch_ˆ
Ãwe¡
)

5275 
Mu‹x
::
Lock”
 
	`l
(
osd_lock
);

5276 ià(
	`is_´eboÙ
()) {

5277 
	`_´eboÙ
(
Şde¡
, 
Ãwe¡
);

5279 
	}
}

5281 
	gOSD
::
	$_´eboÙ
(
•och_t
 
Şde¡
,ƒpoch_ˆ
Ãwe¡
)

5283 
	`as£¹
(
	`is_´eboÙ
());

5284 
	`dout
(10è<< 
__func__
 << " _preboot mon has osdmaps "

5285 << 
Şde¡
 << ".." << 
Ãwe¡
 << 
d’dl
;

5288 
	`h—¹b—t
();

5291 ià(
osdm­
->
	`g‘_•och
() == 0) {

5292 
d”r
 << "wa™šg fÜ in™ŸÈosdm­" << 
d’dl
;

5293 } ià(
osdm­
->
	`is_de¡royed
(
whßmi
)) {

5294 
d”r
 << "osdm­ say I‡m de¡royed" << 
d’dl
;

5297 ià(
osdm­
->
	`g‘_•och
(è> 
Ãwe¡
 - 1) {

5298 
	`ex™
(0);

5300 } ià(
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_NOUP
è|| osdm­->
	`is_noup
(
whßmi
)) {

5301 
d”r
 << "osdm­ NOUP fÏg i £t, wa™šg fÜ iˆtØş—r" << 
d’dl
;

5302 } ià(!
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_SORTBITWISE
)) {

5303 
d”r
 << "osdmap SORTBITWISE OSDMap flag is NOT set;…lease set it"

5304 << 
d’dl
;

5305 } ià(
osdm­
->
»quœe_osd_»Ëa£
 < 
CEPH_RELEASE_LUMINOUS
) {

5306 
d”r
 << "osdmap„equire_osd_release <†uminous;…lease upgradeo†uminous"

5307 << 
d’dl
;

5308 } ià(
£rviû
.
	`Ãed_fuÎÃss_upd©e
()) {

5309 
d”r
 << "osdm­ fuÎÃs ¡©Ãed upd©e" << 
d’dl
;

5310 
	`£nd_fuÎ_upd©e
();

5311 } ià(
osdm­
->
	`g‘_•och
(è>ğ
Şde¡
 - 1 &&

5312 
osdm­
->
	`g‘_•och
(è+ 
cù
->
_cÚf
->
osd_m­_mes§ge_max
 > 
Ãwe¡
) {

5313 
	`_£nd_boÙ
();

5318 ià(
osdm­
->
	`g‘_•och
(è+ 1 >ğ
Şde¡
)

5319 
	`osdm­_subsüibe
(
osdm­
->
	`g‘_•och
(è+ 1, 
çl£
);

5321 
	`osdm­_subsüibe
(
Şde¡
 - 1, 
Œue
);

5322 
	}
}

5324 
	gOSD
::
	$£nd_fuÎ_upd©e
()

5326 ià(!
£rviû
.
	`Ãed_fuÎÃss_upd©e
())

5328 
¡©e
 = 0;

5329 ià(
£rviû
.
	`is_fuÎ
()) {

5330 
¡©e
 = 
CEPH_OSD_FULL
;

5331 } ià(
£rviû
.
	`is_backflfuÎ
()) {

5332 
¡©e
 = 
CEPH_OSD_BACKFILLFULL
;

5333 } ià(
£rviû
.
	`is_Ã¬fuÎ
()) {

5334 
¡©e
 = 
CEPH_OSD_NEARFULL
;

5336 
£t
<
¡ršg
> 
s
;

5337 
OSDM­
::
	`ÿlc_¡©e_£t
(
¡©e
, 
s
);

5338 
	`dout
(10è<< 
__func__
 << " wªˆ¡©" << 
s
 << 
d’dl
;

5339 
mÚc
->
	`£nd_mÚ_mes§ge
(
Ãw
 
	`MOSDFuÎ
(
osdm­
->
	`g‘_•och
(), 
¡©e
));

5340 
	}
}

5342 
	gOSD
::
	$¡¬t_wa™šg_fÜ_h—Éhy
()

5344 
	`dout
(1è<< "¡¬t_wa™šg_fÜ_h—Éhy" << 
d’dl
;

5345 
	`£t_¡©e
(
STATE_WAITING_FOR_HEALTHY
);

5346 
Ï¡_h—¹b—t_»§m¶e
 = 
	`utime_t
();

5349 
	`osdm­_subsüibe
(
osdm­
->
	`g‘_•och
(è+ 1, 
çl£
);

5350 
	}
}

5352 
boŞ
 
	gOSD
::
	$_is_h—Éhy
()

5354 ià(!
cù
->
	`g‘_h—¹b—t_m­
()->
	`is_h—Éhy
()) {

5355 
	`dout
(1è<< "is_h—Éhy f®£ -- iÁ”ÇÈh—¹b—ˆçed" << 
d’dl
;

5356  
çl£
;

5359 ià(
	`is_wa™šg_fÜ_h—Éhy
()) {

5360 
Mu‹x
::
Lock”
 
	`l
(
h—¹b—t_lock
);

5361 
utime_t
 
cutoff
 = 
	`ûph_şock_now
();

5362 
cutoff
 -ğ
cù
->
_cÚf
->
osd_h—¹b—t_g¿û
;

5363 
num
 = 0, 
up
 = 0;

5364 
m­
<,
H—¹b—tInfo
>::
™”©Ü
 
p
 = 
h—¹b—t_³”s
.
	`begš
();

5365 
p
 !ğ
h—¹b—t_³”s
.
	`’d
();

5366 ++
p
) {

5367 ià(
p
->
£cÚd
.
	`is_h—Éhy
(
cutoff
))

5368 ++
up
;

5369 ++
num
;

5371 ià(()
up
 < ()
num
 * 
cù
->
_cÚf
->
osd_h—¹b—t_mš_h—Éhy_¿tio
) {

5372 
	`dout
(1è<< "is_h—Éhy f®£ -- oÆy " << 
up
 << "/" << 
num
 << " up…eers (lesshan "

5373 << (
cù
->
_cÚf
->
osd_h—¹b—t_mš_h—Éhy_¿tio
 * 100.0è<< "%)" << 
d’dl
;

5374  
çl£
;

5378  
Œue
;

5379 
	}
}

5381 
	gOSD
::
	$_£nd_boÙ
()

5383 
	`dout
(10è<< "_£nd_boÙ" << 
d’dl
;

5384 
’t™y_addr_t
 
şu¡”_addr
 = 
şu¡”_mes£ng”
->
	`g‘_myaddr
();

5385 
CÚÃùiÚ
 *
loÿl_cÚÃùiÚ
 = 
şu¡”_mes£ng”
->
	`g‘_loİback_cÚÃùiÚ
().
	`g‘
();

5386 ià(
şu¡”_addr
.
	`is_bÏnk_
()) {

5387 
pÜt
 = 
şu¡”_addr
.
	`g‘_pÜt
();

5388 
şu¡”_addr
 = 
ş›Á_mes£ng”
->
	`g‘_myaddr
();

5389 
şu¡”_addr
.
	`£t_pÜt
(
pÜt
);

5390 
şu¡”_mes£ng”
->
	`£t_addr_unknowns
(
şu¡”_addr
);

5391 
	`dout
(10è<< "‡ssumšg clu¡”_add¸ m©che ş›Á_addr" << 
d’dl
;

5393 
SessiÚ
 *
s
 = 
¡©ic_ÿ¡
<SessiÚ*>(
loÿl_cÚÃùiÚ
->
	`g‘_´iv
());

5394 ià(
s
)

5395 
s
->
	`put
();

5397 
şu¡”_mes£ng”
->
	`ms_d–iv”_hªdË_ç¡_cÚÃù
(
loÿl_cÚÃùiÚ
);

5400 
’t™y_addr_t
 
hb_back_addr
 = 
hb_back_£rv”_mes£ng”
->
	`g‘_myaddr
();

5401 
loÿl_cÚÃùiÚ
 = 
hb_back_£rv”_mes£ng”
->
	`g‘_loİback_cÚÃùiÚ
().
	`g‘
();

5402 ià(
hb_back_addr
.
	`is_bÏnk_
()) {

5403 
pÜt
 = 
hb_back_addr
.
	`g‘_pÜt
();

5404 
hb_back_addr
 = 
şu¡”_addr
;

5405 
hb_back_addr
.
	`£t_pÜt
(
pÜt
);

5406 
hb_back_£rv”_mes£ng”
->
	`£t_addr_unknowns
(
hb_back_addr
);

5407 
	`dout
(10è<< "‡ssumšg hb_back_add¸ m©che şu¡”_addr" << 
d’dl
;

5409 
SessiÚ
 *
s
 = 
¡©ic_ÿ¡
<SessiÚ*>(
loÿl_cÚÃùiÚ
->
	`g‘_´iv
());

5410 ià(
s
)

5411 
s
->
	`put
();

5413 
hb_back_£rv”_mes£ng”
->
	`ms_d–iv”_hªdË_ç¡_cÚÃù
(
loÿl_cÚÃùiÚ
);

5416 
’t™y_addr_t
 
hb_äÚt_addr
 = 
hb_äÚt_£rv”_mes£ng”
->
	`g‘_myaddr
();

5417 
loÿl_cÚÃùiÚ
 = 
hb_äÚt_£rv”_mes£ng”
->
	`g‘_loİback_cÚÃùiÚ
().
	`g‘
();

5418 ià(
hb_äÚt_addr
.
	`is_bÏnk_
()) {

5419 
pÜt
 = 
hb_äÚt_addr
.
	`g‘_pÜt
();

5420 
hb_äÚt_addr
 = 
ş›Á_mes£ng”
->
	`g‘_myaddr
();

5421 
hb_äÚt_addr
.
	`£t_pÜt
(
pÜt
);

5422 
hb_äÚt_£rv”_mes£ng”
->
	`£t_addr_unknowns
(
hb_äÚt_addr
);

5423 
	`dout
(10è<< "‡ssumšg hb_äÚt_add¸ m©che ş›Á_addr" << 
d’dl
;

5425 
SessiÚ
 *
s
 = 
¡©ic_ÿ¡
<SessiÚ*>(
loÿl_cÚÃùiÚ
->
	`g‘_´iv
());

5426 ià(
s
)

5427 
s
->
	`put
();

5429 
hb_äÚt_£rv”_mes£ng”
->
	`ms_d–iv”_hªdË_ç¡_cÚÃù
(
loÿl_cÚÃùiÚ
);

5432 
MOSDBoÙ
 *
mboÙ
 = 
Ãw
 
	`MOSDBoÙ
(
su³rblock
, 
	`g‘_osdm­_•och
(), 
£rviû
.
	`g‘_boÙ_•och
(),

5433 
hb_back_addr
, 
hb_äÚt_addr
, 
şu¡”_addr
,

5434 
CEPH_FEATURES_ALL
);

5435 
	`dout
(10è<< " cl›Á_add¸" << 
ş›Á_mes£ng”
->
	`g‘_myaddr
()

5436 << ", clu¡”_add¸" << 
şu¡”_addr


5437 << ", hb_back_add¸" << 
hb_back_addr


5438 << ", hb_äÚt_add¸" << 
hb_äÚt_addr


5439 << 
d’dl
;

5440 
	`_cŞËù_m‘ad©a
(&
mboÙ
->
m‘ad©a
);

5441 
mÚc
->
	`£nd_mÚ_mes§ge
(
mboÙ
);

5442 
	`£t_¡©e
(
STATE_BOOTING
);

5443 
	}
}

5445 
	g¡d
::
¡ršg
 
OSD
::
	$_cŞËù_com´essiÚ_®gÜ™hms
()

5447 
usšg
 
¡d
::
ex³rim’l
::
make_o¡»am_još”
;

5449 cÚ¡‡uto& 
com´essiÚ_®gÜ™hms
 = 
Com´essÜ
::compression_algorithms;

5450 cÚ¡‡uto& 
¶ugš_»gi¡ry
 = 
cù
->
	`g‘_¶ugš_»gi¡ry
()->
¶ugšs
;

5452 ià(
¶ugš_»gi¡ry
.
	`em±y
())

5455 
o¡ršg¡»am
 
os
;

5457 
	`cİy_if
(
	`begš
(
com´essiÚ_®gÜ™hms
), 
	`’d
(compression_algorithms),

5458 
	`make_o¡»am_još”
(
os
, ", "),

5459 [&
¶ugš_»gi¡ry
](cÚ¡‡uto& 
®gÜ™hm
) {

5460  
¶ugš_»gi¡ry
.
	`’d
(è!ğ¶ugš_»gi¡ry.
	`fšd
(
®gÜ™hm
.
fœ¡
);

5463  
os
.
	`¡r
();

5464 
	}
}

5466 
	gOSD
::
_cŞËù_m‘ad©a
(
m­
<
¡ršg
,¡ršg> *
pm
)

5469 (*
	gpm
)["osd_d©a"] = 
dev_·th
;

5470 ià(
	g¡Üe
->
g‘_ty³
() == "filestore") {

5472 (*
pm
)["osd_jouº®"] = 
jouº®_·th
;

5474 (*
	gpm
)["äÚt_addr"] = 
¡ršgify
(
ş›Á_mes£ng”
->
g‘_myaddr
());

5475 (*
	gpm
)["back_addr"] = 
¡ršgify
(
şu¡”_mes£ng”
->
g‘_myaddr
());

5476 (*
	gpm
)["hb_äÚt_addr"] = 
¡ršgify
(
hb_äÚt_£rv”_mes£ng”
->
g‘_myaddr
());

5477 (*
	gpm
)["hb_back_addr"] = 
¡ršgify
(
hb_back_£rv”_mes£ng”
->
g‘_myaddr
());

5480 (*
	gpm
)["osd_objeù¡Üe"] = 
¡Üe
->
g‘_ty³
();

5481 (*
	gpm
)["rÙ©iÚ®"] = 
¡Üe_is_rÙ©iÚ®
 ? "1" : "0";

5482 (*
	gpm
)["jouº®_rÙ©iÚ®"] = 
jouº®_is_rÙ©iÚ®
 ? "1" : "0";

5483 (*
	gpm
)["deçuÉ_deviû_şass"] = 
¡Üe
->
g‘_deçuÉ_deviû_şass
();

5484 
	g¡Üe
->
cŞËù_m‘ad©a
(
pm
);

5486 
cŞËù_sys_šfo
(
pm
, 
cù
);

5488 (*
	gpm
)["äÚt_içû"] = 
pick_içû
(
cù
,

5489 
ş›Á_mes£ng”
->
g‘_myaddr
().
g‘_sockaddr_¡Üage
());

5490 (*
	gpm
)["back_içû"] = 
pick_içû
(
cù
,

5491 
şu¡”_mes£ng”
->
g‘_myaddr
().
g‘_sockaddr_¡Üage
());

5493 
	g£t
<
	g¡ršg
> 
	gdevÇmes
;

5494 
	g¡Üe
->
g‘_deviûs
(&
devÇmes
);

5495 (*
	gpm
)["deviûs"] = 
¡ršgify
(
devÇmes
);

5498 (*
	gpm
)["suµÜ‹d_com´essiÚ_®gÜ™hms"] = 
_cŞËù_com´essiÚ_®gÜ™hms
();

5500 
dout
(10è<< 
	g__func__
 << " " << *
	gpm
 << 
	gd’dl
;

5503 
	gOSD
::
	$queue_wªt_up_thru
(
•och_t
 
wªt
)

5505 
m­_lock
.
	`g‘_»ad
();

5506 
•och_t
 
cur
 = 
osdm­
->
	`g‘_up_thru
(
whßmi
);

5507 
Mu‹x
::
Lock”
 
	`l
(
mÚ_»pÜt_lock
);

5508 ià(
wªt
 > 
up_thru_wª‹d
) {

5509 
	`dout
(10è<< "queue_wªt_up_thru‚ow " << 
wªt
 << " (wa " << 
up_thru_wª‹d
 << ")"

5510 << ", cu¼’y " << 
cur


5511 << 
d’dl
;

5512 
up_thru_wª‹d
 = 
wªt
;

5513 
	`£nd_®ive
();

5515 
	`dout
(10è<< "queue_wªt_up_thru wªˆ" << 
wªt
 << " <ğqueued " << 
up_thru_wª‹d


5516 << ", cu¼’y " << 
cur


5517 << 
d’dl
;

5519 
m­_lock
.
	`put_»ad
();

5520 
	}
}

5522 
	gOSD
::
	$£nd_®ive
()

5524 
	`as£¹
(
mÚ_»pÜt_lock
.
	`is_locked
());

5525 ià(!
osdm­
->
	`exi¡s
(
whßmi
))

5527 
•och_t
 
up_thru
 = 
osdm­
->
	`g‘_up_thru
(
whßmi
);

5528 
	`dout
(10è<< "£nd_®ivup_thru cu¼’y " << 
up_thru
 << " wªˆ" << 
up_thru_wª‹d
 << 
d’dl
;

5529 ià(
up_thru_wª‹d
 > 
up_thru
) {

5530 
	`dout
(10è<< "£nd_®ivwªˆ" << 
up_thru_wª‹d
 << 
d’dl
;

5531 
mÚc
->
	`£nd_mÚ_mes§ge
(
Ãw
 
	`MOSDAlive
(
osdm­
->
	`g‘_•och
(), 
up_thru_wª‹d
));

5533 
	}
}

5535 
	gOSD
::
	$»que¡_fuÎ_m­
(
•och_t
 
fœ¡
,ƒpoch_ˆ
Ï¡
)

5537 
	`dout
(10è<< 
__func__
 << " " << 
fœ¡
 << ".." << 
Ï¡


5539 << 
»que¡ed_fuÎ_fœ¡
 << ".." << 
»que¡ed_fuÎ_Ï¡
 << 
d’dl
;

5540 
	`as£¹
(
osd_lock
.
	`is_locked
());

5541 
	`as£¹
(
fœ¡
 > 0 && 
Ï¡
 > 0);

5542 
	`as£¹
(
fœ¡
 <ğ
Ï¡
);

5543 
	`as£¹
(
fœ¡
 >ğ
»que¡ed_fuÎ_fœ¡
);

5544 ià(
»que¡ed_fuÎ_fœ¡
 == 0) {

5546 
»que¡ed_fuÎ_fœ¡
 = 
fœ¡
;

5547 
»que¡ed_fuÎ_Ï¡
 = 
Ï¡
;

5548 } ià(
Ï¡
 <ğ
»que¡ed_fuÎ_Ï¡
) {

5553 
fœ¡
 = 
»que¡ed_fuÎ_Ï¡
 + 1;

5554 
»que¡ed_fuÎ_Ï¡
 = 
Ï¡
;

5556 
MMÚG‘OSDM­
 *
»q
 = 
Ãw
 MMonGetOSDMap;

5557 
»q
->
	`»que¡_fuÎ
(
fœ¡
, 
Ï¡
);

5558 
mÚc
->
	`£nd_mÚ_mes§ge
(
»q
);

5559 
	}
}

5561 
	gOSD
::
	$gÙ_fuÎ_m­
(
•och_t
 
e
)

5563 
	`as£¹
(
»que¡ed_fuÎ_fœ¡
 <ğ
»que¡ed_fuÎ_Ï¡
);

5564 
	`as£¹
(
osd_lock
.
	`is_locked
());

5565 ià(
»que¡ed_fuÎ_fœ¡
 == 0) {

5566 
	`dout
(20è<< 
__func__
 << " " << 
e
 << ",‚Ùhšg„eque¡ed" << 
d’dl
;

5569 ià(
e
 < 
»que¡ed_fuÎ_fœ¡
) {

5570 
	`dout
(10è<< 
__func__
 << " " << 
e
 << ",„eque¡ed " << 
»que¡ed_fuÎ_fœ¡


5571 << ".." << 
»que¡ed_fuÎ_Ï¡


5572 << ", ignÜšg" << 
d’dl
;

5575 ià(
e
 >ğ
»que¡ed_fuÎ_Ï¡
) {

5576 
	`dout
(10è<< 
__func__
 << " " << 
e
 << ",„eque¡ed " << 
»que¡ed_fuÎ_fœ¡


5577 << ".." << 
»que¡ed_fuÎ_Ï¡
 << ",„e£‰šg" << 
d’dl
;

5578 
»que¡ed_fuÎ_fœ¡
 = 
»que¡ed_fuÎ_Ï¡
 = 0;

5582 
»que¡ed_fuÎ_fœ¡
 = 
e
 + 1;

5584 
	`dout
(10è<< 
__func__
 << " " << 
e
 << ",„eque¡ed " << 
»que¡ed_fuÎ_fœ¡


5585 << ".." << 
»que¡ed_fuÎ_Ï¡


5586 << ", stÈÃed mÜe" << 
d’dl
;

5587 
	}
}

5589 
	gOSD
::
	$»queue_çu»s
()

5591 
Mu‹x
::
Lock”
 
	`l
(
h—¹b—t_lock
);

5592 
Şd_queue
 = 
çu»_queue
.
	`size
();

5593 
Şd_³ndšg
 = 
çu»_³ndšg
.
	`size
();

5594 
m­
<,
·œ
<
utime_t
,
’t™y_š¡_t
> >::
™”©Ü
 
p
 =

5595 
çu»_³ndšg
.
	`begš
();

5596 
p
 !ğ
çu»_³ndšg
.
	`’d
(); ) {

5597 
çu»_queue
[
p
->
fœ¡
] =…->
£cÚd
.first;

5598 
çu»_³ndšg
.
	`”a£
(
p
++);

5600 
	`dout
(10è<< 
__func__
 << " " << 
Şd_queue
 << " + " << 
Şd_³ndšg
 << " -> "

5601 << 
çu»_queue
.
	`size
(è<< 
d’dl
;

5602 
	}
}

5604 
	gOSD
::
	$£nd_çu»s
()

5606 
	`as£¹
(
m­_lock
.
	`is_locked
());

5607 
	`as£¹
(
mÚ_»pÜt_lock
.
	`is_locked
());

5608 
Mu‹x
::
Lock”
 
	`l
(
h—¹b—t_lock
);

5609 
utime_t
 
now
 = 
	`ûph_şock_now
();

5610 !
çu»_queue
.
	`em±y
()) {

5611 
osd
 = 
çu»_queue
.
	`begš
()->
fœ¡
;

5612 ià(!
çu»_³ndšg
.
	`couÁ
(
osd
)) {

5613 
’t™y_š¡_t
 
i
 = 
osdm­
->
	`g‘_š¡
(
osd
);

5614 
çed_fÜ
 = ()()(
now
 - 
çu»_queue
.
	`begš
()->
£cÚd
);

5615 
mÚc
->
	`£nd_mÚ_mes§ge
(
Ãw
 
	`MOSDFau»
(mÚc->
	`g‘_fsid
(), 
i
, 
çed_fÜ
,

5616 
osdm­
->
	`g‘_•och
()));

5617 
çu»_³ndšg
[
osd
] = 
	`make_·œ
(
çu»_queue
.
	`begš
()->
£cÚd
, 
i
);

5619 
çu»_queue
.
	`”a£
(
osd
);

5621 
	}
}

5623 
	gOSD
::
	$£nd_¡l_®ive
(
•och_t
 
•och
, cÚ¡ 
’t™y_š¡_t
 &
i
)

5625 
MOSDFau»
 *
m
 = 
Ãw
 
	`MOSDFau»
(
mÚc
->
	`g‘_fsid
(), 
i
, 0, 
•och
, MOSDFau»::
FLAG_ALIVE
);

5626 
mÚc
->
	`£nd_mÚ_mes§ge
(
m
);

5627 
	}
}

5629 
	gOSD
::
	$£nd_b—cÚ
(cÚ¡ 
ûph
::
cßr£_mÚo_şock
::
time_pošt
& 
now
)

5631 cÚ¡‡uto& 
mÚm­
 = 
mÚc
->monmap;

5634 ià(
mÚm­
.
•och
 > 0 &&

5635 
mÚm­
.
	`g‘_»quœed_ã©u»s
().
	`cÚšs_®l
(

5636 
ûph
::
ã©u»s
::
mÚ
::
FEATURE_LUMINOUS
)) {

5637 
	`dout
(20è<< 
__func__
 << " s’dšg" << 
d’dl
;

5638 
MOSDB—cÚ
* 
b—cÚ
 = 
nuÎ±r
;

5640 
Mu‹x
::
Lock”
 
l
{
mš_Ï¡_•och_ş—n_lock
};

5641 
b—cÚ
 = 
Ãw
 
	`MOSDB—cÚ
(
osdm­
->
	`g‘_•och
(), 
mš_Ï¡_•och_ş—n
);

5642 
¡d
::
	`sw­
(
b—cÚ
->
pgs
, 
mš_Ï¡_•och_ş—n_pgs
);

5643 
Ï¡_£Á_b—cÚ
 = 
now
;

5645 
mÚc
->
	`£nd_mÚ_mes§ge
(
b—cÚ
);

5647 
	`dout
(20è<< 
__func__
 << "‚Ù s’dšg" << 
d’dl
;

5649 
	}
}

5651 
	gOSD
::
	$hªdË_commªd
(
MMÚCommªd
 *
m
)

5653 ià(!
	`»quœe_mÚ_³”
(
m
)) {

5654 
m
->
	`put
();

5658 
Commªd
 *
c
 = 
Ãw
 
	`Commªd
(
m
->
cmd
, m->
	`g‘_tid
(), m->
	`g‘_d©a
(), 
NULL
);

5659 
commªd_wq
.
	`queue
(
c
);

5660 
m
->
	`put
();

5661 
	}
}

5663 
	gOSD
::
	$hªdË_commªd
(
MCommªd
 *
m
)

5665 
CÚÃùiÚRef
 
cÚ
 = 
m
->
	`g‘_cÚÃùiÚ
();

5666 
SessiÚ
 *
£ssiÚ
 = 
¡©ic_ÿ¡
<SessiÚ *>(
cÚ
->
	`g‘_´iv
());

5667 ià(!
£ssiÚ
) {

5668 
cÚ
->
	`£nd_mes§ge
(
Ãw
 
	`MCommªdR•ly
(
m
, -
EPERM
));

5669 
m
->
	`put
();

5673 
OSDC­
& 
ÿps
 = 
£ssiÚ
->caps;

5674 
£ssiÚ
->
	`put
();

5676 ià(!
ÿps
.
	`®low_®l
(è|| 
m
->
	`g‘_sourû
().
	`is_mÚ
()) {

5677 
cÚ
->
	`£nd_mes§ge
(
Ãw
 
	`MCommªdR•ly
(
m
, -
EPERM
));

5678 
m
->
	`put
();

5682 
Commªd
 *
c
 = 
Ãw
 
	`Commªd
(
m
->
cmd
, m->
	`g‘_tid
(), m->
	`g‘_d©a
(), 
cÚ
.
	`g‘
());

5683 
commªd_wq
.
	`queue
(
c
);

5685 
m
->
	`put
();

5686 
	}
}

5688 
	sOSDCommªd
 {

5689 
¡ršg
 
	mcmd¡ršg
;

5690 
¡ršg
 
	mh–p¡ršg
;

5691 
¡ršg
 
	mmoduË
;

5692 
¡ršg
 
	m³rm
;

5693 
¡ršg
 
	mavaab™y
;

5694 } 
	gosd_commªds
[] = {

5696 
	#COMMAND
(
·r£sig
, 
h–±ext
, 
moduË
, 
³rm
, 
avaab™y
) \

5697 {
·r£sig
, 
h–±ext
, 
moduË
, 
³rm
, 
avaab™y
},

	)

5704 
COMMAND
("pg " \

5708 
COMMAND
("pg " \

5714 
COMMAND
("pg " \

5723 
COMMAND
("query",

5725 
COMMAND
("mark_unfound_lost " \

5729 
COMMAND
("list_missing " \

5733 
COMMAND
("perf histogram dump "

5740 
COMMAND
("version", "report version of OSD", "osd", "r", "cli,rest")

5741 
COMMAND
("get_command_descriptions", "list commands descriptions", "osd", "r", "cli,rest")

5742 
COMMAND
("injectargs " \

5746 
COMMAND
("config set " \

5750 
COMMAND
("config get " \

5754 
COMMAND
("config unset " \

5758 
COMMAND
("cluster_log " \

5763 
COMMAND
("bench " \

5771 
COMMAND
("flush_pg_stats", "flush…g stats", "osd", "rw", "cli,rest")

5772 
COMMAND
("heap " \

5776 
COMMAND
("debug dump_missing " \

5779 
COMMAND
("debug kick_recovery_wq " \

5782 
COMMAND
("cpu_profiler " \

5785 
COMMAND
("dump_pg_recovery_stats", "dump…g„ecovery statistics",

5787 
COMMAND
("reset_pg_recovery_stats", "reset…g„ecovery statistics",

5789 
COMMAND
("compact",

5793 
COMMAND
("smart",

5798 
	gOSD
::
do_commªd
(
CÚÃùiÚ
 *
cÚ
, 
ûph_tid_t
 
tid
, 
veùÜ
<
¡ršg
>& 
cmd
, 
bufã¾i¡
& 
d©a
)

5800 
	gr
 = 0;

5801 
¡ršg¡»am
 
	gss
, 
	gds
;

5802 
¡ršg
 
	grs
;

5803 
bufã¾i¡
 
	god©a
;

5805 
dout
(20è<< "do_commªdid " << 
	gtid
 << " " << 
	gcmd
 << 
	gd’dl
;

5807 
cmdm­_t
 
	gcmdm­
;

5808 
¡ršg
 
	g´efix
;

5809 
¡ršg
 
	gfÜm©
;

5810 
¡ršg
 
	gpgid¡r
;

5811 
	gboo¡
::
scİed_±r
<
FÜm©‹r
> 
f
;

5813 ià(
	gcmd
.
em±y
()) {

5814 
	gss
 << "no command given";

5815 
	gout
;

5818 ià(!
cmdm­_äom_jsÚ
(
cmd
, &
cmdm­
, 
ss
)) {

5819 
	gr
 = -
EINVAL
;

5820 
	gout
;

5823 
cmd_g‘v®
(
cù
, 
cmdm­
, "´efix", 
´efix
);

5825 ià(
	g´efix
 == "get_command_descriptions") {

5826 
cmdnum
 = 0;

5827 
JSONFÜm©‹r
 *
	gf
 = 
Ãw
 JSONFormatter();

5828 
	gf
->
İ’_objeù_£ùiÚ
("command_descriptions");

5829 
OSDCommªd
 *
	gı
 = 
osd_commªds
;

5830 
	gı
 < &
	gosd_commªds
[
ARRAY_SIZE
(
osd_commªds
)]; cp++) {

5832 
o¡ršg¡»am
 
	g£úame
;

5833 
	g£úame
 << "cmd" << 
£tfl
('0'è<< 
	g¡d
::
£tw
(3è<< 
cmdnum
;

5834 
dump_cmddesc_to_jsÚ
(
f
, 
£úame
.
¡r
(), 
ı
->
cmd¡ršg
, cp->
h–p¡ršg
,

5835 
ı
->
moduË
, cp->
³rm
, cp->
avaab™y
, 0);

5836 
	gcmdnum
++;

5838 
	gf
->
şo£_£ùiÚ
();

5840 
	gf
->
æush
(
ds
);

5841 
d–‘e
 
	gf
;

5842 
	gout
;

5845 
cmd_g‘v®
(
cù
, 
cmdm­
, "fÜm©", 
fÜm©
);

5846 
	gf
.
»£t
(
FÜm©‹r
::
ü—‹
(
fÜm©
));

5848 ià(
	g´efix
 == "version") {

5849 ià(
f
) {

5850 
f
->
İ’_objeù_£ùiÚ
("version");

5851 
	gf
->
dump_¡ršg
("v”siÚ", 
´‘ty_v”siÚ_to_¡r
());

5852 
	gf
->
şo£_£ùiÚ
();

5853 
	gf
->
æush
(
ds
);

5855 
	gds
 << 
´‘ty_v”siÚ_to_¡r
();

5857 
	gout
;

5859 ià(
	g´efix
 == "injectargs") {

5860 
veùÜ
<
¡ršg
> 
¬gsvec
;

5861 
cmd_g‘v®
(
cù
, 
cmdm­
, "šjeùed_¬gs", 
¬gsvec
);

5863 ià(
	g¬gsvec
.
em±y
()) {

5864 
	gr
 = -
EINVAL
;

5865 
	gss
 << "ignoringƒmpty injectargs";

5866 
	gout
;

5868 
¡ršg
 
	g¬gs
 = 
¬gsvec
.
äÚt
();

5869 
	gveùÜ
<
	g¡ršg
>::
™”©Ü
 
a
 = ++
¬gsvec
.
begš
(); 
	ga
 !ğ¬gsvec.
’d
(); ++a)

5870 
	g¬gs
 +ğ" " + *
a
;

5871 
	gosd_lock
.
UÆock
();

5872 
	gr
 = 
cù
->
_cÚf
->
šjeù¬gs
(
¬gs
, &
ss
);

5873 
	gosd_lock
.
Lock
();

5875 ià(
	g´efix
 == "config set") {

5876 
¡d
::
¡ršg
 
key
;

5877 
	g¡d
::
¡ršg
 
v®
;

5878 
cmd_g‘v®
(
cù
, 
cmdm­
, "key", 
key
);

5879 
cmd_g‘v®
(
cù
, 
cmdm­
, "v®ue", 
v®
);

5880 
	gosd_lock
.
UÆock
();

5881 
	gr
 = 
cù
->
_cÚf
->
£t_v®
(
key
, 
v®
, &
ss
);

5882 ià(
	gr
 == 0) {

5883 
cù
->
_cÚf
->
­¶y_chªges
(
nuÎ±r
);

5885 
	gosd_lock
.
Lock
();

5887 ià(
	g´efix
 == "config get") {

5888 
¡d
::
¡ršg
 
key
;

5889 
cmd_g‘v®
(
cù
, 
cmdm­
, "key", 
key
);

5890 
	gosd_lock
.
UÆock
();

5891 
	g¡d
::
¡ršg
 
v®
;

5892 
	gr
 = 
cù
->
_cÚf
->
g‘_v®
(
key
, &
v®
);

5893 ià(
	gr
 == 0) {

5894 
ds
 << 
v®
;

5896 
	gosd_lock
.
Lock
();

5898 ià(
	g´efix
 == "config unset") {

5899 
¡d
::
¡ršg
 
key
;

5900 
cmd_g‘v®
(
cù
, 
cmdm­
, "key", 
key
);

5901 
	gosd_lock
.
UÆock
();

5902 
	gr
 = 
cù
->
_cÚf
->
rm_v®
(
key
);

5903 ià(
	gr
 == 0) {

5904 
cù
->
_cÚf
->
­¶y_chªges
(
nuÎ±r
);

5906 
	gosd_lock
.
Lock
();

5908 ià(
	g´efix
 == "cluster_log") {

5909 
veùÜ
<
¡ršg
> 
msg
;

5910 
cmd_g‘v®
(
cù
, 
cmdm­
, "mes§ge", 
msg
);

5911 ià(
	gmsg
.
em±y
()) {

5912 
	gr
 = -
EINVAL
;

5913 
	gss
 << "ignoringƒmpty†og message";

5914 
	gout
;

5916 
¡ršg
 
	gmes§ge
 = 
msg
.
äÚt
();

5917 
	gveùÜ
<
	g¡ršg
>::
™”©Ü
 
a
 = ++
msg
.
begš
(); 
	ga
 !ğmsg.
’d
(); ++a)

5918 
	gmes§ge
 +ğ" " + *
a
;

5919 
¡ršg
 
	glvl
;

5920 
cmd_g‘v®
(
cù
, 
cmdm­
, "Ëv–", 
lvl
);

5921 
şog_ty³
 
	gËv–
 = 
¡ršg_to_şog_ty³
(
lvl
);

5922 ià(
	gËv–
 < 0) {

5923 
	gr
 = -
EINVAL
;

5924 
	gss
 << "unknowÀËv– '" << 
	glvl
 << "'";

5925 
	gout
;

5927 
	gşog
->
do_log
(
Ëv–
, 
mes§ge
);

5933 ià(
	g´efix
 == "pg" ||

5934 
´efix
 == "query" ||

5935 
´efix
 == "mark_unfound_lost" ||

5936 
´efix
 == "list_missing"

5938 
pg_t
 
pgid
;

5940 ià(!
cmd_g‘v®
(
cù
, 
cmdm­
, "pgid", 
pgid¡r
)) {

5941 
	gss
 << "no…gid specified";

5942 
	gr
 = -
EINVAL
;

5943 } ià(!
	gpgid
.
·r£
(
pgid¡r
.
c_¡r
())) {

5944 
	gss
 << "couldn'ˆ·r£…gid '" << 
	gpgid¡r
 << "'";

5945 
	gr
 = -
EINVAL
;

5947 
¥g_t
 
	gpÿnd
;

5948 
PGRef
 
	gpg
;

5949 ià(
	gosdm­
->
g‘_´im¬y_sh¬d
(
pgid
, &
pÿnd
) &&

5950 (
	gpg
 = 
_lookup_lock_pg
(
pÿnd
))) {

5951 ià(
pg
->
is_´im¬y
()) {

5953 ià(
´efix
 != "pg")

5954 
cmd_putv®
(
cù
, 
cmdm­
, "cmd", 
´efix
);

5955 
	gr
 = 
pg
->
do_commªd
(
cmdm­
, 
ss
, 
d©a
, 
od©a
, 
cÚ
, 
tid
);

5956 ià(
	gr
 =ğ-
EAGAIN
) {

5957 
pg
->
uÆock
();

5962 
	gss
 << "nÙ…rim¬y fÜ…gid " << 
	gpgid
;

5966 
	g£rviû
.
£nd_šüem’l_m­
(
osdm­
->
g‘_•och
(è- 1, 
cÚ
, osdmap);

5970 
	gpg
->
uÆock
();

5973 
	gpg
->
uÆock
();

5975 
	gss
 << "˜dÚ'ˆhavpgid " << 
	gpgid
;

5976 
	gr
 = -
ENOENT
;

5981 ià(
	g´efix
 == "bench") {

5982 
št64_t
 
couÁ
;

5983 
št64_t
 
	gbsize
;

5984 
št64_t
 
	gosize
, 
	gÚum
;

5986 
cmd_g‘v®
(
cù
, 
cmdm­
, "couÁ", 
couÁ
, (
št64_t
)1 << 30);

5987 
cmd_g‘v®
(
cù
, 
cmdm­
, "size", 
bsize
, (
št64_t
)4 << 20);

5988 
cmd_g‘v®
(
cù
, 
cmdm­
, "objeù_size", 
osize
, (
št64_t
)0);

5989 
cmd_g‘v®
(
cù
, 
cmdm­
, "objeù_num", 
Úum
, (
št64_t
)0);

5991 
ušt32_t
 
	gdu¿tiÚ
 = 
cù
->
_cÚf
->
osd_b’ch_du¿tiÚ
;

5993 ià(
	gbsize
 > (
	gšt64_t
è
	gcù
->
	g_cÚf
->
	gosd_b’ch_max_block_size
) {

5997 
	gss
 << "block 'size' values‡re capped‡t "

5998 << 
by‹_u_t
(
cù
->
_cÚf
->
osd_b’ch_max_block_size
) << ". If you wisho use"

6000 
	gr
 = -
EINVAL
;

6001 
	gout
;

6002 } ià(
	gbsize
 < (
	gšt64_t
) (1 << 20)) {

6007 
št64_t
 
	gmax_couÁ
 =

6008 
bsize
 * 
du¿tiÚ
 * 
cù
->
_cÚf
->
osd_b’ch_sm®l_size_max_iİs
;

6009 ià(
	gcouÁ
 > 
	gmax_couÁ
) {

6010 
	gss
 << "'couÁ' v®ue g»©”hª " << 
	gmax_couÁ


6011 << " fÜ‡ block sizoà" << 
by‹_u_t
(
bsize
) << ",‡ssuming "

6012 << 
	gcù
->
	g_cÚf
->
	gosd_b’ch_sm®l_size_max_iİs
 << " IOPS,"

6013 << " fÜ " << 
	gdu¿tiÚ
 << " seconds,"

6017 
	gr
 = -
EINVAL
;

6018 
	gout
;

6030 
št64_t
 
	gmax_couÁ
 =

6031 
cù
->
_cÚf
->
osd_b’ch_Ïrge_size_max_throughput
 * 
du¿tiÚ
;

6032 ià(
	gcouÁ
 > 
	gmax_couÁ
) {

6033 
	gss
 << "'couÁ' v®ue g»©”hª " << 
	gmax_couÁ


6034 << " fÜ‡ block sizoà" << 
by‹_u_t
(
bsize
) << ",‡ssuming "

6035 << 
by‹_u_t
(
cù
->
_cÚf
->
osd_b’ch_Ïrge_size_max_throughput
) << "/s,"

6036 << " fÜ " << 
	gdu¿tiÚ
 << " seconds,"

6040 
	gr
 = -
EINVAL
;

6041 
	gout
;

6045 ià(
	gosize
 && 
	gbsize
 > osize)

6046 
	gbsize
 = 
osize
;

6048 
dout
(1è<< " b’ch couÁ " << 
	gcouÁ


6049 << " bsiz" << 
by‹_u_t
(
bsize
è<< 
	gd’dl
;

6051 
	gObjeùStÜe
::
T¿n§ùiÚ
 
ş—nu±
;

6053 ià(
	gosize
 && 
	gÚum
) {

6054 
bufã¾i¡
 
	gbl
;

6055 
bufã½Œ
 
bp
(
osize
);

6056 
	gbp
.
z”o
();

6057 
	gbl
.
push_back
(
¡d
::
move
(
bp
));

6058 
	gbl
.
»bud_·ge_®igÃd
();

6059 
	gi
=0; i<
	gÚum
; ++i) {

6060 
	gnm
[30];

6061 
¢´štf
(
nm
, Òm), "disk_bw_‹¡_%d", 
i
);

6062 
objeù_t
 
oid
(
nm
);

6063 
hobjeù_t
 
soid
(
sobjeù_t
(
oid
, 0));

6064 
	gObjeùStÜe
::
T¿n§ùiÚ
 
t
;

6065 
	gt
.
wr™e
(
cŞl_t
(), 
ghobjeù_t
(
soid
), 0, 
osize
, 
bl
);

6066 
	g¡Üe
->
queue_Œª§ùiÚ
(
£rviû
.
m‘a_ch
, 
¡d
::
move
(
t
), 
NULL
);

6067 
	gş—nu±
.
»move
(
cŞl_t
(), 
ghobjeù_t
(
soid
));

6071 
bufã¾i¡
 
	gbl
;

6072 
bufã½Œ
 
bp
(
bsize
);

6073 
	gbp
.
z”o
();

6074 
	gbl
.
push_back
(
¡d
::
move
(
bp
));

6075 
	gbl
.
»bud_·ge_®igÃd
();

6078 
C_SaãrCÚd
 
	gwa™”
;

6079 ià(!
	g£rviû
.
	gm‘a_ch
->
æush_comm™
(&
wa™”
)) {

6080 
	gwa™”
.
wa™
();

6084 
utime_t
 
	g¡¬t
 = 
ûph_şock_now
();

6085 
št64_t
 
	gpos
 = 0;…o < 
	gcouÁ
;…o +ğ
bsize
) {

6086 
nm
[30];

6087 
	goff£t
 = 0;

6088 ià(
	gÚum
 && 
	gosize
) {

6089 
¢´štf
(
nm
, Òm), "disk_bw_‹¡_%d", ()(
¿nd
(è% 
Úum
));

6090 
	goff£t
 = 
¿nd
(è% (
osize
 / 
bsize
) * bsize;

6092 
¢´štf
(
nm
, Òm), "disk_bw_‹¡_%Îd", ()
pos
);

6094 
objeù_t
 
oid
(
nm
);

6095 
hobjeù_t
 
soid
(
sobjeù_t
(
oid
, 0));

6096 
	gObjeùStÜe
::
T¿n§ùiÚ
 
t
;

6097 
	gt
.
wr™e
(
cŞl_t
::
m‘a
(), 
ghobjeù_t
(
soid
), 
off£t
, 
bsize
, 
bl
);

6098 
	g¡Üe
->
queue_Œª§ùiÚ
(
£rviû
.
m‘a_ch
, 
¡d
::
move
(
t
), 
NULL
);

6099 ià(!
	gÚum
 || !
	gosize
)

6100 
	gş—nu±
.
»move
(
cŞl_t
::
m‘a
(), 
ghobjeù_t
(
soid
));

6104 
C_SaãrCÚd
 
	gwa™”
;

6105 ià(!
	g£rviû
.
	gm‘a_ch
->
æush_comm™
(&
wa™”
)) {

6106 
	gwa™”
.
wa™
();

6109 
utime_t
 
	g’d
 = 
ûph_şock_now
();

6112 
	g¡Üe
->
queue_Œª§ùiÚ
(
£rviû
.
m‘a_ch
, 
¡d
::
move
(
ş—nu±
), 
NULL
);

6114 
C_SaãrCÚd
 
	gwa™”
;

6115 ià(!
	g£rviû
.
	gm‘a_ch
->
æush_comm™
(&
wa™”
)) {

6116 
	gwa™”
.
wa™
();

6120 
ušt64_t
 
	g¿‹
 = ()
couÁ
 / (
’d
 - 
¡¬t
);

6121 ià(
	gf
) {

6122 
	gf
->
İ’_objeù_£ùiÚ
("osd_bench_results");

6123 
	gf
->
dump_št
("by‹s_wr™‹n", 
couÁ
);

6124 
	gf
->
dump_št
("blocksize", 
bsize
);

6125 
	gf
->
dump_unsigÃd
("by‹s_³r_£c", 
¿‹
);

6126 
	gf
->
şo£_£ùiÚ
();

6127 
	gf
->
æush
(
ds
);

6129 
	gds
 << "b’ch: wrÙ" << 
by‹_u_t
(
couÁ
)

6130 << " iÀblock oà" << 
by‹_u_t
(
bsize
) << " in "

6131 << (
	g’d
-
	g¡¬t
è<< " seø© " << 
by‹_u_t
(
¿‹
) << "/sec";

6135 ià(
	g´efix
 == "flush_pg_stats") {

6136 
mgrc
.
£nd_pg¡©s
();

6137 
	gds
 << 
	g£rviû
.
g‘_osd_¡©_£q
() << "\n";

6140 ià(
	g´efix
 == "heap") {

6141 
r
 = 
ûph
::
osd_cmds
::
h—p
(*
cù
, 
cmdm­
, *
f
, 
ds
);

6144 ià(
	g´efix
 == "debug dump_missing") {

6145 ià(!
f
) {

6146 
f
.
»£t
(
Ãw
 
JSONFÜm©‹r
(
Œue
));

6148 
	gf
->
İ’_¬¿y_£ùiÚ
("pgs");

6149 
	gveùÜ
<
	gPGRef
> 
	gpgs
;

6150 
_g‘_pgs
(&
pgs
);

6151 auto& 
	gpg
 : 
pgs
) {

6152 
¡ršg
 
s
 = 
¡ršgify
(
pg
->
pg_id
);

6153 
	gf
->
İ’_¬¿y_£ùiÚ
(
s
.
c_¡r
());

6154 
	gpg
->
lock
();

6155 
	gpg
->
dump_missšg
(
f
.
g‘
());

6156 
	gpg
->
uÆock
();

6157 
	gf
->
şo£_£ùiÚ
();

6159 
	gf
->
şo£_£ùiÚ
();

6160 
	gf
->
æush
(
ss
);

6162 ià(
	g´efix
 == "debug kick_recovery_wq") {

6163 
št64_t
 
d–ay
;

6164 
cmd_g‘v®
(
cù
, 
cmdm­
, "d–ay", 
d–ay
);

6165 
o¡ršg¡»am
 
	goss
;

6166 
	goss
 << 
	gd–ay
;

6167 
	gr
 = 
cù
->
_cÚf
->
£t_v®
("osd_»cov”y_d–ay_¡¬t", 
oss
.
¡r
().
c_¡r
());

6168 ià(
	gr
 != 0) {

6169 
ss
 << "kick_recovery_wq:ƒrror setting "

6170 << "osd_»cov”y_d–ay_¡¬ˆtØ'" << 
d–ay
 << "':ƒrror "

6171 << 
r
;

6172 
	gout
;

6174 
	gcù
->
	g_cÚf
->
­¶y_chªges
(
NULL
);

6175 
	gss
 << "kicking„ecovery queue. set osd_recovery_delay_start "

6176 << "tØ" << 
	gcù
->
	g_cÚf
->
	gosd_»cov”y_d–ay_¡¬t
;

6179 ià(
	g´efix
 == "cpu_profiler") {

6180 
¡ršg
 
¬g
;

6181 
cmd_g‘v®
(
cù
, 
cmdm­
, "¬g", 
¬g
);

6182 
	gveùÜ
<
	g¡ršg
> 
	g¬gvec
;

6183 
g‘_¡r_vec
(
¬g
, 
¬gvec
);

6184 
ıu_´of”_hªdË_commªd
(
¬gvec
, 
ds
);

6187 ià(
	g´efix
 == "dump_pg_recovery_stats") {

6188 
¡ršg¡»am
 
s
;

6189 ià(
	gf
) {

6190 
	gpg_»cov”y_¡©s
.
dump_fÜm©‹d
(
f
.
g‘
());

6191 
	gf
->
æush
(
ds
);

6193 
	gpg_»cov”y_¡©s
.
dump
(
s
);

6194 
	gds
 << "dum°pg„ecov”y sts: " << 
	gs
.
¡r
();

6198 ià(
	g´efix
 == "reset_pg_recovery_stats") {

6199 
ss
 << "reset…g„ecovery stats";

6200 
	gpg_»cov”y_¡©s
.
»£t
();

6203 ià(
	g´efix
 == "perf histogram dump") {

6204 
¡d
::
¡ršg
 
logg”
;

6205 
	g¡d
::
¡ršg
 
couÁ”
;

6206 
cmd_g‘v®
(
cù
, 
cmdm­
, "logg”", 
logg”
);

6207 
cmd_g‘v®
(
cù
, 
cmdm­
, "couÁ”", 
couÁ”
);

6208 ià(
	gf
) {

6209 
	gcù
->
g‘_³rfcouÁ”s_cŞËùiÚ
()->
dump_fÜm©‹d_hi¡og¿ms
(

6210 
f
.
g‘
(), 
çl£
, 
logg”
, 
couÁ”
);

6211 
	gf
->
æush
(
ds
);

6215 ià(
	g´efix
 == "compact") {

6216 
dout
(1è<< "Œigg”šg mªu® com·ùiÚ" << 
d’dl
;

6217 autØ
	g¡¬t
 = 
ûph
::
cßr£_mÚo_şock
::
now
();

6218 
	g¡Üe
->
com·ù
();

6219 autØ
	g’d
 = 
ûph
::
cßr£_mÚo_şock
::
now
();

6220 
	gdu¿tiÚ
 = 
¡d
::
chrÚo
::
du¿tiÚ
<>(
’d
-
¡¬t
).
couÁ
();

6221 
dout
(1) << "finished manual compaction in "

6222 << 
	gdu¿tiÚ


6223 << " secÚds" << 
	gd’dl
;

6224 
	gss
 << "com·ùed om­ iÀ" << 
	gdu¿tiÚ
 << " seconds";

6227 ià(
	g´efix
 == "smart") {

6228 
´obe_sm¬t
(
ds
);

6232 
	gss
 << "uÄecognized commªd! " << 
	gcmd
;

6233 
	gr
 = -
EINVAL
;

6236 
	gout
:

6237 
rs
 = 
ss
.
¡r
();

6238 
	god©a
.
­³nd
(
ds
);

6239 
dout
(0è<< "do_commªd„=" << 
	gr
 << " " << 
	grs
 << 
	gd’dl
;

6240 
	gşog
->
šfo
(è<< 
	grs
;

6241 ià(
	gcÚ
) {

6242 
MCommªdR•ly
 *
	g»¶y
 = 
Ãw
 MCommªdR•ly(
r
, 
rs
);

6243 
	g»¶y
->
£t_tid
(
tid
);

6244 
	g»¶y
->
£t_d©a
(
od©a
);

6245 
	gcÚ
->
£nd_mes§ge
(
»¶y
);

6249 
	gOSD
::
	$´obe_sm¬t
(
o¡»am
& 
ss
)

6251 
£t
<
¡ršg
> 
devÇmes
;

6252 
¡Üe
->
	`g‘_deviûs
(&
devÇmes
);

6253 
ušt64_t
 
sm¬t_timeout
 = 
cù
->
_cÚf
->
g‘_v®
<uint64_t>("osd_smart_report_timeout");

6254 
¡d
::
¡ršg
 
»suÉ
;

6256 
jsÚ_¥œ™
::
mObjeù
 
jsÚ_m­
;

6257 
jsÚ_¥œ™
::
mV®ue
 
sm¬t_jsÚ
;

6259 autØ
dev
 : 
devÇmes
) {

6261 ià(
dev
.
	`fšd
("dm-") == 0) {

6265 ià(
	`´obe_sm¬t_deviû
(("/dev/" + 
dev
).
	`c_¡r
(), 
sm¬t_timeout
, &
»suÉ
)) {

6266 
	`dout
(10è<< "´obe_sm¬t_deviû faed fÜ /dev/" << 
dev
 << 
d’dl
;

6271 ià(!
jsÚ_¥œ™
::
	`»ad
(
»suÉ
, 
sm¬t_jsÚ
)) {

6272 
d”r
 << "sm¬tùÈJSON ouuˆoà/dev/" + 
dev
 + " i šv®id" << 
d’dl
;

6274 
jsÚ_m­
[
dev
] = 
sm¬t_jsÚ
;

6278 
jsÚ_¥œ™
::
	`wr™e
(
jsÚ_m­
, 
ss
, jsÚ_¥œ™::
´‘ty_´št
);

6279 
	}
}

6281 
	gOSD
::
	$´obe_sm¬t_deviû
(cÚ¡ *
deviû
, 
timeout
, 
¡d
::
¡ršg
 *
»suÉ
)

6284 
SubProûssTimed
 
	`sm¬tùl
("sudo", 
SubProûss
::
CLOSE
, SubProûss::
PIPE
, SubProcess::CLOSE,

6285 
timeout
);

6286 
sm¬tùl
.
	`add_cmd_¬gs
(

6291 
deviû
,

6292 
NULL
);

6294 
»t
 = 
sm¬tùl
.
	`¥awn
();

6295 ià(
»t
 != 0) {

6296 
d”r
 << "çed„uÀsm¬tùl: " << 
sm¬tùl
.
	`”r
(è<< 
d’dl
;

6297  
»t
;

6300 
bufã¾i¡
 
ouut
;

6301 
»t
 = 
ouut
.
	`»ad_fd
(
sm¬tùl
.
	`g‘_¡dout
(), 100*1024);

6302 ià(
»t
 < 0) {

6303 
d”r
 << "çed„—d from sm¬tùl: " << 
	`ıp_¡»¼Ü
(-
»t
è<< 
d’dl
;

6305 
»t
 = 0;

6306 *
»suÉ
 = 
ouut
.
	`to_¡r
();

6307 
	`dout
(10è<< "sm¬tùÈouuˆis: " << *
»suÉ
 << 
d’dl
;

6310 ià(
sm¬tùl
.
	`još
() != 0) {

6311 
d”r
 << 
sm¬tùl
.
	`”r
(è<< 
d’dl
;

6312  -
EINVAL
;

6315  
»t
;

6316 
	}
}

6318 
boŞ
 
	gOSD
::
	$h—¹b—t_di¥©ch
(
Mes§ge
 *
m
)

6320 
	`dout
(30è<< "h—¹b—t_di¥©ch " << 
m
 << 
d’dl
;

6321 
m
->
	`g‘_ty³
()) {

6323 
CEPH_MSG_PING
:

6324 
	`dout
(10è<< "pšg from " << 
m
->
	`g‘_sourû_š¡
(è<< 
d’dl
;

6325 
m
->
	`put
();

6328 
MSG_OSD_PING
:

6329 
	`hªdË_osd_pšg
(
¡©ic_ÿ¡
<
MOSDPšg
*>(
m
));

6333 
	`dout
(0è<< "drİpšg uÃx³ùed mes§g" << *
m
 << " from " << m->
	`g‘_sourû_š¡
(è<< 
d’dl
;

6334 
m
->
	`put
();

6337  
Œue
;

6338 
	}
}

6340 
boŞ
 
	gOSD
::
	$ms_di¥©ch
(
Mes§ge
 *
m
)

6342 
	`dout
(20è<< "OSD::ms_di¥©ch: " << *
m
 << 
d’dl
;

6343 ià(
m
->
	`g‘_ty³
(è=ğ
MSG_OSD_MARK_ME_DOWN
) {

6344 
£rviû
.
	`gÙ_¡İ_ack
();

6345 
m
->
	`put
();

6346  
Œue
;

6351 
osd_lock
.
	`Lock
();

6352 ià(
	`is_¡İpšg
()) {

6353 
osd_lock
.
	`UÆock
();

6354 
m
->
	`put
();

6355  
Œue
;

6358 
	`do_wa™”s
();

6359 
	`_di¥©ch
(
m
);

6361 
osd_lock
.
	`UÆock
();

6363  
Œue
;

6364 
	}
}

6366 
	gOSD
::
	$maybe_sh¬e_m­
(

6367 
SessiÚ
 *
£ssiÚ
,

6368 
OpReque¡Ref
 
İ
,

6369 
OSDM­Ref
 
osdm­
)

6371 ià(!
İ
->
check_£nd_m­
) {

6374 
•och_t
 
Ï¡_£Á_•och
 = 0;

6376 
£ssiÚ
->
£Á_•och_lock
.
	`lock
();

6377 
Ï¡_£Á_•och
 = 
£ssiÚ
->last_sent_epoch;

6378 
£ssiÚ
->
£Á_•och_lock
.
	`uÆock
();

6380 cÚ¡ 
Mes§ge
 *
m
 = 
İ
->
	`g‘_»q
();

6381 
£rviû
.
	`sh¬e_m­
(

6382 
m
->
	`g‘_sourû
(),

6383 
m
->
	`g‘_cÚÃùiÚ
().
	`g‘
(),

6384 
İ
->
£Á_•och
,

6385 
osdm­
,

6386 
£ssiÚ
 ? &
Ï¡_£Á_•och
 : 
NULL
);

6388 
£ssiÚ
->
£Á_•och_lock
.
	`lock
();

6389 ià(
£ssiÚ
->
Ï¡_£Á_•och
 <†ast_sent_epoch) {

6390 
£ssiÚ
->
Ï¡_£Á_•och
 =†ast_sent_epoch;

6392 
£ssiÚ
->
£Á_•och_lock
.
	`uÆock
();

6394 
İ
->
check_£nd_m­
 = 
çl£
;

6395 
	}
}

6397 
	gOSD
::
	$di¥©ch_£ssiÚ_wa™šg
(
SessiÚ
 *
£ssiÚ
, 
OSDM­Ref
 
osdm­
)

6399 
	`as£¹
(
£ssiÚ
->
£ssiÚ_di¥©ch_lock
.
	`is_locked
());

6401 autØ
i
 = 
£ssiÚ
->
wa™šg_Ú_m­
.
	`begš
();

6402 
i
 !ğ
£ssiÚ
->
wa™šg_Ú_m­
.
	`’d
()) {

6403 
OpReque¡Ref
 
İ
 = &(*
i
);

6404 
	`as£¹
(
	`ms_ÿn_ç¡_di¥©ch
(
İ
->
	`g‘_»q
()));

6405 cÚ¡ 
MOSDFa¡Di¥©chOp
 *
m
 = 
¡©ic_ÿ¡
<const MOSDFastDispatchOp*>(

6406 
İ
->
	`g‘_»q
());

6407 ià(
m
->
	`g‘_mš_•och
(è> 
osdm­
->
	`g‘_•och
()) {

6410 
£ssiÚ
->
wa™šg_Ú_m­
.
	`”a£
(
i
++);

6411 
İ
->
	`put
();

6413 
¥g_t
 
pgid
;

6414 ià(
m
->
	`g‘_ty³
(è=ğ
CEPH_MSG_OSD_OP
) {

6415 
pg_t
 
aùu®_pgid
 = 
osdm­
->
	`¿w_pg_to_pg
(

6416 
¡©ic_ÿ¡
<cÚ¡ 
MOSDOp
*>(
m
)->
	`g‘_pg
());

6417 ià(!
osdm­
->
	`g‘_´im¬y_sh¬d
(
aùu®_pgid
, &
pgid
)) {

6421 
pgid
 = 
m
->
	`g‘_¥g
();

6423 
	`’queue_İ
(
pgid
, 
İ
, 
m
->
	`g‘_m­_•och
());

6426 ià(
£ssiÚ
->
wa™šg_Ú_m­
.
	`em±y
()) {

6427 
	`ş—r_£ssiÚ_wa™šg_Ú_m­
(
£ssiÚ
);

6429 
	`»gi¡”_£ssiÚ_wa™šg_Ú_m­
(
£ssiÚ
);

6431 
	}
}

6433 
	gOSD
::
	$ms_ç¡_di¥©ch
(
Mes§ge
 *
m
)

6435 
	`FUNCTRACE
(
cù
);

6436 ià(
£rviû
.
	`is_¡İpšg
()) {

6437 
m
->
	`put
();

6442 
m
->
	`g‘_ty³
()) {

6443 
CEPH_MSG_PING
:

6444 
	`dout
(10è<< "pšg from " << 
m
->
	`g‘_sourû
(è<< 
d’dl
;

6445 
m
->
	`put
();

6447 
MSG_MON_COMMAND
:

6448 
	`hªdË_commªd
(
¡©ic_ÿ¡
<
MMÚCommªd
*>(
m
));

6450 
MSG_OSD_FORCE_RECOVERY
:

6451 
	`hªdË_ç¡_fÜû_»cov”y
(
¡©ic_ÿ¡
<
MOSDFÜûRecov”y
*>(
m
));

6453 
MSG_OSD_SCRUB2
:

6454 
	`hªdË_ç¡_süub
(
¡©ic_ÿ¡
<
MOSDSüub2
*>(
m
));

6457 
MSG_OSD_PG_CREATE2
:

6458  
	`hªdË_ç¡_pg_ü—‹
(
¡©ic_ÿ¡
<
MOSDPGC»©e2
*>(
m
));

6459 
MSG_OSD_PG_QUERY
:

6460  
	`hªdË_ç¡_pg_qu”y
(
¡©ic_ÿ¡
<
MOSDPGQu”y
*>(
m
));

6461 
MSG_OSD_PG_NOTIFY
:

6462  
	`hªdË_ç¡_pg_nÙify
(
¡©ic_ÿ¡
<
MOSDPGNÙify
*>(
m
));

6463 
MSG_OSD_PG_INFO
:

6464  
	`hªdË_ç¡_pg_šfo
(
¡©ic_ÿ¡
<
MOSDPGInfo
*>(
m
));

6465 
MSG_OSD_PG_REMOVE
:

6466  
	`hªdË_ç¡_pg_»move
(
¡©ic_ÿ¡
<
MOSDPGRemove
*>(
m
));

6469 
MSG_OSD_PG_LOG
:

6470 
MSG_OSD_PG_TRIM
:

6471 
MSG_OSD_BACKFILL_RESERVE
:

6472 
MSG_OSD_RECOVERY_RESERVE
:

6474 
MOSDP“ršgOp
 *
pm
 = 
¡©ic_ÿ¡
<MOSDP“ršgOp*>(
m
);

6475 ià(
	`»quœe_osd_³”
(
pm
)) {

6476 
	`’queue_³”šg_evt
(

6477 
pm
->
	`g‘_¥g
(),

6478 
	`PGP“ršgEv’tRef
(
pm
->
	`g‘_ev’t
()));

6480 
pm
->
	`put
();

6485 
OpReque¡Ref
 
İ
 = 
İ_Œack”
.
ü—‹_»que¡
<
OpReque¡
, 
Mes§ge
*>(
m
);

6487 #ifdeà
WITH_LTTNG


6488 
osd_»qid_t
 
»qid
 = 
İ
->
	`g‘_»qid
();

6490 
	`Œaûpošt
(
osd
, 
ms_ç¡_di¥©ch
, 
»qid
.
Çme
.
_ty³
,

6491 
»qid
.
Çme
.
_num
,„eqid.
tid
,„eqid.
šc
);

6494 ià(
m
->
Œaû
)

6495 
İ
->
osd_Œaû
.
	`š™
("osd op", &
Œaû_’dpošt
, &
m
->
Œaû
);

6498 
İ
->
£Á_•och
 = 
¡©ic_ÿ¡
<
MOSDFa¡Di¥©chOp
*>(
m
)->
	`g‘_m­_•och
();

6499 
İ
->
mš_•och
 = 
¡©ic_ÿ¡
<
MOSDFa¡Di¥©chOp
*>(
m
)->
	`g‘_mš_•och
();

6500 
	`as£¹
(
İ
->
mš_•och
 <ğİ->
£Á_•och
);

6502 
£rviû
.
	`maybe_šjeù_di¥©ch_d–ay
();

6504 ià(
m
->
	`g‘_cÚÃùiÚ
()->
	`has_ã©u»s
(
CEPH_FEATUREMASK_RESEND_ON_SPLIT
) ||

6505 
m
->
	`g‘_ty³
(è!ğ
CEPH_MSG_OSD_OP
) {

6507 
	`’queue_İ
(

6508 
¡©ic_ÿ¡
<
MOSDFa¡Di¥©chOp
*>(
m
)->
	`g‘_¥g
(),

6509 
İ
,

6510 
¡©ic_ÿ¡
<
MOSDFa¡Di¥©chOp
*>(
m
)->
	`g‘_m­_•och
());

6515 
SessiÚ
 *
£ssiÚ
 = 
¡©ic_ÿ¡
<SessiÚ*>(
m
->
	`g‘_cÚÃùiÚ
()->
	`g‘_´iv
());

6516 ià(
£ssiÚ
) {

6518 
Mu‹x
::
Lock”
 
	`l
(
£ssiÚ
->
£ssiÚ_di¥©ch_lock
);

6519 
İ
->
	`g‘
();

6520 
£ssiÚ
->
wa™šg_Ú_m­
.
	`push_back
(*
İ
);

6521 
OSDM­Ref
 
Ãxtm­
 = 
£rviû
.
	`g‘_Ãxtm­_»£rved
();

6522 
	`di¥©ch_£ssiÚ_wa™šg
(
£ssiÚ
, 
Ãxtm­
);

6523 
£rviû
.
	`»Ëa£_m­
(
Ãxtm­
);

6525 
£ssiÚ
->
	`put
();

6528 
	`OID_EVENT_TRACE_WITH_MSG
(
m
, "MS_FAST_DISPATCH_END", 
çl£
);

6529 
	}
}

6531 
	gOSD
::
	$ms_ç¡_´•roûss
(
Mes§ge
 *
m
)

6533 ià(
m
->
	`g‘_cÚÃùiÚ
()->
	`g‘_³”_ty³
(è=ğ
CEPH_ENTITY_TYPE_OSD
) {

6534 ià(
m
->
	`g‘_ty³
(è=ğ
CEPH_MSG_OSD_MAP
) {

6535 
MOSDM­
 *
mm
 = 
¡©ic_ÿ¡
<MOSDM­*>(
m
);

6536 
SessiÚ
 *
s
 = 
¡©ic_ÿ¡
<SessiÚ*>(
m
->
	`g‘_cÚÃùiÚ
()->
	`g‘_´iv
());

6537 ià(
s
) {

6538 
s
->
»ûived_m­_lock
.
	`lock
();

6539 
s
->
»ûived_m­_•och
 = 
mm
->
	`g‘_Ï¡
();

6540 
s
->
»ûived_m­_lock
.
	`uÆock
();

6541 
s
->
	`put
();

6545 
	}
}

6547 
boŞ
 
	gOSD
::
	$ms_g‘_authÜiz”
(
de¡_ty³
, 
AuthAuthÜiz”
 **
authÜiz”
, 
boŞ
 
fÜû_Ãw
)

6549 
	`dout
(10è<< "OSD::ms_g‘_authÜiz”y³=" << 
	`ûph_’t™y_ty³_Çme
(
de¡_ty³
è<< 
d’dl
;

6551 ià(
	`is_¡İpšg
()) {

6552 
	`dout
(10è<< 
__func__
 << " bašg, w¬shu‰šg down" << 
d’dl
;

6553  
çl£
;

6556 ià(
de¡_ty³
 =ğ
CEPH_ENTITY_TYPE_MON
)

6557  
Œue
;

6559 ià(
fÜû_Ãw
) {

6562 ià(
mÚc
->
	`wa™_auth_rÙ©šg
(10) < 0) {

6563 
d”r
 << "OSD::ms_g‘_authÜiz” wa™_auth_rÙ©šg faed" << 
d’dl
;

6564  
çl£
;

6568 *
authÜiz”
 = 
mÚc
->
	`bud_authÜiz”
(
de¡_ty³
);

6569  *
authÜiz”
 !ğ
NULL
;

6570 
	}
}

6573 
boŞ
 
	gOSD
::
	$ms_v”ify_authÜiz”
(
CÚÃùiÚ
 *
cÚ
, 
³”_ty³
,

6574 
´ÙocŞ
, 
bufã¾i¡
& 
authÜiz”_d©a
, bufã¾i¡& 
authÜiz”_»¶y
,

6575 
boŞ
& 
isv®id
, 
Cry±oKey
& 
£ssiÚ_key
)

6577 
AuthAuthÜizeHªdËr
 *
authÜize_hªdËr
 = 0;

6578 
³”_ty³
) {

6579 
CEPH_ENTITY_TYPE_MDS
:

6584 
CEPH_ENTITY_TYPE_OSD
:

6585 
CEPH_ENTITY_TYPE_MGR
:

6586 
authÜize_hªdËr
 = 
authÜize_hªdËr_şu¡”_»gi¡ry
->
	`g‘_hªdËr
(
´ÙocŞ
);

6589 
authÜize_hªdËr
 = 
authÜize_hªdËr_£rviû_»gi¡ry
->
	`g‘_hªdËr
(
´ÙocŞ
);

6591 ià(!
authÜize_hªdËr
) {

6592 
	`dout
(0è<< "NØAuthAuthÜizeHªdË¸found fÜ…rÙocŞ " << 
´ÙocŞ
 << 
d’dl
;

6593 
isv®id
 = 
çl£
;

6594  
Œue
;

6597 
AuthC­sInfo
 
ÿps_šfo
;

6598 
EÁ™yName
 
Çme
;

6599 
ušt64_t
 
glob®_id
;

6600 
ušt64_t
 
auid
 = 
CEPH_AUTH_UID_DEFAULT
;

6602 
RÙ©šgKeyRšg
 *
keys
 = 
mÚc
->
rÙ©šg_£ü‘s
.
	`g‘
();

6603 ià(
keys
) {

6604 
isv®id
 = 
authÜize_hªdËr
->
	`v”ify_authÜiz”
(

6605 
cù
, 
keys
,

6606 
authÜiz”_d©a
, 
authÜiz”_»¶y
, 
Çme
, 
glob®_id
, 
ÿps_šfo
, 
£ssiÚ_key
,

6607 &
auid
);

6609 
	`dout
(10è<< 
__func__
 << "‚ØrÙ©šg_key (y‘), d’›d" << 
d’dl
;

6610 
isv®id
 = 
çl£
;

6613 ià(
isv®id
) {

6614 
SessiÚ
 *
s
 = 
¡©ic_ÿ¡
<SessiÚ *>(
cÚ
->
	`g‘_´iv
());

6615 ià(!
s
) {

6616 
s
 = 
Ãw
 
	`SessiÚ
(
cù
);

6617 
cÚ
->
	`£t_´iv
(
s
->
	`g‘
());

6618 
s
->
cÚ
 = con;

6619 
	`dout
(10è<< "‚ew sessiÚ " << 
s
 << " cÚ=" << s->
cÚ
 << "‡ddr=" << s->cÚ->
	`g‘_³”_addr
(è<< 
d’dl
;

6622 
s
->
’t™y_Çme
 = 
Çme
;

6623 ià(
ÿps_šfo
.
®low_®l
)

6624 
s
->
ÿps
.
	`£t_®low_®l
();

6625 
s
->
auid
 =‡uid;

6627 ià(
ÿps_šfo
.
ÿps
.
	`Ëngth
() > 0) {

6628 
bufã¾i¡
::
™”©Ü
 
p
 = 
ÿps_šfo
.
ÿps
.
	`begš
();

6629 
¡ršg
 
¡r
;

6630 
Œy
 {

6631 
	`decode
(
¡r
, 
p
);

6633 
	`ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

6634 
isv®id
 = 
çl£
;

6636 
¡ršg¡»am
 
ss
;

6637 
boŞ
 
sucûss
 = 
s
->
ÿps
.
	`·r£
(
¡r
, &
ss
);

6638 ià(
sucûss
)

6639 
	`dout
(10è<< " sessiÚ " << 
s
 << " " << s->
’t™y_Çme
 << " ha ÿp " << s->
ÿps
 << " '" << 
¡r
 << "'" << 
d’dl
;

6641 
	`dout
(10è<< " sessiÚ " << 
s
 << " " << s->
’t™y_Çme
 << " faedØ·r£ c­ '" << 
¡r
 << "'" << 
d’dl
;

6642 
	`dout
(20è<< "·r£¸»tuºed " << 
ss
.
	`¡r
(è<< 
d’dl
;

6643 
isv®id
 = 
çl£
;

6647 
s
->
	`put
();

6649  
Œue
;

6650 
	}
}

6652 
	gOSD
::
	$do_wa™”s
()

6654 
	`as£¹
(
osd_lock
.
	`is_locked
());

6656 
	`dout
(10è<< "do_wa™” -- s¹" << 
d’dl
;

6657 !
fšished
.
	`em±y
()) {

6658 
OpReque¡Ref
 
Ãxt
 = 
fšished
.
	`äÚt
();

6659 
fšished
.
	`pİ_äÚt
();

6660 
	`di¥©ch_İ
(
Ãxt
);

6662 
	`dout
(10è<< "do_wa™” -- fšish" << 
d’dl
;

6663 
	}
}

6665 
	gOSD
::
	$di¥©ch_İ
(
OpReque¡Ref
 
İ
)

6667 
İ
->
	`g‘_»q
()->
	`g‘_ty³
()) {

6669 
MSG_OSD_PG_CREATE
:

6670 
	`hªdË_pg_ü—‹
(
İ
);

6673 
	}
}

6675 
	gOSD
::
	$_di¥©ch
(
Mes§ge
 *
m
)

6677 
	`as£¹
(
osd_lock
.
	`is_locked
());

6678 
	`dout
(20è<< "_di¥©ch " << 
m
 << " " << *m << 
d’dl
;

6680 
m
->
	`g‘_ty³
()) {

6684 
CEPH_MSG_OSD_MAP
:

6685 
	`hªdË_osd_m­
(
¡©ic_ÿ¡
<
MOSDM­
*>(
m
));

6689 
MSG_OSD_SCRUB
:

6690 
	`hªdË_süub
(
¡©ic_ÿ¡
<
MOSDSüub
*>(
m
));

6693 
MSG_COMMAND
:

6694 
	`hªdË_commªd
(
¡©ic_ÿ¡
<
MCommªd
*>(
m
));

6699 
MSG_OSD_PG_CREATE
:

6701 
OpReque¡Ref
 
İ
 = 
İ_Œack”
.
ü—‹_»que¡
<
OpReque¡
, 
Mes§ge
*>(
m
);

6702 ià(
m
->
Œaû
)

6703 
İ
->
osd_Œaû
.
	`š™
("osd op", &
Œaû_’dpošt
, &
m
->
Œaû
);

6705 ià(!
osdm­
) {

6706 
	`dout
(7è<< "nØOSDM­,‚Ù boÙed" << 
d’dl
;

6707 
logg”
->
	`šc
(
l_osd_wa™šg_fÜ_m­
);

6708 
wa™šg_fÜ_osdm­
.
	`push_back
(
İ
);

6709 
İ
->
	`m¬k_d–ayed
("no osdmap");

6714 
	`di¥©ch_İ
(
İ
);

6717 
	}
}

6720 
	gOSD
::
	$hªdË_süub
(
MOSDSüub
 *
m
)

6722 
	`dout
(10è<< "hªdË_süub " << *
m
 << 
d’dl
;

6723 ià(!
	`»quœe_mÚ_Ü_mgr_³”
(
m
)) {

6724 
m
->
	`put
();

6727 ià(
m
->
fsid
 !ğ
mÚc
->
	`g‘_fsid
()) {

6728 
	`dout
(0è<< "hªdË_süub fsid " << 
m
->
fsid
 << " !ğ" << 
mÚc
->
	`g‘_fsid
()

6729 << 
d’dl
;

6730 
m
->
	`put
();

6734 
veùÜ
<
¥g_t
> 
¥gs
;

6735 
	`_g‘_pgids
(&
¥gs
);

6737 ià(!
m
->
süub_pgs
.
	`em±y
()) {

6738 
veùÜ
<
¥g_t
> 
v
;

6739 autØ
pgid
 : 
m
->
süub_pgs
) {

6740 
¥g_t
 
pÿnd
;

6741 ià(
osdm­
->
	`g‘_´im¬y_sh¬d
(
pgid
, &
pÿnd
) &&

6742 
¡d
::
	`fšd
(
¥gs
.
	`begš
(), spgs.
	`’d
(), 
pÿnd
) != spgs.end()) {

6743 
v
.
	`push_back
(
pÿnd
);

6746 
¥gs
.
	`sw­
(
v
);

6749 autØ
pgid
 : 
¥gs
) {

6750 
	`’queue_³”šg_evt
(

6751 
pgid
,

6752 
	`PGP“ršgEv’tRef
(

6753 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

6754 
	`g‘_osdm­_•och
(),

6755 
	`g‘_osdm­_•och
(),

6756 
PG
::
	`Reque¡Süub
(
m
->
d“p
, m->
»·œ
))));

6759 
m
->
	`put
();

6760 
	}
}

6762 
	gOSD
::
	$hªdË_ç¡_süub
(
MOSDSüub2
 *
m
)

6764 
	`dout
(10è<< 
__func__
 << " " << *
m
 << 
d’dl
;

6765 ià(!
	`»quœe_mÚ_Ü_mgr_³”
(
m
)) {

6766 
m
->
	`put
();

6769 ià(
m
->
fsid
 !ğ
mÚc
->
	`g‘_fsid
()) {

6770 
	`dout
(0è<< 
__func__
 << " fsid " << 
m
->
fsid
 << " !ğ" << 
mÚc
->
	`g‘_fsid
()

6771 << 
d’dl
;

6772 
m
->
	`put
();

6775 autØ
pgid
 : 
m
->
süub_pgs
) {

6776 
	`’queue_³”šg_evt
(

6777 
pgid
,

6778 
	`PGP“ršgEv’tRef
(

6779 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

6780 
m
->
•och
,

6781 
m
->
•och
,

6782 
PG
::
	`Reque¡Süub
(
m
->
d“p
, m->
»·œ
))));

6784 
m
->
	`put
();

6785 
	}
}

6787 
boŞ
 
	gOSD
::
	$süub_¿ndom_backoff
()

6789 
boŞ
 
coš_æ
 = (
	`¿nd
(è/ ()
RAND_MAX
 >=

6790 
cù
->
_cÚf
->
osd_süub_backoff_¿tio
);

6791 ià(!
coš_æ
) {

6792 
	`dout
(20è<< "süub_¿ndom_backofàlo¡ coš fl,„ªdomly backšg off" << 
d’dl
;

6793  
Œue
;

6795  
çl£
;

6796 
	}
}

6798 
	gOSDS”viû
::
SüubJob
::
	$SüubJob
(
C•hCÚ‹xt
* 
cù
,

6799 cÚ¡ 
¥g_t
& 
pg
, cÚ¡ 
utime_t
& 
time¡amp
,

6800 
poŞ_süub_mš_š‹rv®
,

6801 
poŞ_süub_max_š‹rv®
, 
boŞ
 
mu¡
)

6802 : 
	`cù
(
cù
),

6803 
	`pgid
(
pg
),

6804 
	`sched_time
(
time¡amp
),

6805 
	$d—dlše
(
time¡amp
)

6808 ià(!
mu¡
) {

6809 
süub_mš_š‹rv®
 = 
poŞ_süub_mš_š‹rv®
 > 0 ?

6810 
poŞ_süub_mš_š‹rv®
 : 
cù
->
_cÚf
->
osd_süub_mš_š‹rv®
;

6811 
süub_max_š‹rv®
 = 
poŞ_süub_max_š‹rv®
 > 0 ?

6812 
poŞ_süub_max_š‹rv®
 : 
cù
->
_cÚf
->
osd_süub_max_š‹rv®
;

6814 
sched_time
 +ğ
süub_mš_š‹rv®
;

6815 
r
 = 
	`¿nd
(è/ ()
RAND_MAX
;

6816 
sched_time
 +=

6817 
süub_mš_š‹rv®
 * 
cù
->
_cÚf
->
osd_süub_š‹rv®_¿ndomize_¿tio
 * 
r
;

6818 ià(
süub_max_š‹rv®
 == 0) {

6819 
d—dlše
 = 
	`utime_t
();

6821 
d—dlše
 +ğ
süub_max_š‹rv®
;

6825 
	}
}

6827 
boŞ
 
	gOSDS”viû
::
SüubJob
::SüubJob::
İ”©Ü
<(cÚ¡ 
OSDS”viû
::SüubJob& 
rhs
) const {

6828 ià(
sched_time
 < 
rhs
.sched_time)

6829  
Œue
;

6830 ià(
	gsched_time
 > 
	grhs
.sched_time)

6831  
	gçl£
;

6832  
	gpgid
 < 
	grhs
.pgid;

6835 
boŞ
 
	gOSD
::
	$süub_time_³rm™
(
utime_t
 
now
)

6837 
tm
 
bdt
;

6838 
time_t
 
‰
 = 
now
.
	`£c
();

6839 
	`loÿÉime_r
(&
‰
, &
bdt
);

6841 
boŞ
 
day_³rm™
 = 
çl£
;

6842 ià(
cù
->
_cÚf
->
osd_süub_begš_w“k_day
 < cù->_cÚf->
osd_süub_’d_w“k_day
) {

6843 ià(
bdt
.
tm_wday
 >ğ
cù
->
_cÚf
->
osd_süub_begš_w“k_day
 && bdt.tm_wday < cù->_cÚf->
osd_süub_’d_w“k_day
) {

6844 
day_³rm™
 = 
Œue
;

6847 ià(
bdt
.
tm_wday
 >ğ
cù
->
_cÚf
->
osd_süub_begš_w“k_day
 || bdt.tm_wday < cù->_cÚf->
osd_süub_’d_w“k_day
) {

6848 
day_³rm™
 = 
Œue
;

6852 ià(!
day_³rm™
) {

6853 
	`dout
(20è<< 
__func__
 << " should„uÀb‘w“Àw“k day " << 
cù
->
_cÚf
->
osd_süub_begš_w“k_day


6854 << " - " << 
cù
->
_cÚf
->
osd_süub_’d_w“k_day


6855 << "‚ow " << 
bdt
.
tm_wday
 << " =‚o" << 
d’dl
;

6856  
çl£
;

6859 
boŞ
 
time_³rm™
 = 
çl£
;

6860 ià(
cù
->
_cÚf
->
osd_süub_begš_hour
 < cù->_cÚf->
osd_süub_’d_hour
) {

6861 ià(
bdt
.
tm_hour
 >ğ
cù
->
_cÚf
->
osd_süub_begš_hour
 && bdt.tm_hou¸< cù->_cÚf->
osd_süub_’d_hour
) {

6862 
time_³rm™
 = 
Œue
;

6865 ià(
bdt
.
tm_hour
 >ğ
cù
->
_cÚf
->
osd_süub_begš_hour
 || bdt.tm_hou¸< cù->_cÚf->
osd_süub_’d_hour
) {

6866 
time_³rm™
 = 
Œue
;

6869 ià(!
time_³rm™
) {

6870 
	`dout
(20è<< 
__func__
 << " should„uÀb‘w“À" << 
cù
->
_cÚf
->
osd_süub_begš_hour


6871 << " - " << 
cù
->
_cÚf
->
osd_süub_’d_hour


6872 << "‚ow " << 
bdt
.
tm_hour
 << " =‚o" << 
d’dl
;

6874 
	`dout
(20è<< 
__func__
 << " should„uÀb‘w“À" << 
cù
->
_cÚf
->
osd_süub_begš_hour


6875 << " - " << 
cù
->
_cÚf
->
osd_süub_’d_hour


6876 << "‚ow " << 
bdt
.
tm_hour
 << " = yes" << 
d’dl
;

6878  
time_³rm™
;

6879 
	}
}

6881 
boŞ
 
	gOSD
::
	$süub_lßd_b–ow_th»shŞd
()

6883 
lßdavgs
[3];

6884 ià(
	`g‘lßdavg
(
lßdavgs
, 3) != 3) {

6885 
	`dout
(10è<< 
__func__
 << " couldn'ˆ»ad†ßdavgs\n" << 
d’dl
;

6886  
çl£
;

6890 
ıus
 = 
	`syscÚf
(
_SC_NPROCESSORS_ONLN
);

6891 
lßdavg_³r_ıu
 = 
ıus
 > 0 ? 
lßdavgs
[0] / cpus :†oadavgs[0];

6892 ià(
lßdavg_³r_ıu
 < 
cù
->
_cÚf
->
osd_süub_lßd_th»shŞd
) {

6893 
	`dout
(20è<< 
__func__
 << "†ßdavg…” cpu " << 
lßdavg_³r_ıu


6894 << " < max " << 
cù
->
_cÚf
->
osd_süub_lßd_th»shŞd


6895 << " = yes" << 
d’dl
;

6896  
Œue
;

6900 ià(
lßdavgs
[0] < 
day_lßdavg
 &&†oadavgs[0] <†oadavgs[2]) {

6901 
	`dout
(20è<< 
__func__
 << "†ßdavg " << 
lßdavgs
[0]

6902 << " < day_lßdavg " << 
day_lßdavg


6903 << "‡nd < 15m‡vg " << 
lßdavgs
[2]

6904 << " = yes" << 
d’dl
;

6905  
Œue
;

6908 
	`dout
(20è<< 
__func__
 << "†ßdavg " << 
lßdavgs
[0]

6909 << " >ğmax " << 
cù
->
_cÚf
->
osd_süub_lßd_th»shŞd


6910 << "‡nd ( >ğday_lßdavg " << 
day_lßdavg


6911 << " o¸>ğ15m‡vg " << 
lßdavgs
[2]

6912 << "èğno" << 
d’dl
;

6913  
çl£
;

6914 
	}
}

6916 
	gOSD
::
	$sched_süub
()

6919 ià(!
£rviû
.
	`ÿn_šc_süubs_³ndšg
()) {

6922 ià(!
cù
->
_cÚf
->
osd_süub_duršg_»cov”y
 && 
£rviû
.
	`is_»cov”y_aùive
()) {

6923 
	`dout
(20è<< 
__func__
 << "‚Ù schedulšg süub dutØaùiv»cov”y" << 
d’dl
;

6928 
utime_t
 
now
 = 
	`ûph_şock_now
();

6929 
boŞ
 
time_³rm™
 = 
	`süub_time_³rm™
(
now
);

6930 
boŞ
 
lßd_is_low
 = 
	`süub_lßd_b–ow_th»shŞd
();

6931 
	`dout
(20è<< "sched_süub†ßd_is_low=" << ()
lßd_is_low
 << 
d’dl
;

6933 
OSDS”viû
::
SüubJob
 
süub
;

6934 ià(
£rviû
.
	`fœ¡_süub_¡amp
(&
süub
)) {

6936 
	`dout
(30è<< "sched_süubƒxamš" << 
süub
.
pgid
 << "‡ˆ" << süub.
sched_time
 << 
d’dl
;

6938 ià(
süub
.
sched_time
 > 
now
) {

6940 
	`dout
(10è<< "sched_süub " << 
süub
.
pgid
 << " scheduËd‡ˆ" << süub.
sched_time


6941 << " > " << 
now
 << 
d’dl
;

6945 ià((
süub
.
d—dlše
.
	`is_z”o
(è|| süub.d—dlš>ğ
now
è&& !(
time_³rm™
 && 
lßd_is_low
)) {

6946 
	`dout
(10è<< 
__func__
 << "‚Ù schedulšg süub fÜ " << 
süub
.
pgid
 << " dueo "

6947 << (!
time_³rm™
 ? "timnÙ…”m™" : "high†ßd"è<< 
d’dl
;

6951 
PGRef
 
pg
 = 
	`_lookup_lock_pg
(
süub
.
pgid
);

6952 ià(!
pg
)

6954 
	`dout
(10è<< "sched_süub süubbšg " << 
süub
.
pgid
 << "‡ˆ" << süub.
sched_time


6955 << (
pg
->
	`g‘_mu¡_süub
() ? ",ƒxplicitly„equested" :

6956 (
lßd_is_low
 ? ",†oad_is_low" : " deadline <‚ow"))

6957 << 
d’dl
;

6958 ià(
pg
->
	`sched_süub
()) {

6959 
pg
->
	`uÆock
();

6962 
pg
->
	`uÆock
();

6963 } 
£rviû
.
	`Ãxt_süub_¡amp
(
süub
, &scrub));

6965 
	`dout
(20è<< "sched_süub dÚe" << 
d’dl
;

6966 
	}
}

6968 
MPGSts
* 
	gOSD
::
	$cŞËù_pg_¡©s
()

6974 
RWLock
::
RLock”
 
	`l
(
m­_lock
);

6976 
utime_t
 
had_fÜ
 = 
	`ûph_şock_now
(è- 
had_m­_sšû
;

6977 
osd_¡©_t
 
cur_¡©
 = 
£rviû
.
	`g‘_osd_¡©
();

6978 
cur_¡©
.
os_³rf_¡©
 = 
¡Üe
->
	`g‘_cur_¡©s
();

6980 autØ
m
 = 
Ãw
 
	`MPGSts
(
mÚc
->
	`g‘_fsid
(), 
osdm­
->
	`g‘_•och
(), 
had_fÜ
);

6981 
m
->
osd_¡©
 = 
cur_¡©
;

6983 
Mu‹x
::
Lock”
 
Ëc
{
mš_Ï¡_•och_ş—n_lock
};

6984 
mš_Ï¡_•och_ş—n
 = 
osdm­
->
	`g‘_•och
();

6985 
mš_Ï¡_•och_ş—n_pgs
.
	`ş—r
();

6986 
veùÜ
<
PGRef
> 
pgs
;

6987 
	`_g‘_pgs
(&
pgs
);

6988 auto& 
pg
 : 
pgs
) {

6989 ià(!
pg
->
	`is_´im¬y
()) {

6992 
pg
->
	`g‘_pg_¡©s
([&](cÚ¡ 
pg_¡©_t
& 
s
, 
•och_t
 
Ëc
) {

6993 
m
->
pg_¡©
[
pg
->
pg_id
.
pgid
] = 
s
;

6994 
mš_Ï¡_•och_ş—n
 = 
	`mš
(mš_Ï¡_•och_ş—n, 
Ëc
);

6995 
mš_Ï¡_•och_ş—n_pgs
.
	`push_back
(
pg
->
pg_id
.
pgid
);

6999  
m
;

7000 
	}
}

7002 
	gveùÜ
<
	gD«mÚH—ÉhM‘ric
> 
	gOSD
::
	$g‘_h—Éh_m‘rics
()

7004 
veùÜ
<
D«mÚH—ÉhM‘ric
> 
m‘rics
;

7006 
utime_t
 
Şde¡_£cs
;

7007 cÚ¡ 
utime_t
 
now
 = 
	`ûph_şock_now
();

7008 autØ
too_Şd
 = 
now
;

7009 
too_Şd
 -ğ
cù
->
_cÚf
->
g‘_v®
<>("osd_op_complaint_time");

7010 
¦ow
 = 0;

7011 
T¿ckedOpRef
 
Şde¡_İ
;

7012 autØ
couÁ_¦ow_İs
 = [&](
T¿ckedOp
& 
İ
) {

7013 ià(
İ
.
	`g‘_š™Ÿ‹d
(è< 
too_Şd
) {

7014 
	`lg’”ic_subdout
(
cù
,
osd
,20è<< "¦ow o°" << 
İ
.
	`g‘_desc
()

7016 << 
İ
.
	`g‘_š™Ÿ‹d
(è<< 
d’dl
;

7017 
¦ow
++;

7018 ià(!
Şde¡_İ
 || 
İ
.
	`g‘_š™Ÿ‹d
() < oldest_op->get_initiated()) {

7019 
Şde¡_İ
 = &
İ
;

7021  
Œue
;

7023  
çl£
;

7026 ià(
İ_Œack”
.
	`vis™_İs_š_æight
(&
Şde¡_£cs
, 
couÁ_¦ow_İs
)) {

7027 ià(
¦ow
) {

7028 
d”r
 << 
__func__
 << "„•Ütšg " << 
¦ow
 << " slow ops, oldest is "

7029 << 
Şde¡_İ
->
	`g‘_desc
(è<< 
d’dl
;

7031 
m‘rics
.
	`em¶aû_back
(
d«mÚ_m‘ric
::
SLOW_OPS
, 
¦ow
, 
Şde¡_£cs
);

7034 
m‘rics
.
	`em¶aû_back
(
d«mÚ_m‘ric
::
SLOW_OPS
, 0, 0);

7037 
	`w™h_unique_lock
(
³ndšg_ü—‹s_lock
, [&]() {

7038 autØ
n_´im¬›s
 = 
³ndšg_ü—‹s_äom_mÚ
;

7039 cÚ¡‡uto& 
ü—‹
 : 
³ndšg_ü—‹s_äom_osd
) {

7040 ià(
ü—‹
.
£cÚd
) {

7041 
n_´im¬›s
++;

7044 
m‘rics
.
	`em¶aû_back
(
d«mÚ_m‘ric
::
PENDING_CREATING_PGS
, 
n_´im¬›s
);

7046  
m‘rics
;

7047 
	}
}

7052 
	gOSD
::
	$wa™_fÜ_Ãw_m­
(
OpReque¡Ref
 
İ
)

7055 ià(
wa™šg_fÜ_osdm­
.
	`em±y
()) {

7056 
	`osdm­_subsüibe
(
osdm­
->
	`g‘_•och
(è+ 1, 
çl£
);

7059 
logg”
->
	`šc
(
l_osd_wa™šg_fÜ_m­
);

7060 
wa™šg_fÜ_osdm­
.
	`push_back
(
İ
);

7061 
İ
->
	`m¬k_d–ayed
("wait for‚ew map");

7062 
	}
}

7069 
	gOSD
::
	$nÙe_down_osd
(
³”
)

7071 
	`as£¹
(
osd_lock
.
	`is_locked
());

7072 
şu¡”_mes£ng”
->
	`m¬k_down
(
osdm­
->
	`g‘_şu¡”_addr
(
³”
));

7074 
h—¹b—t_lock
.
	`Lock
();

7075 
çu»_queue
.
	`”a£
(
³”
);

7076 
çu»_³ndšg
.
	`”a£
(
³”
);

7077 
m­
<,
H—¹b—tInfo
>::
™”©Ü
 
p
 = 
h—¹b—t_³”s
.
	`fšd
(
³”
);

7078 ià(
p
 !ğ
h—¹b—t_³”s
.
	`’d
()) {

7079 
p
->
£cÚd
.
cÚ_back
->
	`m¬k_down
();

7080 ià(
p
->
£cÚd
.
cÚ_äÚt
) {

7081 
p
->
£cÚd
.
cÚ_äÚt
->
	`m¬k_down
();

7083 
h—¹b—t_³”s
.
	`”a£
(
p
);

7085 
h—¹b—t_lock
.
	`UÆock
();

7086 
	}
}

7088 
	gOSD
::
	$nÙe_up_osd
(
³”
)

7090 
£rviû
.
	`fÜg‘_³”_•och
(
³”
, 
osdm­
->
	`g‘_•och
() - 1);

7091 
	`h—¹b—t_£t_³”s_Ãed_upd©e
();

7092 
	}
}

7094 
	gC_OnM­Comm™
 : 
public
 
CÚ‹xt
 {

7095 
OSD
 *
osd
;

7096 
•och_t
 
	gfœ¡
, 
	gÏ¡
;

7097 
MOSDM­
 *
	gmsg
;

7098 
C_OnM­Comm™
(
OSD
 *
o
, 
•och_t
 
f
,ƒpoch_ˆ
l
, 
MOSDM­
 *
m
)

7099 : 
osd
(
o
), 
fœ¡
(
f
), 
Ï¡
(
l
), 
msg
(
m
) {}

7100 
fšish
(
r
è
	gov”ride
 {

7101 
	gosd
->
_comm™‹d_osd_m­s
(
fœ¡
, 
Ï¡
, 
msg
);

7102 
	gmsg
->
put
();

7106 
	gOSD
::
	$osdm­_subsüibe
(
v”siÚ_t
 
•och
, 
boŞ
 
fÜû_»que¡
)

7108 
Mu‹x
::
Lock”
 
	`l
(
osdm­_subsüibe_lock
);

7109 ià(
Ï‹¡_subsüibed_•och
 >ğ
•och
 && !
fÜû_»que¡
)

7112 
Ï‹¡_subsüibed_•och
 = 
¡d
::
max
<
ušt64_t
>(
•och
,†atest_subscribed_epoch);

7114 ià(
mÚc
->
	`sub_wªt_šüem’t
("osdm­", 
•och
, 
CEPH_SUBSCRIBE_ONETIME
) ||

7115 
fÜû_»que¡
) {

7116 
mÚc
->
	`»Ãw_subs
();

7118 
	}
}

7120 
	gOSD
::
	$Œim_m­s
(
•och_t
 
Şde¡
, 
Äeûived
, 
boŞ
 
sk_m­s
)

7122 
•och_t
 
mš
 = 
¡d
::
	`mš
(
Şde¡
, 
£rviû
.
m­_ÿche
.
	`ÿched_key_low”_bound
());

7123 ià(
mš
 <ğ
su³rblock
.
Şde¡_m­
)

7126 
num
 = 0;

7127 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

7128 
•och_t
 
e
 = 
su³rblock
.
Şde¡_m­
;ƒ < 
mš
; ++e) {

7129 
	`dout
(20è<< "„emovšg old osdm­ƒpoch " << 
e
 << 
d’dl
;

7130 
t
.
	`»move
(
cŞl_t
::
	`m‘a
(), 
	`g‘_osdm­_pobjeù_Çme
(
e
));

7131 
t
.
	`»move
(
cŞl_t
::
	`m‘a
(), 
	`g‘_šc_osdm­_pobjeù_Çme
(
e
));

7132 
su³rblock
.
Şde¡_m­
 = 
e
 + 1;

7133 
num
++;

7134 ià(
num
 >ğ
cù
->
_cÚf
->
osd_rg‘_Œª§ùiÚ_size
 &&‚um >ğ
Äeûived
) {

7135 
£rviû
.
	`publish_su³rblock
(
su³rblock
);

7136 
	`wr™e_su³rblock
(
t
);

7137 
Œ
 = 
¡Üe
->
	`queue_Œª§ùiÚ
(
£rviû
.
m‘a_ch
, 
¡d
::
	`move
(
t
), 
nuÎ±r
);

7138 
	`as£¹
(
Œ
 == 0);

7139 
num
 = 0;

7140 ià(!
sk_m­s
) {

7150 ià(
num
 > 0) {

7151 
£rviû
.
	`publish_su³rblock
(
su³rblock
);

7152 
	`wr™e_su³rblock
(
t
);

7153 
Œ
 = 
¡Üe
->
	`queue_Œª§ùiÚ
(
£rviû
.
m‘a_ch
, 
¡d
::
	`move
(
t
), 
nuÎ±r
);

7154 
	`as£¹
(
Œ
 == 0);

7157 
	`as£¹
(
mš
 <ğ
£rviû
.
m­_ÿche
.
	`ÿched_key_low”_bound
());

7158 
	}
}

7160 
	gOSD
::
	$hªdË_osd_m­
(
MOSDM­
 *
m
)

7162 
	`as£¹
(
osd_lock
.
	`is_locked
());

7169 
m­
<
•och_t
,
OSDM­Ref
> 
added_m­s
;

7170 
m­
<
•och_t
,
bufã¾i¡
> 
added_m­s_bl
;

7171 ià(
m
->
fsid
 !ğ
mÚc
->
	`g‘_fsid
()) {

7172 
	`dout
(0è<< "hªdË_osd_m­ fsid " << 
m
->
fsid
 << " != "

7173 << 
mÚc
->
	`g‘_fsid
(è<< 
d’dl
;

7174 
m
->
	`put
();

7177 ià(
	`is_š™Ÿlizšg
()) {

7178 
	`dout
(0è<< "ignÜšg osdm­ uÁ whavš™Ÿlized" << 
d’dl
;

7179 
m
->
	`put
();

7183 
SessiÚ
 *
£ssiÚ
 = 
¡©ic_ÿ¡
<SessiÚ *>(
m
->
	`g‘_cÚÃùiÚ
()->
	`g‘_´iv
());

7184 ià(
£ssiÚ
 && !(£ssiÚ->
’t™y_Çme
.
	`is_mÚ
() ||

7185 
£ssiÚ
->
’t™y_Çme
.
	`is_osd
())) {

7187 
	`dout
(10è<< "gÙ osd m­ from SessiÚ " << 
£ssiÚ


7188 << " which wÿn'ˆkm­ äom (nÙ‡ mÚ o¸osd)" << 
d’dl
;

7189 
m
->
	`put
();

7190 
£ssiÚ
->
	`put
();

7193 ià(
£ssiÚ
)

7194 
£ssiÚ
->
	`put
();

7197 ià(!
	`is_´eboÙ
())

7198 
£rviû
.
objeù”
->
	`hªdË_osd_m­
(
m
);

7200 
•och_t
 
fœ¡
 = 
m
->
	`g‘_fœ¡
();

7201 
•och_t
 
Ï¡
 = 
m
->
	`g‘_Ï¡
();

7202 
	`dout
(3è<< "hªdË_osd_m­ƒpoch [" << 
fœ¡
 << "," << 
Ï¡
 << "], i have "

7203 << 
su³rblock
.
Ãwe¡_m­


7204 << ", srøha [" << 
m
->
Şde¡_m­
 << "," << m->
Ãwe¡_m­
 << "]"

7205 << 
d’dl
;

7207 
logg”
->
	`šc
(
l_osd_m­
);

7208 
logg”
->
	`šc
(
l_osd_m­e
, 
Ï¡
 - 
fœ¡
 + 1);

7209 ià(
fœ¡
 <ğ
su³rblock
.
Ãwe¡_m­
)

7210 
logg”
->
	`šc
(
l_osd_m­e_dup
, 
su³rblock
.
Ãwe¡_m­
 - 
fœ¡
 + 1);

7211 ià(
£rviû
.
max_Şde¡_m­
 < 
m
->
Şde¡_m­
) {

7212 
£rviû
.
max_Şde¡_m­
 = 
m
->
Şde¡_m­
;

7213 
	`as£¹
(
£rviû
.
max_Şde¡_m­
 >ğ
su³rblock
.
Şde¡_m­
);

7218 ià(
Ï¡
 <ğ
su³rblock
.
Ãwe¡_m­
) {

7219 
	`dout
(10è<< "‚ØÃw m­ h”e, drİpšg" << 
d’dl
;

7220 
m
->
	`put
();

7225 
boŞ
 
sk_m­s
 = 
çl£
;

7226 ià(
fœ¡
 > 
su³rblock
.
Ãwe¡_m­
 + 1) {

7227 
	`dout
(10) << "handle_osd_map message skipsƒpochs "

7228 << 
su³rblock
.
Ãwe¡_m­
 + 1 << ".." << (
fœ¡
-1è<< 
d’dl
;

7229 ià(
m
->
Şde¡_m­
 <ğ
su³rblock
.
Ãwe¡_m­
 + 1) {

7230 
	`osdm­_subsüibe
(
su³rblock
.
Ãwe¡_m­
 + 1, 
çl£
);

7231 
m
->
	`put
();

7238 ià(
m
->
Şde¡_m­
 < 
fœ¡
) {

7239 
	`osdm­_subsüibe
(
m
->
Şde¡_m­
 - 1, 
Œue
);

7240 
m
->
	`put
();

7243 
sk_m­s
 = 
Œue
;

7252 
•och_t
 
max_Ïg
 = 
cù
->
_cÚf
->
osd_m­_ÿche_size
 *

7253 
m_osd_pg_•och_max_Ïg_çùÜ
;

7254 
	`as£¹
(
max_Ïg
 > 0);

7255 ià(
osdm­
->
	`g‘_•och
(è> 
max_Ïg
) {

7256 
•och_t
 
Ãed
 = 
osdm­
->
	`g‘_•och
(è- 
max_Ïg
;

7257 autØ
sh¬d
 : 
sh¬ds
) {

7258 
•och_t
 
mš
 = 
sh¬d
->
	`g‘_mš_pg_•och
();

7259 ià(
Ãed
 > 
mš
) {

7260 
	`dout
(10è<< 
__func__
 << " wa™šg fÜ…g tØcÚsum" << 
Ãed


7261 << " (sh¬d " << 
sh¬d
->
sh¬d_id
 << " mš " << 
mš


7262 << ", m­ cachi " << 
cù
->
_cÚf
->
osd_m­_ÿche_size


7263 << ", max_Ïg_çùÜ " << 
m_osd_pg_•och_max_Ïg_çùÜ


7264 << ")" << 
d’dl
;

7265 
sh¬d
->
	`wa™_mš_pg_•och
(
Ãed
);

7271 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

7272 
ušt64_t
 
txn_size
 = 0;

7275 
•och_t
 
¡¬t
 = 
¡d
::
	`max
(
su³rblock
.
Ãwe¡_m­
 + 1, 
fœ¡
);

7276 
•och_t
 
e
 = 
¡¬t
;ƒ <ğ
Ï¡
;ƒ++) {

7277 ià(
txn_size
 >ğ
t
.
	`g‘_num_by‹s
()) {

7278 
d”r
 << 
__func__
 << "¿n§ùiÚ sizov”æowed" << 
d’dl
;

7279 
	`as£¹
(
txn_size
 < 
t
.
	`g‘_num_by‹s
());

7281 
txn_size
 = 
t
.
	`g‘_num_by‹s
();

7282 
m­
<
•och_t
,
bufã¾i¡
>::
™”©Ü
 
p
;

7283 
p
 = 
m
->
m­s
.
	`fšd
(
e
);

7284 ià(
p
 !ğ
m
->
m­s
.
	`’d
()) {

7285 
	`dout
(10è<< "hªdË_osd_m­ gÙ fuÎ m­ fÜƒpoch " << 
e
 << 
d’dl
;

7286 
OSDM­
 *
o
 = 
Ãw
 OSDMap;

7287 
bufã¾i¡
& 
bl
 = 
p
->
£cÚd
;

7289 
o
->
	`decode
(
bl
);

7291 
ghobjeù_t
 
fuÎoid
 = 
	`g‘_osdm­_pobjeù_Çme
(
e
);

7292 
t
.
	`wr™e
(
cŞl_t
::
	`m‘a
(), 
fuÎoid
, 0, 
bl
.
	`Ëngth
(), bl);

7293 
added_m­s
[
e
] = 
	`add_m­
(
o
);

7294 
added_m­s_bl
[
e
] = 
bl
;

7295 
	`gÙ_fuÎ_m­
(
e
);

7299 
p
 = 
m
->
šüem’l_m­s
.
	`fšd
(
e
);

7300 ià(
p
 !ğ
m
->
šüem’l_m­s
.
	`’d
()) {

7301 
	`dout
(10è<< "hªdË_osd_m­ gÙ inøm­ fÜƒpoch " << 
e
 << 
d’dl
;

7302 
bufã¾i¡
& 
bl
 = 
p
->
£cÚd
;

7303 
ghobjeù_t
 
oid
 = 
	`g‘_šc_osdm­_pobjeù_Çme
(
e
);

7304 
t
.
	`wr™e
(
cŞl_t
::
	`m‘a
(), 
oid
, 0, 
bl
.
	`Ëngth
(), bl);

7306 
OSDM­
 *
o
 = 
Ãw
 OSDMap;

7307 ià(
e
 > 1) {

7308 
bufã¾i¡
 
obl
;

7309 
boŞ
 
gÙ
 = 
	`g‘_m­_bl
(
e
 - 1, 
obl
);

7310 ià(!
gÙ
) {

7311 autØ
p
 = 
added_m­s_bl
.
	`fšd
(
e
 - 1);

7312 
	`as£¹
(
p
 !ğ
added_m­s_bl
.
	`’d
());

7313 
obl
 = 
p
->
£cÚd
;

7315 
o
->
	`decode
(
obl
);

7318 
OSDM­
::
Inüem’l
 
šc
;

7319 
bufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
	`begš
();

7320 
šc
.
	`decode
(
p
);

7321 ià(
o
->
	`­¶y_šüem’l
(
šc
) < 0) {

7322 
d”r
 << "ERROR: bad fsid? i hav" << 
osdm­
->
	`g‘_fsid
(è<< "‡nd inøha " << 
šc
.
fsid
 << 
d’dl
;

7323 
	`as£¹
(0 == "bad fsid");

7326 
bufã¾i¡
 
fbl
;

7327 
o
->
	`’code
(
fbl
, 
šc
.
’code_ã©u»s
 | 
CEPH_FEATURE_RESERVED
);

7329 
boŞ
 
šjeùed_çu»
 = 
çl£
;

7330 ià(
cù
->
_cÚf
->
osd_šjeù_bad_m­_üc_´obab™y
 > 0 &&

7331 (
	`¿nd
(è% 10000è< 
cù
->
_cÚf
->
osd_šjeù_bad_m­_üc_´obab™y
*10000.0) {

7332 
d”r
 << 
__func__
 << " injeùšg m­ crøçu»" << 
d’dl
;

7333 
šjeùed_çu»
 = 
Œue
;

7336 ià((
šc
.
have_üc
 && 
o
->
	`g‘_üc
(è!ğšc.
fuÎ_üc
è|| 
šjeùed_çu»
) {

7337 
	`dout
(2è<< "gÙ inüem’È" << 
e


7339 << 
d’dl
;

7340 
şog
->
	`w¬n
(è<< "çedØ’codm­ƒ" << 
e
 << " withƒxpected crc";

7341 
	`dout
(20) << "myƒncoded map was:\n";

7342 
fbl
.
	`hexdump
(*
_dout
);

7343 *
_dout
 << 
d’dl
;

7344 
d–‘e
 
o
;

7345 
	`»que¡_fuÎ_m­
(
e
, 
Ï¡
);

7346 
Ï¡
 = 
e
 - 1;

7349 
	`gÙ_fuÎ_m­
(
e
);

7351 
ghobjeù_t
 
fuÎoid
 = 
	`g‘_osdm­_pobjeù_Çme
(
e
);

7352 
t
.
	`wr™e
(
cŞl_t
::
	`m‘a
(), 
fuÎoid
, 0, 
fbl
.
	`Ëngth
(), fbl);

7353 
added_m­s
[
e
] = 
	`add_m­
(
o
);

7354 
added_m­s_bl
[
e
] = 
fbl
;

7358 
	`as£¹
(0 == "MOSDMap†ied‡bout what maps it had?");

7362 
mÚc
->
	`sub_gÙ
("osdm­", 
Ï¡
);

7364 ià(!
m
->
m­s
.
	`em±y
(è&& 
»que¡ed_fuÎ_fœ¡
) {

7365 
	`dout
(10è<< 
__func__
 << " stÈmissšg fuÎ m­ " << 
»que¡ed_fuÎ_fœ¡


7366 << ".." << 
»que¡ed_fuÎ_Ï¡
 << 
d’dl
;

7367 
	`»»que¡_fuÎ_m­s
();

7370 ià(
su³rblock
.
Şde¡_m­
) {

7372 
	`Œim_m­s
(
m
->
Şde¡_m­
, 
Ï¡
 - 
fœ¡
 + 1, 
sk_m­s
);

7375 ià(!
su³rblock
.
Şde¡_m­
 || 
sk_m­s
)

7376 
su³rblock
.
Şde¡_m­
 = 
fœ¡
;

7377 
su³rblock
.
Ãwe¡_m­
 = 
Ï¡
;

7378 
su³rblock
.
cu¼’t_•och
 = 
Ï¡
;

7381 
•och_t
 
boÙ_•och
 = 
£rviû
.
	`g‘_boÙ_•och
();

7382 ià(
boÙ_•och
 && boÙ_•och >ğ
su³rblock
.
mouÁed
) {

7383 
su³rblock
.
mouÁed
 = 
boÙ_•och
;

7384 
su³rblock
.
ş—n_thru
 = 
Ï¡
;

7388 
OSDM­Ref
 
Ï¡m­
;

7389 auto& 
i
 : 
added_m­s
) {

7390 ià(!
Ï¡m­
) {

7391 
Ï¡m­
 = 
	`g‘_m­
(
i
.
fœ¡
 - 1);

7393 
	`as£¹
(
Ï¡m­
->
	`g‘_•och
(è+ 1 =ğ
i
.
£cÚd
->get_epoch());

7394 auto& 
j
 : 
Ï¡m­
->
	`g‘_poŞs
()) {

7395 ià(!
i
.
£cÚd
->
	`have_pg_poŞ
(
j
.
fœ¡
)) {

7396 
	`dout
(10è<< 
__func__
 << "„ecording final…g_pool_t for…ool "

7397 << 
j
.
fœ¡
 << 
d’dl
;

7400 
ghobjeù_t
 
obj
 = 
	`make_fš®_poŞ_šfo_oid
(
j
.
fœ¡
);

7401 
bufã¾i¡
 
bl
;

7402 
	`’code
(
j
.
£cÚd
, 
bl
, 
CEPH_FEATURES_ALL
);

7403 
¡ršg
 
Çme
 = 
Ï¡m­
->
	`g‘_poŞ_Çme
(
j
.
fœ¡
);

7404 
	`’code
(
Çme
, 
bl
);

7405 
m­
<
¡ršg
,¡ršg> 
´ofe
;

7406 ià(
Ï¡m­
->
	`g‘_pg_poŞ
(
j
.
fœ¡
)->
	`is_”asu»
()) {

7407 
´ofe
 = 
Ï¡m­
->
	`g‘_”asu»_code_´ofe
(

7408 
Ï¡m­
->
	`g‘_pg_poŞ
(
j
.
fœ¡
)->
”asu»_code_´ofe
);

7410 
	`’code
(
´ofe
, 
bl
);

7411 
t
.
	`wr™e
(
cŞl_t
::
	`m‘a
(), 
obj
, 0, 
bl
.
	`Ëngth
(), bl);

7412 
£rviû
.
	`¡Üe_d–‘ed_poŞ_pg_num
(
j
.
fœ¡
, j.
£cÚd
.
	`g‘_pg_num
());

7415 
Ï¡m­
 = 
i
.
£cÚd
;

7419 
	`wr™e_su³rblock
(
t
);

7420 
t
.
	`»gi¡”_Ú_comm™
(
Ãw
 
	`C_OnM­Comm™
(
this
, 
¡¬t
, 
Ï¡
, 
m
));

7421 
¡Üe
->
	`queue_Œª§ùiÚ
(

7422 
£rviû
.
m‘a_ch
,

7423 
¡d
::
	`move
(
t
));

7424 
£rviû
.
	`publish_su³rblock
(
su³rblock
);

7425 
	}
}

7427 
	gOSD
::
	$_comm™‹d_osd_m­s
(
•och_t
 
fœ¡
,ƒpoch_ˆ
Ï¡
, 
MOSDM­
 *
m
)

7429 
	`dout
(10è<< 
__func__
 << " " << 
fœ¡
 << ".." << 
Ï¡
 << 
d’dl
;

7430 ià(
	`is_¡İpšg
()) {

7431 
	`dout
(10è<< 
__func__
 << " bašg, w¬shu‰šg down" << 
d’dl
;

7434 
Mu‹x
::
Lock”
 
	`l
(
osd_lock
);

7435 ià(
	`is_¡İpšg
()) {

7436 
	`dout
(10è<< 
__func__
 << " bašg, w¬shu‰šg down" << 
d’dl
;

7439 
m­_lock
.
	`g‘_wr™e
();

7441 
boŞ
 
do_shutdown
 = 
çl£
;

7442 
boŞ
 
do_»¡¬t
 = 
çl£
;

7443 
boŞ
 
ÃtwÜk_”rÜ
 = 
çl£
;

7446 
•och_t
 
cur
 = 
fœ¡
; cu¸<ğ
Ï¡
; cur++) {

7447 
	`dout
(10è<< "‡dvªûØ•och " << 
cur


7448 << " (<ğÏ¡ " << 
Ï¡


7449 << " <ğÃwe¡_m­ " << 
su³rblock
.
Ãwe¡_m­


7450 << ")" << 
d’dl
;

7452 
OSDM­Ref
 
Ãwm­
 = 
	`g‘_m­
(
cur
);

7453 
	`as£¹
(
Ãwm­
);

7456 
£rviû
.
	`´e_publish_m­
(
Ãwm­
);

7459 
boŞ
 
wa™ed_fÜ_»£rv©iÚs
 = 
çl£
;

7460 
£t
<> 
Şd
;

7461 
osdm­
->
	`g‘_®l_osds
(
Şd
);

7462 
£t
<>::
™”©Ü
 
p
 = 
Şd
.
	`begš
();… !ğŞd.
	`’d
(); ++p) {

7463 ià(*
p
 !ğ
whßmi
 &&

7464 
osdm­
->
	`is_up
(*
p
) &&

7465 
Ãwm­
->
	`is_down
(*
p
)) {

7466 ià(!
wa™ed_fÜ_»£rv©iÚs
) {

7467 
£rviû
.
	`awa™_»£rved_m­s
();

7468 
wa™ed_fÜ_»£rv©iÚs
 = 
Œue
;

7470 
	`nÙe_down_osd
(*
p
);

7471 } ià(*
p
 !ğ
whßmi
 &&

7472 
osdm­
->
	`is_down
(*
p
) &&

7473 
Ãwm­
->
	`is_up
(*
p
)) {

7474 
	`nÙe_up_osd
(*
p
);

7478 ià((
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_NOUP
) !=

7479 
Ãwm­
->
	`‹¡_æag
(
CEPH_OSDMAP_NOUP
)) ||

7480 (
osdm­
->
	`is_noup
(
whßmi
è!ğ
Ãwm­
->is_noup(whoami))) {

7481 
	`dout
(10è<< 
__func__
 << " NOUP fÏg chªged iÀ" << 
Ãwm­
->
	`g‘_•och
()

7482 << 
d’dl
;

7483 ià(
	`is_boÙšg
()) {

7490 
do_»¡¬t
 = 
Œue
;

7494 
osdm­
 = 
Ãwm­
;

7495 
•och_t
 
up_•och
;

7496 
•och_t
 
boÙ_•och
;

7497 
£rviû
.
	`»Œ›ve_•ochs
(&
boÙ_•och
, &
up_•och
, 
NULL
);

7498 ià(!
up_•och
 &&

7499 
osdm­
->
	`is_up
(
whßmi
) &&

7500 
osdm­
->
	`g‘_š¡
(
whßmi
è=ğ
ş›Á_mes£ng”
->
	`g‘_myš¡
()) {

7501 
up_•och
 = 
osdm­
->
	`g‘_•och
();

7502 
	`dout
(10è<< "up_•och i " << 
up_•och
 << 
d’dl
;

7503 ià(!
boÙ_•och
) {

7504 
boÙ_•och
 = 
osdm­
->
	`g‘_•och
();

7505 
	`dout
(10è<< "boÙ_•och i " << 
boÙ_•och
 << 
d’dl
;

7507 
£rviû
.
	`£t_•ochs
(&
boÙ_•och
, &
up_•och
, 
NULL
);

7511 
had_m­_sšû
 = 
	`ûph_şock_now
();

7513 
•och_t
 
_bšd_•och
 = 
£rviû
.
	`g‘_bšd_•och
();

7514 ià(
osdm­
->
	`is_up
(
whßmi
) &&

7515 
osdm­
->
	`g‘_addr
(
whßmi
è=ğ
ş›Á_mes£ng”
->
	`g‘_myaddr
() &&

7516 
_bšd_•och
 < 
osdm­
->
	`g‘_up_äom
(
whßmi
)) {

7518 ià(
	`is_boÙšg
()) {

7519 
	`dout
(1è<< "¡©e: boÙšg ->‡ùive" << 
d’dl
;

7520 
	`£t_¡©e
(
STATE_ACTIVE
);

7521 
do_»¡¬t
 = 
çl£
;

7525 
£rviû
.
objeù”
->
	`£t_ş›Á_šÿº©iÚ
(
osdm­
->
	`g‘_•och
());

7529 ià(
osdm­
->
	`g‘_•och
() > 0 &&

7530 
	`is_aùive
()) {

7531 ià(!
osdm­
->
	`exi¡s
(
whßmi
)) {

7532 
	`dout
(0è<< "m­ say ˜dØnÙƒxi¡. shu‰šg down." << 
d’dl
;

7533 
do_shutdown
 = 
Œue
;

7535 } ià(!
osdm­
->
	`is_up
(
whßmi
) ||

7536 !
osdm­
->
	`g‘_addr
(
whßmi
).
	`´obably_equ®s
(

7537 
ş›Á_mes£ng”
->
	`g‘_myaddr
()) ||

7538 !
osdm­
->
	`g‘_şu¡”_addr
(
whßmi
).
	`´obably_equ®s
(

7539 
şu¡”_mes£ng”
->
	`g‘_myaddr
()) ||

7540 !
osdm­
->
	`g‘_hb_back_addr
(
whßmi
).
	`´obably_equ®s
(

7541 
hb_back_£rv”_mes£ng”
->
	`g‘_myaddr
()) ||

7542 (
osdm­
->
	`g‘_hb_äÚt_addr
(
whßmi
è!ğ
	`’t™y_addr_t
() &&

7543 !
osdm­
->
	`g‘_hb_äÚt_addr
(
whßmi
).
	`´obably_equ®s
(

7544 
hb_äÚt_£rv”_mes£ng”
->
	`g‘_myaddr
()))) {

7545 ià(!
osdm­
->
	`is_up
(
whßmi
)) {

7546 ià(
£rviû
.
	`is_´•¬šg_to_¡İ
(è|| s”viû.
	`is_¡İpšg
()) {

7547 
£rviû
.
	`gÙ_¡İ_ack
();

7549 
şog
->
	`w¬n
(è<< "MÚ™Ü d«mÚ m¬ked osd." << 
whßmi
 << " down, "

7551 
şog
->
	`debug
(è<< "m­ƒ" << 
osdm­
->
	`g‘_•och
()

7553 << 
osdm­
->
	`g‘_down_©
(
whßmi
);

7555 } ià(!
osdm­
->
	`g‘_addr
(
whßmi
).
	`´obably_equ®s
(

7556 
ş›Á_mes£ng”
->
	`g‘_myaddr
())) {

7557 
şog
->
	`”rÜ
(è<< "m­ƒ" << 
osdm­
->
	`g‘_•och
()

7558 << " had wrÚg cl›Á‡dd¸(" << 
osdm­
->
	`g‘_addr
(
whßmi
)

7559 << " !ğmy " << 
ş›Á_mes£ng”
->
	`g‘_myaddr
() << ")";

7560 } ià(!
osdm­
->
	`g‘_şu¡”_addr
(
whßmi
).
	`´obably_equ®s
(

7561 
şu¡”_mes£ng”
->
	`g‘_myaddr
())) {

7562 
şog
->
	`”rÜ
(è<< "m­ƒ" << 
osdm­
->
	`g‘_•och
()

7564 << 
osdm­
->
	`g‘_şu¡”_addr
(
whßmi
)

7565 << " !ğmy " << 
şu¡”_mes£ng”
->
	`g‘_myaddr
() << ")";

7566 } ià(!
osdm­
->
	`g‘_hb_back_addr
(
whßmi
).
	`´obably_equ®s
(

7567 
hb_back_£rv”_mes£ng”
->
	`g‘_myaddr
())) {

7568 
şog
->
	`”rÜ
(è<< "m­ƒ" << 
osdm­
->
	`g‘_•och
()

7570 << 
osdm­
->
	`g‘_hb_back_addr
(
whßmi
)

7571 << " !ğmy " << 
hb_back_£rv”_mes£ng”
->
	`g‘_myaddr
()

7573 } ià(
osdm­
->
	`g‘_hb_äÚt_addr
(
whßmi
è!ğ
	`’t™y_addr_t
() &&

7574 !
osdm­
->
	`g‘_hb_äÚt_addr
(
whßmi
).
	`´obably_equ®s
(

7575 
hb_äÚt_£rv”_mes£ng”
->
	`g‘_myaddr
())) {

7576 
şog
->
	`”rÜ
(è<< "m­ƒ" << 
osdm­
->
	`g‘_•och
()

7578 << 
osdm­
->
	`g‘_hb_äÚt_addr
(
whßmi
)

7579 << " !ğmy " << 
hb_äÚt_£rv”_mes£ng”
->
	`g‘_myaddr
()

7583 ià(!
£rviû
.
	`is_¡İpšg
()) {

7584 
•och_t
 
up_•och
 = 0;

7585 
•och_t
 
bšd_•och
 = 
osdm­
->
	`g‘_•och
();

7586 
£rviû
.
	`£t_•ochs
(
NULL
,&
up_•och
, &
bšd_•och
);

7587 
do_»¡¬t
 = 
Œue
;

7590 
utime_t
 
now
 = 
	`ûph_şock_now
();

7591 
utime_t
 
g¿û
 = 
	`utime_t
(
cù
->
_cÚf
->
osd_max_m¬kdown_³riod
, 0);

7592 
osd_m¬kdown_log
.
	`push_back
(
now
);

7594 !
osd_m¬kdown_log
.
	`em±y
() &&

7595 
osd_m¬kdown_log
.
	`äÚt
(è+ 
g¿û
 < 
now
)

7596 
osd_m¬kdown_log
.
	`pİ_äÚt
();

7597 ià(()
osd_m¬kdown_log
.
	`size
(è> 
cù
->
_cÚf
->
osd_max_m¬kdown_couÁ
) {

7598 
	`dout
(0è<< 
__func__
 << " marked down "

7599 << 
osd_m¬kdown_log
.
	`size
()

7601 << 
cù
->
_cÚf
->
osd_max_m¬kdown_couÁ


7602 << " iÀÏ¡ " << 
g¿û
 << " seconds, shutting down"

7603 << 
d’dl
;

7604 
do_»¡¬t
 = 
çl£
;

7605 
do_shutdown
 = 
Œue
;

7608 
	`¡¬t_wa™šg_fÜ_h—Éhy
();

7610 
£t
<> 
avoid_pÜts
;

7611 #ià
	`defšed
(
__F»eBSD__
)

7615 
avoid_pÜts
.
	`š£¹
(
ş›Á_mes£ng”
->
	`g‘_myaddr
().
	`g‘_pÜt
());

7617 
avoid_pÜts
.
	`š£¹
(
şu¡”_mes£ng”
->
	`g‘_myaddr
().
	`g‘_pÜt
());

7618 
avoid_pÜts
.
	`š£¹
(
hb_back_£rv”_mes£ng”
->
	`g‘_myaddr
().
	`g‘_pÜt
());

7619 
avoid_pÜts
.
	`š£¹
(
hb_äÚt_£rv”_mes£ng”
->
	`g‘_myaddr
().
	`g‘_pÜt
());

7621 
r
 = 
şu¡”_mes£ng”
->
	`»bšd
(
avoid_pÜts
);

7622 ià(
r
 != 0) {

7623 
do_shutdown
 = 
Œue
;

7624 
ÃtwÜk_”rÜ
 = 
Œue
;

7625 
	`dout
(0è<< 
__func__
 << " marked down:"

7626 << "„ebšd clu¡”_mes£ng” faed" << 
d’dl
;

7629 
r
 = 
hb_back_£rv”_mes£ng”
->
	`»bšd
(
avoid_pÜts
);

7630 ià(
r
 != 0) {

7631 
do_shutdown
 = 
Œue
;

7632 
ÃtwÜk_”rÜ
 = 
Œue
;

7633 
	`dout
(0è<< 
__func__
 << " marked down:"

7634 << "„ebšd hb_back_£rv”_mes£ng” faed" << 
d’dl
;

7637 
r
 = 
hb_äÚt_£rv”_mes£ng”
->
	`»bšd
(
avoid_pÜts
);

7638 ià(
r
 != 0) {

7639 
do_shutdown
 = 
Œue
;

7640 
ÃtwÜk_”rÜ
 = 
Œue
;

7641 
	`dout
(0è<< 
__func__
 << " marked down:"

7642 << "„ebšd hb_äÚt_£rv”_mes£ng” faed" << 
d’dl
;

7645 
hb_äÚt_ş›Á_mes£ng”
->
	`m¬k_down_®l
();

7646 
hb_back_ş›Á_mes£ng”
->
	`m¬k_down_®l
();

7648 
	`»£t_h—¹b—t_³”s
();

7653 
m­_lock
.
	`put_wr™e
();

7655 
	`check_osdm­_ã©u»s
();

7658 
	`cÚsume_m­
();

7660 ià(
	`is_aùive
(è|| 
	`is_wa™šg_fÜ_h—Éhy
())

7661 
	`maybe_upd©e_h—¹b—t_³”s
();

7663 ià(!
	`is_aùive
()) {

7664 
	`dout
(10è<< "‚Ù y‘‡ùive; wa™šg fÜ…“ršg wÜkØd¿š" << 
d’dl
;

7665 autØ
sh¬d
 : 
sh¬ds
) {

7666 
sh¬d
->
	`wa™_mš_pg_•och
(
Ï¡
);

7669 
	`aùiv©e_m­
();

7672 ià(
do_shutdown
) {

7673 ià(
ÃtwÜk_”rÜ
) {

7674 
Mu‹x
::
Lock”
 
	`l
(
h—¹b—t_lock
);

7675 
m­
<,
·œ
<
utime_t
,
’t™y_š¡_t
>>::
™”©Ü
 
™
 =

7676 
çu»_³ndšg
.
	`begš
();

7677 
™
 !ğ
çu»_³ndšg
.
	`’d
()) {

7678 
	`dout
(10) << "handle_osd_ping canceling in-flight failure„eport for osd."

7679 << 
™
->
fœ¡
 << 
d’dl
;

7680 
	`£nd_¡l_®ive
(
osdm­
->
	`g‘_•och
(), 
™
->
£cÚd
.second);

7681 
çu»_³ndšg
.
	`”a£
(
™
++);

7685 
	`dout
(0è<< 
__func__
 << " shutdowÀOSD vŸ‡synøsigÇl" << 
d’dl
;

7686 
	`queue_async_sigÇl
(
SIGINT
);

7688 ià(
m
->
Ãwe¡_m­
 && m->Ãwe¡_m­ > 
Ï¡
) {

7689 
	`dout
(10è<< " msg say‚ewe¡ m­ i " << 
m
->
Ãwe¡_m­


7690 << ",„eque¡šg mÜe" << 
d’dl
;

7691 
	`osdm­_subsüibe
(
osdm­
->
	`g‘_•och
()+1, 
çl£
);

7693 ià(
	`is_´eboÙ
()) {

7694 ià(
m
->
	`g‘_sourû
().
	`is_mÚ
())

7695 
	`_´eboÙ
(
m
->
Şde¡_m­
, m->
Ãwe¡_m­
);

7697 
	`¡¬t_boÙ
();

7699 ià(
do_»¡¬t
)

7700 
	`¡¬t_boÙ
();

7702 
	}
}

7704 
	gOSD
::
	$check_osdm­_ã©u»s
()

7716 
Mes£ng”
::
PŞicy
 
p
 = 
ş›Á_mes£ng”
->
	`g‘_deçuÉ_pŞicy
();

7717 
ušt64_t
 
mask
;

7718 
ušt64_t
 
ã©u»s
 = 
osdm­
->
	`g‘_ã©u»s
(
’t™y_Çme_t
::
TYPE_CLIENT
, &
mask
);

7719 ià((
p
.
ã©u»s_»quœed
 & 
mask
è!ğ
ã©u»s
) {

7720 
	`dout
(0è<< "üush m­ ha ã©u» " << 
ã©u»s


7721 << ",‡dju¡šg msg¸»quœe fÜ cl›Ás" << 
d’dl
;

7722 
p
.
ã©u»s_»quœed
 = (p.ã©u»s_»quœed & ~
mask
è| 
ã©u»s
;

7723 
ş›Á_mes£ng”
->
	`£t_deçuÉ_pŞicy
(
p
);

7727 
Mes£ng”
::
PŞicy
 
p
 = 
ş›Á_mes£ng”
->
	`g‘_pŞicy
(
’t™y_Çme_t
::
TYPE_MON
);

7728 
ušt64_t
 
mask
;

7729 
ušt64_t
 
ã©u»s
 = 
osdm­
->
	`g‘_ã©u»s
(
’t™y_Çme_t
::
TYPE_MON
, &
mask
);

7730 ià((
p
.
ã©u»s_»quœed
 & 
mask
è!ğ
ã©u»s
) {

7731 
	`dout
(0è<< "üush m­ ha ã©u» " << 
ã©u»s


7732 << " wa " << 
p
.
ã©u»s_»quœed


7733 << ",‡dju¡šg msg¸»quœe fÜ mÚs" << 
d’dl
;

7734 
p
.
ã©u»s_»quœed
 = (p.ã©u»s_»quœed & ~
mask
è| 
ã©u»s
;

7735 
ş›Á_mes£ng”
->
	`£t_pŞicy
(
’t™y_Çme_t
::
TYPE_MON
, 
p
);

7739 
Mes£ng”
::
PŞicy
 
p
 = 
şu¡”_mes£ng”
->
	`g‘_pŞicy
(
’t™y_Çme_t
::
TYPE_OSD
);

7740 
ušt64_t
 
mask
;

7741 
ušt64_t
 
ã©u»s
 = 
osdm­
->
	`g‘_ã©u»s
(
’t™y_Çme_t
::
TYPE_OSD
, &
mask
);

7743 ià((
p
.
ã©u»s_»quœed
 & 
mask
è!ğ
ã©u»s
) {

7744 
	`dout
(0è<< "üush m­ ha ã©u» " << 
ã©u»s


7745 << ",‡dju¡šg msg¸»quœe fÜ osds" << 
d’dl
;

7746 
p
.
ã©u»s_»quœed
 = (p.ã©u»s_»quœed & ~
mask
è| 
ã©u»s
;

7747 
şu¡”_mes£ng”
->
	`£t_pŞicy
(
’t™y_Çme_t
::
TYPE_OSD
, 
p
);

7750 ià(!
su³rblock
.
com·t_ã©u»s
.
šcom·t
.
	`cÚšs
(
CEPH_OSD_FEATURE_INCOMPAT_SHARDS
)) {

7751 
	`dout
(0è<< 
__func__
 << "ƒÇblšg on-disk ERASURE CODES com·ˆã©u»" << 
d’dl
;

7752 
su³rblock
.
com·t_ã©u»s
.
šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_SHARDS
);

7753 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

7754 
	`wr™e_su³rblock
(
t
);

7755 
”r
 = 
¡Üe
->
	`queue_Œª§ùiÚ
(
£rviû
.
m‘a_ch
, 
¡d
::
	`move
(
t
), 
NULL
);

7756 
	`as£¹
(
”r
 == 0);

7759 
	}
}

7761 
	gC_FšishS¶™s
 : 
public
 
CÚ‹xt
 {

7762 
OSD
 *
osd
;

7763 
	g£t
<
	gPGRef
> 
	gpgs
;

7764 
C_FšishS¶™s
(
OSD
 *
osd
, cÚ¡ 
£t
<
PGRef
> &
š
)

7765 : 
osd
(osd), 
pgs
(
š
) {}

7766 
fšish
(
r
è
	gov”ride
 {

7767 
	gosd
->
_fšish_¥l™s
(
pgs
);

7771 
	gOSD
::
_fšish_¥l™s
(
£t
<
PGRef
>& 
pgs
)

7773 
dout
(10è<< 
__func__
 << " " << 
pgs
 << 
d’dl
;

7774 
	gMu‹x
::
Lock”
 
l
(
osd_lock
);

7775 ià(
is_¡İpšg
())

7777 
	gPG
::
Recov”yCtx
 
rùx
 = 
ü—‹_cÚ‹xt
();

7778 
	g£t
<
	gPGRef
>::
™”©Ü
 
i
 = 
pgs
.
begš
();

7779 
	gi
 !ğ
pgs
.
’d
();

7780 ++
	gi
) {

7781 
PG
 *
	gpg
 = 
i
->
g‘
();

7783 
	gpg
->
lock
();

7784 
dout
(10è<< 
	g__func__
 << " " << *
	gpg
 << 
	gd’dl
;

7785 
•och_t
 
	ge
 = 
pg
->
g‘_osdm­_•och
();

7786 
	gpg
->
hªdË_š™Ÿlize
(&
rùx
);

7787 
	gpg
->
queue_nuÎ
(
e
,ƒ);

7788 
di¥©ch_cÚ‹xt_Œª§ùiÚ
(
rùx
, 
pg
);

7789 
	gpg
->
uÆock
();

7791 
	gsh¬d_šdex
 = 
pg
->
pg_id
.
hash_to_sh¬d
(
num_sh¬ds
);

7792 
	gsh¬ds
[
sh¬d_šdex
]->
»gi¡”_ªd_wake_¥l™_chd
(
pg
);

7795 
di¥©ch_cÚ‹xt
(
rùx
, 0, 
£rviû
.
g‘_osdm­
());

7798 
	gOSD
::
	$advªû_pg
(

7799 
•och_t
 
osd_•och
, 
PG
 *
pg
,

7800 
Th»adPoŞ
::
TPHªdË
 &
hªdË
,

7801 
PG
::
Recov”yCtx
 *
rùx
)

7803 
	`as£¹
(
pg
->
	`is_locked
());

7804 
OSDM­Ref
 
Ï¡m­
 = 
pg
->
	`g‘_osdm­
();

7805 
	`as£¹
(
Ï¡m­
->
	`g‘_•och
(è< 
osd_•och
);

7806 
£t
<
PGRef
> 
Ãw_pgs
;

7807 
•och_t
 
Ãxt_•och
 = 
pg
->
	`g‘_osdm­_•och
() + 1;

7808 
Ãxt_•och
 <ğ
osd_•och
;

7809 ++
Ãxt_•och
) {

7810 
OSDM­Ref
 
Ãxtm­
 = 
£rviû
.
	`Œy_g‘_m­
(
Ãxt_•och
);

7811 ià(!
Ãxtm­
) {

7812 
	`dout
(20è<< 
__func__
 << " missšg m­ " << 
Ãxt_•och
 << 
d’dl
;

7816 
veùÜ
<> 
Ãwup
, 
Ãwaùšg
;

7817 
up_´im¬y
, 
aùšg_´im¬y
;

7818 
Ãxtm­
->
	`pg_to_up_aùšg_osds
(

7819 
pg
->
pg_id
.
pgid
,

7820 &
Ãwup
, &
up_´im¬y
,

7821 &
Ãwaùšg
, &
aùšg_´im¬y
);

7822 
pg
->
	`hªdË_advªû_m­
(

7823 
Ãxtm­
, 
Ï¡m­
, 
Ãwup
, 
up_´im¬y
,

7824 
Ãwaùšg
, 
aùšg_´im¬y
, 
rùx
);

7827 
£t
<
¥g_t
> 
chd»n
;

7828 
¥g_t
 
	`·»Á
(
pg
->
pg_id
);

7829 ià(
Ãxtm­
->
	`have_pg_poŞ
(
pg
->
pg_id
.
	`poŞ
()) &&

7830 
·»Á
.
	`is_¥l™
(

7831 
Ï¡m­
->
	`g‘_pg_num
(
pg
->
pg_id
.
	`poŞ
()),

7832 
Ãxtm­
->
	`g‘_pg_num
(
pg
->
pg_id
.
	`poŞ
()),

7833 &
chd»n
)) {

7834 
	`¥l™_pgs
(

7835 
pg
, 
chd»n
, &
Ãw_pgs
, 
Ï¡m­
, 
Ãxtm­
,

7836 
rùx
);

7839 
Ï¡m­
 = 
Ãxtm­
;

7840 
hªdË
.
	`»£t__timeout
();

7842 
pg
->
	`hªdË_aùiv©e_m­
(
rùx
);

7844 ià(!
Ãw_pgs
.
	`em±y
()) {

7845 
rùx
->
Œª§ùiÚ
->
	`»gi¡”_Ú_­¶›d
(
Ãw
 
	`C_FšishS¶™s
(
this
, 
Ãw_pgs
));

7847 
	}
}

7849 
	gOSD
::
	$cÚsume_m­
()

7851 
	`as£¹
(
osd_lock
.
	`is_locked
());

7852 
	`dout
(7è<< "cÚsume_m­ v”siÚ " << 
osdm­
->
	`g‘_•och
(è<< 
d’dl
;

7858 ià(!
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_SORTBITWISE
è&& 
	`is_aùive
()) {

7859 
d”r
 << 
__func__
 << " SORTBITWISE fÏg i nÙ s‘" << 
d’dl
;

7860 
	`ûph_abÜt
();

7863 
£rviû
.
	`´e_publish_m­
(
osdm­
);

7864 
£rviû
.
	`awa™_»£rved_m­s
();

7865 
£rviû
.
	`publish_m­
(
osdm­
);

7868 
£t
<
¥g_t
> 
Ãwly_¥l™
;

7869 auto& 
sh¬d
 : 
sh¬ds
) {

7870 
sh¬d
->
	`id’tify_¥l™s
(
osdm­
, &
Ãwly_¥l™
);

7872 ià(!
Ãwly_¥l™
.
	`em±y
()) {

7873 auto& 
sh¬d
 : 
sh¬ds
) {

7874 
sh¬d
->
	`´ime_¥l™s
(
osdm­
, &
Ãwly_¥l™
);

7876 
	`as£¹
(
Ãwly_¥l™
.
	`em±y
());

7879 
pushes_to_ä“
 = 0;

7880 auto& 
sh¬d
 : 
sh¬ds
) {

7881 
sh¬d
->
	`cÚsume_m­
(
osdm­
, &
pushes_to_ä“
);

7884 
veùÜ
<
¥g_t
> 
pgids
;

7885 
	`_g‘_pgids
(&
pgids
);

7888 
num_pg_´im¬y
 = 0, 
num_pg_»¶iÿ
 = 0, 
num_pg_¡¿y
 = 0;

7889 
veùÜ
<
PGRef
> 
pgs
;

7890 
	`_g‘_pgs
(&
pgs
);

7891 auto& 
pg
 : 
pgs
) {

7894 ià(
pg
->
	`is_´im¬y
())

7895 
num_pg_´im¬y
++;

7896 ià(
pg
->
	`is_»¶iÿ
())

7897 
num_pg_»¶iÿ
++;

7899 
num_pg_¡¿y
++;

7904 [[
gnu
::
unu£d
]]‡uto&& 
³ndšg_ü—‹_lock”
 = 
	`gu¬dedly_lock
(
³ndšg_ü—‹s_lock
);

7905 autØ
pg
 = 
³ndšg_ü—‹s_äom_osd
.
	`cbegš
();

7906 
pg
 !ğ
³ndšg_ü—‹s_äom_osd
.
	`ûnd
();) {

7907 ià(
osdm­
->
	`g‘_pg_aùšg_¿nk
(
pg
->
fœ¡
, 
whßmi
) < 0) {

7908 
pg
 = 
³ndšg_ü—‹s_äom_osd
.
	`”a£
(pg);

7910 ++
pg
;

7915 
£rviû
.
	`maybe_šjeù_di¥©ch_d–ay
();

7917 
	`di¥©ch_£ssiÚs_wa™šg_Ú_m­
();

7919 
£rviû
.
	`maybe_šjeù_di¥©ch_d–ay
();

7921 
£rviû
.
	`»Ëa£_»£rved_pushes
(
pushes_to_ä“
);

7924 autØ
pgid
 : 
pgids
) {

7925 
	`’queue_³”šg_evt
(

7926 
pgid
,

7927 
	`PGP“ršgEv’tRef
(

7928 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

7929 
osdm­
->
	`g‘_•och
(),

7930 
osdm­
->
	`g‘_•och
(),

7931 
	`NuÎEvt
())));

7933 
logg”
->
	`£t
(
l_osd_pg
, 
pgids
.
	`size
());

7934 
logg”
->
	`£t
(
l_osd_pg_´im¬y
, 
num_pg_´im¬y
);

7935 
logg”
->
	`£t
(
l_osd_pg_»¶iÿ
, 
num_pg_»¶iÿ
);

7936 
logg”
->
	`£t
(
l_osd_pg_¡¿y
, 
num_pg_¡¿y
);

7937 
	}
}

7939 
	gOSD
::
	$aùiv©e_m­
()

7941 
	`as£¹
(
osd_lock
.
	`is_locked
());

7943 
	`dout
(7è<< "aùiv©e_m­ v”siÚ " << 
osdm­
->
	`g‘_•och
(è<< 
d’dl
;

7945 ià(
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_FULL
)) {

7946 
	`dout
(10è<< " osdm­ fÏgged fuÎ, došg oÃtimosdm­ subsüibe" << 
d’dl
;

7947 
	`osdm­_subsüibe
(
osdm­
->
	`g‘_•och
(è+ 1, 
çl£
);

7951 ià(
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_NORECOVER
)) {

7952 ià(!
£rviû
.
	`»cov”y_is_·u£d
()) {

7953 
	`dout
(1è<< "·usšg„ecov”y (NORECOVER fÏg s‘)" << 
d’dl
;

7954 
£rviû
.
	`·u£_»cov”y
();

7957 ià(
£rviû
.
	`»cov”y_is_·u£d
()) {

7958 
	`dout
(1è<< "uÅausšg„ecov”y (NORECOVER fÏg un£t)" << 
d’dl
;

7959 
£rviû
.
	`uÅau£_»cov”y
();

7963 
£rviû
.
	`aùiv©e_m­
();

7966 
	`ke_wa™”s
(
wa™šg_fÜ_osdm­
);

7967 
	}
}

7969 
boŞ
 
	gOSD
::
	$»quœe_mÚ_³”
(cÚ¡ 
Mes§ge
 *
m
)

7971 ià(!
m
->
	`g‘_cÚÃùiÚ
()->
	`³”_is_mÚ
()) {

7972 
	`dout
(0) << "require_mon_peer„eceived from‚on-mon "

7973 << 
m
->
	`g‘_cÚÃùiÚ
()->
	`g‘_³”_addr
()

7974 << " " << *
m
 << 
d’dl
;

7975  
çl£
;

7977  
Œue
;

7978 
	}
}

7980 
boŞ
 
	gOSD
::
	$»quœe_mÚ_Ü_mgr_³”
(cÚ¡ 
Mes§ge
 *
m
)

7982 ià(!
m
->
	`g‘_cÚÃùiÚ
()->
	`³”_is_mÚ
() &&

7983 !
m
->
	`g‘_cÚÃùiÚ
()->
	`³”_is_mgr
()) {

7984 
	`dout
(0) << "require_mon_or_mgr_peer„eceived from‚on-mon,‚on-mgr "

7985 << 
m
->
	`g‘_cÚÃùiÚ
()->
	`g‘_³”_addr
()

7986 << " " << *
m
 << 
d’dl
;

7987  
çl£
;

7989  
Œue
;

7990 
	}
}

7992 
boŞ
 
	gOSD
::
	$»quœe_osd_³”
(cÚ¡ 
Mes§ge
 *
m
)

7994 ià(!
m
->
	`g‘_cÚÃùiÚ
()->
	`³”_is_osd
()) {

7995 
	`dout
(0) << "require_osd_peer„eceived from‚on-osd "

7996 << 
m
->
	`g‘_cÚÃùiÚ
()->
	`g‘_³”_addr
()

7997 << " " << *
m
 << 
d’dl
;

7998  
çl£
;

8000  
Œue
;

8001 
	}
}

8003 
boŞ
 
	gOSD
::
	$»quœe_£lf_®iv’ess
(cÚ¡ 
Mes§ge
 *
m
, 
•och_t
 
•och
)

8005 
•och_t
 
up_•och
 = 
£rviû
.
	`g‘_up_•och
();

8006 ià(
•och
 < 
up_•och
) {

8007 
	`dout
(7è<< "äom…»-u°•och " << 
•och
 << " < " << 
up_•och
 << 
d’dl
;

8008  
çl£
;

8011 ià(!
	`is_aùive
()) {

8012 
	`dout
(7è<< "¡Èš boÙ s‹, drİpšg mes§g" << *
m
 << 
d’dl
;

8013  
çl£
;

8016  
Œue
;

8017 
	}
}

8019 
boŞ
 
	gOSD
::
	$»quœe_§me_³”_š¡ªû
(cÚ¡ 
Mes§ge
 *
m
, 
OSDM­Ref
& 
m­
,

8020 
boŞ
 
is_ç¡_di¥©ch
)

8022 
äom
 = 
m
->
	`g‘_sourû
().
	`num
();

8024 ià(
m­
->
	`is_down
(
äom
) ||

8025 (
m­
->
	`g‘_şu¡”_addr
(
äom
è!ğ
m
->
	`g‘_sourû_š¡
().
addr
)) {

8026 
	`dout
(5è<< "äom d—d osd." << 
äom
 << ", marking down, "

8027 << " msg wa " << 
m
->
	`g‘_sourû_š¡
().
addr


8028 << "ƒx³ùed " << (
m­
->
	`is_up
(
äom
) ?

8029 
m­
->
	`g‘_şu¡”_addr
(
äom
è: 
	`’t™y_addr_t
())

8030 << 
d’dl
;

8031 
CÚÃùiÚRef
 
cÚ
 = 
m
->
	`g‘_cÚÃùiÚ
();

8032 
cÚ
->
	`m¬k_down
();

8033 
SessiÚ
 *
s
 = 
¡©ic_ÿ¡
<SessiÚ*>(
cÚ
->
	`g‘_´iv
());

8034 ià(
s
) {

8035 ià(!
is_ç¡_di¥©ch
)

8036 
s
->
£ssiÚ_di¥©ch_lock
.
	`Lock
();

8037 
	`ş—r_£ssiÚ_wa™šg_Ú_m­
(
s
);

8038 
cÚ
->
	`£t_´iv
(
NULL
);

8039 ià(!
is_ç¡_di¥©ch
)

8040 
s
->
£ssiÚ_di¥©ch_lock
.
	`UÆock
();

8041 
s
->
	`put
();

8043  
çl£
;

8045  
Œue
;

8046 
	}
}

8053 
boŞ
 
	gOSD
::
	$»quœe_§me_Ü_Ãw”_m­
(
OpReque¡Ref
& 
İ
, 
•och_t
 
•och
,

8054 
boŞ
 
is_ç¡_di¥©ch
)

8056 cÚ¡ 
Mes§ge
 *
m
 = 
İ
->
	`g‘_»q
();

8057 
	`dout
(15è<< "»quœe_§me_Ü_Ãw”_m­ " << 
•och


8058 << " (˜am " << 
osdm­
->
	`g‘_•och
(è<< "è" << 
m
 << 
d’dl
;

8060 
	`as£¹
(
osd_lock
.
	`is_locked
());

8063 ià(
•och
 > 
osdm­
->
	`g‘_•och
()) {

8064 
	`dout
(7è<< "wa™šg fÜ‚ew” m­ƒpoch " << 
•och


8065 << " > my " << 
osdm­
->
	`g‘_•och
(è<< " w™h " << 
m
 << 
d’dl
;

8066 
	`wa™_fÜ_Ãw_m­
(
İ
);

8067  
çl£
;

8070 ià(!
	`»quœe_£lf_®iv’ess
(
İ
->
	`g‘_»q
(), 
•och
)) {

8071  
çl£
;

8075 ià(
m
->
	`g‘_cÚÃùiÚ
()->
	`g‘_mes£ng”
(è=ğ
şu¡”_mes£ng”
 &&

8076 !
	`»quœe_§me_³”_š¡ªû
(
İ
->
	`g‘_»q
(), 
osdm­
, 
is_ç¡_di¥©ch
)) {

8077  
çl£
;

8080  
Œue
;

8081 
	}
}

8090 
	gOSD
::
¥l™_pgs
(

8091 
PG
 *
·»Á
,

8092 cÚ¡ 
£t
<
¥g_t
> &
chdpgids
, s‘<
PGRef
> *
out_pgs
,

8093 
OSDM­Ref
 
curm­
,

8094 
OSDM­Ref
 
Ãxtm­
,

8095 
PG
::
Recov”yCtx
 *
rùx
)

8097 
pg_num
 = 
Ãxtm­
->
g‘_pg_num
(
·»Á
->
pg_id
.
poŞ
());

8098 
	g·»Á
->
upd©e_¢­_m­³r_b™s
(
·»Á
->
g‘_pgid
().
g‘_¥l™_b™s
(
pg_num
));

8100 
	gveùÜ
<
	gobjeù_¡©_sum_t
> 
	gupd©ed_¡©s
;

8101 
	g·»Á
->
¡¬t_¥l™_¡©s
(
chdpgids
, &
upd©ed_¡©s
);

8103 
	gveùÜ
<
	gobjeù_¡©_sum_t
>::
™”©Ü
 
¡©_™”
 = 
upd©ed_¡©s
.
begš
();

8104 
	g£t
<
	g¥g_t
>::
cÚ¡_™”©Ü
 
i
 = 
chdpgids
.
begš
();

8105 
	gi
 !ğ
chdpgids
.
’d
();

8106 ++
	gi
, ++
	g¡©_™”
) {

8107 
as£¹
(
¡©_™”
 !ğ
upd©ed_¡©s
.
’d
());

8108 
dout
(10è<< 
	g__func__
 << " s¶™tšg " << *
	g·»Á
 << " iÁØ" << *
	gi
 << 
	gd’dl
;

8109 
PG
* 
	gchd
 = 
_make_pg
(
Ãxtm­
, *
i
);

8110 
	gchd
->
lock
(
Œue
);

8111 
	gout_pgs
->
š£¹
(
chd
);

8112 
	gchd
->
	gch
 = 
¡Üe
->
ü—‹_Ãw_cŞËùiÚ
(
chd
->
cŞl
);

8114 
	g¥l™_b™s
 = 
i
->
g‘_¥l™_b™s
(
pg_num
);

8115 
dout
(10è<< "…g_num i " << 
	gpg_num


8116 << ", m_£ed " << 
	gi
->
ps
()

8117 << ", s¶™_b™ i " << 
	g¥l™_b™s
 << 
	gd’dl
;

8118 
	g·»Á
->
¥l™_cŞls
(

8119 *
i
,

8120 
¥l™_b™s
,

8121 
i
->
ps
(),

8122 &
chd
->
g‘_poŞ
().
šfo
,

8123 
rùx
->
Œª§ùiÚ
);

8124 
	g·»Á
->
¥l™_što
(

8125 
i
->
pgid
,

8126 
chd
,

8127 
¥l™_b™s
);

8129 
	gchd
->
fšish_¥l™_¡©s
(*
¡©_™”
, 
rùx
->
Œª§ùiÚ
);

8130 
	gchd
->
uÆock
();

8132 
as£¹
(
¡©_™”
 !ğ
upd©ed_¡©s
.
’d
());

8133 
	g·»Á
->
fšish_¥l™_¡©s
(*
¡©_™”
, 
rùx
->
Œª§ùiÚ
);

8139 
	gOSD
::
	$hªdË_pg_ü—‹
(
OpReque¡Ref
 
İ
)

8141 cÚ¡ 
MOSDPGC»©e
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDPGC»©e*>(
İ
->
	`g‘_»q
());

8142 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
MSG_OSD_PG_CREATE
);

8144 
	`dout
(10è<< "hªdË_pg_ü—‹ " << *
m
 << 
d’dl
;

8146 ià(!
	`»quœe_mÚ_³”
(
İ
->
	`g‘_»q
())) {

8150 ià(!
	`»quœe_§me_Ü_Ãw”_m­
(
İ
, 
m
->
•och
, 
çl£
))

8153 
İ
->
	`m¬k_¡¬‹d
();

8155 
m­
<
pg_t
,
utime_t
>::
cÚ¡_™”©Ü
 
ci
 = 
m
->
ùimes
.
	`begš
();

8156 
m­
<
pg_t
,
pg_ü—‹_t
>::
cÚ¡_™”©Ü
 
p
 = 
m
->
mkpg
.
	`begš
();

8157 
p
 !ğ
m
->
mkpg
.
	`’d
();

8158 ++
p
, ++
ci
) {

8159 
	`as£¹
(
ci
 !ğ
m
->
ùimes
.
	`’d
(è&& ci->
fœ¡
 =ğ
p
->first);

8160 
•och_t
 
ü—‹d
 = 
p
->
£cÚd
.created;

8161 ià(
p
->
£cÚd
.
¥l™_b™s
)

8163 
pg_t
 
Ú
 = 
p
->
fœ¡
;

8165 ià(!
osdm­
->
	`have_pg_poŞ
(
Ú
.
	`poŞ
())) {

8166 
	`dout
(20è<< "ignÜšg…g oÀd–‘ed…oŞ " << 
Ú
 << 
d’dl
;

8170 
	`dout
(20è<< "mkpg " << 
Ú
 << "ƒ" << 
ü—‹d
 << "@" << 
ci
->
£cÚd
 << 
d’dl
;

8173 
veùÜ
<> 
up
, 
aùšg
;

8174 
up_´im¬y
 = -1;

8175 
aùšg_´im¬y
 = -1;

8176 
osdm­
->
	`pg_to_up_aùšg_osds
(
Ú
, &
up
, &
up_´im¬y
, &
aùšg
, &
aùšg_´im¬y
);

8177 
rŞe
 = 
osdm­
->
	`ÿlc_pg_rŞe
(
whßmi
, 
aùšg
,‡ùšg.
	`size
());

8179 ià(
aùšg_´im¬y
 !ğ
whßmi
) {

8180 
	`dout
(10è<< "mkpg " << 
Ú
 << "‚Ù‡ùšg_´im¬y (" << 
aùšg_´im¬y


8181 << "), my„Şe=" << 
rŞe
 << ", skpšg" << 
d’dl
;

8185 
¥g_t
 
pgid
;

8186 
boŞ
 
m­³d
 = 
osdm­
->
	`g‘_´im¬y_sh¬d
(
Ú
, &
pgid
);

8187 
	`as£¹
(
m­³d
);

8189 
Pa¡IÁ”v®s
 
pi
;

8190 
pg_hi¡Üy_t
 
hi¡Üy
;

8191 
	`bud_š™Ÿl_pg_hi¡Üy
(
pgid
, 
ü—‹d
, 
ci
->
£cÚd
, &
hi¡Üy
, &
pi
);

8196 ià(
hi¡Üy
.
§me_´im¬y_sšû
 > 
m
->
•och
) {

8197 
	`dout
(10è<< 
__func__
 << ": got obsolete…g create on…gid "

8198 << 
pgid
 << " fromƒpoch " << 
m
->
•och


8199 << ",…rim¬y chªged iÀ" << 
hi¡Üy
.
§me_´im¬y_sšû


8200 << 
d’dl
;

8203 
	`’queue_³”šg_evt
(

8204 
pgid
,

8205 
	`PGP“ršgEv’tRef
(

8206 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

8207 
osdm­
->
	`g‘_•och
(),

8208 
osdm­
->
	`g‘_•och
(),

8209 
	`NuÎEvt
(),

8210 
Œue
,

8211 
Ãw
 
	`PGC»©eInfo
(

8212 
pgid
,

8213 
osdm­
->
	`g‘_•och
(),

8214 
hi¡Üy
,

8215 
pi
,

8216 
Œue
)

8220 
	`w™h_unique_lock
(
³ndšg_ü—‹s_lock
, [=]() {

8221 ià(
³ndšg_ü—‹s_äom_mÚ
 == 0) {

8222 
Ï¡_pg_ü—‹_•och
 = 
m
->
•och
;

8226 
	`maybe_upd©e_h—¹b—t_³”s
();

8227 
	}
}

8233 
	gPG
::
Recov”yCtx
 
OSD
::
	$ü—‹_cÚ‹xt
()

8235 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
 = 
Ãw
 ObjectStore::Transaction;

8236 
m­
<, m­<
¥g_t
,
pg_qu”y_t
> > *
qu”y_m­
 =

8237 
Ãw
 
m­
<, m­<
¥g_t
, 
pg_qu”y_t
> >;

8238 
m­
<,
veùÜ
<
·œ
<
pg_nÙify_t
, 
Pa¡IÁ”v®s
> > > *
nÙify_li¡
 =

8239 
Ãw
 
m­
<, 
veùÜ
<
·œ
<
pg_nÙify_t
, 
Pa¡IÁ”v®s
> > >;

8240 
m­
<,
veùÜ
<
·œ
<
pg_nÙify_t
, 
Pa¡IÁ”v®s
> > > *
šfo_m­
 =

8241 
Ãw
 
m­
<,
veùÜ
<
·œ
<
pg_nÙify_t
, 
Pa¡IÁ”v®s
> > >;

8242 
PG
::
Recov”yCtx
 
	`rùx
(
qu”y_m­
, 
šfo_m­
, 
nÙify_li¡
, 
t
);

8243  
rùx
;

8244 
	}
}

8246 
	gOSD
::
	$di¥©ch_cÚ‹xt_Œª§ùiÚ
(
PG
::
Recov”yCtx
 &
ùx
, PG *
pg
,

8247 
Th»adPoŞ
::
TPHªdË
 *
hªdË
)

8249 ià(!
ùx
.
Œª§ùiÚ
->
	`em±y
(è|| ctx.Œª§ùiÚ->
	`has_cÚ‹xts
()) {

8250 
Œ
 = 
¡Üe
->
	`queue_Œª§ùiÚ
(

8251 
pg
->
ch
,

8252 
¡d
::
	`move
(*
ùx
.
Œª§ùiÚ
), 
	`T¿ckedOpRef
(), 
hªdË
);

8253 
	`as£¹
(
Œ
 == 0);

8254 
	`d–‘e
 (
ùx
.
Œª§ùiÚ
);

8255 
ùx
.
Œª§ùiÚ
 = 
Ãw
 
ObjeùStÜe
::
T¿n§ùiÚ
;

8257 
	}
}

8259 
	gOSD
::
	$di¥©ch_cÚ‹xt
(
PG
::
Recov”yCtx
 &
ùx
, PG *
pg
, 
OSDM­Ref
 
curm­
,

8260 
Th»adPoŞ
::
TPHªdË
 *
hªdË
)

8262 ià(!
£rviû
.
	`g‘_osdm­
()->
	`is_up
(
whßmi
)) {

8263 
	`dout
(20è<< 
__func__
 << "‚Ù u°š osdm­" << 
d’dl
;

8264 } ià(!
	`is_aùive
()) {

8265 
	`dout
(20è<< 
__func__
 << "‚Ù‡ùive" << 
d’dl
;

8267 
	`do_nÙif›s
(*
ùx
.
nÙify_li¡
, 
curm­
);

8268 
	`do_qu”›s
(*
ùx
.
qu”y_m­
, 
curm­
);

8269 
	`do_šfos
(*
ùx
.
šfo_m­
, 
curm­
);

8271 ià((!
ùx
.
Œª§ùiÚ
->
	`em±y
(è|| ctx.Œª§ùiÚ->
	`has_cÚ‹xts
()è&& 
pg
) {

8272 
Œ
 = 
¡Üe
->
	`queue_Œª§ùiÚ
(

8273 
pg
->
ch
,

8274 
¡d
::
	`move
(*
ùx
.
Œª§ùiÚ
), 
	`T¿ckedOpRef
(),

8275 
hªdË
);

8276 
	`as£¹
(
Œ
 == 0);

8278 
d–‘e
 
ùx
.
nÙify_li¡
;

8279 
d–‘e
 
ùx
.
qu”y_m­
;

8280 
d–‘e
 
ùx
.
šfo_m­
;

8281 
d–‘e
 
ùx
.
Œª§ùiÚ
;

8282 
	}
}

8284 
	gOSD
::
	$disÿrd_cÚ‹xt
(
PG
::
Recov”yCtx
& 
ùx
)

8286 
d–‘e
 
ùx
.
nÙify_li¡
;

8287 
d–‘e
 
ùx
.
qu”y_m­
;

8288 
d–‘e
 
ùx
.
šfo_m­
;

8289 
d–‘e
 
ùx
.
Œª§ùiÚ
;

8290 
	}
}

8298 
	gOSD
::
do_nÙif›s
(

8299 
m­
<,
veùÜ
<
·œ
<
pg_nÙify_t
,
Pa¡IÁ”v®s
> > >& 
nÙify_li¡
,

8300 
OSDM­Ref
 
curm­
)

8302 
	gm­
<,

8303 
	gveùÜ
<
	g·œ
<
	gpg_nÙify_t
,
	gPa¡IÁ”v®s
> > >::
™”©Ü
 
™
 =

8304 
nÙify_li¡
.
begš
();

8305 
	g™
 !ğ
nÙify_li¡
.
’d
();

8306 ++
	g™
) {

8307 ià(!
	gcurm­
->
is_up
(
™
->
fœ¡
)) {

8308 
dout
(20è<< 
	g__func__
 << " skpšg dowÀosd." << 
	g™
->
	gfœ¡
 << 
	gd’dl
;

8311 
CÚÃùiÚRef
 
	gcÚ
 = 
£rviû
.
g‘_cÚ_osd_şu¡”
(

8312 
™
->
fœ¡
, 
curm­
->
g‘_•och
());

8313 ià(!
	gcÚ
) {

8314 
dout
(20è<< 
	g__func__
 << " skpšg osd." << 
	g™
->
	gfœ¡


8315 << " (NULL cÚ)" << 
	gd’dl
;

8318 
	g£rviû
.
sh¬e_m­_³”
(
™
->
fœ¡
, 
cÚ
.
g‘
(), 
curm­
);

8319 
dout
(7è<< 
	g__func__
 << " osd." << 
	g™
->
	gfœ¡


8320 << " oÀ" << 
	g™
->
	g£cÚd
.
size
(è<< " PGs" << 
	gd’dl
;

8321 
MOSDPGNÙify
 *
	gm
 = 
Ãw
 MOSDPGNÙify(
curm­
->
g‘_•och
(),

8322 
™
->
£cÚd
);

8323 
	gcÚ
->
£nd_mes§ge
(
m
);

8331 
	gOSD
::
do_qu”›s
(
m­
<, m­<
¥g_t
,
pg_qu”y_t
> >& 
qu”y_m­
,

8332 
OSDM­Ref
 
curm­
)

8334 
	gm­
<, m­<
	g¥g_t
,
	gpg_qu”y_t
> >::
™”©Ü
 
p™
 = 
qu”y_m­
.
begš
();

8335 
	gp™
 !ğ
qu”y_m­
.
’d
();

8336 ++
	gp™
) {

8337 ià(!
	gcurm­
->
is_up
(
p™
->
fœ¡
)) {

8338 
dout
(20è<< 
	g__func__
 << " skpšg dowÀosd." << 
	gp™
->
	gfœ¡
 << 
	gd’dl
;

8341 
	gwho
 = 
p™
->
fœ¡
;

8342 
CÚÃùiÚRef
 
	gcÚ
 = 
£rviû
.
g‘_cÚ_osd_şu¡”
(
who
, 
curm­
->
g‘_•och
());

8343 ià(!
	gcÚ
) {

8344 
dout
(20è<< 
	g__func__
 << " skpšg osd." << 
	gwho


8345 << " (NULL cÚ)" << 
	gd’dl
;

8348 
	g£rviû
.
sh¬e_m­_³”
(
who
, 
cÚ
.
g‘
(), 
curm­
);

8349 
dout
(7è<< 
	g__func__
 << " qu”yšg osd." << 
	gwho


8350 << " oÀ" << 
	gp™
->
	g£cÚd
.
size
(è<< " PGs" << 
	gd’dl
;

8351 
MOSDPGQu”y
 *
	gm
 = 
Ãw
 MOSDPGQu”y(
curm­
->
g‘_•och
(), 
p™
->
£cÚd
);

8352 
	gcÚ
->
£nd_mes§ge
(
m
);

8357 
	gOSD
::
do_šfos
(
m­
<,

8358 
veùÜ
<
·œ
<
pg_nÙify_t
, 
Pa¡IÁ”v®s
> > >& 
šfo_m­
,

8359 
OSDM­Ref
 
curm­
)

8361 
	gm­
<,

8362 
	gveùÜ
<
	g·œ
<
	gpg_nÙify_t
, 
	gPa¡IÁ”v®s
> > >::
™”©Ü
 
p
 =

8363 
šfo_m­
.
begš
();

8364 
	gp
 !ğ
šfo_m­
.
’d
();

8365 ++
	gp
) {

8366 ià(!
	gcurm­
->
is_up
(
p
->
fœ¡
)) {

8367 
dout
(20è<< 
	g__func__
 << " skpšg dowÀosd." << 
	gp
->
	gfœ¡
 << 
	gd’dl
;

8370 
	gveùÜ
<
	g·œ
<
	gpg_nÙify_t
,
	gPa¡IÁ”v®s
> >::
™”©Ü
 
i
 = 
p
->
£cÚd
.
begš
();

8371 
	gi
 !ğ
p
->
£cÚd
.
’d
();

8372 ++
	gi
) {

8373 
dout
(20è<< 
	g__func__
 << " s’dšg infØ" << 
	gi
->
	gfœ¡
.
	gšfo


8374 << "Øsh¬d " << 
	gp
->
	gfœ¡
 << 
	gd’dl
;

8376 
CÚÃùiÚRef
 
	gcÚ
 = 
£rviû
.
g‘_cÚ_osd_şu¡”
(

8377 
p
->
fœ¡
, 
curm­
->
g‘_•och
());

8378 ià(!
	gcÚ
) {

8379 
dout
(20è<< 
	g__func__
 << " skpšg osd." << 
	gp
->
	gfœ¡


8380 << " (NULL cÚ)" << 
	gd’dl
;

8383 
	g£rviû
.
sh¬e_m­_³”
(
p
->
fœ¡
, 
cÚ
.
g‘
(), 
curm­
);

8384 
MOSDPGInfo
 *
	gm
 = 
Ãw
 MOSDPGInfo(
curm­
->
g‘_•och
());

8385 
	gm
->
	gpg_li¡
 = 
p
->
£cÚd
;

8386 
	gcÚ
->
£nd_mes§ge
(
m
);

8388 
	gšfo_m­
.
ş—r
();

8391 
	gOSD
::
	$hªdË_ç¡_pg_ü—‹
(
MOSDPGC»©e2
 *
m
)

8393 
	`dout
(7è<< 
__func__
 << " " << *
m
 << " from " << m->
	`g‘_sourû
(è<< 
d’dl
;

8394 ià(!
	`»quœe_mÚ_³”
(
m
)) {

8395 
m
->
	`put
();

8398 auto& 
p
 : 
m
->
pgs
) {

8399 
¥g_t
 
pgid
 = 
p
.
fœ¡
;

8400 
•och_t
 
ü—‹d
 = 
p
.
£cÚd
.
fœ¡
;

8401 
utime_t
 
ü—‹d_¡amp
 = 
p
.
£cÚd
.second;

8402 
	`dout
(20è<< 
__func__
 << " " << 
pgid
 << "ƒ" << 
ü—‹d


8403 << "@" << 
ü—‹d_¡amp
 << 
d’dl
;

8405 
pg_hi¡Üy_t
 
h
;

8406 
h
.
•och_ü—‹d
 = 
ü—‹d
;

8407 
h
.
•och_poŞ_ü—‹d
 = 
ü—‹d
;

8408 
h
.
§me_up_sšû
 = 
ü—‹d
;

8409 
h
.
§me_š‹rv®_sšû
 = 
ü—‹d
;

8410 
h
.
§me_´im¬y_sšû
 = 
ü—‹d
;

8411 
h
.
Ï¡_süub_¡amp
 = 
ü—‹d_¡amp
;

8412 
h
.
Ï¡_d“p_süub_¡amp
 = 
ü—‹d_¡amp
;

8413 
h
.
Ï¡_ş—n_süub_¡amp
 = 
ü—‹d_¡amp
;

8415 
	`’queue_³”šg_evt
(

8416 
pgid
,

8417 
	`PGP“ršgEv’tRef
(

8418 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

8419 
m
->
•och
,

8420 
m
->
•och
,

8421 
	`NuÎEvt
(),

8422 
Œue
,

8423 
Ãw
 
	`PGC»©eInfo
(

8424 
pgid
,

8425 
ü—‹d
,

8426 
h
,

8427 
	`Pa¡IÁ”v®s
(),

8428 
Œue
)

8432 
	`w™h_unique_lock
(
³ndšg_ü—‹s_lock
, [=]() {

8433 ià(
³ndšg_ü—‹s_äom_mÚ
 == 0) {

8434 
Ï¡_pg_ü—‹_•och
 = 
m
->
•och
;

8438 
m
->
	`put
();

8439 
	}
}

8441 
	gOSD
::
	$hªdË_ç¡_pg_qu”y
(
MOSDPGQu”y
 *
m
)

8443 
	`dout
(7è<< 
__func__
 << " " << *
m
 << " from " << m->
	`g‘_sourû
(è<< 
d’dl
;

8444 ià(!
	`»quœe_osd_³”
(
m
)) {

8445 
m
->
	`put
();

8448 
äom
 = 
m
->
	`g‘_sourû
().
	`num
();

8449 auto& 
p
 : 
m
->
pg_li¡
) {

8450 
	`’queue_³”šg_evt
(

8451 
p
.
fœ¡
,

8452 
	`PGP“ršgEv’tRef
(

8453 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

8454 
p
.
£cÚd
.
•och_£Á
,….second.epoch_sent,

8455 
	`MQu”y
(

8456 
p
.
fœ¡
,

8457 
	`pg_sh¬d_t
(
äom
, 
p
.
£cÚd
.from),

8458 
p
.
£cÚd
,

8459 
p
.
£cÚd
.
•och_£Á
),

8460 
çl£
))

8463 
m
->
	`put
();

8464 
	}
}

8466 
	gOSD
::
	$hªdË_ç¡_pg_nÙify
(
MOSDPGNÙify
* 
m
)

8468 
	`dout
(7è<< 
__func__
 << " " << *
m
 << " from " << m->
	`g‘_sourû
(è<< 
d’dl
;

8469 ià(!
	`»quœe_osd_³”
(
m
)) {

8470 
m
->
	`put
();

8473 
äom
 = 
m
->
	`g‘_sourû
().
	`num
();

8474 auto& 
p
 : 
m
->
	`g‘_pg_li¡
()) {

8475 
¥g_t
 
	`pgid
(
p
.
fœ¡
.
šfo
.
pgid
.pgid,….fœ¡.
to
);

8476 
	`’queue_³”šg_evt
(

8477 
pgid
,

8478 
	`PGP“ršgEv’tRef
(

8479 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

8480 
p
.
fœ¡
.
•och_£Á
,

8481 
p
.
fœ¡
.
qu”y_•och
,

8482 
	`MNÙifyRec
(

8483 
pgid
, 
	`pg_sh¬d_t
(
äom
, 
p
.
fœ¡
.from),

8484 
p
.
fœ¡
,

8485 
m
->
	`g‘_cÚÃùiÚ
()->
	`g‘_ã©u»s
(),

8486 
p
.
£cÚd
),

8487 
Œue
,

8488 
Ãw
 
	`PGC»©eInfo
(

8489 
pgid
,

8490 
p
.
fœ¡
.
qu”y_•och
,

8491 
p
.
fœ¡
.
šfo
.
hi¡Üy
,

8492 
p
.
£cÚd
,

8493 
çl£
)

8496 
m
->
	`put
();

8497 
	}
}

8499 
	gOSD
::
	$hªdË_ç¡_pg_šfo
(
MOSDPGInfo
* 
m
)

8501 
	`dout
(7è<< 
__func__
 << " " << *
m
 << " from " << m->
	`g‘_sourû
(è<< 
d’dl
;

8502 ià(!
	`»quœe_osd_³”
(
m
)) {

8503 
m
->
	`put
();

8506 
äom
 = 
m
->
	`g‘_sourû
().
	`num
();

8507 auto& 
p
 : 
m
->
pg_li¡
) {

8508 
	`’queue_³”šg_evt
(

8509 
	`¥g_t
(
p
.
fœ¡
.
šfo
.
pgid
.pgid,….fœ¡.
to
),

8510 
	`PGP“ršgEv’tRef
(

8511 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

8512 
p
.
fœ¡
.
•och_£Á
,….fœ¡.
qu”y_•och
,

8513 
	`MInfoRec
(

8514 
	`pg_sh¬d_t
(
äom
, 
p
.
fœ¡
.from),

8515 
p
.
fœ¡
.
šfo
,

8516 
p
.
fœ¡
.
•och_£Á
)))

8519 
m
->
	`put
();

8520 
	}
}

8522 
	gOSD
::
	$hªdË_ç¡_pg_»move
(
MOSDPGRemove
 *
m
)

8524 
	`dout
(7è<< 
__func__
 << " " << *
m
 << " from " << m->
	`g‘_sourû
(è<< 
d’dl
;

8525 ià(!
	`»quœe_osd_³”
(
m
)) {

8526 
m
->
	`put
();

8529 auto& 
pgid
 : 
m
->
pg_li¡
) {

8530 
	`’queue_³”šg_evt
(

8531 
pgid
,

8532 
	`PGP“ršgEv’tRef
(

8533 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

8534 
m
->
	`g‘_•och
(), m->get_epoch(),

8535 
PG
::
	`D–‘eS¹
())));

8537 
m
->
	`put
();

8538 
	}
}

8540 
	gOSD
::
	$hªdË_ç¡_fÜû_»cov”y
(
MOSDFÜûRecov”y
 *
m
)

8542 
	`dout
(10è<< 
__func__
 << " " << *
m
 << 
d’dl
;

8543 ià(!
	`»quœe_mÚ_Ü_mgr_³”
(
m
)) {

8544 
m
->
	`put
();

8547 
•och_t
 
•och
 = 
	`g‘_osdm­_•och
();

8548 autØ
pgid
 : 
m
->
fÜûd_pgs
) {

8549 ià(
m
->
İtiÚs
 & 
OFR_BACKFILL
) {

8550 ià(
m
->
İtiÚs
 & 
OFR_CANCEL
) {

8551 
	`’queue_³”šg_evt
(

8552 
pgid
,

8553 
	`PGP“ršgEv’tRef
(

8554 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

8555 
•och
,ƒpoch,

8556 
PG
::
	`Un£tFÜûBackfl
())));

8558 
	`’queue_³”šg_evt
(

8559 
pgid
,

8560 
	`PGP“ršgEv’tRef
(

8561 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

8562 
•och
,ƒpoch,

8563 
PG
::
	`S‘FÜûBackfl
())));

8565 } ià(
m
->
İtiÚs
 & 
OFR_RECOVERY
) {

8566 ià(
m
->
İtiÚs
 & 
OFR_CANCEL
) {

8567 
	`’queue_³”šg_evt
(

8568 
pgid
,

8569 
	`PGP“ršgEv’tRef
(

8570 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

8571 
•och
,ƒpoch,

8572 
PG
::
	`Un£tFÜûRecov”y
())));

8574 
	`’queue_³”šg_evt
(

8575 
pgid
,

8576 
	`PGP“ršgEv’tRef
(

8577 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

8578 
•och
,ƒpoch,

8579 
PG
::
	`S‘FÜûRecov”y
())));

8583 
m
->
	`put
();

8584 
	}
}

8586 
	gOSD
::
	$hªdË_pg_qu”y_nİg
(cÚ¡ 
MQu”y
& 
q
)

8588 
¥g_t
 
pgid
 = 
q
.pgid;

8589 
	`dout
(10è<< 
__func__
 << " " << 
pgid
 << 
d’dl
;

8591 
OSDM­Ref
 
osdm­
 = 
	`g‘_osdm­
();

8592 ià(!
osdm­
->
	`have_pg_poŞ
(
pgid
.
	`poŞ
()))

8596 
up_´im¬y
, 
aùšg_´im¬y
;

8597 
veùÜ
<> 
up
, 
aùšg
;

8598 
osdm­
->
	`pg_to_up_aùšg_osds
(

8599 
pgid
.pgid, &
up
, &
up_´im¬y
, &
aùšg
, &
aùšg_´im¬y
);

8602 
pg_hi¡Üy_t
 
hi¡Üy
 = 
q
.
qu”y
.history;

8603 
boŞ
 
v®id_hi¡Üy
 = 
	`´ojeù_pg_hi¡Üy
(

8604 
pgid
, 
hi¡Üy
, 
q
.
qu”y
.
•och_£Á
,

8605 
up
, 
up_´im¬y
, 
aùšg
, 
aùšg_´im¬y
);

8607 ià(!
v®id_hi¡Üy
 ||

8608 
q
.
qu”y
.
•och_£Á
 < 
hi¡Üy
.
§me_š‹rv®_sšû
) {

8609 
	`dout
(10è<< "…g " << 
pgid
 << " dne,‡nd…g has changed in "

8610 << 
hi¡Üy
.
§me_š‹rv®_sšû


8611 << " (msg from " << 
q
.
qu”y
.
•och_£Á
 << ")" << 
d’dl
;

8615 
	`dout
(10è<< "…g " << 
pgid
 << " dÃ" << 
d’dl
;

8616 
pg_šfo_t
 
	`em±y
(
	`¥g_t
(
pgid
.pgid, 
q
.
qu”y
.
to
));

8617 
CÚÃùiÚRef
 
cÚ
 = 
£rviû
.
	`g‘_cÚ_osd_şu¡”
(
q
.
äom
.
osd
, 
osdm­
->
	`g‘_•och
());

8618 ià(
cÚ
) {

8619 
Mes§ge
 *
m
;

8620 ià(
q
.
qu”y
.
ty³
 =ğ
pg_qu”y_t
::
LOG
 ||

8621 
q
.
qu”y
.
ty³
 =ğ
pg_qu”y_t
::
FULLLOG
) {

8622 
m
 = 
Ãw
 
	`MOSDPGLog
(

8623 
q
.
qu”y
.
äom
, q.qu”y.
to
,

8624 
osdm­
->
	`g‘_•och
(), 
em±y
,

8625 
q
.
qu”y
.
•och_£Á
);

8627 
veùÜ
<
·œ
<
pg_nÙify_t
,
Pa¡IÁ”v®s
>> 
ls
;

8628 
ls
.
	`push_back
(

8629 
	`make_·œ
(

8630 
	`pg_nÙify_t
(

8631 
q
.
qu”y
.
äom
, q.qu”y.
to
,

8632 
q
.
qu”y
.
•och_£Á
,

8633 
osdm­
->
	`g‘_•och
(),

8634 
em±y
),

8635 
	`Pa¡IÁ”v®s
()));

8636 
m
 = 
Ãw
 
	`MOSDPGNÙify
(
osdm­
->
	`g‘_•och
(), 
ls
);

8638 
£rviû
.
	`sh¬e_m­_³”
(
q
.
äom
.
osd
, 
cÚ
.
	`g‘
(), 
osdm­
);

8639 
cÚ
->
	`£nd_mes§ge
(
m
);

8641 
	}
}

8647 
	gOSDS”viû
::
	$_maybe_queue_»cov”y
() {

8648 
	`as£¹
(
»cov”y_lock
.
	`is_locked_by_me
());

8649 
ušt64_t
 
avaabË_pushes
;

8650 !
awa™šg_thrÙe
.
	`em±y
() &&

8651 
	`_»cov”_now
(&
avaabË_pushes
)) {

8652 
ušt64_t
 
to_¡¬t
 = 
¡d
::
	`mš
(

8653 
avaabË_pushes
,

8654 
cù
->
_cÚf
->
osd_»cov”y_max_sšgË_¡¬t
);

8655 
	`_queue_fÜ_»cov”y
(
awa™šg_thrÙe
.
	`äÚt
(), 
to_¡¬t
);

8656 
awa™šg_thrÙe
.
	`pİ_äÚt
();

8657 
	`dout
(10è<< 
__func__
 << " s¹šg " << 
to_¡¬t


8658 << ",„ecov”y_İs_»£rved " << 
»cov”y_İs_»£rved


8659 << " -> " << (
»cov”y_İs_»£rved
 + 
to_¡¬t
è<< 
d’dl
;

8660 
»cov”y_İs_»£rved
 +ğ
to_¡¬t
;

8662 
	}
}

8664 
boŞ
 
	gOSDS”viû
::
	$_»cov”_now
(
ušt64_t
 *
avaabË_pushes
)

8666 ià(
avaabË_pushes
)

8667 *
avaabË_pushes
 = 0;

8669 ià(
	`ûph_şock_now
(è< 
deãr_»cov”y_uÁ
) {

8670 
	`dout
(15è<< 
__func__
 << " deã¸uÁ " << 
deãr_»cov”y_uÁ
 << 
d’dl
;

8671  
çl£
;

8674 ià(
»cov”y_·u£d
) {

8675 
	`dout
(15è<< 
__func__
 << "…au£d" << 
d’dl
;

8676  
çl£
;

8679 
ušt64_t
 
max
 = 
cù
->
_cÚf
->
osd_»cov”y_max_aùive
;

8680 ià(
max
 <ğ
»cov”y_İs_aùive
 + 
»cov”y_İs_»£rved
) {

8681 
	`dout
(15è<< 
__func__
 << "‡ùiv" << 
»cov”y_İs_aùive


8682 << " +„e£rved " << 
»cov”y_İs_»£rved


8683 << " >ğmax " << 
max
 << 
d’dl
;

8684  
çl£
;

8687 ià(
avaabË_pushes
)

8688 *
avaabË_pushes
 = 
max
 - 
»cov”y_İs_aùive
 - 
»cov”y_İs_»£rved
;

8690  
Œue
;

8691 
	}
}

8693 
	gOSD
::
	$do_»cov”y
(

8694 
PG
 *
pg
, 
•och_t
 
queued
, 
ušt64_t
 
»£rved_pushes
,

8695 
Th»adPoŞ
::
TPHªdË
 &
hªdË
)

8697 
ušt64_t
 
¡¬‹d
 = 0;

8706 
»cov”y_¦“p
 = 
	`g‘_osd_»cov”y_¦“p
();

8708 
Mu‹x
::
Lock”
 
	`l
(
£rviû
.
»cov”y_¦“p_lock
);

8709 ià(
»cov”y_¦“p
 > 0 && 
£rviû
.
»cov”y_Ãeds_¦“p
) {

8710 
PGRef
 
	`pg»f
(
pg
);

8711 autØ
»cov”y_»queue_ÿÎback
 = 
Ãw
 
	`FunùiÚCÚ‹xt
([
this
, 
pg»f
, 
queued
, 
»£rved_pushes
](
r
) {

8712 
	`dout
(20) << "do_recovery wake up‡t "

8713 << 
	`ûph_şock_now
()

8714 << ",„e-queušg„ecov”y" << 
d’dl
;

8715 
Mu‹x
::
Lock”
 
	`l
(
£rviû
.
»cov”y_¦“p_lock
);

8716 
£rviû
.
»cov”y_Ãeds_¦“p
 = 
çl£
;

8717 
£rviû
.
	`queue_»cov”y_aá”_¦“p
(
pg»f
.
	`g‘
(), 
queued
, 
»£rved_pushes
);

8723 ià(
£rviû
.
»cov”y_scheduË_time
 < 
	`ûph_şock_now
()) {

8724 
£rviû
.
»cov”y_scheduË_time
 = 
	`ûph_şock_now
();

8726 
£rviû
.
»cov”y_scheduË_time
 +ğ
»cov”y_¦“p
;

8727 
£rviû
.
»cov”y_¦“p_tim”
.
	`add_ev’t_©
(£rviû.
»cov”y_scheduË_time
,

8728 
»cov”y_»queue_ÿÎback
);

8729 
	`dout
(20) << "Recoveryƒvent scheduled‡t "

8730 << 
£rviû
.
»cov”y_scheduË_time
 << 
d’dl
;

8737 
Mu‹x
::
Lock”
 
	`l
(
£rviû
.
»cov”y_¦“p_lock
);

8738 
£rviû
.
»cov”y_Ãeds_¦“p
 = 
Œue
;

8741 ià(
pg
->
	`pg_has_»£t_sšû
(
queued
)) {

8742 
out
;

8745 
	`dout
(10è<< "do_»cov”y s¹šg " << 
»£rved_pushes
 << " " << *
pg
 << 
d’dl
;

8746 #ifdeà
DEBUG_RECOVERY_OIDS


8747 
	`dout
(20è<< "‡ùivwa " << 
£rviû
.
»cov”y_oids
[
pg
->
pg_id
] << 
d’dl
;

8750 
boŞ
 
do_unfound
 = 
pg
->
	`¡¬t_»cov”y_İs
(
»£rved_pushes
, 
hªdË
, &
¡¬‹d
);

8751 
	`dout
(10è<< "do_»cov”y s¹ed " << 
¡¬‹d
 << "/" << 
»£rved_pushes


8752 << " oÀ" << *
pg
 << 
d’dl
;

8754 ià(
do_unfound
) {

8755 
PG
::
Recov”yCtx
 
rùx
 = 
	`ü—‹_cÚ‹xt
();

8756 
rùx
.
hªdË
 = &handle;

8757 
pg
->
	`fšd_unfound
(
queued
, &
rùx
);

8758 
	`di¥©ch_cÚ‹xt
(
rùx
, 
pg
,…g->
	`g‘_osdm­
());

8762 
out
:

8763 
	`as£¹
(
¡¬‹d
 <ğ
»£rved_pushes
);

8764 
£rviû
.
	`»Ëa£_»£rved_pushes
(
»£rved_pushes
);

8765 
	}
}

8767 
	gOSDS”viû
::
	$¡¬t_»cov”y_İ
(
PG
 *
pg
, cÚ¡ 
hobjeù_t
& 
soid
)

8769 
Mu‹x
::
Lock”
 
	`l
(
»cov”y_lock
);

8770 
	`dout
(10è<< "¡¬t_»cov”y_İ " << *
pg
 << " " << 
soid


8771 << " (" << 
»cov”y_İs_aùive
 << "/"

8772 << 
cù
->
_cÚf
->
osd_»cov”y_max_aùive
 << "„ops)"

8773 << 
d’dl
;

8774 
»cov”y_İs_aùive
++;

8776 #ifdeà
DEBUG_RECOVERY_OIDS


8777 
	`dout
(20è<< "‡ùivwa " << 
»cov”y_oids
[
pg
->
pg_id
] << 
d’dl
;

8778 
	`as£¹
(
»cov”y_oids
[
pg
->
pg_id
].
	`couÁ
(
soid
) == 0);

8779 
»cov”y_oids
[
pg
->
pg_id
].
	`š£¹
(
soid
);

8781 
	}
}

8783 
	gOSDS”viû
::
	$fšish_»cov”y_İ
(
PG
 *
pg
, cÚ¡ 
hobjeù_t
& 
soid
, 
boŞ
 
dequeue
)

8785 
Mu‹x
::
Lock”
 
	`l
(
»cov”y_lock
);

8786 
	`dout
(10è<< "fšish_»cov”y_İ " << *
pg
 << " " << 
soid


8787 << " dequeue=" << 
dequeue


8788 << " (" << 
»cov”y_İs_aùive
 << "/" << 
cù
->
_cÚf
->
osd_»cov”y_max_aùive
 << "„ops)"

8789 << 
d’dl
;

8792 
	`as£¹
(
»cov”y_İs_aùive
 > 0);

8793 
»cov”y_İs_aùive
--;

8795 #ifdeà
DEBUG_RECOVERY_OIDS


8796 
	`dout
(20è<< "‡ùivoid wa " << 
»cov”y_oids
[
pg
->
pg_id
] << 
d’dl
;

8797 
	`as£¹
(
»cov”y_oids
[
pg
->
pg_id
].
	`couÁ
(
soid
));

8798 
»cov”y_oids
[
pg
->
pg_id
].
	`”a£
(
soid
);

8801 
	`_maybe_queue_»cov”y
();

8802 
	}
}

8804 
boŞ
 
	gOSDS”viû
::
	$is_»cov”y_aùive
()

8806  
loÿl_»£rv”
.
	`has_»£rv©iÚ
(è|| 
»mÙe_»£rv”
.has_reservation();

8807 
	}
}

8809 
	gOSDS”viû
::
	$»Ëa£_»£rved_pushes
(
ušt64_t
 
pushes
)

8811 
Mu‹x
::
Lock”
 
	`l
(
»cov”y_lock
);

8812 
	`dout
(10è<< 
__func__
 << "(" << 
pushes
 << "),„ecovery_ops_reserved "

8813 << 
»cov”y_İs_»£rved
 << " -> " << (»cov”y_İs_»£rved-
pushes
)

8814 << 
d’dl
;

8815 
	`as£¹
(
»cov”y_İs_»£rved
 >ğ
pushes
);

8816 
»cov”y_İs_»£rved
 -ğ
pushes
;

8817 
	`_maybe_queue_»cov”y
();

8818 
	}
}

8823 
boŞ
 
	gOSD
::
	$İ_is_disÿrdabË
(cÚ¡ 
MOSDOp
 *
İ
)

8827 ià(!
İ
->
	`g‘_cÚÃùiÚ
()->
	`is_cÚÃùed
()) {

8828  
Œue
;

8830  
çl£
;

8831 
	}
}

8833 
	gOSD
::
	$’queue_İ
(
¥g_t
 
pg
, 
OpReque¡Ref
& 
İ
, 
•och_t
 
•och
)

8835 
utime_t
 
Ï‹ncy
 = 
	`ûph_şock_now
(è- 
İ
->
	`g‘_»q
()->
	`g‘_»cv_¡amp
();

8836 
	`dout
(15è<< "’queue_İ " << 
İ
 << "…riØ" << op->
	`g‘_»q
()->
	`g‘_´iÜ™y
()

8837 << " co¡ " << 
İ
->
	`g‘_»q
()->
	`g‘_co¡
()

8838 << "†©’cy " << 
Ï‹ncy


8839 << "ƒpoch " << 
•och


8840 << " " << *(
İ
->
	`g‘_»q
()è<< 
d’dl
;

8841 
İ
->
osd_Œaû
.
	`ev’t
("enqueue op");

8842 
İ
->
osd_Œaû
.
	`keyv®
("´iÜ™y", op->
	`g‘_»q
()->
	`g‘_´iÜ™y
());

8843 
İ
->
osd_Œaû
.
	`keyv®
("co¡", op->
	`g‘_»q
()->
	`g‘_co¡
());

8844 
İ
->
	`m¬k_queued_fÜ_pg
();

8845 
logg”
->
	`tšc
(
l_osd_İ_befÜe_queue_İ_Ït
, 
Ï‹ncy
);

8846 
İ_sh¬dedwq
.
	`queue
(

8847 
	`OpQueueI‹m
(

8848 
unique_±r
<
OpQueueI‹m
::
OpQueu—bË
>(
Ãw
 
	`PGOpI‹m
(
pg
, 
İ
)),

8849 
İ
->
	`g‘_»q
()->
	`g‘_co¡
(),

8850 
İ
->
	`g‘_»q
()->
	`g‘_´iÜ™y
(),

8851 
İ
->
	`g‘_»q
()->
	`g‘_»cv_¡amp
(),

8852 
İ
->
	`g‘_»q
()->
	`g‘_sourû
().
	`num
(),

8853 
•och
));

8854 
	}
}

8856 
	gOSD
::
	$’queue_³”šg_evt
(
¥g_t
 
pgid
, 
PGP“ršgEv’tRef
 
evt
)

8858 
	`dout
(15è<< 
__func__
 << " " << 
pgid
 << " " << 
evt
->
	`g‘_desc
(è<< 
d’dl
;

8859 
İ_sh¬dedwq
.
	`queue
(

8860 
	`OpQueueI‹m
(

8861 
unique_±r
<
OpQueueI‹m
::
OpQueu—bË
>(
Ãw
 
	`PGP“ršgI‹m
(
pgid
, 
evt
)),

8863 
cù
->
_cÚf
->
osd_³”šg_İ_´iÜ™y
,

8864 
	`utime_t
(),

8866 
evt
->
	`g‘_•och_£Á
()));

8867 
	}
}

8869 
	gOSD
::
	$’queue_³”šg_evt_äÚt
(
¥g_t
 
pgid
, 
PGP“ršgEv’tRef
 
evt
)

8871 
	`dout
(15è<< 
__func__
 << " " << 
pgid
 << " " << 
evt
->
	`g‘_desc
(è<< 
d’dl
;

8872 
İ_sh¬dedwq
.
	`queue_äÚt
(

8873 
	`OpQueueI‹m
(

8874 
unique_±r
<
OpQueueI‹m
::
OpQueu—bË
>(
Ãw
 
	`PGP“ršgI‹m
(
pgid
, 
evt
)),

8876 
cù
->
_cÚf
->
osd_³”šg_İ_´iÜ™y
,

8877 
	`utime_t
(),

8879 
evt
->
	`g‘_•och_£Á
()));

8880 
	}
}

8885 
	gOSD
::
	$dequeue_İ
(

8886 
PGRef
 
pg
, 
OpReque¡Ref
 
İ
,

8887 
Th»adPoŞ
::
TPHªdË
 &
hªdË
)

8889 
	`FUNCTRACE
(
cù
);

8890 
	`OID_EVENT_TRACE_WITH_MSG
(
İ
->
	`g‘_»q
(), "DEQUEUE_OP_BEGIN", 
çl£
);

8892 
utime_t
 
now
 = 
	`ûph_şock_now
();

8893 
İ
->
	`£t_dequeued_time
(
now
);

8894 
utime_t
 
Ï‹ncy
 = 
now
 - 
İ
->
	`g‘_»q
()->
	`g‘_»cv_¡amp
();

8895 
	`dout
(10è<< "dequeue_İ " << 
İ
 << "…riØ" << op->
	`g‘_»q
()->
	`g‘_´iÜ™y
()

8896 << " co¡ " << 
İ
->
	`g‘_»q
()->
	`g‘_co¡
()

8897 << "†©’cy " << 
Ï‹ncy


8898 << " " << *(
İ
->
	`g‘_»q
())

8899 << "…g " << *
pg
 << 
d’dl
;

8901 
logg”
->
	`tšc
(
l_osd_İ_befÜe_dequeue_İ_Ït
, 
Ï‹ncy
);

8903 
SessiÚ
 *
£ssiÚ
 = 
¡©ic_ÿ¡
<Session *>(

8904 
İ
->
	`g‘_»q
()->
	`g‘_cÚÃùiÚ
()->
	`g‘_´iv
());

8905 ià(
£ssiÚ
) {

8906 
	`maybe_sh¬e_m­
(
£ssiÚ
, 
İ
, 
pg
->
	`g‘_osdm­
());

8907 
£ssiÚ
->
	`put
();

8910 ià(
pg
->
	`is_d–‘šg
())

8913 
İ
->
	`m¬k_»ached_pg
();

8914 
İ
->
osd_Œaû
.
	`ev’t
("dequeue_op");

8916 
pg
->
	`do_»que¡
(
İ
, 
hªdË
);

8919 
	`dout
(10è<< "dequeue_İ " << 
İ
 << " fšish" << 
d’dl
;

8920 
	`OID_EVENT_TRACE_WITH_MSG
(
İ
->
	`g‘_»q
(), "DEQUEUE_OP_END", 
çl£
);

8921 
	}
}

8924 
	gOSD
::
	$dequeue_³”šg_evt
(

8925 
OSDSh¬d
 *
sd©a
,

8926 
PG
 *
pg
,

8927 
PGP“ršgEv’tRef
 
evt
,

8928 
Th»adPoŞ
::
TPHªdË
& 
hªdË
)

8930 
PG
::
Recov”yCtx
 
rùx
 = 
	`ü—‹_cÚ‹xt
();

8931 autØ
curm­
 = 
sd©a
->
	`g‘_osdm­
();

8932 
•och_t
 
Ãed_up_thru
 = 0, 
§me_š‹rv®_sšû
 = 0;

8933 ià(!
pg
) {

8934 ià(cÚ¡ 
MQu”y
 *
q
 = 
dyÇmic_ÿ¡
<cÚ¡ MQu”y*>(
evt
->evt.
	`g‘
())) {

8935 
	`hªdË_pg_qu”y_nİg
(*
q
);

8937 
d”r
 << 
__func__
 << " uÄecognized…g-Ës ev’ˆ" << 
evt
->
	`g‘_desc
(è<< 
d’dl
;

8938 
	`ûph_abÜt
();

8941 ià(
curm­
->
	`g‘_•och
(è> 
pg
->
	`g‘_osdm­_•och
()) {

8942 
	`advªû_pg
(
curm­
->
	`g‘_•och
(), 
pg
, 
hªdË
, &
rùx
);

8944 
pg
->
	`do_³”šg_ev’t
(
evt
, &
rùx
);

8945 ià(
pg
->
	`is_d–‘ed
()) {

8947 
	`disÿrd_cÚ‹xt
(
rùx
);

8948 
pg
->
	`uÆock
();

8951 
	`di¥©ch_cÚ‹xt_Œª§ùiÚ
(
rùx
, 
pg
, &
hªdË
);

8952 
Ãed_up_thru
 = 
pg
->
	`g‘_Ãed_up_thru
();

8953 
§me_š‹rv®_sšû
 = 
pg
->
	`g‘_§me_š‹rv®_sšû
();

8954 
pg
->
	`uÆock
();

8957 ià(
Ãed_up_thru
) {

8958 
	`queue_wªt_up_thru
(
§me_š‹rv®_sšû
);

8960 
	`di¥©ch_cÚ‹xt
(
rùx
, 
pg
, 
curm­
, &
hªdË
);

8962 
£rviû
.
	`£nd_pg_‹mp
();

8963 
	}
}

8965 
	gOSD
::
	$dequeue_d–‘e
(

8966 
OSDSh¬d
 *
sd©a
,

8967 
PG
 *
pg
,

8968 
•och_t
 
e
,

8969 
Th»adPoŞ
::
TPHªdË
& 
hªdË
)

8971 
	`dequeue_³”šg_evt
(

8972 
sd©a
,

8973 
pg
,

8974 
	`PGP“ršgEv’tRef
(

8975 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

8976 
e
,ƒ,

8977 
PG
::
	`D–‘eSome
())),

8978 
hªdË
);

8979 
	}
}

8985 cÚ¡ ** 
	gOSD
::
	$g‘_Œacked_cÚf_keys
() const

8987 cÚ¡ * 
KEYS
[] = {

9017 
NULL


9019  
KEYS
;

9020 
	}
}

9022 
	gOSD
::
hªdË_cÚf_chªge
(cÚ¡ 
md_cÚfig_t
 *
cÚf
,

9023 cÚ¡ 
¡d
::
£t
 <¡d::
¡ršg
> &
chªged
)

9025 ià(
chªged
.
couÁ
("osd_max_backfills")) {

9026 
£rviû
.
loÿl_»£rv”
.
£t_max
(
cù
->
_cÚf
->
osd_max_backfls
);

9027 
	g£rviû
.
	g»mÙe_»£rv”
.
£t_max
(
cù
->
_cÚf
->
osd_max_backfls
);

9029 ià(
	gchªged
.
couÁ
("osd_min_recovery_priority")) {

9030 
	g£rviû
.
	gloÿl_»£rv”
.
£t_mš_´iÜ™y
(
cù
->
_cÚf
->
osd_mš_»cov”y_´iÜ™y
);

9031 
	g£rviû
.
	g»mÙe_»£rv”
.
£t_mš_´iÜ™y
(
cù
->
_cÚf
->
osd_mš_»cov”y_´iÜ™y
);

9033 ià(
	gchªged
.
couÁ
("osd_max_trimming_pgs")) {

9034 
	g£rviû
.
	g¢­_»£rv”
.
£t_max
(
cù
->
_cÚf
->
osd_max_Œimmšg_pgs
);

9036 ià(
	gchªged
.
couÁ
("osd_op_complaint_time") ||

9037 
	gchªged
.
couÁ
("osd_op_log_threshold")) {

9038 
	gİ_Œack”
.
£t_com¶ašt_ªd_th»shŞd
(
cù
->
_cÚf
->
osd_İ_com¶ašt_time
,

9039 
cù
->
_cÚf
->
osd_İ_log_th»shŞd
);

9041 ià(
	gchªged
.
couÁ
("osd_op_history_size") ||

9042 
	gchªged
.
couÁ
("osd_op_history_duration")) {

9043 
	gİ_Œack”
.
£t_hi¡Üy_size_ªd_du¿tiÚ
(
cù
->
_cÚf
->
osd_İ_hi¡Üy_size
,

9044 
cù
->
_cÚf
->
osd_İ_hi¡Üy_du¿tiÚ
);

9046 ià(
	gchªged
.
couÁ
("osd_op_history_slow_op_size") ||

9047 
	gchªged
.
couÁ
("osd_op_history_slow_op_threshold")) {

9048 
	gİ_Œack”
.
£t_hi¡Üy_¦ow_İ_size_ªd_th»shŞd
(
cù
->
_cÚf
->
osd_İ_hi¡Üy_¦ow_İ_size
,

9049 
cù
->
_cÚf
->
osd_İ_hi¡Üy_¦ow_İ_th»shŞd
);

9051 ià(
	gchªged
.
couÁ
("osd_enable_op_tracker")) {

9052 
	gİ_Œack”
.
£t_Œackšg
(
cù
->
_cÚf
->
osd_’abË_İ_Œack”
);

9054 ià(
	gchªged
.
couÁ
("osd_map_cache_size")) {

9055 
	g£rviû
.
	gm­_ÿche
.
£t_size
(
cù
->
_cÚf
->
osd_m­_ÿche_size
);

9056 
	g£rviû
.
	gm­_bl_ÿche
.
£t_size
(
cù
->
_cÚf
->
osd_m­_ÿche_size
);

9057 
	g£rviû
.
	gm­_bl_šc_ÿche
.
£t_size
(
cù
->
_cÚf
->
osd_m­_ÿche_size
);

9059 ià(
	gchªged
.
couÁ
("clog_to_monitors") ||

9060 
	gchªged
.
couÁ
("clog_to_syslog") ||

9061 
	gchªged
.
couÁ
("clog_to_syslog_level") ||

9062 
	gchªged
.
couÁ
("clog_to_syslog_facility") ||

9063 
	gchªged
.
couÁ
("clog_to_graylog") ||

9064 
	gchªged
.
couÁ
("clog_to_graylog_host") ||

9065 
	gchªged
.
couÁ
("clog_to_graylog_port") ||

9066 
	gchªged
.
couÁ
("host") ||

9067 
	gchªged
.
couÁ
("fsid")) {

9068 
upd©e_log_cÚfig
();

9070 ià(
	gchªged
.
couÁ
("osd_pg_epoch_max_lag_factor")) {

9071 
	gm_osd_pg_•och_max_Ïg_çùÜ
 = 
cÚf
->
g‘_v®
<>(

9075 #ifdeà
HAVE_LIBFUSE


9076 ià(
	gchªged
.
couÁ
("osd_objectstore_fuse")) {

9077 ià(
	g¡Üe
) {

9078 
’abË_di§bË_fu£
(
çl£
);

9083 ià(
	gchªged
.
couÁ
("osd_recovery_delay_start")) {

9084 
	g£rviû
.
deãr_»cov”y
(
cù
->
_cÚf
->
osd_»cov”y_d–ay_¡¬t
);

9085 
	g£rviû
.
kick_»cov”y_queue
();

9088 ià(
	gchªged
.
couÁ
("osd_client_message_cap")) {

9089 
ušt64_t
 
	gÃwv®
 = 
cù
->
_cÚf
->
osd_ş›Á_mes§ge_ÿp
;

9090 
	gMes£ng”
::
PŞicy
 
pŞ
 = 
ş›Á_mes£ng”
->
g‘_pŞicy
(
’t™y_Çme_t
::
TYPE_CLIENT
);

9091 ià(
	gpŞ
.
	gthrÙ”_mes§ges
 && 
	gÃwv®
 > 0) {

9092 
	gpŞ
.
	gthrÙ”_mes§ges
->
»£t_max
(
Ãwv®
);

9095 ià(
	gchªged
.
couÁ
("osd_client_message_size_cap")) {

9096 
ušt64_t
 
	gÃwv®
 = 
cù
->
_cÚf
->
osd_ş›Á_mes§ge_size_ÿp
;

9097 
	gMes£ng”
::
PŞicy
 
pŞ
 = 
ş›Á_mes£ng”
->
g‘_pŞicy
(
’t™y_Çme_t
::
TYPE_CLIENT
);

9098 ià(
	gpŞ
.
	gthrÙ”_by‹s
 && 
	gÃwv®
 > 0) {

9099 
	gpŞ
.
	gthrÙ”_by‹s
->
»£t_max
(
Ãwv®
);

9103 
check_cÚfig
();

9106 
	gOSD
::
	$upd©e_log_cÚfig
()

9108 
m­
<
¡ršg
,¡ršg> 
log_to_mÚ™Üs
;

9109 
m­
<
¡ršg
,¡ršg> 
log_to_sy¦og
;

9110 
m­
<
¡ršg
,¡ršg> 
log_chªÃl
;

9111 
m­
<
¡ršg
,¡ršg> 
log_´io
;

9112 
m­
<
¡ršg
,¡ršg> 
log_to_g¿ylog
;

9113 
m­
<
¡ršg
,¡ršg> 
log_to_g¿ylog_ho¡
;

9114 
m­
<
¡ršg
,¡ršg> 
log_to_g¿ylog_pÜt
;

9115 
uuid_d
 
fsid
;

9116 
¡ršg
 
ho¡
;

9118 ià(
	`·r£_log_ş›Á_İtiÚs
(
cù
, 
log_to_mÚ™Üs
, 
log_to_sy¦og
,

9119 
log_chªÃl
, 
log_´io
, 
log_to_g¿ylog
,

9120 
log_to_g¿ylog_ho¡
, 
log_to_g¿ylog_pÜt
,

9121 
fsid
, 
ho¡
) == 0)

9122 
şog
->
	`upd©e_cÚfig
(
log_to_mÚ™Üs
, 
log_to_sy¦og
,

9123 
log_chªÃl
, 
log_´io
, 
log_to_g¿ylog
,

9124 
log_to_g¿ylog_ho¡
, 
log_to_g¿ylog_pÜt
,

9125 
fsid
, 
ho¡
);

9126 
d”r
 << "log_to_mÚ™Ü " << 
log_to_mÚ™Üs
 << 
d’dl
;

9127 
	}
}

9129 
	gOSD
::
	$check_cÚfig
()

9132 ià(
cù
->
_cÚf
->
osd_m­_ÿche_size
 <ğ()cù->_cÚf->
osd_pg_•och_³rsi¡ed_max_¡®e
 + 2) {

9133 
şog
->
	`w¬n
(è<< "osd_m­_ÿche_siz(" << 
cù
->
_cÚf
->
osd_m­_ÿche_size
 << ")"

9135 << 
cù
->
_cÚf
->
osd_pg_•och_³rsi¡ed_max_¡®e
 << ")";

9137 
	}
}

9141 
	gOSD
::
	$g‘_Ï‹¡_osdm­
()

9143 
	`dout
(10è<< 
__func__
 << " -- s¹" << 
d’dl
;

9145 
C_SaãrCÚd
 
cÚd
;

9146 
£rviû
.
objeù”
->
	`wa™_fÜ_Ï‹¡_osdm­
(&
cÚd
);

9147 
cÚd
.
	`wa™
();

9149 
	`dout
(10è<< 
__func__
 << " -- fšish" << 
d’dl
;

9150 
	}
}

9154 
	gOSD
::
	$š™_İ_æags
(
OpReque¡Ref
& 
İ
)

9156 cÚ¡ 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDOp*>(
İ
->
	`g‘_»q
());

9157 
veùÜ
<
OSDOp
>::
cÚ¡_™”©Ü
 
™”
;

9160 
İ
->
rmw_æags
 = 0;

9162 ià(
m
->
	`has_æag
(
CEPH_OSD_FLAG_RWORDERED
)) {

9163 
İ
->
	`£t_fÜû_rwÜd”ed
();

9167 
™”
 = 
m
->
İs
.
	`begš
(); i‹¸!ğm->İs.
	`’d
(); ++iter) {

9168 ià((
™”
->
İ
.İ =ğ
CEPH_OSD_OP_WATCH
 &&

9169 
™”
->
İ
.
w©ch
.İ =ğ
CEPH_OSD_WATCH_OP_PING
)) {

9177 
İ
->
	`£t_fÜû_rwÜd”ed
();

9179 ià(
	`ûph_osd_İ_mode_modify
(
™”
->
İ
.op))

9180 
İ
->
	`£t_wr™e
();

9182 ià(
	`ûph_osd_İ_mode_»ad
(
™”
->
İ
.op))

9183 
İ
->
	`£t_»ad
();

9186 ià(
™”
->
soid
.
oid
.
Çme
.
	`Ëngth
())

9187 
İ
->
	`£t_»ad
();

9190 ià(
	`ûph_osd_İ_ty³_pg
(
™”
->
İ
.op))

9191 
İ
->
	`£t_pg_İ
();

9193 ià(
	`ûph_osd_İ_mode_ÿche
(
™”
->
İ
.op))

9194 
İ
->
	`£t_ÿche
();

9197 
št64_t
 
poŞid
 = 
m
->
	`g‘_pg
().
	`poŞ
();

9198 cÚ¡ 
pg_poŞ_t
 *
poŞ
 = 
osdm­
->
	`g‘_pg_poŞ
(
poŞid
);

9199 ià(
poŞ
 &&…oŞ->
	`is_t›r
()) {

9200 cÚ¡ 
pg_poŞ_t
 *
ba£_poŞ
 = 
osdm­
->
	`g‘_pg_poŞ
(
poŞ
->
t›r_of
);

9201 ià(
ba£_poŞ
 && ba£_poŞ->
	`»quœe_rŞlback
()) {

9202 ià((
™”
->
İ
.İ !ğ
CEPH_OSD_OP_READ
) &&

9203 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_CHECKSUM
) &&

9204 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_CMPEXT
) &&

9205 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_STAT
) &&

9206 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_ISDIRTY
) &&

9207 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_UNDIRTY
) &&

9208 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_GETXATTR
) &&

9209 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_GETXATTRS
) &&

9210 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_CMPXATTR
) &&

9211 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_ASSERT_VER
) &&

9212 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_LIST_WATCHERS
) &&

9213 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_LIST_SNAPS
) &&

9214 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_SETALLOCHINT
) &&

9215 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_WRITEFULL
) &&

9216 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_ROLLBACK
) &&

9217 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_CREATE
) &&

9218 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_DELETE
) &&

9219 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_SETXATTR
) &&

9220 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_RMXATTR
) &&

9221 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_STARTSYNC
) &&

9222 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_COPY_GET
) &&

9223 (
™”
->
İ
.İ !ğ
CEPH_OSD_OP_COPY_FROM
)) {

9224 
İ
->
	`£t_´omÙe
();

9229 
™”
->
İ
.op) {

9230 
CEPH_OSD_OP_CALL
:

9232 
bufã¾i¡
::
™”©Ü
 
bp
 = 
cÚ¡_ÿ¡
<bufã¾i¡&>(
™”
->
šd©a
).
	`begš
();

9233 
is_wr™e
, 
is_»ad
;

9234 
¡ršg
 
úame
, 
mÇme
;

9235 
bp
.
	`cİy
(
™”
->
İ
.
şs
.
şass_Ën
, 
úame
);

9236 
bp
.
	`cİy
(
™”
->
İ
.
şs
.
m‘hod_Ën
, 
mÇme
);

9238 
CÏssHªdËr
::
CÏssD©a
 *
şs
;

9239 
r
 = 
şass_hªdËr
->
	`İ’_şass
(
úame
, &
şs
);

9240 ià(
r
) {

9241 
d”r
 << "şas " << 
úame
 << " o³ÀgÙ " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

9242 ià(
r
 =ğ-
ENOENT
)

9243 
r
 = -
EOPNOTSUPP
;

9244 ià(
r
 !ğ-
EPERM
)

9245 
r
 = -
EIO
;

9246  
r
;

9248 
æags
 = 
şs
->
	`g‘_m‘hod_æags
(
mÇme
.
	`c_¡r
());

9249 ià(
æags
 < 0) {

9250 ià(
æags
 =ğ-
ENOENT
)

9251 
r
 = -
EOPNOTSUPP
;

9253 
r
 = 
æags
;

9254  
r
;

9256 
is_»ad
 = 
æags
 & 
CLS_METHOD_RD
;

9257 
is_wr™e
 = 
æags
 & 
CLS_METHOD_WR
;

9258 
boŞ
 
is_´omÙe
 = 
æags
 & 
CLS_METHOD_PROMOTE
;

9260 
	`dout
(10è<< "şas " << 
úame
 << " m‘hod " << 
mÇme
 << " "

9261 << "æags=" << (
is_»ad
 ? "r" : "")

9262 << (
is_wr™e
 ? "w" : "")

9263 << (
is_´omÙe
 ? "p" : "")

9264 << 
d’dl
;

9265 ià(
is_»ad
)

9266 
İ
->
	`£t_şass_»ad
();

9267 ià(
is_wr™e
)

9268 
İ
->
	`£t_şass_wr™e
();

9269 ià(
is_´omÙe
)

9270 
İ
->
	`£t_´omÙe
();

9271 
İ
->
	`add_şass
(
¡d
::
	`move
(
úame
), std::move(
mÇme
), 
is_»ad
, 
is_wr™e
,

9272 
şs
->
wh™–i¡ed
);

9276 
CEPH_OSD_OP_WATCH
:

9280 
İ
->
	`£t_»ad
();

9282 
CEPH_OSD_OP_NOTIFY
:

9283 
CEPH_OSD_OP_NOTIFY_ACK
:

9285 
İ
->
	`£t_´omÙe
();

9289 
CEPH_OSD_OP_DELETE
:

9293 ià(
™”
 =ğ
m
->
İs
.
	`begš
() &&

9294 
™”
->
İ
.
æags
 =ğ
CEPH_OSD_OP_FLAG_FAILOK
) {

9295 
İ
->
	`£t_sk_hªdË_ÿche
();

9298 ià(
m
->
İs
.
	`size
() == 1) {

9299 
İ
->
	`£t_sk_´omÙe
();

9303 
CEPH_OSD_OP_CACHE_TRY_FLUSH
:

9304 
CEPH_OSD_OP_CACHE_FLUSH
:

9305 
CEPH_OSD_OP_CACHE_EVICT
:

9307 ià(
m
->
İs
.
	`size
() == 1) {

9308 
İ
->
	`£t_sk_hªdË_ÿche
();

9312 
CEPH_OSD_OP_READ
:

9313 
CEPH_OSD_OP_SYNC_READ
:

9314 
CEPH_OSD_OP_SPARSE_READ
:

9315 
CEPH_OSD_OP_CHECKSUM
:

9316 
CEPH_OSD_OP_WRITEFULL
:

9317 ià(
m
->
İs
.
	`size
() == 1 &&

9318 (
™”
->
İ
.
æags
 & 
CEPH_OSD_OP_FLAG_FADVISE_NOCACHE
 ||

9319 
™”
->
İ
.
æags
 & 
CEPH_OSD_OP_FLAG_FADVISE_DONTNEED
)) {

9320 
İ
->
	`£t_sk_´omÙe
();

9325 
CEPH_OSD_OP_CACHE_PIN
:

9326 
İ
->
	`£t_´omÙe
();

9334 ià(
İ
->
rmw_æags
 == 0)

9335  -
EINVAL
;

9338 
	}
}

9343 #undeà
dout_cÚ‹xt


9344 
	#dout_cÚ‹xt
 
cù


	)

9345 #undeà
dout_´efix


9346 
	#dout_´efix
 *
_dout
 << "osd." << 
osd
->
	`g‘_nodeid
(è<< ":" << 
sh¬d_id
 << "." << 
__func__
 << " "

	)

9348 
	gOSDSh¬d
::
	$_©ch_pg
(
OSDSh¬dPGSlÙ
 *
¦Ù
, 
PG
 *
pg
)

9350 
	`dout
(10è<< 
pg
->
pg_id
 << " " <<…g << 
d’dl
;

9351 
¦Ù
->
pg
 =…g;

9352 
pg
->
osd_sh¬d
 = 
this
;

9353 
pg
->
pg_¦Ù
 = 
¦Ù
;

9354 
osd
->
	`šc_num_pgs
();

9356 
¦Ù
->
•och
 = 
pg
->
	`g‘_osdm­_•och
();

9357 
pg_¦Ùs_by_•och
.
	`š£¹
(*
¦Ù
);

9358 
	}
}

9360 
	gOSDSh¬d
::
	$_d‘ach_pg
(
OSDSh¬dPGSlÙ
 *
¦Ù
)

9362 
	`dout
(10è<< 
¦Ù
->
pg
->
pg_id
 << " " << slÙ->pg << 
d’dl
;

9363 
¦Ù
->
pg
->
osd_sh¬d
 = 
nuÎ±r
;

9364 
¦Ù
->
pg
->
pg_¦Ù
 = 
nuÎ±r
;

9365 
¦Ù
->
pg
 = 
nuÎ±r
;

9366 
osd
->
	`dec_num_pgs
();

9368 
pg_¦Ùs_by_•och
.
	`”a£
Õg_¦Ùs_by_•och.
	`™”©Ü_to
(*
¦Ù
));

9369 
¦Ù
->
•och
 = 0;

9370 ià(
wa™šg_fÜ_mš_pg_•och
) {

9371 
mš_pg_•och_cÚd
.
	`SigÇl
();

9373 
	}
}

9375 
	gOSDSh¬d
::
	$upd©e_pg_•och
(
OSDSh¬dPGSlÙ
 *
¦Ù
, 
•och_t
 
e
)

9377 
Mu‹x
::
Lock”
 
	`l
(
sh¬d_lock
);

9378 
	`dout
(30è<< "mš wa " << 
pg_¦Ùs_by_•och
.
	`begš
()->
•och


9379 << " oÀ" << 
pg_¦Ùs_by_•och
.
	`begš
()->
pg
->
pg_id
 << 
d’dl
;

9380 
pg_¦Ùs_by_•och
.
	`”a£
Õg_¦Ùs_by_•och.
	`™”©Ü_to
(*
¦Ù
));

9381 
	`dout
(20è<< 
¦Ù
->
pg
->
pg_id
 << " " << slÙ->
•och
 << " -> " << 
e
 << 
d’dl
;

9382 
¦Ù
->
•och
 = 
e
;

9383 
pg_¦Ùs_by_•och
.
	`š£¹
(*
¦Ù
);

9384 
	`dout
(30è<< "mš i now " << 
pg_¦Ùs_by_•och
.
	`begš
()->
•och


9385 << " oÀ" << 
pg_¦Ùs_by_•och
.
	`begš
()->
pg
->
pg_id
 << 
d’dl
;

9386 ià(
wa™šg_fÜ_mš_pg_•och
) {

9387 
mš_pg_•och_cÚd
.
	`SigÇl
();

9389 
	}
}

9391 
•och_t
 
	gOSDSh¬d
::
	$g‘_mš_pg_•och
()

9393 
Mu‹x
::
Lock”
 
	`l
(
sh¬d_lock
);

9394 autØ
p
 = 
pg_¦Ùs_by_•och
.
	`begš
();

9395 ià(
p
 =ğ
pg_¦Ùs_by_•och
.
	`’d
()) {

9398  
p
->
•och
;

9399 
	}
}

9401 
	gOSDSh¬d
::
	$wa™_mš_pg_•och
(
•och_t
 
Ãed
)

9403 
Mu‹x
::
Lock”
 
	`l
(
sh¬d_lock
);

9404 
wa™šg_fÜ_mš_pg_•och
 = 
Œue
;

9405 !
pg_¦Ùs_by_•och
.
	`em±y
() &&

9406 
pg_¦Ùs_by_•och
.
	`begš
()->
•och
 < 
Ãed
) {

9407 
	`dout
(10è<< 
Ãed
 << " waiting on "

9408 << 
pg_¦Ùs_by_•och
.
	`begš
()->
•och
 << 
d’dl
;

9409 
mš_pg_•och_cÚd
.
	`Wa™
(
sh¬d_lock
);

9411 
wa™šg_fÜ_mš_pg_•och
 = 
çl£
;

9412 
	}
}

9414 
•och_t
 
	gOSDSh¬d
::
	$g‘_max_wa™šg_•och
()

9416 
Mu‹x
::
Lock”
 
	`l
(
sh¬d_lock
);

9417 
•och_t
 
r
 = 0;

9418 auto& 
i
 : 
pg_¦Ùs
) {

9419 ià(!
i
.
£cÚd
->
wa™šg_³”šg
.
	`em±y
()) {

9420 
r
 = 
¡d
::
	`max
Ô, 
i
.
£cÚd
->
wa™šg_³”šg
.
	`rbegš
()->
fœ¡
);

9423  
r
;

9424 
	}
}

9426 
	gOSDSh¬d
::
	$cÚsume_m­
(

9427 
OSDM­Ref
& 
Ãw_osdm­
,

9428 *
pushes_to_ä“
)

9430 
Mu‹x
::
Lock”
 
	`l
(
sh¬d_lock
);

9431 
OSDM­Ref
 
Şd_osdm­
;

9433 
Mu‹x
::
Lock”
 
	`l
(
osdm­_lock
);

9434 
Şd_osdm­
 = 
¡d
::
	`move
(
sh¬d_osdm­
);

9435 
sh¬d_osdm­
 = 
Ãw_osdm­
;

9437 
	`dout
(10è<< 
Ãw_osdm­
->
	`g‘_•och
()

9438 << " (wa " << (
Şd_osdm­
 ? old_osdm­->
	`g‘_•och
() : 0) << ")"

9439 << 
d’dl
;

9440 
boŞ
 
queued
 = 
çl£
;

9443 autØ
p
 = 
pg_¦Ùs
.
	`begš
();

9444 
p
 !ğ
pg_¦Ùs
.
	`’d
()) {

9445 
OSDSh¬dPGSlÙ
 *
¦Ù
 = 
p
->
£cÚd
.
	`g‘
();

9446 cÚ¡ 
¥g_t
& 
pgid
 = 
p
->
fœ¡
;

9447 
	`dout
(20è<< 
__func__
 << " " << 
pgid
 << 
d’dl
;

9448 ià(
¦Ù
->
wa™šg_fÜ_¥l™
) {

9449 
	`dout
(20è<< 
__func__
 << " " << 
pgid


9450 << " wa™šg fÜ s¶™" << 
d’dl
;

9451 ++
p
;

9454 ià(!
¦Ù
->
wa™šg_³”šg
.
	`em±y
()) {

9455 
•och_t
 
fœ¡
 = 
¦Ù
->
wa™šg_³”šg
.
	`begš
()->first;

9456 ià(
fœ¡
 <ğ
Ãw_osdm­
->
	`g‘_•och
()) {

9457 
	`dout
(20è<< 
__func__
 << " " << 
pgid


9458 << "…’dšg_³”šg fœ¡ƒpoch " << 
fœ¡


9459 << " <ğ" << 
Ãw_osdm­
->
	`g‘_•och
(è<< ",„equeuešg" << 
d’dl
;

9460 
	`_wake_pg_¦Ù
(
pgid
, 
¦Ù
);

9461 
queued
 = 
Œue
;

9463 ++
p
;

9466 ià(!
¦Ù
->
wa™šg
.
	`em±y
()) {

9467 ià(
Ãw_osdm­
->
	`is_up_aùšg_osd_sh¬d
(
pgid
, 
osd
->
	`g‘_nodeid
())) {

9468 
	`dout
(20è<< 
__func__
 << " " << 
pgid
 << " mapso us, keeping"

9469 << 
d’dl
;

9470 ++
p
;

9473 !
¦Ù
->
wa™šg
.
	`em±y
() &&

9474 
¦Ù
->
wa™šg
.
	`äÚt
().
	`g‘_m­_•och
(è<ğ
Ãw_osdm­
->
	`g‘_•och
()) {

9475 auto& 
qi
 = 
¦Ù
->
wa™šg
.
	`äÚt
();

9476 
	`dout
(20è<< 
__func__
 << " " << 
pgid


9477 << " wa™šg i‹m " << 
qi


9478 << "ƒpoch " << 
qi
.
	`g‘_m­_•och
()

9479 << " <ğ" << 
Ãw_osdm­
->
	`g‘_•och
()

9481 << (
qi
.
	`g‘_m­_•och
(è< 
Ãw_osdm­
->
	`g‘_•och
() ? "stale" :

9483 << ", drİpšg" << 
d’dl
;

9484 *
pushes_to_ä“
 +ğ
qi
.
	`g‘_»£rved_pushes
();

9485 
¦Ù
->
wa™šg
.
	`pİ_äÚt
();

9488 ià(
¦Ù
->
wa™šg
.
	`em±y
() &&

9489 
¦Ù
->
num_ruÂšg
 == 0 &&

9490 !
¦Ù
->
pg
) {

9491 
	`dout
(20è<< 
__func__
 << " " << 
pgid
 << "ƒm±y,…runšg" << 
d’dl
;

9492 
p
 = 
pg_¦Ùs
.
	`”a£
(p);

9496 ++
p
;

9498 ià(
queued
) {

9499 
sd©a_wa™_lock
.
	`Lock
();

9500 
sd©a_cÚd
.
	`SigÇlOÃ
();

9501 
sd©a_wa™_lock
.
	`UÆock
();

9503 
	}
}

9505 
	gOSDSh¬d
::
	$_wake_pg_¦Ù
(

9506 
¥g_t
 
pgid
,

9507 
OSDSh¬dPGSlÙ
 *
¦Ù
)

9509 
	`dout
(20è<< 
__func__
 << " " << 
pgid


9510 << "o_´oûs " << 
¦Ù
->
to_´oûss


9511 << " wa™šg " << 
¦Ù
->
wa™šg


9512 << " wa™šg_³”šg " << 
¦Ù
->
wa™šg_³”šg
 << 
d’dl
;

9513 autØ
i
 = 
¦Ù
->
to_´oûss
.
	`rbegš
();

9514 
i
 !ğ
¦Ù
->
to_´oûss
.
	`»nd
();

9515 ++
i
) {

9516 
	`_’queue_äÚt
(
¡d
::
	`move
(*
i
), 
osd
->
İ_´io_cutoff
);

9518 
¦Ù
->
to_´oûss
.
	`ş—r
();

9519 autØ
i
 = 
¦Ù
->
wa™šg
.
	`rbegš
();

9520 
i
 !ğ
¦Ù
->
wa™šg
.
	`»nd
();

9521 ++
i
) {

9522 
	`_’queue_äÚt
(
¡d
::
	`move
(*
i
), 
osd
->
İ_´io_cutoff
);

9524 
¦Ù
->
wa™šg
.
	`ş—r
();

9525 autØ
i
 = 
¦Ù
->
wa™šg_³”šg
.
	`rbegš
();

9526 
i
 !ğ
¦Ù
->
wa™šg_³”šg
.
	`»nd
();

9527 ++
i
) {

9531 autØ
j
 = 
i
->
£cÚd
.
	`rbegš
(); j !ği->£cÚd.
	`»nd
(); ++j) {

9532 
	`_’queue_äÚt
(
¡d
::
	`move
(*
j
), 
osd
->
İ_´io_cutoff
);

9535 
¦Ù
->
wa™šg_³”šg
.
	`ş—r
();

9536 
¦Ù
->
wa™šg_fÜ_¥l™
 = 
çl£
;

9537 ++
¦Ù
->
»queue_£q
;

9538 
	}
}

9540 
	gOSDSh¬d
::
id’tify_¥l™s
(cÚ¡ 
OSDM­Ref
& 
as_of_osdm­
, 
£t
<
¥g_t
> *
pgids
)

9542 
	gMu‹x
::
Lock”
 
l
(
sh¬d_lock
);

9543 ià(
	gsh¬d_osdm­
) {

9544 auto& 
	gi
 : 
pg_¦Ùs
) {

9545 cÚ¡ 
¥g_t
& 
pgid
 = 
i
.
fœ¡
;

9546 autØ*
	g¦Ù
 = 
i
.
£cÚd
.
g‘
();

9547 ià(
	g¦Ù
->
	gpg
 || slÙ->
	gwa™šg_fÜ_¥l™
) {

9548 
	gosd
->
	g£rviû
.
id’tify_¥l™_chd»n
(
sh¬d_osdm­
, 
as_of_osdm­
, 
pgid
,

9549 
pgids
);

9551 
dout
(20è<< 
	g__func__
 << " slÙ " << 
	gpgid


9552 << " ha nØpg‡nd !wa™šg_fÜ_¥l™" << 
	gd’dl
;

9558 
	gOSDSh¬d
::
´ime_¥l™s
(cÚ¡ 
OSDM­Ref
& 
as_of_osdm­
, 
£t
<
¥g_t
> *
pgids
)

9560 
	gMu‹x
::
Lock”
 
l
(
sh¬d_lock
);

9561 
_´ime_¥l™s
(
pgids
);

9562 ià(
	gsh¬d_osdm­
->
g‘_•och
(è> 
	gas_of_osdm­
->get_epoch()) {

9563 
	g£t
<
	g¥g_t
> 
	gÃw”_chd»n
;

9564 autØ
	gpgid
 : *
pgids
) {

9565 
osd
->
£rviû
.
id’tify_¥l™_chd»n
(
as_of_osdm­
, 
sh¬d_osdm­
, 
pgid
,

9566 &
Ãw”_chd»n
);

9568 
	gÃw”_chd»n
.
š£¹
(
pgids
->
begš
(),…gids->
’d
());

9569 
dout
(10è<< "as_of_osdm­ " << 
	gas_of_osdm­
->
g‘_•och
() << " < shard "

9570 << 
	gsh¬d_osdm­
->
g‘_•och
(è<< ",‚ew chd»À" << 
	gÃw”_chd»n


9571 << 
	gd’dl
;

9572 
_´ime_¥l™s
(&
Ãw”_chd»n
);

9584 
	gOSDSh¬d
::
_´ime_¥l™s
(
£t
<
¥g_t
> *
pgids
)

9586 
dout
(10è<< *
pgids
 << 
d’dl
;

9587 autØ
	gp
 = 
pgids
->
begš
();

9588 
	gp
 !ğ
pgids
->
’d
()) {

9589 
sh¬d_šdex
 = 
p
->
hash_to_sh¬d
(
osd
->
num_sh¬ds
);

9590 ià(
	gsh¬d_šdex
 =ğ
sh¬d_id
) {

9591 autØ
r
 = 
pg_¦Ùs
.
em¶aû
(*
p
, 
nuÎ±r
);

9592 ià(
	gr
.
	g£cÚd
) {

9593 
dout
(10è<< "´imšg slÙ " << *
	gp
 << 
	gd’dl
;

9594 
	gr
.
	gfœ¡
->
	g£cÚd
 = 
make_unique
<
OSDSh¬dPGSlÙ
>();

9595 
	gr
.
	gfœ¡
->
	g£cÚd
->
	gwa™šg_fÜ_¥l™
 = 
Œue
;

9597 autØ
	gq
 = 
r
.
fœ¡
;

9598 
as£¹
(
q
 !ğ
pg_¦Ùs
.
’d
());

9599 ià(
	gq
->
	g£cÚd
->
	gwa™šg_fÜ_¥l™
) {

9600 
dout
(10è<< "¦Ù " << *
	gp
 << "‡Ì—dy…rimed" << 
	gd’dl
;

9602 
dout
(10è<< "´imšg (exi¡šgè¦Ù " << *
	gp
 << 
	gd’dl
;

9603 
	gq
->
	g£cÚd
->
	gwa™šg_fÜ_¥l™
 = 
Œue
;

9606 
	gp
 = 
pgids
->
”a£
(
p
);

9608 ++
	gp
;

9613 
	gOSDSh¬d
::
	$»gi¡”_ªd_wake_¥l™_chd
(
PG
 *
pg
)

9616 
Mu‹x
::
Lock”
 
	`l
(
sh¬d_lock
);

9617 
	`dout
(10è<< 
pg
->
pg_id
 << " " <<…g << 
d’dl
;

9618 autØ
p
 = 
pg_¦Ùs
.
	`fšd
(
pg
->
pg_id
);

9619 
	`as£¹
(
p
 !ğ
pg_¦Ùs
.
	`’d
());

9620 autØ*
¦Ù
 = 
p
->
£cÚd
.
	`g‘
();

9621 
	`as£¹
(!
¦Ù
->
pg
);

9622 
	`as£¹
(
¦Ù
->
wa™šg_fÜ_¥l™
);

9623 
	`_©ch_pg
(
¦Ù
, 
pg
);

9624 
	`_wake_pg_¦Ù
(
pg
->
pg_id
, 
¦Ù
);

9626 
sd©a_wa™_lock
.
	`Lock
();

9627 
sd©a_cÚd
.
	`SigÇlOÃ
();

9628 
sd©a_wa™_lock
.
	`UÆock
();

9629 
	}
}

9631 
	gOSDSh¬d
::
	$uÅrime_¥l™_chd»n
(
¥g_t
 
·»Á
, 
Şd_pg_num
)

9633 
Mu‹x
::
Lock”
 
	`l
(
sh¬d_lock
);

9634 
veùÜ
<
¥g_t
> 
to_d–‘e
;

9635 auto& 
i
 : 
pg_¦Ùs
) {

9636 ià(
i
.
fœ¡
 !ğ
·»Á
 &&

9637 
i
.
fœ¡
.
	`g‘_ªû¡Ü
(
Şd_pg_num
è=ğ
·»Á
) {

9638 
	`dout
(10è<< 
__func__
 << "…¬’ˆ" << 
·»Á
 << " cË¬šg " << 
i
.
fœ¡


9639 << 
d’dl
;

9640 
to_d–‘e
.
	`push_back
(
i
.
fœ¡
);

9643 autØ
pgid
 : 
to_d–‘e
) {

9644 
pg_¦Ùs
.
	`”a£
(
pgid
);

9646 
	}
}

9650 #undeà
dout_cÚ‹xt


9651 
	#dout_cÚ‹xt
 
osd
->
cù


	)

9652 #undeà
dout_´efix


9653 
	#dout_´efix
 *
_dout
 << "osd." << 
osd
->
whßmi
 << " op_wq "

	)

9655 
	gOSD
::
Sh¬dedOpWQ
::
	$_add_¦Ù_wa™”
(

9656 
¥g_t
 
pgid
,

9657 
OSDSh¬dPGSlÙ
 *
¦Ù
,

9658 
OpQueueI‹m
&& 
qi
)

9660 ià(
qi
.
	`is_³”šg
()) {

9661 
	`dout
(20è<< 
__func__
 << " " << 
pgid


9663 << 
qi
.
	`g‘_m­_•och
()

9664 << ", wÈwa™ oÀ" << 
qi
 << 
d’dl
;

9665 
¦Ù
->
wa™šg_³”šg
[
qi
.
	`g‘_m­_•och
()].
	`push_back
(
¡d
::
	`move
(qi));

9667 
	`dout
(20è<< 
__func__
 << " " << 
pgid


9669 << 
qi
.
	`g‘_m­_•och
()

9670 << ", wÈwa™ oÀ" << 
qi
 << 
d’dl
;

9671 
¦Ù
->
wa™šg
.
	`push_back
(
¡d
::
	`move
(
qi
));

9673 
	}
}

9675 #undeà
dout_´efix


9676 
	#dout_´efix
 *
_dout
 << "osd." << 
osd
->
whßmi
 << " op_wq(" << 
sh¬d_šdex
 << "è"

	)

9678 
	gOSD
::
Sh¬dedOpWQ
::
	$_´oûss
(
ušt32_t
 
th»ad_šdex
, 
h—¹b—t_hªdË_d
 *
hb
)

9680 
ušt32_t
 
sh¬d_šdex
 = 
th»ad_šdex
 % 
osd
->
num_sh¬ds
;

9681 auto& 
sd©a
 = 
osd
->
sh¬ds
[
sh¬d_šdex
];

9682 
	`as£¹
(
sd©a
);

9684 
sd©a
->
sh¬d_lock
.
	`Lock
();

9685 ià(
sd©a
->
pqueue
->
	`em±y
()) {

9686 
sd©a
->
sd©a_wa™_lock
.
	`Lock
();

9687 ià(!
sd©a
->
¡İ_wa™šg
) {

9688 
	`dout
(20è<< 
__func__
 << "ƒm±y q, wa™šg" << 
d’dl
;

9689 
osd
->
cù
->
	`g‘_h—¹b—t_m­
()->
	`ş—r_timeout
(
hb
);

9690 
sd©a
->
sh¬d_lock
.
	`UÆock
();

9691 
sd©a
->
sd©a_cÚd
.
	`Wa™
(sd©a->
sd©a_wa™_lock
);

9692 
sd©a
->
sd©a_wa™_lock
.
	`UÆock
();

9693 
sd©a
->
sh¬d_lock
.
	`Lock
();

9694 ià(
sd©a
->
pqueue
->
	`em±y
()) {

9695 
sd©a
->
sh¬d_lock
.
	`UÆock
();

9698 
osd
->
cù
->
	`g‘_h—¹b—t_m­
()->
	`»£t_timeout
(
hb
,

9699 
osd
->
cù
->
_cÚf
->
th»adpoŞ_deçuÉ_timeout
, 0);

9701 
	`dout
(0è<< 
__func__
 << "‚“d„‘uº immedŸ‹ly" << 
d’dl
;

9702 
sd©a
->
sd©a_wa™_lock
.
	`UÆock
();

9703 
sd©a
->
sh¬d_lock
.
	`UÆock
();

9707 
OpQueueI‹m
 
™em
 = 
sd©a
->
pqueue
->
	`dequeue
();

9708 ià(
osd
->
	`is_¡İpšg
()) {

9709 
sd©a
->
sh¬d_lock
.
	`UÆock
();

9712 cÚ¡‡utØ
tok’
 = 
™em
.
	`g‘_Üd”šg_tok’
();

9713 autØ
r
 = 
sd©a
->
pg_¦Ùs
.
	`em¶aû
(
tok’
, 
nuÎ±r
);

9714 ià(
r
.
£cÚd
) {

9715 
r
.
fœ¡
->
£cÚd
 = 
make_unique
<
OSDSh¬dPGSlÙ
>();

9717 
OSDSh¬dPGSlÙ
 *
¦Ù
 = 
r
.
fœ¡
->
£cÚd
.
	`g‘
();

9718 
	`dout
(20è<< 
__func__
 << " " << 
tok’


9719 << (
r
.
£cÚd
 ? " (new)" : "")

9720 << "o_´oûs " << 
¦Ù
->
to_´oûss


9721 << " wa™šg " << 
¦Ù
->
wa™šg


9722 << " wa™šg_³”šg " << 
¦Ù
->
wa™šg_³”šg


9723 << 
d’dl
;

9724 
¦Ù
->
to_´oûss
.
	`push_back
(
¡d
::
	`move
(
™em
));

9725 
	`dout
(20è<< 
__func__
 << " " << 
¦Ù
->
to_´oûss
.
	`back
()

9726 << " queued" << 
d’dl
;

9728 
»Œy_pg
:

9729 
PGRef
 
pg
 = 
¦Ù
->pg;

9732 ià(
pg
) {

9734 
ušt64_t
 
»queue_£q
 = 
¦Ù
->requeue_seq;

9735 ++
¦Ù
->
num_ruÂšg
;

9737 
sd©a
->
sh¬d_lock
.
	`UÆock
();

9738 
osd
->
£rviû
.
	`maybe_šjeù_di¥©ch_d–ay
();

9739 
pg
->
	`lock
();

9740 
osd
->
£rviû
.
	`maybe_šjeù_di¥©ch_d–ay
();

9741 
sd©a
->
sh¬d_lock
.
	`Lock
();

9743 autØ
q
 = 
sd©a
->
pg_¦Ùs
.
	`fšd
(
tok’
);

9744 ià(
q
 =ğ
sd©a
->
pg_¦Ùs
.
	`’d
()) {

9746 
	`dout
(20è<< 
__func__
 << " slÙ " << 
tok’
 << "‚ØlÚg”h”e" << 
d’dl
;

9747 
pg
->
	`uÆock
();

9748 
sd©a
->
sh¬d_lock
.
	`UÆock
();

9751 
¦Ù
 = 
q
->
£cÚd
.
	`g‘
();

9752 --
¦Ù
->
num_ruÂšg
;

9754 ià(
¦Ù
->
to_´oûss
.
	`em±y
()) {

9756 
	`dout
(20è<< 
__func__
 << " " << 
tok’


9757 << "‚Ùhšg queued" << 
d’dl
;

9758 
pg
->
	`uÆock
();

9759 
sd©a
->
sh¬d_lock
.
	`UÆock
();

9762 ià(
»queue_£q
 !ğ
¦Ù
->requeue_seq) {

9763 
	`dout
(20è<< 
__func__
 << " " << 
tok’


9764 << "„equeue_£q " << 
¦Ù
->
»queue_£q
 << " > our "

9765 << 
»queue_£q
 << ", we„aced with _wake_pg_slot"

9766 << 
d’dl
;

9767 
pg
->
	`uÆock
();

9768 
sd©a
->
sh¬d_lock
.
	`UÆock
();

9771 ià(
¦Ù
->
pg
 !=…g) {

9773 
	`dout
(20è<< 
__func__
 << " slÙ " << 
tok’
 << "‚o†onger‡ttachedo "

9774 << 
pg
 << 
d’dl
;

9775 
pg
->
	`uÆock
();

9776 
»Œy_pg
;

9780 
	`dout
(20è<< 
__func__
 << " " << 
tok’


9781 << "o_´oûs " << 
¦Ù
->
to_´oûss


9782 << " wa™šg " << 
¦Ù
->
wa™šg


9783 << " wa™šg_³”šg " << 
¦Ù
->
wa™šg_³”šg
 << 
d’dl
;

9785 
Th»adPoŞ
::
TPHªdË
 
	`_hªdË
(
osd
->
cù
, 
hb
, 
timeout_š‹rv®
,

9786 
suicide_š‹rv®
);

9789 autØ
qi
 = 
¡d
::
	`move
(
¦Ù
->
to_´oûss
.
	`äÚt
());

9790 
¦Ù
->
to_´oûss
.
	`pİ_äÚt
();

9791 
	`dout
(20è<< 
__func__
 << " " << 
qi
 << "…g " << 
pg
 << 
d’dl
;

9792 
£t
<
¥g_t
> 
Ãw_chd»n
;

9793 
OSDM­Ref
 
osdm­
;

9795 !
pg
) {

9797 
osdm­
 = 
sd©a
->
sh¬d_osdm­
;

9798 cÚ¡ 
PGC»©eInfo
 *
ü—‹_šfo
 = 
qi
.
	`ü—‹s_pg
();

9799 ià(
¦Ù
->
wa™šg_fÜ_¥l™
) {

9800 
	`dout
(20è<< 
__func__
 << " " << 
tok’


9801 << " s¶™tšg" << 
d’dl
;

9802 
	`_add_¦Ù_wa™”
(
tok’
, 
¦Ù
, 
¡d
::
	`move
(
qi
));

9803 } ià(
qi
.
	`g‘_m­_•och
(è> 
osdm­
->
	`g‘_•och
()) {

9804 
	`dout
(20è<< 
__func__
 << " " << 
tok’


9805 << " m­ " << 
qi
.
	`g‘_m­_•och
() << " > "

9806 << 
osdm­
->
	`g‘_•och
(è<< 
d’dl
;

9807 
	`_add_¦Ù_wa™”
(
tok’
, 
¦Ù
, 
¡d
::
	`move
(
qi
));

9808 } ià(
qi
.
	`is_³”šg
()) {

9809 ià(!
qi
.
	`³”šg_»quœes_pg
()) {

9812 
qi
.
	`run
(
osd
, 
sd©a
, 
pg
, 
_hªdË
);

9813 } ià(
osdm­
->
	`is_up_aùšg_osd_sh¬d
(
tok’
, 
osd
->
whßmi
)) {

9814 ià(
ü—‹_šfo
) {

9815 ià(
ü—‹_šfo
->
by_mÚ
 &&

9816 
osdm­
->
	`g‘_pg_aùšg_´im¬y
(
tok’
.
pgid
è!ğ
osd
->
whßmi
) {

9817 
	`dout
(20è<< 
__func__
 << " " << 
tok’


9819 << 
qi
 << 
d’dl
;

9821 
	`dout
(20è<< 
__func__
 << " " << 
tok’


9822 << "‚Øpg, should c»©Ú " << 
qi
 << 
d’dl
;

9823 
pg
 = 
osd
->
	`hªdË_pg_ü—‹_šfo
(
osdm­
, 
ü—‹_šfo
);

9824 ià(
pg
) {

9826 
sd©a
->
	`_©ch_pg
(
¦Ù
, 
pg
.
	`g‘
());

9827 
sd©a
->
	`_wake_pg_¦Ù
(
tok’
, 
¦Ù
);

9830 
osd
->
£rviû
.
	`id’tify_¥l™_chd»n
(

9831 
pg
->
	`g‘_osdm­
(), 
osdm­
,…g->
pg_id
, &
Ãw_chd»n
);

9832 
sd©a
->
	`_´ime_¥l™s
(&
Ãw_chd»n
);

9836 
	`dout
(20è<< 
__func__
 << " ignÜed c»©Ú " << 
qi
 << 
d’dl
;

9839 
	`dout
(20è<< 
__func__
 << " " << 
tok’


9840 << "‚Øpg,…“ršg, !ü—‹, disÿrdšg " << 
qi
 << 
d’dl
;

9843 
	`dout
(20è<< 
__func__
 << " " << 
tok’


9844 << "‚Øpg,…“ršg, dÛ¢'ˆm­ h”e" << 
osdm­
->
	`g‘_•och
()

9845 << ", disÿrdšg " << 
qi


9846 << 
d’dl
;

9848 } ià(
osdm­
->
	`is_up_aùšg_osd_sh¬d
(
tok’
, 
osd
->
whßmi
)) {

9849 
	`dout
(20è<< 
__func__
 << " " << 
tok’


9850 << "‚Øpg, shouldƒxi¡ƒ" << 
osdm­
->
	`g‘_•och
()

9851 << ", wÈwa™ oÀ" << 
qi
 << 
d’dl
;

9852 
	`_add_¦Ù_wa™”
(
tok’
, 
¦Ù
, 
¡d
::
	`move
(
qi
));

9854 
	`dout
(20è<< 
__func__
 << " " << 
tok’


9855 << "‚Øpg, shouldn'ˆexi¡ƒ" << 
osdm­
->
	`g‘_•och
()

9856 << ", drİpšg " << 
qi
 << 
d’dl
;

9858 ià(
boo¡
::
İtiÚ®
<
OpReque¡Ref
> 
_İ
 = 
qi
.
	`maybe_g‘_İ
()) {

9859 
SessiÚ
 *
£ssiÚ
 = 
¡©ic_ÿ¡
<Session *>(

9860 (*
_İ
)->
	`g‘_»q
()->
	`g‘_cÚÃùiÚ
()->
	`g‘_´iv
());

9861 ià(
£ssiÚ
) {

9862 
osd
->
	`maybe_sh¬e_m­
(
£ssiÚ
, *
_İ
, 
sd©a
->
sh¬d_osdm­
);

9863 
£ssiÚ
->
	`put
();

9866 
pushes_to_ä“
 = 
qi
.
	`g‘_»£rved_pushes
();

9867 ià(
pushes_to_ä“
 > 0) {

9868 
sd©a
->
sh¬d_lock
.
	`UÆock
();

9869 
osd
->
£rviû
.
	`»Ëa£_»£rved_pushes
(
pushes_to_ä“
);

9873 
sd©a
->
sh¬d_lock
.
	`UÆock
();

9876 ià(
qi
.
	`is_³”šg
()) {

9877 
OSDM­Ref
 
osdm­
 = 
sd©a
->
sh¬d_osdm­
;

9878 ià(
qi
.
	`g‘_m­_•och
(è> 
osdm­
->
	`g‘_•och
()) {

9879 
	`_add_¦Ù_wa™”
(
tok’
, 
¦Ù
, 
¡d
::
	`move
(
qi
));

9880 
sd©a
->
sh¬d_lock
.
	`UÆock
();

9881 
pg
->
	`uÆock
();

9885 
sd©a
->
sh¬d_lock
.
	`UÆock
();

9887 ià(!
Ãw_chd»n
.
	`em±y
()) {

9888 autØ
sh¬d
 : 
osd
->
sh¬ds
) {

9889 
sh¬d
->
	`´ime_¥l™s
(
osdm­
, &
Ãw_chd»n
);

9891 
	`as£¹
(
Ãw_chd»n
.
	`em±y
());

9897 #ifdeà
WITH_LTTNG


9898 
osd_»qid_t
 
»qid
;

9899 ià(
boo¡
::
İtiÚ®
<
OpReque¡Ref
> 
_İ
 = 
qi
.
	`maybe_g‘_İ
()) {

9900 
»qid
 = (*
_İ
)->
	`g‘_»qid
();

9903 
	`Œaûpošt
(
osd
, 
İwq_´oûss_¡¬t
, 
»qid
.
Çme
.
_ty³
,

9904 
»qid
.
Çme
.
_num
,„eqid.
tid
,„eqid.
šc
);

9907 
	`lg’”ic_subdout
(
osd
->
cù
, osd, 30) << "dequeue status: ";

9908 
FÜm©‹r
 *
f
 = FÜm©‹r::
	`ü—‹
("json");

9909 
f
->
	`İ’_objeù_£ùiÚ
("q");

9910 
	`dump
(
f
);

9911 
f
->
	`şo£_£ùiÚ
();

9912 
f
->
	`æush
(*
_dout
);

9913 
d–‘e
 
f
;

9914 *
_dout
 << 
d’dl
;

9916 
qi
.
	`run
(
osd
, 
sd©a
, 
pg
, 
_hªdË
);

9919 #ifdeà
WITH_LTTNG


9920 
osd_»qid_t
 
»qid
;

9921 ià(
boo¡
::
İtiÚ®
<
OpReque¡Ref
> 
_İ
 = 
qi
.
	`maybe_g‘_İ
()) {

9922 
»qid
 = (*
_İ
)->
	`g‘_»qid
();

9925 
	`Œaûpošt
(
osd
, 
İwq_´oûss_fšish
, 
»qid
.
Çme
.
_ty³
,

9926 
»qid
.
Çme
.
_num
,„eqid.
tid
,„eqid.
šc
);

9928 
	}
}

9930 
	gOSD
::
Sh¬dedOpWQ
::
	$_’queue
(
OpQueueI‹m
&& 
™em
) {

9931 
ušt32_t
 
sh¬d_šdex
 =

9932 
™em
.
	`g‘_Üd”šg_tok’
().
	`hash_to_sh¬d
(
osd
->
sh¬ds
.
	`size
());

9934 
OSDSh¬d
* 
sd©a
 = 
osd
->
sh¬ds
[
sh¬d_šdex
];

9935 
	`as£¹
 (
NULL
 !ğ
sd©a
);

9936 
´iÜ™y
 = 
™em
.
	`g‘_´iÜ™y
();

9937 
co¡
 = 
™em
.
	`g‘_co¡
();

9938 
sd©a
->
sh¬d_lock
.
	`Lock
();

9940 
	`dout
(20è<< 
__func__
 << " " << 
™em
 << 
d’dl
;

9941 ià(
´iÜ™y
 >ğ
osd
->
İ_´io_cutoff
)

9942 
sd©a
->
pqueue
->
	`’queue_¡riù
(

9943 
™em
.
	`g‘_owÃr
(), 
´iÜ™y
, 
¡d
::
	`move
(item));

9945 
sd©a
->
pqueue
->
	`’queue
(

9946 
™em
.
	`g‘_owÃr
(), 
´iÜ™y
, 
co¡
, 
¡d
::
	`move
(item));

9947 
sd©a
->
sh¬d_lock
.
	`UÆock
();

9949 
sd©a
->
sd©a_wa™_lock
.
	`Lock
();

9950 
sd©a
->
sd©a_cÚd
.
	`SigÇlOÃ
();

9951 
sd©a
->
sd©a_wa™_lock
.
	`UÆock
();

9953 
	}
}

9955 
	gOSD
::
Sh¬dedOpWQ
::
	$_’queue_äÚt
(
OpQueueI‹m
&& 
™em
)

9957 autØ
sh¬d_šdex
 = 
™em
.
	`g‘_Üd”šg_tok’
().
	`hash_to_sh¬d
(
osd
->
sh¬ds
.
	`size
());

9958 auto& 
sd©a
 = 
osd
->
sh¬ds
[
sh¬d_šdex
];

9959 
	`as£¹
(
sd©a
);

9960 
sd©a
->
sh¬d_lock
.
	`Lock
();

9961 autØ
p
 = 
sd©a
->
pg_¦Ùs
.
	`fšd
(
™em
.
	`g‘_Üd”šg_tok’
());

9962 ià(
p
 !ğ
sd©a
->
pg_¦Ùs
.
	`’d
() &&

9963 !
p
->
£cÚd
->
to_´oûss
.
	`em±y
()) {

9968 
p
->
£cÚd
->
to_´oûss
.
	`push_äÚt
(
¡d
::
	`move
(
™em
));

9969 
™em
 = 
¡d
::
	`move
(
p
->
£cÚd
->
to_´oûss
.
	`back
());

9970 
p
->
£cÚd
->
to_´oûss
.
	`pİ_back
();

9971 
	`dout
(20è<< 
__func__


9972 << " " << 
p
->
£cÚd
->
to_´oûss
.
	`äÚt
()

9973 << " shufæed w/ " << 
™em
 << 
d’dl
;

9975 
	`dout
(20è<< 
__func__
 << " " << 
™em
 << 
d’dl
;

9977 
sd©a
->
	`_’queue_äÚt
(
¡d
::
	`move
(
™em
), 
osd
->
İ_´io_cutoff
);

9978 
sd©a
->
sh¬d_lock
.
	`UÆock
();

9979 
sd©a
->
sd©a_wa™_lock
.
	`Lock
();

9980 
sd©a
->
sd©a_cÚd
.
	`SigÇlOÃ
();

9981 
sd©a
->
sd©a_wa™_lock
.
	`UÆock
();

9982 
	}
}

9984 
Çme¥aû
 
	gûph
 {

9985 
Çme¥aû
 
	gosd_cmds
 {

9987 
h—p
(
C•hCÚ‹xt
& 
cù
, cÚ¡ 
cmdm­_t
& 
cmdm­
, 
FÜm©‹r
& 
f
,

9988 
¡d
::
o¡»am
& 
os
)

9990 ià(!
ûph_usšg_tcm®loc
()) {

9991 
os
 << "could‚ot issue heap…rofiler command --‚ot usingcmalloc!";

9992  -
	gEOPNOTSUPP
;

9995 
¡ršg
 
	gcmd
;

9996 ià(!
cmd_g‘v®
(&
cù
, 
cmdm­
, "h—pcmd", 
cmd
)) {

9997 
	gos
 << "uÇbËØg‘ v®ufÜ commªd \"" << 
	gcmd
 << "\"";

9998  -
	gEINVAL
;

10001 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
cmd_vec
;

10002 
g‘_¡r_vec
(
cmd
, 
cmd_vec
);

10004 
ûph_h—p_´of”_hªdË_commªd
(
cmd_vec
, 
os
);

10012 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
out
, cÚ¡ 
	gio_queue
& 
	gq
) {

10013 
	gq
) {

10014 
	gio_queue
::
´iÜ™ized
:

10015 
out
 << "prioritized";

10017 
	gio_queue
::
weigh‹d´iÜ™y
:

10018 
out
 << "weightedpriority";

10020 
	gio_queue
::
mşock_İşass
:

10021 
out
 << "mclock_opclass";

10023 
	gio_queue
::
mşock_ş›Á
:

10024 
out
 << "mclock_client";

10027  
	gout
;

	@osd/OSD.h

15 #iâdeà
CEPH_OSD_H


16 
	#CEPH_OSD_H


	)

18 
	~"PG.h
"

20 
	~"msg/Di¥©ch”.h
"

22 
	~"commÚ/Mu‹x.h
"

23 
	~"commÚ/RWLock.h
"

24 
	~"commÚ/Tim”.h
"

25 
	~"commÚ/WÜkQueue.h
"

26 
	~"commÚ/AsyncRe£rv”.h
"

27 
	~"commÚ/ûph_cÚ‹xt.h
"

28 
	~"commÚ/cÚfig_ÿch”.h
"

29 
	~"commÚ/zkš_Œaû.h
"

31 
	~"mgr/MgrCl›Á.h
"

33 
	~"os/ObjeùStÜe.h
"

34 
	~"OSDC­.h
"

36 
	~"auth/KeyRšg.h
"

37 
	~"osd/CÏssHªdËr.h
"

39 
	~"šşude/Com·tS‘.h
"

41 
	~"OpReque¡.h
"

42 
	~"SessiÚ.h
"

44 
	~"osd/OpQueueI‹m.h
"

46 
	~<©omic
>

47 
	~<m­
>

48 
	~<memÜy
>

49 
	~"šşude/memÜy.h
"

51 
	~"šşude/unÜd”ed_m­.h
"

53 
	~"commÚ/sh¬ed_ÿche.hµ
"

54 
	~"commÚ/sim¶e_ÿche.hµ
"

55 
	~"commÚ/sh¬ed±r_»gi¡ry.hµ
"

56 
	~"commÚ/Weigh‹dPriÜ™yQueue.h
"

57 
	~"commÚ/PriÜ™izedQueue.h
"

58 
	~"osd/mClockOpCÏssQueue.h
"

59 
	~"osd/mClockCl›ÁQueue.h
"

60 
	~"mes§ges/MOSDOp.h
"

61 
	~"commÚ/Ev’tT¿û.h
"

63 
	#CEPH_OSD_PROTOCOL
 10

	)

76 
	ml_osd_fœ¡
 = 10000,

77 
	ml_osd_İ_w
,

78 
	ml_osd_İ
,

79 
	ml_osd_İ_šb
,

80 
	ml_osd_İ_outb
,

81 
	ml_osd_İ_Ït
,

82 
	ml_osd_İ_´oûss_Ït
,

83 
	ml_osd_İ_´•¬e_Ït
,

84 
	ml_osd_İ_r
,

85 
	ml_osd_İ_r_outb
,

86 
	ml_osd_İ_r_Ït
,

87 
	ml_osd_İ_r_Ït_outb_hi¡
,

88 
	ml_osd_İ_r_´oûss_Ït
,

89 
	ml_osd_İ_r_´•¬e_Ït
,

90 
	ml_osd_İ_w
,

91 
	ml_osd_İ_w_šb
,

92 
	ml_osd_İ_w_Ït
,

93 
	ml_osd_İ_w_Ït_šb_hi¡
,

94 
	ml_osd_İ_w_´oûss_Ït
,

95 
	ml_osd_İ_w_´•¬e_Ït
,

96 
	ml_osd_İ_rw
,

97 
	ml_osd_İ_rw_šb
,

98 
	ml_osd_İ_rw_outb
,

99 
	ml_osd_İ_rw_Ït
,

100 
	ml_osd_İ_rw_Ït_šb_hi¡
,

101 
	ml_osd_İ_rw_Ït_outb_hi¡
,

102 
	ml_osd_İ_rw_´oûss_Ït
,

103 
	ml_osd_İ_rw_´•¬e_Ït
,

105 
	ml_osd_İ_befÜe_queue_İ_Ït
,

106 
	ml_osd_İ_befÜe_dequeue_İ_Ït
,

108 
	ml_osd_sİ
,

109 
	ml_osd_sİ_šb
,

110 
	ml_osd_sİ_Ït
,

111 
	ml_osd_sİ_w
,

112 
	ml_osd_sİ_w_šb
,

113 
	ml_osd_sİ_w_Ït
,

114 
	ml_osd_sİ_puÎ
,

115 
	ml_osd_sİ_puÎ_Ït
,

116 
	ml_osd_sİ_push
,

117 
	ml_osd_sİ_push_šb
,

118 
	ml_osd_sİ_push_Ït
,

120 
	ml_osd_puÎ
,

121 
	ml_osd_push
,

122 
	ml_osd_push_outb
,

124 
	ml_osd_rİ
,

126 
	ml_osd_lßdavg
,

127 
	ml_osd_buf
,

128 
	ml_osd_hi¡Üy_®loc_by‹s
,

129 
	ml_osd_hi¡Üy_®loc_num
,

130 
	ml_osd_ÿched_üc
,

131 
	ml_osd_ÿched_üc_adju¡ed
,

132 
	ml_osd_mis£d_üc
,

134 
	ml_osd_pg
,

135 
	ml_osd_pg_´im¬y
,

136 
	ml_osd_pg_»¶iÿ
,

137 
	ml_osd_pg_¡¿y
,

138 
	ml_osd_pg_»movšg
,

139 
	ml_osd_hb_to
,

140 
	ml_osd_m­
,

141 
	ml_osd_m­e
,

142 
	ml_osd_m­e_dup
,

144 
	ml_osd_wa™šg_fÜ_m­
,

146 
	ml_osd_m­_ÿche_h™
,

147 
	ml_osd_m­_ÿche_miss
,

148 
	ml_osd_m­_ÿche_miss_low
,

149 
	ml_osd_m­_ÿche_miss_low_avg
,

150 
	ml_osd_m­_bl_ÿche_h™
,

151 
	ml_osd_m­_bl_ÿche_miss
,

153 
	ml_osd_¡©_by‹s
,

154 
	ml_osd_¡©_by‹s_u£d
,

155 
	ml_osd_¡©_by‹s_ava
,

157 
	ml_osd_cİyäom
,

159 
	ml_osd_t›r_´omÙe
,

160 
	ml_osd_t›r_æush
,

161 
	ml_osd_t›r_æush_ç
,

162 
	ml_osd_t›r_Œy_æush
,

163 
	ml_osd_t›r_Œy_æush_ç
,

164 
	ml_osd_t›r_eviù
,

165 
	ml_osd_t›r_wh™eout
,

166 
	ml_osd_t›r_dœty
,

167 
	ml_osd_t›r_ş—n
,

168 
	ml_osd_t›r_d–ay
,

169 
	ml_osd_t›r_´oxy_»ad
,

170 
	ml_osd_t›r_´oxy_wr™e
,

172 
	ml_osd_ag’t_wake
,

173 
	ml_osd_ag’t_sk
,

174 
	ml_osd_ag’t_æush
,

175 
	ml_osd_ag’t_eviù
,

177 
	ml_osd_objeù_ùx_ÿche_h™
,

178 
	ml_osd_objeù_ùx_ÿche_tÙ®
,

180 
	ml_osd_İ_ÿche_h™
,

181 
	ml_osd_t›r_æush_Ït
,

182 
	ml_osd_t›r_´omÙe_Ït
,

183 
	ml_osd_t›r_r_Ït
,

185 
	ml_osd_pg_šfo
,

186 
	ml_osd_pg_ç¡šfo
,

187 
	ml_osd_pg_bigšfo
,

189 
	ml_osd_Ï¡
,

194 
	mrs_fœ¡
 = 20000,

195 
	mrs_š™Ÿl_Ï‹ncy
,

196 
	mrs_¡¬‹d_Ï‹ncy
,

197 
	mrs_»£t_Ï‹ncy
,

198 
	mrs_¡¬t_Ï‹ncy
,

199 
	mrs_´im¬y_Ï‹ncy
,

200 
	mrs_³”šg_Ï‹ncy
,

201 
	mrs_backflšg_Ï‹ncy
,

202 
	mrs_wa™»mÙebackfÌe£rved_Ï‹ncy
,

203 
	mrs_wa™loÿlbackfÌe£rved_Ï‹ncy
,

204 
	mrs_nÙbackflšg_Ï‹ncy
,

205 
	mrs_»²Ù»cov”šg_Ï‹ncy
,

206 
	mrs_»pwa™»cov”y»£rved_Ï‹ncy
,

207 
	mrs_»pwa™backfÌe£rved_Ï‹ncy
,

208 
	mrs_»´ecov”šg_Ï‹ncy
,

209 
	mrs_aùiv©šg_Ï‹ncy
,

210 
	mrs_wa™loÿÌecov”y»£rved_Ï‹ncy
,

211 
	mrs_wa™»mÙ”ecov”y»£rved_Ï‹ncy
,

212 
	mrs_»cov”šg_Ï‹ncy
,

213 
	mrs_»cov”ed_Ï‹ncy
,

214 
	mrs_ş—n_Ï‹ncy
,

215 
	mrs_aùive_Ï‹ncy
,

216 
	mrs_»¶iÿaùive_Ï‹ncy
,

217 
	mrs_¡¿y_Ï‹ncy
,

218 
	mrs_g‘šfo_Ï‹ncy
,

219 
	mrs_g‘log_Ï‹ncy
,

220 
	mrs_wa™aùšgchªge_Ï‹ncy
,

221 
	mrs_šcom¶‘e_Ï‹ncy
,

222 
	mrs_down_Ï‹ncy
,

223 
	mrs_g‘missšg_Ï‹ncy
,

224 
	mrs_wa™u±hru_Ï‹ncy
,

225 
	mrs_nÙ»cov”šg_Ï‹ncy
,

226 
	mrs_Ï¡
,

229 
şass
 
	gMes£ng”
;

230 
şass
 
	gMes§ge
;

231 
şass
 
	gMÚCl›Á
;

232 
şass
 
	gP”fCouÁ”s
;

233 
şass
 
	gObjeùStÜe
;

234 
şass
 
	gFu£StÜe
;

235 
şass
 
	gOSDM­
;

236 
şass
 
	gMLog
;

237 
şass
 
	gObjeù”
;

239 
şass
 
	gW©ch
;

240 
şass
 
	gPrim¬yLogPG
;

242 
şass
 
	gAuthAuthÜizeHªdËrRegi¡ry
;

244 
şass
 
	gTe¡OpsSock‘Hook
;

245 
	gC_FšishS¶™s
;

246 
	gC_O³nPGs
;

247 
şass
 
	gLogChªÃl
;

248 
şass
 
	gC•hCÚ‹xt
;

249 
şass
 
	gMOSDOp
;

251 
şass
 
	gMOSDPGC»©e2
;

252 
şass
 
	gMOSDPGQu”y
;

253 
şass
 
	gMOSDPGNÙify
;

254 
şass
 
	gMOSDPGInfo
;

255 
şass
 
	gMOSDPGRemove
;

256 
şass
 
	gMOSDFÜûRecov”y
;

258 
şass
 
	gOSD
;

260 şas 
	cOSDS”viû
 {

261 
	mpublic
:

262 
OSD
 *
osd
;

263 
C•hCÚ‹xt
 *
	mcù
;

264 
	mObjeùStÜe
::
CŞËùiÚHªdË
 
m‘a_ch
;

265 cÚ¡ 
	mwhßmi
;

266 
	mObjeùStÜe
 *&
	m¡Üe
;

267 
	mLogCl›Á
 &
	mlog_ş›Á
;

268 
LogChªÃlRef
 
	mşog
;

269 
	mPGRecov”ySts
 &
	mpg_»cov”y_¡©s
;

270 
	m´iv©e
:

271 
Mes£ng”
 *&
şu¡”_mes£ng”
;

272 
	mMes£ng”
 *&
	mş›Á_mes£ng”
;

273 
	mpublic
:

274 
P”fCouÁ”s
 *&
logg”
;

275 
	mP”fCouÁ”s
 *&
	m»cov”y¡©e_³rf
;

276 
	mMÚCl›Á
 *&
	mmÚc
;

277 
	mCÏssHªdËr
 *&
	mşass_hªdËr
;

279 
	mmd_cÚfig_ÿch”_t
<
	mušt64_t
> 
	mosd_max_objeù_size
;

280 
	mmd_cÚfig_ÿch”_t
<
	mboŞ
> 
	mosd_sk_d©a_dige¡
;

282 
’queue_back
(
OpQueueI‹m
&& 
qi
);

283 
’queue_äÚt
(
OpQueueI‹m
&& 
qi
);

285 
	$maybe_šjeù_di¥©ch_d–ay
() {

286 ià(
g_cÚf
->
osd_debug_šjeù_di¥©ch_d–ay_´obab™y
 > 0) {

287 ià(
	`¿nd
() % 10000 <

288 
g_cÚf
->
osd_debug_šjeù_di¥©ch_d–ay_´obab™y
 * 10000) {

289 
utime_t
 
t
;

290 
t
.
	`£t_äom_doubË
(
g_cÚf
->
osd_debug_šjeù_di¥©ch_d–ay_du¿tiÚ
);

291 
t
.
	`¦“p
();

296 
´iv©e
:

298 
Mu‹x
 
publish_lock
, 
´e_publish_lock
;

299 
OSDSu³rblock
 
su³rblock
;

301 
public
:

302 
OSDSu³rblock
 
	$g‘_su³rblock
() {

303 
Mu‹x
::
Lock”
 
	`l
(
publish_lock
);

304  
su³rblock
;

305 
	}
}

306 
	$publish_su³rblock
(cÚ¡ 
OSDSu³rblock
 &
block
) {

307 
Mu‹x
::
Lock”
 
	`l
(
publish_lock
);

308 
su³rblock
 = 
block
;

309 
	}
}

311 
	$g‘_nodeid
(ècÚ¡ {  
whßmi
; 
	}
}

313 
	g¡d
::
©omic
<
•och_t
> 
max_Şde¡_m­
;

314 
	g´iv©e
:

315 
OSDM­Ref
 
osdm­
;

317 
	gpublic
:

318 
OSDM­Ref
 
	$g‘_osdm­
() {

319 
Mu‹x
::
Lock”
 
	`l
(
publish_lock
);

320  
osdm­
;

321 
	}
}

322 
•och_t
 
	$g‘_osdm­_•och
() {

323 
Mu‹x
::
Lock”
 
	`l
(
publish_lock
);

324  
osdm­
 ? osdm­->
	`g‘_•och
() : 0;

325 
	}
}

326 
	$publish_m­
(
OSDM­Ref
 
m­
) {

327 
Mu‹x
::
Lock”
 
	`l
(
publish_lock
);

328 
osdm­
 = 
m­
;

329 
	}
}

345 
	g´iv©e
:

346 
OSDM­Ref
 
Ãxt_osdm­
;

347 
CÚd
 
	g´e_publish_cÚd
;

349 
	gpublic
:

350 
	$´e_publish_m­
(
OSDM­Ref
 
m­
) {

351 
Mu‹x
::
Lock”
 
	`l
(
´e_publish_lock
);

352 
Ãxt_osdm­
 = 
¡d
::
	`move
(
m­
);

353 
	}
}

355 
aùiv©e_m­
();

357 
	gm­
<
	g•och_t
, > 
	gm­_»£rv©iÚs
;

360 
OSDM­Ref
 
	$g‘_Ãxtm­_»£rved
() {

361 
Mu‹x
::
Lock”
 
	`l
(
´e_publish_lock
);

362 ià(!
Ãxt_osdm­
)

363  
	`OSDM­Ref
();

364 
•och_t
 
e
 = 
Ãxt_osdm­
->
	`g‘_•och
();

365 
m­
<
•och_t
, >::
™”©Ü
 
i
 =

366 
m­_»£rv©iÚs
.
	`š£¹
(
	`make_·œ
(
e
, 0)).
fœ¡
;

367 
i
->
£cÚd
++;

368  
Ãxt_osdm­
;

369 
	}
}

371 
	$»Ëa£_m­
(
OSDM­Ref
 
osdm­
) {

372 
Mu‹x
::
Lock”
 
	`l
(
´e_publish_lock
);

373 
m­
<
•och_t
, >::
™”©Ü
 
i
 =

374 
m­_»£rv©iÚs
.
	`fšd
(
osdm­
->
	`g‘_•och
());

375 
	`as£¹
(
i
 !ğ
m­_»£rv©iÚs
.
	`’d
());

376 
	`as£¹
(
i
->
£cÚd
 > 0);

377 ià(--(
i
->
£cÚd
) == 0) {

378 
m­_»£rv©iÚs
.
	`”a£
(
i
);

380 
´e_publish_cÚd
.
	`SigÇl
();

381 
	}
}

383 
	$awa™_»£rved_m­s
() {

384 
Mu‹x
::
Lock”
 
	`l
(
´e_publish_lock
);

385 
	`as£¹
(
Ãxt_osdm­
);

386 
Œue
) {

387 
m­
<
•och_t
, >::
cÚ¡_™”©Ü
 
i
 = 
m­_»£rv©iÚs
.
	`cbegš
();

388 ià(
i
 =ğ
m­_»£rv©iÚs
.
	`ûnd
(è|| i->
fœ¡
 >ğ
Ãxt_osdm­
->
	`g‘_•och
()) {

391 
´e_publish_cÚd
.
	`Wa™
(
´e_publish_lock
);

394 
	}
}

395 
OSDM­Ref
 
	$g‘_Ãxt_osdm­
() {

396 
Mu‹x
::
Lock”
 
	`l
(
´e_publish_lock
);

397 ià(!
Ãxt_osdm­
)

398  
	`OSDM­Ref
();

399  
Ãxt_osdm­
;

400 
	}
}

402 
	g´iv©e
:

403 
Mu‹x
 
³”_m­_•och_lock
;

404 
	gm­
<, 
	g•och_t
> 
	g³”_m­_•och
;

405 
	gpublic
:

406 
•och_t
 
g‘_³”_•och
(
p
);

407 
•och_t
 
nÙe_³”_•och
(
p
,ƒpoch_ˆ
e
);

408 
fÜg‘_³”_•och
(
p
, 
•och_t
 
e
);

410 
£nd_m­
(
şass
 
MOSDM­
 *
m
, 
CÚÃùiÚ
 *
cÚ
);

411 
£nd_šüem’l_m­
(
•och_t
 
sšû
, 
CÚÃùiÚ
 *
cÚ
, 
OSDM­Ref
& 
osdm­
);

412 
MOSDM­
 *
bud_šüem’l_m­_msg
(
•och_t
 
äom
,ƒpoch_ˆ
to
,

413 
OSDSu³rblock
& 
su³rblock
);

414 
boŞ
 
should_sh¬e_m­
(
’t™y_Çme_t
 
Çme
, 
CÚÃùiÚ
 *
cÚ
, 
•och_t
 
•och
,

415 cÚ¡ 
OSDM­Ref
& 
osdm­
, cÚ¡ 
•och_t
 *
£Á_•och_p
);

416 
sh¬e_m­
(
’t™y_Çme_t
 
Çme
, 
CÚÃùiÚ
 *
cÚ
, 
•och_t
 
•och
,

417 
OSDM­Ref
& 
osdm­
, 
•och_t
 *
£Á_•och_p
);

418 
sh¬e_m­_³”
(
³”
, 
CÚÃùiÚ
 *
cÚ
,

419 
OSDM­Ref
 
m­
 = OSDMapRef());

421 
CÚÃùiÚRef
 
g‘_cÚ_osd_şu¡”
(
³”
, 
•och_t
 
äom_•och
);

422 
	g·œ
<
	gCÚÃùiÚRef
,CÚÃùiÚRef> 
g‘_cÚ_osd_hb
(
³”
, 
•och_t
 
äom_•och
);

423 
£nd_mes§ge_osd_şu¡”
(
³”
, 
Mes§ge
 *
m
, 
•och_t
 
äom_•och
);

424 
	$£nd_mes§ge_osd_şu¡”
(
Mes§ge
 *
m
, 
CÚÃùiÚ
 *
cÚ
) {

425 
cÚ
->
	`£nd_mes§ge
(
m
);

426 
	}
}

427 
	$£nd_mes§ge_osd_şu¡”
(
Mes§ge
 *
m
, cÚ¡ 
CÚÃùiÚRef
& 
cÚ
) {

428 
cÚ
->
	`£nd_mes§ge
(
m
);

429 
	}
}

430 
	$£nd_mes§ge_osd_ş›Á
(
Mes§ge
 *
m
, 
CÚÃùiÚ
 *
cÚ
) {

431 
cÚ
->
	`£nd_mes§ge
(
m
);

432 
	}
}

433 
	$£nd_mes§ge_osd_ş›Á
(
Mes§ge
 *
m
, cÚ¡ 
CÚÃùiÚRef
& 
cÚ
) {

434 
cÚ
->
	`£nd_mes§ge
(
m
);

435 
	}
}

436 
’t™y_Çme_t
 
	$g‘_şu¡”_msgr_Çme
() {

437  
şu¡”_mes£ng”
->
	`g‘_myÇme
();

438 
	}
}

440 
	g´iv©e
:

442 
Mu‹x
 
sched_süub_lock
;

443 
	gsüubs_³ndšg
;

444 
	gsüubs_aùive
;

446 
	gpublic
:

447 
	sSüubJob
 {

448 
C•hCÚ‹xt
* 
cù
;

450 
¥g_t
 
	gpgid
;

453 
utime_t
 
	gsched_time
;

455 
utime_t
 
	gd—dlše
;

456 
SüubJob
(è: 
cù
(
nuÎ±r
) {}

457 
ex¶ic™
 
SüubJob
(
C•hCÚ‹xt
* 
cù
, cÚ¡ 
¥g_t
& 
pg
,

458 cÚ¡ 
utime_t
& 
time¡amp
,

459 
poŞ_süub_mš_š‹rv®
 = 0,

460 
poŞ_süub_max_š‹rv®
 = 0, 
boŞ
 
mu¡
 = 
Œue
);

462 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	gSüubJob
& 
	grhs
) const;

464 
	g£t
<
	gSüubJob
> 
	gsched_süub_pg
;

467 
utime_t
 
	$»g_pg_süub
(
¥g_t
 
pgid
, 
utime_t
 
t
, 
poŞ_süub_mš_š‹rv®
,

468 
poŞ_süub_max_š‹rv®
, 
boŞ
 
mu¡
) {

469 
SüubJob
 
	`süub
(
cù
, 
pgid
, 
t
, 
poŞ_süub_mš_š‹rv®
, 
poŞ_süub_max_š‹rv®
,

470 
mu¡
);

471 
Mu‹x
::
Lock”
 
	`l
(
sched_süub_lock
);

472 
sched_süub_pg
.
	`š£¹
(
süub
);

473  
süub
.
sched_time
;

474 
	}
}

475 
	$uÄeg_pg_süub
(
¥g_t
 
pgid
, 
utime_t
 
t
) {

476 
Mu‹x
::
Lock”
 
	`l
(
sched_süub_lock
);

477 
size_t
 
»moved
 = 
sched_süub_pg
.
	`”a£
(
	`SüubJob
(
cù
, 
pgid
, 
t
));

478 
	`as£¹
(
»moved
);

479 
	}
}

480 
boŞ
 
	$fœ¡_süub_¡amp
(
SüubJob
 *
out
) {

481 
Mu‹x
::
Lock”
 
	`l
(
sched_süub_lock
);

482 ià(
sched_süub_pg
.
	`em±y
())

483  
çl£
;

484 
£t
<
SüubJob
>::
™”©Ü
 
™”
 = 
sched_süub_pg
.
	`begš
();

485 *
out
 = *
™”
;

486  
Œue
;

487 
	}
}

488 
boŞ
 
	$Ãxt_süub_¡amp
(cÚ¡ 
SüubJob
& 
Ãxt
,

489 
SüubJob
 *
out
) {

490 
Mu‹x
::
Lock”
 
	`l
(
sched_süub_lock
);

491 ià(
sched_süub_pg
.
	`em±y
())

492  
çl£
;

493 
£t
<
SüubJob
>::
cÚ¡_™”©Ü
 
™”
 = 
sched_süub_pg
.
	`low”_bound
(
Ãxt
);

494 ià(
™”
 =ğ
sched_süub_pg
.
	`ûnd
())

495  
çl£
;

496 ++
™”
;

497 ià(
™”
 =ğ
sched_süub_pg
.
	`ûnd
())

498  
çl£
;

499 *
out
 = *
™”
;

500  
Œue
;

501 
	}
}

503 
	$dumps_süub
(
FÜm©‹r
 *
f
) {

504 
	`as£¹
(
f
 !ğ
nuÎ±r
);

505 
Mu‹x
::
Lock”
 
	`l
(
sched_süub_lock
);

507 
f
->
	`İ’_¬¿y_£ùiÚ
("scrubs");

508 cÚ¡‡utØ&
i
: 
sched_süub_pg
) {

509 
f
->
	`İ’_objeù_£ùiÚ
("scrub");

510 
f
->
	`dump_¡»am
("pgid"è<< 
i
.
pgid
;

511 
f
->
	`dump_¡»am
("sched_time"è<< 
i
.
sched_time
;

512 
f
->
	`dump_¡»am
("d—dlše"è<< 
i
.
d—dlše
;

513 
f
->
	`dump_boŞ
("fÜûd", 
i
.
sched_time
 =ği.
d—dlše
);

514 
f
->
	`şo£_£ùiÚ
();

516 
f
->
	`şo£_£ùiÚ
();

517 
	}
}

519 
boŞ
 
ÿn_šc_süubs_³ndšg
();

520 
boŞ
 
šc_süubs_³ndšg
();

521 
šc_süubs_aùive
(
boŞ
 
»£rved
);

522 
dec_süubs_³ndšg
();

523 
dec_süubs_aùive
();

525 
»¶y_İ_”rÜ
(
OpReque¡Ref
 
İ
, 
”r
);

526 
»¶y_İ_”rÜ
(
OpReque¡Ref
 
İ
, 
”r
, 
ev”siÚ_t
 
v
, 
v”siÚ_t
 
uv
);

527 
hªdË_misdœeùed_İ
(
PG
 *
pg
, 
OpReque¡Ref
 
İ
);

530 
	g´iv©e
:

532 
Mu‹x
 
ag’t_lock
;

533 
CÚd
 
	gag’t_cÚd
;

534 
	gm­
<
	gušt64_t
, 
	g£t
<
	gPGRef
> > 
	gag’t_queue
;

535 
	g£t
<
	gPGRef
>::
™”©Ü
 
ag’t_queue_pos
;

536 
boŞ
 
	gag’t_v®id_™”©Ü
;

537 
	gag’t_İs
;

538 
	gæush_mode_high_couÁ
;

539 
	g£t
<
	ghobjeù_t
> 
	gag’t_oids
;

540 
boŞ
 
	gag’t_aùive
;

541 
	gAg’tTh»ad
 : 
public
 
Th»ad
 {

542 
OSDS”viû
 *
osd
;

543 
ex¶ic™
 
Ag’tTh»ad
(
OSDS”viû
 *
o
è: 
osd
(o) {}

544 *
’Œy
(è
ov”ride
 {

545 
osd
->
ag’t_’Œy
();

546  
	gNULL
;

548 } 
	gag’t_th»ad
;

549 
boŞ
 
	gag’t_¡İ_æag
;

550 
Mu‹x
 
	gag’t_tim”_lock
;

551 
SaãTim”
 
	gag’t_tim”
;

553 
	gpublic
:

554 
ag’t_’Œy
();

555 
ag’t_¡İ
();

557 
	$_’queue
(
PG
 *
pg
, 
ušt64_t
 
´iÜ™y
) {

558 ià(!
ag’t_queue
.
	`em±y
() &&

559 
ag’t_queue
.
	`rbegš
()->
fœ¡
 < 
´iÜ™y
)

560 
ag’t_v®id_™”©Ü
 = 
çl£
;

561 
£t
<
PGRef
>& 
nq
 = 
ag’t_queue
[
´iÜ™y
];

562 ià(
nq
.
	`em±y
())

563 
ag’t_cÚd
.
	`SigÇl
();

564 
nq
.
	`š£¹
(
pg
);

565 
	}
}

567 
	$_dequeue
(
PG
 *
pg
, 
ušt64_t
 
Şd_´iÜ™y
) {

568 
£t
<
PGRef
>& 
oq
 = 
ag’t_queue
[
Şd_´iÜ™y
];

569 
£t
<
PGRef
>::
™”©Ü
 
p
 = 
oq
.
	`fšd
(
pg
);

570 
	`as£¹
(
p
 !ğ
oq
.
	`’d
());

571 ià(
p
 =ğ
ag’t_queue_pos
)

572 ++
ag’t_queue_pos
;

573 
oq
.
	`”a£
(
p
);

574 ià(
oq
.
	`em±y
()) {

575 ià(
ag’t_queue
.
	`rbegš
()->
fœ¡
 =ğ
Şd_´iÜ™y
)

576 
ag’t_v®id_™”©Ü
 = 
çl£
;

577 
ag’t_queue
.
	`”a£
(
Şd_´iÜ™y
);

579 
	}
}

582 
	$ag’t_’abË_pg
(
PG
 *
pg
, 
ušt64_t
 
´iÜ™y
) {

583 
Mu‹x
::
Lock”
 
	`l
(
ag’t_lock
);

584 
	`_’queue
(
pg
, 
´iÜ™y
);

585 
	}
}

588 
	$ag’t_adju¡_pg
(
PG
 *
pg
, 
ušt64_t
 
Şd_´iÜ™y
, ušt64_ˆ
Ãw_´iÜ™y
) {

589 
Mu‹x
::
Lock”
 
	`l
(
ag’t_lock
);

590 
	`as£¹
(
Ãw_´iÜ™y
 !ğ
Şd_´iÜ™y
);

591 
	`_’queue
(
pg
, 
Ãw_´iÜ™y
);

592 
	`_dequeue
(
pg
, 
Şd_´iÜ™y
);

593 
	}
}

596 
	$ag’t_di§bË_pg
(
PG
 *
pg
, 
ušt64_t
 
Şd_´iÜ™y
) {

597 
Mu‹x
::
Lock”
 
	`l
(
ag’t_lock
);

598 
	`_dequeue
(
pg
, 
Şd_´iÜ™y
);

599 
	}
}

602 
	$ag’t_¡¬t_eviù_İ
() {

603 
Mu‹x
::
Lock”
 
	`l
(
ag’t_lock
);

604 ++
ag’t_İs
;

605 
	}
}

608 
	$ag’t_fšish_eviù_İ
() {

609 
Mu‹x
::
Lock”
 
	`l
(
ag’t_lock
);

610 
	`as£¹
(
ag’t_İs
 > 0);

611 --
ag’t_İs
;

612 
ag’t_cÚd
.
	`SigÇl
();

613 
	}
}

616 
	$ag’t_¡¬t_İ
(cÚ¡ 
hobjeù_t
& 
oid
) {

617 
Mu‹x
::
Lock”
 
	`l
(
ag’t_lock
);

618 ++
ag’t_İs
;

619 
	`as£¹
(
ag’t_oids
.
	`couÁ
(
oid
) == 0);

620 
ag’t_oids
.
	`š£¹
(
oid
);

621 
	}
}

624 
	$ag’t_fšish_İ
(cÚ¡ 
hobjeù_t
& 
oid
) {

625 
Mu‹x
::
Lock”
 
	`l
(
ag’t_lock
);

626 
	`as£¹
(
ag’t_İs
 > 0);

627 --
ag’t_İs
;

628 
	`as£¹
(
ag’t_oids
.
	`couÁ
(
oid
) == 1);

629 
ag’t_oids
.
	`”a£
(
oid
);

630 
ag’t_cÚd
.
	`SigÇl
();

631 
	}
}

634 
boŞ
 
	$ag’t_is_aùive_oid
(cÚ¡ 
hobjeù_t
& 
oid
) {

635 
Mu‹x
::
Lock”
 
	`l
(
ag’t_lock
);

636  
ag’t_oids
.
	`couÁ
(
oid
);

637 
	}
}

640 
	$ag’t_g‘_num_İs
() {

641 
Mu‹x
::
Lock”
 
	`l
(
ag’t_lock
);

642  
ag’t_İs
;

643 
	}
}

645 
	$ag’t_šc_high_couÁ
() {

646 
Mu‹x
::
Lock”
 
	`l
(
ag’t_lock
);

647 
æush_mode_high_couÁ
 ++;

648 
	}
}

650 
	$ag’t_dec_high_couÁ
() {

651 
Mu‹x
::
Lock”
 
	`l
(
ag’t_lock
);

652 
æush_mode_high_couÁ
 --;

653 
	}
}

655 
	g´iv©e
:

657 
¡d
::
©omic
<> 
´omÙe_´obab™y_mlis
{1000};

658 
PromÙeCouÁ”
 
	g´omÙe_couÁ”
;

659 
utime_t
 
	gÏ¡_»ÿlib¿‹
;

660 
	g´omÙe_max_objeùs
, 
	g´omÙe_max_by‹s
;

662 
	gpublic
:

663 
boŞ
 
	$´omÙe_thrÙe
() {

665 
´omÙe_couÁ”
.
	`©‹m±
();

666 ià(()
	`¿nd
(è% 1000 > 
´omÙe_´obab™y_mlis
)

667  
Œue
;

668 ià(
´omÙe_max_objeùs
 &&

669 
´omÙe_couÁ”
.
objeùs
 > 
´omÙe_max_objeùs
)

670  
Œue
;

671 ià(
´omÙe_max_by‹s
 &&

672 
´omÙe_couÁ”
.
by‹s
 > 
´omÙe_max_by‹s
)

673  
Œue
;

674  
çl£
;

675 
	}
}

676 
	$´omÙe_fšish
(
ušt64_t
 
by‹s
) {

677 
´omÙe_couÁ”
.
	`fšish
(
by‹s
);

678 
	}
}

679 
´omÙe_thrÙe_»ÿlib¿‹
();

682 
Objeù”
 *
	gobjeù”
;

683 
	gm_objeù”_fšish”s
;

684 
	gveùÜ
<
	gFšish”
*> 
	gobjeù”_fšish”s
;

687 
Mu‹x
 
	gw©ch_lock
;

688 
SaãTim”
 
	gw©ch_tim”
;

689 
ušt64_t
 
	gÃxt_nÙif_id
;

690 
ušt64_t
 
	$g‘_Ãxt_id
(
•och_t
 
cur_•och
) {

691 
Mu‹x
::
Lock”
 
	`l
(
w©ch_lock
);

692  (((
ušt64_t
)
cur_•och
è<< 32è| ((ušt64_t)(
Ãxt_nÙif_id
++));

693 
	}
}

696 
Mu‹x
 
	g»cov”y_»que¡_lock
;

697 
SaãTim”
 
	g»cov”y_»que¡_tim”
;

700 
boŞ
 
	g»cov”y_Ãeds_¦“p
 = 
Œue
;

701 
utime_t
 
	g»cov”y_scheduË_time
 = utime_t();

703 
Mu‹x
 
	g»cov”y_¦“p_lock
;

704 
SaãTim”
 
	g»cov”y_¦“p_tim”
;

708 
	g¡d
::
©omic
<> 
Ï¡_tid
{0};

709 
ûph_tid_t
 
	$g‘_tid
() {

710  (
ûph_tid_t
)
Ï¡_tid
++;

711 
	}
}

714 
Fšish”
 
	g»£rv”_fšish”
;

715 
	gAsyncRe£rv”
<
	g¥g_t
> 
	gloÿl_»£rv”
;

716 
	gAsyncRe£rv”
<
	g¥g_t
> 
	g»mÙe_»£rv”
;

719 
	g´iv©e
:

720 
Mu‹x
 
pg_‹mp_lock
;

721 
	spg_‹mp_t
 {

722 
	gveùÜ
<> 
	gaùšg
;

723 
boŞ
 
	gfÜûd
 = 
çl£
;

725 
	gm­
<
	gpg_t
, 
	gpg_‹mp_t
> 
	gpg_‹mp_wª‹d
;

726 
	gm­
<
	gpg_t
, 
	gpg_‹mp_t
> 
	gpg_‹mp_³ndšg
;

727 
_£Á_pg_‹mp
();

728 
ä›nd
 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am&, cÚ¡ 
	gpg_‹mp_t
&);

729 
	gpublic
:

730 
queue_wªt_pg_‹mp
(
pg_t
 
pgid
, cÚ¡ 
veùÜ
<>& 
wªt
,

731 
boŞ
 
fÜûd
 = 
çl£
);

732 
»move_wªt_pg_‹mp
(
pg_t
 
pgid
);

733 
»queue_pg_‹mp
();

734 
£nd_pg_‹mp
();

736 
£nd_pg_ü—‹d
(
pg_t
 
pgid
);

738 
Mu‹x
 
	g¢­_¦“p_lock
;

739 
SaãTim”
 
	g¢­_¦“p_tim”
;

741 
Mu‹x
 
	gsüub_¦“p_lock
;

742 
SaãTim”
 
	gsüub_¦“p_tim”
;

744 
	gAsyncRe£rv”
<
	g¥g_t
> 
	g¢­_»£rv”
;

745 
queue_»cov”y_cÚ‹xt
(
PG
 *
pg
, 
G’CÚ‹xt
<
Th»adPoŞ
::
TPHªdË
&> *
c
);

746 
queue_fÜ_¢­_Œim
(
PG
 *
pg
);

747 
queue_fÜ_süub
(
PG
 *
pg
, 
boŞ
 
w™h_high_´iÜ™y
);

748 
queue_fÜ_pg_d–‘e
(
¥g_t
 
pgid
, 
•och_t
 
e
);

749 
fšish_pg_d–‘e
(
PG
 *
pg
, 
Şd_pg_num
);

751 
	g´iv©e
:

753 
Mu‹x
 
»cov”y_lock
;

754 
	gli¡
<
	g·œ
<
	g•och_t
, 
	gPGRef
> > 
	gawa™šg_thrÙe
;

756 
utime_t
 
	gdeãr_»cov”y_uÁ
;

757 
ušt64_t
 
	g»cov”y_İs_aùive
;

758 
ušt64_t
 
	g»cov”y_İs_»£rved
;

759 
boŞ
 
	g»cov”y_·u£d
;

760 #ifdeà
DEBUG_RECOVERY_OIDS


761 
	gm­
<
	g¥g_t
, 
	g£t
<
	ghobjeù_t
> > 
	g»cov”y_oids
;

763 
boŞ
 
_»cov”_now
(
ušt64_t
 *
avaabË_pushes
);

764 
_maybe_queue_»cov”y
();

765 
_queue_fÜ_»cov”y
(

766 
·œ
<
•och_t
, 
PGRef
> 
p
, 
ušt64_t
 
»£rved_pushes
);

767 
	gpublic
:

768 
¡¬t_»cov”y_İ
(
PG
 *
pg
, cÚ¡ 
hobjeù_t
& 
soid
);

769 
fšish_»cov”y_İ
(
PG
 *
pg
, cÚ¡ 
hobjeù_t
& 
soid
, 
boŞ
 
dequeue
);

770 
boŞ
 
is_»cov”y_aùive
();

771 
»Ëa£_»£rved_pushes
(
ušt64_t
 
pushes
);

772 
	$deãr_»cov”y
(
deãr_fÜ
) {

773 
deãr_»cov”y_uÁ
 = 
	`ûph_şock_now
();

774 
deãr_»cov”y_uÁ
 +ğ
deãr_fÜ
;

775 
	}
}

776 
	$·u£_»cov”y
() {

777 
Mu‹x
::
Lock”
 
	`l
(
»cov”y_lock
);

778 
»cov”y_·u£d
 = 
Œue
;

779 
	}
}

780 
boŞ
 
	$»cov”y_is_·u£d
() {

781 
Mu‹x
::
Lock”
 
	`l
(
»cov”y_lock
);

782  
»cov”y_·u£d
;

783 
	}
}

784 
	$uÅau£_»cov”y
() {

785 
Mu‹x
::
Lock”
 
	`l
(
»cov”y_lock
);

786 
»cov”y_·u£d
 = 
çl£
;

787 
	`_maybe_queue_»cov”y
();

788 
	}
}

789 
	$kick_»cov”y_queue
() {

790 
Mu‹x
::
Lock”
 
	`l
(
»cov”y_lock
);

791 
	`_maybe_queue_»cov”y
();

792 
	}
}

793 
	$ş—r_queued_»cov”y
(
PG
 *
pg
) {

794 
Mu‹x
::
Lock”
 
	`l
(
»cov”y_lock
);

795 
awa™šg_thrÙe
.
	`»move_if
(

796 [
pg
](
	`deşty³
(
awa™šg_thrÙe
)::
cÚ¡_»ã»nû
 
awa™šg
 ) {

797  
awa™šg
.
£cÚd
.
	`g‘
(è=ğ
pg
;

799 
	}
}

801 
	$queue_fÜ_»cov”y
(
PG
 *
pg
) {

802 
Mu‹x
::
Lock”
 
	`l
(
»cov”y_lock
);

804 ià(
pg
->
	`is_fÜûd_»cov”y_Ü_backfl
()) {

805 
awa™šg_thrÙe
.
	`push_äÚt
(
	`make_·œ
(
pg
->
	`g‘_osdm­
()->
	`g‘_•och
(),…g));

807 
awa™šg_thrÙe
.
	`push_back
(
	`make_·œ
(
pg
->
	`g‘_osdm­
()->
	`g‘_•och
(),…g));

809 
	`_maybe_queue_»cov”y
();

810 
	}
}

811 
	$queue_»cov”y_aá”_¦“p
(
PG
 *
pg
, 
•och_t
 
queued
, 
ušt64_t
 
»£rved_pushes
) {

812 
Mu‹x
::
Lock”
 
	`l
(
»cov”y_lock
);

813 
	`_queue_fÜ_»cov”y
(
	`make_·œ
(
queued
, 
pg
), 
»£rved_pushes
);

814 
	}
}

817 
Mu‹x
 
	gm­_ÿche_lock
;

818 
	gSh¬edLRU
<
	g•och_t
, cÚ¡ 
	gOSDM­
> 
	gm­_ÿche
;

819 
	gSim¶eLRU
<
	g•och_t
, 
	gbufã¾i¡
> 
	gm­_bl_ÿche
;

820 
	gSim¶eLRU
<
	g•och_t
, 
	gbufã¾i¡
> 
	gm­_bl_šc_ÿche
;

823 
	gm­
<
	gšt64_t
,> 
	gd–‘ed_poŞ_pg_nums
;

825 
OSDM­Ref
 
Œy_g‘_m­
(
•och_t
 
e
);

826 
OSDM­Ref
 
	$g‘_m­
(
•och_t
 
e
) {

827 
OSDM­Ref
 
	`»t
(
	`Œy_g‘_m­
(
e
));

828 
	`as£¹
(
»t
);

829  
»t
;

830 
	}
}

831 
OSDM­Ref
 
	$add_m­
(
OSDM­
 *
o
) {

832 
Mu‹x
::
Lock”
 
	`l
(
m­_ÿche_lock
);

833  
	`_add_m­
(
o
);

834 
	}
}

835 
OSDM­Ref
 
_add_m­
(
OSDM­
 *
o
);

837 
	$add_m­_bl
(
•och_t
 
e
, 
bufã¾i¡
& 
bl
) {

838 
Mu‹x
::
Lock”
 
	`l
(
m­_ÿche_lock
);

839  
	`_add_m­_bl
(
e
, 
bl
);

840 
	}
}

841 
_add_m­_bl
(
•och_t
 
e
, 
bufã¾i¡
& 
bl
);

842 
boŞ
 
	$g‘_m­_bl
(
•och_t
 
e
, 
bufã¾i¡
& 
bl
) {

843 
Mu‹x
::
Lock”
 
	`l
(
m­_ÿche_lock
);

844  
	`_g‘_m­_bl
(
e
, 
bl
);

845 
	}
}

846 
boŞ
 
_g‘_m­_bl
(
•och_t
 
e
, 
bufã¾i¡
& 
bl
);

848 
	$add_m­_šc_bl
(
•och_t
 
e
, 
bufã¾i¡
& 
bl
) {

849 
Mu‹x
::
Lock”
 
	`l
(
m­_ÿche_lock
);

850  
	`_add_m­_šc_bl
(
e
, 
bl
);

851 
	}
}

852 
_add_m­_šc_bl
(
•och_t
 
e
, 
bufã¾i¡
& 
bl
);

853 
boŞ
 
g‘_šc_m­_bl
(
•och_t
 
e
, 
bufã¾i¡
& 
bl
);

856 
g‘_d–‘ed_poŞ_pg_num
(
št64_t
 
poŞ
);

858 
	$¡Üe_d–‘ed_poŞ_pg_num
(
št64_t
 
poŞ
, 
pg_num
) {

859 
Mu‹x
::
Lock”
 
	`l
(
m­_ÿche_lock
);

860 
d–‘ed_poŞ_pg_nums
[
poŞ
] = 
pg_num
;

861 
	}
}

864 
	$g‘_possibly_d–‘ed_poŞ_pg_num
(
OSDM­Ref
 
Ãwm­
,

865 
št64_t
 
poŞ
) {

866 ià(
Ãwm­
->
	`have_pg_poŞ
(
poŞ
)) {

867  
Ãwm­
->
	`g‘_pg_num
(
poŞ
);

869  
	`g‘_d–‘ed_poŞ_pg_num
(
poŞ
);

870 
	}
}

873 
id’tify_¥l™_chd»n
(

874 
OSDM­Ref
 
Şd_m­
,

875 
OSDM­Ref
 
Ãw_m­
,

876 
¥g_t
 
pgid
,

877 
£t
<
¥g_t
> *
Ãw_chd»n
);

879 
Ãed_h—¹b—t_³”_upd©e
();

881 
š™
();

882 
fš®_š™
();

883 
¡¬t_shutdown
();

884 
shutdown_»£rv”
();

885 
shutdown
();

888 
Mu‹x
 
	g¡©_lock
;

889 
osd_¡©_t
 
	gosd_¡©
;

890 
ušt32_t
 
	g£q
 = 0;

892 
upd©e_osd_¡©
(
veùÜ
<>& 
hb_³”s
);

893 
osd_¡©_t
 
£t_osd_¡©
(cÚ¡ 
¡Üe_¡©fs_t
 &
¡buf
,

894 
veùÜ
<>& 
hb_³”s
,

895 
num_pgs
);

896 
osd_¡©_t
 
	$g‘_osd_¡©
() {

897 
Mu‹x
::
Lock”
 
	`l
(
¡©_lock
);

898 ++
£q
;

899 
osd_¡©
.
up_äom
 = 
up_•och
;

900 
osd_¡©
.
£q
 = ((
ušt64_t
)osd_¡©.
up_äom
 << 32) + seq;

901  
osd_¡©
;

902 
	}
}

903 
ušt64_t
 
	$g‘_osd_¡©_£q
() {

904 
Mu‹x
::
Lock”
 
	`l
(
¡©_lock
);

905  
osd_¡©
.
£q
;

906 
	}
}

909 
	g´iv©e
:

910 
ä›nd
 
Te¡OpsSock‘Hook
;

911 
mubË
 
Mu‹x
 
	gfuÎ_¡©us_lock
;

912 
	es_Çmes
 { 
	gINVALID
 = -1, 
	gNONE
, 
	gNEARFULL
, 
	gBACKFILLFULL
, 
	gFULL
, 
	gFAILSAFE
 } 
	gcur_¡©e
;

913 cÚ¡ *
	$g‘_fuÎ_¡©e_Çme
(
s_Çmes
 
s
) const {

914 
s
) {

915 
NONE
:  "none";

916 
NEARFULL
:  "nearfull";

917 
BACKFILLFULL
:  "backfillfull";

918 
FULL
:  "full";

919 
FAILSAFE
:  "failsafe";

922 
	}
}

923 
s_Çmes
 
	$g‘_fuÎ_¡©e
(
¡ršg
 
ty³
) const {

924 ià(
ty³
 == "none")

925  
NONE
;

926 ià(
ty³
 == "failsafe")

927  
FAILSAFE
;

928 ià(
ty³
 == "full")

929  
FULL
;

930 ià(
ty³
 == "backfillfull")

931  
BACKFILLFULL
;

932 ià(
ty³
 == "nearfull")

933  
NEARFULL
;

935  
INVALID
;

936 
	}
}

937 
	gcur_¿tio
;

938 
mubË
 
št64_t
 
	gšjeùfuÎ
 = 0;

939 
s_Çmes
 
	gšjeùfuÎ_¡©e
 = 
NONE
;

940 
g‘_ç§ã_fuÎ_¿tio
();

941 
check_fuÎ_¡©us
(
¿tio
);

942 
boŞ
 
	$_check_fuÎ
(
DoutP»fixProvid”
 *
dµ
, 
s_Çmes
 
ty³
) const;

943 
public
:

944 
boŞ
 
	$check_ç§ã_fuÎ
(
DoutP»fixProvid”
 *
dµ
) const;

945 
boŞ
 
	$check_fuÎ
(
DoutP»fixProvid”
 *
dµ
) const;

946 
boŞ
 
	$check_backfl_fuÎ
(
DoutP»fixProvid”
 *
dµ
) const;

947 
boŞ
 
	$check_Ã¬fuÎ
(
DoutP»fixProvid”
 *
dµ
) const;

948 
boŞ
 
	$is_ç§ã_fuÎ
() const;

949 
boŞ
 
	$is_fuÎ
() const;

950 
boŞ
 
	$is_backflfuÎ
() const;

951 
boŞ
 
	$is_Ã¬fuÎ
() const;

952 
boŞ
 
	`Ãed_fuÎÃss_upd©e
();

953 
	`£t_šjeùfuÎ
(
s_Çmes
 
ty³
, 
št64_t
 
couÁ
);

954 
boŞ
 
	`check_osdm­_fuÎ
(cÚ¡ 
£t
<
pg_sh¬d_t
> &
missšg_Ú
);

958 
´iv©e
:

959 
mubË
 
Mu‹x
 
•och_lock
;

960 
•och_t
 
boÙ_•och
;

961 
•och_t
 
up_•och
;

962 
•och_t
 
bšd_•och
;

963 
public
:

968 
	$»Œ›ve_•ochs
(
•och_t
 *
_boÙ_•och
,ƒpoch_ˆ*
_up_•och
,

969 
•och_t
 *
_bšd_•och
) const;

973 
	`£t_•ochs
(cÚ¡ 
•och_t
 *
_boÙ_•och
, cÚ¡ƒpoch_ˆ*
_up_•och
,

974 cÚ¡ 
•och_t
 *
_bšd_•och
);

975 
•och_t
 
	$g‘_boÙ_•och
() const {

976 
•och_t
 
»t
;

977 
	`»Œ›ve_•ochs
(&
»t
, 
NULL
, NULL);

978  
»t
;

979 
	}
}

980 
•och_t
 
	$g‘_up_•och
() const {

981 
•och_t
 
»t
;

982 
	`»Œ›ve_•ochs
(
NULL
, &
»t
, NULL);

983  
»t
;

984 
	}
}

985 
•och_t
 
	$g‘_bšd_•och
() const {

986 
•och_t
 
»t
;

987 
	`»Œ›ve_•ochs
(
NULL
, NULL, &
»t
);

988  
»t
;

989 
	}
}

991 
»que¡_osdm­_upd©e
(
•och_t
 
e
);

994 
Mu‹x
 
	gis_¡İpšg_lock
;

995 
CÚd
 
	gis_¡İpšg_cÚd
;

997 
	gNOT_STOPPING
,

998 
	gPREPARING_TO_STOP
,

999 
	gSTOPPING
 };

1000 
	g¡d
::
©omic
<> 
¡©e
{
NOT_STOPPING
};

1001 
	$g‘_¡©e
() const {

1002  
¡©e
;

1003 
	}
}

1004 
	$£t_¡©e
(
s
) {

1005 
¡©e
 = 
s
;

1006 
	}
}

1007 
boŞ
 
	$is_¡İpšg
() const {

1008  
¡©e
 =ğ
STOPPING
;

1009 
	}
}

1010 
boŞ
 
	$is_´•¬šg_to_¡İ
() const {

1011  
¡©e
 =ğ
PREPARING_TO_STOP
;

1012 
	}
}

1013 
boŞ
 
´•¬e_to_¡İ
();

1014 
gÙ_¡İ_ack
();

1017 #ifdeà
PG_DEBUG_REFS


1018 
Mu‹x
 
	gpgid_lock
;

1019 
	gm­
<
	g¥g_t
, > 
	gpgid_Œack”
;

1020 
	gm­
<
	g¥g_t
, 
	gPG
*> 
	glive_pgs
;

1021 
add_pgid
(
¥g_t
 
pgid
, 
PG
 *
pg
);

1022 
»move_pgid
(
¥g_t
 
pgid
, 
PG
 *
pg
);

1023 
dump_live_pgids
();

1026 
ex¶ic™
 
OSDS”viû
(
OSD
 *
osd
);

1027 ~
OSDS”viû
();

1031 şas 
	cio_queue
 {

1032 
	m´iÜ™ized
,

1033 
	mweigh‹d´iÜ™y
,

1034 
	mmşock_İşass
,

1035 
	mmşock_ş›Á
,

1089 
	sOSDSh¬dPGSlÙ
 {

1090 
PGRef
 
	mpg
;

1091 
	mdeque
<
	mOpQueueI‹m
> 
	mto_´oûss
;

1092 
	mnum_ruÂšg
 = 0;

1094 
	mdeque
<
	mOpQueueI‹m
> 
	mwa™šg
;

1097 
	mm­
<
	m•och_t
,
	mdeque
<
	mOpQueueI‹m
>> 
	mwa™šg_³”šg
;

1101 
ušt64_t
 
	m»queue_£q
 = 0;

1104 
boŞ
 
	mwa™šg_fÜ_¥l™
 = 
çl£
;

1106 
•och_t
 
	m•och
 = 0;

1107 
	mboo¡
::
šŒusive
::
£t_memb”_hook
<> 
pg_•och_™em
;

1110 
	sOSDSh¬d
 {

1111 cÚ¡ 
	msh¬d_id
;

1112 
C•hCÚ‹xt
 *
	mcù
;

1113 
OSD
 *
	mosd
;

1115 
¡ršg
 
	msh¬d_Çme
;

1117 
¡ršg
 
	msd©a_wa™_lock_Çme
;

1118 
Mu‹x
 
	msd©a_wa™_lock
;

1119 
CÚd
 
	msd©a_cÚd
;

1121 
¡ršg
 
	mosdm­_lock_Çme
;

1122 
Mu‹x
 
	mosdm­_lock
;

1123 
OSDM­Ref
 
	msh¬d_osdm­
;

1125 
OSDM­Ref
 
g‘_osdm­
() {

1126 
	mMu‹x
::
Lock”
 
l
(
osdm­_lock
);

1127  
	msh¬d_osdm­
;

1130 
¡ršg
 
	msh¬d_lock_Çme
;

1131 
Mu‹x
 
	msh¬d_lock
;

1136 
	munÜd”ed_m­
<
	m¥g_t
,
	munique_±r
<
	mOSDSh¬dPGSlÙ
>> 
	mpg_¦Ùs
;

1138 
	spg_¦Ù_com·»_by_•och
 {

1139 
boŞ
 
İ”©Ü
()(cÚ¡ 
	mOSDSh¬dPGSlÙ
& 
	ml
, cÚ¡ OSDSh¬dPGSlÙ& 
	mr
) const {

1140  
	ml
.
	m•och
 < 
	mr
.epoch;

1145 
	mboo¡
::
šŒusive
::
muÉi£t
<

1146 
OSDSh¬dPGSlÙ
,

1147 
	mboo¡
::
šŒusive
::
memb”_hook
<

1148 
OSDSh¬dPGSlÙ
,

1149 
	mboo¡
::
šŒusive
::
£t_memb”_hook
<>,

1150 &
	mOSDSh¬dPGSlÙ
::
pg_•och_™em
>,

1151 
	mboo¡
::
šŒusive
::
com·»
<
pg_¦Ù_com·»_by_•och
>> 
pg_¦Ùs_by_•och
;

1152 
boŞ
 
	mwa™šg_fÜ_mš_pg_•och
 = 
çl£
;

1153 
CÚd
 
	mmš_pg_•och_cÚd
;

1156 
	m¡d
::
unique_±r
<
OpQueue
<
OpQueueI‹m
, 
	mušt64_t
>> 
	mpqueue
;

1158 
boŞ
 
	m¡İ_wa™šg
 = 
çl£
;

1160 
_’queue_äÚt
(
OpQueueI‹m
&& 
™em
, 
cutoff
) {

1161 
	m´iÜ™y
 = 
™em
.
g‘_´iÜ™y
();

1162 
	mco¡
 = 
™em
.
g‘_co¡
();

1163 ià(
	m´iÜ™y
 >ğ
cutoff
)

1164 
pqueue
->
’queue_¡riù_äÚt
(

1165 
™em
.
g‘_owÃr
(),

1166 
´iÜ™y
, 
¡d
::
move
(
™em
));

1168 
	mpqueue
->
’queue_äÚt
(

1169 
™em
.
g‘_owÃr
(),

1170 
´iÜ™y
, 
co¡
, 
¡d
::
move
(
™em
));

1173 
_©ch_pg
(
OSDSh¬dPGSlÙ
 *
¦Ù
, 
PG
 *
pg
);

1174 
_d‘ach_pg
(
OSDSh¬dPGSlÙ
 *
¦Ù
);

1176 
upd©e_pg_•och
(
OSDSh¬dPGSlÙ
 *
¦Ù
, 
•och_t
 
•och
);

1177 
•och_t
 
g‘_mš_pg_•och
();

1178 
wa™_mš_pg_•och
(
•och_t
 
Ãed
);

1181 
•och_t
 
g‘_max_wa™šg_•och
();

1184 
cÚsume_m­
(

1185 
OSDM­Ref
& 
osdm­
,

1186 *
pushes_to_ä“
);

1188 
_wake_pg_¦Ù
(
¥g_t
 
pgid
, 
OSDSh¬dPGSlÙ
 *
¦Ù
);

1190 
id’tify_¥l™s
(cÚ¡ 
OSDM­Ref
& 
as_of_osdm­
, 
£t
<
¥g_t
> *
pgids
);

1191 
_´ime_¥l™s
(
£t
<
¥g_t
> *
pgids
);

1192 
´ime_¥l™s
(cÚ¡ 
OSDM­Ref
& 
as_of_osdm­
, 
£t
<
¥g_t
> *
pgids
);

1193 
»gi¡”_ªd_wake_¥l™_chd
(
PG
 *
pg
);

1194 
uÅrime_¥l™_chd»n
(
¥g_t
 
·»Á
, 
Şd_pg_num
);

1196 
OSDSh¬d
(

1197 
id
,

1198 
C•hCÚ‹xt
 *
cù
,

1199 
OSD
 *
osd
,

1200 
ušt64_t
 
max_tok_³r_´io
, ušt64_ˆ
mš_co¡
,

1201 
io_queue
 
İqueue
)

1202 : 
sh¬d_id
(
id
),

1203 
cù
(cct),

1204 
osd
(osd),

1205 
sh¬d_Çme
(
¡ršg
("OSDSh¬d."è+ 
¡ršgify
(
id
)),

1206 
sd©a_wa™_lock_Çme
(
sh¬d_Çme
 + "::sdata_wait_lock"),

1207 
sd©a_wa™_lock
(
sd©a_wa™_lock_Çme
.
c_¡r
(), 
çl£
, 
Œue
, f®£, 
cù
),

1208 
osdm­_lock_Çme
(
sh¬d_Çme
 + "::osdmap_lock"),

1209 
osdm­_lock
(
osdm­_lock_Çme
.
c_¡r
(), 
çl£
, false),

1210 
sh¬d_lock_Çme
(
sh¬d_Çme
 + "::shard_lock"),

1211 
sh¬d_lock
(
sh¬d_lock_Çme
.
c_¡r
(), 
çl£
, 
Œue
,

1212 
çl£
, 
cù
) {

1213 ià(
	mİqueue
 =ğ
io_queue
::
weigh‹d´iÜ™y
) {

1214 
pqueue
 = 
¡d
::
make_unique
<

1215 
Weigh‹dPriÜ™yQueue
<
OpQueueI‹m
,
	mušt64_t
>>(

1216 
	mmax_tok_³r_´io
, 
	mmš_co¡
);

1217 } ià(
	mİqueue
 =ğ
io_queue
::
´iÜ™ized
) {

1218 
pqueue
 = 
¡d
::
make_unique
<

1219 
PriÜ™izedQueue
<
OpQueueI‹m
,
	mušt64_t
>>(

1220 
	mmax_tok_³r_´io
, 
	mmš_co¡
);

1221 } ià(
	mİqueue
 =ğ
io_queue
::
mşock_İşass
) {

1222 
pqueue
 = 
¡d
::
make_unique
<
ûph
::
mClockOpCÏssQueue
>(
cù
);

1223 } ià(
	mİqueue
 =ğ
io_queue
::
mşock_ş›Á
) {

1224 
pqueue
 = 
¡d
::
make_unique
<
ûph
::
mClockCl›ÁQueue
>(
cù
);

1229 
şass
 
	gOSD
 : 
public
 
Di¥©ch”
,

1230 
public
 
	gmd_cÚfig_obs_t
 {

1232 
Mu‹x
 
	gosd_lock
;

1233 
SaãTim”
 
	gtick_tim”
;

1236 
Mu‹x
 
	gtick_tim”_lock
;

1237 
SaãTim”
 
	gtick_tim”_w™hout_osd_lock
;

1238 
	gpublic
:

1240 cÚ¡ ** 
g‘_Œacked_cÚf_keys
(ècÚ¡ 
ov”ride
;

1241 
hªdË_cÚf_chªge
(cÚ¡ 
md_cÚfig_t
 *
cÚf
,

1242 cÚ¡ 
¡d
::
£t
 <¡d::
¡ršg
> &
chªged
è
ov”ride
;

1243 
upd©e_log_cÚfig
();

1244 
check_cÚfig
();

1246 
	g´Ùeùed
:

1248 cÚ¡ 
OSD_TICK_INTERVAL
;

1250 
AuthAuthÜizeHªdËrRegi¡ry
 *
	gauthÜize_hªdËr_şu¡”_»gi¡ry
;

1251 
AuthAuthÜizeHªdËrRegi¡ry
 *
	gauthÜize_hªdËr_£rviû_»gi¡ry
;

1253 
Mes£ng”
 *
	gşu¡”_mes£ng”
;

1254 
Mes£ng”
 *
	gş›Á_mes£ng”
;

1255 
Mes£ng”
 *
	gobjeù”_mes£ng”
;

1256 
MÚCl›Á
 *
	gmÚc
;

1257 
MgrCl›Á
 
	gmgrc
;

1258 
P”fCouÁ”s
 *
	glogg”
;

1259 
P”fCouÁ”s
 *
	g»cov”y¡©e_³rf
;

1260 
ObjeùStÜe
 *
	g¡Üe
;

1261 #ifdeà
HAVE_LIBFUSE


1262 
Fu£StÜe
 *
	gfu£_¡Üe
 = 
nuÎ±r
;

1264 
LogCl›Á
 
	glog_ş›Á
;

1265 
LogChªÃlRef
 
	gşog
;

1267 
	gwhßmi
;

1268 
	g¡d
::
¡ršg
 
dev_·th
, 
	gjouº®_·th
;

1270 
boŞ
 
	g¡Üe_is_rÙ©iÚ®
 = 
Œue
;

1271 
boŞ
 
	gjouº®_is_rÙ©iÚ®
 = 
Œue
;

1273 
	gZT¿ûr
::
Endpošt
 
Œaû_’dpošt
;

1274 
ü—‹_logg”
();

1275 
ü—‹_»cov”y¡©e_³rf
();

1276 
tick
();

1277 
tick_w™hout_osd_lock
();

1278 
_di¥©ch
(
Mes§ge
 *
m
);

1279 
di¥©ch_İ
(
OpReque¡Ref
 
İ
);

1281 
check_osdm­_ã©u»s
();

1284 
ä›nd
 
şass
 
	gOSDSock‘Hook
;

1285 
şass
 
OSDSock‘Hook
 *
	gasok_hook
;

1286 
boŞ
 
asok_commªd
(
¡d
::
¡ršg_v›w
 
admš_commªd
, cÚ¡ 
cmdm­_t
& 
cmdm­
,

1287 
¡d
::
¡ršg_v›w
 
fÜm©
, std::
o¡»am
& 
ss
);

1289 
	gpublic
:

1290 
CÏssHªdËr
 *
şass_hªdËr
 = 
nuÎ±r
;

1291 
g‘_nodeid
(è{  
	gwhßmi
; }

1293 
ghobjeù_t
 
g‘_osdm­_pobjeù_Çme
(
•och_t
 
•och
) {

1294 
	gfoo
[20];

1295 
¢´štf
(
foo
, (foo), "osdm­.%d", 
•och
);

1296  
ghobjeù_t
(
hobjeù_t
(
sobjeù_t
(
objeù_t
(
foo
), 0)));

1298 
ghobjeù_t
 
g‘_šc_osdm­_pobjeù_Çme
(
•och_t
 
•och
) {

1299 
	gfoo
[22];

1300 
¢´štf
(
foo
, (foo), "šc_osdm­.%d", 
•och
);

1301  
ghobjeù_t
(
hobjeù_t
(
sobjeù_t
(
objeù_t
(
foo
), 0)));

1304 
ghobjeù_t
 
make_¢­m­³r_oid
() {

1305  
ghobjeù_t
(
hobjeù_t
(

1306 
sobjeù_t
(

1307 
objeù_t
("snapmapper"),

1311 
ghobjeù_t
 
make_pg_log_oid
(
¥g_t
 
pg
) {

1312 
¡ršg¡»am
 
	gss
;

1313 
	gss
 << "pglog_" << 
	gpg
;

1314 
¡ršg
 
	gs
;

1315 
g‘lše
(
ss
, 
s
);

1316  
ghobjeù_t
(
hobjeù_t
(
sobjeù_t
(
objeù_t
(
s
.
c_¡r
()), 0)));

1319 
ghobjeù_t
 
make_pg_bigšfo_oid
(
¥g_t
 
pg
) {

1320 
¡ršg¡»am
 
	gss
;

1321 
	gss
 << "pgšfo_" << 
	gpg
;

1322 
¡ršg
 
	gs
;

1323 
g‘lše
(
ss
, 
s
);

1324  
ghobjeù_t
(
hobjeù_t
(
sobjeù_t
(
objeù_t
(
s
.
c_¡r
()), 0)));

1326 
ghobjeù_t
 
make_šfos_oid
() {

1327 
hobjeù_t
 
oid
(
sobjeù_t
("šfos", 
CEPH_NOSNAP
));

1328  
ghobjeù_t
(
oid
);

1331 
ghobjeù_t
 
make_fš®_poŞ_šfo_oid
(
št64_t
 
poŞ
) {

1332  
ghobjeù_t
(

1333 
hobjeù_t
(

1334 
sobjeù_t
(

1335 
objeù_t
(
¡ršg
("fš®_poŞ_"è+ 
¡ršgify
(
poŞ
)),

1336 
CEPH_NOSNAP
)));

1339 
»cursive_»move_cŞËùiÚ
(
C•hCÚ‹xt
* 
cù
,

1340 
ObjeùStÜe
 *
¡Üe
,

1341 
¥g_t
 
pgid
,

1342 
cŞl_t
 
tmp
);

1352 
Com·tS‘
 
g‘_osd_š™Ÿl_com·t_£t
();

1361 
Com·tS‘
 
g‘_osd_com·t_£t
();

1364 
	g´iv©e
:

1365 
şass
 
C_Tick
;

1366 
şass
 
	gC_Tick_W™houtOSDLock
;

1369 
	gm_osd_pg_•och_max_Ïg_çùÜ
;

1372 
OSDSu³rblock
 
	gsu³rblock
;

1374 
wr™e_su³rblock
();

1375 
wr™e_su³rblock
(
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
);

1376 
»ad_su³rblock
();

1378 
ş—r_‹mp_objeùs
();

1380 
Com·tS‘
 
	gosd_com·t
;

1383 
	gpublic
:

1385 
STATE_INITIALIZING
 = 1,

1386 
	gSTATE_PREBOOT
,

1387 
	gSTATE_BOOTING
,

1388 
	gSTATE_ACTIVE
,

1389 
	gSTATE_STOPPING
,

1390 
	gSTATE_WAITING_FOR_HEALTHY


1391 } 
	tosd_¡©e_t
;

1393 cÚ¡ *
g‘_¡©e_Çme
(
s
) {

1394 
	gs
) {

1395 
	gSTATE_INITIALIZING
:  "initializing";

1396 
	gSTATE_PREBOOT
:  "preboot";

1397 
	gSTATE_BOOTING
:  "booting";

1398 
	gSTATE_ACTIVE
:  "active";

1399 
	gSTATE_STOPPING
:  "stopping";

1400 
	gSTATE_WAITING_FOR_HEALTHY
:  "waiting_for_healthy";

1405 
	g´iv©e
:

1406 
¡d
::
©omic
<> 
¡©e
{
STATE_INITIALIZING
};

1408 
	gpublic
:

1409 
g‘_¡©e
() const {

1410  
¡©e
;

1412 
£t_¡©e
(
s
) {

1413 
	g¡©e
 = 
s
;

1415 
boŞ
 
is_š™Ÿlizšg
() const {

1416  
	g¡©e
 =ğ
STATE_INITIALIZING
;

1418 
boŞ
 
is_´eboÙ
() const {

1419  
	g¡©e
 =ğ
STATE_PREBOOT
;

1421 
boŞ
 
is_boÙšg
() const {

1422  
	g¡©e
 =ğ
STATE_BOOTING
;

1424 
boŞ
 
is_aùive
() const {

1425  
	g¡©e
 =ğ
STATE_ACTIVE
;

1427 
boŞ
 
is_¡İpšg
() const {

1428  
	g¡©e
 =ğ
STATE_STOPPING
;

1430 
boŞ
 
is_wa™šg_fÜ_h—Éhy
() const {

1431  
	g¡©e
 =ğ
STATE_WAITING_FOR_HEALTHY
;

1434 
	g´iv©e
:

1436 
Sh¬dedTh»adPoŞ
 
osd_İ_
;

1437 
Th»adPoŞ
 
	gcommªd_
;

1439 
g‘_Ï‹¡_osdm­
();

1442 
	g´iv©e
:

1443 
di¥©ch_£ssiÚ_wa™šg
(
SessiÚ
 *
£ssiÚ
, 
OSDM­Ref
 
osdm­
);

1444 
maybe_sh¬e_m­
(
SessiÚ
 *
£ssiÚ
, 
OpReque¡Ref
 
İ
, 
OSDM­Ref
 
osdm­
);

1446 
Mu‹x
 
	g£ssiÚ_wa™šg_lock
;

1447 
	g£t
<
	gSessiÚ
*> 
	g£ssiÚ_wa™šg_fÜ_m­
;

1450 
g‘_£ssiÚs_wa™šg_fÜ_m­
(
£t
<
SessiÚ
*> *
out
) {

1451 
	gMu‹x
::
Lock”
 
l
(
£ssiÚ_wa™šg_lock
);

1452 
	gout
->
sw­
(
£ssiÚ_wa™šg_fÜ_m­
);

1454 
»gi¡”_£ssiÚ_wa™šg_Ú_m­
(
SessiÚ
 *
£ssiÚ
) {

1455 
	gMu‹x
::
Lock”
 
l
(
£ssiÚ_wa™šg_lock
);

1456 ià(
	g£ssiÚ_wa™šg_fÜ_m­
.
š£¹
(
£ssiÚ
).
	g£cÚd
) {

1457 
	g£ssiÚ
->
g‘
();

1460 
ş—r_£ssiÚ_wa™šg_Ú_m­
(
SessiÚ
 *
£ssiÚ
) {

1461 
	gMu‹x
::
Lock”
 
l
(
£ssiÚ_wa™šg_lock
);

1462 
	g£t
<
	gSessiÚ
*>::
™”©Ü
 
i
 = 
£ssiÚ_wa™šg_fÜ_m­
.
fšd
(
£ssiÚ
);

1463 ià(
	gi
 !ğ
£ssiÚ_wa™šg_fÜ_m­
.
’d
()) {

1464 (*
i
)->
put
();

1465 
	g£ssiÚ_wa™šg_fÜ_m­
.
”a£
(
i
);

1468 
di¥©ch_£ssiÚs_wa™šg_Ú_m­
() {

1469 
	g£t
<
	gSessiÚ
*> 
	g£ssiÚs_to_check
;

1470 
g‘_£ssiÚs_wa™šg_fÜ_m­
(&
£ssiÚs_to_check
);

1471 
	g£t
<
	gSessiÚ
*>::
™”©Ü
 
i
 = 
£ssiÚs_to_check
.
begš
();

1472 
	gi
 !ğ
£ssiÚs_to_check
.
’d
();

1473 
	g£ssiÚs_to_check
.
”a£
(
i
++)) {

1474 (*
	gi
)->
	g£ssiÚ_di¥©ch_lock
.
Lock
();

1475 
di¥©ch_£ssiÚ_wa™šg
(*
i
, 
osdm­
);

1476 (*
	gi
)->
	g£ssiÚ_di¥©ch_lock
.
UÆock
();

1477 (*
	gi
)->
put
();

1480 
£ssiÚ_hªdË_»£t
(
SessiÚ
 *
£ssiÚ
) {

1481 
	gMu‹x
::
Lock”
 
l
(
£ssiÚ
->
£ssiÚ_di¥©ch_lock
);

1482 
ş—r_£ssiÚ_wa™šg_Ú_m­
(
£ssiÚ
);

1484 
	g£ssiÚ
->
ş—r_backoffs
();

1491 
	g£ssiÚ
->
	gwa™šg_Ú_m­
.
ş—r_ªd_di¥o£
(
T¿ckedOp
::
Pu‰”
());

1494 
	g´iv©e
:

1509 
osdm­_subsüibe
(
v”siÚ_t
 
•och
, 
boŞ
 
fÜû_»que¡
);

1512 
Mu‹x
 
	gosdm­_subsüibe_lock
;

1513 
•och_t
 
	gÏ‹¡_subsüibed_•och
{0};

1517 
	sH—¹b—tInfo
 {

1518 
	g³”
;

1519 
CÚÃùiÚRef
 
	gcÚ_äÚt
;

1520 
CÚÃùiÚRef
 
	gcÚ_back
;

1521 
utime_t
 
	gfœ¡_tx
;

1522 
utime_t
 
	gÏ¡_tx
;

1523 
utime_t
 
	gÏ¡_rx_äÚt
;

1524 
utime_t
 
	gÏ¡_rx_back
;

1525 
•och_t
 
	g•och
;

1527 
boŞ
 
is_unh—Éhy
(
utime_t
 
cutoff
) const {

1529 ! ((
	gÏ¡_rx_äÚt
 > 
	gcutoff
 ||

1530 (
	gÏ¡_rx_äÚt
 =ğ
utime_t
(è&& (
Ï¡_tx
 == utime_t() ||

1531 
fœ¡_tx
 > 
cutoff
))) &&

1532 (
Ï¡_rx_back
 > 
cutoff
 ||

1533 (
Ï¡_rx_back
 =ğ
utime_t
(è&& (
Ï¡_tx
 == utime_t() ||

1534 
fœ¡_tx
 > 
cutoff
))));

1536 
boŞ
 
is_h—Éhy
(
utime_t
 
cutoff
) const {

1537  
	gÏ¡_rx_äÚt
 > 
	gcutoff
 && 
	gÏ¡_rx_back
 > cutoff;

1542 
	gH—¹b—tSessiÚ
 : 
public
 
RefCouÁedObjeù
 {

1543 
³”
;

1544 
ex¶ic™
 
H—¹b—tSessiÚ
(
p
è: 
³”
(p) {}

1546 
Mu‹x
 
	gh—¹b—t_lock
;

1547 
	gm­
<, > 
	gdebug_h—¹b—t_drİs_»maššg
;

1548 
CÚd
 
	gh—¹b—t_cÚd
;

1549 
boŞ
 
	gh—¹b—t_¡İ
;

1550 
	g¡d
::
©omic
<
boŞ
> 
h—¹b—t_Ãed_upd©e
;

1551 
	gm­
<,
	gH—¹b—tInfo
> 
	gh—¹b—t_³”s
;

1552 
utime_t
 
	gÏ¡_mÚ_h—¹b—t
;

1553 
Mes£ng”
 *
	ghb_äÚt_ş›Á_mes£ng”
;

1554 
Mes£ng”
 *
	ghb_back_ş›Á_mes£ng”
;

1555 
Mes£ng”
 *
	ghb_äÚt_£rv”_mes£ng”
;

1556 
Mes£ng”
 *
	ghb_back_£rv”_mes£ng”
;

1557 
utime_t
 
	gÏ¡_h—¹b—t_»§m¶e
;

1558 
	gday_lßdavg
;

1560 
_add_h—¹b—t_³”
(
p
);

1561 
_»move_h—¹b—t_³”
(
p
);

1562 
boŞ
 
h—¹b—t_»£t
(
CÚÃùiÚ
 *
cÚ
);

1563 
maybe_upd©e_h—¹b—t_³”s
();

1564 
»£t_h—¹b—t_³”s
();

1565 
boŞ
 
h—¹b—t_³”s_Ãed_upd©e
() {

1566  
	gh—¹b—t_Ãed_upd©e
.
lßd
();

1568 
h—¹b—t_£t_³”s_Ãed_upd©e
() {

1569 
	gh—¹b—t_Ãed_upd©e
.
¡Üe
(
Œue
);

1571 
h—¹b—t_ş—r_³”s_Ãed_upd©e
() {

1572 
	gh—¹b—t_Ãed_upd©e
.
¡Üe
(
çl£
);

1574 
h—¹b—t
();

1575 
h—¹b—t_check
();

1576 
h—¹b—t_’Œy
();

1577 
Ãed_h—¹b—t_³”_upd©e
();

1579 
h—¹b—t_kick
() {

1580 
	gMu‹x
::
Lock”
 
l
(
h—¹b—t_lock
);

1581 
	gh—¹b—t_cÚd
.
SigÇl
();

1584 
	gT_H—¹b—t
 : 
public
 
Th»ad
 {

1585 
OSD
 *
osd
;

1586 
ex¶ic™
 
T_H—¹b—t
(
OSD
 *
o
è: 
osd
(o) {}

1587 *
’Œy
(è
ov”ride
 {

1588 
osd
->
h—¹b—t_’Œy
();

1591 } 
	gh—¹b—t_th»ad
;

1593 
	gpublic
:

1594 
boŞ
 
h—¹b—t_di¥©ch
(
Mes§ge
 *
m
);

1596 
	gH—¹b—tDi¥©ch”
 : 
public
 
Di¥©ch”
 {

1597 
OSD
 *
osd
;

1598 
ex¶ic™
 
H—¹b—tDi¥©ch”
(
OSD
 *
o
è: 
Di¥©ch”
(o->
cù
), 
osd
(o) {}

1600 
boŞ
 
ms_ÿn_ç¡_di¥©ch_ªy
(ècÚ¡ 
	gov”ride
 {  
	gŒue
; }

1601 
boŞ
 
ms_ÿn_ç¡_di¥©ch
(cÚ¡ 
Mes§ge
 *
m
ècÚ¡ 
	gov”ride
 {

1602 
	gm
->
g‘_ty³
()) {

1603 
	gCEPH_MSG_PING
:

1604 
MSG_OSD_PING
:

1605  
Œue
;

1607  
çl£
;

1610 
ms_ç¡_di¥©ch
(
Mes§ge
 *
m
è
	gov”ride
 {

1611 
	gosd
->
h—¹b—t_di¥©ch
(
m
);

1613 
boŞ
 
ms_di¥©ch
(
Mes§ge
 *
m
è
	gov”ride
 {

1614  
	gosd
->
h—¹b—t_di¥©ch
(
m
);

1616 
boŞ
 
ms_hªdË_»£t
(
CÚÃùiÚ
 *
cÚ
è
	gov”ride
 {

1617  
	gosd
->
h—¹b—t_»£t
(
cÚ
);

1619 
ms_hªdË_»mÙe_»£t
(
CÚÃùiÚ
 *
cÚ
è
	gov”ride
 {}

1620 
boŞ
 
ms_hªdË_»fu£d
(
CÚÃùiÚ
 *
cÚ
è
	gov”ride
 {

1621  
	gosd
->
ms_hªdË_»fu£d
(
cÚ
);

1623 
boŞ
 
ms_v”ify_authÜiz”
(
CÚÃùiÚ
 *
cÚ
, 
³”_ty³
,

1624 
´ÙocŞ
, 
bufã¾i¡
& 
authÜiz”_d©a
, bufã¾i¡& 
authÜiz”_»¶y
,

1625 
boŞ
& 
isv®id
, 
Cry±oKey
& 
£ssiÚ_key
è
	gov”ride
 {

1626 
	gisv®id
 = 
Œue
;

1627  
	gŒue
;

1629 } 
	gh—¹b—t_di¥©ch”
;

1631 
	g´iv©e
:

1633 
li¡
<
OpReque¡Ref
> 
fšished
;

1635 
ke_wa™”s
(
li¡
<
OpReque¡Ref
>& 
ls
) {

1636 
as£¹
(
osd_lock
.
is_locked
());

1637 
	gfšished
.
¥liû
(
fšished
.
’d
(), 
ls
);

1639 
do_wa™”s
();

1642 
OpT¿ck”
 
	gİ_Œack”
;

1643 
‹¡_İs
(
¡d
::
¡ršg
 
commªd
, std::¡ršg 
¬gs
, 
o¡»am
& 
ss
);

1644 
ä›nd
 
şass
 
	gTe¡OpsSock‘Hook
;

1645 
Te¡OpsSock‘Hook
 *
	g‹¡_İs_hook
;

1646 
ä›nd
 
	gC_FšishS¶™s
;

1647 
ä›nd
 
	gC_O³nPGs
;

1650 
ä›nd
 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
out
, cÚ¡ 
	gio_queue
& 
	gq
);

1652 cÚ¡ 
io_queue
 
	gİ_queue
;

1653 
	gpublic
:

1654 cÚ¡ 
İ_´io_cutoff
;

1655 
	g´Ùeùed
:

1677 
ä›nd
 
şass
 
PGOpI‹m
;

1678 
ä›nd
 
şass
 
	gPGP“ršgI‹m
;

1679 
ä›nd
 
şass
 
	gPGRecov”y
;

1680 
ä›nd
 
şass
 
	gPGD–‘e
;

1682 
şass
 
	gSh¬dedOpWQ


1683 : 
public
 
Sh¬dedTh»adPoŞ
::
Sh¬dedWQ
<
OpQueueI‹m
>

1685 
OSD
 *
osd
;

1687 
	gpublic
:

1688 
Sh¬dedOpWQ
(
OSD
 *
o
,

1689 
time_t
 
ti
,

1690 
time_t
 
si
,

1691 
Sh¬dedTh»adPoŞ
* 

)

1692 : 
Sh¬dedTh»adPoŞ
::
Sh¬dedWQ
<
OpQueueI‹m
>(
ti
, 
	gsi
, 
	g
),

1693 
osd
(
o
) {

1696 
_add_¦Ù_wa™”
(

1697 
¥g_t
 
tok’
,

1698 
OSDSh¬dPGSlÙ
 *
¦Ù
,

1699 
OpQueueI‹m
&& 
qi
);

1702 
_´oûss
(
ušt32_t
 
th»ad_šdex
, 
h—¹b—t_hªdË_d
 *
hb
è
	gov”ride
;

1705 
_’queue
(
OpQueueI‹m
&& 
™em
è
	gov”ride
;

1708 
_’queue_äÚt
(
OpQueueI‹m
&& 
™em
è
	gov”ride
;

1710 
»tuº_wa™šg_th»ads
(è
	gov”ride
 {

1711 
ušt32_t
 
	gi
 = 0; i < 
	gosd
->
	gnum_sh¬ds
; i++) {

1712 
OSDSh¬d
* 
	gsd©a
 = 
osd
->
sh¬ds
[
i
];

1713 
as£¹
 (
NULL
 !ğ
sd©a
);

1714 
	gsd©a
->
	gsd©a_wa™_lock
.
Lock
();

1715 
	gsd©a
->
	g¡İ_wa™šg
 = 
Œue
;

1716 
	gsd©a
->
	gsd©a_cÚd
.
SigÇl
();

1717 
	gsd©a
->
	gsd©a_wa™_lock
.
UÆock
();

1721 
¡İ_»tuº_wa™šg_th»ads
(è
	gov”ride
 {

1722 
ušt32_t
 
	gi
 = 0; i < 
	gosd
->
	gnum_sh¬ds
; i++) {

1723 
OSDSh¬d
* 
	gsd©a
 = 
osd
->
sh¬ds
[
i
];

1724 
as£¹
 (
NULL
 !ğ
sd©a
);

1725 
	gsd©a
->
	gsd©a_wa™_lock
.
Lock
();

1726 
	gsd©a
->
	g¡İ_wa™šg
 = 
çl£
;

1727 
	gsd©a
->
	gsd©a_wa™_lock
.
UÆock
();

1731 
dump
(
FÜm©‹r
 *
f
) {

1732 
ušt32_t
 
	gi
 = 0; i < 
	gosd
->
	gnum_sh¬ds
; i++) {

1733 autØ&&
	gsd©a
 = 
osd
->
sh¬ds
[
i
];

1735 
	gqueue_Çme
[32] = {0};

1736 
¢´štf
(
queue_Çme
, (queue_Çme), "%s%" 
PRIu32
, "OSD:Sh¬dedOpWQ:", 
i
);

1737 
as£¹
(
NULL
 !ğ
sd©a
);

1739 
	gsd©a
->
	gsh¬d_lock
.
Lock
();

1740 
	gf
->
İ’_objeù_£ùiÚ
(
queue_Çme
);

1741 
	gsd©a
->
	gpqueue
->
dump
(
f
);

1742 
	gf
->
şo£_£ùiÚ
();

1743 
	gsd©a
->
	gsh¬d_lock
.
UÆock
();

1747 
boŞ
 
is_sh¬d_em±y
(
ušt32_t
 
th»ad_šdex
è
	gov”ride
 {

1748 
ušt32_t
 
	gsh¬d_šdex
 = 
th»ad_šdex
 % 
osd
->
num_sh¬ds
;

1749 autØ&&
	gsd©a
 = 
osd
->
sh¬ds
[
sh¬d_šdex
];

1750 
as£¹
(
sd©a
);

1751 
	gMu‹x
::
Lock”
 
l
(
sd©a
->
sh¬d_lock
);

1752  
	gsd©a
->
	gpqueue
->
em±y
();

1754 } 
	gİ_sh¬dedwq
;

1757 
’queue_İ
(
¥g_t
 
pg
, 
OpReque¡Ref
& 
İ
, 
•och_t
 
•och
);

1758 
dequeue_İ
(

1759 
PGRef
 
pg
, 
OpReque¡Ref
 
İ
,

1760 
Th»adPoŞ
::
TPHªdË
 &
hªdË
);

1762 
’queue_³”šg_evt
(

1763 
¥g_t
 
pgid
,

1764 
PGP“ršgEv’tRef
 
»f
);

1765 
’queue_³”šg_evt_äÚt
(

1766 
¥g_t
 
pgid
,

1767 
PGP“ršgEv’tRef
 
»f
);

1768 
dequeue_³”šg_evt
(

1769 
OSDSh¬d
 *
sd©a
,

1770 
PG
 *
pg
,

1771 
PGP“ršgEv’tRef
 
»f
,

1772 
Th»adPoŞ
::
TPHªdË
& 
hªdË
);

1774 
dequeue_d–‘e
(

1775 
OSDSh¬d
 *
sd©a
,

1776 
PG
 *
pg
,

1777 
•och_t
 
•och
,

1778 
Th»adPoŞ
::
TPHªdË
& 
hªdË
);

1780 
ä›nd
 
şass
 
	gPG
;

1781 
ä›nd
 
şass
 
	gPrim¬yLogPG
;

1784 
	g´Ùeùed
:

1787 
OSDM­Ref
 
osdm­
;

1788 
OSDM­Ref
 
g‘_osdm­
() {

1789  
	gosdm­
;

1791 
•och_t
 
g‘_osdm­_•och
() const {

1792  
	gosdm­
 ? osdm­->
g‘_•och
() : 0;

1795 
utime_t
 
	ghad_m­_sšû
;

1796 
RWLock
 
	gm­_lock
;

1797 
	gli¡
<
	gOpReque¡Ref
> 
	gwa™šg_fÜ_osdm­
;

1798 
	gdeque
<
	gutime_t
> 
	gosd_m¬kdown_log
;

1800 
ä›nd
 
	g£nd_m­_Ú_de¡ruù
;

1802 
wa™_fÜ_Ãw_m­
(
OpReque¡Ref
 
İ
);

1803 
hªdË_osd_m­
(
şass
 
MOSDM­
 *
m
);

1804 
_comm™‹d_osd_m­s
(
•och_t
 
fœ¡
,ƒpoch_ˆ
Ï¡
, 
şass
 
MOSDM­
 *
m
);

1805 
Œim_m­s
(
•och_t
 
Şde¡
, 
Äeûived
, 
boŞ
 
sk_m­s
);

1806 
nÙe_down_osd
(
osd
);

1807 
nÙe_up_osd
(
osd
);

1808 
ä›nd
 
şass
 
	gC_OnM­Comm™
;

1810 
advªû_pg
(

1811 
•och_t
 
advªû_to
, 
PG
 *
pg
,

1812 
Th»adPoŞ
::
TPHªdË
 &
hªdË
,

1813 
PG
::
Recov”yCtx
 *
rùx
);

1814 
cÚsume_m­
();

1815 
aùiv©e_m­
();

1818 
OSDM­Ref
 
g‘_m­
(
•och_t
 
e
) {

1819  
	g£rviû
.
g‘_m­
(
e
);

1821 
OSDM­Ref
 
add_m­
(
OSDM­
 *
o
) {

1822  
	g£rviû
.
add_m­
(
o
);

1824 
add_m­_bl
(
•och_t
 
e
, 
bufã¾i¡
& 
bl
) {

1825  
	g£rviû
.
add_m­_bl
(
e
, 
bl
);

1827 
boŞ
 
g‘_m­_bl
(
•och_t
 
e
, 
bufã¾i¡
& 
bl
) {

1828  
	g£rviû
.
g‘_m­_bl
(
e
, 
bl
);

1830 
add_m­_šc_bl
(
•och_t
 
e
, 
bufã¾i¡
& 
bl
) {

1831  
	g£rviû
.
add_m­_šc_bl
(
e
, 
bl
);

1834 
	gpublic
:

1836 
veùÜ
<
OSDSh¬d
*> 
sh¬ds
;

1837 
ušt32_t
 
	gnum_sh¬ds
 = 0;

1839 
šc_num_pgs
() {

1840 ++
	gnum_pgs
;

1842 
dec_num_pgs
() {

1843 --
	gnum_pgs
;

1846 
	g´Ùeùed
:

1848 
¡d
::
©omic
<
size_t
> 
num_pgs
 = {0};

1850 
	g¡d
::
mu‹x
 
³ndšg_ü—‹s_lock
;

1851 
usšg
 
	gü—‹_äom_osd_t
 = 
¡d
::
·œ
<
pg_t
, 
	gboŞ
 >;

1852 
	g¡d
::
£t
<
ü—‹_äom_osd_t
> 
³ndšg_ü—‹s_äom_osd
;

1853 
	g³ndšg_ü—‹s_äom_mÚ
 = 0;

1855 
PGRecov”ySts
 
	gpg_»cov”y_¡©s
;

1857 
PGRef
 
_lookup_pg
(
¥g_t
 
pgid
);

1858 
PGRef
 
_lookup_lock_pg
(
¥g_t
 
pgid
);

1859 
»gi¡”_pg
(
PGRef
 
pg
);

1860 
uÄegi¡”_pg
(
PG
 *
pg
);

1862 
_g‘_pgs
(
veùÜ
<
PGRef
> *
v
, 
boŞ
 
ş—r_too
=
çl£
);

1863 
_g‘_pgids
(
veùÜ
<
¥g_t
> *
v
);

1865 
	gpublic
:

1866 
PGRef
 
lookup_lock_pg
(
¥g_t
 
pgid
);

1868 
	g¡d
::
£t
<
št64_t
> 
g‘_m­³d_poŞs
();

1870 
	g´Ùeùed
:

1871 
PG
* 
_make_pg
(
OSDM­Ref
 
ü—‹m­
, 
¥g_t
 
pgid
);

1873 
boŞ
 
maybe_wa™_fÜ_max_pg
(cÚ¡ 
OSDM­Ref
& 
osdm­
,

1874 
¥g_t
 
pgid
, 
boŞ
 
is_mÚ_ü—‹
);

1875 
»sume_ü—tšg_pg
();

1877 
lßd_pgs
();

1880 
bud_š™Ÿl_pg_hi¡Üy
(

1881 
¥g_t
 
pgid
,

1882 
•och_t
 
ü—‹d
,

1883 
utime_t
 
ü—‹d_¡amp
,

1884 
pg_hi¡Üy_t
 *
h
,

1885 
Pa¡IÁ”v®s
 *
pi
);

1888 
boŞ
 
´ojeù_pg_hi¡Üy
(

1889 
¥g_t
 
pgid
, 
pg_hi¡Üy_t
& 
h
, 
•och_t
 
äom
,

1890 cÚ¡ 
veùÜ
<>& 
Ï¡up
,

1891 
Ï¡uµrim¬y
,

1892 cÚ¡ 
veùÜ
<>& 
Ï¡aùšg
,

1893 
Ï¡aùšg´im¬y


1896 
•och_t
 
	gÏ¡_pg_ü—‹_•och
;

1898 
hªdË_pg_ü—‹
(
OpReque¡Ref
 
İ
);

1900 
¥l™_pgs
(

1901 
PG
 *
·»Á
,

1902 cÚ¡ 
£t
<
¥g_t
> &
chdpgids
, s‘<
PGRef
> *
out_pgs
,

1903 
OSDM­Ref
 
curm­
,

1904 
OSDM­Ref
 
Ãxtm­
,

1905 
PG
::
Recov”yCtx
 *
rùx
);

1906 
_fšish_¥l™s
(
£t
<
PGRef
>& 
pgs
);

1909 
Mu‹x
 
	gmÚ_»pÜt_lock
;

1910 
utime_t
 
	gÏ¡_mÚ_»pÜt
;

1913 
¡¬t_boÙ
();

1914 
_gÙ_mÚ_•ochs
(
•och_t
 
Şde¡
,ƒpoch_ˆ
Ãwe¡
);

1915 
_´eboÙ
(
•och_t
 
Şde¡
,ƒpoch_ˆ
Ãwe¡
);

1916 
_£nd_boÙ
();

1917 
_cŞËù_m‘ad©a
(
m­
<
¡ršg
,¡ršg> *
pm‘a
);

1918 
	g¡d
::
¡ršg
 
_cŞËù_com´essiÚ_®gÜ™hms
();

1920 
¡¬t_wa™šg_fÜ_h—Éhy
();

1921 
boŞ
 
_is_h—Éhy
();

1923 
£nd_fuÎ_upd©e
();

1925 
ä›nd
 
	gC_OSD_G‘V”siÚ
;

1928 
•och_t
 
	gup_thru_wª‹d
;

1930 
queue_wªt_up_thru
(
•och_t
 
wªt
);

1931 
£nd_®ive
();

1934 
•och_t
 
	g»que¡ed_fuÎ_fœ¡
, 
	g»que¡ed_fuÎ_Ï¡
;

1936 
»que¡_fuÎ_m­
(
•och_t
 
fœ¡
,ƒpoch_ˆ
Ï¡
);

1937 
»»que¡_fuÎ_m­s
() {

1938 
•och_t
 
	gfœ¡
 = 
»que¡ed_fuÎ_fœ¡
;

1939 
•och_t
 
	gÏ¡
 = 
»que¡ed_fuÎ_Ï¡
;

1940 
	g»que¡ed_fuÎ_fœ¡
 = 0;

1941 
	g»que¡ed_fuÎ_Ï¡
 = 0;

1942 
»que¡_fuÎ_m­
(
fœ¡
, 
Ï¡
);

1944 
gÙ_fuÎ_m­
(
•och_t
 
e
);

1947 
	gm­
<,
	gutime_t
> 
	gçu»_queue
;

1948 
	gm­
<,
	g·œ
<
	gutime_t
,
	g’t™y_š¡_t
> > 
	gçu»_³ndšg
;

1950 
»queue_çu»s
();

1951 
£nd_çu»s
();

1952 
£nd_¡l_®ive
(
•och_t
 
•och
, cÚ¡ 
’t™y_š¡_t
 &
i
);

1954 
	gûph
::
cßr£_mÚo_şock
::
time_pošt
 
Ï¡_£Á_b—cÚ
;

1955 
Mu‹x
 
	gmš_Ï¡_•och_ş—n_lock
{"OSD::min_last_epoch_clean_lock"};

1956 
•och_t
 
	gmš_Ï¡_•och_ş—n
 = 0;

1958 
	g¡d
::
veùÜ
<
pg_t
> 
mš_Ï¡_•och_ş—n_pgs
;

1959 
£nd_b—cÚ
(cÚ¡ 
ûph
::
cßr£_mÚo_şock
::
time_pošt
& 
now
);

1961 
ûph_tid_t
 
g‘_tid
() {

1962  
	g£rviû
.
g‘_tid
();

1966 
	gPG
::
Recov”yCtx
 
ü—‹_cÚ‹xt
();

1967 
di¥©ch_cÚ‹xt
(
PG
::
Recov”yCtx
 &
ùx
, PG *
pg
, 
OSDM­Ref
 
curm­
,

1968 
Th»adPoŞ
::
TPHªdË
 *
hªdË
 = 
NULL
);

1969 
di¥©ch_cÚ‹xt_Œª§ùiÚ
(
PG
::
Recov”yCtx
 &
ùx
, PG *
pg
,

1970 
Th»adPoŞ
::
TPHªdË
 *
hªdË
 = 
NULL
);

1971 
disÿrd_cÚ‹xt
(
PG
::
Recov”yCtx
 &
ùx
);

1972 
do_nÙif›s
(
m­
<,

1973 
veùÜ
<
·œ
<
pg_nÙify_t
, 
Pa¡IÁ”v®s
> > >&

1974 
nÙify_li¡
,

1975 
OSDM­Ref
 
m­
);

1976 
do_qu”›s
(
m­
<, m­<
¥g_t
,
pg_qu”y_t
> >& 
qu”y_m­
,

1977 
OSDM­Ref
 
m­
);

1978 
do_šfos
(
m­
<,

1979 
veùÜ
<
·œ
<
pg_nÙify_t
, 
Pa¡IÁ”v®s
> > >& 
šfo_m­
,

1980 
OSDM­Ref
 
m­
);

1982 
boŞ
 
»quœe_mÚ_³”
(cÚ¡ 
Mes§ge
 *
m
);

1983 
boŞ
 
»quœe_mÚ_Ü_mgr_³”
(cÚ¡ 
Mes§ge
 *
m
);

1984 
boŞ
 
»quœe_osd_³”
(cÚ¡ 
Mes§ge
 *
m
);

1989 
boŞ
 
»quœe_£lf_®iv’ess
(cÚ¡ 
Mes§ge
 *
m
, 
•och_t
 
®ive_sšû
);

1995 
boŞ
 
»quœe_§me_³”_š¡ªû
(cÚ¡ 
Mes§ge
 *
m
, 
OSDM­Ref
& 
m­
,

1996 
boŞ
 
is_ç¡_di¥©ch
);

1998 
boŞ
 
»quœe_§me_Ü_Ãw”_m­
(
OpReque¡Ref
& 
İ
, 
•och_t
 
e
,

1999 
boŞ
 
is_ç¡_di¥©ch
);

2001 
hªdË_ç¡_pg_ü—‹
(
MOSDPGC»©e2
 *
m
);

2002 
hªdË_ç¡_pg_qu”y
(
MOSDPGQu”y
 *
m
);

2003 
hªdË_pg_qu”y_nİg
(cÚ¡ 
MQu”y
& 
q
);

2004 
hªdË_ç¡_pg_nÙify
(
MOSDPGNÙify
 *
m
);

2005 
hªdË_pg_nÙify_nİg
(cÚ¡ 
MNÙifyRec
& 
q
);

2006 
hªdË_ç¡_pg_šfo
(
MOSDPGInfo
 *
m
);

2007 
hªdË_ç¡_pg_»move
(
MOSDPGRemove
 *
m
);

2009 
PGRef
 
hªdË_pg_ü—‹_šfo
(cÚ¡ 
OSDM­Ref
& 
osdm­
, cÚ¡ 
PGC»©eInfo
 *
šfo
);

2011 
hªdË_ç¡_fÜû_»cov”y
(
MOSDFÜûRecov”y
 *
m
);

2014 
	sCommªd
 {

2015 
	gveùÜ
<
	g¡ršg
> 
	gcmd
;

2016 
ûph_tid_t
 
	gtid
;

2017 
bufã¾i¡
 
	gšd©a
;

2018 
CÚÃùiÚRef
 
	gcÚ
;

2020 
Commªd
(
veùÜ
<
¡ršg
>& 
c
, 
ûph_tid_t
 
t
, 
bufã¾i¡
& 
bl
, 
CÚÃùiÚ
 *
co
)

2021 : 
cmd
(
c
), 
tid
(
t
), 
šd©a
(
bl
), 
cÚ
(
co
) {}

2023 
	gli¡
<
	gCommªd
*> 
	gcommªd_queue
;

2024 
	gCommªdWQ
 : 
public
 
Th»adPoŞ
::
WÜkQueue
<
Commªd
> {

2025 
OSD
 *
osd
;

2026 
CommªdWQ
(
OSD
 *
o
, 
time_t
 
ti
,ime_ˆ
si
, 
Th»adPoŞ
 *

)

2027 : 
Th»adPoŞ
::
WÜkQueue
<
Commªd
>("OSD::CommªdWQ", 
	gti
, 
	gsi
, 
	g
), 
osd
(
o
) {}

2029 
boŞ
 
_em±y
(è
	gov”ride
 {

2030  
	gosd
->
	gcommªd_queue
.
em±y
();

2032 
boŞ
 
_’queue
(
Commªd
 *
c
è
	gov”ride
 {

2033 
	gosd
->
	gcommªd_queue
.
push_back
(
c
);

2034  
	gŒue
;

2036 
_dequeue
(
Commªd
 *
pg
è
	gov”ride
 {

2037 
ûph_abÜt
();

2039 
Commªd
 *
_dequeue
(è
	gov”ride
 {

2040 ià(
	gosd
->
	gcommªd_queue
.
em±y
())

2041  
	gNULL
;

2042 
Commªd
 *
	gc
 = 
osd
->
commªd_queue
.
äÚt
();

2043 
	gosd
->
	gcommªd_queue
.
pİ_äÚt
();

2044  
	gc
;

2046 
_´oûss
(
Commªd
 *
c
, 
Th»adPoŞ
::
TPHªdË
 &è
ov”ride
 {

2047 
osd
->
osd_lock
.
Lock
();

2048 ià(
	gosd
->
is_¡İpšg
()) {

2049 
	gosd
->
	gosd_lock
.
UÆock
();

2050 
d–‘e
 
	gc
;

2053 
	gosd
->
do_commªd
(
c
->
cÚ
.
g‘
(), c->
tid
, c->
cmd
, c->
šd©a
);

2054 
	gosd
->
	gosd_lock
.
UÆock
();

2055 
d–‘e
 
	gc
;

2057 
_ş—r
(è
	gov”ride
 {

2058 !
	gosd
->
	gcommªd_queue
.
em±y
()) {

2059 
Commªd
 *
	gc
 = 
osd
->
commªd_queue
.
äÚt
();

2060 
	gosd
->
	gcommªd_queue
.
pİ_äÚt
();

2061 
d–‘e
 
	gc
;

2064 } 
	gcommªd_wq
;

2066 
hªdË_commªd
(
şass
 
MMÚCommªd
 *
m
);

2067 
hªdË_commªd
(
şass
 
MCommªd
 *
m
);

2068 
do_commªd
(
CÚÃùiÚ
 *
cÚ
, 
ûph_tid_t
 
tid
, 
veùÜ
<
¡ršg
>& 
cmd
, 
bufã¾i¡
& 
d©a
);

2071 
do_»cov”y
(
PG
 *
pg
, 
•och_t
 
•och_queued
, 
ušt64_t
 
pushes_»£rved
,

2072 
Th»adPoŞ
::
TPHªdË
 &
hªdË
);

2076 
sched_süub
();

2077 
boŞ
 
süub_¿ndom_backoff
();

2078 
boŞ
 
süub_lßd_b–ow_th»shŞd
();

2079 
boŞ
 
süub_time_³rm™
(
utime_t
 
now
);

2082 
MPGSts
 *
cŞËù_pg_¡©s
();

2083 
	g¡d
::
veùÜ
<
D«mÚH—ÉhM‘ric
> 
g‘_h—Éh_m‘rics
();

2085 
	g´iv©e
:

2086 
boŞ
 
ms_ÿn_ç¡_di¥©ch_ªy
(ècÚ¡ 
ov”ride
 {  
Œue
; }

2087 
boŞ
 
ms_ÿn_ç¡_di¥©ch
(cÚ¡ 
Mes§ge
 *
m
ècÚ¡ 
	gov”ride
 {

2088 
	gm
->
g‘_ty³
()) {

2089 
	gCEPH_MSG_PING
:

2090 
CEPH_MSG_OSD_OP
:

2091 
CEPH_MSG_OSD_BACKOFF
:

2092 
MSG_OSD_SCRUB2
:

2093 
MSG_OSD_FORCE_RECOVERY
:

2094 
MSG_MON_COMMAND
:

2095 
MSG_OSD_PG_CREATE2
:

2096 
MSG_OSD_PG_QUERY
:

2097 
MSG_OSD_PG_INFO
:

2098 
MSG_OSD_PG_NOTIFY
:

2099 
MSG_OSD_PG_LOG
:

2100 
MSG_OSD_PG_TRIM
:

2101 
MSG_OSD_PG_REMOVE
:

2102 
MSG_OSD_BACKFILL_RESERVE
:

2103 
MSG_OSD_RECOVERY_RESERVE
:

2104 
MSG_OSD_REPOP
:

2105 
MSG_OSD_REPOPREPLY
:

2106 
MSG_OSD_PG_PUSH
:

2107 
MSG_OSD_PG_PULL
:

2108 
MSG_OSD_PG_PUSH_REPLY
:

2109 
MSG_OSD_PG_SCAN
:

2110 
MSG_OSD_PG_BACKFILL
:

2111 
MSG_OSD_PG_BACKFILL_REMOVE
:

2112 
MSG_OSD_EC_WRITE
:

2113 
MSG_OSD_EC_WRITE_REPLY
:

2114 
MSG_OSD_EC_READ
:

2115 
MSG_OSD_EC_READ_REPLY
:

2116 
MSG_OSD_SCRUB_RESERVE
:

2117 
MSG_OSD_REP_SCRUB
:

2118 
MSG_OSD_REP_SCRUBMAP
:

2119 
MSG_OSD_PG_UPDATE_LOG_MISSING
:

2120 
MSG_OSD_PG_UPDATE_LOG_MISSING_REPLY
:

2121 
MSG_OSD_PG_RECOVERY_DELETE
:

2122 
MSG_OSD_PG_RECOVERY_DELETE_REPLY
:

2123  
Œue
;

2125  
çl£
;

2128 
ms_ç¡_di¥©ch
(
Mes§ge
 *
m
è
	gov”ride
;

2129 
ms_ç¡_´•roûss
(
Mes§ge
 *
m
è
	gov”ride
;

2130 
boŞ
 
ms_di¥©ch
(
Mes§ge
 *
m
è
	gov”ride
;

2131 
boŞ
 
ms_g‘_authÜiz”
(
de¡_ty³
, 
AuthAuthÜiz”
 **
authÜiz”
, boŞ 
fÜû_Ãw
è
	gov”ride
;

2132 
boŞ
 
ms_v”ify_authÜiz”
(
CÚÃùiÚ
 *
cÚ
, 
³”_ty³
,

2133 
´ÙocŞ
, 
bufã¾i¡
& 
authÜiz”
, bufã¾i¡& 
authÜiz”_»¶y
,

2134 
boŞ
& 
isv®id
, 
Cry±oKey
& 
£ssiÚ_key
è
	gov”ride
;

2135 
ms_hªdË_cÚÃù
(
CÚÃùiÚ
 *
cÚ
è
	gov”ride
;

2136 
ms_hªdË_ç¡_cÚÃù
(
CÚÃùiÚ
 *
cÚ
è
	gov”ride
;

2137 
ms_hªdË_ç¡_acû±
(
CÚÃùiÚ
 *
cÚ
è
	gov”ride
;

2138 
boŞ
 
ms_hªdË_»£t
(
CÚÃùiÚ
 *
cÚ
è
	gov”ride
;

2139 
ms_hªdË_»mÙe_»£t
(
CÚÃùiÚ
 *
cÚ
è
	gov”ride
 {}

2140 
boŞ
 
ms_hªdË_»fu£d
(
CÚÃùiÚ
 *
cÚ
è
	gov”ride
;

2142 
io_queue
 
g‘_io_queue
() const {

2143 ià(
	gcù
->
	g_cÚf
->
	gosd_İ_queue
 == "debug_random") {

2144 
io_queue
 
šdex_lookup
[] = { io_queue::
´iÜ™ized
,

2145 
io_queue
::
weigh‹d´iÜ™y
,

2146 
io_queue
::
mşock_İşass
,

2147 
io_queue
::
mşock_ş›Á
 };

2148 
¤ªd
(
time
(
NULL
));

2149 
	gwhich
 = 
¿nd
(è% ((
šdex_lookup
) / (index_lookup[0]));

2150  
	gšdex_lookup
[
which
];

2151 } ià(
	gcù
->
	g_cÚf
->
	gosd_İ_queue
 == "prioritized") {

2152  
io_queue
::
´iÜ™ized
;

2153 } ià(
	gcù
->
	g_cÚf
->
	gosd_İ_queue
 == "mclock_opclass") {

2154  
io_queue
::
mşock_İşass
;

2155 } ià(
	gcù
->
	g_cÚf
->
	gosd_İ_queue
 == "mclock_client") {

2156  
io_queue
::
mşock_ş›Á
;

2159  
	gio_queue
::
weigh‹d´iÜ™y
;

2163 
g‘_io_´io_cut
() const {

2164 ià(
	gcù
->
	g_cÚf
->
	gosd_İ_queue_cut_off
 == "debug_random") {

2165 
¤ªd
(
time
(
NULL
));

2166  (
¿nd
(è% 2 < 1è? 
	gCEPH_MSG_PRIO_HIGH
 : 
CEPH_MSG_PRIO_LOW
;

2167 } ià(
	gcù
->
	g_cÚf
->
	gosd_İ_queue_cut_off
 == "high") {

2168  
CEPH_MSG_PRIO_HIGH
;

2171  
	gCEPH_MSG_PRIO_LOW
;

2175 
	gpublic
:

2178 
OSD
(
C•hCÚ‹xt
 *
cù_
,

2179 
ObjeùStÜe
 *
¡Üe_
,

2180 
id
,

2181 
Mes£ng”
 *
š‹º®
,

2182 
Mes£ng”
 *
ex‹º®
,

2183 
Mes£ng”
 *
hb_äÚt_ş›Á
,

2184 
Mes£ng”
 *
hb_back_ş›Á
,

2185 
Mes£ng”
 *
hb_äÚt_£rv”
,

2186 
Mes£ng”
 *
hb_back_£rv”
,

2187 
Mes£ng”
 *
osdc_mes£ng”
,

2188 
MÚCl›Á
 *
mc
, cÚ¡ 
¡d
::
¡ršg
 &
dev
, cÚ¡ std::¡ršg &
jdev
);

2189 ~
OSD
(è
	gov”ride
;

2192 
mkfs
(
C•hCÚ‹xt
 *
cù
, 
ObjeùStÜe
 *
¡Üe
,

2193 cÚ¡ 
¡ršg
& 
dev
,

2194 
uuid_d
 
fsid
, 
whßmi
);

2196 
f‹r_x©Œs
(
m­
<
¡ršg
, 
bufã½Œ
>& 
©Œs
) {

2197 
	gm­
<
	g¡ršg
, 
	gbufã½Œ
>::
™”©Ü
 
™”
 = 
©Œs
.
begš
();

2198 
	g™”
 !ğ
©Œs
.
’d
();

2200 ià(('_' !ğ
™”
->
fœ¡
.
©
(0)è|| (™”->fœ¡.
size
() == 1))

2201 
©Œs
.
”a£
(
™”
++);

2202 ++
	g™”
;

2206 
	g´iv©e
:

2207 
mÚ_cmd_maybe_osd_ü—‹
(
¡ršg
 &
cmd
);

2208 
upd©e_üush_deviû_şass
();

2209 
upd©e_üush_loÿtiÚ
();

2211 
wr™e_m‘a
(
C•hCÚ‹xt
 *
cù
,

2212 
ObjeùStÜe
 *
¡Üe
,

2213 
uuid_d
& 
şu¡”_fsid
, uuid_d& 
osd_fsid
, 
whßmi
);

2215 
hªdË_süub
(
MOSDSüub
 *
m
);

2216 
hªdË_ç¡_süub
(
MOSDSüub2
 *
m
);

2217 
hªdË_osd_pšg
(
şass
 
MOSDPšg
 *
m
);

2219 
š™_İ_æags
(
OpReque¡Ref
& 
İ
);

2221 
g‘_num_İ_sh¬ds
();

2222 
g‘_num_İ_th»ads
();

2224 
g‘_osd_»cov”y_¦“p
();

2226 
´obe_sm¬t
(
o¡»am
& 
ss
);

2227 
´obe_sm¬t_deviû
(cÚ¡ *
deviû
, 
timeout
, 
¡d
::
¡ršg
 *
»suÉ
);

2229 
	gpublic
:

2230 
³ek_m‘a
(
ObjeùStÜe
 *
¡Üe
, 
¡ršg
& 
magic
,

2231 
uuid_d
& 
şu¡”_fsid
, uuid_d& 
osd_fsid
, & 
whßmi
);

2235 
´e_š™
();

2236 
š™
();

2237 
fš®_š™
();

2239 
’abË_di§bË_fu£
(
boŞ
 
¡İ
);

2241 
suicide
(
ex™code
);

2242 
shutdown
();

2244 
hªdË_sigÇl
(
signum
);

2247 
boŞ
 
İ_is_disÿrdabË
(cÚ¡ 
MOSDOp
 *
m
);

2249 
	gpublic
:

2250 
OSDS”viû
 
£rviû
;

2251 
ä›nd
 
şass
 
	gOSDS”viû
;

2255 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
out
, cÚ¡ 
	gio_queue
& 
	gq
);

2259 cÚ¡ 
Com·tS‘
::
F—tu»
 
ûph_osd_ã©u»_com·t
[];

2260 cÚ¡ 
Com·tS‘
::
F—tu»
 
ûph_osd_ã©u»_ro_com·t
[];

2261 cÚ¡ 
Com·tS‘
::
F—tu»
 
ûph_osd_ã©u»_šcom·t
[];

	@osd/OSDCap.cc

15 
	~<boo¡/cÚfig/w¬nšg_di§bË.hµ
>

16 
	~<boo¡/¥œ™/šşude/qi.hµ
>

17 
	~<boo¡/¥œ™/šşude/phÛnix_İ”©Ü.hµ
>

18 
	~<boo¡/¥œ™/šşude/phÛnix.hµ
>

19 
	~<boo¡/®gÜ™hm/¡ršg/´ediÿ‹.hµ
>

21 
	~"OSDC­.h
"

22 
	~"commÚ/cÚfig.h
"

23 
	~"commÚ/debug.h
"

25 
usšg
 
	g¡d
::
o¡»am
;

26 
usšg
 
	g¡d
::
veùÜ
;

28 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gosd_rwxa_t
& 
	gp
)

30 ià(
	gp
 =ğ
OSD_CAP_ANY
)

31  
out
 << "*";

33 ià(
	gp
 & 
	gOSD_CAP_R
)

34 
	gout
 << "r";

35 ià(
	gp
 & 
	gOSD_CAP_W
)

36 
	gout
 << "w";

37 ià((
	gp
 & 
	gOSD_CAP_X
è=ğ
OSD_CAP_X
) {

38 
out
 << "x";

40 ià(
	gp
 & 
	gOSD_CAP_CLS_R
)

41 
	gout
 << " class-read";

42 ià(
	gp
 & 
	gOSD_CAP_CLS_W
)

43 
	gout
 << " class-write";

45  
	gout
;

48 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gOSDC­S³c
& 
	gs
)

50 ià(
	gs
.
	g®low
)

51  
	gout
 << 
	gs
.
	g®low
;

52 ià(
	gs
.
	gşass_Çme
.
Ëngth
()) {

53 
	gout
 << "şas '" << 
	gs
.
	gşass_Çme
 << "'";

54 ià(!
	gs
.
	gm‘hod_Çme
.
em±y
()) {

55 
	gout
 << " '" << 
	gs
.
	gm‘hod_Çme
 << "'";

58  
	gout
;

61 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gOSDC­PoŞName¥aû
& 
	g²s
)

63 ià(!
	g²s
.
	gpoŞ_Çme
.
em±y
()) {

64 
	gout
 << "poŞ " << 
	g²s
.
	gpoŞ_Çme
 << " ";

66 ià(
	g²s
.
	gn¥aû
) {

67 
	gout
 << "namespace ";

68 ià(
	g²s
.
	gn¥aû
->
em±y
()) {

69 
	gout
 << "\"\"";

71 
	gout
 << *
	g²s
.
	gn¥aû
;

73 
	gout
 << " ";

75  
	gout
;

78 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am &
	gout
, cÚ¡ 
	gOSDC­PoŞTag
 &
	g±
)

80 
	gout
 << "­°" << 
	g±
.
	g­¶iÿtiÚ
 << " key " <<…t.
	gkey
 << " v® " <<…t.
	gv®ue


82  
	gout
;

85 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gOSDC­M©ch
& 
	gm
)

87 ià(
	gm
.
	gauid
 != -1LL) {

88 
out
 << "auid " << 
m
.
auid
 << " ";

91 ià(!
	gm
.
	gpoŞ_Çme¥aû
.
	gpoŞ_Çme
.
em±y
(è|| m.poŞ_Çme¥aû.
	gn¥aû
) {

92 
	gout
 << 
	gm
.
	gpoŞ_Çme¥aû
;

95 ià(!
	gm
.
	gpoŞ_g
.
	g­¶iÿtiÚ
.
em±y
()) {

96 
	gout
 << 
	gm
.
	gpoŞ_g
;

99 ià(
	gm
.
	gobjeù_´efix
.
Ëngth
()) {

100 
	gout
 << "objeù_´efix " << 
	gm
.
	gobjeù_´efix
 << " ";

102  
	gout
;

105 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gOSDC­Profe
& 
	gm
)

107 
	gout
 << "´of" << 
	gm
.
	gÇme
;

108 
	gout
 << 
	gm
.
	gpoŞ_Çme¥aû
;

109  
	gout
;

112 
boŞ
 
	gOSDC­PoŞName¥aû
::
	$is_m©ch
(cÚ¡ 
¡d
::
¡ršg
& 
²
,

113 cÚ¡ 
¡d
::
¡ršg
& 
ns
) const

115 ià(!
poŞ_Çme
.
	`em±y
()) {

116 ià(
poŞ_Çme
 !ğ
²
) {

117  
çl£
;

120 ià(
n¥aû
) {

121 ià((*
n¥aû
)[n¥aû->
	`Ëngth
() - 1] == '*' &&

122 
boo¡
::
	`¡¬ts_w™h
(
ns
, 
n¥aû
->
	`sub¡r
(0,‚¥aû->
	`Ëngth
() - 1))) {

123  
Œue
;

126 ià(*
n¥aû
 !ğ
ns
) {

127  
çl£
;

130  
Œue
;

131 
	}
}

133 
boŞ
 
	gOSDC­PoŞName¥aû
::
	$is_m©ch_®l
() const

135 ià(!
poŞ_Çme
.
	`em±y
())

136  
çl£
;

137 ià(
n¥aû
)

138  
çl£
;

139  
Œue
;

140 
	}
}

142 
boŞ
 
	gOSDC­PoŞTag
::
	$is_m©ch
(cÚ¡ 
­p_m­_t
& 
­p_m­
) const

144 ià(
­¶iÿtiÚ
.
	`em±y
()) {

145  
Œue
;

147 autØ
kv_m­
 = 
­p_m­
.
	`fšd
(
­¶iÿtiÚ
);

148 ià(
kv_m­
 =ğ
­p_m­
.
	`’d
()) {

149  
çl£
;

151 ià(!
key
.
	`com·»
("*"è&& !
v®ue
.compare("*")) {

152  
Œue
;

154 ià(!
key
.
	`com·»
("*")) {

155 autØ
™
 : 
kv_m­
->
£cÚd
) {

156 ià(
™
.
£cÚd
 =ğ
v®ue
) {

157  
Œue
;

160  
çl£
;

162 autØ
kv_v®
 = 
kv_m­
->
£cÚd
.
	`fšd
(
key
);

163 ià(
kv_v®
 =ğ
kv_m­
->
£cÚd
.
	`’d
()) {

164  
çl£
;

166 ià(!
v®ue
.
	`com·»
("*")) {

167  
Œue
;

169  
kv_v®
->
£cÚd
 =ğ
v®ue
;

170 
	}
}

172 
boŞ
 
	gOSDC­PoŞTag
::
	$is_m©ch_®l
() const {

173  
­¶iÿtiÚ
.
	`em±y
();

174 
	}
}

176 
boŞ
 
	gOSDC­M©ch
::
	$is_m©ch
(cÚ¡ 
¡ršg
& 
²
, cÚ¡ sŒšg& 
ns
,

177 
št64_t
 
poŞ_auid
,

178 cÚ¡ 
OSDC­PoŞTag
::
­p_m­_t
& 
­p_m­
,

179 cÚ¡ 
¡ršg
& 
objeù
) const

181 ià(
auid
 >= 0) {

182 ià(
auid
 !ğ
poŞ_auid
)

183  
çl£
;

184 } ià(!
poŞ_Çme¥aû
.
	`is_m©ch
(
²
, 
ns
)) {

185  
çl£
;

186 } ià(!
poŞ_g
.
	`is_m©ch
(
­p_m­
)) {

187  
çl£
;

190 ià(
objeù_´efix
.
	`Ëngth
()) {

191 ià(
objeù
.
	`fšd
(
objeù_´efix
) != 0)

192  
çl£
;

194  
Œue
;

195 
	}
}

197 
boŞ
 
	gOSDC­M©ch
::
	$is_m©ch_®l
() const

199 ià(
auid
 >= 0) {

200  
çl£
;

201 } ià(!
poŞ_Çme¥aû
.
	`is_m©ch_®l
()) {

202  
çl£
;

203 } ià(!
poŞ_g
.
	`is_m©ch_®l
()) {

204  
çl£
;

207 ià(
objeù_´efix
.
	`Ëngth
()) {

208  
çl£
;

210  
Œue
;

211 
	}
}

213 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gOSDC­G¿Á
& 
	gg
)

215 
	gout
 << "grant(";

216 ià(
	gg
.
	g´ofe
.
is_v®id
()) {

217 
	gout
 << 
	gg
.
	g´ofe
 << " [";

218 autØ
	g™
 = 
g
.
´ofe_g¿Ás
.
cbegš
();

219 
	g™
 !ğ
g
.
´ofe_g¿Ás
.
ûnd
(); ++it) {

220 ià(
	g™
 !ğ
g
.
´ofe_g¿Ás
.
cbegš
()) {

221 
out
 << ",";

223 
	gout
 << *
	g™
;

225 
	gout
 << "]";

227 
	gout
 << 
	gg
.
	gm©ch
 << g.
	g¥ec
;

229 
	gout
 << ")";

230  
	gout
;

233 
boŞ
 
	gOSDC­G¿Á
::
	$®low_®l
() const

235 ià(
´ofe
.
	`is_v®id
()) {

236  
¡d
::
	`ªy_of
(
´ofe_g¿Ás
.
	`cbegš
(),…rofe_g¿Ás.
	`ûnd
(),

237 [](cÚ¡ 
OSDC­G¿Á
& 
g¿Á
) {

238  
g¿Á
.
	`®low_®l
();

242  (
m©ch
.
	`is_m©ch_®l
(è&& 
¥ec
.
	`®low_®l
());

243 
	}
}

245 
boŞ
 
	gOSDC­G¿Á
::
is_ÿ·bË
(cÚ¡ 
¡ršg
& 
poŞ_Çme
, cÚ¡ sŒšg& 
ns
,

246 
št64_t
 
poŞ_auid
,

247 cÚ¡ 
OSDC­PoŞTag
::
­p_m­_t
& 
­¶iÿtiÚ_m‘ad©a
,

248 cÚ¡ 
¡ršg
& 
objeù
,

249 
boŞ
 
İ_may_»ad
, boŞ 
İ_may_wr™e
,

250 cÚ¡ 
¡d
::
veùÜ
<
OpReque¡
::
CÏssInfo
>& 
şas£s
,

251 
¡d
::
veùÜ
<
boŞ
>* 
şass_®lowed
) const

253 
osd_rwxa_t
 
®low
 = 0;

254 ià(
	g´ofe
.
is_v®id
()) {

255  
	g¡d
::
ªy_of
(
´ofe_g¿Ás
.
cbegš
(),…rofe_g¿Ás.
ûnd
(),

256 [&](cÚ¡ 
OSDC­G¿Á
& 
g¿Á
) {

257  
g¿Á
.
is_ÿ·bË
(
poŞ_Çme
, 
ns
, 
poŞ_auid
,

258 
­¶iÿtiÚ_m‘ad©a
,

259 
objeù
, 
İ_may_»ad
,

260 
İ_may_wr™e
, 
şas£s
,

261 
şass_®lowed
);

264 ià(
	gm©ch
.
is_m©ch
(
poŞ_Çme
, 
ns
, 
poŞ_auid
, 
­¶iÿtiÚ_m‘ad©a
, 
objeù
)) {

265 
	g®low
 = 
®low
 | 
¥ec
.allow;

266 ià((
	gİ_may_»ad
 && !(
	g®low
 & 
	gOSD_CAP_R
)) ||

267 (
	gİ_may_wr™e
 && !(
	g®low
 & 
	gOSD_CAP_W
))) {

268  
	gçl£
;

270 ià(!
	gşas£s
.
em±y
()) {

272 ià(
	g¥ec
.
®low_®l
()) {

273  
	gŒue
;

277 
size_t
 
	gi
 = 0; i < 
	gşas£s
.
size
(); ++i) {

279 ià(!
	g¥ec
.
	gşass_Çme
.
em±y
() &&

280 
	gşas£s
[
i
].
	gşass_Çme
 =ğ
¥ec
.
şass_Çme
 &&

281 (
¥ec
.
m‘hod_Çme
.
em±y
() ||

282 
şas£s
[
i
].
m‘hod_Çme
 =ğ
¥ec
.method_name)) {

283 (*
şass_®lowed
)[
i
] = 
Œue
;

287 ià(!
	gşas£s
[
i
].
	gwh™–i¡ed
) {

290 ià((
	gşas£s
[
i
].
	g»ad
 && !(
	g®low
 & 
	gOSD_CAP_CLS_R
)) ||

291 (
	gşas£s
[
i
].
	gwr™e
 && !(
	g®low
 & 
	gOSD_CAP_CLS_W
))) {

294 (*
	gşass_®lowed
)[
i
] = 
Œue
;

296 ià(!
	g¡d
::
®l_of
(
şass_®lowed
->
cbegš
(), cÏss_®lowed->
ûnd
(),

297 [](
boŞ
 
v
) {  v; })) {

298  
	gçl£
;

301  
	gŒue
;

304  
	gçl£
;

307 
	gOSDC­G¿Á
::
	$ex·nd_´ofe
()

309 ià(
´ofe
.
Çme
 == "read-only") {

311 
´ofe_g¿Ás
.
	`em¶aû_back
(
	`OSDC­M©ch
(
´ofe
.
poŞ_Çme¥aû
),

312 
	`OSDC­S³c
(
	`osd_rwxa_t
(
OSD_CAP_R
)));

315 ià(
´ofe
.
Çme
 == "read-write") {

317 
´ofe_g¿Ás
.
	`em¶aû_back
(
	`OSDC­M©ch
(
´ofe
.
poŞ_Çme¥aû
),

318 
	`OSDC­S³c
(
	`osd_rwxa_t
(
OSD_CAP_R
 | 
OSD_CAP_W
)));

321 ià(
´ofe
.
Çme
 == "rbd") {

323 
´ofe_g¿Ás
.
	`em¶aû_back
(
	`OSDC­M©ch
({}, "rbd_children"),

324 
	`OSDC­S³c
(
	`osd_rwxa_t
(
OSD_CAP_CLS_R
)));

325 
´ofe_g¿Ás
.
	`em¶aû_back
(
	`OSDC­M©ch
({}, "rbd_mirroring"),

326 
	`OSDC­S³c
(
	`osd_rwxa_t
(
OSD_CAP_CLS_R
)));

327 
´ofe_g¿Ás
.
	`em¶aû_back
(
	`OSDC­M©ch
(
´ofe
.
poŞ_Çme¥aû
),

328 
	`OSDC­S³c
(
	`osd_rwxa_t
(
OSD_CAP_R
 |

329 
OSD_CAP_W
 |

330 
OSD_CAP_X
)));

332 ià(
´ofe
.
Çme
 == "rbd-read-only") {

334 
´ofe_g¿Ás
.
	`em¶aû_back
(
	`OSDC­M©ch
(
´ofe
.
poŞ_Çme¥aû
),

335 
	`OSDC­S³c
(
	`osd_rwxa_t
(
OSD_CAP_R
 |

336 
OSD_CAP_CLS_R
)));

337 
´ofe_g¿Ás
.
	`em¶aû_back
(
	`OSDC­M©ch
(
´ofe
.
poŞ_Çme¥aû
,

339 
	`OSDC­S³c
("rbd", "child_attach"));

340 
´ofe_g¿Ás
.
	`em¶aû_back
(
	`OSDC­M©ch
(
´ofe
.
poŞ_Çme¥aû
,

342 
	`OSDC­S³c
("rbd", "child_detach"));

344 
	}
}

346 
boŞ
 
	gOSDC­
::
	$®low_®l
() const

348 autØ&
g¿Á
 : 
g¿Ás
) {

349 ià(
g¿Á
.
	`®low_®l
()) {

350  
Œue
;

353  
çl£
;

354 
	}
}

356 
	gOSDC­
::
	$£t_®low_®l
()

358 
g¿Ás
.
	`ş—r
();

359 
g¿Ás
.
	`push_back
(
	`OSDC­G¿Á
(
	`OSDC­M©ch
(), 
	`OSDC­S³c
(
OSD_CAP_ANY
)));

360 
	}
}

362 
boŞ
 
	gOSDC­
::
is_ÿ·bË
(cÚ¡ 
¡ršg
& 
poŞ_Çme
, cÚ¡ sŒšg& 
ns
,

363 
št64_t
 
poŞ_auid
,

364 cÚ¡ 
OSDC­PoŞTag
::
­p_m­_t
& 
­¶iÿtiÚ_m‘ad©a
,

365 cÚ¡ 
¡ršg
& 
objeù
,

366 
boŞ
 
İ_may_»ad
, boŞ 
İ_may_wr™e
,

367 cÚ¡ 
¡d
::
veùÜ
<
OpReque¡
::
CÏssInfo
>& 
şas£s
) const

369 
¡d
::
veùÜ
<
boŞ
> 
şass_®lowed
(
şas£s
.
size
(), 
çl£
);

370 autØ&
	gg¿Á
 : 
g¿Ás
) {

371 ià(
g¿Á
.
is_ÿ·bË
(
poŞ_Çme
, 
ns
, 
poŞ_auid
, 
­¶iÿtiÚ_m‘ad©a
,

372 
objeù
, 
İ_may_»ad
, 
İ_may_wr™e
, 
şas£s
,

373 &
şass_®lowed
)) {

374  
	gŒue
;

377  
	gçl£
;

382 
Çme¥aû
 
	gqi
 = 
boo¡
::
¥œ™
::
qi
;

383 
Çme¥aû
 
	gascii
 = 
boo¡
::
¥œ™
::
ascii
;

384 
Çme¥aû
 
	gphÛnix
 = 
boo¡
::
phÛnix
;

386 
	g‹m¶©e
 <
ty³Çme
 
	gI‹¿tÜ
>

387 
	gOSDC­P¬£r
 : 
qi
::
g¿mm¬
<
I‹¿tÜ
, 
OSDC­
()>

389 
OSDC­P¬£r
(è: OSDC­P¬£r::
ba£_ty³
(
osdÿp
)

391 
usšg
 
qi
::
ch¬_
;

392 
usšg
 
	gqi
::
št_
;

393 
usšg
 
	gqi
::
Ëxeme
;

394 
usšg
 
	gqi
::
®num
;

395 
usšg
 
	gqi
::
_v®
;

396 
usšg
 
	gqi
::
_1
;

397 
usšg
 
	gqi
::
_2
;

398 
usšg
 
	gqi
::
_3
;

399 
usšg
 
	gqi
::
•s
;

400 
usšg
 
	gqi
::
l™
;

402 
	gquÙed_¡ršg
 %=

403 
Ëxeme
['"' >> +(
ch¬_
 - '"') >> '"'] |

404 
Ëxeme
['\'' >> +(
ch¬_
 - '\'') >> '\''];

405 
	gequÙed_¡ršg
 %=

406 
Ëxeme
['"' >> *(
ch¬_
 - '"') >> '"'] |

407 
Ëxeme
['\'' >> *(
ch¬_
 - '\'') >> '\''];

408 
	gunquÙed_wÜd
 %ğ+
ch¬_
("a-zA-Z0-9_.-");

409 
	g¡r
 %ğ
quÙed_¡ršg
 | 
unquÙed_wÜd
;

410 
	ge¡r
 %ğ
equÙed_¡ršg
 | 
unquÙed_wÜd
;

412 
	g¥aûs
 = +
ascii
::
¥aû
;

414 
	gwdÿrd
 = (
l™
('*'è|†™("®l")è[
_v®
 = "*"];

416 
	gpoŞ_Çme
 %ğ-(
¥aûs
 >> 
l™
("poŞ"è>> (l™('='è| s·ûsè>> 
¡r
);

417 
	gn¥aû
 %ğ(
¥aûs
 >> 
l™
("namespace")

418 >> (
l™
('='è| 
¥aûs
)

419 >> 
e¡r
 >> -
ch¬_
('*'));

422 
	gauid
 %ğ(
¥aûs
 >> 
l™
("auid"è>> s·û >> 
št_
);

423 
	gobjeù_´efix
 %ğ-(
¥aûs
 >> 
l™
("objeù_´efix"è>> s·û >> 
¡r
);

424 
	gpoŞg
 %ğ(
¥aûs
 >> 
l™
("tag")

425 >> 
¥aûs
 >> 
¡r


426 >> 
¥aûs
 >> (
wdÿrd
 | 
¡r
)

427 >> -
¥aûs
 >> 
l™
('='è>> -¥aû >> (
wdÿrd
 | 
¡r
));

429 
	gm©ch
 = (

430 
poŞg
 [
_v®
 = 
phÛnix
::
cÚ¡ruù
<
OSDC­M©ch
>(
_1
)] |

431 (
n¥aû
 >> 
poŞg
è[
_v®
 = 
phÛnix
::
cÚ¡ruù
<
OSDC­M©ch
>(
_1
, 
_2
)] |

432 (
	gauid
 >> 
	gobjeù_´efix
è[
_v®
 = 
phÛnix
::
cÚ¡ruù
<
OSDC­M©ch
>(
_1
, 
_2
)] |

433 (
	gpoŞ_Çme
 >> 
	gn¥aû
 >> 
	gobjeù_´efix
è[
_v®
 = 
phÛnix
::
cÚ¡ruù
<
OSDC­M©ch
>(
_1
, 
_2
, 
_3
)] |

434 (
	gpoŞ_Çme
 >> 
	gobjeù_´efix
è[
_v®
 = 
phÛnix
::
cÚ¡ruù
<
OSDC­M©ch
>(
_1
, 
_2
)]

438 
	grwxa
 =

439 (
¥aûs
 >> 
wdÿrd
[
_v®
 = 
OSD_CAP_ANY
]) |

440 Ğ
•s
[
_v®
 = 0] >>

442 
¥aûs
 >>

443 Ğ
l™
('r')[
_v®
 |ğ
OSD_CAP_R
] ||

444 
l™
('w')[
_v®
 |ğ
OSD_CAP_W
] ||

445 
l™
('x')[
_v®
 |ğ
OSD_CAP_X
] )) ||

446 Ğ(
¥aûs
 >> 
l™
("şass-»ad")[
_v®
 |ğ
OSD_CAP_CLS_R
]) ||

447 (
¥aûs
 >> 
l™
("şass-wr™e")[
_v®
 |ğ
OSD_CAP_CLS_W
]) ));

450 
	gşass_Çme
 %ğ(
¥aûs
 >> 
l™
("şass"è>> s·û >> 
¡r
);

451 
	gm‘hod_Çme
 %ğ-(
¥aûs
 >> 
¡r
);

452 
	gÿp¥ec
 = (

453 (
rwxa
è[
_v®
 = 
phÛnix
::
cÚ¡ruù
<
OSDC­S³c
>(
_1
)] |

454 (
şass_Çme
 >> 
m‘hod_Çme
è[
_v®
 = 
phÛnix
::
cÚ¡ruù
<
OSDC­S³c
>(
_1
, 
_2
)]);

457 
	g´ofe_Çme
 %ğ(
l™
("´ofe"è>> (l™('='è| 
¥aûs
è>> 
¡r
);

458 
	g´ofe
 = (

459 (
´ofe_Çme
 >> 
poŞ_Çme
 >> 
n¥aû
è[
_v®
 = 
phÛnix
::
cÚ¡ruù
<
OSDC­Profe
>(
_1
, 
_2
, 
_3
)] |

460 (
	g´ofe_Çme
 >> 
	gpoŞ_Çme
è[
_v®
 = 
phÛnix
::
cÚ¡ruù
<
OSDC­Profe
>(
_1
, 
_2
)]);

463 
	gg¿Á
 = (*
ascii
::
bÏnk
 >>

464 ((
l™
("®low"è>> 
ÿp¥ec
 >> 
m©ch
è[
_v®
 = 
phÛnix
::
cÚ¡ruù
<
OSDC­G¿Á
>(
_2
, 
_1
)] |

465 (
l™
("®low"è>> 
	gm©ch
 >> 
	gÿp¥ec
è[
_v®
 = 
phÛnix
::
cÚ¡ruù
<
OSDC­G¿Á
>(
_1
, 
_2
)] |

466 (
	g´ofe
è[
_v®
 = 
phÛnix
::
cÚ¡ruù
<
OSDC­G¿Á
>(
_1
)]

467 è>> *
ascii
::
bÏnk
);

469 
	gg¿Ás
 %ğ(
g¿Á
 % (
l™
(';') |†it(',')));

470 
	gosdÿp
 = 
g¿Ás
 [
_v®
 = 
phÛnix
::
cÚ¡ruù
<
OSDC­
>(
_1
)];

472 
	gqi
::
ruË
<
I‹¿tÜ
> 
¥aûs
;

473 
	gqi
::
ruË
<
I‹¿tÜ
, ()> 
	grwxa
;

474 
	gqi
::
ruË
<
I‹¿tÜ
, 
¡ršg
()> 
	gquÙed_¡ršg
, 
	gequÙed_¡ršg
;

475 
	gqi
::
ruË
<
I‹¿tÜ
, 
¡ršg
()> 
	gunquÙed_wÜd
;

476 
	gqi
::
ruË
<
I‹¿tÜ
, 
¡ršg
()> 
	g¡r
, 
	ge¡r
;

477 
	gqi
::
ruË
<
I‹¿tÜ
, 
¡ršg
()> 
	gwdÿrd
;

478 
	gqi
::
ruË
<
I‹¿tÜ
, ()> 
	gauid
;

479 
	gqi
::
ruË
<
I‹¿tÜ
, 
¡ršg
()> 
	gşass_Çme
;

480 
	gqi
::
ruË
<
I‹¿tÜ
, 
¡ršg
()> 
	gm‘hod_Çme
;

481 
	gqi
::
ruË
<
I‹¿tÜ
, 
OSDC­S³c
()> 
	gÿp¥ec
;

482 
	gqi
::
ruË
<
I‹¿tÜ
, 
¡ršg
()> 
	gpoŞ_Çme
;

483 
	gqi
::
ruË
<
I‹¿tÜ
, 
¡ršg
()> 
	gn¥aû
;

484 
	gqi
::
ruË
<
I‹¿tÜ
, 
¡ršg
()> 
	gobjeù_´efix
;

485 
	gqi
::
ruË
<
I‹¿tÜ
, 
OSDC­PoŞTag
()> 
	gpoŞg
;

486 
	gqi
::
ruË
<
I‹¿tÜ
, 
OSDC­M©ch
()> 
	gm©ch
;

487 
	gqi
::
ruË
<
I‹¿tÜ
, 
¡ršg
()> 
	g´ofe_Çme
;

488 
	gqi
::
ruË
<
I‹¿tÜ
, 
OSDC­Profe
()> 
	g´ofe
;

489 
	gqi
::
ruË
<
I‹¿tÜ
, 
OSDC­G¿Á
()> 
	gg¿Á
;

490 
	gqi
::
ruË
<
I‹¿tÜ
, 
	g¡d
::
veùÜ
<
OSDC­G¿Á
>()> 
g¿Ás
;

491 
	gqi
::
ruË
<
I‹¿tÜ
, 
OSDC­
()> 
	gosdÿp
;

494 
boŞ
 
	gOSDC­
::
	$·r£
(cÚ¡ 
¡ršg
& 
¡r
, 
o¡»am
 *
”r
)

496 
OSDC­P¬£r
<
¡ršg
::
cÚ¡_™”©Ü
> 
g
;

497 
¡ršg
::
cÚ¡_™”©Ü
 
™”
 = 
¡r
.
	`begš
();

498 
¡ršg
::
cÚ¡_™”©Ü
 
’d
 = 
¡r
.
	`’d
();

500 
boŞ
 
r
 = 
qi
::
	`ph¿£_·r£
(
™”
, 
’d
, 
g
, 
ascii
::
¥aû
, *
this
);

501 ià(
r
 && 
™”
 =ğ
’d
)

502  
Œue
;

505 
g¿Ás
.
	`ş—r
();

507 ià(
”r
)

508 *
”r
 << "osdÿ°·r£ faed, stİ³d‡ˆ'" << 
¡d
::
	`¡ršg
(
™”
, 
’d
)

509 << "' oà'" << 
¡r
 << "'\n";

511  
çl£
;

512 
	}
}

	@osd/OSDCap.h

27 #iâdeà
CEPH_OSDCAP_H


28 
	#CEPH_OSDCAP_H


	)

30 
	~<o¡»am
>

31 
usšg
 
	g¡d
::
o¡»am
;

33 
	~"šşude/ty³s.h
"

34 
	~"OpReque¡.h
"

36 
	~<li¡
>

37 
	~<veùÜ
>

38 
	~<boo¡/İtiÚ®.hµ
>

39 
	~<boo¡/fusiÚ/šşude/ad­t_¡ruù.hµ
>

41 cÚ¡ 
__u8
 
	gOSD_CAP_R
 = (1 << 1);

42 cÚ¡ 
__u8
 
	gOSD_CAP_W
 = (1 << 2);

43 cÚ¡ 
__u8
 
	gOSD_CAP_CLS_R
 = (1 << 3);

44 cÚ¡ 
__u8
 
	gOSD_CAP_CLS_W
 = (1 << 4);

45 cÚ¡ 
__u8
 
	gOSD_CAP_X
 = (
OSD_CAP_CLS_R
 | 
OSD_CAP_CLS_W
);

46 cÚ¡ 
__u8
 
	gOSD_CAP_ANY
 = 0xff;

48 
	sosd_rwxa_t
 {

49 
__u8
 
	mv®
;

52 
osd_rwxa_t
(
__u8
 
v
 = 0è: 
v®
(v) {}

53 
osd_rwxa_t
& 
İ”©Ü
=(
__u8
 
v
) {

54 
v®
 = 
v
;

55  *
	mthis
;

57 
İ”©Ü
 
__u8
() const {

58  
	mv®
;

62 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gosd_rwxa_t
& 
	gp
);

64 
	sOSDC­S³c
 {

65 
osd_rwxa_t
 
	m®low
;

66 
	m¡d
::
¡ršg
 
şass_Çme
;

67 
	m¡d
::
¡ršg
 
m‘hod_Çme
;

69 
OSDC­S³c
(è: 
®low
(0) {}

70 
ex¶ic™
 
OSDC­S³c
(
osd_rwxa_t
 
v
è: 
®low
(v) {}

71 
OSDC­S³c
(
¡d
::
¡ršg
 
şass_Çme
, std::¡ršg 
m‘hod_Çme
)

72 : 
®low
(0), 
şass_Çme
(
¡d
::
move
(class_name)),

73 
m‘hod_Çme
(
¡d
::
move
(method_name)) {}

75 
boŞ
 
®low_®l
() const {

76  
®low
 =ğ
OSD_CAP_ANY
;

80 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gOSDC­S³c
& 
	gs
);

82 
	sOSDC­PoŞName¥aû
 {

83 
	m¡d
::
¡ršg
 
poŞ_Çme
;

84 
	mboo¡
::
İtiÚ®
<
¡d
::
¡ršg
> 
n¥aû
 = 
boo¡
::
nÚe
;

86 
OSDC­PoŞName¥aû
() {

88 
OSDC­PoŞName¥aû
(cÚ¡ 
¡d
::
¡ršg
& 
poŞ_Çme
,

89 cÚ¡ 
boo¡
::
İtiÚ®
<
¡d
::
¡ršg
>& 
n¥aû
 = boo¡::
nÚe
)

90 : 
poŞ_Çme
ÕoŞ_Çme), 
n¥aû
(nspace) {

93 
boŞ
 
is_m©ch
(cÚ¡ 
¡d
::
¡ršg
& 
²
, cÚ¡ std::¡ršg& 
ns
) const;

94 
boŞ
 
is_m©ch_®l
() const;

97 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gOSDC­PoŞName¥aû
& 
	g²s
);

99 
	sOSDC­PoŞTag
 {

100 
	m¡d
::
	tm­
<
	t¡d
::
	t¡ršg
, std::m­<¡d::¡ršg, std::¡ršg> > 
	t­p_m­_t
;

101 
	m¡d
::
¡ršg
 
­¶iÿtiÚ
;

102 
	m¡d
::
¡ršg
 
key
;

103 
	m¡d
::
¡ršg
 
v®ue
;

105 
OSDC­PoŞTag
 () {}

106 
OSDC­PoŞTag
(cÚ¡ 
¡d
::
¡ršg
& 
­¶iÿtiÚ
, cÚ¡ std::¡ršg& 
key
,

107 cÚ¡ 
¡d
::
¡ršg
& 
v®ue
) :

108 
­¶iÿtiÚ
×µliÿtiÚ), 
key
(key), 
v®ue
(value) {}

110 
boŞ
 
is_m©ch
(cÚ¡ 
­p_m­_t
& 
­p_m­
) const;

111 
boŞ
 
is_m©ch_®l
() const;

114 
BOOST_FUSION_ADAPT_STRUCT
(
OSDC­PoŞTag
,

115 (
¡d
::
¡ršg
, 
­¶iÿtiÚ
)

116 (
¡d
::
¡ršg
, 
key
)

117 (
¡d
::
¡ršg
, 
v®ue
))

119 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gOSDC­PoŞTag
& 
	g±
);

121 
	sOSDC­M©ch
 {

122 
	m¡d
::
	tm­
<
	t¡d
::
	t¡ršg
, std::m­<¡d::¡ršg, std::¡ršg> > 
	t­p_m­_t
;

124 
št64_t
 
	mauid
 = 
CEPH_AUTH_UID_DEFAULT
;

125 
OSDC­PoŞName¥aû
 
	mpoŞ_Çme¥aû
;

126 
OSDC­PoŞTag
 
	mpoŞ_g
;

127 
	m¡d
::
¡ršg
 
objeù_´efix
;

129 
OSDC­M©ch
() {}

130 
ex¶ic™
 
OSDC­M©ch
(cÚ¡ 
OSDC­PoŞTag
& 
±
è: 
poŞ_g
(pt) {}

131 
ex¶ic™
 
OSDC­M©ch
(cÚ¡ 
OSDC­PoŞName¥aû
& 
²s
è: 
poŞ_Çme¥aû
(pns) {}

132 
OSDC­M©ch
(cÚ¡ 
OSDC­PoŞName¥aû
& 
²s
, cÚ¡ 
¡d
::
¡ršg
& 
´e
)

133 : 
poŞ_Çme¥aû
(
²s
), 
objeù_´efix
(
´e
) {}

134 
OSDC­M©ch
(cÚ¡ 
¡d
::
¡ršg
& 
¶
, cÚ¡ std::¡ršg& 
´e
)

135 : 
poŞ_Çme¥aû
(
¶
), 
objeù_´efix
(
´e
) {}

136 
OSDC­M©ch
(cÚ¡ 
¡d
::
¡ršg
& 
¶
, cÚ¡ std::¡ršg& 
ns
,

137 cÚ¡ 
¡d
::
¡ršg
& 
´e
)

138 : 
poŞ_Çme¥aû
(
¶
, 
ns
), 
objeù_´efix
(
´e
) {}

139 
OSDC­M©ch
(
ušt64_t
 
auid
, cÚ¡ 
¡d
::
¡ršg
& 
´e
)

140 : 
auid
×uid), 
objeù_´efix
(
´e
) {}

141 
OSDC­M©ch
(cÚ¡ 
¡d
::
¡ršg
& 
dummy
, cÚ¡ std::¡ršg& 
­p
,

142 cÚ¡ 
¡d
::
¡ršg
& 
key
, cÚ¡ std::¡ršg& 
v®
)

143 : 
poŞ_g
(
­p
, 
key
, 
v®
) {}

144 
OSDC­M©ch
(cÚ¡ 
¡d
::
¡ršg
& 
ns
, cÚ¡ 
OSDC­PoŞTag
& 
±
)

145 : 
poŞ_Çme¥aû
("", 
ns
), 
poŞ_g
(
±
) {}

156 
boŞ
 
is_m©ch
(cÚ¡ 
¡d
::
¡ršg
& 
poŞ_Çme
, cÚ¡ std::¡ršg& 
n¥aû_Çme
,

157 
št64_t
 
poŞ_auid
, cÚ¡ 
­p_m­_t
& 
­p_m­
,

158 cÚ¡ 
¡d
::
¡ršg
& 
objeù
) const;

159 
boŞ
 
is_m©ch_®l
() const;

162 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gOSDC­M©ch
& 
	gm
);

165 
	sOSDC­Profe
 {

166 
	m¡d
::
¡ršg
 
Çme
;

167 
OSDC­PoŞName¥aû
 
	mpoŞ_Çme¥aû
;

169 
OSDC­Profe
() {

171 
OSDC­Profe
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
,

172 cÚ¡ 
¡d
::
¡ršg
& 
poŞ_Çme
,

173 cÚ¡ 
boo¡
::
İtiÚ®
<
¡d
::
¡ršg
>& 
n¥aû
 = boo¡::
nÚe
)

174 : 
Çme
Òame), 
poŞ_Çme¥aû
(
poŞ_Çme
, 
n¥aû
) {

177 
šlše
 
boŞ
 
is_v®id
() const {

178  !
	mÇme
.
em±y
();

182 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gOSDC­Profe
& 
	gm
);

184 
	sOSDC­G¿Á
 {

185 
OSDC­M©ch
 
	mm©ch
;

186 
OSDC­S³c
 
	m¥ec
;

187 
OSDC­Profe
 
	m´ofe
;

191 
	m¡d
::
li¡
<
OSDC­G¿Á
> 
´ofe_g¿Ás
;

193 
OSDC­G¿Á
() {}

194 
OSDC­G¿Á
(cÚ¡ 
OSDC­M©ch
& 
m
, cÚ¡ 
OSDC­S³c
& 
s
è: 
m©ch
(m), 
¥ec
(s) {}

195 
ex¶ic™
 
OSDC­G¿Á
(cÚ¡ 
OSDC­Profe
& 
´ofe
) :…rofile(profile) {

196 
ex·nd_´ofe
();

199 
boŞ
 
®low_®l
() const;

200 
boŞ
 
is_ÿ·bË
(cÚ¡ 
¡ršg
& 
poŞ_Çme
, cÚ¡ sŒšg& 
ns
, 
št64_t
 
poŞ_auid
,

201 cÚ¡ 
OSDC­PoŞTag
::
­p_m­_t
& 
­¶iÿtiÚ_m‘ad©a
,

202 cÚ¡ 
¡ršg
& 
objeù
, 
boŞ
 
İ_may_»ad
, boŞ 
İ_may_wr™e
,

203 cÚ¡ 
¡d
::
veùÜ
<
OpReque¡
::
CÏssInfo
>& 
şas£s
,

204 
¡d
::
veùÜ
<
boŞ
>* 
şass_®lowed
) const;

206 
ex·nd_´ofe
();

209 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gOSDC­G¿Á
& 
	gg
);

212 
	sOSDC­
 {

213 
	m¡d
::
veùÜ
<
OSDC­G¿Á
> 
g¿Ás
;

215 
OSDC­
() {}

216 
ex¶ic™
 
OSDC­
(
¡d
::
veùÜ
<
OSDC­G¿Á
> 
g
è: 
g¿Ás
(¡d::
move
(g)) {}

218 
boŞ
 
®low_®l
() const;

219 
£t_®low_®l
();

220 
boŞ
 
·r£
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
, 
o¡»am
 *
”r
=
NULL
);

238 
boŞ
 
is_ÿ·bË
(cÚ¡ 
¡ršg
& 
poŞ_Çme
, cÚ¡ sŒšg& 
ns
, 
št64_t
 
poŞ_auid
,

239 cÚ¡ 
OSDC­PoŞTag
::
­p_m­_t
& 
­¶iÿtiÚ_m‘ad©a
,

240 cÚ¡ 
¡ršg
& 
objeù
, 
boŞ
 
İ_may_»ad
, boŞ 
İ_may_wr™e
,

241 cÚ¡ 
¡d
::
veùÜ
<
OpReque¡
::
CÏssInfo
>& 
şas£s
) const;

244 
šlše
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gOSDC­
& 
	gÿp
)

246  
	gout
 << "osdÿp" << 
	gÿp
.
	gg¿Ás
;

	@osd/OSDMap.cc

18 
	~<boo¡/®gÜ™hm/¡ršg.hµ
>

20 
	~"OSDM­.h
"

21 
	~<®gÜ™hm
>

22 
	~"commÚ/cÚfig.h
"

23 
	~"commÚ/”ºo.h
"

24 
	~"commÚ/FÜm©‹r.h
"

25 
	~"commÚ/TextTabË.h
"

26 
	~"šşude/ûph_ã©u»s.h
"

27 
	~"šşude/¡r_m­.h
"

29 
	~"commÚ/code_’vœÚm’t.h
"

30 
	~"mÚ/h—Éh_check.h
"

32 
	~"üush/CrushT»eDum³r.h
"

33 
	~"commÚ/Clock.h
"

34 
	~"mÚ/PGM­.h
"

36 
	#dout_subsys
 
ûph_subsys_osd


	)

38 
MEMPOOL_DEFINE_OBJECT_FACTORY
(
OSDM­
, 
osdm­
, osdmap);

39 
MEMPOOL_DEFINE_OBJECT_FACTORY
(
OSDM­
::
Inüem’l
, 
osdm­_šc
, 
osdm­
);

45 
	gosd_šfo_t
::
	$dump
(
FÜm©‹r
 *
f
) const

47 
f
->
	`dump_št
("Ï¡_ş—n_begš", 
Ï¡_ş—n_begš
);

48 
f
->
	`dump_št
("Ï¡_ş—n_’d", 
Ï¡_ş—n_’d
);

49 
f
->
	`dump_št
("up_äom", 
up_äom
);

50 
f
->
	`dump_št
("up_thru", 
up_thru
);

51 
f
->
	`dump_št
("down_©", 
down_©
);

52 
f
->
	`dump_št
("lo¡_©", 
lo¡_©
);

53 
	}
}

55 
	gosd_šfo_t
::
	$’code
(
bufã¾i¡
& 
bl
) const

57 
usšg
 
ûph
::
’code
;

58 
__u8
 
¡ruù_v
 = 1;

59 
	`’code
(
¡ruù_v
, 
bl
);

60 
	`’code
(
Ï¡_ş—n_begš
, 
bl
);

61 
	`’code
(
Ï¡_ş—n_’d
, 
bl
);

62 
	`’code
(
up_äom
, 
bl
);

63 
	`’code
(
up_thru
, 
bl
);

64 
	`’code
(
down_©
, 
bl
);

65 
	`’code
(
lo¡_©
, 
bl
);

66 
	}
}

68 
	gosd_šfo_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
)

70 
usšg
 
ûph
::
decode
;

71 
__u8
 
¡ruù_v
;

72 
	`decode
(
¡ruù_v
, 
bl
);

73 
	`decode
(
Ï¡_ş—n_begš
, 
bl
);

74 
	`decode
(
Ï¡_ş—n_’d
, 
bl
);

75 
	`decode
(
up_äom
, 
bl
);

76 
	`decode
(
up_thru
, 
bl
);

77 
	`decode
(
down_©
, 
bl
);

78 
	`decode
(
lo¡_©
, 
bl
);

79 
	}
}

81 
	gosd_šfo_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
osd_šfo_t
*>& 
o
)

83 
o
.
push_back
(
Ãw
 
osd_šfo_t
);

84 
	go
.
push_back
(
Ãw
 
osd_šfo_t
);

85 
	go
.
back
()->
	gÏ¡_ş—n_begš
 = 1;

86 
	go
.
back
()->
	gÏ¡_ş—n_’d
 = 2;

87 
	go
.
back
()->
	gup_äom
 = 30;

88 
	go
.
back
()->
	gup_thru
 = 40;

89 
	go
.
back
()->
	gdown_©
 = 5;

90 
	go
.
back
()->
	glo¡_©
 = 6;

93 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gosd_šfo_t
& 
	gšfo
)

95 
	gout
 << "up_äom " << 
	gšfo
.
	gup_äom


96 << " up_thru " << 
	gšfo
.
	gup_thru


97 << " down_© " << 
	gšfo
.
	gdown_©


98 << "†a¡_ş—n_š‹rv® [" << 
	gšfo
.
	gÏ¡_ş—n_begš
 << "," << info.
	gÏ¡_ş—n_’d
 << ")";

99 ià(
	gšfo
.
	glo¡_©
)

100 
	gout
 << "†o¡_© " << 
	gšfo
.
	glo¡_©
;

101  
	gout
;

107 
	gosd_xšfo_t
::
	$dump
(
FÜm©‹r
 *
f
) const

109 
f
->
	`dump_¡»am
("down_¡amp"è<< 
down_¡amp
;

110 
f
->
	`dump_æßt
("Ïggy_´obab™y", 
Ïggy_´obab™y
);

111 
f
->
	`dump_št
("Ïggy_š‹rv®", 
Ïggy_š‹rv®
);

112 
f
->
	`dump_št
("ã©u»s", 
ã©u»s
);

113 
f
->
	`dump_unsigÃd
("Şd_weight", 
Şd_weight
);

114 
	}
}

116 
	gosd_xšfo_t
::
	$’code
(
bufã¾i¡
& 
bl
) const

118 
	`ENCODE_START
(3, 1, 
bl
);

119 
	`’code
(
down_¡amp
, 
bl
);

120 
__u32
 
Í
 = 
Ïggy_´obab™y
 * 0xfffffffful;

121 
	`’code
(
Í
, 
bl
);

122 
	`’code
(
Ïggy_š‹rv®
, 
bl
);

123 
	`’code
(
ã©u»s
, 
bl
);

124 
	`’code
(
Şd_weight
, 
bl
);

125 
	`ENCODE_FINISH
(
bl
);

126 
	}
}

128 
	gosd_xšfo_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
)

130 
	`DECODE_START
(3, 
bl
);

131 
	`decode
(
down_¡amp
, 
bl
);

132 
__u32
 
Í
;

133 
	`decode
(
Í
, 
bl
);

134 
Ïggy_´obab™y
 = ()
Í
 / ()0xffffffff;

135 
	`decode
(
Ïggy_š‹rv®
, 
bl
);

136 ià(
¡ruù_v
 >= 2)

137 
	`decode
(
ã©u»s
, 
bl
);

139 
ã©u»s
 = 0;

140 ià(
¡ruù_v
 >= 3)

141 
	`decode
(
Şd_weight
, 
bl
);

143 
Şd_weight
 = 0;

144 
	`DECODE_FINISH
(
bl
);

145 
	}
}

147 
	gosd_xšfo_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
osd_xšfo_t
*>& 
o
)

149 
o
.
push_back
(
Ãw
 
osd_xšfo_t
);

150 
	go
.
push_back
(
Ãw
 
osd_xšfo_t
);

151 
	go
.
back
()->
	gdown_¡amp
 = 
utime_t
(2, 3);

152 
	go
.
back
()->
	gÏggy_´obab™y
 = .123;

153 
	go
.
back
()->
	gÏggy_š‹rv®
 = 123456;

154 
	go
.
back
()->
	gŞd_weight
 = 0x7fff;

157 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gosd_xšfo_t
& 
	gxi
)

159  
	gout
 << "down_¡am°" << 
	gxi
.
	gdown_¡amp


160 << "†aggy_´obab™y " << 
	gxi
.
	gÏggy_´obab™y


161 << "†aggy_š‹rv® " << 
	gxi
.
	gÏggy_š‹rv®


162 << " old_weighˆ" << 
	gxi
.
	gŞd_weight
;

168 
	gOSDM­
::
Inüem’l
::
	$g‘_Ãt_m¬ked_out
(cÚ¡ 
OSDM­
 *
´evious
) const

170 
n
 = 0;

171 autØ&
weight
 : 
Ãw_weight
) {

172 ià(
weight
.
£cÚd
 =ğ
CEPH_OSD_OUT
 && !
´evious
->
	`is_out
(weight.
fœ¡
))

173 
n
++;

174 ià(
weight
.
£cÚd
 !ğ
CEPH_OSD_OUT
 && 
´evious
->
	`is_out
(weight.
fœ¡
))

175 
n
--;

177  
n
;

178 
	}
}

180 
	gOSDM­
::
Inüem’l
::
	$g‘_Ãt_m¬ked_down
(cÚ¡ 
OSDM­
 *
´evious
) const

182 
n
 = 0;

183 autØ&
¡©e
 : 
Ãw_¡©e
) {

184 ià(
¡©e
.
£cÚd
 & 
CEPH_OSD_UP
) {

185 ià(
´evious
->
	`is_up
(
¡©e
.
fœ¡
))

186 
n
++;

188 
n
--;

191  
n
;

192 
	}
}

194 
	gOSDM­
::
Inüem’l
::
	$id’tify_osd
(
uuid_d
 
u
) const

196 autØ&
uuid
 : 
Ãw_uuid
)

197 ià(
uuid
.
£cÚd
 =ğ
u
)

198  
uuid
.
fœ¡
;

200 
	}
}

202 
	gOSDM­
::
Inüem’l
::
	$´İag©e_¢­s_to_t›rs
(
C•hCÚ‹xt
 *
cù
,

203 cÚ¡ 
OSDM­
& 
osdm­
)

205 
	`as£¹
(
•och
 =ğ
osdm­
.
	`g‘_•och
() + 1);

207 autØ&
Ãw_poŞ
 : 
Ãw_poŞs
) {

208 ià(!
Ãw_poŞ
.
£cÚd
.
t›rs
.
	`em±y
()) {

209 
pg_poŞ_t
& 
ba£
 = 
Ãw_poŞ
.
£cÚd
;

211 autØ
Ãw_»m_™
 = 
Ãw_»moved_¢­s
.
	`fšd
(
Ãw_poŞ
.
fœ¡
);

213 cÚ¡‡utØ&
t›r_poŞ
 : 
ba£
.
t›rs
) {

214 cÚ¡‡utØ&
r
 = 
Ãw_poŞs
.
	`fšd
(
t›r_poŞ
);

215 
pg_poŞ_t
 *
t›r
 = 0;

216 ià(
r
 =ğ
Ãw_poŞs
.
	`’d
()) {

217 cÚ¡ 
pg_poŞ_t
 *
Üig
 = 
osdm­
.
	`g‘_pg_poŞ
(
t›r_poŞ
);

218 ià(!
Üig
) {

219 
	`ld”r
(
cù
è<< 
__func__
 << "‚ØpoŞ " << 
t›r_poŞ
 << 
d’dl
;

220  -
EIO
;

222 
t›r
 = 
	`g‘_Ãw_poŞ
(
t›r_poŞ
, 
Üig
);

224 
t›r
 = &
r
->
£cÚd
;

226 ià(
t›r
->
t›r_of
 !ğ
Ãw_poŞ
.
fœ¡
) {

227 
	`ld”r
(
cù
è<< 
__func__
 << " " << 
r
->
fœ¡
 << "›r_oà!ğ" << 
Ãw_poŞ
.fœ¡ << 
d’dl
;

228  -
EIO
;

231 
	`ldout
(
cù
, 10è<< 
__func__
 << " from " << 
Ãw_poŞ
.
fœ¡
 << "o "

232 << 
t›r_poŞ
 << 
d’dl
;

233 
t›r
->
¢­_£q
 = 
ba£
.snap_seq;

234 
t›r
->
¢­_•och
 = 
ba£
.snap_epoch;

235 
t›r
->
¢­s
 = 
ba£
.snaps;

236 
t›r
->
»moved_¢­s
 = 
ba£
.removed_snaps;

237 
t›r
->
æags
 |ğ
ba£
.æag & (
pg_poŞ_t
::
FLAG_SELFMANAGED_SNAPS
|

238 
pg_poŞ_t
::
FLAG_POOL_SNAPS
);

240 ià(
Ãw_»m_™
 !ğ
Ãw_»moved_¢­s
.
	`’d
()) {

241 
Ãw_»moved_¢­s
[
t›r_poŞ
] = 
Ãw_»m_™
->
£cÚd
;

247 
	}
}

252 
boŞ
 
	gOSDM­
::
subŒ“_is_down
(
id
, 
£t
<> *
down_ÿche
) const

254 ià(
	gid
 >= 0)

255  
is_down
(
id
);

257 ià(
	gdown_ÿche
 &&

258 
	gdown_ÿche
->
couÁ
(
id
)) {

259  
	gŒue
;

262 
	gli¡
<> 
	gchd»n
;

263 
	güush
->
g‘_chd»n
(
id
, &
chd»n
);

264 cÚ¡‡utØ&
	gchd
 : 
chd»n
) {

265 ià(!
subŒ“_is_down
(
chd
, 
down_ÿche
)) {

266  
	gçl£
;

269 ià(
	gdown_ÿche
) {

270 
	gdown_ÿche
->
š£¹
(
id
);

272  
	gŒue
;

275 
boŞ
 
	gOSDM­
::
cÚššg_subŒ“_is_down
(
C•hCÚ‹xt
 *
cù
, 
id
, 
subŒ“_ty³
, 
£t
<> *
down_ÿche
) const

280 
	g£t
<> 
	gloÿl_down_ÿche
;

281 ià(!
	gdown_ÿche
) {

282 
	gdown_ÿche
 = &
loÿl_down_ÿche
;

285 
	gcu¼’t
 = 
id
;

286 
	gŒue
) {

287 
	gty³
;

288 ià(
	gcu¼’t
 >= 0) {

289 
ty³
 = 0;

291 
	gty³
 = 
üush
->
g‘_buck‘_ty³
(
cu¼’t
);

293 
as£¹
(
ty³
 >= 0);

295 ià(!
subŒ“_is_down
(
cu¼’t
, 
down_ÿche
)) {

296 
ldout
(
cù
, 30è<< "cÚššg_subŒ“_is_down(" << 
	gid
 << "èğçl£" << 
	gd’dl
;

297  
	gçl£
;

301 ià(
	gty³
 >ğ
subŒ“_ty³
) {

302 
ldout
(
cù
, 30è<< "cÚššg_subŒ“_is_down(" << 
id
 << "èğŒu... " << 
ty³
 << " >ğ" << 
subŒ“_ty³
 << 
d’dl
;

303  
	gŒue
;

306 
	gr
 = 
üush
->
g‘_immedŸ‹_·»Á_id
(
cu¼’t
, &current);

307 ià(
	gr
 < 0) {

308  
	gçl£
;

313 
boŞ
 
	gOSDM­
::
subŒ“_ty³_is_down
(

314 
C•hCÚ‹xt
 *
cù
,

315 
id
,

316 
subŒ“_ty³
,

317 
£t
<> *
down_š_osds
,

318 
£t
<> *
up_š_osds
,

319 
£t
<> *
subŒ“_up
,

320 
unÜd”ed_m­
<, 
£t
<> > *
subŒ“_ty³_down
) const

322 ià(
	gid
 >= 0) {

323 
boŞ
 
is_down_»t
 = 
is_down
(
id
);

324 ià(!
is_out
(
id
)) {

325 ià(
	gis_down_»t
) {

326 
	gdown_š_osds
->
š£¹
(
id
);

328 
	gup_š_osds
->
š£¹
(
id
);

331  
	gis_down_»t
;

334 ià(
	gsubŒ“_ty³_down
 &&

335 (*
	gsubŒ“_ty³_down
)[
subŒ“_ty³
].
couÁ
(
id
)) {

336  
	gŒue
;

339 
	gli¡
<> 
	gchd»n
;

340 
	güush
->
g‘_chd»n
(
id
, &
chd»n
);

341 cÚ¡‡utØ&
	gchd
 : 
chd»n
) {

342 ià(!
subŒ“_ty³_is_down
(

343 
cù
, 
chd
, 
üush
->
g‘_buck‘_ty³
(child),

344 
down_š_osds
, 
up_š_osds
, 
subŒ“_up
, 
subŒ“_ty³_down
)) {

345 
	gsubŒ“_up
->
š£¹
(
id
);

346  
	gçl£
;

349 ià(
	gsubŒ“_ty³_down
) {

350 (*
	gsubŒ“_ty³_down
)[
subŒ“_ty³
].
š£¹
(
id
);

352  
	gŒue
;

355 
	gOSDM­
::
Inüem’l
::
	$’code_ş›Á_Şd
(
bufã¾i¡
& 
bl
) const

357 
usšg
 
ûph
::
’code
;

358 
__u16
 
v
 = 5;

359 
	`’code
(
v
, 
bl
);

360 
	`’code
(
fsid
, 
bl
);

361 
	`’code
(
•och
, 
bl
);

362 
	`’code
(
modif›d
, 
bl
);

363 
št32_t
 
Ãw_t
 = 
Ãw_poŞ_max
;

364 
	`’code
(
Ãw_t
, 
bl
);

365 
	`’code
(
Ãw_æags
, 
bl
);

366 
	`’code
(
fuÎm­
, 
bl
);

367 
	`’code
(
üush
, 
bl
);

369 
	`’code
(
Ãw_max_osd
, 
bl
);

371 
__u32
 
n
 = 
Ãw_poŞs
.
	`size
();

372 
	`’code
(
n
, 
bl
);

373 cÚ¡‡utØ&
Ãw_poŞ
 : 
Ãw_poŞs
) {

374 
n
 = 
Ãw_poŞ
.
fœ¡
;

375 
	`’code
(
n
, 
bl
);

376 
	`’code
(
Ãw_poŞ
.
£cÚd
, 
bl
, 0);

379 
n
 = 
Ãw_poŞ_Çmes
.
	`size
();

380 
	`’code
(
n
, 
bl
);

382 cÚ¡‡utØ&
Ãw_poŞ_Çme
 : 
Ãw_poŞ_Çmes
) {

383 
n
 = 
Ãw_poŞ_Çme
.
fœ¡
;

384 
	`’code
(
n
, 
bl
);

385 
	`’code
(
Ãw_poŞ_Çme
.
£cÚd
, 
bl
);

388 
n
 = 
Şd_poŞs
.
	`size
();

389 
	`’code
(
n
, 
bl
);

390 autØ&
Şd_poŞ
 : 
Şd_poŞs
) {

391 
n
 = 
Şd_poŞ
;

392 
	`’code
(
n
, 
bl
);

394 
	`’code
(
Ãw_up_ş›Á
, 
bl
, 0);

397 
ušt32_t
 
n
 = 
Ãw_¡©e
.
	`size
();

398 
	`’code
(
n
, 
bl
);

399 autØ
p
 : 
Ãw_¡©e
) {

400 
	`’code
(
p
.
fœ¡
, 
bl
);

401 
	`’code
((
ušt8_t
)
p
.
£cÚd
, 
bl
);

404 
	`’code
(
Ãw_weight
, 
bl
);

406 
n
 = 
Ãw_pg_‹mp
.
	`size
();

407 
	`’code
(
n
, 
bl
);

409 cÚ¡‡utØ&
pg_‹mp
 : 
Ãw_pg_‹mp
) {

410 
Şd_pg_t
 
İg
 = 
pg_‹mp
.
fœ¡
.
	`g‘_Şd_pg
();

411 
	`’code
(
İg
, 
bl
);

412 
	`’code
(
pg_‹mp
.
£cÚd
, 
bl
);

414 
	}
}

416 
	gOSDM­
::
Inüem’l
::
	$’code_şassic
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
) const

418 
usšg
 
ûph
::
’code
;

419 ià((
ã©u»s
 & 
CEPH_FEATURE_PGID64
) == 0) {

420 
	`’code_ş›Á_Şd
(
bl
);

425 
__u16
 
v
 = 6;

426 
	`’code
(
v
, 
bl
);

427 
	`’code
(
fsid
, 
bl
);

428 
	`’code
(
•och
, 
bl
);

429 
	`’code
(
modif›d
, 
bl
);

430 
	`’code
(
Ãw_poŞ_max
, 
bl
);

431 
	`’code
(
Ãw_æags
, 
bl
);

432 
	`’code
(
fuÎm­
, 
bl
);

433 
	`’code
(
üush
, 
bl
);

435 
	`’code
(
Ãw_max_osd
, 
bl
);

436 
	`’code
(
Ãw_poŞs
, 
bl
, 
ã©u»s
);

437 
	`’code
(
Ãw_poŞ_Çmes
, 
bl
);

438 
	`’code
(
Şd_poŞs
, 
bl
);

439 
	`’code
(
Ãw_up_ş›Á
, 
bl
, 
ã©u»s
);

441 
ušt32_t
 
n
 = 
Ãw_¡©e
.
	`size
();

442 
	`’code
(
n
, 
bl
);

443 autØ
p
 : 
Ãw_¡©e
) {

444 
	`’code
(
p
.
fœ¡
, 
bl
);

445 
	`’code
((
ušt8_t
)
p
.
£cÚd
, 
bl
);

448 
	`’code
(
Ãw_weight
, 
bl
);

449 
	`’code
(
Ãw_pg_‹mp
, 
bl
);

452 
__u16
 
ev
 = 10;

453 
	`’code
(
ev
, 
bl
);

454 
	`’code
(
Ãw_hb_back_up
, 
bl
, 
ã©u»s
);

455 
	`’code
(
Ãw_up_thru
, 
bl
);

456 
	`’code
(
Ãw_Ï¡_ş—n_š‹rv®
, 
bl
);

457 
	`’code
(
Ãw_lo¡
, 
bl
);

458 
	`’code
(
Ãw_bÏckli¡
, 
bl
, 
ã©u»s
);

459 
	`’code
(
Şd_bÏckli¡
, 
bl
, 
ã©u»s
);

460 
	`’code
(
Ãw_up_şu¡”
, 
bl
, 
ã©u»s
);

461 
	`’code
(
şu¡”_¢­shÙ
, 
bl
);

462 
	`’code
(
Ãw_uuid
, 
bl
);

463 
	`’code
(
Ãw_xšfo
, 
bl
);

464 
	`’code
(
Ãw_hb_äÚt_up
, 
bl
, 
ã©u»s
);

465 
	}
}

467 
	gOSDM­
::
Inüem’l
::
	$’code
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
) const

469 
usšg
 
ûph
::
’code
;

470 ià((
ã©u»s
 & 
CEPH_FEATURE_OSDMAP_ENC
) == 0) {

471 
	`’code_şassic
(
bl
, 
ã©u»s
);

479 
	`as£¹
(
ã©u»s
 & 
CEPH_FEATURE_RESERVED
);

480 
ã©u»s
 &ğ~
CEPH_FEATURE_RESERVED
;

482 
size_t
 
¡¬t_off£t
 = 
bl
.
	`Ëngth
();

483 
size_t
 
_off£t
;

484 
bufãr
::
li¡
::
™”©Ü
 
üc_™
;

487 
	`ENCODE_START
(8, 7, 
bl
);

490 
ušt8_t
 
v
 = 6;

491 ià(!
	`HAVE_FEATURE
(
ã©u»s
, 
SERVER_LUMINOUS
)) {

492 
v
 = 3;

493 } ià(!
	`HAVE_FEATURE
(
ã©u»s
, 
SERVER_MIMIC
)) {

494 
v
 = 5;

496 
	`ENCODE_START
(
v
, 1, 
bl
);

497 
	`’code
(
fsid
, 
bl
);

498 
	`’code
(
•och
, 
bl
);

499 
	`’code
(
modif›d
, 
bl
);

500 
	`’code
(
Ãw_poŞ_max
, 
bl
);

501 
	`’code
(
Ãw_æags
, 
bl
);

502 
	`’code
(
fuÎm­
, 
bl
);

503 
	`’code
(
üush
, 
bl
);

505 
	`’code
(
Ãw_max_osd
, 
bl
);

506 
	`’code
(
Ãw_poŞs
, 
bl
, 
ã©u»s
);

507 
	`’code
(
Ãw_poŞ_Çmes
, 
bl
);

508 
	`’code
(
Şd_poŞs
, 
bl
);

509 
	`’code
(
Ãw_up_ş›Á
, 
bl
, 
ã©u»s
);

510 ià(
v
 >= 5) {

511 
	`’code
(
Ãw_¡©e
, 
bl
);

513 
ušt32_t
 
n
 = 
Ãw_¡©e
.
	`size
();

514 
	`’code
(
n
, 
bl
);

515 autØ
p
 : 
Ãw_¡©e
) {

516 
	`’code
(
p
.
fœ¡
, 
bl
);

517 
	`’code
((
ušt8_t
)
p
.
£cÚd
, 
bl
);

520 
	`’code
(
Ãw_weight
, 
bl
);

521 
	`’code
(
Ãw_pg_‹mp
, 
bl
);

522 
	`’code
(
Ãw_´im¬y_‹mp
, 
bl
);

523 
	`’code
(
Ãw_´im¬y_affš™y
, 
bl
);

524 
	`’code
(
Ãw_”asu»_code_´ofes
, 
bl
);

525 
	`’code
(
Şd_”asu»_code_´ofes
, 
bl
);

526 ià(
v
 >= 4) {

527 
	`’code
(
Ãw_pg_upm­
, 
bl
);

528 
	`’code
(
Şd_pg_upm­
, 
bl
);

529 
	`’code
(
Ãw_pg_upm­_™ems
, 
bl
);

530 
	`’code
(
Şd_pg_upm­_™ems
, 
bl
);

532 ià(
v
 >= 6) {

533 
	`’code
(
Ãw_»moved_¢­s
, 
bl
);

534 
	`’code
(
Ãw_purged_¢­s
, 
bl
);

536 
	`ENCODE_FINISH
(
bl
);

540 
ušt8_t
 
rg‘_v
 = 6;

541 ià(!
	`HAVE_FEATURE
(
ã©u»s
, 
SERVER_LUMINOUS
)) {

542 
rg‘_v
 = 2;

544 
	`ENCODE_START
(
rg‘_v
, 1, 
bl
);

545 
	`’code
(
Ãw_hb_back_up
, 
bl
, 
ã©u»s
);

546 
	`’code
(
Ãw_up_thru
, 
bl
);

547 
	`’code
(
Ãw_Ï¡_ş—n_š‹rv®
, 
bl
);

548 
	`’code
(
Ãw_lo¡
, 
bl
);

549 
	`’code
(
Ãw_bÏckli¡
, 
bl
, 
ã©u»s
);

550 
	`’code
(
Şd_bÏckli¡
, 
bl
, 
ã©u»s
);

551 
	`’code
(
Ãw_up_şu¡”
, 
bl
, 
ã©u»s
);

552 
	`’code
(
şu¡”_¢­shÙ
, 
bl
);

553 
	`’code
(
Ãw_uuid
, 
bl
);

554 
	`’code
(
Ãw_xšfo
, 
bl
);

555 
	`’code
(
Ãw_hb_äÚt_up
, 
bl
, 
ã©u»s
);

556 
	`’code
(
ã©u»s
, 
bl
);

557 ià(
rg‘_v
 >= 3) {

558 
	`’code
(
Ãw_Ã¬fuÎ_¿tio
, 
bl
);

559 
	`’code
(
Ãw_fuÎ_¿tio
, 
bl
);

560 
	`’code
(
Ãw_backflfuÎ_¿tio
, 
bl
);

563 ià(
rg‘_v
 >= 6) {

564 
	`’code
(
Ãw_»quœe_mš_com·t_ş›Á
, 
bl
);

565 
	`’code
(
Ãw_»quœe_osd_»Ëa£
, 
bl
);

567 
	`ENCODE_FINISH
(
bl
);

570 
	`’code
((
ušt32_t
)0, 
bl
);

571 
üc_™
 = 
bl
.
	`’d
();

572 
üc_™
.
	`advªû
(-4);

573 
_off£t
 = 
bl
.
	`Ëngth
();

575 
	`’code
(
fuÎ_üc
, 
bl
);

577 
	`ENCODE_FINISH
(
bl
);

580 
bufã¾i¡
 
äÚt
;

581 
äÚt
.
	`sub¡r_of
(
bl
, 
¡¬t_off£t
, 
üc_™
.
	`g‘_off
() - start_offset);

582 
šc_üc
 = 
äÚt
.
	`üc32c
(-1);

583 
bufã¾i¡
 

;

584 

.
	`sub¡r_of
(
bl
, 
_off£t
, bl.
	`Ëngth
() -ail_offset);

585 
šc_üc
 = 

.
	`üc32c
(inc_crc);

586 
ûph_Ë32
 
üc_Ë
;

587 
üc_Ë
 = 
šc_üc
;

588 
üc_™
.
	`cİy_š
(4, (*)&
üc_Ë
);

589 
have_üc
 = 
Œue
;

590 
	}
}

592 
	gOSDM­
::
Inüem’l
::
	$decode_şassic
(
bufã¾i¡
::
™”©Ü
 &
p
)

594 
usšg
 
ûph
::
decode
;

595 
__u32
 
n
, 
t
;

597 
__u16
 
v
;

598 
	`decode
(
v
, 
p
);

599 
	`decode
(
fsid
, 
p
);

600 
	`decode
(
•och
, 
p
);

601 
	`decode
(
modif›d
, 
p
);

602 ià(
v
 == 4 || v == 5) {

603 
	`decode
(
n
, 
p
);

604 
Ãw_poŞ_max
 = 
n
;

605 } ià(
v
 >= 6)

606 
	`decode
(
Ãw_poŞ_max
, 
p
);

607 
	`decode
(
Ãw_æags
, 
p
);

608 
	`decode
(
fuÎm­
, 
p
);

609 
	`decode
(
üush
, 
p
);

611 
	`decode
(
Ãw_max_osd
, 
p
);

612 ià(
v
 < 6) {

613 
Ãw_poŞs
.
	`ş—r
();

614 
	`decode
(
n
, 
p
);

615 
n
--) {

616 
	`decode
(
t
, 
p
);

617 
	`decode
(
Ãw_poŞs
[
t
], 
p
);

620 
	`decode
(
Ãw_poŞs
, 
p
);

622 ià(
v
 == 5) {

623 
Ãw_poŞ_Çmes
.
	`ş—r
();

624 
	`decode
(
n
, 
p
);

625 
n
--) {

626 
	`decode
(
t
, 
p
);

627 
	`decode
(
Ãw_poŞ_Çmes
[
t
], 
p
);

629 } ià(
v
 >= 6) {

630 
	`decode
(
Ãw_poŞ_Çmes
, 
p
);

632 ià(
v
 < 6) {

633 
Şd_poŞs
.
	`ş—r
();

634 
	`decode
(
n
, 
p
);

635 
n
--) {

636 
	`decode
(
t
, 
p
);

637 
Şd_poŞs
.
	`š£¹
(
t
);

640 
	`decode
(
Şd_poŞs
, 
p
);

642 
	`decode
(
Ãw_up_ş›Á
, 
p
);

644 
m­
<
št32_t
,
ušt8_t
> 
ns
;

645 
	`decode
(
ns
, 
p
);

646 autØ
q
 : 
ns
) {

647 
Ãw_¡©e
[
q
.
fœ¡
] = q.
£cÚd
;

650 
	`decode
(
Ãw_weight
, 
p
);

652 ià(
v
 < 6) {

653 
Ãw_pg_‹mp
.
	`ş—r
();

654 
	`decode
(
n
, 
p
);

655 
n
--) {

656 
Şd_pg_t
 
İg
;

657 ::
	`decode_¿w
(
İg
, 
p
);

658 
	`decode
(
Ãw_pg_‹mp
[
	`pg_t
(
İg
)], 
p
);

661 
	`decode
(
Ãw_pg_‹mp
, 
p
);

665 ià(
v
 =ğ5 && 
p
.
	`’d
())

669 
__u16
 
ev
 = 0;

670 ià(
v
 >= 5)

671 
	`decode
(
ev
, 
p
);

672 
	`decode
(
Ãw_hb_back_up
, 
p
);

673 ià(
v
 < 5)

674 
	`decode
(
Ãw_poŞ_Çmes
, 
p
);

675 
	`decode
(
Ãw_up_thru
, 
p
);

676 
	`decode
(
Ãw_Ï¡_ş—n_š‹rv®
, 
p
);

677 
	`decode
(
Ãw_lo¡
, 
p
);

678 
	`decode
(
Ãw_bÏckli¡
, 
p
);

679 
	`decode
(
Şd_bÏckli¡
, 
p
);

680 ià(
ev
 >= 6)

681 
	`decode
(
Ãw_up_şu¡”
, 
p
);

682 ià(
ev
 >= 7)

683 
	`decode
(
şu¡”_¢­shÙ
, 
p
);

684 ià(
ev
 >= 8)

685 
	`decode
(
Ãw_uuid
, 
p
);

686 ià(
ev
 >= 9)

687 
	`decode
(
Ãw_xšfo
, 
p
);

688 ià(
ev
 >= 10)

689 
	`decode
(
Ãw_hb_äÚt_up
, 
p
);

690 
	}
}

692 
	gOSDM­
::
Inüem’l
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
)

694 
usšg
 
ûph
::
decode
;

702 
size_t
 
¡¬t_off£t
 = 
bl
.
	`g‘_off
();

703 
size_t
 
_off£t
 = 0;

704 
bufã¾i¡
 
üc_äÚt
, 
üc_
;

706 
	`DECODE_START_LEGACY_COMPAT_LEN
(8, 7, 7, 
bl
);

707 ià(
¡ruù_v
 < 7) {

708 
¡ruù_v_size
 = (
¡ruù_v
);

709 
bl
.
	`advªû
(-
¡ruù_v_size
);

710 
	`decode_şassic
(
bl
);

711 
’code_ã©u»s
 = 0;

712 ià(
¡ruù_v
 >= 6)

713 
’code_ã©u»s
 = 
CEPH_FEATURE_PGID64
;

715 
’code_ã©u»s
 = 0;

719 
	`DECODE_START
(6, 
bl
);

720 
	`decode
(
fsid
, 
bl
);

721 
	`decode
(
•och
, 
bl
);

722 
	`decode
(
modif›d
, 
bl
);

723 
	`decode
(
Ãw_poŞ_max
, 
bl
);

724 
	`decode
(
Ãw_æags
, 
bl
);

725 
	`decode
(
fuÎm­
, 
bl
);

726 
	`decode
(
üush
, 
bl
);

728 
	`decode
(
Ãw_max_osd
, 
bl
);

729 
	`decode
(
Ãw_poŞs
, 
bl
);

730 
	`decode
(
Ãw_poŞ_Çmes
, 
bl
);

731 
	`decode
(
Şd_poŞs
, 
bl
);

732 
	`decode
(
Ãw_up_ş›Á
, 
bl
);

733 ià(
¡ruù_v
 >= 5) {

734 
	`decode
(
Ãw_¡©e
, 
bl
);

736 
m­
<
št32_t
,
ušt8_t
> 
ns
;

737 
	`decode
(
ns
, 
bl
);

738 autØ
q
 : 
ns
) {

739 
Ãw_¡©e
[
q
.
fœ¡
] = q.
£cÚd
;

742 
	`decode
(
Ãw_weight
, 
bl
);

743 
	`decode
(
Ãw_pg_‹mp
, 
bl
);

744 
	`decode
(
Ãw_´im¬y_‹mp
, 
bl
);

745 ià(
¡ruù_v
 >= 2)

746 
	`decode
(
Ãw_´im¬y_affš™y
, 
bl
);

748 
Ãw_´im¬y_affš™y
.
	`ş—r
();

749 ià(
¡ruù_v
 >= 3) {

750 
	`decode
(
Ãw_”asu»_code_´ofes
, 
bl
);

751 
	`decode
(
Şd_”asu»_code_´ofes
, 
bl
);

753 
Ãw_”asu»_code_´ofes
.
	`ş—r
();

754 
Şd_”asu»_code_´ofes
.
	`ş—r
();

756 ià(
¡ruù_v
 >= 4) {

757 
	`decode
(
Ãw_pg_upm­
, 
bl
);

758 
	`decode
(
Şd_pg_upm­
, 
bl
);

759 
	`decode
(
Ãw_pg_upm­_™ems
, 
bl
);

760 
	`decode
(
Şd_pg_upm­_™ems
, 
bl
);

762 ià(
¡ruù_v
 >= 6) {

763 
	`decode
(
Ãw_»moved_¢­s
, 
bl
);

764 
	`decode
(
Ãw_purged_¢­s
, 
bl
);

766 
	`DECODE_FINISH
(
bl
);

770 
	`DECODE_START
(6, 
bl
);

771 
	`decode
(
Ãw_hb_back_up
, 
bl
);

772 
	`decode
(
Ãw_up_thru
, 
bl
);

773 
	`decode
(
Ãw_Ï¡_ş—n_š‹rv®
, 
bl
);

774 
	`decode
(
Ãw_lo¡
, 
bl
);

775 
	`decode
(
Ãw_bÏckli¡
, 
bl
);

776 
	`decode
(
Şd_bÏckli¡
, 
bl
);

777 
	`decode
(
Ãw_up_şu¡”
, 
bl
);

778 
	`decode
(
şu¡”_¢­shÙ
, 
bl
);

779 
	`decode
(
Ãw_uuid
, 
bl
);

780 
	`decode
(
Ãw_xšfo
, 
bl
);

781 
	`decode
(
Ãw_hb_äÚt_up
, 
bl
);

782 ià(
¡ruù_v
 >= 2)

783 
	`decode
(
’code_ã©u»s
, 
bl
);

785 
’code_ã©u»s
 = 
CEPH_FEATURE_PGID64
 | 
CEPH_FEATURE_OSDMAP_ENC
;

786 ià(
¡ruù_v
 >= 3) {

787 
	`decode
(
Ãw_Ã¬fuÎ_¿tio
, 
bl
);

788 
	`decode
(
Ãw_fuÎ_¿tio
, 
bl
);

790 
Ãw_Ã¬fuÎ_¿tio
 = -1;

791 
Ãw_fuÎ_¿tio
 = -1;

793 ià(
¡ruù_v
 >= 4) {

794 
	`decode
(
Ãw_backflfuÎ_¿tio
, 
bl
);

796 
Ãw_backflfuÎ_¿tio
 = -1;

798 ià(
¡ruù_v
 == 5) {

799 
¡ršg
 
r
;

800 
	`decode
(
r
, 
bl
);

801 ià(
r
.
	`Ëngth
()) {

802 
Ãw_»quœe_mš_com·t_ş›Á
 = 
	`ûph_»Ëa£_äom_Çme
(
r
.
	`c_¡r
());

805 ià(
¡ruù_v
 >= 6) {

806 
	`decode
(
Ãw_»quœe_mš_com·t_ş›Á
, 
bl
);

807 
	`decode
(
Ãw_»quœe_osd_»Ëa£
, 
bl
);

809 ià(
Ãw_æags
 >ğ0 && (Ãw_æag & 
CEPH_OSDMAP_REQUIRE_LUMINOUS
)) {

811 
Ãw_»quœe_osd_»Ëa£
 = 
CEPH_RELEASE_LUMINOUS
;

812 
Ãw_æags
 &ğ~(
CEPH_OSDMAP_LEGACY_REQUIRE_FLAGS
);

813 } ià(
Ãw_æags
 >ğ0 && (Ãw_æag & 
CEPH_OSDMAP_REQUIRE_KRAKEN
)) {

814 
Ãw_»quœe_osd_»Ëa£
 = 
CEPH_RELEASE_KRAKEN
;

815 } ià(
Ãw_æags
 >ğ0 && (Ãw_æag & 
CEPH_OSDMAP_REQUIRE_JEWEL
)) {

816 
Ãw_»quœe_osd_»Ëa£
 = 
CEPH_RELEASE_JEWEL
;

818 
Ãw_»quœe_osd_»Ëa£
 = -1;

821 
	`DECODE_FINISH
(
bl
);

824 ià(
¡ruù_v
 >= 8) {

825 
have_üc
 = 
Œue
;

826 
üc_äÚt
.
	`sub¡r_of
(
bl
.
	`g‘_bl
(), 
¡¬t_off£t
, bl.
	`g‘_off
() - start_offset);

827 
	`decode
(
šc_üc
, 
bl
);

828 
_off£t
 = 
bl
.
	`g‘_off
();

829 
	`decode
(
fuÎ_üc
, 
bl
);

831 
have_üc
 = 
çl£
;

832 
fuÎ_üc
 = 0;

833 
šc_üc
 = 0;

836 
	`DECODE_FINISH
(
bl
);

838 ià(
have_üc
) {

840 
ušt32_t
 
aùu®
 = 
üc_äÚt
.
	`üc32c
(-1);

841 ià(
_off£t
 < 
bl
.
	`g‘_off
()) {

842 
bufã¾i¡
 

;

843 

.
	`sub¡r_of
(
bl
.
	`g‘_bl
(), 
_off£t
, bl.
	`g‘_off
() -ail_offset);

844 
aùu®
 = 

.
	`üc32c
(actual);

846 ià(
šc_üc
 !ğ
aùu®
) {

847 
o¡ršg¡»am
 
ss
;

848 
ss
 << "bad crc,‡ùu® " << 
aùu®
 << " !ğex³ùed " << 
šc_üc
;

849 
¡ršg
 
s
 = 
ss
.
	`¡r
();

850 
throw
 
bufãr
::
	`m®fÜmed_šput
(
s
.
	`c_¡r
());

853 
	}
}

855 
	gOSDM­
::
Inüem’l
::
	$dump
(
FÜm©‹r
 *
f
) const

857 
f
->
	`dump_št
("•och", 
•och
);

858 
f
->
	`dump_¡»am
("fsid"è<< 
fsid
;

859 
f
->
	`dump_¡»am
("modif›d"è<< 
modif›d
;

860 
f
->
	`dump_št
("Ãw_poŞ_max", 
Ãw_poŞ_max
);

861 
f
->
	`dump_št
("Ãw_æags", 
Ãw_æags
);

862 
f
->
	`dump_æßt
("Ãw_fuÎ_¿tio", 
Ãw_fuÎ_¿tio
);

863 
f
->
	`dump_æßt
("Ãw_Ã¬fuÎ_¿tio", 
Ãw_Ã¬fuÎ_¿tio
);

864 
f
->
	`dump_æßt
("Ãw_backflfuÎ_¿tio", 
Ãw_backflfuÎ_¿tio
);

865 
f
->
	`dump_št
("Ãw_»quœe_mš_com·t_ş›Á", 
Ãw_»quœe_mš_com·t_ş›Á
);

866 
f
->
	`dump_št
("Ãw_»quœe_osd_»Ëa£", 
Ãw_»quœe_osd_»Ëa£
);

868 ià(
fuÎm­
.
	`Ëngth
()) {

869 
f
->
	`İ’_objeù_£ùiÚ
("full_map");

870 
OSDM­
 
fuÎ
;

871 
bufã¾i¡
 
fbl
 = 
fuÎm­
;

872 autØ
p
 = 
fbl
.
	`begš
();

873 
fuÎ
.
	`decode
(
p
);

874 
fuÎ
.
	`dump
(
f
);

875 
f
->
	`şo£_£ùiÚ
();

877 ià(
üush
.
	`Ëngth
()) {

878 
f
->
	`İ’_objeù_£ùiÚ
("crush");

879 
CrushW¿µ”
 
c
;

880 
bufã¾i¡
 
tbl
 = 
üush
;

881 autØ
p
 = 
tbl
.
	`begš
();

882 
c
.
	`decode
(
p
);

883 
c
.
	`dump
(
f
);

884 
f
->
	`şo£_£ùiÚ
();

887 
f
->
	`dump_št
("Ãw_max_osd", 
Ãw_max_osd
);

889 
f
->
	`İ’_¬¿y_£ùiÚ
("new_pools");

891 cÚ¡‡utØ&
Ãw_poŞ
 : 
Ãw_poŞs
) {

892 
f
->
	`İ’_objeù_£ùiÚ
("pool");

893 
f
->
	`dump_št
("poŞ", 
Ãw_poŞ
.
fœ¡
);

894 
Ãw_poŞ
.
£cÚd
.
	`dump
(
f
);

895 
f
->
	`şo£_£ùiÚ
();

897 
f
->
	`şo£_£ùiÚ
();

898 
f
->
	`İ’_¬¿y_£ùiÚ
("new_pool_names");

900 cÚ¡‡utØ&
Ãw_poŞ_Çme
 : 
Ãw_poŞ_Çmes
) {

901 
f
->
	`İ’_objeù_£ùiÚ
("pool_name");

902 
f
->
	`dump_št
("poŞ", 
Ãw_poŞ_Çme
.
fœ¡
);

903 
f
->
	`dump_¡ršg
("Çme", 
Ãw_poŞ_Çme
.
£cÚd
);

904 
f
->
	`şo£_£ùiÚ
();

906 
f
->
	`şo£_£ùiÚ
();

907 
f
->
	`İ’_¬¿y_£ùiÚ
("old_pools");

909 cÚ¡‡utØ&
Şd_poŞ
 : 
Şd_poŞs
)

910 
f
->
	`dump_št
("poŞ", 
Şd_poŞ
);

911 
f
->
	`şo£_£ùiÚ
();

913 
f
->
	`İ’_¬¿y_£ùiÚ
("new_up_osds");

915 cÚ¡‡utØ&
upş›Á
 : 
Ãw_up_ş›Á
) {

916 
f
->
	`İ’_objeù_£ùiÚ
("osd");

917 
f
->
	`dump_št
("osd", 
upş›Á
.
fœ¡
);

918 
f
->
	`dump_¡»am
("public_addr"è<< 
upş›Á
.
£cÚd
;

919 
f
->
	`dump_¡»am
("şu¡”_addr"è<< 
Ãw_up_şu¡”
.
	`fšd
(
upş›Á
.
fœ¡
)->
£cÚd
;

920 
f
->
	`dump_¡»am
("h—¹b—t_back_addr"è<< 
Ãw_hb_back_up
.
	`fšd
(
upş›Á
.
fœ¡
)->
£cÚd
;

921 
m­
<
št32_t
, 
’t™y_addr_t
>::
cÚ¡_™”©Ü
 
q
;

922 ià((
q
 = 
Ãw_hb_äÚt_up
.
	`fšd
(
upş›Á
.
fœ¡
)è!ğÃw_hb_äÚt_up.
	`’d
())

923 
f
->
	`dump_¡»am
("h—¹b—t_äÚt_addr"è<< 
q
->
£cÚd
;

924 
f
->
	`şo£_£ùiÚ
();

926 
f
->
	`şo£_£ùiÚ
();

928 
f
->
	`İ’_¬¿y_£ùiÚ
("new_weight");

930 cÚ¡‡utØ&
weight
 : 
Ãw_weight
) {

931 
f
->
	`İ’_objeù_£ùiÚ
("osd");

932 
f
->
	`dump_št
("osd", 
weight
.
fœ¡
);

933 
f
->
	`dump_št
("weight", 
weight
.
£cÚd
);

934 
f
->
	`şo£_£ùiÚ
();

936 
f
->
	`şo£_£ùiÚ
();

938 
f
->
	`İ’_¬¿y_£ùiÚ
("osd_state_xor");

939 cÚ¡‡utØ&
ns
 : 
Ãw_¡©e
) {

940 
f
->
	`İ’_objeù_£ùiÚ
("osd");

941 
f
->
	`dump_št
("osd", 
ns
.
fœ¡
);

942 
£t
<
¡ršg
> 
¡
;

943 
	`ÿlc_¡©e_£t
(
Ãw_¡©e
.
	`fšd
(
ns
.
fœ¡
)->
£cÚd
, 
¡
);

944 
f
->
	`İ’_¬¿y_£ùiÚ
("state_xor");

945 autØ&
¡©e
 : 
¡
)

946 
f
->
	`dump_¡ršg
("¡©e", 
¡©e
);

947 
f
->
	`şo£_£ùiÚ
();

948 
f
->
	`şo£_£ùiÚ
();

950 
f
->
	`şo£_£ùiÚ
();

952 
f
->
	`İ’_¬¿y_£ùiÚ
("new_pg_temp");

954 cÚ¡‡utØ&
pg_‹mp
 : 
Ãw_pg_‹mp
) {

955 
f
->
	`İ’_objeù_£ùiÚ
("pg");

956 
f
->
	`dump_¡»am
("pgid"è<< 
pg_‹mp
.
fœ¡
;

957 
f
->
	`İ’_¬¿y_£ùiÚ
("osds");

959 cÚ¡‡utØ&
osd
 : 
pg_‹mp
.
£cÚd
)

960 
f
->
	`dump_št
("osd", 
osd
);

961 
f
->
	`şo£_£ùiÚ
();

962 
f
->
	`şo£_£ùiÚ
();

964 
f
->
	`şo£_£ùiÚ
();

966 
f
->
	`İ’_¬¿y_£ùiÚ
("primary_temp");

968 cÚ¡‡utØ&
´im¬y_‹mp
 : 
Ãw_´im¬y_‹mp
) {

969 
f
->
	`dump_¡»am
("pgid"è<< 
´im¬y_‹mp
.
fœ¡
;

970 
f
->
	`dump_št
("osd", 
´im¬y_‹mp
.
£cÚd
);

972 
f
->
	`şo£_£ùiÚ
();

974 
f
->
	`İ’_¬¿y_£ùiÚ
("new_pg_upmap");

975 auto& 
i
 : 
Ãw_pg_upm­
) {

976 
f
->
	`İ’_objeù_£ùiÚ
("mapping");

977 
f
->
	`dump_¡»am
("pgid"è<< 
i
.
fœ¡
;

978 
f
->
	`İ’_¬¿y_£ùiÚ
("osds");

979 autØ
osd
 : 
i
.
£cÚd
) {

980 
f
->
	`dump_št
("osd", 
osd
);

982 
f
->
	`şo£_£ùiÚ
();

983 
f
->
	`şo£_£ùiÚ
();

985 
f
->
	`şo£_£ùiÚ
();

986 
f
->
	`İ’_¬¿y_£ùiÚ
("old_pg_upmap");

987 auto& 
i
 : 
Şd_pg_upm­
) {

988 
f
->
	`dump_¡»am
("pgid"è<< 
i
;

990 
f
->
	`şo£_£ùiÚ
();

992 
f
->
	`İ’_¬¿y_£ùiÚ
("new_pg_upmap_items");

993 auto& 
i
 : 
Ãw_pg_upm­_™ems
) {

994 
f
->
	`İ’_objeù_£ùiÚ
("mapping");

995 
f
->
	`dump_¡»am
("pgid"è<< 
i
.
fœ¡
;

996 
f
->
	`İ’_¬¿y_£ùiÚ
("mappings");

997 auto& 
p
 : 
i
.
£cÚd
) {

998 
f
->
	`İ’_objeù_£ùiÚ
("mapping");

999 
f
->
	`dump_št
("äom", 
p
.
fœ¡
);

1000 
f
->
	`dump_št
("to", 
p
.
£cÚd
);

1001 
f
->
	`şo£_£ùiÚ
();

1003 
f
->
	`şo£_£ùiÚ
();

1004 
f
->
	`şo£_£ùiÚ
();

1006 
f
->
	`şo£_£ùiÚ
();

1007 
f
->
	`İ’_¬¿y_£ùiÚ
("old_pg_upmap_items");

1008 auto& 
i
 : 
Şd_pg_upm­_™ems
) {

1009 
f
->
	`dump_¡»am
("pgid"è<< 
i
;

1011 
f
->
	`şo£_£ùiÚ
();

1013 
f
->
	`İ’_¬¿y_£ùiÚ
("new_up_thru");

1015 cÚ¡‡utØ&
up_thru
 : 
Ãw_up_thru
) {

1016 
f
->
	`İ’_objeù_£ùiÚ
("osd");

1017 
f
->
	`dump_št
("osd", 
up_thru
.
fœ¡
);

1018 
f
->
	`dump_št
("up_thru", 
up_thru
.
£cÚd
);

1019 
f
->
	`şo£_£ùiÚ
();

1021 
f
->
	`şo£_£ùiÚ
();

1023 
f
->
	`İ’_¬¿y_£ùiÚ
("new_lost");

1025 cÚ¡‡utØ&
lo¡
 : 
Ãw_lo¡
) {

1026 
f
->
	`İ’_objeù_£ùiÚ
("osd");

1027 
f
->
	`dump_št
("osd", 
lo¡
.
fœ¡
);

1028 
f
->
	`dump_št
("•och_lo¡", 
lo¡
.
£cÚd
);

1029 
f
->
	`şo£_£ùiÚ
();

1031 
f
->
	`şo£_£ùiÚ
();

1033 
f
->
	`İ’_¬¿y_£ùiÚ
("new_last_clean_interval");

1035 cÚ¡‡utØ&
Ï¡_ş—n_š‹rv®
 : 
Ãw_Ï¡_ş—n_š‹rv®
) {

1036 
f
->
	`İ’_objeù_£ùiÚ
("osd");

1037 
f
->
	`dump_št
("osd", 
Ï¡_ş—n_š‹rv®
.
fœ¡
);

1038 
f
->
	`dump_št
("fœ¡", 
Ï¡_ş—n_š‹rv®
.
£cÚd
.
fœ¡
);

1039 
f
->
	`dump_št
("Ï¡", 
Ï¡_ş—n_š‹rv®
.
£cÚd
.second);

1040 
f
->
	`şo£_£ùiÚ
();

1042 
f
->
	`şo£_£ùiÚ
();

1044 
f
->
	`İ’_¬¿y_£ùiÚ
("new_blacklist");

1045 cÚ¡‡utØ&
bli¡
 : 
Ãw_bÏckli¡
) {

1046 
¡ršg¡»am
 
ss
;

1047 
ss
 << 
bli¡
.
fœ¡
;

1048 
f
->
	`dump_¡»am
(
ss
.
	`¡r
().
	`c_¡r
()è<< 
bli¡
.
£cÚd
;

1050 
f
->
	`şo£_£ùiÚ
();

1051 
f
->
	`İ’_¬¿y_£ùiÚ
("old_blacklist");

1052 cÚ¡‡utØ&
bli¡
 : 
Şd_bÏckli¡
)

1053 
f
->
	`dump_¡»am
("addr"è<< 
bli¡
;

1054 
f
->
	`şo£_£ùiÚ
();

1056 
f
->
	`İ’_¬¿y_£ùiÚ
("new_xinfo");

1057 cÚ¡‡utØ&
xšfo
 : 
Ãw_xšfo
) {

1058 
f
->
	`İ’_objeù_£ùiÚ
("xinfo");

1059 
f
->
	`dump_št
("osd", 
xšfo
.
fœ¡
);

1060 
xšfo
.
£cÚd
.
	`dump
(
f
);

1061 
f
->
	`şo£_£ùiÚ
();

1063 
f
->
	`şo£_£ùiÚ
();

1065 ià(
şu¡”_¢­shÙ
.
	`size
())

1066 
f
->
	`dump_¡ršg
("şu¡”_¢­shÙ", 
şu¡”_¢­shÙ
);

1068 
f
->
	`İ’_¬¿y_£ùiÚ
("new_uuid");

1069 cÚ¡‡utØ&
uuid
 : 
Ãw_uuid
) {

1070 
f
->
	`İ’_objeù_£ùiÚ
("osd");

1071 
f
->
	`dump_št
("osd", 
uuid
.
fœ¡
);

1072 
f
->
	`dump_¡»am
("uuid"è<< 
uuid
.
£cÚd
;

1073 
f
->
	`şo£_£ùiÚ
();

1075 
f
->
	`şo£_£ùiÚ
();

1077 
OSDM­
::
	`dump_”asu»_code_´ofes
(
Ãw_”asu»_code_´ofes
, 
f
);

1078 
f
->
	`İ’_¬¿y_£ùiÚ
("old_erasure_code_profiles");

1079 cÚ¡‡utØ&
”asu»_code_´ofe
 : 
Şd_”asu»_code_´ofes
) {

1080 
f
->
	`dump_¡ršg
("Şd", 
”asu»_code_´ofe
.
	`c_¡r
());

1082 
f
->
	`şo£_£ùiÚ
();

1084 
f
->
	`İ’_¬¿y_£ùiÚ
("new_removed_snaps");

1085 auto& 
p
 : 
Ãw_»moved_¢­s
) {

1086 
f
->
	`İ’_objeù_£ùiÚ
("pool");

1087 
f
->
	`dump_št
("poŞ", 
p
.
fœ¡
);

1088 
f
->
	`İ’_¬¿y_£ùiÚ
("snaps");

1089 autØ
q
 = 
p
.
£cÚd
.
	`begš
(); q !ğp.£cÚd.
	`’d
(); ++q) {

1090 
f
->
	`İ’_objeù_£ùiÚ
("interval");

1091 
f
->
	`dump_unsigÃd
("begš", 
q
.
	`g‘_¡¬t
());

1092 
f
->
	`dump_unsigÃd
("Ëngth", 
q
.
	`g‘_Ën
());

1093 
f
->
	`şo£_£ùiÚ
();

1095 
f
->
	`şo£_£ùiÚ
();

1096 
f
->
	`şo£_£ùiÚ
();

1098 
f
->
	`şo£_£ùiÚ
();

1099 
f
->
	`İ’_¬¿y_£ùiÚ
("new_purged_snaps");

1100 auto& 
p
 : 
Ãw_purged_¢­s
) {

1101 
f
->
	`İ’_objeù_£ùiÚ
("pool");

1102 
f
->
	`dump_št
("poŞ", 
p
.
fœ¡
);

1103 
f
->
	`İ’_¬¿y_£ùiÚ
("snaps");

1104 autØ
q
 = 
p
.
£cÚd
.
	`begš
(); q !ğp.£cÚd.
	`’d
(); ++q) {

1105 
f
->
	`İ’_objeù_£ùiÚ
("interval");

1106 
f
->
	`dump_unsigÃd
("begš", 
q
.
	`g‘_¡¬t
());

1107 
f
->
	`dump_unsigÃd
("Ëngth", 
q
.
	`g‘_Ën
());

1108 
f
->
	`şo£_£ùiÚ
();

1110 
f
->
	`şo£_£ùiÚ
();

1111 
f
->
	`şo£_£ùiÚ
();

1113 
f
->
	`şo£_£ùiÚ
();

1114 
	}
}

1116 
	gOSDM­
::
Inüem’l
::
g’”©e_‹¡_š¡ªûs
(
li¡
<Inüem’l*>& 
o
)

1118 
o
.
push_back
(
Ãw
 
Inüem’l
);

1124 
	gOSDM­
::
	$£t_•och
(
•och_t
 
e
)

1126 
•och
 = 
e
;

1127 autØ&
poŞ
 : 
poŞs
)

1128 
poŞ
.
£cÚd
.
Ï¡_chªge
 = 
e
;

1129 
	}
}

1131 
boŞ
 
	gOSDM­
::
	$is_bÏckli¡ed
(cÚ¡ 
’t™y_addr_t
& 
a
) const

1133 ià(
bÏckli¡
.
	`em±y
())

1134  
çl£
;

1137 ià(
bÏckli¡
.
	`couÁ
(
a
))

1138  
Œue
;

1141 ià(
a
.
	`is_
()) {

1142 
’t™y_addr_t
 
b
 = 
a
;

1143 
b
.
	`£t_pÜt
(0);

1144 
b
.
	`£t_nÚû
(0);

1145 ià(
bÏckli¡
.
	`couÁ
(
b
)) {

1146  
Œue
;

1150  
çl£
;

1151 
	}
}

1153 
	gOSDM­
::
g‘_bÏckli¡
(
li¡
<
·œ
<
’t™y_addr_t
,
utime_t
> > *
bl
) const

1155 
	g¡d
::
cİy
(
bÏckli¡
.
begš
(), bÏckli¡.
’d
(), 
¡d
::
back_š£¹”
(*
bl
));

1158 
	gOSDM­
::
g‘_bÏckli¡
(
¡d
::
£t
<
’t™y_addr_t
> *
bl
) const

1160 cÚ¡‡utØ&
i
 : 
bÏckli¡
) {

1161 
bl
->
š£¹
(
i
.
fœ¡
);

1165 
	gOSDM­
::
	$£t_max_osd
(
m
)

1167 
o
 = 
max_osd
;

1168 
max_osd
 = 
m
;

1169 
osd_¡©e
.
	`»size
(
m
);

1170 
osd_weight
.
	`»size
(
m
);

1171 ; 
o
<
max_osd
; o++) {

1172 
osd_¡©e
[
o
] = 0;

1173 
osd_weight
[
o
] = 
CEPH_OSD_OUT
;

1175 
osd_šfo
.
	`»size
(
m
);

1176 
osd_xšfo
.
	`»size
(
m
);

1177 
osd_addrs
->
ş›Á_addr
.
	`»size
(
m
);

1178 
osd_addrs
->
şu¡”_addr
.
	`»size
(
m
);

1179 
osd_addrs
->
hb_back_addr
.
	`»size
(
m
);

1180 
osd_addrs
->
hb_äÚt_addr
.
	`»size
(
m
);

1181 
osd_uuid
->
	`»size
(
m
);

1182 ià(
osd_´im¬y_affš™y
)

1183 
osd_´im¬y_affš™y
->
	`»size
(
m
, 
CEPH_OSD_DEFAULT_PRIMARY_AFFINITY
);

1185 
	`ÿlc_num_osds
();

1186 
	}
}

1188 
	gOSDM­
::
	$ÿlc_num_osds
()

1190 
num_osd
 = 0;

1191 
num_up_osd
 = 0;

1192 
num_š_osd
 = 0;

1193 
i
=0; i<
max_osd
; i++) {

1194 ià(
osd_¡©e
[
i
] & 
CEPH_OSD_EXISTS
) {

1195 ++
num_osd
;

1196 ià(
osd_¡©e
[
i
] & 
CEPH_OSD_UP
) {

1197 ++
num_up_osd
;

1199 ià(
	`g‘_weight
(
i
è!ğ
CEPH_OSD_OUT
) {

1200 ++
num_š_osd
;

1204  
num_osd
;

1205 
	}
}

1207 
	gOSDM­
::
g‘_fuÎ_poŞs
(
C•hCÚ‹xt
 *
cù
,

1208 
£t
<
št64_t
> *
fuÎ
,

1209 
£t
<
št64_t
> *
backflfuÎ
,

1210 
£t
<
št64_t
> *
Ã¬fuÎ
) const

1212 
as£¹
(
fuÎ
);

1213 
as£¹
(
backflfuÎ
);

1214 
as£¹
(
Ã¬fuÎ
);

1215 
	gfuÎ
->
ş—r
();

1216 
	gbackflfuÎ
->
ş—r
();

1217 
	gÃ¬fuÎ
->
ş—r
();

1219 
	gveùÜ
<> 
	gfuÎ_osds
;

1220 
	gveùÜ
<> 
	gbackflfuÎ_osds
;

1221 
	gveùÜ
<> 
	gÃ¬fuÎ_osds
;

1222 
	gi
 = 0; i < 
	gmax_osd
; ++i) {

1223 ià(
exi¡s
(
i
è&& 
is_up
(iè&& 
is_š
(i)) {

1224 ià(
	gosd_¡©e
[
i
] & 
	gCEPH_OSD_FULL
)

1225 
	gfuÎ_osds
.
push_back
(
i
);

1226 ià(
	gosd_¡©e
[
i
] & 
	gCEPH_OSD_BACKFILLFULL
)

1227 
	gbackflfuÎ_osds
.
push_back
(
i
);

1228 ià(
	gosd_¡©e
[
i
] & 
	gCEPH_OSD_NEARFULL
)

1229 
	gÃ¬fuÎ_osds
.
push_back
(
i
);

1233 autØ
	gi
: 
fuÎ_osds
) {

1234 
g‘_poŞ_ids_by_osd
(
cù
, 
i
, 
fuÎ
);

1236 autØ
	gi
: 
backflfuÎ_osds
) {

1237 
g‘_poŞ_ids_by_osd
(
cù
, 
i
, 
backflfuÎ
);

1239 autØ
	gi
: 
Ã¬fuÎ_osds
) {

1240 
g‘_poŞ_ids_by_osd
(
cù
, 
i
, 
Ã¬fuÎ
);

1244 
	gOSDM­
::
g‘_fuÎ_osd_couÁs
(
£t
<> *
fuÎ
, s‘<> *
backfl
,

1245 
£t
<> *
Ã¬fuÎ
) const

1247 
	gfuÎ
->
ş—r
();

1248 
	gbackfl
->
ş—r
();

1249 
	gÃ¬fuÎ
->
ş—r
();

1250 
	gi
 = 0; i < 
	gmax_osd
; ++i) {

1251 ià(
exi¡s
(
i
è&& 
is_up
(iè&& 
is_š
(i)) {

1252 ià(
	gosd_¡©e
[
i
] & 
	gCEPH_OSD_FULL
)

1253 
	gfuÎ
->
em¶aû
(
i
);

1254 ià(
	gosd_¡©e
[
i
] & 
	gCEPH_OSD_BACKFILLFULL
)

1255 
	gbackfl
->
em¶aû
(
i
);

1256 ià(
	gosd_¡©e
[
i
] & 
	gCEPH_OSD_NEARFULL
)

1257 
	gÃ¬fuÎ
->
em¶aû
(
i
);

1262 
	gOSDM­
::
g‘_®l_osds
(
£t
<
št32_t
>& 
ls
) const

1264 
i
=0; 
	gi
<
	gmax_osd
; i++)

1265 ià(
exi¡s
(
i
))

1266 
	gls
.
š£¹
(
i
);

1269 
	gOSDM­
::
g‘_up_osds
(
£t
<
št32_t
>& 
ls
) const

1271 
i
 = 0; 
	gi
 < 
	gmax_osd
; i++) {

1272 ià(
is_up
(
i
))

1273 
	gls
.
š£¹
(
i
);

1277 
	gOSDM­
::
g‘_out_osds
(
£t
<
št32_t
>& 
ls
) const

1279 
i
 = 0; 
	gi
 < 
	gmax_osd
; i++) {

1280 ià(
is_out
(
i
))

1281 
	gls
.
š£¹
(
i
);

1285 
	gOSDM­
::
g‘_æag_£t
(
£t
<
¡ršg
> *
æag£t
) const

1287 
i
 = 0; 
	gi
 < (
	gæags
) * 8; ++i) {

1288 ià(
	gæags
 & (1<<
	gi
)) {

1289 
	gæag£t
->
š£¹
(
g‘_æag_¡ršg
(
æags
 & (1<<
i
)));

1294 
	gOSDM­
::
ÿlc_¡©e_£t
(
¡©e
, 
£t
<
¡ršg
>& 
¡
)

1296 
	gt
 = 
¡©e
;

1297 
	gs
 = 1; 
	gt
; s <<= 1) {

1298 ià(
t
 & 
s
) {

1299 
t
 &ğ~
s
;

1300 
	g¡
.
š£¹
(
ûph_osd_¡©e_Çme
(
s
));

1305 
	gOSDM­
::
adju¡_osd_weights
(cÚ¡ 
m­
<,>& 
weights
, 
Inüem’l
& 
šc
) const

1307 
	gmax
 = 0;

1308 cÚ¡‡utØ&
	gweight
 : 
weights
) {

1309 ià(
weight
.
£cÚd
 > 
max
)

1310 
max
 = 
weight
.
£cÚd
;

1313 cÚ¡‡utØ&
	gweight
 : 
weights
) {

1314 
šc
.
Ãw_weight
[
weight
.
fœ¡
] = ()((weight.
£cÚd
 / 
max
è* 
CEPH_OSD_IN
);

1318 
	gOSDM­
::
	$id’tify_osd
(cÚ¡ 
’t™y_addr_t
& 
addr
) const

1320 
i
=0; i<
max_osd
; i++)

1321 ià(
	`exi¡s
(
i
è&& (
	`g‘_addr
(iè=ğ
addr
 || 
	`g‘_şu¡”_addr
(i) ==‡ddr))

1322  
i
;

1324 
	}
}

1326 
	gOSDM­
::
	$id’tify_osd
(cÚ¡ 
uuid_d
& 
u
) const

1328 
i
=0; i<
max_osd
; i++)

1329 ià(
	`exi¡s
(
i
è&& 
	`g‘_uuid
(iè=ğ
u
)

1330  
i
;

1332 
	}
}

1334 
	gOSDM­
::
	$id’tify_osd_Ú_®l_chªÃls
(cÚ¡ 
’t™y_addr_t
& 
addr
) const

1336 
i
=0; i<
max_osd
; i++)

1337 ià(
	`exi¡s
(
i
è&& (
	`g‘_addr
(iè=ğ
addr
 || 
	`g‘_şu¡”_addr
(i) ==‡ddr ||

1338 
	`g‘_hb_back_addr
(
i
è=ğ
addr
 || 
	`g‘_hb_äÚt_addr
(i) ==‡ddr))

1339  
i
;

1341 
	}
}

1343 
	gOSDM­
::
	$fšd_osd_Ú_
(cÚ¡ 
’t™y_addr_t
& 

) const

1345 
i
=0; i<
max_osd
; i++)

1346 ià(
	`exi¡s
(
i
è&& (
	`g‘_addr
(i).
	`is_§me_ho¡
(

è|| 
	`g‘_şu¡”_addr
(i).is_same_host(ip)))

1347  
i
;

1349 
	}
}

1352 
ušt64_t
 
	gOSDM­
::
	$g‘_ã©u»s
(
’t™y_ty³
, 
ušt64_t
 *
pmask
) const

1354 
ušt64_t
 
ã©u»s
 = 0;

1355 
ušt64_t
 
mask
 = 0;

1357 ià(
üush
->
	`has_nÚdeçuÉ_tuÇbËs
())

1358 
ã©u»s
 |ğ
CEPH_FEATURE_CRUSH_TUNABLES
;

1359 ià(
üush
->
	`has_nÚdeçuÉ_tuÇbËs2
())

1360 
ã©u»s
 |ğ
CEPH_FEATURE_CRUSH_TUNABLES2
;

1361 ià(
üush
->
	`has_nÚdeçuÉ_tuÇbËs3
())

1362 
ã©u»s
 |ğ
CEPH_FEATURE_CRUSH_TUNABLES3
;

1363 ià(
üush
->
	`has_v4_buck‘s
())

1364 
ã©u»s
 |ğ
CEPH_FEATURE_CRUSH_V4
;

1365 ià(
üush
->
	`has_nÚdeçuÉ_tuÇbËs5
())

1366 
ã©u»s
 |ğ
CEPH_FEATURE_CRUSH_TUNABLES5
;

1367 ià(
üush
->
	`has_šcom·t_choo£_¬gs
()) {

1368 
ã©u»s
 |ğ
CEPH_FEATUREMASK_CRUSH_CHOOSE_ARGS
;

1370 
mask
 |ğ
CEPH_FEATURES_CRUSH
;

1372 ià(!
pg_upm­
.
	`em±y
(è|| !
pg_upm­_™ems
.empty())

1373 
ã©u»s
 |ğ
CEPH_FEATUREMASK_OSDMAP_PG_UPMAP
;

1374 
mask
 |ğ
CEPH_FEATUREMASK_OSDMAP_PG_UPMAP
;

1376 autØ&
poŞ
: 
poŞs
) {

1377 ià(
poŞ
.
£cÚd
.
	`has_æag
(
pg_poŞ_t
::
FLAG_HASHPSPOOL
)) {

1378 
ã©u»s
 |ğ
CEPH_FEATURE_OSDHASHPSPOOL
;

1380 ià(!
poŞ
.
£cÚd
.
t›rs
.
	`em±y
() ||

1381 
poŞ
.
£cÚd
.
	`is_t›r
()) {

1382 
ã©u»s
 |ğ
CEPH_FEATURE_OSD_CACHEPOOL
;

1384 
ruËid
 = 
üush
->
	`fšd_ruË
(
poŞ
.
£cÚd
.
	`g‘_üush_ruË
(),

1385 
poŞ
.
£cÚd
.
	`g‘_ty³
(),

1386 
poŞ
.
£cÚd
.
	`g‘_size
());

1387 ià(
ruËid
 >= 0) {

1388 ià(
üush
->
	`is_v2_ruË
(
ruËid
))

1389 
ã©u»s
 |ğ
CEPH_FEATURE_CRUSH_V2
;

1390 ià(
üush
->
	`is_v3_ruË
(
ruËid
))

1391 
ã©u»s
 |ğ
CEPH_FEATURE_CRUSH_TUNABLES3
;

1392 ià(
üush
->
	`is_v5_ruË
(
ruËid
))

1393 
ã©u»s
 |ğ
CEPH_FEATURE_CRUSH_TUNABLES5
;

1396 
mask
 |ğ
CEPH_FEATURE_OSDHASHPSPOOL
 | 
CEPH_FEATURE_OSD_CACHEPOOL
;

1398 ià(
osd_´im¬y_affš™y
) {

1399 
i
 = 0; i < 
max_osd
; ++i) {

1400 ià((*
osd_´im¬y_affš™y
)[
i
] !ğ
CEPH_OSD_DEFAULT_PRIMARY_AFFINITY
) {

1401 
ã©u»s
 |ğ
CEPH_FEATURE_OSD_PRIMARY_AFFINITY
;

1406 
mask
 |ğ
CEPH_FEATURE_OSD_PRIMARY_AFFINITY
;

1408 ià(
’t™y_ty³
 =ğ
CEPH_ENTITY_TYPE_OSD
) {

1409 cÚ¡ 
ušt64_t
 
jew–_ã©u»s
 = 
CEPH_FEATURE_SERVER_JEWEL
;

1410 ià(
»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_JEWEL
) {

1411 
ã©u»s
 |ğ
jew–_ã©u»s
;

1413 
mask
 |ğ
jew–_ã©u»s
;

1415 cÚ¡ 
ušt64_t
 
k¿k’_ã©u»s
 = 
CEPH_FEATUREMASK_SERVER_KRAKEN


1416 | 
CEPH_FEATURE_MSG_ADDR2
;

1417 ià(
»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_KRAKEN
) {

1418 
ã©u»s
 |ğ
k¿k’_ã©u»s
;

1420 
mask
 |ğ
k¿k’_ã©u»s
;

1423 ià(
pmask
)

1424 *
pmask
 = 
mask
;

1425  
ã©u»s
;

1426 
	}
}

1428 
ušt8_t
 
	gOSDM­
::
	$g‘_mš_com·t_ş›Á
() const

1430 
ušt64_t
 
f
 = 
	`g‘_ã©u»s
(
CEPH_ENTITY_TYPE_CLIENT
, 
nuÎ±r
);

1432 ià(
	`HAVE_FEATURE
(
f
, 
OSDMAP_PG_UPMAP
) ||

1433 
	`HAVE_FEATURE
(
f
, 
CRUSH_CHOOSE_ARGS
)) {

1434  
CEPH_RELEASE_LUMINOUS
;

1436 ià(
	`HAVE_FEATURE
(
f
, 
CRUSH_TUNABLES5
)) {

1437  
CEPH_RELEASE_JEWEL
;

1439 ià(
	`HAVE_FEATURE
(
f
, 
CRUSH_V4
)) {

1440  
CEPH_RELEASE_HAMMER
;

1442 ià(
	`HAVE_FEATURE
(
f
, 
OSD_PRIMARY_AFFINITY
) ||

1443 
	`HAVE_FEATURE
(
f
, 
CRUSH_TUNABLES3
) ||

1444 
	`HAVE_FEATURE
(
f
, 
OSD_CACHEPOOL
)) {

1445  
CEPH_RELEASE_FIREFLY
;

1447 ià(
	`HAVE_FEATURE
(
f
, 
CRUSH_TUNABLES2
) ||

1448 
	`HAVE_FEATURE
(
f
, 
OSDHASHPSPOOL
)) {

1449  
CEPH_RELEASE_DUMPLING
;

1451 ià(
	`HAVE_FEATURE
(
f
, 
CRUSH_TUNABLES
)) {

1452  
CEPH_RELEASE_ARGONAUT
;

1454  
CEPH_RELEASE_ARGONAUT
;

1455 
	}
}

1457 
ušt8_t
 
	gOSDM­
::
	$g‘_»quœe_mš_com·t_ş›Á
() const

1459  
»quœe_mš_com·t_ş›Á
;

1460 
	}
}

1462 
	gOSDM­
::
	$_ÿlc_up_osd_ã©u»s
()

1464 
boŞ
 
fœ¡
 = 
Œue
;

1465 
ÿched_up_osd_ã©u»s
 = 0;

1466 
osd
 = 0; osd < 
max_osd
; ++osd) {

1467 ià(!
	`is_up
(
osd
))

1469 cÚ¡ 
osd_xšfo_t
 &
xi
 = 
	`g‘_xšfo
(
osd
);

1470 ià(
xi
.
ã©u»s
 == 0)

1472 ià(
fœ¡
) {

1473 
ÿched_up_osd_ã©u»s
 = 
xi
.
ã©u»s
;

1474 
fœ¡
 = 
çl£
;

1476 
ÿched_up_osd_ã©u»s
 &ğ
xi
.
ã©u»s
;

1479 
	}
}

1481 
ušt64_t
 
	gOSDM­
::
	$g‘_up_osd_ã©u»s
() const

1483  
ÿched_up_osd_ã©u»s
;

1484 
	}
}

1486 
	gOSDM­
::
	$dedup
(cÚ¡ 
OSDM­
 *
o
, OSDM­ *
n
)

1488 
usšg
 
ûph
::
’code
;

1489 ià(
o
->
•och
 =ğ
n
->epoch)

1492 
diff
 = 0;

1495 ià(
o
->
max_osd
 !ğ
n
->max_osd)

1496 
diff
++;

1497 
i
 = 0; i < 
o
->
max_osd
 && i < 
n
->max_osd; i++) {

1498 iàĞ
n
->
osd_addrs
->
ş›Á_addr
[
i
] && 
o
->osd_addrs->client_addr[i] &&

1499 *
n
->
osd_addrs
->
ş›Á_addr
[
i
] =ğ*
o
->osd_addrs->client_addr[i])

1500 
n
->
osd_addrs
->
ş›Á_addr
[
i
] = 
o
->osd_addrs->client_addr[i];

1502 
diff
++;

1503 iàĞ
n
->
osd_addrs
->
şu¡”_addr
[
i
] && 
o
->osd_addrs->cluster_addr[i] &&

1504 *
n
->
osd_addrs
->
şu¡”_addr
[
i
] =ğ*
o
->osd_addrs->cluster_addr[i])

1505 
n
->
osd_addrs
->
şu¡”_addr
[
i
] = 
o
->osd_addrs->cluster_addr[i];

1507 
diff
++;

1508 iàĞ
n
->
osd_addrs
->
hb_back_addr
[
i
] && 
o
->osd_addrs->hb_back_addr[i] &&

1509 *
n
->
osd_addrs
->
hb_back_addr
[
i
] =ğ*
o
->osd_addrs->hb_back_addr[i])

1510 
n
->
osd_addrs
->
hb_back_addr
[
i
] = 
o
->osd_addrs->hb_back_addr[i];

1512 
diff
++;

1513 iàĞ
n
->
osd_addrs
->
hb_äÚt_addr
[
i
] && 
o
->osd_addrs->hb_front_addr[i] &&

1514 *
n
->
osd_addrs
->
hb_äÚt_addr
[
i
] =ğ*
o
->osd_addrs->hb_front_addr[i])

1515 
n
->
osd_addrs
->
hb_äÚt_addr
[
i
] = 
o
->osd_addrs->hb_front_addr[i];

1517 
diff
++;

1519 ià(
diff
 == 0) {

1521 
n
->
osd_addrs
 = 
o
->osd_addrs;

1525 
bufã¾i¡
 
oc
, 
nc
;

1526 
	`’code
(*
o
->
üush
, 
oc
, 
CEPH_FEATURES_SUPPORTED_DEFAULT
);

1527 
	`’code
(*
n
->
üush
, 
nc
, 
CEPH_FEATURES_SUPPORTED_DEFAULT
);

1528 ià(
oc
.
	`cÚ‹Ás_equ®
(
nc
)) {

1529 
n
->
üush
 = 
o
->crush;

1533 ià(*
o
->
pg_‹mp
 =ğ*
n
->pg_temp)

1534 
n
->
pg_‹mp
 = 
o
->pg_temp;

1537 ià(
o
->
´im¬y_‹mp
->
	`size
(è=ğ
n
->primary_temp->size()) {

1538 ià(*
o
->
´im¬y_‹mp
 =ğ*
n
->primary_temp)

1539 
n
->
´im¬y_‹mp
 = 
o
->primary_temp;

1543 ià(
o
->
osd_uuid
->
	`size
(è=ğ
n
->osd_uuid->size() &&

1544 *
o
->
osd_uuid
 =ğ*
n
->osd_uuid)

1545 
n
->
osd_uuid
 = 
o
->osd_uuid;

1546 
	}
}

1548 
	gOSDM­
::
	$ş—n_‹mps
(
C•hCÚ‹xt
 *
cù
,

1549 cÚ¡ 
OSDM­
& 
osdm­
, 
Inüem’l
 *
³ndšg_šc
)

1551 
	`ldout
(
cù
, 10è<< 
__func__
 << 
d’dl
;

1552 
OSDM­
 
tmpm­
;

1553 
tmpm­
.
	`d“pish_cİy_äom
(
osdm­
);

1554 
tmpm­
.
	`­¶y_šüem’l
(*
³ndšg_šc
);

1556 autØ
pg
 : *
tmpm­
.
pg_‹mp
) {

1560 ià(!
osdm­
.
	`have_pg_poŞ
(
pg
.
fœ¡
.
	`poŞ
())) {

1561 
	`ldout
(
cù
, 10è<< 
__func__
 << "„emovšg…g_‹m°" << 
pg
.
fœ¡


1562 << " fÜ‚Úexi¡’ˆpoŞ " << 
pg
.
fœ¡
.
	`poŞ
(è<< 
d’dl
;

1563 
³ndšg_šc
->
Ãw_pg_‹mp
[
pg
.
fœ¡
].
	`ş—r
();

1567 
num_up
 = 0;

1568 autØ
o
 : 
pg
.
£cÚd
) {

1569 ià(!
tmpm­
.
	`is_down
(
o
)) {

1570 ++
num_up
;

1574 ià(
num_up
 == 0) {

1575 
	`ldout
(
cù
, 10è<< 
__func__
 << "„emovšg…g_‹m°" << 
pg
.
fœ¡


1576 << " w™h‡Î dowÀosds" << 
pg
.
£cÚd
 << 
d’dl
;

1577 
³ndšg_šc
->
Ãw_pg_‹mp
[
pg
.
fœ¡
].
	`ş—r
();

1581 
veùÜ
<> 
¿w_up
;

1582 
´im¬y
;

1583 
tmpm­
.
	`pg_to_¿w_up
(
pg
.
fœ¡
, &
¿w_up
, &
´im¬y
);

1584 ià(
¿w_up
 =ğ
pg
.
£cÚd
) {

1585 
	`ldout
(
cù
, 10è<< 
__func__
 << "„emovšg…g_‹m°" << 
pg
.
fœ¡
 << " "

1586 << 
pg
.
£cÚd
 << "h© m©che ¿w_u°m­pšg" << 
d’dl
;

1587 ià(
osdm­
.
pg_‹mp
->
	`couÁ
(
pg
.
fœ¡
))

1588 
³ndšg_šc
->
Ãw_pg_‹mp
[
pg
.
fœ¡
].
	`ş—r
();

1590 
³ndšg_šc
->
Ãw_pg_‹mp
.
	`”a£
(
pg
.
fœ¡
);

1594 autØ&
pg
 : *
tmpm­
.
´im¬y_‹mp
) {

1596 ià(
tmpm­
.
	`is_down
(
pg
.
£cÚd
)) {

1597 
	`ldout
(
cù
, 10è<< 
__func__
 << "„emovšg…rim¬y_‹m°" << 
pg
.
fœ¡


1598 << "ØdowÀ" << 
pg
.
£cÚd
 << 
d’dl
;

1599 
³ndšg_šc
->
Ãw_´im¬y_‹mp
[
pg
.
fœ¡
] = -1;

1603 
veùÜ
<> 
»®_up
, 
‹m¶ess_up
;

1604 
»®_´im¬y
, 
‹m¶ess_´im¬y
;

1605 
pg_t
 
pgid
 = 
pg
.
fœ¡
;

1606 
tmpm­
.
	`pg_to_aùšg_osds
(
pgid
, &
»®_up
, &
»®_´im¬y
);

1607 
tmpm­
.
	`pg_to_¿w_up
(
pgid
, &
‹m¶ess_up
, &
‹m¶ess_´im¬y
);

1608 ià(
»®_´im¬y
 =ğ
‹m¶ess_´im¬y
){

1609 
	`ldout
(
cù
, 10è<< 
__func__
 << "„emoving…rimary_temp "

1610 << 
pgid
 << " -> " << 
»®_´im¬y


1611 << " (uÂeûs§ry/»dundªt)" << 
d’dl
;

1612 ià(
osdm­
.
´im¬y_‹mp
->
	`couÁ
(
pgid
))

1613 
³ndšg_šc
->
Ãw_´im¬y_‹mp
[
pgid
] = -1;

1615 
³ndšg_šc
->
Ãw_´im¬y_‹mp
.
	`”a£
(
pgid
);

1618 
	}
}

1620 
	gOSDM­
::
	$maybe_»move_pg_upm­s
(
C•hCÚ‹xt
 *
cù
,

1621 cÚ¡ 
OSDM­
& 
osdm­
,

1622 
Inüem’l
 *
³ndšg_šc
)

1624 
	`ldout
(
cù
, 10è<< 
__func__
 << 
d’dl
;

1625 
OSDM­
 
tmpm­
;

1626 
tmpm­
.
	`d“pish_cİy_äom
(
osdm­
);

1627 
tmpm­
.
	`­¶y_šüem’l
(*
³ndšg_šc
);

1628 
£t
<
pg_t
> 
to_check
;

1629 
£t
<
pg_t
> 
to_ÿnûl
;

1630 
m­
<, m­<, >> 
ruË_weight_m­
;

1632 auto& 
p
 : 
tmpm­
.
pg_upm­
) {

1633 
to_check
.
	`š£¹
(
p
.
fœ¡
);

1635 auto& 
p
 : 
tmpm­
.
pg_upm­_™ems
) {

1636 
to_check
.
	`š£¹
(
p
.
fœ¡
);

1638 auto& 
p
 : 
³ndšg_šc
->
Ãw_pg_upm­
) {

1639 
to_check
.
	`š£¹
(
p
.
fœ¡
);

1641 auto& 
p
 : 
³ndšg_šc
->
Ãw_pg_upm­_™ems
) {

1642 
to_check
.
	`š£¹
(
p
.
fœ¡
);

1644 auto& 
pg
 : 
to_check
) {

1645 autØ
üush_ruË
 = 
tmpm­
.
	`g‘_pg_poŞ_üush_ruË
(
pg
);

1646 ià(
üush_ruË
 < 0) {

1647 
	`ld”r
(
cù
è<< 
__func__
 << " unableo†oad crush-rule of…g "

1648 << 
pg
 << 
d’dl
;

1651 
m­
<, > 
weight_m­
;

1652 autØ
™
 = 
ruË_weight_m­
.
	`fšd
(
üush_ruË
);

1653 ià(
™
 =ğ
ruË_weight_m­
.
	`’d
()) {

1654 autØ
r
 = 
tmpm­
.
üush
->
	`g‘_ruË_weight_osd_m­
(
üush_ruË
, &
weight_m­
);

1655 ià(
r
 < 0) {

1656 
	`ld”r
(
cù
è<< 
__func__
 << " unableo get crush weight_map for "

1657 << "üush_ruË " << 
üush_ruË
 << 
d’dl
;

1660 
ruË_weight_m­
[
üush_ruË
] = 
weight_m­
;

1662 
weight_m­
 = 
™
->
£cÚd
;

1664 autØ
ty³
 = 
tmpm­
.
üush
->
	`g‘_ruË_çu»_domaš
(
üush_ruË
);

1665 ià(
ty³
 < 0) {

1666 
	`ld”r
(
cù
è<< 
__func__
 << " unableo†oad failure-domain-type of…g "

1667 << 
pg
 << 
d’dl
;

1670 
	`ldout
(
cù
, 10è<< 
__func__
 << "…g " << 
pg


1671 << " crush-ruË-id " << 
üush_ruË


1672 << " weight_m­ " << 
weight_m­


1673 << " fau»-domaš-ty³ " << 
ty³


1674 << 
d’dl
;

1675 
veùÜ
<> 
¿w
;

1676 
´im¬y
;

1677 
tmpm­
.
	`pg_to_¿w_up
(
pg
, &
¿w
, &
´im¬y
);

1678 
£t
<> 
·»Ás
;

1679 autØ
osd
 : 
¿w
) {

1680 ià(
ty³
 > 0) {

1681 autØ
·»Á
 = 
tmpm­
.
üush
->
	`g‘_·»Á_of_ty³
(
osd
, 
ty³
, 
üush_ruË
);

1682 ià(
·»Á
 >= 0) {

1683 
	`ld”r
(
cù
è<< 
__func__
 << " unableo get…arent of„aw osd."

1684 << 
osd
 << " oàpg " << 
pg


1685 << 
d’dl
;

1688 autØ
r
 = 
·»Ás
.
	`š£¹
(
·»Á
);

1689 ià(!
r
.
£cÚd
) {

1691 
to_ÿnûl
.
	`š£¹
(
pg
);

1697 autØ
™
 = 
weight_m­
.
	`fšd
(
osd
);

1698 ià(
™
 =ğ
weight_m­
.
	`’d
()) {

1700 
to_ÿnûl
.
	`š£¹
(
pg
);

1703 autØ
adju¡ed_weight
 = 
tmpm­
.
	`g‘_weightf
(
™
->
fœ¡
è* it->
£cÚd
;

1704 ià(
adju¡ed_weight
 == 0) {

1706 
to_ÿnûl
.
	`š£¹
(
pg
);

1711 autØ&
pg
: 
to_ÿnûl
) {

1713 autØ
™
 = 
³ndšg_šc
->
Ãw_pg_upm­
.
	`fšd
(
pg
);

1714 ià(
™
 !ğ
³ndšg_šc
->
Ãw_pg_upm­
.
	`’d
()) {

1715 
	`ldout
(
cù
, 10è<< 
__func__
 << " cancel invalid…ending "

1717 << 
™
->
fœ¡
 << "->" << it->
£cÚd


1718 << 
d’dl
;

1719 
³ndšg_šc
->
Ãw_pg_upm­
.
	`”a£
(
™
);

1721 ià(
osdm­
.
pg_upm­
.
	`couÁ
(
pg
)) {

1722 
	`ldout
(
cù
, 10è<< 
__func__
 << " cancel invalid…g_upmapƒntry "

1723 << 
osdm­
.
pg_upm­
.
	`fšd
(
pg
)->
fœ¡
 << "->"

1724 << 
osdm­
.
pg_upm­
.
	`fšd
(
pg
)->
£cÚd


1725 << 
d’dl
;

1726 
³ndšg_šc
->
Şd_pg_upm­
.
	`š£¹
(
pg
);

1730 autØ
™
 = 
³ndšg_šc
->
Ãw_pg_upm­_™ems
.
	`fšd
(
pg
);

1731 ià(
™
 !ğ
³ndšg_šc
->
Ãw_pg_upm­_™ems
.
	`’d
()) {

1732 
	`ldout
(
cù
, 10è<< 
__func__
 << " cancel invalid…ending "

1734 << 
™
->
fœ¡
 << "->" << it->
£cÚd


1735 << 
d’dl
;

1736 
³ndšg_šc
->
Ãw_pg_upm­_™ems
.
	`”a£
(
™
);

1738 ià(
osdm­
.
pg_upm­_™ems
.
	`couÁ
(
pg
)) {

1739 
	`ldout
(
cù
, 10è<< 
__func__
 << " cancel invalid "

1741 << 
osdm­
.
pg_upm­_™ems
.
	`fšd
(
pg
)->
fœ¡
 << "->"

1742 << 
osdm­
.
pg_upm­_™ems
.
	`fšd
(
pg
)->
£cÚd


1743 << 
d’dl
;

1744 
³ndšg_šc
->
Şd_pg_upm­_™ems
.
	`š£¹
(
pg
);

1748 
	}
}

1750 
	gOSDM­
::
	$­¶y_šüem’l
(cÚ¡ 
Inüem’l
 &
šc
)

1752 
Ãw_bÏckli¡_’Œ›s
 = 
çl£
;

1753 ià(
šc
.
•och
 == 1)

1754 
fsid
 = 
šc
.fsid;

1755 ià(
šc
.
fsid
 != fsid)

1756  -
EINVAL
;

1758 
	`as£¹
(
šc
.
•och
 ==ƒpoch+1);

1760 
•och
++;

1761 
modif›d
 = 
šc
.modified;

1764 ià(
šc
.
fuÎm­
.
	`Ëngth
()) {

1765 
bufã¾i¡
 
	`bl
(
šc
.
fuÎm­
);

1766 
	`decode
(
bl
);

1771 ià(
šc
.
Ãw_æags
 >= 0) {

1772 
æags
 = 
šc
.
Ãw_æags
;

1777 ià(
æags
 & 
CEPH_OSDMAP_REQUIRE_KRAKEN
) {

1778 ià(
»quœe_osd_»Ëa£
 < 
CEPH_RELEASE_KRAKEN
) {

1779 
»quœe_osd_»Ëa£
 = 
CEPH_RELEASE_KRAKEN
;

1781 } ià(
æags
 & 
CEPH_OSDMAP_REQUIRE_JEWEL
) {

1782 ià(
»quœe_osd_»Ëa£
 < 
CEPH_RELEASE_JEWEL
) {

1783 
»quœe_osd_»Ëa£
 = 
CEPH_RELEASE_JEWEL
;

1788 ià(
šc
.
Ãw_max_osd
 >= 0)

1789 
	`£t_max_osd
(
šc
.
Ãw_max_osd
);

1791 ià(
šc
.
Ãw_poŞ_max
 != -1)

1792 
poŞ_max
 = 
šc
.
Ãw_poŞ_max
;

1794 cÚ¡‡utØ&
poŞ
 : 
šc
.
Ãw_poŞs
) {

1795 
poŞs
[
poŞ
.
fœ¡
] =…oŞ.
£cÚd
;

1796 
poŞs
[
poŞ
.
fœ¡
].
Ï¡_chªge
 = 
•och
;

1799 
Ãw_»moved_¢­s
 = 
šc
.new_removed_snaps;

1800 
Ãw_purged_¢­s
 = 
šc
.new_purged_snaps;

1801 autØ
p
 = 
Ãw_»moved_¢­s
.
	`begš
();

1802 
p
 !ğ
Ãw_»moved_¢­s
.
	`’d
();

1803 ++
p
) {

1804 
»moved_¢­s_queue
[
p
->
fœ¡
].
	`uniÚ_of
Õ->
£cÚd
);

1806 autØ
p
 = 
Ãw_purged_¢­s
.
	`begš
();

1807 
p
 !ğ
Ãw_purged_¢­s
.
	`’d
();

1808 ++
p
) {

1809 autØ
q
 = 
»moved_¢­s_queue
.
	`fšd
(
p
->
fœ¡
);

1810 
	`as£¹
(
q
 !ğ
»moved_¢­s_queue
.
	`’d
());

1811 
q
->
£cÚd
.
	`subŒaù
(
p
->second);

1812 ià(
q
->
£cÚd
.
	`em±y
()) {

1813 
»moved_¢­s_queue
.
	`”a£
(
q
);

1817 cÚ¡‡utØ&
²ame
 : 
šc
.
Ãw_poŞ_Çmes
) {

1818 autØ
poŞ_Çme_’Œy
 = 
poŞ_Çme
.
	`fšd
(
²ame
.
fœ¡
);

1819 ià(
poŞ_Çme_’Œy
 !ğ
poŞ_Çme
.
	`’d
()) {

1820 
Çme_poŞ
.
	`”a£
(
poŞ_Çme_’Œy
->
£cÚd
);

1821 
poŞ_Çme_’Œy
->
£cÚd
 = 
²ame
.second;

1823 
poŞ_Çme
[
²ame
.
fœ¡
] =…Çme.
£cÚd
;

1825 
Çme_poŞ
[
²ame
.
£cÚd
] =…Çme.
fœ¡
;

1828 cÚ¡‡utØ&
poŞ
 : 
šc
.
Şd_poŞs
) {

1829 
poŞs
.
	`”a£
(
poŞ
);

1830 
Çme_poŞ
.
	`”a£
(
poŞ_Çme
[
poŞ
]);

1831 
poŞ_Çme
.
	`”a£
(
poŞ
);

1834 cÚ¡‡utØ&
weight
 : 
šc
.
Ãw_weight
) {

1835 
	`£t_weight
(
weight
.
fœ¡
, weight.
£cÚd
);

1839 ià(
weight
.
£cÚd
) {

1840 
osd_¡©e
[
weight
.
fœ¡
] &ğ~(
CEPH_OSD_AUTOOUT
 | 
CEPH_OSD_NEW
);

1841 
osd_xšfo
[
weight
.
fœ¡
].
Şd_weight
 = 0;

1845 cÚ¡‡utØ&
´im¬y_affš™y
 : 
šc
.
Ãw_´im¬y_affš™y
) {

1846 
	`£t_´im¬y_affš™y
(
´im¬y_affš™y
.
fœ¡
,…rim¬y_affš™y.
£cÚd
);

1850 cÚ¡‡utØ&
´ofe
 : 
šc
.
Şd_”asu»_code_´ofes
)

1851 
”asu»_code_´ofes
.
	`”a£
(
´ofe
);

1853 cÚ¡‡utØ&
´ofe
 : 
šc
.
Ãw_”asu»_code_´ofes
) {

1854 
	`£t_”asu»_code_´ofe
(
´ofe
.
fœ¡
,…rofe.
£cÚd
);

1858 cÚ¡‡utØ&
¡©e
 : 
šc
.
Ãw_¡©e
) {

1859 cÚ¡‡utØ
osd
 = 
¡©e
.
fœ¡
;

1860 
s
 = 
¡©e
.
£cÚd
 ? s‹.£cÚd : 
CEPH_OSD_UP
;

1861 ià((
osd_¡©e
[
osd
] & 
CEPH_OSD_UP
) &&

1862 (
s
 & 
CEPH_OSD_UP
)) {

1863 
osd_šfo
[
osd
].
down_©
 = 
•och
;

1864 
osd_xšfo
[
osd
].
down_¡amp
 = 
modif›d
;

1866 ià((
osd_¡©e
[
osd
] & 
CEPH_OSD_EXISTS
) &&

1867 (
s
 & 
CEPH_OSD_EXISTS
)) {

1869 (*
osd_uuid
)[
osd
] = 
	`uuid_d
();

1870 
osd_šfo
[
osd
] = 
	`osd_šfo_t
();

1871 
osd_xšfo
[
osd
] = 
	`osd_xšfo_t
();

1872 
	`£t_´im¬y_affš™y
(
osd
, 
CEPH_OSD_DEFAULT_PRIMARY_AFFINITY
);

1873 
osd_addrs
->
ş›Á_addr
[
osd
].
	`»£t
(
Ãw
 
	`’t™y_addr_t
());

1874 
osd_addrs
->
şu¡”_addr
[
osd
].
	`»£t
(
Ãw
 
	`’t™y_addr_t
());

1875 
osd_addrs
->
hb_äÚt_addr
[
osd
].
	`»£t
(
Ãw
 
	`’t™y_addr_t
());

1876 
osd_addrs
->
hb_back_addr
[
osd
].
	`»£t
(
Ãw
 
	`’t™y_addr_t
());

1877 
osd_¡©e
[
osd
] = 0;

1879 
osd_¡©e
[
osd
] ^ğ
s
;

1883 cÚ¡‡utØ&
ş›Á
 : 
šc
.
Ãw_up_ş›Á
) {

1884 
osd_¡©e
[
ş›Á
.
fœ¡
] |ğ
CEPH_OSD_EXISTS
 | 
CEPH_OSD_UP
;

1885 
osd_addrs
->
ş›Á_addr
[
ş›Á
.
fœ¡
].
	`»£t
(
Ãw
 
	`’t™y_addr_t
(ş›Á.
£cÚd
));

1886 ià(
šc
.
Ãw_hb_back_up
.
	`em±y
())

1887 
osd_addrs
->
hb_back_addr
[
ş›Á
.
fœ¡
].
	`»£t
(
Ãw
 
	`’t™y_addr_t
(ş›Á.
£cÚd
));

1889 
osd_addrs
->
hb_back_addr
[
ş›Á
.
fœ¡
].
	`»£t
(

1890 
Ãw
 
	`’t™y_addr_t
(
šc
.
Ãw_hb_back_up
.
	`fšd
(
ş›Á
.
fœ¡
)->
£cÚd
));

1891 cÚ¡‡utØ
j
 = 
šc
.
Ãw_hb_äÚt_up
.
	`fšd
(
ş›Á
.
fœ¡
);

1892 ià(
j
 !ğ
šc
.
Ãw_hb_äÚt_up
.
	`’d
())

1893 
osd_addrs
->
hb_äÚt_addr
[
ş›Á
.
fœ¡
].
	`»£t
(
Ãw
 
	`’t™y_addr_t
(
j
->
£cÚd
));

1895 
osd_addrs
->
hb_äÚt_addr
[
ş›Á
.
fœ¡
].
	`»£t
();

1897 
osd_šfo
[
ş›Á
.
fœ¡
].
up_äom
 = 
•och
;

1900 cÚ¡‡utØ&
şu¡”
 : 
šc
.
Ãw_up_şu¡”
)

1901 
osd_addrs
->
şu¡”_addr
[
şu¡”
.
fœ¡
].
	`»£t
(
Ãw
 
	`’t™y_addr_t
(şu¡”.
£cÚd
));

1904 cÚ¡‡utØ&
thru
 : 
šc
.
Ãw_up_thru
)

1905 
osd_šfo
[
thru
.
fœ¡
].
up_thru
 =hru.
£cÚd
;

1907 cÚ¡‡utØ&
š‹rv®
 : 
šc
.
Ãw_Ï¡_ş—n_š‹rv®
) {

1908 
osd_šfo
[
š‹rv®
.
fœ¡
].
Ï¡_ş—n_begš
 = iÁ”v®.
£cÚd
.first;

1909 
osd_šfo
[
š‹rv®
.
fœ¡
].
Ï¡_ş—n_’d
 = iÁ”v®.
£cÚd
.second;

1912 cÚ¡‡utØ&
lo¡
 : 
šc
.
Ãw_lo¡
)

1913 
osd_šfo
[
lo¡
.
fœ¡
].
lo¡_©
 =†o¡.
£cÚd
;

1916 cÚ¡‡utØ&
xšfo
 : 
šc
.
Ãw_xšfo
)

1917 
osd_xšfo
[
xšfo
.
fœ¡
] = xšfo.
£cÚd
;

1920 cÚ¡‡utØ&
uuid
 : 
šc
.
Ãw_uuid
)

1921 (*
osd_uuid
)[
uuid
.
fœ¡
] = uuid.
£cÚd
;

1924 cÚ¡‡utØ&
pg
 : 
šc
.
Ãw_pg_‹mp
) {

1925 ià(
pg
.
£cÚd
.
	`em±y
())

1926 
pg_‹mp
->
	`”a£
(
pg
.
fœ¡
);

1928 
pg_‹mp
->
	`£t
(
pg
.
fœ¡
,…g.
£cÚd
);

1930 ià(!
šc
.
Ãw_pg_‹mp
.
	`em±y
()) {

1932 
pg_‹mp
->
	`»bud
();

1935 cÚ¡‡utØ&
pg
 : 
šc
.
Ãw_´im¬y_‹mp
) {

1936 ià(
pg
.
£cÚd
 == -1)

1937 
´im¬y_‹mp
->
	`”a£
(
pg
.
fœ¡
);

1939 (*
´im¬y_‹mp
)[
pg
.
fœ¡
] =…g.
£cÚd
;

1942 auto& 
p
 : 
šc
.
Ãw_pg_upm­
) {

1943 
pg_upm­
[
p
.
fœ¡
] =….
£cÚd
;

1945 auto& 
pg
 : 
šc
.
Şd_pg_upm­
) {

1946 
pg_upm­
.
	`”a£
(
pg
);

1948 auto& 
p
 : 
šc
.
Ãw_pg_upm­_™ems
) {

1949 
pg_upm­_™ems
[
p
.
fœ¡
] =….
£cÚd
;

1951 auto& 
pg
 : 
šc
.
Şd_pg_upm­_™ems
) {

1952 
pg_upm­_™ems
.
	`”a£
(
pg
);

1956 ià(!
šc
.
Ãw_bÏckli¡
.
	`em±y
()) {

1957 
bÏckli¡
.
	`š£¹
(
šc
.
Ãw_bÏckli¡
.
	`begš
(),šc.Ãw_bÏckli¡.
	`’d
());

1958 
Ãw_bÏckli¡_’Œ›s
 = 
Œue
;

1960 cÚ¡‡utØ&
addr
 : 
šc
.
Şd_bÏckli¡
)

1961 
bÏckli¡
.
	`”a£
(
addr
);

1964 ià(
šc
.
şu¡”_¢­shÙ
.
	`Ëngth
()) {

1965 
şu¡”_¢­shÙ
 = 
šc
.cluster_snapshot;

1966 
şu¡”_¢­shÙ_•och
 = 
šc
.
•och
;

1968 
şu¡”_¢­shÙ
.
	`ş—r
();

1969 
şu¡”_¢­shÙ_•och
 = 0;

1972 ià(
šc
.
Ãw_Ã¬fuÎ_¿tio
 >= 0) {

1973 
Ã¬fuÎ_¿tio
 = 
šc
.
Ãw_Ã¬fuÎ_¿tio
;

1975 ià(
šc
.
Ãw_backflfuÎ_¿tio
 >= 0) {

1976 
backflfuÎ_¿tio
 = 
šc
.
Ãw_backflfuÎ_¿tio
;

1978 ià(
šc
.
Ãw_fuÎ_¿tio
 >= 0) {

1979 
fuÎ_¿tio
 = 
šc
.
Ãw_fuÎ_¿tio
;

1981 ià(
šc
.
Ãw_»quœe_mš_com·t_ş›Á
 > 0) {

1982 
»quœe_mš_com·t_ş›Á
 = 
šc
.
Ãw_»quœe_mš_com·t_ş›Á
;

1984 ià(
šc
.
Ãw_»quœe_osd_»Ëa£
 >= 0) {

1985 
»quœe_osd_»Ëa£
 = 
šc
.
Ãw_»quœe_osd_»Ëa£
;

1986 ià(
»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_LUMINOUS
) {

1987 
æags
 &ğ~(
CEPH_OSDMAP_LEGACY_REQUIRE_FLAGS
);

1988 
æags
 |ğ
CEPH_OSDMAP_RECOVERY_DELETES
;

1993 ià(
šc
.
üush
.
	`Ëngth
()) {

1994 
bufã¾i¡
 
	`bl
(
šc
.
üush
);

1995 autØ
bÍ
 = 
bl
.
	`begš
();

1996 
üush
.
	`»£t
(
Ãw
 
CrushW¿µ”
);

1997 
üush
->
	`decode
(
bÍ
);

1998 ià(
»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_LUMINOUS
) {

2003 ++
üush_v”siÚ
;

2007 
	`ÿlc_num_osds
();

2008 
	`_ÿlc_up_osd_ã©u»s
();

2010 
	}
}

2013 
	gOSDM­
::
	$m­_to_pg
(

2014 
št64_t
 
poŞid
,

2015 cÚ¡ 
¡ršg
& 
Çme
,

2016 cÚ¡ 
¡ršg
& 
key
,

2017 cÚ¡ 
¡ršg
& 
n¥aû
,

2018 
pg_t
 *
pg
) const

2021 cÚ¡ 
pg_poŞ_t
 *
poŞ
 = 
	`g‘_pg_poŞ
(
poŞid
);

2022 ià(!
poŞ
)

2023  -
ENOENT
;

2024 
ps_t
 
ps
;

2025 ià(!
key
.
	`em±y
())

2026 
ps
 = 
poŞ
->
	`hash_key
(
key
, 
n¥aû
);

2028 
ps
 = 
poŞ
->
	`hash_key
(
Çme
, 
n¥aû
);

2029 *
pg
 = 
	`pg_t
(
ps
, 
poŞid
);

2031 
	}
}

2033 
	gOSDM­
::
	$objeù_loÿtÜ_to_pg
(

2034 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
loc
, 
pg_t
 &
pg
) const

2036 ià(
loc
.
hash
 >= 0) {

2037 ià(!
	`g‘_pg_poŞ
(
loc
.
	`g‘_poŞ
())) {

2038  -
ENOENT
;

2040 
pg
 = 
	`pg_t
(
loc
.
hash
,†oc.
	`g‘_poŞ
());

2043  
	`m­_to_pg
(
loc
.
	`g‘_poŞ
(), 
oid
.
Çme
,†oc.
key
,†oc.
n¥aû
, &
pg
);

2044 
	}
}

2046 
ûph_objeù_Ïyout
 
	gOSDM­
::
	$make_objeù_Ïyout
(

2047 
objeù_t
 
oid
, 
pg_poŞ
, 
¡ršg
 
n¥aû
) const

2049 
objeù_loÿtÜ_t
 
	`loc
(
pg_poŞ
, 
n¥aû
);

2051 
ûph_objeù_Ïyout
 
Ş
;

2052 
pg_t
 
pgid
 = 
	`objeù_loÿtÜ_to_pg
(
oid
, 
loc
);

2053 
Ş
.
Ş_pgid
 = 
pgid
.
	`g‘_Şd_pg
().
v
;

2054 
Ş
.
Ş_¡re_un™
 = 0;

2055  
Ş
;

2056 
	}
}

2058 
	gOSDM­
::
_»move_nÚexi¡’t_osds
(cÚ¡ 
pg_poŞ_t
& 
poŞ
,

2059 
veùÜ
<>& 
osds
) const

2061 ià(
	gpoŞ
.
ÿn_shiá_osds
()) {

2062 
	g»moved
 = 0;

2063 
	gi
 = 0; i < 
	gosds
.
size
(); i++) {

2064 ià(!
exi¡s
(
osds
[
i
])) {

2065 
	g»moved
++;

2068 ià(
	g»moved
) {

2069 
	gosds
[
i
 - 
»moved
] = 
osds
[i];

2072 ià(
	g»moved
)

2073 
	gosds
.
»size
(
osds
.
size
(è- 
»moved
);

2075 auto& 
	gosd
 : 
osds
) {

2076 ià(!
exi¡s
(
osd
))

2077 
osd
 = 
CRUSH_ITEM_NONE
;

2082 
	gOSDM­
::
_pg_to_¿w_osds
(

2083 cÚ¡ 
pg_poŞ_t
& 
poŞ
, 
pg_t
 
pg
,

2084 
veùÜ
<> *
osds
,

2085 
ps_t
 *
µps
) const

2088 
ps_t
 
	gµs
 = 
poŞ
.
¿w_pg_to_µs
(
pg
);

2089 
	gsize
 = 
poŞ
.
g‘_size
();

2092 
	gruËno
 = 
üush
->
fšd_ruË
(
poŞ
.
g‘_üush_ruË
(),…oŞ.
g‘_ty³
(), 
size
);

2093 ià(
	gruËno
 >= 0)

2094 
üush
->
do_ruË
(
ruËno
, 
µs
, *
osds
, 
size
, 
osd_weight
, 
pg
.
poŞ
());

2096 
_»move_nÚexi¡’t_osds
(
poŞ
, *
osds
);

2098 ià(
	gµps
)

2099 *
	gµps
 = 
µs
;

2102 
	gOSDM­
::
_pick_´im¬y
(cÚ¡ 
veùÜ
<>& 
osds
) const

2104 autØ
osd
 : 
osds
) {

2105 ià(
osd
 !ğ
CRUSH_ITEM_NONE
) {

2106  
osd
;

2112 
	gOSDM­
::
_­¶y_upm­
(cÚ¡ 
pg_poŞ_t
& 
pi
, 
pg_t
 
¿w_pg
, 
veùÜ
<> *
¿w
) const

2114 
pg_t
 
	gpg
 = 
pi
.
¿w_pg_to_pg
(
¿w_pg
);

2115 autØ
	gp
 = 
pg_upm­
.
fšd
(
pg
);

2116 ià(
	gp
 !ğ
pg_upm­
.
’d
()) {

2118 autØ
osd
 : 
p
->
£cÚd
) {

2119 ià(
osd
 !ğ
CRUSH_ITEM_NONE
 && osd < 
max_osd
 && 
osd_weight
[osd] == 0) {

2124 *
	g¿w
 = 
veùÜ
<>(
p
->
£cÚd
.
begš
(), 
	gp
->
	g£cÚd
.
’d
());

2128 autØ
	gq
 = 
pg_upm­_™ems
.
fšd
(
pg
);

2129 ià(
	gq
 !ğ
pg_upm­_™ems
.
’d
()) {

2132 auto& 
r
 : 
q
->
£cÚd
) {

2134 
boŞ
 
exi¡s
 = 
çl£
;

2135 
ssize_t
 
	gpos
 = -1;

2136 
	gi
 = 0; i < 
	g¿w
->
size
(); ++i) {

2137 
	gosd
 = (*
¿w
)[
i
];

2138 ià(
	gosd
 =ğ
r
.
£cÚd
) {

2139 
exi¡s
 = 
Œue
;

2143 ià(
	gosd
 =ğ
r
.
fœ¡
 &&

2144 
pos
 < 0 &&

2145 !(
r
.
£cÚd
 !ğ
CRUSH_ITEM_NONE
 &&„.£cÚd < 
max_osd
 &&

2146 
osd_weight
[
r
.
£cÚd
] == 0)) {

2147 
pos
 = 
i
;

2150 ià(!
	gexi¡s
 && 
	gpos
 >= 0) {

2151 (*
¿w
)[
pos
] = 
r
.
£cÚd
;

2158 
	gOSDM­
::
_¿w_to_up_osds
(cÚ¡ 
pg_poŞ_t
& 
poŞ
, cÚ¡ 
veùÜ
<>& 
¿w
,

2159 
veùÜ
<> *
up
) const

2161 ià(
	gpoŞ
.
ÿn_shiá_osds
()) {

2163 
	gup
->
ş—r
();

2164 
	gup
->
»£rve
(
¿w
.
size
());

2165 
	gi
=0; i<
	g¿w
.
size
(); i++) {

2166 ià(!
exi¡s
(
¿w
[
i
]è|| 
is_down
(raw[i]))

2168 
	gup
->
push_back
(
¿w
[
i
]);

2172 
	gup
->
»size
(
¿w
.
size
());

2173 
	gi
 = 
¿w
.
size
() - 1; i >= 0; --i) {

2174 ià(!
exi¡s
(
¿w
[
i
]è|| 
is_down
(raw[i])) {

2175 (*
	gup
)[
i
] = 
CRUSH_ITEM_NONE
;

2177 (*
	gup
)[
i
] = 
¿w
[i];

2183 
	gOSDM­
::
_­¶y_´im¬y_affš™y
(
ps_t
 
£ed
,

2184 cÚ¡ 
pg_poŞ_t
& 
poŞ
,

2185 
veùÜ
<> *
osds
,

2186 *
´im¬y
) const

2189 ià(!
	gosd_´im¬y_affš™y
)

2192 
boŞ
 
	gªy
 = 
çl£
;

2193 cÚ¡‡utØ
	gosd
 : *
osds
) {

2194 ià(
osd
 !ğ
CRUSH_ITEM_NONE
 &&

2195 (*
osd_´im¬y_affš™y
)[
osd
] !ğ
CEPH_OSD_DEFAULT_PRIMARY_AFFINITY
) {

2196 
ªy
 = 
Œue
;

2200 ià(!
	gªy
)

2206 
	gpos
 = -1;

2207 
	gi
 = 0; i < 
	gosds
->
size
(); ++i) {

2208 
	go
 = (*
osds
)[
i
];

2209 ià(
	go
 =ğ
CRUSH_ITEM_NONE
)

2211 
	ga
 = (*
osd_´im¬y_affš™y
)[
o
];

2212 ià(
	ga
 < 
	gCEPH_OSD_MAX_PRIMARY_AFFINITY
 &&

2213 (
üush_hash32_2
(
CRUSH_HASH_RJENKINS1
,

2214 
£ed
, 
o
è>> 16è>ğ
a
) {

2217 ià(
pos
 < 0)

2218 
pos
 = 
i
;

2220 
	gpos
 = 
i
;

2224 ià(
	gpos
 < 0)

2227 *
	g´im¬y
 = (*
osds
)[
pos
];

2229 ià(
	gpoŞ
.
ÿn_shiá_osds
(è&& 
	gpos
 > 0) {

2231 
	gi
 = 
pos
; i > 0; --i) {

2232 (*
	gosds
)[
i
] = (*
osds
)[i-1];

2234 (*
	gosds
)[0] = *
´im¬y
;

2238 
	gOSDM­
::
_g‘_‹mp_osds
(cÚ¡ 
pg_poŞ_t
& 
poŞ
, 
pg_t
 
pg
,

2239 
veùÜ
<> *
‹mp_pg
, *
‹mp_´im¬y
) const

2241 
	gpg
 = 
poŞ
.
¿w_pg_to_pg
(
pg
);

2242 cÚ¡‡utØ
	gp
 = 
pg_‹mp
->
fšd
(
pg
);

2243 
	g‹mp_pg
->
ş—r
();

2244 ià(
	gp
 !ğ
pg_‹mp
->
’d
()) {

2245 
i
=0; 
	gi
<
	gp
->
	g£cÚd
.
size
(); i++) {

2246 ià(!
exi¡s
(
p
->
£cÚd
[
i
]è|| 
is_down
(p->second[i])) {

2247 ià(
	gpoŞ
.
ÿn_shiá_osds
()) {

2250 
	g‹mp_pg
->
push_back
(
CRUSH_ITEM_NONE
);

2253 
	g‹mp_pg
->
push_back
(
p
->
£cÚd
[
i
]);

2257 cÚ¡‡utØ&
	gµ
 = 
´im¬y_‹mp
->
fšd
(
pg
);

2258 *
	g‹mp_´im¬y
 = -1;

2259 ià(
	gµ
 !ğ
´im¬y_‹mp
->
’d
()) {

2260 *
‹mp_´im¬y
 = 
µ
->
£cÚd
;

2261 } ià(!
	g‹mp_pg
->
em±y
()) {

2262 
	gi
 = 0; i < 
	g‹mp_pg
->
size
(); ++i) {

2263 ià((*
	g‹mp_pg
)[
i
] !ğ
CRUSH_ITEM_NONE
) {

2264 *
‹mp_´im¬y
 = (*
‹mp_pg
)[
i
];

2271 
	gOSDM­
::
pg_to_¿w_osds
(
pg_t
 
pg
, 
veùÜ
<> *
¿w
, *
´im¬y
) const

2273 cÚ¡ 
pg_poŞ_t
 *
	gpoŞ
 = 
g‘_pg_poŞ
(
pg
.
poŞ
());

2274 ià(!
	gpoŞ
) {

2275 *
	g´im¬y
 = -1;

2276 
	g¿w
->
ş—r
();

2279 
_pg_to_¿w_osds
(*
poŞ
, 
pg
, 
¿w
, 
NULL
);

2280 *
	g´im¬y
 = 
_pick_´im¬y
(*
¿w
);

2283 
	gOSDM­
::
pg_to_¿w_up
(
pg_t
 
pg
, 
veùÜ
<> *
up
, *
´im¬y
) const

2285 cÚ¡ 
pg_poŞ_t
 *
	gpoŞ
 = 
g‘_pg_poŞ
(
pg
.
poŞ
());

2286 ià(!
	gpoŞ
) {

2287 *
	g´im¬y
 = -1;

2288 
	gup
->
ş—r
();

2291 
	gveùÜ
<> 
	g¿w
;

2292 
ps_t
 
	gµs
;

2293 
_pg_to_¿w_osds
(*
poŞ
, 
pg
, &
¿w
, &
µs
);

2294 
_­¶y_upm­
(*
poŞ
, 
pg
, &
¿w
);

2295 
_¿w_to_up_osds
(*
poŞ
, 
¿w
, 
up
);

2296 *
	g´im¬y
 = 
_pick_´im¬y
(
¿w
);

2297 
_­¶y_´im¬y_affš™y
(
µs
, *
poŞ
, 
up
, 
´im¬y
);

2300 
	gOSDM­
::
_pg_to_up_aùšg_osds
(

2301 cÚ¡ 
pg_t
& 
pg
, 
veùÜ
<> *
up
, *
up_´im¬y
,

2302 
veùÜ
<> *
aùšg
, *
aùšg_´im¬y
,

2303 
boŞ
 
¿w_pg_to_pg
) const

2305 cÚ¡ 
pg_poŞ_t
 *
	gpoŞ
 = 
g‘_pg_poŞ
(
pg
.
poŞ
());

2306 ià(!
	gpoŞ
 ||

2307 (!
	g¿w_pg_to_pg
 && 
	gpg
.
ps
(è>ğ
poŞ
->
g‘_pg_num
())) {

2308 ià(
up
)

2309 
up
->
ş—r
();

2310 ià(
	gup_´im¬y
)

2311 *
	gup_´im¬y
 = -1;

2312 ià(
	gaùšg
)

2313 
	gaùšg
->
ş—r
();

2314 ià(
	gaùšg_´im¬y
)

2315 *
	gaùšg_´im¬y
 = -1;

2318 
	gveùÜ
<> 
	g¿w
;

2319 
	gveùÜ
<> 
	g_up
;

2320 
	gveùÜ
<> 
	g_aùšg
;

2321 
	g_up_´im¬y
;

2322 
	g_aùšg_´im¬y
;

2323 
ps_t
 
	gµs
;

2324 
_g‘_‹mp_osds
(*
poŞ
, 
pg
, &
_aùšg
, &
_aùšg_´im¬y
);

2325 ià(
	g_aùšg
.
em±y
(è|| 
	gup
 || 
	gup_´im¬y
) {

2326 
_pg_to_¿w_osds
(*
poŞ
, 
pg
, &
¿w
, &
µs
);

2327 
_­¶y_upm­
(*
poŞ
, 
pg
, &
¿w
);

2328 
_¿w_to_up_osds
(*
poŞ
, 
¿w
, &
_up
);

2329 
	g_up_´im¬y
 = 
_pick_´im¬y
(
_up
);

2330 
_­¶y_´im¬y_affš™y
(
µs
, *
poŞ
, &
_up
, &
_up_´im¬y
);

2331 ià(
	g_aùšg
.
em±y
()) {

2332 
	g_aùšg
 = 
_up
;

2333 ià(
	g_aùšg_´im¬y
 == -1) {

2334 
_aùšg_´im¬y
 = 
_up_´im¬y
;

2338 ià(
	gup
)

2339 
	gup
->
sw­
(
_up
);

2340 ià(
	gup_´im¬y
)

2341 *
	gup_´im¬y
 = 
_up_´im¬y
;

2344 ià(
	gaùšg
)

2345 
	gaùšg
->
sw­
(
_aùšg
);

2346 ià(
	gaùšg_´im¬y
)

2347 *
	gaùšg_´im¬y
 = 
_aùšg_´im¬y
;

2350 
	gOSDM­
::
ÿlc_pg_¿nk
(
osd
, cÚ¡ 
veùÜ
<>& 
aùšg
, 
Ä•
)

2352 ià(!
	gÄ•
)

2353 
	gÄ•
 = 
aùšg
.
size
();

2354 
	gi
=0; i<
	gÄ•
; i++)

2355 ià(
	gaùšg
[
i
] =ğ
osd
)

2356  
i
;

2360 
	gOSDM­
::
ÿlc_pg_rŞe
(
osd
, cÚ¡ 
veùÜ
<>& 
aùšg
, 
Ä•
)

2362  
ÿlc_pg_¿nk
(
osd
, 
aùšg
, 
Ä•
);

2365 
boŞ
 
	gOSDM­
::
´im¬y_chªged
(

2366 
Şd´im¬y
,

2367 cÚ¡ 
veùÜ
<> &
Şdaùšg
,

2368 
Ãw´im¬y
,

2369 cÚ¡ 
veùÜ
<> &
Ãwaùšg
)

2371 ià(
	gŞdaùšg
.
em±y
(è&& 
	gÃwaùšg
.empty())

2372  
	gçl£
;

2373 ià(
	gŞdaùšg
.
em±y
(è^ 
	gÃwaùšg
.empty())

2374  
	gŒue
;

2375 ià(
	gŞd´im¬y
 !ğ
Ãw´im¬y
)

2376  
Œue
;

2377 ià(
ÿlc_pg_¿nk
(
Şd´im¬y
, 
Şdaùšg
) !=

2378 
ÿlc_pg_¿nk
(
Ãw´im¬y
, 
Ãwaùšg
))

2379  
	gŒue
;

2380  
	gçl£
;

2383 
ušt64_t
 
	gOSDM­
::
	$g‘_’codšg_ã©u»s
() const

2385 
ušt64_t
 
f
 = 
SIGNIFICANT_FEATURES
;

2386 ià(
»quœe_osd_»Ëa£
 < 
CEPH_RELEASE_MIMIC
) {

2387 
f
 &ğ~
CEPH_FEATURE_SERVER_MIMIC
;

2389 ià(
»quœe_osd_»Ëa£
 < 
CEPH_RELEASE_LUMINOUS
) {

2390 
f
 &ğ~(
CEPH_FEATURE_SERVER_LUMINOUS
 |

2391 
CEPH_FEATURE_CRUSH_CHOOSE_ARGS
);

2393 ià(
»quœe_osd_»Ëa£
 < 
CEPH_RELEASE_KRAKEN
) {

2394 
f
 &ğ~(
CEPH_FEATURE_SERVER_KRAKEN
 |

2395 
CEPH_FEATURE_MSG_ADDR2
 |

2396 
CEPH_FEATURE_CRUSH_TUNABLES5
);

2398 ià(
»quœe_osd_»Ëa£
 < 
CEPH_RELEASE_JEWEL
) {

2399 
f
 &ğ~(
CEPH_FEATURE_SERVER_JEWEL
 |

2400 
CEPH_FEATURE_NEW_OSDOP_ENCODING
);

2402  
f
;

2403 
	}
}

2406 
	gOSDM­
::
	$’code_ş›Á_Şd
(
bufã¾i¡
& 
bl
) const

2408 
usšg
 
ûph
::
’code
;

2409 
__u16
 
v
 = 5;

2410 
	`’code
(
v
, 
bl
);

2413 
	`’code
(
fsid
, 
bl
);

2414 
	`’code
(
•och
, 
bl
);

2415 
	`’code
(
ü—‹d
, 
bl
);

2416 
	`’code
(
modif›d
, 
bl
);

2419 
__u32
 
n
 = 
poŞs
.
	`size
();

2420 
	`’code
(
n
, 
bl
);

2422 cÚ¡‡utØ&
poŞ
 : 
poŞs
) {

2423 
n
 = 
poŞ
.
fœ¡
;

2424 
	`’code
(
n
, 
bl
);

2425 
	`’code
(
poŞ
.
£cÚd
, 
bl
, 0);

2428 
n
 = 
poŞ_Çme
.
	`size
();

2429 
	`’code
(
n
, 
bl
);

2430 cÚ¡‡utØ&
²ame
 : 
poŞ_Çme
) {

2431 
n
 = 
²ame
.
fœ¡
;

2432 
	`’code
(
n
, 
bl
);

2433 
	`’code
(
²ame
.
£cÚd
, 
bl
);

2436 
n
 = 
poŞ_max
;

2437 
	`’code
(
n
, 
bl
);

2439 
	`’code
(
æags
, 
bl
);

2441 
	`’code
(
max_osd
, 
bl
);

2443 
ušt32_t
 
n
 = 
osd_¡©e
.
	`size
();

2444 
	`’code
(
n
, 
bl
);

2445 autØ
s
 : 
osd_¡©e
) {

2446 
	`’code
((
ušt8_t
)
s
, 
bl
);

2449 
	`’code
(
osd_weight
, 
bl
);

2450 
	`’code
(
osd_addrs
->
ş›Á_addr
, 
bl
, 0);

2453 
n
 = 
pg_‹mp
->
	`size
();

2454 
	`’code
(
n
, 
bl
);

2455 cÚ¡‡utØ
pg
 : *
pg_‹mp
) {

2456 
Şd_pg_t
 
İg
 = 
pg
.
fœ¡
.
	`g‘_Şd_pg
();

2457 
	`’code
(
İg
, 
bl
);

2458 
	`’code
(
pg
.
£cÚd
, 
bl
);

2462 
bufã¾i¡
 
cbl
;

2463 
üush
->
	`’code
(
cbl
, 0 );

2464 
	`’code
(
cbl
, 
bl
);

2465 
	}
}

2467 
	gOSDM­
::
	$’code_şassic
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
) const

2469 
usšg
 
ûph
::
’code
;

2470 ià((
ã©u»s
 & 
CEPH_FEATURE_PGID64
) == 0) {

2471 
	`’code_ş›Á_Şd
(
bl
);

2475 
__u16
 
v
 = 6;

2476 
	`’code
(
v
, 
bl
);

2479 
	`’code
(
fsid
, 
bl
);

2480 
	`’code
(
•och
, 
bl
);

2481 
	`’code
(
ü—‹d
, 
bl
);

2482 
	`’code
(
modif›d
, 
bl
);

2484 
	`’code
(
poŞs
, 
bl
, 
ã©u»s
);

2485 
	`’code
(
poŞ_Çme
, 
bl
);

2486 
	`’code
(
poŞ_max
, 
bl
);

2488 
	`’code
(
æags
, 
bl
);

2490 
	`’code
(
max_osd
, 
bl
);

2492 
ušt32_t
 
n
 = 
osd_¡©e
.
	`size
();

2493 
	`’code
(
n
, 
bl
);

2494 autØ
s
 : 
osd_¡©e
) {

2495 
	`’code
((
ušt8_t
)
s
, 
bl
);

2498 
	`’code
(
osd_weight
, 
bl
);

2499 
	`’code
(
osd_addrs
->
ş›Á_addr
, 
bl
, 
ã©u»s
);

2501 
	`’code
(*
pg_‹mp
, 
bl
);

2504 
bufã¾i¡
 
cbl
;

2505 
üush
->
	`’code
(
cbl
, 0 );

2506 
	`’code
(
cbl
, 
bl
);

2509 
__u16
 
ev
 = 10;

2510 
	`’code
(
ev
, 
bl
);

2511 
	`’code
(
osd_addrs
->
hb_back_addr
, 
bl
, 
ã©u»s
);

2512 
	`’code
(
osd_šfo
, 
bl
);

2513 
	`’code
(
bÏckli¡
, 
bl
, 
ã©u»s
);

2514 
	`’code
(
osd_addrs
->
şu¡”_addr
, 
bl
, 
ã©u»s
);

2515 
	`’code
(
şu¡”_¢­shÙ_•och
, 
bl
);

2516 
	`’code
(
şu¡”_¢­shÙ
, 
bl
);

2517 
	`’code
(*
osd_uuid
, 
bl
);

2518 
	`’code
(
osd_xšfo
, 
bl
);

2519 
	`’code
(
osd_addrs
->
hb_äÚt_addr
, 
bl
, 
ã©u»s
);

2520 
	}
}

2522 
	gOSDM­
::
	$’code
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
) const

2524 
usšg
 
ûph
::
’code
;

2525 ià((
ã©u»s
 & 
CEPH_FEATURE_OSDMAP_ENC
) == 0) {

2526 
	`’code_şassic
(
bl
, 
ã©u»s
);

2534 
	`as£¹
(
ã©u»s
 & 
CEPH_FEATURE_RESERVED
);

2535 
ã©u»s
 &ğ~
CEPH_FEATURE_RESERVED
;

2537 
size_t
 
¡¬t_off£t
 = 
bl
.
	`Ëngth
();

2538 
size_t
 
_off£t
;

2539 
bufãr
::
li¡
::
™”©Ü
 
üc_™
;

2542 
	`ENCODE_START
(8, 7, 
bl
);

2547 
ušt8_t
 
v
 = 7;

2548 ià(!
	`HAVE_FEATURE
(
ã©u»s
, 
SERVER_LUMINOUS
)) {

2549 
v
 = 3;

2550 } ià(!
	`HAVE_FEATURE
(
ã©u»s
, 
SERVER_MIMIC
)) {

2551 
v
 = 6;

2553 
	`ENCODE_START
(
v
, 1, 
bl
);

2555 
	`’code
(
fsid
, 
bl
);

2556 
	`’code
(
•och
, 
bl
);

2557 
	`’code
(
ü—‹d
, 
bl
);

2558 
	`’code
(
modif›d
, 
bl
);

2560 
	`’code
(
poŞs
, 
bl
, 
ã©u»s
);

2561 
	`’code
(
poŞ_Çme
, 
bl
);

2562 
	`’code
(
poŞ_max
, 
bl
);

2564 ià(
v
 < 4) {

2565 
	`deşty³
(
æags
è
f
 = flags;

2566 ià(
»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_LUMINOUS
)

2567 
f
 |ğ
CEPH_OSDMAP_REQUIRE_LUMINOUS
 | 
CEPH_OSDMAP_RECOVERY_DELETES
;

2568 ià(
»quœe_osd_»Ëa£
 =ğ
CEPH_RELEASE_KRAKEN
)

2569 
f
 |ğ
CEPH_OSDMAP_REQUIRE_KRAKEN
;

2570 ià(
»quœe_osd_»Ëa£
 =ğ
CEPH_RELEASE_JEWEL
)

2571 
f
 |ğ
CEPH_OSDMAP_REQUIRE_JEWEL
;

2572 
	`’code
(
f
, 
bl
);

2574 
	`’code
(
æags
, 
bl
);

2577 
	`’code
(
max_osd
, 
bl
);

2578 ià(
v
 >= 5) {

2579 
	`’code
(
osd_¡©e
, 
bl
);

2581 
ušt32_t
 
n
 = 
osd_¡©e
.
	`size
();

2582 
	`’code
(
n
, 
bl
);

2583 autØ
s
 : 
osd_¡©e
) {

2584 
	`’code
((
ušt8_t
)
s
, 
bl
);

2587 
	`’code
(
osd_weight
, 
bl
);

2588 
	`’code
(
osd_addrs
->
ş›Á_addr
, 
bl
, 
ã©u»s
);

2590 
	`’code
(*
pg_‹mp
, 
bl
);

2591 
	`’code
(*
´im¬y_‹mp
, 
bl
);

2592 ià(
osd_´im¬y_affš™y
) {

2593 
	`’code
(*
osd_´im¬y_affš™y
, 
bl
);

2595 
veùÜ
<
__u32
> 
v
;

2596 
	`’code
(
v
, 
bl
);

2600 
bufã¾i¡
 
cbl
;

2601 
üush
->
	`’code
(
cbl
, 
ã©u»s
);

2602 
	`’code
(
cbl
, 
bl
);

2603 
	`’code
(
”asu»_code_´ofes
, 
bl
);

2605 ià(
v
 >= 4) {

2606 
	`’code
(
pg_upm­
, 
bl
);

2607 
	`’code
(
pg_upm­_™ems
, 
bl
);

2609 
	`as£¹
(
pg_upm­
.
	`em±y
());

2610 
	`as£¹
(
pg_upm­_™ems
.
	`em±y
());

2612 ià(
v
 >= 6) {

2613 
	`’code
(
üush_v”siÚ
, 
bl
);

2615 ià(
v
 >= 7) {

2616 
	`’code
(
Ãw_»moved_¢­s
, 
bl
);

2617 
	`’code
(
Ãw_purged_¢­s
, 
bl
);

2619 
	`ENCODE_FINISH
(
bl
);

2625 
ušt8_t
 
rg‘_v
 = 6;

2626 ià(!
	`HAVE_FEATURE
(
ã©u»s
, 
SERVER_LUMINOUS
)) {

2627 
rg‘_v
 = 1;

2628 } ià(!
	`HAVE_FEATURE
(
ã©u»s
, 
SERVER_MIMIC
)) {

2629 
rg‘_v
 = 5;

2631 
	`ENCODE_START
(
rg‘_v
, 1, 
bl
);

2632 
	`’code
(
osd_addrs
->
hb_back_addr
, 
bl
, 
ã©u»s
);

2633 
	`’code
(
osd_šfo
, 
bl
);

2637 
m­
<
’t™y_addr_t
,
utime_t
> 
bÏckli¡_m­
;

2638 cÚ¡‡utØ&
addr
 : 
bÏckli¡
)

2639 
bÏckli¡_m­
.
	`š£¹
(
	`make_·œ
(
addr
.
fœ¡
,‡ddr.
£cÚd
));

2640 
	`’code
(
bÏckli¡_m­
, 
bl
, 
ã©u»s
);

2642 
	`’code
(
osd_addrs
->
şu¡”_addr
, 
bl
, 
ã©u»s
);

2643 
	`’code
(
şu¡”_¢­shÙ_•och
, 
bl
);

2644 
	`’code
(
şu¡”_¢­shÙ
, 
bl
);

2645 
	`’code
(*
osd_uuid
, 
bl
);

2646 
	`’code
(
osd_xšfo
, 
bl
);

2647 
	`’code
(
osd_addrs
->
hb_äÚt_addr
, 
bl
, 
ã©u»s
);

2648 ià(
rg‘_v
 >= 2) {

2649 
	`’code
(
Ã¬fuÎ_¿tio
, 
bl
);

2650 
	`’code
(
fuÎ_¿tio
, 
bl
);

2651 
	`’code
(
backflfuÎ_¿tio
, 
bl
);

2654 ià(
rg‘_v
 >= 5) {

2655 
	`’code
(
»quœe_mš_com·t_ş›Á
, 
bl
);

2656 
	`’code
(
»quœe_osd_»Ëa£
, 
bl
);

2658 ià(
rg‘_v
 >= 6) {

2659 
	`’code
(
»moved_¢­s_queue
, 
bl
);

2661 
	`ENCODE_FINISH
(
bl
);

2664 
	`’code
((
ušt32_t
)0, 
bl
);

2665 
üc_™
 = 
bl
.
	`’d
();

2666 
üc_™
.
	`advªû
(-4);

2667 
_off£t
 = 
bl
.
	`Ëngth
();

2669 
	`ENCODE_FINISH
(
bl
);

2672 
bufã¾i¡
 
äÚt
;

2673 
äÚt
.
	`sub¡r_of
(
bl
, 
¡¬t_off£t
, 
üc_™
.
	`g‘_off
() - start_offset);

2674 
üc
 = 
äÚt
.
	`üc32c
(-1);

2675 ià(
_off£t
 < 
bl
.
	`Ëngth
()) {

2676 
bufã¾i¡
 

;

2677 

.
	`sub¡r_of
(
bl
, 
_off£t
, bl.
	`Ëngth
() -ail_offset);

2678 
üc
 = 

.
	`üc32c
(crc);

2680 
ûph_Ë32
 
üc_Ë
;

2681 
üc_Ë
 = 
üc
;

2682 
üc_™
.
	`cİy_š
(4, (*)&
üc_Ë
);

2683 
üc_defšed
 = 
Œue
;

2684 
	}
}

2686 
	gOSDM­
::
	$decode
(
bufã¾i¡
& 
bl
)

2688 autØ
p
 = 
bl
.
	`begš
();

2689 
	`decode
(
p
);

2690 
	}
}

2692 
	gOSDM­
::
	$decode_şassic
(
bufã¾i¡
::
™”©Ü
& 
p
)

2694 
usšg
 
ûph
::
decode
;

2695 
__u32
 
n
, 
t
;

2696 
__u16
 
v
;

2697 
	`decode
(
v
, 
p
);

2700 
	`decode
(
fsid
, 
p
);

2701 
	`decode
(
•och
, 
p
);

2702 
	`decode
(
ü—‹d
, 
p
);

2703 
	`decode
(
modif›d
, 
p
);

2705 ià(
v
 < 6) {

2706 ià(
v
 < 4) {

2707 
št32_t
 
max_poŞs
 = 0;

2708 
	`decode
(
max_poŞs
, 
p
);

2709 
poŞ_max
 = 
max_poŞs
;

2711 
poŞs
.
	`ş—r
();

2712 
	`decode
(
n
, 
p
);

2713 
n
--) {

2714 
	`decode
(
t
, 
p
);

2715 
	`decode
(
poŞs
[
t
], 
p
);

2717 ià(
v
 == 4) {

2718 
	`decode
(
n
, 
p
);

2719 
poŞ_max
 = 
n
;

2720 } ià(
v
 == 5) {

2721 
poŞ_Çme
.
	`ş—r
();

2722 
	`decode
(
n
, 
p
);

2723 
n
--) {

2724 
	`decode
(
t
, 
p
);

2725 
	`decode
(
poŞ_Çme
[
t
], 
p
);

2727 
	`decode
(
n
, 
p
);

2728 
poŞ_max
 = 
n
;

2731 
	`decode
(
poŞs
, 
p
);

2732 
	`decode
(
poŞ_Çme
, 
p
);

2733 
	`decode
(
poŞ_max
, 
p
);

2736 ià(
poŞs
.
	`size
(è&& 
poŞ_max
 <…oŞs.
	`rbegš
()->
fœ¡
) {

2737 
poŞ_max
 = 
poŞs
.
	`rbegš
()->
fœ¡
;

2740 
	`decode
(
æags
, 
p
);

2742 
	`decode
(
max_osd
, 
p
);

2744 
veùÜ
<
ušt8_t
> 
os
;

2745 
	`decode
(
os
, 
p
);

2746 
osd_¡©e
.
	`»size
(
os
.
	`size
());

2747 
i
 = 0; i < 
os
.
	`size
(); ++i) {

2748 
osd_¡©e
[
i
] = 
os
[i];

2751 
	`decode
(
osd_weight
, 
p
);

2752 
	`decode
(
osd_addrs
->
ş›Á_addr
, 
p
);

2753 ià(
v
 <= 5) {

2754 
pg_‹mp
->
	`ş—r
();

2755 
	`decode
(
n
, 
p
);

2756 
n
--) {

2757 
Şd_pg_t
 
İg
;

2758 ::
	`decode_¿w
(
İg
, 
p
);

2759 
mempoŞ
::
osdm­
::
veùÜ
<
št32_t
> 
v
;

2760 
	`decode
(
v
, 
p
);

2761 
pg_‹mp
->
	`£t
(
	`pg_t
(
İg
), 
v
);

2764 
	`decode
(*
pg_‹mp
, 
p
);

2768 
bufã¾i¡
 
cbl
;

2769 
	`decode
(
cbl
, 
p
);

2770 autØ
cbÍ
 = 
cbl
.
	`begš
();

2771 
üush
->
	`decode
(
cbÍ
);

2774 
__u16
 
ev
 = 0;

2775 ià(
v
 >= 5)

2776 
	`decode
(
ev
, 
p
);

2777 
	`decode
(
osd_addrs
->
hb_back_addr
, 
p
);

2778 
	`decode
(
osd_šfo
, 
p
);

2779 ià(
v
 < 5)

2780 
	`decode
(
poŞ_Çme
, 
p
);

2782 
	`decode
(
bÏckli¡
, 
p
);

2783 ià(
ev
 >= 6)

2784 
	`decode
(
osd_addrs
->
şu¡”_addr
, 
p
);

2786 
osd_addrs
->
şu¡”_addr
.
	`»size
(osd_addrs->
ş›Á_addr
.
	`size
());

2788 ià(
ev
 >= 7) {

2789 
	`decode
(
şu¡”_¢­shÙ_•och
, 
p
);

2790 
	`decode
(
şu¡”_¢­shÙ
, 
p
);

2793 ià(
ev
 >= 8) {

2794 
	`decode
(*
osd_uuid
, 
p
);

2796 
osd_uuid
->
	`»size
(
max_osd
);

2798 ià(
ev
 >= 9)

2799 
	`decode
(
osd_xšfo
, 
p
);

2801 
osd_xšfo
.
	`»size
(
max_osd
);

2803 ià(
ev
 >= 10)

2804 
	`decode
(
osd_addrs
->
hb_äÚt_addr
, 
p
);

2806 
osd_addrs
->
hb_äÚt_addr
.
	`»size
(osd_addrs->
hb_back_addr
.
	`size
());

2808 
osd_´im¬y_affš™y
.
	`»£t
();

2810 
	`po¡_decode
();

2811 
	}
}

2813 
	gOSDM­
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
)

2815 
usšg
 
ûph
::
decode
;

2823 
size_t
 
¡¬t_off£t
 = 
bl
.
	`g‘_off
();

2824 
size_t
 
_off£t
 = 0;

2825 
bufã¾i¡
 
üc_äÚt
, 
üc_
;

2827 
	`DECODE_START_LEGACY_COMPAT_LEN
(8, 7, 7, 
bl
);

2828 ià(
¡ruù_v
 < 7) {

2829 
¡ruù_v_size
 = (
¡ruù_v
);

2830 
bl
.
	`advªû
(-
¡ruù_v_size
);

2831 
	`decode_şassic
(
bl
);

2838 
	`DECODE_START
(7, 
bl
);

2840 
	`decode
(
fsid
, 
bl
);

2841 
	`decode
(
•och
, 
bl
);

2842 
	`decode
(
ü—‹d
, 
bl
);

2843 
	`decode
(
modif›d
, 
bl
);

2845 
	`decode
(
poŞs
, 
bl
);

2846 
	`decode
(
poŞ_Çme
, 
bl
);

2847 
	`decode
(
poŞ_max
, 
bl
);

2849 
	`decode
(
æags
, 
bl
);

2851 
	`decode
(
max_osd
, 
bl
);

2852 ià(
¡ruù_v
 >= 5) {

2853 
	`decode
(
osd_¡©e
, 
bl
);

2855 
veùÜ
<
ušt8_t
> 
os
;

2856 
	`decode
(
os
, 
bl
);

2857 
osd_¡©e
.
	`»size
(
os
.
	`size
());

2858 
i
 = 0; i < 
os
.
	`size
(); ++i) {

2859 
osd_¡©e
[
i
] = 
os
[i];

2862 
	`decode
(
osd_weight
, 
bl
);

2863 
	`decode
(
osd_addrs
->
ş›Á_addr
, 
bl
);

2865 
	`decode
(*
pg_‹mp
, 
bl
);

2866 
	`decode
(*
´im¬y_‹mp
, 
bl
);

2867 ià(
¡ruù_v
 >= 2) {

2868 
osd_´im¬y_affš™y
.
	`»£t
(
Ãw
 
mempoŞ
::
osdm­
::
veùÜ
<
__u32
>);

2869 
	`decode
(*
osd_´im¬y_affš™y
, 
bl
);

2870 ià(
osd_´im¬y_affš™y
->
	`em±y
())

2871 
osd_´im¬y_affš™y
.
	`»£t
();

2873 
osd_´im¬y_affš™y
.
	`»£t
();

2877 
bufã¾i¡
 
cbl
;

2878 
	`decode
(
cbl
, 
bl
);

2879 autØ
cbÍ
 = 
cbl
.
	`begš
();

2880 
üush
->
	`decode
(
cbÍ
);

2881 ià(
¡ruù_v
 >= 3) {

2882 
	`decode
(
”asu»_code_´ofes
, 
bl
);

2884 
”asu»_code_´ofes
.
	`ş—r
();

2886 ià(
¡ruù_v
 >= 4) {

2887 
	`decode
(
pg_upm­
, 
bl
);

2888 
	`decode
(
pg_upm­_™ems
, 
bl
);

2890 
pg_upm­
.
	`ş—r
();

2891 
pg_upm­_™ems
.
	`ş—r
();

2893 ià(
¡ruù_v
 >= 6) {

2894 
	`decode
(
üush_v”siÚ
, 
bl
);

2896 ià(
¡ruù_v
 >= 7) {

2897 
	`decode
(
Ãw_»moved_¢­s
, 
bl
);

2898 
	`decode
(
Ãw_purged_¢­s
, 
bl
);

2900 
	`DECODE_FINISH
(
bl
);

2904 
	`DECODE_START
(6, 
bl
);

2905 
	`decode
(
osd_addrs
->
hb_back_addr
, 
bl
);

2906 
	`decode
(
osd_šfo
, 
bl
);

2907 
	`decode
(
bÏckli¡
, 
bl
);

2908 
	`decode
(
osd_addrs
->
şu¡”_addr
, 
bl
);

2909 
	`decode
(
şu¡”_¢­shÙ_•och
, 
bl
);

2910 
	`decode
(
şu¡”_¢­shÙ
, 
bl
);

2911 
	`decode
(*
osd_uuid
, 
bl
);

2912 
	`decode
(
osd_xšfo
, 
bl
);

2913 
	`decode
(
osd_addrs
->
hb_äÚt_addr
, 
bl
);

2914 ià(
¡ruù_v
 >= 2) {

2915 
	`decode
(
Ã¬fuÎ_¿tio
, 
bl
);

2916 
	`decode
(
fuÎ_¿tio
, 
bl
);

2918 
Ã¬fuÎ_¿tio
 = 0;

2919 
fuÎ_¿tio
 = 0;

2921 ià(
¡ruù_v
 >= 3) {

2922 
	`decode
(
backflfuÎ_¿tio
, 
bl
);

2924 
backflfuÎ_¿tio
 = 0;

2926 ià(
¡ruù_v
 == 4) {

2927 
¡ršg
 
r
;

2928 
	`decode
(
r
, 
bl
);

2929 ià(
r
.
	`Ëngth
())

2930 
»quœe_mš_com·t_ş›Á
 = 
	`ûph_»Ëa£_äom_Çme
(
r
.
	`c_¡r
());

2932 ià(
¡ruù_v
 >= 5) {

2933 
	`decode
(
»quœe_mš_com·t_ş›Á
, 
bl
);

2934 
	`decode
(
»quœe_osd_»Ëa£
, 
bl
);

2935 ià(
»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_LUMINOUS
) {

2936 
æags
 &ğ~(
CEPH_OSDMAP_LEGACY_REQUIRE_FLAGS
);

2937 
æags
 |ğ
CEPH_OSDMAP_RECOVERY_DELETES
;

2940 ià(
æags
 & 
CEPH_OSDMAP_REQUIRE_LUMINOUS
) {

2942 
»quœe_osd_»Ëa£
 = 
CEPH_RELEASE_LUMINOUS
;

2943 
æags
 &ğ~(
CEPH_OSDMAP_LEGACY_REQUIRE_FLAGS
);

2944 
æags
 |ğ
CEPH_OSDMAP_RECOVERY_DELETES
;

2945 } ià(
æags
 & 
CEPH_OSDMAP_REQUIRE_KRAKEN
) {

2946 
»quœe_osd_»Ëa£
 = 
CEPH_RELEASE_KRAKEN
;

2947 } ià(
æags
 & 
CEPH_OSDMAP_REQUIRE_JEWEL
) {

2948 
»quœe_osd_»Ëa£
 = 
CEPH_RELEASE_JEWEL
;

2950 
»quœe_osd_»Ëa£
 = 0;

2953 ià(
¡ruù_v
 >= 6) {

2954 
	`decode
(
»moved_¢­s_queue
, 
bl
);

2956 
	`DECODE_FINISH
(
bl
);

2959 ià(
¡ruù_v
 >= 8) {

2960 
üc_äÚt
.
	`sub¡r_of
(
bl
.
	`g‘_bl
(), 
¡¬t_off£t
, bl.
	`g‘_off
() - start_offset);

2961 
	`decode
(
üc
, 
bl
);

2962 
_off£t
 = 
bl
.
	`g‘_off
();

2963 
üc_defšed
 = 
Œue
;

2965 
üc_defšed
 = 
çl£
;

2966 
üc
 = 0;

2969 
	`DECODE_FINISH
(
bl
);

2971 ià(
_off£t
) {

2973 
ušt32_t
 
aùu®
 = 
üc_äÚt
.
	`üc32c
(-1);

2974 ià(
_off£t
 < 
bl
.
	`g‘_off
()) {

2975 
bufã¾i¡
 

;

2976 

.
	`sub¡r_of
(
bl
.
	`g‘_bl
(), 
_off£t
, bl.
	`g‘_off
() -ail_offset);

2977 
aùu®
 = 

.
	`üc32c
(actual);

2979 ià(
üc
 !ğ
aùu®
) {

2980 
o¡ršg¡»am
 
ss
;

2981 
ss
 << "bad crc,‡ùu® " << 
aùu®
 << " !ğex³ùed " << 
üc
;

2982 
¡ršg
 
s
 = 
ss
.
	`¡r
();

2983 
throw
 
bufãr
::
	`m®fÜmed_šput
(
s
.
	`c_¡r
());

2987 
	`po¡_decode
();

2988 
	}
}

2990 
	gOSDM­
::
	$po¡_decode
()

2993 
Çme_poŞ
.
	`ş—r
();

2994 cÚ¡‡utØ&
²ame
 : 
poŞ_Çme
) {

2995 
Çme_poŞ
[
²ame
.
£cÚd
] =…Çme.
fœ¡
;

2998 
	`ÿlc_num_osds
();

2999 
	`_ÿlc_up_osd_ã©u»s
();

3000 
	}
}

3002 
	gOSDM­
::
dump_”asu»_code_´ofes
(

3003 cÚ¡ 
mempoŞ
::
osdm­
::
m­
<
¡ršg
,m­<¡ršg,¡ršg>>& 
´ofes
,

3004 
FÜm©‹r
 *
f
)

3006 
	gf
->
İ’_objeù_£ùiÚ
("erasure_code_profiles");

3007 cÚ¡‡utØ&
	g´ofe
 : 
´ofes
) {

3008 
f
->
İ’_objeù_£ùiÚ
(
´ofe
.
fœ¡
.
c_¡r
());

3009 cÚ¡‡utØ&
	g´ofm
 : 
´ofe
.
£cÚd
) {

3010 
f
->
dump_¡ršg
(
´ofm
.
fœ¡
.
c_¡r
(),…rofm.
£cÚd
.c_str());

3012 
	gf
->
şo£_£ùiÚ
();

3014 
	gf
->
şo£_£ùiÚ
();

3017 
	gOSDM­
::
	$dump
(
FÜm©‹r
 *
f
) const

3019 
f
->
	`dump_št
("•och", 
	`g‘_•och
());

3020 
f
->
	`dump_¡»am
("fsid"è<< 
	`g‘_fsid
();

3021 
f
->
	`dump_¡»am
("ü—‹d"è<< 
	`g‘_ü—‹d
();

3022 
f
->
	`dump_¡»am
("modif›d"è<< 
	`g‘_modif›d
();

3023 
f
->
	`dump_¡ršg
("æags", 
	`g‘_æag_¡ršg
());

3024 
f
->
	`dump_unsigÃd
("æags_num", 
æags
);

3025 
f
->
	`İ’_¬¿y_£ùiÚ
("flags_set");

3026 
£t
<
¡ršg
> 
æag£t
;

3027 
	`g‘_æag_£t
(&
æag£t
);

3028 autØ
p
 : 
æag£t
) {

3029 
f
->
	`dump_¡ršg
("æag", 
p
);

3031 
f
->
	`şo£_£ùiÚ
();

3032 
f
->
	`dump_unsigÃd
("üush_v”siÚ", 
	`g‘_üush_v”siÚ
());

3033 
f
->
	`dump_æßt
("fuÎ_¿tio", 
fuÎ_¿tio
);

3034 
f
->
	`dump_æßt
("backflfuÎ_¿tio", 
backflfuÎ_¿tio
);

3035 
f
->
	`dump_æßt
("Ã¬fuÎ_¿tio", 
Ã¬fuÎ_¿tio
);

3036 
f
->
	`dump_¡ršg
("şu¡”_¢­shÙ", 
	`g‘_şu¡”_¢­shÙ
());

3037 
f
->
	`dump_št
("poŞ_max", 
	`g‘_poŞ_max
());

3038 
f
->
	`dump_št
("max_osd", 
	`g‘_max_osd
());

3039 
f
->
	`dump_¡ršg
("require_min_compat_client",

3040 
	`ûph_»Ëa£_Çme
(
»quœe_mš_com·t_ş›Á
));

3041 
f
->
	`dump_¡ršg
("min_compat_client",

3042 
	`ûph_»Ëa£_Çme
(
	`g‘_mš_com·t_ş›Á
()));

3043 
f
->
	`dump_¡ršg
("require_osd_release",

3044 
	`ûph_»Ëa£_Çme
(
»quœe_osd_»Ëa£
));

3046 
f
->
	`İ’_¬¿y_£ùiÚ
("pools");

3047 cÚ¡‡utØ&
poŞ
 : 
poŞs
) {

3048 
¡d
::
¡ršg
 
	`Çme
("<unknown>");

3049 cÚ¡‡utØ&
²i
 = 
poŞ_Çme
.
	`fšd
(
poŞ
.
fœ¡
);

3050 ià(
²i
 !ğ
poŞ_Çme
.
	`’d
())

3051 
Çme
 = 
²i
->
£cÚd
;

3052 
f
->
	`İ’_objeù_£ùiÚ
("pool");

3053 
f
->
	`dump_št
("poŞ", 
poŞ
.
fœ¡
);

3054 
f
->
	`dump_¡ršg
("poŞ_Çme", 
Çme
);

3055 
poŞ
.
£cÚd
.
	`dump
(
f
);

3056 
f
->
	`şo£_£ùiÚ
();

3058 
f
->
	`şo£_£ùiÚ
();

3060 
f
->
	`İ’_¬¿y_£ùiÚ
("osds");

3061 
i
=0; i<
	`g‘_max_osd
(); i++)

3062 ià(
	`exi¡s
(
i
)) {

3063 
f
->
	`İ’_objeù_£ùiÚ
("osd_info");

3064 
f
->
	`dump_št
("osd", 
i
);

3065 
f
->
	`dump_¡»am
("uuid"è<< 
	`g‘_uuid
(
i
);

3066 
f
->
	`dump_št
("up", 
	`is_up
(
i
));

3067 
f
->
	`dump_št
("š", 
	`is_š
(
i
));

3068 
f
->
	`dump_æßt
("weight", 
	`g‘_weightf
(
i
));

3069 
f
->
	`dump_æßt
("´im¬y_affš™y", 
	`g‘_´im¬y_affš™yf
(
i
));

3070 
	`g‘_šfo
(
i
).
	`dump
(
f
);

3071 
f
->
	`dump_¡»am
("public_addr"è<< 
	`g‘_addr
(
i
);

3072 
f
->
	`dump_¡»am
("şu¡”_addr"è<< 
	`g‘_şu¡”_addr
(
i
);

3073 
f
->
	`dump_¡»am
("h—¹b—t_back_addr"è<< 
	`g‘_hb_back_addr
(
i
);

3074 
f
->
	`dump_¡»am
("h—¹b—t_äÚt_addr"è<< 
	`g‘_hb_äÚt_addr
(
i
);

3076 
£t
<
¡ršg
> 
¡
;

3077 
	`g‘_¡©e
(
i
, 
¡
);

3078 
f
->
	`İ’_¬¿y_£ùiÚ
("state");

3079 cÚ¡‡utØ&
¡©e
 : 
¡
)

3080 
f
->
	`dump_¡ršg
("¡©e", 
¡©e
);

3081 
f
->
	`şo£_£ùiÚ
();

3083 
f
->
	`şo£_£ùiÚ
();

3085 
f
->
	`şo£_£ùiÚ
();

3087 
f
->
	`İ’_¬¿y_£ùiÚ
("osd_xinfo");

3088 
i
=0; i<
	`g‘_max_osd
(); i++) {

3089 ià(
	`exi¡s
(
i
)) {

3090 
f
->
	`İ’_objeù_£ùiÚ
("xinfo");

3091 
f
->
	`dump_št
("osd", 
i
);

3092 
osd_xšfo
[
i
].
	`dump
(
f
);

3093 
f
->
	`şo£_£ùiÚ
();

3096 
f
->
	`şo£_£ùiÚ
();

3098 
f
->
	`İ’_¬¿y_£ùiÚ
("pg_upmap");

3099 auto& 
p
 : 
pg_upm­
) {

3100 
f
->
	`İ’_objeù_£ùiÚ
("mapping");

3101 
f
->
	`dump_¡»am
("pgid"è<< 
p
.
fœ¡
;

3102 
f
->
	`İ’_¬¿y_£ùiÚ
("osds");

3103 autØ
q
 : 
p
.
£cÚd
) {

3104 
f
->
	`dump_št
("osd", 
q
);

3106 
f
->
	`şo£_£ùiÚ
();

3107 
f
->
	`şo£_£ùiÚ
();

3109 
f
->
	`şo£_£ùiÚ
();

3110 
f
->
	`İ’_¬¿y_£ùiÚ
("pg_upmap_items");

3111 auto& 
p
 : 
pg_upm­_™ems
) {

3112 
f
->
	`İ’_objeù_£ùiÚ
("mapping");

3113 
f
->
	`dump_¡»am
("pgid"è<< 
p
.
fœ¡
;

3114 
f
->
	`İ’_¬¿y_£ùiÚ
("mappings");

3115 auto& 
q
 : 
p
.
£cÚd
) {

3116 
f
->
	`İ’_objeù_£ùiÚ
("mapping");

3117 
f
->
	`dump_št
("äom", 
q
.
fœ¡
);

3118 
f
->
	`dump_št
("to", 
q
.
£cÚd
);

3119 
f
->
	`şo£_£ùiÚ
();

3121 
f
->
	`şo£_£ùiÚ
();

3122 
f
->
	`şo£_£ùiÚ
();

3124 
f
->
	`şo£_£ùiÚ
();

3125 
f
->
	`İ’_¬¿y_£ùiÚ
("pg_temp");

3126 
pg_‹mp
->
	`dump
(
f
);

3127 
f
->
	`şo£_£ùiÚ
();

3129 
f
->
	`İ’_¬¿y_£ùiÚ
("primary_temp");

3130 cÚ¡‡utØ&
pg
 : *
´im¬y_‹mp
) {

3131 
f
->
	`dump_¡»am
("pgid"è<< 
pg
.
fœ¡
;

3132 
f
->
	`dump_št
("osd", 
pg
.
£cÚd
);

3134 
f
->
	`şo£_£ùiÚ
();

3136 
f
->
	`İ’_objeù_£ùiÚ
("blacklist");

3137 cÚ¡‡utØ&
addr
 : 
bÏckli¡
) {

3138 
¡ršg¡»am
 
ss
;

3139 
ss
 << 
addr
.
fœ¡
;

3140 
f
->
	`dump_¡»am
(
ss
.
	`¡r
().
	`c_¡r
()è<< 
addr
.
£cÚd
;

3142 
f
->
	`şo£_£ùiÚ
();

3144 
	`dump_”asu»_code_´ofes
(
”asu»_code_´ofes
, 
f
);

3146 
f
->
	`İ’_¬¿y_£ùiÚ
("removed_snaps_queue");

3147 auto& 
p
 : 
»moved_¢­s_queue
) {

3148 
f
->
	`İ’_objeù_£ùiÚ
("pool");

3149 
f
->
	`dump_št
("poŞ", 
p
.
fœ¡
);

3150 
f
->
	`İ’_¬¿y_£ùiÚ
("snaps");

3151 autØ
q
 = 
p
.
£cÚd
.
	`begš
(); q !ğp.£cÚd.
	`’d
(); ++q) {

3152 
f
->
	`İ’_objeù_£ùiÚ
("interval");

3153 
f
->
	`dump_unsigÃd
("begš", 
q
.
	`g‘_¡¬t
());

3154 
f
->
	`dump_unsigÃd
("Ëngth", 
q
.
	`g‘_Ën
());

3155 
f
->
	`şo£_£ùiÚ
();

3157 
f
->
	`şo£_£ùiÚ
();

3158 
f
->
	`şo£_£ùiÚ
();

3160 
f
->
	`şo£_£ùiÚ
();

3161 
f
->
	`İ’_¬¿y_£ùiÚ
("new_removed_snaps");

3162 auto& 
p
 : 
Ãw_»moved_¢­s
) {

3163 
f
->
	`İ’_objeù_£ùiÚ
("pool");

3164 
f
->
	`dump_št
("poŞ", 
p
.
fœ¡
);

3165 
f
->
	`İ’_¬¿y_£ùiÚ
("snaps");

3166 autØ
q
 = 
p
.
£cÚd
.
	`begš
(); q !ğp.£cÚd.
	`’d
(); ++q) {

3167 
f
->
	`İ’_objeù_£ùiÚ
("interval");

3168 
f
->
	`dump_unsigÃd
("begš", 
q
.
	`g‘_¡¬t
());

3169 
f
->
	`dump_unsigÃd
("Ëngth", 
q
.
	`g‘_Ën
());

3170 
f
->
	`şo£_£ùiÚ
();

3172 
f
->
	`şo£_£ùiÚ
();

3173 
f
->
	`şo£_£ùiÚ
();

3175 
f
->
	`şo£_£ùiÚ
();

3176 
f
->
	`İ’_¬¿y_£ùiÚ
("new_purged_snaps");

3177 auto& 
p
 : 
Ãw_purged_¢­s
) {

3178 
f
->
	`İ’_objeù_£ùiÚ
("pool");

3179 
f
->
	`dump_št
("poŞ", 
p
.
fœ¡
);

3180 
f
->
	`İ’_¬¿y_£ùiÚ
("snaps");

3181 autØ
q
 = 
p
.
£cÚd
.
	`begš
(); q !ğp.£cÚd.
	`’d
(); ++q) {

3182 
f
->
	`İ’_objeù_£ùiÚ
("interval");

3183 
f
->
	`dump_unsigÃd
("begš", 
q
.
	`g‘_¡¬t
());

3184 
f
->
	`dump_unsigÃd
("Ëngth", 
q
.
	`g‘_Ën
());

3185 
f
->
	`şo£_£ùiÚ
();

3187 
f
->
	`şo£_£ùiÚ
();

3188 
f
->
	`şo£_£ùiÚ
();

3190 
f
->
	`şo£_£ùiÚ
();

3191 
	}
}

3193 
	gOSDM­
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
OSDM­
*>& 
o
)

3195 
o
.
push_back
(
Ãw
 
OSDM­
);

3197 
C•hCÚ‹xt
 *
	gcù
 = 
Ãw
 C•hCÚ‹xt(
CODE_ENVIRONMENT_UTILITY
);

3198 
	go
.
push_back
(
Ãw
 
OSDM­
);

3199 
uuid_d
 
	gfsid
;

3200 
	go
.
back
()->
bud_sim¶e
(
cù
, 1, 
fsid
, 16);

3201 
	go
.
back
()->
	gü—‹d
 = 
o
.back()->
modif›d
 = 
utime_t
(1, 2);

3202 
	go
.
back
()->
	gbÏckli¡
[
’t™y_addr_t
()] = 
utime_t
(5, 6);

3203 
	gcù
->
put
();

3206 
¡ršg
 
	gOSDM­
::
	$g‘_æag_¡ršg
(
f
)

3208 
¡ršg
 
s
;

3209 iàĞ
f
& 
CEPH_OSDMAP_NEARFULL
)

3210 
s
 += ",nearfull";

3211 ià(
f
 & 
CEPH_OSDMAP_FULL
)

3212 
s
 += ",full";

3213 ià(
f
 & 
CEPH_OSDMAP_PAUSERD
)

3214 
s
 += ",pauserd";

3215 ià(
f
 & 
CEPH_OSDMAP_PAUSEWR
)

3216 
s
 += ",pausewr";

3217 ià(
f
 & 
CEPH_OSDMAP_PAUSEREC
)

3218 
s
 += ",pauserec";

3219 ià(
f
 & 
CEPH_OSDMAP_NOUP
)

3220 
s
 += ",noup";

3221 ià(
f
 & 
CEPH_OSDMAP_NODOWN
)

3222 
s
 += ",nodown";

3223 ià(
f
 & 
CEPH_OSDMAP_NOOUT
)

3224 
s
 += ",noout";

3225 ià(
f
 & 
CEPH_OSDMAP_NOIN
)

3226 
s
 += ",noin";

3227 ià(
f
 & 
CEPH_OSDMAP_NOBACKFILL
)

3228 
s
 += ",nobackfill";

3229 ià(
f
 & 
CEPH_OSDMAP_NOREBALANCE
)

3230 
s
 += ",norebalance";

3231 ià(
f
 & 
CEPH_OSDMAP_NORECOVER
)

3232 
s
 += ",norecover";

3233 ià(
f
 & 
CEPH_OSDMAP_NOSCRUB
)

3234 
s
 += ",noscrub";

3235 ià(
f
 & 
CEPH_OSDMAP_NODEEP_SCRUB
)

3236 
s
 += ",nodeep-scrub";

3237 ià(
f
 & 
CEPH_OSDMAP_NOTIERAGENT
)

3238 
s
 += ",notieragent";

3239 ià(
f
 & 
CEPH_OSDMAP_NOSNAPTRIM
)

3240 
s
 += ",nosnaptrim";

3241 ià(
f
 & 
CEPH_OSDMAP_SORTBITWISE
)

3242 
s
 += ",sortbitwise";

3243 ià(
f
 & 
CEPH_OSDMAP_REQUIRE_JEWEL
)

3244 
s
 += ",require_jewel_osds";

3245 ià(
f
 & 
CEPH_OSDMAP_REQUIRE_KRAKEN
)

3246 
s
 += ",require_kraken_osds";

3247 ià(
f
 & 
CEPH_OSDMAP_REQUIRE_LUMINOUS
)

3248 
s
 += ",require_luminous_osds";

3249 ià(
f
 & 
CEPH_OSDMAP_RECOVERY_DELETES
)

3250 
s
 += ",recovery_deletes";

3251 ià(
f
 & 
CEPH_OSDMAP_PURGED_SNAPDIRS
)

3252 
s
 += ",purged_snapdirs";

3253 ià(
s
.
	`Ëngth
())

3254 
s
.
	`”a£
(0, 1);

3255  
s
;

3256 
	}
}

3258 
¡ršg
 
	gOSDM­
::
	$g‘_æag_¡ršg
() const

3260  
	`g‘_æag_¡ršg
(
æags
);

3261 
	}
}

3263 
	gOSDM­
::
	$´št_poŞs
(
o¡»am
& 
out
) const

3265 cÚ¡‡utØ&
poŞ
 : 
poŞs
) {

3266 
¡d
::
¡ršg
 
	`Çme
("<unknown>");

3267 cÚ¡‡utØ&
²i
 = 
poŞ_Çme
.
	`fšd
(
poŞ
.
fœ¡
);

3268 ià(
²i
 !ğ
poŞ_Çme
.
	`’d
())

3269 
Çme
 = 
²i
->
£cÚd
;

3270 
out
 << "poŞ " << 
poŞ
.
fœ¡


3271 << " '" << 
Çme


3272 << "' " << 
poŞ
.
£cÚd
 << "\n";

3274 cÚ¡‡utØ&
¢­
 : 
poŞ
.
£cÚd
.
¢­s
)

3275 
out
 << "\t¢­ " << 
¢­
.
£cÚd
.
¢­id
 << " '" << sÇp.£cÚd.
Çme
 << "' " << sÇp.£cÚd.
¡amp
 << "\n";

3277 ià(!
poŞ
.
£cÚd
.
»moved_¢­s
.
	`em±y
())

3278 
out
 << "\Œemoved_¢­ " << 
poŞ
.
£cÚd
.
»moved_¢­s
 << "\n";

3279 autØ
p
 = 
»moved_¢­s_queue
.
	`fšd
(
poŞ
.
fœ¡
);

3280 ià(
p
 !ğ
»moved_¢­s_queue
.
	`’d
()) {

3281 
out
 << "\Œemoved_¢­s_queu" << 
p
->
£cÚd
 << "\n";

3284 
out
 << 
¡d
::
’dl
;

3285 
	}
}

3287 
	gOSDM­
::
	$´št
(
o¡»am
& 
out
) const

3289 
out
 << "•och " << 
	`g‘_•och
() << "\n"

3290 << "fsid " << 
	`g‘_fsid
() << "\n"

3291 << "ü—‹d " << 
	`g‘_ü—‹d
() << "\n"

3292 << "modif›d " << 
	`g‘_modif›d
() << "\n";

3294 
out
 << "æag " << 
	`g‘_æag_¡ršg
() << "\n";

3295 
out
 << "üush_v”siÚ " << 
	`g‘_üush_v”siÚ
() << "\n";

3296 
out
 << "fuÎ_¿tiØ" << 
fuÎ_¿tio
 << "\n";

3297 
out
 << "backflfuÎ_¿tiØ" << 
backflfuÎ_¿tio
 << "\n";

3298 
out
 << "Ã¬fuÎ_¿tiØ" << 
Ã¬fuÎ_¿tio
 << "\n";

3299 ià(
»quœe_mš_com·t_ş›Á
 > 0) {

3300 
out
 << "require_min_compat_client "

3301 << 
	`ûph_»Ëa£_Çme
(
»quœe_mš_com·t_ş›Á
) << "\n";

3303 
out
 << "mš_com·t_ş›Á " << 
	`ûph_»Ëa£_Çme
(
	`g‘_mš_com·t_ş›Á
())

3305 ià(
»quœe_osd_»Ëa£
 > 0) {

3306 
out
 << "»quœe_osd_»Ëa£ " << 
	`ûph_»Ëa£_Çme
(
»quœe_osd_»Ëa£
)

3309 ià(
	`g‘_şu¡”_¢­shÙ
().
	`Ëngth
())

3310 
out
 << "şu¡”_¢­shÙ " << 
	`g‘_şu¡”_¢­shÙ
() << "\n";

3311 
out
 << "\n";

3313 
	`´št_poŞs
(
out
);

3315 
out
 << "max_osd " << 
	`g‘_max_osd
() << "\n";

3316 
i
=0; i<
	`g‘_max_osd
(); i++) {

3317 ià(
	`exi¡s
(
i
)) {

3318 
out
 << "osd." << 
i
;

3319 
out
 << (
	`is_up
(
i
) ? " up ":" down");

3320 
out
 << (
	`is_š
(
i
) ? " in ":" out");

3321 
out
 << " weighˆ" << 
	`g‘_weightf
(
i
);

3322 ià(
	`g‘_´im¬y_affš™y
(
i
è!ğ
CEPH_OSD_DEFAULT_PRIMARY_AFFINITY
)

3323 
out
 << "…rim¬y_affš™y " << 
	`g‘_´im¬y_affš™yf
(
i
);

3324 cÚ¡ 
osd_šfo_t
& 
	`šfo
(
	`g‘_šfo
(
i
));

3325 
out
 << " " << 
šfo
;

3326 
out
 << " " << 
	`g‘_addr
(
i
è<< " " << 
	`g‘_şu¡”_addr
(iè<< " " << 
	`g‘_hb_back_addr
(i)

3327 << " " << 
	`g‘_hb_äÚt_addr
(
i
);

3328 
£t
<
¡ršg
> 
¡
;

3329 
	`g‘_¡©e
(
i
, 
¡
);

3330 
out
 << " " << 
¡
;

3331 ià(!
	`g‘_uuid
(
i
).
	`is_z”o
())

3332 
out
 << " " << 
	`g‘_uuid
(
i
);

3333 
out
 << "\n";

3336 
out
 << 
¡d
::
’dl
;

3338 auto& 
p
 : 
pg_upm­
) {

3339 
out
 << "pg_upm­ " << 
p
.
fœ¡
 << " " <<….
£cÚd
 << "\n";

3341 auto& 
p
 : 
pg_upm­_™ems
) {

3342 
out
 << "pg_upm­_™em " << 
p
.
fœ¡
 << " " <<….
£cÚd
 << "\n";

3345 cÚ¡‡utØ
pg
 : *
pg_‹mp
)

3346 
out
 << "pg_‹m°" << 
pg
.
fœ¡
 << " " <<…g.
£cÚd
 << "\n";

3348 cÚ¡‡utØ
pg
 : *
´im¬y_‹mp
)

3349 
out
 << "´im¬y_‹m°" << 
pg
.
fœ¡
 << " " <<…g.
£cÚd
 << "\n";

3351 cÚ¡‡utØ&
addr
 : 
bÏckli¡
)

3352 
out
 << "bÏckli¡ " << 
addr
.
fœ¡
 << "ƒxpœe " <<‡ddr.
£cÚd
 << "\n";

3353 
	}
}

3355 
şass
 
	gOSDT»ePÏšDum³r
 : 
public
 
CrushT»eDum³r
::
Dum³r
<
TextTabË
> {

3356 
public
:

3357 
CrushT»eDum³r
::
	tDum³r
<
	tTextTabË
> 
	tP¬’t
;

3359 
OSDT»ePÏšDum³r
(cÚ¡ 
CrushW¿µ”
 *
üush
, cÚ¡ 
OSDM­
 *
osdm­_
,

3360 
f
)

3361 : 
P¬’t
(
üush
, 
osdm­_
->
g‘_poŞ_Çmes
()), 
osdm­
(osdm­_), 
f‹r
(
f
) { }

3363 
boŞ
 
should_dump_Ëaf
(
i
ècÚ¡ 
	gov”ride
 {

3364 ià(!
	gf‹r
) {

3365  
	gŒue
;

3367 ià(((
	gf‹r
 & 
	gOSDM­
::
DUMP_UP
è&& 
osdm­
->
is_up
(
i
)) ||

3368 ((
f‹r
 & 
OSDM­
::
DUMP_DOWN
è&& 
osdm­
->
is_down
(
i
)) ||

3369 ((
f‹r
 & 
OSDM­
::
DUMP_IN
è&& 
osdm­
->
is_š
(
i
)) ||

3370 ((
f‹r
 & 
OSDM­
::
DUMP_OUT
è&& 
osdm­
->
is_out
(
i
)) ||

3371 ((
f‹r
 & 
OSDM­
::
DUMP_DESTROYED
è&& 
osdm­
->
is_de¡royed
(
i
))) {

3372  
Œue
;

3374  
	gçl£
;

3377 
boŞ
 
should_dump_em±y_buck‘
(ècÚ¡ 
	gov”ride
 {

3378  !
	gf‹r
;

3381 
š™_bË
(
TextTabË
 *
tbl
) {

3382 
	gtbl
->
defše_cŞumn
("ID", 
TextTabË
::
LEFT
, TextTabË::
RIGHT
);

3383 
	gtbl
->
defše_cŞumn
("CLASS", 
TextTabË
::
LEFT
, TextTabË::
RIGHT
);

3384 
	gtbl
->
defše_cŞumn
("WEIGHT", 
TextTabË
::
LEFT
, TextTabË::
RIGHT
);

3385 
	gtbl
->
defše_cŞumn
("TYPE NAME", 
TextTabË
::
LEFT
, TextTable::LEFT);

3386 
	gtbl
->
defše_cŞumn
("STATUS", 
TextTabË
::
LEFT
, TextTabË::
RIGHT
);

3387 
	gtbl
->
defše_cŞumn
("REWEIGHT", 
TextTabË
::
LEFT
, TextTabË::
RIGHT
);

3388 
	gtbl
->
defše_cŞumn
("PRI-AFF", 
TextTabË
::
LEFT
, TextTabË::
RIGHT
);

3390 
dump
(
TextTabË
 *
tbl
, 
¡ršg
& 
buck‘
) {

3391 
š™_bË
(
tbl
);

3393 ià(!
	gbuck‘
.
em±y
()) {

3394 
£t_roÙ
(
buck‘
);

3395 
	gP¬’t
::
dump
(
tbl
);

3397 
	gP¬’t
::
dump
(
tbl
);

3398 
	gi
 = 0; i < 
	gosdm­
->
g‘_max_osd
(); i++) {

3399 ià(
	gosdm­
->
exi¡s
(
i
è&& !
is_touched
(iè&& 
should_dump_Ëaf
(i)) {

3400 
dump_™em
(
CrushT»eDum³r
::
I‹m
(
i
, 0, 0, 0), 
tbl
);

3406 
	g´Ùeùed
:

3407 
dump_™em
(cÚ¡ 
CrushT»eDum³r
::
I‹m
 &
qi
, 
TextTabË
 *
tbl
è
	gov”ride
 {

3408 cÚ¡ *
	gc
 = 
üush
->
g‘_™em_şass
(
qi
.
id
);

3409 ià(!
	gc
)

3410 
	gc
 = "";

3411 *
	gtbl
 << 
	gqi
.
	gid


3412 << 
	gc


3413 << 
weightf_t
(
qi
.
weight
);

3415 
o¡ršg¡»am
 
	gÇme
;

3416 
	gk
 = 0; k < 
	gqi
.
	gd•th
; k++)

3417 
	gÇme
 << " ";

3418 ià(
	gqi
.
is_buck‘
()) {

3419 
	gÇme
 << 
	güush
->
g‘_ty³_Çme
(
üush
->
g‘_buck‘_ty³
(
qi
.
id
)) << " "

3420 << 
	güush
->
g‘_™em_Çme
(
qi
.
id
);

3422 
	gÇme
 << "osd." << 
	gqi
.
	gid
;

3424 *
	gtbl
 << 
	gÇme
.
¡r
();

3426 ià(!
	gqi
.
is_buck‘
()) {

3427 ià(!
	gosdm­
->
exi¡s
(
qi
.
id
)) {

3428 *
	gtbl
 << "DNE"

3431 
¡ršg
 
	gs
;

3432 ià(
	gosdm­
->
is_up
(
qi
.
id
)) {

3433 
	gs
 = "up";

3434 } ià(
	gosdm­
->
is_de¡royed
(
qi
.
id
)) {

3435 
	gs
 = "destroyed";

3437 
	gs
 = "down";

3439 *
	gtbl
 << 
	gs


3440 << 
weightf_t
(
osdm­
->
g‘_weightf
(
qi
.
id
))

3441 << 
weightf_t
(
osdm­
->
g‘_´im¬y_affš™yf
(
qi
.
id
));

3444 *
	gtbl
 << 
	gTextTabË
::
’drow
;

3447 
	g´iv©e
:

3448 cÚ¡ 
OSDM­
 *
osdm­
;

3449 cÚ¡ 
	gf‹r
;

3452 şas 
	cOSDT»eFÜm©tšgDum³r
 : 
public
 
CrushT»eDum³r
::
FÜm©tšgDum³r
 {

3453 
public
:

3454 
CrushT»eDum³r
::
	tFÜm©tšgDum³r
 
	tP¬’t
;

3456 
	$OSDT»eFÜm©tšgDum³r
(cÚ¡ 
CrushW¿µ”
 *
üush
, cÚ¡ 
OSDM­
 *
osdm­_
,

3457 
f
)

3458 : 
	`P¬’t
(
üush
, 
osdm­_
->
	`g‘_poŞ_Çmes
()), 
	`osdm­
(osdm­_), 
	$f‹r
(
f
) { }

3460 
boŞ
 
	$should_dump_Ëaf
(
i
ècÚ¡ 
ov”ride
 {

3461 ià(!
f‹r
) {

3462  
Œue
;

3464 ià(((
f‹r
 & 
OSDM­
::
DUMP_UP
è&& 
osdm­
->
	`is_up
(
i
)) ||

3465 ((
f‹r
 & 
OSDM­
::
DUMP_DOWN
è&& 
osdm­
->
	`is_down
(
i
)) ||

3466 ((
f‹r
 & 
OSDM­
::
DUMP_IN
è&& 
osdm­
->
	`is_š
(
i
)) ||

3467 ((
f‹r
 & 
OSDM­
::
DUMP_OUT
è&& 
osdm­
->
	`is_out
(
i
)) ||

3468 ((
f‹r
 & 
OSDM­
::
DUMP_DESTROYED
è&& 
osdm­
->
	`is_de¡royed
(
i
))) {

3469  
Œue
;

3471  
çl£
;

3472 
	}
}

3474 
boŞ
 
	$should_dump_em±y_buck‘
(ècÚ¡ 
ov”ride
 {

3475  !
f‹r
;

3476 
	}
}

3478 
	$dump
(
FÜm©‹r
 *
f
, 
¡ršg
& 
buck‘
) {

3479 ià(!
buck‘
.
	`em±y
()) {

3480 
	`£t_roÙ
(
buck‘
);

3481 
f
->
	`İ’_¬¿y_£ùiÚ
("nodes");

3482 
P¬’t
::
	`dump
(
f
);

3483 
f
->
	`şo£_£ùiÚ
();

3485 
f
->
	`İ’_¬¿y_£ùiÚ
("nodes");

3486 
P¬’t
::
	`dump
(
f
);

3487 
f
->
	`şo£_£ùiÚ
();

3488 
f
->
	`İ’_¬¿y_£ùiÚ
("stray");

3489 
i
 = 0; i < 
osdm­
->
	`g‘_max_osd
(); i++) {

3490 ià(
osdm­
->
	`exi¡s
(
i
è&& !
	`is_touched
(iè&& 
	`should_dump_Ëaf
(i))

3491 
	`dump_™em
(
CrushT»eDum³r
::
	`I‹m
(
i
, 0, 0, 0), 
f
);

3493 
f
->
	`şo£_£ùiÚ
();

3495 
	}
}

3497 
	g´Ùeùed
:

3498 
	$dump_™em_f›lds
(cÚ¡ 
CrushT»eDum³r
::
I‹m
 &
qi
, 
FÜm©‹r
 *
f
è
ov”ride
 {

3499 
P¬’t
::
	`dump_™em_f›lds
(
qi
, 
f
);

3500 ià(!
qi
.
	`is_buck‘
())

3502 
¡ršg
 
s
;

3503 ià(
osdm­
->
	`is_up
(
qi
.
id
)) {

3504 
s
 = "up";

3505 } ià(
osdm­
->
	`is_de¡royed
(
qi
.
id
)) {

3506 
s
 = "destroyed";

3508 
s
 = "down";

3510 
f
->
	`dump_unsigÃd
("exi¡s", ()
osdm­
->
	`exi¡s
(
qi
.
id
));

3511 
f
->
	`dump_¡ršg
("¡©us", 
s
);

3512 
f
->
	`dump_æßt
("»weight", 
osdm­
->
	`g‘_weightf
(
qi
.
id
));

3513 
f
->
	`dump_æßt
("´im¬y_affš™y", 
osdm­
->
	`g‘_´im¬y_affš™yf
(
qi
.
id
));

3515 
	}
}

3517 
	g´iv©e
:

3518 cÚ¡ 
OSDM­
 *
osdm­
;

3519 cÚ¡ 
	gf‹r
;

3522 
	gOSDM­
::
	$´št_Œ“
(
FÜm©‹r
 *
f
, 
o¡»am
 *
out
, 
f‹r
, 
¡ršg
 
buck‘
) const

3524 ià(
f
) {

3525 
	`OSDT»eFÜm©tšgDum³r
(
üush
.
	`g‘
(), 
this
, 
f‹r
).
	`dump
(
f
, 
buck‘
);

3527 
	`as£¹
(
out
);

3528 
TextTabË
 
tbl
;

3529 
	`OSDT»ePÏšDum³r
(
üush
.
	`g‘
(), 
this
, 
f‹r
).
	`dump
(&
tbl
, 
buck‘
);

3530 *
out
 << 
tbl
;

3532 
	}
}

3534 
	gOSDM­
::
	$´št_summ¬y
(
FÜm©‹r
 *
f
, 
o¡»am
& 
out
,

3535 cÚ¡ 
¡ršg
& 
´efix
, 
boŞ
 
exŒa
) const

3537 ià(
f
) {

3538 
f
->
	`İ’_objeù_£ùiÚ
("osdmap");

3539 
f
->
	`dump_št
("•och", 
	`g‘_•och
());

3540 
f
->
	`dump_št
("num_osds", 
	`g‘_num_osds
());

3541 
f
->
	`dump_št
("num_up_osds", 
	`g‘_num_up_osds
());

3542 
f
->
	`dump_št
("num_š_osds", 
	`g‘_num_š_osds
());

3543 
f
->
	`dump_boŞ
("fuÎ", 
	`‹¡_æag
(
CEPH_OSDMAP_FULL
è? 
Œue
 : 
çl£
);

3544 
f
->
	`dump_boŞ
("Ã¬fuÎ", 
	`‹¡_æag
(
CEPH_OSDMAP_NEARFULL
è? 
Œue
 : 
çl£
);

3545 
f
->
	`dump_unsigÃd
("num_»m­³d_pgs", 
	`g‘_num_pg_‹mp
());

3546 
f
->
	`şo£_£ùiÚ
();

3548 
out
 << 
	`g‘_num_osds
() << " osds: "

3549 << 
	`g‘_num_up_osds
() << " up, "

3550 << 
	`g‘_num_š_osds
() << " in";

3551 ià(
exŒa
)

3552 
out
 << ";ƒpoch:ƒ" << 
	`g‘_•och
();

3553 ià(
	`g‘_num_pg_‹mp
())

3554 
out
 << "; " << 
	`g‘_num_pg_‹mp
() << "„emapped…gs";

3555 
out
 << "\n";

3556 
ušt64_t
 
impÜÁ_æags
 = 
æags
 & ~
CEPH_OSDMAP_SEMIHIDDEN_FLAGS
;

3557 ià(
impÜÁ_æags
)

3558 
out
 << 
´efix
 << "æag " << 
	`g‘_æag_¡ršg
(
impÜÁ_æags
) << "\n";

3560 
	}
}

3562 
	gOSDM­
::
	$´št_Ú–še_summ¬y
(
o¡»am
& 
out
) const

3564 
out
 << "e" << 
	`g‘_•och
() << ": "

3565 << 
	`g‘_num_osds
() << "otal, "

3566 << 
	`g‘_num_up_osds
() << " up, "

3567 << 
	`g‘_num_š_osds
() << " in";

3568 ià(
	`‹¡_æag
(
CEPH_OSDMAP_FULL
))

3569 
out
 << "; full flag set";

3570 ià(
	`‹¡_æag
(
CEPH_OSDMAP_NEARFULL
))

3571 
out
 << ";‚earfull flag set";

3572 
	}
}

3574 
boŞ
 
	gOSDM­
::
	$üush_ruË_š_u£
(
ruË_id
) const

3576 cÚ¡‡utØ&
poŞ
 : 
poŞs
) {

3577 ià(
poŞ
.
£cÚd
.
üush_ruË
 =ğ
ruË_id
)

3578  
Œue
;

3580  
çl£
;

3581 
	}
}

3583 
	gOSDM­
::
	$v®id©e_üush_ruËs
(
CrushW¿µ”
 *
Ãwüush
,

3584 
o¡»am
 *
ss
) const

3586 auto& 
i
 : 
poŞs
) {

3587 auto& 
poŞ
 = 
i
.
£cÚd
;

3588 
ruËno
 = 
poŞ
.
	`g‘_üush_ruË
();

3589 ià(!
Ãwüush
->
	`ruË_exi¡s
(
ruËno
)) {

3590 *
ss
 << "poŞ " << 
i
.
fœ¡
 << "„eã»nû üush_ruË " << 
ruËno


3592  -
EINVAL
;

3594 ià(
Ãwüush
->
	`g‘_ruË_mask_ruË£t
(
ruËno
) !=„uleno) {

3595 *
ss
 << "ruË " << 
ruËno
 << " mask„uleset does‚ot match„ule id";

3596  -
EINVAL
;

3598 ià(
Ãwüush
->
	`g‘_ruË_mask_ty³
(
ruËno
è!ğ()
poŞ
.
	`g‘_ty³
()) {

3599 *
ss
 << "poŞ " << 
i
.
fœ¡
 << "y³ dÛ nÙ m©ch„uË " << 
ruËno
;

3600  -
EINVAL
;

3602 
poŞsize
 = 
poŞ
.
	`g‘_size
();

3603 ià(
poŞsize
 < 
Ãwüush
->
	`g‘_ruË_mask_mš_size
(
ruËno
) ||

3604 
poŞsize
 > 
Ãwüush
->
	`g‘_ruË_mask_max_size
(
ruËno
)) {

3605 *
ss
 << "poŞ " << 
i
.
fœ¡
 << " siz" << 
poŞsize
 << " does‚ot"

3606 << " f®Èw™hš„uË " << 
ruËno


3607 << " mš_siz" << 
Ãwüush
->
	`g‘_ruË_mask_mš_size
(
ruËno
)

3608 << "‡nd max_siz" << 
Ãwüush
->
	`g‘_ruË_mask_max_size
(
ruËno
);

3609  -
EINVAL
;

3613 
	}
}

3615 
	gOSDM­
::
	$bud_sim¶e_İtiÚed
(
C•hCÚ‹xt
 *
cù
, 
•och_t
 
e
, 
uuid_d
 &
fsid
,

3616 
nosd
, 
pg_b™s
, 
pgp_b™s
,

3617 
boŞ
 
deçuÉ_poŞ
)

3619 
	`ldout
(
cù
, 10è<< "bud_sim¶Ú " << 
nosd


3620 << " osds" << 
d’dl
;

3621 
•och
 = 
e
;

3622 
	`£t_fsid
(
fsid
);

3623 
ü—‹d
 = 
modif›d
 = 
	`ûph_şock_now
();

3625 ià(
nosd
 >= 0) {

3626 
	`£t_max_osd
(
nosd
);

3629 
maxosd
 = 0;

3630 cÚ¡ 
md_cÚfig_t
 *
cÚf
 = 
cù
->
_cÚf
;

3631 
veùÜ
<
¡ršg
> 
£ùiÚs
;

3632 
cÚf
->
	`g‘_®l_£ùiÚs
(
£ùiÚs
);

3634 autØ&
£ùiÚ
 : 
£ùiÚs
) {

3635 ià(
£ùiÚ
.
	`fšd
("osd.") != 0)

3638 cÚ¡ *
begš
 = 
£ùiÚ
.
	`c_¡r
() + 4;

3639 *
’d
 = (*)
begš
;

3640 
o
 = 
	`¡¹Ş
(
begš
, &
’d
, 10);

3641 ià(*
’d
 != '\0')

3644 ià(
o
 > 
cù
->
_cÚf
->
mÚ_max_osd
) {

3645 
	`ld”r
(
cù
è<< "[osd." << 
o
 << "] iÀcÚfig ha id > mÚ_max_osd " << cù->
_cÚf
->
mÚ_max_osd
 << 
d’dl
;

3646  -
ERANGE
;

3649 ià(
o
 > 
maxosd
)

3650 
maxosd
 = 
o
;

3653 
	`£t_max_osd
(
maxosd
 + 1);

3657 
¡ršg¡»am
 
ss
;

3658 
r
;

3659 ià(
nosd
 >= 0)

3660 
r
 = 
	`bud_sim¶e_üush_m­
(
cù
, *
üush
, 
nosd
, &
ss
);

3662 
r
 = 
	`bud_sim¶e_üush_m­_äom_cÚf
(
cù
, *
üush
, &
ss
);

3663 
	`as£¹
(
r
 == 0);

3665 
poŞba£
 = 
	`g‘_max_osd
() ? get_max_osd() : 1;

3667 cÚ¡ 
deçuÉ_»¶iÿ‹d_ruË
 = 
üush
->
	`g‘_osd_poŞ_deçuÉ_üush_»¶iÿ‹d_ruË£t
(
cù
);

3668 
	`as£¹
(
deçuÉ_»¶iÿ‹d_ruË
 >= 0);

3670 ià(
deçuÉ_poŞ
) {

3672 ià(
pgp_b™s
 > 
pg_b™s
)

3673 
pgp_b™s
 = 
pg_b™s
;

3675 
veùÜ
<
¡ršg
> 
poŞ_Çmes
;

3676 
poŞ_Çmes
.
	`push_back
("rbd");

3677 autØ&
¶Çme
 : 
poŞ_Çmes
) {

3678 
št64_t
 
poŞ
 = ++
poŞ_max
;

3679 
poŞs
[
poŞ
].
ty³
 = 
pg_poŞ_t
::
TYPE_REPLICATED
;

3680 
poŞs
[
poŞ
].
æags
 = 
cù
->
_cÚf
->
osd_poŞ_deçuÉ_æags
;

3681 ià(
cù
->
_cÚf
->
osd_poŞ_deçuÉ_æag_hashp¥oŞ
)

3682 
poŞs
[
poŞ
].
	`£t_æag
(
pg_poŞ_t
::
FLAG_HASHPSPOOL
);

3683 ià(
cù
->
_cÚf
->
osd_poŞ_deçuÉ_æag_nod–‘e
)

3684 
poŞs
[
poŞ
].
	`£t_æag
(
pg_poŞ_t
::
FLAG_NODELETE
);

3685 ià(
cù
->
_cÚf
->
osd_poŞ_deçuÉ_æag_nİgchªge
)

3686 
poŞs
[
poŞ
].
	`£t_æag
(
pg_poŞ_t
::
FLAG_NOPGCHANGE
);

3687 ià(
cù
->
_cÚf
->
osd_poŞ_deçuÉ_æag_nosizechªge
)

3688 
poŞs
[
poŞ
].
	`£t_æag
(
pg_poŞ_t
::
FLAG_NOSIZECHANGE
);

3689 
poŞs
[
poŞ
].
size
 = 
cù
->
_cÚf
->
g‘_v®
<
ušt64_t
>("osd_pool_default_size");

3690 
poŞs
[
poŞ
].
mš_size
 = 
cù
->
_cÚf
->
	`g‘_osd_poŞ_deçuÉ_mš_size
();

3691 
poŞs
[
poŞ
].
üush_ruË
 = 
deçuÉ_»¶iÿ‹d_ruË
;

3692 
poŞs
[
poŞ
].
objeù_hash
 = 
CEPH_STR_HASH_RJENKINS
;

3693 
poŞs
[
poŞ
].
	`£t_pg_num
(
poŞba£
 << 
pg_b™s
);

3694 
poŞs
[
poŞ
].
	`£t_pgp_num
(
poŞba£
 << 
pgp_b™s
);

3695 
poŞs
[
poŞ
].
Ï¡_chªge
 = 
•och
;

3696 
poŞs
[
poŞ
].
­¶iÿtiÚ_m‘ad©a
.
	`š£¹
(

3697 {
pg_poŞ_t
::
APPLICATION_NAME_RBD
, {}});

3698 
poŞ_Çme
[
poŞ
] = 
¶Çme
;

3699 
Çme_poŞ
[
¶Çme
] = 
poŞ
;

3703 
i
=0; i<
	`g‘_max_osd
(); i++) {

3704 
	`£t_¡©e
(
i
, 0);

3705 
	`£t_weight
(
i
, 
CEPH_OSD_OUT
);

3708 
m­
<
¡ršg
,¡ršg> 
´ofe_m­
;

3709 
r
 = 
	`g‘_”asu»_code_´ofe_deçuÉ
(
cù
, 
´ofe_m­
, &
ss
);

3710 ià(
r
 < 0) {

3711 
	`ld”r
(
cù
è<< 
ss
.
	`¡r
(è<< 
d’dl
;

3712  
r
;

3714 
	`£t_”asu»_code_´ofe
("deçuÉ", 
´ofe_m­
);

3716 
	}
}

3718 
	gOSDM­
::
g‘_”asu»_code_´ofe_deçuÉ
(
C•hCÚ‹xt
 *
cù
,

3719 
m­
<
¡ršg
,¡ršg> &
´ofe_m­
,

3720 
o¡»am
 *
ss
)

3722 
	gr
 = 
g‘_jsÚ_¡r_m­
(
cù
->
_cÚf
->
g‘_v®
<
¡ršg
>("osd_pool_default_erasure_code_profile"),

3723 *
ss
,

3724 &
´ofe_m­
);

3725  
	gr
;

3728 
	gOSDM­
::
	$_bud_üush_ty³s
(
CrushW¿µ”
& 
üush
)

3730 
üush
.
	`£t_ty³_Çme
(0, "osd");

3731 
üush
.
	`£t_ty³_Çme
(1, "host");

3732 
üush
.
	`£t_ty³_Çme
(2, "chassis");

3733 
üush
.
	`£t_ty³_Çme
(3, "rack");

3734 
üush
.
	`£t_ty³_Çme
(4, "row");

3735 
üush
.
	`£t_ty³_Çme
(5, "pdu");

3736 
üush
.
	`£t_ty³_Çme
(6, "pod");

3737 
üush
.
	`£t_ty³_Çme
(7, "room");

3738 
üush
.
	`£t_ty³_Çme
(8, "datacenter");

3739 
üush
.
	`£t_ty³_Çme
(9, "region");

3740 
üush
.
	`£t_ty³_Çme
(10, "root");

3742 
	}
}

3744 
	gOSDM­
::
	$bud_sim¶e_üush_m­
(
C•hCÚ‹xt
 *
cù
, 
CrushW¿µ”
& 
üush
,

3745 
nosd
, 
o¡»am
 *
ss
)

3747 
üush
.
	`ü—‹
();

3750 
roÙ_ty³
 = 
	`_bud_üush_ty³s
(
üush
);

3751 
roÙid
;

3752 
r
 = 
üush
.
	`add_buck‘
(0, 0, 
CRUSH_HASH_DEFAULT
,

3753 
roÙ_ty³
, 0, 
NULL
, NULL, &
roÙid
);

3754 
	`as£¹
(
r
 == 0);

3755 
üush
.
	`£t_™em_Çme
(
roÙid
, "default");

3757 
o
=0; o<
nosd
; o++) {

3758 
m­
<
¡ršg
,¡ršg> 
loc
;

3759 
loc
["host"] = "localhost";

3760 
loc
["rack"] = "localrack";

3761 
loc
["root"] = "default";

3762 
	`ldout
(
cù
, 10è<< "‡ddšg osd." << 
o
 << "‡ˆ" << 
loc
 << 
d’dl
;

3763 
Çme
[32];

3764 
	`¢´štf
(
Çme
, Òame), "osd.%d", 
o
);

3765 
üush
.
	`š£¹_™em
(
cù
, 
o
, 1.0, 
Çme
, 
loc
);

3768 
	`bud_sim¶e_üush_ruËs
(
cù
, 
üush
, "deçuÉ", 
ss
);

3770 
üush
.
	`fš®ize
();

3773 
	}
}

3775 
	gOSDM­
::
	$bud_sim¶e_üush_m­_äom_cÚf
(
C•hCÚ‹xt
 *
cù
,

3776 
CrushW¿µ”
& 
üush
,

3777 
o¡»am
 *
ss
)

3779 cÚ¡ 
md_cÚfig_t
 *
cÚf
 = 
cù
->
_cÚf
;

3781 
üush
.
	`ü—‹
();

3784 
roÙ_ty³
 = 
	`_bud_üush_ty³s
(
üush
);

3785 
roÙid
;

3786 
r
 = 
üush
.
	`add_buck‘
(0, 0,

3787 
CRUSH_HASH_DEFAULT
,

3788 
roÙ_ty³
, 0, 
NULL
, NULL, &
roÙid
);

3789 
	`as£¹
(
r
 == 0);

3790 
üush
.
	`£t_™em_Çme
(
roÙid
, "default");

3793 
veùÜ
<
¡ršg
> 
£ùiÚs
;

3794 
cÚf
->
	`g‘_®l_£ùiÚs
(
£ùiÚs
);

3796 autØ&
£ùiÚ
 : 
£ùiÚs
) {

3797 ià(
£ùiÚ
.
	`fšd
("osd.") != 0)

3800 cÚ¡ *
begš
 = 
£ùiÚ
.
	`c_¡r
() + 4;

3801 *
’d
 = (*)
begš
;

3802 
o
 = 
	`¡¹Ş
(
begš
, &
’d
, 10);

3803 ià(*
’d
 != '\0')

3806 
¡ršg
 
ho¡
, 
¿ck
, 
row
, 
room
, 
dc
, 
poŞ
;

3807 
veùÜ
<
¡ršg
> 
£ùiÚtmp
;

3808 
£ùiÚtmp
.
	`push_back
("osd");

3809 
£ùiÚtmp
.
	`push_back
(
£ùiÚ
);

3810 
cÚf
->
	`g‘_v®_äom_cÚf_fe
(
£ùiÚtmp
, "ho¡", 
ho¡
, 
çl£
);

3811 
cÚf
->
	`g‘_v®_äom_cÚf_fe
(
£ùiÚtmp
, "¿ck", 
¿ck
, 
çl£
);

3812 
cÚf
->
	`g‘_v®_äom_cÚf_fe
(
£ùiÚtmp
, "row", 
row
, 
çl£
);

3813 
cÚf
->
	`g‘_v®_äom_cÚf_fe
(
£ùiÚtmp
, "room", 
room
, 
çl£
);

3814 
cÚf
->
	`g‘_v®_äom_cÚf_fe
(
£ùiÚtmp
, "d©aûÁ”", 
dc
, 
çl£
);

3815 
cÚf
->
	`g‘_v®_äom_cÚf_fe
(
£ùiÚtmp
, "roÙ", 
poŞ
, 
çl£
);

3817 ià(
ho¡
.
	`Ëngth
() == 0)

3818 
ho¡
 = "unknownhost";

3819 ià(
¿ck
.
	`Ëngth
() == 0)

3820 
¿ck
 = "unknownrack";

3822 
m­
<
¡ršg
,¡ršg> 
loc
;

3823 
loc
["ho¡"] = 
ho¡
;

3824 
loc
["¿ck"] = 
¿ck
;

3825 ià(
row
.
	`size
())

3826 
loc
["row"] = 
row
;

3827 ià(
room
.
	`size
())

3828 
loc
["room"] = 
room
;

3829 ià(
dc
.
	`size
())

3830 
loc
["d©aûÁ”"] = 
dc
;

3831 
loc
["root"] = "default";

3833 
	`ldout
(
cù
, 5è<< "‡ddšg osd." << 
o
 << "‡ˆ" << 
loc
 << 
d’dl
;

3834 
üush
.
	`š£¹_™em
(
cù
, 
o
, 1.0, 
£ùiÚ
, 
loc
);

3837 
	`bud_sim¶e_üush_ruËs
(
cù
, 
üush
, "deçuÉ", 
ss
);

3839 
üush
.
	`fš®ize
();

3842 
	}
}

3845 
	gOSDM­
::
	$bud_sim¶e_üush_ruËs
(

3846 
C•hCÚ‹xt
 *
cù
,

3847 
CrushW¿µ”
& 
üush
,

3848 cÚ¡ 
¡ršg
& 
roÙ
,

3849 
o¡»am
 *
ss
)

3851 
üush_ruË
 = 
üush
.
	`g‘_osd_poŞ_deçuÉ_üush_»¶iÿ‹d_ruË£t
(
cù
);

3852 
¡ršg
 
çu»_domaš
 =

3853 
üush
.
	`g‘_ty³_Çme
(
cù
->
_cÚf
->
osd_üush_choo£Ëaf_ty³
);

3855 
r
;

3856 
r
 = 
üush
.
	`add_sim¶e_ruË_©
(

3857 "»¶iÿ‹d_ruË", 
roÙ
, 
çu»_domaš
, "",

3858 "fœ¡n", 
pg_poŞ_t
::
TYPE_REPLICATED
,

3859 
üush_ruË
, 
ss
);

3860 ià(
r
 < 0)

3861  
r
;

3865 
	}
}

3867 
	gOSDM­
::
summ¬ize_m­pšg_¡©s
(

3868 
OSDM­
 *
Ãwm­
,

3869 cÚ¡ 
£t
<
št64_t
> *
poŞs
,

3870 
¡d
::
¡ršg
 *
out
,

3871 
FÜm©‹r
 *
f
) const

3873 
	g£t
<
	gšt64_t
> 
	gls
;

3874 ià(
	gpoŞs
) {

3875 
	gls
 = *
poŞs
;

3877 autØ&
	gp
 : 
g‘_poŞs
())

3878 
ls
.
š£¹
(
p
.
fœ¡
);

3881 
	gtÙ®_pg
 = 0;

3882 
	gmoved_pg
 = 0;

3883 
	gveùÜ
<> 
ba£_by_osd
(
g‘_max_osd
(), 0);

3884 
	gveùÜ
<> 
Ãw_by_osd
(
g‘_max_osd
(), 0);

3885 
št64_t
 
	gpoŞ_id
 : 
ls
) {

3886 cÚ¡ 
pg_poŞ_t
 *
pi
 = 
g‘_pg_poŞ
(
poŞ_id
);

3887 
	gveùÜ
<> 
	gup
, 
	gup2
;

3888 
	gup_´im¬y
;

3889 
	gps
 = 0;… < 
	gpi
->
g‘_pg_num
(); ++ps) {

3890 
pg_t
 
pgid
(
ps
, 
poŞ_id
);

3891 
	gtÙ®_pg
 +ğ
pi
->
g‘_size
();

3892 
pg_to_up_aùšg_osds
(
pgid
, &
up
, &
up_´im¬y
, 
nuÎ±r
,‚ullptr);

3893 
	gosd
 : 
up
) {

3894 ià(
osd
 >ğ0 && osd < 
g‘_max_osd
())

3895 ++
ba£_by_osd
[
osd
];

3897 ià(
	gÃwm­
) {

3898 
	gÃwm­
->
pg_to_up_aùšg_osds
(
pgid
, &
up2
, &
up_´im¬y
, 
nuÎ±r
,‚ullptr);

3899 
	gosd
 : 
up2
) {

3900 ià(
osd
 >ğ0 && osd < 
g‘_max_osd
())

3901 ++
Ãw_by_osd
[
osd
];

3903 ià(
	gpi
->
	gty³
 =ğ
pg_poŞ_t
::
TYPE_ERASURE
) {

3904 
i
=0; 
	gi
<
	gup
.
size
(); ++i) {

3905 ià(
	gup
[
i
] !ğ
up2
[i]) {

3906 ++
moved_pg
;

3909 } ià(
	gpi
->
	gty³
 =ğ
pg_poŞ_t
::
TYPE_REPLICATED
) {

3910 
osd
 : 
up
) {

3911 ià(
¡d
::
fšd
(
up2
.
begš
(), up2.
’d
(), 
osd
) == up2.end()) {

3912 ++
moved_pg
;

3916 
as£¹
(0 == "unhandled…oolype");

3922 
	gnum_up_š
 = 0;

3923 
	gosd
 = 0; osd < 
g‘_max_osd
(); ++osd) {

3924 ià(
is_up
(
osd
è&& 
is_š
(osd))

3925 ++
	gnum_up_š
;

3927 ià(!
	gnum_up_š
) {

3928  -
	gEINVAL
;

3931 
	gavg_pg
 = ()
tÙ®_pg
 / ()
num_up_š
;

3932 
	gba£_¡ddev
 = 0, 
	gÃw_¡ddev
 = 0;

3933 
	gmš
 = -1, 
	gmax
 = -1;

3934 
	gmš_ba£_pg
 = 0, 
	gmax_ba£_pg
 = 0;

3935 
	gmš_Ãw_pg
 = 0, 
	gmax_Ãw_pg
 = 0;

3936 
	gosd
 = 0; osd < 
g‘_max_osd
(); ++osd) {

3937 ià(
is_up
(
osd
è&& 
is_š
(osd)) {

3938 
	gba£_diff
 = ()
ba£_by_osd
[
osd
] - 
avg_pg
;

3939 
	gba£_¡ddev
 +ğ
ba£_diff
 * base_diff;

3940 
	gÃw_diff
 = ()
Ãw_by_osd
[
osd
] - 
avg_pg
;

3941 
	gÃw_¡ddev
 +ğ
Ãw_diff
 *‚ew_diff;

3942 ià(
	gmš
 < 0 || 
	gba£_by_osd
[
osd
] < 
	gmš_ba£_pg
) {

3943 
	gmš
 = 
osd
;

3944 
	gmš_ba£_pg
 = 
ba£_by_osd
[
osd
];

3945 
	gmš_Ãw_pg
 = 
Ãw_by_osd
[
osd
];

3947 ià(
	gmax
 < 0 || 
	gba£_by_osd
[
osd
] > 
	gmax_ba£_pg
) {

3948 
	gmax
 = 
osd
;

3949 
	gmax_ba£_pg
 = 
ba£_by_osd
[
osd
];

3950 
	gmax_Ãw_pg
 = 
Ãw_by_osd
[
osd
];

3954 
	gba£_¡ddev
 = 
sq¹
(
ba£_¡ddev
 / 
num_up_š
);

3955 
	gÃw_¡ddev
 = 
sq¹
(
Ãw_¡ddev
 / 
num_up_š
);

3957 
	gedev
 = 
sq¹
(
avg_pg
 * (1.0 - (1.0 / ()
num_up_š
)));

3959 
o¡ršg¡»am
 
	gss
;

3960 ià(
	gf
)

3961 
	gf
->
İ’_objeù_£ùiÚ
("utilization");

3962 ià(
	gÃwm­
) {

3963 ià(
	gf
) {

3964 
	gf
->
dump_unsigÃd
("moved_pgs", 
moved_pg
);

3965 
	gf
->
dump_unsigÃd
("tÙ®_pgs", 
tÙ®_pg
);

3967 
	g³rûÁ
 = 0;

3968 ià(
	gtÙ®_pg
)

3969 
	g³rûÁ
 = ()
moved_pg
 * 100.0 / ()
tÙ®_pg
;

3970 
	gss
 << "moved " << 
	gmoved_pg
 << " / " << 
	gtÙ®_pg


3971 << " (" << 
	g³rûÁ
 << "%)\n";

3974 ià(
	gf
) {

3975 
	gf
->
dump_æßt
("avg_pgs", 
avg_pg
);

3976 
	gf
->
dump_æßt
("¡d_dev", 
ba£_¡ddev
);

3977 
	gf
->
dump_æßt
("ex³ùed_ba£lše_¡d_dev", 
edev
);

3978 ià(
	gÃwm­
)

3979 
	gf
->
dump_æßt
("Ãw_¡d_dev", 
Ãw_¡ddev
);

3981 
	gss
 << "avg " << 
	gavg_pg
 << "\n";

3982 
	gss
 << "¡ddev " << 
	gba£_¡ddev
;

3983 ià(
	gÃwm­
)

3984 
	gss
 << " -> " << 
	gÃw_¡ddev
;

3985 
	gss
 << " (ex³ùed ba£lš" << 
	gedev
 << ")\n";

3987 ià(
	gmš
 >= 0) {

3988 ià(
f
) {

3989 
f
->
dump_unsigÃd
("mš_osd", 
mš
);

3990 
	gf
->
dump_unsigÃd
("mš_osd_pgs", 
mš_ba£_pg
);

3991 ià(
	gÃwm­
)

3992 
	gf
->
dump_unsigÃd
("Ãw_mš_osd_pgs", 
mš_Ãw_pg
);

3994 
	gss
 << "mš osd." << 
	gmš
 << " w™h " << 
	gmš_ba£_pg
;

3995 ià(
	gÃwm­
)

3996 
	gss
 << " -> " << 
	gmš_Ãw_pg
;

3997 
	gss
 << "…g (" << ()
	gmš_ba£_pg
 / 
	gavg_pg
;

3998 ià(
	gÃwm­
)

3999 
	gss
 << " -> " << ()
	gmš_Ãw_pg
 / 
	gavg_pg
;

4000 
	gss
 << " * mean)\n";

4003 ià(
	gmax
 >= 0) {

4004 ià(
f
) {

4005 
f
->
dump_unsigÃd
("max_osd", 
max
);

4006 
	gf
->
dump_unsigÃd
("max_osd_pgs", 
max_ba£_pg
);

4007 ià(
	gÃwm­
)

4008 
	gf
->
dump_unsigÃd
("Ãw_max_osd_pgs", 
max_Ãw_pg
);

4010 
	gss
 << "max osd." << 
	gmax
 << " w™h " << 
	gmax_ba£_pg
;

4011 ià(
	gÃwm­
)

4012 
	gss
 << " -> " << 
	gmax_Ãw_pg
;

4013 
	gss
 << "…g (" << ()
	gmax_ba£_pg
 / 
	gavg_pg
;

4014 ià(
	gÃwm­
)

4015 
	gss
 << " -> " << ()
	gmax_Ãw_pg
 / 
	gavg_pg
;

4016 
	gss
 << " * mean)\n";

4019 ià(
	gf
)

4020 
	gf
->
şo£_£ùiÚ
();

4021 ià(
	gout
)

4022 *
	gout
 = 
ss
.
¡r
();

4027 
	gOSDM­
::
	$ş—n_pg_upm­s
(

4028 
C•hCÚ‹xt
 *
cù
,

4029 
Inüem’l
 *
³ndšg_šc
)

4031 
	`ldout
(
cù
, 10è<< 
__func__
 << 
d’dl
;

4032 
chªged
 = 0;

4033 auto& 
p
 : 
pg_upm­
) {

4034 
veùÜ
<> 
¿w
;

4035 
´im¬y
;

4036 
	`pg_to_¿w_osds
(
p
.
fœ¡
, &
¿w
, &
´im¬y
);

4037 ià(
¿w
 =ğ
p
.
£cÚd
) {

4038 
	`ldout
(
cù
, 10è<< "„emovšg„edundªˆpg_upm­ " << 
p
.
fœ¡
 << " "

4039 << 
p
.
£cÚd
 << 
d’dl
;

4040 
³ndšg_šc
->
Şd_pg_upm­
.
	`š£¹
(
p
.
fœ¡
);

4041 ++
chªged
;

4044 auto& 
p
 : 
pg_upm­_™ems
) {

4045 
veùÜ
<> 
¿w
;

4046 
´im¬y
;

4047 
	`pg_to_¿w_osds
(
p
.
fœ¡
, &
¿w
, &
´im¬y
);

4048 
mempoŞ
::
osdm­
::
veùÜ
<
·œ
<,>> 
Ãwm­
;

4049 auto& 
q
 : 
p
.
£cÚd
) {

4050 ià(
¡d
::
	`fšd
(
¿w
.
	`begš
(),„aw.
	`’d
(), 
q
.
fœ¡
) !=„aw.end()) {

4051 
Ãwm­
.
	`push_back
(
q
);

4054 ià(
Ãwm­
.
	`em±y
()) {

4055 
	`ldout
(
cù
, 10è<< "„emovšg‚o-İ…g_upm­_™em " << 
p
.
fœ¡
 << " "

4056 << 
p
.
£cÚd
 << 
d’dl
;

4057 
³ndšg_šc
->
Şd_pg_upm­_™ems
.
	`š£¹
(
p
.
fœ¡
);

4058 ++
chªged
;

4059 } ià(
Ãwm­
 !ğ
p
.
£cÚd
) {

4060 
	`ldout
(
cù
, 10) << " simplifying…artially‚o-op…g_upmap_items "

4061 << 
p
.
fœ¡
 << " " <<….
£cÚd
 << " -> " << 
Ãwm­
 << 
d’dl
;

4062 
³ndšg_šc
->
Ãw_pg_upm­_™ems
[
p
.
fœ¡
] = 
Ãwm­
;

4063 ++
chªged
;

4066  
chªged
;

4067 
	}
}

4069 
boŞ
 
	gOSDM­
::
Œy_pg_upm­
(

4070 
C•hCÚ‹xt
 *
cù
,

4071 
pg_t
 
pg
,

4072 cÚ¡ 
£t
<>& 
ov”fuÎ
,

4073 cÚ¡ 
veùÜ
<>& 
und”fuÎ
,

4074 
veùÜ
<> *
Üig
,

4075 
veùÜ
<> *
out
)

4077 cÚ¡ 
pg_poŞ_t
 *
	gpoŞ
 = 
g‘_pg_poŞ
(
pg
.
poŞ
());

4078 ià(!
	gpoŞ
)

4079  
	gçl£
;

4080 
	gruË
 = 
üush
->
fšd_ruË
(
poŞ
->
g‘_üush_ruË
(),…oŞ->
g‘_ty³
(),

4081 
poŞ
->
g‘_size
());

4082 ià(
	gruË
 < 0)

4083  
	gçl£
;

4086 
_pg_to_¿w_osds
(*
poŞ
, 
pg
, 
Üig
, 
NULL
);

4089 
boŞ
 
	gªy
 = 
çl£
;

4090 autØ
	gosd
 : *
Üig
) {

4091 ià(
ov”fuÎ
.
couÁ
(
osd
)) {

4092 
ªy
 = 
Œue
;

4096 ià(!
	gªy
) {

4097  
	gçl£
;

4100 
	gr
 = 
üush
->
Œy_»m­_ruË
(

4101 
cù
,

4102 
ruË
,

4103 
poŞ
->
g‘_size
(),

4104 
ov”fuÎ
, 
und”fuÎ
,

4105 *
Üig
,

4106 
out
);

4107 ià(
	gr
 < 0)

4108  
	gçl£
;

4109 ià(*
	gout
 =ğ*
Üig
)

4110  
çl£
;

4111  
	gŒue
;

4114 
	gOSDM­
::
ÿlc_pg_upm­s
(

4115 
C•hCÚ‹xt
 *
cù
,

4116 
max_devŸtiÚ_¿tio
,

4117 
max
,

4118 cÚ¡ 
£t
<
št64_t
>& 
Úly_poŞs_Üig
,

4119 
OSDM­
::
Inüem’l
 *
³ndšg_šc
)

4121 
£t
<
št64_t
> 
Úly_poŞs
;

4122 ià(
	gÚly_poŞs_Üig
.
em±y
()) {

4123 auto& 
	gi
 : 
poŞs
) {

4124 
Úly_poŞs
.
š£¹
(
i
.
fœ¡
);

4127 
	gÚly_poŞs
 = 
Úly_poŞs_Üig
;

4129 
OSDM­
 
	gtmp
;

4130 
	gtmp
.
d“pish_cİy_äom
(*
this
);

4131 
	g¡¬t_devŸtiÚ
 = 0;

4132 
	g’d_devŸtiÚ
 = 0;

4133 
	gnum_chªged
 = 0;

4134 
	gŒue
) {

4135 
	gm­
<,
	g£t
<
	gpg_t
>> 
	gpgs_by_osd
;

4136 
	gtÙ®_pgs
 = 0;

4137 
	gosd_weight_tÙ®
 = 0;

4138 
	gm­
<,> 
	gosd_weight
;

4139 auto& 
	gi
 : 
poŞs
) {

4140 ià(!
Úly_poŞs
.
em±y
(è&& !Úly_poŞs.
couÁ
(
i
.
fœ¡
))

4142 
	gps
 = 0;… < 
	gi
.
	g£cÚd
.
g‘_pg_num
(); ++ps) {

4143 
pg_t
 
pg
(
ps
, 
i
.
fœ¡
);

4144 
	gveùÜ
<> 
	gup
;

4145 
	gtmp
.
pg_to_up_aùšg_osds
(
pg
, &
up
, 
nuÎ±r
,‚ullptr,‚ullptr);

4146 autØ
	gosd
 : 
up
) {

4147 ià(
osd
 !ğ
CRUSH_ITEM_NONE
)

4148 
pgs_by_osd
[
osd
].
š£¹
(
pg
);

4151 
	gtÙ®_pgs
 +ğ
i
.
£cÚd
.
g‘_size
(è* i.£cÚd.
g‘_pg_num
();

4153 
	gm­
<,> 
	gpm­
;

4154 
	gruËno
 = 
tmp
.
üush
->
fšd_ruË
(
i
.
£cÚd
.
g‘_üush_ruË
(),

4155 
i
.
£cÚd
.
g‘_ty³
(),

4156 
i
.
£cÚd
.
g‘_size
());

4157 
	gtmp
.
	güush
->
g‘_ruË_weight_osd_m­
(
ruËno
, &
pm­
);

4158 
ldout
(
cù
,30è<< 
	g__func__
 << "…oŞ " << 
	gi
.
	gfœ¡
 << "„uËnØ" << 
	gruËno
 << 
	gd’dl
;

4159 autØ
	gp
 : 
pm­
) {

4160 autØ
adju¡ed_weight
 = 
tmp
.
g‘_weightf
(
p
.
fœ¡
è*….
£cÚd
;

4161 ià(
	gadju¡ed_weight
 == 0) {

4164 
	gosd_weight
[
p
.
fœ¡
] +ğ
adju¡ed_weight
;

4165 
	gosd_weight_tÙ®
 +ğ
adju¡ed_weight
;

4168 auto& 
	gi
 : 
osd_weight
) {

4169 
pgs
 = 0;

4170 autØ
	gp
 = 
pgs_by_osd
.
fšd
(
i
.
fœ¡
);

4171 ià(
	gp
 !ğ
pgs_by_osd
.
’d
())

4172 
pgs
 = 
p
->
£cÚd
.
size
();

4174 
	gpgs_by_osd
.
em¶aû
(
i
.
fœ¡
, 
£t
<
pg_t
>());

4175 
ldout
(
cù
, 20è<< " osd." << 
	gi
.
	gfœ¡
 << " weighˆ" << i.
	g£cÚd


4176 << "…g " << 
	gpgs
 << 
	gd’dl
;

4179 ià(
	gosd_weight_tÙ®
 == 0) {

4180 
ld”r
(
cù
è<< 
__func__
 << "‡bÜˆdutØosd_weight_tÙ® =ğ0" << 
d’dl
;

4183 
	gpgs_³r_weight
 = 
tÙ®_pgs
 / 
osd_weight_tÙ®
;

4184 
ldout
(
cù
, 10è<< " osd_weight_tÙ® " << 
	gosd_weight_tÙ®
 << 
	gd’dl
;

4185 
ldout
(
cù
, 10è<< "…gs_³r_weighˆ" << 
	gpgs_³r_weight
 << 
	gd’dl
;

4188 
	gtÙ®_devŸtiÚ
 = 0;

4189 
	gm­
<,> 
	gosd_devŸtiÚ
;

4190 
	gmuÉim­
<,> 
	gdevŸtiÚ_osd
;

4191 
	g£t
<> 
	gov”fuÎ
;

4192 auto& 
	gi
 : 
pgs_by_osd
) {

4193 
rg‘
 = 
osd_weight
[
i
.
fœ¡
] * 
pgs_³r_weight
;

4194 
	gdevŸtiÚ
 = ()
i
.
£cÚd
.
size
(è- 
rg‘
;

4195 
ldout
(
cù
, 20è<< " osd." << 
	gi
.
	gfœ¡


4196 << "\g " << 
	gi
.
	g£cÚd
.
size
()

4197 << "\‰¬g‘ " << 
	grg‘


4198 << "\tdevŸtiÚ " << 
	gdevŸtiÚ


4199 << 
	gd’dl
;

4200 
	gosd_devŸtiÚ
[
i
.
fœ¡
] = 
devŸtiÚ
;

4201 
	gdevŸtiÚ_osd
.
š£¹
(
make_·œ
(
devŸtiÚ
, 
i
.
fœ¡
));

4202 ià(
	gdevŸtiÚ
 >= 1.0)

4203 
ov”fuÎ
.
š£¹
(
i
.
fœ¡
);

4204 
	gtÙ®_devŸtiÚ
 +ğ
abs
(
devŸtiÚ
);

4206 ià(
	gnum_chªged
 == 0) {

4207 
¡¬t_devŸtiÚ
 = 
tÙ®_devŸtiÚ
;

4209 
	g’d_devŸtiÚ
 = 
tÙ®_devŸtiÚ
;

4212 
	gveùÜ
<> 
	gund”fuÎ
;

4213 autØ
	gi
 = 
devŸtiÚ_osd
.
begš
();

4214 
	gi
 !ğ
devŸtiÚ_osd
.
’d
();

4215 ++
	gi
) {

4216 ià(
	gi
->
	gfœ¡
 >= -.999)

4218 
	gund”fuÎ
.
push_back
(
i
->
£cÚd
);

4220 
ldout
(
cù
, 10è<< "Ù®_devŸtiÚ " << 
	gtÙ®_devŸtiÚ


4221 << " ov”fuÎ " << 
	gov”fuÎ


4222 << " und”fuÎ " << 
	gund”fuÎ
 << 
	gd’dl
;

4223 ià(
	gov”fuÎ
.
em±y
(è|| 
	gund”fuÎ
.empty())

4227 
boŞ
 
	g»¡¬t
 = 
çl£
;

4228 autØ
	gp
 = 
devŸtiÚ_osd
.
rbegš
();… !ğdevŸtiÚ_osd.
»nd
(); ++p) {

4229 
	gosd
 = 
p
->
£cÚd
;

4230 
	gdevŸtiÚ
 = 
p
->
fœ¡
;

4232 
as£¹
(
osd_weight
.
couÁ
(
osd
));

4233 
	grg‘
 = 
osd_weight
[
osd
] * 
pgs_³r_weight
;

4234 
as£¹
(
rg‘
 > 0);

4235 ià(
	gdevŸtiÚ
/
	grg‘
 < 
	gmax_devŸtiÚ_¿tio
) {

4236 
ldout
(
cù
, 10è<< " osd." << 
	gosd


4237 << "¬g‘ " << 
	grg‘


4238 << " devŸtiÚ " << 
	gdevŸtiÚ


4239 << " ->„©iØ" << 
	gdevŸtiÚ
/
	grg‘


4240 << " < max„©iØ" << 
	gmax_devŸtiÚ_¿tio
 << 
	gd’dl
;

4243 
	gnum_to_move
 = 
devŸtiÚ
;

4244 
ldout
(
cù
, 10è<< " osd." << 
	gosd
 << " mov" << 
	gnum_to_move
 << 
	gd’dl
;

4245 ià(
	gnum_to_move
 < 1)

4248 
	g£t
<
	gpg_t
>& 
	gpgs
 = 
pgs_by_osd
[
osd
];

4251 autØ
	gpg
 : 
pgs
) {

4252 autØ
p
 = 
tmp
.
pg_upm­_™ems
.
fšd
(
pg
);

4253 ià(
	gp
 !ğ
tmp
.
pg_upm­_™ems
.
’d
()) {

4254 autØ
q
 : 
p
->
£cÚd
) {

4255 ià(
q
.
£cÚd
 =ğ
osd
) {

4256 
ldout
(
cù
, 10è<< " drİpšg…g_upm­_™em " << 
pg


4257 << " " << 
p
->
£cÚd
 << 
d’dl
;

4258 
	gtmp
.
	gpg_upm­_™ems
.
”a£
(
p
);

4259 
	g³ndšg_šc
->
	gŞd_pg_upm­_™ems
.
š£¹
(
pg
);

4260 ++
	gnum_chªged
;

4261 
	g»¡¬t
 = 
Œue
;

4265 ià(
	g»¡¬t
)

4268 ià(
	g»¡¬t
)

4271 autØ
	gpg
 : 
pgs
) {

4272 ià(
tmp
.
pg_upm­
.
couÁ
(
pg
) ||

4273 
tmp
.
pg_upm­_™ems
.
couÁ
(
pg
)) {

4274 
ldout
(
cù
, 20è<< "‡Ì—dy„em­³d " << 
	gpg
 << 
	gd’dl
;

4277 
ldout
(
cù
, 10è<< "ryšg " << 
	gpg
 << 
	gd’dl
;

4278 
	gveùÜ
<> 
	gÜig
, 
	gout
;

4279 ià(!
Œy_pg_upm­
(
cù
, 
pg
, 
ov”fuÎ
, 
und”fuÎ
, &
Üig
, &
out
)) {

4282 
ldout
(
cù
, 10è<< " " << 
	gpg
 << " " << 
	gÜig
 << " -> " << 
	gout
 << 
	gd’dl
;

4283 ià(
	gÜig
.
size
(è!ğ
out
.size()) {

4286 
as£¹
(
Üig
 !ğ
out
);

4287 auto& 
	grmi
 = 
tmp
.
pg_upm­_™ems
[
pg
];

4288 
	gi
 = 0; i < 
	gout
.
size
(); ++i) {

4289 ià(
	gÜig
[
i
] !ğ
out
[i]) {

4290 
rmi
.
push_back
(
make_·œ
(
Üig
[
i
], 
out
[i]));

4293 
	g³ndšg_šc
->
	gÃw_pg_upm­_™ems
[
pg
] = 
rmi
;

4294 
ldout
(
cù
, 10è<< " " << 
	gpg
 << "…g_upm­_™em " << 
	grmi
 << 
	gd’dl
;

4295 
	g»¡¬t
 = 
Œue
;

4296 ++
	gnum_chªged
;

4299 ià(
	g»¡¬t
)

4303 ià(!
	g»¡¬t
) {

4304 
ldout
(
cù
, 10è<< " faedØfšd‡ny chªge tØmake" << 
	gd’dl
;

4307 ià(--
	gmax
 == 0) {

4308 
ldout
(
cù
, 10è<< " h™ max i‹¿tiÚs, stİpšg" << 
d’dl
;

4312 
ldout
(
cù
, 10è<< " s¹ devŸtiÚ " << 
	g¡¬t_devŸtiÚ
 << 
	gd’dl
;

4313 
ldout
(
cù
, 10è<< "ƒnd devŸtiÚ " << 
	g’d_devŸtiÚ
 << 
	gd’dl
;

4314  
	gnum_chªged
;

4317 
	gOSDM­
::
g‘_osds_by_buck‘_Çme
(cÚ¡ 
¡ršg
 &
Çme
, 
£t
<> *
osds
) const

4319  
	güush
->
g‘_Ëaves
(
Çme
, 
osds
);

4323 
	gOSDM­
::
g‘_poŞ_ids_by_osd
(
C•hCÚ‹xt
 *
cù
,

4324 
osd
,

4325 
£t
<
št64_t
> *
poŞ_ids
) const

4327 
as£¹
(
poŞ_ids
);

4328 
	g£t
<> 
	g¿w_ruËs
;

4329 
	gr
 = 
üush
->
g‘_ruËs_by_osd
(
osd
, &
¿w_ruËs
);

4330 ià(
	gr
 < 0) {

4331 
ld”r
(
cù
è<< 
	g__func__
 << " g‘_ruËs_by_osd faed: " << 
ıp_¡»¼Ü
(
r
)

4332 << 
	gd’dl
;

4333 
as£¹
(
r
 >= 0);

4335 
	g£t
<> 
	gruËs
;

4336 autØ&
	gi
: 
¿w_ruËs
) {

4338 ià(
üush_ruË_š_u£
(
i
)) {

4339 
ruËs
.
š£¹
(
i
);

4342 autØ&
	gr
: 
ruËs
) {

4343 
g‘_poŞ_ids_by_ruË
(
r
, 
poŞ_ids
);

4347 
	g‹m¶©e
 <
ty³Çme
 
	gF
>

4348 
şass
 
	gOSDUtiz©iÚDum³r
 : 
public
 
CrushT»eDum³r
::
Dum³r
<
F
> {

4349 
public
:

4350 
CrushT»eDum³r
::
	tDum³r
<
	tF
> 
	tP¬’t
;

4352 
OSDUtiz©iÚDum³r
(cÚ¡ 
CrushW¿µ”
 *
üush
, cÚ¡ 
OSDM­
 *
osdm­_
,

4353 cÚ¡ 
PGM­
& 
pgm­_
, 
boŞ
 
Œ“_
) :

4354 
P¬’t
(
üush
, 
osdm­_
->
g‘_poŞ_Çmes
()),

4355 
osdm­
(
osdm­_
),

4356 
pgm­
(
pgm­_
),

4357 
Œ“
(
Œ“_
),

4358 
av”age_ut
(
av”age_utiz©iÚ
()),

4359 
mš_v¬
(-1),

4360 
max_v¬
(-1),

4361 
¡ddev
(0),

4362 
sum
(0) {

4365 
	g´Ùeùed
:

4366 
dump_¡¿y
(
F
 *
f
) {

4367 
i
 = 0; 
	gi
 < 
	gosdm­
->
g‘_max_osd
(); i++) {

4368 ià(
	gosdm­
->
exi¡s
(
i
è&& !
	gthis
->
is_touched
(i))

4369 
dump_™em
(
CrushT»eDum³r
::
I‹m
(
i
, 0, 0, 0), 
f
);

4373 
dump_™em
(cÚ¡ 
CrushT»eDum³r
::
I‹m
 &
qi
, 
F
 *
f
è
	gov”ride
 {

4374 ià(!
	gŒ“
 && 
	gqi
.
is_buck‘
())

4377 
	g»weight
 = 
qi
.
is_buck‘
(è? -1 : 
osdm­
->
g‘_weightf
(qi.
id
);

4378 
št64_t
 
	gkb
 = 0, 
	gkb_u£d
 = 0, 
	gkb_ava
 = 0;

4379 
	gut
 = 0;

4380 ià(
g‘_buck‘_utiz©iÚ
(
qi
.
id
, &
kb
, &
kb_u£d
, &
kb_ava
))

4381 ià(
	gkb_u£d
 && 
	gkb
)

4382 
	gut
 = 100.0 * ()
kb_u£d
 / ()
kb
;

4384 
	gv¬
 = 1.0;

4385 ià(
	gav”age_ut
)

4386 
	gv¬
 = 
ut
 / 
av”age_ut
;

4388 
size_t
 
	gnum_pgs
 = 
qi
.
is_buck‘
(è? 0 : 
pgm­
.
g‘_num_pg_by_osd
(qi.
id
);

4390 
dump_™em
(
qi
, 
»weight
, 
kb
, 
kb_u£d
, 
kb_ava
, 
ut
, 
v¬
, 
num_pgs
, 
f
);

4392 ià(!
	gqi
.
is_buck‘
(è&& 
	g»weight
 > 0) {

4393 ià(
	gmš_v¬
 < 0 || 
	gv¬
 < min_var)

4394 
	gmš_v¬
 = 
v¬
;

4395 ià(
	gmax_v¬
 < 0 || 
	gv¬
 > max_var)

4396 
	gmax_v¬
 = 
v¬
;

4398 
	gdev
 = 
ut
 - 
av”age_ut
;

4399 
	gdev
 *ğ
dev
;

4400 
	g¡ddev
 +ğ
»weight
 * 
dev
;

4401 
	gsum
 +ğ
»weight
;

4405 
vœtu®
 
dump_™em
(cÚ¡ 
CrushT»eDum³r
::
I‹m
 &
qi
,

4406 &
»weight
,

4407 
št64_t
 
kb
,

4408 
št64_t
 
kb_u£d
,

4409 
št64_t
 
kb_ava
,

4410 & 
ut
,

4411 & 
v¬
,

4412 cÚ¡ 
size_t
 
num_pgs
,

4413 
F
 *
f
) = 0;

4415 
dev
() {

4416  
	gsum
 > 0 ? 
sq¹
(
¡ddev
 / 
sum
) : 0;

4419 
av”age_utiz©iÚ
() {

4420 
št64_t
 
	gkb
 = 0, 
	gkb_u£d
 = 0;

4421 
	gi
 = 0; i < 
	gosdm­
->
g‘_max_osd
(); i++) {

4422 ià(!
	gosdm­
->
exi¡s
(
i
è|| osdm­->
g‘_weight
(i) == 0)

4424 
št64_t
 
	gkb_i
, 
	gkb_u£d_i
, 
	gkb_ava_i
;

4425 ià(
g‘_osd_utiz©iÚ
(
i
, &
kb_i
, &
kb_u£d_i
, &
kb_ava_i
)) {

4426 
	gkb
 +ğ
kb_i
;

4427 
	gkb_u£d
 +ğ
kb_u£d_i
;

4430  
	gkb
 > 0 ? 100.0 * ()
	gkb_u£d
 / ()kb : 0;

4433 
boŞ
 
g‘_osd_utiz©iÚ
(
id
, 
št64_t
* 
kb
, iÁ64_t* 
kb_u£d
,

4434 
št64_t
* 
kb_ava
) const {

4435 cÚ¡ 
osd_¡©_t
 *
	gp
 = 
pgm­
.
g‘_osd_¡©
(
id
);

4436 ià(!
	gp
è 
	gçl£
;

4437 *
	gkb
 = 
p
->
kb
;

4438 *
	gkb_u£d
 = 
p
->
kb_u£d
;

4439 *
	gkb_ava
 = 
p
->
kb_ava
;

4440  *
	gkb
 > 0;

4443 
boŞ
 
g‘_buck‘_utiz©iÚ
(
id
, 
št64_t
* 
kb
, iÁ64_t* 
kb_u£d
,

4444 
št64_t
* 
kb_ava
) const {

4445 ià(
	gid
 >= 0) {

4446 ià(
osdm­
->
is_out
(
id
)) {

4447 *
kb
 = 0;

4448 *
	gkb_u£d
 = 0;

4449 *
	gkb_ava
 = 0;

4450  
	gŒue
;

4452  
g‘_osd_utiz©iÚ
(
id
, 
kb
, 
kb_u£d
, 
kb_ava
);

4455 *
	gkb
 = 0;

4456 *
	gkb_u£d
 = 0;

4457 *
	gkb_ava
 = 0;

4459 
	gk
 = 
osdm­
->
üush
->
g‘_buck‘_size
(
id
) - 1; k >= 0; k--) {

4460 
	g™em
 = 
osdm­
->
üush
->
g‘_buck‘_™em
(
id
, 
k
);

4461 
št64_t
 
	gkb_i
 = 0, 
	gkb_u£d_i
 = 0, 
	gkb_ava_i
 = 0;

4462 ià(!
g‘_buck‘_utiz©iÚ
(
™em
, &
kb_i
, &
kb_u£d_i
, &
kb_ava_i
))

4463  
	gçl£
;

4464 *
	gkb
 +ğ
kb_i
;

4465 *
	gkb_u£d
 +ğ
kb_u£d_i
;

4466 *
	gkb_ava
 +ğ
kb_ava_i
;

4468  *
	gkb
 > 0;

4471 
	g´Ùeùed
:

4472 cÚ¡ 
OSDM­
 *
osdm­
;

4473 cÚ¡ 
	gPGM­
& 
	gpgm­
;

4474 
boŞ
 
	gŒ“
;

4475 
	gav”age_ut
;

4476 
	gmš_v¬
;

4477 
	gmax_v¬
;

4478 
	g¡ddev
;

4479 
	gsum
;

4483 
şass
 
	gOSDUtiz©iÚPÏšDum³r
 : 
public
 
OSDUtiz©iÚDum³r
<
TextTabË
> {

4484 
public
:

4485 
OSDUtiz©iÚDum³r
<
	tTextTabË
> 
	tP¬’t
;

4487 
OSDUtiz©iÚPÏšDum³r
(cÚ¡ 
CrushW¿µ”
 *
üush
, cÚ¡ 
OSDM­
 *
osdm­
,

4488 cÚ¡ 
PGM­
& 
pgm­
, 
boŞ
 
Œ“
) :

4489 
P¬’t
(
üush
, 
osdm­
, 
pgm­
, 
Œ“
) {}

4491 
dump
(
TextTabË
 *
tbl
) {

4492 
	gtbl
->
defše_cŞumn
("ID", 
TextTabË
::
LEFT
, TextTabË::
RIGHT
);

4493 
	gtbl
->
defše_cŞumn
("CLASS", 
TextTabË
::
LEFT
, TextTabË::
RIGHT
);

4494 
	gtbl
->
defše_cŞumn
("WEIGHT", 
TextTabË
::
LEFT
, TextTabË::
RIGHT
);

4495 
	gtbl
->
defše_cŞumn
("REWEIGHT", 
TextTabË
::
LEFT
, TextTabË::
RIGHT
);

4496 
	gtbl
->
defše_cŞumn
("SIZE", 
TextTabË
::
LEFT
, TextTabË::
RIGHT
);

4497 
	gtbl
->
defše_cŞumn
("USE", 
TextTabË
::
LEFT
, TextTabË::
RIGHT
);

4498 
	gtbl
->
defše_cŞumn
("AVAIL", 
TextTabË
::
LEFT
, TextTabË::
RIGHT
);

4499 
	gtbl
->
defše_cŞumn
("%USE", 
TextTabË
::
LEFT
, TextTabË::
RIGHT
);

4500 
	gtbl
->
defše_cŞumn
("VAR", 
TextTabË
::
LEFT
, TextTabË::
RIGHT
);

4501 
	gtbl
->
defše_cŞumn
("PGS", 
TextTabË
::
LEFT
, TextTabË::
RIGHT
);

4502 ià(
	gŒ“
)

4503 
	gtbl
->
defše_cŞumn
("TYPE NAME", 
TextTabË
::
LEFT
, TextTable::LEFT);

4505 
	gP¬’t
::
dump
(
tbl
);

4507 
dump_¡¿y
(
tbl
);

4509 *
	gtbl
 << ""

4512 << 
by‹_u_t
(
pgm­
.
g‘_osd_sum
().
kb
 << 10)

4513 << 
by‹_u_t
(
pgm­
.
g‘_osd_sum
().
kb_u£d
 << 10)

4514 << 
by‹_u_t
(
pgm­
.
g‘_osd_sum
().
kb_ava
 << 10)

4515 << 
low´ecisiÚ_t
(
av”age_ut
)

4517 << 
	gTextTabË
::
’drow
;

4520 
	g´Ùeùed
:

4521 
	slow´ecisiÚ_t
 {

4522 
v
;

4523 
ex¶ic™
 
low´ecisiÚ_t
(
_v
è: 
v
(_v) {}

4525 
ä›nd
 
	g¡d
::
o¡»am
 &
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
	glow´ecisiÚ_t
& 
	gv
);

4527 
usšg
 
	gOSDUtiz©iÚDum³r
<
	gTextTabË
>::
dump_™em
;

4528 
dump_™em
(cÚ¡ 
CrushT»eDum³r
::
I‹m
 &
qi
,

4529 &
»weight
,

4530 
št64_t
 
kb
,

4531 
št64_t
 
kb_u£d
,

4532 
št64_t
 
kb_ava
,

4533 & 
ut
,

4534 & 
v¬
,

4535 cÚ¡ 
size_t
 
num_pgs
,

4536 
TextTabË
 *
tbl
è
	gov”ride
 {

4537 cÚ¡ *
	gc
 = 
üush
->
g‘_™em_şass
(
qi
.
id
);

4538 ià(!
	gc
)

4539 
	gc
 = "";

4540 *
	gtbl
 << 
	gqi
.
	gid


4541 << 
	gc


4542 << 
weightf_t
(
qi
.
weight
)

4543 << 
weightf_t
(
»weight
)

4544 << 
by‹_u_t
(
kb
 << 10)

4545 << 
by‹_u_t
(
kb_u£d
 << 10)

4546 << 
by‹_u_t
(
kb_ava
 << 10)

4547 << 
low´ecisiÚ_t
(
ut
)

4548 << 
low´ecisiÚ_t
(
v¬
);

4550 ià(
	gqi
.
is_buck‘
()) {

4551 *
	gtbl
 << "-";

4553 *
	gtbl
 << 
	gnum_pgs
;

4556 ià(
	gŒ“
) {

4557 
o¡ršg¡»am
 
	gÇme
;

4558 
	gk
 = 0; k < 
	gqi
.
	gd•th
; k++)

4559 
	gÇme
 << " ";

4560 ià(
	gqi
.
is_buck‘
()) {

4561 
	gty³
 = 
üush
->
g‘_buck‘_ty³
(
qi
.
id
);

4562 
	gÇme
 << 
	güush
->
g‘_ty³_Çme
(
ty³
) << " "

4563 << 
	güush
->
g‘_™em_Çme
(
qi
.
id
);

4565 
	gÇme
 << "osd." << 
	gqi
.
	gid
;

4567 *
	gtbl
 << 
	gÇme
.
¡r
();

4570 *
	gtbl
 << 
	gTextTabË
::
’drow
;

4573 
	gpublic
:

4574 
¡ršg
 
summ¬y
() {

4575 
o¡ršg¡»am
 
out
;

4576 
	gout
 << "MIN/MAX VAR: " << 
low´ecisiÚ_t
(
mš_v¬
)

4577 << "/" << 
low´ecisiÚ_t
(
max_v¬
) << " "

4578 << "STDDEV: " << 
low´ecisiÚ_t
(
dev
());

4579  
	gout
.
¡r
();

4583 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
,

4584 cÚ¡ 
	gOSDUtiz©iÚPÏšDum³r
::
low´ecisiÚ_t
& 
v
)

4586 ià(
v
.v < -0.01) {

4587  
out
 << "-";

4588 } ià(
	gv
.v < 0.001) {

4589  
	gout
 << "0";

4591 
	g¡d
::
¡»amsize
 
p
 = 
out
.
´ecisiÚ
();

4592  
	gout
 << 
	g¡d
::
fixed
 << 
¡d
::
£»cisiÚ
(2è<< 
v
.v << std::£»cisiÚ(
p
);

4596 
şass
 
	gOSDUtiz©iÚFÜm©Dum³r
 : 
public
 
OSDUtiz©iÚDum³r
<
FÜm©‹r
> {

4597 
public
:

4598 
OSDUtiz©iÚDum³r
<
	tFÜm©‹r
> 
	tP¬’t
;

4600 
OSDUtiz©iÚFÜm©Dum³r
(cÚ¡ 
CrushW¿µ”
 *
üush
, cÚ¡ 
OSDM­
 *
osdm­
,

4601 cÚ¡ 
PGM­
& 
pgm­
, 
boŞ
 
Œ“
) :

4602 
P¬’t
(
üush
, 
osdm­
, 
pgm­
, 
Œ“
) {}

4604 
dump
(
FÜm©‹r
 *
f
) {

4605 
	gf
->
İ’_¬¿y_£ùiÚ
("nodes");

4606 
	gP¬’t
::
dump
(
f
);

4607 
	gf
->
şo£_£ùiÚ
();

4609 
	gf
->
İ’_¬¿y_£ùiÚ
("stray");

4610 
dump_¡¿y
(
f
);

4611 
	gf
->
şo£_£ùiÚ
();

4614 
	g´Ùeùed
:

4615 
usšg
 
OSDUtiz©iÚDum³r
<
FÜm©‹r
>::
dump_™em
;

4616 
dump_™em
(cÚ¡ 
CrushT»eDum³r
::
I‹m
 &
qi
,

4617 &
»weight
,

4618 
št64_t
 
kb
,

4619 
št64_t
 
kb_u£d
,

4620 
št64_t
 
kb_ava
,

4621 & 
ut
,

4622 & 
v¬
,

4623 cÚ¡ 
size_t
 
num_pgs
,

4624 
FÜm©‹r
 *
f
è
	gov”ride
 {

4625 
	gf
->
İ’_objeù_£ùiÚ
("item");

4626 
	gCrushT»eDum³r
::
dump_™em_f›lds
(
üush
, 
weight_£t_Çmes
, 
qi
, 
f
);

4627 
	gf
->
dump_æßt
("»weight", 
»weight
);

4628 
	gf
->
dump_št
("kb", 
kb
);

4629 
	gf
->
dump_št
("kb_u£d", 
kb_u£d
);

4630 
	gf
->
dump_št
("kb_ava", 
kb_ava
);

4631 
	gf
->
dump_æßt
("utiz©iÚ", 
ut
);

4632 
	gf
->
dump_æßt
("v¬", 
v¬
);

4633 
	gf
->
dump_unsigÃd
("pgs", 
num_pgs
);

4634 
	gCrushT»eDum³r
::
dump_buck‘_chd»n
(
üush
, 
qi
, 
f
);

4635 
	gf
->
şo£_£ùiÚ
();

4638 
	gpublic
:

4639 
summ¬y
(
FÜm©‹r
 *
f
) {

4640 
f
->
İ’_objeù_£ùiÚ
("summary");

4641 
	gf
->
dump_št
("tÙ®_kb", 
pgm­
.
g‘_osd_sum
().
kb
);

4642 
	gf
->
dump_št
("tÙ®_kb_u£d", 
pgm­
.
g‘_osd_sum
().
kb_u£d
);

4643 
	gf
->
dump_št
("tÙ®_kb_ava", 
pgm­
.
g‘_osd_sum
().
kb_ava
);

4644 
	gf
->
dump_æßt
("av”age_utiz©iÚ", 
av”age_ut
);

4645 
	gf
->
dump_æßt
("mš_v¬", 
mš_v¬
);

4646 
	gf
->
dump_æßt
("max_v¬", 
max_v¬
);

4647 
	gf
->
dump_æßt
("dev", 
dev
());

4648 
	gf
->
şo£_£ùiÚ
();

4652 
	$´št_osd_utiz©iÚ
(cÚ¡ 
OSDM­
& 
osdm­
,

4653 cÚ¡ 
PGM­
& 
pgm­
,

4654 
o¡»am
& 
out
,

4655 
FÜm©‹r
 *
f
,

4656 
boŞ
 
Œ“
)

4658 cÚ¡ 
CrushW¿µ”
 *
üush
 = 
osdm­
.üush.
	`g‘
();

4659 ià(
f
) {

4660 
f
->
	`İ’_objeù_£ùiÚ
("df");

4661 
OSDUtiz©iÚFÜm©Dum³r
 
	`d
(
üush
, &
osdm­
, 
pgm­
, 
Œ“
);

4662 
d
.
	`dump
(
f
);

4663 
d
.
	`summ¬y
(
f
);

4664 
f
->
	`şo£_£ùiÚ
();

4665 
f
->
	`æush
(
out
);

4667 
OSDUtiz©iÚPÏšDum³r
 
	`d
(
üush
, &
osdm­
, 
pgm­
, 
Œ“
);

4668 
TextTabË
 
tbl
;

4669 
d
.
	`dump
(&
tbl
);

4670 
out
 << 
tbl
 << 
d
.
	`summ¬y
() << "\n";

4672 
	}
}

4674 
	gOSDM­
::
	$check_h—Éh
(
h—Éh_check_m­_t
 *
checks
) const

4676 
num_osds
 = 
	`g‘_num_osds
();

4681 ià(
num_osds
 >= 0) {

4682 
num_š_osds
 = 0;

4683 
num_down_š_osds
 = 0;

4684 
£t
<> 
osds
;

4685 
£t
<> 
down_š_osds
;

4686 
£t
<> 
up_š_osds
;

4687 
£t
<> 
subŒ“_up
;

4688 
unÜd”ed_m­
<, 
£t
<> > 
subŒ“_ty³_down
;

4689 
unÜd”ed_m­
<, > 
num_osds_subŒ“
;

4690 
max_ty³
 = 
üush
->
	`g‘_max_ty³_id
();

4692 
i
 = 0; i < 
	`g‘_max_osd
(); i++) {

4693 ià(!
	`exi¡s
(
i
)) {

4694 ià(
üush
->
	`™em_exi¡s
(
i
)) {

4695 
osds
.
	`š£¹
(
i
);

4699 ià(
	`is_out
(
i
))

4701 ++
num_š_osds
;

4702 ià(
down_š_osds
.
	`couÁ
(
i
è|| 
up_š_osds
.count(i))

4704 ià(!
	`is_up
(
i
)) {

4705 
down_š_osds
.
	`š£¹
(
i
);

4706 
·»Á_id
 = 0;

4707 
cu¼’t
 = 
i
;

4708 
ty³
 = 0;y³ <ğ
max_ty³
;ype++) {

4709 ià(!
üush
->
	`g‘_ty³_Çme
(
ty³
))

4711 
r
 = 
üush
->
	`g‘_immedŸ‹_·»Á_id
(
cu¼’t
, &
·»Á_id
);

4712 ià(
r
 =ğ-
ENOENT
)

4715 ià(
subŒ“_up
.
	`couÁ
(
·»Á_id
))

4717 
ty³
 = 
üush
->
	`g‘_buck‘_ty³
(
·»Á_id
);

4718 ià(!
	`subŒ“_ty³_is_down
(

4719 
g_ûph_cÚ‹xt
, 
·»Á_id
, 
ty³
,

4720 &
down_š_osds
, &
up_š_osds
, &
subŒ“_up
, &
subŒ“_ty³_down
))

4722 
cu¼’t
 = 
·»Á_id
;

4729 
ty³
 = 1;y³ <ğ
max_ty³
;ype++) {

4730 ià(!
üush
->
	`g‘_ty³_Çme
(
ty³
))

4732 autØ
j
 = 
subŒ“_ty³_down
[
ty³
].
	`begš
();

4733 
j
 !ğ
subŒ“_ty³_down
[
ty³
].
	`’d
();

4734 ++
j
) {

4735 
li¡
<> 
chd»n
;

4736 
num
 = 0;

4737 
num_chd»n
 = 
üush
->
	`g‘_chd»n
(*
j
, &
chd»n
);

4738 ià(
num_chd»n
 == 0)

4740 autØ
l
 = 
chd»n
.
	`begš
();† !ğchd»n.
	`’d
(); ++l) {

4741 ià(*
l
 >= 0) {

4742 ++
num
;

4743 } ià(
num_osds_subŒ“
[*
l
] > 0) {

4744 
num
 =‚um + 
num_osds_subŒ“
[*
l
];

4747 
num_osds_subŒ“
[*
j
] = 
num
;

4750 
num_down_š_osds
 = 
down_š_osds
.
	`size
();

4751 
	`as£¹
(
num_down_š_osds
 <ğ
num_š_osds
);

4752 ià(
num_down_š_osds
 > 0) {

4754 
ty³
 = 
max_ty³
;ype > 0;ype--) {

4755 ià(!
üush
->
	`g‘_ty³_Çme
(
ty³
))

4757 ià(
subŒ“_ty³_down
[
ty³
].
	`size
() > 0) {

4758 
o¡ršg¡»am
 
ss
;

4759 
ss
 << 
subŒ“_ty³_down
[
ty³
].
	`size
() << " "

4760 << 
üush
->
	`g‘_ty³_Çme
(
ty³
);

4761 ià(
subŒ“_ty³_down
[
ty³
].
	`size
() > 1) {

4762 
ss
 << "s";

4764 
sum_down_osds
 = 0;

4765 autØ
j
 = 
subŒ“_ty³_down
[
ty³
].
	`begš
();

4766 
j
 !ğ
subŒ“_ty³_down
[
ty³
].
	`’d
();

4767 ++
j
) {

4768 
sum_down_osds
 = sum_down_osd + 
num_osds_subŒ“
[*
j
];

4770 
ss
 << " (" << 
sum_down_osds
 << " osds) down";

4771 
¡ršg
 
”r
 = 
	`¡ršg
("OSD_") +

4772 
	`¡ršg
(
üush
->
	`g‘_ty³_Çme
(
ty³
)) + "_DOWN";

4773 
boo¡
::
	`to_uµ”
(
”r
);

4774 auto& 
d
 = 
checks
->
	`add
(
”r
, 
HEALTH_WARN
, 
ss
.
	`¡r
());

4775 autØ
j
 = 
subŒ“_ty³_down
[
ty³
].
	`rbegš
();

4776 
j
 !ğ
subŒ“_ty³_down
[
ty³
].
	`»nd
();

4777 ++
j
) {

4778 
o¡ršg¡»am
 
ss
;

4779 
ss
 << 
üush
->
	`g‘_ty³_Çme
(
ty³
);

4780 
ss
 << " ";

4781 
ss
 << 
üush
->
	`g‘_™em_Çme
(*
j
);

4783 ià(
ty³
 !ğ
max_ty³
) {

4784 
ss
 << " (";

4785 
ss
 << 
üush
->
	`g‘_fuÎ_loÿtiÚ_Üd”ed_¡ršg
(*
j
);

4786 
ss
 << ")";

4788 
num
 = 
num_osds_subŒ“
[*
j
];

4789 
ss
 << " (" << 
num
 << " osds)";

4790 
ss
 << " is down";

4791 
d
.
d‘a
.
	`push_back
(
ss
.
	`¡r
());

4795 
o¡ršg¡»am
 
ss
;

4796 
ss
 << 
down_š_osds
.
	`size
() << " osds down";

4797 auto& 
d
 = 
checks
->
	`add
("OSD_DOWN", 
HEALTH_WARN
, 
ss
.
	`¡r
());

4798 autØ
™
 = 
down_š_osds
.
	`begš
(); iˆ!ğdown_š_osds.
	`’d
(); ++it) {

4799 
o¡ršg¡»am
 
ss
;

4800 
ss
 << "osd." << *
™
 << " (";

4801 
ss
 << 
üush
->
	`g‘_fuÎ_loÿtiÚ_Üd”ed_¡ršg
(*
™
);

4802 
ss
 << ") is down";

4803 
d
.
d‘a
.
	`push_back
(
ss
.
	`¡r
());

4807 ià(!
osds
.
	`em±y
()) {

4808 
o¡ršg¡»am
 
ss
;

4809 
ss
 << 
osds
.
	`size
() << " osdsƒxist inhe crush map but‚ot inhe osdmap";

4810 auto& 
d
 = 
checks
->
	`add
("OSD_ORPHAN", 
HEALTH_WARN
, 
ss
.
	`¡r
());

4811 autØ
osd
 : 
osds
) {

4812 
o¡ršg¡»am
 
ss
;

4813 
ss
 << "osd." << 
osd
 << "ƒxists in crush map but‚ot in osdmap";

4814 
d
.
d‘a
.
	`push_back
(
ss
.
	`¡r
());

4823 
f¤
 = 
g_cÚf
->
osd_ç§ã_fuÎ_¿tio
;

4824 ià(
f¤
 > 1.0) fsr /= 100;

4825 
ä
 = 
	`g‘_fuÎ_¿tio
();

4826 
br
 = 
	`g‘_backflfuÎ_¿tio
();

4827 
Ä
 = 
	`g‘_Ã¬fuÎ_¿tio
();

4829 
li¡
<
¡ršg
> 
d‘a
;

4832 ià(
br
 < 
Ä
) {

4833 
o¡ršg¡»am
 
ss
;

4834 
ss
 << "backflfuÎ_¿tiØ(" << 
br


4835 << "è<‚—rfuÎ_¿tiØ(" << 
Ä
 << "), increased";

4836 
d‘a
.
	`push_back
(
ss
.
	`¡r
());

4837 
br
 = 
Ä
;

4839 ià(
ä
 < 
br
) {

4840 
o¡ršg¡»am
 
ss
;

4841 
ss
 << "fuÎ_¿tiØ(" << 
ä
 << "è< backflfuÎ_¿tiØ(" << 
br


4843 
d‘a
.
	`push_back
(
ss
.
	`¡r
());

4844 
ä
 = 
br
;

4846 ià(
f¤
 < 
ä
) {

4847 
o¡ršg¡»am
 
ss
;

4848 
ss
 << "osd_ç§ã_fuÎ_¿tiØ(" << 
f¤
 << "è< fuÎ_¿tiØ(" << 
ä


4850 
d‘a
.
	`push_back
(
ss
.
	`¡r
());

4852 ià(!
d‘a
.
	`em±y
()) {

4853 auto& 
d
 = 
checks
->
	`add
("OSD_OUT_OF_ORDER_FULL", 
HEALTH_ERR
,

4855 
d
.
d‘a
.
	`sw­
(detail);

4864 
£t
<> 
fuÎ
, 
backflfuÎ
, 
Ã¬fuÎ
;

4865 
	`g‘_fuÎ_osd_couÁs
(&
fuÎ
, &
backflfuÎ
, &
Ã¬fuÎ
);

4866 ià(
fuÎ
.
	`size
()) {

4867 
o¡ršg¡»am
 
ss
;

4868 
ss
 << 
fuÎ
.
	`size
() << " full osd(s)";

4869 auto& 
d
 = 
checks
->
	`add
("OSD_FULL", 
HEALTH_ERR
, 
ss
.
	`¡r
());

4870 auto& 
i
: 
fuÎ
) {

4871 
o¡ršg¡»am
 
ss
;

4872 
ss
 << "osd." << 
i
 << " is full";

4873 
d
.
d‘a
.
	`push_back
(
ss
.
	`¡r
());

4876 ià(
backflfuÎ
.
	`size
()) {

4877 
o¡ršg¡»am
 
ss
;

4878 
ss
 << 
backflfuÎ
.
	`size
() << " backfillfull osd(s)";

4879 auto& 
d
 = 
checks
->
	`add
("OSD_BACKFILLFULL", 
HEALTH_WARN
, 
ss
.
	`¡r
());

4880 auto& 
i
: 
backflfuÎ
) {

4881 
o¡ršg¡»am
 
ss
;

4882 
ss
 << "osd." << 
i
 << " is backfill full";

4883 
d
.
d‘a
.
	`push_back
(
ss
.
	`¡r
());

4886 ià(
Ã¬fuÎ
.
	`size
()) {

4887 
o¡ršg¡»am
 
ss
;

4888 
ss
 << 
Ã¬fuÎ
.
	`size
() << "‚earfull osd(s)";

4889 auto& 
d
 = 
checks
->
	`add
("OSD_NEARFULL", 
HEALTH_WARN
, 
ss
.
	`¡r
());

4890 auto& 
i
: 
Ã¬fuÎ
) {

4891 
o¡ršg¡»am
 
ss
;

4892 
ss
 << "osd." << 
i
 << " is‚ear full";

4893 
d
.
d‘a
.
	`push_back
(
ss
.
	`¡r
());

4901 
ušt64_t
 
w¬n_æags
 =

4902 
CEPH_OSDMAP_NEARFULL
 |

4903 
CEPH_OSDMAP_FULL
 |

4904 
CEPH_OSDMAP_PAUSERD
 |

4905 
CEPH_OSDMAP_PAUSEWR
 |

4906 
CEPH_OSDMAP_PAUSEREC
 |

4907 
CEPH_OSDMAP_NOUP
 |

4908 
CEPH_OSDMAP_NODOWN
 |

4909 
CEPH_OSDMAP_NOIN
 |

4910 
CEPH_OSDMAP_NOOUT
 |

4911 
CEPH_OSDMAP_NOBACKFILL
 |

4912 
CEPH_OSDMAP_NORECOVER
 |

4913 
CEPH_OSDMAP_NOSCRUB
 |

4914 
CEPH_OSDMAP_NODEEP_SCRUB
 |

4915 
CEPH_OSDMAP_NOTIERAGENT
 |

4916 
CEPH_OSDMAP_NOSNAPTRIM
 |

4917 
CEPH_OSDMAP_NOREBALANCE
;

4918 ià(
	`‹¡_æag
(
w¬n_æags
)) {

4919 
o¡ršg¡»am
 
ss
;

4920 
ss
 << 
	`g‘_æag_¡ršg
(
	`g‘_æags
(è& 
w¬n_æags
)

4922 
checks
->
	`add
("OSDMAP_FLAGS", 
HEALTH_WARN
, 
ss
.
	`¡r
());

4928 
li¡
<
¡ršg
> 
d‘a
;

4929 cÚ¡ 
æags
 =

4930 
CEPH_OSD_NOUP
 |

4931 
CEPH_OSD_NOIN
 |

4932 
CEPH_OSD_NODOWN
 |

4933 
CEPH_OSD_NOOUT
;

4934 
i
 = 0; i < 
max_osd
; ++i) {

4935 ià(
osd_¡©e
[
i
] & 
æags
) {

4936 
o¡ršg¡»am
 
ss
;

4937 
£t
<
¡ršg
> 
¡©es
;

4938 
OSDM­
::
	`ÿlc_¡©e_£t
(
osd_¡©e
[
i
] & 
æags
, 
¡©es
);

4939 
ss
 << "osd." << 
i
 << " ha æag " << 
¡©es
;

4940 
d‘a
.
	`push_back
(
ss
.
	`¡r
());

4943 ià(!
d‘a
.
	`em±y
()) {

4944 
o¡ršg¡»am
 
ss
;

4945 
ss
 << 
d‘a
.
	`size
() << " osd(s) have {NOUP,NODOWN,NOIN,NOOUT} flags set";

4946 auto& 
d
 = 
checks
->
	`add
("OSD_FLAGS", 
HEALTH_WARN
, 
ss
.
	`¡r
());

4947 
d
.
d‘a
.
	`sw­
(detail);

4952 ià(
g_cÚf
->
mÚ_w¬n_Ú_Ëgacy_üush_tuÇbËs
) {

4953 
¡ršg
 
mš
 = 
üush
->
	`g‘_mš_»quœed_v”siÚ
();

4954 ià(
mš
 < 
g_cÚf
->
mÚ_üush_mš_»quœed_v”siÚ
) {

4955 
o¡ršg¡»am
 
ss
;

4956 
ss
 << "üush m­ ha ËgacyuÇbË Ôequœ" << 
mš


4957 << ", mš i " << 
g_cÚf
->
mÚ_üush_mš_»quœed_v”siÚ
 << ")";

4958 auto& 
d
 = 
checks
->
	`add
("OLD_CRUSH_TUNABLES", 
HEALTH_WARN
, 
ss
.
	`¡r
());

4959 
d
.
d‘a
.
	`push_back
("see http://docs.ceph.com/docs/master/rados/operations/crush-map/#tunables");

4964 ià(
g_cÚf
->
mÚ_w¬n_Ú_üush_¡¿w_ÿlc_v”siÚ_z”o
) {

4965 ià(
üush
->
	`g‘_¡¿w_ÿlc_v”siÚ
() == 0) {

4966 
o¡ršg¡»am
 
ss
;

4967 
ss
 << "crush map has straw_calc_version=0";

4968 auto& 
d
 = 
checks
->
	`add
("OLD_CRUSH_STRAW_CALC_VERSION", 
HEALTH_WARN
, 
ss
.
	`¡r
());

4969 
d
.
d‘a
.
	`push_back
(

4975 ià(
g_cÚf
->
mÚ_w¬n_Ú_ÿche_poŞs_w™hout_h™_£ts
) {

4976 
li¡
<
¡ršg
> 
d‘a
;

4977 
m­
<
št64_t
, 
pg_poŞ_t
>::
cÚ¡_™”©Ü
 
p
 = 
poŞs
.
	`begš
();

4978 
p
 !ğ
poŞs
.
	`’d
();

4979 ++
p
) {

4980 cÚ¡ 
pg_poŞ_t
& 
šfo
 = 
p
->
£cÚd
;

4981 ià(
šfo
.
	`ÿche_mode_»quœes_h™_£t
() &&

4982 
šfo
.
h™_£t_·¿ms
.
	`g‘_ty³
(è=ğ
H™S‘
::
TYPE_NONE
) {

4983 
o¡ršg¡»am
 
ss
;

4984 
ss
 << "poŞ '" << 
	`g‘_poŞ_Çme
(
p
->
fœ¡
)

4985 << "' w™h cache_mod" << 
šfo
.
	`g‘_ÿche_mode_Çme
()

4987 
d‘a
.
	`push_back
(
ss
.
	`¡r
());

4990 ià(!
d‘a
.
	`em±y
()) {

4991 
o¡ršg¡»am
 
ss
;

4992 
ss
 << 
d‘a
.
	`size
() << " cache…ools‡re missing hit_sets";

4993 auto& 
d
 = 
checks
->
	`add
("CACHE_POOL_NO_HIT_SET", 
HEALTH_WARN
, 
ss
.
	`¡r
());

4994 
d
.
d‘a
.
	`sw­
(detail);

4999 ià(!
	`‹¡_æag
(
CEPH_OSDMAP_SORTBITWISE
)) {

5000 
o¡ršg¡»am
 
ss
;

5001 
ss
 << "'sortbitwise' flag is‚ot set";

5002 
checks
->
	`add
("OSD_NO_SORTBITWISE", 
HEALTH_WARN
, 
ss
.
	`¡r
());

5010 
li¡
<
¡ršg
> 
fuÎ_d‘a
, 
backflfuÎ_d‘a
, 
Ã¬fuÎ_d‘a
;

5011 autØ
™
 : 
	`g‘_poŞs
()) {

5012 cÚ¡ 
pg_poŞ_t
 &
poŞ
 = 
™
.
£cÚd
;

5013 cÚ¡ 
¡ršg
& 
poŞ_Çme
 = 
	`g‘_poŞ_Çme
(
™
.
fœ¡
);

5014 ià(
poŞ
.
	`has_æag
(
pg_poŞ_t
::
FLAG_FULL
)) {

5015 
¡ršg¡»am
 
ss
;

5016 ià(
poŞ
.
	`has_æag
(
pg_poŞ_t
::
FLAG_FULL_QUOTA
)) {

5019 
ss
 << "poŞ '" << 
poŞ_Çme
 << "' is full (running out of quota)";

5021 
ss
 << "poŞ '" << 
poŞ_Çme
 << "' is full (no space)";

5023 
fuÎ_d‘a
.
	`push_back
(
ss
.
	`¡r
());

5024 } ià(
poŞ
.
	`has_æag
(
pg_poŞ_t
::
FLAG_BACKFILLFULL
)) {

5025 
¡ršg¡»am
 
ss
;

5026 
ss
 << "poŞ '" << 
poŞ_Çme
 << "' is backfillfull";

5027 
backflfuÎ_d‘a
.
	`push_back
(
ss
.
	`¡r
());

5028 } ià(
poŞ
.
	`has_æag
(
pg_poŞ_t
::
FLAG_NEARFULL
)) {

5029 
¡ršg¡»am
 
ss
;

5030 
ss
 << "poŞ '" << 
poŞ_Çme
 << "' is‚earfull";

5031 
Ã¬fuÎ_d‘a
.
	`push_back
(
ss
.
	`¡r
());

5034 ià(!
fuÎ_d‘a
.
	`em±y
()) {

5035 
o¡ršg¡»am
 
ss
;

5036 
ss
 << 
fuÎ_d‘a
.
	`size
() << "…ool(s) full";

5037 auto& 
d
 = 
checks
->
	`add
("POOL_FULL", 
HEALTH_WARN
, 
ss
.
	`¡r
());

5038 
d
.
d‘a
.
	`sw­
(
fuÎ_d‘a
);

5040 ià(!
backflfuÎ_d‘a
.
	`em±y
()) {

5041 
o¡ršg¡»am
 
ss
;

5042 
ss
 << 
backflfuÎ_d‘a
.
	`size
() << "…ool(s) backfillfull";

5043 auto& 
d
 = 
checks
->
	`add
("POOL_BACKFILLFULL", 
HEALTH_WARN
, 
ss
.
	`¡r
());

5044 
d
.
d‘a
.
	`sw­
(
backflfuÎ_d‘a
);

5046 ià(!
Ã¬fuÎ_d‘a
.
	`em±y
()) {

5047 
o¡ršg¡»am
 
ss
;

5048 
ss
 << 
Ã¬fuÎ_d‘a
.
	`size
() << "…ool(s)‚earfull";

5049 auto& 
d
 = 
checks
->
	`add
("POOL_NEARFULL", 
HEALTH_WARN
, 
ss
.
	`¡r
());

5050 
d
.
d‘a
.
	`sw­
(
Ã¬fuÎ_d‘a
);

5053 
	}
}

5055 
	gOSDM­
::
·r£_osd_id_li¡
(cÚ¡ 
veùÜ
<
¡ršg
>& 
ls
, 
£t
<> *
out
,

5056 
o¡»am
 *
ss
) const

5058 
	gout
->
ş—r
();

5059 autØ
	gi
 = 
ls
.
begš
(); i !ğls.
’d
(); ++i) {

5060 ià(
	gi
 =ğ
ls
.
begš
() &&

5061 (*
i
 == "any" || *i == "all" || *i == "*")) {

5062 
g‘_®l_osds
(*
out
);

5065 
	gosd
 = 
·r£_osd_id
(
i
->
c_¡r
(), 
ss
);

5066 ià(
	gosd
 < 0) {

5067 *
	gss
 << "šv®id osd id '" << *
	gi
 << "'";

5068  -
	gEINVAL
;

5070 
	gout
->
š£¹
(
osd
);

	@osd/OSDMap.h

19 #iâdeà
CEPH_OSDMAP_H


20 
	#CEPH_OSDMAP_H


	)

27 
	~"šşude/ty³s.h
"

28 
	~"osd_ty³s.h
"

31 
	~"üush/CrushW¿µ”.h
"

32 
	~<veùÜ
>

33 
	~<li¡
>

34 
	~<£t
>

35 
	~<m­
>

36 
	~"šşude/memÜy.h
"

37 
	~"šşude/bŒ“_m­.h
"

40 
şass
 
	gC•hCÚ‹xt
;

41 
şass
 
	gCrushW¿µ”
;

42 
şass
 
	gh—Éh_check_m­_t
;

66 
	sosd_šfo_t
 {

67 
•och_t
 
	mÏ¡_ş—n_begš
;

68 
•och_t
 
	mÏ¡_ş—n_’d
;

69 
•och_t
 
	mup_äom
;

70 
•och_t
 
	mup_thru
;

71 
•och_t
 
	mdown_©
;

72 
•och_t
 
	mlo¡_©
;

74 
osd_šfo_t
(è: 
Ï¡_ş—n_begš
(0), 
Ï¡_ş—n_’d
(0),

75 
up_äom
(0), 
up_thru
(0), 
down_©
(0), 
lo¡_©
(0) {}

77 
dump
(
FÜm©‹r
 *
f
) const;

78 
’code
(
bufã¾i¡
& 
bl
) const;

79 
decode
(
bufã¾i¡
::
™”©Ü
& 
bl
);

80 
g’”©e_‹¡_š¡ªûs
(
li¡
<
osd_šfo_t
*>& 
o
);

82 
	$WRITE_CLASS_ENCODER
(
osd_šfo_t
)

84 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
osd_šfo_t
& 
šfo
);

86 
	sosd_xšfo_t
 {

87 
utime_t
 
down_¡amp
;

88 
Ïggy_´obab™y
;

89 
__u32
 
Ïggy_š‹rv®
;

90 
ušt64_t
 
ã©u»s
;

91 
__u32
 
Şd_weight
;

93 
	`osd_xšfo_t
(è: 
	`Ïggy_´obab™y
(0), 
	`Ïggy_š‹rv®
(0),

94 
	`ã©u»s
(0), 
	`Şd_weight
(0) {}

96 
	`dump
(
FÜm©‹r
 *
f
) const;

97 
	`’code
(
bufã¾i¡
& 
bl
) const;

98 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
bl
);

99 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
osd_xšfo_t
*>& 
o
);

101 
	$WRITE_CLASS_ENCODER
(
osd_xšfo_t
)

103 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
osd_xšfo_t
& 
xi
);

106 
	sPGTempM­
 {

108 
bufã¾i¡
 
d©a
;

109 
bŒ“
::
	tbŒ“_m­
<
	tpg_t
,
	tšt32_t
*> 
	tm­_t
;

110 
m­_t
 
m­
;

112 
	`’code
(
bufã¾i¡
& 
bl
) const {

113 
usšg
 
ûph
::
’code
;

114 
ušt32_t
 
n
 = 
m­
.
	`size
();

115 
	`’code
(
n
, 
bl
);

116 autØ&
p
 : 
m­
) {

117 
	`’code
(
p
.
fœ¡
, 
bl
);

118 
bl
.
	`­³nd
((*)
p
.
£cÚd
, (*p.£cÚd + 1è* (
št32_t
));

121 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
p
) {

122 
usšg
 
ûph
::
decode
;

123 
d©a
.
	`ş—r
();

124 
m­
.
	`ş—r
();

125 
ušt32_t
 
n
;

126 
	`decode
(
n
, 
p
);

127 ià(!
n
)

129 
bufã¾i¡
::
™”©Ü
 
p¡¬t
 = 
p
;

130 
size_t
 
¡¬t_off
 = 
p¡¬t
.
	`g‘_off
();

131 
veùÜ
<
·œ
<
pg_t
,
size_t
>> 
off£ts
;

132 
off£ts
.
	`»size
(
n
);

133 
i
=0; i<
n
; ++i) {

134 
pg_t
 
pgid
;

135 
	`decode
(
pgid
, 
p
);

136 
off£ts
[
i
].
fœ¡
 = 
pgid
;

137 
off£ts
[
i
].
£cÚd
 = 
p
.
	`g‘_off
(è- 
¡¬t_off
;

138 
ušt32_t
 
vn
;

139 
	`decode
(
vn
, 
p
);

140 
p
.
	`advªû
(
vn
 * (
št32_t
));

142 
size_t
 
Ën
 = 
p
.
	`g‘_off
(è- 
¡¬t_off
;

143 
p¡¬t
.
	`cİy
(
Ën
, 
d©a
);

144 ià(
d©a
.
	`g‘_num_bufãrs
() > 1) {

145 
d©a
.
	`»bud
();

148 *
¡¬t
 = 
d©a
.
	`c_¡r
();

149 autØ
i
 : 
off£ts
) {

150 
m­
.
	`š£¹
(m­.
	`’d
(), 
	`make_·œ
(
i
.
fœ¡
, (
št32_t
*)(
¡¬t
 + i.
£cÚd
)));

153 
	`»bud
() {

154 
bufã¾i¡
 
bl
;

155 
	`’code
(
bl
);

156 autØ
p
 = 
bl
.
	`begš
();

157 
	`decode
(
p
);

159 
ä›nd
 
boŞ
 
İ”©Ü
==(cÚ¡ 
PGTempM­
& 
l
, cÚ¡ PGTempM­& 
r
) {

161 
l
.
m­
.
	`size
(è=ğ
r
.map.size() &&

162 
l
.
d©a
.
	`cÚ‹Ás_equ®
(
r
.data);

165 şas 
	c™”©Ü
 {

166 
m­_t
::
cÚ¡_™”©Ü
 
™
;

167 
m­_t
::
cÚ¡_™”©Ü
 
’d
;

168 
·œ
<
pg_t
,
veùÜ
<
št32_t
>> 
cu¼’t
;

169 
	`š™_cu¼’t
() {

170 ià(
™
 !ğ
’d
) {

171 
cu¼’t
.
fœ¡
 = 
™
->first;

172 
	`as£¹
(
™
->
£cÚd
);

173 
cu¼’t
.
£cÚd
.
	`»size
(*
™
->second);

174 
št32_t
 *
p
 = 
™
->
£cÚd
 + 1;

175 
n
 = 0;‚ < *
™
->
£cÚd
; ++n, ++
p
) {

176 
cu¼’t
.
£cÚd
[
n
] = *
p
;

180 
public
:

181 
	`™”©Ü
(
m­_t
::
cÚ¡_™”©Ü
 
p
,

182 
m­_t
::
cÚ¡_™”©Ü
 
e
)

183 : 
	`™
(
p
), 
	`’d
(
e
) {

184 
	`š™_cu¼’t
();

187 cÚ¡ 
·œ
<
pg_t
,
veùÜ
<
št32_t
>>& 
İ”©Ü
*() const {

188  
cu¼’t
;

190 cÚ¡ 
·œ
<
pg_t
,
veùÜ
<
št32_t
>>* 
İ”©Ü
->() const {

191  &
cu¼’t
;

193 
ä›nd
 
boŞ
 
İ”©Ü
==(cÚ¡ 
™”©Ü
& 
l
, cÚ¡ i‹¿tÜ& 
r
) {

194  
l
.
™
 =ğ
r
.it;

196 
ä›nd
 
boŞ
 
İ”©Ü
!=(cÚ¡ 
™”©Ü
& 
l
, cÚ¡ i‹¿tÜ& 
r
) {

197  
l
.
™
 !ğ
r
.it;

199 
™”©Ü
& 
İ”©Ü
++() {

200 ++
™
;

201 ià(
™
 !ğ
’d
)

202 
	`š™_cu¼’t
();

203  *
this
;

205 
™”©Ü
 
İ”©Ü
++() {

206 
™”©Ü
 
r
 = *
this
;

207 ++
™
;

208 ià(
™
 !ğ
’d
)

209 
	`š™_cu¼’t
();

210  
r
;

213 
™”©Ü
 
	$begš
() const {

214  
	`™”©Ü
(
m­
.
	`begš
(), m­.
	`’d
());

215 
	}
}

216 
™”©Ü
 
	$’d
() const {

217  
	`™”©Ü
(
m­
.
	`’d
(), map.end());

218 
	}
}

219 
™”©Ü
 
	$fšd
(
pg_t
 
pgid
) const {

220  
	`™”©Ü
(
m­
.
	`fšd
(
pgid
), m­.
	`’d
());

221 
	}
}

222 
size_t
 
	$size
() const {

223  
m­
.
	`size
();

224 
	}
}

225 
size_t
 
	$couÁ
(
pg_t
 
pgid
) const {

226  
m­
.
	`couÁ
(
pgid
);

227 
	}
}

228 
	$”a£
(
pg_t
 
pgid
) {

229 
m­
.
	`”a£
(
pgid
);

230 
	}
}

231 
	$ş—r
() {

232 
m­
.
	`ş—r
();

233 
d©a
.
	`ş—r
();

234 
	}
}

235 
£t
(
pg_t
 
pgid
, cÚ¡ 
mempoŞ
::
osdm­
::
veùÜ
<
št32_t
>& 
v
) {

236 
usšg
 
ûph
::
’code
;

237 
size_t
 
	gÃed
 = (
št32_t
è* (1 + 
v
.
size
());

238 ià(
	gÃed
 < 
	gd©a
.
g‘_­³nd_bufãr_unu£d__Ëngth
()) {

239 
bufã½Œ
 
z
(
d©a
.
g‘_­³nd_bufãr_unu£d__Ëngth
());

240 
	gz
.
z”o
();

241 
	gd©a
.
­³nd
(
z
.
c_¡r
(), z.
Ëngth
());

243 
’code
(
v
, 
d©a
);

244 
	gm­
[
pgid
] = (
št32_t
*)(
d©a
.
back
().
’d_c_¡r
()è- (1 + 
v
.
size
());

246 
	gmempoŞ
::
osdm­
::
veùÜ
<
št32_t
> 
	$g‘
(
pg_t
 
pgid
) {

247 
mempoŞ
::
osdm­
::
veùÜ
<
št32_t
> 
v
;

248 
št32_t
 *
p
 = 
m­
[
pgid
];

249 
size_t
 
n
 = *
p
++;

250 
v
.
	`»size
(
n
);

251 
size_t
 
i
 = 0; i < 
n
; ++i, ++
p
) {

252 
v
[
i
] = *
p
;

254  
v
;

255 
	}
}

258 
	gmempoŞ
::
osdm­
::
m­
<
pg_t
,mempoŞ::osdm­::
veùÜ
<
št32_t
> > 
pg_‹mp
;

260 
	$’code
(
bufã¾i¡
& 
bl
) const {

261 
	`’code
(
pg_‹mp
, 
bl
);

262 
	}
}

263 
	$decode
(
bufã¾i¡
::
™”©Ü
& 
p
) {

264 
	`decode
(
pg_‹mp
, 
p
);

265 
	}
}

266 
ä›nd
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
PGTempM­
& 
l
, cÚ¡ 
	gPGTempM­
& 
	gr
) {

268 
	gl
.
	gpg_‹mp
.
size
(è=ğ
r
.
pg_‹mp
.size() &&

269 
l
.
pg_‹mp
 =ğ
r
.pg_temp;

272 şas 
	c™”©Ü
 {

273 
	gmempoŞ
::
osdm­
::
m­
<
pg_t
,mempoŞ::osdm­::
veùÜ
<
št32_t
> >::
cÚ¡_™”©Ü
 
™
;

274 
	gpublic
:

275 
™”©Ü
(
mempoŞ
::
osdm­
::
m­
<
pg_t
,

276 
mempoŞ
::
osdm­
::
veùÜ
<
št32_t
> >::
cÚ¡_™”©Ü
 
p
)

277 : 
™
(
p
) {}

279 
·œ
<
pg_t
,cÚ¡ 
	gmempoŞ
::
osdm­
::
veùÜ
<
št32_t
>&> 
İ”©Ü
*() const {

280  *
™
;

282 cÚ¡ 
	g·œ
<cÚ¡ 
	gpg_t
,
	gmempoŞ
::
osdm­
::
veùÜ
<
št32_t
>>* 
İ”©Ü
->() const {

283  &*
™
;

285 
ä›nd
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
™”©Ü
& 
l
, cÚ¡ 
	g™”©Ü
& 
	gr
) {

286  
	gl
.
	g™
 =ğ
r
.
™
;

288 
ä›nd
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
™”©Ü
& 
l
, cÚ¡ 
	g™”©Ü
& 
	gr
) {

289  
	gl
.
	g™
 !ğ
r
.
™
;

291 
	g™”©Ü
& 
	gİ”©Ü
++() {

292 ++
	g™
;

293  *
	gthis
;

295 
™”©Ü
 
	gİ”©Ü
++() {

296 
™”©Ü
 
	gr
 = *
this
;

297 ++
	g™
;

298  
	gr
;

301 
™”©Ü
 
	$begš
() const {

302  
	`™”©Ü
(
pg_‹mp
.
	`cbegš
());

303 
	}
}

304 
™”©Ü
 
	$’d
() const {

305  
	`™”©Ü
(
pg_‹mp
.
	`ûnd
());

306 
	}
}

307 
™”©Ü
 
	$fšd
(
pg_t
 
pgid
) const {

308  
	`™”©Ü
(
pg_‹mp
.
	`fšd
(
pgid
));

309 
	}
}

310 
size_t
 
	$size
() const {

311  
pg_‹mp
.
	`size
();

312 
	}
}

313 
size_t
 
	$couÁ
(
pg_t
 
pgid
) const {

314  
pg_‹mp
.
	`couÁ
(
pgid
);

315 
	}
}

316 
	$”a£
(
pg_t
 
pgid
) {

317 
pg_‹mp
.
	`”a£
(
pgid
);

318 
	}
}

319 
	$ş—r
() {

320 
pg_‹mp
.
	`ş—r
();

321 
	}
}

322 
£t
(
pg_t
 
pgid
, cÚ¡ 
mempoŞ
::
osdm­
::
veùÜ
<
št32_t
>& 
v
) {

323 
pg_‹mp
[
pgid
] = 
v
;

325 cÚ¡ 
	gmempoŞ
::
osdm­
::
veùÜ
<
št32_t
>& 
	$g‘
(
pg_t
 
pgid
) {

326  
pg_‹mp
.
	`©
(
pgid
);

327 
	}
}

329 
	$dump
(
FÜm©‹r
 *
f
) const {

330 cÚ¡‡utØ&
pg
 : *
this
) {

331 
f
->
	`İ’_objeù_£ùiÚ
("osds");

332 
f
->
	`dump_¡»am
("pgid"è<< 
pg
.
fœ¡
;

333 
f
->
	`İ’_¬¿y_£ùiÚ
("osds");

334 cÚ¡‡utØ
osd
 : 
pg
.
£cÚd
)

335 
f
->
	`dump_št
("osd", 
osd
);

336 
f
->
	`şo£_£ùiÚ
();

337 
f
->
	`şo£_£ùiÚ
();

339 
	}
}

341 
	$WRITE_CLASS_ENCODER
(
PGTempM­
)

345 şas 
	cOSDM­
 {

346 
public
:

347 
	`MEMPOOL_CLASS_HELPERS
();

349 
š‹rv®_£t
<

350 
	t¢­id_t
,

351 
	tmempoŞ
::
	tosdm­
::
	tæ©_m­
<
	t¢­id_t
,¢­id_t>> 
	t¢­_š‹rv®_£t_t
;

353 şas 
	cInüem’l
 {

354 
public
:

355 
	`MEMPOOL_CLASS_HELPERS
();

359 
ušt64_t
 
’code_ã©u»s
;

360 
uuid_d
 
fsid
;

361 
•och_t
 
•och
;

362 
utime_t
 
modif›d
;

363 
št64_t
 
Ãw_poŞ_max
;

364 
št32_t
 
Ãw_æags
;

365 
št8_t
 
Ãw_»quœe_osd_»Ëa£
 = -1;

368 
bufã¾i¡
 
fuÎm­
;

369 
bufã¾i¡
 
üush
;

372 
št32_t
 
Ãw_max_osd
;

373 
mempoŞ
::
osdm­
::
m­
<
št64_t
,
pg_poŞ_t
> 
Ãw_poŞs
;

374 
mempoŞ
::
osdm­
::
m­
<
št64_t
,
¡ršg
> 
Ãw_poŞ_Çmes
;

375 
mempoŞ
::
osdm­
::
£t
<
št64_t
> 
Şd_poŞs
;

376 
mempoŞ
::
osdm­
::
m­
<
¡ršg
,m­<¡ršg,¡ršg> > 
Ãw_”asu»_code_´ofes
;

377 
mempoŞ
::
osdm­
::
veùÜ
<
¡ršg
> 
Şd_”asu»_code_´ofes
;

378 
mempoŞ
::
osdm­
::
m­
<
št32_t
,
’t™y_addr_t
> 
Ãw_up_ş›Á
;

379 
mempoŞ
::
osdm­
::
m­
<
št32_t
,
’t™y_addr_t
> 
Ãw_up_şu¡”
;

380 
mempoŞ
::
osdm­
::
m­
<
št32_t
,
ušt32_t
> 
Ãw_¡©e
;

381 
mempoŞ
::
osdm­
::
m­
<
št32_t
,
ušt32_t
> 
Ãw_weight
;

382 
mempoŞ
::
osdm­
::
m­
<
pg_t
,mempoŞ::osdm­::
veùÜ
<
št32_t
> > 
Ãw_pg_‹mp
;

383 
mempoŞ
::
osdm­
::
m­
<
pg_t
, 
št32_t
> 
Ãw_´im¬y_‹mp
;

384 
mempoŞ
::
osdm­
::
m­
<
št32_t
,
ušt32_t
> 
Ãw_´im¬y_affš™y
;

385 
mempoŞ
::
osdm­
::
m­
<
št32_t
,
•och_t
> 
Ãw_up_thru
;

386 
mempoŞ
::
osdm­
::
m­
<
št32_t
,
·œ
<
•och_t
,•och_t> > 
Ãw_Ï¡_ş—n_š‹rv®
;

387 
mempoŞ
::
osdm­
::
m­
<
št32_t
,
•och_t
> 
Ãw_lo¡
;

388 
mempoŞ
::
osdm­
::
m­
<
št32_t
,
uuid_d
> 
Ãw_uuid
;

389 
mempoŞ
::
osdm­
::
m­
<
št32_t
,
osd_xšfo_t
> 
Ãw_xšfo
;

391 
mempoŞ
::
osdm­
::
m­
<
’t™y_addr_t
,
utime_t
> 
Ãw_bÏckli¡
;

392 
mempoŞ
::
osdm­
::
veùÜ
<
’t™y_addr_t
> 
Şd_bÏckli¡
;

393 
mempoŞ
::
osdm­
::
m­
<
št32_t
, 
’t™y_addr_t
> 
Ãw_hb_back_up
;

394 
mempoŞ
::
osdm­
::
m­
<
št32_t
, 
’t™y_addr_t
> 
Ãw_hb_äÚt_up
;

396 
mempoŞ
::
osdm­
::
m­
<
pg_t
,mempoŞ::osdm­::
veùÜ
<
št32_t
>> 
Ãw_pg_upm­
;

397 
mempoŞ
::
osdm­
::
m­
<
pg_t
,mempoŞ::osdm­::
veùÜ
<
·œ
<
št32_t
,št32_t>>> 
Ãw_pg_upm­_™ems
;

398 
mempoŞ
::
osdm­
::
£t
<
pg_t
> 
Şd_pg_upm­
, 
Şd_pg_upm­_™ems
;

399 
mempoŞ
::
osdm­
::
m­
<
št64_t
, 
¢­_š‹rv®_£t_t
> 
Ãw_»moved_¢­s
;

400 
mempoŞ
::
osdm­
::
m­
<
št64_t
, 
¢­_š‹rv®_£t_t
> 
Ãw_purged_¢­s
;

402 
¡ršg
 
şu¡”_¢­shÙ
;

404 
Ãw_Ã¬fuÎ_¿tio
 = -1;

405 
Ãw_backflfuÎ_¿tio
 = -1;

406 
Ãw_fuÎ_¿tio
 = -1;

408 
št8_t
 
Ãw_»quœe_mš_com·t_ş›Á
 = -1;

410 
mubË
 
boŞ
 
have_üc
;

411 
ušt32_t
 
fuÎ_üc
;

412 
mubË
 
ušt32_t
 
šc_üc
;

414 
	`g‘_Ãt_m¬ked_out
(cÚ¡ 
OSDM­
 *
´evious
) const;

415 
	`g‘_Ãt_m¬ked_down
(cÚ¡ 
OSDM­
 *
´evious
) const;

416 
	`id’tify_osd
(
uuid_d
 
u
) const;

418 
	`’code_ş›Á_Şd
(
bufã¾i¡
& 
bl
) const;

419 
	`’code_şassic
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
) const;

420 
	`’code
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
=
CEPH_FEATURES_ALL
) const;

421 
	`decode_şassic
(
bufã¾i¡
::
™”©Ü
 &
p
);

422 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

423 
	`dump
(
FÜm©‹r
 *
f
) const;

424 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
Inüem’l
*>& 
o
);

426 
ex¶ic™
 
	`Inüem’l
(
•och_t
 
e
=0) :

427 
	`’code_ã©u»s
(0),

428 
	`•och
(
e
), 
	`Ãw_poŞ_max
(-1), 
	`Ãw_æags
(-1), 
	`Ãw_max_osd
(-1),

429 
	`have_üc
(
çl£
), 
	`fuÎ_üc
(0), 
	`šc_üc
(0) {

431 
ex¶ic™
 
	`Inüem’l
(
bufã¾i¡
 &
bl
) {

432 
bufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
	`begš
();

433 
	`decode
(
p
);

435 
ex¶ic™
 
	`Inüem’l
(
bufã¾i¡
::
™”©Ü
 &
p
) {

436 
	`decode
(
p
);

439 
pg_poŞ_t
 *
	`g‘_Ãw_poŞ
(
št64_t
 
poŞ
, cÚ¡…g_poŞ_ˆ*
Üig
) {

440 ià(
Ãw_poŞs
.
	`couÁ
(
poŞ
) == 0)

441 
Ãw_poŞs
[
poŞ
] = *
Üig
;

442  &
Ãw_poŞs
[
poŞ
];

444 
boŞ
 
	`has_”asu»_code_´ofe
(cÚ¡ 
¡ršg
 &
Çme
) const {

445 autØ
i
 = 
Ãw_”asu»_code_´ofes
.
	`fšd
(
Çme
);

446  
i
 !ğ
Ãw_”asu»_code_´ofes
.
	`’d
();

448 
	`£t_”asu»_code_´ofe
(cÚ¡ 
¡ršg
 &
Çme
,

449 cÚ¡ 
m­
<
¡ršg
,¡ršg>& 
´ofe
) {

450 
Ãw_”asu»_code_´ofes
[
Çme
] = 
´ofe
;

454 
	`´İag©e_¢­s_to_t›rs
(
C•hCÚ‹xt
 *
cù
, cÚ¡ 
OSDM­
 &
ba£
);

457 
size_t
 
	`g‘_³ndšg_¡©e_osds
(
veùÜ
<> *
osds
) {

458 
	`as£¹
(
osds
);

459 
osds
->
	`ş—r
();

461 autØ&
p
 : 
Ãw_¡©e
) {

462 
osds
->
	`push_back
(
p
.
fœ¡
);

465  
osds
->
	`size
();

468 
boŞ
 
	`³ndšg_osd_has_¡©e
(
osd
, 
¡©e
) {

469  
Ãw_¡©e
.
	`couÁ
(
osd
è&& (Ãw_¡©e[osd] & 
¡©e
) != 0;

472 
	`³ndšg_osd_¡©e_£t
(
osd
, 
¡©e
) {

473 
Ãw_¡©e
[
osd
] |ğ
¡©e
;

478 
boŞ
 
	`³ndšg_osd_¡©e_ş—r
(
osd
, 
¡©e
) {

479 ià(!
	`³ndšg_osd_has_¡©e
(
osd
, 
¡©e
)) {

481  
çl£
;

484 
Ãw_¡©e
[
osd
] &ğ~
¡©e
;

485 ià(!
Ãw_¡©e
[
osd
]) {

487 
Ãw_¡©e
.
	`”a£
(
osd
);

489  
Œue
;

494 
´iv©e
:

495 
uuid_d
 
fsid
;

496 
•och_t
 
•och
;

497 
utime_t
 
ü—‹d
, 
modif›d
;

498 
št32_t
 
poŞ_max
;

500 
ušt32_t
 
æags
;

502 
num_osd
;

503 
num_up_osd
;

504 
num_š_osd
;

506 
št32_t
 
max_osd
;

507 
veùÜ
<
ušt32_t
> 
osd_¡©e
;

512 
cÚ¡ex´
 
ušt64_t
 
SIGNIFICANT_FEATURES
 =

513 
CEPH_FEATUREMASK_PGID64
 |

514 
CEPH_FEATUREMASK_PGPOOL3
 |

515 
CEPH_FEATUREMASK_OSDENC
 |

516 
CEPH_FEATUREMASK_OSDMAP_ENC
 |

517 
CEPH_FEATUREMASK_OSD_POOLRESEND
 |

518 
CEPH_FEATUREMASK_NEW_OSDOP_ENCODING
 |

519 
CEPH_FEATUREMASK_MSG_ADDR2
 |

520 
CEPH_FEATUREMASK_CRUSH_TUNABLES5
 |

521 
CEPH_FEATUREMASK_CRUSH_CHOOSE_ARGS
 |

522 
CEPH_FEATUREMASK_SERVER_LUMINOUS
 |

523 
CEPH_FEATUREMASK_SERVER_MIMIC
;

525 
	saddrs_s
 {

526 
mempoŞ
::
osdm­
::
veùÜ
<
ûph
::
sh¬ed_±r
<
’t™y_addr_t
> > 
ş›Á_addr
;

527 
mempoŞ
::
osdm­
::
veùÜ
<
ûph
::
sh¬ed_±r
<
’t™y_addr_t
> > 
şu¡”_addr
;

528 
mempoŞ
::
osdm­
::
veùÜ
<
ûph
::
sh¬ed_±r
<
’t™y_addr_t
> > 
hb_back_addr
;

529 
mempoŞ
::
osdm­
::
veùÜ
<
ûph
::
sh¬ed_±r
<
’t™y_addr_t
> > 
hb_äÚt_addr
;

530 
’t™y_addr_t
 
bÏnk
;

531 
	}
};

532 
	gûph
::
sh¬ed_±r
<
addrs_s
> 
osd_addrs
;

534 
	gmempoŞ
::
osdm­
::
veùÜ
<
__u32
> 
osd_weight
;

535 
	gmempoŞ
::
osdm­
::
veùÜ
<
osd_šfo_t
> 
osd_šfo
;

536 
	gûph
::
sh¬ed_±r
<
PGTempM­
> 
pg_‹mp
;

537 
	gûph
::
sh¬ed_±r
< 
mempoŞ
::
osdm­
::
m­
<
pg_t
,
	gšt32_t
 > > 
	g´im¬y_‹mp
;

538 
	gûph
::
sh¬ed_±r
< 
mempoŞ
::
osdm­
::
veùÜ
<
__u32
> > 
osd_´im¬y_affš™y
;

541 
	gmempoŞ
::
osdm­
::
m­
<
pg_t
,mempoŞ::osdm­::
veùÜ
<
št32_t
>> 
pg_upm­
;

542 
	gmempoŞ
::
osdm­
::
m­
<
pg_t
,mempoŞ::osdm­::
veùÜ
<
·œ
<
št32_t
,
	gšt32_t
>>> 
	gpg_upm­_™ems
;

544 
	gmempoŞ
::
osdm­
::
m­
<
št64_t
,
	gpg_poŞ_t
> 
	gpoŞs
;

545 
	gmempoŞ
::
osdm­
::
m­
<
št64_t
,
	g¡ršg
> 
	gpoŞ_Çme
;

546 
	gmempoŞ
::
osdm­
::
m­
<
¡ršg
,
	gm­
<
	g¡ršg
,¡ršg> > 
	g”asu»_code_´ofes
;

547 
	gmempoŞ
::
osdm­
::
m­
<
¡ršg
,
	gšt64_t
> 
	gÇme_poŞ
;

549 
	gûph
::
sh¬ed_±r
< 
mempoŞ
::
osdm­
::
veùÜ
<
uuid_d
> > 
osd_uuid
;

550 
	gmempoŞ
::
osdm­
::
veùÜ
<
osd_xšfo_t
> 
osd_xšfo
;

552 
	gmempoŞ
::
osdm­
::
unÜd”ed_m­
<
’t™y_addr_t
,
	gutime_t
> 
	gbÏckli¡
;

555 
	gmempoŞ
::
osdm­
::
m­
<
št64_t
, 
	g¢­_š‹rv®_£t_t
> 
	g»moved_¢­s_queue
;

558 
	gmempoŞ
::
osdm­
::
m­
<
št64_t
, 
	g¢­_š‹rv®_£t_t
> 
	gÃw_»moved_¢­s
;

561 
	gmempoŞ
::
osdm­
::
m­
<
št64_t
, 
	g¢­_š‹rv®_£t_t
> 
	gÃw_purged_¢­s
;

563 
•och_t
 
	gşu¡”_¢­shÙ_•och
;

564 
¡ršg
 
	gşu¡”_¢­shÙ
;

565 
boŞ
 
	gÃw_bÏckli¡_’Œ›s
;

567 
	gfuÎ_¿tio
 = 0, 
	gbackflfuÎ_¿tio
 = 0, 
	gÃ¬fuÎ_¿tio
 = 0;

570 
ušt8_t
 
	g»quœe_mš_com·t_ş›Á
 = 0;

572 
	gpublic
:

574 
ušt8_t
 
»quœe_osd_»Ëa£
 = 0;

576 
	g´iv©e
:

577 
mubË
 
ušt64_t
 
ÿched_up_osd_ã©u»s
;

579 
mubË
 
boŞ
 
	güc_defšed
;

580 
mubË
 
ušt32_t
 
	güc
;

582 
_ÿlc_up_osd_ã©u»s
();

584 
	gpublic
:

585 
boŞ
 
	$have_üc
(ècÚ¡ {  
üc_defšed
; 
	}
}

586 
ušt32_t
 
	$g‘_üc
(ècÚ¡ {  
üc
; 
	}
}

588 
	gûph
::
sh¬ed_±r
<
CrushW¿µ”
> 
üush
;

589 
	g´iv©e
:

590 
ušt32_t
 
üush_v”siÚ
 = 1;

592 
ä›nd
 
şass
 
	gOSDMÚ™Ü
;

594 
	gpublic
:

595 
	$OSDM­
(è: 
	`•och
(0),

596 
	`poŞ_max
(0),

597 
	`æags
(0),

598 
	`num_osd
(0), 
	`num_up_osd
(0), 
	`num_š_osd
(0),

599 
	`max_osd
(0),

600 
	`osd_addrs
(
¡d
::
make_sh¬ed
<
addrs_s
>()),

601 
	`pg_‹mp
(
¡d
::
make_sh¬ed
<
PGTempM­
>()),

602 
	`´im¬y_‹mp
(
¡d
::
make_sh¬ed
<
mempoŞ
::
osdm­
::
m­
<
pg_t
,
št32_t
>>()),

603 
	`osd_uuid
(
¡d
::
make_sh¬ed
<
mempoŞ
::
osdm­
::
veùÜ
<
uuid_d
>>()),

604 
	`şu¡”_¢­shÙ_•och
(0),

605 
	`Ãw_bÏckli¡_’Œ›s
(
çl£
),

606 
	`ÿched_up_osd_ã©u»s
(0),

607 
	`üc_defšed
(
çl£
), 
	`üc
(0),

608 
	`üush
(
¡d
::
make_sh¬ed
<
CrushW¿µ”
>()) {

609 
	}
}

611 
´iv©e
:

612 
OSDM­
(cÚ¡ OSDM­& 
Ùh”
) = ;

613 
	gOSDM­
& 
	gİ”©Ü
=(cÚ¡ 
OSDM­
& 
Ùh”
) = ;

614 
	gpublic
:

617 
ušt64_t
 
	$g‘_signifiÿÁ_ã©u»s
(
ušt64_t
 
ã©u»s
) {

618  
SIGNIFICANT_FEATURES
 & 
ã©u»s
;

619 
	}
}

621 
ušt64_t
 
	$g‘_’codšg_ã©u»s
() const;

623 
	$d“pish_cİy_äom
(cÚ¡ 
OSDM­
& 
o
) {

624 *
this
 = 
o
;

625 
´im¬y_‹mp
.
	`»£t
(
Ãw
 
mempoŞ
::
osdm­
::
m­
<
pg_t
,
št32_t
>(*
o
.primary_temp));

626 
pg_‹mp
.
	`»£t
(
Ãw
 
	`PGTempM­
(*
o
.pg_temp));

627 
osd_uuid
.
	`»£t
(
Ãw
 
mempoŞ
::
osdm­
::
veùÜ
<
uuid_d
>(*
o
.osd_uuid));

629 ià(
o
.
osd_´im¬y_affš™y
)

630 
osd_´im¬y_affš™y
.
	`»£t
(
Ãw
 
mempoŞ
::
osdm­
::
veùÜ
<
__u32
>(*
o
.osd_primary_affinity));

633 
osd_addrs
.
	`»£t
(
Ãw
 
	`addrs_s
(*
o
.osd_addrs));

637 
	}
}

640 cÚ¡ 
	guuid_d
& 
	$g‘_fsid
(ècÚ¡ {  
fsid
; 
	}
}

641 
	$£t_fsid
(
uuid_d
& 
f
è{ 
fsid
 = f; 
	}
}

643 
•och_t
 
	$g‘_•och
(ècÚ¡ {  
•och
; 
	}
}

644 
	$šc_•och
(è{ 
•och
++; 
	}
}

646 
£t_•och
(
•och_t
 
e
);

648 
ušt32_t
 
	$g‘_üush_v”siÚ
() const {

649  
üush_v”siÚ
;

650 
	}
}

653 cÚ¡ 
	gutime_t
& 
	$g‘_ü—‹d
(ècÚ¡ {  
ü—‹d
; 
	}
}

654 cÚ¡ 
	gutime_t
& 
	$g‘_modif›d
(ècÚ¡ {  
modif›d
; 
	}
}

656 
boŞ
 
	$is_bÏckli¡ed
(cÚ¡ 
’t™y_addr_t
& 
a
) const;

657 
	`g‘_bÏckli¡
(
li¡
<
·œ
<
’t™y_addr_t
,
utime_t
 > > *
bl
) const;

658 
	`g‘_bÏckli¡
(
¡d
::
£t
<
’t™y_addr_t
> *
bl
) const;

660 
¡ršg
 
	$g‘_şu¡”_¢­shÙ
() const {

661 ià(
şu¡”_¢­shÙ_•och
 =ğ
•och
)

662  
şu¡”_¢­shÙ
;

663  
	`¡ršg
();

664 
	}
}

666 
	$g‘_fuÎ_¿tio
() const {

667  
fuÎ_¿tio
;

668 
	}
}

669 
	$g‘_backflfuÎ_¿tio
() const {

670  
backflfuÎ_¿tio
;

671 
	}
}

672 
	$g‘_Ã¬fuÎ_¿tio
() const {

673  
Ã¬fuÎ_¿tio
;

674 
	}
}

675 
g‘_fuÎ_poŞs
(
C•hCÚ‹xt
 *
cù
,

676 
£t
<
št64_t
> *
fuÎ
,

677 
£t
<
št64_t
> *
backflfuÎ
,

678 
£t
<
št64_t
> *
Ã¬fuÎ
) const;

679 
g‘_fuÎ_osd_couÁs
(
£t
<> *
fuÎ
, s‘<> *
backfl
,

680 
£t
<> *
Ã¬fuÎ
) const;

685 
	$g‘_max_osd
(ècÚ¡ {  
max_osd
; 
	}
}

686 
£t_max_osd
(
m
);

688 
	$g‘_num_osds
() const {

689  
num_osd
;

690 
	}
}

691 
	$g‘_num_up_osds
() const {

692  
num_up_osd
;

693 
	}
}

694 
	$g‘_num_š_osds
() const {

695  
num_š_osd
;

696 
	}
}

698 
ÿlc_num_osds
();

700 
g‘_®l_osds
(
£t
<
št32_t
>& 
ls
) const;

701 
g‘_up_osds
(
£t
<
št32_t
>& 
ls
) const;

702 
g‘_out_osds
(
£t
<
št32_t
>& 
ls
) const;

703 
	$g‘_num_pg_‹mp
() const {

704  
pg_‹mp
->
	`size
();

705 
	}
}

707 
	$g‘_æags
(ècÚ¡ {  
æags
; 
	}
}

708 
boŞ
 
	$‹¡_æag
(
f
ècÚ¡ {  
æags
 & f; 
	}
}

709 
	$£t_æag
(
f
è{ 
æags
 |ğf; 
	}
}

710 
	$ş—r_æag
(
f
è{ 
æags
 &ğ~f; 
	}
}

712 
g‘_æag_£t
(
£t
<
¡ršg
> *
æag£t
) const;

714 
ÿlc_¡©e_£t
(
¡©e
, 
£t
<
¡ršg
>& 
¡
);

716 
	$g‘_¡©e
(
o
) const {

717 
	`as£¹
(
o
 < 
max_osd
);

718  
osd_¡©e
[
o
];

719 
	}
}

720 
g‘_¡©e
(
o
, 
£t
<
¡ršg
>& 
¡
) const {

721 
as£¹
(
o
 < 
max_osd
);

722 
	gt
 = 
osd_¡©e
[
o
];

723 
ÿlc_¡©e_£t
(
t
, 
¡
);

724  
	gosd_¡©e
[
o
];

726 
	$£t_¡©e
(
o
, 
s
) {

727 
	`as£¹
(
o
 < 
max_osd
);

728 
osd_¡©e
[
o
] = 
s
;

729 
	}
}

730 
	$£t_weight
(
o
, 
w
) {

731 
	`as£¹
(
o
 < 
max_osd
);

732 
osd_weight
[
o
] = 
w
;

733 ià(
w
)

734 
osd_¡©e
[
o
] |ğ
CEPH_OSD_EXISTS
;

735 
	}
}

736 
	$g‘_weight
(
o
) const {

737 
	`as£¹
(
o
 < 
max_osd
);

738  
osd_weight
[
o
];

739 
	}
}

740 
	$g‘_weightf
(
o
) const {

741  ()
	`g‘_weight
(
o
è/ ()
CEPH_OSD_IN
;

742 
	}
}

743 
adju¡_osd_weights
(cÚ¡ 
m­
<,>& 
weights
, 
Inüem’l
& 
šc
) const;

745 
	$£t_´im¬y_affš™y
(
o
, 
w
) {

746 
	`as£¹
(
o
 < 
max_osd
);

747 ià(!
osd_´im¬y_affš™y
)

748 
osd_´im¬y_affš™y
.
	`»£t
(

749 
Ãw
 
mempoŞ
::
osdm­
::
veùÜ
<
__u32
>(

750 
max_osd
, 
CEPH_OSD_DEFAULT_PRIMARY_AFFINITY
));

751 (*
osd_´im¬y_affš™y
)[
o
] = 
w
;

752 
	}
}

753 
	$g‘_´im¬y_affš™y
(
o
) const {

754 
	`as£¹
(
o
 < 
max_osd
);

755 ià(!
osd_´im¬y_affš™y
)

756  
CEPH_OSD_DEFAULT_PRIMARY_AFFINITY
;

757  (*
osd_´im¬y_affš™y
)[
o
];

758 
	}
}

759 
	$g‘_´im¬y_affš™yf
(
o
) const {

760  ()
	`g‘_´im¬y_affš™y
(
o
è/ ()
CEPH_OSD_MAX_PRIMARY_AFFINITY
;

761 
	}
}

763 
boŞ
 
	$has_”asu»_code_´ofe
(cÚ¡ 
¡ršg
 &
Çme
) const {

764 autØ
i
 = 
”asu»_code_´ofes
.
	`fšd
(
Çme
);

765  
i
 !ğ
”asu»_code_´ofes
.
	`’d
();

766 
	}
}

767 
g‘_”asu»_code_´ofe_deçuÉ
(
C•hCÚ‹xt
 *
cù
,

768 
m­
<
¡ršg
,¡ršg> &
´ofe_m­
,

769 
o¡»am
 *
ss
);

770 
£t_”asu»_code_´ofe
(cÚ¡ 
¡ršg
 &
Çme
,

771 cÚ¡ 
m­
<
¡ršg
,¡ršg>& 
´ofe
) {

772 
	g”asu»_code_´ofes
[
Çme
] = 
´ofe
;

774 cÚ¡ 
	gm­
<
	g¡ršg
,¡ršg> &
	$g‘_”asu»_code_´ofe
(

775 cÚ¡ 
¡ršg
 &
Çme
) const {

776 
m­
<
¡ršg
,¡ršg> 
em±y
;

777 autØ
i
 = 
”asu»_code_´ofes
.
	`fšd
(
Çme
);

778 ià(
i
 =ğ
”asu»_code_´ofes
.
	`’d
())

779  
em±y
;

781  
i
->
£cÚd
;

782 
	}
}

783 cÚ¡ 
	gmempoŞ
::
osdm­
::
m­
<
¡ršg
,
	gm­
<
	g¡ršg
,¡ršg> > &
	$g‘_”asu»_code_´ofes
() const {

784  
”asu»_code_´ofes
;

785 
	}
}

787 
boŞ
 
	$exi¡s
(
osd
) const {

789  
osd
 >ğ0 && osd < 
max_osd
 && (
osd_¡©e
[osd] & 
CEPH_OSD_EXISTS
);

790 
	}
}

792 
boŞ
 
	$is_de¡royed
(
osd
) const {

793  
	`exi¡s
(
osd
è&& (
osd_¡©e
[osd] & 
CEPH_OSD_DESTROYED
);

794 
	}
}

796 
boŞ
 
	$is_up
(
osd
) const {

797  
	`exi¡s
(
osd
è&& (
osd_¡©e
[osd] & 
CEPH_OSD_UP
);

798 
	}
}

800 
boŞ
 
	$has_b“n_up_sšû
(
osd
, 
•och_t
 
•och
) const {

801  
	`is_up
(
osd
è&& 
	`g‘_up_äom
(osdè<ğ
•och
;

802 
	}
}

804 
boŞ
 
	$is_down
(
osd
) const {

805  !
	`is_up
(
osd
);

806 
	}
}

808 
boŞ
 
	$is_out
(
osd
) const {

809  !
	`exi¡s
(
osd
è|| 
	`g‘_weight
(osdè=ğ
CEPH_OSD_OUT
;

810 
	}
}

812 
boŞ
 
	$is_š
(
osd
) const {

813  !
	`is_out
(
osd
);

814 
	}
}

816 
boŞ
 
	$is_noup
(
osd
) const {

817  
	`exi¡s
(
osd
è&& (
osd_¡©e
[osd] & 
CEPH_OSD_NOUP
);

818 
	}
}

820 
boŞ
 
	$is_nodown
(
osd
) const {

821  
	`exi¡s
(
osd
è&& (
osd_¡©e
[osd] & 
CEPH_OSD_NODOWN
);

822 
	}
}

824 
boŞ
 
	$is_noš
(
osd
) const {

825  
	`exi¡s
(
osd
è&& (
osd_¡©e
[osd] & 
CEPH_OSD_NOIN
);

826 
	}
}

828 
boŞ
 
	$is_noout
(
osd
) const {

829  
	`exi¡s
(
osd
è&& (
osd_¡©e
[osd] & 
CEPH_OSD_NOOUT
);

830 
	}
}

832 
g‘_noup_osds
(
veùÜ
<> *
osds
) const {

833 
as£¹
(
osds
);

834 
	gosds
->
ş—r
();

836 
	gi
 = 0; i < 
	gmax_osd
; i++) {

837 ià(
is_noup
(
i
)) {

838 
	gosds
->
push_back
(
i
);

843 
g‘_nodown_osds
(
veùÜ
<> *
osds
) const {

844 
as£¹
(
osds
);

845 
	gosds
->
ş—r
();

847 
	gi
 = 0; i < 
	gmax_osd
; i++) {

848 ià(
is_nodown
(
i
)) {

849 
	gosds
->
push_back
(
i
);

854 
g‘_noš_osds
(
veùÜ
<> *
osds
) const {

855 
as£¹
(
osds
);

856 
	gosds
->
ş—r
();

858 
	gi
 = 0; i < 
	gmax_osd
; i++) {

859 ià(
is_noš
(
i
)) {

860 
	gosds
->
push_back
(
i
);

865 
g‘_noout_osds
(
veùÜ
<> *
osds
) const {

866 
as£¹
(
osds
);

867 
	gosds
->
ş—r
();

869 
	gi
 = 0; i < 
	gmax_osd
; i++) {

870 ià(
is_noout
(
i
)) {

871 
	gosds
->
push_back
(
i
);

879 
boŞ
 
subŒ“_is_down
(
id
, 
£t
<> *
down_ÿche
) const;

880 
boŞ
 
cÚššg_subŒ“_is_down
(
C•hCÚ‹xt
 *
cù
, 
osd
, 
subŒ“_ty³
, 
£t
<> *
down_ÿche
) const;

882 
boŞ
 
subŒ“_ty³_is_down
(
C•hCÚ‹xt
 *
cù
, 
id
, 
subŒ“_ty³
, 
£t
<> *
down_š_osds
, s‘<> *
up_š_osds
,

883 
£t
<> *
subŒ“_up
, 
unÜd”ed_m­
<, s‘<> > *
subŒ“_ty³_down
) const;

885 
	$id’tify_osd
(cÚ¡ 
’t™y_addr_t
& 
addr
) const;

886 
	$id’tify_osd
(cÚ¡ 
uuid_d
& 
u
) const;

887 
	$id’tify_osd_Ú_®l_chªÃls
(cÚ¡ 
’t™y_addr_t
& 
addr
) const;

889 
boŞ
 
	$have_addr
(cÚ¡ 
’t™y_addr_t
& 
addr
) const {

890  
	`id’tify_osd
(
addr
) >= 0;

891 
	}
}

892 
	$fšd_osd_Ú_
(cÚ¡ 
’t™y_addr_t
& 

) const;

893 cÚ¡ 
’t™y_addr_t
 &
	$g‘_addr
(
osd
) const {

894 
	`as£¹
(
	`exi¡s
(
osd
));

895  
osd_addrs
->
ş›Á_addr
[
osd
] ? *osd_addrs->ş›Á_addr[osd] : osd_addrs->
bÏnk
;

896 
	}
}

897 cÚ¡ 
	g’t™y_addr_t
 &
	$g‘_şu¡”_addr
(
osd
) const {

898 
	`as£¹
(
	`exi¡s
(
osd
));

899 ià(!
osd_addrs
->
şu¡”_addr
[
osd
] || *osd_addrs->şu¡”_addr[osd] =ğ
	`’t™y_addr_t
())

900  
	`g‘_addr
(
osd
);

901  *
osd_addrs
->
şu¡”_addr
[
osd
];

902 
	}
}

903 cÚ¡ 
	g’t™y_addr_t
 &
	$g‘_hb_back_addr
(
osd
) const {

904 
	`as£¹
(
	`exi¡s
(
osd
));

905  
osd_addrs
->
hb_back_addr
[
osd
] ? *osd_addrs->hb_back_addr[osd] : osd_addrs->
bÏnk
;

906 
	}
}

907 cÚ¡ 
	g’t™y_addr_t
 &
	$g‘_hb_äÚt_addr
(
osd
) const {

908 
	`as£¹
(
	`exi¡s
(
osd
));

909  
osd_addrs
->
hb_äÚt_addr
[
osd
] ? *osd_addrs->hb_äÚt_addr[osd] : osd_addrs->
bÏnk
;

910 
	}
}

911 
’t™y_š¡_t
 
	$g‘_mo¡_»ûÁ_š¡
(
osd
) const {

912 
	`as£¹
(
	`exi¡s
(
osd
));

913  
	`’t™y_š¡_t
(
’t™y_Çme_t
::
	`OSD
(
osd
), 
	`g‘_addr
(osd));

914 
	}
}

915 
’t™y_š¡_t
 
	$g‘_š¡
(
osd
) const {

916 
	`as£¹
(
	`is_up
(
osd
));

917  
	`g‘_mo¡_»ûÁ_š¡
(
osd
);

918 
	}
}

919 
’t™y_š¡_t
 
	$g‘_şu¡”_š¡
(
osd
) const {

920 
	`as£¹
(
	`is_up
(
osd
));

921  
	`’t™y_š¡_t
(
’t™y_Çme_t
::
	`OSD
(
osd
), 
	`g‘_şu¡”_addr
(osd));

922 
	}
}

923 
’t™y_š¡_t
 
	$g‘_hb_back_š¡
(
osd
) const {

924 
	`as£¹
(
	`is_up
(
osd
));

925  
	`’t™y_š¡_t
(
’t™y_Çme_t
::
	`OSD
(
osd
), 
	`g‘_hb_back_addr
(osd));

926 
	}
}

927 
’t™y_š¡_t
 
	$g‘_hb_äÚt_š¡
(
osd
) const {

928 
	`as£¹
(
	`is_up
(
osd
));

929  
	`’t™y_š¡_t
(
’t™y_Çme_t
::
	`OSD
(
osd
), 
	`g‘_hb_äÚt_addr
(osd));

930 
	}
}

932 cÚ¡ 
	guuid_d
& 
	$g‘_uuid
(
osd
) const {

933 
	`as£¹
(
	`exi¡s
(
osd
));

934  (*
osd_uuid
)[
osd
];

935 
	}
}

937 cÚ¡ 
	g•och_t
& 
	$g‘_up_äom
(
osd
) const {

938 
	`as£¹
(
	`exi¡s
(
osd
));

939  
osd_šfo
[
osd
].
up_äom
;

940 
	}
}

941 cÚ¡ 
	g•och_t
& 
	$g‘_up_thru
(
osd
) const {

942 
	`as£¹
(
	`exi¡s
(
osd
));

943  
osd_šfo
[
osd
].
up_thru
;

944 
	}
}

945 cÚ¡ 
	g•och_t
& 
	$g‘_down_©
(
osd
) const {

946 
	`as£¹
(
	`exi¡s
(
osd
));

947  
osd_šfo
[
osd
].
down_©
;

948 
	}
}

949 cÚ¡ 
	gosd_šfo_t
& 
	$g‘_šfo
(
osd
) const {

950 
	`as£¹
(
osd
 < 
max_osd
);

951  
osd_šfo
[
osd
];

952 
	}
}

954 cÚ¡ 
	gosd_xšfo_t
& 
	$g‘_xšfo
(
osd
) const {

955 
	`as£¹
(
osd
 < 
max_osd
);

956  
osd_xšfo
[
osd
];

957 
	}
}

959 
	$g‘_Ãxt_up_osd_aá”
(
n
) const {

960 ià(
	`g‘_max_osd
() == 0)

962 
i
 = 
n
 + 1; i !=‚; ++i) {

963 ià(
i
 >ğ
	`g‘_max_osd
())

964 
i
 = 0;

965 ià(
i
 =ğ
n
)

967 ià(
	`is_up
(
i
))

968  
i
;

971 
	}
}

973 
	$g‘_´evious_up_osd_befÜe
(
n
) const {

974 ià(
	`g‘_max_osd
() == 0)

976 
i
 = 
n
 - 1; i !=‚; --i) {

977 ià(
i
 < 0)

978 
i
 = 
	`g‘_max_osd
() - 1;

979 ià(
i
 =ğ
n
)

981 ià(
	`is_up
(
i
))

982  
i
;

985 
	}
}

994 
ušt64_t
 
	$g‘_ã©u»s
(
’t™y_ty³
, 
ušt64_t
 *
mask
) const;

1000 
ušt8_t
 
	$g‘_mš_com·t_ş›Á
() const;

1005 
ušt8_t
 
	$g‘_»quœe_mš_com·t_ş›Á
() const;

1010 
ušt64_t
 
	$g‘_up_osd_ã©u»s
() const;

1012 
	`maybe_»move_pg_upm­s
(
C•hCÚ‹xt
 *
cù
,

1013 cÚ¡ 
OSDM­
& 
osdm­
,

1014 
Inüem’l
 *
³ndšg_šc
);

1016 
	`­¶y_šüem’l
(cÚ¡ 
Inüem’l
 &
šc
);

1019 
	`dedup
(cÚ¡ 
OSDM­
 *
Şdm­
, OSDM­ *
Ãwm­
);

1021 
	`ş—n_‹mps
(
C•hCÚ‹xt
 *
cù
, cÚ¡ 
OSDM­
& 
osdm­
,

1022 
Inüem’l
 *
³ndšg_šc
);

1025 
´iv©e
:

1026 
	$’code_ş›Á_Şd
(
bufã¾i¡
& 
bl
) const;

1027 
	$’code_şassic
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
) const;

1028 
	`decode_şassic
(
bufã¾i¡
::
™”©Ü
& 
p
);

1029 
	`po¡_decode
();

1030 
public
:

1031 
	$’code
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
=
CEPH_FEATURES_ALL
) const;

1032 
	`decode
(
bufã¾i¡
& 
bl
);

1033 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
bl
);

1037 
	$m­_to_pg
(

1038 
št64_t
 
poŞ
,

1039 cÚ¡ 
¡ršg
& 
Çme
,

1040 cÚ¡ 
¡ršg
& 
key
,

1041 cÚ¡ 
¡ršg
& 
n¥aû
,

1042 
pg_t
 *
pg
) const;

1043 
	$objeù_loÿtÜ_to_pg
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
loc
,

1044 
pg_t
 &
pg
) const;

1045 
pg_t
 
	$objeù_loÿtÜ_to_pg
(cÚ¡ 
objeù_t
& 
oid
,

1046 cÚ¡ 
objeù_loÿtÜ_t
& 
loc
) const {

1047 
pg_t
 
pg
;

1048 
»t
 = 
	`objeù_loÿtÜ_to_pg
(
oid
, 
loc
, 
pg
);

1049 
	`as£¹
(
»t
 == 0);

1050  
pg
;

1051 
	}
}

1054 
objeù_loÿtÜ_t
 
	$fe_to_objeù_loÿtÜ
(cÚ¡ 
fe_Ïyout_t
& 
Ïyout
) {

1055  
	`objeù_loÿtÜ_t
(
Ïyout
.
poŞ_id
,†ayout.
poŞ_ns
);

1056 
	}
}

1058 
ûph_objeù_Ïyout
 
	$fe_to_objeù_Ïyout
(
objeù_t
 
oid
,

1059 
fe_Ïyout_t
& 
Ïyout
) const {

1060  
	`make_objeù_Ïyout
(
oid
, 
Ïyout
.
poŞ_id
,†ayout.
poŞ_ns
);

1061 
	}
}

1063 
ûph_objeù_Ïyout
 
	$make_objeù_Ïyout
(
objeù_t
 
oid
, 
pg_poŞ
,

1064 
¡ršg
 
n¥aû
) const;

1066 
	$g‘_pg_num
(
pg_poŞ
) const

1068 cÚ¡ 
pg_poŞ_t
 *
poŞ
 = 
	`g‘_pg_poŞ
(
pg_poŞ
);

1069 
	`as£¹
(
NULL
 !ğ
poŞ
);

1070  
poŞ
->
	`g‘_pg_num
();

1071 
	}
}

1073 
boŞ
 
	$pg_exi¡s
(
pg_t
 
pgid
) const {

1074 cÚ¡ 
pg_poŞ_t
 *
p
 = 
	`g‘_pg_poŞ
(
pgid
.
	`poŞ
());

1075  
p
 && 
pgid
.
	`ps
(è<…->
	`g‘_pg_num
();

1076 
	}
}

1078 
	$g‘_pg_poŞ_mš_size
(
pg_t
 
pgid
) const {

1079 ià(!
	`pg_exi¡s
(
pgid
)) {

1080  -
ENOENT
;

1082 cÚ¡ 
pg_poŞ_t
 *
p
 = 
	`g‘_pg_poŞ
(
pgid
.
	`poŞ
());

1083 
	`as£¹
(
p
);

1084  
p
->
	`g‘_mš_size
();

1085 
	}
}

1087 
	$g‘_pg_poŞ_size
(
pg_t
 
pgid
) const {

1088 ià(!
	`pg_exi¡s
(
pgid
)) {

1089  -
ENOENT
;

1091 cÚ¡ 
pg_poŞ_t
 *
p
 = 
	`g‘_pg_poŞ
(
pgid
.
	`poŞ
());

1092 
	`as£¹
(
p
);

1093  
p
->
	`g‘_size
();

1094 
	}
}

1096 
	$g‘_pg_poŞ_üush_ruË
(
pg_t
 
pgid
) const {

1097 ià(!
	`pg_exi¡s
(
pgid
)) {

1098  -
ENOENT
;

1100 cÚ¡ 
pg_poŞ_t
 *
p
 = 
	`g‘_pg_poŞ
(
pgid
.
	`poŞ
());

1101 
	`as£¹
(
p
);

1102  
p
->
	`g‘_üush_ruË
();

1103 
	}
}

1105 
	g´iv©e
:

1107 
_pg_to_¿w_osds
(

1108 cÚ¡ 
pg_poŞ_t
& 
poŞ
, 
pg_t
 
pg
,

1109 
veùÜ
<> *
osds
,

1110 
ps_t
 *
µps
) const;

1111 
_pick_´im¬y
(cÚ¡ 
veùÜ
<>& 
osds
) const;

1112 
_»move_nÚexi¡’t_osds
(cÚ¡ 
pg_poŞ_t
& 
poŞ
, 
veùÜ
<>& 
osds
) const;

1114 
_­¶y_´im¬y_affš™y
(
ps_t
 
£ed
, cÚ¡ 
pg_poŞ_t
& 
poŞ
,

1115 
veùÜ
<> *
osds
, *
´im¬y
) const;

1118 
_­¶y_upm­
(cÚ¡ 
pg_poŞ_t
& 
pi
, 
pg_t
 
pg
, 
veùÜ
<> *
¿w
) const;

1121 
_¿w_to_up_osds
(cÚ¡ 
pg_poŞ_t
& 
poŞ
, cÚ¡ 
veùÜ
<>& 
¿w
,

1122 
veùÜ
<> *
up
) const;

1131 
_g‘_‹mp_osds
(cÚ¡ 
pg_poŞ_t
& 
poŞ
, 
pg_t
 
pg
,

1132 
veùÜ
<> *
‹mp_pg
, *
‹mp_´im¬y
) const;

1137 
_pg_to_up_aùšg_osds
(cÚ¡ 
pg_t
& 
pg
, 
veùÜ
<> *
up
, *
up_´im¬y
,

1138 
veùÜ
<> *
aùšg
, *
aùšg_´im¬y
,

1139 
boŞ
 
¿w_pg_to_pg
 = 
Œue
) const;

1141 
	gpublic
:

1148 
pg_to_¿w_osds
(
pg_t
 
pg
, 
veùÜ
<> *
¿w
, *
´im¬y
) const;

1150 
pg_to_aùšg_osds
(cÚ¡ 
pg_t
& 
pg
, 
veùÜ
<> *
aùšg
,

1151 *
aùšg_´im¬y
) const {

1152 
_pg_to_up_aùšg_osds
(
pg
, 
NULL
, NULL, 
aùšg
, 
aùšg_´im¬y
);

1154 
pg_to_aùšg_osds
(
pg_t
 
pg
, 
veùÜ
<>& 
aùšg
) const {

1155  
pg_to_aùšg_osds
(
pg
, &
aùšg
, 
NULL
);

1161 
pg_to_¿w_up
(
pg_t
 
pg
, 
veùÜ
<> *
up
, *
´im¬y
) const;

1169 
pg_to_up_aùšg_osds
(
pg_t
 
pg
, 
veùÜ
<> *
up
, *
up_´im¬y
,

1170 
veùÜ
<> *
aùšg
, *
aùšg_´im¬y
) const {

1171 
_pg_to_up_aùšg_osds
(
pg
, 
up
, 
up_´im¬y
, 
aùšg
, 
aùšg_´im¬y
);

1173 
pg_to_up_aùšg_osds
(
pg_t
 
pg
, 
veùÜ
<>& 
up
, veùÜ<>& 
aùšg
) const {

1174 
	gup_´im¬y
, 
	gaùšg_´im¬y
;

1175 
pg_to_up_aùšg_osds
(
pg
, &
up
, &
up_´im¬y
, &
aùšg
, &
aùšg_´im¬y
);

1177 
boŞ
 
	$pg_is_ec
(
pg_t
 
pg
) const {

1178 autØ
i
 = 
poŞs
.
	`fšd
(
pg
.
	`poŞ
());

1179 
	`as£¹
(
i
 !ğ
poŞs
.
	`’d
());

1180  
i
->
£cÚd
.
	`is_”asu»
();

1181 
	}
}

1182 
boŞ
 
	$g‘_´im¬y_sh¬d
(cÚ¡ 
pg_t
& 
pgid
, 
¥g_t
 *
out
) const {

1183 autØ
i
 = 
	`g‘_poŞs
().
	`fšd
(
pgid
.
	`poŞ
());

1184 ià(
i
 =ğ
	`g‘_poŞs
().
	`’d
()) {

1185  
çl£
;

1187 ià(!
i
->
£cÚd
.
	`is_”asu»
()) {

1188 *
out
 = 
	`¥g_t
(
pgid
);

1189  
Œue
;

1191 
´im¬y
;

1192 
veùÜ
<> 
aùšg
;

1193 
	`pg_to_aùšg_osds
(
pgid
, &
aùšg
, &
´im¬y
);

1194 
ušt8_t
 
i
 = 0; i < 
aùšg
.
	`size
(); ++i) {

1195 ià(
aùšg
[
i
] =ğ
´im¬y
) {

1196 *
out
 = 
	`¥g_t
(
pgid
, 
	`sh¬d_id_t
(
i
));

1197  
Œue
;

1200  
çl£
;

1201 
	}
}

1202 
boŞ
 
	$g‘_´im¬y_sh¬d
(cÚ¡ 
pg_t
& 
pgid
, *
´im¬y
, 
¥g_t
 *
out
) const {

1203 autØ
i
 = 
	`g‘_poŞs
().
	`fšd
(
pgid
.
	`poŞ
());

1204 ià(
i
 =ğ
	`g‘_poŞs
().
	`’d
()) {

1205  
çl£
;

1207 
veùÜ
<> 
aùšg
;

1208 
	`pg_to_aùšg_osds
(
pgid
, &
aùšg
, 
´im¬y
);

1209 ià(
i
->
£cÚd
.
	`is_”asu»
()) {

1210 
ušt8_t
 
i
 = 0; i < 
aùšg
.
	`size
(); ++i) {

1211 ià(
aùšg
[
i
] =ğ*
´im¬y
) {

1212 *
out
 = 
	`¥g_t
(
pgid
, 
	`sh¬d_id_t
(
i
));

1213  
Œue
;

1217 *
out
 = 
	`¥g_t
(
pgid
);

1218  
Œue
;

1220  
çl£
;

1221 
	}
}

1223 cÚ¡ 
	gmempoŞ
::
osdm­
::
m­
<
št64_t
,
	g¢­_š‹rv®_£t_t
>&

1224 
	$g‘_»moved_¢­s_queue
() const {

1225  
»moved_¢­s_queue
;

1226 
	}
}

1227 cÚ¡ 
	gmempoŞ
::
osdm­
::
m­
<
št64_t
,
	g¢­_š‹rv®_£t_t
>&

1228 
	$g‘_Ãw_»moved_¢­s
() const {

1229  
Ãw_»moved_¢­s
;

1230 
	}
}

1231 cÚ¡ 
	gmempoŞ
::
osdm­
::
m­
<
št64_t
,
	g¢­_š‹rv®_£t_t
>&

1232 
	$g‘_Ãw_purged_¢­s
() const {

1233  
Ãw_purged_¢­s
;

1234 
	}
}

1236 
št64_t
 
	$lookup_pg_poŞ_Çme
(cÚ¡ 
¡ršg
& 
Çme
) const {

1237 autØ
p
 = 
Çme_poŞ
.
	`fšd
(
Çme
);

1238 ià(
p
 =ğ
Çme_poŞ
.
	`’d
())

1239  -
ENOENT
;

1240  
p
->
£cÚd
;

1241 
	}
}

1243 
št64_t
 
	$g‘_poŞ_max
() const {

1244  
poŞ_max
;

1245 
	}
}

1246 cÚ¡ 
	gmempoŞ
::
osdm­
::
m­
<
št64_t
,
	gpg_poŞ_t
>& 
	$g‘_poŞs
() const {

1247  
poŞs
;

1248 
	}
}

1249 
	gmempoŞ
::
osdm­
::
m­
<
št64_t
,
	gpg_poŞ_t
>& 
	$g‘_poŞs
() {

1250  
poŞs
;

1251 
	}
}

1252 
g‘_poŞ_ids_by_ruË
(
ruË_id
, 
£t
<
št64_t
> *
poŞ_ids
) const {

1253 
as£¹
(
poŞ_ids
);

1254 autØ&
	gp
: 
poŞs
) {

1255 ià(
p
.
£cÚd
.
g‘_üush_ruË
(è=ğ
ruË_id
) {

1256 
poŞ_ids
->
š£¹
(
p
.
fœ¡
);

1260 
g‘_poŞ_ids_by_osd
(
C•hCÚ‹xt
 *
cù
,

1261 
osd
,

1262 
£t
<
št64_t
> *
poŞ_ids
) const;

1263 cÚ¡ 
	g¡ršg
& 
	$g‘_poŞ_Çme
(
št64_t
 
p
) const {

1264 autØ
i
 = 
poŞ_Çme
.
	`fšd
(
p
);

1265 
	`as£¹
(
i
 !ğ
poŞ_Çme
.
	`’d
());

1266  
i
->
£cÚd
;

1267 
	}
}

1268 cÚ¡ 
	gmempoŞ
::
osdm­
::
m­
<
št64_t
,
	g¡ršg
>& 
	$g‘_poŞ_Çmes
() const {

1269  
poŞ_Çme
;

1270 
	}
}

1271 
boŞ
 
	$have_pg_poŞ
(
št64_t
 
p
) const {

1272  
poŞs
.
	`couÁ
(
p
);

1273 
	}
}

1274 cÚ¡ 
pg_poŞ_t
* 
	$g‘_pg_poŞ
(
št64_t
 
p
) const {

1275 autØ
i
 = 
poŞs
.
	`fšd
(
p
);

1276 ià(
i
 !ğ
poŞs
.
	`’d
())

1277  &
i
->
£cÚd
;

1278  
NULL
;

1279 
	}
}

1280 
	$g‘_pg_size
(
pg_t
 
pg
) const {

1281 autØ
p
 = 
poŞs
.
	`fšd
(
pg
.
	`poŞ
());

1282 
	`as£¹
(
p
 !ğ
poŞs
.
	`’d
());

1283  
p
->
£cÚd
.
	`g‘_size
();

1284 
	}
}

1285 
	$g‘_pg_ty³
(
pg_t
 
pg
) const {

1286 autØ
p
 = 
poŞs
.
	`fšd
(
pg
.
	`poŞ
());

1287 
	`as£¹
(
p
 !ğ
poŞs
.
	`’d
());

1288  
p
->
£cÚd
.
	`g‘_ty³
();

1289 
	}
}

1292 
pg_t
 
	$¿w_pg_to_pg
(
pg_t
 
pg
) const {

1293 autØ
p
 = 
poŞs
.
	`fšd
(
pg
.
	`poŞ
());

1294 
	`as£¹
(
p
 !ğ
poŞs
.
	`’d
());

1295  
p
->
£cÚd
.
	`¿w_pg_to_pg
(
pg
);

1296 
	}
}

1299 
	$g‘_pg_aùšg_´im¬y
(
pg_t
 
pg
) const {

1300 
´im¬y
 = -1;

1301 
	`_pg_to_up_aùšg_osds
(
pg
, 
nuÎ±r
,‚uÎ±r,‚uÎ±r, &
´im¬y
);

1302  
´im¬y
;

1303 
	}
}

1308 
boŞ
 
	$is_up_aùšg_osd_sh¬d
(
¥g_t
 
pg
, 
osd
) const {

1309 
veùÜ
<> 
up
, 
aùšg
;

1310 
	`_pg_to_up_aùšg_osds
(
pg
.
pgid
, &
up
, 
NULL
, &
aùšg
, NULL, 
çl£
);

1311 ià(
pg
.
sh¬d
 =ğ
sh¬d_id_t
::
NO_SHARD
) {

1312 ià(
	`ÿlc_pg_rŞe
(
osd
, 
aùšg
,‡ùšg.
	`size
()) >= 0 ||

1313 
	`ÿlc_pg_rŞe
(
osd
, 
up
, up.
	`size
()) >= 0)

1314  
Œue
;

1316 ià(
pg
.
sh¬d
 < ()
aùšg
.
	`size
(è&&‡ùšg[pg.sh¬d] =ğ
osd
)

1317  
Œue
;

1318 ià(
pg
.
sh¬d
 < ()
up
.
	`size
(è&& up[pg.sh¬d] =ğ
osd
)

1319  
Œue
;

1321  
çl£
;

1322 
	}
}

1326 
ÿlc_pg_¿nk
(
osd
, cÚ¡ 
veùÜ
<>& 
aùšg
, 
Ä•
=0);

1327 
ÿlc_pg_rŞe
(
osd
, cÚ¡ 
veùÜ
<>& 
aùšg
, 
Ä•
=0);

1328 
boŞ
 
´im¬y_chªged
(

1329 
Şd´im¬y
,

1330 cÚ¡ 
veùÜ
<> &
Şdaùšg
,

1331 
Ãw´im¬y
,

1332 cÚ¡ 
veùÜ
<> &
Ãwaùšg
);

1335 
	$g‘_pg_aùšg_¿nk
(
pg_t
 
pg
, 
osd
) const {

1336 
veùÜ
<> 
group
;

1337 
	`pg_to_aùšg_osds
(
pg
, 
group
);

1338  
	`ÿlc_pg_¿nk
(
osd
, 
group
, group.
	`size
());

1339 
	}
}

1341 
	$g‘_pg_aùšg_rŞe
(cÚ¡ 
pg_t
& 
pg
, 
osd
) const {

1342 
veùÜ
<> 
group
;

1343 
	`pg_to_aùšg_osds
(
pg
, 
group
);

1344  
	`ÿlc_pg_rŞe
(
osd
, 
group
, group.
	`size
());

1345 
	}
}

1347 
boŞ
 
	$osd_is_v®id_İ_rg‘
(
pg_t
 
pg
, 
osd
) const {

1348 
´im¬y
;

1349 
veùÜ
<> 
group
;

1350 
	`pg_to_aùšg_osds
(
pg
, &
group
, &
´im¬y
);

1351 ià(
osd
 =ğ
´im¬y
)

1352  
Œue
;

1353 ià(
	`pg_is_ec
(
pg
))

1354  
çl£
;

1356  
	`ÿlc_pg_rŞe
(
osd
, 
group
, group.
	`size
()) >= 0;

1357 
	}
}

1359 
ş—n_pg_upm­s
(

1360 
C•hCÚ‹xt
 *
cù
,

1361 
Inüem’l
 *
³ndšg_šc
);

1363 
boŞ
 
Œy_pg_upm­
(

1364 
C•hCÚ‹xt
 *
cù
,

1365 
pg_t
 
pg
,

1366 cÚ¡ 
£t
<>& 
ov”fuÎ
,

1367 cÚ¡ 
veùÜ
<>& 
und”fuÎ
,

1368 
veùÜ
<> *
Üig
,

1369 
veùÜ
<> *
out
);

1371 
ÿlc_pg_upm­s
(

1372 
C•hCÚ‹xt
 *
cù
,

1373 
max_devŸtiÚ
,

1374 
max_™”©iÚs
,

1375 cÚ¡ 
£t
<
št64_t
>& 
poŞs
,

1376 
Inüem’l
 *
³ndšg_šc


1379 
g‘_osds_by_buck‘_Çme
(cÚ¡ 
¡ršg
 &
Çme
, 
£t
<> *
osds
) const;

1396 
	g´iv©e
:

1397 
bud_sim¶e_İtiÚed
(
C•hCÚ‹xt
 *
cù
, 
•och_t
 
e
, 
uuid_d
 &
fsid
,

1398 
num_osd
, 
pg_b™s
, 
pgp_b™s
,

1399 
boŞ
 
deçuÉ_poŞ
);

1400 
	gpublic
:

1401 
	$bud_sim¶e
(
C•hCÚ‹xt
 *
cù
, 
•och_t
 
e
, 
uuid_d
 &
fsid
,

1402 
num_osd
) {

1403  
	`bud_sim¶e_İtiÚed
(
cù
, 
e
, 
fsid
, 
num_osd
, 0, 0, 
çl£
);

1404 
	}
}

1405 
	$bud_sim¶e_w™h_poŞ
(
C•hCÚ‹xt
 *
cù
, 
•och_t
 
e
, 
uuid_d
 &
fsid
,

1406 
num_osd
, 
pg_b™s
, 
pgp_b™s
) {

1407  
	`bud_sim¶e_İtiÚed
(
cù
, 
e
, 
fsid
, 
num_osd
,

1408 
pg_b™s
, 
pgp_b™s
, 
Œue
);

1409 
	}
}

1410 
_bud_üush_ty³s
(
CrushW¿µ”
& 
üush
);

1411 
bud_sim¶e_üush_m­
(
C•hCÚ‹xt
 *
cù
, 
CrushW¿µ”
& 
üush
,

1412 
num_osd
, 
o¡»am
 *
ss
);

1413 
bud_sim¶e_üush_m­_äom_cÚf
(
C•hCÚ‹xt
 *
cù
,

1414 
CrushW¿µ”
& 
üush
,

1415 
o¡»am
 *
ss
);

1416 
bud_sim¶e_üush_ruËs
(

1417 
C•hCÚ‹xt
 *
cù
, 
CrushW¿µ”
& 
üush
,

1418 cÚ¡ 
¡ršg
& 
roÙ
,

1419 
o¡»am
 *
ss
);

1421 
boŞ
 
	$üush_ruË_š_u£
(
ruË_id
) const;

1423 
	$v®id©e_üush_ruËs
(
CrushW¿µ”
 *
üush
, 
o¡»am
 *
ss
) const;

1425 
	$ş—r_‹mp
() {

1426 
pg_‹mp
->
	`ş—r
();

1427 
´im¬y_‹mp
->
	`ş—r
();

1428 
	}
}

1430 
	g´iv©e
:

1431 
	$´št_osd_lše
(
cur
, 
o¡»am
 *
out
, 
FÜm©‹r
 *
f
) const;

1432 
public
:

1433 
	$´št
(
o¡»am
& 
out
) const;

1434 
	$´št_poŞs
(
o¡»am
& 
out
) const;

1435 
	$´št_summ¬y
(
FÜm©‹r
 *
f
, 
o¡»am
& 
out
, cÚ¡ 
¡ršg
& 
´efix
, 
boŞ
 
exŒa
=
çl£
) const;

1436 
	$´št_Ú–še_summ¬y
(
o¡»am
& 
out
) const;

1439 
DUMP_IN
 = 1,

1440 
DUMP_OUT
 = 2,

1441 
DUMP_UP
 = 4,

1442 
DUMP_DOWN
 = 8,

1443 
DUMP_DESTROYED
 = 16,

1444 
	}
};

1445 
´št_Œ“
(
FÜm©‹r
 *
f
, 
o¡»am
 *
out
, 
dump_æags
=0, 
¡ršg
 
buck‘
="") const;

1447 
summ¬ize_m­pšg_¡©s
(

1448 
OSDM­
 *
Ãwm­
,

1449 cÚ¡ 
£t
<
št64_t
> *
poŞs
,

1450 
¡d
::
¡ršg
 *
out
,

1451 
FÜm©‹r
 *
f
) const;

1453 
¡ršg
 
	$g‘_æag_¡ršg
() const;

1454 
¡ršg
 
	`g‘_æag_¡ršg
(
æags
);

1455 
	`dump_”asu»_code_´ofes
(

1456 cÚ¡ 
mempoŞ
::
osdm­
::
m­
<
¡ršg
,m­<¡ršg,¡ršg> > &
´ofes
,

1457 
FÜm©‹r
 *
f
);

1458 
	$dump
(
FÜm©‹r
 *
f
) const;

1459 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
OSDM­
*>& 
o
);

1460 
boŞ
 
	$check_Ãw_bÏckli¡_’Œ›s
(ècÚ¡ {  
Ãw_bÏckli¡_’Œ›s
; 
	}
}

1462 
	$check_h—Éh
(
h—Éh_check_m­_t
 *
checks
) const;

1464 
	`·r£_osd_id_li¡
(cÚ¡ 
veùÜ
<
¡ršg
>& 
ls
,

1465 
£t
<> *
out
,

1466 
o¡»am
 *
ss
) const;

1467 
	}
};

1468 
	$WRITE_CLASS_ENCODER_FEATURES
(
OSDM­
)

1469 
	$WRITE_CLASS_ENCODER_FEATURES
(
OSDM­
::
Inüem’l
)

1471 
ûph
::
	tsh¬ed_±r
<cÚ¡ 
	tOSDM­
> 
	tOSDM­Ref
;

1473 
šlše
 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
OSDM­
& 
m
) {

1474 
m
.
	`´št_Ú–še_summ¬y
(
out
);

1475  
out
;

1476 
	}
}

1478 
şass
 
	gPGM­
;

1480 
´št_osd_utiz©iÚ
(cÚ¡ 
OSDM­
& 
osdm­
,

1481 cÚ¡ 
PGM­
& 
pgm­
,

1482 
o¡»am
& 
out
,

1483 
FÜm©‹r
 *
f
,

1484 
boŞ
 
Œ“
);

	@osd/OSDMapMapping.cc

4 
	~"OSDM­M­pšg.h
"

5 
	~"OSDM­.h
"

7 
	#dout_subsys
 
ûph_subsys_mÚ


	)

9 
	~"commÚ/debug.h
"

11 
MEMPOOL_DEFINE_OBJECT_FACTORY
(
OSDM­M­pšg
, 
osdm­m­pšg
,

12 
osdm­_m­pšg
);

16 
	gOSDM­M­pšg
::
	$_š™_m­pšgs
(cÚ¡ 
OSDM­
& 
osdm­
)

18 
num_pgs
 = 0;

19 autØ
q
 = 
poŞs
.
	`begš
();

20 auto& 
p
 : 
osdm­
.
	`g‘_poŞs
()) {

21 
num_pgs
 +ğ
p
.
£cÚd
.
	`g‘_pg_num
();

23 
q
 !ğ
poŞs
.
	`’d
(è&& q->
fœ¡
 < 
p
.first) {

24 
q
 = 
poŞs
.
	`”a£
(q);

26 ià(
q
 !ğ
poŞs
.
	`’d
(è&& q->
fœ¡
 =ğ
p
.first) {

27 ià(
q
->
£cÚd
.
pg_num
 !ğ
p
.£cÚd.
	`g‘_pg_num
() ||

28 
q
->
£cÚd
.
size
 !ğ
p
.£cÚd.
	`g‘_size
()) {

30 
q
 = 
poŞs
.
	`”a£
(q);

33 ++
q
;

37 
poŞs
.
	`em¶aû
(
p
.
fœ¡
, 
	`PoŞM­pšg
Õ.
£cÚd
.
	`g‘_size
(),

38 
p
.
£cÚd
.
	`g‘_pg_num
(),

39 
p
.
£cÚd
.
	`is_”asu»
()));

41 
poŞs
.
	`”a£
(
q
,…oŞs.
	`’d
());

42 
	`as£¹
(
poŞs
.
	`size
(è=ğ
osdm­
.
	`g‘_poŞs
().size());

43 
	}
}

45 
	gOSDM­M­pšg
::
	$upd©e
(cÚ¡ 
OSDM­
& 
osdm­
)

47 
	`_¡¬t
(
osdm­
);

48 auto& 
p
 : 
osdm­
.
	`g‘_poŞs
()) {

49 
	`_upd©e_¿nge
(
osdm­
, 
p
.
fœ¡
, 0,….
£cÚd
.
	`g‘_pg_num
());

51 
	`_fšish
(
osdm­
);

53 
	}
}

55 
	gOSDM­M­pšg
::
	$upd©e
(cÚ¡ 
OSDM­
& 
osdm­
, 
pg_t
 
pgid
)

57 
	`_upd©e_¿nge
(
osdm­
, 
pgid
.
	`poŞ
(),…gid.
	`ps
(),…gid.ps() + 1);

58 
	}
}

60 
	gOSDM­M­pšg
::
	$_bud_rm­
(cÚ¡ 
OSDM­
& 
osdm­
)

62 
aùšg_rm­
.
	`»size
(
osdm­
.
	`g‘_max_osd
());

64 auto& 
v
 : 
aùšg_rm­
) {

65 
v
.
	`»size
(0);

70 auto& 
p
 : 
poŞs
) {

71 
pg_t
 
	`pgid
(0, 
p
.
fœ¡
);

72 
ps
 = 0;… < 
p
.
£cÚd
.
pg_num
; ++ps) {

73 
pgid
.
	`£t_ps
(
ps
);

74 
št32_t
 *
row
 = &
p
.
£cÚd
.
bË
[p.£cÚd.
	`row_size
(è* 
ps
];

75 
i
 = 0; i < 
row
[2]; ++i) {

76 ià(
row
[4 + 
i
] !ğ
CRUSH_ITEM_NONE
) {

77 
aùšg_rm­
[
row
[4 + 
i
]].
	`push_back
(
pgid
);

85 
	}
}

87 
	gOSDM­M­pšg
::
	$_fšish
(cÚ¡ 
OSDM­
& 
osdm­
)

89 
	`_bud_rm­
(
osdm­
);

90 
•och
 = 
osdm­
.
	`g‘_•och
();

91 
	}
}

93 
	gOSDM­M­pšg
::
	$_dump
()

95 auto& 
p
 : 
poŞs
) {

96 
cout
 << "poŞ " << 
p
.
fœ¡
 << 
¡d
::
’dl
;

97 
i
 = 0; i < 
p
.
£cÚd
.
bË
.
	`size
(); ++i) {

98 
cout
 << " " << 
p
.
£cÚd
.
bË
[
i
];

99 ià(
i
 % 
p
.
£cÚd
.
	`row_size
() ==….second.row_size() - 1)

100 
cout
 << 
¡d
::
’dl
;

103 
	}
}

105 
	gOSDM­M­pšg
::
	$_upd©e_¿nge
(

106 cÚ¡ 
OSDM­
& 
osdm­
,

107 
št64_t
 
poŞ
,

108 
pg_begš
,

109 
pg_’d
)

111 autØ
i
 = 
poŞs
.
	`fšd
(
poŞ
);

112 
	`as£¹
(
i
 !ğ
poŞs
.
	`’d
());

113 
	`as£¹
(
pg_begš
 <ğ
pg_’d
);

114 
	`as£¹
(
pg_’d
 <ğ
i
->
£cÚd
.
pg_num
);

115 
ps
 = 
pg_begš
;… < 
pg_’d
; ++ps) {

116 
veùÜ
<> 
up
, 
aùšg
;

117 
up_´im¬y
, 
aùšg_´im¬y
;

118 
osdm­
.
	`pg_to_up_aùšg_osds
(

119 
	`pg_t
(
ps
, 
poŞ
),

120 &
up
, &
up_´im¬y
, &
aùšg
, &
aùšg_´im¬y
);

121 
i
->
£cÚd
.
	`£t
(
ps
, 
¡d
::
	`move
(
up
), 
up_´im¬y
,

122 
¡d
::
	`move
(
aùšg
), 
aùšg_´im¬y
);

124 
	}
}

128 
	gP¬®ËlPGM­³r
::
Job
::
	$fšish_Úe
()

130 
CÚ‹xt
 *
fš
 = 
nuÎ±r
;

132 
Mu‹x
::
Lock”
 
	`l
(
lock
);

133 ià(--
sh¬ds
 == 0) {

134 ià(!
abÜ‹d
) {

135 
fšish
 = 
	`ûph_şock_now
();

136 
	`com¶‘e
();

138 
cÚd
.
	`SigÇl
();

139 
fš
 = 
Úfšish
;

140 
Úfšish
 = 
nuÎ±r
;

143 ià(
fš
) {

144 
fš
->
	`com¶‘e
(0);

146 
	}
}

148 
	gP¬®ËlPGM­³r
::
WQ
::
	$_´oûss
(
I‹m
 *
i
, 
Th»adPoŞ
::
TPHªdË
 &
h
)

150 
	`ldout
(
m
->
cù
, 20è<< 
__func__
 << " " << 
i
->
job
 << " " << i->
poŞ


151 << " [" << 
i
->
begš
 << "," << i->
’d
 << ")" << 
d’dl
;

152 
i
->
job
->
	`´oûss
(i->
poŞ
, i->
begš
, i->
’d
);

153 
i
->
job
->
	`fšish_Úe
();

154 
d–‘e
 
i
;

155 
	}
}

157 
	gP¬®ËlPGM­³r
::
	$queue
(

158 
Job
 *
job
,

159 
pgs_³r_™em
)

161 
boŞ
 
ªy
 = 
çl£
;

162 auto& 
p
 : 
job
->
osdm­
->
	`g‘_poŞs
()) {

163 
ps
 = 0;… < 
p
.
£cÚd
.
	`g‘_pg_num
();… +ğ
pgs_³r_™em
) {

164 
ps_’d
 = 
¡d
::
	`mš
(
ps
 + 
pgs_³r_™em
, 
p
.
£cÚd
.
	`g‘_pg_num
());

165 
job
->
	`¡¬t_Úe
();

166 
wq
.
	`queue
(
Ãw
 
	`I‹m
(
job
, 
p
.
fœ¡
, 
ps
, 
ps_’d
));

167 
	`ldout
(
cù
, 20è<< 
__func__
 << " " << 
job
 << " " << 
p
.
fœ¡
 << " [" << 
ps


168 << "," << 
ps_’d
 << ")" << 
d’dl
;

169 
ªy
 = 
Œue
;

172 
	`as£¹
(
ªy
);

173 
	}
}

	@osd/OSDMapMapping.h

5 #iâdeà
CEPH_OSDMAPMAPPING_H


6 
	#CEPH_OSDMAPMAPPING_H


	)

8 
	~<veùÜ
>

9 
	~<m­
>

11 
	~"osd/osd_ty³s.h
"

12 
	~"commÚ/WÜkQueue.h
"

14 
şass
 
	gOSDM­
;

17 şas 
	cP¬®ËlPGM­³r
 {

18 
	mpublic
:

19 
	sJob
 {

20 
utime_t
 
¡¬t
, 
	mfšish
;

21 
	msh¬ds
 = 0;

22 cÚ¡ 
OSDM­
 *
	mosdm­
;

23 
boŞ
 
	mabÜ‹d
 = 
çl£
;

24 
CÚ‹xt
 *
	mÚfšish
 = 
nuÎ±r
;

26 
Mu‹x
 
	mlock
 = {"ParallelPGMapper::Job::lock"};

27 
CÚd
 
	mcÚd
;

29 
Job
(cÚ¡ 
OSDM­
 *
om
è: 
¡¬t
(
ûph_şock_now
()), 
osdm­
(om) {}

30 
	mvœtu®
 ~
Job
() {

31 
as£¹
(
sh¬ds
 == 0);

35 
vœtu®
 
´oûss
(
št64_t
 
poŞid
, 
ps_begš
, 
ps_’d
) = 0;

36 
vœtu®
 
com¶‘e
() = 0;

38 
£t_fšish_ev’t
(
CÚ‹xt
 *
fš
) {

39 
	mlock
.
Lock
();

40 ià(
	msh¬ds
 == 0) {

42 
lock
.
UÆock
();

43 
	mfš
->
com¶‘e
(0);

46 
	mÚfšish
 = 
fš
;

47 
	mlock
.
UÆock
();

50 
boŞ
 
is_dÚe
() {

51 
	mMu‹x
::
Lock”
 
l
(
lock
);

52  
	msh¬ds
 == 0;

54 
utime_t
 
g‘_du¿tiÚ
() {

55  
	mfšish
 - 
	m¡¬t
;

57 
wa™
() {

58 
	mMu‹x
::
Lock”
 
l
(
lock
);

59 
	msh¬ds
 > 0) {

60 
	mcÚd
.
Wa™
(
lock
);

63 
boŞ
 
wa™_fÜ
(
du¿tiÚ
) {

64 
utime_t
 
	muÁ
 = 
¡¬t
;

65 
	muÁ
 +ğ
du¿tiÚ
;

66 
	mMu‹x
::
Lock”
 
l
(
lock
);

67 
	msh¬ds
 > 0) {

68 ià(
ûph_şock_now
(è>ğ
uÁ
) {

69  
çl£
;

71 
	mcÚd
.
Wa™
(
lock
);

73  
	mŒue
;

75 
abÜt
() {

76 
CÚ‹xt
 *
	mfš
 = 
nuÎ±r
;

78 
	mMu‹x
::
Lock”
 
l
(
lock
);

79 
	mabÜ‹d
 = 
Œue
;

80 
	mfš
 = 
Úfšish
;

81 
	mÚfšish
 = 
nuÎ±r
;

82 
	msh¬ds
 > 0) {

83 
	mcÚd
.
Wa™
(
lock
);

86 ià(
	mfš
) {

87 
	mfš
->
com¶‘e
(-
ECANCELED
);

91 
¡¬t_Úe
() {

92 
	mMu‹x
::
Lock”
 
l
(
lock
);

93 ++
	msh¬ds
;

95 
fšish_Úe
();

98 
	g´Ùeùed
:

99 
C•hCÚ‹xt
 *
cù
;

101 
	sI‹m
 {

102 
Job
 *
	gjob
;

103 
št64_t
 
	gpoŞ
;

104 
	gbegš
, 
	g’d
;

106 
I‹m
(
Job
 *
j
, 
št64_t
 
p
, 
b
, 
e
)

107 : 
job
(
j
),

108 
poŞ
(
p
),

109 
begš
(
b
),

110 
’d
(
e
) {}

112 
	g¡d
::
deque
<
I‹m
*> 
q
;

114 
	gWQ
 : 
public
 
Th»adPoŞ
::
WÜkQueue
<
I‹m
> {

115 
P¬®ËlPGM­³r
 *
m
;

117 
WQ
(
P¬®ËlPGM­³r
 *
m_
, 
Th»adPoŞ
 *

)

118 : 
Th»adPoŞ
::
WÜkQueue
<
I‹m
>("P¬®ËlPGM­³r::WQ", 0, 0, 
	g
),

119 
m
(
m_
) {}

121 
boŞ
 
_’queue
(
I‹m
 *
i
è
	gov”ride
 {

122 
	gm
->
	gq
.
push_back
(
i
);

123  
	gŒue
;

125 
_dequeue
(
I‹m
 *
i
è
	gov”ride
 {

126 
ûph_abÜt
();

128 
I‹m
 *
_dequeue
(è
	gov”ride
 {

129 !
	gm
->
	gq
.
em±y
()) {

130 
I‹m
 *
	gi
 = 
m
->
q
.
äÚt
();

131 
	gm
->
	gq
.
pİ_äÚt
();

132 ià(
	gi
->
	gjob
->
	gabÜ‹d
) {

133 
	gi
->
	gjob
->
fšish_Úe
();

134 
d–‘e
 
	gi
;

136  
	gi
;

139  
	gnuÎ±r
;

142 
_´oûss
(
I‹m
 *
i
, 
Th»adPoŞ
::
TPHªdË
 &
h
è
ov”ride
;

144 
_ş—r
(è
	gov”ride
 {

145 
as£¹
(
_em±y
());

148 
boŞ
 
_em±y
(è
	gov”ride
 {

149  
	gm
->
	gq
.
em±y
();

151 } 
	gwq
;

153 
	gpublic
:

154 
	$P¬®ËlPGM­³r
(
C•hCÚ‹xt
 *
cù
, 
Th»adPoŞ
 *

)

155 : 
	`cù
(
cù
),

156 
	$wq
(
this
, 

è{
	}
}

158 
queue
(

159 
Job
 *
job
,

160 
pgs_³r_™em
);

162 
	$d¿š
() {

163 
wq
.
	`d¿š
();

164 
	}
}

169 şas 
	cOSDM­M­pšg
 {

170 
	mpublic
:

171 
MEMPOOL_CLASS_HELPERS
();

172 
	m´iv©e
:

174 
	sPoŞM­pšg
 {

175 
MEMPOOL_CLASS_HELPERS
();

177 
	msize
 = 0;

178 
	mpg_num
 = 0;

179 
boŞ
 
	m”asu»
 = 
çl£
;

180 
	mmempoŞ
::
osdm­_m­pšg
::
veùÜ
<
št32_t
> 
bË
;

182 
size_t
 
row_size
() const {

188 
	msize
 +

189 
	msize
;

192 
PoŞM­pšg
(
s
, 
p
, 
boŞ
 
e
)

193 : 
size
(
s
),

194 
pg_num
(
p
),

195 
”asu»
(
e
),

196 
bË
(
pg_num
 * 
row_size
()) {

199 
g‘
(
size_t
 
ps
,

200 
¡d
::
veùÜ
<> *
up
,

201 *
up_´im¬y
,

202 
¡d
::
veùÜ
<> *
aùšg
,

203 *
aùšg_´im¬y
) const {

204 cÚ¡ 
št32_t
 *
	mrow
 = &
bË
[
row_size
(è* 
ps
];

205 ià(
	maùšg_´im¬y
) {

206 *
	maùšg_´im¬y
 = 
row
[0];

208 ià(
	mup_´im¬y
) {

209 *
	mup_´im¬y
 = 
row
[1];

211 ià(
	maùšg
) {

212 
	maùšg
->
»size
(
row
[2]);

213 
	mi
 = 0; i < 
	mrow
[2]; ++i) {

214 (*
	maùšg
)[
i
] = 
row
[4 + i];

217 ià(
	mup
) {

218 
	mup
->
»size
(
row
[3]);

219 
	mi
 = 0; i < 
	mrow
[3]; ++i) {

220 (*
	mup
)[
i
] = 
row
[4 + 
size
 + i];

225 
£t
(
size_t
 
ps
,

226 cÚ¡ 
¡d
::
veùÜ
<>& 
up
,

227 
up_´im¬y
,

228 cÚ¡ 
¡d
::
veùÜ
<>& 
aùšg
,

229 
aùšg_´im¬y
) {

230 
št32_t
 *
	mrow
 = &
bË
[
row_size
(è* 
ps
];

231 
	mrow
[0] = 
aùšg_´im¬y
;

232 
	mrow
[1] = 
up_´im¬y
;

233 
	mrow
[2] = 
aùšg
.
size
();

234 
	mrow
[3] = 
up
.
size
();

235 
	mi
 = 0; i < 
	mrow
[2]; ++i) {

236 
	mrow
[4 + 
i
] = 
aùšg
[i];

238 
	mi
 = 0; i < 
	mrow
[3]; ++i) {

239 
	mrow
[4 + 
size
 + 
i
] = 
up
[i];

244 
	gmempoŞ
::
osdm­_m­pšg
::
m­
<
št64_t
,
	gPoŞM­pšg
> 
	gpoŞs
;

245 
	gmempoŞ
::
osdm­_m­pšg
::
veùÜ
<

246 
mempoŞ
::
osdm­_m­pšg
::
veùÜ
<
pg_t
>> 
aùšg_rm­
;

248 
•och_t
 
	g•och
 = 0;

249 
ušt64_t
 
	gnum_pgs
 = 0;

251 
_š™_m­pšgs
(cÚ¡ 
OSDM­
& 
osdm­
);

252 
_upd©e_¿nge
(

253 cÚ¡ 
OSDM­
& 
m­
,

254 
št64_t
 
poŞ
,

255 
pg_begš
, 
pg_’d
);

257 
_bud_rm­
(cÚ¡ 
OSDM­
& 
osdm­
);

259 
	$_¡¬t
(cÚ¡ 
OSDM­
& 
osdm­
) {

260 
	`_š™_m­pšgs
(
osdm­
);

261 
	}
}

262 
_fšish
(cÚ¡ 
OSDM­
& 
osdm­
);

264 
_dump
();

266 
ä›nd
 
şass
 
	gP¬®ËlPGM­³r
;

268 
	gM­pšgJob
 : 
public
 
P¬®ËlPGM­³r
::
Job
 {

269 
OSDM­M­pšg
 *
m­pšg
;

270 
M­pšgJob
(cÚ¡ 
OSDM­
 *
osdm­
, 
OSDM­M­pšg
 *
m
)

271 : 
Job
(
osdm­
), 
m­pšg
(
m
) {

272 
	gm­pšg
->
_¡¬t
(*
osdm­
);

274 
´oûss
(
št64_t
 
poŞ
, 
ps_begš
, 
ps_’d
è
	gov”ride
 {

275 
	gm­pšg
->
_upd©e_¿nge
(*
osdm­
, 
poŞ
, 
ps_begš
, 
ps_’d
);

277 
com¶‘e
(è
	gov”ride
 {

278 
	gm­pšg
->
_fšish
(*
osdm­
);

282 
	gpublic
:

283 
g‘
(
pg_t
 
pgid
,

284 
¡d
::
veùÜ
<> *
up
,

285 *
up_´im¬y
,

286 
¡d
::
veùÜ
<> *
aùšg
,

287 *
aùšg_´im¬y
) const {

288 autØ
	gp
 = 
poŞs
.
fšd
(
pgid
.
poŞ
());

289 
as£¹
(
p
 !ğ
poŞs
.
’d
());

290 
as£¹
(
pgid
.
ps
(è< 
p
->
£cÚd
.
pg_num
);

291 
	gp
->
	g£cÚd
.
g‘
(
pgid
.
ps
(), 
up
, 
up_´im¬y
, 
aùšg
, 
aùšg_´im¬y
);

294 
boŞ
 
	$g‘_´im¬y_ªd_sh¬d
(
pg_t
 
pgid
,

295 *
aùšg_´im¬y
,

296 
¥g_t
 *
¥gid
) {

297 autØ
p
 = 
poŞs
.
	`fšd
(
pgid
.
	`poŞ
());

298 
	`as£¹
(
p
 !ğ
poŞs
.
	`’d
());

299 
	`as£¹
(
pgid
.
	`ps
(è< 
p
->
£cÚd
.
pg_num
);

300 
veùÜ
<> 
aùšg
;

301 
p
->
£cÚd
.
	`g‘
(
pgid
.
	`ps
(), 
nuÎ±r
,‚uÎ±r, &
aùšg
, 
aùšg_´im¬y
);

302 ià(
p
->
£cÚd
.
”asu»
) {

303 
ušt8_t
 
i
 = 0; i < 
aùšg
.
	`size
(); ++i) {

304 ià(
aùšg
[
i
] =ğ*
aùšg_´im¬y
) {

305 *
¥gid
 = 
	`¥g_t
(
pgid
, 
	`sh¬d_id_t
(
i
));

306  
Œue
;

309  
çl£
;

311 *
¥gid
 = 
	`¥g_t
(
pgid
);

312  
Œue
;

314 
	}
}

316 cÚ¡ 
	gmempoŞ
::
osdm­_m­pšg
::
veùÜ
<
pg_t
>& 
	$g‘_osd_aùšg_pgs
(
osd
) {

317 
	`as£¹
(
osd
 < 
aùšg_rm­
.
	`size
());

318  
aùšg_rm­
[
osd
];

319 
	}
}

321 
upd©e
(cÚ¡ 
OSDM­
& 
m­
);

322 
upd©e
(cÚ¡ 
OSDM­
& 
m­
, 
pg_t
 
pgid
);

324 
	g¡d
::
unique_±r
<
M­pšgJob
> 
	$¡¬t_upd©e
(

325 cÚ¡ 
OSDM­
& 
m­
,

326 
P¬®ËlPGM­³r
& 
m­³r
,

327 
pgs_³r_™em
) {

328 
¡d
::
unique_±r
<
M­pšgJob
> 
	`job
(
Ãw
 
	`M­pšgJob
(&
m­
, 
this
));

329 
m­³r
.
	`queue
(
job
.
	`g‘
(), 
pgs_³r_™em
);

330  
job
;

331 
	}
}

333 
•och_t
 
	$g‘_•och
() const {

334  
•och
;

335 
	}
}

337 
ušt64_t
 
	$g‘_num_pgs
() const {

338  
num_pgs
;

339 
	}
}

	@osd/ObjectVersioner.h

15 #iâdeà
CEPH_OSD_OBJECTVERSIONER_H


16 
	#CEPH_OSD_OBJECTVERSIONER_H


	)

18 şas 
	cObjeùV”siÚ”
 {

19 
	mpublic
:

20 
pobjeù_t
 
oid
;

22 
g‘_v”siÚs
(
li¡
<
v”siÚ_t
>& 
ls
);

23 
v”siÚ_t
 
h—d
();

24 
v”siÚ_t
 
comm™‹d
();

25 
v”siÚ_t
 

();

30 
´•¬e
(
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
, 
v”siÚ_t
 
v
);

31 
rŞlback_to
(
v”siÚ_t
 
v
);

32 
comm™_to
(
v”siÚ_t
 
v
);

	@osd/OpQueueItem.cc

15 
	~"OpQueueI‹m.h
"

16 
	~"OSD.h
"

18 
	gPGOpI‹m
::
	$run
(

19 
OSD
 *
osd
,

20 
OSDSh¬d
 *
sd©a
,

21 
PGRef
& 
pg
,

22 
Th»adPoŞ
::
TPHªdË
 &
hªdË
)

24 
osd
->
	`dequeue_İ
(
pg
, 
İ
, 
hªdË
);

25 
pg
->
	`uÆock
();

26 
	}
}

28 
	gPGP“ršgI‹m
::
	$run
(

29 
OSD
 *
osd
,

30 
OSDSh¬d
 *
sd©a
,

31 
PGRef
& 
pg
,

32 
Th»adPoŞ
::
TPHªdË
 &
hªdË
)

34 
osd
->
	`dequeue_³”šg_evt
(
sd©a
, 
pg
.
	`g‘
(), 
evt
, 
hªdË
);

35 
	}
}

37 
	gPGSÇpTrim
::
	$run
(

38 
OSD
 *
osd
,

39 
OSDSh¬d
 *
sd©a
,

40 
PGRef
& 
pg
,

41 
Th»adPoŞ
::
TPHªdË
 &
hªdË
)

43 
pg
->
	`¢­_Œimm”
(
•och_queued
);

44 
pg
->
	`uÆock
();

45 
	}
}

47 
	gPGSüub
::
	$run
(

48 
OSD
 *
osd
,

49 
OSDSh¬d
 *
sd©a
,

50 
PGRef
& 
pg
,

51 
Th»adPoŞ
::
TPHªdË
 &
hªdË
)

53 
pg
->
	`süub
(
•och_queued
, 
hªdË
);

54 
pg
->
	`uÆock
();

55 
	}
}

57 
	gPGRecov”y
::
	$run
(

58 
OSD
 *
osd
,

59 
OSDSh¬d
 *
sd©a
,

60 
PGRef
& 
pg
,

61 
Th»adPoŞ
::
TPHªdË
 &
hªdË
)

63 
osd
->
	`do_»cov”y
(
pg
.
	`g‘
(), 
•och_queued
, 
»£rved_pushes
, 
hªdË
);

64 
pg
->
	`uÆock
();

65 
	}
}

67 
	gPGRecov”yCÚ‹xt
::
	$run
(

68 
OSD
 *
osd
,

69 
OSDSh¬d
 *
sd©a
,

70 
PGRef
& 
pg
,

71 
Th»adPoŞ
::
TPHªdË
 &
hªdË
)

73 
c
.
	`»Ëa£
()->
	`com¶‘e
(
hªdË
);

74 
pg
->
	`uÆock
();

75 
	}
}

77 
	gPGD–‘e
::
	$run
(

78 
OSD
 *
osd
,

79 
OSDSh¬d
 *
sd©a
,

80 
PGRef
& 
pg
,

81 
Th»adPoŞ
::
TPHªdË
 &
hªdË
)

83 
osd
->
	`dequeue_d–‘e
(
sd©a
, 
pg
.
	`g‘
(), 
•och_queued
, 
hªdË
);

84 
	}
}

	@osd/OpQueueItem.h

15 #´agm¨
Úû


17 
	~<o¡»am
>

19 
	~"šşude/ty³s.h
"

20 
	~"šşude/utime.h
"

21 
	~"osd/OpReque¡.h
"

22 
	~"osd/PG.h
"

23 
	~"PGP“ršgEv’t.h
"

25 
şass
 
	gOSD
;

26 
şass
 
	gOSDSh¬d
;

28 şas 
	cOpQueueI‹m
 {

29 
	mpublic
:

30 şas 
	cOrd”Lock”
 {

31 
public
:

32 
usšg
 
Ref
 = 
unique_±r
<
Ord”Lock”
>;

33 
vœtu®
 
lock
() = 0;

34 
vœtu®
 
uÆock
() = 0;

35 
	mvœtu®
 ~
Ord”Lock”
() {}

38 şas 
	cOpQueu—bË
 {

39 
	gpublic
:

40 şas 
	cİ_ty³_t
 {

41 
ş›Á_İ
,

42 
	g³”šg_ev’t
,

43 
	gbg_¢­Œim
,

44 
	gbg_»cov”y
,

45 
	gbg_süub
,

46 
	gbg_pg_d–‘e


48 
usšg
 
	gRef
 = 
¡d
::
unique_±r
<
OpQueu—bË
>;

51 
vœtu®
 
ušt32_t
 
g‘_queue_tok’
() const = 0;

55 
vœtu®
 cÚ¡ 
	g¥g_t
& 
g‘_Üd”šg_tok’
() const = 0;

56 
vœtu®
 
	gOrd”Lock”
::
Ref
 
g‘_Üd”_lock”
(
PGRef
 
pg
) = 0;

57 
vœtu®
 
İ_ty³_t
 
g‘_İ_ty³
() const = 0;

58 
vœtu®
 
	gboo¡
::
İtiÚ®
<
OpReque¡Ref
> 
maybe_g‘_İ
() const {

59  
boo¡
::
nÚe
;

62 
vœtu®
 
ušt64_t
 
g‘_»£rved_pushes
() const {

66 
vœtu®
 
boŞ
 
is_³”šg
() const {

67  
	gçl£
;

69 
vœtu®
 
boŞ
 
³”šg_»quœes_pg
() const {

70 
ûph_abÜt
();

72 
vœtu®
 cÚ¡ 
PGC»©eInfo
 *
ü—‹s_pg
() const {

73  
	gnuÎ±r
;

76 
vœtu®
 
	go¡»am
 &
´št
(
o¡»am
 &
rhs
) const = 0;

78 
vœtu®
 
run
(
OSD
 *
osd
, 
OSDSh¬d
 *
sd©a
, 
PGRef
& 
pg
, 
Th»adPoŞ
::
TPHªdË
 &
hªdË
) = 0;

79 
	gvœtu®
 ~
OpQueu—bË
() {}

80 
ä›nd
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gOpQueu—bË
& 
	gq
) {

81  
	gq
.
´št
(
out
);

86 
	g´iv©e
:

87 
OpQueu—bË
::
Ref
 
q™em
;

88 
	gco¡
;

89 
	g´iÜ™y
;

90 
utime_t
 
	g¡¬t_time
;

91 
ušt64_t
 
	gowÃr
;

92 
•och_t
 
	gm­_•och
;

94 
	gpublic
:

95 
	$OpQueueI‹m
(

96 
OpQueu—bË
::
Ref
 &&
™em
,

97 
co¡
,

98 
´iÜ™y
,

99 
utime_t
 
¡¬t_time
,

100 
ušt64_t
 
owÃr
,

101 
•och_t
 
e
)

102 : 
	`q™em
(
¡d
::
	`move
(
™em
)),

103 
	`co¡
(
co¡
),

104 
	`´iÜ™y
(
´iÜ™y
),

105 
	`¡¬t_time
(
¡¬t_time
),

106 
	`owÃr
(
owÃr
),

107 
	$m­_•och
(
e
)

108 {
	}
}

109 
OpQueueI‹m
(OpQueueItem &&) = ;

110 
OpQueueI‹m
(cÚ¡ OpQueueI‹m &èğ
d–‘e
;

111 
	gOpQueueI‹m
 &
	gİ”©Ü
=(
OpQueueI‹m
 &&) = ;

112 
	gOpQueueI‹m
 &
	gİ”©Ü
=(cÚ¡ 
OpQueueI‹m
 &èğ
d–‘e
;

114 
	gOrd”Lock”
::
Ref
 
	$g‘_Üd”_lock”
(
PGRef
 
pg
) {

115  
q™em
->
	`g‘_Üd”_lock”
(
pg
);

116 
	}
}

117 
ušt32_t
 
	$g‘_queue_tok’
() const {

118  
q™em
->
	`g‘_queue_tok’
();

119 
	}
}

120 cÚ¡ 
	g¥g_t
& 
	$g‘_Üd”šg_tok’
() const {

121  
q™em
->
	`g‘_Üd”šg_tok’
();

122 
	}
}

123 
usšg
 
	gİ_ty³_t
 = 
OpQueu—bË
::
İ_ty³_t
;

124 
	gOpQueu—bË
::
İ_ty³_t
 
	$g‘_İ_ty³
() const {

125  
q™em
->
	`g‘_İ_ty³
();

126 
	}
}

127 
	gboo¡
::
İtiÚ®
<
OpReque¡Ref
> 
	$maybe_g‘_İ
() const {

128  
q™em
->
	`maybe_g‘_İ
();

129 
	}
}

130 
ušt64_t
 
	$g‘_»£rved_pushes
() const {

131  
q™em
->
	`g‘_»£rved_pushes
();

132 
	}
}

133 
	$run
(
OSD
 *
osd
, 
OSDSh¬d
 *
sd©a
,
PGRef
& 
pg
, 
Th»adPoŞ
::
TPHªdË
 &
hªdË
) {

134 
q™em
->
	`run
(
osd
, 
sd©a
, 
pg
, 
hªdË
);

135 
	}
}

136 
	$g‘_´iÜ™y
(ècÚ¡ {  
´iÜ™y
; 
	}
}

137 
	$g‘_co¡
(ècÚ¡ {  
co¡
; 
	}
}

138 
utime_t
 
	$g‘_¡¬t_time
(ècÚ¡ {  
¡¬t_time
; 
	}
}

139 
ušt64_t
 
	$g‘_owÃr
(ècÚ¡ {  
owÃr
; 
	}
}

140 
•och_t
 
	$g‘_m­_•och
(ècÚ¡ {  
m­_•och
; 
	}
}

142 
boŞ
 
	$is_³”šg
() const {

143  
q™em
->
	`is_³”šg
();

144 
	}
}

146 cÚ¡ 
PGC»©eInfo
 *
	$ü—‹s_pg
() const {

147  
q™em
->
	`ü—‹s_pg
();

148 
	}
}

150 
boŞ
 
	$³”šg_»quœes_pg
() const {

151  
q™em
->
	`³”šg_»quœes_pg
();

152 
	}
}

154 
ä›nd
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gOpQueueI‹m
& 
	g™em
) {

155 
	gout
 << "OpQueueItem("

156 << 
	g™em
.
g‘_Üd”šg_tok’
(è<< " " << *™em.
	gq™em


157 << "…riØ" << 
	g™em
.
g‘_´iÜ™y
()

158 << " co¡ " << 
	g™em
.
g‘_co¡
()

159 << "ƒ" << 
	g™em
.
g‘_m­_•och
();

160 ià(
	g™em
.
g‘_»£rved_pushes
()) {

161 
	gout
 << "„e£rved_pushe " << 
	g™em
.
g‘_»£rved_pushes
();

163  
	gout
 << ")";

168 şas 
	cPGOpQueu—bË
 : 
public
 
OpQueueI‹m
::
OpQueu—bË
 {

169 
¥g_t
 
pgid
;

170 
	m´Ùeùed
:

171 cÚ¡ 
¥g_t
& 
	$g‘_pgid
() const {

172  
pgid
;

174 
public
:

175 
ex¶ic™
 
	$PGOpQueu—bË
(
¥g_t
 
pg
è: 
	$pgid
(
pg
è{
	}
}

176 
ušt32_t
 
	$g‘_queue_tok’
(ècÚ¡ 
ov”ride
 
fš®
 {

177  
	`g‘_pgid
().
	`ps
();

178 
	}
}

180 cÚ¡ 
	g¥g_t
& 
	$g‘_Üd”šg_tok’
(ècÚ¡ 
ov”ride
 
fš®
 {

181  
	`g‘_pgid
();

182 
	}
}

184 
	gOpQueueI‹m
::
Ord”Lock”
::
Ref
 
	$g‘_Üd”_lock”
(
PGRef
 
pg
è
ov”ride
 
fš®
 {

185 şas 
	cLock”
 : 
public
 
OpQueueI‹m
::
Ord”Lock”
 {

186 
PGRef
 
pg
;

187 
public
:

188 
ex¶ic™
 
	`Lock”
(
PGRef
 
pg
è: 
	`pg
(pg) {}

189 
	`lock
(è
ov”ride
 
fš®
 {

190 
pg
->
	`lock
();

192 
	`uÆock
(è
ov”ride
 
fš®
 {

193 
pg
->
	`uÆock
();

196  
OpQueueI‹m
::
Ord”Lock”
::
	`Ref
(

197 
Ãw
 
	`Lock”
(
pg
));

198 
	}
}

201 şas 
	cPGOpI‹m
 : 
public
 
PGOpQueu—bË
 {

202 
OpReque¡Ref
 
İ
;

203 
	mpublic
:

204 
	$PGOpI‹m
(
¥g_t
 
pg
, 
OpReque¡Ref
 
İ
è: 
	`PGOpQueu—bË
Õg), 
	$İ
(
İ
) {}

205 
İ_ty³_t
 
	$g‘_İ_ty³
(ècÚ¡ 
ov”ride
 
fš®
 {

206  
İ_ty³_t
::
ş›Á_İ
;

207 
	}
}

208 
	go¡»am
 &
	$´št
(
o¡»am
 &
rhs
ècÚ¡ 
ov”ride
 
fš®
 {

209  
rhs
 << "PGOpI‹m(İ=" << *(
İ
->
	`g‘_»q
()) << ")";

210 
	}
}

211 
	gboo¡
::
İtiÚ®
<
OpReque¡Ref
> 
	$maybe_g‘_İ
(ècÚ¡ 
ov”ride
 
fš®
 {

212  
İ
;

213 
	}
}

214 
	$run
(
OSD
 *
osd
, 
OSDSh¬d
 *
sd©a
, 
PGRef
& 
pg
, 
Th»adPoŞ
::
TPHªdË
 &
hªdË
è
ov”ride
 
fš®
;

215 
	}
};

217 şas 
	cPGP“ršgI‹m
 : 
public
 
PGOpQueu—bË
 {

218 
PGP“ršgEv’tRef
 
evt
;

219 
	mpublic
:

220 
	$PGP“ršgI‹m
(
¥g_t
 
pg
, 
PGP“ršgEv’tRef
 
e
è: 
	`PGOpQueu—bË
Õg), 
	$evt
(
e
) {}

221 
İ_ty³_t
 
	$g‘_İ_ty³
(ècÚ¡ 
ov”ride
 
fš®
 {

222  
İ_ty³_t
::
³”šg_ev’t
;

223 
	}
}

224 
	go¡»am
 &
	$´št
(
o¡»am
 &
rhs
ècÚ¡ 
ov”ride
 
fš®
 {

225  
rhs
 << "PGP“ršgEv’t(" << 
evt
->
	`g‘_desc
() << ")";

226 
	}
}

227 
	$run
(
OSD
 *
osd
, 
OSDSh¬d
 *
sd©a
, 
PGRef
& 
pg
, 
Th»adPoŞ
::
TPHªdË
 &
hªdË
è
ov”ride
 
fš®
;

228 
boŞ
 
	$is_³”šg
(ècÚ¡ 
ov”ride
 {

229  
Œue
;

230 
	}
}

231 
boŞ
 
	$³”šg_»quœes_pg
(ècÚ¡ 
ov”ride
 {

232  
evt
->
»quœes_pg
;

233 
	}
}

234 cÚ¡ 
PGC»©eInfo
 *
	$ü—‹s_pg
(ècÚ¡ 
ov”ride
 {

235  
evt
->
ü—‹_šfo
.
	`g‘
();

236 
	}
}

239 şas 
	cPGSÇpTrim
 : 
public
 
PGOpQueu—bË
 {

240 
•och_t
 
•och_queued
;

241 
	mpublic
:

242 
	$PGSÇpTrim
(

243 
¥g_t
 
pg
,

244 
•och_t
 
•och_queued
)

245 : 
	`PGOpQueu—bË
(
pg
), 
	$•och_queued
(
•och_queued
) {}

246 
İ_ty³_t
 
	$g‘_İ_ty³
(ècÚ¡ 
ov”ride
 
fš®
 {

247  
İ_ty³_t
::
bg_¢­Œim
;

248 
	}
}

249 
	go¡»am
 &
	$´št
(
o¡»am
 &
rhs
ècÚ¡ 
ov”ride
 
fš®
 {

250  
rhs
 << "PGSÇpTrimÕgid=" << 
	`g‘_pgid
()

251 << "•och_queued=" << 
•och_queued


253 
	}
}

254 
	$run
(

255 
OSD
 *
osd
, 
OSDSh¬d
 *
sd©a
, 
PGRef
& 
pg
, 
Th»adPoŞ
::
TPHªdË
 &
hªdË
è
ov”ride
 
fš®
;

256 
	}
};

258 şas 
	cPGSüub
 : 
public
 
PGOpQueu—bË
 {

259 
•och_t
 
•och_queued
;

260 
	mpublic
:

261 
	$PGSüub
(

262 
¥g_t
 
pg
,

263 
•och_t
 
•och_queued
)

264 : 
	`PGOpQueu—bË
(
pg
), 
	$•och_queued
(
•och_queued
) {}

265 
İ_ty³_t
 
	$g‘_İ_ty³
(ècÚ¡ 
ov”ride
 
fš®
 {

266  
İ_ty³_t
::
bg_süub
;

267 
	}
}

268 
	go¡»am
 &
	$´št
(
o¡»am
 &
rhs
ècÚ¡ 
ov”ride
 
fš®
 {

269  
rhs
 << "PGSüubÕgid=" << 
	`g‘_pgid
()

270 << "•och_queued=" << 
•och_queued


272 
	}
}

273 
	$run
(

274 
OSD
 *
osd
, 
OSDSh¬d
 *
sd©a
, 
PGRef
& 
pg
, 
Th»adPoŞ
::
TPHªdË
 &
hªdË
è
ov”ride
 
fš®
;

275 
	}
};

277 şas 
	cPGRecov”y
 : 
public
 
PGOpQueu—bË
 {

278 
•och_t
 
•och_queued
;

279 
ušt64_t
 
	m»£rved_pushes
;

280 
	mpublic
:

281 
	$PGRecov”y
(

282 
¥g_t
 
pg
,

283 
•och_t
 
•och_queued
,

284 
ušt64_t
 
»£rved_pushes
)

285 : 
	`PGOpQueu—bË
(
pg
),

286 
	`•och_queued
(
•och_queued
),

287 
	$»£rved_pushes
(
»£rved_pushes
) {}

288 
İ_ty³_t
 
	$g‘_İ_ty³
(ècÚ¡ 
ov”ride
 
fš®
 {

289  
İ_ty³_t
::
bg_»cov”y
;

290 
	}
}

291 
vœtu®
 
	go¡»am
 &
	$´št
(
o¡»am
 &
rhs
ècÚ¡ 
ov”ride
 
fš®
 {

292  
rhs
 << "PGRecov”yÕgid=" << 
	`g‘_pgid
()

293 << "•och_queued=" << 
•och_queued


294 << "»£rved_pushes=" << 
»£rved_pushes


296 
	}
}

297 
vœtu®
 
ušt64_t
 
	$g‘_»£rved_pushes
(ècÚ¡ 
ov”ride
 
fš®
 {

298  
»£rved_pushes
;

299 
	}
}

300 
vœtu®
 
	$run
(

301 
OSD
 *
osd
, 
OSDSh¬d
 *
sd©a
, 
PGRef
& 
pg
, 
Th»adPoŞ
::
TPHªdË
 &
hªdË
è
ov”ride
 
fš®
;

302 
	}
};

304 şas 
	cPGRecov”yCÚ‹xt
 : 
public
 
PGOpQueu—bË
 {

305 
unique_±r
<
G’CÚ‹xt
<
Th»adPoŞ
::
TPHªdË
&>> 
c
;

306 
•och_t
 
	m•och
;

307 
	mpublic
:

308 
PGRecov”yCÚ‹xt
(
¥g_t
 
pgid
,

309 
G’CÚ‹xt
<
Th»adPoŞ
::
TPHªdË
&> *
c
, 
•och_t
 
•och
)

310 : 
PGOpQueu—bË
(
pgid
),

311 
c
(c), 
	$•och
(
•och
) {}

312 
İ_ty³_t
 
	$g‘_İ_ty³
(ècÚ¡ 
ov”ride
 
fš®
 {

313  
İ_ty³_t
::
bg_»cov”y
;

314 
	}
}

315 
	go¡»am
 &
	$´št
(
o¡»am
 &
rhs
ècÚ¡ 
ov”ride
 
fš®
 {

316  
rhs
 << "PGRecov”yCÚ‹xtÕgid=" << 
	`g‘_pgid
()

317 << " c=" << 
c
.
	`g‘
(è<< "ƒpoch=" << 
•och


319 
	}
}

320 
	$run
(

321 
OSD
 *
osd
, 
OSDSh¬d
 *
sd©a
, 
PGRef
& 
pg
, 
Th»adPoŞ
::
TPHªdË
 &
hªdË
è
ov”ride
 
fš®
;

322 
	}
};

324 şas 
	cPGD–‘e
 : 
public
 
PGOpQueu—bË
 {

325 
•och_t
 
•och_queued
;

326 
	mpublic
:

327 
	$PGD–‘e
(

328 
¥g_t
 
pg
,

329 
•och_t
 
•och_queued
)

330 : 
	`PGOpQueu—bË
(
pg
),

331 
	$•och_queued
(
•och_queued
) {}

332 
İ_ty³_t
 
	$g‘_İ_ty³
(ècÚ¡ 
ov”ride
 
fš®
 {

333  
İ_ty³_t
::
bg_pg_d–‘e
;

334 
	}
}

335 
	go¡»am
 &
	$´št
(
o¡»am
 &
rhs
ècÚ¡ 
ov”ride
 
fš®
 {

336  
rhs
 << "PGD–‘e(" << 
	`g‘_pgid
()

337 << "ƒ" << 
•och_queued


339 
	}
}

340 
	$run
(

341 
OSD
 *
osd
, 
OSDSh¬d
 *
sd©a
, 
PGRef
& 
pg
, 
Th»adPoŞ
::
TPHªdË
 &
hªdË
è
ov”ride
 
fš®
;

342 
	}
};

	@osd/OpRequest.cc

3 
	~"OpReque¡.h
"

4 
	~"commÚ/FÜm©‹r.h
"

5 
	~<io¡»am
>

6 
	~<veùÜ
>

7 
	~"commÚ/debug.h
"

8 
	~"commÚ/cÚfig.h
"

9 
	~"msg/Mes§ge.h
"

10 
	~"mes§ges/MOSDOp.h
"

11 
	~"mes§ges/MOSDR•Op.h
"

12 
	~"mes§ges/MOSDR•OpR•ly.h
"

13 
	~"šşude/as£¹.h
"

14 
	~"osd/osd_ty³s.h
"

16 #ifdeà
WITH_LTTNG


17 
	#TRACEPOINT_DEFINE


	)

18 
	#TRACEPOINT_PROBE_DYNAMIC_LINKAGE


	)

19 
	~"Œacšg/İ»que¡.h
"

20 #undeà
TRACEPOINT_PROBE_DYNAMIC_LINKAGE


21 #undeà
TRACEPOINT_DEFINE


23 
	#Œaûpošt
(...)

	)

26 
	gOpReque¡
::
	$OpReque¡
(
Mes§ge
 *
»q
, 
OpT¿ck”
 *
Œack”
) :

27 
	`T¿ckedOp
(
Œack”
, 
»q
->
	`g‘_»cv_¡amp
()),

28 
	`rmw_æags
(0), 
	`»que¡
(
»q
),

29 
	`h™_æag_pošts
(0), 
	`Ï‹¡_æag_pošt
(0),

30 
	$h™£t_š£¹ed
(
çl£
)

32 ià(
»q
->
	`g‘_´iÜ™y
(è< 
Œack”
->
cù
->
_cÚf
->
osd_ş›Á_İ_´iÜ™y
) {

34 
w¬n_š‹rv®_muÉl›r
 = 
Œack”
->
cù
->
_cÚf
->
osd_»cov”y_İ_w¬n_muÉË
;

36 ià(
»q
->
	`g‘_ty³
(è=ğ
CEPH_MSG_OSD_OP
) {

37 
»qid
 = 
¡©ic_ÿ¡
<
MOSDOp
*>(
»q
)->
	`g‘_»qid
();

38 } ià(
»q
->
	`g‘_ty³
(è=ğ
MSG_OSD_REPOP
) {

39 
»qid
 = 
¡©ic_ÿ¡
<
MOSDR•Op
*>(
»q
)->reqid;

40 } ià(
»q
->
	`g‘_ty³
(è=ğ
MSG_OSD_REPOPREPLY
) {

41 
»qid
 = 
¡©ic_ÿ¡
<
MOSDR•OpR•ly
*>(
»q
)->reqid;

43 
»q_¤c_š¡
 = 
»q
->
	`g‘_sourû_š¡
();

44 
	}
}

46 
	gOpReque¡
::
	$_dump
(
FÜm©‹r
 *
f
) const

48 
Mes§ge
 *
m
 = 
»que¡
;

49 
f
->
	`dump_¡ršg
("æag_pošt", 
	`¡©e_¡ršg
());

50 ià(
m
->
	`g‘_Üig_sourû
().
	`is_ş›Á
()) {

51 
f
->
	`İ’_objeù_£ùiÚ
("client_info");

52 
¡ršg¡»am
 
ş›Á_Çme
, 
ş›Á_addr
;

53 
ş›Á_Çme
 << 
»q_¤c_š¡
.
Çme
;

54 
ş›Á_addr
 << 
»q_¤c_š¡
.
addr
;

55 
f
->
	`dump_¡ršg
("ş›Á", 
ş›Á_Çme
.
	`¡r
());

56 
f
->
	`dump_¡ršg
("ş›Á_addr", 
ş›Á_addr
.
	`¡r
());

57 
f
->
	`dump_unsigÃd
("tid", 
m
->
	`g‘_tid
());

58 
f
->
	`şo£_£ùiÚ
();

61 
f
->
	`İ’_¬¿y_£ùiÚ
("events");

62 
Mu‹x
::
Lock”
 
	`l
(
lock
);

63 auto& 
i
 : 
ev’ts
) {

64 
f
->
	`dump_objeù
("ev’t", 
i
);

66 
f
->
	`şo£_£ùiÚ
();

68 
	}
}

70 
	gOpReque¡
::
	$_dump_İ_desütÜ_uÆocked
(
o¡»am
& 
¡»am
) const

72 
	`g‘_»q
()->
	`´št
(
¡»am
);

73 
	}
}

75 
	gOpReque¡
::
	$_uÄegi¡”ed
() {

76 
»que¡
->
	`ş—r_d©a
();

77 
»que¡
->
	`ş—r_·ylßd
();

78 
»que¡
->
	`»Ëa£_mes§ge_thrÙe
();

79 
»que¡
->
	`£t_cÚÃùiÚ
(
nuÎ±r
);

80 
	}
}

82 
boŞ
 
	gOpReque¡
::
	$check_rmw
(
æag
) {

83 
	`as£¹
(
rmw_æags
 != 0);

84  
rmw_æags
 & 
æag
;

85 
	}
}

86 
boŞ
 
	gOpReque¡
::
	$may_»ad
() {

87  
	`Ãed_»ad_ÿp
(è|| 
	`check_rmw
(
CEPH_OSD_RMW_FLAG_CLASS_READ
);

88 
	}
}

89 
boŞ
 
	gOpReque¡
::
	$may_wr™e
() {

90  
	`Ãed_wr™e_ÿp
(è|| 
	`check_rmw
(
CEPH_OSD_RMW_FLAG_CLASS_WRITE
);

91 
	}
}

92 
boŞ
 
	gOpReque¡
::
	$may_ÿche
(è{  
	`check_rmw
(
CEPH_OSD_RMW_FLAG_CACHE
); 
	}
}

93 
boŞ
 
	gOpReque¡
::
	$rwÜd”ed_fÜûd
() {

94  
	`check_rmw
(
CEPH_OSD_RMW_FLAG_RWORDERED
);

95 
	}
}

96 
boŞ
 
	gOpReque¡
::
	$rwÜd”ed
() {

97  
	`may_wr™e
(è|| 
	`may_ÿche
(è|| 
	`rwÜd”ed_fÜûd
();

98 
	}
}

100 
boŞ
 
	gOpReque¡
::
	$šşudes_pg_İ
(è{  
	`check_rmw
(
CEPH_OSD_RMW_FLAG_PGOP
); 
	}
}

101 
boŞ
 
	gOpReque¡
::
	$Ãed_»ad_ÿp
() {

102  
	`check_rmw
(
CEPH_OSD_RMW_FLAG_READ
);

103 
	}
}

104 
boŞ
 
	gOpReque¡
::
	$Ãed_wr™e_ÿp
() {

105  
	`check_rmw
(
CEPH_OSD_RMW_FLAG_WRITE
);

106 
	}
}

107 
boŞ
 
	gOpReque¡
::
	$Ãed_´omÙe
() {

108  
	`check_rmw
(
CEPH_OSD_RMW_FLAG_FORCE_PROMOTE
);

109 
	}
}

110 
boŞ
 
	gOpReque¡
::
	$Ãed_sk_hªdË_ÿche
() {

111  
	`check_rmw
(
CEPH_OSD_RMW_FLAG_SKIP_HANDLE_CACHE
);

112 
	}
}

113 
boŞ
 
	gOpReque¡
::
	$Ãed_sk_´omÙe
() {

114  
	`check_rmw
(
CEPH_OSD_RMW_FLAG_SKIP_PROMOTE
);

115 
	}
}

117 
	gOpReque¡
::
	$£t_rmw_æags
(
æags
) {

118 #ifdeà
WITH_LTTNG


119 
Şd_rmw_æags
 = 
rmw_æags
;

121 
rmw_æags
 |ğ
æags
;

122 
	`Œaûpošt
(
İ»que¡
, 
£t_rmw_æags
, 
»qid
.
Çme
.
_ty³
,

123 
»qid
.
Çme
.
_num
,„eqid.
tid
,„eqid.
šc
,

124 
æags
, 
Şd_rmw_æags
, 
rmw_æags
);

125 
	}
}

127 
	gOpReque¡
::
	$£t_»ad
(è{ 
	`£t_rmw_æags
(
CEPH_OSD_RMW_FLAG_READ
); 
	}
}

128 
	gOpReque¡
::
	$£t_wr™e
(è{ 
	`£t_rmw_æags
(
CEPH_OSD_RMW_FLAG_WRITE
); 
	}
}

129 
	gOpReque¡
::
	$£t_şass_»ad
(è{ 
	`£t_rmw_æags
(
CEPH_OSD_RMW_FLAG_CLASS_READ
); 
	}
}

130 
	gOpReque¡
::
	$£t_şass_wr™e
(è{ 
	`£t_rmw_æags
(
CEPH_OSD_RMW_FLAG_CLASS_WRITE
); 
	}
}

131 
	gOpReque¡
::
	$£t_pg_İ
(è{ 
	`£t_rmw_æags
(
CEPH_OSD_RMW_FLAG_PGOP
); 
	}
}

132 
	gOpReque¡
::
	$£t_ÿche
(è{ 
	`£t_rmw_æags
(
CEPH_OSD_RMW_FLAG_CACHE
); 
	}
}

133 
	gOpReque¡
::
	$£t_´omÙe
(è{ 
	`£t_rmw_æags
(
CEPH_OSD_RMW_FLAG_FORCE_PROMOTE
); 
	}
}

134 
	gOpReque¡
::
	$£t_sk_hªdË_ÿche
(è{ 
	`£t_rmw_æags
(
CEPH_OSD_RMW_FLAG_SKIP_HANDLE_CACHE
); 
	}
}

135 
	gOpReque¡
::
	$£t_sk_´omÙe
(è{ 
	`£t_rmw_æags
(
CEPH_OSD_RMW_FLAG_SKIP_PROMOTE
); 
	}
}

136 
	gOpReque¡
::
	$£t_fÜû_rwÜd”ed
(è{ 
	`£t_rmw_æags
(
CEPH_OSD_RMW_FLAG_RWORDERED
); 
	}
}

138 
	gOpReque¡
::
	$m¬k_æag_pošt
(
ušt8_t
 
æag
, cÚ¡ *
s
) {

139 #ifdeà
WITH_LTTNG


140 
ušt8_t
 
Şd_æags
 = 
h™_æag_pošts
;

142 
	`m¬k_ev’t
(
s
);

143 
h™_æag_pošts
 |ğ
æag
;

144 
Ï‹¡_æag_pošt
 = 
æag
;

145 
	`Œaûpošt
(
İ»que¡
, 
m¬k_æag_pošt
, 
»qid
.
Çme
.
_ty³
,

146 
»qid
.
Çme
.
_num
,„eqid.
tid
,„eqid.
šc
, 
rmw_æags
,

147 
æag
, 
s
, 
Şd_æags
, 
h™_æag_pošts
);

148 
	}
}

150 
	gOpReque¡
::
	$m¬k_æag_pošt_¡ršg
(
ušt8_t
 
æag
, cÚ¡ 
¡ršg
& 
s
) {

151 #ifdeà
WITH_LTTNG


152 
ušt8_t
 
Şd_æags
 = 
h™_æag_pošts
;

154 
	`m¬k_ev’t_¡ršg
(
s
);

155 
h™_æag_pošts
 |ğ
æag
;

156 
Ï‹¡_æag_pošt
 = 
æag
;

157 
	`Œaûpošt
(
İ»que¡
, 
m¬k_æag_pošt
, 
»qid
.
Çme
.
_ty³
,

158 
»qid
.
Çme
.
_num
,„eqid.
tid
,„eqid.
šc
, 
rmw_æags
,

159 
æag
, 
s
.
	`c_¡r
(), 
Şd_æags
, 
h™_æag_pošts
);

160 
	}
}

162 
boŞ
 
	gOpReque¡
::
f‹r_out
(cÚ¡ 
£t
<
¡ršg
>& 
f‹rs
)

164 
£t
<
’t™y_addr_t
> 
addrs
;

165 autØ
	g™
 = 
f‹rs
.
begš
(); iˆ!ğf‹rs.
’d
(); it++) {

166 
’t™y_addr_t
 
	gaddr
;

167 ià(
	gaddr
.
·r£
((*
™
).
c_¡r
())) {

168 
	gaddrs
.
š£¹
(
addr
);

171 ià(
	gaddrs
.
em±y
())

172  
	gŒue
;

174 
’t™y_addr_t
 
	gcmp_addr
 = 
»q_¤c_š¡
.
addr
;

175 ià(
	gaddrs
.
couÁ
(
cmp_addr
)) {

176  
	gŒue
;

178 
	gcmp_addr
.
£t_nÚû
(0);

179 ià(
	gaddrs
.
couÁ
(
cmp_addr
)) {

180  
	gŒue
;

182 
	gcmp_addr
.
£t_pÜt
(0);

183 ià(
	gaddrs
.
couÁ
(
cmp_addr
)) {

184  
	gŒue
;

187  
	gçl£
;

190 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gOpReque¡
::
CÏssInfo
& 
i
)

192 
out
 << "şas " << 
i
.
şass_Çme
 << " m‘hod " << i.
m‘hod_Çme


193 << "„d " << 
i
.
»ad
 << " w¸" << i.
wr™e
 << " wÈ" << i.
wh™–i¡ed
;

194  
	gout
;

	@osd/OpRequest.h

14 #iâdeà
OPREQUEST_H_


15 
	#OPREQUEST_H_


	)

17 
	~"osd/osd_ty³s.h
"

18 
	~"commÚ/T¿ckedOp.h
"

24 
	gOpReque¡
 : 
public
 
T¿ckedOp
 {

25 
ä›nd
 
şass
 
OpT¿ck”
;

28 
	grmw_æags
;

30 
boŞ
 
check_rmw
(
æag
);

31 
boŞ
 
may_»ad
();

32 
boŞ
 
may_wr™e
();

33 
boŞ
 
may_ÿche
();

34 
boŞ
 
rwÜd”ed_fÜûd
();

35 
boŞ
 
rwÜd”ed
();

36 
boŞ
 
šşudes_pg_İ
();

37 
boŞ
 
Ãed_»ad_ÿp
();

38 
boŞ
 
Ãed_wr™e_ÿp
();

39 
boŞ
 
Ãed_´omÙe
();

40 
boŞ
 
Ãed_sk_hªdË_ÿche
();

41 
boŞ
 
Ãed_sk_´omÙe
();

42 
£t_»ad
();

43 
£t_wr™e
();

44 
£t_ÿche
();

45 
£t_şass_»ad
();

46 
£t_şass_wr™e
();

47 
£t_pg_İ
();

48 
£t_´omÙe
();

49 
£t_sk_hªdË_ÿche
();

50 
£t_sk_´omÙe
();

51 
£t_fÜû_rwÜd”ed
();

53 
	sCÏssInfo
 {

54 
CÏssInfo
(
¡d
::
¡ršg
&& 
şass_Çme
, std::¡ršg&& 
m‘hod_Çme
,

55 
boŞ
 
»ad
, boŞ 
wr™e
, boŞ 
wh™–i¡ed
) :

56 
şass_Çme
(
¡d
::
move
(şass_Çme)), 
m‘hod_Çme
(std::move(method_name)),

57 
»ad
Ô—d), 
wr™e
(wr™e), 
wh™–i¡ed
(whitelisted)

59 cÚ¡ 
	g¡d
::
¡ršg
 
şass_Çme
;

60 cÚ¡ 
	g¡d
::
¡ršg
 
m‘hod_Çme
;

61 cÚ¡ 
boŞ
 
	g»ad
, 
	gwr™e
, 
	gwh™–i¡ed
;

64 
add_şass
(
¡d
::
¡ršg
&& 
şass_Çme
, std::¡ršg&& 
m‘hod_Çme
,

65 
boŞ
 
»ad
, boŞ 
wr™e
, boŞ 
wh™–i¡ed
) {

66 
	gşas£s_
.
em¶aû_back
(
¡d
::
move
(
şass_Çme
), std::move(
m‘hod_Çme
),

67 
»ad
, 
wr™e
, 
wh™–i¡ed
);

70 
	g¡d
::
veùÜ
<
CÏssInfo
> 
şas£s
() const {

71  
şas£s_
;

74 
_dump
(
FÜm©‹r
 *
f
ècÚ¡ 
	gov”ride
;

76 
boŞ
 
has_ã©u»
(
ušt64_t
 
f
) const {

77  
	g»que¡
->
g‘_cÚÃùiÚ
()->
has_ã©u»
(
f
);

80 
	g´iv©e
:

81 
Mes§ge
 *
»que¡
;

82 
osd_»qid_t
 
	g»qid
;

83 
’t™y_š¡_t
 
	g»q_¤c_š¡
;

84 
ušt8_t
 
	gh™_æag_pošts
;

85 
ušt8_t
 
	gÏ‹¡_æag_pošt
;

86 
utime_t
 
	gdequeued_time
;

87 cÚ¡ 
ušt8_t
 
	gæag_queued_fÜ_pg
=1 << 0;

88 cÚ¡ 
ušt8_t
 
	gæag_»ached_pg
 = 1 << 1;

89 cÚ¡ 
ušt8_t
 
	gæag_d–ayed
 = 1 << 2;

90 cÚ¡ 
ušt8_t
 
	gæag_¡¬‹d
 = 1 << 3;

91 cÚ¡ 
ušt8_t
 
	gæag_sub_İ_£Á
 = 1 << 4;

92 cÚ¡ 
ušt8_t
 
	gæag_comm™_£Á
 = 1 << 5;

94 
	g¡d
::
veùÜ
<
CÏssInfo
> 
şas£s_
;

96 
OpReque¡
(
Mes§ge
 *
»q
, 
OpT¿ck”
 *
Œack”
);

98 
	g´Ùeùed
:

99 
_dump_İ_desütÜ_uÆocked
(
o¡»am
& 
¡»am
ècÚ¡ 
ov”ride
;

100 
_uÄegi¡”ed
(è
	gov”ride
;

101 
boŞ
 
f‹r_out
(cÚ¡ 
£t
<
¡ršg
>& 
f‹rs
è
	gov”ride
;

103 
	gpublic
:

104 ~
OpReque¡
(è
ov”ride
 {

105 
»que¡
->
put
();

108 
boŞ
 
	gcheck_£nd_m­
 = 
Œue
;

109 
•och_t
 
	g£Á_•och
 = 0;

110 
•och_t
 
	gmš_•och
 = 0;

112 
boŞ
 
	gh™£t_š£¹ed
;

113 cÚ¡ 
Mes§ge
 *
g‘_»q
(ècÚ¡ {  
	g»que¡
; }

114 
Mes§ge
 *
g‘_nÚcÚ¡_»q
(è{  
	g»que¡
; }

116 
’t™y_Çme_t
 
g‘_sourû
() {

117 ià(
	g»que¡
) {

118  
	g»que¡
->
g‘_sourû
();

120  
’t™y_Çme_t
();

124 cÚ¡ *
¡©e_¡ršg
(ècÚ¡ 
	gov”ride
 {

125 
	gÏ‹¡_æag_pošt
) {

126 
	gæag_queued_fÜ_pg
:  "queued for…g";

127 
	gæag_»ached_pg
:  "reached…g";

128 
	gæag_d–ayed
:  "delayed";

129 
	gæag_¡¬‹d
:  "started";

130 
	gæag_sub_İ_£Á
:  "waiting for sub ops";

131 
	gæag_comm™_£Á
:  "commit sent;‡pply or cleanup";

137 
m¬k_queued_fÜ_pg
() {

138 
m¬k_æag_pošt
(
æag_queued_fÜ_pg
, "queued_for_pg");

140 
m¬k_»ached_pg
() {

141 
m¬k_æag_pošt
(
æag_»ached_pg
, "reached_pg");

143 
m¬k_d–ayed
(cÚ¡ 
¡ršg
& 
s
) {

144 
m¬k_æag_pošt_¡ršg
(
æag_d–ayed
, 
s
);

146 
m¬k_¡¬‹d
() {

147 
m¬k_æag_pošt
(
æag_¡¬‹d
, "started");

149 
m¬k_sub_İ_£Á
(cÚ¡ 
¡ršg
& 
s
) {

150 
m¬k_æag_pošt_¡ršg
(
æag_sub_İ_£Á
, 
s
);

152 
m¬k_comm™_£Á
() {

153 
m¬k_æag_pošt
(
æag_comm™_£Á
, "commit_sent");

156 
utime_t
 
g‘_dequeued_time
() const {

157  
	gdequeued_time
;

159 
£t_dequeued_time
(
utime_t
 
deq_time
) {

160 
	gdequeued_time
 = 
deq_time
;

163 
osd_»qid_t
 
g‘_»qid
() const {

164  
	g»qid
;

167 
	gboo¡
::
	tšŒusive_±r
<
	tOpReque¡
> 
	tRef
;

169 
	g´iv©e
:

170 
£t_rmw_æags
(
æags
);

171 
m¬k_æag_pošt
(
ušt8_t
 
æag
, cÚ¡ *
s
);

172 
m¬k_æag_pošt_¡ršg
(
ušt8_t
 
æag
, cÚ¡ 
¡ršg
& 
s
);

175 
	gOpReque¡
::
	tRef
 
	tOpReque¡Ref
;

177 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gOpReque¡
::
CÏssInfo
& 
i
);

	@osd/PG.cc

15 
	~"PG.h
"

17 
	~"mes§ges/MOSDR•Süub.h
"

21 
	~"commÚ/”ºo.h
"

22 
	~"commÚ/cÚfig.h
"

23 
	~"OSD.h
"

24 
	~"OpReque¡.h
"

25 
	~"SüubStÜe.h
"

26 
	~"SessiÚ.h
"

28 
	~"commÚ/Tim”.h
"

29 
	~"commÚ/³rf_couÁ”s.h
"

31 
	~"mes§ges/MOSDOp.h
"

32 
	~"mes§ges/MOSDPGNÙify.h
"

34 
	~"mes§ges/MOSDPGRemove.h
"

35 
	~"mes§ges/MOSDPGInfo.h
"

36 
	~"mes§ges/MOSDPGTrim.h
"

37 
	~"mes§ges/MOSDPGSÿn.h
"

38 
	~"mes§ges/MOSDPGBackfl.h
"

39 
	~"mes§ges/MOSDPGBackflRemove.h
"

40 
	~"mes§ges/MBackflRe£rve.h
"

41 
	~"mes§ges/MRecov”yRe£rve.h
"

42 
	~"mes§ges/MOSDPGPush.h
"

43 
	~"mes§ges/MOSDPGPushR•ly.h
"

44 
	~"mes§ges/MOSDPGPuÎ.h
"

45 
	~"mes§ges/MOSDECSubOpWr™e.h
"

46 
	~"mes§ges/MOSDECSubOpWr™eR•ly.h
"

47 
	~"mes§ges/MOSDECSubOpR—d.h
"

48 
	~"mes§ges/MOSDECSubOpR—dR•ly.h
"

49 
	~"mes§ges/MOSDPGUpd©eLogMissšg.h
"

50 
	~"mes§ges/MOSDPGUpd©eLogMissšgR•ly.h
"

51 
	~"mes§ges/MOSDBackoff.h
"

52 
	~"mes§ges/MOSDSüubRe£rve.h
"

53 
	~"mes§ges/MOSDR•Op.h
"

54 
	~"mes§ges/MOSDR•OpR•ly.h
"

55 
	~"mes§ges/MOSDR•SüubM­.h
"

56 
	~"mes§ges/MOSDPGRecov”yD–‘e.h
"

57 
	~"mes§ges/MOSDPGRecov”yD–‘eR•ly.h
"

59 
	~"commÚ/BackT¿û.h
"

60 
	~"commÚ/Ev’tT¿û.h
"

62 #ifdeà
WITH_LTTNG


63 
	#TRACEPOINT_DEFINE


	)

64 
	#TRACEPOINT_PROBE_DYNAMIC_LINKAGE


	)

65 
	~"Œacšg/pg.h
"

66 #undeà
TRACEPOINT_PROBE_DYNAMIC_LINKAGE


67 #undeà
TRACEPOINT_DEFINE


69 
	#Œaûpošt
(...)

	)

72 
	~<s¡»am
>

74 
	#dout_cÚ‹xt
 
cù


	)

75 
	#dout_subsys
 
ûph_subsys_osd


	)

76 #undeà
dout_´efix


77 
	#dout_´efix
 
	`_´efix
(
_dout
, 
this
)

	)

81 cÚ¡ 
¡ršg
 
šfov”_key
("_infover");

82 cÚ¡ 
¡ršg
 
šfo_key
("_info");

83 cÚ¡ 
¡ršg
 
bigšfo_key
("_biginfo");

84 cÚ¡ 
¡ršg
 
•och_key
("_epoch");

85 cÚ¡ 
¡ršg
 
ç¡šfo_key
("_fastinfo");

87 
	g‹m¶©e
 <
şass
 
	gT
>

88 
	go¡»am
& 
	$_´efix
(
¡d
::
o¡»am
 *
_dout
, 
T
 *
t
)

90  
t
->
	`g’_´efix
(*
_dout
);

91 
	}
}

93 
	gPGS‹Hi¡Üy
::
	$’‹r
(
PG
* 
pg
, cÚ¡ 
utime_t
 
’time
, cÚ¡ * 
¡©e
)

96 ià(::
	`¡r¡r
(
¡©e
, "Trimmšg"è!ğ
NULL
) {

98 } ià(
pi
 !ğ
nuÎ±r
) {

99 
pi
->
	`’‹r_¡©e
(
’time
, 
¡©e
);

102 iàĞ
tmµi
 =ğ
nuÎ±r
) {

103 
tmµi
 = 
¡d
::
unique_±r
<
PGS‹In¡ªû
>(
Ãw
 PGStateInstance);

106 
thi¥g
 = 
pg
;

107 
tmµi
->
	`’‹r_¡©e
(
’time
, 
¡©e
);

109 
	}
}

111 
	gPGS‹Hi¡Üy
::
	$ex™
(cÚ¡ * 
¡©e
) {

114 ià(::
	`¡r¡r
(
¡©e
, "Trimmšg"è!ğ
NULL
 || 
pg_š_de¡ruùÜ
) {

117 
boŞ
 
ocked
 = 
çl£
;

118 if(!
thi¥g
->
	`is_locked
()) {

119 
thi¥g
->
	`lock
();

120 
ocked
 = 
Œue
;

122 ià(
pi
 =ğ
nuÎ±r
) {

123 
bufãr
.
	`push_back
(
¡d
::
unique_±r
<
PGS‹In¡ªû
>(
tmµi
.
	`»Ëa£
()));

124 
pi
 = 
bufãr
.
	`back
().
	`g‘
();

125 
pi
->
	`£‹poch
(
thi¥g
->
	`g‘_osdm­
()->
	`g‘_•och
());

128 
pi
->
	`ex™_¡©e
(
	`ûph_şock_now
());

129 ià(::
	`¡rcmp
(
¡©e
, "Reset") == 0) {

130 
this
->
	`»£t
();

132 if(
ocked
) {

133 
thi¥g
->
	`uÆock
();

136 
	}
}

138 
	gPGS‹Hi¡Üy
::
	$dump
(
FÜm©‹r
* 
f
) const {

139 
f
->
	`İ’_¬¿y_£ùiÚ
("history");

140 autØ
pi
 = 
bufãr
.
	`begš
();…˜!ğbufãr.
	`’d
(); ++pi) {

141 
f
->
	`İ’_objeù_£ùiÚ
("states");

142 
f
->
	`dump_¡»am
("•och"è<< (*
pi
)->
this_•och
;

143 autØ
she
 : (*
pi
)->
¡©e_hi¡Üy
) {

144 
f
->
	`dump_¡ršg
("¡©e", 
¡d
::
g‘
<2>(
she
));

145 
f
->
	`dump_¡»am
("’‹r"è<< 
¡d
::
g‘
<0>(
she
);

146 
f
->
	`dump_¡»am
("ex™"è<< 
¡d
::
g‘
<1>(
she
);

148 
f
->
	`şo£_£ùiÚ
();

150 
f
->
	`şo£_£ùiÚ
();

151 
	}
}

153 
	gPG
::
	$g‘
(cÚ¡ * 
g
)

155 
»f
++;

156 #ifdeà
PG_DEBUG_REFS


157 
Mu‹x
::
Lock”
 
	`l
(
_»f_id_lock
);

158 
_g_couÁs
[
g
]++;

160 
	}
}

162 
	gPG
::
	$put
(cÚ¡ * 
g
)

164 #ifdeà
PG_DEBUG_REFS


166 
Mu‹x
::
Lock”
 
	`l
(
_»f_id_lock
);

167 autØ
g_couÁs_’Œy
 = 
_g_couÁs
.
	`fšd
(
g
);

168 
	`as£¹
(
g_couÁs_’Œy
 !ğ
_g_couÁs
.
	`’d
());

169 --
g_couÁs_’Œy
->
£cÚd
;

170 ià(
g_couÁs_’Œy
->
£cÚd
 == 0) {

171 
_g_couÁs
.
	`”a£
(
g_couÁs_’Œy
);

175 ià(--
»f
== 0)

176 
d–‘e
 
this
;

177 
	}
}

179 #ifdeà
PG_DEBUG_REFS


180 
ušt64_t
 
	gPG
::
	$g‘_w™h_id
()

182 
»f
++;

183 
Mu‹x
::
Lock”
 
	`l
(
_»f_id_lock
);

184 
ušt64_t
 
id
 = ++
_»f_id
;

185 
BackT¿û
 
	`bt
(0);

186 
¡ršg¡»am
 
ss
;

187 
bt
.
	`´št
(
ss
);

188 
	`dout
(20è<< 
__func__
 << ": " << 
šfo
.
pgid
 << " gÙ id " << 
id
 << " (Ãwè»f==" << 
»f
 << 
d’dl
;

189 
	`as£¹
(!
_live_ids
.
	`couÁ
(
id
));

190 
_live_ids
.
	`š£¹
(
	`make_·œ
(
id
, 
ss
.
	`¡r
()));

191  
id
;

192 
	}
}

194 
	gPG
::
	$put_w™h_id
(
ušt64_t
 
id
)

196 
	`dout
(20è<< 
__func__
 << ": " << 
šfo
.
pgid
 << "…uˆid " << 
id
 << " (cu¼’tè»f==" << 
»f
 << 
d’dl
;

198 
Mu‹x
::
Lock”
 
	`l
(
_»f_id_lock
);

199 
	`as£¹
(
_live_ids
.
	`couÁ
(
id
));

200 
_live_ids
.
	`”a£
(
id
);

202 ià(--
»f
 == 0)

203 
d–‘e
 
this
;

204 
	}
}

206 
	gPG
::
	$dump_live_ids
()

208 
Mu‹x
::
Lock”
 
	`l
(
_»f_id_lock
);

209 
	`dout
(0è<< "\t" << 
__func__
 << ": " << 
šfo
.
pgid
 << "†ivids:" << 
d’dl
;

210 
m­
<
ušt64_t
, 
¡ršg
>::
™”©Ü
 
i
 = 
_live_ids
.
	`begš
();

211 
i
 !ğ
_live_ids
.
	`’d
();

212 ++
i
) {

213 
	`dout
(0è<< "\t\tid: " << *
i
 << 
d’dl
;

215 
	`dout
(0è<< "\t" << 
__func__
 << ": " << 
šfo
.
pgid
 << "†ivgs:" << 
d’dl
;

216 
m­
<
¡ršg
, 
ušt64_t
>::
™”©Ü
 
i
 = 
_g_couÁs
.
	`begš
();

217 
i
 !ğ
_g_couÁs
.
	`’d
();

218 ++
i
) {

219 
	`dout
(0è<< "\t\tid: " << *
i
 << 
d’dl
;

221 
	}
}

225 
	gPGPoŞ
::
	$upd©e
(
C•hCÚ‹xt
 *
cù
, 
OSDM­Ref
 
m­
)

227 cÚ¡ 
pg_poŞ_t
 *
pi
 = 
m­
->
	`g‘_pg_poŞ
(
id
);

228 ià(!
pi
) {

231 
šfo
 = *
pi
;

232 
Çme
 = 
m­
->
	`g‘_poŞ_Çme
(
id
);

234 
boŞ
 
upd©ed
 = 
çl£
;

235 ià((
m­
->
	`g‘_•och
(è!ğ
ÿched_•och
 + 1) ||

236 (
pi
->
	`g‘_¢­_•och
(è=ğ
m­
->
	`g‘_•och
())) {

237 
upd©ed
 = 
Œue
;

240 ià(
m­
->
»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_MIMIC
) {

244 
ÿched_»moved_¢­s
.
	`ş—r
();

245 
Ãwly_»moved_¢­s
.
	`ş—r
();

248 ià(
upd©ed
) {

249 ià(
pi
->
	`maybe_upd©ed_»moved_¢­s
(
ÿched_»moved_¢­s
)) {

250 
pi
->
	`bud_»moved_¢­s
(
Ãwly_»moved_¢­s
);

251 ià(
ÿched_»moved_¢­s
.
	`sub£t_of
(
Ãwly_»moved_¢­s
)) {

252 
š‹rv®_£t
<
¢­id_t
> 
»moved_¢­s
 = 
Ãwly_»moved_¢­s
;

253 
Ãwly_»moved_¢­s
.
	`subŒaù
(
ÿched_»moved_¢­s
);

254 
ÿched_»moved_¢­s
.
	`sw­
(
»moved_¢­s
);

256 
	`lg’”ic_subdout
(
cù
, 
osd
, 0è<< 
__func__


257 << " cached_»moved_¢­ sh¿nk from " << 
ÿched_»moved_¢­s


258 << "Ø" << 
Ãwly_»moved_¢­s
 << 
d’dl
;

259 
ÿched_»moved_¢­s
.
	`sw­
(
Ãwly_»moved_¢­s
);

260 
Ãwly_»moved_¢­s
.
	`ş—r
();

263 
Ãwly_»moved_¢­s
.
	`ş—r
();

276 
Ãwly_»moved_¢­s
.
	`ş—r
();

278 
	`lg’”ic_subdout
(
cù
, 
osd
, 20)

280 << 
ÿched_»moved_¢­s


282 << 
Ãwly_»moved_¢­s


283 << " sÇpø" << 
¢­c


284 << (
upd©ed
 ? " (updated)":" (no change)")

285 << 
d’dl
;

286 ià(
cù
->
_cÚf
->
osd_debug_v”ify_ÿched_¢­s
) {

287 
š‹rv®_£t
<
¢­id_t
> 
aùu®_»moved_¢­s
;

288 
pi
->
	`bud_»moved_¢­s
(
aùu®_»moved_¢­s
);

289 ià(!(
aùu®_»moved_¢­s
 =ğ
ÿched_»moved_¢­s
)) {

290 
	`lg’”ic_d”r
(
cù
è<< 
__func__


292 << 
aùu®_»moved_¢­s


294 << "…oŞ.ÿched_»moved_¢­ " << 
ÿched_»moved_¢­s


295 << 
d’dl
;

297 
	`as£¹
(
aùu®_»moved_¢­s
 =ğ
ÿched_»moved_¢­s
);

300 ià(
šfo
.
	`is_poŞ_¢­s_mode
(è&& 
upd©ed
) {

301 
¢­c
 = 
pi
->
	`g‘_¢­_cÚ‹xt
();

303 
ÿched_•och
 = 
m­
->
	`g‘_•och
();

304 
	}
}

306 
	gPG
::
	$PG
(
OSDS”viû
 *
o
, 
OSDM­Ref
 
curm­
,

307 cÚ¡ 
PGPoŞ
 &
_poŞ
, 
¥g_t
 
p
) :

308 
	`pg_id
(
p
),

309 
	`cŞl
(
p
),

310 
	`osd
(
o
),

311 
	`cù
(
o
->
cù
),

312 
	`osdm­_»f
(
curm­
),

313 
	`poŞ
(
_poŞ
),

314 
	`osdriv”
(
osd
->
¡Üe
, 
	`cŞl_t
(), 
OSD
::
	`make_¢­m­³r_oid
()),

315 
	`¢­_m­³r
(

316 
cù
,

317 &
osdriv”
,

318 
p
.
	`ps
(),

319 
p
.
	`g‘_¥l™_b™s
(
_poŞ
.
šfo
.
	`g‘_pg_num
()),

320 
_poŞ
.
id
,

321 
p
.
sh¬d
),

322 
	`Ï¡_³rsi¡ed_osdm­
(
curm­
->
	`g‘_•och
()),

323 
	`d–‘šg
(
çl£
),

324 
	`Œaû_’dpošt
("0.0.0.0", 0, "PG"),

325 
	`dœty_šfo
(
çl£
), 
	`dœty_big_šfo
(false),

326 
	`šfo
(
p
),

327 
	`šfo_¡ruù_v
(0),

328 
	`pg_log
(
cù
),

329 
	`pgm‘a_oid
(
p
.
	`make_pgm‘a_oid
()),

330 
	`missšg_loc
(
this
),

331 
	`¡©_queue_™em
(
this
),

332 
	`süub_queued
(
çl£
),

333 
	`»cov”y_queued
(
çl£
),

334 
	`»cov”y_İs_aùive
(0),

335 
	`rŞe
(-1),

336 
	`¡©e
(0),

337 
	`£nd_nÙify
(
çl£
),

338 
	`pg_whßmi
(
osd
->
whßmi
, 
p
.
sh¬d
),

339 
	`Ãed_up_thru
(
çl£
),

340 
	`Ï¡_³”šg_»£t
(0),

341 
	`h—¹b—t_³”_lock
("PG::heartbeat_peer_lock"),

342 
	`backfl_»£rved
(
çl£
),

343 
	`backfl_»£rvšg
(
çl£
),

344 
	`æushes_š_´og»ss
(0),

345 
	`pg_¡©s_publish_lock
("PG::pg_stats_publish_lock"),

346 
	`pg_¡©s_publish_v®id
(
çl£
),

347 
	`fšish_sync_ev’t
(
NULL
),

348 
	`backoff_lock
("PG::backoff_lock"),

349 
	`süub_aá”_»cov”y
(
çl£
),

350 
	`aùive_pushes
(0),

351 
	`»cov”y_¡©e
(
this
),

352 
	`³”_ã©u»s
(
CEPH_FEATURES_SUPPORTED_DEFAULT
),

353 
	`aùšg_ã©u»s
(
CEPH_FEATURES_SUPPORTED_DEFAULT
),

354 
	`u·ùšg_ã©u»s
(
CEPH_FEATURES_SUPPORTED_DEFAULT
),

355 
	`Ï¡_•och
(0),

356 
	`Ï¡_»quœe_osd_»Ëa£
(
curm­
->
»quœe_osd_»Ëa£
)

358 #ifdeà
PG_DEBUG_REFS


359 
osd
->
	`add_pgid
(
p
, 
this
);

361 #ifdeà
WITH_BLKIN


362 
¡d
::
¡ršg¡»am
 
ss
;

363 
ss
 << "PG " << 
šfo
.
pgid
;

364 
Œaû_’dpošt
.
	`cİy_Çme
(
ss
.
	`¡r
());

366 
	}
}

368 
	gPG
::~
	$PG
()

370 
pg¡©e_hi¡Üy
.
	`£t_pg_š_de¡ruùÜ
();

371 #ifdeà
PG_DEBUG_REFS


372 
osd
->
	`»move_pgid
(
šfo
.
pgid
, 
this
);

374 
	}
}

376 
	gPG
::
	$lock
(
boŞ
 
no_lockd•
) const

378 
_lock
.
	`Lock
(
no_lockd•
);

380 
	`as£¹
(!
dœty_šfo
);

381 
	`as£¹
(!
dœty_big_šfo
);

383 
	`dout
(30è<< "lock" << 
d’dl
;

384 
	}
}

386 
	g¡d
::
o¡»am
& 
PG
::
	$g’_´efix
(
¡d
::
o¡»am
& 
out
) const

388 
OSDM­Ref
 
m­»f
 = 
osdm­_»f
;

389 ià(
_lock
.
	`is_locked_by_me
()) {

390 
out
 << "osd." << 
osd
->
whßmi


391 << "…g_•och: " << (
m­»f
 ? m­»f->
	`g‘_•och
():0)

392 << " " << *
this
 << " ";

394 
out
 << "osd." << 
osd
->
whßmi


395 << "…g_•och: " << (
m­»f
 ? m­»f->
	`g‘_•och
():0)

396 << "…g[" << 
šfo
.
pgid
 << "(unlocked)] ";

398  
out
;

399 
	}
}

403 
	gPG
::
	$´oc_ma¡”_log
(

404 
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
, 
pg_šfo_t
 &
ošfo
,

405 
pg_log_t
 &
Şog
, 
pg_missšg_t
& 
omissšg
, 
pg_sh¬d_t
 
äom
)

407 
	`dout
(10è<< "´oc_ma¡”_log fÜ osd." << 
äom
 << ": "

408 << 
Şog
 << " " << 
omissšg
 << 
d’dl
;

409 
	`as£¹
(!
	`is_³”ed
(è&& 
	`is_´im¬y
());

415 
	`m”ge_log
(
t
, 
ošfo
, 
Şog
, 
äom
);

416 
³”_šfo
[
äom
] = 
ošfo
;

417 
	`dout
(10è<< "…“¸osd." << 
äom
 << "‚ow " << 
ošfo
 << " " << 
omissšg
 << 
d’dl
;

418 
might_have_unfound
.
	`š£¹
(
äom
);

421 ià(
ošfo
.
Ï¡_•och_¡¬‹d
 > 
šfo
.last_epoch_started) {

422 
šfo
.
Ï¡_•och_¡¬‹d
 = 
ošfo
.last_epoch_started;

423 
dœty_šfo
 = 
Œue
;

425 ià(
ošfo
.
Ï¡_š‹rv®_¡¬‹d
 > 
šfo
.last_interval_started) {

426 
šfo
.
Ï¡_š‹rv®_¡¬‹d
 = 
ošfo
.last_interval_started;

427 
dœty_šfo
 = 
Œue
;

429 
	`upd©e_hi¡Üy
(
ošfo
.
hi¡Üy
);

430 
	`as£¹
(
cù
->
_cÚf
->
osd_fšd_be¡_šfo_ignÜe_hi¡Üy_Ës
 ||

431 
šfo
.
Ï¡_•och_¡¬‹d
 >ğšfo.
hi¡Üy
.last_epoch_started);

433 
³”_missšg
[
äom
].
	`şaim
(
omissšg
);

434 
	}
}

436 
	gPG
::
	$´oc_»¶iÿ_log
(

437 
pg_šfo_t
 &
ošfo
,

438 cÚ¡ 
pg_log_t
 &
Şog
,

439 
pg_missšg_t
& 
omissšg
,

440 
pg_sh¬d_t
 
äom
)

442 
	`dout
(10è<< "´oc_»¶iÿ_log fÜ osd." << 
äom
 << ": "

443 << 
ošfo
 << " " << 
Şog
 << " " << 
omissšg
 << 
d’dl
;

445 
pg_log
.
	`´oc_»¶iÿ_log
(
ošfo
, 
Şog
, 
omissšg
, 
äom
);

447 
³”_šfo
[
äom
] = 
ošfo
;

448 
	`dout
(10è<< "…“¸osd." << 
äom
 << "‚ow " << 
ošfo
 << " " << 
omissšg
 << 
d’dl
;

449 
might_have_unfound
.
	`š£¹
(
äom
);

451 
m­
<
hobjeù_t
, 
pg_missšg_™em
>::
cÚ¡_™”©Ü
 
i
 =

452 
omissšg
.
	`g‘_™ems
().
	`begš
();

453 
i
 !ğ
omissšg
.
	`g‘_™ems
().
	`’d
();

454 ++
i
) {

455 
	`dout
(20è<< "‡á” missšg " << 
i
->
fœ¡
 << "‚“d " << i->
£cÚd
.
Ãed


456 << " hav" << 
i
->
£cÚd
.
have
 << 
d’dl
;

458 
³”_missšg
[
äom
].
	`şaim
(
omissšg
);

459 
	}
}

461 
boŞ
 
	gPG
::
	$´oc_»¶iÿ_šfo
(

462 
pg_sh¬d_t
 
äom
, cÚ¡ 
pg_šfo_t
 &
ošfo
, 
•och_t
 
£nd_•och
)

464 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
>::
™”©Ü
 
p
 = 
³”_šfo
.
	`fšd
(
äom
);

465 ià(
p
 !ğ
³”_šfo
.
	`’d
(è&&…->
£cÚd
.
Ï¡_upd©e
 =ğ
ošfo
.last_update) {

466 
	`dout
(10è<< " gÙ du°osd." << 
äom
 << " infØ" << 
ošfo
 << ", id’tiÿÈtØours" << 
d’dl
;

467  
çl£
;

470 ià(!
	`g‘_osdm­
()->
	`has_b“n_up_sšû
(
äom
.
osd
, 
£nd_•och
)) {

471 
	`dout
(10è<< " gÙ infØ" << 
ošfo
 << " from dowÀosd." << 
äom


472 << " disÿrdšg" << 
d’dl
;

473  
çl£
;

476 
	`dout
(10è<< " gÙ osd." << 
äom
 << " " << 
ošfo
 << 
d’dl
;

477 
	`as£¹
(
	`is_´im¬y
());

478 
³”_šfo
[
äom
] = 
ošfo
;

479 
might_have_unfound
.
	`š£¹
(
äom
);

481 
	`upd©e_hi¡Üy
(
ošfo
.
hi¡Üy
);

484 ià(!
	`is_up
(
äom
è&& !
	`is_aùšg
(from)) {

485 
	`dout
(10è<< " osd." << 
äom
 << " ha ¡¿y cÚ‹Á: " << 
ošfo
 << 
d’dl
;

486 
¡¿y_£t
.
	`š£¹
(
äom
);

487 ià(
	`is_ş—n
()) {

488 
	`purge_¡¿ys
();

493 ià(
p
 =ğ
³”_šfo
.
	`’d
())

494 
	`upd©e_h—¹b—t_³”s
();

496  
Œue
;

497 
	}
}

499 
	gPG
::
	$»move_¢­_m­³d_objeù
(

500 
ObjeùStÜe
::
T¿n§ùiÚ
 &
t
, cÚ¡ 
hobjeù_t
 &
soid
)

502 
t
.
	`»move
(

503 
cŞl
,

504 
	`ghobjeù_t
(
soid
, 
ghobjeù_t
::
NO_GEN
, 
pg_whßmi
.
sh¬d
));

505 
	`ş—r_objeù_¢­_m­pšg
(&
t
, 
soid
);

506 
	}
}

508 
	gPG
::
	$ş—r_objeù_¢­_m­pšg
(

509 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
, cÚ¡ 
hobjeù_t
 &
soid
)

511 
OSDriv”
::
OST¿n§ùiÚ
 
	`_t
(
osdriv”
.
	`g‘_Œª§ùiÚ
(
t
));

512 ià(
soid
.
¢­
 < 
CEPH_MAXSNAP
) {

513 
r
 = 
¢­_m­³r
.
	`»move_oid
(

514 
soid
,

515 &
_t
);

516 ià(!(
r
 =ğ0 ||„ =ğ-
ENOENT
)) {

517 
d”r
 << 
__func__
 << ":„emove_oid„‘uºed " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

518 
	`ûph_abÜt
();

521 
	}
}

523 
	gPG
::
upd©e_objeù_¢­_m­pšg
(

524 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
, cÚ¡ 
hobjeù_t
 &
soid
, cÚ¡ 
£t
<
¢­id_t
> &
¢­s
)

526 
	gOSDriv”
::
OST¿n§ùiÚ
 
_t
(
osdriv”
.
g‘_Œª§ùiÚ
(
t
));

527 
as£¹
(
soid
.
¢­
 < 
CEPH_MAXSNAP
);

528 
	gr
 = 
¢­_m­³r
.
»move_oid
(

529 
soid
,

530 &
_t
);

531 ià(!(
	gr
 =ğ0 || 
r
 =ğ-
ENOENT
)) {

532 
d”r
 << 
__func__
 << ":„emove_oid„‘uºed " << 
ıp_¡»¼Ü
(
r
è<< 
d’dl
;

533 
ûph_abÜt
();

535 
	g¢­_m­³r
.
add_oid
(

536 
soid
,

537 
¢­s
,

538 &
_t
);

541 
	gPG
::
	$m”ge_log
(

542 
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
, 
pg_šfo_t
 &
ošfo
, 
pg_log_t
 &
Şog
, 
pg_sh¬d_t
 
äom
)

544 
PGLogEÁryHªdËr
 
rŞlback”
{
this
, &
t
};

545 
pg_log
.
	`m”ge_log
(

546 
ošfo
, 
Şog
, 
äom
, 
šfo
, &
rŞlback”
, 
dœty_šfo
, 
dœty_big_šfo
);

547 
	}
}

549 
	gPG
::
	$»wšd_div”g’t_log
(
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
, 
ev”siÚ_t
 
Ãwh—d
)

551 
PGLogEÁryHªdËr
 
rŞlback”
{
this
, &
t
};

552 
pg_log
.
	`»wšd_div”g’t_log
(

553 
Ãwh—d
, 
šfo
, &
rŞlback”
, 
dœty_šfo
, 
dœty_big_šfo
);

554 
	}
}

563 
boŞ
 
	gPG
::
	$£¬ch_fÜ_missšg
(

564 cÚ¡ 
pg_šfo_t
 &
ošfo
, cÚ¡ 
pg_missšg_t
 &
omissšg
,

565 
pg_sh¬d_t
 
äom
,

566 
Recov”yCtx
 *
ùx
)

568 
ušt64_t
 
num_unfound_befÜe
 = 
missšg_loc
.
	`num_unfound
();

569 
boŞ
 
found_missšg
 = 
missšg_loc
.
	`add_sourû_šfo
(

570 
äom
, 
ošfo
, 
omissšg
, 
ùx
->
hªdË
);

571 ià(
found_missšg
 && 
num_unfound_befÜe
 !ğ
missšg_loc
.
	`num_unfound
())

572 
	`publish_¡©s_to_osd
();

573 ià(
found_missšg
) {

574 
pg_šfo_t
 
	`tšfo
(
ošfo
);

575 
tšfo
.
pgid
.
sh¬d
 = 
pg_whßmi
.shard;

576 (*(
ùx
->
šfo_m­
))[
äom
.
osd
].
	`push_back
(

577 
	`make_·œ
(

578 
	`pg_nÙify_t
(

579 
äom
.
sh¬d
, 
pg_whßmi
.shard,

580 
	`g‘_osdm­
()->
	`g‘_•och
(),

581 
	`g‘_osdm­
()->
	`g‘_•och
(),

582 
tšfo
),

583 
·¡_š‹rv®s
));

585  
found_missšg
;

586 
	}
}

591 
boŞ
 
	gPG
::
MissšgLoc
::
»adabË_w™h_aùšg
(

592 cÚ¡ 
hobjeù_t
 &
hoid
,

593 cÚ¡ 
£t
<
pg_sh¬d_t
> &
aùšg
) const {

594 ià(!
Ãeds_»cov”y
(
hoid
))

595  
	gŒue
;

596 ià(
is_d–‘ed
(
hoid
))

597  
	gçl£
;

598 autØ
	gmissšg_loc_’Œy
 = 
missšg_loc
.
fšd
(
hoid
);

599 ià(
	gmissšg_loc_’Œy
 =ğ
missšg_loc
.
’d
())

600  
çl£
;

601 cÚ¡ 
	g£t
<
	gpg_sh¬d_t
> &
	glocs
 = 
missšg_loc_’Œy
->
£cÚd
;

602 
ldout
(
pg
->
cù
, 10è<< 
	g__func__
 << ":†ocs:" << 
	glocs
 << 
	gd’dl
;

603 
	g£t
<
	gpg_sh¬d_t
> 
	ghave_aùšg
;

604 
	g£t
<
	gpg_sh¬d_t
>::
cÚ¡_™”©Ü
 
i
 = 
locs
.
begš
();

605 
	gi
 !ğ
locs
.
’d
();

606 ++
	gi
) {

607 ià(
	gaùšg
.
couÁ
(*
i
))

608 
	ghave_aùšg
.
š£¹
(*
i
);

610  (*
	gis_»adabË
)(
	ghave_aùšg
);

613 
	gPG
::
MissšgLoc
::
add_b©ch_sourûs_šfo
(

614 cÚ¡ 
£t
<
pg_sh¬d_t
> &
sourûs
, 
Th»adPoŞ
::
TPHªdË
* 
hªdË
)

616 
ldout
(
pg
->
cù
, 10è<< 
	g__func__
 << ":‡dding sources in batch "

617 << 
	gsourûs
.
size
(è<< 
	gd’dl
;

618 
	gloİ
 = 0;

619 
boŞ
 
	gsourûs_upd©ed
 = 
çl£
;

620 
	gm­
<
	ghobjeù_t
, 
	gpg_missšg_™em
>::
cÚ¡_™”©Ü
 
i
 = 
Ãeds_»cov”y_m­
.
begš
();

621 
	gi
 !ğ
Ãeds_»cov”y_m­
.
’d
();

622 ++
	gi
) {

623 ià(
	ghªdË
 && ++
	gloİ
 >ğ
pg
->
cù
->
_cÚf
->
osd_loİ_befÜe_»£t_hªdË
) {

624 
hªdË
->
»£t__timeout
();

625 
	gloİ
 = 0;

627 ià(
	gi
->
	g£cÚd
.
is_d–‘e
())

630 autØ
	gp
 = 
missšg_loc
.
fšd
(
i
->
fœ¡
);

631 ià(
	gp
 =ğ
missšg_loc
.
’d
()) {

632 
p
 = 
missšg_loc
.
em¶aû
(
i
->
fœ¡
, 
£t
<
pg_sh¬d_t
>()).
	gfœ¡
;

634 
_dec_couÁ
(
p
->
£cÚd
);

636 
	gmissšg_loc
[
i
->
fœ¡
].
š£¹
(
sourûs
.
begš
(), sourûs.
’d
());

637 
_šc_couÁ
(
p
->
£cÚd
);

639 ià(!
	gsourûs_upd©ed
) {

640 
	gmissšg_loc_sourûs
.
š£¹
(
sourûs
.
begš
(), sourûs.
’d
());

641 
	gsourûs_upd©ed
 = 
Œue
;

646 
boŞ
 
	gPG
::
MissšgLoc
::
	$add_sourû_šfo
(

647 
pg_sh¬d_t
 
äomosd
,

648 cÚ¡ 
pg_šfo_t
 &
ošfo
,

649 cÚ¡ 
pg_missšg_t
 &
omissšg
,

650 
Th»adPoŞ
::
TPHªdË
* 
hªdË
)

652 
boŞ
 
found_missšg
 = 
çl£
;

653 
loİ
 = 0;

654 
boŞ
 
sourûs_upd©ed
 = 
çl£
;

656 
m­
<
hobjeù_t
,
pg_missšg_™em
>::
cÚ¡_™”©Ü
 
p
 = 
Ãeds_»cov”y_m­
.
	`begš
();

657 
p
 !ğ
Ãeds_»cov”y_m­
.
	`’d
();

658 ++
p
) {

659 cÚ¡ 
hobjeù_t
 &
	`soid
(
p
->
fœ¡
);

660 
ev”siÚ_t
 
Ãed
 = 
p
->
£cÚd
.need;

661 ià(
hªdË
 && ++
loİ
 >ğ
pg
->
cù
->
_cÚf
->
osd_loİ_befÜe_»£t_hªdË
) {

662 
hªdË
->
	`»£t__timeout
();

663 
loİ
 = 0;

665 ià(
p
->
£cÚd
.
	`is_d–‘e
()) {

666 
	`ldout
(
pg
->
cù
, 10è<< 
__func__
 << " " << 
soid


667 << " d–‘e, ignÜšg sourû" << 
d’dl
;

668 
found_missšg
 = 
Œue
;

671 ià(
ošfo
.
Ï¡_upd©e
 < 
Ãed
) {

672 
	`ldout
(
pg
->
cù
, 10è<< "£¬ch_fÜ_missšg " << 
soid
 << " " << 
Ãed


673 << "‡lsØmissšg oÀosd." << 
äomosd


674 << " (Ï¡_upd©" << 
ošfo
.
Ï¡_upd©e


675 << " <‚“ded " << 
Ãed
 << ")" << 
d’dl
;

678 ià(!
ošfo
.
Ï¡_backfl
.
	`is_max
() &&

679 !
ošfo
.
Ï¡_backfl_b™wi£
) {

680 
	`ldout
(
pg
->
cù
, 10è<< "£¬ch_fÜ_missšg " << 
soid
 << " " << 
Ãed


681 << "‡lsØmissšg oÀosd." << 
äomosd


682 << " (Ï¡_backfÈ" << 
ošfo
.
Ï¡_backfl


684 << 
d’dl
;

687 ià(
p
->
fœ¡
 >ğ
ošfo
.
Ï¡_backfl
) {

690 
	`ldout
(
pg
->
cù
, 10è<< "£¬ch_fÜ_missšg " << 
soid
 << " " << 
Ãed


691 << "‡lsØmissšg oÀosd." << 
äomosd


692 << " (·¡†a¡_backfÈ" << 
ošfo
.
Ï¡_backfl


693 << ")" << 
d’dl
;

696 ià(
ošfo
.
Ï¡_com¶‘e
 < 
Ãed
) {

697 ià(
omissšg
.
	`is_missšg
(
soid
)) {

698 
	`ldout
(
pg
->
cù
, 10è<< "£¬ch_fÜ_missšg " << 
soid
 << " " << 
Ãed


699 << "‡lsØmissšg oÀosd." << 
äomosd
 << 
d’dl
;

704 
	`ldout
(
pg
->
cù
, 10è<< "£¬ch_fÜ_missšg " << 
soid
 << " " << 
Ãed


705 << " i Ú osd." << 
äomosd
 << 
d’dl
;

708 autØ
p
 = 
missšg_loc
.
	`fšd
(
soid
);

709 ià(
p
 =ğ
missšg_loc
.
	`’d
()) {

710 
p
 = 
missšg_loc
.
	`em¶aû
(
soid
, 
£t
<
pg_sh¬d_t
>()).
fœ¡
;

712 
	`_dec_couÁ
(
p
->
£cÚd
);

714 
p
->
£cÚd
.
	`š£¹
(
äomosd
);

715 
	`_šc_couÁ
(
p
->
£cÚd
);

718 ià(!
sourûs_upd©ed
) {

719 
missšg_loc_sourûs
.
	`š£¹
(
äomosd
);

720 
sourûs_upd©ed
 = 
Œue
;

722 
found_missšg
 = 
Œue
;

725 
	`ldout
(
pg
->
cù
, 20è<< "Ãeds_»cov”y_m­ missšg " << 
Ãeds_»cov”y_m­


726 << 
d’dl
;

727  
found_missšg
;

728 
	}
}

730 
	gPG
::
MissšgLoc
::
	$check_»cov”y_sourûs
(cÚ¡ 
OSDM­Ref
& 
osdm­
)

732 
£t
<
pg_sh¬d_t
> 
now_down
;

733 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
p
 = 
missšg_loc_sourûs
.
	`begš
();

734 
p
 !ğ
missšg_loc_sourûs
.
	`’d
();

736 ià(
osdm­
->
	`is_up
(
p
->
osd
)) {

737 ++
p
;

740 
	`ldout
(
pg
->
cù
, 10è<< 
__func__
 << " sourû osd." << *
p
 << "‚ow down" << 
d’dl
;

741 
now_down
.
	`š£¹
(*
p
);

742 
missšg_loc_sourûs
.
	`”a£
(
p
++);

745 ià(
now_down
.
	`em±y
()) {

746 
	`ldout
(
pg
->
cù
, 10è<< 
__func__
 << "‚Øsourû osd (" << 
missšg_loc_sourûs
 << "èw’ˆdown" << 
d’dl
;

748 
	`ldout
(
pg
->
cù
, 10è<< 
__func__
 << " sourû osd " << 
now_down
 << "‚ow down,„emaining sources‡re "

749 << 
missšg_loc_sourûs
 << 
d’dl
;

752 
m­
<
hobjeù_t
, 
£t
<
pg_sh¬d_t
>>::
™”©Ü
 
p
 = 
missšg_loc
.
	`begš
();

753 
p
 !ğ
missšg_loc
.
	`’d
()) {

754 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
q
 = 
p
->
£cÚd
.
	`begš
();

755 
boŞ
 
chªged
 = 
çl£
;

756 
q
 !ğ
p
->
£cÚd
.
	`’d
()) {

757 ià(
now_down
.
	`couÁ
(*
q
)) {

758 ià(!
chªged
) {

759 
chªged
 = 
Œue
;

760 
	`_dec_couÁ
(
p
->
£cÚd
);

762 
p
->
£cÚd
.
	`”a£
(
q
++);

764 ++
q
;

767 ià(
p
->
£cÚd
.
	`em±y
()) {

768 
missšg_loc
.
	`”a£
(
p
++);

770 ià(
chªged
) {

771 
	`_šc_couÁ
(
p
->
£cÚd
);

773 ++
p
;

777 
	}
}

779 
	gPG
::
discov”_®l_missšg
(
m­
<, m­<
¥g_t
,
pg_qu”y_t
> > &
qu”y_m­
)

781 autØ&
	gmissšg
 = 
pg_log
.
g‘_missšg
();

782 
ušt64_t
 
	gunfound
 = 
g‘_num_unfound
();

784 
dout
(10è<< 
	g__func__
 << " "

785 << 
	gmissšg
.
num_missšg
() << " missing, "

786 << 
	gunfound
 << " unfound"

787 << 
	gd’dl
;

789 
	g¡d
::
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
m
 = 
might_have_unfound
.
begš
();

790 
	g¡d
::
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
m’d
 = 
might_have_unfound
.
’d
();

791 ; 
	gm
 !ğ
m’d
; ++m) {

792 
pg_sh¬d_t
 
³”
(*
m
);

794 ià(!
g‘_osdm­
()->
is_up
(
³”
.
osd
)) {

795 
dout
(20è<< 
	g__func__
 << " skpšg dowÀosd." << 
	g³”
 << 
	gd’dl
;

799 
	gm­
<
	gpg_sh¬d_t
, 
	gpg_šfo_t
>::
cÚ¡_™”©Ü
 
™”
 = 
³”_šfo
.
fšd
(
³”
);

800 ià(
	g™”
 !ğ
³”_šfo
.
’d
() &&

801 (
™”
->
£cÚd
.
is_em±y
(è|| i‹r->£cÚd.
dÃ
())) {

809 ià(
	g³”_missšg
.
fšd
(
³”
è!ğ
³”_missšg
.
’d
()) {

810 
dout
(20è<< 
__func__
 << ": osd." << 
³”


811 << ": w®»ady havpg_missšg_t" << 
d’dl
;

814 ià(
	g³”_log_»que¡ed
.
fšd
(
³”
è!ğ
³”_log_»que¡ed
.
’d
()) {

815 
dout
(20è<< 
__func__
 << ": osd." << 
³”


816 << ": iÀ³”_log_»que¡ed" << 
d’dl
;

819 ià(
	g³”_missšg_»que¡ed
.
fšd
(
³”
è!ğ
³”_missšg_»que¡ed
.
’d
()) {

820 
dout
(20è<< 
__func__
 << ": osd." << 
³”


821 << ": iÀ³”_missšg_»que¡ed" << 
d’dl
;

826 
dout
(10è<< 
	g__func__
 << ": osd." << 
	g³”
 << ":„equesting…g_missing_t"

827 << 
	gd’dl
;

828 
	g³”_missšg_»que¡ed
.
š£¹
(
³”
);

829 
	gqu”y_m­
[
³”
.
osd
][
¥g_t
(
šfo
.
pgid
.pgid,…“r.
sh¬d
)] =

830 
pg_qu”y_t
(

831 
pg_qu”y_t
::
FULLLOG
,

832 
³”
.
sh¬d
, 
pg_whßmi
.shard,

833 
šfo
.
hi¡Üy
, 
g‘_osdm­
()->
g‘_•och
());

838 
boŞ
 
	gPG
::
	$Ãeds_»cov”y
() const

840 
	`as£¹
(
	`is_´im¬y
());

842 autØ&
missšg
 = 
pg_log
.
	`g‘_missšg
();

844 ià(
missšg
.
	`num_missšg
()) {

845 
	`dout
(10è<< 
__func__
 << "…rim¬y ha " << 
missšg
.
	`num_missšg
()

846 << " missšg" << 
d’dl
;

847  
Œue
;

850 
	`as£¹
(!
aùšg_»cov”y_backfl
.
	`em±y
());

851 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
’d
 = 
aùšg_»cov”y_backfl
.
	`’d
();

852 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
a
 = 
aùšg_»cov”y_backfl
.
	`begš
();

853 ; 
a
 !ğ
’d
; ++a) {

854 ià(*
a
 =ğ
	`g‘_´im¬y
()) ;

855 
pg_sh¬d_t
 
³”
 = *
a
;

856 
m­
<
pg_sh¬d_t
, 
pg_missšg_t
>::
cÚ¡_™”©Ü
 
pm
 = 
³”_missšg
.
	`fšd
(
³”
);

857 ià(
pm
 =ğ
³”_missšg
.
	`’d
()) {

858 
	`dout
(10è<< 
__func__
 << " osd." << 
³”
 << " doesn't have missing set"

859 << 
d’dl
;

862 ià(
pm
->
£cÚd
.
	`num_missšg
()) {

863 
	`dout
(10è<< 
__func__
 << " osd." << 
³”
 << " has "

864 << 
pm
->
£cÚd
.
	`num_missšg
(è<< " missšg" << 
d’dl
;

865  
Œue
;

869 
	`dout
(10è<< 
__func__
 << " i »cov”ed" << 
d’dl
;

870  
çl£
;

871 
	}
}

873 
boŞ
 
	gPG
::
	$Ãeds_backfl
() const

875 
	`as£¹
(
	`is_´im¬y
());

879 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
’d
 = 
backfl_rg‘s
.
	`’d
();

880 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
a
 = 
backfl_rg‘s
.
	`begš
();

881 ; 
a
 !ğ
’d
; ++a) {

882 
pg_sh¬d_t
 
³”
 = *
a
;

883 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
>::
cÚ¡_™”©Ü
 
pi
 = 
³”_šfo
.
	`fšd
(
³”
);

884 ià(!
pi
->
£cÚd
.
Ï¡_backfl
.
	`is_max
()) {

885 
	`dout
(10è<< 
__func__
 << " osd." << 
³”
 << " ha Ï¡_backfÈ" << 
pi
->
£cÚd
.
Ï¡_backfl
 << 
d’dl
;

886  
Œue
;

890 
	`dout
(10è<< 
__func__
 << " dÛ nÙ‚“d backfl" << 
d’dl
;

891  
çl£
;

892 
	}
}

895 
	gPG
::
	$check_·¡_š‹rv®_bounds
() const

897 autØ
½ib
 = 
	`g‘_»quœed_·¡_š‹rv®_bounds
(

898 
šfo
,

899 
osd
->
	`g‘_su³rblock
().
Şde¡_m­
);

900 ià(
½ib
.
fœ¡
 >ğ½ib.
£cÚd
) {

901 ià(!
·¡_š‹rv®s
.
	`em±y
()) {

902 
osd
->
şog
->
	`”rÜ
(è<< 
šfo
.
pgid
 << "„equired…ast_interval bounds‡re"

903 << "ƒm±y [" << 
½ib
 << ") but…ast_intervals is‚ot: "

904 << 
·¡_š‹rv®s
;

905 
d”r
 << 
šfo
.
pgid
 << "„equired…ast_interval bounds‡re"

906 << "ƒm±y [" << 
½ib
 << ") but…ast_intervals is‚ot: "

907 << 
·¡_š‹rv®s
 << 
d’dl
;

910 ià(
·¡_š‹rv®s
.
	`em±y
()) {

911 
osd
->
şog
->
	`”rÜ
(è<< 
šfo
.
pgid
 << "„equired…ast_interval bounds‡re"

912 << "‚Ùƒm±y [" << 
½ib
 << ") but…ast_intervals "

913 << 
·¡_š‹rv®s
 << " isƒmpty";

914 
d”r
 << 
šfo
.
pgid
 << "„equired…ast_interval bounds‡re"

915 << "‚Ùƒm±y [" << 
½ib
 << ") but…ast_intervals "

916 << 
·¡_š‹rv®s
 << " i em±y" << 
d’dl
;

917 
	`as£¹
(!
·¡_š‹rv®s
.
	`em±y
());

920 autØ
­ib
 = 
·¡_š‹rv®s
.
	`g‘_bounds
();

921 ià(
­ib
.
fœ¡
 > 
½ib
.first) {

922 
osd
->
şog
->
	`”rÜ
(è<< 
šfo
.
pgid
 << "…a¡_š‹rv® [" << 
­ib


924 << " bound [" << 
½ib
 << ") start";

925 
d”r
 << 
šfo
.
pgid
 << "…a¡_š‹rv® [" << 
­ib


927 << " bound [" << 
½ib
 << "è¡¬t" << 
d’dl
;

928 
	`as£¹
(0 == "past_interval start interval mismatch");

930 ià(
­ib
.
£cÚd
 !ğ
½ib
.second) {

931 
osd
->
şog
->
	`”rÜ
(è<< 
šfo
.
pgid
 << "…a¡_š‹¿Èbound [" << 
­ib


932 << "è’d dÛ nÙ m©ch„equœed [" << 
½ib


934 
d”r
 << 
šfo
.
pgid
 << "…a¡_š‹¿Èbound [" << 
­ib


935 << "è’d dÛ nÙ m©ch„equœed [" << 
½ib


936 << "è’d" << 
d’dl
;

937 
	`as£¹
(0 == "past_intervalƒnd mismatch");

940 
	}
}

942 
boŞ
 
	gPG
::
	$adju¡_Ãed_up_thru
(cÚ¡ 
OSDM­Ref
 
osdm­
)

944 
•och_t
 
up_thru
 = 
osdm­
->
	`g‘_up_thru
(
osd
->
whßmi
);

945 ià(
Ãed_up_thru
 &&

946 
up_thru
 >ğ
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû
) {

947 
	`dout
(10è<< "adju¡_Ãed_up_thru‚ow " << 
up_thru
 << ",‚“d_up_thru‚ow f®£" << 
d’dl
;

948 
Ãed_up_thru
 = 
çl£
;

949  
Œue
;

951  
çl£
;

952 
	}
}

954 
	gPG
::
	$»move_down_³”_šfo
(cÚ¡ 
OSDM­Ref
 
osdm­
)

957 
boŞ
 
»moved
 = 
çl£
;

958 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
>::
™”©Ü
 
p
 = 
³”_šfo
.
	`begš
();

959 
p
 !ğ
³”_šfo
.
	`’d
()) {

960 ià(!
osdm­
->
	`is_up
(
p
->
fœ¡
.
osd
)) {

961 
	`dout
(10è<< " drİpšg dowÀosd." << 
p
->
fœ¡
 << " infØ" <<…->
£cÚd
 << 
d’dl
;

962 
³”_missšg
.
	`”a£
(
p
->
fœ¡
);

963 
³”_log_»que¡ed
.
	`”a£
(
p
->
fœ¡
);

964 
³”_missšg_»que¡ed
.
	`”a£
(
p
->
fœ¡
);

965 
³”_šfo
.
	`”a£
(
p
++);

966 
»moved
 = 
Œue
;

968 ++
p
;

972 ià(
»moved
)

973 
	`upd©e_h—¹b—t_³”s
();

974 
	`check_»cov”y_sourûs
(
osdm­
);

975 
	}
}

980 
boŞ
 
	gPG
::
	$®l_unfound_¬e_qu”›d_Ü_lo¡
(cÚ¡ 
OSDM­Ref
 
osdm­
) const

982 
	`as£¹
(
	`is_´im¬y
());

984 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
³”
 = 
might_have_unfound
.
	`begš
();

985 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
m’d
 = 
might_have_unfound
.
	`’d
();

986 ; 
³”
 !ğ
m’d
; ++peer) {

987 ià(
³”_missšg
.
	`couÁ
(*
³”
))

989 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
>::
cÚ¡_™”©Ü
 
™”
 = 
³”_šfo
.
	`fšd
(*
³”
);

990 ià(
™”
 !ğ
³”_šfo
.
	`’d
() &&

991 (
™”
->
£cÚd
.
	`is_em±y
(è|| i‹r->£cÚd.
	`dÃ
()))

993 ià(!
osdm­
->
	`exi¡s
(
³”
->
osd
))

995 cÚ¡ 
osd_šfo_t
 &
	`osd_šfo
(
osdm­
->
	`g‘_šfo
(
³”
->
osd
));

996 ià(
osd_šfo
.
lo¡_©
 <ğosd_šfo.
up_äom
) {

999  
çl£
;

1002 
	`dout
(10è<< "®l_unfound_¬e_qu”›d_Ü_lo¡‡Î oàmight_have_unfound " << 
might_have_unfound


1003 << " havb“Àqu”›d o¸¬m¬ked†o¡" << 
d’dl
;

1004  
Œue
;

1005 
	}
}

1007 
	gPa¡IÁ”v®s
::
PriÜS‘
 
PG
::
	$bud_´iÜ
()

1011 
m­
<
pg_sh¬d_t
,
pg_šfo_t
>::
™”©Ü
 
™
 = 
³”_šfo
.
	`begš
();

1012 
™
 !ğ
³”_šfo
.
	`’d
();

1013 ++
™
) {

1014 
	`as£¹
(
šfo
.
hi¡Üy
.
Ï¡_•och_¡¬‹d
 >ğ
™
->
£cÚd
.history.last_epoch_started);

1018 cÚ¡ 
OSDM­
 &
osdm­
 = *
	`g‘_osdm­
();

1019 
Pa¡IÁ”v®s
::
PriÜS‘
 
´iÜ
 = 
·¡_š‹rv®s
.
	`g‘_´iÜ_£t
(

1020 
poŞ
.
šfo
.
	`is_”asu»
(),

1021 
šfo
.
hi¡Üy
.
Ï¡_•och_¡¬‹d
,

1022 
	`g‘_pgback’d
()->
	`g‘_is_»cov”abË_´ediÿ‹
(),

1023 [&](
•och_t
 
¡¬t
, 
osd
,ƒpoch_ˆ*
lo¡_©
) {

1024 cÚ¡ 
osd_šfo_t
 *
pšfo
 = 0;

1025 ià(
osdm­
.
	`exi¡s
(
osd
)) {

1026 
pšfo
 = &
osdm­
.
	`g‘_šfo
(
osd
);

1027 ià(
lo¡_©
)

1028 *
lo¡_©
 = 
pšfo
->lost_at;

1031 ià(
osdm­
.
	`is_up
(
osd
)) {

1032  
Pa¡IÁ”v®s
::
UP
;

1033 } ià(!
pšfo
) {

1034  
Pa¡IÁ”v®s
::
DNE
;

1035 } ià(
pšfo
->
lo¡_©
 > 
¡¬t
) {

1036  
Pa¡IÁ”v®s
::
LOST
;

1038  
Pa¡IÁ”v®s
::
DOWN
;

1041 
up
,

1042 
aùšg
,

1043 
this
);

1045 ià(
´iÜ
.
pg_down
) {

1046 
	`¡©e_£t
(
PG_STATE_DOWN
);

1049 ià(
	`g‘_osdm­
()->
	`g‘_up_thru
(
osd
->
whßmi
è< 
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû
) {

1050 
	`dout
(10è<< "up_thru " << 
	`g‘_osdm­
()->
	`g‘_up_thru
(
osd
->
whßmi
)

1051 << " < same_sšû " << 
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû


1052 << ", mu¡‚Ùify mÚ™Ü" << 
d’dl
;

1053 
Ãed_up_thru
 = 
Œue
;

1055 
	`dout
(10è<< "up_thru " << 
	`g‘_osdm­
()->
	`g‘_up_thru
(
osd
->
whßmi
)

1056 << " >ğ§me_sšû " << 
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû


1057 << ",‡Î i w–l" << 
d’dl
;

1058 
Ãed_up_thru
 = 
çl£
;

1060 
	`£t_´obe_rg‘s
(
´iÜ
.
´obe
);

1061  
´iÜ
;

1062 
	}
}

1064 
	gPG
::
	$ş—r_´im¬y_¡©e
()

1066 
	`dout
(10è<< "ş—r_´im¬y_¡©e" << 
d’dl
;

1069 
¡¿y_£t
.
	`ş—r
();

1070 
³”_log_»que¡ed
.
	`ş—r
();

1071 
³”_missšg_»que¡ed
.
	`ş—r
();

1072 
³”_šfo
.
	`ş—r
();

1073 
³”_missšg
.
	`ş—r
();

1074 
Ãed_up_thru
 = 
çl£
;

1075 
³”_Ï¡_com¶‘e_Údisk
.
	`ş—r
();

1076 
³”_aùiv©ed
.
	`ş—r
();

1077 
mš_Ï¡_com¶‘e_Údisk
 = 
	`ev”siÚ_t
();

1078 
pg_Œim_to
 = 
	`ev”siÚ_t
();

1079 
might_have_unfound
.
	`ş—r
();

1080 
´ojeùed_log
 = 
PGLog
::
	`IndexedLog
();

1082 
Ï¡_upd©e_Údisk
 = 
	`ev”siÚ_t
();

1084 
¢­_Œimq
.
	`ş—r
();

1086 
fšish_sync_ev’t
 = 0;

1088 
missšg_loc
.
	`ş—r
();

1090 
	`»Ëa£_pg_backoffs
();

1092 
pg_log
.
	`»£t_»cov”y_poš‹rs
();

1094 
süubb”
.
»£rved_³”s
.
	`ş—r
();

1095 
süub_aá”_»cov”y
 = 
çl£
;

1097 
	`ag’t_ş—r
();

1098 
	}
}

1100 
	gPG
::
Süubb”
::
	$Süubb”
()

1101 : 
	`»£rved
(
çl£
), 
	`»£rve_çed
(false),

1102 
	`•och_¡¬t
(0),

1103 
	`aùive
(
çl£
),

1104 
	`sh®low_”rÜs
(0), 
	`d“p_”rÜs
(0), 
	`fixed
(0),

1105 
	`mu¡_süub
(
çl£
), 
	`mu¡_d“p_süub
(çl£), 
	`mu¡_»·œ
(false),

1106 
	`auto_»·œ
(
çl£
),

1107 
	`num_dige¡_upd©es_³ndšg
(0),

1108 
	`¡©e
(
INACTIVE
),

1109 
	$d“p
(
çl£
)

1110 {
	}
}

1112 
	gPG
::
Süubb”
::~
	$Süubb”
(è{
	}
}

1122 
m­
<
pg_sh¬d_t
, 
	gpg_šfo_t
>::
cÚ¡_™”©Ü
 
PG
::
fšd_be¡_šfo
(

1123 cÚ¡ 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
> &
šfos
,

1124 
boŞ
 
»¡riù_to_up_aùšg
,

1125 
boŞ
 *
hi¡Üy_Ës_bound
) const

1127 
as£¹
(
hi¡Üy_Ës_bound
);

1131 
ev”siÚ_t
 
	gmš_Ï¡_upd©e_acû±abË
 =ƒv”siÚ_t::
max
();

1132 
•och_t
 
	gmax_Ï¡_•och_¡¬‹d_found
 = 0;

1133 
	gm­
<
	gpg_sh¬d_t
, 
	gpg_šfo_t
>::
cÚ¡_™”©Ü
 
i
 = 
šfos
.
begš
();

1134 
	gi
 !ğ
šfos
.
’d
();

1135 ++
	gi
) {

1136 ià(!
	gcù
->
	g_cÚf
->
	gosd_fšd_be¡_šfo_ignÜe_hi¡Üy_Ës
 &&

1137 
	gmax_Ï¡_•och_¡¬‹d_found
 < 
	gi
->
	g£cÚd
.
	ghi¡Üy
.
	gÏ¡_•och_¡¬‹d
) {

1138 *
	ghi¡Üy_Ës_bound
 = 
Œue
;

1139 
	gmax_Ï¡_•och_¡¬‹d_found
 = 
i
->
£cÚd
.
hi¡Üy
.
Ï¡_•och_¡¬‹d
;

1141 ià(!
	gi
->
	g£cÚd
.
is_šcom¶‘e
() &&

1142 
	gmax_Ï¡_•och_¡¬‹d_found
 < 
	gi
->
	g£cÚd
.
	gÏ¡_•och_¡¬‹d
) {

1143 
	gmax_Ï¡_•och_¡¬‹d_found
 = 
i
->
£cÚd
.
Ï¡_•och_¡¬‹d
;

1146 
	gm­
<
	gpg_sh¬d_t
, 
	gpg_šfo_t
>::
cÚ¡_™”©Ü
 
i
 = 
šfos
.
begš
();

1147 
	gi
 !ğ
šfos
.
’d
();

1148 ++
	gi
) {

1149 ià(
	gmax_Ï¡_•och_¡¬‹d_found
 <ğ
i
->
£cÚd
.
Ï¡_•och_¡¬‹d
) {

1150 ià(
mš_Ï¡_upd©e_acû±abË
 > 
i
->
£cÚd
.
Ï¡_upd©e
)

1151 
mš_Ï¡_upd©e_acû±abË
 = 
i
->
£cÚd
.
Ï¡_upd©e
;

1154 ià(
	gmš_Ï¡_upd©e_acû±abË
 =ğ
ev”siÚ_t
::
max
())

1155  
šfos
.
’d
();

1157 
	gm­
<
	gpg_sh¬d_t
, 
	gpg_šfo_t
>::
cÚ¡_™”©Ü
 
be¡
 = 
šfos
.
’d
();

1162 
	gm­
<
	gpg_sh¬d_t
, 
	gpg_šfo_t
>::
cÚ¡_™”©Ü
 
p
 = 
šfos
.
begš
();

1163 
	gp
 !ğ
šfos
.
’d
();

1164 ++
	gp
) {

1165 ià(
	g»¡riù_to_up_aùšg
 && !
is_up
(
p
->
fœ¡
) &&

1166 !
is_aùšg
(
p
->
fœ¡
))

1169 ià(
	gp
->
	g£cÚd
.
	gÏ¡_upd©e
 < 
	gmš_Ï¡_upd©e_acû±abË
)

1172 ià(
	gp
->
	g£cÚd
.
	gÏ¡_•och_¡¬‹d
 < 
	gmax_Ï¡_•och_¡¬‹d_found
)

1175 ià(
	gp
->
	g£cÚd
.
is_šcom¶‘e
())

1177 ià(
	gbe¡
 =ğ
šfos
.
’d
()) {

1178 
be¡
 = 
p
;

1182 ià(
	gpoŞ
.
	gšfo
.
»quœe_rŞlback
()) {

1183 ià(
	gp
->
	g£cÚd
.
	gÏ¡_upd©e
 > 
	gbe¡
->second.last_update)

1185 ià(
	gp
->
	g£cÚd
.
	gÏ¡_upd©e
 < 
	gbe¡
->second.last_update) {

1186 
	gbe¡
 = 
p
;

1190 ià(
	gp
->
	g£cÚd
.
	gÏ¡_upd©e
 < 
	gbe¡
->second.last_update)

1192 ià(
	gp
->
	g£cÚd
.
	gÏ¡_upd©e
 > 
	gbe¡
->second.last_update) {

1193 
	gbe¡
 = 
p
;

1199 ià(
	gp
->
	g£cÚd
.
	glog_
 > 
	gbe¡
->second.log_tail) {

1201 } ià(
	gp
->
	g£cÚd
.
	glog_
 < 
	gbe¡
->second.log_tail) {

1202 
	gbe¡
 = 
p
;

1207 ià(
	gp
->
	gfœ¡
 =ğ
pg_whßmi
) {

1208 
dout
(10è<< "ÿlc_aùšg…»ã¸osd." << 
p
->
fœ¡


1209 << " beÿu£ iˆi cu¼’ˆ´im¬y" << 
d’dl
;

1210 
	gbe¡
 = 
p
;

1214  
	gbe¡
;

1217 
	gPG
::
ÿlc_ec_aùšg
(

1218 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
>::
cÚ¡_™”©Ü
 
auth_log_sh¬d
,

1219 
size
,

1220 cÚ¡ 
veùÜ
<> &
aùšg
,

1221 cÚ¡ 
veùÜ
<> &
up
,

1222 cÚ¡ 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
> &
®l_šfo
,

1223 
boŞ
 
»¡riù_to_up_aùšg
,

1224 
veùÜ
<> *
_wªt
,

1225 
£t
<
pg_sh¬d_t
> *
backfl
,

1226 
£t
<
pg_sh¬d_t
> *
aùšg_backfl
,

1227 
o¡»am
 &
ss
)

1229 
	gveùÜ
<> 
wªt
(
size
, 
CRUSH_ITEM_NONE
);

1230 
	gm­
<
	gsh¬d_id_t
, 
	g£t
<
	gpg_sh¬d_t
> > 
	g®l_šfo_by_sh¬d
;

1231 
	gm­
<
	gpg_sh¬d_t
, 
	gpg_šfo_t
>::
cÚ¡_™”©Ü
 
i
 = 
®l_šfo
.
begš
();

1232 
	gi
 !ğ
®l_šfo
.
’d
();

1233 ++
	gi
) {

1234 
	g®l_šfo_by_sh¬d
[
i
->
fœ¡
.
sh¬d
].
š£¹
(i->first);

1236 
ušt8_t
 
	gi
 = 0; i < 
	gwªt
.
size
(); ++i) {

1237 
	gss
 << "FÜ…os™iÚ " << ()
	gi
 << ": ";

1238 ià(
	gup
.
size
(è> ()
	gi
 && up[
i
] !ğ
CRUSH_ITEM_NONE
 &&

1239 !
®l_šfo
.
fšd
(
pg_sh¬d_t
(
up
[
i
], 
sh¬d_id_t
(i)))->
	g£cÚd
.
is_šcom¶‘e
() &&

1240 
	g®l_šfo
.
fšd
(
pg_sh¬d_t
(
up
[
i
], 
sh¬d_id_t
(i)))->
	g£cÚd
.
	gÏ¡_upd©e
 >=

1241 
auth_log_sh¬d
->
£cÚd
.
log_
) {

1242 
ss
 << " s–eùšg up[i]: " << 
pg_sh¬d_t
(
up
[
i
], 
sh¬d_id_t
(i)è<< 
¡d
::
’dl
;

1243 
	gwªt
[
i
] = 
up
[i];

1246 ià(
	gup
.
size
(è> ()
	gi
 && up[
i
] !ğ
CRUSH_ITEM_NONE
) {

1247 
ss
 << " backflšg up[i]: " << 
pg_sh¬d_t
(
up
[
i
], 
sh¬d_id_t
(i))

1249 
	gbackfl
->
š£¹
(
pg_sh¬d_t
(
up
[
i
], 
sh¬d_id_t
(i)));

1252 ià(
	gaùšg
.
size
(è> ()
	gi
 &&‡ùšg[
i
] !ğ
CRUSH_ITEM_NONE
 &&

1253 !
®l_šfo
.
fšd
(
pg_sh¬d_t
(
aùšg
[
i
], 
sh¬d_id_t
(i)))->
	g£cÚd
.
is_šcom¶‘e
() &&

1254 
	g®l_šfo
.
fšd
(
pg_sh¬d_t
(
aùšg
[
i
], 
sh¬d_id_t
(i)))->
	g£cÚd
.
	gÏ¡_upd©e
 >=

1255 
auth_log_sh¬d
->
£cÚd
.
log_
) {

1256 
ss
 << " s–eùšg‡ùšg[i]: " << 
pg_sh¬d_t
(
aùšg
[
i
], 
sh¬d_id_t
(i)è<< 
¡d
::
’dl
;

1257 
	gwªt
[
i
] = 
aùšg
[i];

1258 } ià(!
	g»¡riù_to_up_aùšg
) {

1259 
	g£t
<
	gpg_sh¬d_t
>::
™”©Ü
 
j
 = 
®l_šfo_by_sh¬d
[
sh¬d_id_t
(
i
)].
begš
();

1260 
	gj
 !ğ
®l_šfo_by_sh¬d
[
sh¬d_id_t
(
i
)].
’d
();

1261 ++
	gj
) {

1262 
as£¹
(
j
->
sh¬d
 =ğ
i
);

1263 ià(!
	g®l_šfo
.
fšd
(*
j
)->
	g£cÚd
.
is_šcom¶‘e
() &&

1264 
	g®l_šfo
.
fšd
(*
j
)->
	g£cÚd
.
	gÏ¡_upd©e
 >=

1265 
auth_log_sh¬d
->
£cÚd
.
log_
) {

1266 
ss
 << " s–eùšg sŒay: " << *
j
 << 
¡d
::
’dl
;

1267 
	gwªt
[
i
] = 
j
->
osd
;

1271 ià(
	gwªt
[
i
] =ğ
CRUSH_ITEM_NONE
)

1272 
ss
 << " faedØfÈpos™iÚ " << ()
i
 << 
¡d
::
’dl
;

1276 
ušt8_t
 
	gi
 = 0; i < 
	gwªt
.
size
(); ++i) {

1277 ià(
	gwªt
[
i
] !ğ
CRUSH_ITEM_NONE
) {

1278 
aùšg_backfl
->
š£¹
(
pg_sh¬d_t
(
wªt
[
i
], 
sh¬d_id_t
(i)));

1281 
	gaùšg_backfl
->
š£¹
(
backfl
->
begš
(), backfl->
’d
());

1282 
	g_wªt
->
sw­
(
wªt
);

1292 
	gPG
::
ÿlc_»¶iÿ‹d_aùšg
(

1293 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
>::
cÚ¡_™”©Ü
 
auth_log_sh¬d
,

1294 
size
,

1295 cÚ¡ 
veùÜ
<> &
aùšg
,

1296 cÚ¡ 
veùÜ
<> &
up
,

1297 
pg_sh¬d_t
 
up_´im¬y
,

1298 cÚ¡ 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
> &
®l_šfo
,

1299 
boŞ
 
»¡riù_to_up_aùšg
,

1300 
veùÜ
<> *
wªt
,

1301 
£t
<
pg_sh¬d_t
> *
backfl
,

1302 
£t
<
pg_sh¬d_t
> *
aùšg_backfl
,

1303 
o¡»am
 &
ss
)

1305 
pg_sh¬d_t
 
	gauth_log_sh¬d_id
 = 
auth_log_sh¬d
->
fœ¡
;

1307 
	gss
 << 
	g__func__
 << "‚ewe¡ upd©Ú osd." << 
	gauth_log_sh¬d_id


1308 << " w™h " << 
	gauth_log_sh¬d
->
	g£cÚd


1309 << (
	g»¡riù_to_up_aùšg
 ? "„e¡riù_to_up_aùšg" : ""è<< 
¡d
::
’dl
;

1312 
	gm­
<
	gpg_sh¬d_t
,
	gpg_šfo_t
>::
cÚ¡_™”©Ü
 
´im¬y
 = 
®l_šfo
.
fšd
(
up_´im¬y
);

1313 ià(
	gup
.
size
() &&

1314 !
	g´im¬y
->
	g£cÚd
.
is_šcom¶‘e
() &&

1315 
	g´im¬y
->
	g£cÚd
.
	gÏ¡_upd©e
 >=

1316 
auth_log_sh¬d
->
£cÚd
.
log_
) {

1317 
ss
 << "up_´im¬y: " << 
up_´im¬y
 << "è£Ëùed‡ ´im¬y" << 
¡d
::
’dl
;

1319 
as£¹
(!
auth_log_sh¬d
->
£cÚd
.
is_šcom¶‘e
());

1320 
	gss
 << "up[0]‚“d backfl, osd." << 
	gauth_log_sh¬d_id


1321 << " s–eùed‡ ´im¬y in¡—d" << 
	g¡d
::
’dl
;

1322 
	g´im¬y
 = 
auth_log_sh¬d
;

1325 
	gss
 << 
	g__func__
 << "…rim¬y i osd." << 
	g´im¬y
->
	gfœ¡


1326 << " w™h " << 
	g´im¬y
->
	g£cÚd
 << 
	g¡d
::
’dl
;

1327 
	gwªt
->
push_back
(
´im¬y
->
fœ¡
.
osd
);

1328 
	gaùšg_backfl
->
š£¹
(
´im¬y
->
fœ¡
);

1329 
	gu§bË
 = 1;

1333 
ev”siÚ_t
 
	gŞde¡_auth_log_’Œy
 =

1334 
¡d
::
mš
(
´im¬y
->
£cÚd
.
log_
, 
auth_log_sh¬d
->second.log_tail);

1335 
	gveùÜ
<>::
cÚ¡_™”©Ü
 
i
 = 
up
.
begš
();

1336 
	gi
 !ğ
up
.
’d
();

1337 ++
	gi
) {

1338 
pg_sh¬d_t
 
	gup_ÿnd
 =…g_sh¬d_t(*
i
, 
sh¬d_id_t
::
NO_SHARD
);

1339 ià(
	gup_ÿnd
 =ğ
´im¬y
->
fœ¡
)

1341 cÚ¡ 
	gpg_šfo_t
 &
	gcur_šfo
 = 
®l_šfo
.
fšd
(
up_ÿnd
)->
£cÚd
;

1342 ià(
	gcur_šfo
.
is_šcom¶‘e
() ||

1343 
	gcur_šfo
.
	gÏ¡_upd©e
 < 
	gŞde¡_auth_log_’Œy
) {

1349 
	gss
 << " sh¬d " << 
	gup_ÿnd
 << " (upèbackfÈ" << 
	gcur_šfo
 << 
	g¡d
::
’dl
;

1350 
	gbackfl
->
š£¹
(
up_ÿnd
);

1351 
	gaùšg_backfl
->
š£¹
(
up_ÿnd
);

1353 
	gwªt
->
push_back
(*
i
);

1354 
	gaùšg_backfl
->
š£¹
(
up_ÿnd
);

1355 
	gu§bË
++;

1356 
	gss
 << " osd." << *
	gi
 << " (upèacû±ed " << 
	gcur_šfo
 << 
	g¡d
::
’dl
;

1360 ià(
	gu§bË
 >ğ
size
) {

1364 
	g¡d
::
veùÜ
<
¡d
::
·œ
<
ev”siÚ_t
, >> 
	gÿndid©e_by_Ï¡_upd©e
;

1365 
	gÿndid©e_by_Ï¡_upd©e
.
»£rve
(
aùšg
.
size
());

1367 
	gveùÜ
<>::
cÚ¡_™”©Ü
 
i
 = 
aùšg
.
begš
();

1368 
	gi
 !ğ
aùšg
.
’d
();

1369 ++
	gi
) {

1370 
pg_sh¬d_t
 
aùšg_ÿnd
(*
i
, 
sh¬d_id_t
::
NO_SHARD
);

1372 ià(
	gaùšg_ÿnd
 =ğ
´im¬y
->
fœ¡
)

1374 
	gveùÜ
<>::
cÚ¡_™”©Ü
 
up_™
 = 
fšd
(
up
.
begš
(), up.
’d
(), *
i
);

1375 ià(
	gup_™
 !ğ
up
.
’d
())

1378 cÚ¡ 
	gpg_šfo_t
 &
	gcur_šfo
 = 
®l_šfo
.
fšd
(
aùšg_ÿnd
)->
£cÚd
;

1379 ià(
	gcur_šfo
.
is_šcom¶‘e
() ||

1380 
	gcur_šfo
.
	gÏ¡_upd©e
 < 
	gŞde¡_auth_log_’Œy
) {

1381 
	gss
 << " sh¬d " << 
	gaùšg_ÿnd
 << " (acting) REJECTED "

1382 << 
	gcur_šfo
 << 
	g¡d
::
’dl
;

1384 
	gÿndid©e_by_Ï¡_upd©e
.
push_back
(
make_·œ
(
cur_šfo
.
Ï¡_upd©e
, *
i
));

1389 
	g¡d
::
sÜt
(
ÿndid©e_by_Ï¡_upd©e
.
begš
(), cªdid©e_by_Ï¡_upd©e.
’d
(),

1390 [](cÚ¡ 
¡d
::
·œ
<
ev”siÚ_t
, > &
lhs
,

1391 cÚ¡ 
¡d
::
·œ
<
ev”siÚ_t
, > &
rhs
) {

1392  
lhs
.
fœ¡
 > 
rhs
.first;

1396 autØ&
	gp
: 
ÿndid©e_by_Ï¡_upd©e
) {

1397 
as£¹
(
u§bË
 < 
size
);

1398 
	gwªt
->
push_back
(
p
.
£cÚd
);

1399 
pg_sh¬d_t
 
	gs
 =…g_sh¬d_t(
p
.
£cÚd
, 
sh¬d_id_t
::
NO_SHARD
);

1400 
	gaùšg_backfl
->
š£¹
(
s
);

1401 
	gss
 << " sh¬d " << 
	gs
 << " (acting)‡ccepted "

1402 << 
	g®l_šfo
.
fšd
(
s
)->
	g£cÚd
 << 
	g¡d
::
’dl
;

1403 
	gu§bË
++;

1404 ià(
	gu§bË
 >ğ
size
) {

1409 ià(
	g»¡riù_to_up_aùšg
) {

1412 
	gÿndid©e_by_Ï¡_upd©e
.
ş—r
();

1413 
	gÿndid©e_by_Ï¡_upd©e
.
»£rve
(
®l_šfo
.
size
());

1414 
	gm­
<
	gpg_sh¬d_t
,
	gpg_šfo_t
>::
cÚ¡_™”©Ü
 
i
 = 
®l_šfo
.
begš
();

1415 
	gi
 !ğ
®l_šfo
.
’d
();

1416 ++
	gi
) {

1418 ià(
	gi
->
	gfœ¡
 =ğ
´im¬y
->
fœ¡
)

1420 
	gveùÜ
<>::
cÚ¡_™”©Ü
 
up_™
 = 
fšd
(
up
.
begš
(), up.
’d
(), 
i
->
fœ¡
.
osd
);

1421 ià(
	gup_™
 !ğ
up
.
’d
())

1423 
	gveùÜ
<>::
cÚ¡_™”©Ü
 
aùšg_™
 = 
fšd
(

1424 
aùšg
.
begš
(),‡ùšg.
’d
(), 
i
->
fœ¡
.
osd
);

1425 ià(
	gaùšg_™
 !ğ
aùšg
.
’d
())

1428 ià(
	gi
->
	g£cÚd
.
is_šcom¶‘e
() ||

1429 
	gi
->
	g£cÚd
.
	gÏ¡_upd©e
 < 
	gŞde¡_auth_log_’Œy
) {

1430 
	gss
 << " sh¬d " << 
	gi
->
	gfœ¡
 << " (stray) REJECTED "

1431 << 
	gi
->
	g£cÚd
 << 
	g¡d
::
’dl
;

1433 
	gÿndid©e_by_Ï¡_upd©e
.
push_back
(

1434 
make_·œ
(
i
->
£cÚd
.
Ï¡_upd©e
, i->
fœ¡
.
osd
));

1438 ià(
	gÿndid©e_by_Ï¡_upd©e
.
em±y
()) {

1444 
	g¡d
::
sÜt
(
ÿndid©e_by_Ï¡_upd©e
.
begš
(), cªdid©e_by_Ï¡_upd©e.
’d
(),

1445 [](cÚ¡ 
¡d
::
·œ
<
ev”siÚ_t
, > &
lhs
,

1446 cÚ¡ 
¡d
::
·œ
<
ev”siÚ_t
, > &
rhs
) {

1447  
lhs
.
fœ¡
 > 
rhs
.first;

1451 autØ&
	gp
: 
ÿndid©e_by_Ï¡_upd©e
) {

1452 
as£¹
(
u§bË
 < 
size
);

1453 
	gwªt
->
push_back
(
p
.
£cÚd
);

1454 
pg_sh¬d_t
 
	gs
 =…g_sh¬d_t(
p
.
£cÚd
, 
sh¬d_id_t
::
NO_SHARD
);

1455 
	gaùšg_backfl
->
š£¹
(
s
);

1456 
	gss
 << " sh¬d " << 
	gs
 << " (stray)‡ccepted "

1457 << 
	g®l_šfo
.
fšd
(
s
)->
	g£cÚd
 << 
	g¡d
::
’dl
;

1458 
	gu§bË
++;

1459 ià(
	gu§bË
 >ğ
size
) {

1465 
boŞ
 
	gPG
::
»cov”abË_ªd_ge_mš_size
(cÚ¡ 
veùÜ
<> &
wªt
) const

1467 
num_wªt_aùšg
 = 0;

1468 
	g£t
<
	gpg_sh¬d_t
> 
	ghave
;

1469 
	gi
 = 0; i < ()
	gwªt
.
size
(); ++i) {

1470 ià(
	gwªt
[
i
] !ğ
CRUSH_ITEM_NONE
) {

1471 ++
num_wªt_aùšg
;

1472 
	ghave
.
š£¹
(

1473 
pg_sh¬d_t
(

1474 
wªt
[
i
],

1475 
poŞ
.
šfo
.
is_”asu»
(è? 
sh¬d_id_t
(
i
è: sh¬d_id_t::
NO_SHARD
));

1481 ià(
	gnum_wªt_aùšg
 < 
	gpoŞ
.
	gšfo
.
	gmš_size
 &&

1482 (
	gpoŞ
.
	gšfo
.
is_”asu»
() ||

1483 !
	gcù
->
	g_cÚf
->
	gosd_®low_»cov”y_b–ow_mš_size
)) {

1484 
dout
(10è<< 
	g__func__
 << " faed, b–ow mš size" << 
	gd’dl
;

1485  
	gçl£
;

1489 
	gboo¡
::
scİed_±r
<
IsPGRecov”abËP»diÿ‹
> 
»cov”abË_´ediÿ‹
(

1490 
g‘_pgback’d
()->
g‘_is_»cov”abË_´ediÿ‹
());

1491 ià(!(*
	g»cov”abË_´ediÿ‹
)(
	ghave
)) {

1492 
dout
(10è<< 
	g__func__
 << " faed,‚Ù„ecov”abË" << 
	gd’dl
;

1493  
	gçl£
;

1496  
	gŒue
;

1499 
	gPG
::
choo£_async_»cov”y_ec
(cÚ¡ 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
> &
®l_šfo
,

1500 cÚ¡ 
pg_šfo_t
 &
auth_šfo
,

1501 
veùÜ
<> *
wªt
,

1502 
£t
<
pg_sh¬d_t
> *
async_»cov”y
) const

1504 
	g£t
<
	g·œ
<, 
	gpg_sh¬d_t
> > 
	gÿndid©es_by_co¡
;

1505 
ušt8_t
 
	gi
 = 0; i < 
	gwªt
->
size
(); ++i) {

1506 ià((*
	gwªt
)[
i
] =ğ
CRUSH_ITEM_NONE
)

1512 
pg_sh¬d_t
 
sh¬d_i
((*
wªt
)[
i
], 
sh¬d_id_t
(i));

1513 autØ
	gsh¬d_šfo
 = 
®l_šfo
.
fšd
(
sh¬d_i
)->
£cÚd
;

1518 
v”siÚ_t
 
	gauth_v”siÚ
 = 
auth_šfo
.
Ï¡_upd©e
.
v”siÚ
;

1519 
v”siÚ_t
 
	gÿndid©e_v”siÚ
 = 
sh¬d_šfo
.
Ï¡_upd©e
.
v”siÚ
;

1520 ià(
	gauth_v”siÚ
 > 
	gÿndid©e_v”siÚ
 &&

1521 (
	gauth_v”siÚ
 - 
	gÿndid©e_v”siÚ
è> 
	gcù
->
	g_cÚf
->
	gg‘_v®
<
	gušt64_t
>("osd_async_recovery_min_pg_log_entries")) {

1522 
	gÿndid©es_by_co¡
.
š£¹
(
make_·œ
(
auth_v”siÚ
 - 
ÿndid©e_v”siÚ
, 
sh¬d_i
));

1526 
dout
(20è<< 
	g__func__
 << " cªdid©e by co¡‡»: " << 
	gÿndid©es_by_co¡


1527 << 
	gd’dl
;

1530 autØ
	gr™
 = 
ÿndid©es_by_co¡
.
rbegš
();

1531 
	gr™
 !ğ
ÿndid©es_by_co¡
.
»nd
(); ++rit) {

1532 
pg_sh¬d_t
 
	gcur_sh¬d
 = 
r™
->
£cÚd
;

1533 
	gveùÜ
<> 
ÿndid©e_wªt
(*
wªt
);

1534 
	gÿndid©e_wªt
[
cur_sh¬d
.
sh¬d
.
id
] = 
CRUSH_ITEM_NONE
;

1535 ià(
»cov”abË_ªd_ge_mš_size
(
ÿndid©e_wªt
)) {

1536 
	gwªt
->
sw­
(
ÿndid©e_wªt
);

1537 
	gasync_»cov”y
->
š£¹
(
cur_sh¬d
);

1540 
dout
(20è<< 
	g__func__
 << "„esuÉ wªt=" << *
	gwªt


1541 << "‡sync_»cov”y=" << *
	gasync_»cov”y
 << 
	gd’dl
;

1544 
	gPG
::
choo£_async_»cov”y_»¶iÿ‹d
(cÚ¡ 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
> &
®l_šfo
,

1545 cÚ¡ 
pg_šfo_t
 &
auth_šfo
,

1546 
veùÜ
<> *
wªt
,

1547 
£t
<
pg_sh¬d_t
> *
async_»cov”y
) const

1549 
	g£t
<
	g·œ
<, 
	gpg_sh¬d_t
> > 
	gÿndid©es_by_co¡
;

1550 autØ
	gosd_num
 : *
wªt
) {

1551 
pg_sh¬d_t
 
sh¬d_i
(
osd_num
, 
sh¬d_id_t
::
NO_SHARD
);

1552 autØ
	gsh¬d_šfo
 = 
®l_šfo
.
fšd
(
sh¬d_i
)->
£cÚd
;

1555 
v”siÚ_t
 
	gauth_v”siÚ
 = 
auth_šfo
.
Ï¡_upd©e
.
v”siÚ
;

1556 
v”siÚ_t
 
	gÿndid©e_v”siÚ
 = 
sh¬d_šfo
.
Ï¡_upd©e
.
v”siÚ
;

1557 
size_t
 
	g­´ox_’Œ›s
;

1558 ià(
	gauth_v”siÚ
 > 
	gÿndid©e_v”siÚ
) {

1559 
	g­´ox_’Œ›s
 = 
auth_v”siÚ
 - 
ÿndid©e_v”siÚ
;

1561 
	g­´ox_’Œ›s
 = 
ÿndid©e_v”siÚ
 - 
auth_v”siÚ
;

1563 ià(
	g­´ox_’Œ›s
 > 
	gcù
->
	g_cÚf
->
	gg‘_v®
<
	gušt64_t
>("osd_async_recovery_min_pg_log_entries")) {

1564 
	gÿndid©es_by_co¡
.
š£¹
(
make_·œ
(
­´ox_’Œ›s
, 
sh¬d_i
));

1568 
dout
(20è<< 
	g__func__
 << " cªdid©e by co¡‡»: " << 
	gÿndid©es_by_co¡


1569 << 
	gd’dl
;

1571 autØ
	gr™
 = 
ÿndid©es_by_co¡
.
rbegš
();

1572 
	gr™
 !ğ
ÿndid©es_by_co¡
.
»nd
(); ++rit) {

1573 ià(
	gwªt
->
size
(è<ğ
poŞ
.
šfo
.
mš_size
) {

1576 
pg_sh¬d_t
 
	gcur_sh¬d
 = 
r™
->
£cÚd
;

1577 
	gveùÜ
<> 
ÿndid©e_wªt
(*
wªt
);

1578 autØ
	g™
 = 
ÿndid©e_wªt
.
begš
(); iˆ!ğÿndid©e_wªt.
’d
(); ++it) {

1579 ià(*
	g™
 =ğ
cur_sh¬d
.
osd
) {

1580 
ÿndid©e_wªt
.
”a£
(
™
);

1581 
	gwªt
->
sw­
(
ÿndid©e_wªt
);

1582 
	gasync_»cov”y
->
š£¹
(
cur_sh¬d
);

1587 
dout
(20è<< 
	g__func__
 << "„esuÉ wªt=" << *
	gwªt


1588 << "‡sync_»cov”y=" << *
	gasync_»cov”y
 << 
	gd’dl
;

1606 
boŞ
 
	gPG
::
	$choo£_aùšg
(
pg_sh¬d_t
 &
auth_log_sh¬d_id
,

1607 
boŞ
 
»¡riù_to_up_aùšg
,

1608 
boŞ
 *
hi¡Üy_Ës_bound
)

1610 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
> 
	`®l_šfo
(
³”_šfo
.
	`begš
(),…“r_šfo.
	`’d
());

1611 
®l_šfo
[
pg_whßmi
] = 
šfo
;

1613 ià(
cù
->
_cÚf
->
subsys
.
should_g©h”
<
dout_subsys
, 10>()) {

1614 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
>::
™”©Ü
 
p
 = 
®l_šfo
.
	`begš
();

1615 
p
 !ğ
®l_šfo
.
	`’d
();

1616 ++
p
) {

1617 
	`dout
(10è<< 
__func__
 << "‡Î_šfØosd." << 
p
->
fœ¡
 << " " <<…->
£cÚd
 << 
d’dl
;

1621 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
>::
cÚ¡_™”©Ü
 
auth_log_sh¬d
 =

1622 
	`fšd_be¡_šfo
(
®l_šfo
, 
»¡riù_to_up_aùšg
, 
hi¡Üy_Ës_bound
);

1624 ià(
auth_log_sh¬d
 =ğ
®l_šfo
.
	`’d
()) {

1625 ià(
up
 !ğ
aùšg
) {

1626 
	`dout
(10è<< 
__func__
 << "‚o suitable info found (incomplete backfills?),"

1627 << "„ev”tšgØup" << 
d’dl
;

1628 
wªt_aùšg
 = 
up
;

1629 
veùÜ
<> 
em±y
;

1630 
osd
->
	`queue_wªt_pg_‹mp
(
šfo
.
pgid
.pgid, 
em±y
);

1632 
	`dout
(10è<< 
__func__
 << " faed" << 
d’dl
;

1633 
	`as£¹
(
wªt_aùšg
.
	`em±y
());

1635  
çl£
;

1638 
	`as£¹
(!
auth_log_sh¬d
->
£cÚd
.
	`is_šcom¶‘e
());

1639 
auth_log_sh¬d_id
 = 
auth_log_sh¬d
->
fœ¡
;

1641 
£t
<
pg_sh¬d_t
> 
wªt_backfl
, 
wªt_aùšg_backfl
;

1642 
veùÜ
<> 
wªt
;

1643 
¡ršg¡»am
 
ss
;

1644 ià(!
poŞ
.
šfo
.
	`is_”asu»
())

1645 
	`ÿlc_»¶iÿ‹d_aùšg
(

1646 
auth_log_sh¬d
,

1647 
	`g‘_osdm­
()->
	`g‘_pg_size
(
šfo
.
pgid
.pgid),

1648 
aùšg
,

1649 
up
,

1650 
up_´im¬y
,

1651 
®l_šfo
,

1652 
»¡riù_to_up_aùšg
,

1653 &
wªt
,

1654 &
wªt_backfl
,

1655 &
wªt_aùšg_backfl
,

1656 
ss
);

1658 
	`ÿlc_ec_aùšg
(

1659 
auth_log_sh¬d
,

1660 
	`g‘_osdm­
()->
	`g‘_pg_size
(
šfo
.
pgid
.pgid),

1661 
aùšg
,

1662 
up
,

1663 
®l_šfo
,

1664 
»¡riù_to_up_aùšg
,

1665 &
wªt
,

1666 &
wªt_backfl
,

1667 &
wªt_aùšg_backfl
,

1668 
ss
);

1669 
	`dout
(10è<< 
ss
.
	`¡r
(è<< 
d’dl
;

1671 ià(!
	`»cov”abË_ªd_ge_mš_size
(
wªt
)) {

1672 
wªt_aùšg
.
	`ş—r
();

1673  
çl£
;

1676 
£t
<
pg_sh¬d_t
> 
wªt_async_»cov”y
;

1677 ià(
	`HAVE_FEATURE
(
	`g‘_osdm­
()->
	`g‘_up_osd_ã©u»s
(), 
SERVER_MIMIC
)) {

1678 ià(
poŞ
.
šfo
.
	`is_”asu»
()) {

1679 
	`choo£_async_»cov”y_ec
(
®l_šfo
, 
auth_log_sh¬d
->
£cÚd
, &
wªt
, &
wªt_async_»cov”y
);

1681 
	`choo£_async_»cov”y_»¶iÿ‹d
(
®l_šfo
, 
auth_log_sh¬d
->
£cÚd
, &
wªt
, &
wªt_async_»cov”y
);

1684 ià(
wªt
 !ğ
aùšg
) {

1685 
	`dout
(10è<< 
__func__
 << " wªˆ" << 
wªt
 << " !ğaùšg " << 
aùšg


1686 << ",„eque¡šg…g_‹m°chªge" << 
d’dl
;

1687 
wªt_aùšg
 = 
wªt
;

1689 ià(
wªt_aùšg
 =ğ
up
) {

1692 
	`as£¹
(
wªt_backfl
.
	`em±y
());

1693 
veùÜ
<> 
em±y
;

1694 
osd
->
	`queue_wªt_pg_‹mp
(
šfo
.
pgid
.pgid, 
em±y
);

1696 
osd
->
	`queue_wªt_pg_‹mp
(
šfo
.
pgid
.pgid, 
wªt
);

1697  
çl£
;

1699 
wªt_aùšg
.
	`ş—r
();

1700 
aùšg_»cov”y_backfl
 = 
wªt_aùšg_backfl
;

1701 
	`dout
(10è<< "aùšg_»cov”y_backfÈi " << 
aùšg_»cov”y_backfl
 << 
d’dl
;

1702 
	`as£¹
(
backfl_rg‘s
.
	`em±y
(è|| backfl_rg‘ =ğ
wªt_backfl
);

1703 ià(
backfl_rg‘s
.
	`em±y
()) {

1705 
backfl_rg‘s
 = 
wªt_backfl
;

1708 
	`as£¹
(
async_»cov”y_rg‘s
.
	`em±y
(è||‡sync_»cov”y_rg‘ =ğ
wªt_async_»cov”y
 || !
	`Ãeds_»cov”y
());

1709 ià(
async_»cov”y_rg‘s
.
	`em±y
(è|| !
	`Ãeds_»cov”y
()) {

1710 
async_»cov”y_rg‘s
 = 
wªt_async_»cov”y
;

1714 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
wªt_backfl
.
	`begš
();

1715 
i
 !ğ
wªt_backfl
.
	`’d
();

1716 ++
i
) {

1717 
	`as£¹
(
¡¿y_£t
.
	`fšd
(*
i
è=ğ¡¿y_£t.
	`’d
());

1719 
	`dout
(10è<< "choo£_aùšg wªt=" << 
wªt
 << " backfill_targets="

1720 << 
wªt_backfl
 << "‡sync_recovery_targets="

1721 << 
async_»cov”y_rg‘s
 << 
d’dl
;

1722  
Œue
;

1723 
	}
}

1733 
	gPG
::
	$bud_might_have_unfound
()

1735 
	`as£¹
(
might_have_unfound
.
	`em±y
());

1736 
	`as£¹
(
	`is_´im¬y
());

1738 
	`dout
(10è<< 
__func__
 << 
d’dl
;

1740 
	`check_·¡_š‹rv®_bounds
();

1742 
might_have_unfound
 = 
·¡_š‹rv®s
.
	`g‘_might_have_unfound
(

1743 
pg_whßmi
,

1744 
poŞ
.
šfo
.
	`is_”asu»
());

1747 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
>::
™”©Ü
 
p
 = 
³”_šfo
.
	`begš
();

1748 
p
 !ğ
³”_šfo
.
	`’d
();

1749 ++
p
)

1750 
might_have_unfound
.
	`š£¹
(
p
->
fœ¡
);

1752 
	`dout
(15è<< 
__func__
 << ": buˆ" << 
might_have_unfound
 << 
d’dl
;

1753 
	}
}

1755 
	gPG
::
aùiv©e
(
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
,

1756 
•och_t
 
aùiv©iÚ_•och
,

1757 
m­
<, m­<
¥g_t
,
pg_qu”y_t
> >& 
qu”y_m­
,

1758 
m­
<,

1759 
veùÜ
<

1760 
·œ
<
pg_nÙify_t
,

1761 
Pa¡IÁ”v®s
> > > *
aùiv©Ü_m­
,

1762 
Recov”yCtx
 *
ùx
)

1764 
as£¹
(!
is_³”ed
());

1765 
as£¹
(
süubb”
.
ÿÎbacks
.
em±y
());

1766 
as£¹
(
ÿÎbacks_fÜ_deg¿ded_objeù
.
em±y
());

1769 
¡©e_ş—r
(
PG_STATE_DOWN
);

1771 
	g£nd_nÙify
 = 
çl£
;

1773 ià(
is_´im¬y
()) {

1775 ià(
	gaùšg
.
size
(è>ğ
poŞ
.
šfo
.
mš_size
) {

1776 
as£¹
(
cù
->
_cÚf
->
osd_fšd_be¡_šfo_ignÜe_hi¡Üy_Ës
 ||

1777 
šfo
.
Ï¡_•och_¡¬‹d
 <ğ
aùiv©iÚ_•och
);

1778 
	gšfo
.
	gÏ¡_•och_¡¬‹d
 = 
aùiv©iÚ_•och
;

1779 
	gšfo
.
	gÏ¡_š‹rv®_¡¬‹d
 = 
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû
;

1781 } ià(
is_aùšg
(
pg_whßmi
)) {

1785 ià(
	gšfo
.
	gÏ¡_•och_¡¬‹d
 < 
	gaùiv©iÚ_•och
) {

1786 
	gšfo
.
	gÏ¡_•och_¡¬‹d
 = 
aùiv©iÚ_•och
;

1787 
	gšfo
.
	gÏ¡_š‹rv®_¡¬‹d
 = 
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû
;

1791 autØ&
	gmissšg
 = 
pg_log
.
g‘_missšg
();

1793 ià(
is_´im¬y
()) {

1794 
	gÏ¡_upd©e_Údisk
 = 
šfo
.
Ï¡_upd©e
;

1795 
	gmš_Ï¡_com¶‘e_Údisk
 = 
ev”siÚ_t
(0,0);

1797 
	gÏ¡_upd©e_­¶›d
 = 
šfo
.
Ï¡_upd©e
;

1798 
	gÏ¡_rŞlback_šfo_Œimmed_to_­¶›d
 = 
pg_log
.
g‘_ÿn_rŞlback_to
();

1800 
	gÃed_up_thru
 = 
çl£
;

1803 
	gdœty_šfo
 = 
Œue
;

1804 
	gdœty_big_šfo
 = 
Œue
;

1807 
	gt
.
»gi¡”_Ú_com¶‘e
(

1808 
Ãw
 
C_PG_Aùiv©eComm™‹d
(

1809 
this
,

1810 
g‘_osdm­
()->
g‘_•och
(),

1811 
aùiv©iÚ_•och
));

1813 ià(
is_´im¬y
()) {

1815 ià(
g‘_osdm­
()->
	g»quœe_osd_»Ëa£
 < 
	gCEPH_RELEASE_MIMIC
) {

1816 
dout
(20è<< "aùiv©-…urged_¢­ " << 
	gšfo
.
	gpurged_¢­s


1817 << " cached_»moved_¢­ " << 
	gpoŞ
.
	gÿched_»moved_¢­s


1818 << 
	gd’dl
;

1819 
	g¢­_Œimq
 = 
poŞ
.
ÿched_»moved_¢­s
;

1821 auto& 
	g»moved_¢­s_queue
 = 
g‘_osdm­
()->
g‘_»moved_¢­s_queue
();

1822 autØ
	gp
 = 
»moved_¢­s_queue
.
fšd
(
šfo
.
pgid
.pgid.
poŞ
());

1823 
	g¢­_Œimq
.
ş—r
();

1824 ià(
	gp
 !ğ
»moved_¢­s_queue
.
’d
()) {

1825 
dout
(20è<< "aùiv©-…urged_¢­ " << 
šfo
.
purged_¢­s


1826 << "„emoved_¢­ " << 
p
->
£cÚd


1827 << 
d’dl
;

1828 autØ
	gq
 : 
p
->
£cÚd
) {

1829 
¢­_Œimq
.
š£¹
(
q
.
fœ¡
, q.
£cÚd
);

1833 
	gš‹rv®_£t
<
	g¢­id_t
> 
	gpurged
;

1834 
	gpurged
.
š‹r£ùiÚ_of
(
¢­_Œimq
, 
šfo
.
purged_¢­s
);

1835 
	g¢­_Œimq
.
subŒaù
(
purged
);

1837 ià(
g‘_osdm­
()->
	g»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_MIMIC
) {

1842 
šfo
.
purged_¢­s
.
sw­
(
purged
);

1847 ià(
	gmissšg
.
num_missšg
() == 0) {

1848 
dout
(10è<< "aùiv©-‚Ømissšg, movšg†a¡_com¶‘" << 
šfo
.
Ï¡_com¶‘e


1849 << " -> " << 
šfo
.
Ï¡_upd©e
 << 
d’dl
;

1850 
	gšfo
.
	gÏ¡_com¶‘e
 = 
šfo
.
Ï¡_upd©e
;

1851 
	gpg_log
.
»£t_»cov”y_poš‹rs
();

1853 
dout
(10è<< "aùiv©-‚Ù com¶‘e, " << 
	gmissšg
 << 
	gd’dl
;

1854 
	gpg_log
.
aùiv©e_nÙ_com¶‘e
(
šfo
);

1857 
log_weœdÃss
();

1860 ià(
is_´im¬y
()) {

1861 
as£¹
(
ùx
);

1864 
as£¹
(!
aùšg_»cov”y_backfl
.
em±y
());

1865 
	g£t
<
	gpg_sh¬d_t
>::
™”©Ü
 
i
 = 
aùšg_»cov”y_backfl
.
begš
();

1866 
	gi
 !ğ
aùšg_»cov”y_backfl
.
’d
();

1867 ++
	gi
) {

1868 ià(*
	gi
 =ğ
pg_whßmi
) ;

1869 
pg_sh¬d_t
 
	g³”
 = *
i
;

1870 
as£¹
(
³”_šfo
.
couÁ
(
³”
));

1871 
	gpg_šfo_t
& 
	gpi
 = 
³”_šfo
[
³”
];

1873 
dout
(10è<< "aùiv©³” osd." << 
	g³”
 << " " << 
	gpi
 << 
	gd’dl
;

1875 
MOSDPGLog
 *
	gm
 = 0;

1876 
as£¹
(
³”_missšg
.
couÁ
(
³”
));

1877 
	gpg_missšg_t
& 
	gpm
 = 
³”_missšg
[
³”
];

1879 
boŞ
 
	gÃeds_·¡_š‹rv®s
 = 
pi
.
dÃ
();

1885 
boŞ
 
	gfÜû_»¡¬t_backfl
 =

1886 !
pi
.
Ï¡_backfl
.
is_max
() &&

1887 !
pi
.
Ï¡_backfl_b™wi£
;

1889 ià(
	gpi
.
	gÏ¡_upd©e
 =ğ
šfo
.
Ï¡_upd©e
 && !
fÜû_»¡¬t_backfl
) {

1891 ià(!
pi
.
Ï¡_backfl
.
is_max
())

1892 
osd
->
şog
->
šfo
(è<< info.
pgid
 << " continuing backfillo osd."

1893 << 
³”


1894 << " from (" << 
pi
.
log_
 << "," <<…i.
Ï¡_upd©e


1895 << "] " << 
pi
.
Ï¡_backfl


1896 << "Ø" << 
šfo
.
Ï¡_upd©e
;

1897 ià(!
	gpi
.
is_em±y
(è&& 
	gaùiv©Ü_m­
) {

1898 
dout
(10è<< "aùiv©³” osd." << 
	g³”
 << " i u°tØd©e, queuešg iÀ³ndšg_aùiv©Üs" << 
	gd’dl
;

1899 (*
	gaùiv©Ü_m­
)[
³”
.
osd
].
push_back
(

1900 
make_·œ
(

1901 
pg_nÙify_t
(

1902 
³”
.
sh¬d
, 
pg_whßmi
.shard,

1903 
g‘_osdm­
()->
g‘_•och
(),

1904 
g‘_osdm­
()->
g‘_•och
(),

1905 
šfo
),

1906 
·¡_š‹rv®s
));

1908 
dout
(10è<< "aùiv©³” osd." << 
	g³”
 << " i u°tØd©e, buˆ£ndšg…g_log‡nyway" << 
	gd’dl
;

1909 
	gm
 = 
Ãw
 
MOSDPGLog
(

1910 
i
->
sh¬d
, 
pg_whßmi
.shard,

1911 
g‘_osdm­
()->
g‘_•och
(), 
šfo
);

1914 
	gpg_log
.
g‘_
(è> 
	gpi
.
	gÏ¡_upd©e
 ||

1915 
	gpi
.
	gÏ¡_backfl
 =ğ
hobjeù_t
() ||

1916 
fÜû_»¡¬t_backfl
 ||

1917 (
backfl_rg‘s
.
couÁ
(*
i
è&& 
pi
.
Ï¡_backfl
.
is_max
())) {

1926 
osd
->
şog
->
debug
(è<< 
šfo
.
pgid
 << " s¹šg backfÈtØosd." << 
³”


1927 << " from (" << 
pi
.
log_
 << "," <<…i.
Ï¡_upd©e


1928 << "] " << 
pi
.
Ï¡_backfl


1929 << "Ø" << 
šfo
.
Ï¡_upd©e
;

1931 
	gpi
.
	gÏ¡_upd©e
 = 
šfo
.
Ï¡_upd©e
;

1932 
	gpi
.
	gÏ¡_com¶‘e
 = 
šfo
.
Ï¡_upd©e
;

1933 
	gpi
.
£t_Ï¡_backfl
(
hobjeù_t
());

1934 
	gpi
.
	gÏ¡_•och_¡¬‹d
 = 
šfo
.
Ï¡_•och_¡¬‹d
;

1935 
	gpi
.
	gÏ¡_š‹rv®_¡¬‹d
 = 
šfo
.
Ï¡_š‹rv®_¡¬‹d
;

1936 
	gpi
.
	ghi¡Üy
 = 
šfo
.
hi¡Üy
;

1937 
	gpi
.
	gh™_£t
 = 
šfo
.
h™_£t
;

1938 
	gpi
.
	g¡©s
.¡©s.
ş—r
();

1941 
	gpi
.
	gpurged_¢­s
 = 
šfo
.
purged_¢­s
;

1943 
	gm
 = 
Ãw
 
MOSDPGLog
(

1944 
i
->
sh¬d
, 
pg_whßmi
.shard,

1945 
g‘_osdm­
()->
g‘_•och
(), 
pi
);

1948 
	gm
->
	glog
.
cİy_up_to
(
pg_log
.
g‘_log
(), 
cù
->
_cÚf
->
osd_mš_pg_log_’Œ›s
);

1949 
	gm
->
	gšfo
.
	glog_
 = 
m
->
log
.

;

1950 
	gpi
.
	glog_
 = 
m
->
log
.

;

1952 
	gpm
.
ş—r
();

1955 
as£¹
(
pg_log
.
g‘_
(è<ğ
pi
.
Ï¡_upd©e
);

1956 
	gm
 = 
Ãw
 
MOSDPGLog
(

1957 
i
->
sh¬d
, 
pg_whßmi
.shard,

1958 
g‘_osdm­
()->
g‘_•och
(), 
šfo
);

1960 
	gm
->
	glog
.
cİy_aá”
(
pg_log
.
g‘_log
(), 
pi
.
Ï¡_upd©e
);

1966 ià(
	gm
 && 
	gÃeds_·¡_š‹rv®s
)

1967 
	gm
->
	g·¡_š‹rv®s
 = 
·¡_š‹rv®s
;

1970 ià(
	gm
 && 
	gpi
.
	gÏ¡_backfl
 !ğ
hobjeù_t
()) {

1971 
li¡
<
pg_log_’Œy_t
>::
™”©Ü
 
p
 = 
m
->
log
.log.
begš
();

1972 
	gp
 !ğ
m
->
log
.log.
’d
();

1973 ++
	gp
) {

1974 ià(
	gp
->
	gsoid
 <ğ
pi
.
Ï¡_backfl
 &&

1975 !
p
->
is_”rÜ
()) {

1976 ià(
³rfÜm_d–‘es_duršg_³”šg
(è&& 
p
->
is_d–‘e
()) {

1977 
pm
.
rm
(
p
->
soid
,…->
v”siÚ
);

1979 
	gpm
.
add_Ãxt_ev’t
(*
p
);

1985 ià(
	gm
) {

1986 
dout
(10è<< "aùiv©³” osd." << 
	g³”
 << " s’dšg " << 
	gm
->
	glog
 << 
	gd’dl
;

1988 
	gosd
->
£nd_mes§ge_osd_şu¡”
(
³”
.
osd
, 
m
, 
g‘_osdm­
()->
g‘_•och
());

1992 
	gpi
.
	gÏ¡_upd©e
 = 
šfo
.
Ï¡_upd©e
;

1995 ià(
	gpm
.
num_missšg
() == 0) {

1996 
pi
.
Ï¡_com¶‘e
 =…i.
Ï¡_upd©e
;

1997 
dout
(10è<< "aùiv©³” osd." << 
	g³”
 << " " << 
	gpi
 << " u±od©e" << 
	gd’dl
;

1999 
dout
(10è<< "aùiv©³” osd." << 
	g³”
 << " " << 
	gpi
 << " missšg " << 
	gpm
 << 
	gd’dl
;

2004 
	g£t
<
	gpg_sh¬d_t
> 
	gcom¶‘e_sh¬ds
;

2005 
	g£t
<
	gpg_sh¬d_t
>::
™”©Ü
 
i
 = 
aùšg_»cov”y_backfl
.
begš
();

2006 
	gi
 !ğ
aùšg_»cov”y_backfl
.
’d
();

2007 ++
	gi
) {

2008 
dout
(20è<< 
	g__func__
 << " s‘tšg u°missšg_loøäom sh¬d " << *
	gi
 << " " << 
	gd’dl
;

2009 ià(*
	gi
 =ğ
g‘_´im¬y
()) {

2010 
missšg_loc
.
add_aùive_missšg
(
missšg
);

2011 ià(!
	gmissšg
.
have_missšg
())

2012 
	gcom¶‘e_sh¬ds
.
š£¹
(*
i
);

2014 autØ
	g³”_missšg_’Œy
 = 
³”_missšg
.
fšd
(*
i
);

2015 
as£¹
(
³”_missšg_’Œy
 !ğ
³”_missšg
.
’d
());

2016 
	gmissšg_loc
.
add_aùive_missšg
(
³”_missšg_’Œy
->
£cÚd
);

2017 ià(!
	g³”_missšg_’Œy
->
	g£cÚd
.
have_missšg
() &&

2018 
	g³”_šfo
[*
i
].
	gÏ¡_backfl
.
is_max
())

2019 
	gcom¶‘e_sh¬ds
.
š£¹
(*
i
);

2026 
	gmight_have_unfound
.
ş—r
();

2027 ià(
Ãeds_»cov”y
()) {

2032 ià(
	gcom¶‘e_sh¬ds
.
size
(è+ 1 =ğ
aùšg_»cov”y_backfl
.size()) {

2033 
missšg_loc
.
add_b©ch_sourûs_šfo
(
com¶‘e_sh¬ds
, 
ùx
->
hªdË
);

2035 
	gmissšg_loc
.
add_sourû_šfo
(
pg_whßmi
, 
šfo
, 
pg_log
.
g‘_missšg
(),

2036 
ùx
->
hªdË
);

2037 
	g£t
<
	gpg_sh¬d_t
>::
™”©Ü
 
i
 = 
aùšg_»cov”y_backfl
.
begš
();

2038 
	gi
 !ğ
aùšg_»cov”y_backfl
.
’d
();

2039 ++
	gi
) {

2040 ià(*
	gi
 =ğ
pg_whßmi
) ;

2041 
dout
(10è<< 
	g__func__
 << ":‡ddšg " << *
	gi
 << "‡ ¨sourû" << 
	gd’dl
;

2042 
as£¹
(
³”_missšg
.
couÁ
(*
i
));

2043 
as£¹
(
³”_šfo
.
couÁ
(*
i
));

2044 
	gmissšg_loc
.
add_sourû_šfo
(

2045 *
i
,

2046 
³”_šfo
[*
i
],

2047 
³”_missšg
[*
i
],

2048 
ùx
->
hªdË
);

2051 
	gm­
<
	gpg_sh¬d_t
, 
	gpg_missšg_t
>::
™”©Ü
 
i
 = 
³”_missšg
.
begš
();

2052 
	gi
 !ğ
³”_missšg
.
’d
();

2053 ++
	gi
) {

2054 ià(
is_aùšg_»cov”y_backfl
(
i
->
fœ¡
))

2056 
as£¹
(
³”_šfo
.
couÁ
(
i
->
fœ¡
));

2057 
£¬ch_fÜ_missšg
(

2058 
³”_šfo
[
i
->
fœ¡
],

2059 
i
->
£cÚd
,

2060 
i
->
fœ¡
,

2061 
ùx
);

2064 
bud_might_have_unfound
();

2067 
discov”_®l_missšg
(
qu”y_m­
);

2072 ià(
g‘_osdm­
()->
g‘_pg_size
(
šfo
.
pgid
.pgidè> 
	gaùšg£t
.
size
()) {

2073 
¡©e_£t
(
PG_STATE_UNDERSIZED
);

2076 
¡©e_£t
(
PG_STATE_ACTIVATING
);

2077 
»Ëa£_pg_backoffs
();

2078 
	g´ojeùed_Ï¡_upd©e
 = 
šfo
.
Ï¡_upd©e
;

2080 ià(
	gaùšg
.
size
(è>ğ
poŞ
.
šfo
.
mš_size
) {

2081 
PGLogEÁryHªdËr
 
hªdËr
{
this
, &
t
};

2082 
	gpg_log
.
rŞl_fÜw¬d
(&
hªdËr
);

2086 
boŞ
 
	gPG
::
	$İ_has_suffic›Á_ÿps
(
OpReque¡Ref
& 
İ
)

2089 ià(
İ
->
	`g‘_»q
()->
	`g‘_ty³
(è!ğ
CEPH_MSG_OSD_OP
)

2090  
Œue
;

2092 cÚ¡ 
MOSDOp
 *
»q
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDOp*>(
İ
->
	`g‘_»q
());

2094 
SessiÚ
 *
£ssiÚ
 = 
¡©ic_ÿ¡
<SessiÚ*>(
»q
->
	`g‘_cÚÃùiÚ
()->
	`g‘_´iv
());

2095 ià(!
£ssiÚ
) {

2096 
	`dout
(0è<< "İ_has_suffic›Á_ÿps:‚Ø£ssiÚ fÜ o°" << *
»q
 << 
d’dl
;

2097  
çl£
;

2099 
OSDC­
& 
ÿps
 = 
£ssiÚ
->caps;

2100 
£ssiÚ
->
	`put
();

2102 cÚ¡ 
¡ršg
 &
key
 = 
»q
->
	`g‘_hobj
().
	`g‘_key
().
	`em±y
() ?

2103 
»q
->
	`g‘_oid
().
Çme
 :

2104 
»q
->
	`g‘_hobj
().
	`g‘_key
();

2106 
boŞ
 
ÿp
 = 
ÿps
.
	`is_ÿ·bË
(
poŞ
.
Çme
, 
»q
->
	`g‘_hobj
().
n¥aû
,

2107 
poŞ
.
šfo
.
auid
,

2108 
poŞ
.
šfo
.
­¶iÿtiÚ_m‘ad©a
,

2109 
key
,

2110 
İ
->
	`Ãed_»ad_ÿp
(),

2111 
İ
->
	`Ãed_wr™e_ÿp
(),

2112 
İ
->
	`şas£s
());

2114 
	`dout
(20) << "op_has_sufficient_caps "

2115 << "£ssiÚ=" << 
£ssiÚ


2116 << "…oŞ=" << 
poŞ
.
id
 << " (" <<…oŞ.
Çme


2117 << " " << 
»q
->
	`g‘_hobj
().
n¥aû


2118 << "èowÃr=" << 
poŞ
.
šfo
.
auid


2119 << "…oŞ_­p_m‘ad©a=" << 
poŞ
.
šfo
.
­¶iÿtiÚ_m‘ad©a


2120 << "‚“d_»ad_ÿp=" << 
İ
->
	`Ãed_»ad_ÿp
()

2121 << "‚“d_wr™e_ÿp=" << 
İ
->
	`Ãed_wr™e_ÿp
()

2122 << " cÏs£s=" << 
İ
->
	`şas£s
()

2123 << " -> " << (
ÿp
 ? "yes" : "NO")

2124 << 
d’dl
;

2125  
ÿp
;

2126 
	}
}

2128 
	gPG
::
	$_aùiv©e_comm™‹d
(
•och_t
 
•och
,ƒpoch_ˆ
aùiv©iÚ_•och
)

2130 
	`lock
();

2131 ià(
	`pg_has_»£t_sšû
(
•och
)) {

2132 
	`dout
(10è<< "_aùiv©e_comm™‹d " << 
•och


2133 << ",h© wa ª old iÁ”v®" << 
d’dl
;

2134 } ià(
	`is_´im¬y
()) {

2135 
	`as£¹
(!
³”_aùiv©ed
.
	`couÁ
(
pg_whßmi
));

2136 
³”_aùiv©ed
.
	`š£¹
(
pg_whßmi
);

2137 
	`dout
(10è<< "_aùiv©e_comm™‹d " << 
•och


2138 << "…“r_aùiv©ed‚ow " << 
³”_aùiv©ed


2139 << "†a¡_š‹rv®_¡¬‹d " << 
šfo
.
hi¡Üy
.
Ï¡_š‹rv®_¡¬‹d


2140 << "†a¡_•och_¡¬‹d " << 
šfo
.
hi¡Üy
.
Ï¡_•och_¡¬‹d


2141 << " same_š‹rv®_sšû " << 
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû
 << 
d’dl
;

2142 
	`as£¹
(!
aùšg_»cov”y_backfl
.
	`em±y
());

2143 ià(
³”_aùiv©ed
.
	`size
(è=ğ
aùšg_»cov”y_backfl
.size())

2144 
	`®l_aùiv©ed_ªd_comm™‹d
();

2146 
	`dout
(10è<< "_aùiv©e_comm™‹d " << 
•och
 << "–lšg…rim¬y" << 
d’dl
;

2147 
MOSDPGInfo
 *
m
 = 
Ãw
 
	`MOSDPGInfo
(
•och
);

2148 
pg_nÙify_t
 
i
 = 
	`pg_nÙify_t
(

2149 
	`g‘_´im¬y
().
sh¬d
, 
pg_whßmi
.shard,

2150 
	`g‘_osdm­
()->
	`g‘_•och
(),

2151 
	`g‘_osdm­
()->
	`g‘_•och
(),

2152 
šfo
);

2154 
i
.
šfo
.
hi¡Üy
.
Ï¡_•och_¡¬‹d
 = 
aùiv©iÚ_•och
;

2155 
i
.
šfo
.
hi¡Üy
.
Ï¡_š‹rv®_¡¬‹d
 = i.šfo.hi¡Üy.
§me_š‹rv®_sšû
;

2156 ià(
aùšg
.
	`size
(è>ğ
poŞ
.
šfo
.
mš_size
) {

2157 
	`¡©e_£t
(
PG_STATE_ACTIVE
);

2159 
	`¡©e_£t
(
PG_STATE_PEERED
);

2162 
m
->
pg_li¡
.
	`push_back
(
	`make_·œ
(
i
, 
	`Pa¡IÁ”v®s
()));

2163 
osd
->
	`£nd_mes§ge_osd_şu¡”
(
	`g‘_´im¬y
().osd, 
m
, 
	`g‘_osdm­
()->
	`g‘_•och
());

2166 ià(
æushes_š_´og»ss
 == 0) {

2167 
	`»queue_İs
(
wa™šg_fÜ_³”ed
);

2168 } ià(!
wa™šg_fÜ_³”ed
.
	`em±y
()) {

2169 
	`dout
(10è<< 
__func__
 << " flushes in…rogress, moving "

2170 << 
wa™šg_fÜ_³”ed
.
	`size
() << " itemso waiting_for_flush"

2171 << 
d’dl
;

2172 
	`as£¹
(
wa™šg_fÜ_æush
.
	`em±y
());

2173 
wa™šg_fÜ_æush
.
	`sw­
(
wa™šg_fÜ_³”ed
);

2177 
	`as£¹
(!
dœty_šfo
);

2179 
	`uÆock
();

2180 
	}
}

2187 
	gPG
::
	$®l_aùiv©ed_ªd_comm™‹d
()

2189 
	`dout
(10è<< "®l_aùiv©ed_ªd_comm™‹d" << 
d’dl
;

2190 
	`as£¹
(
	`is_´im¬y
());

2191 
	`as£¹
(
³”_aùiv©ed
.
	`size
(è=ğ
aùšg_»cov”y_backfl
.size());

2192 
	`as£¹
(!
aùšg_»cov”y_backfl
.
	`em±y
());

2193 
	`as£¹
(
blocked_by
.
	`em±y
());

2196 
	`_upd©e_ÿlc_¡©s
();

2197 ià(
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs_deg¿ded
) {

2198 
	`¡©e_£t
(
PG_STATE_DEGRADED
);

2200 
	`¡©e_ş—r
(
PG_STATE_DEGRADED
);

2203 
	`queue_³”šg_ev’t
(

2204 
	`PGP“ršgEv’tRef
(

2205 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

2206 
	`g‘_osdm­
()->
	`g‘_•och
(),

2207 
	`g‘_osdm­
()->
	`g‘_•och
(),

2208 
	`AÎR•liÿsAùiv©ed
())));

2209 
	}
}

2211 
boŞ
 
	gPG
::
	$»queue_süub
(
boŞ
 
high_´iÜ™y
)

2213 
	`as£¹
(
	`is_locked
());

2214 ià(
süub_queued
) {

2215 
	`dout
(10è<< 
__func__
 << ":‡Ì—dy queued" << 
d’dl
;

2216  
çl£
;

2218 
	`dout
(10è<< 
__func__
 << ": queuešg" << 
d’dl
;

2219 
süub_queued
 = 
Œue
;

2220 
osd
->
	`queue_fÜ_süub
(
this
, 
high_´iÜ™y
);

2221  
Œue
;

2223 
	}
}

2225 
	gPG
::
	$queue_»cov”y
()

2227 ià(!
	`is_´im¬y
(è|| !
	`is_³”ed
()) {

2228 
	`dout
(10è<< "queue_»cov”y --‚Ù…rim¬y o¸nÙ…“»d " << 
d’dl
;

2229 
	`as£¹
(!
»cov”y_queued
);

2230 } ià(
»cov”y_queued
) {

2231 
	`dout
(10è<< "queue_»cov”y --‡Ì—dy queued" << 
d’dl
;

2233 
	`dout
(10è<< "queue_»cov”y -- queušg" << 
d’dl
;

2234 
»cov”y_queued
 = 
Œue
;

2235 
osd
->
	`queue_fÜ_»cov”y
(
this
);

2237 
	}
}

2239 
boŞ
 
	gPG
::
	$queue_süub
()

2241 
	`as£¹
(
	`is_locked
());

2242 ià(
	`is_süubbšg
()) {

2243  
çl£
;

2245 
süubb”
.
´iÜ™y
 = süubb”.
mu¡_süub
 ?

2246 
cù
->
_cÚf
->
osd_»que¡ed_süub_´iÜ™y
 : 
	`g‘_süub_´iÜ™y
();

2247 
süubb”
.
mu¡_süub
 = 
çl£
;

2248 
	`¡©e_£t
(
PG_STATE_SCRUBBING
);

2249 ià(
süubb”
.
mu¡_d“p_süub
) {

2250 
	`¡©e_£t
(
PG_STATE_DEEP_SCRUB
);

2251 
süubb”
.
mu¡_d“p_süub
 = 
çl£
;

2253 ià(
süubb”
.
mu¡_»·œ
 || süubb”.
auto_»·œ
) {

2254 
	`¡©e_£t
(
PG_STATE_REPAIR
);

2255 
süubb”
.
mu¡_»·œ
 = 
çl£
;

2257 
	`»queue_süub
();

2258  
Œue
;

2259 
	}
}

2261 
	gPG
::
	$g‘_süub_´iÜ™y
()

2264 
poŞ_süub_´iÜ™y
 = 0;

2265 
poŞ
.
šfo
.
İts
.
	`g‘
(
poŞ_İts_t
::
SCRUB_PRIORITY
, &
poŞ_süub_´iÜ™y
);

2266  
poŞ_süub_´iÜ™y
 > 0 ?…oŞ_süub_´iÜ™y : 
cù
->
_cÚf
->
osd_süub_´iÜ™y
;

2267 
	}
}

2269 
	gPG
::
	$m¬k_ş—n
()

2271 ià(
aùšg£t
.
	`size
(è=ğ
	`g‘_osdm­
()->
	`g‘_pg_size
(
šfo
.
pgid
.pgid)) {

2272 
	`¡©e_ş—r
(
PG_STATE_FORCED_BACKFILL
 | 
PG_STATE_FORCED_RECOVERY
);

2273 
	`¡©e_£t
(
PG_STATE_CLEAN
);

2274 
šfo
.
hi¡Üy
.
Ï¡_•och_ş—n
 = 
	`g‘_osdm­
()->
	`g‘_•och
();

2275 
šfo
.
hi¡Üy
.
Ï¡_š‹rv®_ş—n
 = info.hi¡Üy.
§me_š‹rv®_sšû
;

2276 
·¡_š‹rv®s
.
	`ş—r
();

2277 
dœty_big_šfo
 = 
Œue
;

2278 
dœty_šfo
 = 
Œue
;

2281 
	`kick_¢­_Œim
();

2282 
	}
}

2284 
boŞ
 
	gPG
::
	$£t_fÜû_»cov”y
(
boŞ
 
b
)

2286 
boŞ
 
did
 = 
çl£
;

2287 ià(
b
) {

2288 ià(!(
¡©e
 & 
PG_STATE_FORCED_RECOVERY
) &&

2289 (
¡©e
 & (
PG_STATE_DEGRADED
 |

2290 
PG_STATE_RECOVERY_WAIT
 |

2291 
PG_STATE_RECOVERING
))) {

2292 
	`dout
(20è<< 
__func__
 << " s‘" << 
d’dl
;

2293 
	`¡©e_£t
(
PG_STATE_FORCED_RECOVERY
);

2294 
	`publish_¡©s_to_osd
();

2295 
did
 = 
Œue
;

2297 } ià(
¡©e
 & 
PG_STATE_FORCED_RECOVERY
) {

2298 
	`dout
(20è<< 
__func__
 << " cË¬" << 
d’dl
;

2299 
	`¡©e_ş—r
(
PG_STATE_FORCED_RECOVERY
);

2300 
	`publish_¡©s_to_osd
();

2301 
did
 = 
Œue
;

2303  
did
;

2304 
	}
}

2306 
boŞ
 
	gPG
::
	$£t_fÜû_backfl
(
boŞ
 
b
)

2308 
boŞ
 
did
 = 
çl£
;

2309 ià(
b
) {

2310 ià(!(
¡©e
 & 
PG_STATE_FORCED_RECOVERY
) &&

2311 (
¡©e
 & (
PG_STATE_DEGRADED
 |

2312 
PG_STATE_BACKFILL_WAIT
 |

2313 
PG_STATE_BACKFILLING
))) {

2314 
	`dout
(10è<< 
__func__
 << " s‘" << 
d’dl
;

2315 
	`¡©e_£t
(
PG_STATE_FORCED_RECOVERY
);

2316 
	`publish_¡©s_to_osd
();

2317 
did
 = 
Œue
;

2319 } ià(
¡©e
 & 
PG_STATE_FORCED_RECOVERY
) {

2320 
	`dout
(10è<< 
__func__
 << " cË¬" << 
d’dl
;

2321 
	`¡©e_ş—r
(
PG_STATE_FORCED_RECOVERY
);

2322 
	`publish_¡©s_to_osd
();

2323 
did
 = 
Œue
;

2325  
did
;

2326 
	}
}

2328 
šlše
 
	gPG
::
	$şamp_»cov”y_´iÜ™y
(
´iÜ™y
)

2330 
	`¡©ic_as£¹
(
OSD_RECOVERY_PRIORITY_MIN
 < 
OSD_RECOVERY_PRIORITY_MAX
, "Invalid…riority„ange");

2331 
	`¡©ic_as£¹
(
OSD_RECOVERY_PRIORITY_MIN
 >= 0, "Priority„ange must match unsignedype");

2334 ià(
´iÜ™y
 > 
OSD_RECOVERY_PRIORITY_MAX
) {

2335  
OSD_RECOVERY_PRIORITY_MAX
;

2336 } ià(
´iÜ™y
 < 
OSD_RECOVERY_PRIORITY_MIN
) {

2337  
OSD_RECOVERY_PRIORITY_MIN
;

2339  
´iÜ™y
;

2341 
	}
}

2343 
	gPG
::
	$g‘_»cov”y_´iÜ™y
()

2346 
»t
 = 0;

2348 ià(
¡©e
 & 
PG_STATE_FORCED_RECOVERY
) {

2349 
»t
 = 
OSD_RECOVERY_PRIORITY_FORCED
;

2351 
poŞ
.
šfo
.
İts
.
	`g‘
(
poŞ_İts_t
::
RECOVERY_PRIORITY
, &
»t
);

2352 
»t
 = 
	`şamp_»cov”y_´iÜ™y
(
OSD_RECOVERY_PRIORITY_BASE
 +„et);

2354 
	`dout
(20è<< 
__func__
 << "„ecov”y…riÜ™y fÜ " << *
this
 << " i " << 
»t
 << ", s‹ i " << 
¡©e
 << 
d’dl
;

2355  
¡©ic_ÿ¡
<>(
»t
);

2356 
	}
}

2358 
	gPG
::
	$g‘_backfl_´iÜ™y
()

2361 
»t
 = 
OSD_BACKFILL_PRIORITY_BASE
;

2362 ià(
¡©e
 & 
PG_STATE_FORCED_BACKFILL
) {

2363 
»t
 = 
OSD_RECOVERY_PRIORITY_FORCED
;

2365 ià(
aùšg
.
	`size
(è< 
poŞ
.
šfo
.
mš_size
) {

2367 
»t
 = 
OSD_BACKFILL_INACTIVE_PRIORITY_BASE
 + (
poŞ
.
šfo
.
mš_size
 - 
aùšg
.
	`size
());

2369 } ià(
	`is_und”sized
()) {

2371 
	`as£¹
(
poŞ
.
šfo
.
size
 > 
aùšg£t
.
	`size
());

2372 
»t
 = 
OSD_BACKFILL_DEGRADED_PRIORITY_BASE
 + (
poŞ
.
šfo
.
size
 - 
aùšg£t
.
	`size
());

2374 } ià(
	`is_deg¿ded
()) {

2376 
»t
 = 
OSD_BACKFILL_DEGRADED_PRIORITY_BASE
;

2380 
poŞ_»cov”y_´iÜ™y
 = 0;

2381 
poŞ
.
šfo
.
İts
.
	`g‘
(
poŞ_İts_t
::
RECOVERY_PRIORITY
, &
poŞ_»cov”y_´iÜ™y
);

2383 
»t
 = 
	`şamp_»cov”y_´iÜ™y
(
poŞ_»cov”y_´iÜ™y
 +„et);

2386  
¡©ic_ÿ¡
<>(
»t
);

2387 
	}
}

2389 
	gPG
::
	$g‘_d–‘e_´iÜ™y
()

2391 autØ
¡©e
 = 
	`g‘_osdm­
()->
	`g‘_¡©e
(
osd
->
whßmi
);

2392 ià(
¡©e
 & (
CEPH_OSD_BACKFILLFULL
 |

2393 
CEPH_OSD_FULL
)) {

2394  
OSD_DELETE_PRIORITY_FULL
;

2395 } ià(
¡©e
 & 
CEPH_OSD_NEARFULL
) {

2396  
OSD_DELETE_PRIORITY_FULLISH
;

2398  
OSD_DELETE_PRIORITY_NORMAL
;

2400 
	}
}

2402 
CÚ‹xt
 *
	gPG
::
	$fšish_»cov”y
()

2404 
	`dout
(10è<< "fšish_»cov”y" << 
d’dl
;

2405 
	`as£¹
(
šfo
.
Ï¡_com¶‘e
 =ğšfo.
Ï¡_upd©e
);

2407 
	`ş—r_»cov”y_¡©e
();

2412 
fšish_sync_ev’t
 = 
Ãw
 
	`C_PG_FšishRecov”y
(
this
);

2413  
fšish_sync_ev’t
;

2414 
	}
}

2416 
	gPG
::
	$_fšish_»cov”y
(
CÚ‹xt
 *
c
)

2418 
	`lock
();

2419 ià(
d–‘šg
) {

2420 
	`uÆock
();

2423 ià(
c
 =ğ
fšish_sync_ev’t
) {

2424 
	`dout
(10è<< "_fšish_»cov”y" << 
d’dl
;

2425 
fšish_sync_ev’t
 = 0;

2426 
	`purge_¡¿ys
();

2428 
	`publish_¡©s_to_osd
();

2430 ià(
süub_aá”_»cov”y
) {

2431 
	`dout
(10è<< "_fšish_»cov”y„equeuešg fÜ süub" << 
d’dl
;

2432 
süub_aá”_»cov”y
 = 
çl£
;

2433 
süubb”
.
mu¡_d“p_süub
 = 
Œue
;

2434 
	`queue_süub
();

2437 
	`dout
(10è<< "_fšish_»cov”y -- sË" << 
d’dl
;

2439 
	`uÆock
();

2440 
	}
}

2442 
	gPG
::
	$¡¬t_»cov”y_İ
(cÚ¡ 
hobjeù_t
& 
soid
)

2444 
	`dout
(10è<< "¡¬t_»cov”y_İ " << 
soid


2445 #ifdeà
DEBUG_RECOVERY_OIDS


2446 << " (" << 
»cov”šg_oids
 << ")"

2448 << 
d’dl
;

2449 
	`as£¹
(
»cov”y_İs_aùive
 >= 0);

2450 
»cov”y_İs_aùive
++;

2451 #ifdeà
DEBUG_RECOVERY_OIDS


2452 
»cov”šg_oids
.
	`š£¹
(
soid
);

2454 
osd
->
	`¡¬t_»cov”y_İ
(
this
, 
soid
);

2455 
	}
}

2457 
	gPG
::
	$fšish_»cov”y_İ
(cÚ¡ 
hobjeù_t
& 
soid
, 
boŞ
 
dequeue
)

2459 
	`dout
(10è<< "fšish_»cov”y_İ " << 
soid


2460 #ifdeà
DEBUG_RECOVERY_OIDS


2461 << " (" << 
»cov”šg_oids
 << ")"

2463 << 
d’dl
;

2464 
	`as£¹
(
»cov”y_İs_aùive
 > 0);

2465 
»cov”y_İs_aùive
--;

2466 #ifdeà
DEBUG_RECOVERY_OIDS


2467 
	`as£¹
(
»cov”šg_oids
.
	`couÁ
(
soid
));

2468 
»cov”šg_oids
.
	`”a£
Ôecov”šg_oids.
	`fšd
(
soid
));

2470 
osd
->
	`fšish_»cov”y_İ
(
this
, 
soid
, 
dequeue
);

2472 ià(!
dequeue
) {

2473 
	`queue_»cov”y
();

2475 
	}
}

2477 
	gPG
::
	$¥l™_što
(
pg_t
 
chd_pgid
, 
PG
 *
chd
, 
¥l™_b™s
)

2479 
chd
->
	`upd©e_¢­_m­³r_b™s
(
¥l™_b™s
);

2480 
chd
->
	`upd©e_osdm­_»f
(
	`g‘_osdm­
());

2482 
chd
->
poŞ
 =…ool;

2485 
pg_log
.
	`¥l™_što
(
chd_pgid
, 
¥l™_b™s
, &(
chd
->pg_log));

2486 
chd
->
šfo
.
Ï¡_com¶‘e
 = info.last_complete;

2488 
šfo
.
Ï¡_upd©e
 = 
pg_log
.
	`g‘_h—d
();

2489 
chd
->
šfo
.
Ï¡_upd©e
 = chd->
pg_log
.
	`g‘_h—d
();

2491 
chd
->
šfo
.
Ï¡_u£r_v”siÚ
 = info.last_user_version;

2493 
šfo
.
log_
 = 
pg_log
.
	`g‘_
();

2494 
chd
->
šfo
.
log_
 = chd->
pg_log
.
	`g‘_
();

2496 ià(
šfo
.
Ï¡_com¶‘e
 < 
pg_log
.
	`g‘_
())

2497 
šfo
.
Ï¡_com¶‘e
 = 
pg_log
.
	`g‘_
();

2498 ià(
chd
->
šfo
.
Ï¡_com¶‘e
 < chd->
pg_log
.
	`g‘_
())

2499 
chd
->
šfo
.
Ï¡_com¶‘e
 = chd->
pg_log
.
	`g‘_
();

2502 
chd
->
šfo
.
hi¡Üy
 = info.history;

2503 
chd
->
šfo
.
hi¡Üy
.
•och_ü—‹d
 = 
	`g‘_osdm­
()->
	`g‘_•och
();

2504 
chd
->
šfo
.
purged_¢­s
 = info.purged_snaps;

2506 ià(
šfo
.
Ï¡_backfl
.
	`is_max
()) {

2507 
chd
->
šfo
.
	`£t_Ï¡_backfl
(
hobjeù_t
::
	`g‘_max
());

2513 
šfo
.
	`£t_Ï¡_backfl
(
	`hobjeù_t
());

2514 
chd
->
šfo
.
	`£t_Ï¡_backfl
(
	`hobjeù_t
());

2517 
pg_log
.
	`»£t_backfl
();

2518 
chd
->
pg_log
.
	`»£t_backfl
();

2521 
chd
->
šfo
.
¡©s
 = info.stats;

2522 
chd
->
šfo
.
¡©s
.
·»Á_¥l™_b™s
 = 
¥l™_b™s
;

2523 
šfo
.
¡©s
.
¡©s_šv®id
 = 
Œue
;

2524 
chd
->
šfo
.
¡©s
.
¡©s_šv®id
 = 
Œue
;

2525 
chd
->
šfo
.
Ï¡_•och_¡¬‹d
 = info.last_epoch_started;

2526 
chd
->
šfo
.
Ï¡_š‹rv®_¡¬‹d
 = info.last_interval_started;

2528 
chd
->
¢­_Œimq
 = snap_trimq;

2531 
´im¬y
, 
up_´im¬y
;

2532 
veùÜ
<> 
Ãwup
, 
Ãwaùšg
;

2533 
	`g‘_osdm­
()->
	`pg_to_up_aùšg_osds
(

2534 
chd
->
šfo
.
pgid
.pgid, &
Ãwup
, &
up_´im¬y
, &
Ãwaùšg
, &
´im¬y
);

2535 
chd
->
	`š™_´im¬y_up_aùšg
(

2536 
Ãwup
,

2537 
Ãwaùšg
,

2538 
up_´im¬y
,

2539 
´im¬y
);

2540 
chd
->
rŞe
 = 
OSDM­
::
	`ÿlc_pg_rŞe
(
osd
->
whßmi
, chd->
aùšg
);

2543 ià(
	`g‘_´im¬y
(è!ğ
chd
->get_primary())

2544 
chd
->
šfo
.
hi¡Üy
.
§me_´im¬y_sšû
 = 
	`g‘_osdm­
()->
	`g‘_•och
();

2546 
chd
->
šfo
.
¡©s
.
up
 = up;

2547 
chd
->
šfo
.
¡©s
.
up_´im¬y
 = up_primary;

2548 
chd
->
šfo
.
¡©s
.
aùšg
 =‡cting;

2549 
chd
->
šfo
.
¡©s
.
aùšg_´im¬y
 = 
´im¬y
;

2550 
chd
->
šfo
.
¡©s
.
m­pšg_•och
 = 
	`g‘_osdm­
()->
	`g‘_•och
();

2553 
chd
->
·¡_š‹rv®s
 =…ast_intervals;

2555 
	`_¥l™_što
(
chd_pgid
, 
chd
, 
¥l™_b™s
);

2558 
	`»Ëa£_backoffs
(
	`hobjeù_t
(), 
hobjeù_t
::
	`g‘_max
());

2560 
chd
->
	`Ú_Ãw_š‹rv®
();

2562 
chd
->
£nd_nÙify
 = !chd->
	`is_´im¬y
();

2564 
chd
->
dœty_šfo
 = 
Œue
;

2565 
chd
->
dœty_big_šfo
 = 
Œue
;

2566 
dœty_šfo
 = 
Œue
;

2567 
dœty_big_šfo
 = 
Œue
;

2568 
	}
}

2570 
	gPG
::
¡¬t_¥l™_¡©s
(cÚ¡ 
£t
<
¥g_t
>& 
chdpgs
, 
veùÜ
<
objeù_¡©_sum_t
> *
out
)

2572 
	gout
->
»size
(
chdpgs
.
size
() + 1);

2573 
	gšfo
.
	g¡©s
.¡©s.
	gsum
.
¥l™
(*
out
);

2576 
	gPG
::
	$fšish_¥l™_¡©s
(cÚ¡ 
objeù_¡©_sum_t
& 
¡©s
, 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

2578 
šfo
.
¡©s
.¡©s.
sum
 = stats;

2579 
	`wr™e_if_dœty
(*
t
);

2580 
	}
}

2582 
	gPG
::
	$add_backoff
(
SessiÚRef
 
s
, cÚ¡ 
hobjeù_t
& 
begš
, cÚ¡ hobjeù_t& 
’d
)

2584 
CÚÃùiÚRef
 
cÚ
 = 
s
->con;

2585 ià(!
cÚ
)

2587 
BackoffRef
 
	`b
(
s
->
	`have_backoff
(
šfo
.
pgid
, 
begš
));

2588 ià(
b
) {

2589 
d”r
 << 
__func__
 << "‡Ì—dy havbackofàfÜ " << 
s
 << " begš " << 
begš


2590 << " " << *
b
 << 
d’dl
;

2591 
	`ûph_abÜt
();

2593 
Mu‹x
::
Lock”
 
	`l
(
backoff_lock
);

2595 
b
 = 
Ãw
 
	`Backoff
(
šfo
.
pgid
, 
this
, 
s
, ++s->
backoff_£q
, 
begš
, 
’d
);

2596 
backoffs
[
begš
].
	`š£¹
(
b
);

2597 
s
->
	`add_backoff
(
b
);

2598 
	`dout
(10è<< 
__func__
 << " sessiÚ " << 
s
 << "‡dded " << *
b
 << 
d’dl
;

2600 
cÚ
->
	`£nd_mes§ge
(

2601 
Ãw
 
	`MOSDBackoff
(

2602 
šfo
.
pgid
,

2603 
	`g‘_osdm­
()->
	`g‘_•och
(),

2604 
CEPH_OSD_BACKOFF_OP_BLOCK
,

2605 
b
->
id
,

2606 
begš
,

2607 
’d
));

2608 
	}
}

2610 
	gPG
::
	$»Ëa£_backoffs
(cÚ¡ 
hobjeù_t
& 
begš
, cÚ¡ hobjeù_t& 
’d
)

2612 
	`dout
(10è<< 
__func__
 << " [" << 
begš
 << "," << 
’d
 << ")" << 
d’dl
;

2613 
veùÜ
<
BackoffRef
> 
bv
;

2615 
Mu‹x
::
Lock”
 
	`l
(
backoff_lock
);

2616 autØ
p
 = 
backoffs
.
	`low”_bound
(
begš
);

2617 
p
 !ğ
backoffs
.
	`’d
()) {

2618 
r
 = 
	`cmp
(
p
->
fœ¡
, 
’d
);

2619 
	`dout
(20è<< 
__func__
 << " ? " << 
r
 << " " << 
p
->
fœ¡


2620 << " " << 
p
->
£cÚd
 << 
d’dl
;

2622 ià(
r
 > 0 || (¸=ğ0 && 
begš
 < 
’d
)) {

2625 
	`dout
(20è<< 
__func__
 << " checkšg " << 
p
->
fœ¡


2626 << " " << 
p
->
£cÚd
 << 
d’dl
;

2627 autØ
q
 = 
p
->
£cÚd
.
	`begš
();

2628 
q
 !ğ
p
->
£cÚd
.
	`’d
()) {

2629 
	`dout
(20è<< 
__func__
 << " checkšg " << *
q
 << 
d’dl
;

2630 
r
 = 
	`cmp
((*
q
)->
begš
, begin);

2631 ià(
r
 =ğ0 || (¸> 0 && (*
q
)->
’d
 <ƒnd)) {

2632 
bv
.
	`push_back
(*
q
);

2633 
q
 = 
p
->
£cÚd
.
	`”a£
(q);

2635 ++
q
;

2638 ià(
p
->
£cÚd
.
	`em±y
()) {

2639 
p
 = 
backoffs
.
	`”a£
(p);

2641 ++
p
;

2645 autØ
b
 : 
bv
) {

2646 
Mu‹x
::
Lock”
 
	`l
(
b
->
lock
);

2647 
	`dout
(10è<< 
__func__
 << " " << *
b
 << 
d’dl
;

2648 ià(
b
->
£ssiÚ
) {

2649 
	`as£¹
(
b
->
pg
 =ğ
this
);

2650 
CÚÃùiÚRef
 
cÚ
 = 
b
->
£ssiÚ
->con;

2651 ià(
cÚ
) {

2652 
cÚ
->
	`£nd_mes§ge
(

2653 
Ãw
 
	`MOSDBackoff
(

2654 
šfo
.
pgid
,

2655 
	`g‘_osdm­
()->
	`g‘_•och
(),

2656 
CEPH_OSD_BACKOFF_OP_UNBLOCK
,

2657 
b
->
id
,

2658 
b
->
begš
,

2659 
b
->
’d
));

2661 ià(
b
->
	`is_Ãw
()) {

2662 
b
->
¡©e
 = 
Backoff
::
STATE_DELETING
;

2664 
b
->
£ssiÚ
->
	`rm_backoff
(b);

2665 
b
->
£ssiÚ
.
	`»£t
();

2667 
b
->
pg
.
	`»£t
();

2670 
	}
}

2672 
	gPG
::
	$ş—r_backoffs
()

2674 
	`dout
(10è<< 
__func__
 << " " << 
d’dl
;

2675 
m­
<
hobjeù_t
,
£t
<
BackoffRef
>> 
ls
;

2677 
Mu‹x
::
Lock”
 
	`l
(
backoff_lock
);

2678 
ls
.
	`sw­
(
backoffs
);

2680 auto& 
p
 : 
ls
) {

2681 auto& 
b
 : 
p
.
£cÚd
) {

2682 
Mu‹x
::
Lock”
 
	`l
(
b
->
lock
);

2683 
	`dout
(10è<< 
__func__
 << " " << *
b
 << 
d’dl
;

2684 ià(
b
->
£ssiÚ
) {

2685 
	`as£¹
(
b
->
pg
 =ğ
this
);

2686 ià(
b
->
	`is_Ãw
()) {

2687 
b
->
¡©e
 = 
Backoff
::
STATE_DELETING
;

2689 
b
->
£ssiÚ
->
	`rm_backoff
(b);

2690 
b
->
£ssiÚ
.
	`»£t
();

2692 
b
->
pg
.
	`»£t
();

2696 
	}
}

2699 
	gPG
::
	$rm_backoff
(
BackoffRef
 
b
)

2701 
	`dout
(10è<< 
__func__
 << " " << *
b
 << 
d’dl
;

2702 
Mu‹x
::
Lock”
 
	`l
(
backoff_lock
);

2703 
	`as£¹
(
b
->
lock
.
	`is_locked_by_me
());

2704 
	`as£¹
(
b
->
pg
 =ğ
this
);

2705 autØ
p
 = 
backoffs
.
	`fšd
(
b
->
begš
);

2707 ià(
p
 !ğ
backoffs
.
	`’d
()) {

2708 autØ
q
 = 
p
->
£cÚd
.
	`fšd
(
b
);

2709 ià(
q
 !ğ
p
->
£cÚd
.
	`’d
()) {

2710 
p
->
£cÚd
.
	`”a£
(
q
);

2711 ià(
p
->
£cÚd
.
	`em±y
()) {

2712 
backoffs
.
	`”a£
(
p
);

2716 
	}
}

2718 
	gPG
::
	$ş—r_»cov”y_¡©e
()

2720 
	`dout
(10è<< "ş—r_»cov”y_¡©e" << 
d’dl
;

2722 
pg_log
.
	`»£t_»cov”y_poš‹rs
();

2723 
fšish_sync_ev’t
 = 0;

2725 
hobjeù_t
 
soid
;

2726 
»cov”y_İs_aùive
 > 0) {

2727 #ifdeà
DEBUG_RECOVERY_OIDS


2728 
soid
 = *
»cov”šg_oids
.
	`begš
();

2730 
	`fšish_»cov”y_İ
(
soid
, 
Œue
);

2733 
async_»cov”y_rg‘s
.
	`ş—r
();

2734 
backfl_rg‘s
.
	`ş—r
();

2735 
backfl_šfo
.
	`ş—r
();

2736 
³”_backfl_šfo
.
	`ş—r
();

2737 
wa™šg_Ú_backfl
.
	`ş—r
();

2738 
	`_ş—r_»cov”y_¡©e
();

2739 
	}
}

2741 
	gPG
::
	$ÿnûl_»cov”y
()

2743 
	`dout
(10è<< "ÿnûl_»cov”y" << 
d’dl
;

2744 
	`ş—r_»cov”y_¡©e
();

2745 
	}
}

2748 
	gPG
::
	$purge_¡¿ys
()

2750 
	`dout
(10è<< "purge_¡¿y " << 
¡¿y_£t
 << 
d’dl
;

2752 
boŞ
 
»moved
 = 
çl£
;

2753 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
p
 = 
¡¿y_£t
.
	`begš
();

2754 
p
 !ğ
¡¿y_£t
.
	`’d
();

2755 ++
p
) {

2756 
	`as£¹
(!
	`is_aùšg_»cov”y_backfl
(*
p
));

2757 ià(
	`g‘_osdm­
()->
	`is_up
(
p
->
osd
)) {

2758 
	`dout
(10è<< "£ndšg PGRemovtØosd." << *
p
 << 
d’dl
;

2759 
veùÜ
<
¥g_t
> 
to_»move
;

2760 
to_»move
.
	`push_back
(
	`¥g_t
(
šfo
.
pgid
.pgid, 
p
->
sh¬d
));

2761 
MOSDPGRemove
 *
m
 = 
Ãw
 
	`MOSDPGRemove
(

2762 
	`g‘_osdm­
()->
	`g‘_•och
(),

2763 
to_»move
);

2764 
osd
->
	`£nd_mes§ge_osd_şu¡”
(
p
->osd, 
m
, 
	`g‘_osdm­
()->
	`g‘_•och
());

2766 
	`dout
(10è<< "nÙ s’dšg PGRemovtØdowÀosd." << *
p
 << 
d’dl
;

2768 
³”_missšg
.
	`”a£
(*
p
);

2769 
³”_šfo
.
	`”a£
(*
p
);

2770 
³”_purged
.
	`š£¹
(*
p
);

2771 
»moved
 = 
Œue
;

2775 ià(
»moved
)

2776 
	`upd©e_h—¹b—t_³”s
();

2778 
¡¿y_£t
.
	`ş—r
();

2782 
³”_log_»que¡ed
.
	`ş—r
();

2783 
³”_missšg_»que¡ed
.
	`ş—r
();

2784 
	}
}

2786 
	gPG
::
£t_´obe_rg‘s
(cÚ¡ 
£t
<
pg_sh¬d_t
> &
´obe_£t
)

2788 
Mu‹x
::
Lock”
 
l
(
h—¹b—t_³”_lock
);

2789 
	g´obe_rg‘s
.
ş—r
();

2790 
	g£t
<
	gpg_sh¬d_t
>::
™”©Ü
 
i
 = 
´obe_£t
.
begš
();

2791 
	gi
 !ğ
´obe_£t
.
’d
();

2792 ++
	gi
) {

2793 
	g´obe_rg‘s
.
š£¹
(
i
->
osd
);

2797 
	gPG
::
	$ş—r_´obe_rg‘s
()

2799 
Mu‹x
::
Lock”
 
	`l
(
h—¹b—t_³”_lock
);

2800 
´obe_rg‘s
.
	`ş—r
();

2801 
	}
}

2803 
	gPG
::
	$upd©e_h—¹b—t_³”s
()

2805 
	`as£¹
(
	`is_locked
());

2807 ià(!
	`is_´im¬y
())

2810 
£t
<> 
Ãw_³”s
;

2811 
i
=0; i<
aùšg
.
	`size
(); i++) {

2812 ià(
aùšg
[
i
] !ğ
CRUSH_ITEM_NONE
)

2813 
Ãw_³”s
.
	`š£¹
(
aùšg
[
i
]);

2815 
i
=0; i<
up
.
	`size
(); i++) {

2816 ià(
up
[
i
] !ğ
CRUSH_ITEM_NONE
)

2817 
Ãw_³”s
.
	`š£¹
(
up
[
i
]);

2819 
m­
<
pg_sh¬d_t
,
pg_šfo_t
>::
™”©Ü
 
p
 = 
³”_šfo
.
	`begš
();

2820 
p
 !ğ
³”_šfo
.
	`’d
();

2821 ++
p
)

2822 
Ãw_³”s
.
	`š£¹
(
p
->
fœ¡
.
osd
);

2824 
boŞ
 
Ãed_upd©e
 = 
çl£
;

2825 
h—¹b—t_³”_lock
.
	`Lock
();

2826 ià(
Ãw_³”s
 =ğ
h—¹b—t_³”s
) {

2827 
	`dout
(10è<< "upd©e_h—¹b—t_³” " << 
h—¹b—t_³”s
 << " unchªged" << 
d’dl
;

2829 
	`dout
(10è<< "upd©e_h—¹b—t_³” " << 
h—¹b—t_³”s
 << " -> " << 
Ãw_³”s
 << 
d’dl
;

2830 
h—¹b—t_³”s
.
	`sw­
(
Ãw_³”s
);

2831 
Ãed_upd©e
 = 
Œue
;

2833 
h—¹b—t_³”_lock
.
	`UÆock
();

2835 ià(
Ãed_upd©e
)

2836 
osd
->
	`Ãed_h—¹b—t_³”_upd©e
();

2837 
	}
}

2840 
boŞ
 
	gPG
::
	$check_š_´og»ss_İ
(

2841 cÚ¡ 
osd_»qid_t
 &
r
,

2842 
ev”siÚ_t
 *
v”siÚ
,

2843 
v”siÚ_t
 *
u£r_v”siÚ
,

2844 *
»tuº_code
) const

2847 
´ojeùed_log
.
	`g‘_»que¡
(
r
, 
v”siÚ
, 
u£r_v”siÚ
, 
»tuº_code
) ||

2848 
pg_log
.
	`g‘_log
().
	`g‘_»que¡
(
r
, 
v”siÚ
, 
u£r_v”siÚ
, 
»tuº_code
));

2849 
	}
}

2851 
boŞ
 
fšd_sh¬d
(cÚ¡ 
£t
<
pg_sh¬d_t
> & 
pgs
, 
sh¬d_id_t
 
sh¬d
)

2853 auto&
	gp
 : 
pgs
)

2854 ià(
p
.
sh¬d
 == shard)

2855  
Œue
;

2856  
	gçl£
;

2859 
pg_sh¬d_t
 
g‘_ªÙh”_sh¬d
(cÚ¡ 
£t
<pg_sh¬d_t> & 
pgs
,…g_sh¬d_ˆ
sk
, 
sh¬d_id_t
 
sh¬d
)

2861 auto&
	gp
 : 
pgs
) {

2862 ià(
p
 =ğ
sk
)

2864 ià(
	gp
.
	gsh¬d
 =ğ
sh¬d
)

2865  
p
;

2867  
pg_sh¬d_t
();

2870 
	gPG
::
	$_upd©e_ÿlc_¡©s
()

2872 
šfo
.
¡©s
.
v”siÚ
 = info.
Ï¡_upd©e
;

2873 
šfo
.
¡©s
.
ü—‹d
 = info.
hi¡Üy
.
•och_ü—‹d
;

2874 
šfo
.
¡©s
.
Ï¡_süub
 = info.
hi¡Üy
.last_scrub;

2875 
šfo
.
¡©s
.
Ï¡_süub_¡amp
 = info.
hi¡Üy
.last_scrub_stamp;

2876 
šfo
.
¡©s
.
Ï¡_d“p_süub
 = info.
hi¡Üy
.last_deep_scrub;

2877 
šfo
.
¡©s
.
Ï¡_d“p_süub_¡amp
 = info.
hi¡Üy
.last_deep_scrub_stamp;

2878 
šfo
.
¡©s
.
Ï¡_ş—n_süub_¡amp
 = info.
hi¡Üy
.last_clean_scrub_stamp;

2879 
šfo
.
¡©s
.
Ï¡_•och_ş—n
 = info.
hi¡Üy
.last_epoch_clean;

2881 
šfo
.
¡©s
.
log_size
 = 
pg_log
.
	`g‘_h—d
().
v”siÚ
 -…g_log.
	`g‘_
().version;

2882 
šfo
.
¡©s
.
Údisk_log_size
 = info.¡©s.
log_size
;

2883 
šfo
.
¡©s
.
log_¡¬t
 = 
pg_log
.
	`g‘_
();

2884 
šfo
.
¡©s
.
Údisk_log_¡¬t
 = 
pg_log
.
	`g‘_
();

2885 
šfo
.
¡©s
.
¢­Œimq_Ën
 = 
¢­_Œimq
.
	`size
();

2887 
num_sh¬ds
 = 
	`g‘_osdm­
()->
	`g‘_pg_size
(
šfo
.
pgid
.pgid);

2891 
rg‘
 = 
¡d
::
	`max
(
num_sh¬ds
, ()
up£t
.
	`size
());

2893 
Ä•
 = 
¡d
::
	`max
(
aùšg£t
.
	`size
(), 
up£t
.size());

2895 
šfo
.
¡©s
.¡©s.
	`ÿlc_cİ›s
(
¡d
::
	`max
(
rg‘
, 
Ä•
));

2896 
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs_deg¿ded
 = 0;

2897 
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs_unfound
 = 0;

2898 
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs_mi¥Ïûd
 = 0;

2900 ià((
	`is_»m­³d
(è|| 
	`is_und”sized
(è|| !
	`is_ş—n
()è&& (
	`is_³”ed
(è|| 
	`is_aùiv©šg
())) {

2901 
	`dout
(20è<< 
__func__
 << "‡ùšg£ˆ" << 
aùšg£t
 << " upset "

2902 << 
up£t
 << "‡ùšg_»cov”y_backfÈ" << 
aùšg_»cov”y_backfl
 << 
d’dl
;

2903 
	`dout
(20è<< 
__func__
 << "‡ùšg " << 
aùšg
 << " u°" << 
up
 << 
d’dl
;

2905 
	`as£¹
(!
aùšg_»cov”y_backfl
.
	`em±y
());

2907 
boŞ
 
e¡im©e
 = 
çl£
;

2911 
št64_t
 
num_objeùs
 = 
šfo
.
¡©s
.¡©s.
sum
.num_objects;

2914 
boo¡
::
cÚš”
::
æ©_£t
<
·œ
<
št64_t
,
pg_sh¬d_t
>> 
missšg_rg‘_objeùs
;

2916 
boo¡
::
cÚš”
::
æ©_£t
<
·œ
<
št64_t
,
pg_sh¬d_t
>> 
aùšg_sourû_objeùs
;

2921 
št64_t
 
missšg
;

2924 
missšg
 = 
pg_log
.
	`g‘_missšg
().
	`num_missšg
();

2925 
	`as£¹
(
aùšg_»cov”y_backfl
.
	`couÁ
(
pg_whßmi
));

2926 ià(
up£t
.
	`couÁ
(
pg_whßmi
)) {

2927 
missšg_rg‘_objeùs
.
	`š£¹
(
	`make_·œ
(
missšg
, 
pg_whßmi
));

2929 
aùšg_sourû_objeùs
.
	`š£¹
(
	`make_·œ
(
missšg
, 
pg_whßmi
));

2931 
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs_missšg_Ú_´im¬y
 = 
missšg
;

2932 
	`dout
(20è<< 
__func__
 << " sh¬d " << 
pg_whßmi


2933 << "…rim¬y objeù " << 
num_objeùs


2934 << " missšg " << 
missšg


2935 << 
d’dl
;

2939 auto& 
³”
 : 
³”_šfo
) {

2941 ià(
³”
.
fœ¡
 =ğ
pg_whßmi
) ;

2942 
št64_t
 
missšg
 = 0;

2943 
št64_t
 
³”_num_objeùs
 = 
³”
.
£cÚd
.
¡©s
.¡©s.
sum
.
num_objeùs
;

2946 ià(
	`is_backfl_rg‘s
(
³”
.
fœ¡
)) {

2947 
missšg
 = 
¡d
::
	`max
((
št64_t
)0, 
num_objeùs
 - 
³”_num_objeùs
);

2949 ià(
³”_missšg
.
	`couÁ
(
³”
.
fœ¡
)) {

2950 
missšg
 = 
³”_missšg
[
³”
.
fœ¡
].
	`num_missšg
();

2952 
	`dout
(20è<< 
__func__
 << "‚Ø³”_missšg found fÜ " << 
³”
.
fœ¡
 << 
d’dl
;

2953 ià(
	`is_»cov”šg
()) {

2954 
e¡im©e
 = 
Œue
;

2956 
missšg
 = 
¡d
::
	`max
((
št64_t
)0, 
num_objeùs
 - 
³”_num_objeùs
);

2959 ià(
up£t
.
	`couÁ
(
³”
.
fœ¡
)) {

2960 
missšg_rg‘_objeùs
.
	`š£¹
(
	`make_·œ
(
missšg
, 
³”
.
fœ¡
));

2961 } ià(
aùšg£t
.
	`couÁ
(
³”
.
fœ¡
)) {

2962 
aùšg_sourû_objeùs
.
	`š£¹
(
	`make_·œ
(
missšg
, 
³”
.
fœ¡
));

2964 
³”
.
£cÚd
.
¡©s
.¡©s.
sum
.
num_objeùs_missšg
 = 
missšg
;

2965 
	`dout
(20è<< 
__func__
 << " sh¬d " << 
³”
.
fœ¡


2966 << " objeù " << 
³”_num_objeùs


2967 << " missšg " << 
missšg


2968 << 
d’dl
;

2972 
št64_t
 
mi¥Ïûd
 = 0;

2974 
št64_t
 
deg¿ded
 = 0;

2976 ià(
	`is_»cov”šg
()) {

2977 auto& 
sml
: 
missšg_loc
.
	`g‘_missšg_by_couÁ
()) {

2978 auto& 
ml
: 
sml
.
£cÚd
) {

2979 
missšg_sh¬ds
;

2980 ià(
sml
.
fœ¡
 =ğ
sh¬d_id_t
::
NO_SHARD
) {

2981 
	`dout
(0è<< 
__func__
 << " mÈ" << 
ml
.
£cÚd
 << " up£ˆsiz" << 
up£t
.
	`size
(è<< " u°" << ml.
fœ¡
.
up
 << 
d’dl
;

2982 
missšg_sh¬ds
 = ()
up£t
.
	`size
(è- 
ml
.
fœ¡
.
up
;

2985 ià(!
	`fšd_sh¬d
(
up£t
, 
sml
.
fœ¡
))

2987 
missšg_sh¬ds
 = 
¡d
::
	`max
(0, 1 - 
ml
.
fœ¡
.
up
);

2988 
	`dout
(0è<< 
__func__
 << " sh¬d " << 
sml
.
fœ¡
 << " mÈ" << 
ml
.
£cÚd
 << " missšg sh¬d " << 
missšg_sh¬ds
 << 
d’dl
;

2990 
odeg¿ded
 = 
ml
.
£cÚd
 * 
missšg_sh¬ds
;

2992 
mÜe_osds
 = 
¡d
::
	`mš
(
missšg_sh¬ds
, 
ml
.
fœ¡
.
Ùh”
);

2993 
omi¥Ïûd
 = 
ml
.
£cÚd
 * 
mÜe_osds
;

2994 
	`as£¹
(
omi¥Ïûd
 <ğ
odeg¿ded
);

2995 
odeg¿ded
 -ğ
omi¥Ïûd
;

2997 
mi¥Ïûd
 +ğ
omi¥Ïûd
;

2998 
deg¿ded
 +ğ
odeg¿ded
;

3002 
	`dout
(20è<< 
__func__
 << " missšg ba£d deg¿ded " << 
deg¿ded
 << 
d’dl
;

3003 
	`dout
(20è<< 
__func__
 << " missšg ba£d mi¥Ïûd " << 
mi¥Ïûd
 << 
d’dl
;

3006 ià(
poŞ
.
šfo
.
	`is_»¶iÿ‹d
()) {

3008 
	`as£¹
(
rg‘
 >ğ
up£t
.
	`size
());

3009 
Ãeded
 = 
rg‘
 - 
up£t
.
	`size
();

3010 
deg¿ded
 +ğ
num_objeùs
 * 
Ãeded
;

3012 
i
 = 0 ; i < 
num_sh¬ds
; ++i) {

3013 
sh¬d_id_t
 
	`sh¬d
(
i
);

3015 ià(!
	`fšd_sh¬d
(
up£t
, 
sh¬d
)) {

3016 
pg_sh¬d_t
 
pgs
 = 
	`g‘_ªÙh”_sh¬d
(
aùšg£t
, 
	`pg_sh¬d_t
(), 
sh¬d
);

3018 ià(
pgs
 !ğ
	`pg_sh¬d_t
()) {

3019 
št64_t
 
missšg
;

3021 ià(
pgs
 =ğ
pg_whßmi
)

3022 
missšg
 = 
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs_missšg_Ú_´im¬y
;

3024 
missšg
 = 
³”_šfo
[
pgs
].
¡©s
.¡©s.
sum
.
num_objeùs_missšg
;

3026 
deg¿ded
 +ğ
missšg
;

3027 
mi¥Ïûd
 +ğ
¡d
::
	`max
((
št64_t
)0, 
num_objeùs
 - 
missšg
);

3030 
deg¿ded
 +ğ
num_objeùs
;

3035 
out
;

3039 ià(
poŞ
.
šfo
.
	`is_»¶iÿ‹d
()) {

3041 
	`as£¹
(
rg‘
 >ğ
missšg_rg‘_objeùs
.
	`size
());

3042 
Ãeded
 = 
rg‘
 - 
missšg_rg‘_objeùs
.
	`size
();

3043 ià(
Ãeded
)

3044 
missšg_rg‘_objeùs
.
	`š£¹
(
	`make_·œ
(
num_objeùs
 * 
Ãeded
, 
	`pg_sh¬d_t
(
pg_sh¬d_t
::
NO_OSD
)));

3046 
i
 = 0 ; i < 
num_sh¬ds
; ++i) {

3047 
sh¬d_id_t
 
	`sh¬d
(
i
);

3048 
boŞ
 
found
 = 
çl£
;

3049 cÚ¡‡uto& 
t
 : 
missšg_rg‘_objeùs
) {

3050 ià(
¡d
::
g‘
<1>(
t
).
sh¬d
 == shard) {

3051 
found
 = 
Œue
;

3055 ià(!
found
)

3056 
missšg_rg‘_objeùs
.
	`š£¹
(
	`make_·œ
(
num_objeùs
, 
	`pg_sh¬d_t
(
pg_sh¬d_t
::
NO_OSD
,
sh¬d
)));

3060 cÚ¡‡uto& 
™em
 : 
missšg_rg‘_objeùs
)

3061 
	`dout
(20è<< 
__func__
 << " missšg sh¬d " << 
¡d
::
g‘
<1>(
™em
è<< " missšgğ" << std::g‘<0>(™emè<< 
d’dl
;

3062 cÚ¡‡uto& 
™em
 : 
aùšg_sourû_objeùs
)

3063 
	`dout
(20è<< 
__func__
 << "‡ùšg sh¬d " << 
¡d
::
g‘
<1>(
™em
è<< " missšgğ" << std::g‘<0>(™emè<< 
d’dl
;

3067 autØ
m
 = 
missšg_rg‘_objeùs
.
	`rbegš
();

3068 
m
 !ğ
missšg_rg‘_objeùs
.
	`»nd
(); ++m) {

3070 
št64_t
 
exŒa_missšg
 = -1;

3072 ià(
poŞ
.
šfo
.
	`is_»¶iÿ‹d
()) {

3073 ià(!
aùšg_sourû_objeùs
.
	`em±y
()) {

3074 autØ
exŒa_cİy
 = 
aùšg_sourû_objeùs
.
	`begš
();

3075 
exŒa_missšg
 = 
¡d
::
g‘
<0>(*
exŒa_cİy
);

3076 
aùšg_sourû_objeùs
.
	`”a£
(
exŒa_cİy
);

3080 cÚ¡‡uto& 
a
 : 
aùšg_sourû_objeùs
) {

3081 ià(
¡d
::
g‘
<1>(
a
).
sh¬d
 =ğ¡d::g‘<1>(*
m
).shard) {

3082 
exŒa_missšg
 = 
¡d
::
g‘
<0>(
a
);

3083 
aùšg_sourû_objeùs
.
	`”a£
(
a
);

3089 ià(
exŒa_missšg
 >ğ0 && 
¡d
::
g‘
<0>(*
m
) >=ƒxtra_missing) {

3092 
mi¥Ïûd
 +ğ
¡d
::
g‘
<0>(*
m
è- 
exŒa_missšg
;

3093 
deg¿ded
 +ğ
exŒa_missšg
;

3098 
deg¿ded
 +ğ
¡d
::
g‘
<0>(*
m
);

3103 cÚ¡‡uto& 
a
 : 
aùšg_sourû_objeùs
) {

3104 
št64_t
 
exŒa_mi¥Ïûd
 = 
¡d
::
	`max
((št64_t)0, 
num_objeùs
 - std::
g‘
<0>(
a
));

3105 
	`dout
(20è<< 
__func__
 << "ƒxŒ¨aùšg mi¥Ïûd " << 
exŒa_mi¥Ïûd
 << 
d’dl
;

3106 
mi¥Ïûd
 +ğ
exŒa_mi¥Ïûd
;

3108 
out
:

3110 
	`dout
(20è<< 
__func__
 << " deg¿ded " << 
deg¿ded
 << (
e¡im©e
 ? " (e¡)": ""è<< 
d’dl
;

3111 
	`dout
(20è<< 
__func__
 << " mi¥Ïûd " << 
mi¥Ïûd
 << (
e¡im©e
 ? " (e¡)": "")<< 
d’dl
;

3113 
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs_deg¿ded
 = 
deg¿ded
;

3114 
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs_unfound
 = 
	`g‘_num_unfound
();

3115 
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs_mi¥Ïûd
 = 
mi¥Ïûd
;

3117 
	}
}

3119 
	gPG
::
	$_upd©e_blocked_by
()

3123 
k“p
 = 
¡d
::
mš
<>(
blocked_by
.
	`size
(), 
cù
->
_cÚf
->
osd_max_pg_blocked_by
);

3124 
sk
 = 
blocked_by
.
	`size
(è- 
k“p
;

3125 
šfo
.
¡©s
.
blocked_by
.
	`ş—r
();

3126 
šfo
.
¡©s
.
blocked_by
.
	`»size
(
k“p
);

3127 
pos
 = 0;

3128 
£t
<>::
™”©Ü
 
p
 = 
blocked_by
.
	`begš
();

3129 
p
 !ğ
blocked_by
.
	`’d
(è&& 
k“p
 > 0;

3130 ++
p
) {

3131 ià(
sk
 > 0 && (
	`¿nd
(è% (sk + 
k“p
) < skip)) {

3132 --
sk
;

3134 
šfo
.
¡©s
.
blocked_by
[
pos
++] = *
p
;

3135 --
k“p
;

3138 
	}
}

3140 
	gPG
::
	$publish_¡©s_to_osd
()

3142 ià(!
	`is_´im¬y
())

3145 
pg_¡©s_publish_lock
.
	`Lock
();

3147 ià(
šfo
.
¡©s
.¡©s.
sum
.
num_süub_”rÜs
)

3148 
	`¡©e_£t
(
PG_STATE_INCONSISTENT
);

3150 
	`¡©e_ş—r
(
PG_STATE_INCONSISTENT
);

3152 
utime_t
 
now
 = 
	`ûph_şock_now
();

3153 ià(
šfo
.
¡©s
.
¡©e
 != state) {

3154 
šfo
.
¡©s
.
Ï¡_chªge
 = 
now
;

3157 ià(!(
¡©e
 & 
PG_STATE_ACTIVE
) &&

3158 (
šfo
.
¡©s
.
¡©e
 & 
PG_STATE_ACTIVE
))

3159 
šfo
.
¡©s
.
Ï¡_aùive
 = 
now
;

3161 ià((
¡©e
 & 
PG_STATE_ACTIVE
) &&

3162 !(
šfo
.
¡©s
.
¡©e
 & 
PG_STATE_ACTIVE
))

3163 
šfo
.
¡©s
.
Ï¡_beÿme_aùive
 = 
now
;

3164 ià((
¡©e
 & (
PG_STATE_ACTIVE
|
PG_STATE_PEERED
)) &&

3165 !(
šfo
.
¡©s
.
¡©e
 & (
PG_STATE_ACTIVE
|
PG_STATE_PEERED
)))

3166 
šfo
.
¡©s
.
Ï¡_beÿme_³”ed
 = 
now
;

3167 ià(!(
¡©e
 & 
PG_STATE_CREATING
) &&

3168 (
šfo
.
¡©s
.
¡©e
 & 
PG_STATE_CREATING
)) {

3169 
osd
->
	`£nd_pg_ü—‹d
(
	`g‘_pgid
().
pgid
);

3171 
šfo
.
¡©s
.
¡©e
 = state;

3174 
	`_upd©e_ÿlc_¡©s
();

3175 ià(
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs_deg¿ded
) {

3176 
	`¡©e_£t
(
PG_STATE_DEGRADED
);

3178 
	`¡©e_ş—r
(
PG_STATE_DEGRADED
);

3180 
	`_upd©e_blocked_by
();

3182 
pg_¡©_t
 
´e_publish
 = 
šfo
.
¡©s
;

3183 
´e_publish
.
¡©s
.
	`add
(
un¡abË_¡©s
);

3184 
utime_t
 
cutoff
 = 
now
;

3185 
cutoff
 -ğ
cù
->
_cÚf
->
osd_pg_¡©_»pÜt_š‹rv®_max
;

3187 ià(
	`g‘_osdm­
()->
»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_MIMIC
) {

3190 
max
 = 
cù
->
_cÚf
->
osd_max_¢­_´uÃ_š‹rv®s_³r_•och
;

3191 
num
 = 0;

3192 autØ
i
 = 
šfo
.
purged_¢­s
.
	`begš
();

3193 
num
 < 
max
 && 
i
 !ğ
šfo
.
purged_¢­s
.
	`’d
()) {

3194 
´e_publish
.
purged_¢­s
.
	`š£¹
(
i
.
	`g‘_¡¬t
(), i.
	`g‘_Ën
());

3195 ++
num
;

3196 ++
i
;

3198 
	`dout
(20è<< 
__func__
 << "„eporting…urged_snaps "

3199 << 
´e_publish
.
purged_¢­s
 << 
d’dl
;

3202 ià(
pg_¡©s_publish_v®id
 && 
´e_publish
 =ğ
pg_¡©s_publish
 &&

3203 
šfo
.
¡©s
.
Ï¡_äesh
 > 
cutoff
) {

3204 
	`dout
(15è<< "publish_¡©s_to_osd " << 
pg_¡©s_publish
.
»pÜ‹d_•och


3205 << ":‚Øchªgsšû " << 
šfo
.
¡©s
.
Ï¡_äesh
 << 
d’dl
;

3208 
šfo
.
¡©s
.
»pÜ‹d_•och
 = 
	`g‘_osdm­
()->
	`g‘_•och
();

3209 ++
šfo
.
¡©s
.
»pÜ‹d_£q
;

3211 
šfo
.
¡©s
.
Ï¡_äesh
 = 
now
;

3213 ià(
šfo
.
¡©s
.
¡©e
 & 
PG_STATE_CLEAN
)

3214 
šfo
.
¡©s
.
Ï¡_ş—n
 = 
now
;

3215 ià(
šfo
.
¡©s
.
¡©e
 & 
PG_STATE_ACTIVE
)

3216 
šfo
.
¡©s
.
Ï¡_aùive
 = 
now
;

3217 ià(
šfo
.
¡©s
.
¡©e
 & (
PG_STATE_ACTIVE
|
PG_STATE_PEERED
))

3218 
šfo
.
¡©s
.
Ï¡_³”ed
 = 
now
;

3219 
šfo
.
¡©s
.
Ï¡_un¡®e
 = 
now
;

3220 ià((
šfo
.
¡©s
.
¡©e
 & 
PG_STATE_DEGRADED
) == 0)

3221 
šfo
.
¡©s
.
Ï¡_undeg¿ded
 = 
now
;

3222 ià((
šfo
.
¡©s
.
¡©e
 & 
PG_STATE_UNDERSIZED
) == 0)

3223 
šfo
.
¡©s
.
Ï¡_fuÎsized
 = 
now
;

3225 
pg_¡©s_publish_v®id
 = 
Œue
;

3226 
pg_¡©s_publish
 = 
´e_publish
;

3228 
	`dout
(15è<< "publish_¡©s_to_osd " << 
pg_¡©s_publish
.
»pÜ‹d_•och


3229 << ":" << 
pg_¡©s_publish
.
»pÜ‹d_£q
 << 
d’dl
;

3231 
pg_¡©s_publish_lock
.
	`UÆock
();

3232 
	}
}

3234 
	gPG
::
	$ş—r_publish_¡©s
()

3236 
	`dout
(15è<< "ş—r_¡©s" << 
d’dl
;

3237 
pg_¡©s_publish_lock
.
	`Lock
();

3238 
pg_¡©s_publish_v®id
 = 
çl£
;

3239 
pg_¡©s_publish_lock
.
	`UÆock
();

3240 
	}
}

3256 
	gPG
::
š™
(

3257 
rŞe
,

3258 cÚ¡ 
veùÜ
<>& 
Ãwup
, 
Ãw_up_´im¬y
,

3259 cÚ¡ 
veùÜ
<>& 
Ãwaùšg
, 
Ãw_aùšg_´im¬y
,

3260 cÚ¡ 
pg_hi¡Üy_t
& 
hi¡Üy
,

3261 cÚ¡ 
Pa¡IÁ”v®s
& 
pi
,

3262 
boŞ
 
backfl
,

3263 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

3265 
dout
(10è<< "š™„Ş" << 
rŞe
 << " u°" << 
Ãwup
 << "‡ùšg " << 
Ãwaùšg


3266 << " hi¡Üy " << 
hi¡Üy


3267 << "…a¡_š‹rv® " << 
pi


3268 << 
d’dl
;

3270 
£t_rŞe
(
rŞe
);

3271 
	gaùšg
 = 
Ãwaùšg
;

3272 
	gup
 = 
Ãwup
;

3273 
š™_´im¬y_up_aùšg
(

3274 
Ãwup
,

3275 
Ãwaùšg
,

3276 
Ãw_up_´im¬y
,

3277 
Ãw_aùšg_´im¬y
);

3279 
	gšfo
.
	ghi¡Üy
 = 
hi¡Üy
;

3280 
	g·¡_š‹rv®s
 = 
pi
;

3282 
	gšfo
.
	g¡©s
.
	gup
 = 
up
;

3283 
	gšfo
.
	g¡©s
.
	gup_´im¬y
 = 
Ãw_up_´im¬y
;

3284 
	gšfo
.
	g¡©s
.
	gaùšg
 = 
aùšg
;

3285 
	gšfo
.
	g¡©s
.
	gaùšg_´im¬y
 = 
Ãw_aùšg_´im¬y
;

3286 
	gšfo
.
	g¡©s
.
	gm­pšg_•och
 = 
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû
;

3288 ià(
	gbackfl
) {

3289 
dout
(10è<< 
	g__func__
 << ": S‘tšg backfl" << 
	gd’dl
;

3290 
	gšfo
.
£t_Ï¡_backfl
(
hobjeù_t
());

3291 
	gšfo
.
	gÏ¡_com¶‘e
 = 
šfo
.
Ï¡_upd©e
;

3292 
	gpg_log
.
m¬k_log_fÜ_»wr™e
();

3295 
Ú_Ãw_š‹rv®
();

3297 
	gdœty_šfo
 = 
Œue
;

3298 
	gdœty_big_šfo
 = 
Œue
;

3299 
wr™e_if_dœty
(*
t
);

3302 
	gPG
::
	$shutdown
()

3304 
ch
->
	`æush
();

3305 
	`lock
();

3306 
	`Ú_shutdown
();

3307 
	`uÆock
();

3308 
	}
}

3310 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wpragmas"

3311 #´agm¨
GCC
 
dŸgno¡ic
 
push


3312 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wdeprecated-declarations"

3314 
	gPG
::
	$upg¿de
(
ObjeùStÜe
 *
¡Üe
)

3316 
	`dout
(0è<< 
__func__
 << " " << 
šfo_¡ruù_v
 << " -> " << 
Ï‹¡_¡ruù_v


3317 << 
d’dl
;

3318 
	`as£¹
(
šfo_¡ruù_v
 <= 10);

3319 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

3324 
	`as£¹
(
šfo_¡ruù_v
 == 10);

3327 ià(
šfo_¡ruù_v
 < 
Ï‹¡_¡ruù_v
) {

3328 
m­
<
¡ršg
,
bufã¾i¡
> 
v
;

3329 
__u8
 
v”
 = 
Ï‹¡_¡ruù_v
;

3330 
	`’code
(
v”
, 
v
[
šfov”_key
]);

3331 
t
.
	`om­_£tkeys
(
cŞl
, 
pgm‘a_oid
, 
v
);

3334 
dœty_šfo
 = 
Œue
;

3335 
dœty_big_šfo
 = 
Œue
;

3336 
	`wr™e_if_dœty
(
t
);

3338 
ObjeùStÜe
::
CŞËùiÚHªdË
 
ch
 = 
¡Üe
->
	`İ’_cŞËùiÚ
(
cŞl
);

3339 
r
 = 
¡Üe
->
	`queue_Œª§ùiÚ
(
ch
, 
¡d
::
	`move
(
t
));

3340 ià(
r
 != 0) {

3341 
d”r
 << 
__func__
 << ": queue_transaction„eturned "

3342 << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

3343 
	`ûph_abÜt
();

3345 
	`as£¹
(
r
 == 0);

3347 
C_SaãrCÚd
 
wa™”
;

3348 ià(!
ch
->
	`æush_comm™
(&
wa™”
)) {

3349 
wa™”
.
	`wa™
();

3351 
	}
}

3353 #´agm¨
GCC
 
dŸgno¡ic
 
pİ


3354 #´agm¨
GCC
 
dŸgno¡ic
 
w¬nšg
 "-Wpragmas"

3356 
	gPG
::
_´•¬e_wr™e_šfo
(
C•hCÚ‹xt
* 
cù
,

3357 
m­
<
¡ršg
,
bufã¾i¡
> *
km
,

3358 
•och_t
 
•och
,

3359 
pg_šfo_t
 &
šfo
,…g_šfo_ˆ&
Ï¡_wr™‹n_šfo
,

3360 
Pa¡IÁ”v®s
 &
·¡_š‹rv®s
,

3361 
boŞ
 
dœty_big_šfo
,

3362 
boŞ
 
dœty_•och
,

3363 
boŞ
 
Œy_ç¡_šfo
,

3364 
P”fCouÁ”s
 *
logg”
)

3366 ià(
	gdœty_•och
) {

3367 
’code
(
•och
, (*
km
)[
•och_key
]);

3370 ià(
	glogg”
)

3371 
	glogg”
->
šc
(
l_osd_pg_šfo
);

3374 ià(!
	gdœty_big_šfo
 && 
	gŒy_ç¡_šfo
 &&

3375 
	gšfo
.
	gÏ¡_upd©e
 > 
	gÏ¡_wr™‹n_šfo
.last_update) {

3376 
pg_ç¡_šfo_t
 
	gç¡
;

3377 
	gç¡
.
pİuÏ‹_äom
(
šfo
);

3378 
boŞ
 
	gdid
 = 
ç¡
.
Œy_­¶y_to
(&
Ï¡_wr™‹n_šfo
);

3379 
as£¹
(
did
);

3380 ià(
	gšfo
 =ğ
Ï¡_wr™‹n_šfo
) {

3381 
’code
(
ç¡
, (*
km
)[
ç¡šfo_key
]);

3382 ià(
	glogg”
)

3383 
	glogg”
->
šc
(
l_osd_pg_ç¡šfo
);

3386 
g’”ic_dout
(30è<< 
	g__func__
 << " fastinfo failed, info:\n";

3388 
JSONFÜm©‹r
 
jf
(
Œue
);

3389 
	gjf
.
dump_objeù
("šfo", 
šfo
);

3390 
	gjf
.
æush
(*
_dout
);

3393 *
	g_dout
 << "\nlast_written_info:\n";

3394 
JSONFÜm©‹r
 
jf
(
Œue
);

3395 
	gjf
.
dump_objeù
("Ï¡_wr™‹n_šfo", 
Ï¡_wr™‹n_šfo
);

3396 
	gjf
.
æush
(*
_dout
);

3398 *
	g_dout
 << 
	gd’dl
;

3400 
	gÏ¡_wr™‹n_šfo
 = 
šfo
;

3403 
	gš‹rv®_£t
<
	g¢­id_t
> 
	gpurged_¢­s
;

3404 
	gpurged_¢­s
.
sw­
(
šfo
.
purged_¢­s
);

3405 
’code
(
šfo
, (*
km
)[
šfo_key
]);

3406 
	gpurged_¢­s
.
sw­
(
šfo
.
purged_¢­s
);

3408 ià(
	gdœty_big_šfo
) {

3410 
	gbufã¾i¡
& 
	gbigbl
 = (*
km
)[
bigšfo_key
];

3411 
’code
(
·¡_š‹rv®s
, 
bigbl
);

3412 
’code
(
šfo
.
purged_¢­s
, 
bigbl
);

3414 ià(
	glogg”
)

3415 
	glogg”
->
šc
(
l_osd_pg_bigšfo
);

3421 
	gPG
::
	$_ü—‹
(
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
, 
¥g_t
 
pgid
, 
b™s
)

3423 
cŞl_t
 
	`cŞl
(
pgid
);

3424 
t
.
	`ü—‹_cŞËùiÚ
(
cŞl
, 
b™s
);

3425 
	}
}

3427 
	gPG
::
	$_š™
(
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
, 
¥g_t
 
pgid
, cÚ¡ 
pg_poŞ_t
 *
poŞ
)

3429 
cŞl_t
 
	`cŞl
(
pgid
);

3431 ià(
poŞ
) {

3433 
bufã¾i¡
 
hšt
;

3434 
ušt32_t
 
pg_num
 = 
poŞ
->
	`g‘_pg_num
();

3435 
ušt64_t
 
ex³ùed_num_objeùs_pg
 = 
poŞ
->
ex³ùed_num_objeùs
 / 
pg_num
;

3436 
	`’code
(
pg_num
, 
hšt
);

3437 
	`’code
(
ex³ùed_num_objeùs_pg
, 
hšt
);

3438 
ušt32_t
 
hšt_ty³
 = 
ObjeùStÜe
::
T¿n§ùiÚ
::
COLL_HINT_EXPECTED_NUM_OBJECTS
;

3439 
t
.
	`cŞËùiÚ_hšt
(
cŞl
, 
hšt_ty³
, 
hšt
);

3442 
ghobjeù_t
 
	`pgm‘a_oid
(
pgid
.
	`make_pgm‘a_oid
());

3443 
t
.
	`touch
(
cŞl
, 
pgm‘a_oid
);

3444 
m­
<
¡ršg
,
bufã¾i¡
> 
v®ues
;

3445 
__u8
 
¡ruù_v
 = 
Ï‹¡_¡ruù_v
;

3446 
	`’code
(
¡ruù_v
, 
v®ues
[
šfov”_key
]);

3447 
t
.
	`om­_£tkeys
(
cŞl
, 
pgm‘a_oid
, 
v®ues
);

3448 
	}
}

3450 
	gPG
::
´•¬e_wr™e_šfo
(
m­
<
¡ršg
,
bufã¾i¡
> *
km
)

3452 
	gšfo
.
	g¡©s
.¡©s.
add
(
un¡abË_¡©s
);

3453 
	gun¡abË_¡©s
.
ş—r
();

3455 
boŞ
 
	gÃed_upd©e_•och
 = 
Ï¡_•och
 < 
g‘_osdm­
()->
g‘_•och
();

3456 
	g»t
 = 
_´•¬e_wr™e_šfo
(
cù
, 
km
, 
g‘_osdm­
()->
g‘_•och
(),

3457 
šfo
,

3458 
Ï¡_wr™‹n_šfo
,

3459 
·¡_š‹rv®s
,

3460 
dœty_big_šfo
, 
Ãed_upd©e_•och
,

3461 
cù
->
_cÚf
->
osd_ç¡_šfo
,

3462 
osd
->
logg”
);

3463 
as£¹
(
»t
 == 0);

3464 ià(
	gÃed_upd©e_•och
)

3465 
	gÏ¡_•och
 = 
g‘_osdm­
()->
g‘_•och
();

3466 
	gÏ¡_³rsi¡ed_osdm­
 = 
Ï¡_•och
;

3468 
	gdœty_šfo
 = 
çl£
;

3469 
	gdœty_big_šfo
 = 
çl£
;

3472 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wpragmas"

3473 #´agm¨
GCC
 
dŸgno¡ic
 
push


3474 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wdeprecated-declarations"

3476 
boŞ
 
	gPG
::
	$_has_»mov®_æag
(
ObjeùStÜe
 *
¡Üe
,

3477 
¥g_t
 
pgid
)

3479 
cŞl_t
 
	`cŞl
(
pgid
);

3480 
ghobjeù_t
 
	`pgm‘a_oid
(
pgid
.
	`make_pgm‘a_oid
());

3483 
£t
<
¡ršg
> 
keys
;

3484 
keys
.
	`š£¹
("_remove");

3485 
m­
<
¡ršg
,
bufã¾i¡
> 
v®ues
;

3486 autØ
ch
 = 
¡Üe
->
	`İ’_cŞËùiÚ
(
cŞl
);

3487 
	`as£¹
(
ch
);

3488 ià(
¡Üe
->
	`om­_g‘_v®ues
(
ch
, 
pgm‘a_oid
, 
keys
, &
v®ues
) == 0 &&

3489 
v®ues
.
	`size
() == 1)

3490  
Œue
;

3492  
çl£
;

3493 
	}
}

3495 
	gPG
::
	$³ek_m­_•och
(
ObjeùStÜe
 *
¡Üe
,

3496 
¥g_t
 
pgid
,

3497 
•och_t
 *
³poch
)

3499 
cŞl_t
 
	`cŞl
(
pgid
);

3500 
ghobjeù_t
 
	`Ëgacy_šfos_oid
(
OSD
::
	`make_šfos_oid
());

3501 
ghobjeù_t
 
	`pgm‘a_oid
(
pgid
.
	`make_pgm‘a_oid
());

3502 
•och_t
 
cur_•och
 = 0;

3505 
	`as£¹
(
cŞl
.
	`is_pg
());

3508 
£t
<
¡ršg
> 
keys
;

3509 
keys
.
	`š£¹
(
šfov”_key
);

3510 
keys
.
	`š£¹
(
•och_key
);

3511 
m­
<
¡ršg
,
bufã¾i¡
> 
v®ues
;

3512 autØ
ch
 = 
¡Üe
->
	`İ’_cŞËùiÚ
(
cŞl
);

3513 
	`as£¹
(
ch
);

3514 
r
 = 
¡Üe
->
	`om­_g‘_v®ues
(
ch
, 
pgm‘a_oid
, 
keys
, &
v®ues
);

3515 ià(
r
 == 0) {

3516 
	`as£¹
(
v®ues
.
	`size
() == 2);

3519 
bufã¾i¡
::
™”©Ü
 
bp
 = 
v®ues
[
šfov”_key
].
	`begš
();

3520 
__u8
 
¡ruù_v
 = 0;

3521 
	`decode
(
¡ruù_v
, 
bp
);

3522 
	`as£¹
(
¡ruù_v
 >= 8);

3525 
bp
 = 
v®ues
[
•och_key
].
	`begš
();

3526 
	`decode
(
cur_•och
, 
bp
);

3532 *
³poch
 = 
cur_•och
;

3534 
	}
}

3536 #´agm¨
GCC
 
dŸgno¡ic
 
pİ


3537 #´agm¨
GCC
 
dŸgno¡ic
 
w¬nšg
 "-Wpragmas"

3539 
	gPG
::
	$wr™e_if_dœty
(
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
)

3541 
m­
<
¡ršg
,
bufã¾i¡
> 
km
;

3542 ià(
dœty_big_šfo
 || 
dœty_šfo
)

3543 
	`´•¬e_wr™e_šfo
(&
km
);

3544 
pg_log
.
	`wr™e_log_ªd_missšg
(
t
, &
km
, 
cŞl
, 
pgm‘a_oid
, 
poŞ
.
šfo
.
	`»quœe_rŞlback
());

3545 ià(!
km
.
	`em±y
())

3546 
t
.
	`om­_£tkeys
(
cŞl
, 
pgm‘a_oid
, 
km
);

3547 
	}
}

3549 
	gPG
::
	$Œim_log
()

3551 
	`as£¹
(
	`is_´im¬y
());

3552 
	`ÿlc_Œim_to
();

3553 
	`dout
(10è<< 
__func__
 << "Ø" << 
pg_Œim_to
 << 
d’dl
;

3554 ià(
pg_Œim_to
 !ğ
	`ev”siÚ_t
()) {

3556 
	`as£¹
(!
aùšg_»cov”y_backfl
.
	`em±y
());

3557 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
aùšg_»cov”y_backfl
.
	`begš
();

3558 
i
 !ğ
aùšg_»cov”y_backfl
.
	`’d
();

3559 ++
i
) {

3560 ià(*
i
 =ğ
pg_whßmi
) ;

3561 
osd
->
	`£nd_mes§ge_osd_şu¡”
(

3562 
i
->
osd
,

3563 
Ãw
 
	`MOSDPGTrim
(

3564 
	`g‘_osdm­
()->
	`g‘_•och
(),

3565 
	`¥g_t
(
šfo
.
pgid
.pgid, 
i
->
sh¬d
),

3566 
pg_Œim_to
),

3567 
	`g‘_osdm­
()->
	`g‘_•och
());

3571 
pg_log
.
	`Œim
(
pg_Œim_to
, 
šfo
);

3572 
dœty_šfo
 = 
Œue
;

3574 
	}
}

3576 
	gPG
::
	$add_log_’Œy
(cÚ¡ 
pg_log_’Œy_t
& 
e
, 
boŞ
 
­¶›d
)

3579 ià(
šfo
.
Ï¡_com¶‘e
 =ğšfo.
Ï¡_upd©e
)

3580 
šfo
.
Ï¡_com¶‘e
 = 
e
.
v”siÚ
;

3583 
	`as£¹
(
e
.
v”siÚ
 > 
šfo
.
Ï¡_upd©e
);

3584 
šfo
.
Ï¡_upd©e
 = 
e
.
v”siÚ
;

3588 ià(
e
.
u£r_v”siÚ
 > 
šfo
.
Ï¡_u£r_v”siÚ
)

3589 
šfo
.
Ï¡_u£r_v”siÚ
 = 
e
.
u£r_v”siÚ
;

3592 
pg_log
.
	`add
(
e
, 
­¶›d
);

3593 
	`dout
(10è<< "add_log_’Œy " << 
e
 << 
d’dl
;

3594 
	}
}

3597 
	gPG
::
­³nd_log
(

3598 cÚ¡ 
veùÜ
<
pg_log_’Œy_t
>& 
logv
,

3599 
ev”siÚ_t
 
Œim_to
,

3600 
ev”siÚ_t
 
rŞl_fÜw¬d_to
,

3601 
ObjeùStÜe
::
T¿n§ùiÚ
 &
t
,

3602 
boŞ
 
Œª§ùiÚ_­¶›d
)

3604 ià(
	gŒª§ùiÚ_­¶›d
)

3605 
upd©e_¢­_m­
(
logv
, 
t
);

3612 ià(
	gšfo
.
	gÏ¡_•och_¡¬‹d
 !ğ
šfo
.
hi¡Üy
.
Ï¡_•och_¡¬‹d
) {

3613 
šfo
.
hi¡Üy
.
Ï¡_•och_¡¬‹d
 = info.last_epoch_started;

3615 ià(
	gšfo
.
	gÏ¡_š‹rv®_¡¬‹d
 !ğ
šfo
.
hi¡Üy
.
Ï¡_š‹rv®_¡¬‹d
) {

3616 
šfo
.
hi¡Üy
.
Ï¡_š‹rv®_¡¬‹d
 = info.last_interval_started;

3618 
dout
(10è<< "­³nd_log " << 
	gpg_log
.
g‘_log
(è<< " " << 
	glogv
 << 
	gd’dl
;

3620 
PGLogEÁryHªdËr
 
	ghªdËr
{
	gthis
, &
	gt
};

3621 ià(!
	gŒª§ùiÚ_­¶›d
) {

3626 
	gpg_log
.
rŞl_fÜw¬d
(&
hªdËr
);

3629 
	gveùÜ
<
	gpg_log_’Œy_t
>::
cÚ¡_™”©Ü
 
p
 = 
logv
.
begš
();

3630 
	gp
 !ğ
logv
.
’d
();

3631 ++
	gp
) {

3632 
add_log_’Œy
(*
p
, 
Œª§ùiÚ_­¶›d
);

3637 ià(
	gŒª§ùiÚ_­¶›d
 &&

3638 
	gp
->
	gsoid
 > 
	gšfo
.
	gÏ¡_backfl
) {

3639 
	gpg_log
.
rŞl_fÜw¬d
(&
hªdËr
);

3642 autØ
	gÏ¡
 = 
logv
.
rbegš
();

3643 ià(
is_´im¬y
(è&& 
	gÏ¡
 !ğ
logv
.
»nd
()) {

3644 
´ojeùed_log
.
sk_ÿn_rŞlback_to_to_h—d
();

3645 
	g´ojeùed_log
.
Œim
(
cù
, 
Ï¡
->
v”siÚ
, 
nuÎ±r
,‚ullptr,‚ullptr);

3648 ià(
	gŒª§ùiÚ_­¶›d
 && 
	grŞl_fÜw¬d_to
 > 
	gpg_log
.
g‘_ÿn_rŞlback_to
()) {

3649 
	gpg_log
.
rŞl_fÜw¬d_to
(

3650 
rŞl_fÜw¬d_to
,

3651 &
hªdËr
);

3652 
	gÏ¡_rŞlback_šfo_Œimmed_to_­¶›d
 = 
rŞl_fÜw¬d_to
;

3655 
	gpg_log
.
Œim
(
Œim_to
, 
šfo
);

3658 
	gdœty_šfo
 = 
Œue
;

3659 
wr™e_if_dœty
(
t
);

3662 
boŞ
 
	gPG
::
	$check_log_fÜ_cÜru±iÚ
(
ObjeùStÜe
 *
¡Üe
)

3665  
Œue
;

3666 
	}
}

3669 
	g¡d
::
¡ršg
 
PG
::
	$g‘_cÜru±_pg_log_Çme
() const

3671 cÚ¡ 
MAX_BUF
 = 512;

3672 
buf
[
MAX_BUF
];

3673 
tm
 
tm_buf
;

3674 
time_t
 
	`my_time
(
	`time
(
NULL
));

3675 cÚ¡ 
tm
 *
t
 = 
	`loÿÉime_r
(&
my_time
, &
tm_buf
);

3676 
»t
 = 
	`¡ráime
(
buf
, (buf), "cÜru±_log_%Y-%m-%d_%k:%M_", 
t
);

3677 ià(
»t
 == 0) {

3678 
	`dout
(0è<< "¡ráimçed" << 
d’dl
;

3681 
¡ršg
 
	`out
(
buf
);

3682 
out
 +ğ
	`¡ršgify
(
šfo
.
pgid
);

3683  
out
;

3684 
	}
}

3686 
	gPG
::
	$»ad_šfo
(

3687 
ObjeùStÜe
 *
¡Üe
, 
¥g_t
 
pgid
, cÚ¡ 
cŞl_t
 &
cŞl
,

3688 
pg_šfo_t
 &
šfo
, 
Pa¡IÁ”v®s
 &
·¡_š‹rv®s
,

3689 
__u8
 &
¡ruù_v
)

3691 
£t
<
¡ršg
> 
keys
;

3692 
keys
.
	`š£¹
(
šfov”_key
);

3693 
keys
.
	`š£¹
(
šfo_key
);

3694 
keys
.
	`š£¹
(
bigšfo_key
);

3695 
keys
.
	`š£¹
(
ç¡šfo_key
);

3696 
ghobjeù_t
 
	`pgm‘a_oid
(
pgid
.
	`make_pgm‘a_oid
());

3697 
m­
<
¡ršg
,
bufã¾i¡
> 
v®ues
;

3698 autØ
ch
 = 
¡Üe
->
	`İ’_cŞËùiÚ
(
cŞl
);

3699 
	`as£¹
(
ch
);

3700 
r
 = 
¡Üe
->
	`om­_g‘_v®ues
(
ch
, 
pgm‘a_oid
, 
keys
, &
v®ues
);

3701 
	`as£¹
(
r
 == 0);

3702 
	`as£¹
(
v®ues
.
	`size
() == 3 ||

3703 
v®ues
.
	`size
() == 4);

3705 
bufã¾i¡
::
™”©Ü
 
p
 = 
v®ues
[
šfov”_key
].
	`begš
();

3706 
	`decode
(
¡ruù_v
, 
p
);

3707 
	`as£¹
(
¡ruù_v
 >= 10);

3709 
p
 = 
v®ues
[
šfo_key
].
	`begš
();

3710 
	`decode
(
šfo
, 
p
);

3712 
p
 = 
v®ues
[
bigšfo_key
].
	`begš
();

3713 
	`decode
(
·¡_š‹rv®s
, 
p
);

3714 
	`decode
(
šfo
.
purged_¢­s
, 
p
);

3716 
p
 = 
v®ues
[
ç¡šfo_key
].
	`begš
();

3717 ià(!
p
.
	`’d
()) {

3718 
pg_ç¡_šfo_t
 
ç¡
;

3719 
	`decode
(
ç¡
, 
p
);

3720 
ç¡
.
	`Œy_­¶y_to
(&
šfo
);

3723 
	}
}

3725 
	gPG
::
	$»ad_¡©e
(
ObjeùStÜe
 *
¡Üe
)

3727 
r
 = 
	`»ad_šfo
(
¡Üe
, 
pg_id
, 
cŞl
, 
šfo
, 
·¡_š‹rv®s
,

3728 
šfo_¡ruù_v
);

3729 
	`as£¹
(
r
 >= 0);

3731 ià(
šfo_¡ruù_v
 < 
com·t_¡ruù_v
) {

3732 
d”r
 << "PG‚eeds upgrade, but on-disk data isoo old; upgradeo"

3733 << "‡ÀŞd” v”siÚ fœ¡." << 
d’dl
;

3734 
	`as£¹
(0 == "PGoo oldo upgrade");

3737 
Ï¡_wr™‹n_šfo
 = 
šfo
;

3739 
o¡ršg¡»am
 
oss
;

3740 
pg_log
.
	`»ad_log_ªd_missšg
(

3741 
¡Üe
,

3742 
ch
,

3743 
pgm‘a_oid
,

3744 
šfo
,

3745 
oss
,

3746 
cù
->
_cÚf
->
osd_ignÜe_¡®e_div”g’t_´iÜs
,

3747 
cù
->
_cÚf
->
osd_debug_v”ify_missšg_Ú_¡¬t
);

3748 ià(
oss
.
	`‹Îp
())

3749 
osd
->
şog
->
	`”rÜ
(è<< 
oss
.
	`¡r
();

3752 
	`log_weœdÃss
();

3754 ià(
šfo_¡ruù_v
 < 
Ï‹¡_¡ruù_v
) {

3755 
	`upg¿de
(
¡Üe
);

3760 
´im¬y
, 
up_´im¬y
;

3761 
veùÜ
<> 
aùšg
, 
up
;

3762 
	`g‘_osdm­
()->
	`pg_to_up_aùšg_osds
(

3763 
pg_id
.
pgid
, &
up
, &
up_´im¬y
, &
aùšg
, &
´im¬y
);

3764 
	`š™_´im¬y_up_aùšg
(

3765 
up
,

3766 
aùšg
,

3767 
up_´im¬y
,

3768 
´im¬y
);

3769 
¼
 = 
OSDM­
::
	`ÿlc_pg_rŞe
(
osd
->
whßmi
, 
aùšg
);

3770 ià(
poŞ
.
šfo
.
	`is_»¶iÿ‹d
(è|| 
¼
 =ğ
pg_whßmi
.
sh¬d
)

3771 
	`£t_rŞe
(
¼
);

3773 
	`£t_rŞe
(-1);

3776 
PG
::
Recov”yCtx
 
	`rùx
(0, 0, 0, 
Ãw
 
ObjeùStÜe
::
T¿n§ùiÚ
);

3777 
	`hªdË_š™Ÿlize
(&
rùx
);

3780 
	`wr™e_if_dœty
(*
rùx
.
Œª§ùiÚ
);

3781 
¡Üe
->
	`queue_Œª§ùiÚ
(
ch
, 
¡d
::
	`move
(*
rùx
.
Œª§ùiÚ
));

3782 
d–‘e
 
rùx
.
Œª§ùiÚ
;

3783 
	}
}

3785 
	gPG
::
	$log_weœdÃss
()

3787 ià(
pg_log
.
	`g‘_
(è!ğ
šfo
.
log_
)

3788 
osd
->
şog
->
	`”rÜ
(è<< 
šfo
.
pgid


3789 << " infØmism©ch,†og. " << 
pg_log
.
	`g‘_
()

3790 << " !ğšfo.log_ " << 
šfo
.
log_
;

3791 ià(
pg_log
.
	`g‘_h—d
(è!ğ
šfo
.
Ï¡_upd©e
)

3792 
osd
->
şog
->
	`”rÜ
(è<< 
šfo
.
pgid


3793 << " infØmism©ch,†og.h—d " << 
pg_log
.
	`g‘_h—d
()

3794 << " !ğšfo.Ï¡_upd©" << 
šfo
.
Ï¡_upd©e
;

3796 ià(!
pg_log
.
	`g‘_log
().
	`em±y
()) {

3798 ià((
pg_log
.
	`g‘_log
().
log
.
	`begš
()->
v”siÚ
 <ğpg_log.
	`g‘_
()))

3799 
osd
->
şog
->
	`”rÜ
(è<< 
šfo
.
pgid


3801 << 
pg_log
.
	`g‘_
(è<< "," <<…g_log.
	`g‘_h—d
() << "]"

3803 << 
pg_log
.
	`g‘_log
().
log
.
	`begš
()->
v”siÚ
 << ","

3804 << 
pg_log
.
	`g‘_log
().
log
.
	`rbegš
()->
v”siÚ
 << "]";

3807 ià(
pg_log
.
	`g‘_log
().
ÿÎ”_İs
.
	`size
(è>…g_log.g‘_log().
log
.size()) {

3808 
osd
->
şog
->
	`”rÜ
(è<< 
šfo
.
pgid


3809 << " c®Ër_İs.siz" << 
pg_log
.
	`g‘_log
().
ÿÎ”_İs
.
	`size
()

3810 << " >†og siz" << 
pg_log
.
	`g‘_log
().
log
.
	`size
();

3812 
	}
}

3814 
	gPG
::
upd©e_¢­_m­
(

3815 cÚ¡ 
veùÜ
<
pg_log_’Œy_t
> &
log_’Œ›s
,

3816 
ObjeùStÜe
::
T¿n§ùiÚ
 &
t
)

3818 
veùÜ
<
pg_log_’Œy_t
>::
cÚ¡_™”©Ü
 
i
 = 
log_’Œ›s
.
begš
();

3819 
	gi
 !ğ
log_’Œ›s
.
’d
();

3820 ++
	gi
) {

3821 
	gOSDriv”
::
OST¿n§ùiÚ
 
_t
(
osdriv”
.
g‘_Œª§ùiÚ
(&
t
));

3822 ià(
	gi
->
	gsoid
.
	g¢­
 < 
	gCEPH_MAXSNAP
) {

3823 ià(
	gi
->
is_d–‘e
()) {

3824 
	gr
 = 
¢­_m­³r
.
»move_oid
(

3825 
i
->
soid
,

3826 &
_t
);

3827 
as£¹
(
r
 == 0);

3828 } ià(
	gi
->
is_upd©e
()) {

3829 
as£¹
(
i
->
¢­s
.
Ëngth
() > 0);

3830 
	gveùÜ
<
	g¢­id_t
> 
	g¢­s
;

3831 
bufã¾i¡
 
	g¢­bl
 = 
i
->
¢­s
;

3832 
	gbufã¾i¡
::
™”©Ü
 
p
 = 
¢­bl
.
begš
();

3833 
	gŒy
 {

3834 
decode
(
¢­s
, 
p
);

3835 } 
ÿtch
 (...) {

3836 
	gd”r
 << 
	g__func__
 << " decod¢­ çu» oÀ" << *
	gi
 << 
	gd’dl
;

3837 
	g¢­s
.
ş—r
();

3839 
	g£t
<
	g¢­id_t
> 
_¢­s
(
¢­s
.
begš
(), sÇps.
’d
());

3841 ià(
	gi
->
is_şÚe
(è|| i->
is_´omÙe
()) {

3842 
	g¢­_m­³r
.
add_oid
(

3843 
i
->
soid
,

3844 
_¢­s
,

3845 &
_t
);

3846 } ià(
	gi
->
is_modify
()) {

3847 
	gr
 = 
¢­_m­³r
.
upd©e_¢­s
(

3848 
i
->
soid
,

3849 
_¢­s
,

3851 &
_t
);

3852 
as£¹
(
r
 == 0);

3854 
as£¹
(
i
->
is_ş—n
());

3864 
	gPG
::
f‹r_¢­c
(
veùÜ
<
¢­id_t
> &
¢­s
)

3867 ià(
¢­_Œimq
.
em±y
(è&& 
šfo
.
purged_¢­s
.empty())

3870 
boŞ
 
	gf‹ršg
 = 
çl£
;

3871 
	gveùÜ
<
	g¢­id_t
> 
	gÃw¢­s
;

3872 
	gveùÜ
<
	g¢­id_t
>::
™”©Ü
 
p
 = 
¢­s
.
begš
();

3873 
	gp
 !ğ
¢­s
.
’d
();

3874 ++
	gp
) {

3875 ià(
	g¢­_Œimq
.
cÚšs
(*
p
è|| 
	gšfo
.
	gpurged_¢­s
.contains(*p)) {

3876 ià(!
	gf‹ršg
) {

3878 
dout
(10è<< "f‹r_¢­øf‹ršg " << 
	g¢­s
 << 
	gd’dl
;

3879 
	gÃw¢­s
.
š£¹
(
Ãw¢­s
.
begš
(), 
¢­s
.begš(), 
p
);

3880 
	gf‹ršg
 = 
Œue
;

3882 
dout
(20è<< "f‹r_¢­ø„emovšgrimq|purged sÇ°" << *
	gp
 << 
	gd’dl
;

3884 ià(
	gf‹ršg
)

3885 
	gÃw¢­s
.
push_back
(*
p
);

3888 ià(
	gf‹ršg
) {

3889 
	g¢­s
.
sw­
(
Ãw¢­s
);

3890 
dout
(10è<< "f‹r_¢­ø„esuÉ " << 
	g¢­s
 << 
	gd’dl
;

3894 
	gPG
::
»queue_objeù_wa™”s
(
m­
<
hobjeù_t
, 
li¡
<
OpReque¡Ref
>>& 
m
)

3896 
	gm­
<
	ghobjeù_t
, 
	gli¡
<
	gOpReque¡Ref
>>::
™”©Ü
 
™
 = 
m
.
begš
();

3897 
	g™
 !ğ
m
.
’d
();

3898 ++
	g™
)

3899 
»queue_İs
(
™
->
£cÚd
);

3900 
	gm
.
ş—r
();

3903 
	gPG
::
	$»queue_İ
(
OpReque¡Ref
 
İ
)

3905 autØ
p
 = 
wa™šg_fÜ_m­
.
	`fšd
(
İ
->
	`g‘_sourû
());

3906 ià(
p
 !ğ
wa™šg_fÜ_m­
.
	`’d
()) {

3907 
	`dout
(20è<< 
__func__
 << " " << 
İ
 << " (wa™šg_fÜ_m­ " << 
p
->
fœ¡
 << ")"

3908 << 
d’dl
;

3909 
p
->
£cÚd
.
	`push_äÚt
(
İ
);

3911 
	`dout
(20è<< 
__func__
 << " " << 
İ
 << 
d’dl
;

3912 
osd
->
	`’queue_äÚt
(

3913 
	`OpQueueI‹m
(

3914 
unique_±r
<
OpQueueI‹m
::
OpQueu—bË
>(
Ãw
 
	`PGOpI‹m
(
šfo
.
pgid
, 
İ
)),

3915 
İ
->
	`g‘_»q
()->
	`g‘_co¡
(),

3916 
İ
->
	`g‘_»q
()->
	`g‘_´iÜ™y
(),

3917 
İ
->
	`g‘_»q
()->
	`g‘_»cv_¡amp
(),

3918 
İ
->
	`g‘_»q
()->
	`g‘_sourû
().
	`num
(),

3919 
	`g‘_osdm­
()->
	`g‘_•och
()));

3921 
	}
}

3923 
	gPG
::
»queue_İs
(
li¡
<
OpReque¡Ref
> &
ls
)

3925 
li¡
<
OpReque¡Ref
>::
»v”£_™”©Ü
 
i
 = 
ls
.
rbegš
();

3926 
	gi
 !ğ
ls
.
»nd
();

3927 ++
	gi
) {

3928 
»queue_İ
(*
i
);

3930 
	gls
.
ş—r
();

3933 
	gPG
::
	$»queue_m­_wa™”s
()

3935 
•och_t
 
•och
 = 
	`g‘_osdm­
()->
	`g‘_•och
();

3936 autØ
p
 = 
wa™šg_fÜ_m­
.
	`begš
();

3937 
p
 !ğ
wa™šg_fÜ_m­
.
	`’d
()) {

3938 ià(
•och
 < 
p
->
£cÚd
.
	`äÚt
()->
mš_•och
) {

3939 
	`dout
(20è<< 
__func__
 << " " << 
p
->
fœ¡
 << " front op "

3940 << 
p
->
£cÚd
.
	`äÚt
() << " must still wait, doing‚othing"

3941 << 
d’dl
;

3942 ++
p
;

3944 
	`dout
(20è<< 
__func__
 << " " << 
p
->
fœ¡
 << " " <<…->
£cÚd
 << 
d’dl
;

3945 autØ
q
 = 
p
->
£cÚd
.
	`rbegš
(); q !ğp->£cÚd.
	`»nd
(); ++q) {

3946 autØ
»q
 = *
q
;

3947 
osd
->
	`’queue_äÚt
(
	`OpQueueI‹m
(

3948 
unique_±r
<
OpQueueI‹m
::
OpQueu—bË
>(
Ãw
 
	`PGOpI‹m
(
šfo
.
pgid
, 
»q
)),

3949 
»q
->
	`g‘_»q
()->
	`g‘_co¡
(),

3950 
»q
->
	`g‘_»q
()->
	`g‘_´iÜ™y
(),

3951 
»q
->
	`g‘_»q
()->
	`g‘_»cv_¡amp
(),

3952 
»q
->
	`g‘_»q
()->
	`g‘_sourû
().
	`num
(),

3953 
•och
));

3955 
p
 = 
wa™šg_fÜ_m­
.
	`”a£
(p);

3958 
	}
}

3986 
boŞ
 
	gPG
::
	$sched_süub
()

3988 
boŞ
 
nod“p_süub
 = 
çl£
;

3989 
	`as£¹
(
	`is_locked
());

3990 ià(!(
	`is_´im¬y
(è&& 
	`is_aùive
(è&& 
	`is_ş—n
(è&& !
	`is_süubbšg
())) {

3991  
çl£
;

3994 
d“p_süub_š‹rv®
 = 0;

3995 
poŞ
.
šfo
.
İts
.
	`g‘
(
poŞ_İts_t
::
DEEP_SCRUB_INTERVAL
, &
d“p_süub_š‹rv®
);

3996 ià(
d“p_süub_š‹rv®
 <= 0) {

3997 
d“p_süub_š‹rv®
 = 
cù
->
_cÚf
->
osd_d“p_süub_š‹rv®
;

3999 
boŞ
 
time_fÜ_d“p
 = 
	`ûph_şock_now
() >=

4000 
šfo
.
hi¡Üy
.
Ï¡_d“p_süub_¡amp
 + 
d“p_süub_š‹rv®
;

4002 
boŞ
 
d“p_coš_æ
 = 
çl£
;

4004 ià(!
süubb”
.
mu¡_süub
)

4005 
d“p_coš_æ
 = (
	`¿nd
(è% 100è< 
cù
->
_cÚf
->
osd_d“p_süub_¿ndomize_¿tio
 * 100;

4006 
	`dout
(20è<< 
__func__
 << ":ime_fÜ_d“p=" << 
time_fÜ_d“p
 << " d“p_coš_æ=" << 
d“p_coš_æ
 << 
d’dl
;

4008 
time_fÜ_d“p
 = (time_fÜ_d“°|| 
d“p_coš_æ
);

4011 ià(
osd
->osd->
	`g‘_osdm­
()->
	`‹¡_æag
(
CEPH_OSDMAP_NODEEP_SCRUB
) ||

4012 
poŞ
.
šfo
.
	`has_æag
(
pg_poŞ_t
::
FLAG_NODEEP_SCRUB
)) {

4013 
time_fÜ_d“p
 = 
çl£
;

4014 
nod“p_süub
 = 
Œue
;

4017 ià(!
süubb”
.
mu¡_süub
) {

4018 
	`as£¹
(!
süubb”
.
mu¡_d“p_süub
);

4021 ià((
osd
->osd->
	`g‘_osdm­
()->
	`‹¡_æag
(
CEPH_OSDMAP_NOSCRUB
) ||

4022 
poŞ
.
šfo
.
	`has_æag
(
pg_poŞ_t
::
FLAG_NOSCRUB
)è&& !
time_fÜ_d“p
) {

4023 ià(
süubb”
.
»£rved
) {

4027 
	`ş—r_süub_»£rved
();

4028 
	`süub_uÄe£rve_»¶iÿs
();

4030  
çl£
;

4034 ià(
cù
->
_cÚf
->
osd_süub_auto_»·œ


4035 && 
	`g‘_pgback’d
()->
	`auto_»·œ_suµÜ‹d
()

4036 && 
time_fÜ_d“p


4038 && !
süubb”
.
mu¡_»·œ


4039 && !
süubb”
.
mu¡_süub


4040 && !
süubb”
.
mu¡_d“p_süub
) {

4041 
	`dout
(20è<< 
__func__
 << ":‡utØ»·œ w™h d“°süubbšg" << 
d’dl
;

4042 
süubb”
.
auto_»·œ
 = 
Œue
;

4046 
süubb”
.
auto_»·œ
 = 
çl£
;

4049 
boŞ
 
»t
 = 
Œue
;

4050 ià(!
süubb”
.
»£rved
) {

4051 
	`as£¹
(
süubb”
.
»£rved_³”s
.
	`em±y
());

4052 ià((
cù
->
_cÚf
->
osd_süub_duršg_»cov”y
 || !
osd
->
	`is_»cov”y_aùive
()) &&

4053 
osd
->
	`šc_süubs_³ndšg
()) {

4054 
	`dout
(20è<< 
__func__
 << ":„e£rved†oÿÎy,„e£rvšg„•liÿs" << 
d’dl
;

4055 
süubb”
.
»£rved
 = 
Œue
;

4056 
süubb”
.
»£rved_³”s
.
	`š£¹
(
pg_whßmi
);

4057 
	`süub_»£rve_»¶iÿs
();

4059 
	`dout
(20è<< 
__func__
 << ": faedØ»£rvloÿÎy" << 
d’dl
;

4060 
»t
 = 
çl£
;

4063 ià(
süubb”
.
»£rved
) {

4064 ià(
süubb”
.
»£rve_çed
) {

4065 
	`dout
(20è<< "sched_süub: faed,‡…“¸deşšed" << 
d’dl
;

4066 
	`ş—r_süub_»£rved
();

4067 
	`süub_uÄe£rve_»¶iÿs
();

4068 
»t
 = 
çl£
;

4069 } ià(
süubb”
.
»£rved_³”s
.
	`size
(è=ğ
aùšg
.size()) {

4070 
	`dout
(20è<< "sched_süub: sucûss,„e£rved s–àªd„•liÿs" << 
d’dl
;

4071 ià(
time_fÜ_d“p
) {

4072 
	`dout
(10è<< "sched_süub: süub wÈbd“p" << 
d’dl
;

4073 
	`¡©e_£t
(
PG_STATE_DEEP_SCRUB
);

4074 } ià(!
süubb”
.
mu¡_d“p_süub
 && 
šfo
.
¡©s
.¡©s.
sum
.
num_d“p_süub_”rÜs
) {

4075 ià(!
nod“p_süub
) {

4076 
osd
->
şog
->
	`šfo
(è<< "osd." << osd->
whßmi


4077 << "…g " << 
šfo
.
pgid


4079 
	`¡©e_£t
(
PG_STATE_DEEP_SCRUB
);

4080 } ià(!
süubb”
.
mu¡_süub
) {

4081 
osd
->
şog
->
	`”rÜ
(è<< "osd." << osd->
whßmi


4082 << "…g " << 
šfo
.
pgid


4084 
	`ş—r_süub_»£rved
();

4085 
	`süub_uÄe£rve_»¶iÿs
();

4086  
çl£
;

4088 
osd
->
şog
->
	`”rÜ
(è<< "osd." << osd->
whßmi


4089 << "…g " << 
šfo
.
pgid


4093 
	`queue_süub
();

4096 
	`dout
(20è<< "sched_süub:„e£rved " << 
süubb”
.
»£rved_³”s
 << ", wa™šg fÜ„•liÿs" << 
d’dl
;

4100  
»t
;

4101 
	}
}

4103 
	gPG
::
	$»g_Ãxt_süub
()

4105 ià(!
	`is_´im¬y
())

4108 
utime_t
 
»g_¡amp
;

4109 
boŞ
 
mu¡
 = 
çl£
;

4110 ià(
süubb”
.
mu¡_süub
 ||

4111 (
šfo
.
¡©s
.
¡©s_šv®id
 && 
cù
->
_cÚf
->
osd_süub_šv®id_¡©s
)) {

4112 
»g_¡amp
 = 
	`ûph_şock_now
();

4113 
mu¡
 = 
Œue
;

4115 
»g_¡amp
 = 
šfo
.
hi¡Üy
.
Ï¡_süub_¡amp
;

4119 
süub_mš_š‹rv®
 = 0, 
süub_max_š‹rv®
 = 0;

4120 
poŞ
.
šfo
.
İts
.
	`g‘
(
poŞ_İts_t
::
SCRUB_MIN_INTERVAL
, &
süub_mš_š‹rv®
);

4121 
poŞ
.
šfo
.
İts
.
	`g‘
(
poŞ_İts_t
::
SCRUB_MAX_INTERVAL
, &
süub_max_š‹rv®
);

4122 
	`as£¹
(
süubb”
.
süub_»g_¡amp
 =ğ
	`utime_t
());

4123 
süubb”
.
süub_»g_¡amp
 = 
osd
->
	`»g_pg_süub
(
šfo
.
pgid
,

4124 
»g_¡amp
,

4125 
süub_mš_š‹rv®
,

4126 
süub_max_š‹rv®
,

4127 
mu¡
);

4128 
	}
}

4130 
	gPG
::
	$uÄeg_Ãxt_süub
()

4132 ià(
	`is_´im¬y
()) {

4133 
osd
->
	`uÄeg_pg_süub
(
šfo
.
pgid
, 
süubb”
.
süub_»g_¡amp
);

4134 
süubb”
.
süub_»g_¡amp
 = 
	`utime_t
();

4136 
	}
}

4138 
	gPG
::
	$do_»¶iÿ_süub_m­
(
OpReque¡Ref
 
İ
)

4140 cÚ¡ 
MOSDR•SüubM­
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDR•SüubM­*>(
İ
->
	`g‘_»q
());

4141 
	`dout
(7è<< 
__func__
 << " " << *
m
 << 
d’dl
;

4142 ià(
m
->
m­_•och
 < 
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû
) {

4143 
	`dout
(10è<< 
__func__
 << " discarding old from "

4144 << 
m
->
m­_•och
 << " < " << 
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû


4145 << 
d’dl
;

4148 ià(!
süubb”
.
	`is_chunky_süub_aùive
()) {

4149 
	`dout
(10è<< 
__func__
 << " süub i¢'ˆaùive" << 
d’dl
;

4153 
İ
->
	`m¬k_¡¬‹d
();

4155 
bufã¾i¡
::
™”©Ü
 
p
 = 
cÚ¡_ÿ¡
<bufã¾i¡&>(
m
->
	`g‘_d©a
()).
	`begš
();

4156 
süubb”
.
»ûived_m­s
[
m
->
äom
].
	`decode
(
p
, 
šfo
.
pgid
.
	`poŞ
());

4157 
	`dout
(10) << "map version is "

4158 << 
süubb”
.
»ûived_m­s
[
m
->
äom
].
v®id_through


4159 << 
d’dl
;

4161 
	`dout
(10è<< 
__func__
 << " wa™šg_Ú_whom wa " << 
süubb”
.
wa™šg_Ú_whom


4162 << 
d’dl
;

4163 
	`as£¹
(
süubb”
.
wa™šg_Ú_whom
.
	`couÁ
(
m
->
äom
));

4164 
süubb”
.
wa™šg_Ú_whom
.
	`”a£
(
m
->
äom
);

4165 ià(
m
->
´“m±ed
) {

4166 
	`dout
(10è<< 
__func__
 << "„•liÿ wa ´“m±ed, s‘tšg fÏg" << 
d’dl
;

4167 
süub_´“m±ed
 = 
Œue
;

4169 ià(
süubb”
.
wa™šg_Ú_whom
.
	`em±y
()) {

4170 
	`»queue_süub
(
	`İs_blocked_by_süub
());

4172 
	}
}

4175 
	gPG
::
	$_»que¡_süub_m­
(

4176 
pg_sh¬d_t
 
»¶iÿ
, 
ev”siÚ_t
 
v”siÚ
,

4177 
hobjeù_t
 
¡¬t
, hobjeù_ˆ
’d
,

4178 
boŞ
 
d“p
,

4179 
boŞ
 
®low_´“m±iÚ
)

4181 
	`as£¹
(
»¶iÿ
 !ğ
pg_whßmi
);

4182 
	`dout
(10è<< "süub„eque¡šg süubm­ from osd." << 
»¶iÿ


4183 << " d“°" << ()
d“p
 << 
d’dl
;

4184 
MOSDR•Süub
 *
»psüubİ
 = 
Ãw
 
	`MOSDR•Süub
(

4185 
	`¥g_t
(
šfo
.
pgid
.pgid, 
»¶iÿ
.
sh¬d
), 
v”siÚ
,

4186 
	`g‘_osdm­
()->
	`g‘_•och
(),

4187 
	`g‘_Ï¡_³”šg_»£t
(),

4188 
¡¬t
, 
’d
, 
d“p
,

4189 
®low_´“m±iÚ
,

4190 
süubb”
.
´iÜ™y
,

4191 
	`İs_blocked_by_süub
());

4194 
osd
->
	`£nd_mes§ge_osd_şu¡”
(

4195 
»¶iÿ
.
osd
, 
»psüubİ
, 
	`g‘_osdm­
()->
	`g‘_•och
());

4196 
	}
}

4198 
	gPG
::
	$hªdË_süub_»£rve_»que¡
(
OpReque¡Ref
 
İ
)

4200 
	`dout
(7è<< 
__func__
 << " " << *
İ
->
	`g‘_»q
(è<< 
d’dl
;

4201 
İ
->
	`m¬k_¡¬‹d
();

4202 ià(
süubb”
.
»£rved
) {

4203 
	`dout
(10è<< 
__func__
 << " ignoring„eserve„equest: Already„eserved"

4204 << 
d’dl
;

4207 ià((
cù
->
_cÚf
->
osd_süub_duršg_»cov”y
 || !
osd
->
	`is_»cov”y_aùive
()) &&

4208 
osd
->
	`šc_süubs_³ndšg
()) {

4209 
süubb”
.
»£rved
 = 
Œue
;

4211 
	`dout
(20è<< 
__func__
 << ": faedØ»£rv»mÙ–y" << 
d’dl
;

4212 
süubb”
.
»£rved
 = 
çl£
;

4214 cÚ¡ 
MOSDSüubRe£rve
 *
m
 =

4215 
¡©ic_ÿ¡
<cÚ¡ 
MOSDSüubRe£rve
*>(
İ
->
	`g‘_»q
());

4216 
Mes§ge
 *
»¶y
 = 
Ãw
 
	`MOSDSüubRe£rve
(

4217 
	`¥g_t
(
šfo
.
pgid
.pgid, 
´im¬y
.
sh¬d
),

4218 
m
->
m­_•och
,

4219 
süubb”
.
»£rved
 ? 
MOSDSüubRe£rve
::
GRANT
 : MOSDSüubRe£rve::
REJECT
,

4220 
pg_whßmi
);

4221 
osd
->
	`£nd_mes§ge_osd_şu¡”
(
»¶y
, 
İ
->
	`g‘_»q
()->
	`g‘_cÚÃùiÚ
());

4222 
	}
}

4224 
	gPG
::
	$hªdË_süub_»£rve_g¿Á
(
OpReque¡Ref
 
İ
, 
pg_sh¬d_t
 
äom
)

4226 
	`dout
(7è<< 
__func__
 << " " << *
İ
->
	`g‘_»q
(è<< 
d’dl
;

4227 
İ
->
	`m¬k_¡¬‹d
();

4228 ià(!
süubb”
.
»£rved
) {

4229 
	`dout
(10è<< "ignÜšg obsŞ‘süub„e£rv»¶y" << 
d’dl
;

4232 ià(
süubb”
.
»£rved_³”s
.
	`fšd
(
äom
è!ğsüubb”.»£rved_³”s.
	`’d
()) {

4233 
	`dout
(10è<< "‡Ì—dy had osd." << 
äom
 << "„e£rved" << 
d’dl
;

4235 
	`dout
(10è<< " osd." << 
äom
 << " süub„e£rvğsucûss" << 
d’dl
;

4236 
süubb”
.
»£rved_³”s
.
	`š£¹
(
äom
);

4237 
	`sched_süub
();

4239 
	}
}

4241 
	gPG
::
	$hªdË_süub_»£rve_»jeù
(
OpReque¡Ref
 
İ
, 
pg_sh¬d_t
 
äom
)

4243 
	`dout
(7è<< 
__func__
 << " " << *
İ
->
	`g‘_»q
(è<< 
d’dl
;

4244 
İ
->
	`m¬k_¡¬‹d
();

4245 ià(!
süubb”
.
»£rved
) {

4246 
	`dout
(10è<< "ignÜšg obsŞ‘süub„e£rv»¶y" << 
d’dl
;

4249 ià(
süubb”
.
»£rved_³”s
.
	`fšd
(
äom
è!ğsüubb”.»£rved_³”s.
	`’d
()) {

4250 
	`dout
(10è<< "‡Ì—dy had osd." << 
äom
 << "„e£rved" << 
d’dl
;

4253 
	`dout
(10è<< " osd." << 
äom
 << " süub„e£rvğç" << 
d’dl
;

4254 
süubb”
.
»£rve_çed
 = 
Œue
;

4255 
	`sched_süub
();

4257 
	}
}

4259 
	gPG
::
	$hªdË_süub_»£rve_»Ëa£
(
OpReque¡Ref
 
İ
)

4261 
	`dout
(7è<< 
__func__
 << " " << *
İ
->
	`g‘_»q
(è<< 
d’dl
;

4262 
İ
->
	`m¬k_¡¬‹d
();

4263 
	`ş—r_süub_»£rved
();

4264 
	}
}

4266 
	gPG
::
	$»jeù_»£rv©iÚ
()

4268 
osd
->
	`£nd_mes§ge_osd_şu¡”
(

4269 
´im¬y
.
osd
,

4270 
Ãw
 
	`MBackflRe£rve
(

4271 
MBackflRe£rve
::
REJECT
,

4272 
	`¥g_t
(
šfo
.
pgid
.pgid, 
´im¬y
.
sh¬d
),

4273 
	`g‘_osdm­
()->
	`g‘_•och
()),

4274 
	`g‘_osdm­
()->
	`g‘_•och
());

4275 
	}
}

4277 
	gPG
::
	$scheduË_backfl_»Œy
(
d–ay
)

4279 
Mu‹x
::
Lock”
 
	`lock
(
osd
->
»cov”y_»que¡_lock
);

4280 
osd
->
»cov”y_»que¡_tim”
.
	`add_ev’t_aá”
(

4281 
d–ay
,

4282 
Ãw
 
QueueP“ršgEvt
<
Reque¡Backfl
>(

4283 
this
, 
	`g‘_osdm­
()->
	`g‘_•och
(),

4284 
	`Reque¡Backfl
()));

4285 
	}
}

4287 
	gPG
::
	$scheduË_»cov”y_»Œy
(
d–ay
)

4289 
Mu‹x
::
Lock”
 
	`lock
(
osd
->
»cov”y_»que¡_lock
);

4290 
osd
->
»cov”y_»que¡_tim”
.
	`add_ev’t_aá”
(

4291 
d–ay
,

4292 
Ãw
 
QueueP“ršgEvt
<
DoRecov”y
>(

4293 
this
, 
	`g‘_osdm­
()->
	`g‘_•och
(),

4294 
	`DoRecov”y
()));

4295 
	}
}

4297 
	gPG
::
	$ş—r_süub_»£rved
()

4299 
süubb”
.
»£rved_³”s
.
	`ş—r
();

4300 
süubb”
.
»£rve_çed
 = 
çl£
;

4302 ià(
süubb”
.
»£rved
) {

4303 
süubb”
.
»£rved
 = 
çl£
;

4304 
osd
->
	`dec_süubs_³ndšg
();

4306 
	}
}

4308 
	gPG
::
	$süub_»£rve_»¶iÿs
()

4310 
	`as£¹
(
backfl_rg‘s
.
	`em±y
());

4311 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
aùšg_»cov”y_backfl
.
	`begš
();

4312 
i
 !ğ
aùšg_»cov”y_backfl
.
	`’d
();

4313 ++
i
) {

4314 ià(*
i
 =ğ
pg_whßmi
) ;

4315 
	`dout
(10è<< "süub„eque¡šg„e£rväom osd." << *
i
 << 
d’dl
;

4316 
osd
->
	`£nd_mes§ge_osd_şu¡”
(

4317 
i
->
osd
,

4318 
Ãw
 
	`MOSDSüubRe£rve
(
	`¥g_t
(
šfo
.
pgid
.pgid, 
i
->
sh¬d
),

4319 
	`g‘_osdm­
()->
	`g‘_•och
(),

4320 
MOSDSüubRe£rve
::
REQUEST
, 
pg_whßmi
),

4321 
	`g‘_osdm­
()->
	`g‘_•och
());

4323 
	}
}

4325 
	gPG
::
	$süub_uÄe£rve_»¶iÿs
()

4327 
	`as£¹
(
backfl_rg‘s
.
	`em±y
());

4328 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
aùšg_»cov”y_backfl
.
	`begš
();

4329 
i
 !ğ
aùšg_»cov”y_backfl
.
	`’d
();

4330 ++
i
) {

4331 ià(*
i
 =ğ
pg_whßmi
) ;

4332 
	`dout
(10è<< "süub„eque¡šg uÄe£rväom osd." << *
i
 << 
d’dl
;

4333 
osd
->
	`£nd_mes§ge_osd_şu¡”
(

4334 
i
->
osd
,

4335 
Ãw
 
	`MOSDSüubRe£rve
(
	`¥g_t
(
šfo
.
pgid
.pgid, 
i
->
sh¬d
),

4336 
	`g‘_osdm­
()->
	`g‘_•och
(),

4337 
MOSDSüubRe£rve
::
RELEASE
, 
pg_whßmi
),

4338 
	`g‘_osdm­
()->
	`g‘_•och
());

4340 
	}
}

4342 
	gPG
::
_sÿn_rŞlback_obs
(cÚ¡ 
veùÜ
<
ghobjeù_t
> &
rŞlback_obs
)

4344 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

4345 
ev”siÚ_t
 
	gŒimmed_to
 = 
Ï¡_rŞlback_šfo_Œimmed_to_­¶›d
;

4346 
	gveùÜ
<
	gghobjeù_t
>::
cÚ¡_™”©Ü
 
i
 = 
rŞlback_obs
.
begš
();

4347 
	gi
 !ğ
rŞlback_obs
.
’d
();

4348 ++
	gi
) {

4349 ià(
	gi
->
	gg’”©iÚ
 < 
	gŒimmed_to
.
	gv”siÚ
) {

4350 
	gosd
->
	gşog
->
”rÜ
(è<< "osd." << osd->
	gwhßmi


4351 << "…g " << 
	gšfo
.
	gpgid


4353 << *
	gi
 << " generation <rimmed_to "

4354 << 
	gŒimmed_to


4356 
	gt
.
»move
(
cŞl
, *
i
);

4359 ià(!
	gt
.
em±y
()) {

4360 
	gd”r
 << 
	g__func__
 << ": queueingranso clean up obsolete„ollback objs"

4361 << 
	gd’dl
;

4362 
	gosd
->
	g¡Üe
->
queue_Œª§ùiÚ
(
ch
, 
¡d
::
move
(
t
), 
NULL
);

4366 
	gPG
::
	$_sÿn_¢­s
(
SüubM­
 &
sm­
)

4368 
hobjeù_t
 
h—d
;

4369 
SÇpS‘
 
¢­£t
;

4373 
	`dout
(20è<< 
__func__
 << " s¹" << 
d’dl
;

4375 
m­
<
hobjeù_t
, 
SüubM­
::
objeù
>::
»v”£_™”©Ü
 
i
 = 
sm­
.
objeùs
.
	`rbegš
();

4376 
i
 !ğ
sm­
.
objeùs
.
	`»nd
();

4377 ++
i
) {

4378 cÚ¡ 
hobjeù_t
 &
hoid
 = 
i
->
fœ¡
;

4379 
SüubM­
::
objeù
 &
o
 = 
i
->
£cÚd
;

4381 
	`dout
(20è<< 
__func__
 << " " << 
hoid
 << 
d’dl
;

4383 
	`as£¹
(!
hoid
.
	`is_¢­dœ
());

4384 ià(
hoid
.
	`is_h—d
()) {

4386 
bufã¾i¡
 
bl
;

4387 ià(
o
.
©Œs
.
	`fšd
(
SS_ATTR
è=ğo.©Œs.
	`’d
()) {

4390 
bl
.
	`push_back
(
o
.
©Œs
[
SS_ATTR
]);

4391 autØ
p
 = 
bl
.
	`begš
();

4392 
Œy
 {

4393 
	`decode
(
¢­£t
, 
p
);

4394 } 
	`ÿtch
(...) {

4397 
h—d
 = 
hoid
.
	`g‘_h—d
();

4400 ià(
hoid
.
¢­
 < 
CEPH_MAXSNAP
) {

4402 ià(
hoid
.
	`g‘_h—d
(è!ğ
h—d
) {

4403 
d”r
 << 
__func__
 << "‚Øh—d fÜ " << 
hoid
 << " (hav" << 
h—d
 << ")"

4404 << 
d’dl
;

4407 
£t
<
¢­id_t
> 
obj_¢­s
;

4408 autØ
p
 = 
¢­£t
.
şÚe_¢­s
.
	`fšd
(
hoid
.
¢­
);

4409 ià(
p
 =ğ
¢­£t
.
şÚe_¢­s
.
	`’d
()) {

4410 
d”r
 << 
__func__
 << "‚ØşÚe_¢­ fÜ " << 
hoid
 << " iÀ" << 
¢­£t


4411 << 
d’dl
;

4414 
obj_¢­s
.
	`š£¹
(
p
->
£cÚd
.
	`begš
(),…->£cÚd.
	`’d
());

4415 
£t
<
¢­id_t
> 
cur_¢­s
;

4416 
r
 = 
¢­_m­³r
.
	`g‘_¢­s
(
hoid
, &
cur_¢­s
);

4417 ià(
r
 !ğ0 &&„ !ğ-
ENOENT
) {

4418 
d”r
 << 
__func__
 << ": g‘_¢­ »tuºed " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

4419 
	`ûph_abÜt
();

4421 ià(
r
 =ğ-
ENOENT
 || 
cur_¢­s
 !ğ
obj_¢­s
) {

4422 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

4423 
OSDriv”
::
OST¿n§ùiÚ
 
	`_t
(
osdriv”
.
	`g‘_Œª§ùiÚ
(&
t
));

4424 ià(
r
 == 0) {

4425 
r
 = 
¢­_m­³r
.
	`»move_oid
(
hoid
, &
_t
);

4426 ià(
r
 != 0) {

4427 
d”r
 << 
__func__
 << ":„emove_oid„‘uºed " << 
	`ıp_¡»¼Ü
(
r
)

4428 << 
d’dl
;

4429 
	`ûph_abÜt
();

4431 
osd
->
şog
->
	`”rÜ
(è<< "osd." << osd->
whßmi


4433 << 
šfo
.
pgid


4434 << " oid " << 
hoid
 << " snaps in mapper: "

4435 << 
cur_¢­s
 << ", oi: "

4436 << 
obj_¢­s


4439 
osd
->
şog
->
	`”rÜ
(è<< "osd." << osd->
whßmi


4441 << 
šfo
.
pgid


4442 << " oid " << 
hoid
 << " snaps missing in mapper"

4444 << 
obj_¢­s


4445 << " wa " << 
cur_¢­s
 << "„ " << 
r


4448 
¢­_m­³r
.
	`add_oid
(
hoid
, 
obj_¢­s
, &
_t
);

4452 
CÚd
 
my_cÚd
;

4453 
Mu‹x
 
	`my_lock
("PG::_scan_snaps my_lock");

4454 
r
 = 0;

4455 
boŞ
 
dÚe
;

4456 
t
.
	`»gi¡”_Ú_­¶›d_sync
(

4457 
Ãw
 
	`C_SaãCÚd
(&
my_lock
, &
my_cÚd
, &
dÚe
, &
r
));

4458 
r
 = 
osd
->
¡Üe
->
	`queue_Œª§ùiÚ
(
ch
, 
¡d
::
	`move
(
t
));

4459 ià(
r
 != 0) {

4460 
d”r
 << 
__func__
 << ": queue_Œª§ùiÚ gÙ " << 
	`ıp_¡»¼Ü
(
r
)

4461 << 
d’dl
;

4463 
my_lock
.
	`Lock
();

4464 !
dÚe
)

4465 
my_cÚd
.
	`Wa™
(
my_lock
);

4466 
my_lock
.
	`UÆock
();

4472 
	}
}

4474 
	gPG
::
	$_»·œ_ošfo_oid
(
SüubM­
 &
sm­
)

4476 
m­
<
hobjeù_t
, 
SüubM­
::
objeù
>::
»v”£_™”©Ü
 
i
 = 
sm­
.
objeùs
.
	`rbegš
();

4477 
i
 !ğ
sm­
.
objeùs
.
	`»nd
();

4478 ++
i
) {

4479 cÚ¡ 
hobjeù_t
 &
hoid
 = 
i
->
fœ¡
;

4480 
SüubM­
::
objeù
 &
o
 = 
i
->
£cÚd
;

4482 
bufã¾i¡
 
bl
;

4483 ià(
o
.
©Œs
.
	`fšd
(
OI_ATTR
è=ğo.©Œs.
	`’d
()) {

4486 
bl
.
	`push_back
(
o
.
©Œs
[
OI_ATTR
]);

4487 
objeù_šfo_t
 
oi
;

4488 
Œy
 {

4489 
oi
.
	`decode
(
bl
);

4490 } 
	`ÿtch
(...) {

4493 ià(
oi
.
soid
 !ğ
hoid
) {

4494 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

4495 
OSDriv”
::
OST¿n§ùiÚ
 
	`_t
(
osdriv”
.
	`g‘_Œª§ùiÚ
(&
t
));

4496 
osd
->
şog
->
	`”rÜ
(è<< "osd." << osd->
whßmi


4498 << 
šfo
.
pgid


4499 << " oid " << 
hoid
 << " oid in object info: "

4500 << 
oi
.
soid


4503 
oi
.
soid
 = 
hoid
;

4504 
bl
.
	`ş—r
();

4505 
	`’code
(
oi
, 
bl
, 
	`g‘_osdm­
()->
	`g‘_ã©u»s
(
CEPH_ENTITY_TYPE_OSD
, 
nuÎ±r
));

4507 
bufã½Œ
 
	`bp
(
bl
.
	`c_¡r
(), bl.
	`Ëngth
());

4508 
o
.
©Œs
[
OI_ATTR
] = 
bp
;

4510 
t
.
	`£‰r
(
cŞl
, 
	`ghobjeù_t
(
hoid
), 
OI_ATTR
, 
bl
);

4511 
r
 = 
osd
->
¡Üe
->
	`queue_Œª§ùiÚ
(
ch
, 
¡d
::
	`move
(
t
));

4512 ià(
r
 != 0) {

4513 
d”r
 << 
__func__
 << ": queue_Œª§ùiÚ gÙ " << 
	`ıp_¡»¼Ü
(
r
)

4514 << 
d’dl
;

4518 
	}
}

4519 
	gPG
::
	$bud_süub_m­_chunk
(

4520 
SüubM­
 &
m­
,

4521 
SüubM­Bud”
 &
pos
,

4522 
hobjeù_t
 
¡¬t
,

4523 
hobjeù_t
 
’d
,

4524 
boŞ
 
d“p
,

4525 
Th»adPoŞ
::
TPHªdË
 &
hªdË
)

4527 
	`dout
(10è<< 
__func__
 << " [" << 
¡¬t
 << "," << 
’d
 << ") "

4528 << "…o " << 
pos


4529 << 
d’dl
;

4532 
pos
.
	`em±y
()) {

4533 
pos
.
d“p
 = deep;

4534 
m­
.
v®id_through
 = 
šfo
.
Ï¡_upd©e
;

4537 
veùÜ
<
ghobjeù_t
> 
rŞlback_obs
;

4538 
pos
.
»t
 = 
	`g‘_pgback’d
()->
	`objeùs_li¡_¿nge
(

4539 
¡¬t
,

4540 
’d
,

4541 &
pos
.
ls
,

4542 &
rŞlback_obs
);

4543 ià(
pos
.
»t
 < 0) {

4544 
	`dout
(5è<< "objeùs_li¡_¿ng”rÜ: " << 
pos
.
»t
 << 
d’dl
;

4545  
pos
.
»t
;

4547 ià(
pos
.
ls
.
	`em±y
()) {

4550 
	`_sÿn_rŞlback_obs
(
rŞlback_obs
);

4551 
pos
.pos = 0;

4552  -
EINPROGRESS
;

4556 !
pos
.
	`dÚe
()) {

4557 
r
 = 
	`g‘_pgback’d
()->
	`be_sÿn_li¡
(
m­
, 
pos
);

4558 ià(
r
 =ğ-
EINPROGRESS
) {

4559  
r
;

4564 
	`dout
(20è<< 
__func__
 << " fšishšg" << 
d’dl
;

4565 
	`as£¹
(
pos
.
	`dÚe
());

4566 
	`_»·œ_ošfo_oid
(
m­
);

4567 ià(!
	`is_´im¬y
()) {

4568 
SüubM­
 
fÜ_m‘a_süub
;

4569 
süubb”
.
ş—Ãd_m‘a_m­
.
	`š£¹
(
m­
);

4570 
süubb”
.
	`ş—n_m‘a_m­
(
fÜ_m‘a_süub
);

4571 
	`_sÿn_¢­s
(
fÜ_m‘a_süub
);

4574 
	`dout
(20è<< 
__func__
 << " dÚe, gÙ " << 
m­
.
objeùs
.
	`size
() << " items"

4575 << 
d’dl
;

4577 
	}
}

4579 
	gPG
::
Süubb”
::
	$ş—nup_¡Üe
(
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
) {

4580 ià(!
¡Üe
)

4582 
OnCom¶‘e
 : 
CÚ‹xt
 {

4583 
¡d
::
unique_±r
<
Süub
::
StÜe
> 
¡Üe
;

4584 
ex¶ic™
 
	`OnCom¶‘e
(

4585 
¡d
::
unique_±r
<
Süub
::
StÜe
> &&
¡Üe
)

4586 : 
	`¡Üe
(
¡d
::
	`move
(
¡Üe
)) {}

4587 
	`fšish
(è
ov”ride
 {}

4589 
¡Üe
->
	`ş—nup
(
t
);

4590 
t
->
	`»gi¡”_Ú_com¶‘e
(
Ãw
 
	`OnCom¶‘e
(
¡d
::
	`move
(
¡Üe
)));

4591 
	`as£¹
(!
¡Üe
);

4592 
	}
}

4594 
	gPG
::
»·œ_objeù
(

4595 cÚ¡ 
hobjeù_t
& 
soid
, 
li¡
<
·œ
<
SüubM­
::
objeù
, 
pg_sh¬d_t
> > *
ok_³”s
,

4596 
pg_sh¬d_t
 
bad_³”
)

4598 
	gli¡
<
	gpg_sh¬d_t
> 
	gİ_sh¬ds
;

4599 autØ
	gi
 : *
ok_³”s
) {

4600 
İ_sh¬ds
.
push_back
(
i
.
£cÚd
);

4602 
dout
(10è<< "»·œ_objeù " << 
	gsoid
 << " bad_peer osd."

4603 << 
	gbad_³”
 << " ok_³” osd.{" << 
	gİ_sh¬ds
 << "}" << 
	gd’dl
;

4604 
	gSüubM­
::
objeù
 &
po
 = 
ok_³”s
->
back
().
fœ¡
;

4605 
ev”siÚ_t
 
	gv
;

4606 
bufã¾i¡
 
	gbv
;

4607 
	gbv
.
push_back
(
po
.
©Œs
[
OI_ATTR
]);

4608 
objeù_šfo_t
 
	goi
;

4609 
	gŒy
 {

4610 
	gbufã¾i¡
::
™”©Ü
 
bl™”
 = 
bv
.
begš
();

4611 
decode
(
oi
, 
bl™”
);

4612 } 
ÿtch
 (...) {

4613 
dout
(0è<< 
	g__func__
 << ": N“d v”siÚ oà»¶iÿ, bad objeù_šfo_t: " << 
	gsoid
 << 
	gd’dl
;

4614 
as£¹
(0);

4616 ià(
	gbad_³”
 !ğ
´im¬y
) {

4617 
³”_missšg
[
bad_³”
].
add
(
soid
, 
oi
.
v”siÚ
, 
ev”siÚ_t
(), 
çl£
);

4620 
as£¹
(
wa™šg_fÜ_uÄ—dabË_objeù
.
em±y
());

4622 
	gpg_log
.
missšg_add
(
soid
, 
oi
.
v”siÚ
, 
ev”siÚ_t
());

4624 
	gpg_log
.
£t_Ï¡_»que¡ed
(0);

4625 
dout
(10è<< 
	g__func__
 << ":…rim¬y = " << 
	g´im¬y
 << 
	gd’dl
;

4628 ià(
is_ec_pg
(è|| 
	gbad_³”
 =ğ
´im¬y
) {

4631 
missšg_loc
.
add_missšg
(
soid
, 
oi
.
v”siÚ
, 
ev”siÚ_t
());

4632 
	gli¡
<
	g·œ
<
	gSüubM­
::
objeù
, 
	gpg_sh¬d_t
> >::
™”©Ü
 
i
;

4633 
	gi
 = 
ok_³”s
->
begš
();

4634 
	gi
 !ğ
ok_³”s
->
’d
();

4635 ++
	gi
)

4636 
	gmissšg_loc
.
add_loÿtiÚ
(
soid
, 
i
->
£cÚd
);

4646 
	gPG
::
	$»¶iÿ_süub
(

4647 
OpReque¡Ref
 
İ
,

4648 
Th»adPoŞ
::
TPHªdË
 &
hªdË
)

4650 cÚ¡ 
MOSDR•Süub
 *
msg
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDR•Süub *>(
İ
->
	`g‘_»q
());

4651 
	`as£¹
(!
süubb”
.
aùive_»p_süub
);

4652 
	`dout
(7è<< "»¶iÿ_süub" << 
d’dl
;

4654 ià(
msg
->
m­_•och
 < 
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû
) {

4655 
	`dout
(10) << "replica_scrub discarding old„eplica_scrub from "

4656 << 
msg
->
m­_•och
 << " < " << 
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû


4657 << 
d’dl
;

4661 
	`as£¹
(
msg
->
chunky
);

4662 ià(
aùive_pushes
 > 0) {

4663 
	`dout
(10è<< "wa™šg fÜ‡ùivpushe tØfšish" << 
d’dl
;

4664 
süubb”
.
aùive_»p_süub
 = 
İ
;

4668 
süubb”
.
¡©e
 = 
Süubb”
::
BUILD_MAP_REPLICA
;

4669 
süubb”
.
»¶iÿ_süub_¡¬t
 = 
msg
->
mš_•och
;

4670 
süubb”
.
¡¬t
 = 
msg
->start;

4671 
süubb”
.
’d
 = 
msg
->end;

4672 
süubb”
.
d“p
 = 
msg
->deep;

4673 
süubb”
.
•och_¡¬t
 = 
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû
;

4674 ià(
msg
->
´iÜ™y
) {

4675 
süubb”
.
´iÜ™y
 = 
msg
->priority;

4677 
süubb”
.
´iÜ™y
 = 
	`g‘_süub_´iÜ™y
();

4680 
süub_ÿn_´“m±
 = 
msg
->
®low_´“m±iÚ
;

4681 
süub_´“m±ed
 = 
çl£
;

4682 
süubb”
.
»¶iÿ_süubm­_pos
.
	`»£t
();

4684 
	`»queue_süub
(
msg
->
high_´iÜ™y
);

4685 
	}
}

4693 
	gPG
::
	$süub
(
•och_t
 
queued
, 
Th»adPoŞ
::
TPHªdË
 &
hªdË
)

4695 ià(
cù
->
_cÚf
->
osd_süub_¦“p
 > 0 &&

4696 (
süubb”
.
¡©e
 =ğ
PG
::
Süubb”
::
NEW_CHUNK
 ||

4697 
süubb”
.
¡©e
 =ğ
PG
::
Süubb”
::
INACTIVE
) &&

4698 
süubb”
.
Ãeds_¦“p
) {

4699 
	`ûph_as£¹
(!
süubb”
.
¦“pšg
);

4700 
	`dout
(20è<< 
__func__
 << " s‹ i INACTIVE|NEW_CHUNK, sË•šg" << 
d’dl
;

4703 
OSDS”viû
 *
osds
 = 
osd
;

4704 
¥g_t
 
pgid
 = 
	`g‘_pgid
();

4705 
¡©e
 = 
süubb”
.state;

4706 autØ
süub_»queue_ÿÎback
 =

4707 
Ãw
 
	`FunùiÚCÚ‹xt
([
osds
, 
pgid
, 
¡©e
](
r
) {

4708 
PGRef
 
pg
 = 
osds
->
osd
->
	`lookup_lock_pg
(
pgid
);

4709 ià(
pg
 =ğ
nuÎ±r
) {

4710 
	`lg’”ic_dout
(
osds
->
osd
->
cù
, 20)

4712 << "PG " << 
pgid
 << " can't complete scrub„equeue‡fter sleep"

4713 << 
d’dl
;

4716 
pg
->
süubb”
.
¦“pšg
 = 
çl£
;

4717 
pg
->
süubb”
.
Ãeds_¦“p
 = 
çl£
;

4718 
	`lg’”ic_dout
(
pg
->
cù
, 20)

4720 << 
	`ûph_şock_now
(è- 
pg
->
süubb”
.
¦“p_¡¬t


4721 << ",„e-queušg süub w™h s‹ " << 
¡©e
 << 
d’dl
;

4722 
pg
->
süub_queued
 = 
çl£
;

4723 
pg
->
	`»queue_süub
();

4724 
pg
->
süubb”
.
¦“p_¡¬t
 = 
	`utime_t
();

4725 
pg
->
	`uÆock
();

4727 
Mu‹x
::
Lock”
 
	`l
(
osd
->
süub_¦“p_lock
);

4728 
osd
->
süub_¦“p_tim”
.
	`add_ev’t_aá”
(
cù
->
_cÚf
->
osd_süub_¦“p
,

4729 
süub_»queue_ÿÎback
);

4730 
süubb”
.
¦“pšg
 = 
Œue
;

4731 
süubb”
.
¦“p_¡¬t
 = 
	`ûph_şock_now
();

4734 ià(
	`pg_has_»£t_sšû
(
queued
)) {

4737 
	`as£¹
(
süub_queued
);

4738 
süub_queued
 = 
çl£
;

4739 
süubb”
.
Ãeds_¦“p
 = 
Œue
;

4742 ià(!
	`is_´im¬y
() &&

4743 
süubb”
.
¡©e
 =ğ
PG
::
Süubb”
::
BUILD_MAP_REPLICA
) {

4744 
	`chunky_süub
(
hªdË
);

4748 ià(!
	`is_´im¬y
(è|| !
	`is_aùive
(è|| !
	`is_ş—n
(è|| !
	`is_süubbšg
()) {

4749 
	`dout
(10è<< "süub --‚Ù…rim¬y o¸aùivÜ‚Ù cËª" << 
d’dl
;

4750 
	`¡©e_ş—r
(
PG_STATE_SCRUBBING
);

4751 
	`¡©e_ş—r
(
PG_STATE_REPAIR
);

4752 
	`¡©e_ş—r
(
PG_STATE_DEEP_SCRUB
);

4753 
	`publish_¡©s_to_osd
();

4757 ià(!
süubb”
.
aùive
) {

4758 
	`as£¹
(
backfl_rg‘s
.
	`em±y
());

4760 
süubb”
.
d“p
 = 
	`¡©e_‹¡
(
PG_STATE_DEEP_SCRUB
);

4762 
	`dout
(10è<< "¡¬tšg‡‚ew chunky süub" << 
d’dl
;

4765 
	`chunky_süub
(
hªdË
);

4766 
	}
}

4846 
	gPG
::
	$chunky_süub
(
Th»adPoŞ
::
TPHªdË
 &
hªdË
)

4849 ià(
süubb”
.
	`is_chunky_süub_aùive
()) {

4850 ià(
süubb”
.
•och_¡¬t
 !ğ
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû
) {

4851 
	`dout
(10è<< "süub…g chªged,‡bÜtšg" << 
d’dl
;

4852 
	`süub_ş—r_¡©e
();

4853 
	`süub_uÄe£rve_»¶iÿs
();

4858 
boŞ
 
dÚe
 = 
çl£
;

4859 
»t
;

4861 !
dÚe
) {

4862 
	`dout
(20è<< "süub s‹ " << 
Süubb”
::
	`¡©e_¡ršg
(
süubb”
.
¡©e
)

4863 << " [" << 
süubb”
.
¡¬t
 << "," << süubb”.
’d
 << ")" << 
d’dl
;

4865 
süubb”
.
¡©e
) {

4866 
PG
::
Süubb”
::
INACTIVE
:

4867 
	`dout
(10è<< "süub s¹" << 
d’dl
;

4868 
	`as£¹
(
	`is_´im¬y
());

4870 
	`publish_¡©s_to_osd
();

4871 
süubb”
.
•och_¡¬t
 = 
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû
;

4872 
süubb”
.
aùive
 = 
Œue
;

4874 
osd
->
	`šc_süubs_aùive
(
süubb”
.
»£rved
);

4875 ià(
süubb”
.
»£rved
) {

4876 
süubb”
.
»£rved
 = 
çl£
;

4877 
süubb”
.
»£rved_³”s
.
	`ş—r
();

4881 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

4882 
süubb”
.
	`ş—nup_¡Üe
(&
t
);

4883 
süubb”
.
¡Üe
.
	`»£t
(
Süub
::
StÜe
::
	`ü—‹
(
osd
->¡Üe, &
t
,

4884 
šfo
.
pgid
, 
cŞl
));

4885 
osd
->
¡Üe
->
	`queue_Œª§ùiÚ
(
ch
, 
¡d
::
	`move
(
t
), 
nuÎ±r
);

4889 
süubb”
.
¡¬t
 = 
šfo
.
pgid
.pgid.
	`g‘_hobj_¡¬t
();

4890 
süubb”
.
¡©e
 = 
PG
::
Süubb”
::
NEW_CHUNK
;

4893 
boŞ
 
»·œ
 = 
	`¡©e_‹¡
(
PG_STATE_REPAIR
);

4894 
boŞ
 
d“p_süub
 = 
	`¡©e_‹¡
(
PG_STATE_DEEP_SCRUB
);

4895 cÚ¡ *
mode
 = (
»·œ
 ? "»·œ": (
d“p_süub
 ? "deep-scrub" : "scrub"));

4896 
¡ršg¡»am
 
oss
;

4897 
oss
 << 
šfo
.
pgid
.pgid << " " << 
mode
 << " s¹s" << 
¡d
::
’dl
;

4898 
osd
->
şog
->
	`debug
(
oss
);

4901 
süubb”
.
´“m±_Ëá
 = 
cù
->
_cÚf
->
g‘_v®
<
ušt64_t
>(

4903 
süubb”
.
´“m±_divisÜ
 = 1;

4906 
PG
::
Süubb”
::
NEW_CHUNK
:

4907 
süubb”
.
´im¬y_süubm­
 = 
	`SüubM­
();

4908 
süubb”
.
»ûived_m­s
.
	`ş—r
();

4911 ià(
süub_´“m±ed
) {

4912 
süubb”
.
´“m±_Ëá
--;

4913 
süubb”
.
´“m±_divisÜ
 *= 2;

4914 
	`dout
(10è<< 
__func__
 << "…»em±ed, " << 
süubb”
.
´“m±_Ëá


4915 << "†eá" << 
d’dl
;

4916 
süub_´“m±ed
 = 
çl£
;

4918 
süub_ÿn_´“m±
 = 
süubb”
.
´“m±_Ëá
 > 0;

4937 
mš
 = 
¡d
::
max
<
št64_t
>(3, 
cù
->
_cÚf
->
osd_süub_chunk_mš
 /

4938 
süubb”
.
´“m±_divisÜ
);

4939 
max
 = 
¡d
::max<
št64_t
>(
mš
, 
cù
->
_cÚf
->
osd_süub_chunk_max
 /

4940 
süubb”
.
´“m±_divisÜ
);

4941 
hobjeù_t
 
¡¬t
 = 
süubb”
.start;

4942 
hobjeù_t
 
ÿndid©e_’d
;

4943 
veùÜ
<
hobjeù_t
> 
objeùs
;

4944 
»t
 = 
	`g‘_pgback’d
()->
	`objeùs_li¡_·¹Ÿl
(

4945 
¡¬t
,

4946 
mš
,

4947 
max
,

4948 &
objeùs
,

4949 &
ÿndid©e_’d
);

4950 
	`as£¹
(
»t
 >= 0);

4952 ià(!
objeùs
.
	`em±y
()) {

4953 
hobjeù_t
 
back
 = 
objeùs
.
	`back
();

4954 
ÿndid©e_’d
.
	`is_h—d
() &&

4955 
ÿndid©e_’d
 =ğ
back
.
	`g‘_h—d
()) {

4956 
ÿndid©e_’d
 = 
back
;

4957 
objeùs
.
	`pİ_back
();

4958 ià(
objeùs
.
	`em±y
()) {

4959 
	`as£¹
(0 ==

4963 
back
 = 
objeùs
.
	`back
();

4965 ià(
ÿndid©e_’d
.
	`is_h—d
()) {

4966 
	`as£¹
(
ÿndid©e_’d
 !ğ
back
.
	`g‘_h—d
());

4967 
ÿndid©e_’d
 = cªdid©e_’d.
	`g‘_objeù_bound¬y
();

4970 
	`as£¹
(
ÿndid©e_’d
.
	`is_max
());

4973 ià(!
	`_¿nge_avaabË_fÜ_süub
(
süubb”
.
¡¬t
, 
ÿndid©e_’d
)) {

4975 
	`dout
(10è<< 
__func__
 << ": scrub blocked somewhere in„ange "

4976 << "[" << 
süubb”
.
¡¬t
 << ", " << 
ÿndid©e_’d
 << ")"

4977 << 
d’dl
;

4978 
dÚe
 = 
Œue
;

4981 
süubb”
.
’d
 = 
ÿndid©e_’d
;

4985 
süubb”
.
sub£t_Ï¡_upd©e
 = 
	`ev”siÚ_t
();

4986 autØ
p
 = 
´ojeùed_log
.
log
.
	`rbegš
();

4987 
p
 !ğ
´ojeùed_log
.
log
.
	`»nd
();

4988 ++
p
) {

4989 ià(
p
->
soid
 >ğ
süubb”
.
¡¬t
 &&

4990 
p
->
soid
 < 
süubb”
.
’d
) {

4991 
süubb”
.
sub£t_Ï¡_upd©e
 = 
p
->
v”siÚ
;

4995 ià(
süubb”
.
sub£t_Ï¡_upd©e
 =ğ
	`ev”siÚ_t
()) {

4996 
li¡
<
pg_log_’Œy_t
>::
cÚ¡_»v”£_™”©Ü
 
p
 =

4997 
pg_log
.
	`g‘_log
().
log
.
	`rbegš
();

4998 
p
 !ğ
pg_log
.
	`g‘_log
().
log
.
	`»nd
();

4999 ++
p
) {

5000 ià(
p
->
soid
 >ğ
süubb”
.
¡¬t
 &&

5001 
p
->
soid
 < 
süubb”
.
’d
) {

5002 
süubb”
.
sub£t_Ï¡_upd©e
 = 
p
->
v”siÚ
;

5008 
süubb”
.
¡©e
 = 
PG
::
Süubb”
::
WAIT_PUSHES
;

5011 
PG
::
Süubb”
::
WAIT_PUSHES
:

5012 ià(
aùive_pushes
 == 0) {

5013 
süubb”
.
¡©e
 = 
PG
::
Süubb”
::
WAIT_LAST_UPDATE
;

5015 
	`dout
(15è<< "wa™ fÜ…ushe tØ­¶y" << 
d’dl
;

5016 
dÚe
 = 
Œue
;

5020 
PG
::
Süubb”
::
WAIT_LAST_UPDATE
:

5021 ià(
Ï¡_upd©e_­¶›d
 < 
süubb”
.
sub£t_Ï¡_upd©e
) {

5023 
	`dout
(15è<< "wa™ fÜ EC„—d/modify/wr™e tØqueue" << 
d’dl
;

5024 
dÚe
 = 
Œue
;

5029 
süubb”
.
wa™šg_Ú_whom
.
	`š£¹
(
pg_whßmi
);

5032 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
aùšg_»cov”y_backfl
.
	`begš
();

5033 
i
 !ğ
aùšg_»cov”y_backfl
.
	`’d
();

5034 ++
i
) {

5035 ià(*
i
 =ğ
pg_whßmi
) ;

5036 
	`_»que¡_süub_m­
(*
i
, 
süubb”
.
sub£t_Ï¡_upd©e
,

5037 
süubb”
.
¡¬t
, süubb”.
’d
, süubb”.
d“p
,

5038 
süubb”
.
´“m±_Ëá
 > 0);

5039 
süubb”
.
wa™šg_Ú_whom
.
	`š£¹
(*
i
);

5041 
	`dout
(10è<< 
__func__
 << " wa™šg_Ú_whom " << 
süubb”
.
wa™šg_Ú_whom


5042 << 
d’dl
;

5044 
süubb”
.
¡©e
 = 
PG
::
Süubb”
::
BUILD_MAP
;

5045 
süubb”
.
´im¬y_süubm­_pos
.
	`»£t
();

5048 
PG
::
Süubb”
::
BUILD_MAP
:

5049 
	`as£¹
(
Ï¡_upd©e_­¶›d
 >ğ
süubb”
.
sub£t_Ï¡_upd©e
);

5052 ià(
süub_´“m±ed
) {

5053 
	`dout
(10è<< 
__func__
 << "…»em±ed" << 
d’dl
;

5054 
süubb”
.
¡©e
 = 
PG
::
Süubb”
::
BUILD_MAP_DONE
;

5057 
»t
 = 
	`bud_süub_m­_chunk
(

5058 
süubb”
.
´im¬y_süubm­
,

5059 
süubb”
.
´im¬y_süubm­_pos
,

5060 
süubb”
.
¡¬t
, süubb”.
’d
,

5061 
süubb”
.
d“p
,

5062 
hªdË
);

5063 ià(
»t
 =ğ-
EINPROGRESS
) {

5064 
	`»queue_süub
();

5065 
dÚe
 = 
Œue
;

5068 
süubb”
.
¡©e
 = 
PG
::
Süubb”
::
BUILD_MAP_DONE
;

5071 
PG
::
Süubb”
::
BUILD_MAP_DONE
:

5072 ià(
süubb”
.
´im¬y_süubm­_pos
.
»t
 < 0) {

5073 
	`dout
(5è<< "”rÜ: " << 
süubb”
.
´im¬y_süubm­_pos
.
»t


5074 << ",‡bÜtšg" << 
d’dl
;

5075 
	`süub_ş—r_¡©e
();

5076 
	`süub_uÄe£rve_»¶iÿs
();

5079 
	`dout
(10è<< 
__func__
 << " waiting_on_whom was "

5080 << 
süubb”
.
wa™šg_Ú_whom
 << 
d’dl
;

5081 
	`as£¹
(
süubb”
.
wa™šg_Ú_whom
.
	`couÁ
(
pg_whßmi
));

5082 
süubb”
.
wa™šg_Ú_whom
.
	`”a£
(
pg_whßmi
);

5084 
süubb”
.
¡©e
 = 
PG
::
Süubb”
::
WAIT_REPLICAS
;

5087 
PG
::
Süubb”
::
WAIT_REPLICAS
:

5088 ià(!
süubb”
.
wa™šg_Ú_whom
.
	`em±y
()) {

5090 
	`dout
(10è<< "wa™ fÜ„•liÿ tØbud süub m­" << 
d’dl
;

5091 
dÚe
 = 
Œue
;

5095 
süub_ÿn_´“m±
 = 
çl£
;

5096 ià(
süub_´“m±ed
) {

5097 
	`dout
(10è<< 
__func__
 << "…»em±ed,„e¡¬tšg chunk" << 
d’dl
;

5098 
süubb”
.
¡©e
 = 
PG
::
Süubb”
::
NEW_CHUNK
;

5100 
süubb”
.
¡©e
 = 
PG
::
Süubb”
::
COMPARE_MAPS
;

5104 
PG
::
Süubb”
::
COMPARE_MAPS
:

5105 
	`as£¹
(
Ï¡_upd©e_­¶›d
 >ğ
süubb”
.
sub£t_Ï¡_upd©e
);

5106 
	`as£¹
(
süubb”
.
wa™šg_Ú_whom
.
	`em±y
());

5108 
	`süub_com·»_m­s
();

5109 
süubb”
.
¡¬t
 = süubb”.
’d
;

5110 
süubb”
.
	`run_ÿÎbacks
();

5113 
	`»queue_İs
(
wa™šg_fÜ_süub
);

5115 
süubb”
.
¡©e
 = 
PG
::
Süubb”
::
WAIT_DIGEST_UPDATES
;

5119 
PG
::
Süubb”
::
WAIT_DIGEST_UPDATES
:

5120 ià(
süubb”
.
num_dige¡_upd©es_³ndšg
) {

5121 
	`dout
(10è<< 
__func__
 << " waiting on "

5122 << 
süubb”
.
num_dige¡_upd©es_³ndšg


5123 << " dige¡ upd©es" << 
d’dl
;

5124 
dÚe
 = 
Œue
;

5128 
süubb”
.
´“m±_Ëá
 = 
cù
->
_cÚf
->
g‘_v®
<
ušt64_t
>(

5130 
süubb”
.
´“m±_divisÜ
 = 1;

5132 ià(!(
süubb”
.
’d
.
	`is_max
())) {

5133 
süubb”
.
¡©e
 = 
PG
::
Süubb”
::
NEW_CHUNK
;

5134 
	`»queue_süub
();

5135 
dÚe
 = 
Œue
;

5137 
süubb”
.
¡©e
 = 
PG
::
Süubb”
::
FINISH
;

5142 
PG
::
Süubb”
::
FINISH
:

5143 
	`süub_fšish
();

5144 
süubb”
.
¡©e
 = 
PG
::
Süubb”
::
INACTIVE
;

5145 
dÚe
 = 
Œue
;

5147 ià(!
¢­_Œimq
.
	`em±y
()) {

5148 
	`dout
(10è<< "süub fšished,„equeušg sÇp_Œimm”" << 
d’dl
;

5149 
	`¢­_Œimm”_süub_com¶‘e
();

5154 
PG
::
Süubb”
::
BUILD_MAP_REPLICA
:

5156 ià(
süub_´“m±ed
) {

5157 
	`dout
(10è<< 
__func__
 << "…»em±ed" << 
d’dl
;

5158 
»t
 = 0;

5160 
»t
 = 
	`bud_süub_m­_chunk
(

5161 
süubb”
.
»¶iÿ_süubm­
,

5162 
süubb”
.
»¶iÿ_süubm­_pos
,

5163 
süubb”
.
¡¬t
, süubb”.
’d
,

5164 
süubb”
.
d“p
,

5165 
hªdË
);

5167 ià(
»t
 =ğ-
EINPROGRESS
) {

5168 
	`»queue_süub
();

5169 
dÚe
 = 
Œue
;

5174 
MOSDR•SüubM­
 *
»¶y
 = 
Ãw
 
	`MOSDR•SüubM­
(

5175 
	`¥g_t
(
šfo
.
pgid
.pgid, 
	`g‘_´im¬y
().
sh¬d
),

5176 
süubb”
.
»¶iÿ_süub_¡¬t
,

5177 
pg_whßmi
);

5178 
»¶y
->
´“m±ed
 = 
süub_´“m±ed
;

5179 ::
	`’code
(
süubb”
.
»¶iÿ_süubm­
, 
»¶y
->
	`g‘_d©a
());

5180 
osd
->
	`£nd_mes§ge_osd_şu¡”
(

5181 
	`g‘_´im¬y
().
osd
, 
»¶y
,

5182 
süubb”
.
»¶iÿ_süub_¡¬t
);

5184 
süub_´“m±ed
 = 
çl£
;

5185 
süub_ÿn_´“m±
 = 
çl£
;

5186 
süubb”
.
¡©e
 = 
PG
::
Süubb”
::
INACTIVE
;

5187 
süubb”
.
»¶iÿ_süubm­
 = 
	`SüubM­
();

5188 
süubb”
.
»¶iÿ_süubm­_pos
 = 
	`SüubM­Bud”
();

5189 
süubb”
.
¡¬t
 = 
	`hobjeù_t
();

5190 
süubb”
.
’d
 = 
	`hobjeù_t
();

5191 
dÚe
 = 
Œue
;

5195 
	`ûph_abÜt
();

5198 
	`dout
(20è<< "süub fš® s‹ " << 
Süubb”
::
	`¡©e_¡ršg
(
süubb”
.
¡©e
)

5199 << " [" << 
süubb”
.
¡¬t
 << "," << süubb”.
’d
 << ")" << 
d’dl
;

5200 
	}
}

5202 
boŞ
 
	gPG
::
	$wr™e_blocked_by_süub
(cÚ¡ 
hobjeù_t
& 
soid
)

5204 ià(
soid
 < 
süubb”
.
¡¬t
 || soid >ğsüubb”.
’d
) {

5205  
çl£
;

5207 ià(
süub_ÿn_´“m±
) {

5208 ià(!
süub_´“m±ed
) {

5209 
	`dout
(10è<< 
__func__
 << " " << 
soid
 << "…»em±ed" << 
d’dl
;

5210 
süub_´“m±ed
 = 
Œue
;

5212 
	`dout
(10è<< 
__func__
 << " " << 
soid
 << "‡Ì—dy…»em±ed" << 
d’dl
;

5214  
çl£
;

5216  
Œue
;

5217 
	}
}

5219 
boŞ
 
	gPG
::
	$¿nge_š‹r£ùs_süub
(cÚ¡ 
hobjeù_t
 &
¡¬t
, cÚ¡ hobjeù_t& 
’d
)

5222  (
¡¬t
 < 
süubb”
.
’d
 &&

5223 
’d
 >ğ
süubb”
.
¡¬t
);

5224 
	}
}

5226 
	gPG
::
	$süub_ş—r_¡©e
()

5228 
	`as£¹
(
	`is_locked
());

5229 
	`¡©e_ş—r
(
PG_STATE_SCRUBBING
);

5230 
	`¡©e_ş—r
(
PG_STATE_REPAIR
);

5231 
	`¡©e_ş—r
(
PG_STATE_DEEP_SCRUB
);

5232 
	`publish_¡©s_to_osd
();

5235 ià(
süubb”
.
aùive
)

5236 
osd
->
	`dec_süubs_aùive
();

5238 
	`»queue_İs
(
wa™šg_fÜ_süub
);

5240 
süubb”
.
	`»£t
();

5243 
	`_süub_ş—r_¡©e
();

5244 
	}
}

5246 
	gPG
::
	$süub_com·»_m­s
()

5248 
	`dout
(10è<< 
__func__
 << " ha m­s,‡Çlyzšg" << 
d’dl
;

5251 
süubb”
.
ş—Ãd_m‘a_m­
.
	`š£¹
(süubb”.
´im¬y_süubm­
);

5252 
m­
<
hobjeù_t
,

5253 
·œ
<
boo¡
::
İtiÚ®
<
ušt32_t
>,

5254 
boo¡
::
İtiÚ®
<
ušt32_t
>>> 
missšg_dige¡
;

5256 
m­
<
pg_sh¬d_t
, 
SüubM­
 *> 
m­s
;

5257 
m­s
[
pg_whßmi
] = &
süubb”
.
´im¬y_süubm­
;

5259 cÚ¡‡uto& 
i
 : 
aùšg_»cov”y_backfl
) {

5260 ià(
i
 =ğ
pg_whßmi
) ;

5261 
	`dout
(2è<< 
__func__
 << "„•liÿ " << 
i
 << " has "

5262 << 
süubb”
.
»ûived_m­s
[
i
].
objeùs
.
	`size
()

5263 << " i‹ms" << 
d’dl
;

5264 
m­s
[
i
] = &
süubb”
.
»ûived_m­s
[i];

5267 
£t
<
hobjeù_t
> 
ma¡”_£t
;

5270 cÚ¡‡utØ
m­
 : 
m­s
) {

5271 cÚ¡‡utØ
i
 : 
m­
.
£cÚd
->
objeùs
) {

5272 
ma¡”_£t
.
	`š£¹
(
i
.
fœ¡
);

5276 
¡ršg¡»am
 
ss
;

5277 
	`g‘_pgback’d
()->
	`be_Ïrge_om­_check
(
m­s
, 
ma¡”_£t
,

5278 
süubb”
.
Ïrge_om­_objeùs
, 
ss
);

5279 ià(!
ss
.
	`¡r
().
	`em±y
()) {

5280 
osd
->
şog
->
	`w¬n
(
ss
);

5283 ià(
aùšg
.
	`size
() > 1) {

5284 
	`dout
(10è<< 
__func__
 << " com·ršg„•liÿ süub m­s" << 
d’dl
;

5287 
m­
<
hobjeù_t
, 
li¡
<
pg_sh¬d_t
>> 
authÜ™©ive
;

5289 
	`dout
(2è<< 
__func__
 << " osd." << 
aùšg
[0] << " has "

5290 << 
süubb”
.
´im¬y_süubm­
.
objeùs
.
	`size
(è<< " i‹ms" << 
d’dl
;

5292 
ss
.
	`¡r
("");

5293 
ss
.
	`ş—r
();

5295 
	`g‘_pgback’d
()->
	`be_com·»_süubm­s
(

5296 
m­s
,

5297 
ma¡”_£t
,

5298 
	`¡©e_‹¡
(
PG_STATE_REPAIR
),

5299 
süubb”
.
missšg
,

5300 
süubb”
.
šcÚsi¡’t
,

5301 
authÜ™©ive
,

5302 
missšg_dige¡
,

5303 
süubb”
.
sh®low_”rÜs
,

5304 
süubb”
.
d“p_”rÜs
,

5305 
süubb”
.
¡Üe
.
	`g‘
(),

5306 
šfo
.
pgid
, 
aùšg
,

5307 
ss
);

5308 
	`dout
(2è<< 
ss
.
	`¡r
(è<< 
d’dl
;

5310 ià(!
ss
.
	`¡r
().
	`em±y
()) {

5311 
osd
->
şog
->
	`”rÜ
(
ss
);

5314 
m­
<
hobjeù_t
, 
li¡
<
pg_sh¬d_t
>>::
™”©Ü
 
i
 = 
authÜ™©ive
.
	`begš
();

5315 
i
 !ğ
authÜ™©ive
.
	`’d
();

5316 ++
i
) {

5317 
li¡
<
·œ
<
SüubM­
::
objeù
, 
pg_sh¬d_t
> > 
good_³”s
;

5318 
li¡
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
j
 = 
i
->
£cÚd
.
	`begš
();

5319 
j
 !ğ
i
->
£cÚd
.
	`’d
();

5320 ++
j
) {

5321 
good_³”s
.
	`push_back
(
	`make_·œ
(
m­s
[*
j
]->
objeùs
[
i
->
fœ¡
], *j));

5323 
süubb”
.
authÜ™©ive
.
	`š£¹
(

5324 
	`make_·œ
(

5325 
i
->
fœ¡
,

5326 
good_³”s
));

5329 
m­
<
hobjeù_t
, 
li¡
<
pg_sh¬d_t
>>::
™”©Ü
 
i
 = 
authÜ™©ive
.
	`begš
();

5330 
i
 !ğ
authÜ™©ive
.
	`’d
();

5331 ++
i
) {

5332 
süubb”
.
ş—Ãd_m‘a_m­
.
objeùs
.
	`”a£
(
i
->
fœ¡
);

5333 
süubb”
.
ş—Ãd_m‘a_m­
.
objeùs
.
	`š£¹
(

5334 *(
m­s
[
i
->
£cÚd
.
	`back
()]->
objeùs
.
	`fšd
(i->
fœ¡
))

5339 
SüubM­
 
fÜ_m‘a_süub
;

5340 
süubb”
.
	`ş—n_m‘a_m­
(
fÜ_m‘a_süub
);

5343 
	`süub_¢­shÙ_m‘ad©a
(
fÜ_m‘a_süub
, 
missšg_dige¡
);

5345 
	`_sÿn_¢­s
(
fÜ_m‘a_süub
);

5346 ià(!
süubb”
.
¡Üe
->
	`em±y
()) {

5347 ià(
	`¡©e_‹¡
(
PG_STATE_REPAIR
)) {

5348 
	`dout
(10è<< 
__func__
 << ": disÿrdšg süub„esuÉs" << 
d’dl
;

5349 
süubb”
.
¡Üe
->
	`æush
(
nuÎ±r
);

5351 
	`dout
(10è<< 
__func__
 << ": upd©šg süub objeù" << 
d’dl
;

5352 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

5353 
süubb”
.
¡Üe
->
	`æush
(&
t
);

5354 
osd
->
¡Üe
->
	`queue_Œª§ùiÚ
(
ch
, 
¡d
::
	`move
(
t
), 
nuÎ±r
);

5357 
	}
}

5359 
boŞ
 
	gPG
::
	$süub_´oûss_šcÚsi¡’t
()

5361 
	`dout
(10è<< 
__func__
 << ": checkšg‡uthÜ™©ive" << 
d’dl
;

5362 
boŞ
 
»·œ
 = 
	`¡©e_‹¡
(
PG_STATE_REPAIR
);

5363 
boŞ
 
d“p_süub
 = 
	`¡©e_‹¡
(
PG_STATE_DEEP_SCRUB
);

5364 cÚ¡ *
mode
 = (
»·œ
 ? "»·œ": (
d“p_süub
 ? "deep-scrub" : "scrub"));

5367 ià(!
süubb”
.
authÜ™©ive
.
	`em±y
()) {

5368 
¡ršg¡»am
 
ss
;

5369 
ss
 << 
šfo
.
pgid
 << " " << 
mode
 << " "

5370 << 
süubb”
.
missšg
.
	`size
() << " missing, "

5371 << 
süubb”
.
šcÚsi¡’t
.
	`size
() << " inconsistent objects";

5372 
	`dout
(2è<< 
ss
.
	`¡r
(è<< 
d’dl
;

5373 
osd
->
şog
->
	`”rÜ
(
ss
);

5374 ià(
»·œ
) {

5375 
	`¡©e_ş—r
(
PG_STATE_CLEAN
);

5376 
m­
<
hobjeù_t
, 
li¡
<
·œ
<
SüubM­
::
objeù
, 
pg_sh¬d_t
> >>::
™”©Ü
 
i
 =

5377 
süubb”
.
authÜ™©ive
.
	`begš
();

5378 
i
 !ğ
süubb”
.
authÜ™©ive
.
	`’d
();

5379 ++
i
) {

5380 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
j
;

5382 autØ
missšg_’Œy
 = 
süubb”
.
missšg
.
	`fšd
(
i
->
fœ¡
);

5383 ià(
missšg_’Œy
 !ğ
süubb”
.
missšg
.
	`’d
()) {

5384 
j
 = 
missšg_’Œy
->
£cÚd
.
	`begš
();

5385 
j
 !ğ
missšg_’Œy
->
£cÚd
.
	`’d
();

5386 ++
j
) {

5387 
	`»·œ_objeù
(

5388 
i
->
fœ¡
,

5389 &(
i
->
£cÚd
),

5390 *
j
);

5391 ++
süubb”
.
fixed
;

5394 ià(
süubb”
.
šcÚsi¡’t
.
	`couÁ
(
i
->
fœ¡
)) {

5395 
j
 = 
süubb”
.
šcÚsi¡’t
[
i
->
fœ¡
].
	`begš
();

5396 
j
 !ğ
süubb”
.
šcÚsi¡’t
[
i
->
fœ¡
].
	`’d
();

5397 ++
j
) {

5398 
	`»·œ_objeù
(
i
->
fœ¡
,

5399 &(
i
->
£cÚd
),

5400 *
j
);

5401 ++
süubb”
.
fixed
;

5407  (!
süubb”
.
authÜ™©ive
.
	`em±y
(è&& 
»·œ
);

5408 
	}
}

5410 
boŞ
 
	gPG
::
	$İs_blocked_by_süub
() const {

5411  (
wa™šg_fÜ_süub
.
	`size
() != 0);

5412 
	}
}

5415 
	gPG
::
	$süub_fšish
()

5417 
boŞ
 
»·œ
 = 
	`¡©e_‹¡
(
PG_STATE_REPAIR
);

5420 ià(
»·œ
 && 
süubb”
.
auto_»·œ


5421 && 
süubb”
.
authÜ™©ive
.
	`size
(è> 
cù
->
_cÚf
->
osd_süub_auto_»·œ_num_”rÜs
) {

5422 
	`¡©e_ş—r
(
PG_STATE_REPAIR
);

5423 
»·œ
 = 
çl£
;

5425 
boŞ
 
d“p_süub
 = 
	`¡©e_‹¡
(
PG_STATE_DEEP_SCRUB
);

5426 cÚ¡ *
mode
 = (
»·œ
 ? "»·œ": (
d“p_süub
 ? "deep-scrub" : "scrub"));

5429 
	`_süub_fšish
();

5431 
boŞ
 
has_”rÜ
 = 
	`süub_´oûss_šcÚsi¡’t
();

5434 
¡ršg¡»am
 
oss
;

5435 
oss
 << 
šfo
.
pgid
.pgid << " " << 
mode
 << " ";

5436 
tÙ®_”rÜs
 = 
süubb”
.
sh®low_”rÜs
 + süubb”.
d“p_”rÜs
;

5437 ià(
tÙ®_”rÜs
)

5438 
oss
 << 
tÙ®_”rÜs
 << "ƒrrors";

5440 
oss
 << "ok";

5441 ià(!
d“p_süub
 && 
šfo
.
¡©s
.¡©s.
sum
.
num_d“p_süub_”rÜs
)

5442 
oss
 << " ( " << 
šfo
.
¡©s
.¡©s.
sum
.
num_d“p_süub_”rÜs


5444 ià(
»·œ
)

5445 
oss
 << ", " << 
süubb”
.
fixed
 << " fixed";

5446 ià(
tÙ®_”rÜs
)

5447 
osd
->
şog
->
	`”rÜ
(
oss
);

5449 
osd
->
şog
->
	`debug
(
oss
);

5453 
	`uÄeg_Ãxt_süub
();

5454 
utime_t
 
now
 = 
	`ûph_şock_now
();

5455 
šfo
.
hi¡Üy
.
Ï¡_süub
 = info.
Ï¡_upd©e
;

5456 
šfo
.
hi¡Üy
.
Ï¡_süub_¡amp
 = 
now
;

5457 ià(
süubb”
.
d“p
) {

5458 
šfo
.
hi¡Üy
.
Ï¡_d“p_süub
 = info.
Ï¡_upd©e
;

5459 
šfo
.
hi¡Üy
.
Ï¡_d“p_süub_¡amp
 = 
now
;

5463 ià(
»·œ
) {

5464 ià(
süubb”
.
fixed
 =ğsüubb”.
sh®low_”rÜs
 + süubb”.
d“p_”rÜs
) {

5465 
	`as£¹
(
d“p_süub
);

5466 
süubb”
.
sh®low_”rÜs
 = süubb”.
d“p_”rÜs
 = 0;

5469 
süub_aá”_»cov”y
 = 
Œue
;

5472 ià(
d“p_süub
) {

5473 ià((
süubb”
.
sh®low_”rÜs
 =ğ0è&& (süubb”.
d“p_”rÜs
 == 0))

5474 
šfo
.
hi¡Üy
.
Ï¡_ş—n_süub_¡amp
 = 
now
;

5475 
šfo
.
¡©s
.¡©s.
sum
.
num_sh®low_süub_”rÜs
 = 
süubb”
.
sh®low_”rÜs
;

5476 
šfo
.
¡©s
.¡©s.
sum
.
num_d“p_süub_”rÜs
 = 
süubb”
.
d“p_”rÜs
;

5477 
šfo
.
¡©s
.¡©s.
sum
.
num_Ïrge_om­_objeùs
 = 
süubb”
.
Ïrge_om­_objeùs
;

5479 
šfo
.
¡©s
.¡©s.
sum
.
num_sh®low_süub_”rÜs
 = 
süubb”
.
sh®low_”rÜs
;

5482 ià(
süubb”
.
sh®low_”rÜs
 == 0)

5483 
šfo
.
hi¡Üy
.
Ï¡_ş—n_süub_¡amp
 = 
now
;

5485 
šfo
.
¡©s
.¡©s.
sum
.
num_süub_”rÜs
 =

5486 
šfo
.
¡©s
.¡©s.
sum
.
num_sh®low_süub_”rÜs
 +

5487 
šfo
.
¡©s
.¡©s.
sum
.
num_d“p_süub_”rÜs
;

5488 
	`»g_Ãxt_süub
();

5491 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

5492 
dœty_šfo
 = 
Œue
;

5493 
	`wr™e_if_dœty
(
t
);

5494 
Œ
 = 
osd
->
¡Üe
->
	`queue_Œª§ùiÚ
(
ch
, 
¡d
::
	`move
(
t
), 
NULL
);

5495 
	`as£¹
(
Œ
 == 0);

5499 ià(
has_”rÜ
) {

5500 
	`queue_³”šg_ev’t
(

5501 
	`PGP“ršgEv’tRef
(

5502 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

5503 
	`g‘_osdm­
()->
	`g‘_•och
(),

5504 
	`g‘_osdm­
()->
	`g‘_•och
(),

5505 
	`DoRecov”y
())));

5508 
	`süub_ş—r_¡©e
();

5509 
	`süub_uÄe£rve_»¶iÿs
();

5511 ià(
	`is_aùive
(è&& 
	`is_´im¬y
()) {

5512 
	`sh¬e_pg_šfo
();

5514 
	}
}

5516 
	gPG
::
	$sh¬e_pg_šfo
()

5518 
	`dout
(10è<< "sh¬e_pg_šfo" << 
d’dl
;

5521 
	`as£¹
(!
aùšg_»cov”y_backfl
.
	`em±y
());

5522 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
aùšg_»cov”y_backfl
.
	`begš
();

5523 
i
 !ğ
aùšg_»cov”y_backfl
.
	`’d
();

5524 ++
i
) {

5525 ià(*
i
 =ğ
pg_whßmi
) ;

5526 autØ
pg_sh¬d
 = *
i
;

5527 autØ
³”
 = 
³”_šfo
.
	`fšd
(
pg_sh¬d
);

5528 ià(
³”
 !ğ
³”_šfo
.
	`’d
()) {

5529 
³”
->
£cÚd
.
Ï¡_•och_¡¬‹d
 = 
šfo
.last_epoch_started;

5530 
³”
->
£cÚd
.
Ï¡_š‹rv®_¡¬‹d
 = 
šfo
.last_interval_started;

5531 
³”
->
£cÚd
.
hi¡Üy
.
	`m”ge
(
šfo
.history);

5533 
MOSDPGInfo
 *
m
 = 
Ãw
 
	`MOSDPGInfo
(
	`g‘_osdm­
()->
	`g‘_•och
());

5534 
m
->
pg_li¡
.
	`push_back
(

5535 
	`make_·œ
(

5536 
	`pg_nÙify_t
(

5537 
pg_sh¬d
.
sh¬d
, 
pg_whßmi
.shard,

5538 
	`g‘_osdm­
()->
	`g‘_•och
(),

5539 
	`g‘_osdm­
()->
	`g‘_•och
(),

5540 
šfo
),

5541 
·¡_š‹rv®s
));

5542 
osd
->
	`£nd_mes§ge_osd_şu¡”
(
pg_sh¬d
.osd, 
m
, 
	`g‘_osdm­
()->
	`g‘_•och
());

5544 
	}
}

5546 
boŞ
 
	gPG
::
­³nd_log_’Œ›s_upd©e_missšg
(

5547 cÚ¡ 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> &
’Œ›s
,

5548 
ObjeùStÜe
::
T¿n§ùiÚ
 &
t
, 
boo¡
::
İtiÚ®
<
ev”siÚ_t
> 
Œim_to
,

5549 
boo¡
::
İtiÚ®
<
ev”siÚ_t
> 
rŞl_fÜw¬d_to
)

5551 
as£¹
(!
’Œ›s
.
em±y
());

5552 
as£¹
(
’Œ›s
.
begš
()->
v”siÚ
 > 
šfo
.
Ï¡_upd©e
);

5554 
PGLogEÁryHªdËr
 
	grŞlback”
{
	gthis
, &
	gt
};

5555 ià(
	grŞl_fÜw¬d_to
) {

5556 
	gpg_log
.
rŞl_fÜw¬d
(&
rŞlback”
);

5558 
boŞ
 
	gšv®id©e_¡©s
 =

5559 
pg_log
.
­³nd_Ãw_log_’Œ›s
(
šfo
.
Ï¡_backfl
,

5560 
šfo
.
Ï¡_backfl_b™wi£
,

5561 
’Œ›s
,

5562 &
rŞlback”
);

5564 ià(
	grŞl_fÜw¬d_to
 && 
	g’Œ›s
.
rbegš
()->
	gsoid
 > 
	gšfo
.
	gÏ¡_backfl
) {

5565 
	gpg_log
.
rŞl_fÜw¬d
(&
rŞlback”
);

5567 ià(
	grŞl_fÜw¬d_to
 && *rŞl_fÜw¬d_tØ> 
	gpg_log
.
g‘_ÿn_rŞlback_to
()) {

5568 
	gpg_log
.
rŞl_fÜw¬d_to
(*rŞl_fÜw¬d_to, &
rŞlback”
);

5569 
	gÏ¡_rŞlback_šfo_Œimmed_to_­¶›d
 = *
rŞl_fÜw¬d_to
;

5572 
	gšfo
.
	gÏ¡_upd©e
 = 
pg_log
.
g‘_h—d
();

5574 ià(
	gpg_log
.
g‘_missšg
().
num_missšg
() == 0) {

5576 
šfo
.
Ï¡_com¶‘e
 = info.
Ï¡_upd©e
;

5578 
	gšfo
.
	g¡©s
.
	g¡©s_šv®id
 = 
šfo
.
¡©s
.
¡©s_šv®id
 || 
šv®id©e_¡©s
;

5580 
dout
(20è<< 
	g__func__
 << "rim_tØboŞ = " << 
boŞ
(
Œim_to
è<< "rim_tØğ" << (
	gŒim_to
 ? *Œim_tØ: 
ev”siÚ_t
()è<< 
d’dl
;

5581 ià(
	gŒim_to
)

5582 
	gpg_log
.
Œim
(*
Œim_to
, 
šfo
);

5583 
	gdœty_šfo
 = 
Œue
;

5584 
wr™e_if_dœty
(
t
);

5585  
	gšv®id©e_¡©s
;

5589 
	gPG
::
m”ge_Ãw_log_’Œ›s
(

5590 cÚ¡ 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> &
’Œ›s
,

5591 
ObjeùStÜe
::
T¿n§ùiÚ
 &
t
,

5592 
boo¡
::
İtiÚ®
<
ev”siÚ_t
> 
Œim_to
,

5593 
boo¡
::
İtiÚ®
<
ev”siÚ_t
> 
rŞl_fÜw¬d_to
)

5595 
dout
(10è<< 
__func__
 << " " << 
’Œ›s
 << 
d’dl
;

5596 
as£¹
(
is_´im¬y
());

5598 
boŞ
 
	g»bud_missšg
 = 
­³nd_log_’Œ›s_upd©e_missšg
(
’Œ›s
, 
t
, 
Œim_to
, 
rŞl_fÜw¬d_to
);

5599 
	g£t
<
	gpg_sh¬d_t
>::
cÚ¡_™”©Ü
 
i
 = 
aùšg_»cov”y_backfl
.
begš
();

5600 
	gi
 !ğ
aùšg_»cov”y_backfl
.
’d
();

5601 ++
	gi
) {

5602 
pg_sh¬d_t
 
³”
(*
i
);

5603 ià(
	g³”
 =ğ
pg_whßmi
) ;

5604 
as£¹
(
³”_missšg
.
couÁ
(
³”
));

5605 
as£¹
(
³”_šfo
.
couÁ
(
³”
));

5606 
	gpg_missšg_t
& 
pmissšg
(
³”_missšg
[
³”
]);

5607 
dout
(20è<< 
	g__func__
 << "…“r_missšg fÜ " << 
	g³”
 << " = " << 
	gpmissšg
 << 
	gd’dl
;

5608 
	gpg_šfo_t
& 
pšfo
(
³”_šfo
[
³”
]);

5609 
boŞ
 
	gšv®id©e_¡©s
 = 
PGLog
::
­³nd_log_’Œ›s_upd©e_missšg
(

5610 
pšfo
.
Ï¡_backfl
,

5611 
šfo
.
Ï¡_backfl_b™wi£
,

5612 
’Œ›s
,

5613 
Œue
,

5614 
NULL
,

5615 
pmissšg
,

5616 
NULL
,

5617 
this
);

5618 
	gpšfo
.
	gÏ¡_upd©e
 = 
šfo
.
Ï¡_upd©e
;

5619 
	gpšfo
.
	g¡©s
.
	g¡©s_šv®id
 = 
pšfo
.
¡©s
.
¡©s_šv®id
 || 
šv®id©e_¡©s
;

5620 
	g»bud_missšg
 = 
»bud_missšg
 || 
šv®id©e_¡©s
;

5623 ià(!
	g»bud_missšg
) {

5627 autØ&&
	gi
: 
’Œ›s
) {

5628 
missšg_loc
.
»bud
(

5629 
i
.
soid
,

5630 
pg_whßmi
,

5631 
aùšg_»cov”y_backfl
,

5632 
šfo
,

5633 
pg_log
.
g‘_missšg
(),

5634 
³”_missšg
,

5635 
³”_šfo
);

5639 
	gPG
::
	$upd©e_hi¡Üy
(cÚ¡ 
pg_hi¡Üy_t
& 
Ãw_hi¡Üy
)

5641 
	`uÄeg_Ãxt_süub
();

5642 ià(
šfo
.
hi¡Üy
.
	`m”ge
(
Ãw_hi¡Üy
)) {

5643 
	`dout
(20è<< 
__func__
 << "‡dvªûd hi¡Üy from " << 
Ãw_hi¡Üy
 << 
d’dl
;

5644 
dœty_šfo
 = 
Œue
;

5645 ià(
šfo
.
hi¡Üy
.
Ï¡_•och_ş—n
 >ğšfo.hi¡Üy.
§me_š‹rv®_sšû
) {

5646 
	`dout
(20è<< 
__func__
 << " cË¬šg…a¡_š‹rv®s" << 
d’dl
;

5647 
·¡_š‹rv®s
.
	`ş—r
();

5648 
dœty_big_šfo
 = 
Œue
;

5651 
	`»g_Ãxt_süub
();

5652 
	}
}

5654 
	gPG
::
fulfl_šfo
(

5655 
pg_sh¬d_t
 
äom
, cÚ¡ 
pg_qu”y_t
 &
qu”y
,

5656 
·œ
<
pg_sh¬d_t
, 
pg_šfo_t
> &
nÙify_šfo
)

5658 
as£¹
(
äom
 =ğ
´im¬y
);

5659 
as£¹
(
qu”y
.
ty³
 =ğ
pg_qu”y_t
::
INFO
);

5662 
dout
(10è<< "£ndšg info" << 
	gd’dl
;

5663 
	gnÙify_šfo
 = 
make_·œ
(
äom
, 
šfo
);

5666 
	gPG
::
	$fulfl_log
(

5667 
pg_sh¬d_t
 
äom
, cÚ¡ 
pg_qu”y_t
 &
qu”y
, 
•och_t
 
qu”y_•och
)

5669 
	`dout
(10è<< "log„eque¡ from " << 
äom
 << 
d’dl
;

5670 
	`as£¹
(
äom
 =ğ
´im¬y
);

5671 
	`as£¹
(
qu”y
.
ty³
 !ğ
pg_qu”y_t
::
INFO
);

5672 
CÚÃùiÚRef
 
cÚ
 = 
osd
->
	`g‘_cÚ_osd_şu¡”
(

5673 
äom
.
osd
, 
	`g‘_osdm­
()->
	`g‘_•och
());

5674 ià(!
cÚ
) ;

5676 
MOSDPGLog
 *
mlog
 = 
Ãw
 
	`MOSDPGLog
(

5677 
äom
.
sh¬d
, 
pg_whßmi
.shard,

5678 
	`g‘_osdm­
()->
	`g‘_•och
(),

5679 
šfo
, 
qu”y_•och
);

5680 
mlog
->
missšg
 = 
pg_log
.
	`g‘_missšg
();

5683 ià(
qu”y
.
ty³
 =ğ
pg_qu”y_t
::
LOG
) {

5684 
	`dout
(10è<< " s’dšg info+missšg+log sšû " << 
qu”y
.
sšû


5685 << 
d’dl
;

5686 ià(
qu”y
.
sšû
 !ğ
	`ev”siÚ_t
(è&& qu”y.sšû < 
pg_log
.
	`g‘_
()) {

5687 
osd
->
şog
->
	`”rÜ
(è<< 
šfo
.
pgid
 << " gÙ brok’…g_qu”y_t::LOG sšû " << 
qu”y
.
sšû


5688 << " wh’ my†og. i " << 
pg_log
.
	`g‘_
()

5690 
mlog
->
log
 = 
pg_log
.
	`g‘_log
();

5692 
mlog
->
log
.
	`cİy_aá”
(
pg_log
.
	`g‘_log
(), 
qu”y
.
sšû
);

5694 ià(
qu”y
.
ty³
 =ğ
pg_qu”y_t
::
FULLLOG
) {

5695 
	`dout
(10è<< " s’dšg info+missšg+fuÎ†og" << 
d’dl
;

5696 
mlog
->
log
 = 
pg_log
.
	`g‘_log
();

5699 
	`dout
(10è<< " s’dšg " << 
mlog
->
log
 << " " << mlog->
missšg
 << 
d’dl
;

5701 
osd
->
	`sh¬e_m­_³”
(
äom
.osd, 
cÚ
.
	`g‘
(), 
	`g‘_osdm­
());

5702 
osd
->
	`£nd_mes§ge_osd_şu¡”
(
mlog
, 
cÚ
.
	`g‘
());

5703 
	}
}

5705 
	gPG
::
	$check_fuÎ_Œªs™iÚ
(
OSDM­Ref
 
Ï¡m­
, OSDM­Reà
osdm­
)

5707 
boŞ
 
chªged
 = 
çl£
;

5708 ià(
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_FULL
) &&

5709 !
Ï¡m­
->
	`‹¡_æag
(
CEPH_OSDMAP_FULL
)) {

5710 
	`dout
(10è<< " clu¡” wa m¬ked fuÎ iÀ" << 
osdm­
->
	`g‘_•och
(è<< 
d’dl
;

5711 
chªged
 = 
Œue
;

5713 cÚ¡ 
pg_poŞ_t
 *
pi
 = 
osdm­
->
	`g‘_pg_poŞ
(
šfo
.
pgid
.
	`poŞ
());

5714 ià(!
pi
) {

5717 ià(
pi
->
	`has_æag
(
pg_poŞ_t
::
FLAG_FULL
)) {

5718 cÚ¡ 
pg_poŞ_t
 *
İi
 = 
Ï¡m­
->
	`g‘_pg_poŞ
(
šfo
.
pgid
.
	`poŞ
());

5719 ià(!
İi
 || !İi->
	`has_æag
(
pg_poŞ_t
::
FLAG_FULL
)) {

5720 
	`dout
(10è<< "…oŞ wa m¬ked fuÎ iÀ" << 
osdm­
->
	`g‘_•och
(è<< 
d’dl
;

5721 
chªged
 = 
Œue
;

5724 ià(
chªged
) {

5725 
šfo
.
hi¡Üy
.
Ï¡_•och_m¬ked_fuÎ
 = 
osdm­
->
	`g‘_•och
();

5726 
dœty_šfo
 = 
Œue
;

5728 
	}
}

5730 
boŞ
 
	gPG
::
should_»¡¬t_³”šg
(

5731 
Ãwuµrim¬y
,

5732 
Ãwaùšg´im¬y
,

5733 cÚ¡ 
veùÜ
<>& 
Ãwup
,

5734 cÚ¡ 
veùÜ
<>& 
Ãwaùšg
,

5735 
OSDM­Ref
 
Ï¡m­
,

5736 
OSDM­Ref
 
osdm­
)

5738 ià(
	gPa¡IÁ”v®s
::
is_Ãw_š‹rv®
(

5739 
´im¬y
.
osd
,

5740 
Ãwaùšg´im¬y
,

5741 
aùšg
,

5742 
Ãwaùšg
,

5743 
up_´im¬y
.
osd
,

5744 
Ãwuµrim¬y
,

5745 
up
,

5746 
Ãwup
,

5747 
osdm­
,

5748 
Ï¡m­
,

5749 
šfo
.
pgid
.pgid)) {

5750 
dout
(20è<< "Ãw iÁ”v®‚ewu°" << 
	gÃwup


5751 << "‚ewaùšg " << 
	gÃwaùšg
 << 
	gd’dl
;

5752  
	gŒue
;

5754  
	gçl£
;

5758 
boŞ
 
	gPG
::
	$Şd_³”šg_msg
(
•och_t
 
»¶y_•och
,ƒpoch_ˆ
qu”y_•och
)

5760 ià(
Ï¡_³”šg_»£t
 > 
»¶y_•och
 ||

5761 
Ï¡_³”šg_»£t
 > 
qu”y_•och
) {

5762 
	`dout
(10è<< "Şd_³”šg_msg„•ly_•och " << 
»¶y_•och
 << " qu”y_•och " << 
qu”y_•och


5763 << "†a¡_³”šg_»£ˆ" << 
Ï¡_³”šg_»£t


5764 << 
d’dl
;

5765  
Œue
;

5767  
çl£
;

5768 
	}
}

5770 
	gPG
::
	$£t_Ï¡_³”šg_»£t
()

5772 
	`dout
(20è<< "£t_Ï¡_³”šg_»£ˆ" << 
	`g‘_osdm­
()->
	`g‘_•och
(è<< 
d’dl
;

5773 ià(
Ï¡_³”šg_»£t
 !ğ
	`g‘_osdm­
()->
	`g‘_•och
()) {

5774 
Ï¡_³”šg_»£t
 = 
	`g‘_osdm­
()->
	`g‘_•och
();

5775 
	`»£t_š‹rv®_æush
();

5777 
	}
}

5779 
	sFlushS‹
 {

5780 
PGRef
 
	mpg
;

5781 
•och_t
 
	m•och
;

5782 
FlushS‹
(
PG
 *
pg
, 
•och_t
 
•och
) :…g(pg),ƒpoch(epoch) {}

5783 ~
FlushS‹
() {

5784 
	mpg
->
lock
();

5785 ià(!
	mpg
->
pg_has_»£t_sšû
(
•och
))

5786 
	mpg
->
Ú_æushed
();

5787 
	mpg
->
uÆock
();

5790 
	gûph
::
	tsh¬ed_±r
<
	tFlushS‹
> 
	tFlushS‹Ref
;

5792 
	gPG
::
	$¡¬t_æush
(
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

5795 
FlushS‹Ref
 
	`æush_Œigg”
 (
¡d
::
make_sh¬ed
<
FlushS‹
>(

5796 
this
, 
	`g‘_osdm­
()->
	`g‘_•och
()));

5797 
æushes_š_´og»ss
++;

5798 
t
->
	`»gi¡”_Ú_­¶›d
(
Ãw
 
CÚš”CÚ‹xt
<
FlushS‹Ref
>(
æush_Œigg”
));

5799 
t
->
	`»gi¡”_Ú_comm™
(
Ãw
 
CÚš”CÚ‹xt
<
FlushS‹Ref
>(
æush_Œigg”
));

5800 
	}
}

5802 
	gPG
::
	$»£t_š‹rv®_æush
()

5804 
	`dout
(10è<< "CË¬šg blocked outgošg„ecov”y mes§ges" << 
d’dl
;

5805 
»cov”y_¡©e
.
	`ş—r_blocked_outgošg
();

5807 
CÚ‹xt
 *
c
 = 
Ãw
 
QueueP“ršgEvt
<
IÁ”v®Flush
>(

5808 
this
, 
	`g‘_osdm­
()->
	`g‘_•och
(), 
	`IÁ”v®Flush
());

5809 ià(!
ch
->
	`æush_comm™
(
c
)) {

5810 
	`dout
(10è<< "BegšnšgØblock outgošg„ecov”y mes§ges" << 
d’dl
;

5811 
»cov”y_¡©e
.
	`begš_block_outgošg
();

5813 
	`dout
(10è<< "NÙ blockšg outgošg„ecov”y mes§ges" << 
d’dl
;

5814 
d–‘e
 
c
;

5816 
	}
}

5819 
	gPG
::
¡¬t_³”šg_š‹rv®
(

5820 cÚ¡ 
OSDM­Ref
 
Ï¡m­
,

5821 cÚ¡ 
veùÜ
<>& 
Ãwup
, 
Ãw_up_´im¬y
,

5822 cÚ¡ 
veùÜ
<>& 
Ãwaùšg
, 
Ãw_aùšg_´im¬y
,

5823 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

5825 cÚ¡ 
OSDM­Ref
 
osdm­
 = 
g‘_osdm­
();

5827 
£t_Ï¡_³”šg_»£t
();

5829 
	gveùÜ
<> 
	gŞdaùšg
, 
	gŞdup
;

5830 
	gŞdrŞe
 = 
g‘_rŞe
();

5832 
uÄeg_Ãxt_süub
();

5834 
pg_sh¬d_t
 
	gŞd_aùšg_´im¬y
 = 
g‘_´im¬y
();

5835 
pg_sh¬d_t
 
	gŞd_up_´im¬y
 = 
up_´im¬y
;

5836 
boŞ
 
	gwas_Şd_´im¬y
 = 
is_´im¬y
();

5837 
boŞ
 
	gwas_Şd_»¶iÿ
 = 
is_»¶iÿ
();

5839 
	gaùšg
.
sw­
(
Şdaùšg
);

5840 
	gup
.
sw­
(
Şdup
);

5841 
š™_´im¬y_up_aùšg
(

5842 
Ãwup
,

5843 
Ãwaùšg
,

5844 
Ãw_up_´im¬y
,

5845 
Ãw_aùšg_´im¬y
);

5847 ià(
	gšfo
.
	g¡©s
.
	gup
 !ğ
up
 ||

5848 
šfo
.
¡©s
.
aùšg
 !=‡cting ||

5849 
šfo
.
¡©s
.
up_´im¬y
 !ğ
Ãw_up_´im¬y
 ||

5850 
šfo
.
¡©s
.
aùšg_´im¬y
 !ğ
Ãw_aùšg_´im¬y
) {

5851 
šfo
.
¡©s
.
up
 = up;

5852 
	gšfo
.
	g¡©s
.
	gup_´im¬y
 = 
Ãw_up_´im¬y
;

5853 
	gšfo
.
	g¡©s
.
	gaùšg
 = 
aùšg
;

5854 
	gšfo
.
	g¡©s
.
	gaùšg_´im¬y
 = 
Ãw_aùšg_´im¬y
;

5855 
	gšfo
.
	g¡©s
.
	gm­pšg_•och
 = 
osdm­
->
g‘_•och
();

5858 
	gpg_¡©s_publish_lock
.
Lock
();

5859 
	gpg_¡©s_publish_v®id
 = 
çl£
;

5860 
	gpg_¡©s_publish_lock
.
UÆock
();

5864 ià(
	gup
 !ğ
aùšg
)

5865 
¡©e_£t
(
PG_STATE_REMAPPED
);

5867 
¡©e_ş—r
(
PG_STATE_REMAPPED
);

5869 
	grŞe
 = 
osdm­
->
ÿlc_pg_rŞe
(
osd
->
whßmi
, 
aùšg
,‡ùšg.
size
());

5870 ià(
	gpoŞ
.
	gšfo
.
is_»¶iÿ‹d
(è|| 
	grŞe
 =ğ
pg_whßmi
.
sh¬d
)

5871 
£t_rŞe
(
rŞe
);

5873 
£t_rŞe
(-1);

5876 ià(!
	gÏ¡m­
) {

5877 
dout
(10è<< "‚ØÏ¡m­" << 
	gd’dl
;

5878 
	gdœty_šfo
 = 
Œue
;

5879 
	gdœty_big_šfo
 = 
Œue
;

5880 
	gšfo
.
	ghi¡Üy
.
	g§me_š‹rv®_sšû
 = 
osdm­
->
g‘_•och
();

5882 
	g¡d
::
¡ršg¡»am
 
debug
;

5883 
as£¹
(
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû
 != 0);

5884 
	gboo¡
::
scİed_±r
<
IsPGRecov”abËP»diÿ‹
> 
»cov”abË
(

5885 
g‘_is_»cov”abË_´ediÿ‹
());

5886 
boŞ
 
	gÃw_š‹rv®
 = 
Pa¡IÁ”v®s
::
check_Ãw_š‹rv®
(

5887 
Şd_aùšg_´im¬y
.
osd
,

5888 
Ãw_aùšg_´im¬y
,

5889 
Şdaùšg
, 
Ãwaùšg
,

5890 
Şd_up_´im¬y
.
osd
,

5891 
Ãw_up_´im¬y
,

5892 
Şdup
, 
Ãwup
,

5893 
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû
,

5894 
šfo
.
hi¡Üy
.
Ï¡_•och_ş—n
,

5895 
osdm­
,

5896 
Ï¡m­
,

5897 
šfo
.
pgid
.pgid,

5898 
»cov”abË
.
g‘
(),

5899 &
·¡_š‹rv®s
,

5900 &
debug
);

5901 
dout
(10è<< 
	g__func__
 << ": check_new_interval output: "

5902 << 
	gdebug
.
¡r
(è<< 
	gd’dl
;

5903 ià(
	gÃw_š‹rv®
) {

5904 ià(
	gosdm­
->
g‘_•och
(è=ğ
osd
->
g‘_su³rblock
().
Şde¡_m­
 &&

5905 
šfo
.
hi¡Üy
.
Ï¡_•och_ş—n
 < 
osdm­
->
g‘_•och
()) {

5906 
dout
(10è<< " m­ g­, cË¬šg…a¡_š‹rv® ªd fakšg" << 
d’dl
;

5909 
	g·¡_š‹rv®s
.
ş—r
();

5911 
dout
(10è<< "‚Ùšg…a¡ " << 
	g·¡_š‹rv®s
 << 
	gd’dl
;

5913 
	gdœty_šfo
 = 
Œue
;

5914 
	gdœty_big_šfo
 = 
Œue
;

5915 
	gšfo
.
	ghi¡Üy
.
	g§me_š‹rv®_sšû
 = 
osdm­
->
g‘_•och
();

5916 ià(
	gosdm­
->
have_pg_poŞ
(
šfo
.
pgid
.pgid.
poŞ
()) &&

5917 
	gšfo
.
	gpgid
.pgid.
is_¥l™
(
Ï¡m­
->
g‘_pg_num
(
šfo
.
pgid
.pgid.
poŞ
()),

5918 
osdm­
->
g‘_pg_num
(
šfo
.
pgid
.pgid.
poŞ
()),

5919 
nuÎ±r
)) {

5920 
	gšfo
.
	ghi¡Üy
.
	gÏ¡_•och_¥l™
 = 
osdm­
->
g‘_•och
();

5925 ià(
	gŞd_up_´im¬y
 !ğ
up_´im¬y
 ||

5926 
Şdup
 !ğ
up
) {

5927 
šfo
.
hi¡Üy
.
§me_up_sšû
 = 
osdm­
->
g‘_•och
();

5930 ià(
	gŞd_aùšg_´im¬y
 !ğ
g‘_´im¬y
()) {

5931 
šfo
.
hi¡Üy
.
§me_´im¬y_sšû
 = 
osdm­
->
g‘_•och
();

5934 
Ú_Ãw_š‹rv®
();

5936 
dout
(1è<< 
	g__func__
 << " u°" << 
	gŞdup
 << " -> " << 
	gup


5937 << ",‡ùšg " << 
	gŞdaùšg
 << " -> " << 
	gaùšg


5938 << ",‡ùšg_´im¬y " << 
	gŞd_aùšg_´im¬y
 << " -> " << 
	gÃw_aùšg_´im¬y


5939 << ", up_´im¬y " << 
	gŞd_up_´im¬y
 << " -> " << 
	gÃw_up_´im¬y


5940 << ",„Ş" << 
	gŞdrŞe
 << " -> " << 
	grŞe


5941 << ", f—tu» aùšg " << 
	gaùšg_ã©u»s


5942 << " u·ùšg " << 
	gu·ùšg_ã©u»s


5943 << 
	gd’dl
;

5946 
¡©e_ş—r
(
PG_STATE_ACTIVE
);

5947 
¡©e_ş—r
(
PG_STATE_PEERED
);

5948 
¡©e_ş—r
(
PG_STATE_DOWN
);

5949 
¡©e_ş—r
(
PG_STATE_RECOVERY_WAIT
);

5950 
¡©e_ş—r
(
PG_STATE_RECOVERY_TOOFULL
);

5951 
¡©e_ş—r
(
PG_STATE_RECOVERING
);

5953 
	g³”_purged
.
ş—r
();

5954 
	gaùšg_»cov”y_backfl
.
ş—r
();

5955 
	gsüub_queued
 = 
çl£
;

5958 ià(
	gwas_Şd_´im¬y
 || 
is_´im¬y
()) {

5959 
	gosd
->
»move_wªt_pg_‹mp
(
šfo
.
pgid
.pgid);

5960 } ià(
	gwas_Şd_»¶iÿ
 || 
is_»¶iÿ
()) {

5961 
	gosd
->
»move_wªt_pg_‹mp
(
šfo
.
pgid
.pgid);

5963 
ş—r_´im¬y_¡©e
();

5967 
Ú_chªge
(
t
);

5969 
	g´ojeùed_Ï¡_upd©e
 = 
ev”siÚ_t
();

5971 
as£¹
(!
d–‘šg
);

5974 
	g£nd_nÙify
 = !
is_´im¬y
();

5976 ià(
	grŞe
 !ğ
ŞdrŞe
 ||

5977 
was_Şd_´im¬y
 !ğ
is_´im¬y
()) {

5979 ià(
was_Şd_´im¬y
 !ğ
is_´im¬y
()) {

5980 
¡©e_ş—r
(
PG_STATE_CLEAN
);

5981 
ş—r_publish_¡©s
();

5984 
Ú_rŞe_chªge
();

5987 
»queue_İs
(
wa™šg_fÜ_³”ed
);

5992 ià(
g‘_´im¬y
(è!ğ
Şd_aùšg_´im¬y
) {

5993 
dout
(10è<< *
this
 << " " << 
Şdaùšg
 << " -> " << 
aùšg


5995 << 
Şd_aùšg_´im¬y
 << " -> " << 
g‘_´im¬y
()

5996 << 
d’dl
;

5999 ià(
is_´im¬y
()) {

6001 
¡©e_ş—r
(
PG_STATE_CLEAN
);

6003 
dout
(10è<< 
	gŞdaùšg
 << " -> " << 
	gaùšg


6004 << ",„•liÿ chªged" << 
	gd’dl
;

6008 
ÿnûl_»cov”y
();

6010 ià(
	gaùšg
.
em±y
(è&& !
	gup
.em±y(è&& 
	gup_´im¬y
 =ğ
pg_whßmi
) {

6011 
dout
(10è<< "‡ùšgƒm±y, buˆ˜am up[0], cË¬šg…g_‹mp" << 
d’dl
;

6012 
	gosd
->
queue_wªt_pg_‹mp
(
šfo
.
pgid
.pgid, 
aùšg
);

6016 
	gPG
::
	$Ú_Ãw_š‹rv®
()

6018 cÚ¡ 
OSDM­Ref
 
osdm­
 = 
	`g‘_osdm­
();

6020 
	`»g_Ãxt_süub
();

6023 
aùšg_ã©u»s
 = 
CEPH_FEATURES_SUPPORTED_DEFAULT
;

6024 
u·ùšg_ã©u»s
 = 
CEPH_FEATURES_SUPPORTED_DEFAULT
;

6025 
veùÜ
<>::
™”©Ü
 
p
 = 
aùšg
.
	`begš
();… !ğaùšg.
	`’d
(); ++p) {

6026 ià(*
p
 =ğ
CRUSH_ITEM_NONE
)

6028 
ušt64_t
 
f
 = 
osdm­
->
	`g‘_xšfo
(*
p
).
ã©u»s
;

6029 
aùšg_ã©u»s
 &ğ
f
;

6030 
u·ùšg_ã©u»s
 &ğ
f
;

6032 
veùÜ
<>::
™”©Ü
 
p
 = 
up
.
	`begš
();… !ğup.
	`’d
(); ++p) {

6033 ià(*
p
 =ğ
CRUSH_ITEM_NONE
)

6035 
u·ùšg_ã©u»s
 &ğ
osdm­
->
	`g‘_xšfo
(*
p
).
ã©u»s
;

6038 
	`_Ú_Ãw_š‹rv®
();

6039 
	}
}

6041 
	gPG
::
	$´oc_´im¬y_šfo
(
ObjeùStÜe
::
T¿n§ùiÚ
 &
t
, cÚ¡ 
pg_šfo_t
 &
ošfo
)

6043 
	`as£¹
(!
	`is_´im¬y
());

6045 
	`upd©e_hi¡Üy
(
ošfo
.
hi¡Üy
);

6046 ià(!
šfo
.
¡©s
.
¡©s_šv®id
 && info.¡©s.¡©s.
sum
.
num_süub_”rÜs
) {

6047 
šfo
.
¡©s
.¡©s.
sum
.
num_süub_”rÜs
 = 0;

6048 
šfo
.
¡©s
.¡©s.
sum
.
num_sh®low_süub_”rÜs
 = 0;

6049 
šfo
.
¡©s
.¡©s.
sum
.
num_d“p_süub_”rÜs
 = 0;

6050 
dœty_šfo
 = 
Œue
;

6053 ià(!(
šfo
.
purged_¢­s
 =ğ
ošfo
.purged_snaps)) {

6054 
	`dout
(10è<< 
__func__
 << " upd©šg…urged_¢­ tØ" << 
ošfo
.
purged_¢­s


6055 << 
d’dl
;

6056 
šfo
.
purged_¢­s
 = 
ošfo
.purged_snaps;

6057 
dœty_šfo
 = 
Œue
;

6058 
dœty_big_šfo
 = 
Œue
;

6060 
	}
}

6062 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gPG
& 
	gpg
)

6064 
	gout
 << "pg[" << 
	gpg
.
	gšfo


6065 << " " << 
	gpg
.
	gup
;

6066 ià(
	gpg
.
	gaùšg
 !ğ
pg
.
up
)

6067 
out
 << "/" << 
pg
.
aùšg
;

6068 ià(
	gpg
.
is_ec_pg
())

6069 
	gout
 << "p" << 
	gpg
.
g‘_´im¬y
();

6070 ià(!
	gpg
.
	gasync_»cov”y_rg‘s
.
em±y
())

6071 
	gout
 << "‡sync=[" << 
	gpg
.
	gasync_»cov”y_rg‘s
 << "]";

6072 ià(!
	gpg
.
	gbackfl_rg‘s
.
em±y
())

6073 
	gout
 << " backfl=[" << 
	gpg
.
	gbackfl_rg‘s
 << "]";

6074 
	gout
 << "„=" << 
	gpg
.
g‘_rŞe
();

6075 
	gout
 << "†´=" << 
	gpg
.
g‘_Ï¡_³”šg_»£t
();

6077 ià(
	gpg
.
	gd–‘šg
)

6078 
	gout
 << " DELETING";

6080 ià(!
	gpg
.
	g·¡_š‹rv®s
.
em±y
()) {

6081 
	gout
 << "…i=[" << 
	gpg
.
	g·¡_š‹rv®s
.
g‘_bounds
()

6082 << ")/" << 
	gpg
.
	g·¡_š‹rv®s
.
size
();

6085 ià(
	gpg
.
is_³”ed
()) {

6086 ià(
	gpg
.
	gÏ¡_upd©e_Údisk
 !ğ
pg
.
šfo
.
Ï¡_upd©e
)

6087 
out
 << "†uod=" << 
pg
.
Ï¡_upd©e_Údisk
;

6088 ià(
	gpg
.
	gÏ¡_upd©e_­¶›d
 !ğ
pg
.
šfo
.
Ï¡_upd©e
)

6089 
out
 << "†ua=" << 
pg
.
Ï¡_upd©e_­¶›d
;

6092 ià(
	gpg
.
	g»cov”y_İs_aùive
)

6093 
	gout
 << "„İs=" << 
	gpg
.
	g»cov”y_İs_aùive
;

6095 ià(
	gpg
.
	gpg_log
.
g‘_
(è!ğ
pg
.
šfo
.
log_
 ||

6096 
pg
.
pg_log
.
g‘_h—d
(è!ğpg.
šfo
.
Ï¡_upd©e
)

6097 
out
 << " (šfØmism©ch, " << 
pg
.
pg_log
.
g‘_log
() << ")";

6099 ià(!
	gpg
.
	gpg_log
.
g‘_log
().
em±y
()) {

6100 ià((
	gpg
.
	gpg_log
.
g‘_log
().
	glog
.
begš
()->
	gv”siÚ
 <ğ
pg
.
pg_log
.
g‘_
())) {

6101 
out
 << " (log bound mismatch,‡ctual=["

6102 << 
pg
.
pg_log
.
g‘_log
().
log
.
begš
()->
v”siÚ
 << ","

6103 << 
pg
.
pg_log
.
g‘_log
().
log
.
rbegš
()->
v”siÚ
 << "]";

6104 
	gout
 << ")";

6108 ià(!
	gpg
.
	gbackfl_rg‘s
.
em±y
())

6109 
	gout
 << " bá=" << 
	gpg
.
	gbackfl_rg‘s
;

6110 
	gout
 << " c¹=" << 
	gpg
.
	gpg_log
.
g‘_ÿn_rŞlback_to
();

6112 ià(
	gpg
.
	gÏ¡_com¶‘e_Údisk
 !ğ
pg
.
šfo
.
Ï¡_com¶‘e
)

6113 
out
 << "†cod " << 
pg
.
Ï¡_com¶‘e_Údisk
;

6115 ià(
	gpg
.
is_´im¬y
()) {

6116 
	gout
 << " mlcod " << 
	gpg
.
	gmš_Ï¡_com¶‘e_Údisk
;

6119 
	gout
 << " " << 
pg_¡©e_¡ršg
(
pg
.
g‘_¡©e
());

6120 ià(
	gpg
.
should_£nd_nÙify
())

6121 
	gout
 << " NOTIFY";

6123 ià(
	gpg
.
	gsüubb”
.
	gmu¡_»·œ
)

6124 
	gout
 << " MUST_REPAIR";

6125 ià(
	gpg
.
	gsüubb”
.
	gauto_»·œ
)

6126 
	gout
 << " AUTO_REPAIR";

6127 ià(
	gpg
.
	gsüubb”
.
	gmu¡_d“p_süub
)

6128 
	gout
 << " MUST_DEEP_SCRUB";

6129 ià(
	gpg
.
	gsüubb”
.
	gmu¡_süub
)

6130 
	gout
 << " MUST_SCRUB";

6133 ià(
	gpg
.
	gpg_log
.
g‘_missšg
().
num_missšg
()) {

6134 
	gout
 << " m=" << 
	gpg
.
	gpg_log
.
g‘_missšg
().
num_missšg
();

6135 ià(
	gpg
.
is_´im¬y
()) {

6136 
ušt64_t
 
	gunfound
 = 
pg
.
g‘_num_unfound
();

6137 ià(
	gunfound
)

6138 
	gout
 << " u=" << 
	gunfound
;

6141 ià(!
	gpg
.
is_ş—n
()) {

6142 
	gout
 << " mbc=" << 
	gpg
.
	gmissšg_loc
.
g‘_missšg_by_couÁ
();

6144 ià(!
	gpg
.
	g¢­_Œimq
.
em±y
()) {

6145 
	gout
 << "rimq=";

6147 ià(
	gpg
.
	g¢­_Œimq
.
num_š‹rv®s
() > 16) {

6148 
	gout
 << 
	gpg
.
	g¢­_Œimq
.
size
();

6150 
	gout
 << 
	gpg
.
	g¢­_Œimq
;

6153 ià(!
	gpg
.
	gšfo
.
	gpurged_¢­s
.
em±y
()) {

6154 
	gout
 << "…s=";

6155 ià(
	gpg
.
	gšfo
.
	gpurged_¢­s
.
num_š‹rv®s
() > 16) {

6156 
	gout
 << 
	gpg
.
	gšfo
.
	gpurged_¢­s
.
size
();

6158 
	gout
 << 
	gpg
.
	gšfo
.
	gpurged_¢­s
;

6162 
	gout
 << "]";

6165  
	gout
;

6168 
boŞ
 
	gPG
::
	$ÿn_disÿrd_İ
(
OpReque¡Ref
& 
İ
)

6170 cÚ¡ 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDOp*>(
İ
->
	`g‘_»q
());

6171 ià(
cù
->
_cÚf
->
osd_disÿrd_discÚÃùed_İs
 && 
OSD
::
	`İ_is_disÿrdabË
(
m
)) {

6172 
	`dout
(20è<< " disÿrd " << *
m
 << 
d’dl
;

6173  
Œue
;

6176 ià(
m
->
	`g‘_m­_•och
(è< 
šfo
.
hi¡Üy
.
§me_´im¬y_sšû
) {

6177 
	`dout
(7è<< " chªged‡á” " << 
m
->
	`g‘_m­_•och
()

6178 << ", drİpšg " << *
m
 << 
d’dl
;

6179  
Œue
;

6182 ià(
m
->
	`g‘_cÚÃùiÚ
()->
	`has_ã©u»
(
CEPH_FEATURE_RESEND_ON_SPLIT
)) {

6183 ià(
m
->
	`g‘_m­_•och
(è< 
poŞ
.
šfo
.
	`g‘_Ï¡_fÜû_İ_»£nd
()) {

6184 
	`dout
(7è<< 
__func__
 << " sent before†ast_force_op_resend "

6185 << 
poŞ
.
šfo
.
Ï¡_fÜû_İ_»£nd
 << ", drİpšg" << *
m
 << 
d’dl
;

6186  
Œue
;

6188 ià(
m
->
	`g‘_m­_•och
(è< 
šfo
.
hi¡Üy
.
Ï¡_•och_¥l™
) {

6189 
	`dout
(7è<< 
__func__
 << "…g split in "

6190 << 
šfo
.
hi¡Üy
.
Ï¡_•och_¥l™
 << ", drİpšg" << 
d’dl
;

6191  
Œue
;

6193 } ià(
m
->
	`g‘_cÚÃùiÚ
()->
	`has_ã©u»
(
CEPH_FEATURE_OSD_POOLRESEND
)) {

6194 ià(
m
->
	`g‘_m­_•och
(è< 
poŞ
.
šfo
.
	`g‘_Ï¡_fÜû_İ_»£nd_´–umšous
()) {

6195 
	`dout
(7è<< 
__func__
 << " sent before†ast_force_op_resend_preluminous "

6196 << 
poŞ
.
šfo
.
Ï¡_fÜû_İ_»£nd_´–umšous


6197 << ", drİpšg" << *
m
 << 
d’dl
;

6198  
Œue
;

6202  
çl£
;

6203 
	}
}

6205 
	g‹m¶©e
<
ty³Çme
 
	gT
, 
	gMSGTYPE
>

6206 
boŞ
 
	gPG
::
	$ÿn_disÿrd_»¶iÿ_İ
(
OpReque¡Ref
& 
İ
)

6208 cÚ¡ 
T
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ T *>(
İ
->
	`g‘_»q
());

6209 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
MSGTYPE
);

6211 
äom
 = 
m
->
	`g‘_sourû
().
	`num
();

6219 
OSDM­Ref
 
Ãxt_m­
 = 
osd
->
	`g‘_Ãxt_osdm­
();

6220 ià(
Ãxt_m­
->
	`is_down
(
äom
))

6221  
Œue
;

6227 ià(
Ãxt_m­
->
	`g‘_down_©
(
äom
è>ğ
m
->
m­_•och
)

6228  
Œue
;

6232 ià(
	`Şd_³”šg_msg
(
m
->
m­_•och
, m->map_epoch)) {

6233 
	`dout
(10è<< "ÿn_disÿrd_»¶iÿ_İ…g chªged " << 
šfo
.
hi¡Üy


6234 << "‡á” " << 
m
->
m­_•och


6235 << ", drİpšg" << 
d’dl
;

6236  
Œue
;

6238  
çl£
;

6239 
	}
}

6241 
boŞ
 
	gPG
::
	$ÿn_disÿrd_sÿn
(
OpReque¡Ref
 
İ
)

6243 cÚ¡ 
MOSDPGSÿn
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDPGSÿÀ*>(
İ
->
	`g‘_»q
());

6244 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
MSG_OSD_PG_SCAN
);

6246 ià(
	`Şd_³”šg_msg
(
m
->
m­_•och
, m->
qu”y_•och
)) {

6247 
	`dout
(10è<< " gÙ old sÿn, ignÜšg" << 
d’dl
;

6248  
Œue
;

6250  
çl£
;

6251 
	}
}

6253 
boŞ
 
	gPG
::
	$ÿn_disÿrd_backfl
(
OpReque¡Ref
 
İ
)

6255 cÚ¡ 
MOSDPGBackfl
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDPGBackfÈ*>(
İ
->
	`g‘_»q
());

6256 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
MSG_OSD_PG_BACKFILL
);

6258 ià(
	`Şd_³”šg_msg
(
m
->
m­_•och
, m->
qu”y_•och
)) {

6259 
	`dout
(10è<< " gÙ old backfl, ignÜšg" << 
d’dl
;

6260  
Œue
;

6263  
çl£
;

6265 
	}
}

6267 
boŞ
 
	gPG
::
	$ÿn_disÿrd_»que¡
(
OpReque¡Ref
& 
İ
)

6269 
İ
->
	`g‘_»q
()->
	`g‘_ty³
()) {

6270 
CEPH_MSG_OSD_OP
:

6271  
	`ÿn_disÿrd_İ
(
İ
);

6272 
CEPH_MSG_OSD_BACKOFF
:

6273  
çl£
;

6274 
MSG_OSD_REPOP
:

6275  
ÿn_disÿrd_»¶iÿ_İ
<
MOSDR•Op
, 
MSG_OSD_REPOP
>(
İ
);

6276 
MSG_OSD_PG_PUSH
:

6277  
ÿn_disÿrd_»¶iÿ_İ
<
MOSDPGPush
, 
MSG_OSD_PG_PUSH
>(
İ
);

6278 
MSG_OSD_PG_PULL
:

6279  
ÿn_disÿrd_»¶iÿ_İ
<
MOSDPGPuÎ
, 
MSG_OSD_PG_PULL
>(
İ
);

6280 
MSG_OSD_PG_PUSH_REPLY
:

6281  
ÿn_disÿrd_»¶iÿ_İ
<
MOSDPGPushR•ly
, 
MSG_OSD_PG_PUSH_REPLY
>(
İ
);

6282 
MSG_OSD_REPOPREPLY
:

6283  
ÿn_disÿrd_»¶iÿ_İ
<
MOSDR•OpR•ly
, 
MSG_OSD_REPOPREPLY
>(
İ
);

6284 
MSG_OSD_PG_RECOVERY_DELETE
:

6285  
ÿn_disÿrd_»¶iÿ_İ
<
MOSDPGRecov”yD–‘e
, 
MSG_OSD_PG_RECOVERY_DELETE
>(
İ
);

6287 
MSG_OSD_PG_RECOVERY_DELETE_REPLY
:

6288  
ÿn_disÿrd_»¶iÿ_İ
<
MOSDPGRecov”yD–‘eR•ly
, 
MSG_OSD_PG_RECOVERY_DELETE_REPLY
>(
İ
);

6290 
MSG_OSD_EC_WRITE
:

6291  
ÿn_disÿrd_»¶iÿ_İ
<
MOSDECSubOpWr™e
, 
MSG_OSD_EC_WRITE
>(
İ
);

6292 
MSG_OSD_EC_WRITE_REPLY
:

6293  
ÿn_disÿrd_»¶iÿ_İ
<
MOSDECSubOpWr™eR•ly
, 
MSG_OSD_EC_WRITE_REPLY
>(
İ
);

6294 
MSG_OSD_EC_READ
:

6295  
ÿn_disÿrd_»¶iÿ_İ
<
MOSDECSubOpR—d
, 
MSG_OSD_EC_READ
>(
İ
);

6296 
MSG_OSD_EC_READ_REPLY
:

6297  
ÿn_disÿrd_»¶iÿ_İ
<
MOSDECSubOpR—dR•ly
, 
MSG_OSD_EC_READ_REPLY
>(
İ
);

6298 
MSG_OSD_REP_SCRUB
:

6299  
ÿn_disÿrd_»¶iÿ_İ
<
MOSDR•Süub
, 
MSG_OSD_REP_SCRUB
>(
İ
);

6300 
MSG_OSD_SCRUB_RESERVE
:

6301  
ÿn_disÿrd_»¶iÿ_İ
<
MOSDSüubRe£rve
, 
MSG_OSD_SCRUB_RESERVE
>(
İ
);

6302 
MSG_OSD_REP_SCRUBMAP
:

6303  
ÿn_disÿrd_»¶iÿ_İ
<
MOSDR•SüubM­
, 
MSG_OSD_REP_SCRUBMAP
>(
İ
);

6304 
MSG_OSD_PG_UPDATE_LOG_MISSING
:

6305  
ÿn_disÿrd_»¶iÿ_İ
<

6306 
MOSDPGUpd©eLogMissšg
, 
MSG_OSD_PG_UPDATE_LOG_MISSING
>(
İ
);

6307 
MSG_OSD_PG_UPDATE_LOG_MISSING_REPLY
:

6308  
ÿn_disÿrd_»¶iÿ_İ
<

6309 
MOSDPGUpd©eLogMissšgR•ly
, 
MSG_OSD_PG_UPDATE_LOG_MISSING_REPLY
>(
İ
);

6311 
MSG_OSD_PG_SCAN
:

6312  
	`ÿn_disÿrd_sÿn
(
İ
);

6313 
MSG_OSD_PG_BACKFILL
:

6314  
	`ÿn_disÿrd_backfl
(
İ
);

6315 
MSG_OSD_PG_BACKFILL_REMOVE
:

6316  
ÿn_disÿrd_»¶iÿ_İ
<
MOSDPGBackflRemove
,

6317 
MSG_OSD_PG_BACKFILL_REMOVE
>(
İ
);

6319  
Œue
;

6320 
	}
}

6322 
	gPG
::
	$ke_wa™”s
()

6324 
	`dout
(10è<< "ke_wa™”s" << 
d’dl
;

6325 
	`»queue_m­_wa™”s
();

6326 
	}
}

6328 
	gPG
::
	$do_³”šg_ev’t
(
PGP“ršgEv’tRef
 
evt
, 
Recov”yCtx
 *
rùx
)

6330 
	`dout
(10è<< 
__func__
 << ": " << 
evt
->
	`g‘_desc
(è<< 
d’dl
;

6331 
	`as£¹
(
	`have_§me_Ü_Ãw”_m­
(
evt
->
	`g‘_•och_£Á
()));

6332 ià(
	`Şd_³”šg_evt
(
evt
)) {

6333 
	`dout
(10è<< "disÿrd old " << 
evt
->
	`g‘_desc
(è<< 
d’dl
;

6335 
»cov”y_¡©e
.
	`hªdË_ev’t
(
evt
, 
rùx
);

6339 
	`wr™e_if_dœty
(*
rùx
->
Œª§ùiÚ
);

6340 
	}
}

6342 
	gPG
::
	$queue_³”šg_ev’t
(
PGP“ršgEv’tRef
 
evt
)

6344 ià(
	`Şd_³”šg_evt
(
evt
))

6346 
osd
->osd->
	`’queue_³”šg_evt
(
šfo
.
pgid
, 
evt
);

6347 
	}
}

6349 
	gPG
::
	$queue_nuÎ
(
•och_t
 
msg_•och
,

6350 
•och_t
 
qu”y_•och
)

6352 
	`dout
(10è<< "nuÎ" << 
d’dl
;

6353 
	`queue_³”šg_ev’t
(

6354 
	`PGP“ršgEv’tRef
(
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(
msg_•och
, 
qu”y_•och
,

6355 
	`NuÎEvt
())));

6356 
	}
}

6358 
	gPG
::
	$queue_qu”y
(
•och_t
 
msg_•och
,

6359 
•och_t
 
qu”y_•och
,

6360 
pg_sh¬d_t
 
äom
, cÚ¡ 
pg_qu”y_t
& 
q
)

6362 
	`dout
(10è<< "hªdË_qu”y " << 
q
 << " from„•liÿ " << 
äom
 << 
d’dl
;

6363 
	`queue_³”šg_ev’t
(

6364 
	`PGP“ršgEv’tRef
(

6365 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

6366 
msg_•och
, 
qu”y_•och
,

6367 
	`MQu”y
(
šfo
.
pgid
, 
äom
, 
q
, 
qu”y_•och
))));

6368 
	}
}

6370 
	gPG
::
	$fšd_unfound
(
•och_t
 
queued
, 
Recov”yCtx
 *
rùx
)

6378 
	`discov”_®l_missšg
(*
rùx
->
qu”y_m­
);

6379 ià(
rùx
->
qu”y_m­
->
	`em±y
()) {

6380 
¡ršg
 
aùiÚ
;

6381 ià(
	`¡©e_‹¡
(
PG_STATE_BACKFILLING
)) {

6382 autØ
evt
 = 
	`PGP“ršgEv’tRef
(

6383 
Ãw
 
	`PGP“ršgEv’t
(

6384 
queued
,

6385 
queued
,

6386 
PG
::
	`UnfoundBackfl
()));

6387 
	`queue_³”šg_ev’t
(
evt
);

6388 
aùiÚ
 = "in backfill";

6389 } ià(
	`¡©e_‹¡
(
PG_STATE_RECOVERING
)) {

6390 autØ
evt
 = 
	`PGP“ršgEv’tRef
(

6391 
Ãw
 
	`PGP“ršgEv’t
(

6392 
queued
,

6393 
queued
,

6394 
PG
::
	`UnfoundRecov”y
()));

6395 
	`queue_³”šg_ev’t
(
evt
);

6396 
aùiÚ
 = "in„ecovery";

6398 
aùiÚ
 = "already out of„ecovery/backfill";

6400 
	`dout
(10è<< 
__func__
 << ":‚Øluck, givšg u°Úhi pg fÜ‚ow (" << 
aùiÚ
 << ")" << 
d’dl
;

6402 
	`dout
(10è<< 
__func__
 << ":‚Øluck, givšg u°Úhi pg fÜ‚ow (queue_»cov”y)" << 
d’dl
;

6403 
	`queue_»cov”y
();

6405 
	}
}

6407 
	gPG
::
hªdË_advªû_m­
(

6408 
OSDM­Ref
 
osdm­
, OSDM­Reà
Ï¡m­
,

6409 
veùÜ
<>& 
Ãwup
, 
up_´im¬y
,

6410 
veùÜ
<>& 
Ãwaùšg
, 
aùšg_´im¬y
,

6411 
Recov”yCtx
 *
rùx
)

6413 
as£¹
(
Ï¡m­
->
g‘_•och
(è=ğ
osdm­_»f
->get_epoch());

6414 
as£¹
(
Ï¡m­
 =ğ
osdm­_»f
);

6415 
dout
(10) << "handle_advance_map "

6416 << 
	gÃwup
 << "/" << 
	gÃwaùšg


6417 << " -- " << 
	gup_´im¬y
 << "/" << 
	gaùšg_´im¬y


6418 << 
	gd’dl
;

6419 
upd©e_osdm­_»f
(
osdm­
);

6420 
	gosd_sh¬d
->
upd©e_pg_•och
(
pg_¦Ù
, 
osdm­
->
g‘_•och
());

6422 
	gpoŞ
.
upd©e
(
cù
, 
osdm­
);

6424 
AdvM­
 
evt
(

6425 
osdm­
, 
Ï¡m­
, 
Ãwup
, 
up_´im¬y
,

6426 
Ãwaùšg
, 
aùšg_´im¬y
);

6427 
	g»cov”y_¡©e
.
hªdË_ev’t
(
evt
, 
rùx
);

6428 ià(
	gpoŞ
.
	gšfo
.
	gÏ¡_chªge
 =ğ
osdm­_»f
->
g‘_•och
()) {

6429 
Ú_poŞ_chªge
();

6430 
upd©e_¡Üe_w™h_İtiÚs
();

6432 
	gÏ¡_»quœe_osd_»Ëa£
 = 
osdm­
->
»quœe_osd_»Ëa£
;

6435 
	gPG
::
	$hªdË_aùiv©e_m­
(
Recov”yCtx
 *
rùx
)

6437 
	`dout
(10è<< "hªdË_aùiv©e_m­ " << 
d’dl
;

6438 
AùM­
 
evt
;

6439 
»cov”y_¡©e
.
	`hªdË_ev’t
(
evt
, 
rùx
);

6440 ià(
osdm­_»f
->
	`g‘_•och
(è- 
Ï¡_³rsi¡ed_osdm­
 >

6441 
cù
->
_cÚf
->
osd_pg_•och_³rsi¡ed_max_¡®e
) {

6442 
	`dout
(20è<< 
__func__
 << ": Dirtying info:†ast_persisted is "

6443 << 
Ï¡_³rsi¡ed_osdm­


6444 << " whcu¼’ˆi " << 
osdm­_»f
->
	`g‘_•och
(è<< 
d’dl
;

6445 
dœty_šfo
 = 
Œue
;

6447 
	`dout
(20è<< 
__func__
 << ": Not dirtying info:†ast_persisted is "

6448 << 
Ï¡_³rsi¡ed_osdm­


6449 << " whcu¼’ˆi " << 
osdm­_»f
->
	`g‘_•och
(è<< 
d’dl
;

6451 ià(
osdm­_»f
->
	`check_Ãw_bÏckli¡_’Œ›s
()) {

6452 
	`check_bÏckli¡ed_w©ch”s
();

6454 
	`wr™e_if_dœty
(*
rùx
->
Œª§ùiÚ
);

6455 
	}
}

6457 
	gPG
::
	$hªdË_š™Ÿlize
(
Recov”yCtx
 *
rùx
)

6459 
	`dout
(10è<< 
__func__
 << 
d’dl
;

6460 
In™Ÿlize
 
evt
;

6461 
»cov”y_¡©e
.
	`hªdË_ev’t
(
evt
, 
rùx
);

6462 
	}
}

6464 
	gPG
::
	$hªdË_qu”y_¡©e
(
FÜm©‹r
 *
f
)

6466 
	`dout
(10è<< "hªdË_qu”y_¡©e" << 
d’dl
;

6467 
Qu”yS‹
 
	`q
(
f
);

6468 
»cov”y_¡©e
.
	`hªdË_ev’t
(
q
, 0);

6469 
	}
}

6471 
	gPG
::
	$upd©e_¡Üe_w™h_İtiÚs
()

6473 autØ
r
 = 
osd
->
¡Üe
->
	`£t_cŞËùiÚ_İts
(
ch
, 
poŞ
.
šfo
.
İts
);

6474 if(
r
 < 0 &&„ !ğ-
EOPNOTSUPP
) {

6475 
d”r
 << 
__func__
 << " s‘_cŞËùiÚ_İt »tuº ”rÜ:" << 
r
 << 
d’dl
;

6477 
	}
}

6479 
	gC_D–‘eMÜe
 : 
public
 
CÚ‹xt
 {

6480 
PGRef
 
pg
;

6481 
•och_t
 
	g•och
;

6482 
C_D–‘eMÜe
(
PG
 *
p
, 
•och_t
 
e
è: 
pg
Õ), 
•och
(e) {}

6483 
fšish
(
r
è
	gov”ride
 {

6484 
ûph_abÜt
();

6486 
com¶‘e
(
r
è
	gov”ride
 {

6487 
as£¹
(
r
 == 0);

6488 
	gpg
->
lock
();

6489 ià(!
	gpg
->
pg_has_»£t_sšû
(
•och
)) {

6490 
	gpg
->
	gosd
->
queue_fÜ_pg_d–‘e
(
pg
->
g‘_pgid
(), 
•och
);

6492 
	gpg
->
uÆock
();

6493 
d–‘e
 
	gthis
;

6497 
	gPG
::
	$_d–‘e_some
(
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

6499 
	`dout
(10è<< 
__func__
 << 
d’dl
;

6501 
veùÜ
<
ghobjeù_t
> 
Şi¡
;

6502 
max
 = 
¡d
::
	`mš
(
osd
->
¡Üe
->
	`g‘_id—l_li¡_max
(),

6503 ()
cù
->
_cÚf
->
osd_rg‘_Œª§ùiÚ_size
);

6504 
ghobjeù_t
 
Ãxt
;

6505 
osd
->
¡Üe
->
	`cŞËùiÚ_li¡
(

6506 
ch
,

6507 
Ãxt
,

6508 
ghobjeù_t
::
	`g‘_max
(),

6509 
max
,

6510 &
Şi¡
,

6511 &
Ãxt
);

6512 
	`dout
(20è<< 
__func__
 << " " << 
Şi¡
 << 
d’dl
;

6514 
OSDriv”
::
OST¿n§ùiÚ
 
	`_t
(
osdriv”
.
	`g‘_Œª§ùiÚ
(
t
));

6515 
št64_t
 
num
 = 0;

6516 auto& 
oid
 : 
Şi¡
) {

6517 ià(
oid
.
	`is_pgm‘a
()) {

6520 
r
 = 
¢­_m­³r
.
	`»move_oid
(
oid
.
hobj
, &
_t
);

6521 ià(
r
 !ğ0 &&„ !ğ-
ENOENT
) {

6522 
	`ûph_abÜt
();

6524 
t
->
	`»move
(
cŞl
, 
oid
);

6525 ++
num
;

6527 
•och_t
 
e
 = 
	`g‘_osdm­
()->
	`g‘_•och
();

6528 ià(
num
) {

6529 
	`dout
(20è<< 
__func__
 << " d–‘šg " << 
num
 << " objeùs" << 
d’dl
;

6530 
CÚ‹xt
 *
fš
 = 
Ãw
 
	`C_D–‘eMÜe
(
this
, 
e
);

6531 
t
->
	`»gi¡”_Ú_comm™
(
fš
);

6533 
	`dout
(20è<< 
__func__
 << " fšished" << 
d’dl
;

6534 ià(
cù
->
_cÚf
->
osd_šjeù_çu»_Ú_pg_»mov®
) {

6535 
	`_ex™
(1);

6541 
PGRef
 
	`pg»f
(
this
);

6542 
PGLog
::
	`ş—r_šfo_log
(
šfo
.
pgid
, 
t
);

6543 
t
->
	`»move_cŞËùiÚ
(
cŞl
);

6544 
t
->
	`»gi¡”_Ú_comm™
(
Ãw
 
CÚš”CÚ‹xt
<
PGRef
>(
pg»f
));

6545 
t
->
	`»gi¡”_Ú_­¶›d
(
Ãw
 
CÚš”CÚ‹xt
<
PGRef
>(
pg»f
));

6546 
osd
->
¡Üe
->
	`queue_Œª§ùiÚ
(
ch
, 
¡d
::
	`move
(*
t
));

6548 
ch
->
	`æush
();

6550 
osd
->
	`fšish_pg_d–‘e
(
this
, 
poŞ
.
šfo
.
	`g‘_pg_num
());

6551 
d–‘ed
 = 
Œue
;

6555 
osd
->
loÿl_»£rv”
.
	`ÿnûl_»£rv©iÚ
(
šfo
.
pgid
);

6557 
osd
->
logg”
->
	`dec
(
l_osd_pg_»movšg
);

6559 
	}
}

6564 #undeà
dout_´efix


6565 
	#dout_´efix
 (
cÚ‹xt
< 
Recov”yMachše
 >().
pg
->
	`g’_´efix
(*
_dout
) \

6566 << "¡©e<" << 
	`g‘_¡©e_Çme
(è<< ">: ")

	)

6569 
	gPG
::
Recov”yS‹
::
C¿shed
::
	$C¿shed
(
my_cÚ‹xt
 
ùx
)

6570 : 
	`my_ba£
(
ùx
),

6571 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Crashed")

6573 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

6574 
	`as£¹
(0 == "we got‡ bad state machineƒvent");

6575 
	}
}

6579 
	gPG
::
Recov”yS‹
::
In™Ÿl
::
	$In™Ÿl
(
my_cÚ‹xt
 
ùx
)

6580 : 
	`my_ba£
(
ùx
),

6581 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Initial")

6583 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

6584 
	}
}

6586 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
In™Ÿl
::
	$»aù
(cÚ¡ 
MNÙifyRec
& 
nÙify
)

6588 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6589 
pg
->
	`´oc_»¶iÿ_šfo
(

6590 
nÙify
.
äom
,‚Ùify.nÙify.
šfo
,‚Ùify.nÙify.
•och_£Á
);

6591 
pg
->
	`£t_Ï¡_³”šg_»£t
();

6592  
Œªs™
< 
Prim¬y
 >();

6593 
	}
}

6595 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
In™Ÿl
::
	$»aù
(cÚ¡ 
MInfoRec
& 
i
)

6597 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6598 
	`as£¹
(!
pg
->
	`is_´im¬y
());

6599 
	`po¡_ev’t
(
i
);

6600  
Œªs™
< 
SŒay
 >();

6601 
	}
}

6603 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
In™Ÿl
::
	$»aù
(cÚ¡ 
MLogRec
& 
i
)

6605 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6606 
	`as£¹
(!
pg
->
	`is_´im¬y
());

6607 
	`po¡_ev’t
(
i
);

6608  
Œªs™
< 
SŒay
 >();

6609 
	}
}

6611 
	gPG
::
Recov”yS‹
::
In™Ÿl
::
	$ex™
()

6613 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

6614 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6615 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

6616 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_š™Ÿl_Ï‹ncy
, 
dur
);

6617 
	}
}

6620 
	gPG
::
Recov”yS‹
::
S¹ed
::
	$S¹ed
(
my_cÚ‹xt
 
ùx
)

6621 : 
	`my_ba£
(
ùx
),

6622 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started")

6624 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

6625 
	}
}

6627 
	gboo¡
::
¡©ech¬t
::
»suÉ


6628 
PG
::
Recov”yS‹
::
S¹ed
::
	$»aù
(cÚ¡ 
IÁ”v®Flush
&)

6630 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6631 
	`ldout
(
pg
->
cù
, 10è<< "Endšg blocked outgošg„ecov”y mes§ges" << 
d’dl
;

6632 
cÚ‹xt
< 
Recov”yMachše
 >().
pg
->
»cov”y_¡©e
.
	`’d_block_outgošg
();

6633  
	`disÿrd_ev’t
();

6634 
	}
}

6636 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
S¹ed
::
	$»aù
(cÚ¡ 
AdvM­
& 
advm­
)

6638 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6639 
	`ldout
(
pg
->
cù
, 10è<< "S¹ed‡dvm­" << 
d’dl
;

6640 
pg
->
	`check_fuÎ_Œªs™iÚ
(
advm­
.
Ï¡m­
,‡dvm­.
osdm­
);

6641 ià(
pg
->
	`should_»¡¬t_³”šg
(

6642 
advm­
.
up_´im¬y
,

6643 
advm­
.
aùšg_´im¬y
,

6644 
advm­
.
Ãwup
,

6645 
advm­
.
Ãwaùšg
,

6646 
advm­
.
Ï¡m­
,

6647 
advm­
.
osdm­
)) {

6648 
	`ldout
(
pg
->
cù
, 10) << "should_restart_peering,ransitioningo Reset"

6649 << 
d’dl
;

6650 
	`po¡_ev’t
(
advm­
);

6651  
Œªs™
< 
Re£t
 >();

6653 
pg
->
	`»move_down_³”_šfo
(
advm­
.
osdm­
);

6654  
	`disÿrd_ev’t
();

6655 
	}
}

6657 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
S¹ed
::
	$»aù
(cÚ¡ 
Qu”yS‹
& 
q
)

6659 
q
.
f
->
	`İ’_objeù_£ùiÚ
("state");

6660 
q
.
f
->
	`dump_¡ršg
("Çme", 
¡©e_Çme
);

6661 
q
.
f
->
	`dump_¡»am
("’‹r_time"è<< 
’‹r_time
;

6662 
q
.
f
->
	`şo£_£ùiÚ
();

6663  
	`disÿrd_ev’t
();

6664 
	}
}

6666 
	gPG
::
Recov”yS‹
::
S¹ed
::
	$ex™
()

6668 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

6669 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6670 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

6671 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_¡¬‹d_Ï‹ncy
, 
dur
);

6672 
	}
}

6675 
	gPG
::
Recov”yS‹
::
Re£t
::
	$Re£t
(
my_cÚ‹xt
 
ùx
)

6676 : 
	`my_ba£
(
ùx
),

6677 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Reset")

6679 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

6680 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6682 
pg
->
æushes_š_´og»ss
 = 0;

6683 
pg
->
	`£t_Ï¡_³”šg_»£t
();

6684 
	}
}

6686 
	gboo¡
::
¡©ech¬t
::
»suÉ


6687 
PG
::
Recov”yS‹
::
Re£t
::
	$»aù
(cÚ¡ 
IÁ”v®Flush
&)

6689 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6690 
	`ldout
(
pg
->
cù
, 10è<< "Endšg blocked outgošg„ecov”y mes§ges" << 
d’dl
;

6691 
cÚ‹xt
< 
Recov”yMachše
 >().
pg
->
»cov”y_¡©e
.
	`’d_block_outgošg
();

6692  
	`disÿrd_ev’t
();

6693 
	}
}

6695 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Re£t
::
	$»aù
(cÚ¡ 
AdvM­
& 
advm­
)

6697 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6698 
	`ldout
(
pg
->
cù
, 10è<< "Re£ˆadvm­" << 
d’dl
;

6700 
pg
->
	`check_fuÎ_Œªs™iÚ
(
advm­
.
Ï¡m­
,‡dvm­.
osdm­
);

6702 ià(
pg
->
	`should_»¡¬t_³”šg
(

6703 
advm­
.
up_´im¬y
,

6704 
advm­
.
aùšg_´im¬y
,

6705 
advm­
.
Ãwup
,

6706 
advm­
.
Ãwaùšg
,

6707 
advm­
.
Ï¡m­
,

6708 
advm­
.
osdm­
)) {

6709 
	`ldout
(
pg
->
cù
, 10) << "should„estart…eering, calling start_peering_interval‡gain"

6710 << 
d’dl
;

6711 
pg
->
	`¡¬t_³”šg_š‹rv®
(

6712 
advm­
.
Ï¡m­
,

6713 
advm­
.
Ãwup
,‡dvm­.
up_´im¬y
,

6714 
advm­
.
Ãwaùšg
,‡dvm­.
aùšg_´im¬y
,

6715 
cÚ‹xt
< 
Recov”yMachše
 >().
	`g‘_cur_Œª§ùiÚ
());

6717 
pg
->
	`»move_down_³”_šfo
(
advm­
.
osdm­
);

6718 
pg
->
	`check_·¡_š‹rv®_bounds
();

6719  
	`disÿrd_ev’t
();

6720 
	}
}

6722 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Re£t
::
	$»aù
(cÚ¡ 
AùM­
&)

6724 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6725 ià(
pg
->
	`should_£nd_nÙify
(è&&…g->
	`g‘_´im¬y
().
osd
 >= 0) {

6726 
cÚ‹xt
< 
Recov”yMachše
 >().
	`£nd_nÙify
(

6727 
pg
->
	`g‘_´im¬y
(),

6728 
	`pg_nÙify_t
(

6729 
pg
->
	`g‘_´im¬y
().
sh¬d
,…g->
pg_whßmi
.shard,

6730 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
(),

6731 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
(),

6732 
pg
->
šfo
),

6733 
pg
->
·¡_š‹rv®s
);

6736 
pg
->
	`upd©e_h—¹b—t_³”s
();

6737 
pg
->
	`ke_wa™”s
();

6739  
Œªs™
< 
S¹ed
 >();

6740 
	}
}

6742 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Re£t
::
	$»aù
(cÚ¡ 
Qu”yS‹
& 
q
)

6744 
q
.
f
->
	`İ’_objeù_£ùiÚ
("state");

6745 
q
.
f
->
	`dump_¡ršg
("Çme", 
¡©e_Çme
);

6746 
q
.
f
->
	`dump_¡»am
("’‹r_time"è<< 
’‹r_time
;

6747 
q
.
f
->
	`şo£_£ùiÚ
();

6748  
	`disÿrd_ev’t
();

6749 
	}
}

6751 
	gPG
::
Recov”yS‹
::
Re£t
::
	$ex™
()

6753 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

6754 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6755 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

6756 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_»£t_Ï‹ncy
, 
dur
);

6757 
	}
}

6760 
	gPG
::
Recov”yS‹
::
S¹
::
	$S¹
(
my_cÚ‹xt
 
ùx
)

6761 : 
	`my_ba£
(
ùx
),

6762 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Start")

6764 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

6766 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6767 ià(
pg
->
	`is_´im¬y
()) {

6768 
	`ldout
(
pg
->
cù
, 1è<< "Œªs™iÚšgØPrim¬y" << 
d’dl
;

6769 
	`po¡_ev’t
(
	`MakePrim¬y
());

6771 
	`ldout
(
pg
->
cù
, 1è<< "Œªs™iÚšgØSŒay" << 
d’dl
;

6772 
	`po¡_ev’t
(
	`MakeSŒay
());

6774 
	}
}

6776 
	gPG
::
Recov”yS‹
::
S¹
::
	$ex™
()

6778 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

6779 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6780 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

6781 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_¡¬t_Ï‹ncy
, 
dur
);

6782 
	}
}

6785 
	gPG
::
Recov”yS‹
::
Prim¬y
::
	$Prim¬y
(
my_cÚ‹xt
 
ùx
)

6786 : 
	`my_ba£
(
ùx
),

6787 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary")

6789 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

6790 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6791 
	`as£¹
(
pg
->
wªt_aùšg
.
	`em±y
());

6794 ià(
pg
->
šfo
.
hi¡Üy
.
Ï¡_•och_¡¬‹d
 == 0) {

6795 
pg
->
	`¡©e_£t
(
PG_STATE_CREATING
);

6798 
utime_t
 
t
 = 
pg
->
šfo
.
hi¡Üy
.
Ï¡_süub_¡amp
;

6799 
pg
->
šfo
.
¡©s
.
Ï¡_äesh
 = 
t
;

6800 
pg
->
šfo
.
¡©s
.
Ï¡_aùive
 = 
t
;

6801 
pg
->
šfo
.
¡©s
.
Ï¡_chªge
 = 
t
;

6802 
pg
->
šfo
.
¡©s
.
Ï¡_³”ed
 = 
t
;

6803 
pg
->
šfo
.
¡©s
.
Ï¡_ş—n
 = 
t
;

6804 
pg
->
šfo
.
¡©s
.
Ï¡_un¡®e
 = 
t
;

6805 
pg
->
šfo
.
¡©s
.
Ï¡_undeg¿ded
 = 
t
;

6806 
pg
->
šfo
.
¡©s
.
Ï¡_fuÎsized
 = 
t
;

6807 
pg
->
šfo
.
¡©s
.
Ï¡_süub_¡amp
 = 
t
;

6808 
pg
->
šfo
.
¡©s
.
Ï¡_d“p_süub_¡amp
 = 
t
;

6809 
pg
->
šfo
.
¡©s
.
Ï¡_ş—n_süub_¡amp
 = 
t
;

6811 
	}
}

6813 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Prim¬y
::
	$»aù
(cÚ¡ 
MNÙifyRec
& 
nÙevt
)

6815 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6816 
	`ldout
(
pg
->
cù
, 7è<< "hªdË_pg_nÙify from osd." << 
nÙevt
.
äom
 << 
d’dl
;

6817 
pg
->
	`´oc_»¶iÿ_šfo
(

6818 
nÙevt
.
äom
,‚Ùevt.
nÙify
.
šfo
,‚Ùevt.nÙify.
•och_£Á
);

6819  
	`disÿrd_ev’t
();

6820 
	}
}

6822 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Prim¬y
::
	$»aù
(cÚ¡ 
AùM­
&)

6824 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6825 
	`ldout
(
pg
->
cù
, 7è<< "hªdË AùM­…rim¬y" << 
d’dl
;

6826 
pg
->
	`publish_¡©s_to_osd
();

6827 
pg
->
	`ke_wa™”s
();

6828  
	`disÿrd_ev’t
();

6829 
	}
}

6831 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Prim¬y
::
	$»aù
(

6832 cÚ¡ 
S‘FÜûRecov”y
&)

6834 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6835 
pg
->
	`£t_fÜû_»cov”y
(
Œue
);

6836  
	`disÿrd_ev’t
();

6837 
	}
}

6839 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Prim¬y
::
	$»aù
(

6840 cÚ¡ 
Un£tFÜûRecov”y
&)

6842 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6843 
pg
->
	`£t_fÜû_»cov”y
(
çl£
);

6844  
	`disÿrd_ev’t
();

6845 
	}
}

6847 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Prim¬y
::
	$»aù
(

6848 cÚ¡ 
Reque¡Süub
& 
evt
)

6850 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6851 ià(
pg
->
	`is_´im¬y
()) {

6852 
pg
->
	`uÄeg_Ãxt_süub
();

6853 
pg
->
süubb”
.
mu¡_süub
 = 
Œue
;

6854 
pg
->
süubb”
.
mu¡_d“p_süub
 = 
evt
.
d“p
 ||ƒvt.
»·œ
;

6855 
pg
->
süubb”
.
mu¡_»·œ
 = 
evt
.
»·œ
;

6856 
pg
->
	`»g_Ãxt_süub
();

6857 
	`ldout
(
pg
->
cù
,10è<< "m¬kšg fÜ süub" << 
d’dl
;

6859  
	`disÿrd_ev’t
();

6860 
	}
}

6862 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Prim¬y
::
	$»aù
(

6863 cÚ¡ 
S‘FÜûBackfl
&)

6865 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6866 
pg
->
	`£t_fÜû_backfl
(
Œue
);

6867  
	`disÿrd_ev’t
();

6868 
	}
}

6870 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Prim¬y
::
	$»aù
(

6871 cÚ¡ 
Un£tFÜûBackfl
&)

6873 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6874 
pg
->
	`£t_fÜû_backfl
(
çl£
);

6875  
	`disÿrd_ev’t
();

6876 
	}
}

6878 
	gPG
::
Recov”yS‹
::
Prim¬y
::
	$ex™
()

6880 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

6881 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6882 
pg
->
wªt_aùšg
.
	`ş—r
();

6883 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

6884 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_´im¬y_Ï‹ncy
, 
dur
);

6885 
pg
->
	`ş—r_´im¬y_¡©e
();

6886 
pg
->
	`¡©e_ş—r
(
PG_STATE_CREATING
);

6887 
	}
}

6890 
	gPG
::
Recov”yS‹
::
P“ršg
::
	$P“ršg
(
my_cÚ‹xt
 
ùx
)

6891 : 
	`my_ba£
(
ùx
),

6892 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Peering"),

6893 
	$hi¡Üy_Ës_bound
(
çl£
)

6895 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

6897 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6898 
	`as£¹
(!
pg
->
	`is_³”ed
());

6899 
	`as£¹
(!
pg
->
	`is_³”šg
());

6900 
	`as£¹
(
pg
->
	`is_´im¬y
());

6901 
pg
->
	`¡©e_£t
(
PG_STATE_PEERING
);

6902 
	}
}

6904 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
P“ršg
::
	$»aù
(cÚ¡ 
AdvM­
& 
advm­
)

6906 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6907 
	`ldout
(
pg
->
cù
, 10è<< "P“ršg‡dvm­" << 
d’dl
;

6908 ià(
´iÜ_£t
.
	`afãùed_by_m­
(*(
advm­
.
osdm­
), 
pg
)) {

6909 
	`ldout
(
pg
->
cù
, 1è<< "P“ršg,‡fãùed_by_m­, gošgØRe£t" << 
d’dl
;

6910 
	`po¡_ev’t
(
advm­
);

6911  
Œªs™
< 
Re£t
 >();

6914 
pg
->
	`adju¡_Ãed_up_thru
(
advm­
.
osdm­
);

6916  
	`fÜw¬d_ev’t
();

6917 
	}
}

6919 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
P“ršg
::
	$»aù
(cÚ¡ 
Qu”yS‹
& 
q
)

6921 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6923 
q
.
f
->
	`İ’_objeù_£ùiÚ
("state");

6924 
q
.
f
->
	`dump_¡ršg
("Çme", 
¡©e_Çme
);

6925 
q
.
f
->
	`dump_¡»am
("’‹r_time"è<< 
’‹r_time
;

6927 
q
.
f
->
	`İ’_¬¿y_£ùiÚ
("past_intervals");

6928 
pg
->
·¡_š‹rv®s
.
	`dump
(
q
.
f
);

6929 
q
.
f
->
	`şo£_£ùiÚ
();

6931 
q
.
f
->
	`İ’_¬¿y_£ùiÚ
("probing_osds");

6932 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
p
 = 
´iÜ_£t
.
´obe
.
	`begš
();

6933 
p
 !ğ
´iÜ_£t
.
´obe
.
	`’d
();

6934 ++
p
)

6935 
q
.
f
->
	`dump_¡»am
("osd"è<< *
p
;

6936 
q
.
f
->
	`şo£_£ùiÚ
();

6938 ià(
´iÜ_£t
.
pg_down
)

6939 
q
.
f
->
	`dump_¡ršg
("blocked", "peering is blocked dueo down osds");

6941 
q
.
f
->
	`İ’_¬¿y_£ùiÚ
("down_osds_we_would_probe");

6942 
£t
<>::
™”©Ü
 
p
 = 
´iÜ_£t
.
down
.
	`begš
();

6943 
p
 !ğ
´iÜ_£t
.
down
.
	`’d
();

6944 ++
p
)

6945 
q
.
f
->
	`dump_št
("osd", *
p
);

6946 
q
.
f
->
	`şo£_£ùiÚ
();

6948 
q
.
f
->
	`İ’_¬¿y_£ùiÚ
("peering_blocked_by");

6949 
m­
<,
•och_t
>::
™”©Ü
 
p
 = 
´iÜ_£t
.
blocked_by
.
	`begš
();

6950 
p
 !ğ
´iÜ_£t
.
blocked_by
.
	`’d
();

6951 ++
p
) {

6952 
q
.
f
->
	`İ’_objeù_£ùiÚ
("osd");

6953 
q
.
f
->
	`dump_št
("osd", 
p
->
fœ¡
);

6954 
q
.
f
->
	`dump_št
("cu¼’t_lo¡_©", 
p
->
£cÚd
);

6955 
q
.
f
->
	`dump_¡ršg
("comment", "starting or markinghis osd†ost may†et us…roceed");

6956 
q
.
f
->
	`şo£_£ùiÚ
();

6958 
q
.
f
->
	`şo£_£ùiÚ
();

6960 ià(
hi¡Üy_Ës_bound
) {

6961 
q
.
f
->
	`İ’_¬¿y_£ùiÚ
("peering_blocked_by_detail");

6962 
q
.
f
->
	`İ’_objeù_£ùiÚ
("item");

6963 
q
.
f
->
	`dump_¡ršg
("detail","peering_blocked_by_history_les_bound");

6964 
q
.
f
->
	`şo£_£ùiÚ
();

6965 
q
.
f
->
	`şo£_£ùiÚ
();

6968 
q
.
f
->
	`şo£_£ùiÚ
();

6969  
	`fÜw¬d_ev’t
();

6970 
	}
}

6972 
	gPG
::
Recov”yS‹
::
P“ršg
::
	$ex™
()

6974 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6975 
	`ldout
(
pg
->
cù
, 10è<< "L—všg P“ršg" << 
d’dl
;

6976 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

6977 
pg
->
	`¡©e_ş—r
(
PG_STATE_PEERING
);

6978 
pg
->
	`ş—r_´obe_rg‘s
();

6980 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

6981 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_³”šg_Ï‹ncy
, 
dur
);

6982 
	}
}

6986 
	gPG
::
Recov”yS‹
::
Backflšg
::
	$Backflšg
(
my_cÚ‹xt
 
ùx
)

6987 : 
	`my_ba£
(
ùx
),

6988 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Active/Backfilling")

6990 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

6991 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

6992 
pg
->
backfl_»£rved
 = 
Œue
;

6993 
pg
->
	`queue_»cov”y
();

6994 
pg
->
	`¡©e_ş—r
(
PG_STATE_BACKFILL_TOOFULL
);

6995 
pg
->
	`¡©e_ş—r
(
PG_STATE_BACKFILL_WAIT
);

6996 
pg
->
	`¡©e_£t
(
PG_STATE_BACKFILLING
);

6997 
pg
->
	`publish_¡©s_to_osd
();

6998 
	}
}

7000 
	gPG
::
Recov”yS‹
::
Backflšg
::
	$ÿnûl_backfl
()

7002 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7003 
pg
->
osd
->
loÿl_»£rv”
.
	`ÿnûl_»£rv©iÚ
Õg->
šfo
.
pgid
);

7005 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
™
 = 
pg
->
backfl_rg‘s
.
	`begš
();

7006 
™
 !ğ
pg
->
backfl_rg‘s
.
	`’d
();

7007 ++
™
) {

7008 
	`as£¹
(*
™
 !ğ
pg
->
pg_whßmi
);

7009 
CÚÃùiÚRef
 
cÚ
 = 
pg
->
osd
->
	`g‘_cÚ_osd_şu¡”
(

7010 
™
->
osd
, 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
());

7011 ià(
cÚ
) {

7012 
pg
->
osd
->
	`£nd_mes§ge_osd_şu¡”
(

7013 
Ãw
 
	`MBackflRe£rve
(

7014 
MBackflRe£rve
::
RELEASE
,

7015 
	`¥g_t
(
pg
->
šfo
.
pgid
.pgid, 
™
->
sh¬d
),

7016 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
()),

7017 
cÚ
.
	`g‘
());

7021 ià(!
pg
->
wa™šg_Ú_backfl
.
	`em±y
()) {

7022 
pg
->
wa™šg_Ú_backfl
.
	`ş—r
();

7023 
pg
->
	`fšish_»cov”y_İ
(
hobjeù_t
::
	`g‘_max
());

7025 
	}
}

7027 
	gboo¡
::
¡©ech¬t
::
»suÉ


7028 
PG
::
Recov”yS‹
::
Backflšg
::
	$»aù
(cÚ¡ 
DeãrBackfl
 &
c
)

7030 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7031 
	`ldout
(
pg
->
cù
, 10è<< "deã¸backfl,„‘ry d–ay " << 
c
.
d–ay
 << 
d’dl
;

7032 
pg
->
	`¡©e_£t
(
PG_STATE_BACKFILL_WAIT
);

7033 
pg
->
	`¡©e_ş—r
(
PG_STATE_BACKFILLING
);

7034 
	`ÿnûl_backfl
();

7035 
pg
->
	`scheduË_backfl_»Œy
(
c
.
d–ay
);

7036  
Œªs™
<
NÙBackflšg
>();

7037 
	}
}

7039 
	gboo¡
::
¡©ech¬t
::
»suÉ


7040 
PG
::
Recov”yS‹
::
Backflšg
::
	$»aù
(cÚ¡ 
UnfoundBackfl
 &
c
)

7042 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7043 
	`ldout
(
pg
->
cù
, 10è<< "backfÈha unfound, cª'ˆcÚtšue" << 
d’dl
;

7044 
pg
->
	`¡©e_£t
(
PG_STATE_BACKFILL_UNFOUND
);

7045 
pg
->
	`¡©e_ş—r
(
PG_STATE_BACKFILLING
);

7046 
	`ÿnûl_backfl
();

7047  
Œªs™
<
NÙBackflšg
>();

7048 
	}
}

7050 
	gboo¡
::
¡©ech¬t
::
»suÉ


7051 
PG
::
Recov”yS‹
::
Backflšg
::
	$»aù
(cÚ¡ 
RemÙeRe£rv©iÚRevokedTooFuÎ
 &)

7053 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7054 
pg
->
	`¡©e_£t
(
PG_STATE_BACKFILL_TOOFULL
);

7055 
pg
->
	`¡©e_ş—r
(
PG_STATE_BACKFILLING
);

7056 
	`ÿnûl_backfl
();

7057 
pg
->
	`scheduË_backfl_»Œy
Õg->
cù
->
_cÚf
->
osd_backfl_»Œy_š‹rv®
);

7058  
Œªs™
<
NÙBackflšg
>();

7059 
	}
}

7061 
	gboo¡
::
¡©ech¬t
::
»suÉ


7062 
PG
::
Recov”yS‹
::
Backflšg
::
	$»aù
(cÚ¡ 
RemÙeRe£rv©iÚRevoked
 &)

7064 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7065 
pg
->
	`¡©e_£t
(
PG_STATE_BACKFILL_WAIT
);

7066 
	`ÿnûl_backfl
();

7067  
Œªs™
<
Wa™LoÿlBackflRe£rved
>();

7068 
	}
}

7070 
	gPG
::
Recov”yS‹
::
Backflšg
::
	$ex™
()

7072 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

7073 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7074 
pg
->
backfl_»£rved
 = 
çl£
;

7075 
pg
->
backfl_»£rvšg
 = 
çl£
;

7076 
pg
->
	`¡©e_ş—r
(
PG_STATE_BACKFILLING
);

7077 
pg
->
	`¡©e_ş—r
(
PG_STATE_FORCED_BACKFILL
 | 
PG_STATE_FORCED_RECOVERY
);

7078 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

7079 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_backflšg_Ï‹ncy
, 
dur
);

7080 
	}
}

7084 
	gPG
::
Recov”yS‹
::
Wa™RemÙeBackflRe£rved
::
	$Wa™RemÙeBackflRe£rved
(
my_cÚ‹xt
 
ùx
)

7085 : 
	`my_ba£
(
ùx
),

7086 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Active/WaitRemoteBackfillReserved"),

7087 
	`backfl_osd_™
(
cÚ‹xt
< 
Aùive
 >().
»mÙe_sh¬ds_to_»£rve_backfl
.
	$begš
())

7089 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

7090 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7091 
pg
->
	`¡©e_£t
(
PG_STATE_BACKFILL_WAIT
);

7092 
pg
->
	`publish_¡©s_to_osd
();

7093 
	`po¡_ev’t
(
	`RemÙeBackflRe£rved
());

7094 
	}
}

7096 
	gboo¡
::
¡©ech¬t
::
»suÉ


7097 
PG
::
Recov”yS‹
::
Wa™RemÙeBackflRe£rved
::
	$»aù
(cÚ¡ 
RemÙeBackflRe£rved
 &
evt
)

7099 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7101 ià(
backfl_osd_™
 !ğ
cÚ‹xt
< 
Aùive
 >().
»mÙe_sh¬ds_to_»£rve_backfl
.
	`’d
()) {

7103 
	`as£¹
(*
backfl_osd_™
 !ğ
pg
->
pg_whßmi
);

7104 
CÚÃùiÚRef
 
cÚ
 = 
pg
->
osd
->
	`g‘_cÚ_osd_şu¡”
(

7105 
backfl_osd_™
->
osd
, 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
());

7106 ià(
cÚ
) {

7107 
pg
->
osd
->
	`£nd_mes§ge_osd_şu¡”
(

7108 
Ãw
 
	`MBackflRe£rve
(

7109 
MBackflRe£rve
::
REQUEST
,

7110 
	`¥g_t
(
pg
->
šfo
.
pgid
.pgid, 
backfl_osd_™
->
sh¬d
),

7111 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
(),

7112 
pg
->
	`g‘_backfl_´iÜ™y
()),

7113 
cÚ
.
	`g‘
());

7115 ++
backfl_osd_™
;

7117 
	`po¡_ev’t
(
	`AÎBackflsRe£rved
());

7119  
	`disÿrd_ev’t
();

7120 
	}
}

7122 
	gPG
::
Recov”yS‹
::
Wa™RemÙeBackflRe£rved
::
	$ex™
()

7124 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

7125 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7126 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

7127 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_wa™»mÙebackfÌe£rved_Ï‹ncy
, 
dur
);

7128 
	}
}

7130 
	gPG
::
Recov”yS‹
::
Wa™RemÙeBackflRe£rved
::
	$»Œy
()

7132 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7133 
pg
->
osd
->
loÿl_»£rv”
.
	`ÿnûl_»£rv©iÚ
Õg->
šfo
.
pgid
);

7136 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
™
, 
begš
, 
’d
;

7137 
begš
 = 
cÚ‹xt
< 
Aùive
 >().
»mÙe_sh¬ds_to_»£rve_backfl
.
	`begš
();

7138 
’d
 = 
cÚ‹xt
< 
Aùive
 >().
»mÙe_sh¬ds_to_»£rve_backfl
.
	`’d
();

7139 
	`as£¹
(
begš
 !ğ
’d
);

7140 
™
 = 
begš
; iˆ!ğ
backfl_osd_™
; ++it) {

7142 
	`as£¹
(*
™
 !ğ
pg
->
pg_whßmi
);

7143 
CÚÃùiÚRef
 
cÚ
 = 
pg
->
osd
->
	`g‘_cÚ_osd_şu¡”
(

7144 
™
->
osd
, 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
());

7145 ià(
cÚ
) {

7146 
pg
->
osd
->
	`£nd_mes§ge_osd_şu¡”
(

7147 
Ãw
 
	`MBackflRe£rve
(

7148 
MBackflRe£rve
::
RELEASE
,

7149 
	`¥g_t
(
pg
->
šfo
.
pgid
.pgid, 
™
->
sh¬d
),

7150 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
()),

7151 
cÚ
.
	`g‘
());

7155 
pg
->
	`¡©e_ş—r
(
PG_STATE_BACKFILL_WAIT
);

7156 
pg
->
	`¡©e_£t
(
PG_STATE_BACKFILL_TOOFULL
);

7157 
pg
->
	`publish_¡©s_to_osd
();

7159 
pg
->
	`scheduË_backfl_»Œy
Õg->
cù
->
_cÚf
->
osd_backfl_»Œy_š‹rv®
);

7160 
	}
}

7162 
	gboo¡
::
¡©ech¬t
::
»suÉ


7163 
PG
::
Recov”yS‹
::
Wa™RemÙeBackflRe£rved
::
	$»aù
(cÚ¡ 
RemÙeRe£rv©iÚRejeùed
 &
evt
)

7165 
	`»Œy
();

7166  
Œªs™
<
NÙBackflšg
>();

7167 
	}
}

7169 
	gboo¡
::
¡©ech¬t
::
»suÉ


7170 
PG
::
Recov”yS‹
::
Wa™RemÙeBackflRe£rved
::
	$»aù
(cÚ¡ 
RemÙeRe£rv©iÚRevoked
 &
evt
)

7172 
	`»Œy
();

7173  
Œªs™
<
NÙBackflšg
>();

7174 
	}
}

7177 
	gPG
::
Recov”yS‹
::
Wa™LoÿlBackflRe£rved
::
	$Wa™LoÿlBackflRe£rved
(
my_cÚ‹xt
 
ùx
)

7178 : 
	`my_ba£
(
ùx
),

7179 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Active/WaitLocalBackfillReserved")

7181 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

7182 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7183 
pg
->
	`¡©e_£t
(
PG_STATE_BACKFILL_WAIT
);

7184 
pg
->
osd
->
loÿl_»£rv”
.
	`»que¡_»£rv©iÚ
(

7185 
pg
->
šfo
.
pgid
,

7186 
Ãw
 
QueueP“ršgEvt
<
LoÿlBackflRe£rved
>(

7187 
pg
,…g->
	`g‘_osdm­
()->
	`g‘_•och
(),

7188 
	`LoÿlBackflRe£rved
()),

7189 
pg
->
	`g‘_backfl_´iÜ™y
(),

7190 
Ãw
 
QueueP“ršgEvt
<
DeãrBackfl
>(

7191 
pg
,…g->
	`g‘_osdm­
()->
	`g‘_•och
(),

7192 
	`DeãrBackfl
(0.0)));

7193 
pg
->
	`publish_¡©s_to_osd
();

7194 
	}
}

7196 
	gPG
::
Recov”yS‹
::
Wa™LoÿlBackflRe£rved
::
	$ex™
()

7198 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

7199 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7200 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

7201 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_wa™loÿlbackfÌe£rved_Ï‹ncy
, 
dur
);

7202 
	}
}

7205 
	gPG
::
Recov”yS‹
::
NÙBackflšg
::
	$NÙBackflšg
(
my_cÚ‹xt
 
ùx
)

7206 : 
	`my_ba£
(
ùx
),

7207 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Active/NotBackfilling")

7209 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

7210 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7211 
pg
->
	`publish_¡©s_to_osd
();

7212 
	}
}

7214 
	gboo¡
::
¡©ech¬t
::
»suÉ


7215 
PG
::
Recov”yS‹
::
NÙBackflšg
::
	$»aù
(cÚ¡ 
RemÙeBackflRe£rved
 &
evt
)

7217  
	`disÿrd_ev’t
();

7218 
	}
}

7220 
	gboo¡
::
¡©ech¬t
::
»suÉ


7221 
PG
::
Recov”yS‹
::
NÙBackflšg
::
	$»aù
(cÚ¡ 
RemÙeRe£rv©iÚRejeùed
 &
evt
)

7223  
	`disÿrd_ev’t
();

7224 
	}
}

7226 
	gPG
::
Recov”yS‹
::
NÙBackflšg
::
	$ex™
()

7228 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

7229 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7230 
pg
->
	`¡©e_ş—r
(
PG_STATE_BACKFILL_UNFOUND
);

7231 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

7232 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_nÙbackflšg_Ï‹ncy
, 
dur
);

7233 
	}
}

7236 
	gPG
::
Recov”yS‹
::
NÙRecov”šg
::
	$NÙRecov”šg
(
my_cÚ‹xt
 
ùx
)

7237 : 
	`my_ba£
(
ùx
),

7238 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Active/NotRecovering")

7240 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

7241 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7242 
pg
->
	`publish_¡©s_to_osd
();

7243 
	}
}

7245 
	gPG
::
Recov”yS‹
::
NÙRecov”šg
::
	$ex™
()

7247 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

7248 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7249 
pg
->
	`¡©e_ş—r
(
PG_STATE_RECOVERY_UNFOUND
);

7250 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

7251 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_nÙ»cov”šg_Ï‹ncy
, 
dur
);

7252 
	}
}

7255 
	gPG
::
Recov”yS‹
::
R•NÙRecov”šg
::
	$R•NÙRecov”šg
(
my_cÚ‹xt
 
ùx
)

7256 : 
	`my_ba£
(
ùx
),

7257 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/ReplicaActive/RepNotRecovering")

7259 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

7260 
	}
}

7262 
	gboo¡
::
¡©ech¬t
::
»suÉ


7263 
PG
::
Recov”yS‹
::
R•NÙRecov”šg
::
	$»aù
(cÚ¡ 
RejeùRemÙeRe£rv©iÚ
 &
evt
)

7265 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7266 
pg
->
	`»jeù_»£rv©iÚ
();

7267 
	`po¡_ev’t
(
	`RemÙeRe£rv©iÚRejeùed
());

7268  
	`disÿrd_ev’t
();

7269 
	}
}

7271 
	gPG
::
Recov”yS‹
::
R•NÙRecov”šg
::
	$ex™
()

7273 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

7274 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7275 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

7276 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_»²Ù»cov”šg_Ï‹ncy
, 
dur
);

7277 
	}
}

7280 
	gPG
::
Recov”yS‹
::
R•Wa™Recov”yRe£rved
::
	$R•Wa™Recov”yRe£rved
(
my_cÚ‹xt
 
ùx
)

7281 : 
	`my_ba£
(
ùx
),

7282 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/ReplicaActive/RepWaitRecoveryReserved")

7284 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

7285 
	}
}

7287 
	gboo¡
::
¡©ech¬t
::
»suÉ


7288 
PG
::
Recov”yS‹
::
R•Wa™Recov”yRe£rved
::
	$»aù
(cÚ¡ 
RemÙeRecov”yRe£rved
 &
evt
)

7290 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7291 
pg
->
osd
->
	`£nd_mes§ge_osd_şu¡”
(

7292 
pg
->
´im¬y
.
osd
,

7293 
Ãw
 
	`MRecov”yRe£rve
(

7294 
MRecov”yRe£rve
::
GRANT
,

7295 
	`¥g_t
(
pg
->
šfo
.
pgid
.pgid,…g->
´im¬y
.
sh¬d
),

7296 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
()),

7297 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
());

7298  
Œªs™
<
R•Recov”šg
>();

7299 
	}
}

7301 
	gboo¡
::
¡©ech¬t
::
»suÉ


7302 
PG
::
Recov”yS‹
::
R•Wa™Recov”yRe£rved
::
	$»aù
(

7303 cÚ¡ 
RemÙeRe£rv©iÚCªûËd
 &
evt
)

7305 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7306 
pg
->
osd
->
»mÙe_»£rv”
.
	`ÿnûl_»£rv©iÚ
Õg->
šfo
.
pgid
);

7307  
Œªs™
<
R•NÙRecov”šg
>();

7308 
	}
}

7310 
	gPG
::
Recov”yS‹
::
R•Wa™Recov”yRe£rved
::
	$ex™
()

7312 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

7313 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7314 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

7315 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_»pwa™»cov”y»£rved_Ï‹ncy
, 
dur
);

7316 
	}
}

7319 
	gPG
::
Recov”yS‹
::
R•Wa™BackflRe£rved
::
	$R•Wa™BackflRe£rved
(
my_cÚ‹xt
 
ùx
)

7320 : 
	`my_ba£
(
ùx
),

7321 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/ReplicaActive/RepWaitBackfillReserved")

7323 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

7324 
	}
}

7326 
	gboo¡
::
¡©ech¬t
::
»suÉ


7327 
PG
::
Recov”yS‹
::
R•NÙRecov”šg
::
	$»aù
(cÚ¡ 
Reque¡BackflPrio
 &
evt
)

7329 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7330 ià(
pg
->
cù
->
_cÚf
->
osd_debug_»jeù_backfl_´obab™y
 > 0 &&

7331 (
	`¿nd
()%1000 < (
pg
->
cù
->
_cÚf
->
osd_debug_»jeù_backfl_´obab™y
*1000.0))) {

7332 
	`ldout
(
pg
->
cù
, 10) << "backfill„eservation„ejected: failure injection"

7333 << 
d’dl
;

7334 
	`po¡_ev’t
(
	`RejeùRemÙeRe£rv©iÚ
());

7335 } ià(!
pg
->
cù
->
_cÚf
->
osd_debug_sk_fuÎ_check_š_backfl_»£rv©iÚ
 &&

7336 
pg
->
osd
->
	`check_backfl_fuÎ
(pg)) {

7337 
	`ldout
(
pg
->
cù
, 10) << "backfill„eservation„ejected: backfill full"

7338 << 
d’dl
;

7339 
	`po¡_ev’t
(
	`RejeùRemÙeRe£rv©iÚ
());

7341 
CÚ‹xt
 *
´“m±
 = 
nuÎ±r
;

7342 ià(
	`HAVE_FEATURE
(
pg
->
u·ùšg_ã©u»s
, 
RECOVERY_RESERVATION_2
)) {

7344 
´“m±
 = 
Ãw
 
QueueP“ršgEvt
<
RemÙeBackflP»em±ed
>(

7345 
pg
,…g->
	`g‘_osdm­
()->
	`g‘_•och
(),

7346 
	`RemÙeBackflP»em±ed
());

7348 
pg
->
osd
->
»mÙe_»£rv”
.
	`»que¡_»£rv©iÚ
(

7349 
pg
->
šfo
.
pgid
,

7350 
Ãw
 
QueueP“ršgEvt
<
RemÙeBackflRe£rved
>(

7351 
pg
,…g->
	`g‘_osdm­
()->
	`g‘_•och
(),

7352 
	`RemÙeBackflRe£rved
()),

7353 
evt
.
´iÜ™y
,

7354 
´“m±
);

7356  
Œªs™
<
R•Wa™BackflRe£rved
>();

7357 
	}
}

7359 
	gboo¡
::
¡©ech¬t
::
»suÉ


7360 
PG
::
Recov”yS‹
::
R•NÙRecov”šg
::
	$»aù
(cÚ¡ 
Reque¡Recov”yPrio
 &
evt
)

7362 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7366 
´io
 = 
evt
.
´iÜ™y
 ?ƒvt.´iÜ™y : 
pg
->
	`g‘_»cov”y_´iÜ™y
();

7368 
CÚ‹xt
 *
´“m±
 = 
nuÎ±r
;

7369 ià(
	`HAVE_FEATURE
(
pg
->
u·ùšg_ã©u»s
, 
RECOVERY_RESERVATION_2
)) {

7371 
´“m±
 = 
Ãw
 
QueueP“ršgEvt
<
RemÙeRecov”yP»em±ed
>(

7372 
pg
,…g->
	`g‘_osdm­
()->
	`g‘_•och
(),

7373 
	`RemÙeRecov”yP»em±ed
());

7376 
pg
->
osd
->
»mÙe_»£rv”
.
	`»que¡_»£rv©iÚ
(

7377 
pg
->
šfo
.
pgid
,

7378 
Ãw
 
QueueP“ršgEvt
<
RemÙeRecov”yRe£rved
>(

7379 
pg
,…g->
	`g‘_osdm­
()->
	`g‘_•och
(),

7380 
	`RemÙeRecov”yRe£rved
()),

7381 
´io
,

7382 
´“m±
);

7383  
Œªs™
<
R•Wa™Recov”yRe£rved
>();

7384 
	}
}

7386 
	gPG
::
Recov”yS‹
::
R•Wa™BackflRe£rved
::
	$ex™
()

7388 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

7389 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7390 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

7391 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_»pwa™backfÌe£rved_Ï‹ncy
, 
dur
);

7392 
	}
}

7394 
	gboo¡
::
¡©ech¬t
::
»suÉ


7395 
PG
::
Recov”yS‹
::
R•Wa™BackflRe£rved
::
	$»aù
(cÚ¡ 
RemÙeBackflRe£rved
 &
evt
)

7397 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7399 ià(
pg
->
cù
->
_cÚf
->
osd_debug_»jeù_backfl_´obab™y
 > 0 &&

7400 (
	`¿nd
()%1000 < (
pg
->
cù
->
_cÚf
->
osd_debug_»jeù_backfl_´obab™y
*1000.0))) {

7401 
	`ldout
(
pg
->
cù
, 10) << "backfill„eservation„ejected‡fter„eservation: "

7402 << "çu» injeùiÚ" << 
d’dl
;

7403 
	`po¡_ev’t
(
	`RejeùRemÙeRe£rv©iÚ
());

7404  
	`disÿrd_ev’t
();

7405 } ià(!
pg
->
cù
->
_cÚf
->
osd_debug_sk_fuÎ_check_š_backfl_»£rv©iÚ
 &&

7406 
pg
->
osd
->
	`check_backfl_fuÎ
(pg)) {

7407 
	`ldout
(
pg
->
cù
, 10) << "backfill„eservation„ejected‡fter„eservation: backfill full"

7408 << 
d’dl
;

7409 
	`po¡_ev’t
(
	`RejeùRemÙeRe£rv©iÚ
());

7410  
	`disÿrd_ev’t
();

7412 
pg
->
osd
->
	`£nd_mes§ge_osd_şu¡”
(

7413 
pg
->
´im¬y
.
osd
,

7414 
Ãw
 
	`MBackflRe£rve
(

7415 
MBackflRe£rve
::
GRANT
,

7416 
	`¥g_t
(
pg
->
šfo
.
pgid
.pgid,…g->
´im¬y
.
sh¬d
),

7417 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
()),

7418 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
());

7419  
Œªs™
<
R•Recov”šg
>();

7421 
	}
}

7423 
	gboo¡
::
¡©ech¬t
::
»suÉ


7424 
PG
::
Recov”yS‹
::
R•Wa™BackflRe£rved
::
	$»aù
(

7425 cÚ¡ 
RejeùRemÙeRe£rv©iÚ
 &
evt
)

7427 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7428 
pg
->
	`»jeù_»£rv©iÚ
();

7429 
	`po¡_ev’t
(
	`RemÙeRe£rv©iÚRejeùed
());

7430  
	`disÿrd_ev’t
();

7431 
	}
}

7433 
	gboo¡
::
¡©ech¬t
::
»suÉ


7434 
PG
::
Recov”yS‹
::
R•Wa™BackflRe£rved
::
	$»aù
(

7435 cÚ¡ 
RemÙeRe£rv©iÚRejeùed
 &
evt
)

7437 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7438 
pg
->
osd
->
»mÙe_»£rv”
.
	`ÿnûl_»£rv©iÚ
Õg->
šfo
.
pgid
);

7439  
Œªs™
<
R•NÙRecov”šg
>();

7440 
	}
}

7442 
	gboo¡
::
¡©ech¬t
::
»suÉ


7443 
PG
::
Recov”yS‹
::
R•Wa™BackflRe£rved
::
	$»aù
(

7444 cÚ¡ 
RemÙeRe£rv©iÚCªûËd
 &
evt
)

7446 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7447 
pg
->
osd
->
»mÙe_»£rv”
.
	`ÿnûl_»£rv©iÚ
Õg->
šfo
.
pgid
);

7448  
Œªs™
<
R•NÙRecov”šg
>();

7449 
	}
}

7451 
	gboo¡
::
¡©ech¬t
::
»suÉ


7452 
PG
::
Recov”yS‹
::
R•Wa™BackflRe£rved
::
	$»aù
(cÚ¡ 
Recov”yDÚe
&)

7454 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7455 
pg
->
osd
->
»mÙe_»£rv”
.
	`ÿnûl_»£rv©iÚ
Õg->
šfo
.
pgid
);

7456  
Œªs™
<
R•NÙRecov”šg
>();

7457 
	}
}

7460 
	gPG
::
Recov”yS‹
::
R•Recov”šg
::
	$R•Recov”šg
(
my_cÚ‹xt
 
ùx
)

7461 : 
	`my_ba£
(
ùx
),

7462 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/ReplicaActive/RepRecovering")

7464 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

7465 
	}
}

7467 
	gboo¡
::
¡©ech¬t
::
»suÉ


7468 
PG
::
Recov”yS‹
::
R•Recov”šg
::
	$»aù
(cÚ¡ 
RemÙeRecov”yP»em±ed
 &)

7470 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7471 
pg
->
osd
->
	`£nd_mes§ge_osd_şu¡”
(

7472 
pg
->
´im¬y
.
osd
,

7473 
Ãw
 
	`MRecov”yRe£rve
(

7474 
MRecov”yRe£rve
::
REVOKE
,

7475 
	`¥g_t
(
pg
->
šfo
.
pgid
.pgid,…g->
´im¬y
.
sh¬d
),

7476 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
()),

7477 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
());

7478  
	`disÿrd_ev’t
();

7479 
	}
}

7481 
	gboo¡
::
¡©ech¬t
::
»suÉ


7482 
PG
::
Recov”yS‹
::
R•Recov”šg
::
	$»aù
(cÚ¡ 
BackflTooFuÎ
 &)

7484 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7485 
pg
->
osd
->
	`£nd_mes§ge_osd_şu¡”
(

7486 
pg
->
´im¬y
.
osd
,

7487 
Ãw
 
	`MBackflRe£rve
(

7488 
MBackflRe£rve
::
TOOFULL
,

7489 
	`¥g_t
(
pg
->
šfo
.
pgid
.pgid,…g->
´im¬y
.
sh¬d
),

7490 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
()),

7491 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
());

7492  
	`disÿrd_ev’t
();

7493 
	}
}

7495 
	gboo¡
::
¡©ech¬t
::
»suÉ


7496 
PG
::
Recov”yS‹
::
R•Recov”šg
::
	$»aù
(cÚ¡ 
RemÙeBackflP»em±ed
 &)

7498 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7499 
pg
->
osd
->
	`£nd_mes§ge_osd_şu¡”
(

7500 
pg
->
´im¬y
.
osd
,

7501 
Ãw
 
	`MBackflRe£rve
(

7502 
MBackflRe£rve
::
REVOKE
,

7503 
	`¥g_t
(
pg
->
šfo
.
pgid
.pgid,…g->
´im¬y
.
sh¬d
),

7504 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
()),

7505 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
());

7506  
	`disÿrd_ev’t
();

7507 
	}
}

7509 
	gPG
::
Recov”yS‹
::
R•Recov”šg
::
	$ex™
()

7511 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

7512 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7513 
pg
->
osd
->
»mÙe_»£rv”
.
	`ÿnûl_»£rv©iÚ
Õg->
šfo
.
pgid
);

7514 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

7515 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_»´ecov”šg_Ï‹ncy
, 
dur
);

7516 
	}
}

7519 
	gPG
::
Recov”yS‹
::
Aùiv©šg
::
	$Aùiv©šg
(
my_cÚ‹xt
 
ùx
)

7520 : 
	`my_ba£
(
ùx
),

7521 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Active/Activating")

7523 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

7524 
	}
}

7526 
	gPG
::
Recov”yS‹
::
Aùiv©šg
::
	$ex™
()

7528 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

7529 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7530 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

7531 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_aùiv©šg_Ï‹ncy
, 
dur
);

7532 
	}
}

7534 
	gPG
::
Recov”yS‹
::
Wa™LoÿlRecov”yRe£rved
::
	$Wa™LoÿlRecov”yRe£rved
(
my_cÚ‹xt
 
ùx
)

7535 : 
	`my_ba£
(
ùx
),

7536 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Active/WaitLocalRecoveryReserved")

7538 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

7539 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7542 ià(!
pg
->
cù
->
_cÚf
->
osd_debug_sk_fuÎ_check_š_»cov”y
 &&

7543 
pg
->
osd
->
	`check_osdm­_fuÎ
Õg->
aùšg_»cov”y_backfl
)) {

7544 
	`po¡_ev’t
(
	`Recov”yTooFuÎ
());

7548 
pg
->
	`¡©e_ş—r
(
PG_STATE_RECOVERY_TOOFULL
);

7549 
pg
->
	`¡©e_£t
(
PG_STATE_RECOVERY_WAIT
);

7550 
pg
->
osd
->
loÿl_»£rv”
.
	`»que¡_»£rv©iÚ
(

7551 
pg
->
šfo
.
pgid
,

7552 
Ãw
 
QueueP“ršgEvt
<
LoÿlRecov”yRe£rved
>(

7553 
pg
,…g->
	`g‘_osdm­
()->
	`g‘_•och
(),

7554 
	`LoÿlRecov”yRe£rved
()),

7555 
pg
->
	`g‘_»cov”y_´iÜ™y
(),

7556 
Ãw
 
QueueP“ršgEvt
<
DeãrRecov”y
>(

7557 
pg
,…g->
	`g‘_osdm­
()->
	`g‘_•och
(),

7558 
	`DeãrRecov”y
(0.0)));

7559 
pg
->
	`publish_¡©s_to_osd
();

7560 
	}
}

7562 
	gboo¡
::
¡©ech¬t
::
»suÉ


7563 
PG
::
Recov”yS‹
::
Wa™LoÿlRecov”yRe£rved
::
	$»aù
(cÚ¡ 
Recov”yTooFuÎ
 &
evt
)

7565 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7566 
pg
->
	`¡©e_£t
(
PG_STATE_RECOVERY_TOOFULL
);

7567 
pg
->
	`scheduË_»cov”y_»Œy
Õg->
cù
->
_cÚf
->
osd_»cov”y_»Œy_š‹rv®
);

7568  
Œªs™
<
NÙRecov”šg
>();

7569 
	}
}

7571 
	gPG
::
Recov”yS‹
::
Wa™LoÿlRecov”yRe£rved
::
	$ex™
()

7573 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

7574 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7575 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

7576 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_wa™loÿÌecov”y»£rved_Ï‹ncy
, 
dur
);

7577 
	}
}

7579 
	gPG
::
Recov”yS‹
::
Wa™RemÙeRecov”yRe£rved
::
	$Wa™RemÙeRecov”yRe£rved
(
my_cÚ‹xt
 
ùx
)

7580 : 
	`my_ba£
(
ùx
),

7581 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Active/WaitRemoteRecoveryReserved"),

7582 
	`»mÙe_»cov”y_»£rv©iÚ_™
(
cÚ‹xt
< 
Aùive
 >().
»mÙe_sh¬ds_to_»£rve_»cov”y
.
	$begš
())

7584 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

7585 
	`po¡_ev’t
(
	`RemÙeRecov”yRe£rved
());

7586 
	}
}

7588 
	gboo¡
::
¡©ech¬t
::
»suÉ


7589 
PG
::
Recov”yS‹
::
Wa™RemÙeRecov”yRe£rved
::
	$»aù
(cÚ¡ 
RemÙeRecov”yRe£rved
 &
evt
) {

7590 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7592 ià(
»mÙe_»cov”y_»£rv©iÚ_™
 !ğ
cÚ‹xt
< 
Aùive
 >().
»mÙe_sh¬ds_to_»£rve_»cov”y
.
	`’d
()) {

7593 
	`as£¹
(*
»mÙe_»cov”y_»£rv©iÚ_™
 !ğ
pg
->
pg_whßmi
);

7594 
CÚÃùiÚRef
 
cÚ
 = 
pg
->
osd
->
	`g‘_cÚ_osd_şu¡”
(

7595 
»mÙe_»cov”y_»£rv©iÚ_™
->
osd
, 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
());

7596 ià(
cÚ
) {

7597 
pg
->
osd
->
	`£nd_mes§ge_osd_şu¡”
(

7598 
Ãw
 
	`MRecov”yRe£rve
(

7599 
MRecov”yRe£rve
::
REQUEST
,

7600 
	`¥g_t
(
pg
->
šfo
.
pgid
.pgid, 
»mÙe_»cov”y_»£rv©iÚ_™
->
sh¬d
),

7601 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
(),

7602 
pg
->
	`g‘_»cov”y_´iÜ™y
()),

7603 
cÚ
.
	`g‘
());

7605 ++
»mÙe_»cov”y_»£rv©iÚ_™
;

7607 
	`po¡_ev’t
(
	`AÎRemÙesRe£rved
());

7609  
	`disÿrd_ev’t
();

7610 
	}
}

7612 
	gPG
::
Recov”yS‹
::
Wa™RemÙeRecov”yRe£rved
::
	$ex™
()

7614 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

7615 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7616 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

7617 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_wa™»mÙ”ecov”y»£rved_Ï‹ncy
, 
dur
);

7618 
	}
}

7620 
	gPG
::
Recov”yS‹
::
Recov”šg
::
	$Recov”šg
(
my_cÚ‹xt
 
ùx
)

7621 : 
	`my_ba£
(
ùx
),

7622 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Active/Recovering")

7624 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

7626 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7627 
pg
->
	`¡©e_ş—r
(
PG_STATE_RECOVERY_WAIT
);

7628 
pg
->
	`¡©e_ş—r
(
PG_STATE_RECOVERY_TOOFULL
);

7629 
pg
->
	`¡©e_£t
(
PG_STATE_RECOVERING
);

7630 
	`as£¹
(!
pg
->
	`¡©e_‹¡
(
PG_STATE_ACTIVATING
));

7631 
pg
->
	`publish_¡©s_to_osd
();

7632 
pg
->
	`queue_»cov”y
();

7633 
	}
}

7635 
	gPG
::
Recov”yS‹
::
Recov”šg
::
	$»Ëa£_»£rv©iÚs
(
boŞ
 
ÿnûl
)

7637 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7638 
	`as£¹
(
ÿnûl
 || !
pg
->
pg_log
.
	`g‘_missšg
().
	`have_missšg
());

7641 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
i
 =

7642 
cÚ‹xt
< 
Aùive
 >().
»mÙe_sh¬ds_to_»£rve_»cov”y
.
	`begš
();

7643 
i
 !ğ
cÚ‹xt
< 
Aùive
 >().
»mÙe_sh¬ds_to_»£rve_»cov”y
.
	`’d
();

7644 ++
i
) {

7645 ià(*
i
 =ğ
pg
->
pg_whßmi
)

7647 
CÚÃùiÚRef
 
cÚ
 = 
pg
->
osd
->
	`g‘_cÚ_osd_şu¡”
(

7648 
i
->
osd
, 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
());

7649 ià(
cÚ
) {

7650 
pg
->
osd
->
	`£nd_mes§ge_osd_şu¡”
(

7651 
Ãw
 
	`MRecov”yRe£rve
(

7652 
MRecov”yRe£rve
::
RELEASE
,

7653 
	`¥g_t
(
pg
->
šfo
.
pgid
.pgid, 
i
->
sh¬d
),

7654 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
()),

7655 
cÚ
.
	`g‘
());

7658 
	}
}

7660 
	gboo¡
::
¡©ech¬t
::
»suÉ


7661 
PG
::
Recov”yS‹
::
Recov”šg
::
	$»aù
(cÚ¡ 
AÎR•liÿsRecov”ed
 &
evt
)

7663 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7664 
pg
->
	`¡©e_ş—r
(
PG_STATE_FORCED_RECOVERY
);

7665 
	`»Ëa£_»£rv©iÚs
();

7666 
pg
->
osd
->
loÿl_»£rv”
.
	`ÿnûl_»£rv©iÚ
Õg->
šfo
.
pgid
);

7667  
Œªs™
<
Recov”ed
>();

7668 
	}
}

7670 
	gboo¡
::
¡©ech¬t
::
»suÉ


7671 
PG
::
Recov”yS‹
::
Recov”šg
::
	$»aù
(cÚ¡ 
Reque¡Backfl
 &
evt
)

7673 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7674 
pg
->
	`¡©e_ş—r
(
PG_STATE_FORCED_RECOVERY
);

7675 
	`»Ëa£_»£rv©iÚs
();

7676 
pg
->
osd
->
loÿl_»£rv”
.
	`ÿnûl_»£rv©iÚ
Õg->
šfo
.
pgid
);

7678 
pg
->
	`publish_¡©s_to_osd
();

7679  
Œªs™
<
Wa™LoÿlBackflRe£rved
>();

7680 
	}
}

7682 
	gboo¡
::
¡©ech¬t
::
»suÉ


7683 
PG
::
Recov”yS‹
::
Recov”šg
::
	$»aù
(cÚ¡ 
DeãrRecov”y
 &
evt
)

7685 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7686 ià(!
pg
->
	`¡©e_‹¡
(
PG_STATE_RECOVERING
)) {

7689 
	`ldout
(
pg
->
cù
, 10è<< "gÙ deã¸»cov”y buˆnÙ„ecov”šg" << 
d’dl
;

7690  
	`disÿrd_ev’t
();

7692 
	`ldout
(
pg
->
cù
, 10è<< "deã¸»cov”y,„‘ry d–ay " << 
evt
.
d–ay
 << 
d’dl
;

7693 
pg
->
	`¡©e_£t
(
PG_STATE_RECOVERY_WAIT
);

7694 
pg
->
osd
->
loÿl_»£rv”
.
	`ÿnûl_»£rv©iÚ
Õg->
šfo
.
pgid
);

7695 
	`»Ëa£_»£rv©iÚs
(
Œue
);

7696 
pg
->
	`scheduË_»cov”y_»Œy
(
evt
.
d–ay
);

7697  
Œªs™
<
NÙRecov”šg
>();

7698 
	}
}

7700 
	gboo¡
::
¡©ech¬t
::
»suÉ


7701 
PG
::
Recov”yS‹
::
Recov”šg
::
	$»aù
(cÚ¡ 
UnfoundRecov”y
 &
evt
)

7703 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7704 
	`ldout
(
pg
->
cù
, 10è<< "»cov”y ha unfound, cª'ˆcÚtšue" << 
d’dl
;

7705 
pg
->
	`¡©e_£t
(
PG_STATE_RECOVERY_UNFOUND
);

7706 
pg
->
osd
->
loÿl_»£rv”
.
	`ÿnûl_»£rv©iÚ
Õg->
šfo
.
pgid
);

7707 
	`»Ëa£_»£rv©iÚs
(
Œue
);

7708  
Œªs™
<
NÙRecov”šg
>();

7709 
	}
}

7711 
	gPG
::
Recov”yS‹
::
Recov”šg
::
	$ex™
()

7713 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

7714 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7715 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

7716 
pg
->
	`¡©e_ş—r
(
PG_STATE_RECOVERING
);

7717 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_»cov”šg_Ï‹ncy
, 
dur
);

7718 
	}
}

7720 
	gPG
::
Recov”yS‹
::
Recov”ed
::
	$Recov”ed
(
my_cÚ‹xt
 
ùx
)

7721 : 
	`my_ba£
(
ùx
),

7722 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Active/Recovered")

7724 
pg_sh¬d_t
 
auth_log_sh¬d
;

7726 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

7728 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7730 
	`as£¹
(!
pg
->
	`Ãeds_»cov”y
());

7734 
	`as£¹
(!
pg
->
aùšg_»cov”y_backfl
.
	`em±y
());

7735 ià(
pg
->
	`g‘_osdm­
()->
	`g‘_pg_size
Õg->
šfo
.
pgid
.pgid) <=

7736 
pg
->
aùšg_»cov”y_backfl
.
	`size
()) {

7737 
pg
->
	`¡©e_ş—r
(
PG_STATE_FORCED_BACKFILL
 | 
PG_STATE_FORCED_RECOVERY
);

7738 
pg
->
	`publish_¡©s_to_osd
();

7742 
pg
->
	`Œim_log
();

7745 
boŞ
 
hi¡Üy_Ës_bound
 = 
çl£
;

7746 ià(
pg
->
aùšg
 !ğpg->
up
 && !pg->
	`choo£_aùšg
(
auth_log_sh¬d
,

7747 
Œue
, &
hi¡Üy_Ës_bound
)) {

7748 
	`as£¹
(
pg
->
wªt_aùšg
.
	`size
());

7749 } ià(!
pg
->
async_»cov”y_rg‘s
.
	`em±y
()) {

7750 
pg
->
	`choo£_aùšg
(
auth_log_sh¬d
, 
Œue
, &
hi¡Üy_Ës_bound
);

7753 ià(
cÚ‹xt
< 
Aùive
 >().
®l_»¶iÿs_aùiv©ed
 &&

7754 
pg
->
async_»cov”y_rg‘s
.
	`em±y
())

7755 
	`po¡_ev’t
(
	`GoCËª
());

7756 
	}
}

7758 
	gPG
::
Recov”yS‹
::
Recov”ed
::
	$ex™
()

7760 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

7761 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7762 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

7763 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_»cov”ed_Ï‹ncy
, 
dur
);

7764 
	}
}

7766 
	gPG
::
Recov”yS‹
::
CËª
::
	$CËª
(
my_cÚ‹xt
 
ùx
)

7767 : 
	`my_ba£
(
ùx
),

7768 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Active/Clean")

7770 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

7772 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7774 ià(
pg
->
šfo
.
Ï¡_com¶‘e
 !ğpg->šfo.
Ï¡_upd©e
) {

7775 
	`ûph_abÜt
();

7777 
CÚ‹xt
 *
c
 = 
pg
->
	`fšish_»cov”y
();

7778 
cÚ‹xt
< 
Recov”yMachše
 >().
	`g‘_cur_Œª§ùiÚ
()->
	`»gi¡”_Ú_comm™
(
c
);

7780 ià(
pg
->
	`is_aùive
()) {

7781 
pg
->
	`m¬k_ş—n
();

7783 
pg
->
	`¡©e_ş—r
(
PG_STATE_FORCED_RECOVERY
 | 
PG_STATE_FORCED_BACKFILL
);

7784 
pg
->
	`sh¬e_pg_šfo
();

7785 
pg
->
	`publish_¡©s_to_osd
();

7786 
pg
->
	`»queue_İs
Õg->
wa™šg_fÜ_ş—n_to_´im¬y_»·œ
);

7787 
	}
}

7789 
	gPG
::
Recov”yS‹
::
CËª
::
	$ex™
()

7791 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

7792 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7793 
pg
->
	`¡©e_ş—r
(
PG_STATE_CLEAN
);

7794 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

7795 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_ş—n_Ï‹ncy
, 
dur
);

7796 
	}
}

7798 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

7799 
	g£t
<
	gpg_sh¬d_t
> 
	$unique_osd_sh¬d_£t
(cÚ¡ 
pg_sh¬d_t
 & 
sk
, cÚ¡ 
T
 &
š
)

7801 
£t
<> 
osds_found
;

7802 
£t
<
pg_sh¬d_t
> 
out
;

7803 
ty³Çme
 
T
::
cÚ¡_™”©Ü
 
i
 = 
š
.
	`begš
();

7804 
i
 !ğ
š
.
	`’d
();

7805 ++
i
) {

7806 ià(*
i
 !ğ
sk
 && !
osds_found
.
	`couÁ
(i->
osd
)) {

7807 
osds_found
.
	`š£¹
(
i
->
osd
);

7808 
out
.
	`š£¹
(*
i
);

7811  
out
;

7812 
	}
}

7815 
	gPG
::
Recov”yS‹
::
Aùive
::
	$Aùive
(
my_cÚ‹xt
 
ùx
)

7816 : 
	`my_ba£
(
ùx
),

7817 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Active"),

7818 
	`»mÙe_sh¬ds_to_»£rve_»cov”y
(

7819 
	`unique_osd_sh¬d_£t
(

7820 
cÚ‹xt
< 
Recov”yMachše
 >().
pg
->
pg_whßmi
,

7821 
cÚ‹xt
< 
Recov”yMachše
 >().
pg
->
aùšg_»cov”y_backfl
)),

7822 
	`»mÙe_sh¬ds_to_»£rve_backfl
(

7823 
	`unique_osd_sh¬d_£t
(

7824 
cÚ‹xt
< 
Recov”yMachše
 >().
pg
->
pg_whßmi
,

7825 
cÚ‹xt
< 
Recov”yMachše
 >().
pg
->
backfl_rg‘s
)),

7826 
	$®l_»¶iÿs_aùiv©ed
(
çl£
)

7828 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

7830 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7832 
	`as£¹
(!
pg
->
backfl_»£rvšg
);

7833 
	`as£¹
(!
pg
->
backfl_»£rved
);

7834 
	`as£¹
(
pg
->
	`is_´im¬y
());

7835 
	`ldout
(
pg
->
cù
, 10è<< "IÀAùive,‡bouˆtØÿÎ‡ùiv©e" << 
d’dl
;

7836 
pg
->
	`¡¬t_æush
(
cÚ‹xt
< 
Recov”yMachše
 >().
	`g‘_cur_Œª§ùiÚ
());

7837 
pg
->
	`aùiv©e
(*
cÚ‹xt
< 
Recov”yMachše
 >().
	`g‘_cur_Œª§ùiÚ
(),

7838 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
(),

7839 *
cÚ‹xt
< 
Recov”yMachše
 >().
	`g‘_qu”y_m­
(),

7840 
cÚ‹xt
< 
Recov”yMachše
 >().
	`g‘_šfo_m­
(),

7841 
cÚ‹xt
< 
Recov”yMachše
 >().
	`g‘_»cov”y_ùx
());

7844 
pg
->
blocked_by
.
	`ş—r
();

7845 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
p
 = 
pg
->
aùšg_»cov”y_backfl
.
	`begš
();

7846 
p
 !ğ
pg
->
aùšg_»cov”y_backfl
.
	`’d
();

7847 ++
p
) {

7848 ià(
p
->
sh¬d
 !ğ
pg
->
pg_whßmi
.shard) {

7849 
pg
->
blocked_by
.
	`š£¹
(
p
->
sh¬d
);

7852 
pg
->
	`publish_¡©s_to_osd
();

7853 
	`ldout
(
pg
->
cù
, 10è<< "Aùiv©Fšished" << 
d’dl
;

7854 
	}
}

7856 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Aùive
::
	$»aù
(cÚ¡ 
AdvM­
& 
advm­
)

7858 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7859 ià(
pg
->
	`should_»¡¬t_³”šg
(

7860 
advm­
.
up_´im¬y
,

7861 
advm­
.
aùšg_´im¬y
,

7862 
advm­
.
Ãwup
,

7863 
advm­
.
Ãwaùšg
,

7864 
advm­
.
Ï¡m­
,

7865 
advm­
.
osdm­
)) {

7866 
	`ldout
(
pg
->
cù
, 10è<< "Aùivadvm­ iÁ”v® chªge, fa¡„‘uº" << 
d’dl
;

7867  
	`fÜw¬d_ev’t
();

7869 
	`ldout
(
pg
->
cù
, 10è<< "Aùivadvm­" << 
d’dl
;

7870 
boŞ
 
Ãed_publish
 = 
çl£
;

7872 ià(
advm­
.
osdm­
->
»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_MIMIC
) {

7873 cÚ¡‡uto& 
Ãw_»moved_¢­s
 = 
advm­
.
osdm­
->
	`g‘_Ãw_»moved_¢­s
();

7874 autØ
i
 = 
Ãw_»moved_¢­s
.
	`fšd
(
pg
->
šfo
.
pgid
.
	`poŞ
());

7875 ià(
i
 !ğ
Ãw_»moved_¢­s
.
	`’d
()) {

7876 
boŞ
 
bad
 = 
çl£
;

7877 autØ
j
 : 
i
->
£cÚd
) {

7878 ià(
pg
->
¢­_Œimq
.
	`š‹r£ùs
(
j
.
fœ¡
, j.
£cÚd
)) {

7879 
	`deşty³
(
pg
->
¢­_Œimq
è
added
, 
ov”Ïp
;

7880 
added
.
	`š£¹
(
j
.
fœ¡
, j.
£cÚd
);

7881 
ov”Ïp
.
	`š‹r£ùiÚ_of
(
pg
->
¢­_Œimq
, 
added
);

7882 ià(
pg
->
Ï¡_»quœe_osd_»Ëa£
 < 
CEPH_RELEASE_MIMIC
) {

7883 
	`ld”r
(
pg
->
cù
è<< 
__func__
 << "„emoved_snaps‡lready contains "

7884 << 
ov”Ïp
 << ", buthis ishe first mimic+ osdmap,"

7885 << " sØ™' ex³ùed" << 
d’dl
;

7887 
	`ld”r
(
pg
->
cù
è<< 
__func__
 << "„emoved_snaps‡lready contains "

7888 << 
ov”Ïp
 << 
d’dl
;

7889 
bad
 = 
Œue
;

7891 
pg
->
¢­_Œimq
.
	`uniÚ_of
(
added
);

7893 
pg
->
¢­_Œimq
.
	`š£¹
(
j
.
fœ¡
, j.
£cÚd
);

7896 ià(
pg
->
Ï¡_»quœe_osd_»Ëa£
 < 
CEPH_RELEASE_MIMIC
) {

7900 
	`ld”r
(
pg
->
cù
è<< 
__func__
 << " first mimic map, filtering…urged_snaps"

7901 << " from‚ew„emoved_¢­s" << 
d’dl
;

7902 
pg
->
¢­_Œimq
.
	`subŒaù
Õg->
šfo
.
purged_¢­s
);

7904 
	`ldout
(
pg
->
cù
,10è<< 
__func__
 << "‚ew„emoved_¢­ " << 
i
->
£cÚd


7905 << ", sÇp_Œimq‚ow " << 
pg
->
¢­_Œimq
 << 
d’dl
;

7906 
	`as£¹
(!
bad
 || !
pg
->
cù
->
_cÚf
->
osd_debug_v”ify_ÿched_¢­s
);

7907 
pg
->
dœty_šfo
 = 
Œue
;

7908 
pg
->
dœty_big_šfo
 = 
Œue
;

7911 cÚ¡‡uto& 
Ãw_purged_¢­s
 = 
advm­
.
osdm­
->
	`g‘_Ãw_purged_¢­s
();

7912 autØ
j
 = 
Ãw_purged_¢­s
.
	`fšd
(
pg
->
šfo
.
pgid
.
	`poŞ
());

7913 ià(
j
 !ğ
Ãw_purged_¢­s
.
	`’d
()) {

7914 
boŞ
 
bad
 = 
çl£
;

7915 autØ
k
 : 
j
->
£cÚd
) {

7916 ià(!
pg
->
šfo
.
purged_¢­s
.
	`cÚšs
(
k
.
fœ¡
, k.
£cÚd
)) {

7917 
	`deşty³
(
pg
->
šfo
.
purged_¢­s
è
rm
, 
ov”Ïp
;

7918 
rm
.
	`š£¹
(
k
.
fœ¡
, k.
£cÚd
);

7919 
ov”Ïp
.
	`š‹r£ùiÚ_of
(
pg
->
šfo
.
purged_¢­s
, 
rm
);

7920 
	`ld”r
(
pg
->
cù
è<< 
__func__
 << "…urged_snaps does‚ot contain "

7921 << 
rm
 << ", oÆy " << 
ov”Ïp
 << 
d’dl
;

7922 
pg
->
šfo
.
purged_¢­s
.
	`subŒaù
(
ov”Ïp
);

7936 
pg
->
šfo
.
purged_¢­s
.
	`”a£
(
k
.
fœ¡
, k.
£cÚd
);

7939 
	`ldout
(
pg
->
cù
,10è<< 
__func__
 << "‚ew…urged_¢­ " << 
j
->
£cÚd


7940 << ",‚ow " << 
pg
->
šfo
.
purged_¢­s
 << 
d’dl
;

7941 
	`as£¹
(!
bad
 || !
pg
->
cù
->
_cÚf
->
osd_debug_v”ify_ÿched_¢­s
);

7942 
pg
->
dœty_šfo
 = 
Œue
;

7943 
pg
->
dœty_big_šfo
 = 
Œue
;

7945 ià(
pg
->
dœty_big_šfo
) {

7949 
Ãed_publish
 = 
Œue
;

7950 
pg
->
	`sh¬e_pg_šfo
();

7952 } ià(!
pg
->
poŞ
.
Ãwly_»moved_¢­s
.
	`em±y
()) {

7953 
pg
->
¢­_Œimq
.
	`uniÚ_of
Õg->
poŞ
.
Ãwly_»moved_¢­s
);

7954 
	`ldout
(
pg
->
cù
, 10è<< *pg << " sÇp_Œimq‚ow " <<…g->
¢­_Œimq
 << 
d’dl
;

7955 
pg
->
dœty_šfo
 = 
Œue
;

7956 
pg
->
dœty_big_šfo
 = 
Œue
;

7959 
size_t
 
i
 = 0; i < 
pg
->
wªt_aùšg
.
	`size
(); i++) {

7960 
osd
 = 
pg
->
wªt_aùšg
[
i
];

7961 ià(!
advm­
.
osdm­
->
	`is_up
(
osd
)) {

7962 
pg_sh¬d_t
 
	`osd_w™h_sh¬d
(
osd
, 
	`sh¬d_id_t
(
i
));

7963 
	`as£¹
(
pg
->
	`is_aùšg
(
osd_w™h_sh¬d
è||…g->
	`is_up
(osd_with_shard));

7969 ià(
advm­
.
Ï¡m­
->
	`g‘_pg_size
(
pg
->
šfo
.
pgid
.pgid) !=

7970 
pg
->
	`g‘_osdm­
()->
	`g‘_pg_size
Õg->
šfo
.
pgid
.pgid)) {

7971 ià(
pg
->
	`g‘_osdm­
()->
	`g‘_pg_size
Õg->
šfo
.
pgid
.pgidè<ğpg->
aùšg£t
.
	`size
()) {

7972 
pg
->
	`¡©e_ş—r
(
PG_STATE_UNDERSIZED
);

7974 
pg
->
	`¡©e_£t
(
PG_STATE_UNDERSIZED
);

7977 
Ãed_publish
 = 
Œue
;

7981 ià(
pg
->
šfo
.
¡©s
.
»pÜ‹d_•och
 +…g->
cù
->
_cÚf
->
osd_pg_¡©_»pÜt_š‹rv®_max
 < 
advm­
.
osdm­
->
	`g‘_•och
()) {

7982 
	`ldout
(
pg
->
cù
, 20è<< "»pÜtšg st tØosd‡á” " << (
advm­
.
osdm­
->
	`g‘_•och
(è-…g->
šfo
.
¡©s
.
»pÜ‹d_•och
)

7983 << "ƒpochs" << 
d’dl
;

7984 
Ãed_publish
 = 
Œue
;

7987 ià(
Ãed_publish
)

7988 
pg
->
	`publish_¡©s_to_osd
();

7990  
	`fÜw¬d_ev’t
();

7991 
	}
}

7993 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Aùive
::
	$»aù
(cÚ¡ 
AùM­
&)

7995 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

7996 
	`ldout
(
pg
->
cù
, 10è<< "Aùive: hªdlšg AùM­" << 
d’dl
;

7997 
	`as£¹
(
pg
->
	`is_´im¬y
());

7999 ià(
pg
->
	`have_unfound
()) {

8001 
pg
->
	`discov”_®l_missšg
(*
cÚ‹xt
< 
Recov”yMachše
 >().
	`g‘_qu”y_m­
());

8004 ià(
pg
->
cù
->
_cÚf
->
osd_check_fÜ_log_cÜru±iÚ
)

8005 
pg
->
	`check_log_fÜ_cÜru±iÚ
Õg->
osd
->
¡Üe
);

8007 
ušt64_t
 
unfound
 = 
pg
->
missšg_loc
.
	`num_unfound
();

8008 ià(
unfound
 > 0 &&

8009 
pg
->
	`®l_unfound_¬e_qu”›d_Ü_lo¡
Õg->
	`g‘_osdm­
())) {

8010 ià(
pg
->
cù
->
_cÚf
->
osd_auto_m¬k_unfound_lo¡
) {

8011 
pg
->
osd
->
şog
->
	`”rÜ
(è<<…g->
šfo
.
pgid
.pgid << " ha " << 
unfound


8016 
pg
->
osd
->
şog
->
	`”rÜ
(è<<…g->
šfo
.
pgid
.pgid << " has "

8017 << 
unfound
 << " objects unfound‡nd‡pparently†ost";

8020 ià(
pg
->
	`is_aùive
()) {

8021 
	`ldout
(
pg
->
cù
, 10è<< "Aùive: kickšg sÇ°Œim" << 
d’dl
;

8022 
pg
->
	`kick_¢­_Œim
();

8025 ià(
pg
->
	`is_³”ed
() &&

8026 !
pg
->
	`is_ş—n
() &&

8027 !
pg
->
	`g‘_osdm­
()->
	`‹¡_æag
(
CEPH_OSDMAP_NOBACKFILL
) &&

8028 (!
pg
->
	`g‘_osdm­
()->
	`‹¡_æag
(
CEPH_OSDMAP_NOREBALANCE
è||…g->
	`is_deg¿ded
())) {

8029 
pg
->
	`queue_»cov”y
();

8031  
	`fÜw¬d_ev’t
();

8032 
	}
}

8034 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Aùive
::
	$»aù
(cÚ¡ 
MNÙifyRec
& 
nÙevt
)

8036 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8037 
	`as£¹
(
pg
->
	`is_´im¬y
());

8038 ià(
pg
->
³”_šfo
.
	`couÁ
(
nÙevt
.
äom
)) {

8039 
	`ldout
(
pg
->
cù
, 10è<< "Aùive: gÙ‚Ùify from " << 
nÙevt
.
äom


8041 << 
d’dl
;

8042 } ià(
pg
->
³”_purged
.
	`couÁ
(
nÙevt
.
äom
)) {

8043 
	`ldout
(
pg
->
cù
, 10è<< "Aùive: gÙ‚Ùify from " << 
nÙevt
.
äom


8045 << 
d’dl
;

8047 
	`ldout
(
pg
->
cù
, 10è<< "Aùive: gÙ‚Ùify from " << 
nÙevt
.
äom


8049 << 
d’dl
;

8050 
pg
->
	`´oc_»¶iÿ_šfo
(

8051 
nÙevt
.
äom
,‚Ùevt.
nÙify
.
šfo
,‚Ùevt.nÙify.
•och_£Á
);

8052 ià(
pg
->
	`have_unfound
()) {

8053 
pg
->
	`discov”_®l_missšg
(*
cÚ‹xt
< 
Recov”yMachše
 >().
	`g‘_qu”y_m­
());

8056  
	`disÿrd_ev’t
();

8057 
	}
}

8059 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Aùive
::
	$»aù
(cÚ¡ 
MTrim
& 
Œim
)

8061 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8062 
	`as£¹
(
pg
->
	`is_´im¬y
());

8065 
	`ldout
(
pg
->
cù
,10è<< "„•liÿ osd." << 
Œim
.
äom
 << "†cod " <<rim.
Œim_to
 << 
d’dl
;

8066 
pg
->
³”_Ï¡_com¶‘e_Údisk
[
	`pg_sh¬d_t
(
Œim
.
äom
,rim.
sh¬d
)] =rim.
Œim_to
;

8069 
pg
->
	`ÿlc_mš_Ï¡_com¶‘e_Údisk
();

8070  
	`disÿrd_ev’t
();

8071 
	}
}

8073 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Aùive
::
	$»aù
(cÚ¡ 
MInfoRec
& 
šfÛvt
)

8075 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8076 
	`as£¹
(
pg
->
	`is_´im¬y
());

8078 
	`as£¹
(!
pg
->
aùšg_»cov”y_backfl
.
	`em±y
());

8082 ià(
pg
->
	`is_aùšg_»cov”y_backfl
(
šfÛvt
.
äom
) &&

8083 
pg
->
³”_aùiv©ed
.
	`couÁ
(
šfÛvt
.
äom
) == 0) {

8084 
	`ldout
(
pg
->
cù
, 10è<< "…“¸osd." << 
šfÛvt
.
äom


8085 << "‡ùiv©ed‡nd comm™‹d" << 
d’dl
;

8086 
pg
->
³”_aùiv©ed
.
	`š£¹
(
šfÛvt
.
äom
);

8087 
pg
->
blocked_by
.
	`”a£
(
šfÛvt
.
äom
.
sh¬d
);

8088 
pg
->
	`publish_¡©s_to_osd
();

8089 ià(
pg
->
³”_aùiv©ed
.
	`size
(è=ğpg->
aùšg_»cov”y_backfl
.size()) {

8090 
pg
->
	`®l_aùiv©ed_ªd_comm™‹d
();

8093  
	`disÿrd_ev’t
();

8094 
	}
}

8096 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Aùive
::
	$»aù
(cÚ¡ 
MLogRec
& 
logevt
)

8098 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8099 
	`ldout
(
pg
->
cù
, 10è<< "£¬chšg osd." << 
logevt
.
äom


8100 << "†og fÜ unfound i‹ms" << 
d’dl
;

8101 
pg
->
	`´oc_»¶iÿ_log
(

8102 
logevt
.
msg
->
šfo
,†ogevt.msg->
log
,†ogevt.msg->
missšg
,†ogevt.
äom
);

8103 
boŞ
 
gÙ_missšg
 = 
pg
->
	`£¬ch_fÜ_missšg
(

8104 
pg
->
³”_šfo
[
logevt
.
äom
],

8105 
pg
->
³”_missšg
[
logevt
.
äom
],

8106 
logevt
.
äom
,

8107 
cÚ‹xt
< 
Recov”yMachše
 >().
	`g‘_»cov”y_ùx
());

8109 ià(
gÙ_missšg
 && 
pg
->
	`¡©e_‹¡
(
PG_STATE_ACTIVE
)) {

8110 
	`po¡_ev’t
(
	`DoRecov”y
());

8112  
	`disÿrd_ev’t
();

8113 
	}
}

8115 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Aùive
::
	$»aù
(cÚ¡ 
Qu”yS‹
& 
q
)

8117 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8119 
q
.
f
->
	`İ’_objeù_£ùiÚ
("state");

8120 
q
.
f
->
	`dump_¡ršg
("Çme", 
¡©e_Çme
);

8121 
q
.
f
->
	`dump_¡»am
("’‹r_time"è<< 
’‹r_time
;

8124 
q
.
f
->
	`İ’_¬¿y_£ùiÚ
("might_have_unfound");

8125 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
p
 = 
pg
->
might_have_unfound
.
	`begš
();

8126 
p
 !ğ
pg
->
might_have_unfound
.
	`’d
();

8127 ++
p
) {

8128 
q
.
f
->
	`İ’_objeù_£ùiÚ
("osd");

8129 
q
.
f
->
	`dump_¡»am
("osd"è<< *
p
;

8130 ià(
pg
->
³”_missšg
.
	`couÁ
(*
p
)) {

8131 
q
.
f
->
	`dump_¡ršg
("status", "already…robed");

8132 } ià(
pg
->
³”_missšg_»que¡ed
.
	`couÁ
(*
p
)) {

8133 
q
.
f
->
	`dump_¡ršg
("status", "querying");

8134 } ià(!
pg
->
	`g‘_osdm­
()->
	`is_up
(
p
->
osd
)) {

8135 
q
.
f
->
	`dump_¡ršg
("status", "osd is down");

8137 
q
.
f
->
	`dump_¡ršg
("status", "not queried");

8139 
q
.
f
->
	`şo£_£ùiÚ
();

8141 
q
.
f
->
	`şo£_£ùiÚ
();

8144 
q
.
f
->
	`İ’_objeù_£ùiÚ
("recovery_progress");

8145 
pg
->
	`dump_»cov”y_šfo
(
q
.
f
);

8146 
q
.
f
->
	`şo£_£ùiÚ
();

8150 
q
.
f
->
	`İ’_objeù_£ùiÚ
("scrub");

8151 
q
.
f
->
	`dump_¡»am
("süubb”.•och_¡¬t"è<< 
pg
->
süubb”
.
•och_¡¬t
;

8152 
q
.
f
->
	`dump_boŞ
("süubb”.aùive", 
pg
->
süubb”
.
aùive
);

8153 
q
.
f
->
	`dump_¡ršg
("süubb”.¡©e", 
Süubb”
::
	`¡©e_¡ršg
(
pg
->
süubb”
.
¡©e
));

8154 
q
.
f
->
	`dump_¡»am
("süubb”.¡¬t"è<< 
pg
->
süubb”
.
¡¬t
;

8155 
q
.
f
->
	`dump_¡»am
("süubb”.’d"è<< 
pg
->
süubb”
.
’d
;

8156 
q
.
f
->
	`dump_¡»am
("süubb”.sub£t_Ï¡_upd©e"è<< 
pg
->
süubb”
.
sub£t_Ï¡_upd©e
;

8157 
q
.
f
->
	`dump_boŞ
("süubb”.d“p", 
pg
->
süubb”
.
d“p
);

8159 
q
.
f
->
	`İ’_¬¿y_£ùiÚ
("scrubber.waiting_on_whom");

8160 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
p
 = 
pg
->
süubb”
.
wa™šg_Ú_whom
.
	`begš
();

8161 
p
 !ğ
pg
->
süubb”
.
wa™šg_Ú_whom
.
	`’d
();

8162 ++
p
) {

8163 
q
.
f
->
	`dump_¡»am
("sh¬d"è<< *
p
;

8165 
q
.
f
->
	`şo£_£ùiÚ
();

8167 
q
.
f
->
	`şo£_£ùiÚ
();

8170 
q
.
f
->
	`şo£_£ùiÚ
();

8171  
	`fÜw¬d_ev’t
();

8172 
	}
}

8174 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Aùive
::
	$»aù
(cÚ¡ 
AÎR•liÿsAùiv©ed
 &
evt
)

8176 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8177 
®l_»¶iÿs_aùiv©ed
 = 
Œue
;

8179 
pg
->
	`¡©e_ş—r
(
PG_STATE_ACTIVATING
);

8180 
pg
->
	`¡©e_ş—r
(
PG_STATE_CREATING
);

8181 ià(
pg
->
aùšg
.
	`size
(è>ğpg->
poŞ
.
šfo
.
mš_size
) {

8182 
pg
->
	`¡©e_£t
(
PG_STATE_ACTIVE
);

8184 
pg
->
	`¡©e_£t
(
PG_STATE_PEERED
);

8188 ià(
pg
->
šfo
.
hi¡Üy
.
Ï¡_•och_¡¬‹d
 == 0) {

8189 
pg
->
osd
->
	`£nd_pg_ü—‹d
Õg->
šfo
.
pgid
.pgid);

8191 
pg
->
šfo
.
hi¡Üy
.
Ï¡_•och_¡¬‹d
 =…g->info.last_epoch_started;

8192 
pg
->
šfo
.
hi¡Üy
.
Ï¡_š‹rv®_¡¬‹d
 =…g->info.last_interval_started;

8193 
pg
->
dœty_šfo
 = 
Œue
;

8195 
pg
->
	`sh¬e_pg_šfo
();

8196 
pg
->
	`publish_¡©s_to_osd
();

8198 
pg
->
	`check_loÿl
();

8201 ià(
pg
->
æushes_š_´og»ss
 == 0) {

8202 
pg
->
	`»queue_İs
Õg->
wa™šg_fÜ_³”ed
);

8203 } ià(!
pg
->
wa™šg_fÜ_³”ed
.
	`em±y
()) {

8204 
	`ldout
(
pg
->
cù
, 10è<< 
__func__
 << " flushes in…rogress, moving "

8205 << 
pg
->
wa™šg_fÜ_³”ed
.
	`size
()

8207 << 
d’dl
;

8208 
	`as£¹
(
pg
->
wa™šg_fÜ_æush
.
	`em±y
());

8209 
pg
->
wa™šg_fÜ_æush
.
	`sw­
Õg->
wa™šg_fÜ_³”ed
);

8212 
pg
->
	`Ú_aùiv©e
();

8214  
	`disÿrd_ev’t
();

8215 
	}
}

8217 
	gPG
::
Recov”yS‹
::
Aùive
::
	$ex™
()

8219 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

8220 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8221 
pg
->
osd
->
loÿl_»£rv”
.
	`ÿnûl_»£rv©iÚ
Õg->
šfo
.
pgid
);

8223 
pg
->
blocked_by
.
	`ş—r
();

8224 
pg
->
backfl_»£rved
 = 
çl£
;

8225 
pg
->
backfl_»£rvšg
 = 
çl£
;

8226 
pg
->
	`¡©e_ş—r
(
PG_STATE_ACTIVATING
);

8227 
pg
->
	`¡©e_ş—r
(
PG_STATE_DEGRADED
);

8228 
pg
->
	`¡©e_ş—r
(
PG_STATE_UNDERSIZED
);

8229 
pg
->
	`¡©e_ş—r
(
PG_STATE_BACKFILL_TOOFULL
);

8230 
pg
->
	`¡©e_ş—r
(
PG_STATE_BACKFILL_WAIT
);

8231 
pg
->
	`¡©e_ş—r
(
PG_STATE_RECOVERY_WAIT
);

8232 
pg
->
	`¡©e_ş—r
(
PG_STATE_RECOVERY_TOOFULL
);

8233 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

8234 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_aùive_Ï‹ncy
, 
dur
);

8235 
pg
->
	`ag’t_¡İ
();

8236 
	}
}

8239 
	gPG
::
Recov”yS‹
::
R•liÿAùive
::
	$R•liÿAùive
(
my_cÚ‹xt
 
ùx
)

8240 : 
	`my_ba£
(
ùx
),

8241 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/ReplicaActive")

8243 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

8245 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8246 
pg
->
	`¡¬t_æush
(
cÚ‹xt
< 
Recov”yMachše
 >().
	`g‘_cur_Œª§ùiÚ
());

8247 
	}
}

8250 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
R•liÿAùive
::
	$»aù
(

8251 cÚ¡ 
Aùiv©e
& 
aùevt
) {

8252 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8253 
	`ldout
(
pg
->
cù
, 10è<< "IÀR•liÿAùive,‡bouˆtØÿÎ‡ùiv©e" << 
d’dl
;

8254 
m­
<, m­<
¥g_t
, 
pg_qu”y_t
> > 
qu”y_m­
;

8255 
pg
->
	`aùiv©e
(*
cÚ‹xt
< 
Recov”yMachše
 >().
	`g‘_cur_Œª§ùiÚ
(),

8256 
aùevt
.
aùiv©iÚ_•och
,

8257 
qu”y_m­
, 
NULL
, NULL);

8258 
	`ldout
(
pg
->
cù
, 10è<< "Aùiv©Fšished" << 
d’dl
;

8259  
	`disÿrd_ev’t
();

8260 
	}
}

8262 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
R•liÿAùive
::
	$»aù
(cÚ¡ 
MInfoRec
& 
šfÛvt
)

8264 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8265 
pg
->
	`´oc_´im¬y_šfo
(*
cÚ‹xt
<
Recov”yMachše
>().
	`g‘_cur_Œª§ùiÚ
(),

8266 
šfÛvt
.
šfo
);

8267  
	`disÿrd_ev’t
();

8268 
	}
}

8270 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
R•liÿAùive
::
	$»aù
(cÚ¡ 
MLogRec
& 
logevt
)

8272 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8273 
	`ldout
(
pg
->
cù
, 10è<< "»ûived†og from " << 
logevt
.
äom
 << 
d’dl
;

8274 
ObjeùStÜe
::
T¿n§ùiÚ
* 
t
 = 
cÚ‹xt
<
Recov”yMachše
>().
	`g‘_cur_Œª§ùiÚ
();

8275 
pg
->
	`m”ge_log
(*
t
, 
logevt
.
msg
->
šfo
,†ogevt.msg->
log
,†ogevt.
äom
);

8276 
	`as£¹
(
pg
->
pg_log
.
	`g‘_h—d
(è=ğpg->
šfo
.
Ï¡_upd©e
);

8278  
	`disÿrd_ev’t
();

8279 
	}
}

8281 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
R•liÿAùive
::
	$»aù
(cÚ¡ 
MTrim
& 
Œim
)

8283 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8285 
pg
->
pg_log
.
	`Œim
(
Œim
.
Œim_to
,…g->
šfo
);

8286 
pg
->
dœty_šfo
 = 
Œue
;

8287  
	`disÿrd_ev’t
();

8288 
	}
}

8290 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
R•liÿAùive
::
	$»aù
(cÚ¡ 
AùM­
&)

8292 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8293 ià(
pg
->
	`should_£nd_nÙify
(è&&…g->
	`g‘_´im¬y
().
osd
 >= 0) {

8294 
cÚ‹xt
< 
Recov”yMachše
 >().
	`£nd_nÙify
(

8295 
pg
->
	`g‘_´im¬y
(),

8296 
	`pg_nÙify_t
(

8297 
pg
->
	`g‘_´im¬y
().
sh¬d
,…g->
pg_whßmi
.shard,

8298 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
(),

8299 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
(),

8300 
pg
->
šfo
),

8301 
pg
->
·¡_š‹rv®s
);

8303 
pg
->
	`ke_wa™”s
();

8304  
	`disÿrd_ev’t
();

8305 
	}
}

8307 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
R•liÿAùive
::
	$»aù
(cÚ¡ 
MQu”y
& 
qu”y
)

8309 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8310 ià(
qu”y
.qu”y.
ty³
 =ğ
pg_qu”y_t
::
MISSING
) {

8311 
pg
->
	`upd©e_hi¡Üy
(
qu”y
.qu”y.
hi¡Üy
);

8312 
pg
->
	`fulfl_log
(
qu”y
.
äom
, qu”y.qu”y, qu”y.
qu”y_•och
);

8314  
	`disÿrd_ev’t
();

8315 
	}
}

8317 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
R•liÿAùive
::
	$»aù
(cÚ¡ 
Qu”yS‹
& 
q
)

8319 
q
.
f
->
	`İ’_objeù_£ùiÚ
("state");

8320 
q
.
f
->
	`dump_¡ršg
("Çme", 
¡©e_Çme
);

8321 
q
.
f
->
	`dump_¡»am
("’‹r_time"è<< 
’‹r_time
;

8322 
q
.
f
->
	`şo£_£ùiÚ
();

8323  
	`fÜw¬d_ev’t
();

8324 
	}
}

8326 
	gPG
::
Recov”yS‹
::
R•liÿAùive
::
	$ex™
()

8328 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

8329 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8330 
pg
->
osd
->
»mÙe_»£rv”
.
	`ÿnûl_»£rv©iÚ
Õg->
šfo
.
pgid
);

8331 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

8332 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_»¶iÿaùive_Ï‹ncy
, 
dur
);

8333 
	}
}

8336 
	gPG
::
Recov”yS‹
::
SŒay
::
	$SŒay
(
my_cÚ‹xt
 
ùx
)

8337 : 
	`my_ba£
(
ùx
),

8338 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Stray")

8340 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

8342 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8343 
	`as£¹
(!
pg
->
	`is_³”ed
());

8344 
	`as£¹
(!
pg
->
	`is_³”šg
());

8345 
	`as£¹
(!
pg
->
	`is_´im¬y
());

8347 ià(!
pg
->
	`g‘_osdm­
()->
	`have_pg_poŞ
Õg->
	`g‘_pgid
().
	`poŞ
())) {

8348 
	`ldout
(
pg
->
cù
,10è<< 
__func__
 << "…oŞ i d–‘ed" << 
d’dl
;

8349 
	`po¡_ev’t
(
	`D–‘eS¹
());

8351 
pg
->
	`¡¬t_æush
(
cÚ‹xt
< 
Recov”yMachše
 >().
	`g‘_cur_Œª§ùiÚ
());

8353 
	}
}

8355 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
SŒay
::
	$»aù
(cÚ¡ 
MLogRec
& 
logevt
)

8357 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8358 
MOSDPGLog
 *
msg
 = 
logevt
.msg.
	`g‘
();

8359 
	`ldout
(
pg
->
cù
, 10è<< "gÙ info+log from osd." << 
logevt
.
äom
 << " " << 
msg
->
šfo
 << " " << msg->
log
 << 
d’dl
;

8361 
ObjeùStÜe
::
T¿n§ùiÚ
* 
t
 = 
cÚ‹xt
<
Recov”yMachše
>().
	`g‘_cur_Œª§ùiÚ
();

8362 ià(
msg
->
šfo
.
Ï¡_backfl
 =ğ
	`hobjeù_t
()) {

8364 
pg
->
	`uÄeg_Ãxt_süub
();

8365 
pg
->
šfo
 = 
msg
->info;

8366 
pg
->
	`»g_Ãxt_süub
();

8367 
pg
->
dœty_šfo
 = 
Œue
;

8368 
pg
->
dœty_big_šfo
 = 
Œue
;

8370 
PGLogEÁryHªdËr
 
rŞlback”
{
pg
, 
t
};

8371 
pg
->
pg_log
.
	`»£t_backfl_şaim_log
(
msg
->
log
, &
rŞlback”
);

8373 
pg
->
pg_log
.
	`»£t_backfl
();

8375 
pg
->
	`m”ge_log
(*
t
, 
msg
->
šfo
, msg->
log
, 
logevt
.
äom
);

8378 
	`as£¹
(
pg
->
pg_log
.
	`g‘_h—d
(è=ğpg->
šfo
.
Ï¡_upd©e
);

8380 
	`po¡_ev’t
(
	`Aùiv©e
(
logevt
.
msg
->
šfo
.
Ï¡_•och_¡¬‹d
));

8381  
Œªs™
<
R•liÿAùive
>();

8382 
	}
}

8384 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
SŒay
::
	$»aù
(cÚ¡ 
MInfoRec
& 
šfÛvt
)

8386 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8387 
	`ldout
(
pg
->
cù
, 10è<< "gÙ infØäom osd." << 
šfÛvt
.
äom
 << " " << infÛvt.
šfo
 << 
d’dl
;

8389 ià(
pg
->
šfo
.
Ï¡_upd©e
 > 
šfÛvt
.info.last_update) {

8391 
ObjeùStÜe
::
T¿n§ùiÚ
* 
t
 = 
cÚ‹xt
<
Recov”yMachše
>().
	`g‘_cur_Œª§ùiÚ
();

8392 
pg
->
	`»wšd_div”g’t_log
(*
t
, 
šfÛvt
.
šfo
.
Ï¡_upd©e
);

8393 
pg
->
šfo
.
¡©s
 = 
šfÛvt
.info.stats;

8394 
pg
->
šfo
.
h™_£t
 = 
šfÛvt
.info.hit_set;

8397 
	`as£¹
(
šfÛvt
.
šfo
.
Ï¡_upd©e
 =ğ
pg
->info.last_update);

8398 
	`as£¹
(
pg
->
pg_log
.
	`g‘_h—d
(è=ğpg->
šfo
.
Ï¡_upd©e
);

8400 
	`po¡_ev’t
(
	`Aùiv©e
(
šfÛvt
.
šfo
.
Ï¡_•och_¡¬‹d
));

8401  
Œªs™
<
R•liÿAùive
>();

8402 
	}
}

8404 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
SŒay
::
	$»aù
(cÚ¡ 
MQu”y
& 
qu”y
)

8406 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8407 ià(
qu”y
.qu”y.
ty³
 =ğ
pg_qu”y_t
::
INFO
) {

8408 
·œ
<
pg_sh¬d_t
, 
pg_šfo_t
> 
nÙify_šfo
;

8409 
pg
->
	`upd©e_hi¡Üy
(
qu”y
.qu”y.
hi¡Üy
);

8410 
pg
->
	`fulfl_šfo
(
qu”y
.
äom
, qu”y.qu”y, 
nÙify_šfo
);

8411 
cÚ‹xt
< 
Recov”yMachše
 >().
	`£nd_nÙify
(

8412 
nÙify_šfo
.
fœ¡
,

8413 
	`pg_nÙify_t
(

8414 
nÙify_šfo
.
fœ¡
.
sh¬d
, 
pg
->
pg_whßmi
.shard,

8415 
qu”y
.
qu”y_•och
,

8416 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
(),

8417 
nÙify_šfo
.
£cÚd
),

8418 
pg
->
·¡_š‹rv®s
);

8420 
pg
->
	`fulfl_log
(
qu”y
.
äom
, qu”y.qu”y, qu”y.
qu”y_•och
);

8422  
	`disÿrd_ev’t
();

8423 
	}
}

8425 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
SŒay
::
	$»aù
(cÚ¡ 
AùM­
&)

8427 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8428 ià(
pg
->
	`should_£nd_nÙify
(è&&…g->
	`g‘_´im¬y
().
osd
 >= 0) {

8429 
cÚ‹xt
< 
Recov”yMachše
 >().
	`£nd_nÙify
(

8430 
pg
->
	`g‘_´im¬y
(),

8431 
	`pg_nÙify_t
(

8432 
pg
->
	`g‘_´im¬y
().
sh¬d
,…g->
pg_whßmi
.shard,

8433 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
(),

8434 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
(),

8435 
pg
->
šfo
),

8436 
pg
->
·¡_š‹rv®s
);

8438 
pg
->
	`ke_wa™”s
();

8439  
	`disÿrd_ev’t
();

8440 
	}
}

8442 
	gPG
::
Recov”yS‹
::
SŒay
::
	$ex™
()

8444 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

8445 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8446 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

8447 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_¡¿y_Ï‹ncy
, 
dur
);

8448 
	}
}

8452 
	gPG
::
Recov”yS‹
::
ToD–‘e
::
	$ToD–‘e
(
my_cÚ‹xt
 
ùx
)

8453 : 
	`my_ba£
(
ùx
),

8454 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/ToDelete")

8456 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

8457 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8458 
pg
->
osd
->
logg”
->
	`šc
(
l_osd_pg_»movšg
);

8459 
	}
}

8461 
	gPG
::
Recov”yS‹
::
ToD–‘e
::
	$ex™
()

8463 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

8464 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8467 
pg
->
osd
->
logg”
->
	`dec
(
l_osd_pg_»movšg
);

8468 
pg
->
osd
->
loÿl_»£rv”
.
	`ÿnûl_»£rv©iÚ
Õg->
šfo
.
pgid
);

8469 
	}
}

8472 
	gPG
::
Recov”yS‹
::
Wa™D–‘eRe£rved
::
	$Wa™D–‘eRe£rved
(
my_cÚ‹xt
 
ùx
)

8473 : 
	`my_ba£
(
ùx
),

8474 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
,

8477 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

8478 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8479 
cÚ‹xt
<
ToD–‘e
>().
´iÜ™y
 = 
pg
->
	`g‘_d–‘e_´iÜ™y
();

8480 
pg
->
osd
->
loÿl_»£rv”
.
	`ÿnûl_»£rv©iÚ
Õg->
šfo
.
pgid
);

8481 
pg
->
osd
->
loÿl_»£rv”
.
	`»que¡_»£rv©iÚ
(

8482 
pg
->
šfo
.
pgid
,

8483 
Ãw
 
QueueP“ršgEvt
<
D–‘eRe£rved
>(

8484 
pg
,…g->
	`g‘_osdm­
()->
	`g‘_•och
(),

8485 
	`D–‘eRe£rved
()),

8486 
cÚ‹xt
<
ToD–‘e
>().
´iÜ™y
,

8487 
Ãw
 
QueueP“ršgEvt
<
D–‘eIÁ”ru±ed
>(

8488 
pg
,…g->
	`g‘_osdm­
()->
	`g‘_•och
(),

8489 
	`D–‘eIÁ”ru±ed
()));

8490 
	}
}

8492 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
ToD–‘e
::
	$»aù
(

8493 cÚ¡ 
AùM­
& 
evt
)

8495 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8496 ià(
pg
->
	`g‘_d–‘e_´iÜ™y
(è!ğ
´iÜ™y
) {

8497 
	`ldout
(
pg
->
cù
,10è<< 
__func__
 << " delete…riority changed,„esetting"

8498 << 
d’dl
;

8499  
Œªs™
<
ToD–‘e
>();

8501  
	`disÿrd_ev’t
();

8502 
	}
}

8504 
	gPG
::
Recov”yS‹
::
Wa™D–‘eRe£rved
::
	$ex™
()

8506 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

8507 
	}
}

8510 
	gPG
::
Recov”yS‹
::
D–‘šg
::
	$D–‘šg
(
my_cÚ‹xt
 
ùx
)

8511 : 
	`my_ba£
(
ùx
),

8512 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/ToDelete/Deleting")

8514 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

8515 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8516 
pg
->
d–‘šg
 = 
Œue
;

8517 
ObjeùStÜe
::
T¿n§ùiÚ
* 
t
 = 
cÚ‹xt
<
Recov”yMachše
>().
	`g‘_cur_Œª§ùiÚ
();

8518 
pg
->
	`Ú_»mov®
(
t
);

8519 
t
->
	`»gi¡”_Ú_comm™
(
Ãw
 
	`C_D–‘eMÜe
(
pg
,…g->
	`g‘_osdm­
()->
	`g‘_•och
()));

8520 
	}
}

8522 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
D–‘šg
::
	$»aù
(

8523 cÚ¡ 
D–‘eSome
& 
evt
)

8525 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8526 
pg
->
	`_d–‘e_some
(
cÚ‹xt
<
Recov”yMachše
>().
	`g‘_cur_Œª§ùiÚ
());

8527  
	`disÿrd_ev’t
();

8528 
	}
}

8530 
	gPG
::
Recov”yS‹
::
D–‘šg
::
	$ex™
()

8532 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

8533 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8534 
pg
->
d–‘šg
 = 
çl£
;

8535 
pg
->
osd
->
loÿl_»£rv”
.
	`ÿnûl_»£rv©iÚ
Õg->
šfo
.
pgid
);

8536 
	}
}

8539 
	gPG
::
Recov”yS‹
::
G‘Info
::
	$G‘Info
(
my_cÚ‹xt
 
ùx
)

8540 : 
	`my_ba£
(
ùx
),

8541 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Peering/GetInfo")

8543 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

8545 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8546 
pg
->
	`check_·¡_š‹rv®_bounds
();

8547 
Pa¡IÁ”v®s
::
PriÜS‘
 &
´iÜ_£t
 = 
cÚ‹xt
< 
P“ršg
 >().prior_set;

8549 
	`as£¹
(
pg
->
blocked_by
.
	`em±y
());

8551 
´iÜ_£t
 = 
pg
->
	`bud_´iÜ
();

8553 
pg
->
	`»£t_mš_³”_ã©u»s
();

8554 
	`g‘_šfos
();

8555 ià(
´iÜ_£t
.
pg_down
) {

8556 
	`po¡_ev’t
(
	`IsDown
());

8557 } ià(
³”_šfo_»que¡ed
.
	`em±y
()) {

8558 
	`po¡_ev’t
(
	`GÙInfo
());

8560 
	}
}

8562 
	gPG
::
Recov”yS‹
::
G‘Info
::
	$g‘_šfos
()

8564 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8565 
Pa¡IÁ”v®s
::
PriÜS‘
 &
´iÜ_£t
 = 
cÚ‹xt
< 
P“ršg
 >().prior_set;

8567 
pg
->
blocked_by
.
	`ş—r
();

8568 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
™
 = 
´iÜ_£t
.
´obe
.
	`begš
();

8569 
™
 !ğ
´iÜ_£t
.
´obe
.
	`’d
();

8570 ++
™
) {

8571 
pg_sh¬d_t
 
³”
 = *
™
;

8572 ià(
³”
 =ğ
pg
->
pg_whßmi
) {

8575 ià(
pg
->
³”_šfo
.
	`couÁ
(
³”
)) {

8576 
	`ldout
(
pg
->
cù
, 10è<< " havosd." << 
³”
 << " infØ" <<…g->
³”_šfo
[³”] << 
d’dl
;

8579 ià(
³”_šfo_»que¡ed
.
	`couÁ
(
³”
)) {

8580 
	`ldout
(
pg
->
cù
, 10è<< "‡Ì—dy„eque¡ed infØäom osd." << 
³”
 << 
d’dl
;

8581 
pg
->
blocked_by
.
	`š£¹
(
³”
.
osd
);

8582 } ià(!
pg
->
	`g‘_osdm­
()->
	`is_up
(
³”
.
osd
)) {

8583 
	`ldout
(
pg
->
cù
, 10è<< "‚Ù qu”yšg infØäom dowÀosd." << 
³”
 << 
d’dl
;

8585 
	`ldout
(
pg
->
cù
, 10è<< " qu”yšg infØäom osd." << 
³”
 << 
d’dl
;

8586 
cÚ‹xt
< 
Recov”yMachše
 >().
	`£nd_qu”y
(

8587 
³”
, 
	`pg_qu”y_t
(
pg_qu”y_t
::
INFO
,

8588 
™
->
sh¬d
, 
pg
->
pg_whßmi
.shard,

8589 
pg
->
šfo
.
hi¡Üy
,

8590 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
()));

8591 
³”_šfo_»que¡ed
.
	`š£¹
(
³”
);

8592 
pg
->
blocked_by
.
	`š£¹
(
³”
.
osd
);

8596 
pg
->
	`publish_¡©s_to_osd
();

8597 
	}
}

8599 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
G‘Info
::
	$»aù
(cÚ¡ 
MNÙifyRec
& 
šfÛvt
)

8601 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8603 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
p
 = 
³”_šfo_»que¡ed
.
	`fšd
(
šfÛvt
.
äom
);

8604 ià(
p
 !ğ
³”_šfo_»que¡ed
.
	`’d
()) {

8605 
³”_šfo_»que¡ed
.
	`”a£
(
p
);

8606 
pg
->
blocked_by
.
	`”a£
(
šfÛvt
.
äom
.
osd
);

8609 
•och_t
 
Şd_¡¬t
 = 
pg
->
šfo
.
hi¡Üy
.
Ï¡_•och_¡¬‹d
;

8610 ià(
pg
->
	`´oc_»¶iÿ_šfo
(

8611 
šfÛvt
.
äom
, infÛvt.
nÙify
.
šfo
, infÛvt.nÙify.
•och_£Á
)) {

8613 
Pa¡IÁ”v®s
::
PriÜS‘
 &
´iÜ_£t
 = 
cÚ‹xt
< 
P“ršg
 >().prior_set;

8614 ià(
Şd_¡¬t
 < 
pg
->
šfo
.
hi¡Üy
.
Ï¡_•och_¡¬‹d
) {

8615 
	`ldout
(
pg
->
cù
, 10è<< "†a¡_•och_¡¬‹d moved fÜw¬d,„ebudšg…riÜ" << 
d’dl
;

8616 
´iÜ_£t
 = 
pg
->
	`bud_´iÜ
();

8621 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
p
 = 
³”_šfo_»que¡ed
.
	`begš
();

8622 
p
 !ğ
³”_šfo_»que¡ed
.
	`’d
()) {

8623 ià(
´iÜ_£t
.
´obe
.
	`couÁ
(*
p
) == 0) {

8624 
	`ldout
(
pg
->
cù
, 20è<< " drİpšg osd." << *
p
 << " from info_»que¡ed,‚ØlÚg” iÀ´ob£t" << 
d’dl
;

8625 
³”_šfo_»que¡ed
.
	`”a£
(
p
++);

8627 ++
p
;

8630 
	`g‘_šfos
();

8632 
	`ldout
(
pg
->
cù
, 20è<< "Addšg osd: " << 
šfÛvt
.
äom
.
osd
 << "…eer features: "

8633 << 
hex
 << 
šfÛvt
.
ã©u»s
 << 
dec
 << 
d’dl
;

8634 
pg
->
	`­¶y_³”_ã©u»s
(
šfÛvt
.
ã©u»s
);

8637 ià(
³”_šfo_»que¡ed
.
	`em±y
(è&& !
´iÜ_£t
.
pg_down
) {

8638 
	`ldout
(
pg
->
cù
, 20è<< "CommÚ…“¸ã©u»s: " << 
hex
 <<…g->
	`g‘_mš_³”_ã©u»s
(è<< 
dec
 << 
d’dl
;

8639 
	`ldout
(
pg
->
cù
, 20è<< "CommÚ‡ùšg f—tu»s: " << 
hex
 <<…g->
	`g‘_mš_aùšg_ã©u»s
(è<< 
dec
 << 
d’dl
;

8640 
	`ldout
(
pg
->
cù
, 20è<< "CommÚ u·ùšg f—tu»s: " << 
hex
 <<…g->
	`g‘_mš_u·ùšg_ã©u»s
(è<< 
dec
 << 
d’dl
;

8641 
	`po¡_ev’t
(
	`GÙInfo
());

8644  
	`disÿrd_ev’t
();

8645 
	}
}

8647 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
G‘Info
::
	$»aù
(cÚ¡ 
Qu”yS‹
& 
q
)

8649 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8650 
q
.
f
->
	`İ’_objeù_£ùiÚ
("state");

8651 
q
.
f
->
	`dump_¡ršg
("Çme", 
¡©e_Çme
);

8652 
q
.
f
->
	`dump_¡»am
("’‹r_time"è<< 
’‹r_time
;

8654 
q
.
f
->
	`İ’_¬¿y_£ùiÚ
("requested_info_from");

8655 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
p
 = 
³”_šfo_»que¡ed
.
	`begš
();

8656 
p
 !ğ
³”_šfo_»que¡ed
.
	`’d
();

8657 ++
p
) {

8658 
q
.
f
->
	`İ’_objeù_£ùiÚ
("osd");

8659 
q
.
f
->
	`dump_¡»am
("osd"è<< *
p
;

8660 ià(
pg
->
³”_šfo
.
	`couÁ
(*
p
)) {

8661 
q
.
f
->
	`İ’_objeù_£ùiÚ
("got_info");

8662 
pg
->
³”_šfo
[*
p
].
	`dump
(
q
.
f
);

8663 
q
.
f
->
	`şo£_£ùiÚ
();

8665 
q
.
f
->
	`şo£_£ùiÚ
();

8667 
q
.
f
->
	`şo£_£ùiÚ
();

8669 
q
.
f
->
	`şo£_£ùiÚ
();

8670  
	`fÜw¬d_ev’t
();

8671 
	}
}

8673 
	gPG
::
Recov”yS‹
::
G‘Info
::
	$ex™
()

8675 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

8676 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8677 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

8678 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_g‘šfo_Ï‹ncy
, 
dur
);

8679 
pg
->
blocked_by
.
	`ş—r
();

8680 
	}
}

8683 
	gPG
::
Recov”yS‹
::
G‘Log
::
	$G‘Log
(
my_cÚ‹xt
 
ùx
)

8684 : 
	`my_ba£
(
ùx
),

8685 
	`NamedS‹
(

8686 
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Peering/GetLog"),

8687 
	$msg
(0)

8689 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

8691 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8694 ià(!
pg
->
	`choo£_aùšg
(
auth_log_sh¬d
, 
çl£
,

8695 &
cÚ‹xt
< 
P“ršg
 >().
hi¡Üy_Ës_bound
)) {

8696 ià(!
pg
->
wªt_aùšg
.
	`em±y
()) {

8697 
	`po¡_ev’t
(
	`N“dAùšgChªge
());

8699 
	`po¡_ev’t
(
	`IsIncom¶‘e
());

8705 ià(
auth_log_sh¬d
 =ğ
pg
->
pg_whßmi
) {

8706 
	`po¡_ev’t
(
	`GÙLog
());

8710 cÚ¡ 
pg_šfo_t
& 
be¡
 = 
pg
->
³”_šfo
[
auth_log_sh¬d
];

8713 ià(
pg
->
šfo
.
Ï¡_upd©e
 < 
be¡
.
log_
) {

8714 
	`ldout
(
pg
->
cù
, 10è<< "‚Ù cÚtiguou w™h osd." << 
auth_log_sh¬d
 << ", down" << 
d’dl
;

8715 
	`po¡_ev’t
(
	`IsIncom¶‘e
());

8720 
ev”siÚ_t
 
»que¡_log_äom
 = 
pg
->
šfo
.
Ï¡_upd©e
;

8721 
	`as£¹
(!
pg
->
aùšg_»cov”y_backfl
.
	`em±y
());

8722 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
p
 = 
pg
->
aùšg_»cov”y_backfl
.
	`begš
();

8723 
p
 !ğ
pg
->
aùšg_»cov”y_backfl
.
	`’d
();

8724 ++
p
) {

8725 ià(*
p
 =ğ
pg
->
pg_whßmi
) ;

8726 
pg_šfo_t
& 
ri
 = 
pg
->
³”_šfo
[*
p
];

8727 ià(
ri
.
Ï¡_upd©e
 < 
pg
->
šfo
.
log_
 &&„i.Ï¡_upd©>ğ
be¡
.log_tail &&

8728 
ri
.
Ï¡_upd©e
 < 
»que¡_log_äom
)

8729 
»que¡_log_äom
 = 
ri
.
Ï¡_upd©e
;

8733 
	`ldout
(
pg
->
cù
, 10è<< "„eque¡šg†og from osd." << 
auth_log_sh¬d
 << 
d’dl
;

8734 
cÚ‹xt
<
Recov”yMachše
>().
	`£nd_qu”y
(

8735 
auth_log_sh¬d
,

8736 
	`pg_qu”y_t
(

8737 
pg_qu”y_t
::
LOG
,

8738 
auth_log_sh¬d
.
sh¬d
, 
pg
->
pg_whßmi
.shard,

8739 
»que¡_log_äom
, 
pg
->
šfo
.
hi¡Üy
,

8740 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
()));

8742 
	`as£¹
(
pg
->
blocked_by
.
	`em±y
());

8743 
pg
->
blocked_by
.
	`š£¹
(
auth_log_sh¬d
.
osd
);

8744 
pg
->
	`publish_¡©s_to_osd
();

8745 
	}
}

8747 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
G‘Log
::
	$»aù
(cÚ¡ 
AdvM­
& 
advm­
)

8749 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8753 ià(!
advm­
.
osdm­
->
	`is_up
(
auth_log_sh¬d
.
osd
)) {

8754 
	`ldout
(
pg
->
cù
, 10) << "GetLog:‡uth_log_shard osd."

8755 << 
auth_log_sh¬d
.
osd
 << " w’ˆdown" << 
d’dl
;

8756 
	`po¡_ev’t
(
advm­
);

8757  
Œªs™
< 
Re£t
 >();

8761  
	`fÜw¬d_ev’t
();

8762 
	}
}

8764 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
G‘Log
::
	$»aù
(cÚ¡ 
MLogRec
& 
logevt
)

8766 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8767 
	`as£¹
(!
msg
);

8768 ià(
logevt
.
äom
 !ğ
auth_log_sh¬d
) {

8769 
	`ldout
(
pg
->
cù
, 10) << "GetLog: discarding†og from "

8770 << "nÚ-auth_log_sh¬d osd." << 
logevt
.
äom
 << 
d’dl
;

8771  
	`disÿrd_ev’t
();

8773 
	`ldout
(
pg
->
cù
, 10) << "GetLog:„eceived master†og from osd"

8774 << 
logevt
.
äom
 << 
d’dl
;

8775 
msg
 = 
logevt
.msg;

8776 
	`po¡_ev’t
(
	`GÙLog
());

8777  
	`disÿrd_ev’t
();

8778 
	}
}

8780 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
G‘Log
::
	$»aù
(cÚ¡ 
GÙLog
&)

8782 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8783 
	`ldout
(
pg
->
cù
, 10è<< "Ëavšg G‘Log" << 
d’dl
;

8784 ià(
msg
) {

8785 
	`ldout
(
pg
->
cù
, 10è<< "´oûssšg ma¡”†og" << 
d’dl
;

8786 
pg
->
	`´oc_ma¡”_log
(*
cÚ‹xt
<
Recov”yMachše
>().
	`g‘_cur_Œª§ùiÚ
(),

8787 
msg
->
šfo
, msg->
log
, msg->
missšg
,

8788 
auth_log_sh¬d
);

8790 
pg
->
	`¡¬t_æush
(
cÚ‹xt
< 
Recov”yMachše
 >().
	`g‘_cur_Œª§ùiÚ
());

8791  
Œªs™
< 
G‘Missšg
 >();

8792 
	}
}

8794 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
G‘Log
::
	$»aù
(cÚ¡ 
Qu”yS‹
& 
q
)

8796 
q
.
f
->
	`İ’_objeù_£ùiÚ
("state");

8797 
q
.
f
->
	`dump_¡ršg
("Çme", 
¡©e_Çme
);

8798 
q
.
f
->
	`dump_¡»am
("’‹r_time"è<< 
’‹r_time
;

8799 
q
.
f
->
	`dump_¡»am
("auth_log_sh¬d"è<< 
auth_log_sh¬d
;

8800 
q
.
f
->
	`şo£_£ùiÚ
();

8801  
	`fÜw¬d_ev’t
();

8802 
	}
}

8804 
	gPG
::
Recov”yS‹
::
G‘Log
::
	$ex™
()

8806 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

8807 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8808 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

8809 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_g‘log_Ï‹ncy
, 
dur
);

8810 
pg
->
blocked_by
.
	`ş—r
();

8811 
	}
}

8814 
	gPG
::
Recov”yS‹
::
Wa™AùšgChªge
::
	$Wa™AùšgChªge
(
my_cÚ‹xt
 
ùx
)

8815 : 
	`my_ba£
(
ùx
),

8816 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/WaitActingChange")

8818 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

8819 
	}
}

8821 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Wa™AùšgChªge
::
	$»aù
(cÚ¡ 
AdvM­
& 
advm­
)

8823 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8824 
OSDM­Ref
 
osdm­
 = 
advm­
.osdmap;

8826 
	`ldout
(
pg
->
cù
, 10è<< "v”ifyšg‚Øwªt_aùšg " <<…g->
wªt_aùšg
 << "¬g‘ didn'ˆgØdown" << 
d’dl
;

8827 
veùÜ
<>::
™”©Ü
 
p
 = 
pg
->
wªt_aùšg
.
	`begš
();… !ğpg->wªt_aùšg.
	`’d
(); ++p) {

8828 ià(!
osdm­
->
	`is_up
(*
p
)) {

8829 
	`ldout
(
pg
->
cù
, 10è<< " wªt_aùšg¬g‘ osd." << *
p
 << " w’ˆdown,„e£‰šg" << 
d’dl
;

8830 
	`po¡_ev’t
(
advm­
);

8831  
Œªs™
< 
Re£t
 >();

8834  
	`fÜw¬d_ev’t
();

8835 
	}
}

8837 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Wa™AùšgChªge
::
	$»aù
(cÚ¡ 
MLogRec
& 
logevt
)

8839 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8840 
	`ldout
(
pg
->
cù
, 10è<< "IÀWa™AùšgChªge, ignÜšg MLocRec" << 
d’dl
;

8841  
	`disÿrd_ev’t
();

8842 
	}
}

8844 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Wa™AùšgChªge
::
	$»aù
(cÚ¡ 
MInfoRec
& 
evt
)

8846 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8847 
	`ldout
(
pg
->
cù
, 10è<< "IÀWa™AùšgChªge, ignÜšg MInfoRec" << 
d’dl
;

8848  
	`disÿrd_ev’t
();

8849 
	}
}

8851 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Wa™AùšgChªge
::
	$»aù
(cÚ¡ 
MNÙifyRec
& 
evt
)

8853 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8854 
	`ldout
(
pg
->
cù
, 10è<< "IÀWa™AùšgChªge, ignÜšg MNÙifyRec" << 
d’dl
;

8855  
	`disÿrd_ev’t
();

8856 
	}
}

8858 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Wa™AùšgChªge
::
	$»aù
(cÚ¡ 
Qu”yS‹
& 
q
)

8860 
q
.
f
->
	`İ’_objeù_£ùiÚ
("state");

8861 
q
.
f
->
	`dump_¡ršg
("Çme", 
¡©e_Çme
);

8862 
q
.
f
->
	`dump_¡»am
("’‹r_time"è<< 
’‹r_time
;

8863 
q
.
f
->
	`dump_¡ršg
("comment", "waiting for…g‡cting seto change");

8864 
q
.
f
->
	`şo£_£ùiÚ
();

8865  
	`fÜw¬d_ev’t
();

8866 
	}
}

8868 
	gPG
::
Recov”yS‹
::
Wa™AùšgChªge
::
	$ex™
()

8870 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

8871 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8872 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

8873 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_wa™aùšgchªge_Ï‹ncy
, 
dur
);

8874 
	}
}

8877 
	gPG
::
Recov”yS‹
::
Down
::
	$Down
(
my_cÚ‹xt
 
ùx
)

8878 : 
	`my_ba£
(
ùx
),

8879 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Peering/Down")

8881 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

8882 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8884 
pg
->
	`¡©e_ş—r
(
PG_STATE_PEERING
);

8885 
pg
->
	`¡©e_£t
(
PG_STATE_DOWN
);

8887 autØ&
´iÜ_£t
 = 
cÚ‹xt
< 
P“ršg
 >().prior_set;

8888 
	`as£¹
(
pg
->
blocked_by
.
	`em±y
());

8889 
pg
->
blocked_by
.
	`š£¹
(
´iÜ_£t
.
down
.
	`begš
(),…riÜ_£t.down.
	`’d
());

8890 
pg
->
	`publish_¡©s_to_osd
();

8891 
	}
}

8893 
	gPG
::
Recov”yS‹
::
Down
::
	$ex™
()

8895 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

8896 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8898 
pg
->
	`¡©e_ş—r
(
PG_STATE_DOWN
);

8899 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

8900 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_down_Ï‹ncy
, 
dur
);

8902 
pg
->
blocked_by
.
	`ş—r
();

8903 
	}
}

8905 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Down
::
	$»aù
(cÚ¡ 
Qu”yS‹
& 
q
)

8907 
q
.
f
->
	`İ’_objeù_£ùiÚ
("state");

8908 
q
.
f
->
	`dump_¡ršg
("Çme", 
¡©e_Çme
);

8909 
q
.
f
->
	`dump_¡»am
("’‹r_time"è<< 
’‹r_time
;

8910 
q
.
f
->
	`dump_¡ršg
("comment",

8912 
q
.
f
->
	`şo£_£ùiÚ
();

8913  
	`fÜw¬d_ev’t
();

8914 
	}
}

8916 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Down
::
	$»aù
(cÚ¡ 
MNÙifyRec
& 
šfÛvt
)

8918 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8920 
	`as£¹
(
pg
->
	`is_´im¬y
());

8921 
•och_t
 
Şd_¡¬t
 = 
pg
->
šfo
.
hi¡Üy
.
Ï¡_•och_¡¬‹d
;

8922 ià(!
pg
->
³”_šfo
.
	`couÁ
(
šfÛvt
.
äom
) &&

8923 
pg
->
	`g‘_osdm­
()->
	`has_b“n_up_sšû
(
šfÛvt
.
äom
.
osd
, infÛvt.
nÙify
.
•och_£Á
)) {

8924 
pg
->
	`upd©e_hi¡Üy
(
šfÛvt
.
nÙify
.
šfo
.
hi¡Üy
);

8927 ià(
pg
->
šfo
.
hi¡Üy
.
Ï¡_•och_¡¬‹d
 > 
Şd_¡¬t
) {

8928 
	`ldout
(
pg
->
cù
, 10è<< "†a¡_•och_¡¬‹d moved fÜw¬d,„e-’‹¸g‘šfo" << 
d’dl
;

8929 
pg
->
	`¡©e_ş—r
(
PG_STATE_DOWN
);

8930 
pg
->
	`¡©e_£t
(
PG_STATE_PEERING
);

8931  
Œªs™
< 
G‘Info
 >();

8934  
	`disÿrd_ev’t
();

8935 
	}
}

8939 
	gPG
::
Recov”yS‹
::
Incom¶‘e
::
	$Incom¶‘e
(
my_cÚ‹xt
 
ùx
)

8940 : 
	`my_ba£
(
ùx
),

8941 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Peering/Incomplete")

8943 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

8944 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8946 
pg
->
	`¡©e_ş—r
(
PG_STATE_PEERING
);

8947 
pg
->
	`¡©e_£t
(
PG_STATE_INCOMPLETE
);

8949 
Pa¡IÁ”v®s
::
PriÜS‘
 &
´iÜ_£t
 = 
cÚ‹xt
< 
P“ršg
 >().prior_set;

8950 
	`as£¹
(
pg
->
blocked_by
.
	`em±y
());

8951 
pg
->
blocked_by
.
	`š£¹
(
´iÜ_£t
.
down
.
	`begš
(),…riÜ_£t.down.
	`’d
());

8952 
pg
->
	`publish_¡©s_to_osd
();

8953 
	}
}

8955 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Incom¶‘e
::
	$»aù
(cÚ¡ 
AdvM­
 &
advm­
) {

8956 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8957 
št64_t
 
poŞnum
 = 
pg
->
šfo
.
pgid
.
	`poŞ
();

8960 ià(!
advm­
.
osdm­
->
	`have_pg_poŞ
(
poŞnum
) ||

8961 
advm­
.
Ï¡m­
->
	`g‘_poŞs
().
	`fšd
(
poŞnum
)->
£cÚd
.
mš_size
 >

8962 
advm­
.
osdm­
->
	`g‘_poŞs
().
	`fšd
(
poŞnum
)->
£cÚd
.
mš_size
) {

8963 
	`po¡_ev’t
(
advm­
);

8964  
Œªs™
< 
Re£t
 >();

8967  
	`fÜw¬d_ev’t
();

8968 
	}
}

8970 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Incom¶‘e
::
	$»aù
(cÚ¡ 
MNÙifyRec
& 
nÙevt
) {

8971 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8972 
	`ldout
(
pg
->
cù
, 7è<< "hªdË_pg_nÙify from osd." << 
nÙevt
.
äom
 << 
d’dl
;

8973 ià(
pg
->
	`´oc_»¶iÿ_šfo
(

8974 
nÙevt
.
äom
,‚Ùevt.
nÙify
.
šfo
,‚Ùevt.nÙify.
•och_£Á
)) {

8976  
Œªs™
< 
G‘Log
 >();

8978  
	`disÿrd_ev’t
();

8980 
	}
}

8982 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Incom¶‘e
::
	$»aù
(

8983 cÚ¡ 
Qu”yS‹
& 
q
)

8985 
q
.
f
->
	`İ’_objeù_£ùiÚ
("state");

8986 
q
.
f
->
	`dump_¡ršg
("Çme", 
¡©e_Çme
);

8987 
q
.
f
->
	`dump_¡»am
("’‹r_time"è<< 
’‹r_time
;

8988 
q
.
f
->
	`dump_¡ršg
("comment", "notƒnough complete instances ofhis PG");

8989 
q
.
f
->
	`şo£_£ùiÚ
();

8990  
	`fÜw¬d_ev’t
();

8991 
	}
}

8993 
	gPG
::
Recov”yS‹
::
Incom¶‘e
::
	$ex™
()

8995 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

8996 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

8998 
pg
->
	`¡©e_ş—r
(
PG_STATE_INCOMPLETE
);

8999 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

9000 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_šcom¶‘e_Ï‹ncy
, 
dur
);

9002 
pg
->
blocked_by
.
	`ş—r
();

9003 
	}
}

9006 
	gPG
::
Recov”yS‹
::
G‘Missšg
::
	$G‘Missšg
(
my_cÚ‹xt
 
ùx
)

9007 : 
	`my_ba£
(
ùx
),

9008 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Peering/GetMissing")

9010 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

9012 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

9013 
	`as£¹
(!
pg
->
aùšg_»cov”y_backfl
.
	`em±y
());

9014 
ev”siÚ_t
 
sšû
;

9015 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
pg
->
aùšg_»cov”y_backfl
.
	`begš
();

9016 
i
 !ğ
pg
->
aùšg_»cov”y_backfl
.
	`’d
();

9017 ++
i
) {

9018 ià(*
i
 =ğ
pg
->
	`g‘_´im¬y
()) ;

9019 cÚ¡ 
pg_šfo_t
& 
pi
 = 
pg
->
³”_šfo
[*
i
];

9024 
pg
->
³”_missšg
[*
i
].
may_šşude_d–‘es
 = !pg->
	`³rfÜm_d–‘es_duršg_³”šg
();

9026 ià(
pi
.
	`is_em±y
())

9029 ià(
pi
.
Ï¡_upd©e
 < 
pg
->
pg_log
.
	`g‘_
()) {

9030 
	`ldout
(
pg
->
cù
, 10è<< " osd." << *
i
 << " i nÙ cÚtiguous, wÈ»¡¬ˆbackfl" << 
d’dl
;

9031 
pg
->
³”_missšg
[*
i
].
	`ş—r
();

9034 ià(
pi
.
Ï¡_backfl
 =ğ
	`hobjeù_t
()) {

9035 
	`ldout
(
pg
->
cù
, 10è<< " osd." << *
i
 << " wÈfuÎy backfl; cª inã¸em±y missšg s‘" << 
d’dl
;

9036 
pg
->
³”_missšg
[*
i
].
	`ş—r
();

9040 ià(
pi
.
Ï¡_upd©e
 =ğpi.
Ï¡_com¶‘e
 &&

9041 
pi
.
Ï¡_upd©e
 =ğ
pg
->
šfo
.last_update) {

9046 
	`ldout
(
pg
->
cù
, 10è<< " osd." << *
i
 << " ha nØmissšg, id’tiÿÈlog" << 
d’dl
;

9047 
pg
->
³”_missšg
[*
i
].
	`ş—r
();

9053 
sšû
.
•och
 = 
pi
.
Ï¡_•och_¡¬‹d
;

9054 
	`as£¹
(
pi
.
Ï¡_upd©e
 >ğ
pg
->
šfo
.
log_
);

9055 ià(
pi
.
log_
 <ğ
sšû
) {

9056 
	`ldout
(
pg
->
cù
, 10è<< "„eque¡šg†og+missšg sšû " << 
sšû
 << " from osd." << *
i
 << 
d’dl
;

9057 
cÚ‹xt
< 
Recov”yMachše
 >().
	`£nd_qu”y
(

9058 *
i
,

9059 
	`pg_qu”y_t
(

9060 
pg_qu”y_t
::
LOG
,

9061 
i
->
sh¬d
, 
pg
->
pg_whßmi
.shard,

9062 
sšû
, 
pg
->
šfo
.
hi¡Üy
,

9063 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
()));

9065 
	`ldout
(
pg
->
cù
, 10è<< "„eque¡šg fuÎlog+missšg from osd." << *
i


9066 << " (wªˆsšû " << 
sšû
 << " <†og.tail "

9067 << 
pi
.
log_
 << ")" << 
d’dl
;

9068 
cÚ‹xt
< 
Recov”yMachše
 >().
	`£nd_qu”y
(

9069 *
i
, 
	`pg_qu”y_t
(

9070 
pg_qu”y_t
::
FULLLOG
,

9071 
i
->
sh¬d
, 
pg
->
pg_whßmi
.shard,

9072 
pg
->
šfo
.
hi¡Üy
,…g->
	`g‘_osdm­
()->
	`g‘_•och
()));

9074 
³”_missšg_»que¡ed
.
	`š£¹
(*
i
);

9075 
pg
->
blocked_by
.
	`š£¹
(
i
->
osd
);

9078 ià(
³”_missšg_»que¡ed
.
	`em±y
()) {

9079 ià(
pg
->
Ãed_up_thru
) {

9080 
	`ldout
(
pg
->
cù
, 10) << " still‚eed up_thru update before going‡ctive"

9081 << 
d’dl
;

9082 
	`po¡_ev’t
(
	`N“dUpThru
());

9087 
	`po¡_ev’t
(
	`Aùiv©e
(
pg
->
	`g‘_osdm­
()->
	`g‘_•och
()));

9089 
pg
->
	`publish_¡©s_to_osd
();

9091 
	}
}

9093 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
G‘Missšg
::
	$»aù
(cÚ¡ 
MLogRec
& 
logevt
)

9095 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

9097 
³”_missšg_»que¡ed
.
	`”a£
(
logevt
.
äom
);

9098 
pg
->
	`´oc_»¶iÿ_log
(
logevt
.
msg
->
šfo
,†ogevt.msg->
log
,†ogevt.msg->
missšg
,†ogevt.
äom
);

9100 ià(
³”_missšg_»que¡ed
.
	`em±y
()) {

9101 ià(
pg
->
Ãed_up_thru
) {

9102 
	`ldout
(
pg
->
cù
, 10) << " still‚eed up_thru update before going‡ctive"

9103 << 
d’dl
;

9104 
	`po¡_ev’t
(
	`N“dUpThru
());

9106 
	`ldout
(
pg
->
cù
, 10) << "Got†ast missing, don't‚eed missing "

9107 << "po¡šg Aùiv©e" << 
d’dl
;

9108 
	`po¡_ev’t
(
	`Aùiv©e
(
pg
->
	`g‘_osdm­
()->
	`g‘_•och
()));

9111  
	`disÿrd_ev’t
();

9112 
	}
}

9114 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
G‘Missšg
::
	$»aù
(cÚ¡ 
Qu”yS‹
& 
q
)

9116 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

9117 
q
.
f
->
	`İ’_objeù_£ùiÚ
("state");

9118 
q
.
f
->
	`dump_¡ršg
("Çme", 
¡©e_Çme
);

9119 
q
.
f
->
	`dump_¡»am
("’‹r_time"è<< 
’‹r_time
;

9121 
q
.
f
->
	`İ’_¬¿y_£ùiÚ
("peer_missing_requested");

9122 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
p
 = 
³”_missšg_»que¡ed
.
	`begš
();

9123 
p
 !ğ
³”_missšg_»que¡ed
.
	`’d
();

9124 ++
p
) {

9125 
q
.
f
->
	`İ’_objeù_£ùiÚ
("osd");

9126 
q
.
f
->
	`dump_¡»am
("osd"è<< *
p
;

9127 ià(
pg
->
³”_missšg
.
	`couÁ
(*
p
)) {

9128 
q
.
f
->
	`İ’_objeù_£ùiÚ
("got_missing");

9129 
pg
->
³”_missšg
[*
p
].
	`dump
(
q
.
f
);

9130 
q
.
f
->
	`şo£_£ùiÚ
();

9132 
q
.
f
->
	`şo£_£ùiÚ
();

9134 
q
.
f
->
	`şo£_£ùiÚ
();

9136 
q
.
f
->
	`şo£_£ùiÚ
();

9137  
	`fÜw¬d_ev’t
();

9138 
	}
}

9140 
	gPG
::
Recov”yS‹
::
G‘Missšg
::
	$ex™
()

9142 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

9143 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

9144 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

9145 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_g‘missšg_Ï‹ncy
, 
dur
);

9146 
pg
->
blocked_by
.
	`ş—r
();

9147 
	}
}

9150 
	gPG
::
Recov”yS‹
::
Wa™UpThru
::
	$Wa™UpThru
(
my_cÚ‹xt
 
ùx
)

9151 : 
	`my_ba£
(
ùx
),

9152 
	`NamedS‹
(
cÚ‹xt
< 
Recov”yMachše
 >().
pg
, "Started/Primary/Peering/WaitUpThru")

9154 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_’‹r
(
¡©e_Çme
);

9155 
	}
}

9157 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Wa™UpThru
::
	$»aù
(cÚ¡ 
AùM­
& 
am
)

9159 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

9160 ià(!
pg
->
Ãed_up_thru
) {

9161 
	`po¡_ev’t
(
	`Aùiv©e
(
pg
->
	`g‘_osdm­
()->
	`g‘_•och
()));

9163  
	`fÜw¬d_ev’t
();

9164 
	}
}

9166 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Wa™UpThru
::
	$»aù
(cÚ¡ 
MLogRec
& 
logevt
)

9168 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

9169 
	`ldout
(
pg
->
cù
, 10è<< "NÙšg missšg from osd." << 
logevt
.
äom
 << 
d’dl
;

9170 
pg
->
³”_missšg
[
logevt
.
äom
].
	`şaim
Öogevt.
msg
->
missšg
);

9171 
pg
->
³”_šfo
[
logevt
.
äom
] =†ogevt.
msg
->
šfo
;

9172  
	`disÿrd_ev’t
();

9173 
	}
}

9175 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
PG
::
Recov”yS‹
::
Wa™UpThru
::
	$»aù
(cÚ¡ 
Qu”yS‹
& 
q
)

9177 
q
.
f
->
	`İ’_objeù_£ùiÚ
("state");

9178 
q
.
f
->
	`dump_¡ršg
("Çme", 
¡©e_Çme
);

9179 
q
.
f
->
	`dump_¡»am
("’‹r_time"è<< 
’‹r_time
;

9180 
q
.
f
->
	`dump_¡ršg
("comment", "waiting for osdmapo„eflect‡‚ew up_thru forhis osd");

9181 
q
.
f
->
	`şo£_£ùiÚ
();

9182  
	`fÜw¬d_ev’t
();

9183 
	}
}

9185 
	gPG
::
Recov”yS‹
::
Wa™UpThru
::
	$ex™
()

9187 
cÚ‹xt
< 
Recov”yMachše
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

9188 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

9189 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

9190 
pg
->
osd
->
»cov”y¡©e_³rf
->
	`tšc
(
rs_wa™u±hru_Ï‹ncy
, 
dur
);

9191 
	}
}

9194 #undeà
dout_´efix


9195 
	#dout_´efix
 
pg
->
	`g’_´efix
(*
_dout
)

	)

9197 
	gPG
::
Recov”yS‹
::
Recov”yMachše
::
	$log_’‹r
(cÚ¡ *
¡©e_Çme
)

9199 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

9200 
	`ldout
(
pg
->
cù
, 5è<< "’‹¸" << 
¡©e_Çme
 << 
d’dl
;

9201 
pg
->
osd
->
pg_»cov”y_¡©s
.
	`log_’‹r
(
¡©e_Çme
);

9202 
	}
}

9204 
	gPG
::
Recov”yS‹
::
Recov”yMachše
::
	$log_ex™
(cÚ¡ *
¡©e_Çme
, 
utime_t
 
’‹r_time
)

9206 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
’‹r_time
;

9207 
PG
 *
pg
 = 
cÚ‹xt
< 
Recov”yMachše
 >().pg;

9208 
	`ldout
(
pg
->
cù
, 5è<< "ex™ " << 
¡©e_Çme
 << " " << 
dur
 << " " << 
ev’t_couÁ
 << " " << 
ev’t_time
 << 
d’dl
;

9209 
pg
->
osd
->
pg_»cov”y_¡©s
.
	`log_ex™
(
¡©e_Çme
, 
	`ûph_şock_now
(è- 
’‹r_time
,

9210 
ev’t_couÁ
, 
ev’t_time
);

9211 
ev’t_couÁ
 = 0;

9212 
ev’t_time
 = 
	`utime_t
();

9213 
	}
}

9217 #undeà
dout_´efix


9218 
	#dout_´efix
 ((
debug_pg
 ? debug_pg->
	`g’_´efix
(*
_dout
è: *_doutè<< " PriÜS‘: ")

	)

9220 
	gPG
::
Recov”yS‹
::
	$¡¬t_hªdË
(
Recov”yCtx
 *
Ãw_ùx
) {

9221 
	`as£¹
(!
rùx
);

9222 
	`as£¹
(!
Üig_ùx
);

9223 
Üig_ùx
 = 
Ãw_ùx
;

9224 ià(
Ãw_ùx
) {

9225 ià(
mes§ges_³ndšg_æush
) {

9226 
rùx
 = 
	`Recov”yCtx
(*
mes§ges_³ndšg_æush
, *
Ãw_ùx
);

9228 
rùx
 = *
Ãw_ùx
;

9230 
rùx
->
¡¬t_time
 = 
	`ûph_şock_now
();

9232 
	}
}

9234 
	gPG
::
Recov”yS‹
::
	$begš_block_outgošg
() {

9235 
	`as£¹
(!
mes§ges_³ndšg_æush
);

9236 
	`as£¹
(
Üig_ùx
);

9237 
	`as£¹
(
rùx
);

9238 
mes§ges_³ndšg_æush
 = 
	`Bufã»dRecov”yMes§ges
();

9239 
rùx
 = 
	`Recov”yCtx
(*
mes§ges_³ndšg_æush
, *
Üig_ùx
);

9240 
	}
}

9242 
	gPG
::
Recov”yS‹
::
	$ş—r_blocked_outgošg
() {

9243 
	`as£¹
(
Üig_ùx
);

9244 
	`as£¹
(
rùx
);

9245 
mes§ges_³ndšg_æush
 = 
boo¡
::
İtiÚ®
<
Bufã»dRecov”yMes§ges
>();

9246 
	}
}

9248 
	gPG
::
Recov”yS‹
::
	$’d_block_outgošg
() {

9249 
	`as£¹
(
mes§ges_³ndšg_æush
);

9250 
	`as£¹
(
Üig_ùx
);

9251 
	`as£¹
(
rùx
);

9253 
rùx
 = 
	`Recov”yCtx
(*
Üig_ùx
);

9254 
rùx
->
	`acû±_bufã»d_mes§ges
(*
mes§ges_³ndšg_æush
);

9255 
mes§ges_³ndšg_æush
 = 
boo¡
::
İtiÚ®
<
Bufã»dRecov”yMes§ges
>();

9256 
	}
}

9258 
	gPG
::
Recov”yS‹
::
	$’d_hªdË
() {

9259 ià(
rùx
) {

9260 
utime_t
 
dur
 = 
	`ûph_şock_now
(è- 
rùx
->
¡¬t_time
;

9261 
machše
.
ev’t_time
 +ğ
dur
;

9264 
machše
.
ev’t_couÁ
++;

9265 
rùx
 = 
boo¡
::
İtiÚ®
<
Recov”yCtx
>();

9266 
Üig_ùx
 = 
NULL
;

9267 
	}
}

9269 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gPG
::
BackflIÁ”v®
& 
bi
)

9271 
out
 << "BackflInfo(" << 
bi
.
begš
 << "-" << bi.
’d


9272 << " " << 
bi
.
objeùs
.
size
() << " objects";

9273 ià(!
	gbi
.
	gobjeùs
.
em±y
())

9274 
	gout
 << " " << 
	gbi
.
	gobjeùs
;

9275 
	gout
 << ")";

9276  
	gout
;

9279 
	gPG
::
	$dump_pg¡©e_hi¡Üy
(
FÜm©‹r
 *
f
)

9281 
	`lock
();

9282 
pg¡©e_hi¡Üy
.
	`dump
(
f
);

9283 
	`uÆock
();

9284 
	}
}

9286 
	gPG
::
	$dump_missšg
(
FÜm©‹r
 *
f
)

9288 auto& 
i
 : 
pg_log
.
	`g‘_missšg
().
	`g‘_™ems
()) {

9289 
f
->
	`İ’_objeù_£ùiÚ
("object");

9290 
f
->
	`dump_objeù
("oid", 
i
.
fœ¡
);

9291 
f
->
	`dump_objeù
("missšg_šfo", 
i
.
£cÚd
);

9292 ià(
missšg_loc
.
	`Ãeds_»cov”y
(
i
.
fœ¡
)) {

9293 
f
->
	`dump_boŞ
("unfound", 
missšg_loc
.
	`is_unfound
(
i
.
fœ¡
));

9294 
f
->
	`İ’_¬¿y_£ùiÚ
("locations");

9295 autØ
l
 : 
missšg_loc
.
	`g‘_loÿtiÚs
(
i
.
fœ¡
)) {

9296 
f
->
	`dump_objeù
("sh¬d", 
l
);

9298 
f
->
	`şo£_£ùiÚ
();

9300 
f
->
	`şo£_£ùiÚ
();

9302 
	}
}

9304 
	gPG
::
g‘_pg_¡©s
(
¡d
::
funùiÚ
<(cÚ¡ 
pg_¡©_t
&, 
•och_t
 
Ëc
)> 
f
)

9306 
	gpg_¡©s_publish_lock
.
Lock
();

9307 ià(
	gpg_¡©s_publish_v®id
) {

9308 
f
(
pg_¡©s_publish
,…g_¡©s_publish.
g‘_efãùive_Ï¡_•och_ş—n
());

9310 
	gpg_¡©s_publish_lock
.
UÆock
();

9313 
	gPG
::
w™h_h—¹b—t_³”s
(
¡d
::
funùiÚ
<()> 
f
)

9315 
h—¹b—t_³”_lock
.
Lock
();

9316 autØ
	gp
 : 
h—¹b—t_³”s
) {

9317 
f
(
p
);

9319 autØ
	gp
 : 
´obe_rg‘s
) {

9320 
f
(
p
);

9322 
	gh—¹b—t_³”_lock
.
UÆock
();

	@osd/PG.h

15 #iâdeà
CEPH_PG_H


16 
	#CEPH_PG_H


	)

18 
	~<boo¡/¡©ech¬t/cu¡om_»aùiÚ.hµ
>

19 
	~<boo¡/¡©ech¬t/ev’t.hµ
>

20 
	~<boo¡/¡©ech¬t/sim¶e_¡©e.hµ
>

21 
	~<boo¡/¡©ech¬t/¡©e.hµ
>

22 
	~<boo¡/¡©ech¬t/¡©e_machše.hµ
>

23 
	~<boo¡/¡©ech¬t/Œªs™iÚ.hµ
>

24 
	~<boo¡/¡©ech¬t/ev’t_ba£.hµ
>

25 
	~<boo¡/scİed_±r.hµ
>

26 
	~<boo¡/cœcuÏr_bufãr.hµ
>

27 
	~<boo¡/cÚš”/æ©_£t.hµ
>

28 
	~"šşude/memÜy.h
"

29 
	~"šşude/mempoŞ.h
"

32 
	~"šşude/as£¹.h
"

34 
	~"šşude/ty³s.h
"

35 
	~"šşude/¡ršgify.h
"

36 
	~"osd_ty³s.h
"

37 
	~"šşude/xli¡.h
"

38 
	~"SÇpM­³r.h
"

39 
	~"SessiÚ.h
"

40 
	~"commÚ/Tim”.h
"

42 
	~"PGLog.h
"

43 
	~"OSDM­.h
"

44 
	~"mes§ges/MOSDPGLog.h
"

45 
	~"šşude/¡r_li¡.h
"

46 
	~"PGBack’d.h
"

47 
	~"PGP“ršgEv’t.h
"

49 
	~<©omic
>

50 
	~<li¡
>

51 
	~<memÜy
>

52 
	~<¡ack
>

53 
	~<¡ršg
>

54 
	~<tu¶e
>

59 
şass
 
	gOSD
;

60 
şass
 
	gOSDS”viû
;

61 
şass
 
	gOSDSh¬d
;

62 
şass
 
	gOSDSh¬dPGSlÙ
;

63 
şass
 
	gMOSDOp
;

64 
şass
 
	gMOSDPGSÿn
;

65 
şass
 
	gMOSDPGBackfl
;

66 
şass
 
	gMOSDPGInfo
;

68 
şass
 
	gPG
;

69 
	gOpReque¡
;

70 
	gOpReque¡
::
	tRef
 
	tOpReque¡Ref
;

71 
şass
 
	gMOSDPGLog
;

72 
şass
 
	gC•hCÚ‹xt
;

74 
Çme¥aû
 
	gSüub
 {

75 
şass
 
	gStÜe
;

78 
usšg
 
	g¡©e_hi¡Üy_’Œy
 = 
¡d
::
tu¶e
<
utime_t
, 
	gutime_t
, const *>;

79 
usšg
 
	gembedded_¡©e
 = 
¡d
::
·œ
<
utime_t
, const *>;

81 
	sPGS‹In¡ªû
 {

84 
£‹poch
(cÚ¡ 
•och_t
 
cu¼’t_•och
) {

85 
	mthis_•och
 = 
cu¼’t_•och
;

88 
’‹r_¡©e
(cÚ¡ 
utime_t
 
’time
, cÚ¡ * 
¡©e
) {

89 
	membedded_¡©es
.
push
(
¡d
::
make_·œ
(
’time
, 
¡©e
));

92 
ex™_¡©e
(cÚ¡ 
utime_t
 
extime
) {

93 
embedded_¡©e
 
	mthis_¡©e
 = 
embedded_¡©es
.
tİ
();

94 
	m¡©e_hi¡Üy
.
push_back
(
¡©e_hi¡Üy_’Œy
{

95 
this_¡©e
.
fœ¡
, 
extime
,his_¡©e.
£cÚd
});

96 
	membedded_¡©es
.
pİ
();

99 
•och_t
 
	mthis_•och
;

100 
utime_t
 
	m’‹r_time
;

101 
	m¡d
::
veùÜ
<
¡©e_hi¡Üy_’Œy
> 
¡©e_hi¡Üy
;

102 
	m¡d
::
¡ack
<
embedded_¡©e
> 
embedded_¡©es
;

105 şas 
	cPGS‹Hi¡Üy
 {

107 
	mpublic
:

108 
	$PGS‹Hi¡Üy
(è: 
	$bufãr
(10) {}

110 
	`’‹r
(
PG
* 
pg
, cÚ¡ 
utime_t
 
’time
, cÚ¡ * 
¡©e
);

112 
	`ex™
(cÚ¡ * 
¡©e
);

114 
	$»£t
() {

115 
pi
 = 
nuÎ±r
;

116 
	}
}

118 
	$£t_pg_š_de¡ruùÜ
(è{ 
pg_š_de¡ruùÜ
 = 
Œue
; 
	}
}

120 
	$dump
(
FÜm©‹r
* 
f
) const;

122 
´iv©e
:

123 
boŞ
 
pg_š_de¡ruùÜ
 = 
çl£
;

124 
PG
* 
thi¥g
 = 
nuÎ±r
;

125 
¡d
::
unique_±r
<
PGS‹In¡ªû
> 
tmµi
;

126 
PGS‹In¡ªû
* 
pi
 = 
nuÎ±r
;

127 
boo¡
::
cœcuÏr_bufãr
<
¡d
::
unique_±r
<
PGS‹In¡ªû
>> 
bufãr
;

129 
	}
};

131 #ifdeà
PG_DEBUG_REFS


132 
	~"commÚ/Œacked_št_±r.hµ
"

133 
ušt64_t
 
g‘_w™h_id
(
PG
 *
pg
);

134 
put_w™h_id
(
PG
 *
pg
, 
ušt64_t
 
id
);

135 
	gT¿ckedIÁPŒ
<
	tPG
> 
	tPGRef
;

137 
	gboo¡
::
	tšŒusive_±r
<
	tPG
> 
	tPGRef
;

140 şas 
	cPGRecov”ySts
 {

141 
	s³r_¡©e_šfo
 {

142 
ušt64_t
 
	m’‹r
, 
	mex™
;

143 
ušt64_t
 
	mev’ts
;

144 
utime_t
 
	mev’t_time
;

145 
utime_t
 
	mtÙ®_time
;

146 
utime_t
 
	mmš_time
, 
	mmax_time
;

149 
³r_¡©e_šfo
(è: 
’‹r
(0), 
ex™
(0), 
ev’ts
(0) {}

151 
	gm­
<cÚ¡ *,
	g³r_¡©e_šfo
> 
	gšfo
;

152 
Mu‹x
 
	glock
;

154 
	gpublic
:

155 
	$PGRecov”ySts
(è: 
	`lock
("PGRecov”Sts::lock"è{
	}
}

157 
	$»£t
() {

158 
Mu‹x
::
Lock”
 
	`l
(
lock
);

159 
šfo
.
	`ş—r
();

160 
	}
}

161 
	$dump
(
o¡»am
& 
out
) {

162 
Mu‹x
::
Lock”
 
	`l
(
lock
);

163 
m­
<cÚ¡ *,
³r_¡©e_šfo
>::
™”©Ü
 
p
 = 
šfo
.
	`begš
();… !ğšfo.
	`’d
(); ++p) {

164 
³r_¡©e_šfo
& 
i
 = 
p
->
£cÚd
;

165 
out
 << 
i
.
’‹r
 << "\t" << i.
ex™
 << "\t"

166 << 
i
.
ev’ts
 << "\t" << i.
ev’t_time
 << "\t"

167 << 
i
.
tÙ®_time
 << "\t"

168 << 
i
.
mš_time
 << "\t" << i.
max_time
 << "\t"

169 << 
p
->
fœ¡
 << "\n";

171 
	}
}

173 
	$dump_fÜm©‹d
(
FÜm©‹r
 *
f
) {

174 
Mu‹x
::
Lock”
 
	`l
(
lock
);

175 
f
->
	`İ’_¬¿y_£ùiÚ
("pg_recovery_stats");

176 
m­
<cÚ¡ *,
³r_¡©e_šfo
>::
™”©Ü
 
p
 = 
šfo
.
	`begš
();

177 
p
 !ğ
šfo
.
	`’d
(); ++p) {

178 
³r_¡©e_šfo
& 
i
 = 
p
->
£cÚd
;

179 
f
->
	`İ’_objeù_£ùiÚ
("recovery_state");

180 
f
->
	`dump_št
("’‹r", 
i
.
’‹r
);

181 
f
->
	`dump_št
("ex™", 
i
.
ex™
);

182 
f
->
	`dump_št
("ev’ts", 
i
.
ev’ts
);

183 
f
->
	`dump_¡»am
("ev’t_time"è<< 
i
.
ev’t_time
;

184 
f
->
	`dump_¡»am
("tÙ®_time"è<< 
i
.
tÙ®_time
;

185 
f
->
	`dump_¡»am
("mš_time"è<< 
i
.
mš_time
;

186 
f
->
	`dump_¡»am
("max_time"è<< 
i
.
max_time
;

187 
veùÜ
<
¡ršg
> 
¡©es
;

188 
	`g‘_¡r_vec
(
p
->
fœ¡
, "/", 
¡©es
);

189 
f
->
	`İ’_¬¿y_£ùiÚ
("nested_states");

190 
veùÜ
<
¡ršg
>::
™”©Ü
 
¡
 = 
¡©es
.
	`begš
();

191 
¡
 !ğ
¡©es
.
	`’d
(); ++st) {

192 
f
->
	`dump_¡ršg
("¡©e", *
¡
);

194 
f
->
	`şo£_£ùiÚ
();

195 
f
->
	`şo£_£ùiÚ
();

197 
f
->
	`şo£_£ùiÚ
();

198 
	}
}

200 
	$log_’‹r
(cÚ¡ *
s
) {

201 
Mu‹x
::
Lock”
 
	`l
(
lock
);

202 
šfo
[
s
].
’‹r
++;

203 
	}
}

204 
	$log_ex™
(cÚ¡ *
s
, 
utime_t
 
dur
, 
ušt64_t
 
ev’ts
, utime_ˆ
ev’t_dur
) {

205 
Mu‹x
::
Lock”
 
	`l
(
lock
);

206 
³r_¡©e_šfo
 &
i
 = 
šfo
[
s
];

207 
i
.
ex™
++;

208 
i
.
tÙ®_time
 +ğ
dur
;

209 ià(
dur
 > 
i
.
max_time
)

210 
i
.
max_time
 = 
dur
;

211 ià(
dur
 < 
i
.
mš_time
 || i.mš_tim=ğ
	`utime_t
())

212 
i
.
mš_time
 = 
dur
;

213 
i
.
ev’ts
 +=ƒvents;

214 
i
.
ev’t_time
 +ğ
ev’t_dur
;

215 
	}
}

218 
	sPGPoŞ
 {

219 
C•hCÚ‹xt
* 
	mcù
;

220 
•och_t
 
	mÿched_•och
;

221 
št64_t
 
	mid
;

222 
¡ršg
 
	mÇme
;

224 
pg_poŞ_t
 
	mšfo
;

225 
SÇpCÚ‹xt
 
	m¢­c
;

228 
	mš‹rv®_£t
<
	m¢­id_t
> 
	mÿched_»moved_¢­s
;

229 
	mš‹rv®_£t
<
	m¢­id_t
> 
	mÃwly_»moved_¢­s
;

231 
PGPoŞ
(
C•hCÚ‹xt
* 
cù
, 
OSDM­Ref
 
m­
, 
št64_t
 
i
, cÚ¡ 
pg_poŞ_t
& 
šfo
,

232 cÚ¡ 
¡ršg
& 
Çme
)

233 : 
cù
(cct),

234 
ÿched_•och
(
m­
->
g‘_•och
()),

235 
id
(
i
),

236 
Çme
(name),

237 
šfo
(info) {

238 
	m¢­c
 = 
šfo
.
g‘_¢­_cÚ‹xt
();

239 ià(
	mm­
->
	m»quœe_osd_»Ëa£
 < 
	mCEPH_RELEASE_MIMIC
) {

240 
	mšfo
.
bud_»moved_¢­s
(
ÿched_»moved_¢­s
);

244 
upd©e
(
C•hCÚ‹xt
 *
cù
, 
OSDM­Ref
 
m­
);

251 şas 
	cPG
 : 
public
 
DoutP»fixProvid”
 {

252 
public
:

254 cÚ¡ 
¥g_t
 
pg_id
;

255 cÚ¡ 
cŞl_t
 
	mcŞl
;

257 
	mObjeùStÜe
::
CŞËùiÚHªdË
 
ch
;

259 
şass
 
	mRecov”yCtx
;

262 
	m¡d
::
o¡»am
& 
	$g’_´efix
(
¡d
::
o¡»am
& 
out
ècÚ¡ 
ov”ride
;

263 
C•hCÚ‹xt
 *
	$g‘_cù
(ècÚ¡ 
ov”ride
 {

264  
cù
;

266 
	$g‘_subsys
(ècÚ¡ 
ov”ride
 {

267  
ûph_subsys_osd
;

268 
	}
}

270 
OSDM­Ref
 
	$g‘_osdm­
() const {

271 
	`as£¹
(
	`is_locked
());

272 
	`as£¹
(
osdm­_»f
);

273  
osdm­_»f
;

274 
	}
}

275 
•och_t
 
	$g‘_osdm­_•och
() const {

276  
osdm­_»f
->
	`g‘_•och
();

277 
	}
}

279 
	$lock_su¥’d_timeout
(
Th»adPoŞ
::
TPHªdË
 &
hªdË
) {

280 
hªdË
.
	`su¥’d__timeout
();

281 
	`lock
();

282 
hªdË
.
	`»£t__timeout
();

283 
	}
}

284 
	$lock
(
boŞ
 
no_lockd•
 = 
çl£
) const;

285 
	$uÆock
() const {

287 
	`as£¹
(!
dœty_šfo
);

288 
	`as£¹
(!
dœty_big_šfo
);

289 
_lock
.
	`UÆock
();

290 
	}
}

291 
boŞ
 
	$is_locked
() const {

292  
_lock
.
	`is_locked
();

293 
	}
}

295 cÚ¡ 
	g¥g_t
& 
	$g‘_pgid
() const {

296  
pg_id
;

297 
	}
}

299 cÚ¡ 
	gPGPoŞ
& 
	$g‘_poŞ
() const {

300  
poŞ
;

301 
	}
}

302 
ušt64_t
 
	$g‘_Ï¡_u£r_v”siÚ
() const {

303  
šfo
.
Ï¡_u£r_v”siÚ
;

304 
	}
}

305 cÚ¡ 
	gpg_hi¡Üy_t
& 
	$g‘_hi¡Üy
() const {

306  
šfo
.
hi¡Üy
;

307 
	}
}

308 
boŞ
 
	$g‘_Ãed_up_thru
() const {

309  
Ãed_up_thru
;

310 
	}
}

311 
•och_t
 
	$g‘_§me_š‹rv®_sšû
() const {

312  
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû
;

313 
	}
}

315 
	$£t_Ï¡_süub_¡amp
(
utime_t
 
t
) {

316 
šfo
.
hi¡Üy
.
Ï¡_süub_¡amp
 = 
t
;

317 
	}
}

319 
boŞ
 
	$is_d–‘šg
() const {

320  
d–‘šg
;

321 
	}
}

322 
boŞ
 
	$is_d–‘ed
() const {

323  
d–‘ed
;

324 
	}
}

325 
boŞ
 
	$is_»¶iÿ
() const {

326  
rŞe
 > 0;

327 
	}
}

328 
boŞ
 
	$is_´im¬y
() const {

329  
pg_whßmi
 =ğ
´im¬y
;

330 
	}
}

331 
boŞ
 
	$pg_has_»£t_sšû
(
•och_t
 
e
) {

332 
	`as£¹
(
	`is_locked
());

333  
d–‘ed
 || 
e
 < 
	`g‘_Ï¡_³”šg_»£t
();

334 
	}
}

336 
boŞ
 
	$is_ec_pg
() const {

337  
poŞ
.
šfo
.
	`is_”asu»
();

338 
	}
}

339 
	$g‘_rŞe
() const {

340  
rŞe
;

341 
	}
}

342 cÚ¡ 
	gveùÜ
<> 
	$g‘_aùšg
() const {

343  
aùšg
;

344 
	}
}

345 
	$g‘_aùšg_´im¬y
() const {

346  
´im¬y
.
osd
;

347 
	}
}

348 
pg_sh¬d_t
 
	$g‘_´im¬y
() const {

349  
´im¬y
;

350 
	}
}

351 cÚ¡ 
	gveùÜ
<> 
	$g‘_up
() const {

352  
up
;

353 
	}
}

354 
	$g‘_up_´im¬y
() const {

355  
up_´im¬y
.
osd
;

356 
	}
}

357 cÚ¡ 
	gPa¡IÁ”v®s
& 
	$g‘_·¡_š‹rv®s
() const {

358  
·¡_š‹rv®s
;

359 
	}
}

362 
š™
(

363 
rŞe
,

364 cÚ¡ 
veùÜ
<>& 
up
,

365 
up_´im¬y
,

366 cÚ¡ 
veùÜ
<>& 
aùšg
,

367 
aùšg_´im¬y
,

368 cÚ¡ 
pg_hi¡Üy_t
& 
hi¡Üy
,

369 cÚ¡ 
Pa¡IÁ”v®s
& 
pim
,

370 
boŞ
 
backfl
,

371 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

374 
»ad_¡©e
(
ObjeùStÜe
 *
¡Üe
);

375 
³ek_m­_•och
(
ObjeùStÜe
 *
¡Üe
, 
¥g_t
 
pgid
, 
•och_t
 *
³poch
);

377 
	$g‘_Ï‹¡_¡ruù_v
() {

378  
Ï‹¡_¡ruù_v
;

379 
	}
}

380 
	$g‘_com·t_¡ruù_v
() {

381  
com·t_¡ruù_v
;

382 
	}
}

383 
»ad_šfo
(

384 
ObjeùStÜe
 *
¡Üe
, 
¥g_t
 
pgid
, cÚ¡ 
cŞl_t
 &
cŞl
,

385 
pg_šfo_t
 &
šfo
, 
Pa¡IÁ”v®s
 &
·¡_š‹rv®s
,

386 
__u8
 &);

387 
boŞ
 
_has_»mov®_æag
(
ObjeùStÜe
 *
¡Üe
, 
¥g_t
 
pgid
);

389 
rm_backoff
(
BackoffRef
 
b
);

391 
	$upd©e_¢­_m­³r_b™s
(
ušt32_t
 
b™s
) {

392 
¢­_m­³r
.
	`upd©e_b™s
(
b™s
);

393 
	}
}

394 
¡¬t_¥l™_¡©s
(cÚ¡ 
£t
<
¥g_t
>& 
chdpgs
, 
veùÜ
<
objeù_¡©_sum_t
> *
v
);

395 
vœtu®
 
¥l™_cŞls
(

396 
¥g_t
 
chd
,

397 
¥l™_b™s
,

398 
£ed
,

399 cÚ¡ 
pg_poŞ_t
 *
poŞ
,

400 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
) = 0;

401 
¥l™_što
(
pg_t
 
chd_pgid
, 
PG
 *
chd
, 
¥l™_b™s
);

402 
fšish_¥l™_¡©s
(cÚ¡ 
objeù_¡©_sum_t
& 
¡©s
, 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

404 
süub
(
•och_t
 
queued
, 
Th»adPoŞ
::
TPHªdË
 &
hªdË
);

405 
»g_Ãxt_süub
();

406 
uÄeg_Ãxt_süub
();

408 
boŞ
 
	$is_fÜûd_»cov”y_Ü_backfl
() const {

409  
	`g‘_¡©e
(è& (
PG_STATE_FORCED_RECOVERY
 | 
PG_STATE_FORCED_BACKFILL
);

410 
	}
}

411 
boŞ
 
£t_fÜû_»cov”y
(boŞ 
b
);

412 
boŞ
 
£t_fÜû_backfl
(boŞ 
b
);

414 
queue_³”šg_ev’t
(
PGP“ršgEv’tRef
 
evt
);

415 
do_³”šg_ev’t
(
PGP“ršgEv’tRef
 
evt
, 
Recov”yCtx
 *
rcx
);

416 
queue_qu”y
(
•och_t
 
msg_•och
,ƒpoch_ˆ
qu”y_•och
,

417 
pg_sh¬d_t
 
äom
, cÚ¡ 
pg_qu”y_t
& 
q
);

418 
queue_nuÎ
(
•och_t
 
msg_•och
,ƒpoch_ˆ
qu”y_•och
);

419 
queue_æushed
(
•och_t
 
¡¬‹d_©
);

420 
hªdË_advªû_m­
(

421 
OSDM­Ref
 
osdm­
, OSDM­Reà
Ï¡m­
,

422 
veùÜ
<>& 
Ãwup
, 
up_´im¬y
,

423 
veùÜ
<>& 
Ãwaùšg
, 
aùšg_´im¬y
,

424 
Recov”yCtx
 *
rùx
);

425 
hªdË_aùiv©e_m­
(
Recov”yCtx
 *
rùx
);

426 
hªdË_š™Ÿlize
(
Recov”yCtx
 *
rùx
);

427 
hªdË_qu”y_¡©e
(
FÜm©‹r
 *
f
);

433 
vœtu®
 
boŞ
 
¡¬t_»cov”y_İs
(

434 
ušt64_t
 
max
,

435 
Th»adPoŞ
::
TPHªdË
 &
hªdË
,

436 
ušt64_t
 *
İs_begun
) = 0;

439 
fšd_unfound
(
•och_t
 
queued
, 
Recov”yCtx
 *
rùx
);

441 
vœtu®
 
g‘_w©ch”s
(
¡d
::
li¡
<
obj_w©ch_™em_t
> *
ls
) = 0;

443 
dump_pg¡©e_hi¡Üy
(
FÜm©‹r
 *
f
);

444 
dump_missšg
(
FÜm©‹r
 *
f
);

446 
g‘_pg_¡©s
(
¡d
::
funùiÚ
<(cÚ¡ 
pg_¡©_t
&, 
•och_t
 
Ëc
)> 
f
);

447 
w™h_h—¹b—t_³”s
(
¡d
::
funùiÚ
<()> 
f
);

449 
shutdown
();

450 
vœtu®
 
Ú_shutdown
() = 0;

452 
boŞ
 
	$g‘_mu¡_süub
() const {

453  
süubb”
.
mu¡_süub
;

454 
	}
}

455 
boŞ
 
sched_süub
();

457 
vœtu®
 
do_»que¡
(

458 
OpReque¡Ref
& 
İ
,

459 
Th»adPoŞ
::
TPHªdË
 &
hªdË


462 
vœtu®
 
¢­_Œimm”
(
•och_t
 
•och_queued
) = 0;

463 
vœtu®
 
do_commªd
(

464 
cmdm­_t
 
cmdm­
,

465 
o¡»am
& 
ss
,

466 
bufã¾i¡
& 
id©a
,

467 
bufã¾i¡
& 
od©a
,

468 
CÚÃùiÚRef
 
cÚn
,

469 
ûph_tid_t
 
tid
) = 0;

471 
vœtu®
 
boŞ
 
ag’t_wÜk
(
max
) = 0;

472 
vœtu®
 
boŞ
 
ag’t_wÜk
(
max
, 
ag’t_æush_quÙa
) = 0;

473 
vœtu®
 
ag’t_¡İ
() = 0;

474 
vœtu®
 
ag’t_d–ay
() = 0;

475 
vœtu®
 
ag’t_ş—r
() = 0;

476 
vœtu®
 
ag’t_choo£_mode_»¡¬t
() = 0;

478 
vœtu®
 
Ú_»mov®
(
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
) = 0;

480 
_d–‘e_some
(
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

483 #ifdeà
PG_DEBUG_REFS


484 
ušt64_t
 
g‘_w™h_id
();

485 
put_w™h_id
(
ušt64_t
);

486 
dump_live_ids
();

488 
g‘
(cÚ¡ * 
g
);

489 
put
(cÚ¡ * 
g
);

490 
	$g‘_num_»f
() {

491  
»f
;

492 
	}
}

495 
PG
(
OSDS”viû
 *
o
, 
OSDM­Ref
 
curm­
,

496 cÚ¡ 
PGPoŞ
 &
poŞ
, 
¥g_t
 
p
);

497 ~
	$PG
(è
ov”ride
;

500 
ex¶ic™
 
	`PG
(cÚ¡ 
PG
& 
rhs
èğ
d–‘e
;

501 
PG
& 
İ”©Ü
=(cÚ¡ PG& 
rhs
èğ
d–‘e
;

503 
´Ùeùed
:

506 
OSDS”viû
 *
osd
;

507 
public
:

508 
OSDSh¬d
 *
osd_sh¬d
 = 
nuÎ±r
;

509 
OSDSh¬dPGSlÙ
 *
pg_¦Ù
 = 
nuÎ±r
;

510 
´Ùeùed
:

511 
C•hCÚ‹xt
 *
cù
;

514 
OSDM­Ref
 
osdm­_»f
;

516 
PGPoŞ
 
poŞ
;

524 
mubË
 
Mu‹x
 
_lock
 = {"PG::_lock"
	}
};

526 
	g¡d
::
©omic
<> 
»f
{0};

528 #ifdeà
PG_DEBUG_REFS


529 
Mu‹x
 
	g_»f_id_lock
 = {"PG::_ref_id_lock"};

530 
	gm­
<
	gušt64_t
, 
	g¡ršg
> 
	g_live_ids
;

531 
	gm­
<
	g¡ršg
, 
	gušt64_t
> 
	g_g_couÁs
;

532 
ušt64_t
 
	g_»f_id
 = 0;

534 
ä›nd
 
ušt64_t
 
	$g‘_w™h_id
(
PG
 *
pg
è{ …g->
	`g‘_w™h_id
(); 
	}
}

535 
ä›nd
 
	$put_w™h_id
(
PG
 *
pg
, 
ušt64_t
 
id
è{ …g->
	`put_w™h_id
(id); 
	}
}

538 
	g´iv©e
:

539 
ä›nd
 
	$šŒusive_±r_add_»f
(
PG
 *
pg
) {

540 
pg
->
	`g‘
("intptr");

541 
	}
}

542 
ä›nd
 
	$šŒusive_±r_»Ëa£
(
PG
 *
pg
) {

543 
pg
->
	`put
("intptr");

544 
	}
}

549 
	g´Ùeùed
:

550 
OSDriv”
 
osdriv”
;

551 
SÇpM­³r
 
	g¢­_m­³r
;

552 
boŞ
 
	geio_”rÜs_to_´oûss
 = 
çl£
;

554 
vœtu®
 
PGBack’d
 *
g‘_pgback’d
() = 0;

555 
vœtu®
 cÚ¡ 
PGBack’d
* 
	$g‘_pgback’d
() const = 0;

557 
´Ùeùed
:

560 
IsPGRecov”abËP»diÿ‹
 *
	$g‘_is_»cov”abË_´ediÿ‹
() const {

561  
	`g‘_pgback’d
()->
	`g‘_is_»cov”abË_´ediÿ‹
();

562 
	}
}

563 
	g´Ùeùed
:

564 
•och_t
 
Ï¡_³rsi¡ed_osdm­
;

566 
»queue_m­_wa™”s
();

568 
	$upd©e_osdm­_»f
(
OSDM­Ref
 
Ãwm­
) {

569 
	`as£¹
(
_lock
.
	`is_locked_by_me
());

570 
osdm­_»f
 = 
¡d
::
	`move
(
Ãwm­
);

571 
	}
}

573 
	g´Ùeùed
:

576 
boŞ
 
d–‘šg
;

577 
	g©omic
<
	gboŞ
> 
	gd–‘ed
 = {
çl£
};

579 
	gZT¿ûr
::
Endpošt
 
Œaû_’dpošt
;

582 
	g´Ùeùed
:

583 
boŞ
 
dœty_šfo
, 
	gdœty_big_šfo
;

585 
	g´Ùeùed
:

587 
pg_šfo_t
 
šfo
;

588 
pg_šfo_t
 
	gÏ¡_wr™‹n_šfo
;

589 
__u8
 
	gšfo_¡ruù_v
 = 0;

590 cÚ¡ 
__u8
 
	gÏ‹¡_¡ruù_v
 = 10;

596 cÚ¡ 
__u8
 
	gcom·t_¡ruù_v
 = 10;

597 
upg¿de
(
ObjeùStÜe
 *
¡Üe
);

599 
	g´Ùeùed
:

600 
PGLog
 
pg_log
;

601 
¡ršg
 
	$g‘_šfo_key
(
¥g_t
 
pgid
) {

602  
	`¡ršgify
(
pgid
) + "_info";

603 
	}
}

604 
¡ršg
 
	$g‘_bigšfo_key
(
¥g_t
 
pgid
) {

605  
	`¡ršgify
(
pgid
) + "_biginfo";

606 
	}
}

607 
¡ršg
 
	$g‘_•och_key
(
¥g_t
 
pgid
) {

608  
	`¡ršgify
(
pgid
) + "_epoch";

609 
	}
}

610 
ghobjeù_t
 
	gpgm‘a_oid
;

615 şas 
	cMissšgLoc
 {

616 
	gpublic
:

619 
	sloc_couÁ_t
 {

620 
up
 = 0;

621 
	gÙh”
 = 0;

623 
ä›nd
 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	gloc_couÁ_t
& 
	gl
,

624 cÚ¡ 
	gloc_couÁ_t
& 
	gr
) {

625  (
	gl
.
	gup
 < 
	gr
.up ||

626 (
	gl
.
	gup
 =ğ
r
.
up
 &&

627 (
l
.
Ùh”
 < 
r
.other)));

629 
ä›nd
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gloc_couÁ_t
& 
	gl
) {

630 
as£¹
(
l
.
up
 >= 0);

631 
as£¹
(
l
.
Ùh”
 >= 0);

632  
	gout
 << "(" << 
	gl
.
	gup
 << "+" <<†.
	gÙh”
 << ")";

637 
	g´iv©e
:

639 
loc_couÁ_t
 
_g‘_couÁ
(cÚ¡ 
£t
<
pg_sh¬d_t
>& 
sh¬ds
) {

640 
loc_couÁ_t
 
r
;

641 autØ
	gs
 : 
sh¬ds
) {

642 ià(
pg
->
up£t
.
couÁ
(
s
)) {

643 
r
.
up
++;

645 
	gr
.
	gÙh”
++;

648  
	gr
;

651 
	gm­
<
	ghobjeù_t
, 
	gpg_missšg_™em
> 
	gÃeds_»cov”y_m­
;

652 
	gm­
<
	ghobjeù_t
, 
	g£t
<
	gpg_sh¬d_t
> > 
	gmissšg_loc
;

653 
	g£t
<
	gpg_sh¬d_t
> 
	gmissšg_loc_sourûs
;

658 
	gm­
 < 
	gsh¬d_id_t
, m­<
	gloc_couÁ_t
,> > 
	gmissšg_by_couÁ
;

660 
pgs_by_sh¬d_id
(cÚ¡ 
£t
<
pg_sh¬d_t
>& 
s
, 
m­
< 
sh¬d_id_t
, s‘<pg_sh¬d_t> >& 
pgsbs
) {

661 ià(
	gpg
->
g‘_osdm­
()->
pg_is_ec
(
pg
->
šfo
.
pgid
.pgid)) {

662 
	gnum_sh¬ds
 = 
pg
->
g‘_osdm­
()->
g‘_pg_size
Õg->
šfo
.
pgid
.pgid);

664 
	gi
 = 0 ; i < 
	gnum_sh¬ds
 ; ++i) {

665 
sh¬d_id_t
 
sh¬d
(
i
);

666 
	gpgsbs
[
sh¬d
];

668 autØ
	gpgs
: 
s
)

669 
pgsbs
[
pgs
.
sh¬d
].
š£¹
(pgs);

671 
	gpgsbs
[
sh¬d_id_t
::
NO_SHARD
] = 
s
;

675 
_šc_couÁ
(cÚ¡ 
£t
<
pg_sh¬d_t
>& 
s
) {

676 
	gm­
< 
	gsh¬d_id_t
, 
	g£t
<
	gpg_sh¬d_t
> > 
	gpgsbs
;

677 
pgs_by_sh¬d_id
(
s
, 
pgsbs
);

678 autØ
	gsh¬d
: 
pgsbs
)

679 ++
missšg_by_couÁ
[
sh¬d
.
fœ¡
][
_g‘_couÁ
(sh¬d.
£cÚd
)];

681 
_dec_couÁ
(cÚ¡ 
£t
<
pg_sh¬d_t
>& 
s
) {

682 
	gm­
< 
	gsh¬d_id_t
, 
	g£t
<
	gpg_sh¬d_t
> > 
	gpgsbs
;

683 
pgs_by_sh¬d_id
(
s
, 
pgsbs
);

684 autØ
	gsh¬d
: 
pgsbs
) {

685 autØ
p
 = 
missšg_by_couÁ
[
sh¬d
.
fœ¡
].
fšd
(
_g‘_couÁ
(sh¬d.
£cÚd
));

686 
as£¹
(
p
 !ğ
missšg_by_couÁ
[
sh¬d
.
fœ¡
].
’d
());

687 ià(--
	gp
->
	g£cÚd
 == 0) {

688 
missšg_by_couÁ
[
sh¬d
.
fœ¡
].
”a£
(
p
);

693 
PG
 *
	gpg
;

694 
	g£t
<
	gpg_sh¬d_t
> 
	gem±y_£t
;

695 
	gpublic
:

696 
boo¡
::
scİed_±r
<
IsPGR—dabËP»diÿ‹
> 
is_»adabË
;

697 
	gboo¡
::
scİed_±r
<
IsPGRecov”abËP»diÿ‹
> 
is_»cov”abË
;

698 
ex¶ic™
 
MissšgLoc
(
PG
 *
pg
)

699 : 
pg
(pg) { }

700 
£t_back’d_´ediÿ‹s
(

701 
IsPGR—dabËP»diÿ‹
 *
_is_»adabË
,

702 
IsPGRecov”abËP»diÿ‹
 *
_is_»cov”abË
) {

703 
	gis_»adabË
.
»£t
(
_is_»adabË
);

704 
	gis_»cov”abË
.
»£t
(
_is_»cov”abË
);

706 
	g¡d
::
o¡»am
& 
g’_´efix
(
¡d
::o¡»am& 
out
) const {

707  
pg
->
g’_´efix
(
out
);

709 
boŞ
 
Ãeds_»cov”y
(

710 cÚ¡ 
hobjeù_t
 &
hoid
,

711 
ev”siÚ_t
 *
v
 = 0) const {

712 
m­
<
hobjeù_t
, 
pg_missšg_™em
>::
cÚ¡_™”©Ü
 
i
 =

713 
Ãeds_»cov”y_m­
.
fšd
(
hoid
);

714 ià(
	gi
 =ğ
Ãeds_»cov”y_m­
.
’d
())

715  
çl£
;

716 ià(
	gv
)

717 *
	gv
 = 
i
->
£cÚd
.
Ãed
;

718  
	gŒue
;

720 
boŞ
 
is_d–‘ed
(cÚ¡ 
hobjeù_t
 &
hoid
) const {

721 autØ
	gi
 = 
Ãeds_»cov”y_m­
.
fšd
(
hoid
);

722 ià(
	gi
 =ğ
Ãeds_»cov”y_m­
.
’d
())

723  
çl£
;

724  
	gi
->
	g£cÚd
.
is_d–‘e
();

726 
boŞ
 
is_unfound
(cÚ¡ 
hobjeù_t
 &
hoid
) const {

727 autØ
	g™
 = 
Ãeds_»cov”y_m­
.
fšd
(
hoid
);

728 ià(
	g™
 =ğ
Ãeds_»cov”y_m­
.
’d
()) {

729  
çl£
;

731 ià(
	g™
->
	g£cÚd
.
is_d–‘e
()) {

732  
	gçl£
;

734 autØ
	gm™
 = 
missšg_loc
.
fšd
(
hoid
);

735  
	gm™
 =ğ
missšg_loc
.
’d
(è|| !(*
is_»cov”abË
)(
m™
->
£cÚd
);

737 
boŞ
 
»adabË_w™h_aùšg
(

738 cÚ¡ 
hobjeù_t
 &
hoid
,

739 cÚ¡ 
£t
<
pg_sh¬d_t
> &
aùšg
) const;

740 
ušt64_t
 
num_unfound
() const {

741 
ušt64_t
 
	g»t
 = 0;

742 
	gm­
<
	ghobjeù_t
, 
	gpg_missšg_™em
>::
cÚ¡_™”©Ü
 
i
 =

743 
Ãeds_»cov”y_m­
.
begš
();

744 
	gi
 !ğ
Ãeds_»cov”y_m­
.
’d
();

745 ++
	gi
) {

746 ià(
	gi
->
	g£cÚd
.
is_d–‘e
())

748 autØ
	gmi
 = 
missšg_loc
.
fšd
(
i
->
fœ¡
);

749 ià(
	gmi
 =ğ
missšg_loc
.
’d
(è|| !(*
is_»cov”abË
)(
mi
->
£cÚd
))

750 ++
»t
;

752  
	g»t
;

755 
boŞ
 
have_unfound
() const {

756 
	gm­
<
	ghobjeù_t
, 
	gpg_missšg_™em
>::
cÚ¡_™”©Ü
 
i
 =

757 
Ãeds_»cov”y_m­
.
begš
();

758 
	gi
 !ğ
Ãeds_»cov”y_m­
.
’d
();

759 ++
	gi
) {

760 ià(
	gi
->
	g£cÚd
.
is_d–‘e
())

762 autØ
	gmi
 = 
missšg_loc
.
fšd
(
i
->
fœ¡
);

763 ià(
	gmi
 =ğ
missšg_loc
.
’d
(è|| !(*
is_»cov”abË
)(
mi
->
£cÚd
))

764  
Œue
;

766  
	gçl£
;

768 
ş—r
() {

769 
	gÃeds_»cov”y_m­
.
ş—r
();

770 
	gmissšg_loc
.
ş—r
();

771 
	gmissšg_loc_sourûs
.
ş—r
();

772 
	gmissšg_by_couÁ
.
ş—r
();

775 
add_loÿtiÚ
(cÚ¡ 
hobjeù_t
 &
hoid
, 
pg_sh¬d_t
 
loÿtiÚ
) {

776 autØ
	gp
 = 
missšg_loc
.
fšd
(
hoid
);

777 ià(
	gp
 =ğ
missšg_loc
.
’d
()) {

778 
p
 = 
missšg_loc
.
em¶aû
(
hoid
, 
£t
<
pg_sh¬d_t
>()).
	gfœ¡
;

780 
_dec_couÁ
(
p
->
£cÚd
);

782 
	gp
->
	g£cÚd
.
š£¹
(
loÿtiÚ
);

783 
_šc_couÁ
(
p
->
£cÚd
);

785 
»move_loÿtiÚ
(cÚ¡ 
hobjeù_t
 &
hoid
, 
pg_sh¬d_t
 
loÿtiÚ
) {

786 autØ
	gp
 = 
missšg_loc
.
fšd
(
hoid
);

787 ià(
	gp
 !ğ
missšg_loc
.
’d
()) {

788 
_dec_couÁ
(
p
->
£cÚd
);

789 
	gp
->
	g£cÚd
.
”a£
(
loÿtiÚ
);

790 
_šc_couÁ
(
p
->
£cÚd
);

794 
ş—r_loÿtiÚ
(cÚ¡ 
hobjeù_t
 &
hoid
) {

795 autØ
	gp
 = 
missšg_loc
.
fšd
(
hoid
);

796 ià(
	gp
 !ğ
missšg_loc
.
’d
()) {

797 
_dec_couÁ
(
p
->
£cÚd
);

798 
	gmissšg_loc
.
”a£
(
p
);

802 
add_aùive_missšg
(cÚ¡ 
pg_missšg_t
 &
missšg
) {

803 
	gm­
<
	ghobjeù_t
, 
	gpg_missšg_™em
>::
cÚ¡_™”©Ü
 
i
 =

804 
missšg
.
g‘_™ems
().
begš
();

805 
	gi
 !ğ
missšg
.
g‘_™ems
().
’d
();

806 ++
	gi
) {

807 
	gm­
<
	ghobjeù_t
, 
	gpg_missšg_™em
>::
cÚ¡_™”©Ü
 
j
 =

808 
Ãeds_»cov”y_m­
.
fšd
(
i
->
fœ¡
);

809 ià(
	gj
 =ğ
Ãeds_»cov”y_m­
.
’d
()) {

810 
Ãeds_»cov”y_m­
.
š£¹
(*
i
);

812 
lg’”ic_dout
(
pg
->
cù
, 0è<< 
	gthis
 << " " << 
	gpg
->
	gšfo
.
	gpgid
 << " unexpected‚eed for "

813 << 
	gi
->
	gfœ¡
 << " hav" << 
	gj
->
	g£cÚd


814 << "r›dØadd " << 
	gi
->
	g£cÚd
 << 
	gd’dl
;

815 
as£¹
(
i
->
£cÚd
.
Ãed
 =ğ
j
->second.need);

820 
add_missšg
(cÚ¡ 
hobjeù_t
 &
hoid
, 
ev”siÚ_t
 
Ãed
,ƒv”siÚ_ˆ
have
, 
boŞ
 
is_d–‘e
=
çl£
) {

821 
Ãeds_»cov”y_m­
[
hoid
] = 
pg_missšg_™em
(
Ãed
, 
have
, 
is_d–‘e
);

823 
»vi£_Ãed
(cÚ¡ 
hobjeù_t
 &
hoid
, 
ev”siÚ_t
 
Ãed
) {

824 autØ
	g™
 = 
Ãeds_»cov”y_m­
.
fšd
(
hoid
);

825 
as£¹
(
™
 !ğ
Ãeds_»cov”y_m­
.
’d
());

826 
	g™
->
	g£cÚd
.
	gÃed
 = 
Ãed
;

830 
boŞ
 
add_sourû_šfo
(

831 
pg_sh¬d_t
 
sourû
,

832 cÚ¡ 
pg_šfo_t
 &
ošfo
,

833 cÚ¡ 
pg_missšg_t
 &
omissšg
,

834 
Th»adPoŞ
::
TPHªdË
* 
hªdË


838 
add_b©ch_sourûs_šfo
(

839 cÚ¡ 
£t
<
pg_sh¬d_t
> &
sourûs
,

840 
Th»adPoŞ
::
TPHªdË
* 
hªdË


844 
check_»cov”y_sourûs
(cÚ¡ 
OSDM­Ref
& 
osdm­
);

847 
»cov”ed
(cÚ¡ 
hobjeù_t
 &
hoid
) {

848 
	gÃeds_»cov”y_m­
.
”a£
(
hoid
);

849 autØ
	gp
 = 
missšg_loc
.
fšd
(
hoid
);

850 ià(
	gp
 !ğ
missšg_loc
.
’d
()) {

851 
_dec_couÁ
(
p
->
£cÚd
);

852 
	gmissšg_loc
.
”a£
(
p
);

857 
»bud
(

858 cÚ¡ 
hobjeù_t
 &
hoid
,

859 
pg_sh¬d_t
 
£lf
,

860 cÚ¡ 
£t
<
pg_sh¬d_t
> 
to_»cov”
,

861 cÚ¡ 
pg_šfo_t
 &
šfo
,

862 cÚ¡ 
pg_missšg_t
 &
missšg
,

863 cÚ¡ 
m­
<
pg_sh¬d_t
, 
pg_missšg_t
> &
pmissšg
,

864 cÚ¡ 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
> &
pšfo
) {

865 
»cov”ed
(
hoid
);

866 
	gboo¡
::
İtiÚ®
<
pg_missšg_™em
> 
™em
;

867 autØ
	gm™”
 = 
missšg
.
g‘_™ems
().
fšd
(
hoid
);

868 ià(
	gm™”
 !ğ
missšg
.
g‘_™ems
().
’d
()) {

869 
™em
 = 
m™”
->
£cÚd
;

871 autØ&&
	gi
: 
to_»cov”
) {

872 ià(
i
 =ğ
£lf
)

874 autØ
	gpm™”
 = 
pmissšg
.
fšd
(
i
);

875 
as£¹
(
pm™”
 !ğ
pmissšg
.
’d
());

876 
	gm™”
 = 
pm™”
->
£cÚd
.
g‘_™ems
().
fšd
(
hoid
);

877 ià(
	gm™”
 !ğ
pm™”
->
£cÚd
.
g‘_™ems
().
’d
()) {

878 
™em
 = 
m™”
->
£cÚd
;

883 ià(!
	g™em
)

886 
	gÃeds_»cov”y_m­
[
hoid
] = *
™em
;

887 ià(
	g™em
->
is_d–‘e
())

889 autØ
	gml™”
 =

890 
missšg_loc
.
š£¹
(
make_·œ
(
hoid
, 
£t
<
pg_sh¬d_t
>())).
	gfœ¡
;

891 
as£¹
(
šfo
.
Ï¡_backfl
.
is_max
());

892 
as£¹
(
šfo
.
Ï¡_upd©e
 >ğ
™em
->
Ãed
);

893 ià(!
	gmissšg
.
is_missšg
(
hoid
))

894 
	gml™”
->
	g£cÚd
.
š£¹
(
£lf
);

895 autØ&&
	gi
: 
pmissšg
) {

896 ià(
i
.
fœ¡
 =ğ
£lf
)

898 autØ
	gpšfo™”
 = 
pšfo
.
fšd
(
i
.
fœ¡
);

899 
as£¹
(
pšfo™”
 !ğ
pšfo
.
’d
());

900 ià(
	g™em
->
	gÃed
 <ğ
pšfo™”
->
£cÚd
.
Ï¡_upd©e
 &&

901 
hoid
 <ğ
pšfo™”
->
£cÚd
.
Ï¡_backfl
 &&

902 !
i
.
£cÚd
.
is_missšg
(
hoid
))

903 
ml™”
->
£cÚd
.
š£¹
(
i
.
fœ¡
);

905 
_šc_couÁ
(
ml™”
->
£cÚd
);

908 cÚ¡ 
	g£t
<
	gpg_sh¬d_t
> &
g‘_loÿtiÚs
(cÚ¡ 
hobjeù_t
 &
hoid
) const {

909 autØ
	g™
 = 
missšg_loc
.
fšd
(
hoid
);

910  
	g™
 =ğ
missšg_loc
.
’d
(è? 
em±y_£t
 : 
™
->
£cÚd
;

912 cÚ¡ 
	gm­
<
	ghobjeù_t
, 
	g£t
<
	gpg_sh¬d_t
>> &
g‘_missšg_locs
() const {

913  
	gmissšg_loc
;

915 cÚ¡ 
	gm­
<
	ghobjeù_t
, 
	gpg_missšg_™em
> &
g‘_Ãeds_»cov”y
() const {

916  
	gÃeds_»cov”y_m­
;

918 cÚ¡ 
	gm­
 < 
	gsh¬d_id_t
, m­<
	gloc_couÁ_t
,> > &
g‘_missšg_by_couÁ
() const {

919  
	gmissšg_by_couÁ
;

921 } 
	gmissšg_loc
;

923 
Pa¡IÁ”v®s
 
	g·¡_š‹rv®s
;

925 
	gš‹rv®_£t
<
	g¢­id_t
> 
	g¢­_Œimq
;

929 
	gxli¡
<
	gPG
*>::
™em
 
¡©_queue_™em
;

930 
boŞ
 
	gsüub_queued
;

931 
boŞ
 
	g»cov”y_queued
;

933 
	g»cov”y_İs_aùive
;

934 
	g£t
<
	gpg_sh¬d_t
> 
	gwa™šg_Ú_backfl
;

935 #ifdeà
DEBUG_RECOVERY_OIDS


936 
	gmuÉi£t
<
	ghobjeù_t
> 
	g»cov”šg_oids
;

939 
	g´Ùeùed
:

940 
rŞe
;

941 
ušt64_t
 
	g¡©e
;

943 
boŞ
 
	g£nd_nÙify
;

945 
	g´Ùeùed
:

946 
ev”siÚ_t
 
Ï¡_upd©e_Údisk
;

947 
ev”siÚ_t
 
	gÏ¡_com¶‘e_Údisk
;

948 
ev”siÚ_t
 
	gÏ¡_upd©e_­¶›d
;

951 
ev”siÚ_t
 
	gÏ¡_rŞlback_šfo_Œimmed_to_­¶›d
;

954 
	g´Ùeùed
:

955 
pg_sh¬d_t
 
´im¬y
;

956 
pg_sh¬d_t
 
	gpg_whßmi
;

957 
pg_sh¬d_t
 
	gup_´im¬y
;

958 
	gveùÜ
<> 
	gup
, 
	gaùšg
, 
	gwªt_aùšg
;

961 
	g£t
<
	gpg_sh¬d_t
> 
	gaùšg_»cov”y_backfl
, 
	gaùšg£t
, 
	gup£t
;

962 
	gm­
<
	gpg_sh¬d_t
,
	gev”siÚ_t
> 
	g³”_Ï¡_com¶‘e_Údisk
;

963 
ev”siÚ_t
 
	gmš_Ï¡_com¶‘e_Údisk
;

964 
ev”siÚ_t
 
	gpg_Œim_to
;

966 
	g£t
<> 
	gblocked_by
;

968 
	g´Ùeùed
:

970 
	sBufã»dRecov”yMes§ges
 {

971 
m­
<, 
	gm­
<
	g¥g_t
, 
	gpg_qu”y_t
> > 
	gqu”y_m­
;

972 
	gm­
<, 
	gveùÜ
<
	g·œ
<
	gpg_nÙify_t
, 
	gPa¡IÁ”v®s
> > > 
	gšfo_m­
;

973 
	gm­
<, 
	gveùÜ
<
	g·œ
<
	gpg_nÙify_t
, 
	gPa¡IÁ”v®s
> > > 
	gnÙify_li¡
;

976 
	gpublic
:

977 
boŞ
 
	$dÃ
(è{  
šfo
.
	`dÃ
(); 
	}
}

978 
	sRecov”yCtx
 {

979 
utime_t
 
	g¡¬t_time
;

980 
	gm­
<, m­<
	g¥g_t
, 
	gpg_qu”y_t
> > *
	gqu”y_m­
;

981 
	gm­
<, 
	gveùÜ
<
	g·œ
<
	gpg_nÙify_t
, 
	gPa¡IÁ”v®s
> > > *
	gšfo_m­
;

982 
	gm­
<, 
	gveùÜ
<
	g·œ
<
	gpg_nÙify_t
, 
	gPa¡IÁ”v®s
> > > *
	gnÙify_li¡
;

983 
	gObjeùStÜe
::
T¿n§ùiÚ
 *
Œª§ùiÚ
;

984 
	gTh»adPoŞ
::
TPHªdË
* 
hªdË
;

985 
Recov”yCtx
(
m­
<, m­<
¥g_t
, 
pg_qu”y_t
> > *
qu”y_m­
,

986 
m­
<,

987 
veùÜ
<
·œ
<
pg_nÙify_t
, 
Pa¡IÁ”v®s
> > > *
šfo_m­
,

988 
m­
<,

989 
veùÜ
<
·œ
<
pg_nÙify_t
, 
Pa¡IÁ”v®s
> > > *
nÙify_li¡
,

990 
ObjeùStÜe
::
T¿n§ùiÚ
 *
Œª§ùiÚ
)

991 : 
qu”y_m­
(qu”y_m­), 
šfo_m­
(info_map),

992 
nÙify_li¡
(notify_list),

993 
Œª§ùiÚ
(transaction),

994 
hªdË
(
NULL
) {}

996 
Recov”yCtx
(
Bufã»dRecov”yMes§ges
 &
buf
, Recov”yCtx &
rùx
)

997 : 
qu”y_m­
(&(
buf
.query_map)),

998 
šfo_m­
(&(
buf
.info_map)),

999 
nÙify_li¡
(&(
buf
.notify_list)),

1000 
Œª§ùiÚ
(
rùx
.transaction),

1001 
hªdË
(
rùx
.handle) {}

1003 
acû±_bufã»d_mes§ges
(
Bufã»dRecov”yMes§ges
 &
m
) {

1004 
as£¹
(
qu”y_m­
);

1005 
as£¹
(
šfo_m­
);

1006 
as£¹
(
nÙify_li¡
);

1007 
	gm­
<, m­<
	g¥g_t
, 
	gpg_qu”y_t
> >::
™”©Ü
 
i
 = 
m
.
qu”y_m­
.
begš
();

1008 
	gi
 !ğ
m
.
qu”y_m­
.
’d
();

1009 ++
	gi
) {

1010 
	gm­
<
	g¥g_t
, 
	gpg_qu”y_t
> &
	gom­
 = (*
qu”y_m­
)[
i
->
fœ¡
];

1011 
	gm­
<
	g¥g_t
, 
	gpg_qu”y_t
>::
™”©Ü
 
j
 = 
i
->
£cÚd
.
begš
();

1012 
	gj
 !ğ
i
->
£cÚd
.
’d
();

1013 ++
	gj
) {

1014 
	gom­
[
j
->
fœ¡
] = j->
£cÚd
;

1017 
	gm­
<, 
	gveùÜ
<
	g·œ
<
	gpg_nÙify_t
, 
	gPa¡IÁ”v®s
> > >::
™”©Ü
 
i


1018 ğ
m
.
šfo_m­
.
begš
();

1019 
	gi
 !ğ
m
.
šfo_m­
.
’d
();

1020 ++
	gi
) {

1021 
	gveùÜ
<
	g·œ
<
	gpg_nÙify_t
, 
	gPa¡IÁ”v®s
> > &
	govec
 =

1022 (*
šfo_m­
)[
i
->
fœ¡
];

1023 
	govec
.
»£rve
(
ovec
.
size
(è+ 
i
->
£cÚd
.size());

1024 
	govec
.
š£¹
(
ovec
.
’d
(), 
i
->
£cÚd
.
begš
(), i->second.end());

1026 
	gm­
<, 
	gveùÜ
<
	g·œ
<
	gpg_nÙify_t
, 
	gPa¡IÁ”v®s
> > >::
™”©Ü
 
i


1027 ğ
m
.
nÙify_li¡
.
begš
();

1028 
	gi
 !ğ
m
.
nÙify_li¡
.
’d
();

1029 ++
	gi
) {

1030 
	gveùÜ
<
	g·œ
<
	gpg_nÙify_t
, 
	gPa¡IÁ”v®s
> > &
	govec
 =

1031 (*
nÙify_li¡
)[
i
->
fœ¡
];

1032 
	govec
.
»£rve
(
ovec
.
size
(è+ 
i
->
£cÚd
.size());

1033 
	govec
.
š£¹
(
ovec
.
’d
(), 
i
->
£cÚd
.
begš
(), i->second.end());

1037 
	g´Ùeùed
:

1039 
PGS‹Hi¡Üy
 
pg¡©e_hi¡Üy
;

1041 
	sNamedS‹
 {

1042 cÚ¡ *
	g¡©e_Çme
;

1043 
utime_t
 
	g’‹r_time
;

1044 
PG
* 
	gpg
;

1045 cÚ¡ *
g‘_¡©e_Çme
(è{  
	g¡©e_Çme
; }

1046 
NamedS‹
(
PG
 *
pg_
, cÚ¡ *
¡©e_Çme_
)

1047 : 
¡©e_Çme
(
¡©e_Çme_
), 
’‹r_time
(
ûph_şock_now
()), 
pg
(
pg_
) {

1048 
	gpg
->
	gpg¡©e_hi¡Üy
.
’‹r
(
pg
, 
’‹r_time
, 
¡©e_Çme
);

1050 
	gvœtu®
 ~
NamedS‹
(è{ 
	gpg
->
	gpg¡©e_hi¡Üy
.
ex™
(
¡©e_Çme
); }

1055 
	g´Ùeùed
:

1062 
boŞ
 
Ãed_up_thru
;

1063 
	g£t
<
	gpg_sh¬d_t
> 
	g¡¿y_£t
;

1064 
	gm­
<
	gpg_sh¬d_t
, 
	gpg_šfo_t
> 
	g³”_šfo
;

1065 
	g£t
<
	gpg_sh¬d_t
> 
	g³”_purged
;

1066 
	gm­
<
	gpg_sh¬d_t
, 
	gpg_missšg_t
> 
	g³”_missšg
;

1067 
	g£t
<
	gpg_sh¬d_t
> 
	g³”_log_»que¡ed
;

1068 
	g£t
<
	gpg_sh¬d_t
> 
	g³”_missšg_»que¡ed
;

1071 
	g£t
<
	gpg_sh¬d_t
> 
	g³”_aùiv©ed
;

1074 
	g£t
<
	gpg_sh¬d_t
> 
	gmight_have_unfound
;

1076 
•och_t
 
	gÏ¡_³”šg_»£t
;

1078 
•och_t
 
	$g‘_Ï¡_³”šg_»£t
() const {

1079  
Ï¡_³”šg_»£t
;

1080 
	}
}

1083 
£t_´obe_rg‘s
(cÚ¡ 
£t
<
pg_sh¬d_t
> &
´obe_£t
);

1084 
ş—r_´obe_rg‘s
();

1086 
Mu‹x
 
	gh—¹b—t_³”_lock
;

1087 
	g£t
<> 
	gh—¹b—t_³”s
;

1088 
	g£t
<> 
	g´obe_rg‘s
;

1090 
	gpublic
:

1100 
	sBackflIÁ”v®
 {

1102 
ev”siÚ_t
 
v”siÚ
;

1103 
	gm­
<
	ghobjeù_t
,
	gev”siÚ_t
> 
	gobjeùs
;

1104 
hobjeù_t
 
	gbegš
;

1105 
hobjeù_t
 
	g’d
;

1108 
ş—r
() {

1109 *
	gthis
 = 
BackflIÁ”v®
();

1113 
ş—r_objeùs
() {

1114 
	gobjeùs
.
ş—r
();

1118 
»£t
(
hobjeù_t
 
¡¬t
) {

1119 
ş—r
();

1120 
	gbegš
 = 
’d
 = 
¡¬t
;

1124 
boŞ
 
em±y
() const {

1125  
	gobjeùs
.
em±y
();

1129 
boŞ
 
ex‹nds_to_’d
() const {

1130  
	g’d
.
is_max
();

1134 
Œim_to
(cÚ¡ 
hobjeù_t
 &
soid
) {

1135 
Œim
();

1136 !
	gobjeùs
.
em±y
() &&

1137 
	gobjeùs
.
begš
()->
	gfœ¡
 <ğ
soid
) {

1138 
pİ_äÚt
();

1143 
Œim
() {

1144 ià(!
	gobjeùs
.
em±y
())

1145 
	gbegš
 = 
objeùs
.
begš
()->
fœ¡
;

1147 
	gbegš
 = 
’d
;

1151 
pİ_äÚt
() {

1152 
as£¹
(!
objeùs
.
em±y
());

1153 
	gobjeùs
.
”a£
(
objeùs
.
begš
());

1154 
Œim
();

1158 
dump
(
FÜm©‹r
 *
f
) const {

1159 
	gf
->
dump_¡»am
("begš"è<< 
	gbegš
;

1160 
	gf
->
dump_¡»am
("’d"è<< 
	g’d
;

1161 
	gf
->
İ’_¬¿y_£ùiÚ
("objects");

1162 
	gm­
<
	ghobjeù_t
, 
	gev”siÚ_t
>::
cÚ¡_™”©Ü
 
i
 =

1163 
objeùs
.
begš
();

1164 
	gi
 !ğ
objeùs
.
’d
();

1165 ++
	gi
) {

1166 
	gf
->
İ’_objeù_£ùiÚ
("object");

1167 
	gf
->
dump_¡»am
("objeù"è<< 
	gi
->
	gfœ¡
;

1168 
	gf
->
dump_¡»am
("v”siÚ"è<< 
	gi
->
	g£cÚd
;

1169 
	gf
->
şo£_£ùiÚ
();

1171 
	gf
->
şo£_£ùiÚ
();

1175 
	g´Ùeùed
:

1176 
BackflIÁ”v®
 
backfl_šfo
;

1177 
	gm­
<
	gpg_sh¬d_t
, 
	gBackflIÁ”v®
> 
	g³”_backfl_šfo
;

1178 
boŞ
 
	gbackfl_»£rved
;

1179 
boŞ
 
	gbackfl_»£rvšg
;

1181 
	g£t
<
	gpg_sh¬d_t
> 
	gbackfl_rg‘s
, 
	gasync_»cov”y_rg‘s
;

1183 
boŞ
 
	$is_backfl_rg‘s
(
pg_sh¬d_t
 
osd
) {

1184  
backfl_rg‘s
.
	`couÁ
(
osd
);

1185 
	}
}

1187 
	g´Ùeùed
:

1244 
æushes_š_´og»ss
;

1249 
	gunÜd”ed_m­
<
	g’t™y_Çme_t
,
	gli¡
<
	gOpReque¡Ref
>> 
	gwa™šg_fÜ_m­
;

1252 
	gli¡
<
	gOpReque¡Ref
> 
	gwa™šg_fÜ_³”ed
;

1255 
	gli¡
<
	gOpReque¡Ref
> 
	gwa™šg_fÜ_aùive
;

1256 
	gli¡
<
	gOpReque¡Ref
> 
	gwa™šg_fÜ_æush
;

1257 
	gli¡
<
	gOpReque¡Ref
> 
	gwa™šg_fÜ_süub
;

1259 
	gli¡
<
	gOpReque¡Ref
> 
	gwa™šg_fÜ_ÿche_nÙ_fuÎ
;

1260 
	gli¡
<
	gOpReque¡Ref
> 
	gwa™šg_fÜ_ş—n_to_´im¬y_»·œ
;

1261 
	gm­
<
	ghobjeù_t
, 
	gli¡
<
	gOpReque¡Ref
>> 
	gwa™šg_fÜ_uÄ—dabË_objeù
,

1262 
	gwa™šg_fÜ_deg¿ded_objeù
,

1263 
	gwa™šg_fÜ_blocked_objeù
;

1265 
	g£t
<
	ghobjeù_t
> 
	gobjeùs_blocked_Ú_ÿche_fuÎ
;

1266 
	gm­
<
	ghobjeù_t
,
	g¢­id_t
> 
	gobjeùs_blocked_Ú_deg¿ded_¢­
;

1267 
	gm­
<
	ghobjeù_t
,
	gObjeùCÚ‹xtRef
> 
	gobjeùs_blocked_Ú_¢­_´omÙiÚ
;

1270 
	gm­
<
	ghobjeù_t
, 
	gli¡
<
	gCÚ‹xt
*>> 
	gÿÎbacks_fÜ_deg¿ded_objeù
;

1272 
	gm­
<
	gev”siÚ_t
,

1273 
	gli¡
<
	g·œ
<
	gOpReque¡Ref
, 
	gv”siÚ_t
> > > 
	gwa™šg_fÜ_Údisk
;

1275 
»queue_objeù_wa™”s
(
m­
<
hobjeù_t
, 
li¡
<
OpReque¡Ref
>>& 
m
);

1276 
»queue_İ
(
OpReque¡Ref
 
İ
);

1277 
»queue_İs
(
li¡
<
OpReque¡Ref
> &
l
);

1280 
objeù_¡©_cŞËùiÚ_t
 
	gun¡abË_¡©s
;

1283 
Mu‹x
 
	gpg_¡©s_publish_lock
;

1284 
boŞ
 
	gpg_¡©s_publish_v®id
;

1285 
pg_¡©_t
 
	gpg_¡©s_publish
;

1287 
_upd©e_ÿlc_¡©s
();

1288 
_upd©e_blocked_by
();

1289 
publish_¡©s_to_osd
();

1290 
ş—r_publish_¡©s
();

1292 
ş—r_´im¬y_¡©e
();

1294 
boŞ
 
	$is_aùšg_»cov”y_backfl
(
pg_sh¬d_t
 
osd
) const {

1295  
aùšg_»cov”y_backfl
.
	`couÁ
(
osd
);

1296 
	}
}

1297 
boŞ
 
	$is_aùšg
(
pg_sh¬d_t
 
osd
) const {

1298  
	`has_sh¬d
(
poŞ
.
šfo
.
	`is_”asu»
(), 
aùšg
, 
osd
);

1299 
	}
}

1300 
boŞ
 
	$is_up
(
pg_sh¬d_t
 
osd
) const {

1301  
	`has_sh¬d
(
poŞ
.
šfo
.
	`is_”asu»
(), 
up
, 
osd
);

1302 
	}
}

1303 
boŞ
 
has_sh¬d
(boŞ 
ec
, cÚ¡ 
veùÜ
<>& 
v
, 
pg_sh¬d_t
 
osd
) {

1304 ià(
	gec
) {

1305  
	gv
.
size
(è> ()
	gosd
.
	gsh¬d
 && v[
osd
.
sh¬d
] == osd.osd;

1307  
	g¡d
::
fšd
(
v
.
begš
(), v.
’d
(), 
osd
.osd) != v.end();

1311 
boŞ
 
	$Ãeds_»cov”y
() const;

1312 
boŞ
 
	$Ãeds_backfl
() const;

1315 
šlše
 
	`şamp_»cov”y_´iÜ™y
(
´iÜ™y
);

1317 
	`g‘_»cov”y_´iÜ™y
();

1319 
	`g‘_backfl_´iÜ™y
();

1321 
	`g‘_d–‘e_´iÜ™y
();

1323 
	`m¬k_ş—n
();

1326 
·œ
<
•och_t
,ƒpoch_t> 
	$g‘_»quœed_·¡_š‹rv®_bounds
(

1327 cÚ¡ 
pg_šfo_t
 &
šfo
,

1328 
•och_t
 
Şde¡_m­
) {

1329 
•och_t
 
¡¬t
 = 
¡d
::
	`max
(

1330 
šfo
.
hi¡Üy
.
Ï¡_•och_ş—n
 ? info.history.last_epoch_clean :

1331 
šfo
.
hi¡Üy
.
•och_poŞ_ü—‹d
,

1332 
Şde¡_m­
);

1333 
•och_t
 
’d
 = 
¡d
::
	`max
(

1334 
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû
,

1335 
šfo
.
hi¡Üy
.
•och_poŞ_ü—‹d
);

1336  
	`make_·œ
(
¡¬t
, 
’d
);

1337 
	}
}

1338 
	$check_·¡_š‹rv®_bounds
() const;

1339 
Pa¡IÁ”v®s
::
PriÜS‘
 
	`bud_´iÜ
();

1341 
	`»move_down_³”_šfo
(cÚ¡ 
OSDM­Ref
 
osdm­
);

1343 
boŞ
 
	`adju¡_Ãed_up_thru
(cÚ¡ 
OSDM­Ref
 
osdm­
);

1345 
boŞ
 
	$®l_unfound_¬e_qu”›d_Ü_lo¡
(cÚ¡ 
OSDM­Ref
 
osdm­
) const;

1346 
vœtu®
 
	$dump_»cov”y_šfo
(
FÜm©‹r
 *
f
) const = 0;

1348 
boŞ
 
	$ÿlc_mš_Ï¡_com¶‘e_Údisk
() {

1349 
ev”siÚ_t
 
mš
 = 
Ï¡_com¶‘e_Údisk
;

1350 
	`as£¹
(!
aùšg_»cov”y_backfl
.
	`em±y
());

1351 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
aùšg_»cov”y_backfl
.
	`begš
();

1352 
i
 !ğ
aùšg_»cov”y_backfl
.
	`’d
();

1353 ++
i
) {

1354 ià(*
i
 =ğ
	`g‘_´im¬y
()) ;

1355 ià(
³”_Ï¡_com¶‘e_Údisk
.
	`couÁ
(*
i
) == 0)

1356  
çl£
;

1357 
ev”siÚ_t
 
a
 = 
³”_Ï¡_com¶‘e_Údisk
[*
i
];

1358 ià(
a
 < 
mš
)

1359 
mš
 = 
a
;

1361 ià(
mš
 =ğ
mš_Ï¡_com¶‘e_Údisk
)

1362  
çl£
;

1363 
mš_Ï¡_com¶‘e_Údisk
 = 
mš
;

1364  
Œue
;

1365 
	}
}

1367 
vœtu®
 
ÿlc_Œim_to
() = 0;

1369 
´oc_»¶iÿ_log
(
pg_šfo_t
 &
ošfo
, cÚ¡ 
pg_log_t
 &
Şog
,

1370 
pg_missšg_t
& 
omissšg
, 
pg_sh¬d_t
 
äom
);

1371 
´oc_ma¡”_log
(
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
, 
pg_šfo_t
 &
ošfo
, 
pg_log_t
 &
Şog
,

1372 
pg_missšg_t
& 
omissšg
, 
pg_sh¬d_t
 
äom
);

1373 
boŞ
 
´oc_»¶iÿ_šfo
(

1374 
pg_sh¬d_t
 
äom
, cÚ¡ 
pg_šfo_t
 &
šfo
, 
•och_t
 
£nd_•och
);

1376 
	gPGLogEÁryHªdËr
 : 
public
 
PGLog
::
LogEÁryHªdËr
 {

1377 
PG
 *
pg
;

1378 
	gObjeùStÜe
::
T¿n§ùiÚ
 *
t
;

1379 
PGLogEÁryHªdËr
(
PG
 *
pg
, 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
) :…g(pg),(t) {}

1382 
»move
(cÚ¡ 
hobjeù_t
 &
hoid
è
	gov”ride
 {

1383 
	gpg
->
g‘_pgback’d
()->
»move
(
hoid
, 
t
);

1385 
Œy_¡ash
(cÚ¡ 
hobjeù_t
 &
hoid
, 
v”siÚ_t
 
v
è
	gov”ride
 {

1386 
	gpg
->
g‘_pgback’d
()->
Œy_¡ash
(
hoid
, 
v
, 
t
);

1388 
rŞlback
(cÚ¡ 
pg_log_’Œy_t
 &
’Œy
è
	gov”ride
 {

1389 
as£¹
(
’Œy
.
ÿn_rŞlback
());

1390 
	gpg
->
g‘_pgback’d
()->
rŞlback
(
’Œy
, 
t
);

1392 
rŞlfÜw¬d
(cÚ¡ 
pg_log_’Œy_t
 &
’Œy
è
	gov”ride
 {

1393 
	gpg
->
g‘_pgback’d
()->
rŞlfÜw¬d
(
’Œy
, 
t
);

1395 
Œim
(cÚ¡ 
pg_log_’Œy_t
 &
’Œy
è
	gov”ride
 {

1396 
	gpg
->
g‘_pgback’d
()->
Œim
(
’Œy
, 
t
);

1400 
upd©e_objeù_¢­_m­pšg
(

1401 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
, cÚ¡ 
hobjeù_t
 &
soid
,

1402 cÚ¡ 
£t
<
¢­id_t
> &
¢­s
);

1403 
ş—r_objeù_¢­_m­pšg
(

1404 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
, cÚ¡ 
hobjeù_t
 &
soid
);

1405 
»move_¢­_m­³d_objeù
(

1406 
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
, cÚ¡ 
hobjeù_t
& 
soid
);

1407 
m”ge_log
(

1408 
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
, 
pg_šfo_t
 &
ošfo
,

1409 
pg_log_t
 &
Şog
, 
pg_sh¬d_t
 
äom
);

1410 
»wšd_div”g’t_log
(
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
, 
ev”siÚ_t
 
Ãwh—d
);

1411 
boŞ
 
£¬ch_fÜ_missšg
(

1412 cÚ¡ 
pg_šfo_t
 &
ošfo
, cÚ¡ 
pg_missšg_t
 &
omissšg
,

1413 
pg_sh¬d_t
 
äomosd
,

1414 
Recov”yCtx
*);

1416 
check_fÜ_lo¡_objeùs
();

1417 
fÜg‘_lo¡_objeùs
();

1419 
discov”_®l_missšg
(
¡d
::
m­
<, m­<
¥g_t
,
pg_qu”y_t
> > &
qu”y_m­
);

1421 
Œim_wr™e_ah—d
();

1423 
	gm­
<
	gpg_sh¬d_t
, 
	gpg_šfo_t
>::
cÚ¡_™”©Ü
 
fšd_be¡_šfo
(

1424 cÚ¡ 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
> &
šfos
,

1425 
boŞ
 
»¡riù_to_up_aùšg
,

1426 
boŞ
 *
hi¡Üy_Ës_bound
) const;

1427 
ÿlc_ec_aùšg
(

1428 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
>::
cÚ¡_™”©Ü
 
auth_log_sh¬d
,

1429 
size
,

1430 cÚ¡ 
veùÜ
<> &
aùšg
,

1431 cÚ¡ 
veùÜ
<> &
up
,

1432 cÚ¡ 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
> &
®l_šfo
,

1433 
boŞ
 
»¡riù_to_up_aùšg
,

1434 
veùÜ
<> *
wªt
,

1435 
£t
<
pg_sh¬d_t
> *
backfl
,

1436 
£t
<
pg_sh¬d_t
> *
aùšg_backfl
,

1437 
o¡»am
 &
ss
);

1438 
ÿlc_»¶iÿ‹d_aùšg
(

1439 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
>::
cÚ¡_™”©Ü
 
auth_log_sh¬d
,

1440 
size
,

1441 cÚ¡ 
veùÜ
<> &
aùšg
,

1442 cÚ¡ 
veùÜ
<> &
up
,

1443 
pg_sh¬d_t
 
up_´im¬y
,

1444 cÚ¡ 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
> &
®l_šfo
,

1445 
boŞ
 
»¡riù_to_up_aùšg
,

1446 
veùÜ
<> *
wªt
,

1447 
£t
<
pg_sh¬d_t
> *
backfl
,

1448 
£t
<
pg_sh¬d_t
> *
aùšg_backfl
,

1449 
o¡»am
 &
ss
);

1450 
choo£_async_»cov”y_ec
(cÚ¡ 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
> &
®l_šfo
,

1451 cÚ¡ 
pg_šfo_t
 &
auth_šfo
,

1452 
veùÜ
<> *
wªt
,

1453 
£t
<
pg_sh¬d_t
> *
async_»cov”y
) const;

1454 
choo£_async_»cov”y_»¶iÿ‹d
(cÚ¡ 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
> &
®l_šfo
,

1455 cÚ¡ 
pg_šfo_t
 &
auth_šfo
,

1456 
veùÜ
<> *
wªt
,

1457 
£t
<
pg_sh¬d_t
> *
async_»cov”y
) const;

1459 
boŞ
 
»cov”abË_ªd_ge_mš_size
(cÚ¡ 
veùÜ
<> &
wªt
) const;

1460 
boŞ
 
choo£_aùšg
(
pg_sh¬d_t
 &
auth_log_sh¬d
,

1461 
boŞ
 
»¡riù_to_up_aùšg
,

1462 
boŞ
 *
hi¡Üy_Ës_bound
);

1463 
bud_might_have_unfound
();

1464 
aùiv©e
(

1465 
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
,

1466 
•och_t
 
aùiv©iÚ_•och
,

1467 
m­
<, m­<
¥g_t
,
pg_qu”y_t
> >& 
qu”y_m­
,

1468 
m­
<,

1469 
veùÜ
<
·œ
<
pg_nÙify_t
, 
Pa¡IÁ”v®s
> > > *
aùiv©Ü_m­
,

1470 
Recov”yCtx
 *
ùx
);

1472 
	gC_PG_Aùiv©eComm™‹d
 : 
public
 
CÚ‹xt
 {

1473 
PGRef
 
pg
;

1474 
•och_t
 
	g•och
;

1475 
•och_t
 
	gaùiv©iÚ_•och
;

1476 
C_PG_Aùiv©eComm™‹d
(
PG
 *
p
, 
•och_t
 
e
,ƒpoch_ˆ
«
)

1477 : 
pg
(
p
), 
•och
(
e
), 
aùiv©iÚ_•och
(
«
) {}

1478 
fšish
(
r
è
	gov”ride
 {

1479 
	gpg
->
_aùiv©e_comm™‹d
(
•och
, 
aùiv©iÚ_•och
);

1482 
_aùiv©e_comm™‹d
(
•och_t
 
•och
,ƒpoch_ˆ
aùiv©iÚ_•och
);

1483 
®l_aùiv©ed_ªd_comm™‹d
();

1485 
´oc_´im¬y_šfo
(
ObjeùStÜe
::
T¿n§ùiÚ
 &
t
, cÚ¡ 
pg_šfo_t
 &
šfo
);

1487 
boŞ
 
	$have_unfound
() const {

1488  
missšg_loc
.
	`have_unfound
();

1489 
	}
}

1490 
ušt64_t
 
	$g‘_num_unfound
() const {

1491  
missšg_loc
.
	`num_unfound
();

1492 
	}
}

1494 
vœtu®
 
check_loÿl
() = 0;

1496 
purge_¡¿ys
();

1498 
upd©e_h—¹b—t_³”s
();

1500 
CÚ‹xt
 *
	gfšish_sync_ev’t
;

1502 
CÚ‹xt
 *
fšish_»cov”y
();

1503 
_fšish_»cov”y
(
CÚ‹xt
 *
c
);

1504 
	gC_PG_FšishRecov”y
 : 
public
 
CÚ‹xt
 {

1505 
PGRef
 
pg
;

1506 
ex¶ic™
 
C_PG_FšishRecov”y
(
PG
 *
p
è: 
pg
(p) {}

1507 
fšish
(
r
è
ov”ride
 {

1508 
pg
->
_fšish_»cov”y
(
this
);

1511 
ÿnûl_»cov”y
();

1512 
ş—r_»cov”y_¡©e
();

1513 
vœtu®
 
_ş—r_»cov”y_¡©e
() = 0;

1514 
vœtu®
 
check_»cov”y_sourûs
(cÚ¡ 
OSDM­Ref
& 
Ãwm­
) = 0;

1515 
¡¬t_»cov”y_İ
(cÚ¡ 
hobjeù_t
& 
soid
);

1516 
fšish_»cov”y_İ
(cÚ¡ 
hobjeù_t
& 
soid
, 
boŞ
 
dequeue
=
çl£
);

1518 
vœtu®
 
_¥l™_što
(
pg_t
 
chd_pgid
, 
PG
 *
chd
, 
¥l™_b™s
) = 0;

1520 
ä›nd
 
şass
 
	gC_OSD_R•Modify_Comm™
;

1521 
ä›nd
 
şass
 
	gC_D–‘eMÜe
;

1524 
Mu‹x
 
	gbackoff_lock
;

1525 
	gm­
<
	ghobjeù_t
,
	g£t
<
	gBackoffRef
>> 
	gbackoffs
;

1527 
add_backoff
(
SessiÚRef
 
s
, cÚ¡ 
hobjeù_t
& 
begš
, cÚ¡ hobjeù_t& 
’d
);

1528 
»Ëa£_backoffs
(cÚ¡ 
hobjeù_t
& 
begš
, cÚ¡ hobjeù_t& 
’d
);

1529 
	$»Ëa£_backoffs
(cÚ¡ 
hobjeù_t
& 
o
) {

1530 
	`»Ëa£_backoffs
(
o
, o);

1531 
	}
}

1532 
ş—r_backoffs
();

1534 
	$add_pg_backoff
(
SessiÚRef
 
s
) {

1535 
hobjeù_t
 
begš
 = 
šfo
.
pgid
.pgid.
	`g‘_hobj_¡¬t
();

1536 
hobjeù_t
 
’d
 = 
šfo
.
pgid
.pgid.
	`g‘_hobj_’d
(
poŞ
.šfo.
	`g‘_pg_num
());

1537 
	`add_backoff
(
s
, 
begš
, 
’d
);

1538 
	}
}

1539 
	$»Ëa£_pg_backoffs
() {

1540 
hobjeù_t
 
begš
 = 
šfo
.
pgid
.pgid.
	`g‘_hobj_¡¬t
();

1541 
hobjeù_t
 
’d
 = 
šfo
.
pgid
.pgid.
	`g‘_hobj_’d
(
poŞ
.šfo.
	`g‘_pg_num
());

1542 
	`»Ëa£_backoffs
(
begš
, 
’d
);

1543 
	}
}

1546 
	gpublic
:

1547 
	sSüubb”
 {

1548 
Süubb”
();

1549 ~
Süubb”
();

1552 
	g£t
<
	gpg_sh¬d_t
> 
	g»£rved_³”s
;

1553 
boŞ
 
	g»£rved
, 
	g»£rve_çed
;

1554 
•och_t
 
	g•och_¡¬t
;

1557 
boŞ
 
	gaùive
;

1558 
	g£t
<
	gpg_sh¬d_t
> 
	gwa™šg_Ú_whom
;

1559 
	gsh®low_”rÜs
;

1560 
	gd“p_”rÜs
;

1561 
	gÏrge_om­_objeùs
 = 0;

1562 
	gfixed
;

1563 
SüubM­
 
	g´im¬y_süubm­
;

1564 
SüubM­Bud”
 
	g´im¬y_süubm­_pos
;

1565 
•och_t
 
	g»¶iÿ_süub_¡¬t
 = 0;

1566 
SüubM­
 
	g»¶iÿ_süubm­
;

1567 
SüubM­Bud”
 
	g»¶iÿ_süubm­_pos
;

1568 
	gm­
<
	gpg_sh¬d_t
, 
	gSüubM­
> 
	g»ûived_m­s
;

1569 
OpReque¡Ref
 
	gaùive_»p_süub
;

1570 
utime_t
 
	gsüub_»g_¡amp
;

1573 
boŞ
 
	g¦“pšg
 = 
çl£
;

1574 
boŞ
 
	gÃeds_¦“p
 = 
Œue
;

1575 
utime_t
 
	g¦“p_¡¬t
;

1578 
boŞ
 
	gmu¡_süub
, 
	gmu¡_d“p_süub
, 
	gmu¡_»·œ
;

1581 
	g´iÜ™y
 = 0;

1584 
boŞ
 
	gauto_»·œ
;

1587 
	gm­
<
	ghobjeù_t
, 
	g£t
<
	gpg_sh¬d_t
>> 
	gmissšg
;

1588 
	gm­
<
	ghobjeù_t
, 
	g£t
<
	gpg_sh¬d_t
>> 
	gšcÚsi¡’t
;

1591 
	gm­
<
	ghobjeù_t
, 
	gli¡
<
	g·œ
<
	gSüubM­
::
objeù
, 
	gpg_sh¬d_t
> >> 
	gauthÜ™©ive
;

1594 
SüubM­
 
	gş—Ãd_m‘a_m­
;

1596 
ş—n_m‘a_m­
(
SüubM­
 &
fÜ_m‘a_süub
) {

1597 ià(
	g’d
.
is_max
() ||

1598 
	gş—Ãd_m‘a_m­
.
	gobjeùs
.
em±y
()) {

1599 
	gş—Ãd_m‘a_m­
.
sw­
(
fÜ_m‘a_süub
);

1601 autØ
	g™”
 = 
ş—Ãd_m‘a_m­
.
objeùs
.
’d
();

1602 --
	g™”
;

1603 autØ
	gbegš
 = 
ş—Ãd_m‘a_m­
.
objeùs
.
begš
();

1604 ià(
	g™”
->
	gfœ¡
.
has_¢­£t
()) {

1605 ++
	g™”
;

1607 
	g™”
 !ğ
begš
) {

1608 autØ
Ãxt
 = 
™”
--;

1609 ià(
	gÃxt
->
	gfœ¡
.
g‘_h—d
(è!ğ
™”
->
fœ¡
.get_head()) {

1610 ++
™”
;

1615 
	gfÜ_m‘a_süub
.
	gobjeùs
.
š£¹
(
begš
, 
™”
);

1616 
	gş—Ãd_m‘a_m­
.
	gobjeùs
.
”a£
(
begš
, 
™”
);

1621 
	gnum_dige¡_upd©es_³ndšg
;

1624 
hobjeù_t
 
	g¡¬t
, 
	g’d
;

1625 
ev”siÚ_t
 
	gsub£t_Ï¡_upd©e
;

1628 
	eS‹
 {

1629 
	gINACTIVE
,

1630 
	gNEW_CHUNK
,

1631 
	gWAIT_PUSHES
,

1632 
	gWAIT_LAST_UPDATE
,

1633 
	gBUILD_MAP
,

1634 
	gBUILD_MAP_DONE
,

1635 
	gWAIT_REPLICAS
,

1636 
	gCOMPARE_MAPS
,

1637 
	gWAIT_DIGEST_UPDATES
,

1638 
	gFINISH
,

1639 
	gBUILD_MAP_REPLICA
,

1640 } 
	g¡©e
;

1642 
	g¡d
::
unique_±r
<
Süub
::
StÜe
> 
¡Üe
;

1644 
boŞ
 
	gd“p
;

1645 
	g´“m±_Ëá
;

1646 
	g´“m±_divisÜ
;

1648 
	gli¡
<
	gCÚ‹xt
*> 
	gÿÎbacks
;

1649 
add_ÿÎback
(
CÚ‹xt
 *
cÚ‹xt
) {

1650 
	gÿÎbacks
.
push_back
(
cÚ‹xt
);

1652 
run_ÿÎbacks
() {

1653 
	gli¡
<
	gCÚ‹xt
*> 
	gto_run
;

1654 
	gto_run
.
sw­
(
ÿÎbacks
);

1655 
	gli¡
<
	gCÚ‹xt
*>::
™”©Ü
 
i
 = 
to_run
.
begš
();

1656 
	gi
 !ğ
to_run
.
’d
();

1657 ++
	gi
) {

1658 (*
	gi
)->
com¶‘e
(0);

1662 cÚ¡ *
¡©e_¡ršg
(cÚ¡ 
PG
::
Süubb”
::
S‹
& 
¡©e
) {

1663 cÚ¡ *
»t
 = 
NULL
;

1664  
	g¡©e
 )

1666 
	gINACTIVE
: 
»t
 = "INACTIVE"; ;

1667 
	gNEW_CHUNK
: 
»t
 = "NEW_CHUNK"; ;

1668 
	gWAIT_PUSHES
: 
»t
 = "WAIT_PUSHES"; ;

1669 
	gWAIT_LAST_UPDATE
: 
»t
 = "WAIT_LAST_UPDATE"; ;

1670 
	gBUILD_MAP
: 
»t
 = "BUILD_MAP"; ;

1671 
	gBUILD_MAP_DONE
: 
»t
 = "BUILD_MAP_DONE"; ;

1672 
	gWAIT_REPLICAS
: 
»t
 = "WAIT_REPLICAS"; ;

1673 
	gCOMPARE_MAPS
: 
»t
 = "COMPARE_MAPS"; ;

1674 
	gWAIT_DIGEST_UPDATES
: 
»t
 = "WAIT_DIGEST_UPDATES"; ;

1675 
	gFINISH
: 
»t
 = "FINISH"; ;

1676 
	gBUILD_MAP_REPLICA
: 
»t
 = "BUILD_MAP_REPLICA"; ;

1678  
	g»t
;

1681 
boŞ
 
is_chunky_süub_aùive
(ècÚ¡ {  
	g¡©e
 !ğ
INACTIVE
; }

1684 
»£t
() {

1685 
	gaùive
 = 
çl£
;

1686 
	gwa™šg_Ú_whom
.
ş—r
();

1687 ià(
	gaùive_»p_süub
) {

1688 
	gaùive_»p_süub
 = 
OpReque¡Ref
();

1690 
	g»ûived_m­s
.
ş—r
();

1692 
	gmu¡_süub
 = 
çl£
;

1693 
	gmu¡_d“p_süub
 = 
çl£
;

1694 
	gmu¡_»·œ
 = 
çl£
;

1695 
	gauto_»·œ
 = 
çl£
;

1697 
	g¡©e
 = 
PG
::
Süubb”
::
INACTIVE
;

1698 
	g¡¬t
 = 
hobjeù_t
();

1699 
	g’d
 = 
hobjeù_t
();

1700 
	gsub£t_Ï¡_upd©e
 = 
ev”siÚ_t
();

1701 
	gsh®low_”rÜs
 = 0;

1702 
	gd“p_”rÜs
 = 0;

1703 
	gÏrge_om­_objeùs
 = 0;

1704 
	gfixed
 = 0;

1705 
	gd“p
 = 
çl£
;

1706 
run_ÿÎbacks
();

1707 
	gšcÚsi¡’t
.
ş—r
();

1708 
	gmissšg
.
ş—r
();

1709 
	gauthÜ™©ive
.
ş—r
();

1710 
	gnum_dige¡_upd©es_³ndšg
 = 0;

1711 
	g´im¬y_süubm­
 = 
SüubM­
();

1712 
	g´im¬y_süubm­_pos
.
»£t
();

1713 
	g»¶iÿ_süubm­
 = 
SüubM­
();

1714 
	g»¶iÿ_süubm­_pos
.
»£t
();

1715 
	gş—Ãd_m‘a_m­
 = 
SüubM­
();

1716 
	g¦“pšg
 = 
çl£
;

1717 
	gÃeds_¦“p
 = 
Œue
;

1718 
	g¦“p_¡¬t
 = 
utime_t
();

1721 
ü—‹_»suÉs
(cÚ¡ 
hobjeù_t
& 
obj
);

1722 
ş—nup_¡Üe
(
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

1723 } 
	gsüubb”
;

1725 
	g´Ùeùed
:

1726 
boŞ
 
süub_aá”_»cov”y
;

1728 
	gaùive_pushes
;

1730 
boŞ
 
	gsüub_ÿn_´“m±
 = 
çl£
;

1731 
boŞ
 
	gsüub_´“m±ed
 = 
çl£
;

1736 
boŞ
 
wr™e_blocked_by_süub
(cÚ¡ 
hobjeù_t
 &
soid
);

1739 
boŞ
 
¿nge_š‹r£ùs_süub
(cÚ¡ 
hobjeù_t
 &
¡¬t
, cÚ¡ hobjeù_t& 
’d
);

1741 
»·œ_objeù
(

1742 cÚ¡ 
hobjeù_t
& 
soid
, 
li¡
<
·œ
<
SüubM­
::
objeù
, 
pg_sh¬d_t
> > *
ok_³”s
,

1743 
pg_sh¬d_t
 
bad_³”
);

1745 
chunky_süub
(
Th»adPoŞ
::
TPHªdË
 &
hªdË
);

1746 
süub_com·»_m­s
();

1750 
boŞ
 
süub_´oûss_šcÚsi¡’t
();

1751 
boŞ
 
	$İs_blocked_by_süub
() const;

1752 
	`süub_fšish
();

1753 
	`süub_ş—r_¡©e
();

1754 
	`_sÿn_¢­s
(
SüubM­
 &
m­
);

1755 
	`_»·œ_ošfo_oid
(
SüubM­
 &
m­
);

1756 
	`_sÿn_rŞlback_obs
(cÚ¡ 
veùÜ
<
ghobjeù_t
> &
rŞlback_obs
);

1757 
	`_»que¡_süub_m­
(
pg_sh¬d_t
 
»¶iÿ
, 
ev”siÚ_t
 
v”siÚ
,

1758 
hobjeù_t
 
¡¬t
, hobjeù_ˆ
’d
, 
boŞ
 
d“p
,

1759 
boŞ
 
®low_´“m±iÚ
);

1760 
	`bud_süub_m­_chunk
(

1761 
SüubM­
 &
m­
,

1762 
SüubM­Bud”
 &
pos
,

1763 
hobjeù_t
 
¡¬t
, hobjeù_ˆ
’d
, 
boŞ
 
d“p
,

1764 
Th»adPoŞ
::
TPHªdË
 &
hªdË
);

1770 
vœtu®
 
boŞ
 
	`_¿nge_avaabË_fÜ_süub
(

1771 cÚ¡ 
hobjeù_t
 &
begš
, cÚ¡ hobjeù_ˆ&
’d
) = 0;

1772 
vœtu®
 
	`süub_¢­shÙ_m‘ad©a
(

1773 
SüubM­
 &
m­
,

1774 cÚ¡ 
¡d
::
m­
<
hobjeù_t
,

1775 
·œ
<
boo¡
::
İtiÚ®
<
ušt32_t
>,

1776 
boo¡
::
İtiÚ®
<
ušt32_t
>>> &
missšg_dige¡
è{ 
	}
}

1777 
vœtu®
 
	$_süub_ş—r_¡©e
(è{ 
	}
}

1778 
vœtu®
 
	$_süub_fšish
(è{ 
	}
}

1779 
ş—r_süub_»£rved
();

1780 
süub_»£rve_»¶iÿs
();

1781 
süub_uÄe£rve_»¶iÿs
();

1782 
boŞ
 
	$süub_®l_»¶iÿs_»£rved
() const;

1784 
	`»¶iÿ_süub
(

1785 
OpReque¡Ref
 
İ
,

1786 
Th»adPoŞ
::
TPHªdË
 &
hªdË
);

1787 
	`do_»¶iÿ_süub_m­
(
OpReque¡Ref
 
İ
);

1789 
	`hªdË_süub_»£rve_»que¡
(
OpReque¡Ref
 
İ
);

1790 
	`hªdË_süub_»£rve_g¿Á
(
OpReque¡Ref
 
İ
, 
pg_sh¬d_t
 
äom
);

1791 
	`hªdË_süub_»£rve_»jeù
(
OpReque¡Ref
 
İ
, 
pg_sh¬d_t
 
äom
);

1792 
	`hªdË_süub_»£rve_»Ëa£
(
OpReque¡Ref
 
İ
);

1794 
	`»jeù_»£rv©iÚ
();

1795 
	`scheduË_backfl_»Œy
(
»Œy
);

1796 
	`scheduË_»cov”y_»Œy
(
»Œy
);

1800 
‹m¶©e
 <
şass
 
EVT
>

1801 
QueueP“ršgEvt
 : 
CÚ‹xt
 {

1802 
PGRef
 
pg
;

1803 
•och_t
 
•och
;

1804 
EVT
 
evt
;

1805 
	`QueueP“ršgEvt
(
PG
 *
pg
, 
•och_t
 
•och
, 
EVT
 
evt
) :

1806 
	`pg
(
pg
), 
	`•och
(
•och
), 
	`evt
(
evt
) {}

1807 
	`fšish
(
r
è
ov”ride
 {

1808 
pg
->
	`lock
();

1809 
pg
->
	`queue_³”šg_ev’t
(
	`PGP“ršgEv’tRef
(

1810 
Ãw
 
	`PGP“ršgEv’t
(

1811 
•och
,

1812 
•och
,

1813 
evt
)));

1814 
pg
->
	`uÆock
();

1816 
	}
};

1819 
	gQu”yS‹
 : 
boo¡
::
¡©ech¬t
::
ev’t
< 
Qu”yS‹
 > {

1820 
FÜm©‹r
 *
f
;

1821 
ex¶ic™
 
Qu”yS‹
(
FÜm©‹r
 *
f
) : f(f) {}

1822 
´št
(
¡d
::
o¡»am
 *
out
) const {

1823 *
out
 << "Query";

1827 
	gpublic
:

1828 
´Ùeùed
:

1830 
AdvM­
 : 
boo¡
::
¡©ech¬t
::
ev’t
< AdvMap > {

1831 
OSDM­Ref
 
osdm­
;

1832 
OSDM­Ref
 
	gÏ¡m­
;

1833 
	gveùÜ
<> 
	gÃwup
, 
	gÃwaùšg
;

1834 
	gup_´im¬y
, 
	gaùšg_´im¬y
;

1835 
AdvM­
(

1836 
OSDM­Ref
 
osdm­
, OSDM­Reà
Ï¡m­
,

1837 
veùÜ
<>& 
Ãwup
, 
up_´im¬y
,

1838 
veùÜ
<>& 
Ãwaùšg
, 
aùšg_´im¬y
):

1839 
osdm­
(osdm­), 
Ï¡m­
(lastmap),

1840 
Ãwup
(newup),

1841 
Ãwaùšg
(newacting),

1842 
up_´im¬y
(up_primary),

1843 
aùšg_´im¬y
(acting_primary) {}

1844 
´št
(
¡d
::
o¡»am
 *
out
) const {

1845 *
out
 << "AdvMap";

1849 
	gAùM­
 : 
boo¡
::
¡©ech¬t
::
ev’t
< 
AùM­
 > {

1850 
AùM­
(è: 
boo¡
::
¡©ech¬t
::
ev’t
< ActMap >() {}

1851 
´št
(
¡d
::
o¡»am
 *
out
) const {

1852 *
out
 << "ActMap";

1855 
	gAùiv©e
 : 
boo¡
::
¡©ech¬t
::
ev’t
< 
Aùiv©e
 > {

1856 
•och_t
 
aùiv©iÚ_•och
;

1857 
ex¶ic™
 
Aùiv©e
(
•och_t
 
q
è: 
boo¡
::
¡©ech¬t
::
ev’t
< Activate >(),

1858 
aùiv©iÚ_•och
(
q
) {}

1859 
´št
(
¡d
::
o¡»am
 *
out
) const {

1860 *
out
 << "Aùiv©äom " << 
aùiv©iÚ_•och
;

1863 
	gpublic
:

1864 
UnfoundBackfl
 : 
boo¡
::
¡©ech¬t
::
ev’t
<UnfoundBackfill> {

1865 
ex¶ic™
 
UnfoundBackfl
() {}

1866 
´št
(
¡d
::
o¡»am
 *
out
) const {

1867 *
out
 << "UnfoundBackfill";

1870 
	gUnfoundRecov”y
 : 
boo¡
::
¡©ech¬t
::
ev’t
<
UnfoundRecov”y
> {

1871 
ex¶ic™
 
UnfoundRecov”y
() {}

1872 
´št
(
¡d
::
o¡»am
 *
out
) const {

1873 *
out
 << "UnfoundRecovery";

1877 
	gReque¡Süub
 : 
boo¡
::
¡©ech¬t
::
ev’t
<
Reque¡Süub
> {

1878 
boŞ
 
d“p
;

1879 
boŞ
 
	g»·œ
;

1880 
ex¶ic™
 
Reque¡Süub
(
boŞ
 
d
, boŞ 
r
è: 
d“p
(d), 
»·œ
(r) {}

1881 
´št
(
¡d
::
o¡»am
 *
out
) const {

1882 *
out
 << "Reque¡Süub(" << (
d“p
 ? "deep" : "shallow")

1883 << (
»·œ
 ? "„epair" : "");

1887 
	g´Ùeùed
:

1888 
	$TrivŸlEv’t
(
In™Ÿlize
)

1889 
	$TrivŸlEv’t
(
GÙInfo
)

1890 
	$TrivŸlEv’t
(
N“dUpThru
)

1891 
	$TrivŸlEv’t
(
BackfËd
)

1892 
	$TrivŸlEv’t
(
LoÿlBackflRe£rved
)

1893 
	$TrivŸlEv’t
(
RejeùRemÙeRe£rv©iÚ
)

1894 
public
:

1895 
	$TrivŸlEv’t
(
Reque¡Backfl
)

1896 
´Ùeùed
:

1897 
	$TrivŸlEv’t
(
RemÙeRecov”yP»em±ed
)

1898 
	$TrivŸlEv’t
(
RemÙeBackflP»em±ed
)

1899 
	$TrivŸlEv’t
(
BackflTooFuÎ
)

1900 
	$TrivŸlEv’t
(
Recov”yTooFuÎ
)

1902 
	$TrivŸlEv’t
(
MakePrim¬y
)

1903 
	$TrivŸlEv’t
(
MakeSŒay
)

1904 
	$TrivŸlEv’t
(
N“dAùšgChªge
)

1905 
	$TrivŸlEv’t
(
IsIncom¶‘e
)

1906 
	$TrivŸlEv’t
(
IsDown
)

1908 
	$TrivŸlEv’t
(
AÎR•liÿsRecov”ed
)

1909 
	$TrivŸlEv’t
(
DoRecov”y
)

1910 
	$TrivŸlEv’t
(
LoÿlRecov”yRe£rved
)

1911 
public
:

1912 
´Ùeùed
:

1913 
	$TrivŸlEv’t
(
AÎRemÙesRe£rved
)

1914 
	$TrivŸlEv’t
(
AÎBackflsRe£rved
)

1915 
	$TrivŸlEv’t
(
GoCËª
)

1917 
	$TrivŸlEv’t
(
AÎR•liÿsAùiv©ed
)

1919 
	$TrivŸlEv’t
(
IÁ”v®Flush
)

1921 
public
:

1922 
	$TrivŸlEv’t
(
D–‘eS¹
)

1923 
	$TrivŸlEv’t
(
D–‘eSome
)

1925 
	$TrivŸlEv’t
(
S‘FÜûRecov”y
)

1926 
	$TrivŸlEv’t
(
Un£tFÜûRecov”y
)

1927 
	$TrivŸlEv’t
(
S‘FÜûBackfl
)

1928 
	$TrivŸlEv’t
(
Un£tFÜûBackfl
)

1930 
´Ùeùed
:

1931 
	$TrivŸlEv’t
(
D–‘eRe£rved
)

1932 
	$TrivŸlEv’t
(
D–‘eIÁ”ru±ed
)

1935 şas 
	cRecov”yS‹
 {

1936 
	`¡¬t_hªdË
(
Recov”yCtx
 *
Ãw_ùx
);

1937 
	`’d_hªdË
();

1938 
public
:

1939 
	`begš_block_outgošg
();

1940 
	`’d_block_outgošg
();

1941 
	`ş—r_blocked_outgošg
();

1942 
´iv©e
:

1945 
In™Ÿl
;

1946 
şass
 
Recov”yMachše
 : 
public
 
boo¡
::
¡©ech¬t
::
¡©e_machše
< Recov”yMachše, 
In™Ÿl
 > {

1947 
Recov”yS‹
 *
¡©e
;

1948 
public
:

1949 
PG
 *
pg
;

1951 
utime_t
 
ev’t_time
;

1952 
ušt64_t
 
ev’t_couÁ
;

1954 
	`ş—r_ev’t_couÁ”s
() {

1955 
ev’t_time
 = 
	`utime_t
();

1956 
ev’t_couÁ
 = 0;

1959 
	`log_’‹r
(cÚ¡ *
¡©e_Çme
);

1960 
	`log_ex™
(cÚ¡ *
¡©e_Çme
, 
utime_t
 
du¿tiÚ
);

1962 
	`Recov”yMachše
(
Recov”yS‹
 *
¡©e
, 
PG
 *
pg
è: 
	`¡©e
(¡©e), 
	`pg
Õg), 
	`ev’t_couÁ
(0) {}

1965 
ObjeùStÜe
::
T¿n§ùiÚ
* 
	`g‘_cur_Œª§ùiÚ
() {

1966 
	`as£¹
(
¡©e
->
rùx
);

1967 
	`as£¹
(
¡©e
->
rùx
->
Œª§ùiÚ
);

1968  
¡©e
->
rùx
->
Œª§ùiÚ
;

1971 
	`£nd_qu”y
(
pg_sh¬d_t
 
to
, cÚ¡ 
pg_qu”y_t
 &
qu”y
) {

1972 
	`as£¹
(
¡©e
->
rùx
);

1973 
	`as£¹
(
¡©e
->
rùx
->
qu”y_m­
);

1974 (*
¡©e
->
rùx
->
qu”y_m­
)[
to
.
osd
][
	`¥g_t
(
pg
->
šfo
.
pgid
.pgid,o.
sh¬d
)] =

1975 
qu”y
;

1978 
m­
<, m­<
¥g_t
, 
pg_qu”y_t
> > *
	`g‘_qu”y_m­
() {

1979 
	`as£¹
(
¡©e
->
rùx
);

1980 
	`as£¹
(
¡©e
->
rùx
->
qu”y_m­
);

1981  
¡©e
->
rùx
->
qu”y_m­
;

1984 
m­
<, 
veùÜ
<
·œ
<
pg_nÙify_t
, 
Pa¡IÁ”v®s
> > > *
	`g‘_šfo_m­
() {

1985 
	`as£¹
(
¡©e
->
rùx
);

1986 
	`as£¹
(
¡©e
->
rùx
->
šfo_m­
);

1987  
¡©e
->
rùx
->
šfo_m­
;

1990 
Recov”yCtx
 *
	`g‘_»cov”y_ùx
(è{  &*(
¡©e
->
rùx
); }

1992 
	`£nd_nÙify
(
pg_sh¬d_t
 
to
,

1993 cÚ¡ 
pg_nÙify_t
 &
šfo
, cÚ¡ 
Pa¡IÁ”v®s
 &
pi
) {

1994 
	`as£¹
(
¡©e
->
rùx
);

1995 
	`as£¹
(
¡©e
->
rùx
->
nÙify_li¡
);

1996 (*
¡©e
->
rùx
->
nÙify_li¡
)[
to
.
osd
].
	`push_back
(
	`make_·œ
(
šfo
, 
pi
));

1999 
ä›nd
 
şass
 
Recov”yMachše
;

2037 
C¿shed
 : 
boo¡
::
¡©ech¬t
::
¡©e
< C¿shed, 
Recov”yMachše
 >, 
NamedS‹
 {

2038 
ex¶ic™
 
	`C¿shed
(
my_cÚ‹xt
 
ùx
);

2041 
Re£t
;

2043 
In™Ÿl
 : 
boo¡
::
¡©ech¬t
::
¡©e
< In™Ÿl, 
Recov”yMachše
 >, 
NamedS‹
 {

2044 
ex¶ic™
 
	`In™Ÿl
(
my_cÚ‹xt
 
ùx
);

2045 
	`ex™
();

2047 
boo¡
::
	tm¶
::
	tli¡
 <

2048 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tIn™Ÿlize
, 
	tRe£t
 >,

2049 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tNuÎEvt
 >,

2050 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< boo¡::¡©ech¬t::
	tev’t_ba£
, 
	tC¿shed
 >

2051 > 
	t»aùiÚs
;

2053 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MNÙifyRec
&);

2054 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MInfoRec
&);

2055 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MLogRec
&);

2056 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ boo¡::¡©ech¬t::
ev’t_ba£
&) {

2057  
	`disÿrd_ev’t
();

2061 
Re£t
 : 
boo¡
::
¡©ech¬t
::
¡©e
< Re£t, 
Recov”yMachše
 >, 
NamedS‹
 {

2062 
ex¶ic™
 
	`Re£t
(
my_cÚ‹xt
 
ùx
);

2063 
	`ex™
();

2065 
boo¡
::
	tm¶
::
	tli¡
 <

2066 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tQu”yS‹
 >,

2067 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tAdvM­
 >,

2068 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tAùM­
 >,

2069 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tNuÎEvt
 >,

2070 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tIÁ”v®Flush
 >,

2071 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< boo¡::¡©ech¬t::
	tev’t_ba£
, 
	tC¿shed
 >

2072 > 
	t»aùiÚs
;

2073 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Qu”yS‹
& 
q
);

2074 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
AdvM­
&);

2075 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
AùM­
&);

2076 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
IÁ”v®Flush
&);

2077 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ boo¡::¡©ech¬t::
ev’t_ba£
&) {

2078  
	`disÿrd_ev’t
();

2082 
S¹
;

2084 
S¹ed
 : 
boo¡
::
¡©ech¬t
::
¡©e
< S¹ed, 
Recov”yMachše
, 
S¹
 >, 
NamedS‹
 {

2085 
ex¶ic™
 
	`S¹ed
(
my_cÚ‹xt
 
ùx
);

2086 
	`ex™
();

2088 
boo¡
::
	tm¶
::
	tli¡
 <

2089 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tQu”yS‹
 >,

2090 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tAdvM­
 >,

2091 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tIÁ”v®Flush
 >,

2093 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tNuÎEvt
 >,

2094 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
<
	tS‘FÜûRecov”y
>,

2095 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
<
	tUn£tFÜûRecov”y
>,

2096 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
<
	tS‘FÜûBackfl
>,

2097 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
<
	tUn£tFÜûBackfl
>,

2098 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
<
	tReque¡Süub
>,

2100 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< boo¡::¡©ech¬t::
	tev’t_ba£
, 
	tC¿shed
 >

2101 > 
	t»aùiÚs
;

2102 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Qu”yS‹
& 
q
);

2103 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
AdvM­
&);

2104 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
IÁ”v®Flush
&);

2105 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ boo¡::¡©ech¬t::
ev’t_ba£
&) {

2106  
	`disÿrd_ev’t
();

2110 
Prim¬y
;

2111 
SŒay
;

2113 
S¹
 : 
boo¡
::
¡©ech¬t
::
¡©e
< S¹, 
S¹ed
 >, 
NamedS‹
 {

2114 
ex¶ic™
 
	`S¹
(
my_cÚ‹xt
 
ùx
);

2115 
	`ex™
();

2117 
boo¡
::
	tm¶
::
	tli¡
 <

2118 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tMakePrim¬y
, 
	tPrim¬y
 >,

2119 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tMakeSŒay
, 
	tSŒay
 >

2120 > 
	t»aùiÚs
;

2123 
P“ršg
;

2124 
Wa™AùšgChªge
;

2125 
Incom¶‘e
;

2126 
Down
;

2128 
Prim¬y
 : 
boo¡
::
¡©ech¬t
::
¡©e
< Prim¬y, 
S¹ed
, 
P“ršg
 >, 
NamedS‹
 {

2129 
ex¶ic™
 
	`Prim¬y
(
my_cÚ‹xt
 
ùx
);

2130 
	`ex™
();

2132 
boo¡
::
	tm¶
::
	tli¡
 <

2133 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tAùM­
 >,

2134 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMNÙifyRec
 >,

2135 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tN“dAùšgChªge
, 
	tWa™AùšgChªge
 >,

2136 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
<
	tS‘FÜûRecov”y
>,

2137 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
<
	tUn£tFÜûRecov”y
>,

2138 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
<
	tS‘FÜûBackfl
>,

2139 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
<
	tUn£tFÜûBackfl
>,

2140 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
<
	tReque¡Süub
>

2141 > 
	t»aùiÚs
;

2142 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
AùM­
&);

2143 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MNÙifyRec
&);

2144 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
S‘FÜûRecov”y
&);

2145 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Un£tFÜûRecov”y
&);

2146 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
S‘FÜûBackfl
&);

2147 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Un£tFÜûBackfl
&);

2148 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Reque¡Süub
&);

2151 
Wa™AùšgChªge
 : 
boo¡
::
¡©ech¬t
::
¡©e
< Wa™AùšgChªge, 
Prim¬y
>,

2152 
NamedS‹
 {

2153 
boo¡
::
	tm¶
::
	tli¡
 <

2154 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tQu”yS‹
 >,

2155 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tAdvM­
 >,

2156 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMLogRec
 >,

2157 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMInfoRec
 >,

2158 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMNÙifyRec
 >

2159 > 
	t»aùiÚs
;

2160 
ex¶ic™
 
	`Wa™AùšgChªge
(
my_cÚ‹xt
 
ùx
);

2161 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Qu”yS‹
& 
q
);

2162 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
AdvM­
&);

2163 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MLogRec
&);

2164 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MInfoRec
&);

2165 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MNÙifyRec
&);

2166 
	`ex™
();

2169 
G‘Info
;

2170 
Aùive
;

2172 
P“ršg
 : 
boo¡
::
¡©ech¬t
::
¡©e
< P“ršg, 
Prim¬y
, 
G‘Info
 >, 
NamedS‹
 {

2173 
Pa¡IÁ”v®s
::
PriÜS‘
 
´iÜ_£t
;

2174 
boŞ
 
hi¡Üy_Ës_bound
;

2176 
ex¶ic™
 
	`P“ršg
(
my_cÚ‹xt
 
ùx
);

2177 
	`ex™
();

2179 
boo¡
::
	tm¶
::
	tli¡
 <

2180 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tQu”yS‹
 >,

2181 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tAùiv©e
, 
	tAùive
 >,

2182 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tAdvM­
 >

2183 > 
	t»aùiÚs
;

2184 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Qu”yS‹
& 
q
);

2185 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
AdvM­
 &
advm­
);

2188 
Wa™LoÿlRecov”yRe£rved
;

2189 
Aùiv©šg
;

2190 
Aùive
 : 
boo¡
::
¡©ech¬t
::
¡©e
< Aùive, 
Prim¬y
, 
Aùiv©šg
 >, 
NamedS‹
 {

2191 
ex¶ic™
 
	`Aùive
(
my_cÚ‹xt
 
ùx
);

2192 
	`ex™
();

2194 cÚ¡ 
£t
<
pg_sh¬d_t
> 
»mÙe_sh¬ds_to_»£rve_»cov”y
;

2195 cÚ¡ 
£t
<
pg_sh¬d_t
> 
»mÙe_sh¬ds_to_»£rve_backfl
;

2196 
boŞ
 
®l_»¶iÿs_aùiv©ed
;

2198 
boo¡
::
	tm¶
::
	tli¡
 <

2199 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tQu”yS‹
 >,

2200 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tAùM­
 >,

2201 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tAdvM­
 >,

2202 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMInfoRec
 >,

2203 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMNÙifyRec
 >,

2204 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMLogRec
 >,

2205 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMTrim
 >,

2206 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tBackfËd
 >,

2207 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tAÎR•liÿsAùiv©ed
 >,

2208 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tDeãrRecov”y
 >,

2209 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tDeãrBackfl
 >,

2210 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tUnfoundRecov”y
 >,

2211 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tUnfoundBackfl
 >,

2212 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeRe£rv©iÚRevokedTooFuÎ
>,

2213 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeRe£rv©iÚRevoked
>,

2214 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tDoRecov”y
>

2215 > 
	t»aùiÚs
;

2216 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Qu”yS‹
& 
q
);

2217 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
AùM­
&);

2218 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
AdvM­
&);

2219 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MInfoRec
& 
šfÛvt
);

2220 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MNÙifyRec
& 
nÙevt
);

2221 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MLogRec
& 
logevt
);

2222 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MTrim
& 
Œimevt
);

2223 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
BackfËd
&) {

2224  
	`disÿrd_ev’t
();

2226 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
AÎR•liÿsAùiv©ed
&);

2227 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
DeãrRecov”y
& 
evt
) {

2228  
	`disÿrd_ev’t
();

2230 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
DeãrBackfl
& 
evt
) {

2231  
	`disÿrd_ev’t
();

2233 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
UnfoundRecov”y
& 
evt
) {

2234  
	`disÿrd_ev’t
();

2236 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
UnfoundBackfl
& 
evt
) {

2237  
	`disÿrd_ev’t
();

2239 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeRe£rv©iÚRevokedTooFuÎ
&) {

2240  
	`disÿrd_ev’t
();

2242 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeRe£rv©iÚRevoked
&) {

2243  
	`disÿrd_ev’t
();

2245 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
DoRecov”y
&) {

2246  
	`disÿrd_ev’t
();

2250 
CËª
 : 
boo¡
::
¡©ech¬t
::
¡©e
< CËª, 
Aùive
 >, 
NamedS‹
 {

2251 
boo¡
::
	tm¶
::
	tli¡
<

2252 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tDoRecov”y
, 
	tWa™LoÿlRecov”yRe£rved
 >,

2253 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
<
	tS‘FÜûRecov”y
>,

2254 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
<
	tS‘FÜûBackfl
>

2255 > 
	t»aùiÚs
;

2256 
ex¶ic™
 
	`CËª
(
my_cÚ‹xt
 
ùx
);

2257 
	`ex™
();

2258 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ boo¡::¡©ech¬t::
ev’t_ba£
&) {

2259  
	`disÿrd_ev’t
();

2263 
Recov”ed
 : 
boo¡
::
¡©ech¬t
::
¡©e
< Recov”ed, 
Aùive
 >, 
NamedS‹
 {

2264 
boo¡
::
	tm¶
::
	tli¡
<

2265 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tGoCËª
, 
	tCËª
 >,

2266 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tDoRecov”y
, 
	tWa™LoÿlRecov”yRe£rved
 >,

2267 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tAÎR•liÿsAùiv©ed
 >

2268 > 
	t»aùiÚs
;

2269 
ex¶ic™
 
	`Recov”ed
(
my_cÚ‹xt
 
ùx
);

2270 
	`ex™
();

2271 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
AÎR•liÿsAùiv©ed
&) {

2272 
	`po¡_ev’t
(
	`GoCËª
());

2273  
	`fÜw¬d_ev’t
();

2277 
Backflšg
 : 
boo¡
::
¡©ech¬t
::
¡©e
< Backflšg, 
Aùive
 >, 
NamedS‹
 {

2278 
boo¡
::
	tm¶
::
	tli¡
<

2279 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tBackfËd
, 
	tRecov”ed
 >,

2280 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tDeãrBackfl
 >,

2281 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tUnfoundBackfl
 >,

2282 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeRe£rv©iÚRejeùed
 >,

2283 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeRe£rv©iÚRevokedTooFuÎ
>,

2284 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeRe£rv©iÚRevoked
>

2285 > 
	t»aùiÚs
;

2286 
ex¶ic™
 
	`Backflšg
(
my_cÚ‹xt
 
ùx
);

2287 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeRe£rv©iÚRejeùed
& 
evt
) {

2289 
	`po¡_ev’t
(
	`RemÙeRe£rv©iÚRevokedTooFuÎ
());

2290  
	`disÿrd_ev’t
();

2292 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeRe£rv©iÚRevokedTooFuÎ
& 
evt
);

2293 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeRe£rv©iÚRevoked
& 
evt
);

2294 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
DeãrBackfl
& 
evt
);

2295 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
UnfoundBackfl
& 
evt
);

2296 
	`ÿnûl_backfl
();

2297 
	`ex™
();

2300 
Wa™RemÙeBackflRe£rved
 : 
boo¡
::
¡©ech¬t
::
¡©e
< Wa™RemÙeBackflRe£rved, 
Aùive
 >, 
NamedS‹
 {

2301 
boo¡
::
	tm¶
::
	tli¡
<

2302 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeBackflRe£rved
 >,

2303 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeRe£rv©iÚRejeùed
 >,

2304 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeRe£rv©iÚRevoked
 >,

2305 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tAÎBackflsRe£rved
, 
	tBackflšg
 >

2306 > 
	t»aùiÚs
;

2307 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
backfl_osd_™
;

2308 
ex¶ic™
 
	`Wa™RemÙeBackflRe£rved
(
my_cÚ‹xt
 
ùx
);

2309 
	`»Œy
();

2310 
	`ex™
();

2311 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeBackflRe£rved
& 
evt
);

2312 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeRe£rv©iÚRejeùed
& 
evt
);

2313 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeRe£rv©iÚRevoked
& 
evt
);

2316 
Wa™LoÿlBackflRe£rved
 : 
boo¡
::
¡©ech¬t
::
¡©e
< Wa™LoÿlBackflRe£rved, 
Aùive
 >, 
NamedS‹
 {

2317 
boo¡
::
	tm¶
::
	tli¡
<

2318 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tLoÿlBackflRe£rved
, 
	tWa™RemÙeBackflRe£rved
 >

2319 > 
	t»aùiÚs
;

2320 
ex¶ic™
 
	`Wa™LoÿlBackflRe£rved
(
my_cÚ‹xt
 
ùx
);

2321 
	`ex™
();

2324 
NÙBackflšg
 : 
boo¡
::
¡©ech¬t
::
¡©e
< NÙBackflšg, 
Aùive
>, 
NamedS‹
 {

2325 
boo¡
::
	tm¶
::
	tli¡
<

2326 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tReque¡Backfl
, 
	tWa™LoÿlBackflRe£rved
>,

2327 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeBackflRe£rved
 >,

2328 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeRe£rv©iÚRejeùed
 >

2329 > 
	t»aùiÚs
;

2330 
ex¶ic™
 
	`NÙBackflšg
(
my_cÚ‹xt
 
ùx
);

2331 
	`ex™
();

2332 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeBackflRe£rved
& 
evt
);

2333 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeRe£rv©iÚRejeùed
& 
evt
);

2336 
NÙRecov”šg
 : 
boo¡
::
¡©ech¬t
::
¡©e
< NÙRecov”šg, 
Aùive
>, 
NamedS‹
 {

2337 
boo¡
::
	tm¶
::
	tli¡
<

2338 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tDoRecov”y
, 
	tWa™LoÿlRecov”yRe£rved
 >,

2339 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tDeãrRecov”y
 >,

2340 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tUnfoundRecov”y
 >

2341 > 
	t»aùiÚs
;

2342 
ex¶ic™
 
	`NÙRecov”šg
(
my_cÚ‹xt
 
ùx
);

2343 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
DeãrRecov”y
& 
evt
) {

2345  
	`disÿrd_ev’t
();

2347 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
UnfoundRecov”y
& 
evt
) {

2349  
	`disÿrd_ev’t
();

2351 
	`ex™
();

2354 
ToD–‘e
;

2355 
R•NÙRecov”šg
;

2356 
R•liÿAùive
 : 
boo¡
::
¡©ech¬t
::
¡©e
< R•liÿAùive, 
S¹ed
, 
R•NÙRecov”šg
 >, 
NamedS‹
 {

2357 
ex¶ic™
 
	`R•liÿAùive
(
my_cÚ‹xt
 
ùx
);

2358 
	`ex™
();

2360 
boo¡
::
	tm¶
::
	tli¡
 <

2361 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tQu”yS‹
 >,

2362 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tAùM­
 >,

2363 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMQu”y
 >,

2364 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMInfoRec
 >,

2365 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMLogRec
 >,

2366 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMTrim
 >,

2367 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tAùiv©e
 >,

2368 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tDeãrRecov”y
 >,

2369 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tDeãrBackfl
 >,

2370 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tUnfoundRecov”y
 >,

2371 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tUnfoundBackfl
 >,

2372 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeBackflP»em±ed
 >,

2373 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeRecov”yP»em±ed
 >,

2374 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRecov”yDÚe
 >,

2375 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
<
	tD–‘eS¹
, 
	tToD–‘e
>

2376 > 
	t»aùiÚs
;

2377 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Qu”yS‹
& 
q
);

2378 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MInfoRec
& 
šfÛvt
);

2379 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MLogRec
& 
logevt
);

2380 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MTrim
& 
Œimevt
);

2381 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
AùM­
&);

2382 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MQu”y
&);

2383 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Aùiv©e
&);

2384 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Recov”yDÚe
&) {

2385  
	`disÿrd_ev’t
();

2387 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
DeãrRecov”y
& 
evt
) {

2388  
	`disÿrd_ev’t
();

2390 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
DeãrBackfl
& 
evt
) {

2391  
	`disÿrd_ev’t
();

2393 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
UnfoundRecov”y
& 
evt
) {

2394  
	`disÿrd_ev’t
();

2396 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
UnfoundBackfl
& 
evt
) {

2397  
	`disÿrd_ev’t
();

2399 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeBackflP»em±ed
& 
evt
) {

2400  
	`disÿrd_ev’t
();

2402 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeRecov”yP»em±ed
& 
evt
) {

2403  
	`disÿrd_ev’t
();

2407 
R•Recov”šg
 : 
boo¡
::
¡©ech¬t
::
¡©e
< R•Recov”šg, 
R•liÿAùive
 >, 
NamedS‹
 {

2408 
boo¡
::
	tm¶
::
	tli¡
<

2409 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tRecov”yDÚe
, 
	tR•NÙRecov”šg
 >,

2411 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tRemÙeRe£rv©iÚRejeùed
, 
	tR•NÙRecov”šg
 >,

2412 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tRemÙeRe£rv©iÚCªûËd
, 
	tR•NÙRecov”šg
 >,

2413 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tBackflTooFuÎ
 >,

2414 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeRecov”yP»em±ed
 >,

2415 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeBackflP»em±ed
 >

2416 > 
	t»aùiÚs
;

2417 
ex¶ic™
 
	`R•Recov”šg
(
my_cÚ‹xt
 
ùx
);

2418 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeRecov”yP»em±ed
 &
evt
);

2419 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
BackflTooFuÎ
 &
evt
);

2420 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeBackflP»em±ed
 &
evt
);

2421 
	`ex™
();

2424 
R•Wa™BackflRe£rved
 : 
boo¡
::
¡©ech¬t
::
¡©e
< R•Wa™BackflRe£rved, 
R•liÿAùive
 >, 
NamedS‹
 {

2425 
boo¡
::
	tm¶
::
	tli¡
<

2426 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeBackflRe£rved
 >,

2427 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRejeùRemÙeRe£rv©iÚ
 >,

2428 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeRe£rv©iÚRejeùed
 >,

2429 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeRe£rv©iÚCªûËd
 >,

2430 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRecov”yDÚe
 >

2431 > 
	t»aùiÚs
;

2432 
ex¶ic™
 
	`R•Wa™BackflRe£rved
(
my_cÚ‹xt
 
ùx
);

2433 
	`ex™
();

2434 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeBackflRe£rved
 &
evt
);

2435 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RejeùRemÙeRe£rv©iÚ
 &
evt
);

2436 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeRe£rv©iÚRejeùed
 &
evt
);

2437 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeRe£rv©iÚCªûËd
 &
evt
);

2438 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Recov”yDÚe
&);

2441 
R•Wa™Recov”yRe£rved
 : 
boo¡
::
¡©ech¬t
::
¡©e
< R•Wa™Recov”yRe£rved, 
R•liÿAùive
 >, 
NamedS‹
 {

2442 
boo¡
::
	tm¶
::
	tli¡
<

2443 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeRecov”yRe£rved
 >,

2445 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeRe£rv©iÚRejeùed
 >,

2446 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeRe£rv©iÚCªûËd
 >

2447 > 
	t»aùiÚs
;

2448 
ex¶ic™
 
	`R•Wa™Recov”yRe£rved
(
my_cÚ‹xt
 
ùx
);

2449 
	`ex™
();

2450 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeRecov”yRe£rved
 &
evt
);

2451 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeRe£rv©iÚRejeùed
 &
evt
) {

2453 
	`po¡_ev’t
(
	`RemÙeRe£rv©iÚCªûËd
());

2454  
	`disÿrd_ev’t
();

2456 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeRe£rv©iÚCªûËd
 &
evt
);

2459 
R•NÙRecov”šg
 : 
boo¡
::
¡©ech¬t
::
¡©e
< R•NÙRecov”šg, 
R•liÿAùive
>, 
NamedS‹
 {

2460 
boo¡
::
	tm¶
::
	tli¡
<

2461 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tReque¡Recov”yPrio
 >,

2462 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tReque¡BackflPrio
 >,

2463 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRejeùRemÙeRe£rv©iÚ
 >,

2464 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tRemÙeRe£rv©iÚRejeùed
, 
	tR•NÙRecov”šg
 >,

2465 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tRemÙeRe£rv©iÚCªûËd
, 
	tR•NÙRecov”šg
 >,

2466 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeRecov”yRe£rved
 >,

2467 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeBackflRe£rved
 >,

2468 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tRecov”yDÚe
, 
	tR•NÙRecov”šg
 >

2469 > 
	t»aùiÚs
;

2470 
ex¶ic™
 
	`R•NÙRecov”šg
(
my_cÚ‹xt
 
ùx
);

2471 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Reque¡Recov”yPrio
 &
evt
);

2472 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Reque¡BackflPrio
 &
evt
);

2473 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeBackflRe£rved
 &
evt
) {

2475  
	`disÿrd_ev’t
();

2477 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeRecov”yRe£rved
 &
evt
) {

2479  
	`disÿrd_ev’t
();

2481 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RejeùRemÙeRe£rv©iÚ
 &
evt
);

2482 
	`ex™
();

2485 
Recov”šg
 : 
boo¡
::
¡©ech¬t
::
¡©e
< Recov”šg, 
Aùive
 >, 
NamedS‹
 {

2486 
boo¡
::
	tm¶
::
	tli¡
 <

2487 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tAÎR•liÿsRecov”ed
 >,

2488 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tDeãrRecov”y
 >,

2489 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tUnfoundRecov”y
 >,

2490 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tReque¡Backfl
 >

2491 > 
	t»aùiÚs
;

2492 
ex¶ic™
 
	`Recov”šg
(
my_cÚ‹xt
 
ùx
);

2493 
	`ex™
();

2494 
	`»Ëa£_»£rv©iÚs
(
boŞ
 
ÿnûl
 = 
çl£
);

2495 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
AÎR•liÿsRecov”ed
 &
evt
);

2496 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
DeãrRecov”y
& 
evt
);

2497 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
UnfoundRecov”y
& 
evt
);

2498 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Reque¡Backfl
 &
evt
);

2501 
Wa™RemÙeRecov”yRe£rved
 : 
boo¡
::
¡©ech¬t
::
¡©e
< Wa™RemÙeRecov”yRe£rved, 
Aùive
 >, 
NamedS‹
 {

2502 
boo¡
::
	tm¶
::
	tli¡
 <

2503 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRemÙeRecov”yRe£rved
 >,

2504 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tAÎRemÙesRe£rved
, 
	tRecov”šg
 >

2505 > 
	t»aùiÚs
;

2506 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
»mÙe_»cov”y_»£rv©iÚ_™
;

2507 
ex¶ic™
 
	`Wa™RemÙeRecov”yRe£rved
(
my_cÚ‹xt
 
ùx
);

2508 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
RemÙeRecov”yRe£rved
 &
evt
);

2509 
	`ex™
();

2512 
Wa™LoÿlRecov”yRe£rved
 : 
boo¡
::
¡©ech¬t
::
¡©e
< Wa™LoÿlRecov”yRe£rved, 
Aùive
 >, 
NamedS‹
 {

2513 
boo¡
::
	tm¶
::
	tli¡
 <

2514 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tLoÿlRecov”yRe£rved
, 
	tWa™RemÙeRecov”yRe£rved
 >,

2515 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRecov”yTooFuÎ
 >

2516 > 
	t»aùiÚs
;

2517 
ex¶ic™
 
	`Wa™LoÿlRecov”yRe£rved
(
my_cÚ‹xt
 
ùx
);

2518 
	`ex™
();

2519 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Recov”yTooFuÎ
 &
evt
);

2522 
Aùiv©šg
 : 
boo¡
::
¡©ech¬t
::
¡©e
< Aùiv©šg, 
Aùive
 >, 
NamedS‹
 {

2523 
boo¡
::
	tm¶
::
	tli¡
 <

2524 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tAÎR•liÿsRecov”ed
, 
	tRecov”ed
 >,

2525 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tDoRecov”y
, 
	tWa™LoÿlRecov”yRe£rved
 >,

2526 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tReque¡Backfl
, 
	tWa™LoÿlBackflRe£rved
 >

2527 > 
	t»aùiÚs
;

2528 
ex¶ic™
 
	`Aùiv©šg
(
my_cÚ‹xt
 
ùx
);

2529 
	`ex™
();

2532 
SŒay
 : 
boo¡
::
¡©ech¬t
::
¡©e
< SŒay, 
S¹ed
 >,

2533 
NamedS‹
 {

2534 
ex¶ic™
 
	`SŒay
(
my_cÚ‹xt
 
ùx
);

2535 
	`ex™
();

2537 
boo¡
::
	tm¶
::
	tli¡
 <

2538 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMQu”y
 >,

2539 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMLogRec
 >,

2540 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMInfoRec
 >,

2541 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tAùM­
 >,

2542 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tRecov”yDÚe
 >,

2543 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
<
	tD–‘eS¹
, 
	tToD–‘e
>

2544 > 
	t»aùiÚs
;

2545 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MQu”y
& 
qu”y
);

2546 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MLogRec
& 
logevt
);

2547 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MInfoRec
& 
šfÛvt
);

2548 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
AùM­
&);

2549 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Recov”yDÚe
&) {

2550  
	`disÿrd_ev’t
();

2554 
Wa™D–‘eRe£rved
;

2555 
ToD–‘e
 : 
boo¡
::
¡©ech¬t
::
¡©e
<ToD–‘e, 
S¹ed
, 
Wa™D–‘eRe£rved
>, 
NamedS‹
 {

2556 
´iÜ™y
 = 0;

2557 
boo¡
::
	tm¶
::
	tli¡
 <

2558 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tAùM­
 >,

2559 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tD–‘eSome
 >

2560 > 
	t»aùiÚs
;

2561 
ex¶ic™
 
	`ToD–‘e
(
my_cÚ‹xt
 
ùx
);

2562 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
AùM­
 &
evt
);

2563 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
D–‘eSome
 &
evt
) {

2565  
	`disÿrd_ev’t
();

2567 
	`ex™
();

2570 
D–‘šg
;

2571 
Wa™D–‘eRe£rved
 : 
boo¡
::
¡©ech¬t
::
¡©e
<WaitDeleteReserved,

2572 
ToD–‘e
>, 
NamedS‹
 {

2573 
boo¡
::
	tm¶
::
	tli¡
 <

2574 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
<
	tD–‘eRe£rved
, 
	tD–‘šg
>

2575 > 
	t»aùiÚs
;

2576 
ex¶ic™
 
	`Wa™D–‘eRe£rved
(
my_cÚ‹xt
 
ùx
);

2577 
	`ex™
();

2580 
D–‘šg
 : 
boo¡
::
¡©ech¬t
::
¡©e
<Deleting,

2581 
ToD–‘e
>, 
NamedS‹
 {

2582 
boo¡
::
	tm¶
::
	tli¡
 <

2583 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tD–‘eSome
 >,

2584 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
<
	tD–‘eIÁ”ru±ed
, 
	tWa™D–‘eRe£rved
>

2585 > 
	t»aùiÚs
;

2586 
ex¶ic™
 
	`D–‘šg
(
my_cÚ‹xt
 
ùx
);

2587 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
D–‘eSome
 &
evt
);

2588 
	`ex™
();

2591 
G‘Log
;

2593 
G‘Info
 : 
boo¡
::
¡©ech¬t
::
¡©e
< G‘Info, 
P“ršg
 >, 
NamedS‹
 {

2594 
£t
<
pg_sh¬d_t
> 
³”_šfo_»que¡ed
;

2596 
ex¶ic™
 
	`G‘Info
(
my_cÚ‹xt
 
ùx
);

2597 
	`ex™
();

2598 
	`g‘_šfos
();

2600 
boo¡
::
	tm¶
::
	tli¡
 <

2601 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tQu”yS‹
 >,

2602 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tGÙInfo
, 
	tG‘Log
 >,

2603 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMNÙifyRec
 >,

2604 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tIsDown
, 
	tDown
 >

2605 > 
	t»aùiÚs
;

2606 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Qu”yS‹
& 
q
);

2607 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MNÙifyRec
& 
šfÛvt
);

2610 
GÙLog
 : 
boo¡
::
¡©ech¬t
::
ev’t
< GotLog > {

2611 
	`GÙLog
(è: 
boo¡
::
¡©ech¬t
::
ev’t
< 
GÙLog
 >() {}

2614 
G‘Log
 : 
boo¡
::
¡©ech¬t
::
¡©e
< G‘Log, 
P“ršg
 >, 
NamedS‹
 {

2615 
pg_sh¬d_t
 
auth_log_sh¬d
;

2616 
boo¡
::
šŒusive_±r
<
MOSDPGLog
> 
msg
;

2618 
ex¶ic™
 
	`G‘Log
(
my_cÚ‹xt
 
ùx
);

2619 
	`ex™
();

2621 
boo¡
::
	tm¶
::
	tli¡
 <

2622 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tQu”yS‹
 >,

2623 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMLogRec
 >,

2624 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tGÙLog
 >,

2625 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tAdvM­
 >,

2626 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tIsIncom¶‘e
, 
	tIncom¶‘e
 >

2627 > 
	t»aùiÚs
;

2628 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
AdvM­
&);

2629 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Qu”yS‹
& 
q
);

2630 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MLogRec
& 
logevt
);

2631 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
GÙLog
&);

2634 
Wa™UpThru
;

2636 
G‘Missšg
 : 
boo¡
::
¡©ech¬t
::
¡©e
< G‘Missšg, 
P“ršg
 >, 
NamedS‹
 {

2637 
£t
<
pg_sh¬d_t
> 
³”_missšg_»que¡ed
;

2639 
ex¶ic™
 
	`G‘Missšg
(
my_cÚ‹xt
 
ùx
);

2640 
	`ex™
();

2642 
boo¡
::
	tm¶
::
	tli¡
 <

2643 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tQu”yS‹
 >,

2644 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMLogRec
 >,

2645 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tN“dUpThru
, 
	tWa™UpThru
 >

2646 > 
	t»aùiÚs
;

2647 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Qu”yS‹
& 
q
);

2648 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MLogRec
& 
logevt
);

2651 
Wa™UpThru
 : 
boo¡
::
¡©ech¬t
::
¡©e
< Wa™UpThru, 
P“ršg
 >, 
NamedS‹
 {

2652 
ex¶ic™
 
	`Wa™UpThru
(
my_cÚ‹xt
 
ùx
);

2653 
	`ex™
();

2655 
boo¡
::
	tm¶
::
	tli¡
 <

2656 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tQu”yS‹
 >,

2657 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tAùM­
 >,

2658 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMLogRec
 >

2659 > 
	t»aùiÚs
;

2660 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Qu”yS‹
& 
q
);

2661 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
AùM­
& 
am
);

2662 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MLogRec
& 
log»c
);

2665 
Down
 : 
boo¡
::
¡©ech¬t
::
¡©e
< Down, 
P“ršg
>, 
NamedS‹
 {

2666 
ex¶ic™
 
	`Down
(
my_cÚ‹xt
 
ùx
);

2667 
boo¡
::
	tm¶
::
	tli¡
 <

2668 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tQu”yS‹
 >,

2669 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMNÙifyRec
 >

2670 > 
	t»aùiÚs
;

2671 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Qu”yS‹
& 
q
);

2672 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MNÙifyRec
& 
šfÛvt
);

2673 
	`ex™
();

2676 
Incom¶‘e
 : 
boo¡
::
¡©ech¬t
::
¡©e
< Incom¶‘e, 
P“ršg
>, 
NamedS‹
 {

2677 
boo¡
::
	tm¶
::
	tli¡
 <

2678 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tAdvM­
 >,

2679 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tMNÙifyRec
 >,

2680 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tQu”yS‹
 >

2681 > 
	t»aùiÚs
;

2682 
ex¶ic™
 
	`Incom¶‘e
(
my_cÚ‹xt
 
ùx
);

2683 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
AdvM­
 &
advm­
);

2684 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
MNÙifyRec
& 
šfÛvt
);

2685 
boo¡
::
¡©ech¬t
::
»suÉ
 
	`»aù
(cÚ¡ 
Qu”yS‹
& 
q
);

2686 
	`ex™
();

2689 
Recov”yMachše
 
machše
;

2690 
PG
 *
pg
;

2693 
Recov”yCtx
 *
Üig_ùx
;

2696 
boo¡
::
İtiÚ®
<
Bufã»dRecov”yMes§ges
> 
mes§ges_³ndšg_æush
;

2703 
boo¡
::
İtiÚ®
<
Recov”yCtx
> 
rùx
;

2705 
public
:

2706 
ex¶ic™
 
	`Recov”yS‹
(
PG
 *
pg
)

2707 : 
	`machše
(
this
, 
pg
), 
	`pg
Õg), 
	`Üig_ùx
(0) {

2708 
machše
.
	`š™Ÿ‹
();

2711 
	`hªdË_ev’t
(cÚ¡ 
boo¡
::
¡©ech¬t
::
ev’t_ba£
 &
evt
,

2712 
Recov”yCtx
 *
rùx
) {

2713 
	`¡¬t_hªdË
(
rùx
);

2714 
machše
.
	`´oûss_ev’t
(
evt
);

2715 
	`’d_hªdË
();

2718 
	`hªdË_ev’t
(
PGP“ršgEv’tRef
 
evt
,

2719 
Recov”yCtx
 *
rùx
) {

2720 
	`¡¬t_hªdË
(
rùx
);

2721 
machše
.
	`´oûss_ev’t
(
evt
->
	`g‘_ev’t
());

2722 
	`’d_hªdË
();

2725 
	}
} 
	g»cov”y_¡©e
;

2729 
ušt64_t
 
	g³”_ã©u»s
;

2730 
ušt64_t
 
	gaùšg_ã©u»s
;

2731 
ušt64_t
 
	gu·ùšg_ã©u»s
;

2733 
•och_t
 
	gÏ¡_•och
;

2736 
	gÏ¡_»quœe_osd_»Ëa£
 = 0;

2738 
	g´Ùeùed
:

2739 
	$»£t_mš_³”_ã©u»s
() {

2740 
³”_ã©u»s
 = 
CEPH_FEATURES_SUPPORTED_DEFAULT
;

2741 
	}
}

2742 
ušt64_t
 
	$g‘_mš_³”_ã©u»s
(ècÚ¡ {  
³”_ã©u»s
; 
	}
}

2743 
	$­¶y_³”_ã©u»s
(
ušt64_t
 
f
è{ 
³”_ã©u»s
 &ğf; 
	}
}

2745 
ušt64_t
 
	$g‘_mš_aùšg_ã©u»s
(ècÚ¡ {  
aùšg_ã©u»s
; 
	}
}

2746 
ušt64_t
 
	$g‘_mš_u·ùšg_ã©u»s
(ècÚ¡ {  
u·ùšg_ã©u»s
; 
	}
}

2747 
boŞ
 
	$³rfÜm_d–‘es_duršg_³”šg
() const {

2748  !(
	`g‘_osdm­
()->
	`‹¡_æag
(
CEPH_OSDMAP_RECOVERY_DELETES
));

2749 
	}
}

2751 
š™_´im¬y_up_aùšg
(

2752 cÚ¡ 
veùÜ
<> &
Ãwup
,

2753 cÚ¡ 
veùÜ
<> &
Ãwaùšg
,

2754 
Ãw_up_´im¬y
,

2755 
Ãw_aùšg_´im¬y
) {

2756 
	gaùšg£t
.
ş—r
();

2757 
	gaùšg
 = 
Ãwaùšg
;

2758 
ušt8_t
 
	gi
 = 0; i < 
	gaùšg
.
size
(); ++i) {

2759 ià(
	gaùšg
[
i
] !ğ
CRUSH_ITEM_NONE
)

2760 
aùšg£t
.
š£¹
(

2761 
pg_sh¬d_t
(

2762 
aùšg
[
i
],

2763 
poŞ
.
šfo
.
is_”asu»
(è? 
sh¬d_id_t
(
i
è: sh¬d_id_t::
NO_SHARD
));

2765 
	gup£t
.
ş—r
();

2766 
	gup
 = 
Ãwup
;

2767 
ušt8_t
 
	gi
 = 0; i < 
	gup
.
size
(); ++i) {

2768 ià(
	gup
[
i
] !ğ
CRUSH_ITEM_NONE
)

2769 
up£t
.
š£¹
(

2770 
pg_sh¬d_t
(

2771 
up
[
i
],

2772 
poŞ
.
šfo
.
is_”asu»
(è? 
sh¬d_id_t
(
i
è: sh¬d_id_t::
NO_SHARD
));

2774 ià(!
	gpoŞ
.
	gšfo
.
is_”asu»
()) {

2775 
	gup_´im¬y
 = 
pg_sh¬d_t
(
Ãw_up_´im¬y
, 
sh¬d_id_t
::
NO_SHARD
);

2776 
	g´im¬y
 = 
pg_sh¬d_t
(
Ãw_aùšg_´im¬y
, 
sh¬d_id_t
::
NO_SHARD
);

2779 
	gup_´im¬y
 = 
pg_sh¬d_t
();

2780 
	g´im¬y
 = 
pg_sh¬d_t
();

2781 
ušt8_t
 
	gi
 = 0; i < 
	gup
.
size
(); ++i) {

2782 ià(
	gup
[
i
] =ğ
Ãw_up_´im¬y
) {

2783 
up_´im¬y
 = 
pg_sh¬d_t
(
up
[
i
], 
sh¬d_id_t
(i));

2787 
ušt8_t
 
	gi
 = 0; i < 
	gaùšg
.
size
(); ++i) {

2788 ià(
	gaùšg
[
i
] =ğ
Ãw_aùšg_´im¬y
) {

2789 
´im¬y
 = 
pg_sh¬d_t
(
aùšg
[
i
], 
sh¬d_id_t
(i));

2793 
as£¹
(
up_´im¬y
.
osd
 =ğ
Ãw_up_´im¬y
);

2794 
as£¹
(
´im¬y
.
osd
 =ğ
Ãw_aùšg_´im¬y
);

2797 
	$£t_rŞe
(
r
) {

2798 
rŞe
 = 
r
;

2799 
	}
}

2801 
boŞ
 
	$¡©e_‹¡
(
ušt64_t
 
m
ècÚ¡ {  (
¡©e
 & mè!ğ0; 
	}
}

2802 
	$¡©e_£t
(
ušt64_t
 
m
è{ 
¡©e
 |ğm; 
	}
}

2803 
	$¡©e_ş—r
(
ušt64_t
 
m
è{ 
¡©e
 &ğ~m; 
	}
}

2805 
boŞ
 
	$is_com¶‘e
(ècÚ¡ {  
šfo
.
Ï¡_com¶‘e
 =ğšfo.
Ï¡_upd©e
; 
	}
}

2806 
boŞ
 
	$should_£nd_nÙify
(ècÚ¡ {  
£nd_nÙify
; 
	}
}

2808 
	$g‘_¡©e
(ècÚ¡ {  
¡©e
; 
	}
}

2809 
boŞ
 
	$is_aùive
(ècÚ¡ {  
	`¡©e_‹¡
(
PG_STATE_ACTIVE
); 
	}
}

2810 
boŞ
 
	$is_aùiv©šg
(ècÚ¡ {  
	`¡©e_‹¡
(
PG_STATE_ACTIVATING
); 
	}
}

2811 
boŞ
 
	$is_³”šg
(ècÚ¡ {  
	`¡©e_‹¡
(
PG_STATE_PEERING
); 
	}
}

2812 
boŞ
 
	$is_down
(ècÚ¡ {  
	`¡©e_‹¡
(
PG_STATE_DOWN
); 
	}
}

2813 
boŞ
 
	$is_»cov”y_unfound
(ècÚ¡ {  
	`¡©e_‹¡
(
PG_STATE_RECOVERY_UNFOUND
); 
	}
}

2814 
boŞ
 
	$is_backfl_unfound
(ècÚ¡ {  
	`¡©e_‹¡
(
PG_STATE_BACKFILL_UNFOUND
); 
	}
}

2815 
boŞ
 
	$is_šcom¶‘e
(ècÚ¡ {  
	`¡©e_‹¡
(
PG_STATE_INCOMPLETE
); 
	}
}

2816 
boŞ
 
	$is_ş—n
(ècÚ¡ {  
	`¡©e_‹¡
(
PG_STATE_CLEAN
); 
	}
}

2817 
boŞ
 
	$is_deg¿ded
(ècÚ¡ {  
	`¡©e_‹¡
(
PG_STATE_DEGRADED
); 
	}
}

2818 
boŞ
 
	$is_und”sized
(ècÚ¡ {  
	`¡©e_‹¡
(
PG_STATE_UNDERSIZED
); 
	}
}

2819 
boŞ
 
	$is_süubbšg
(ècÚ¡ {  
	`¡©e_‹¡
(
PG_STATE_SCRUBBING
); 
	}
}

2820 
boŞ
 
	$is_»m­³d
(ècÚ¡ {  
	`¡©e_‹¡
(
PG_STATE_REMAPPED
); 
	}
}

2821 
boŞ
 
	$is_³”ed
() const {

2822  
	`¡©e_‹¡
(
PG_STATE_ACTIVE
è|| s‹_‹¡(
PG_STATE_PEERED
);

2823 
	}
}

2824 
boŞ
 
	$is_»cov”šg
(ècÚ¡ {  
	`¡©e_‹¡
(
PG_STATE_RECOVERING
); 
	}
}

2826 
boŞ
 
	$is_em±y
(ècÚ¡ {  
šfo
.
Ï¡_upd©e
 =ğ
	`ev”siÚ_t
(0,0); 
	}
}

2829 
do_³ndšg_æush
();

2831 
	gpublic
:

2832 
_ü—‹
(
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
, 
¥g_t
 
pgid
, 
b™s
);

2833 
_š™
(
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
,

2834 
¥g_t
 
pgid
, cÚ¡ 
pg_poŞ_t
 *
poŞ
);

2836 
	g´Ùeùed
:

2837 
´•¬e_wr™e_šfo
(
m­
<
¡ršg
,
bufã¾i¡
> *
km
);

2839 
upd©e_¡Üe_w™h_İtiÚs
();

2841 
	gpublic
:

2842 
_´•¬e_wr™e_šfo
(

2843 
C•hCÚ‹xt
* 
cù
,

2844 
m­
<
¡ršg
,
bufã¾i¡
> *
km
,

2845 
•och_t
 
•och
,

2846 
pg_šfo_t
 &
šfo
,

2847 
pg_šfo_t
 &
Ï¡_wr™‹n_šfo
,

2848 
Pa¡IÁ”v®s
 &
·¡_š‹rv®s
,

2849 
boŞ
 
dœty_big_šfo
,

2850 
boŞ
 
dœty_•och
,

2851 
boŞ
 
Œy_ç¡_šfo
,

2852 
P”fCouÁ”s
 *
logg”
 = 
nuÎ±r
);

2853 
	g´Ùeùed
:

2854 
wr™e_if_dœty
(
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
);

2856 
	gPGLog
::
IndexedLog
 
´ojeùed_log
;

2857 
boŞ
 
	$check_š_´og»ss_İ
(

2858 cÚ¡ 
osd_»qid_t
 &
r
,

2859 
ev”siÚ_t
 *
v”siÚ
,

2860 
v”siÚ_t
 *
u£r_v”siÚ
,

2861 *
»tuº_code
) const;

2862 
ev”siÚ_t
 
´ojeùed_Ï¡_upd©e
;

2863 
ev”siÚ_t
 
	$g‘_Ãxt_v”siÚ
() const {

2864 
ev”siÚ_t
 
	`©_v”siÚ
(

2865 
	`g‘_osdm­
()->
	`g‘_•och
(),

2866 
´ojeùed_Ï¡_upd©e
.
v”siÚ
+1);

2867 
	`as£¹
(
©_v”siÚ
 > 
šfo
.
Ï¡_upd©e
);

2868 
	`as£¹
(
©_v”siÚ
 > 
pg_log
.
	`g‘_h—d
());

2869 
	`as£¹
(
©_v”siÚ
 > 
´ojeùed_Ï¡_upd©e
);

2870  
©_v”siÚ
;

2871 
	}
}

2873 
add_log_’Œy
(cÚ¡ 
pg_log_’Œy_t
& 
e
, 
boŞ
 
­¶›d
);

2874 
­³nd_log
(

2875 cÚ¡ 
veùÜ
<
pg_log_’Œy_t
>& 
logv
,

2876 
ev”siÚ_t
 
Œim_to
,

2877 
ev”siÚ_t
 
rŞl_fÜw¬d_to
,

2878 
ObjeùStÜe
::
T¿n§ùiÚ
 &
t
,

2879 
boŞ
 
Œª§ùiÚ_­¶›d
 = 
Œue
);

2880 
boŞ
 
check_log_fÜ_cÜru±iÚ
(
ObjeùStÜe
 *
¡Üe
);

2881 
Œim_log
();

2883 
	g¡d
::
¡ršg
 
	$g‘_cÜru±_pg_log_Çme
() const;

2885 
	`upd©e_¢­_m­
(

2886 cÚ¡ 
veùÜ
<
pg_log_’Œy_t
> &
log_’Œ›s
,

2887 
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
);

2889 
	`f‹r_¢­c
(
veùÜ
<
¢­id_t
> &
¢­s
);

2891 
	`log_weœdÃss
();

2893 
vœtu®
 
	`kick_¢­_Œim
() = 0;

2894 
vœtu®
 
	`¢­_Œimm”_süub_com¶‘e
() = 0;

2895 
boŞ
 
	`»queue_süub
(boŞ 
high_´iÜ™y
 = 
çl£
);

2896 
	`queue_»cov”y
();

2897 
boŞ
 
	`queue_süub
();

2898 
	`g‘_süub_´iÜ™y
();

2901 
	`sh¬e_pg_šfo
();

2904 
boŞ
 
	`­³nd_log_’Œ›s_upd©e_missšg
(

2905 cÚ¡ 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> &
’Œ›s
,

2906 
ObjeùStÜe
::
T¿n§ùiÚ
 &
t
,

2907 
boo¡
::
İtiÚ®
<
ev”siÚ_t
> 
Œim_to
,

2908 
boo¡
::
İtiÚ®
<
ev”siÚ_t
> 
rŞl_fÜw¬d_to
);

2914 
	`m”ge_Ãw_log_’Œ›s
(

2915 cÚ¡ 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> &
’Œ›s
,

2916 
ObjeùStÜe
::
T¿n§ùiÚ
 &
t
,

2917 
boo¡
::
İtiÚ®
<
ev”siÚ_t
> 
Œim_to
,

2918 
boo¡
::
İtiÚ®
<
ev”siÚ_t
> 
rŞl_fÜw¬d_to
);

2920 
	`»£t_š‹rv®_æush
();

2921 
	`¡¬t_³”šg_š‹rv®
(

2922 cÚ¡ 
OSDM­Ref
 
Ï¡m­
,

2923 cÚ¡ 
veùÜ
<>& 
Ãwup
, 
up_´im¬y
,

2924 cÚ¡ 
veùÜ
<>& 
Ãwaùšg
, 
aùšg_´im¬y
,

2925 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

2926 
	`Ú_Ãw_š‹rv®
();

2927 
vœtu®
 
	`_Ú_Ãw_š‹rv®
() = 0;

2928 
	`¡¬t_æush
(
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

2929 
	`£t_Ï¡_³”šg_»£t
();

2931 
	`upd©e_hi¡Üy
(cÚ¡ 
pg_hi¡Üy_t
& 
hi¡Üy
);

2932 
	`fulfl_šfo
(
pg_sh¬d_t
 
äom
, cÚ¡ 
pg_qu”y_t
 &
qu”y
,

2933 
·œ
<
pg_sh¬d_t
, 
pg_šfo_t
> &
nÙify_šfo
);

2934 
	`fulfl_log
(
pg_sh¬d_t
 
äom
, cÚ¡ 
pg_qu”y_t
 &
qu”y
, 
•och_t
 
qu”y_•och
);

2936 
	`check_fuÎ_Œªs™iÚ
(
OSDM­Ref
 
Ï¡m­
, OSDM­Reà
osdm­
);

2938 
boŞ
 
	`should_»¡¬t_³”šg
(

2939 
Ãwuµrim¬y
,

2940 
Ãwaùšg´im¬y
,

2941 cÚ¡ 
veùÜ
<>& 
Ãwup
,

2942 cÚ¡ 
veùÜ
<>& 
Ãwaùšg
,

2943 
OSDM­Ref
 
Ï¡m­
,

2944 
OSDM­Ref
 
osdm­
);

2947 
boŞ
 
	`ÿn_disÿrd_İ
(
OpReque¡Ref
& 
İ
);

2948 
boŞ
 
	`ÿn_disÿrd_sÿn
(
OpReque¡Ref
 
İ
);

2949 
boŞ
 
	`ÿn_disÿrd_backfl
(
OpReque¡Ref
 
İ
);

2950 
boŞ
 
	`ÿn_disÿrd_»que¡
(
OpReque¡Ref
& 
İ
);

2952 
‹m¶©e
<
ty³Çme
 
T
, 
MSGTYPE
>

2953 
boŞ
 
	`ÿn_disÿrd_»¶iÿ_İ
(
OpReque¡Ref
& 
İ
);

2955 
boŞ
 
	`Şd_³”šg_msg
(
•och_t
 
»¶y_•och
,ƒpoch_ˆ
qu”y_•och
);

2956 
boŞ
 
	$Şd_³”šg_evt
(
PGP“ršgEv’tRef
 
evt
) {

2957  
	`Şd_³”šg_msg
(
evt
->
	`g‘_•och_£Á
(),ƒvt->
	`g‘_•och_»que¡ed
());

2958 
	}
}

2959 
boŞ
 
	$have_§me_Ü_Ãw”_m­
(
•och_t
 
cur_•och
,ƒpoch_ˆ
e
) {

2960  
e
 <ğ
cur_•och
;

2961 
	}
}

2962 
boŞ
 
	$have_§me_Ü_Ãw”_m­
(
•och_t
 
e
) {

2963  
e
 <ğ
	`g‘_osdm­
()->
	`g‘_•och
();

2964 
	}
}

2966 
boŞ
 
İ_has_suffic›Á_ÿps
(
OpReque¡Ref
& 
İ
);

2970 
ke_wa™”s
();

2974 
ä›nd
 
şass
 
	gFlushS‹
;

2976 
vœtu®
 
Ú_rŞe_chªge
() = 0;

2977 
vœtu®
 
Ú_poŞ_chªge
() = 0;

2978 
vœtu®
 
Ú_chªge
(
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
) = 0;

2979 
vœtu®
 
Ú_aùiv©e
() = 0;

2980 
vœtu®
 
Ú_æushed
() = 0;

2981 
vœtu®
 
check_bÏckli¡ed_w©ch”s
() = 0;

2983 
ä›nd
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gPG
& 
	gpg
);

2987 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gPG
::
BackflIÁ”v®
& 
bi
);

	@osd/PGBackend.cc

19 
	~"commÚ/”ºo.h
"

20 
	~"commÚ/süub_ty³s.h
"

21 
	~"R•liÿ‹dBack’d.h
"

22 
	~"SüubStÜe.h
"

23 
	~"ECBack’d.h
"

24 
	~"PGBack’d.h
"

25 
	~"OSD.h
"

26 
	~"”asu»-code/E¿su»CodePlugš.h
"

27 
	~"OSDM­.h
"

28 
	~"PGLog.h
"

29 
	~"commÚ/LogCl›Á.h
"

30 
	~"mes§ges/MOSDPGRecov”yD–‘e.h
"

31 
	~"mes§ges/MOSDPGRecov”yD–‘eR•ly.h
"

33 
	#dout_cÚ‹xt
 
cù


	)

34 
	#dout_subsys
 
ûph_subsys_osd


	)

35 
	#DOUT_PREFIX_ARGS
 
this


	)

36 #undeà
dout_´efix


37 
	#dout_´efix
 
	`_´efix
(
_dout
, 
this
)

	)

38 
	go¡»am
& 
	$_´efix
(
¡d
::
o¡»am
 *
_dout
, 
PGBack’d
 *
pgb
) {

39  
pgb
->
	`g‘_·»Á
()->
	`g’_dbg_´efix
(*
_dout
);

40 
	}
}

42 
	gPGBack’d
::
	$»cov”_d–‘e_objeù
(cÚ¡ 
hobjeù_t
 &
oid
, 
ev”siÚ_t
 
v
,

43 
Recov”yHªdË
 *
h
)

45 
	`as£¹
(
	`g‘_·»Á
()->
	`g‘_aùšg_»cov”y_backfl_sh¬ds
().
	`size
() > 0);

46 cÚ¡‡uto& 
sh¬d
 : 
	`g‘_·»Á
()->
	`g‘_aùšg_»cov”y_backfl_sh¬ds
()) {

47 ià(
sh¬d
 =ğ
	`g‘_·»Á
()->
	`whßmi_sh¬d
())

49 ià(
	`g‘_·»Á
()->
	`g‘_sh¬d_missšg
(
sh¬d
).
	`is_missšg
(
oid
)) {

50 
	`dout
(20è<< 
__func__
 << " wÈ»mov" << 
oid
 << " " << 
v
 << " from "

51 << 
sh¬d
 << 
d’dl
;

52 
h
->
d–‘es
[
sh¬d
].
	`push_back
(
	`make_·œ
(
oid
, 
v
));

53 
	`g‘_·»Á
()->
	`begš_³”_»cov”
(
sh¬d
, 
oid
);

56 
	}
}

58 
	gPGBack’d
::
£nd_»cov”y_d–‘es
(
´io
,

59 cÚ¡ 
m­
<
pg_sh¬d_t
, 
veùÜ
<
·œ
<
hobjeù_t
, 
ev”siÚ_t
> > > &
d–‘es
)

61 
•och_t
 
	gmš_•och
 = 
g‘_·»Á
()->
g‘_Ï¡_³”šg_»£t_•och
();

62 cÚ¡‡uto& 
	gp
 : 
d–‘es
) {

63 cÚ¡‡uto& 
sh¬d
 = 
p
.
fœ¡
;

64 cÚ¡‡uto& 
	gobjeùs
 = 
p
.
£cÚd
;

65 
CÚÃùiÚRef
 
	gcÚ
 = 
g‘_·»Á
()->
g‘_cÚ_osd_şu¡”
(

66 
sh¬d
.
osd
,

67 
g‘_osdm­
()->
g‘_•och
());

68 ià(!
	gcÚ
)

70 autØ
	g™
 = 
objeùs
.
begš
();

71 
	g™
 !ğ
objeùs
.
’d
()) {

72 
ušt64_t
 
co¡
 = 0;

73 
ušt64_t
 
	gd–‘es
 = 0;

74 
¥g_t
 
	grg‘_pg
 = spg_t(
g‘_·»Á
()->
g‘_šfo
().
pgid
.pgid, 
sh¬d
.shard);

75 
MOSDPGRecov”yD–‘e
 *
	gmsg
 =

76 
Ãw
 
MOSDPGRecov”yD–‘e
(
g‘_·»Á
()->
whßmi_sh¬d
(),

77 
rg‘_pg
,

78 
g‘_osdm­
()->
g‘_•och
(),

79 
mš_•och
);

80 
	gmsg
->
£t_´iÜ™y
(
´io
);

82 
	g™
 !ğ
objeùs
.
’d
() &&

83 
co¡
 < 
cù
->
_cÚf
->
osd_max_push_co¡
 &&

84 
d–‘es
 < 
cù
->
_cÚf
->
osd_max_push_objeùs
) {

85 
dout
(20è<< 
__func__
 << ": s’dšg„ecov”y d–‘<< " << 
™
->
fœ¡


86 << " " << 
™
->
£cÚd
 << "Øosd." << 
sh¬d
 << 
d’dl
;

87 
	gmsg
->
	gobjeùs
.
push_back
(*
™
);

88 
	gco¡
 +ğ
cù
->
_cÚf
->
osd_push_³r_objeù_co¡
;

89 ++
	gd–‘es
;

90 ++
	g™
;

93 
	gmsg
->
£t_co¡
(
co¡
);

94 
g‘_·»Á
()->
£nd_mes§ge_osd_şu¡”
(
msg
, 
cÚ
);

99 
boŞ
 
	gPGBack’d
::
	$hªdË_mes§ge
(
OpReque¡Ref
 
İ
)

101 
İ
->
	`g‘_»q
()->
	`g‘_ty³
()) {

102 
MSG_OSD_PG_RECOVERY_DELETE
:

103 
	`hªdË_»cov”y_d–‘e
(
İ
);

104  
Œue
;

106 
MSG_OSD_PG_RECOVERY_DELETE_REPLY
:

107 
	`hªdË_»cov”y_d–‘e_»¶y
(
İ
);

108  
Œue
;

114  
	`_hªdË_mes§ge
(
İ
);

115 
	}
}

117 
	gPGBack’d
::
	$hªdË_»cov”y_d–‘e
(
OpReque¡Ref
 
İ
)

119 cÚ¡ 
MOSDPGRecov”yD–‘e
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDPGRecov”yD–‘*>(
İ
->
	`g‘_»q
());

120 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
MSG_OSD_PG_RECOVERY_DELETE
);

121 
	`dout
(20è<< 
__func__
 << " " << 
İ
 << 
d’dl
;

123 
İ
->
	`m¬k_¡¬‹d
();

125 
C_G©h”Bud”
 
	`g©h”
(
cù
);

126 cÚ¡‡utØ&
p
 : 
m
->
objeùs
) {

127 
	`g‘_·»Á
()->
	`»move_missšg_objeù
(
p
.
fœ¡
,….
£cÚd
, 
g©h”
.
	`Ãw_sub
());

130 
MOSDPGRecov”yD–‘eR•ly
 *
»¶y
 = 
Ãw
 MOSDPGRecoveryDeleteReply;

131 
»¶y
->
äom
 = 
	`g‘_·»Á
()->
	`whßmi_sh¬d
();

132 
»¶y
->
	`£t_´iÜ™y
(
m
->
	`g‘_´iÜ™y
());

133 
»¶y
->
pgid
 = 
	`¥g_t
(
	`g‘_·»Á
()->
	`g‘_šfo
().pgid.pgid, 
m
->
äom
.
sh¬d
);

134 
»¶y
->
m­_•och
 = 
m
->map_epoch;

135 
»¶y
->
mš_•och
 = 
m
->min_epoch;

136 
»¶y
->
objeùs
 = 
m
->objects;

137 
CÚÃùiÚRef
 
cÚn
 = 
m
->
	`g‘_cÚÃùiÚ
();

139 
g©h”
.
	`£t_fšish”
(
Ãw
 
	`FunùiÚCÚ‹xt
(

140 [=](
r
) {

141 ià(
r
 !ğ-
EAGAIN
) {

142 
	`g‘_·»Á
()->
	`£nd_mes§ge_osd_şu¡”
(
»¶y
, 
cÚn
.
	`g‘
());

144 
»¶y
->
	`put
();

147 
g©h”
.
	`aùiv©e
();

148 
	}
}

150 
	gPGBack’d
::
	$hªdË_»cov”y_d–‘e_»¶y
(
OpReque¡Ref
 
İ
)

152 cÚ¡ 
MOSDPGRecov”yD–‘eR•ly
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDPGRecov”yD–‘eR•ly *>(
İ
->
	`g‘_»q
());

153 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
MSG_OSD_PG_RECOVERY_DELETE_REPLY
);

154 
	`dout
(20è<< 
__func__
 << " " << 
İ
 << 
d’dl
;

156 cÚ¡‡utØ&
p
 : 
m
->
objeùs
) {

157 
ObjeùRecov”yInfo
 
»cov”y_šfo
;

158 
hobjeù_t
 
oid
 = 
p
.
fœ¡
;

159 
»cov”y_šfo
.
v”siÚ
 = 
p
.
£cÚd
;

160 
	`g‘_·»Á
()->
	`Ú_³”_»cov”
(
m
->
äom
, 
oid
, 
»cov”y_šfo
);

161 
boŞ
 
³”s_»cov”ed
 = 
Œue
;

162 cÚ¡‡uto& 
sh¬d
 : 
	`g‘_·»Á
()->
	`g‘_aùšg_»cov”y_backfl_sh¬ds
()) {

163 ià(
sh¬d
 =ğ
	`g‘_·»Á
()->
	`whßmi_sh¬d
())

165 ià(
	`g‘_·»Á
()->
	`g‘_sh¬d_missšg
(
sh¬d
).
	`is_missšg
(
oid
)) {

166 
	`dout
(20è<< 
__func__
 << " " << 
oid
 << " still missing on‡t†east "

167 << 
sh¬d
 << 
d’dl
;

168 
³”s_»cov”ed
 = 
çl£
;

172 ià(
³”s_»cov”ed
 && !
	`g‘_·»Á
()->
	`g‘_loÿl_missšg
().
	`is_missšg
(
oid
)) {

173 
	`dout
(20è<< 
__func__
 << " completed„ecovery,†ocal_missing = "

174 << 
	`g‘_·»Á
()->
	`g‘_loÿl_missšg
(è<< 
d’dl
;

175 
objeù_¡©_sum_t
 
¡©_diff
;

176 
¡©_diff
.
num_objeùs_»cov”ed
 = 1;

177 
	`g‘_·»Á
()->
	`Ú_glob®_»cov”
(
p
.
fœ¡
, 
¡©_diff
, 
Œue
);

180 
	}
}

182 
	gPGBack’d
::
	$rŞlback
(

183 cÚ¡ 
pg_log_’Œy_t
 &
’Œy
,

184 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

187 
RŞlbackVis™Ü
 : 
public
 
ObjeùModDesc
::
Vis™Ü
 {

188 cÚ¡ 
hobjeù_t
 &
hoid
;

189 
PGBack’d
 *
pg
;

190 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

191 
	`RŞlbackVis™Ü
(

192 cÚ¡ 
hobjeù_t
 &
hoid
,

193 
PGBack’d
 *
pg
è: 
	`hoid
(
hoid
), 
	`pg
(pg) {}

194 
	`­³nd
(
ušt64_t
 
Şd_size
è
ov”ride
 {

195 
ObjeùStÜe
::
T¿n§ùiÚ
 
‹mp
;

196 
pg
->
	`rŞlback_­³nd
(
hoid
, 
Şd_size
, &
‹mp
);

197 
‹mp
.
	`­³nd
(
t
);

198 
‹mp
.
	`sw­
(
t
);

200 
	`£‰rs
(
m­
<
¡ršg
, 
boo¡
::
İtiÚ®
<
bufã¾i¡
> > &
©Œs
è
ov”ride
 {

201 
ObjeùStÜe
::
T¿n§ùiÚ
 
‹mp
;

202 
pg
->
	`rŞlback_£‰rs
(
hoid
, 
©Œs
, &
‹mp
);

203 
‹mp
.
	`­³nd
(
t
);

204 
‹mp
.
	`sw­
(
t
);

206 
	`rmobjeù
(
v”siÚ_t
 
Şd_v”siÚ
è
ov”ride
 {

207 
ObjeùStÜe
::
T¿n§ùiÚ
 
‹mp
;

208 
pg
->
	`rŞlback_¡ash
(
hoid
, 
Şd_v”siÚ
, &
‹mp
);

209 
‹mp
.
	`­³nd
(
t
);

210 
‹mp
.
	`sw­
(
t
);

212 
	`Œy_rmobjeù
(
v”siÚ_t
 
Şd_v”siÚ
è
ov”ride
 {

213 
ObjeùStÜe
::
T¿n§ùiÚ
 
‹mp
;

214 
pg
->
	`rŞlback_Œy_¡ash
(
hoid
, 
Şd_v”siÚ
, &
‹mp
);

215 
‹mp
.
	`­³nd
(
t
);

216 
‹mp
.
	`sw­
(
t
);

218 
	`ü—‹
(è
ov”ride
 {

219 
ObjeùStÜe
::
T¿n§ùiÚ
 
‹mp
;

220 
pg
->
	`rŞlback_ü—‹
(
hoid
, &
‹mp
);

221 
‹mp
.
	`­³nd
(
t
);

222 
‹mp
.
	`sw­
(
t
);

224 
	`upd©e_¢­s
(cÚ¡ 
£t
<
¢­id_t
> &
¢­s
è
ov”ride
 {

225 
ObjeùStÜe
::
T¿n§ùiÚ
 
‹mp
;

226 
pg
->
	`g‘_·»Á
()->
	`pgb_£t_objeù_¢­_m­pšg
(
hoid
, 
¢­s
, &
‹mp
);

227 
‹mp
.
	`­³nd
(
t
);

228 
‹mp
.
	`sw­
(
t
);

230 
	`rŞlback_ex‹Ás
(

231 
v”siÚ_t
 
g’
,

232 cÚ¡ 
veùÜ
<
·œ
<
ušt64_t
, ušt64_t> > &
ex‹Ás
è
ov”ride
 {

233 
ObjeùStÜe
::
T¿n§ùiÚ
 
‹mp
;

234 
pg
->
	`rŞlback_ex‹Ás
(
g’
, 
ex‹Ás
, 
hoid
, &
‹mp
);

235 
‹mp
.
	`­³nd
(
t
);

236 
‹mp
.
	`sw­
(
t
);

240 
	`as£¹
(
’Œy
.
mod_desc
.
	`ÿn_rŞlback
());

241 
RŞlbackVis™Ü
 
	`vis
(
’Œy
.
soid
, 
this
);

242 
’Œy
.
mod_desc
.
	`vis™
(&
vis
);

243 
t
->
	`­³nd
(
vis
.t);

244 
	}
}

246 
	gTrimm”
 : 
public
 
ObjeùModDesc
::
Vis™Ü
 {

247 cÚ¡ 
hobjeù_t
 &
soid
;

248 
PGBack’d
 *
	gpg
;

249 
	gObjeùStÜe
::
T¿n§ùiÚ
 *
t
;

250 
Trimm”
(

251 cÚ¡ 
hobjeù_t
 &
soid
,

252 
PGBack’d
 *
pg
,

253 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

254 : 
soid
(soid), 
pg
Õg), 
t
(t) {}

255 
rmobjeù
(
v”siÚ_t
 
Şd_v”siÚ
è
	gov”ride
 {

256 
	gpg
->
Œim_rŞlback_objeù
(

257 
soid
,

258 
Şd_v”siÚ
,

259 
t
);

262 
rŞlback_ex‹Ás
(

263 
v”siÚ_t
 
g’
,

264 cÚ¡ 
veùÜ
<
·œ
<
ušt64_t
, ušt64_t> > &
ex‹Ás
è
	gov”ride
 {

265 
	gpg
->
Œim_rŞlback_objeù
(

266 
soid
,

267 
g’
,

268 
t
);

272 
	gPGBack’d
::
	$rŞlfÜw¬d
(

273 cÚ¡ 
pg_log_’Œy_t
 &
’Œy
,

274 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

276 autØ
dµ
 = 
	`g‘_·»Á
()->
	`g‘_dµ
();

277 
	`ldµ_dout
(
dµ
, 20è<< 
__func__
 << ":ƒÁry=" << 
’Œy
 << 
d’dl
;

278 ià(!
’Œy
.
	`ÿn_rŞlback
())

280 
Trimm”
 
	`Œimm”
(
’Œy
.
soid
, 
this
, 
t
);

281 
’Œy
.
mod_desc
.
	`vis™
(&
Œimm”
);

282 
	}
}

284 
	gPGBack’d
::
	$Œim
(

285 cÚ¡ 
pg_log_’Œy_t
 &
’Œy
,

286 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

288 ià(!
’Œy
.
	`ÿn_rŞlback
())

290 
Trimm”
 
	`Œimm”
(
’Œy
.
soid
, 
this
, 
t
);

291 
’Œy
.
mod_desc
.
	`vis™
(&
Œimm”
);

292 
	}
}

294 
	gPGBack’d
::
	$Œy_¡ash
(

295 cÚ¡ 
hobjeù_t
 &
hoid
,

296 
v”siÚ_t
 
v
,

297 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

299 
t
->
	`Œy_»Çme
(

300 
cŞl
,

301 
	`ghobjeù_t
(
hoid
, 
ghobjeù_t
::
NO_GEN
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
),

302 
	`ghobjeù_t
(
hoid
, 
v
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
));

303 
	}
}

305 
	gPGBack’d
::
	$»move
(

306 cÚ¡ 
hobjeù_t
 &
hoid
,

307 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
) {

308 
	`as£¹
(!
hoid
.
	`is_‹mp
());

309 
t
->
	`»move
(

310 
cŞl
,

311 
	`ghobjeù_t
(
hoid
, 
ghobjeù_t
::
NO_GEN
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
));

312 
	`g‘_·»Á
()->
	`pgb_ş—r_objeù_¢­_m­pšg
(
hoid
, 
t
);

313 
	}
}

315 
	gPGBack’d
::
	$Ú_chªge_ş—nup
(
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

317 
	`dout
(10è<< 
__func__
 << 
d’dl
;

319 
£t
<
hobjeù_t
>::
™”©Ü
 
i
 = 
‹mp_cÚ‹Ás
.
	`begš
();

320 
i
 !ğ
‹mp_cÚ‹Ás
.
	`’d
();

321 ++
i
) {

322 
	`dout
(10è<< 
__func__
 << ": Removing oid "

323 << *
i
 << " fromh‹m°cŞËùiÚ" << 
d’dl
;

324 
t
->
	`»move
(

325 
cŞl
,

326 
	`ghobjeù_t
(*
i
, 
ghobjeù_t
::
NO_GEN
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
));

328 
‹mp_cÚ‹Ás
.
	`ş—r
();

329 
	}
}

331 
	gPGBack’d
::
objeùs_li¡_·¹Ÿl
(

332 cÚ¡ 
hobjeù_t
 &
begš
,

333 
mš
,

334 
max
,

335 
veùÜ
<
hobjeù_t
> *
ls
,

336 
hobjeù_t
 *
Ãxt
)

338 
as£¹
(
ls
);

342 
ghobjeù_t
 
	g_Ãxt
;

343 ià(!
	gbegš
.
is_mš
())

344 
	g_Ãxt
 = 
ghobjeù_t
(
begš
, 0, 
g‘_·»Á
()->
whßmi_sh¬d
().
sh¬d
);

345 
	gls
->
»£rve
(
max
);

346 
	gr
 = 0;

348 ià(
	gmš
 > 
	gmax
)

349 
	gmš
 = 
max
;

351 !
	g_Ãxt
.
is_max
(è&& 
	gls
->
size
(è< ()
	gmš
) {

352 
	gveùÜ
<
	gghobjeù_t
> 
	gobjeùs
;

353 
	gr
 = 
¡Üe
->
cŞËùiÚ_li¡
(

354 
ch
,

355 
_Ãxt
,

356 
ghobjeù_t
::
g‘_max
(),

357 
max
 - 
ls
->
size
(),

358 &
objeùs
,

359 &
_Ãxt
);

360 ià(
	gr
 != 0) {

361 
d”r
 << 
__func__
 << "†i¡ cŞËùiÚ " << 
ch
 << " gÙ: " << 
ıp_¡»¼Ü
(
r
è<< 
d’dl
;

364 
	gveùÜ
<
	gghobjeù_t
>::
™”©Ü
 
i
 = 
objeùs
.
begš
();

365 
	gi
 !ğ
objeùs
.
’d
();

366 ++
	gi
) {

367 ià(
	gi
->
is_pgm‘a
(è|| i->
	ghobj
.
is_‹mp
()) {

370 ià(
	gi
->
is_no_g’
()) {

371 
	gls
->
push_back
(
i
->
hobj
);

375 ià(
	gr
 == 0)

376 *
Ãxt
 = 
_Ãxt
.
hobj
;

377  
	gr
;

380 
	gPGBack’d
::
objeùs_li¡_¿nge
(

381 cÚ¡ 
hobjeù_t
 &
¡¬t
,

382 cÚ¡ 
hobjeù_t
 &
’d
,

383 
veùÜ
<
hobjeù_t
> *
ls
,

384 
veùÜ
<
ghobjeù_t
> *
g’_obs
)

386 
as£¹
(
ls
);

387 
	gveùÜ
<
	gghobjeù_t
> 
	gobjeùs
;

388 
	gr
 = 
¡Üe
->
cŞËùiÚ_li¡
(

389 
ch
,

390 
ghobjeù_t
(
¡¬t
, ghobjeù_t::
NO_GEN
, 
g‘_·»Á
()->
whßmi_sh¬d
().
sh¬d
),

391 
ghobjeù_t
(
’d
, ghobjeù_t::
NO_GEN
, 
g‘_·»Á
()->
whßmi_sh¬d
().
sh¬d
),

392 
INT_MAX
,

393 &
objeùs
,

394 
NULL
);

395 
	gls
->
»£rve
(
objeùs
.
size
());

396 
	gveùÜ
<
	gghobjeù_t
>::
™”©Ü
 
i
 = 
objeùs
.
begš
();

397 
	gi
 !ğ
objeùs
.
’d
();

398 ++
	gi
) {

399 ià(
	gi
->
is_pgm‘a
(è|| i->
	ghobj
.
is_‹mp
()) {

402 ià(
	gi
->
is_no_g’
()) {

403 
	gls
->
push_back
(
i
->
hobj
);

404 } ià(
	gg’_obs
) {

405 
	gg’_obs
->
push_back
(*
i
);

408  
	gr
;

411 
	gPGBack’d
::
	$objeùs_g‘_©Œ
(

412 cÚ¡ 
hobjeù_t
 &
hoid
,

413 cÚ¡ 
¡ršg
 &
©Œ
,

414 
bufã¾i¡
 *
out
)

416 
bufã½Œ
 
bp
;

417 
r
 = 
¡Üe
->
	`g‘©Œ
(

418 
ch
,

419 
	`ghobjeù_t
(
hoid
, 
ghobjeù_t
::
NO_GEN
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
),

420 
©Œ
.
	`c_¡r
(),

421 
bp
);

422 ià(
r
 >ğ0 && 
out
) {

423 
out
->
	`ş—r
();

424 
out
->
	`push_back
(
¡d
::
	`move
(
bp
));

426  
r
;

427 
	}
}

429 
	gPGBack’d
::
objeùs_g‘_©Œs
(

430 cÚ¡ 
hobjeù_t
 &
hoid
,

431 
m­
<
¡ršg
, 
bufã¾i¡
> *
out
)

433  
	g¡Üe
->
g‘©Œs
(

434 
ch
,

435 
ghobjeù_t
(
hoid
, ghobjeù_t::
NO_GEN
, 
g‘_·»Á
()->
whßmi_sh¬d
().
sh¬d
),

436 *
out
);

439 
	gPGBack’d
::
rŞlback_£‰rs
(

440 cÚ¡ 
hobjeù_t
 &
hoid
,

441 
m­
<
¡ršg
, 
boo¡
::
İtiÚ®
<
bufã¾i¡
> > &
Şd_©Œs
,

442 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
) {

443 
m­
<
¡ršg
, 
	gbufã¾i¡
> 
	gto_£t
;

444 
as£¹
(!
hoid
.
is_‹mp
());

445 
	gm­
<
	g¡ršg
, 
	gboo¡
::
İtiÚ®
<
bufã¾i¡
> >::
™”©Ü
 
i
 = 
Şd_©Œs
.
begš
();

446 
	gi
 !ğ
Şd_©Œs
.
’d
();

447 ++
	gi
) {

448 ià(
	gi
->
	g£cÚd
) {

449 
	gto_£t
[
i
->
fœ¡
] = i->
£cÚd
.
g‘
();

451 
	gt
->
rm©Œ
(

452 
cŞl
,

453 
ghobjeù_t
(
hoid
, ghobjeù_t::
NO_GEN
, 
g‘_·»Á
()->
whßmi_sh¬d
().
sh¬d
),

454 
i
->
fœ¡
);

457 
	gt
->
£‰rs
(

458 
cŞl
,

459 
ghobjeù_t
(
hoid
, ghobjeù_t::
NO_GEN
, 
g‘_·»Á
()->
whßmi_sh¬d
().
sh¬d
),

460 
to_£t
);

463 
	gPGBack’d
::
	$rŞlback_­³nd
(

464 cÚ¡ 
hobjeù_t
 &
hoid
,

465 
ušt64_t
 
Şd_size
,

466 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
) {

467 
	`as£¹
(!
hoid
.
	`is_‹mp
());

468 
t
->
	`Œunÿ‹
(

469 
cŞl
,

470 
	`ghobjeù_t
(
hoid
, 
ghobjeù_t
::
NO_GEN
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
),

471 
Şd_size
);

472 
	}
}

474 
	gPGBack’d
::
	$rŞlback_¡ash
(

475 cÚ¡ 
hobjeù_t
 &
hoid
,

476 
v”siÚ_t
 
Şd_v”siÚ
,

477 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
) {

478 
	`as£¹
(!
hoid
.
	`is_‹mp
());

479 
t
->
	`»move
(

480 
cŞl
,

481 
	`ghobjeù_t
(
hoid
, 
ghobjeù_t
::
NO_GEN
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
));

482 
t
->
	`cŞËùiÚ_move_»Çme
(

483 
cŞl
,

484 
	`ghobjeù_t
(
hoid
, 
Şd_v”siÚ
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
),

485 
cŞl
,

486 
	`ghobjeù_t
(
hoid
, 
ghobjeù_t
::
NO_GEN
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
));

487 
	}
}

489 
	gPGBack’d
::
	$rŞlback_Œy_¡ash
(

490 cÚ¡ 
hobjeù_t
 &
hoid
,

491 
v”siÚ_t
 
Şd_v”siÚ
,

492 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
) {

493 
	`as£¹
(!
hoid
.
	`is_‹mp
());

494 
t
->
	`»move
(

495 
cŞl
,

496 
	`ghobjeù_t
(
hoid
, 
ghobjeù_t
::
NO_GEN
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
));

497 
t
->
	`Œy_»Çme
(

498 
cŞl
,

499 
	`ghobjeù_t
(
hoid
, 
Şd_v”siÚ
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
),

500 
	`ghobjeù_t
(
hoid
, 
ghobjeù_t
::
NO_GEN
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
));

501 
	}
}

503 
	gPGBack’d
::
rŞlback_ex‹Ás
(

504 
v”siÚ_t
 
g’
,

505 cÚ¡ 
veùÜ
<
·œ
<
ušt64_t
, ušt64_t> > &
ex‹Ás
,

506 cÚ¡ 
hobjeù_t
 &
hoid
,

507 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
) {

508 autØ
sh¬d
 = 
g‘_·»Á
()->
whßmi_sh¬d
().shard;

509 autØ&&
	gex‹Á
: 
ex‹Ás
) {

510 
t
->
şÚe_¿nge
(

511 
cŞl
,

512 
ghobjeù_t
(
hoid
, 
g’
, 
sh¬d
),

513 
ghobjeù_t
(
hoid
, ghobjeù_t::
NO_GEN
, 
sh¬d
),

514 
ex‹Á
.
fœ¡
,

515 
ex‹Á
.
£cÚd
,

516 
ex‹Á
.
fœ¡
);

518 
	gt
->
»move
(

519 
cŞl
,

520 
ghobjeù_t
(
hoid
, 
g’
, 
sh¬d
));

523 
	gPGBack’d
::
	$Œim_rŞlback_objeù
(

524 cÚ¡ 
hobjeù_t
 &
hoid
,

525 
v”siÚ_t
 
Şd_v”siÚ
,

526 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
) {

527 
	`as£¹
(!
hoid
.
	`is_‹mp
());

528 
t
->
	`»move
(

529 
cŞl
, 
	`ghobjeù_t
(
hoid
, 
Şd_v”siÚ
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
));

530 
	}
}

532 
PGBack’d
 *
	gPGBack’d
::
bud_pg_back’d
(

533 cÚ¡ 
pg_poŞ_t
 &
poŞ
,

534 cÚ¡ 
m­
<
¡ršg
,¡ršg>& 
´ofe
,

535 
Li¡’”
 *
l
,

536 
cŞl_t
 
cŞl
,

537 
ObjeùStÜe
::
CŞËùiÚHªdË
 &
ch
,

538 
ObjeùStÜe
 *
¡Üe
,

539 
C•hCÚ‹xt
 *
cù
)

541 
E¿su»CodeProfe
 
	gec_´ofe
 = 
´ofe
;

542 
	gpoŞ
.
	gty³
) {

543 
	gpg_poŞ_t
::
TYPE_REPLICATED
: {

544  
Ãw
 
R•liÿ‹dBack’d
(
l
, 
cŞl
, 
ch
, 
¡Üe
, 
cù
);

546 
	gpg_poŞ_t
::
TYPE_ERASURE
: {

547 
E¿su»CodeIÁ”çûRef
 
ec_im¶
;

548 
¡ršg¡»am
 
	gss
;

549 
	gûph
::
E¿su»CodePlugšRegi¡ry
::
š¡ªû
().
çùÜy
(

550 
´ofe
.
fšd
("¶ugš")->
£cÚd
,

551 
cù
->
_cÚf
->
g‘_v®
<
¡d
::
¡ršg
>("erasure_code_dir"),

552 
ec_´ofe
,

553 &
ec_im¶
,

554 &
ss
);

555 
as£¹
(
ec_im¶
);

556  
Ãw
 
ECBack’d
(

557 
l
,

558 
cŞl
,

559 
ch
,

560 
¡Üe
,

561 
cù
,

562 
ec_im¶
,

563 
poŞ
.
¡re_width
);

566 
ûph_abÜt
();

567  
	gNULL
;

571 
	gPGBack’d
::
	$be_sÿn_li¡
(

572 
SüubM­
 &
m­
,

573 
SüubM­Bud”
 &
pos
)

575 
	`dout
(10è<< 
__func__
 << " " << 
pos
 << 
d’dl
;

576 
	`as£¹
(!
pos
.
	`dÚe
());

577 
	`as£¹
(
pos
.po <…os.
ls
.
	`size
());

578 
hobjeù_t
& 
poid
 = 
pos
.
ls
[pos.pos];

580 
¡©
 
¡
;

581 
r
 = 
¡Üe
->
	`¡©
(

582 
ch
,

583 
	`ghobjeù_t
(

584 
poid
, 
ghobjeù_t
::
NO_GEN
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
),

585 &
¡
,

586 
Œue
);

587 ià(
r
 == 0) {

588 
SüubM­
::
objeù
 &
o
 = 
m­
.
objeùs
[
poid
];

589 
o
.
size
 = 
¡
.
¡_size
;

590 
	`as£¹
(!
o
.
Ãg©ive
);

591 
¡Üe
->
	`g‘©Œs
(

592 
ch
,

593 
	`ghobjeù_t
(

594 
poid
, 
ghobjeù_t
::
NO_GEN
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
),

595 
o
.
©Œs
);

597 ià(
pos
.
d“p
) {

598 
r
 = 
	`be_d“p_süub
(
poid
, 
m­
, 
pos
, 
o
);

600 
	`dout
(25è<< 
__func__
 << " " << 
poid
 << 
d’dl
;

601 } ià(
r
 =ğ-
ENOENT
) {

602 
	`dout
(25è<< 
__func__
 << " " << 
poid
 << " gÙ " << 
r


603 << ", skpšg" << 
d’dl
;

604 } ià(
r
 =ğ-
EIO
) {

605 
	`dout
(25è<< 
__func__
 << " " << 
poid
 << " gÙ " << 
r


606 << ", st_”rÜ" << 
d’dl
;

607 
SüubM­
::
objeù
 &
o
 = 
m­
.
objeùs
[
poid
];

608 
o
.
¡©_”rÜ
 = 
Œue
;

610 
d”r
 << 
__func__
 << " gÙ: " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

611 
	`ûph_abÜt
();

613 ià(
r
 =ğ-
EINPROGRESS
) {

614  -
EINPROGRESS
;

616 
pos
.
	`Ãxt_objeù
();

618 
	}
}

620 
boŞ
 
	gPGBack’d
::
	$be_com·»_süub_objeùs
(

621 
pg_sh¬d_t
 
auth_sh¬d
,

622 cÚ¡ 
SüubM­
::
objeù
 &
auth
,

623 cÚ¡ 
objeù_šfo_t
& 
auth_oi
,

624 cÚ¡ 
SüubM­
::
objeù
 &
ÿndid©e
,

625 
sh¬d_šfo_w¿µ”
 &
sh¬d_»suÉ
,

626 
šcÚsi¡’t_obj_w¿µ”
 &
obj_»suÉ
,

627 
o¡»am
 &
”rÜ¡»am
)

629 ’um { 
CLEAN
, 
FOUND_ERROR
 } 
”rÜ
 = CLEAN;

630 ià(
ÿndid©e
.
¡©_”rÜ
) {

631 
	`as£¹
(
sh¬d_»suÉ
.
	`has_¡©_”rÜ
());

632 
”rÜ
 = 
FOUND_ERROR
;

633 
”rÜ¡»am
 << "candidate had‡ statƒrror";

635 ià(
ÿndid©e
.
»ad_”rÜ
 || cªdid©e.
ec_hash_mism©ch
 || cªdid©e.
ec_size_mism©ch
) {

636 
”rÜ
 = 
FOUND_ERROR
;

637 
”rÜ¡»am
 << "candidate had‡„eadƒrror";

639 ià(
auth
.
dige¡_´e£Á
 && 
ÿndid©e
.digest_present) {

640 ià(
auth
.
dige¡
 !ğ
ÿndid©e
.digest) {

641 ià(
”rÜ
 !ğ
CLEAN
)

642 
”rÜ¡»am
 << ", ";

643 
”rÜ
 = 
FOUND_ERROR
;

644 
”rÜ¡»am
 << "d©a_dige¡ 0x" << 
¡d
::
hex
 << 
ÿndid©e
.
dige¡


645 << " !ğd©a_dige¡ 0x" << 
auth
.
dige¡
 << 
¡d
::
dec


646 << " from sh¬d " << 
auth_sh¬d
;

647 
obj_»suÉ
.
	`£t_d©a_dige¡_mism©ch
();

650 ià(
auth
.
om­_dige¡_´e£Á
 && 
ÿndid©e
.omap_digest_present) {

651 ià(
auth
.
om­_dige¡
 !ğ
ÿndid©e
.omap_digest) {

652 ià(
”rÜ
 !ğ
CLEAN
)

653 
”rÜ¡»am
 << ", ";

654 
”rÜ
 = 
FOUND_ERROR
;

655 
”rÜ¡»am
 << "om­_dige¡ 0x" << 
¡d
::
hex
 << 
ÿndid©e
.
om­_dige¡


656 << " !ğom­_dige¡ 0x" << 
auth
.
om­_dige¡
 << 
¡d
::
dec


657 << " from sh¬d " << 
auth_sh¬d
;

658 
obj_»suÉ
.
	`£t_om­_dige¡_mism©ch
();

661 ià(
·»Á
->
	`g‘_poŞ
().
	`is_»¶iÿ‹d
()) {

662 ià(
auth_oi
.
	`is_d©a_dige¡
(è&& 
ÿndid©e
.
dige¡_´e£Á
) {

663 ià(
auth_oi
.
d©a_dige¡
 !ğ
ÿndid©e
.
dige¡
) {

664 ià(
”rÜ
 !ğ
CLEAN
)

665 
”rÜ¡»am
 << ", ";

666 
”rÜ
 = 
FOUND_ERROR
;

667 
”rÜ¡»am
 << "d©a_dige¡ 0x" << 
¡d
::
hex
 << 
ÿndid©e
.
dige¡


668 << " !ğd©a_dige¡ 0x" << 
auth_oi
.
d©a_dige¡
 << 
¡d
::
dec


669 << " from‡uth o˜" << 
auth_oi
;

670 
sh¬d_»suÉ
.
	`£t_d©a_dige¡_mism©ch_šfo
();

673 ià(
auth_oi
.
	`is_om­_dige¡
(è&& 
ÿndid©e
.
om­_dige¡_´e£Á
) {

674 ià(
auth_oi
.
om­_dige¡
 !ğ
ÿndid©e
.omap_digest) {

675 ià(
”rÜ
 !ğ
CLEAN
)

676 
”rÜ¡»am
 << ", ";

677 
”rÜ
 = 
FOUND_ERROR
;

678 
”rÜ¡»am
 << "om­_dige¡ 0x" << 
¡d
::
hex
 << 
ÿndid©e
.
om­_dige¡


679 << " !ğom­_dige¡ 0x" << 
auth_oi
.
om­_dige¡
 << 
¡d
::
dec


680 << " from‡uth o˜" << 
auth_oi
;

681 
sh¬d_»suÉ
.
	`£t_om­_dige¡_mism©ch_šfo
();

685 ià(
ÿndid©e
.
¡©_”rÜ
)

686  
”rÜ
 =ğ
FOUND_ERROR
;

687 
ušt64_t
 
oi_size
 = 
	`be_g‘_Údisk_size
(
auth_oi
.
size
);

688 ià(
oi_size
 !ğ
ÿndid©e
.
size
) {

689 ià(
”rÜ
 !ğ
CLEAN
)

690 
”rÜ¡»am
 << ", ";

691 
”rÜ
 = 
FOUND_ERROR
;

692 
”rÜ¡»am
 << "siz" << 
ÿndid©e
.
size


693 << " !ğsiz" << 
oi_size


694 << " from‡uth o˜" << 
auth_oi
;

695 
sh¬d_»suÉ
.
	`£t_size_mism©ch_šfo
();

697 ià(
auth
.
size
 !ğ
ÿndid©e
.size) {

698 ià(
”rÜ
 !ğ
CLEAN
)

699 
”rÜ¡»am
 << ", ";

700 
”rÜ
 = 
FOUND_ERROR
;

701 
”rÜ¡»am
 << "siz" << 
ÿndid©e
.
size


702 << " !ğsiz" << 
auth
.
size


703 << " from sh¬d " << 
auth_sh¬d
;

704 
obj_»suÉ
.
	`£t_size_mism©ch
();

706 
m­
<
¡ršg
,
bufã½Œ
>::
cÚ¡_™”©Ü
 
i
 = 
auth
.
©Œs
.
	`begš
();

707 
i
 !ğ
auth
.
©Œs
.
	`’d
();

708 ++
i
) {

710 ià(
i
->
fœ¡
 =ğ
OI_ATTR
 || i->first[0] != '_')

712 ià(!
ÿndid©e
.
©Œs
.
	`couÁ
(
i
->
fœ¡
)) {

713 ià(
”rÜ
 !ğ
CLEAN
)

714 
”rÜ¡»am
 << ", ";

715 
”rÜ
 = 
FOUND_ERROR
;

716 
”rÜ¡»am
 << "©Œ‚ammism©ch '" << 
i
->
fœ¡
 << "'";

717 
obj_»suÉ
.
	`£t_©Œ_Çme_mism©ch
();

718 } ià(
ÿndid©e
.
©Œs
.
	`fšd
(
i
->
fœ¡
)->
£cÚd
.
	`cmp
(i->second)) {

719 ià(
”rÜ
 !ğ
CLEAN
)

720 
”rÜ¡»am
 << ", ";

721 
”rÜ
 = 
FOUND_ERROR
;

722 
”rÜ¡»am
 << "©Œ v®umism©ch '" << 
i
->
fœ¡
 << "'";

723 
obj_»suÉ
.
	`£t_©Œ_v®ue_mism©ch
();

726 
m­
<
¡ršg
,
bufã½Œ
>::
cÚ¡_™”©Ü
 
i
 = 
ÿndid©e
.
©Œs
.
	`begš
();

727 
i
 !ğ
ÿndid©e
.
©Œs
.
	`’d
();

728 ++
i
) {

730 ià(
i
->
fœ¡
 =ğ
OI_ATTR
 || i->first[0] != '_')

732 ià(!
auth
.
©Œs
.
	`couÁ
(
i
->
fœ¡
)) {

733 ià(
”rÜ
 !ğ
CLEAN
)

734 
”rÜ¡»am
 << ", ";

735 
”rÜ
 = 
FOUND_ERROR
;

736 
”rÜ¡»am
 << "©Œ‚ammism©ch '" << 
i
->
fœ¡
 << "'";

737 
obj_»suÉ
.
	`£t_©Œ_Çme_mism©ch
();

740  
”rÜ
 =ğ
FOUND_ERROR
;

741 
	}
}

743 
	$dcouÁ
(cÚ¡ 
objeù_šfo_t
 &
oi
)

745 
couÁ
 = 0;

746 ià(
oi
.
	`is_d©a_dige¡
())

747 
couÁ
++;

748 ià(
oi
.
	`is_om­_dige¡
())

749 
couÁ
++;

750  
couÁ
;

751 
	}
}

753 
	gm­
<
	gpg_sh¬d_t
, 
	gSüubM­
 *>::
cÚ¡_™”©Ü


754 
PGBack’d
::
be_£Ëù_auth_objeù
(

755 cÚ¡ 
hobjeù_t
 &
obj
,

756 cÚ¡ 
m­
<
pg_sh¬d_t
,
SüubM­
*> &
m­s
,

757 
objeù_šfo_t
 *
auth_oi
,

758 
m­
<
pg_sh¬d_t
, 
sh¬d_šfo_w¿µ”
> &
sh¬d_m­
,

759 
šcÚsi¡’t_obj_w¿µ”
 &
objeù_”rÜ
)

761 
ev”siÚ_t
 
	gauth_v”siÚ
;

762 
bufã¾i¡
 
	gfœ¡_oi_bl
, 
	gfœ¡_ss_bl
, 
	gfœ¡_hk_bl
;

766 
	gli¡
<
	gpg_sh¬d_t
> 
	gsh¬ds
;

767 
	gm­
<
	gpg_sh¬d_t
, 
	gSüubM­
 *>::
cÚ¡_™”©Ü
 
j
 = 
m­s
.
begš
();

768 
	gj
 !ğ
m­s
.
’d
();

769 ++
	gj
) {

770 ià(
	gj
->
	gfœ¡
 =ğ
g‘_·»Á
()->
whßmi_sh¬d
())

772 
	gsh¬ds
.
push_back
(
j
->
fœ¡
);

774 
	gsh¬ds
.
push_äÚt
(
g‘_·»Á
()->
whßmi_sh¬d
());

776 
	gm­
<
	gpg_sh¬d_t
, 
	gSüubM­
 *>::
cÚ¡_™”©Ü
 
auth
 = 
m­s
.
’d
();

777 autØ&
	gl
 : 
sh¬ds
) {

778 
m­
<
pg_sh¬d_t
, 
	gSüubM­
 *>::
cÚ¡_™”©Ü
 
j
 = 
m­s
.
fšd
(
l
);

779 
	gm­
<
	ghobjeù_t
, 
	gSüubM­
::
objeù
>::
™”©Ü
 
i
 =

780 
j
->
£cÚd
->
objeùs
.
fšd
(
obj
);

781 ià(
	gi
 =ğ
j
->
£cÚd
->
objeùs
.
’d
()) {

784 
¡ršg
 
	g”rÜ_¡ršg
;

785 auto& 
	gsh¬d_šfo
 = 
sh¬d_m­
[
j
->
fœ¡
];

786 ià(
	gj
->
	gfœ¡
 =ğ
g‘_·»Á
()->
whßmi_sh¬d
())

787 
sh¬d_šfo
.
´im¬y
 = 
Œue
;

788 ià(
	gi
->
	g£cÚd
.
	g»ad_”rÜ
) {

789 
	gsh¬d_šfo
.
£t_»ad_”rÜ
();

790 
	g”rÜ_¡ršg
 += "„ead_error";

792 ià(
	gi
->
	g£cÚd
.
	gec_hash_mism©ch
) {

793 
	gsh¬d_šfo
.
£t_ec_hash_mism©ch
();

794 
	g”rÜ_¡ršg
 += "ƒc_hash_mismatch";

796 ià(
	gi
->
	g£cÚd
.
	gec_size_mism©ch
) {

797 
	gsh¬d_šfo
.
£t_ec_size_mism©ch
();

798 
	g”rÜ_¡ršg
 += "ƒc_size_mismatch";

801 
objeù_šfo_t
 
	goi
;

802 
bufã¾i¡
 
	gbl
;

803 
	gm­
<
	g¡ršg
, 
	gbufã½Œ
>::
™”©Ü
 
k
;

804 
SÇpS‘
 
	gss
;

805 
bufã¾i¡
 
	gss_bl
, 
	ghk_bl
;

807 ià(
	gi
->
	g£cÚd
.
	g¡©_”rÜ
) {

808 
	gsh¬d_šfo
.
£t_¡©_”rÜ
();

809 
	g”rÜ_¡ršg
 += " stat_error";

812 
	gout
;

816 
as£¹
(!
obj
.
is_¢­dœ
());

817 ià(
	gobj
.
is_h—d
()) {

818 
	gk
 = 
i
->
£cÚd
.
©Œs
.
fšd
(
SS_ATTR
);

819 ià(
	gk
 =ğ
i
->
£cÚd
.
©Œs
.
’d
()) {

820 
sh¬d_šfo
.
£t_¢­£t_missšg
();

821 
	g”rÜ_¡ršg
 += " snapset_missing";

823 
	gss_bl
.
push_back
(
k
->
£cÚd
);

824 
	gŒy
 {

825 
	gbufã¾i¡
::
™”©Ü
 
bl™”
 = 
ss_bl
.
begš
();

826 
decode
(
ss
, 
bl™”
);

827 ià(
	gfœ¡_ss_bl
.
Ëngth
() == 0) {

828 
fœ¡_ss_bl
.
­³nd
(
ss_bl
);

829 } ià(!
	gobjeù_”rÜ
.
has_¢­£t_šcÚsi¡’cy
(è&& !
	gss_bl
.
cÚ‹Ás_equ®
(
fœ¡_ss_bl
)) {

830 
	gobjeù_”rÜ
.
£t_¢­£t_šcÚsi¡’cy
();

831 
	g”rÜ_¡ršg
 += " snapset_inconsistency";

833 } 
ÿtch
 (...) {

835 
	gsh¬d_šfo
.
£t_¢­£t_cÜru±ed
();

836 
	g”rÜ_¡ršg
 += " snapset_corrupted";

841 ià(
	g·»Á
->
g‘_poŞ
().
is_”asu»
()) {

842 
	gECUt
::
HashInfo
 
hi
;

843 
	gk
 = 
i
->
£cÚd
.
©Œs
.
fšd
(
ECUt
::
g‘_hšfo_key
());

844 ià(
	gk
 =ğ
i
->
£cÚd
.
©Œs
.
’d
()) {

845 
sh¬d_šfo
.
£t_hšfo_missšg
();

846 
	g”rÜ_¡ršg
 += " hinfo_key_missing";

848 
	ghk_bl
.
push_back
(
k
->
£cÚd
);

849 
	gŒy
 {

850 
	gbufã¾i¡
::
™”©Ü
 
bl™”
 = 
hk_bl
.
begš
();

851 
decode
(
hi
, 
bl™”
);

852 ià(
	gfœ¡_hk_bl
.
Ëngth
() == 0) {

853 
fœ¡_hk_bl
.
­³nd
(
hk_bl
);

854 } ià(!
	gobjeù_”rÜ
.
has_hšfo_šcÚsi¡’cy
(è&& !
	ghk_bl
.
cÚ‹Ás_equ®
(
fœ¡_hk_bl
)) {

855 
	gobjeù_”rÜ
.
£t_hšfo_šcÚsi¡’cy
();

856 
	g”rÜ_¡ršg
 += " hinfo_inconsistency";

858 } 
ÿtch
 (...) {

860 
	gsh¬d_šfo
.
£t_hšfo_cÜru±ed
();

861 
	g”rÜ_¡ršg
 += " hinfo_corrupted";

866 
	gk
 = 
i
->
£cÚd
.
©Œs
.
fšd
(
OI_ATTR
);

867 ià(
	gk
 =ğ
i
->
£cÚd
.
©Œs
.
’d
()) {

869 
sh¬d_šfo
.
£t_šfo_missšg
();

870 
	g”rÜ_¡ršg
 += " info_missing";

871 
	gout
;

873 
	gbl
.
push_back
(
k
->
£cÚd
);

874 
	gŒy
 {

875 
	gbufã¾i¡
::
™”©Ü
 
bl™”
 = 
bl
.
begš
();

876 
decode
(
oi
, 
bl™”
);

877 } 
ÿtch
 (...) {

879 
	gsh¬d_šfo
.
£t_šfo_cÜru±ed
();

880 
	g”rÜ_¡ršg
 += " info_corrupted";

881 
	gout
;

885 
as£¹
(
oi
.
soid
 =ğ
obj
);

887 ià(
	gfœ¡_oi_bl
.
Ëngth
() == 0) {

888 
fœ¡_oi_bl
.
­³nd
(
bl
);

889 } ià(!
	gobjeù_”rÜ
.
has_objeù_šfo_šcÚsi¡’cy
(è&& !
	gbl
.
cÚ‹Ás_equ®
(
fœ¡_oi_bl
)) {

890 
	gobjeù_”rÜ
.
£t_objeù_šfo_šcÚsi¡’cy
();

891 
	g”rÜ_¡ršg
 += " object_info_inconsistency";

894 ià(
	gi
->
	g£cÚd
.
	gsize
 !ğ
be_g‘_Údisk_size
(
oi
.
size
)) {

895 
dout
(5è<< 
__func__
 << " siz" << 
i
->
£cÚd
.
size
 << " o˜siz" << 
oi
.siz<< 
d’dl
;

896 
	gsh¬d_šfo
.
£t_obj_size_šfo_mism©ch
();

897 
	g”rÜ_¡ršg
 += " obj_size_info_mismatch";

902 ià(
	gsh¬d_šfo
.
	g”rÜs
)

903 
	gout
;

905 ià(
	gauth_v”siÚ
 =ğ
ev”siÚ_t
(è|| 
oi
.
v”siÚ
 > 
auth_v”siÚ
 ||

906 (
oi
.
v”siÚ
 =ğ
auth_v”siÚ
 && 
dcouÁ
(oiè> dcouÁ(*
auth_oi
))) {

907 
auth
 = 
j
;

908 *
	gauth_oi
 = 
oi
;

909 
	gauth_v”siÚ
 = 
oi
.
v”siÚ
;

912 
	gout
:

914 ià(
”rÜ_¡ršg
 != "") {

915 
dout
(10è<< 
__func__
 << ":ƒ¼Ü(sèosd " << 
j
->
fœ¡


916 << " fÜ obj " << 
obj


917 << "," << 
”rÜ_¡ršg


918 << 
d’dl
;

922 
dout
(10è<< 
	g__func__
 << ": s–eùšg osd " << 
	gauth
->
	gfœ¡


923 << " fÜ obj " << 
	gobj


924 << " w™h o˜" << *
	gauth_oi


925 << 
	gd’dl
;

926  
	gauth
;

929 
	gPGBack’d
::
be_com·»_süubm­s
(

930 cÚ¡ 
m­
<
pg_sh¬d_t
,
SüubM­
*> &
m­s
,

931 cÚ¡ 
£t
<
hobjeù_t
> &
ma¡”_£t
,

932 
boŞ
 
»·œ
,

933 
m­
<
hobjeù_t
, 
£t
<
pg_sh¬d_t
>> &
missšg
,

934 
m­
<
hobjeù_t
, 
£t
<
pg_sh¬d_t
>> &
šcÚsi¡’t
,

935 
m­
<
hobjeù_t
, 
li¡
<
pg_sh¬d_t
>> &
authÜ™©ive
,

936 
m­
<
hobjeù_t
, 
·œ
<
boo¡
::
İtiÚ®
<
ušt32_t
>,

937 
boo¡
::
İtiÚ®
<
ušt32_t
>>> &
missšg_dige¡
,

938 &
sh®low_”rÜs
, &
d“p_”rÜs
,

939 
Süub
::
StÜe
 *
¡Üe
,

940 cÚ¡ 
¥g_t
& 
pgid
,

941 cÚ¡ 
veùÜ
<> &
aùšg
,

942 
o¡»am
 &
”rÜ¡»am
)

944 
utime_t
 
	gnow
 = 
ûph_şock_now
();

947 
	g£t
<
	ghobjeù_t
>::
cÚ¡_™”©Ü
 
k
 = 
ma¡”_£t
.
begš
();

948 
	gk
 !ğ
ma¡”_£t
.
’d
();

949 ++
	gk
) {

950 
objeù_šfo_t
 
	gauth_oi
;

951 
	gm­
<
	gpg_sh¬d_t
, 
	gsh¬d_šfo_w¿µ”
> 
	gsh¬d_m­
;

953 
šcÚsi¡’t_obj_w¿µ”
 
	gobjeù_”rÜ
{*
	gk
};

955 
	gm­
<
	gpg_sh¬d_t
, 
	gSüubM­
 *>::
cÚ¡_™”©Ü
 
auth
 =

956 
be_£Ëù_auth_objeù
(*
k
, 
m­s
, &
auth_oi
, 
sh¬d_m­
, 
objeù_”rÜ
);

958 
	gli¡
<
	gpg_sh¬d_t
> 
	gauth_li¡
;

959 
	g£t
<
	gpg_sh¬d_t
> 
	gobjeù_”rÜs
;

960 ià(
	gauth
 =ğ
m­s
.
’d
()) {

961 
objeù_”rÜ
.
£t_v”siÚ
(0);

962 
	gobjeù_”rÜ
.
£t_auth_missšg
(*
k
, 
m­s
, 
sh¬d_m­
, 
sh®low_”rÜs
,

963 
d“p_”rÜs
, 
g‘_·»Á
()->
whßmi_sh¬d
());

964 ià(
	gobjeù_”rÜ
.
has_d“p_”rÜs
())

965 ++
	gd“p_”rÜs
;

966 ià(
	gobjeù_”rÜ
.
has_sh®low_”rÜs
())

967 ++
	gsh®low_”rÜs
;

968 
	g¡Üe
->
add_objeù_”rÜ
(
k
->
poŞ
, 
objeù_”rÜ
);

969 
	g”rÜ¡»am
 << 
	gpgid
.pgid << " soid " << *
	gk


973 
	gobjeù_”rÜ
.
£t_v”siÚ
(
auth_oi
.
u£r_v”siÚ
);

974 
	gSüubM­
::
objeù
& 
auth_objeù
 = 
auth
->
£cÚd
->
objeùs
[*
k
];

975 
	g£t
<
	gpg_sh¬d_t
> 
	gcur_missšg
;

976 
	g£t
<
	gpg_sh¬d_t
> 
	gcur_šcÚsi¡’t
;

978 autØ
	gj
 = 
m­s
.
cbegš
(); j !ğm­s.
ûnd
(); ++j) {

979 ià(
	gj
 =ğ
auth
)

980 
sh¬d_m­
[
auth
->
fœ¡
].
£Ëùed_oi
 = 
Œue
;

981 ià(
	gj
->
	g£cÚd
->
	gobjeùs
.
couÁ
(*
k
)) {

982 
	gsh¬d_m­
[
j
->
fœ¡
].
£t_objeù
(j->
£cÚd
->
objeùs
[*
k
]);

984 
¡ršg¡»am
 
	gss
;

985 
boŞ
 
	gfound
 = 
be_com·»_süub_objeùs
(
auth
->
fœ¡
,

986 
auth_objeù
,

987 
auth_oi
,

988 
j
->
£cÚd
->
objeùs
[*
k
],

989 
sh¬d_m­
[
j
->
fœ¡
],

990 
objeù_”rÜ
,

991 
ss
);

993 ià(
	gsh¬d_m­
[
j
->
fœ¡
].
	g”rÜs
 != 0) {

994 
cur_šcÚsi¡’t
.
š£¹
(
j
->
fœ¡
);

995 ià(
	gsh¬d_m­
[
j
->
fœ¡
].
has_d“p_”rÜs
())

996 ++
	gd“p_”rÜs
;

998 ++
	gsh®low_”rÜs
;

1001 ià(
	gfound
)

1002 
	g”rÜ¡»am
 << 
	gpgid
 << " sh¬d " << 
	gj
->
	gfœ¡
 << ": soid " << *
	gk


1003 << " " << 
	gss
.
¡r
() << "\n";

1004 } ià(
	gfound
) {

1007 
	gobjeù_”rÜs
.
š£¹
(
j
->
fœ¡
);

1008 
	g”rÜ¡»am
 << 
	gpgid
 << " : soid " << *
	gk
 << " " << 
	gss
.
¡r
() << "\n";

1012 
	gauth_li¡
.
push_back
(
j
->
fœ¡
);

1015 
	gcur_missšg
.
š£¹
(
j
->
fœ¡
);

1016 
	gsh¬d_m­
[
j
->
fœ¡
].
£t_missšg
();

1017 
	gsh¬d_m­
[
j
->
fœ¡
].
	g´im¬y
 = (j->fœ¡ =ğ
g‘_·»Á
()->
whßmi_sh¬d
());

1019 ++
	gsh®low_”rÜs
;

1020 
	g”rÜ¡»am
 << 
	gpgid
 << " sh¬d " << 
	gj
->
	gfœ¡
 << " missšg " << *
	gk


1023 
	gobjeù_”rÜ
.
add_sh¬d
(
j
->
fœ¡
, 
sh¬d_m­
[j->first]);

1026 ià(
	gauth_li¡
.
em±y
()) {

1027 ià(
	gobjeù_”rÜs
.
em±y
()) {

1028 
	g”rÜ¡»am
 << 
	gpgid
.pgid << " soid " << *
	gk


1030 
	gout
;

1034 
pg_sh¬d_t
 
	gsh¬d
;

1035 ià(
	gobjeù_”rÜs
.
couÁ
(
auth
->
fœ¡
)) {

1036 
	gsh¬d
 = 
auth
->
fœ¡
;

1038 
	gsh¬d
 = *(
objeù_”rÜs
.
begš
());

1040 
	gauth_li¡
.
push_back
(
sh¬d
);

1041 
	gobjeù_”rÜs
.
”a£
(
sh¬d
);

1045 
	gcur_šcÚsi¡’t
.
š£¹
(
objeù_”rÜs
.
begš
(), objeù_”rÜs.
’d
());

1046 ià(!
	gcur_missšg
.
em±y
()) {

1047 
	gmissšg
[*
k
] = 
cur_missšg
;

1049 ià(!
	gcur_šcÚsi¡’t
.
em±y
()) {

1050 
	gšcÚsi¡’t
[*
k
] = 
cur_šcÚsi¡’t
;

1052 ià(!
	gcur_šcÚsi¡’t
.
em±y
(è|| !
	gcur_missšg
.empty()) {

1053 
	gauthÜ™©ive
[*
k
] = 
auth_li¡
;

1054 } ià(
	g·»Á
->
g‘_poŞ
().
is_»¶iÿ‹d
()) {

1056 
	gNO
 = 0,

1057 
	gMAYBE
 = 1,

1058 
	gFORCE
 = 2,

1059 } 
	gupd©e
 = 
NO
;

1061 ià(
	gauth_objeù
.
	gdige¡_´e£Á
 &&‡uth_objeù.
	gom­_dige¡_´e£Á
 &&

1062 (!
	gauth_oi
.
is_d©a_dige¡
(è|| !auth_oi.
is_om­_dige¡
())) {

1063 
dout
(20è<< 
	g__func__
 << " missšg dige¡ oÀ" << *
	gk
 << 
	gd’dl
;

1064 
	gupd©e
 = 
MAYBE
;

1066 ià(
	gauth_objeù
.
	gdige¡_´e£Á
 &&‡uth_objeù.
	gom­_dige¡_´e£Á
 &&

1067 
	gcù
->
	g_cÚf
->
	gosd_debug_süub_chªû_»wr™e_dige¡
 &&

1068 ((()
¿nd
() % 100) >

1069 
	gcù
->
	g_cÚf
->
	gosd_debug_süub_chªû_»wr™e_dige¡
)) {

1070 
dout
(20è<< 
	g__func__
 << "„ªdomly upd©šg dige¡ oÀ" << *
	gk
 << 
	gd’dl
;

1071 
	gupd©e
 = 
MAYBE
;

1075 ià(
	gauth_oi
.
is_d©a_dige¡
(è&& 
	gauth_objeù
.
	gdige¡_´e£Á
 &&

1076 
	gauth_oi
.
	gd©a_dige¡
 !ğ
auth_objeù
.
dige¡
) {

1077 
as£¹
(
sh¬d_m­
[
auth
->
fœ¡
].
has_d©a_dige¡_mism©ch_šfo
());

1078 
	g”rÜ¡»am
 << 
	gpgid
 << "„ecorded data digest 0x"

1079 << 
	g¡d
::
hex
 << 
auth_oi
.
d©a_dige¡
 << " != on disk 0x"

1080 << 
auth_objeù
.
dige¡
 << 
¡d
::
dec
 << " oÀ" << 
auth_oi
.
soid


1082 ià(
	g»·œ
)

1083 
	gupd©e
 = 
FORCE
;

1085 ià(
	gauth_oi
.
is_om­_dige¡
(è&& 
	gauth_objeù
.
	gom­_dige¡_´e£Á
 &&

1086 
	gauth_oi
.
	gom­_dige¡
 !ğ
auth_objeù
.
om­_dige¡
) {

1087 
as£¹
(
sh¬d_m­
[
auth
->
fœ¡
].
has_om­_dige¡_mism©ch_šfo
());

1088 
	g”rÜ¡»am
 << 
	gpgid
 << "„ecorded omap digest 0x"

1089 << 
	g¡d
::
hex
 << 
auth_oi
.
om­_dige¡
 << " != on disk 0x"

1090 << 
auth_objeù
.
om­_dige¡
 << 
¡d
::
dec


1091 << " oÀ" << 
auth_oi
.
soid
 << "\n";

1092 ià(
	g»·œ
)

1093 
	gupd©e
 = 
FORCE
;

1096 ià(
	gupd©e
 !ğ
NO
) {

1097 
utime_t
 
age
 = 
now
 - 
auth_oi
.
loÿl_mtime
;

1098 ià(
	gupd©e
 =ğ
FORCE
 ||

1099 
age
 > 
cù
->
_cÚf
->
osd_d“p_süub_upd©e_dige¡_mš_age
) {

1100 
dout
(20è<< 
__func__
 << " wÈupd©dige¡ oÀ" << *
k
 << 
d’dl
;

1101 
	gboo¡
::
İtiÚ®
<
ušt32_t
> 
d©a_dige¡
, 
	gom­_dige¡
;

1102 ià(
	gauth_oi
.
is_d©a_dige¡
()) {

1103 
	gd©a_dige¡
 = 
auth_objeù
.
dige¡
;

1105 ià(
	gauth_oi
.
is_om­_dige¡
()) {

1106 
	gom­_dige¡
 = 
auth_objeù
.
om­_dige¡
;

1108 
	gmissšg_dige¡
[*
k
] = 
make_·œ
(
d©a_dige¡
, 
om­_dige¡
);

1110 
dout
(20è<< 
	g__func__
 << " missšg dige¡ buˆag" << 
	gage


1111 << " < " << 
	gcù
->
	g_cÚf
->
	gosd_d“p_süub_upd©e_dige¡_mš_age


1112 << " oÀ" << *
	gk
 << 
	gd’dl
;

1116 
	gout
:

1117 ià(
objeù_”rÜ
.
has_d“p_”rÜs
())

1118 ++
d“p_”rÜs
;

1119 ià(
	gobjeù_”rÜ
.
has_sh®low_”rÜs
())

1120 ++
	gsh®low_”rÜs
;

1121 ià(
	gobjeù_”rÜ
.
	g”rÜs
 || objeù_”rÜ.
	guniÚ_sh¬ds
.errors) {

1122 
	g¡Üe
->
add_objeù_”rÜ
(
k
->
poŞ
, 
objeù_”rÜ
);

1127 
	gPGBack’d
::
be_Ïrge_om­_check
(cÚ¡ 
m­
<
pg_sh¬d_t
,
SüubM­
*> &
m­s
,

1128 cÚ¡ 
£t
<
hobjeù_t
> &
ma¡”_£t
,

1129 & 
Ïrge_om­_objeùs
,

1130 
o¡»am
 &
w¬n¡»am
) const

1132 
boŞ
 
	gÃeds_check
 = 
çl£
;

1133 cÚ¡‡uto& 
	gm­
 : 
m­s
) {

1134 ià(
m­
.
£cÚd
->
has_Ïrge_om­_objeù_”rÜs
) {

1135 
Ãeds_check
 = 
Œue
;

1140 ià(!
	gÃeds_check
) {

1145 cÚ¡‡uto& 
	gk
 : 
ma¡”_£t
) {

1146 cÚ¡‡uto& 
m­
 : 
m­s
) {

1147 autØ
™
 = 
m­
.
£cÚd
->
objeùs
.
fšd
(
k
);

1148 ià(
	g™
 =ğ
m­
.
£cÚd
->
objeùs
.
’d
())

1150 
	gSüubM­
::
objeù
& 
obj
 = 
™
->
£cÚd
;

1151 ià(
	gobj
.
	gÏrge_om­_objeù_found
) {

1152 
	gÏrge_om­_objeùs
++;

1153 
	gw¬n¡»am
 << "L¬gom­ objeù found. Objeù: " << 
	gk
 << " Key count: "

1154 << 
	gobj
.
	gÏrge_om­_objeù_key_couÁ
 << " Size (bytes): "

1155 << 
	gobj
.
	gÏrge_om­_objeù_v®ue_size
 << '\n';

	@osd/PGBackend.h

18 #iâdeà
PGBACKEND_H


19 
	#PGBACKEND_H


	)

21 
	~"osd_ty³s.h
"

22 
	~"commÚ/WÜkQueue.h
"

23 
	~"šşude/CÚ‹xt.h
"

24 
	~"os/ObjeùStÜe.h
"

25 
	~"commÚ/LogCl›Á.h
"

26 
	~<¡ršg
>

27 
	~"PGT¿n§ùiÚ.h
"

29 
Çme¥aû
 
	gSüub
 {

30 
şass
 
	gStÜe
;

32 
	gsh¬d_šfo_w¿µ”
;

33 
	gšcÚsi¡’t_obj_w¿µ”
;

36 
şass
 
	gOSDM­
;

37 
şass
 
	gPGLog
;

38 
	gûph
::
	tsh¬ed_±r
<cÚ¡ 
	tOSDM­
> 
	tOSDM­Ref
;

52 şas 
	cPGBack’d
 {

53 
	mpublic
:

54 
C•hCÚ‹xt
* 
cù
;

55 
	m´Ùeùed
:

56 
ObjeùStÜe
 *
¡Üe
;

57 cÚ¡ 
cŞl_t
 
	mcŞl
;

58 
	mObjeùStÜe
::
CŞËùiÚHªdË
 &
ch
;

59 
	mpublic
:

67 şas 
	cLi¡’”
 {

68 
public
:

70 
vœtu®
 
DoutP»fixProvid”
 *
g‘_dµ
() = 0;

77 
vœtu®
 
Ú_loÿl_»cov”
(

78 cÚ¡ 
hobjeù_t
 &
oid
,

79 cÚ¡ 
ObjeùRecov”yInfo
 &
»cov”y_šfo
,

80 
ObjeùCÚ‹xtRef
 
obc
,

81 
boŞ
 
is_d–‘e
,

82 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t


89 
vœtu®
 
Ú_glob®_»cov”
(

90 cÚ¡ 
hobjeù_t
 &
oid
,

91 cÚ¡ 
objeù_¡©_sum_t
 &
¡©_diff
,

92 
boŞ
 
is_d–‘e


98 
vœtu®
 
Ú_³”_»cov”
(

99 
pg_sh¬d_t
 
³”
,

100 cÚ¡ 
hobjeù_t
 &
oid
,

101 cÚ¡ 
ObjeùRecov”yInfo
 &
»cov”y_šfo


104 
vœtu®
 
begš_³”_»cov”
(

105 
pg_sh¬d_t
 
³”
,

106 cÚ¡ 
hobjeù_t
 
oid
) = 0;

108 
vœtu®
 
çed_push
(cÚ¡ 
li¡
<
pg_sh¬d_t
> &
äom
, cÚ¡ 
hobjeù_t
 &
soid
) = 0;

109 
vœtu®
 
fšish_deg¿ded_objeù
(cÚ¡ 
hobjeù_t
& 
oid
) = 0;

110 
vœtu®
 
´im¬y_çed
(cÚ¡ 
hobjeù_t
 &
soid
) = 0;

111 
vœtu®
 
boŞ
 
´im¬y_”rÜ
(cÚ¡ 
hobjeù_t
& 
soid
, 
ev”siÚ_t
 
v
) = 0;

112 
vœtu®
 
ÿnûl_puÎ
(cÚ¡ 
hobjeù_t
 &
soid
) = 0;

114 
vœtu®
 
­¶y_¡©s
(

115 cÚ¡ 
hobjeù_t
 &
soid
,

116 cÚ¡ 
objeù_¡©_sum_t
 &
d–_¡©s
) = 0;

121 
vœtu®
 
Ú_´im¬y_”rÜ
(

122 cÚ¡ 
hobjeù_t
 &
oid
,

123 
ev”siÚ_t
 
v


126 
vœtu®
 
backfl_add_missšg
(

127 cÚ¡ 
hobjeù_t
 &
oid
,

128 
ev”siÚ_t
 
v


131 
vœtu®
 
»move_missšg_objeù
(cÚ¡ 
hobjeù_t
 &
oid
,

132 
ev”siÚ_t
 
v
,

133 
CÚ‹xt
 *
Ú_com¶‘e
) = 0;

142 
vœtu®
 
CÚ‹xt
 *
bËss_cÚ‹xt
(CÚ‹xˆ*
c
) = 0;

143 
vœtu®
 
	mG’CÚ‹xt
<
	mTh»adPoŞ
::
TPHªdË
&> *
bËss_g’cÚ‹xt
(

144 
G’CÚ‹xt
<
Th»adPoŞ
::
TPHªdË
&> *
c
) = 0;

145 
vœtu®
 
	mG’CÚ‹xt
<
	mTh»adPoŞ
::
TPHªdË
&> *
bËss_uÆocked_g’cÚ‹xt
(

146 
G’CÚ‹xt
<
Th»adPoŞ
::
TPHªdË
&> *
c
) = 0;

148 
vœtu®
 
£nd_mes§ge
(
to_osd
, 
Mes§ge
 *
m
) = 0;

149 
vœtu®
 
queue_Œª§ùiÚ
(

150 
ObjeùStÜe
::
T¿n§ùiÚ
&& 
t
,

151 
OpReque¡Ref
 
İ
 = OpRequestRef()

153 
vœtu®
 
queue_Œª§ùiÚs
(

154 
veùÜ
<
ObjeùStÜe
::
T¿n§ùiÚ
>& 
s
,

155 
OpReque¡Ref
 
İ
 = OpRequestRef()

157 
vœtu®
 
•och_t
 
g‘_•och
() const = 0;

158 
vœtu®
 
•och_t
 
g‘_š‹rv®_¡¬t_•och
() const = 0;

159 
vœtu®
 
•och_t
 
g‘_Ï¡_³”šg_»£t_•och
() const = 0;

161 
vœtu®
 cÚ¡ 
	m£t
<
	mpg_sh¬d_t
> &
g‘_aùšg_»cov”y_backfl_sh¬ds
() const = 0;

162 
vœtu®
 cÚ¡ 
	m£t
<
	mpg_sh¬d_t
> &
g‘_aùšg_sh¬ds
() const = 0;

163 
vœtu®
 cÚ¡ 
	m£t
<
	mpg_sh¬d_t
> &
g‘_backfl_sh¬ds
() const = 0;

165 
vœtu®
 
	m¡d
::
o¡»am
& 
g’_dbg_´efix
(
¡d
::o¡»am& 
out
) const = 0;

167 
vœtu®
 cÚ¡ 
	mm­
<
	mhobjeù_t
, 
	m£t
<
	mpg_sh¬d_t
>> &
g‘_missšg_loc_sh¬ds
()

170 
vœtu®
 cÚ¡ 
	mpg_missšg_Œack”_t
 &
g‘_loÿl_missšg
() const = 0;

171 
vœtu®
 
add_loÿl_Ãxt_ev’t
(cÚ¡ 
pg_log_’Œy_t
& 
e
) = 0;

172 
vœtu®
 cÚ¡ 
	mm­
<
	mpg_sh¬d_t
, 
	mpg_missšg_t
> &
g‘_sh¬d_missšg
()

174 
vœtu®
 
	mboo¡
::
İtiÚ®
<cÚ¡ 
pg_missšg_cÚ¡_i
 &> 
maybe_g‘_sh¬d_missšg
(

175 
pg_sh¬d_t
 
³”
) const {

176 ià(
³”
 =ğ
´im¬y_sh¬d
()) {

177  
g‘_loÿl_missšg
();

179 
	mm­
<
	mpg_sh¬d_t
, 
	mpg_missšg_t
>::
cÚ¡_™”©Ü
 
i
 =

180 
g‘_sh¬d_missšg
().
fšd
(
³”
);

181 ià(
	mi
 =ğ
g‘_sh¬d_missšg
().
’d
()) {

182  
boo¡
::
İtiÚ®
<cÚ¡ 
pg_missšg_cÚ¡_i
 &>();

184  
	mi
->
	m£cÚd
;

188 
vœtu®
 cÚ¡ 
	mpg_missšg_cÚ¡_i
 &
g‘_sh¬d_missšg
(
pg_sh¬d_t
 
³”
) const {

189 autØ
	mm
 = 
maybe_g‘_sh¬d_missšg
(
³”
);

190 
as£¹
(
m
);

191  *
	mm
;

194 
vœtu®
 cÚ¡ 
	mm­
<
	mpg_sh¬d_t
, 
	mpg_šfo_t
> &
g‘_sh¬d_šfo
() const = 0;

195 
vœtu®
 cÚ¡ 
	mpg_šfo_t
 &
g‘_sh¬d_šfo
(
pg_sh¬d_t
 
³”
) const {

196 ià(
	m³”
 =ğ
´im¬y_sh¬d
()) {

197  
g‘_šfo
();

199 
	mm­
<
	mpg_sh¬d_t
, 
	mpg_šfo_t
>::
cÚ¡_™”©Ü
 
i
 =

200 
g‘_sh¬d_šfo
().
fšd
(
³”
);

201 
as£¹
(
i
 !ğ
g‘_sh¬d_šfo
().
’d
());

202  
	mi
->
	m£cÚd
;

206 
vœtu®
 cÚ¡ 
	mPGLog
 &
g‘_log
() const = 0;

207 
vœtu®
 
boŞ
 
pgb_is_´im¬y
() const = 0;

208 
vœtu®
 
OSDM­Ref
 
pgb_g‘_osdm­
() const = 0;

209 
vœtu®
 cÚ¡ 
	mpg_šfo_t
 &
g‘_šfo
() const = 0;

210 
vœtu®
 cÚ¡ 
	mpg_poŞ_t
 &
g‘_poŞ
() const = 0;

212 
vœtu®
 
ObjeùCÚ‹xtRef
 
g‘_obc
(

213 cÚ¡ 
hobjeù_t
 &
hoid
,

214 cÚ¡ 
m­
<
¡ršg
, 
bufã¾i¡
> &
©Œs
) = 0;

216 
vœtu®
 
boŞ
 
Œy_lock_fÜ_»ad
(

217 cÚ¡ 
hobjeù_t
 &
hoid
,

218 
ObcLockMªag”
 &
mªag”
) = 0;

220 
vœtu®
 
»Ëa£_locks
(
ObcLockMªag”
 &
mªag”
) = 0;

222 
vœtu®
 
İ_­¶›d
(

223 cÚ¡ 
ev”siÚ_t
 &
­¶›d_v”siÚ
) = 0;

225 
vœtu®
 
boŞ
 
should_£nd_İ
(

226 
pg_sh¬d_t
 
³”
,

227 cÚ¡ 
hobjeù_t
 &
hoid
) = 0;

229 
vœtu®
 
boŞ
 
pg_is_und”sized
() const = 0;

231 
vœtu®
 
log_İ”©iÚ
(

232 cÚ¡ 
veùÜ
<
pg_log_’Œy_t
> &
logv
,

233 cÚ¡ 
boo¡
::
İtiÚ®
<
pg_h™_£t_hi¡Üy_t
> &
h£t_hi¡Üy
,

234 cÚ¡ 
ev”siÚ_t
 &
Œim_to
,

235 cÚ¡ 
ev”siÚ_t
 &
rŞl_fÜw¬d_to
,

236 
boŞ
 
Œª§ùiÚ_­¶›d
,

237 
ObjeùStÜe
::
T¿n§ùiÚ
 &
t
) = 0;

239 
vœtu®
 
pgb_£t_objeù_¢­_m­pšg
(

240 cÚ¡ 
hobjeù_t
 &
soid
,

241 cÚ¡ 
£t
<
¢­id_t
> &
¢­s
,

242 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
) = 0;

244 
vœtu®
 
pgb_ş—r_objeù_¢­_m­pšg
(

245 cÚ¡ 
hobjeù_t
 &
soid
,

246 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
) = 0;

248 
vœtu®
 
upd©e_³”_Ï¡_com¶‘e_Údisk
(

249 
pg_sh¬d_t
 
äomosd
,

250 
ev”siÚ_t
 
lcod
) = 0;

252 
vœtu®
 
upd©e_Ï¡_com¶‘e_Údisk
(

253 
ev”siÚ_t
 
lcod
) = 0;

255 
vœtu®
 
upd©e_¡©s
(

256 cÚ¡ 
pg_¡©_t
 &
¡©
) = 0;

258 
vœtu®
 
scheduË_»cov”y_wÜk
(

259 
G’CÚ‹xt
<
Th»adPoŞ
::
TPHªdË
&> *
c
) = 0;

261 
vœtu®
 
pg_sh¬d_t
 
whßmi_sh¬d
() const = 0;

262 
whßmi
() const {

263  
whßmi_sh¬d
().
	mosd
;

265 
¥g_t
 
whßmi_¥g_t
() const {

266  
g‘_šfo
().
	mpgid
;

269 
vœtu®
 
¥g_t
 
´im¬y_¥g_t
() const = 0;

270 
vœtu®
 
pg_sh¬d_t
 
´im¬y_sh¬d
() const = 0;

272 
vœtu®
 
ušt64_t
 
mš_³”_ã©u»s
() const = 0;

274 
vœtu®
 
hobjeù_t
 
g‘_‹mp_»cov”y_objeù
(cÚ¡ hobjeù_t& 
rg‘
,

275 
ev”siÚ_t
 
v”siÚ
) = 0;

277 
vœtu®
 
£nd_mes§ge_osd_şu¡”
(

278 
³”
, 
Mes§ge
 *
m
, 
•och_t
 
äom_•och
) = 0;

279 
vœtu®
 
£nd_mes§ge_osd_şu¡”
(

280 
Mes§ge
 *
m
, 
CÚÃùiÚ
 *
cÚ
) = 0;

281 
vœtu®
 
£nd_mes§ge_osd_şu¡”
(

282 
Mes§ge
 *
m
, cÚ¡ 
CÚÃùiÚRef
& 
cÚ
) = 0;

283 
vœtu®
 
CÚÃùiÚRef
 
g‘_cÚ_osd_şu¡”
(
³”
, 
•och_t
 
äom_•och
) = 0;

284 
vœtu®
 
’t™y_Çme_t
 
g‘_şu¡”_msgr_Çme
() = 0;

286 
vœtu®
 
P”fCouÁ”s
 *
g‘_logg”
() = 0;

288 
vœtu®
 
ûph_tid_t
 
g‘_tid
() = 0;

290 
vœtu®
 
LogCl›ÁTemp
 
şog_”rÜ
() = 0;

291 
vœtu®
 
LogCl›ÁTemp
 
şog_w¬n
() = 0;

293 
vœtu®
 
boŞ
 
check_ç§ã_fuÎ
() = 0;

295 
vœtu®
 
boŞ
 
check_osdm­_fuÎ
(cÚ¡ 
£t
<
pg_sh¬d_t
> &
missšg_Ú
) = 0;

297 
vœtu®
 
boŞ
 
maybe_´“m±_»¶iÿ_süub
(cÚ¡ 
hobjeù_t
& 
oid
) = 0;

298 
	mvœtu®
 ~
Li¡’”
() {}

300 
Li¡’”
 *
	g·»Á
;

301 
Li¡’”
 *
	$g‘_·»Á
(ècÚ¡ {  
·»Á
; 
	}
}

302 
	$PGBack’d
(
C•hCÚ‹xt
* 
cù
, 
Li¡’”
 *
l
, 
ObjeùStÜe
 *
¡Üe
, cÚ¡ 
cŞl_t
 &
cŞl
,

303 
ObjeùStÜe
::
CŞËùiÚHªdË
 &
ch
) :

304 
	`cù
(
cù
),

305 
	`¡Üe
(
¡Üe
),

306 
	`cŞl
(
cŞl
),

307 
	`ch
(
ch
),

308 
	$·»Á
(
l
è{
	}
}

309 
boŞ
 
	$is_´im¬y
(ècÚ¡ {  
	`g‘_·»Á
()->
	`pgb_is_´im¬y
(); 
	}
}

310 
OSDM­Ref
 
	$g‘_osdm­
(ècÚ¡ {  
	`g‘_·»Á
()->
	`pgb_g‘_osdm­
(); 
	}
}

311 cÚ¡ 
	gpg_šfo_t
 &
	$g‘_šfo
(è{  
	`g‘_·»Á
()->
	`g‘_šfo
(); 
	}
}

313 
	g¡d
::
o¡»am
& 
	$g’_´efix
(
¡d
::
o¡»am
& 
out
) const {

314  
·»Á
->
	`g’_dbg_´efix
(
out
);

315 
	}
}

325 
	sRecov”yHªdË
 {

326 
boŞ
 
	gÿche_dÚt_Ãed
;

327 
	gm­
<
	gpg_sh¬d_t
, 
	gveùÜ
<
	g·œ
<
	ghobjeù_t
, 
	gev”siÚ_t
> > > 
	gd–‘es
;

329 
Recov”yHªdË
(): 
ÿche_dÚt_Ãed
(
çl£
) {}

330 
vœtu®
 ~
Recov”yHªdË
() {}

334 
vœtu®
 
Recov”yHªdË
 *
İ’_»cov”y_İ
() = 0;

337 
vœtu®
 
run_»cov”y_İ
(

338 
Recov”yHªdË
 *
h
,

339 
´iÜ™y


342 
»cov”_d–‘e_objeù
(cÚ¡ 
hobjeù_t
 &
oid
, 
ev”siÚ_t
 
v
,

343 
Recov”yHªdË
 *
h
);

344 
£nd_»cov”y_d–‘es
(
´io
,

345 cÚ¡ 
m­
<
pg_sh¬d_t
, 
veùÜ
<
·œ
<
hobjeù_t
, 
ev”siÚ_t
> > > &
d–‘es
);

368 
vœtu®
 
»cov”_objeù
(

369 cÚ¡ 
hobjeù_t
 &
hoid
,

370 
ev”siÚ_t
 
v
,

371 
ObjeùCÚ‹xtRef
 
h—d
,

372 
ObjeùCÚ‹xtRef
 
obc
,

373 
Recov”yHªdË
 *
h


381 
vœtu®
 
boŞ
 
ÿn_hªdË_whe_šaùive
(
OpReque¡Ref
 
İ
) = 0;

384 
boŞ
 
hªdË_mes§ge
(

385 
OpReque¡Ref
 
İ


389 
vœtu®
 
boŞ
 
_hªdË_mes§ge
(
OpReque¡Ref
 
İ
) = 0;

391 
vœtu®
 
check_»cov”y_sourûs
(cÚ¡ 
OSDM­Ref
& 
osdm­
) = 0;

397 
Ú_chªge_ş—nup
(
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

402 
vœtu®
 
Ú_chªge
() = 0;

403 
vœtu®
 
ş—r_»cov”y_¡©e
() = 0;

405 
vœtu®
 
IsPGRecov”abËP»diÿ‹
 *
	$g‘_is_»cov”abË_´ediÿ‹
() const = 0;

406 
vœtu®
 
IsPGR—dabËP»diÿ‹
 *
	$g‘_is_»adabË_´ediÿ‹
() const = 0;

408 
vœtu®
 
	$dump_»cov”y_šfo
(
FÜm©‹r
 *
f
) const = 0;

410 
´iv©e
:

411 
£t
<
hobjeù_t
> 
‹mp_cÚ‹Ás
;

412 
public
:

414 
	$add_‹mp_obj
(cÚ¡ 
hobjeù_t
 &
oid
) {

415 
‹mp_cÚ‹Ás
.
	`š£¹
(
oid
);

416 
	}
}

417 
add_‹mp_objs
(cÚ¡ 
£t
<
hobjeù_t
> &
oids
) {

418 
	g‹mp_cÚ‹Ás
.
š£¹
(
oids
.
begš
(), oids.
’d
());

420 
	$ş—r_‹mp_obj
(cÚ¡ 
hobjeù_t
 &
oid
) {

421 
‹mp_cÚ‹Ás
.
	`”a£
(
oid
);

422 
	}
}

423 
ş—r_‹mp_objs
(cÚ¡ 
£t
<
hobjeù_t
> &
oids
) {

424 
	g£t
<
	ghobjeù_t
>::
cÚ¡_™”©Ü
 
i
 = 
oids
.
begš
();

425 
	gi
 !ğ
oids
.
’d
();

426 ++
	gi
) {

427 
	g‹mp_cÚ‹Ás
.
”a£
(*
i
);

431 
	gvœtu®
 ~
	$PGBack’d
(è{
	}
}

434 
vœtu®
 
subm™_Œª§ùiÚ
(

435 cÚ¡ 
hobjeù_t
 &
hoid
,

436 cÚ¡ 
objeù_¡©_sum_t
 &
d–_¡©s
,

437 cÚ¡ 
ev”siÚ_t
 &
©_v”siÚ
,

438 
PGT¿n§ùiÚUPŒ
 &&
t
,

439 cÚ¡ 
ev”siÚ_t
 &
Œim_to
,

440 cÚ¡ 
ev”siÚ_t
 &
rŞl_fÜw¬d_to
,

441 cÚ¡ 
veùÜ
<
pg_log_’Œy_t
> &
log_’Œ›s
,

443 
boo¡
::
İtiÚ®
<
pg_h™_£t_hi¡Üy_t
> &
h£t_hi¡Üy
,

444 
CÚ‹xt
 *
Ú_®l_comm™
,

445 
ûph_tid_t
 
tid
,

446 
osd_»qid_t
 
»qid
,

447 
OpReque¡Ref
 
İ


451 
vœtu®
 
ÿÎ_wr™e_Üd”ed
(
¡d
::
funùiÚ
<()> &&
cb
) = 0;

453 
Œy_¡ash
(

454 cÚ¡ 
hobjeù_t
 &
hoid
,

455 
v”siÚ_t
 
v
,

456 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

458 
rŞlback
(

459 cÚ¡ 
pg_log_’Œy_t
 &
’Œy
,

460 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

462 
ä›nd
 
şass
 
	gLRBTrimm”
;

463 
rŞlfÜw¬d
(

464 cÚ¡ 
pg_log_’Œy_t
 &
’Œy
,

465 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

467 
Œim
(

468 cÚ¡ 
pg_log_’Œy_t
 &
’Œy
,

469 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

471 
»move
(

472 cÚ¡ 
hobjeù_t
 &
hoid
,

473 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

475 
	g´Ùeùed
:

477 
hªdË_»cov”y_d–‘e
(
OpReque¡Ref
 
İ
);

478 
hªdË_»cov”y_d–‘e_»¶y
(
OpReque¡Ref
 
İ
);

481 
rŞlback_£‰rs
(

482 cÚ¡ 
hobjeù_t
 &
hoid
,

483 
m­
<
¡ršg
, 
boo¡
::
İtiÚ®
<
bufã¾i¡
> > &
Şd_©Œs
,

484 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

487 
vœtu®
 
rŞlback_­³nd
(

488 cÚ¡ 
hobjeù_t
 &
hoid
,

489 
ušt64_t
 
Şd_size
,

490 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

493 
rŞlback_¡ash
(

494 cÚ¡ 
hobjeù_t
 &
hoid
,

495 
v”siÚ_t
 
Şd_v”siÚ
,

496 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

499 
rŞlback_Œy_¡ash
(

500 cÚ¡ 
hobjeù_t
 &
hoid
,

501 
v”siÚ_t
 
Şd_v”siÚ
,

502 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

505 
	$rŞlback_ü—‹
(

506 cÚ¡ 
hobjeù_t
 &
hoid
,

507 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
) {

508 
	`»move
(
hoid
, 
t
);

509 
	}
}

512 
rŞlback_ex‹Ás
(

513 
v”siÚ_t
 
g’
,

514 cÚ¡ 
veùÜ
<
·œ
<
ušt64_t
, ušt64_t> > &
ex‹Ás
,

515 cÚ¡ 
hobjeù_t
 &
hoid
,

516 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

517 
	gpublic
:

520 
Œim_rŞlback_objeù
(

521 cÚ¡ 
hobjeù_t
 &
hoid
,

522 
v”siÚ_t
 
g’
,

523 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

526 
objeùs_li¡_·¹Ÿl
(

527 cÚ¡ 
hobjeù_t
 &
begš
,

528 
mš
,

529 
max
,

530 
veùÜ
<
hobjeù_t
> *
ls
,

531 
hobjeù_t
 *
Ãxt
);

533 
objeùs_li¡_¿nge
(

534 cÚ¡ 
hobjeù_t
 &
¡¬t
,

535 cÚ¡ 
hobjeù_t
 &
’d
,

536 
veùÜ
<
hobjeù_t
> *
ls
,

537 
veùÜ
<
ghobjeù_t
> *
g’_obs
=0);

539 
objeùs_g‘_©Œ
(

540 cÚ¡ 
hobjeù_t
 &
hoid
,

541 cÚ¡ 
¡ršg
 &
©Œ
,

542 
bufã¾i¡
 *
out
);

544 
vœtu®
 
objeùs_g‘_©Œs
(

545 cÚ¡ 
hobjeù_t
 &
hoid
,

546 
m­
<
¡ršg
, 
bufã¾i¡
> *
out
);

548 
vœtu®
 
objeùs_»ad_sync
(

549 cÚ¡ 
hobjeù_t
 &
hoid
,

550 
ušt64_t
 
off
,

551 
ušt64_t
 
Ën
,

552 
ušt32_t
 
İ_æags
,

553 
bufã¾i¡
 *
bl
) = 0;

555 
vœtu®
 
objeùs_»ad_async
(

556 cÚ¡ 
hobjeù_t
 &
hoid
,

557 cÚ¡ 
li¡
<
·œ
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
>,

558 
·œ
<
bufã¾i¡
*, 
CÚ‹xt
*> > > &
to_»ad
,

559 
CÚ‹xt
 *
Ú_com¶‘e
, 
boŞ
 
ç¡_»ad
 = 
çl£
) = 0;

561 
vœtu®
 
boŞ
 
	$auto_»·œ_suµÜ‹d
() const = 0;

562 
	`be_sÿn_li¡
(

563 
SüubM­
 &
m­
,

564 
SüubM­Bud”
 &
pos
);

565 
boŞ
 
	`be_com·»_süub_objeùs
(

566 
pg_sh¬d_t
 
auth_sh¬d
,

567 cÚ¡ 
SüubM­
::
objeù
 &
auth
,

568 cÚ¡ 
objeù_šfo_t
& 
auth_oi
,

569 cÚ¡ 
SüubM­
::
objeù
 &
ÿndid©e
,

570 
sh¬d_šfo_w¿µ”
& 
sh¬d_”rÜ
,

571 
šcÚsi¡’t_obj_w¿µ”
 &
»suÉ
,

572 
o¡»am
 &
”rÜ¡»am
);

573 
m­
<
pg_sh¬d_t
, 
SüubM­
 *>::
cÚ¡_™”©Ü
 
	`be_£Ëù_auth_objeù
(

574 cÚ¡ 
hobjeù_t
 &
obj
,

575 cÚ¡ 
m­
<
pg_sh¬d_t
,
SüubM­
*> &
m­s
,

576 
objeù_šfo_t
 *
auth_oi
,

577 
m­
<
pg_sh¬d_t
, 
sh¬d_šfo_w¿µ”
> &
sh¬d_m­
,

578 
šcÚsi¡’t_obj_w¿µ”
 &
objeù_”rÜ
);

579 
	`be_com·»_süubm­s
(

580 cÚ¡ 
m­
<
pg_sh¬d_t
,
SüubM­
*> &
m­s
,

581 cÚ¡ 
£t
<
hobjeù_t
> &
ma¡”_£t
,

582 
boŞ
 
»·œ
,

583 
m­
<
hobjeù_t
, 
£t
<
pg_sh¬d_t
>> &
missšg
,

584 
m­
<
hobjeù_t
, 
£t
<
pg_sh¬d_t
>> &
šcÚsi¡’t
,

585 
m­
<
hobjeù_t
, 
li¡
<
pg_sh¬d_t
>> &
authÜ™©ive
,

586 
m­
<
hobjeù_t
, 
·œ
<
boo¡
::
İtiÚ®
<
ušt32_t
>,

587 
boo¡
::
İtiÚ®
<
ušt32_t
>>> &
missšg_dige¡
,

588 &
sh®low_”rÜs
, &
d“p_”rÜs
,

589 
Süub
::
StÜe
 *
¡Üe
,

590 cÚ¡ 
¥g_t
& 
pgid
,

591 cÚ¡ 
veùÜ
<> &
aùšg
,

592 
o¡»am
 &
”rÜ¡»am
);

593 
vœtu®
 
ušt64_t
 
	`be_g‘_Údisk_size
(

594 
ušt64_t
 
logiÿl_size
) = 0;

595 
vœtu®
 
	`be_d“p_süub
(

596 cÚ¡ 
hobjeù_t
 &
oid
,

597 
SüubM­
 &
m­
,

598 
SüubM­Bud”
 &
pos
,

599 
SüubM­
::
objeù
 &
o
) = 0;

600 
	`be_Ïrge_om­_check
(

601 cÚ¡ 
m­
<
pg_sh¬d_t
,
SüubM­
*> &
m­s
,

602 cÚ¡ 
£t
<
hobjeù_t
> &
ma¡”_£t
,

603 & 
Ïrge_om­_objeùs
,

604 
o¡»am
 &
w¬n¡»am
) const;

606 
PGBack’d
 *
	`bud_pg_back’d
(

607 cÚ¡ 
pg_poŞ_t
 &
poŞ
,

608 cÚ¡ 
m­
<
¡ršg
,¡ršg>& 
´ofe
,

609 
Li¡’”
 *
l
,

610 
cŞl_t
 
cŞl
,

611 
ObjeùStÜe
::
CŞËùiÚHªdË
 &
ch
,

612 
ObjeùStÜe
 *
¡Üe
,

613 
C•hCÚ‹xt
 *
cù
);

614 
	}
};

	@osd/PGLog.cc

18 
	~"PGLog.h
"

19 
	~"šşude/unÜd”ed_m­.h
"

20 
	~"commÚ/ûph_cÚ‹xt.h
"

22 
	#dout_cÚ‹xt
 
cù


	)

23 
	#dout_subsys
 
ûph_subsys_osd


	)

24 #undeà
dout_´efix


25 
	#dout_´efix
 
	`_´efix
(
_dout
, 
this
)

	)

27 
	go¡»am
& 
	$_´efix
(
¡d
::
o¡»am
 *
_dout
, cÚ¡ 
PGLog
 *
pglog
)

29  
pglog
->
	`g’_´efix
(*
_dout
);

30 
	}
}

34 
	gPGLog
::
IndexedLog
::
	$¥l™_out_chd
(

35 
pg_t
 
chd_pgid
,

36 
¥l™_b™s
,

37 
PGLog
::
IndexedLog
 *
rg‘
)

39 
	`unšdex
();

40 *
rg‘
 = 
	`IndexedLog
(
pg_log_t
::
	`¥l™_out_chd
(
chd_pgid
, 
¥l™_b™s
));

41 
	`šdex
();

42 
rg‘
->
	`šdex
();

43 
	`»£t_rŞlback_šfo_Œimmed_to_r™”
();

44 
	}
}

46 
	gPGLog
::
IndexedLog
::
Œim
(

47 
C•hCÚ‹xt
* 
cù
,

48 
ev”siÚ_t
 
s
,

49 
£t
<
ev”siÚ_t
> *
Œimmed
,

50 
£t
<
¡ršg
>* 
Œimmed_dups
,

51 
ev”siÚ_t
 *
wr™e_äom_dups
)

53 ià(
	gcom¶‘e_to
 !ğ
log
.
’d
() &&

54 
com¶‘e_to
->
v”siÚ
 <ğ
s
) {

55 
g’”ic_d”r
 << " badrimØ" << 
s
 << " when complete_to is "

56 << 
com¶‘e_to
->
v”siÚ


57 << " oÀ" << *
this
 << 
d’dl
;

58 
as£¹
(0 == "out of orderrim");

61 
as£¹
(
s
 <ğ
ÿn_rŞlback_to
);

63 autØ
	g—¾›¡_dup_v”siÚ
 =

64 
log
.
rbegš
()->
v”siÚ
.v”siÚ < 
cù
->
_cÚf
->
osd_pg_log_dups_Œacked


66 : 
log
.
rbegš
()->
v”siÚ
.v”siÚ - 
cù
->
_cÚf
->
osd_pg_log_dups_Œacked
;

68 !
	glog
.
em±y
()) {

69 cÚ¡ 
	gpg_log_’Œy_t
 &
	ge
 = *
log
.
begš
();

70 ià(
	ge
.
	gv”siÚ
 > 
	gs
)

72 
g’”ic_dout
(20è<< "Œim " << 
	ge
 << 
	gd’dl
;

73 ià(
	gŒimmed
)

74 
	gŒimmed
->
em¶aû
(
e
.
v”siÚ
);

76 
unšdex
(
e
);

79 
g’”ic_dout
(20è<< "—¾›¡_dup_v”siÚ = " << 
	g—¾›¡_dup_v”siÚ
 << 
	gd’dl
;

80 ià(
	ge
.
	gv”siÚ
.v”siÚ >ğ
—¾›¡_dup_v”siÚ
) {

81 ià(
wr™e_äom_dups
 !ğ
nuÎ±r
 && *wr™e_äom_dup > 
e
.
v”siÚ
) {

82 
g’”ic_dout
(20è<< "upd©šg wr™e_äom_dup äom " << *
wr™e_äom_dups
 << "Ø" << 
e
.
v”siÚ
 << 
d’dl
;

83 *
	gwr™e_äom_dups
 = 
e
.
v”siÚ
;

85 
	gdups
.
push_back
(
pg_log_dup_t
(
e
));

86 
šdex
(
dups
.
back
());

87 cÚ¡‡uto& 
	gexŒa
 : 
e
.
exŒa_»qids
) {

89 
dups
.
push_back
(
pg_log_dup_t
(
e
.
v”siÚ
, 
exŒa
.
£cÚd
,

90 
exŒa
.
fœ¡
, 
e
.
»tuº_code
));

91 
šdex
(
dups
.
back
());

95 ià(
	grŞlback_šfo_Œimmed_to_r™”
 =ğ
log
.
»nd
() ||

96 
e
.
v”siÚ
 =ğ
rŞlback_šfo_Œimmed_to_r™”
->version) {

97 
log
.
pİ_äÚt
();

98 
	grŞlback_šfo_Œimmed_to_r™”
 = 
log
.
»nd
();

100 
	glog
.
pİ_äÚt
();

104 !
	gdups
.
em±y
()) {

105 cÚ¡‡uto& 
	ge
 = *
dups
.
begš
();

106 ià(
	ge
.
	gv”siÚ
.v”siÚ >ğ
—¾›¡_dup_v”siÚ
)

108 
g’”ic_dout
(20è<< "Œim du°" << 
	ge
 << 
	gd’dl
;

109 ià(
	gŒimmed_dups
)

110 
	gŒimmed_dups
->
š£¹
(
e
.
g‘_key_Çme
());

111 
unšdex
(
e
);

112 
	gdups
.
pİ_äÚt
();

116 ià(
	g
 < 
	gs
)

117 
	g
 = 
s
;

120 
	go¡»am
& 
	gPGLog
::
IndexedLog
::
	$´št
(
o¡»am
& 
out
) const

122 
out
 << *
this
 << 
¡d
::
’dl
;

123 
li¡
<
pg_log_’Œy_t
>::
cÚ¡_™”©Ü
 
p
 = 
log
.
	`begš
();

124 
p
 !ğ
log
.
	`’d
();

125 ++
p
) {

126 
out
 << *
p
 << " " <<

127 (
	`logged_objeù
(
p
->
soid
) ? "indexed" : "NOT INDEXED") <<

128 
¡d
::
’dl
;

129 
	`as£¹
(!
p
->
	`»qid_is_šdexed
(è|| 
	`logged_»q
Õ->
»qid
));

132 
li¡
<
pg_log_dup_t
>::
cÚ¡_™”©Ü
 
p
 = 
dups
.
	`begš
();

133 
p
 !ğ
dups
.
	`’d
();

134 ++
p
) {

135 
out
 << *
p
 << 
¡d
::
’dl
;

138  
out
;

139 
	}
}

143 
	gPGLog
::
	$»£t_backfl
()

145 
missšg
.
	`ş—r
();

146 
	}
}

148 
	gPGLog
::
	$ş—r
() {

149 
missšg
.
	`ş—r
();

150 
log
.
	`ş—r
();

151 
log_keys_debug
.
	`ş—r
();

152 
	`undœty
();

153 
	}
}

155 
	gPGLog
::
	$ş—r_šfo_log
(

156 
¥g_t
 
pgid
,

157 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
) {

158 
cŞl_t
 
	`cŞl
(
pgid
);

159 
t
->
	`»move
(
cŞl
, 
pgid
.
	`make_pgm‘a_oid
());

160 
	}
}

162 
	gPGLog
::
	$Œim
(

163 
ev”siÚ_t
 
Œim_to
,

164 
pg_šfo_t
 &
šfo
)

167 ià(
Œim_to
 > 
log
.

) {

169 
	`as£¹
(
Œim_to
 <ğ
šfo
.
Ï¡_com¶‘e
);

171 
	`dout
(10è<< "Œim " << 
log
 << "Ø" << 
Œim_to
 << 
d’dl
;

172 
log
.
	`Œim
(
cù
, 
Œim_to
, &
Œimmed
, &
Œimmed_dups
, &
wr™e_äom_dups
);

173 
šfo
.
log_
 = 
log
.

;

175 
	}
}

177 
	gPGLog
::
	$´oc_»¶iÿ_log
(

178 
pg_šfo_t
 &
ošfo
,

179 cÚ¡ 
pg_log_t
 &
Şog
,

180 
pg_missšg_t
& 
omissšg
,

181 
pg_sh¬d_t
 
äom
) const

183 
	`dout
(10è<< "´oc_»¶iÿ_log fÜ osd." << 
äom
 << ": "

184 << 
ošfo
 << " " << 
Şog
 << " " << 
omissšg
 << 
d’dl
;

186 ià(
Şog
.
h—d
 < 
log
.

) {

187 
	`dout
(10è<< 
__func__
 << ": osd." << 
äom
 << " does‚ot overlap,‚ot†ooking "

188 << "fÜ div”g’ˆobjeùs" << 
d’dl
;

191 ià(
Şog
.
h—d
 =ğ
log
.head) {

192 
	`dout
(10è<< 
__func__
 << ": osd." << 
äom
 << " same†og head,‚ot†ooking "

193 << "fÜ div”g’ˆobjeùs" << 
d’dl
;

207 
m­
<
hobjeù_t
, 
pg_missšg_™em
>::
cÚ¡_™”©Ü
 
i
 = 
omissšg
.
	`g‘_™ems
().
	`begš
();

208 
i
 !ğ
omissšg
.
	`g‘_™ems
().
	`’d
();

209 ++
i
) {

210 
	`dout
(20è<< " befÜmissšg " << 
i
->
fœ¡
 << "‚“d " << i->
£cÚd
.
Ãed


211 << " hav" << 
i
->
£cÚd
.
have
 << 
d’dl
;

214 
li¡
<
pg_log_’Œy_t
>::
cÚ¡_»v”£_™”©Ü
 
fœ¡_nÚ_div”g’t
 =

215 
log
.log.
	`rbegš
();

217 ià(
fœ¡_nÚ_div”g’t
 =ğ
log
.log.
	`»nd
())

219 ià(
fœ¡_nÚ_div”g’t
->
v”siÚ
 <ğ
Şog
.
h—d
) {

220 
	`dout
(20) << "merge_log…oint (usually†ast shared) is "

221 << *
fœ¡_nÚ_div”g’t
 << 
d’dl
;

224 ++
fœ¡_nÚ_div”g’t
;

238 
ev”siÚ_t
 
lim™
 = 
¡d
::
	`max
(
Şog
.

, 
log
.tail);

239 
ev”siÚ_t
 
lu
 =

240 (
fœ¡_nÚ_div”g’t
 =ğ
log
.log.
	`»nd
() ||

241 
fœ¡_nÚ_div”g’t
->
v”siÚ
 < 
lim™
) ?

242 
lim™
 :

243 
fœ¡_nÚ_div”g’t
->
v”siÚ
;

245 
IndexedLog
 
	`fŞog
(
Şog
);

246 autØ
div”g’t
 = 
fŞog
.
	`»wšd_äom_h—d
(
lu
);

247 
	`_m”ge_div”g’t_’Œ›s
(

248 
fŞog
,

249 
div”g’t
,

250 
ošfo
,

251 
Şog
.
	`g‘_ÿn_rŞlback_to
(),

252 
omissšg
,

254 
this
);

256 ià(
lu
 < 
ošfo
.
Ï¡_upd©e
) {

257 
	`dout
(10è<< "…“¸osd." << 
äom
 << "†a¡_upd©now " << 
lu
 << 
d’dl
;

258 
ošfo
.
Ï¡_upd©e
 = 
lu
;

261 ià(
omissšg
.
	`have_missšg
()) {

262 
ev”siÚ_t
 
fœ¡_missšg
 =

263 
omissšg
.
	`g‘_™ems
().
	`©
(omissšg.
	`g‘_rmissšg
().
	`begš
()->
£cÚd
).
Ãed
;

264 
ošfo
.
Ï¡_com¶‘e
 = 
	`ev”siÚ_t
();

265 
li¡
<
pg_log_’Œy_t
>::
cÚ¡_™”©Ü
 
i
 = 
Şog
.
log
.
	`begš
();

267 
i
 !ğ
Şog
.
log
.
	`’d
();

268 ++
i
) {

269 ià(
i
->
v”siÚ
 < 
fœ¡_missšg
)

270 
ošfo
.
Ï¡_com¶‘e
 = 
i
->
v”siÚ
;

275 
ošfo
.
Ï¡_com¶‘e
 = ošfo.
Ï¡_upd©e
;

277 
	}
}

287 
	gPGLog
::
	$»wšd_div”g’t_log
(
ev”siÚ_t
 
Ãwh—d
,

288 
pg_šfo_t
 &
šfo
, 
LogEÁryHªdËr
 *
rŞlback”
,

289 
boŞ
 &
dœty_šfo
, boŞ &
dœty_big_šfo
)

291 
	`dout
(10) << "rewind_divergent_logruncate divergent future " <<

292 
Ãwh—d
 << 
d’dl
;

295 ià(
šfo
.
Ï¡_com¶‘e
 > 
Ãwh—d
)

296 
šfo
.
Ï¡_com¶‘e
 = 
Ãwh—d
;

298 autØ
div”g’t
 = 
log
.
	`»wšd_äom_h—d
(
Ãwh—d
);

299 ià(!
div”g’t
.
	`em±y
()) {

300 
	`m¬k_dœty_äom
(
div”g’t
.
	`äÚt
().
v”siÚ
);

302 autØ&&
’Œy
: 
div”g’t
) {

303 
	`dout
(10è<< "»wšd_div”g’t_log futu» div”g’ˆ" << 
’Œy
 << 
d’dl
;

305 
šfo
.
Ï¡_upd©e
 = 
Ãwh—d
;

307 
	`_m”ge_div”g’t_’Œ›s
(

308 
log
,

309 
div”g’t
,

310 
šfo
,

311 
log
.
	`g‘_ÿn_rŞlback_to
(),

312 
missšg
,

313 
rŞlback”
,

314 
this
);

316 
dœty_šfo
 = 
Œue
;

317 
dœty_big_šfo
 = 
Œue
;

318 
	}
}

320 
	gPGLog
::
	$m”ge_log
(
pg_šfo_t
 &
ošfo
, 
pg_log_t
 &
Şog
, 
pg_sh¬d_t
 
äomosd
,

321 
pg_šfo_t
 &
šfo
, 
LogEÁryHªdËr
 *
rŞlback”
,

322 
boŞ
 &
dœty_šfo
, boŞ &
dœty_big_šfo
)

324 
	`dout
(10è<< "m”ge_log " << 
Şog
 << " from osd." << 
äomosd


325 << " iÁØ" << 
log
 << 
d’dl
;

330 
	`as£¹
(!
log
.
	`nuÎ
(è|| 
Şog
.

 =ğ
	`ev”siÚ_t
());

332 
	`as£¹
(
log
.
h—d
 >ğ
Şog
.

 && olog.head >=†og.tail);

334 
m­
<
hobjeù_t
, 
pg_missšg_™em
>::
cÚ¡_™”©Ü
 
i
 = 
missšg
.
	`g‘_™ems
().
	`begš
();

335 
i
 !ğ
missšg
.
	`g‘_™ems
().
	`’d
();

336 ++
i
) {

337 
	`dout
(20è<< "pg_missšg_ˆsobjeù: " << 
i
->
fœ¡
 << 
d’dl
;

340 
boŞ
 
chªged
 = 
çl£
;

346 
ev”siÚ_t
 
Üig_
 = 
log
.

;

347 ià(
Şog
.

 < 
log
.tail) {

348 
	`dout
(10è<< "m”ge_logƒx‹ndšgaØ" << 
Şog
.

 << 
d’dl
;

349 
li¡
<
pg_log_’Œy_t
>::
™”©Ü
 
äom
 = 
Şog
.
log
.
	`begš
();

350 
li¡
<
pg_log_’Œy_t
>::
™”©Ü
 
to
;

351 
ev”siÚ_t
 
Ï¡
;

352 
to
 = 
äom
;

353 
to
 !ğ
Şog
.
log
.
	`’d
();

354 ++
to
) {

355 ià(
to
->
v”siÚ
 > 
log
.

)

357 
log
.
	`šdex
(*
to
);

358 
	`dout
(15è<< *
to
 << 
d’dl
;

359 
Ï¡
 = 
to
->
v”siÚ
;

361 
	`m¬k_dœty_to
(
Ï¡
);

364 
log
.log.
	`¥liû
Öog.log.
	`begš
(),

365 
Şog
.
log
, 
äom
, 
to
);

367 
šfo
.
log_
 = 
log
.

 = 
Şog
.tail;

368 
chªged
 = 
Œue
;

371 ià(
ošfo
.
¡©s
.
»pÜ‹d_£q
 < 
šfo
.stats.reported_seq ||

372 
ošfo
.
¡©s
.
»pÜ‹d_•och
 < 
šfo
.stats.reported_epoch) {

373 
ošfo
.
¡©s
.
»pÜ‹d_£q
 = 
šfo
.stats.reported_seq;

374 
ošfo
.
¡©s
.
»pÜ‹d_•och
 = 
šfo
.stats.reported_epoch;

376 ià(
šfo
.
Ï¡_backfl
.
	`is_max
())

377 
šfo
.
¡©s
 = 
ošfo
.stats;

378 
šfo
.
h™_£t
 = 
ošfo
.hit_set;

381 ià(
Şog
.
h—d
 < 
log
.head) {

382 
	`»wšd_div”g’t_log
(
Şog
.
h—d
, 
šfo
, 
rŞlback”
, 
dœty_šfo
, 
dœty_big_šfo
);

383 
chªged
 = 
Œue
;

387 ià(
Şog
.
h—d
 > 
log
.head) {

388 
	`dout
(10è<< "m”ge_logƒx‹ndšg h—dØ" << 
Şog
.
h—d
 << 
d’dl
;

391 
li¡
<
pg_log_’Œy_t
>::
™”©Ü
 
to
 = 
Şog
.
log
.
	`’d
();

392 
li¡
<
pg_log_’Œy_t
>::
™”©Ü
 
äom
 = 
Şog
.
log
.
	`’d
();

393 
ev”siÚ_t
 
low”_bound
 = 
¡d
::
	`max
(
Şog
.

, 
Üig_
);

395 ià(
äom
 =ğ
Şog
.
log
.
	`begš
())

397 --
äom
;

398 
	`dout
(20è<< " ? " << *
äom
 << 
d’dl
;

399 ià(
äom
->
v”siÚ
 <ğ
log
.
h—d
) {

400 
low”_bound
 = 
¡d
::
	`max
Öow”_bound, 
äom
->
v”siÚ
);

401 ++
äom
;

405 
	`dout
(20) << "merge_log cut…oint (usually†ast shared) is "

406 << 
low”_bound
 << 
d’dl
;

407 
	`m¬k_dœty_äom
(
low”_bound
);

409 autØ
div”g’t
 = 
log
.
	`»wšd_äom_h—d
(
low”_bound
);

411 autØ&&
Û
: 
div”g’t
) {

412 
	`dout
(10è<< "m”ge_log div”g’ˆ" << 
Û
 << 
d’dl
;

414 
log
.
	`rŞl_fÜw¬d_to
Öog.
h—d
, 
rŞlback”
);

416 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> 
Ãw_’Œ›s
;

417 
Ãw_’Œ›s
.
	`¥liû
Òew_’Œ›s.
	`’d
(), 
Şog
.
log
, 
äom
, 
to
);

418 
	`­³nd_log_’Œ›s_upd©e_missšg
(

419 
šfo
.
Ï¡_backfl
,

420 
šfo
.
Ï¡_backfl_b™wi£
,

421 
Ãw_’Œ›s
,

422 
çl£
,

423 &
log
,

424 
missšg
,

425 
rŞlback”
,

426 
this
);

428 
	`_m”ge_div”g’t_’Œ›s
(

429 
log
,

430 
div”g’t
,

431 
šfo
,

432 
log
.
	`g‘_ÿn_rŞlback_to
(),

433 
missšg
,

434 
rŞlback”
,

435 
this
);

437 
šfo
.
Ï¡_upd©e
 = 
log
.
h—d
 = 
Şog
.head;

440 
log
.
	`sk_ÿn_rŞlback_to_to_h—d
();

442 
šfo
.
Ï¡_u£r_v”siÚ
 = 
ošfo
.last_user_version;

443 
šfo
.
purged_¢­s
 = 
ošfo
.purged_snaps;

445 
chªged
 = 
Œue
;

449 ià(
	`m”ge_log_dups
(
Şog
)) {

450 
chªged
 = 
Œue
;

453 
	`dout
(10è<< "m”ge_log„esuÉ " << 
log
 << " " << 
missšg
 <<

454 " chªged=" << 
chªged
 << 
d’dl
;

456 ià(
chªged
) {

457 
dœty_šfo
 = 
Œue
;

458 
dœty_big_šfo
 = 
Œue
;

460 
	}
}

464 
boŞ
 
	gPGLog
::
	$m”ge_log_dups
(cÚ¡ 
pg_log_t
& 
Şog
) {

465 
boŞ
 
chªged
 = 
çl£
;

467 ià(!
Şog
.
dups
.
	`em±y
()) {

468 ià(
log
.
dups
.
	`em±y
()) {

469 
	`dout
(10) << "merge_log copying olog dupso†og " <<

470 
Şog
.
dups
.
	`äÚt
().
v”siÚ
 << "o " <<

471 
Şog
.
dups
.
	`back
().
v”siÚ
 << 
d’dl
;

472 
chªged
 = 
Œue
;

473 
dœty_äom_dups
 = 
	`ev”siÚ_t
();

474 
dœty_to_dups
 = 
ev”siÚ_t
::
	`max
();

476 cÚ¡‡uto& 
i
 : 
Şog
.
dups
) {

477 
log
.
dups
.
	`push_back
(
i
);

478 
log
.
	`šdex
Öog.
dups
.
	`back
());

483 ià(
Şog
.
dups
.
	`back
().
v”siÚ
 > 
log
.dups.back().version) {

485 
	`dout
(10) << "merge_logƒxtending dupsailo " <<

486 
Şog
.
dups
.
	`back
().
v”siÚ
 << 
d’dl
;

487 
chªged
 = 
Œue
;

489 autØ
log__v”siÚ
 = 
log
.
dups
.
	`back
().
v”siÚ
;

491 autØ
š£¹_cursÜ
 = 
log
.
dups
.
	`’d
();

492 
ev”siÚ_t
 
Ï¡_sh¬ed
 =ƒv”siÚ_t::
	`max
();

493 autØ
i
 = 
Şog
.
dups
.
	`übegš
(); i !ğŞog.dups.
	`ü’d
(); ++i) {

494 ià(
i
->
v”siÚ
 <ğ
log__v”siÚ
) ;

495 
log
.
dups
.
	`š£¹
(
š£¹_cursÜ
, *
i
);

496 
Ï¡_sh¬ed
 = 
i
->
v”siÚ
;

498 autØ
´ev
 = 
š£¹_cursÜ
;

499 --
´ev
;

501 
log
.
	`šdex
(*
´ev
);

503 --
š£¹_cursÜ
;

505 
	`m¬k_dœty_äom_dups
(
Ï¡_sh¬ed
);

508 ià(
Şog
.
dups
.
	`äÚt
().
v”siÚ
 < 
log
.dups.front().version) {

510 
	`dout
(10) << "merge_logƒxtending dups heado " <<

511 
Şog
.
dups
.
	`äÚt
().
v”siÚ
 << 
d’dl
;

512 
chªged
 = 
Œue
;

514 
ev”siÚ_t
 
Ï¡
;

515 autØ
š£¹_cursÜ
 = 
log
.
dups
.
	`begš
();

516 autØ
i
 = 
Şog
.
dups
.
	`cbegš
(); i !ğŞog.dups.
	`ûnd
(); ++i) {

517 ià(
i
->
v”siÚ
 >ğ
š£¹_cursÜ
->version) ;

518 
log
.
dups
.
	`š£¹
(
š£¹_cursÜ
, *
i
);

519 
Ï¡
 = 
i
->
v”siÚ
;

520 autØ
´ev
 = 
š£¹_cursÜ
;

521 --
´ev
;

523 
log
.
	`šdex
(*
´ev
);

525 
	`m¬k_dœty_to_dups
(
Ï¡
);

531 ià(!
log
.
dups
.
	`em±y
(è&&†og.dups.
	`back
().
v”siÚ
 >ğlog.

) {

532 
	`dout
(10) << "merge_log„emoved dups overlapping†ogƒntries [" <<

533 
log
.

 << "," <<†og.
dups
.
	`back
().
v”siÚ
 << "]" << 
d’dl
;

534 
chªged
 = 
Œue
;

536 !
log
.
dups
.
	`em±y
(è&&†og.dups.
	`back
().
v”siÚ
 >ğlog.

) {

537 
log
.
	`unšdex
Öog.
dups
.
	`back
());

538 
	`m¬k_dœty_äom_dups
(
log
.
dups
.
	`back
().
v”siÚ
);

539 
log
.
dups
.
	`pİ_back
();

543  
chªged
;

544 
	}
}

546 
	gPGLog
::
	$check
() {

547 ià(!
pg_log_debug
)

549 ià(
log
.log.
	`size
(è!ğ
log_keys_debug
.size()) {

550 
d”r
 << "log.log.size(è!ğlog_keys_debug.size()" << 
d’dl
;

551 
d”r
 << "aùu®†og:" << 
d’dl
;

552 
li¡
<
pg_log_’Œy_t
>::
™”©Ü
 
i
 = 
log
.log.
	`begš
();

553 
i
 !ğ
log
.log.
	`’d
();

554 ++
i
) {

555 
d”r
 << " " << *
i
 << 
d’dl
;

557 
d”r
 << "log_keys_debug:" << 
d’dl
;

558 
£t
<
¡ršg
>::
cÚ¡_™”©Ü
 
i
 = 
log_keys_debug
.
	`begš
();

559 
i
 !ğ
log_keys_debug
.
	`’d
();

560 ++
i
) {

561 
d”r
 << " " << *
i
 << 
d’dl
;

564 
	`as£¹
(
log
.log.
	`size
(è=ğ
log_keys_debug
.size());

565 
li¡
<
pg_log_’Œy_t
>::
™”©Ü
 
i
 = 
log
.log.
	`begš
();

566 
i
 !ğ
log
.log.
	`’d
();

567 ++
i
) {

568 
	`as£¹
(
log_keys_debug
.
	`couÁ
(
i
->
	`g‘_key_Çme
()));

570 
	}
}

573 
	gPGLog
::
wr™e_log_ªd_missšg
(

574 
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
,

575 
m­
<
¡ršg
,
bufã¾i¡
> *
km
,

576 cÚ¡ 
cŞl_t
& 
cŞl
,

577 cÚ¡ 
ghobjeù_t
 &
log_oid
,

578 
boŞ
 
»quœe_rŞlback
)

580 ià(
is_dœty
()) {

581 
dout
(5) << "write_log_and_missing with: "

582 << "dœty_to: " << 
	gdœty_to


583 << ", dœty_äom: " << 
	gdœty_äom


584 << ", wr™eout_äom: " << 
	gwr™eout_äom


585 << ",rimmed: " << 
	gŒimmed


586 << ",rimmed_dups: " << 
	gŒimmed_dups


587 << ", cË¬_div”g’t_´iÜs: " << 
	gş—r_div”g’t_´iÜs


588 << 
	gd’dl
;

589 
_wr™e_log_ªd_missšg
(

590 
t
, 
km
, 
log
, 
cŞl
, 
log_oid
,

591 
dœty_to
,

592 
dœty_äom
,

593 
wr™eout_äom
,

594 
¡d
::
move
(
Œimmed
),

595 
¡d
::
move
(
Œimmed_dups
),

596 
missšg
,

597 !
touched_log
,

598 
»quœe_rŞlback
,

599 
ş—r_div”g’t_´iÜs
,

600 
dœty_to_dups
,

601 
dœty_äom_dups
,

602 
wr™e_äom_dups
,

603 &
»but_missšg_w™h_d–‘es
,

604 (
pg_log_debug
 ? &
log_keys_debug
 : 
nuÎ±r
));

605 
undœty
();

607 
dout
(10è<< "log i nÙ dœty" << 
	gd’dl
;

612 
	gPGLog
::
wr™e_log_ªd_missšg_wo_missšg
(

613 
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
,

614 
m­
<
¡ršg
,
bufã¾i¡
> *
km
,

615 
pg_log_t
 &
log
,

616 cÚ¡ 
cŞl_t
& 
cŞl
, cÚ¡ 
ghobjeù_t
 &
log_oid
,

617 
m­
<
ev”siÚ_t
, 
hobjeù_t
> &
div”g’t_´iÜs
,

618 
boŞ
 
»quœe_rŞlback


621 
_wr™e_log_ªd_missšg_wo_missšg
(

622 
t
, 
km
, 
log
, 
cŞl
, 
log_oid
,

623 
div”g’t_´iÜs
, 
ev”siÚ_t
::
max
(),ƒversion_t(),ƒversion_t(),

624 
Œue
,rue, 
»quœe_rŞlback
,

625 
ev”siÚ_t
::
max
(),ƒv”siÚ_t(),ƒv”siÚ_t(), 
nuÎ±r
);

629 
	gPGLog
::
wr™e_log_ªd_missšg
(

630 
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
,

631 
m­
<
¡ršg
,
bufã¾i¡
> *
km
,

632 
pg_log_t
 &
log
,

633 cÚ¡ 
cŞl_t
& 
cŞl
,

634 cÚ¡ 
ghobjeù_t
 &
log_oid
,

635 cÚ¡ 
pg_missšg_Œack”_t
 &
missšg
,

636 
boŞ
 
»quœe_rŞlback
,

637 
boŞ
 *
»but_missšg_w™h_d–‘es
)

639 
_wr™e_log_ªd_missšg
(

640 
t
, 
km
, 
log
, 
cŞl
, 
log_oid
,

641 
ev”siÚ_t
::
max
(),

642 
ev”siÚ_t
(),

643 
ev”siÚ_t
(),

644 
£t
<
ev”siÚ_t
>(),

645 
£t
<
¡ršg
>(),

646 
missšg
,

647 
Œue
, 
»quœe_rŞlback
, 
çl£
,

648 
ev”siÚ_t
::
max
(),

649 
ev”siÚ_t
(),

650 
ev”siÚ_t
(),

651 
»but_missšg_w™h_d–‘es
, 
nuÎ±r
);

655 
	gPGLog
::
_wr™e_log_ªd_missšg_wo_missšg
(

656 
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
,

657 
m­
<
¡ršg
,
bufã¾i¡
> *
km
,

658 
pg_log_t
 &
log
,

659 cÚ¡ 
cŞl_t
& 
cŞl
, cÚ¡ 
ghobjeù_t
 &
log_oid
,

660 
m­
<
ev”siÚ_t
, 
hobjeù_t
> &
div”g’t_´iÜs
,

661 
ev”siÚ_t
 
dœty_to
,

662 
ev”siÚ_t
 
dœty_äom
,

663 
ev”siÚ_t
 
wr™eout_äom
,

664 
boŞ
 
dœty_div”g’t_´iÜs
,

665 
boŞ
 
touch_log
,

666 
boŞ
 
»quœe_rŞlback
,

667 
ev”siÚ_t
 
dœty_to_dups
,

668 
ev”siÚ_t
 
dœty_äom_dups
,

669 
ev”siÚ_t
 
wr™e_äom_dups
,

670 
£t
<
¡ršg
> *
log_keys_debug


674 ià(
	gtouch_log
)

675 
	gt
.
touch
(
cŞl
, 
log_oid
);

676 ià(
	gdœty_to
 !ğ
ev”siÚ_t
()) {

677 
t
.
om­_rmkey¿nge
(

678 
cŞl
, 
log_oid
,

679 
ev”siÚ_t
().
g‘_key_Çme
(), 
dœty_to
.get_key_name());

680 
ş—r_up_to
(
log_keys_debug
, 
dœty_to
.
g‘_key_Çme
());

682 ià(
	gdœty_to
 !ğ
ev”siÚ_t
::
max
(è&& 
dœty_äom
 !=ƒversion_t::max()) {

684 
t
.
om­_rmkey¿nge
(

685 
cŞl
, 
log_oid
,

686 
dœty_äom
.
g‘_key_Çme
(), 
ev”siÚ_t
::
max
().get_key_name());

687 
ş—r_aá”
(
log_keys_debug
, 
dœty_äom
.
g‘_key_Çme
());

690 
	gli¡
<
	gpg_log_’Œy_t
>::
™”©Ü
 
p
 = 
log
.log.
begš
();

691 
	gp
 !ğ
log
.log.
’d
(è&& 
p
->
v”siÚ
 <ğ
dœty_to
;

692 ++
	gp
) {

693 
bufã¾i¡
 
bl
((*
p
) * 2);

694 
	gp
->
’code_w™h_checksum
(
bl
);

695 (*
	gkm
)[
p
->
g‘_key_Çme
()].
şaim
(
bl
);

698 
	gli¡
<
	gpg_log_’Œy_t
>::
»v”£_™”©Ü
 
p
 = 
log
.log.
rbegš
();

699 
	gp
 !ğ
log
.log.
»nd
() &&

700 (
p
->
v”siÚ
 >ğ
dœty_äom
 ||…->v”siÚ >ğ
wr™eout_äom
) &&

701 
p
->
v”siÚ
 >ğ
dœty_to
;

702 ++
	gp
) {

703 
bufã¾i¡
 
bl
((*
p
) * 2);

704 
	gp
->
’code_w™h_checksum
(
bl
);

705 (*
	gkm
)[
p
->
g‘_key_Çme
()].
şaim
(
bl
);

708 ià(
	glog_keys_debug
) {

709 
	gm­
<
	g¡ršg
, 
	gbufã¾i¡
>::
™”©Ü
 
i
 = (*
km
).
begš
();

710 
	gi
 !ğ(*
km
).
’d
();

711 ++
	gi
) {

712 ià(
	gi
->
	gfœ¡
[0] == '_')

714 
as£¹
(!
log_keys_debug
->
couÁ
(
i
->
fœ¡
));

715 
	glog_keys_debug
->
š£¹
(
i
->
fœ¡
);

721 ià(
	gdœty_to_dups
 !ğ
ev”siÚ_t
()) {

722 
pg_log_dup_t
 
mš
, 
dœty_to_dup
;

723 
	gdœty_to_dup
.
	gv”siÚ
 = 
dœty_to_dups
;

724 
	gt
.
om­_rmkey¿nge
(

725 
cŞl
, 
log_oid
,

726 
mš
.
g‘_key_Çme
(), 
dœty_to_dup
.get_key_name());

728 ià(
	gdœty_to_dups
 !ğ
ev”siÚ_t
::
max
(è&& 
dœty_äom_dups
 !=ƒversion_t::max()) {

729 
pg_log_dup_t
 
max
, 
dœty_äom_dup
;

730 
	gmax
.
	gv”siÚ
 = 
ev”siÚ_t
::
max
();

731 
	gdœty_äom_dup
.
	gv”siÚ
 = 
dœty_äom_dups
;

732 
	gt
.
om­_rmkey¿nge
(

733 
cŞl
, 
log_oid
,

734 
dœty_äom_dup
.
g‘_key_Çme
(), 
max
.get_key_name());

737 cÚ¡‡uto& 
	g’Œy
 : 
log
.
dups
) {

738 ià(
’Œy
.
v”siÚ
 > 
dœty_to_dups
)

740 
bufã¾i¡
 
	gbl
;

741 
’code
(
’Œy
, 
bl
);

742 (*
	gkm
)[
’Œy
.
g‘_key_Çme
()].
şaim
(
bl
);

745 
	gli¡
<
	gpg_log_dup_t
>::
»v”£_™”©Ü
 
p
 = 
log
.
dups
.
rbegš
();

746 
	gp
 !ğ
log
.
dups
.
»nd
() &&

747 (
p
->
v”siÚ
 >ğ
dœty_äom_dups
 ||…->v”siÚ >ğ
wr™e_äom_dups
) &&

748 
p
->
v”siÚ
 >ğ
dœty_to_dups
;

749 ++
	gp
) {

750 
bufã¾i¡
 
	gbl
;

751 
’code
(*
p
, 
bl
);

752 (*
	gkm
)[
p
->
g‘_key_Çme
()].
şaim
(
bl
);

755 ià(
	gdœty_div”g’t_´iÜs
) {

757 
’code
(
div”g’t_´iÜs
, (*
km
)["divergent_priors"]);

759 ià(
	g»quœe_rŞlback
) {

760 
’code
(

761 
log
.
g‘_ÿn_rŞlback_to
(),

762 (*
km
)["can_rollback_to"]);

763 
’code
(

764 
log
.
g‘_rŞlback_šfo_Œimmed_to
(),

765 (*
km
)["rollback_info_trimmed_to"]);

770 
	gPGLog
::
_wr™e_log_ªd_missšg
(

771 
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
,

772 
m­
<
¡ršg
,
bufã¾i¡
>* 
km
,

773 
pg_log_t
 &
log
,

774 cÚ¡ 
cŞl_t
& 
cŞl
, cÚ¡ 
ghobjeù_t
 &
log_oid
,

775 
ev”siÚ_t
 
dœty_to
,

776 
ev”siÚ_t
 
dœty_äom
,

777 
ev”siÚ_t
 
wr™eout_äom
,

778 
£t
<
ev”siÚ_t
> &&
Œimmed
,

779 
£t
<
¡ršg
> &&
Œimmed_dups
,

780 cÚ¡ 
pg_missšg_Œack”_t
 &
missšg
,

781 
boŞ
 
touch_log
,

782 
boŞ
 
»quœe_rŞlback
,

783 
boŞ
 
ş—r_div”g’t_´iÜs
,

784 
ev”siÚ_t
 
dœty_to_dups
,

785 
ev”siÚ_t
 
dœty_äom_dups
,

786 
ev”siÚ_t
 
wr™e_äom_dups
,

787 
boŞ
 *
»but_missšg_w™h_d–‘es
,

788 
£t
<
¡ršg
> *
log_keys_debug


790 
	g£t
<
	g¡ršg
> 
	gto_»move
;

791 
	gto_»move
.
sw­
(
Œimmed_dups
);

792 auto& 
	gt
 : 
Œimmed
) {

793 
¡ršg
 
key
 = 
t
.
g‘_key_Çme
();

794 ià(
	glog_keys_debug
) {

795 autØ
	g™
 = 
log_keys_debug
->
fšd
(
key
);

796 
as£¹
(
™
 !ğ
log_keys_debug
->
’d
());

797 
	glog_keys_debug
->
”a£
(
™
);

799 
	gto_»move
.
em¶aû
(
¡d
::
move
(
key
));

801 
	gŒimmed
.
ş—r
();

803 ià(
	gtouch_log
)

804 
	gt
.
touch
(
cŞl
, 
log_oid
);

805 ià(
	gdœty_to
 !ğ
ev”siÚ_t
()) {

806 
t
.
om­_rmkey¿nge
(

807 
cŞl
, 
log_oid
,

808 
ev”siÚ_t
().
g‘_key_Çme
(), 
dœty_to
.get_key_name());

809 
ş—r_up_to
(
log_keys_debug
, 
dœty_to
.
g‘_key_Çme
());

811 ià(
	gdœty_to
 !ğ
ev”siÚ_t
::
max
(è&& 
dœty_äom
 !=ƒversion_t::max()) {

813 
t
.
om­_rmkey¿nge
(

814 
cŞl
, 
log_oid
,

815 
dœty_äom
.
g‘_key_Çme
(), 
ev”siÚ_t
::
max
().get_key_name());

816 
ş—r_aá”
(
log_keys_debug
, 
dœty_äom
.
g‘_key_Çme
());

819 
	gli¡
<
	gpg_log_’Œy_t
>::
™”©Ü
 
p
 = 
log
.log.
begš
();

820 
	gp
 !ğ
log
.log.
’d
(è&& 
p
->
v”siÚ
 <ğ
dœty_to
;

821 ++
	gp
) {

822 
bufã¾i¡
 
bl
((*
p
) * 2);

823 
	gp
->
’code_w™h_checksum
(
bl
);

824 (*
	gkm
)[
p
->
g‘_key_Çme
()].
şaim
(
bl
);

827 
	gli¡
<
	gpg_log_’Œy_t
>::
»v”£_™”©Ü
 
p
 = 
log
.log.
rbegš
();

828 
	gp
 !ğ
log
.log.
»nd
() &&

829 (
p
->
v”siÚ
 >ğ
dœty_äom
 ||…->v”siÚ >ğ
wr™eout_äom
) &&

830 
p
->
v”siÚ
 >ğ
dœty_to
;

831 ++
	gp
) {

832 
bufã¾i¡
 
bl
((*
p
) * 2);

833 
	gp
->
’code_w™h_checksum
(
bl
);

834 (*
	gkm
)[
p
->
g‘_key_Çme
()].
şaim
(
bl
);

837 ià(
	glog_keys_debug
) {

838 
	gm­
<
	g¡ršg
, 
	gbufã¾i¡
>::
™”©Ü
 
i
 = (*
km
).
begš
();

839 
	gi
 !ğ(*
km
).
’d
();

840 ++
	gi
) {

841 ià(
	gi
->
	gfœ¡
[0] == '_')

843 
as£¹
(!
log_keys_debug
->
couÁ
(
i
->
fœ¡
));

844 
	glog_keys_debug
->
š£¹
(
i
->
fœ¡
);

850 ià(
	gdœty_to_dups
 !ğ
ev”siÚ_t
()) {

851 
pg_log_dup_t
 
mš
, 
dœty_to_dup
;

852 
	gdœty_to_dup
.
	gv”siÚ
 = 
dœty_to_dups
;

853 
	gt
.
om­_rmkey¿nge
(

854 
cŞl
, 
log_oid
,

855 
mš
.
g‘_key_Çme
(), 
dœty_to_dup
.get_key_name());

857 ià(
	gdœty_to_dups
 !ğ
ev”siÚ_t
::
max
(è&& 
dœty_äom_dups
 !=ƒversion_t::max()) {

858 
pg_log_dup_t
 
max
, 
dœty_äom_dup
;

859 
	gmax
.
	gv”siÚ
 = 
ev”siÚ_t
::
max
();

860 
	gdœty_äom_dup
.
	gv”siÚ
 = 
dœty_äom_dups
;

861 
	gt
.
om­_rmkey¿nge
(

862 
cŞl
, 
log_oid
,

863 
dœty_äom_dup
.
g‘_key_Çme
(), 
max
.get_key_name());

866 cÚ¡‡uto& 
	g’Œy
 : 
log
.
dups
) {

867 ià(
’Œy
.
v”siÚ
 > 
dœty_to_dups
)

869 
bufã¾i¡
 
	gbl
;

870 
’code
(
’Œy
, 
bl
);

871 (*
	gkm
)[
’Œy
.
g‘_key_Çme
()].
şaim
(
bl
);

874 
	gli¡
<
	gpg_log_dup_t
>::
»v”£_™”©Ü
 
p
 = 
log
.
dups
.
rbegš
();

875 
	gp
 !ğ
log
.
dups
.
»nd
() &&

876 (
p
->
v”siÚ
 >ğ
dœty_äom_dups
 ||…->v”siÚ >ğ
wr™e_äom_dups
) &&

877 
p
->
v”siÚ
 >ğ
dœty_to_dups
;

878 ++
	gp
) {

879 
bufã¾i¡
 
	gbl
;

880 
’code
(*
p
, 
bl
);

881 (*
	gkm
)[
p
->
g‘_key_Çme
()].
şaim
(
bl
);

884 ià(
	gş—r_div”g’t_´iÜs
) {

886 
	gto_»move
.
š£¹
("divergent_priors");

890 ià(*
	g»but_missšg_w™h_d–‘es
) {

891 (*
	gkm
)["may_šşude_d–‘es_š_missšg"] = 
bufã¾i¡
();

892 *
	g»but_missšg_w™h_d–‘es
 = 
çl£
;

894 
	gmissšg
.
g‘_chªged
(

895 [&](cÚ¡ 
hobjeù_t
 &
obj
) {

896 
¡ršg
 
key
 = sŒšg("missšg/"è+ 
obj
.
to_¡r
();

897 
pg_missšg_™em
 
™em
;

898 ià(!
missšg
.
is_missšg
(
obj
, &
™em
)) {

899 
to_»move
.
š£¹
(
key
);

901 
ušt64_t
 
ã©u»s
 = 
missšg
.
may_šşude_d–‘es
 ? 
CEPH_FEATURE_OSD_RECOVERY_DELETES
 : 0;

902 
’code
(
make_·œ
(
obj
, 
™em
), (*
km
)[
key
], 
ã©u»s
);

905 ià(
	g»quœe_rŞlback
) {

906 
’code
(

907 
log
.
g‘_ÿn_rŞlback_to
(),

908 (*
km
)["can_rollback_to"]);

909 
’code
(

910 
log
.
g‘_rŞlback_šfo_Œimmed_to
(),

911 (*
km
)["rollback_info_trimmed_to"]);

914 ià(!
	gto_»move
.
em±y
())

915 
	gt
.
om­_rmkeys
(
cŞl
, 
log_oid
, 
to_»move
);

918 
	gPGLog
::
	$»bud_missšg_£t_w™h_d–‘es
(

919 
ObjeùStÜe
 *
¡Üe
,

920 
ObjeùStÜe
::
CŞËùiÚHªdË
& 
ch
,

921 cÚ¡ 
pg_šfo_t
 &
šfo
)

925 
m­
<
hobjeù_t
, 
pg_missšg_™em
> 
exŒa_missšg
;

926 cÚ¡‡uto& 
p
 : 
missšg
.
	`g‘_™ems
()) {

927 ià(!
log
.
	`logged_objeù
(
p
.
fœ¡
)) {

928 
	`dout
(20è<< 
__func__
 << "ƒxŒ¨missšgƒÁry: " << 
p
.
fœ¡


929 << " " << 
p
.
£cÚd
 << 
d’dl
;

930 
exŒa_missšg
[
p
.
fœ¡
] =….
£cÚd
;

933 
missšg
.
	`ş—r
();

934 
missšg
.
may_šşude_d–‘es
 = 
Œue
;

939 
£t
<
hobjeù_t
> 
did
;

940 
li¡
<
pg_log_’Œy_t
>::
»v”£_™”©Ü
 
i
 = 
log
.log.
	`rbegš
();

941 
i
 !ğ
log
.log.
	`»nd
();

942 ++
i
) {

943 ià(
i
->
v”siÚ
 <ğ
šfo
.
Ï¡_com¶‘e
)

945 ià(
i
->
soid
 > 
šfo
.
Ï¡_backfl
 ||

946 
i
->
	`is_”rÜ
() ||

947 
did
.
	`fšd
(
i
->
soid
è!ğdid.
	`’d
())

949 
did
.
	`š£¹
(
i
->
soid
);

951 
bufã¾i¡
 
bv
;

952 
r
 = 
¡Üe
->
	`g‘©Œ
(

953 
ch
,

954 
	`ghobjeù_t
(
i
->
soid
, 
ghobjeù_t
::
NO_GEN
, 
šfo
.
pgid
.
sh¬d
),

955 
OI_ATTR
,

956 
bv
);

957 
	`dout
(20è<< 
__func__
 << " check fÜ†ogƒÁry: " << *
i
 << " = " << 
r
 << 
d’dl
;

959 ià(
r
 >= 0) {

960 
objeù_šfo_t
 
	`oi
(
bv
);

961 
	`dout
(20è<< 
__func__
 << " stÜv”siÚ = " << 
oi
.
v”siÚ
 << 
d’dl
;

962 ià(
oi
.
v”siÚ
 < 
i
->version) {

963 
missšg
.
	`add
(
i
->
soid
, i->
v”siÚ
, 
oi
.v”siÚ, i->
	`is_d–‘e
());

966 
missšg
.
	`add
(
i
->
soid
, i->
v”siÚ
, 
	`ev”siÚ_t
(), i->
	`is_d–‘e
());

970 cÚ¡‡uto& 
p
 : 
exŒa_missšg
) {

971 
missšg
.
	`add
(
p
.
fœ¡
,….
£cÚd
.
Ãed
,….£cÚd.
have
,….£cÚd.
	`is_d–‘e
());

973 
»but_missšg_w™h_d–‘es
 = 
Œue
;

974 
	}
}

	@osd/PGLog.h

17 #´agm¨
Úû


20 
	~"šşude/as£¹.h
"

21 
	~"osd_ty³s.h
"

22 
	~"os/ObjeùStÜe.h
"

23 
	~<li¡
>

25 
cÚ¡ex´
‡utØ
	gPGLOG_INDEXED_OBJECTS
 = 1 << 0;

26 
cÚ¡ex´
‡utØ
	gPGLOG_INDEXED_CALLER_OPS
 = 1 << 1;

27 
cÚ¡ex´
‡utØ
	gPGLOG_INDEXED_EXTRA_CALLER_OPS
 = 1 << 2;

28 
cÚ¡ex´
‡utØ
	gPGLOG_INDEXED_DUPS
 = 1 << 3;

29 
cÚ¡ex´
‡utØ
	gPGLOG_INDEXED_ALL
 = 
PGLOG_INDEXED_OBJECTS


30 | 
PGLOG_INDEXED_CALLER_OPS


31 | 
PGLOG_INDEXED_EXTRA_CALLER_OPS


32 | 
PGLOG_INDEXED_DUPS
;

34 
şass
 
	gC•hCÚ‹xt
;

36 
	gPGLog
 : 
DoutP»fixProvid”
 {

37 
¡d
::
o¡»am
& 
g’_´efix
(¡d::o¡»am& 
out
ècÚ¡ 
ov”ride
 {

38  
out
;

40 
g‘_subsys
(ècÚ¡ 
	gov”ride
 {

41  
	g¡©ic_ÿ¡
<>(
	gûph_subsys_osd
);

43 
C•hCÚ‹xt
 *
g‘_cù
(ècÚ¡ 
	gov”ride
 {

44  
	gcù
;

48 
	sLogEÁryHªdËr
 {

49 
vœtu®
 
rŞlback
(

50 cÚ¡ 
pg_log_’Œy_t
 &
’Œy
) = 0;

51 
vœtu®
 
rŞlfÜw¬d
(

52 cÚ¡ 
pg_log_’Œy_t
 &
’Œy
) = 0;

53 
vœtu®
 
Œim
(

54 cÚ¡ 
pg_log_’Œy_t
 &
’Œy
) = 0;

55 
vœtu®
 
»move
(

56 cÚ¡ 
hobjeù_t
 &
hoid
) = 0;

57 
vœtu®
 
Œy_¡ash
(

58 cÚ¡ 
hobjeù_t
 &
hoid
,

59 
v”siÚ_t
 
v
) = 0;

60 
	gvœtu®
 ~
LogEÁryHªdËr
() {}

64 şas 
	c»ad_log_ªd_missšg_”rÜ
 : 
public
 
bufãr
::
”rÜ
 {

65 
public
:

66 
ex¶ic™
 
»ad_log_ªd_missšg_”rÜ
(cÚ¡ *
wh©
) {

67 
¢´štf
(
buf
, (buf), "»ad_log_ªd_missšg_”rÜ: %s", 
wh©
);

69 cÚ¡ *
wh©
(ècÚ¡ 
throw
 (è
	gov”ride
 {

70  
	gbuf
;

72 
	g´iv©e
:

73 
buf
[512];

76 
	gpublic
:

81 
IndexedLog
 : 
public
 
pg_log_t
 {

82 
mubË
 
ûph
::
unÜd”ed_m­
<
hobjeù_t
,
	gpg_log_’Œy_t
*> 
	gobjeùs
;

83 
mubË
 
	gûph
::
unÜd”ed_m­
<
osd_»qid_t
,
	gpg_log_’Œy_t
*> 
	gÿÎ”_İs
;

84 
mubË
 
	gûph
::
unÜd”ed_muÉim­
<
osd_»qid_t
,
	gpg_log_’Œy_t
*> 
	gexŒa_ÿÎ”_İs
;

85 
mubË
 
	gûph
::
unÜd”ed_m­
<
osd_»qid_t
,
	gpg_log_dup_t
*> 
	gdup_šdex
;

88 
	gli¡
<
	gpg_log_’Œy_t
>::
™”©Ü
 
com¶‘e_to
;

89 
v”siÚ_t
 
	gÏ¡_»que¡ed
 = 0;

92 
	g´iv©e
:

93 
mubË
 
__u16
 
šdexed_d©a
 = 0;

101 
	gmempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
>::
»v”£_™”©Ü


102 
rŞlback_šfo_Œimmed_to_r™”
;

104 
	g‹m¶©e
 <
ty³Çme
 
	gF
>

105 
advªû_ÿn_rŞlback_to
(
ev”siÚ_t
 
to
, 
F
 &&
f
) {

106 ià(
	gto
 > 
	gÿn_rŞlback_to
)

107 
	gÿn_rŞlback_to
 = 
to
;

109 ià(
	gto
 > 
	grŞlback_šfo_Œimmed_to
)

110 
	grŞlback_šfo_Œimmed_to
 = 
to
;

112 
	grŞlback_šfo_Œimmed_to_r™”
 !ğ
log
.
rbegš
()) {

113 --
rŞlback_šfo_Œimmed_to_r™”
;

114 ià(
	grŞlback_šfo_Œimmed_to_r™”
->
	gv”siÚ
 > 
	grŞlback_šfo_Œimmed_to
) {

115 ++
	grŞlback_šfo_Œimmed_to_r™”
;

118 
f
(*
rŞlback_šfo_Œimmed_to_r™”
);

122 
»£t_rŞlback_šfo_Œimmed_to_r™”
() {

123 
	grŞlback_šfo_Œimmed_to_r™”
 = 
log
.
rbegš
();

124 
	grŞlback_šfo_Œimmed_to_r™”
 !ğ
log
.
»nd
() &&

125 
rŞlback_šfo_Œimmed_to_r™”
->
v”siÚ
 > 
rŞlback_šfo_Œimmed_to
)

126 ++
rŞlback_šfo_Œimmed_to_r™”
;

130 
	gpublic
:

131 
IndexedLog
() :

132 
com¶‘e_to
(
log
.
’d
()),

133 
Ï¡_»que¡ed
(0),

134 
šdexed_d©a
(0),

135 
rŞlback_šfo_Œimmed_to_r™”
(
log
.
rbegš
())

138 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

139 
ex¶ic™
 
IndexedLog
(
Args
&&... 
¬gs
) :

140 
pg_log_t
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...),

141 
com¶‘e_to
(
log
.
’d
()),

142 
Ï¡_»que¡ed
(0),

143 
šdexed_d©a
(0),

144 
rŞlback_šfo_Œimmed_to_r™”
(
log
.
rbegš
())

146 
»£t_rŞlback_šfo_Œimmed_to_r™”
();

147 
šdex
();

150 
IndexedLog
(cÚ¡ IndexedLog &
rhs
) :

151 
pg_log_t
(
rhs
),

152 
com¶‘e_to
(
log
.
’d
()),

153 
Ï¡_»que¡ed
(
rhs
.last_requested),

154 
šdexed_d©a
(0),

155 
rŞlback_šfo_Œimmed_to_r™”
(
log
.
rbegš
())

157 
»£t_rŞlback_šfo_Œimmed_to_r™”
();

158 
šdex
(
rhs
.
šdexed_d©a
);

161 
	gIndexedLog
 &
	gİ”©Ü
=(cÚ¡ 
IndexedLog
 &
rhs
) {

162 
this
->~
IndexedLog
();

163 
Ãw
 (
this
è
IndexedLog
(
rhs
);

164  *
	gthis
;

167 
Œim_rŞlback_šfo_to
(
ev”siÚ_t
 
to
, 
LogEÁryHªdËr
 *
h
) {

168 
advªû_ÿn_rŞlback_to
(

169 
to
,

170 [&](
pg_log_’Œy_t
 &
’Œy
) {

171 
h
->
Œim
(
’Œy
);

174 
rŞl_fÜw¬d_to
(
ev”siÚ_t
 
to
, 
LogEÁryHªdËr
 *
h
) {

175 
advªû_ÿn_rŞlback_to
(

176 
to
,

177 [&](
pg_log_’Œy_t
 &
’Œy
) {

178 
h
->
rŞlfÜw¬d
(
’Œy
);

182 
sk_ÿn_rŞlback_to_to_h—d
() {

183 
advªû_ÿn_rŞlback_to
(
h—d
, [&](cÚ¡ 
pg_log_’Œy_t
 &
’Œy
) {});

186 
	gmempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> 
»wšd_äom_h—d
(
ev”siÚ_t
 
Ãwh—d
) {

187 autØ
div”g’t
 = 
pg_log_t
::
»wšd_äom_h—d
(
Ãwh—d
);

188 
šdex
();

189 
»£t_rŞlback_šfo_Œimmed_to_r™”
();

190  
	gdiv”g’t
;

193 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

194 
sÿn_log_aá”
(

195 cÚ¡ 
ev”siÚ_t
 &
bound
,

196 
T
 &&
f
) const {

197 autØ
	g™”
 = 
log
.
rbegš
();

198 
	g™”
 !ğ
log
.
»nd
(è&& 
™”
->
v”siÚ
 > 
bound
)

199 ++
™”
;

201 
	gŒue
) {

202 ià(
	g™”
 =ğ
log
.
rbegš
())

204 
f
(*(--
™”
));

209 
şaim_log_ªd_ş—r_rŞlback_šfo
(cÚ¡ 
pg_log_t
& 
o
) {

211 
as£¹
(
rŞlback_šfo_Œimmed_to
 =ğ
h—d
);

212 
as£¹
(
rŞlback_šfo_Œimmed_to_r™”
 =ğ
log
.
rbegš
());

214 *
	gthis
 = 
IndexedLog
(
o
);

216 
sk_ÿn_rŞlback_to_to_h—d
();

217 
šdex
();

220 
¥l™_out_chd
(

221 
pg_t
 
chd_pgid
,

222 
¥l™_b™s
,

223 
IndexedLog
 *
rg‘
);

225 
z”o
() {

227 
as£¹
(
rŞlback_šfo_Œimmed_to
 =ğ
h—d
);

228 
as£¹
(
rŞlback_šfo_Œimmed_to_r™”
 =ğ
log
.
rbegš
());

230 
unšdex
();

231 
	gpg_log_t
::
ş—r
();

232 
	grŞlback_šfo_Œimmed_to_r™”
 = 
log
.
rbegš
();

233 
»£t_»cov”y_poš‹rs
();

235 
ş—r
() {

236 
sk_ÿn_rŞlback_to_to_h—d
();

237 
z”o
();

239 
»£t_»cov”y_poš‹rs
() {

240 
	gcom¶‘e_to
 = 
log
.
’d
();

241 
	gÏ¡_»que¡ed
 = 0;

244 
boŞ
 
logged_objeù
(cÚ¡ 
hobjeù_t
& 
oid
) const {

245 ià(!(
	gšdexed_d©a
 & 
	gPGLOG_INDEXED_OBJECTS
)) {

246 
šdex_objeùs
();

248  
	gobjeùs
.
couÁ
(
oid
);

251 
boŞ
 
logged_»q
(cÚ¡ 
osd_»qid_t
 &
r
) const {

252 ià(!(
	gšdexed_d©a
 & 
	gPGLOG_INDEXED_CALLER_OPS
)) {

253 
šdex_ÿÎ”_İs
();

255 ià(!
	gÿÎ”_İs
.
couÁ
(
r
)) {

256 ià(!(
	gšdexed_d©a
 & 
	gPGLOG_INDEXED_EXTRA_CALLER_OPS
)) {

257 
šdex_exŒa_ÿÎ”_İs
();

259  
	gexŒa_ÿÎ”_İs
.
couÁ
(
r
);

261  
	gŒue
;

264 
boŞ
 
g‘_»que¡
(

265 cÚ¡ 
osd_»qid_t
 &
r
,

266 
ev”siÚ_t
 *
v”siÚ
,

267 
v”siÚ_t
 *
u£r_v”siÚ
,

268 *
»tuº_code
) const

270 
as£¹
(
v”siÚ
);

271 
as£¹
(
u£r_v”siÚ
);

272 
as£¹
(
»tuº_code
);

273 
	gûph
::
unÜd”ed_m­
<
osd_»qid_t
,
	gpg_log_’Œy_t
*>::
cÚ¡_™”©Ü
 
p
;

274 ià(!(
	gšdexed_d©a
 & 
	gPGLOG_INDEXED_CALLER_OPS
)) {

275 
šdex_ÿÎ”_İs
();

277 
	gp
 = 
ÿÎ”_İs
.
fšd
(
r
);

278 ià(
	gp
 !ğ
ÿÎ”_İs
.
’d
()) {

279 *
v”siÚ
 = 
p
->
£cÚd
->version;

280 *
	gu£r_v”siÚ
 = 
p
->
£cÚd
->
u£r_v”siÚ
;

281 *
	g»tuº_code
 = 
p
->
£cÚd
->
»tuº_code
;

282  
	gŒue
;

287 ià(!(
	gšdexed_d©a
 & 
	gPGLOG_INDEXED_EXTRA_CALLER_OPS
)) {

288 
šdex_exŒa_ÿÎ”_İs
();

290 
	gp
 = 
exŒa_ÿÎ”_İs
.
fšd
(
r
);

291 ià(
	gp
 !ğ
exŒa_ÿÎ”_İs
.
’d
()) {

292 autØ
i
 = 
p
->
£cÚd
->
exŒa_»qids
.
begš
();

293 
	gi
 !ğ
p
->
£cÚd
->
exŒa_»qids
.
’d
();

294 ++
	gi
) {

295 ià(
	gi
->
	gfœ¡
 =ğ
r
) {

296 *
v”siÚ
 = 
p
->
£cÚd
->version;

297 *
	gu£r_v”siÚ
 = 
i
->
£cÚd
;

298 *
	g»tuº_code
 = 
p
->
£cÚd
->
»tuº_code
;

299  
	gŒue
;

302 
as£¹
(0 == "inƒxtra_caller_ops but‚otƒxtra_reqids");

305 ià(!(
	gšdexed_d©a
 & 
	gPGLOG_INDEXED_DUPS
)) {

306 
šdex_dups
();

308 autØ
	gq
 = 
dup_šdex
.
fšd
(
r
);

309 ià(
	gq
 !ğ
dup_šdex
.
’d
()) {

310 *
v”siÚ
 = 
q
->
£cÚd
->version;

311 *
	gu£r_v”siÚ
 = 
q
->
£cÚd
->
u£r_v”siÚ
;

312 *
	g»tuº_code
 = 
q
->
£cÚd
->
»tuº_code
;

313  
	gŒue
;

316  
	gçl£
;

320 
g‘_objeù_»qids
(cÚ¡ 
hobjeù_t
& 
oid
, 
max
,

321 
mempoŞ
::
osd_pglog
::
veùÜ
<
·œ
<
osd_»qid_t
, 
v”siÚ_t
> > *
¶s
) const {

324 ià(!(
	gšdexed_d©a
 & 
	gPGLOG_INDEXED_OBJECTS
)) {

325 
šdex_objeùs
();

327 ià(
	gobjeùs
.
couÁ
(
oid
) == 0)

329 
	gli¡
<
	gpg_log_’Œy_t
>::
cÚ¡_»v”£_™”©Ü
 
i
 = 
log
.
rbegš
();

330 
	gi
 !ğ
log
.
»nd
();

331 ++
	gi
) {

332 ià(
	gi
->
	gsoid
 =ğ
oid
) {

333 ià(
i
->
»qid_is_šdexed
())

334 
¶s
->
push_back
(
make_·œ
(
i
->
»qid
, i->
u£r_v”siÚ
));

335 
	g¶s
->
š£¹
(
¶s
->
’d
(), 
i
->
exŒa_»qids
.
begš
(), i->extra_reqids.end());

336 ià(
	g¶s
->
size
(è>ğ
max
) {

337 ià(
¶s
->
size
(è> 
max
) {

338 
¶s
->
»size
(
max
);

346 
šdex
(
__u16
 
to_šdex
 = 
PGLOG_INDEXED_ALL
) const {

350 ià(!
to_šdex
) ;

352 ià(
	gto_šdex
 & 
	gPGLOG_INDEXED_OBJECTS
)

353 
	gobjeùs
.
ş—r
();

354 ià(
	gto_šdex
 & 
	gPGLOG_INDEXED_CALLER_OPS
)

355 
	gÿÎ”_İs
.
ş—r
();

356 ià(
	gto_šdex
 & 
	gPGLOG_INDEXED_EXTRA_CALLER_OPS
)

357 
	gexŒa_ÿÎ”_İs
.
ş—r
();

358 ià(
	gto_šdex
 & 
	gPGLOG_INDEXED_DUPS
) {

359 
	gdup_šdex
.
ş—r
();

360 auto& 
	gi
 : 
dups
) {

361 
dup_šdex
[
i
.
»qid
] = 
cÚ¡_ÿ¡
<
pg_log_dup_t
*>(&i);

365 
cÚ¡ex´
 
__u16
 
	gªy_log_’Œy_šdex
 =

366 
PGLOG_INDEXED_OBJECTS
 |

367 
PGLOG_INDEXED_CALLER_OPS
 |

368 
PGLOG_INDEXED_EXTRA_CALLER_OPS
;

370 ià(
	gto_šdex
 & 
	gªy_log_’Œy_šdex
) {

371 
	gli¡
<
	gpg_log_’Œy_t
>::
cÚ¡_™”©Ü
 
i
 = 
log
.
begš
();

372 
	gi
 !ğ
log
.
’d
();

373 ++
	gi
) {

374 ià(
	gto_šdex
 & 
	gPGLOG_INDEXED_OBJECTS
) {

375 ià(
	gi
->
objeù_is_šdexed
()) {

376 
	gobjeùs
[
i
->
soid
] = 
cÚ¡_ÿ¡
<
pg_log_’Œy_t
*>(&(*i));

380 ià(
	gto_šdex
 & 
	gPGLOG_INDEXED_CALLER_OPS
) {

381 ià(
	gi
->
»qid_is_šdexed
()) {

382 
	gÿÎ”_İs
[
i
->
»qid
] = 
cÚ¡_ÿ¡
<
pg_log_’Œy_t
*>(&(*i));

386 ià(
	gto_šdex
 & 
	gPGLOG_INDEXED_EXTRA_CALLER_OPS
) {

387 autØ
	gj
 = 
i
->
exŒa_»qids
.
begš
();

388 
	gj
 !ğ
i
->
exŒa_»qids
.
’d
();

389 ++
	gj
) {

390 
	gexŒa_ÿÎ”_İs
.
š£¹
(

391 
make_·œ
(
j
->
fœ¡
, 
cÚ¡_ÿ¡
<
pg_log_’Œy_t
*>(&(*
i
))));

397 
	gšdexed_d©a
 |ğ
to_šdex
;

400 
šdex_objeùs
() const {

401 
šdex
(
PGLOG_INDEXED_OBJECTS
);

404 
šdex_ÿÎ”_İs
() const {

405 
šdex
(
PGLOG_INDEXED_CALLER_OPS
);

408 
šdex_exŒa_ÿÎ”_İs
() const {

409 
šdex
(
PGLOG_INDEXED_EXTRA_CALLER_OPS
);

412 
šdex_dups
() const {

413 
šdex
(
PGLOG_INDEXED_DUPS
);

416 
šdex
(
pg_log_’Œy_t
& 
e
) {

417 ià((
	gšdexed_d©a
 & 
	gPGLOG_INDEXED_OBJECTS
è&& 
	ge
.
objeù_is_šdexed
()) {

418 ià(
	gobjeùs
.
couÁ
(
e
.
soid
) == 0 ||

419 
objeùs
[
e
.
soid
]->
v”siÚ
 <ƒ.version)

420 
objeùs
[
e
.
soid
] = &e;

422 ià(
	gšdexed_d©a
 & 
	gPGLOG_INDEXED_CALLER_OPS
) {

424 ià(
	ge
.
»qid_is_šdexed
()) {

425 
	gÿÎ”_İs
[
e
.
»qid
] = &e;

428 ià(
	gšdexed_d©a
 & 
	gPGLOG_INDEXED_EXTRA_CALLER_OPS
) {

429 autØ
	gj
 = 
e
.
exŒa_»qids
.
begš
();

430 
	gj
 !ğ
e
.
exŒa_»qids
.
’d
();

431 ++
	gj
) {

432 
	gexŒa_ÿÎ”_İs
.
š£¹
(
make_·œ
(
j
->
fœ¡
, &
e
));

437 
unšdex
() {

438 
	gobjeùs
.
ş—r
();

439 
	gÿÎ”_İs
.
ş—r
();

440 
	gexŒa_ÿÎ”_İs
.
ş—r
();

441 
	gdup_šdex
.
ş—r
();

442 
	gšdexed_d©a
 = 0;

445 
unšdex
(cÚ¡ 
pg_log_’Œy_t
& 
e
) {

447 ià(
	gšdexed_d©a
 & 
	gPGLOG_INDEXED_OBJECTS
) {

448 autØ
	g™
 = 
objeùs
.
fšd
(
e
.
soid
);

449 ià(
	g™
 !ğ
objeùs
.
’d
(è&& 
™
->
£cÚd
->
v”siÚ
 =ğ
e
.version)

450 
objeùs
.
”a£
(
™
);

452 ià(
	ge
.
»qid_is_šdexed
()) {

453 ià(
	gšdexed_d©a
 & 
	gPGLOG_INDEXED_CALLER_OPS
) {

454 autØ
	g™
 = 
ÿÎ”_İs
.
fšd
(
e
.
»qid
);

456 ià(
	g™
 !ğ
ÿÎ”_İs
.
’d
(è&& 
™
->
£cÚd
 =ğ&
e
)

457 
ÿÎ”_İs
.
”a£
(
™
);

460 ià(
	gšdexed_d©a
 & 
	gPGLOG_INDEXED_EXTRA_CALLER_OPS
) {

461 autØ
	gj
 = 
e
.
exŒa_»qids
.
begš
();

462 
	gj
 !ğ
e
.
exŒa_»qids
.
’d
();

463 ++
	gj
) {

464 
	gûph
::
unÜd”ed_muÉim­
<
osd_»qid_t
,
	gpg_log_’Œy_t
*>::
™”©Ü
 
k
 =

465 
exŒa_ÿÎ”_İs
.
fšd
(
j
->
fœ¡
);

466 
	gk
 !ğ
exŒa_ÿÎ”_İs
.
’d
(è&& 
k
->
fœ¡
 =ğ
j
->first;

467 ++
	gk
) {

468 ià(
	gk
->
	g£cÚd
 =ğ&
e
) {

469 
exŒa_ÿÎ”_İs
.
”a£
(
k
);

477 
šdex
(
pg_log_dup_t
& 
e
) {

478 ià(
	gšdexed_d©a
 & 
	gPGLOG_INDEXED_DUPS
) {

479 
	gdup_šdex
[
e
.
»qid
] = &e;

483 
unšdex
(cÚ¡ 
pg_log_dup_t
& 
e
) {

484 ià(
	gšdexed_d©a
 & 
	gPGLOG_INDEXED_DUPS
) {

485 autØ
	gi
 = 
dup_šdex
.
fšd
(
e
.
»qid
);

486 ià(
	gi
 !ğ
dup_šdex
.
’d
()) {

487 
dup_šdex
.
”a£
(
i
);

493 
add
(cÚ¡ 
pg_log_’Œy_t
& 
e
, 
boŞ
 
­¶›d
 = 
Œue
) {

494 ià(!
­¶›d
) {

495 
as£¹
(
g‘_ÿn_rŞlback_to
(è=ğ
h—d
);

499 
	ge
.
	gmod_desc
.
Œim_bl
();

502 
	glog
.
push_back
(
e
);

505 ià(
	grŞlback_šfo_Œimmed_to_r™”
 =ğ
log
.
rbegš
())

506 ++
rŞlback_šfo_Œimmed_to_r™”
;

508 
as£¹
(
e
.
v”siÚ
 > 
h—d
);

509 
as£¹
(
h—d
.
v”siÚ
 =ğ0 || 
e
.version.version > head.version);

510 
	gh—d
 = 
e
.
v”siÚ
;

513 ià((
	gšdexed_d©a
 & 
	gPGLOG_INDEXED_OBJECTS
è&& 
	ge
.
objeù_is_šdexed
()) {

514 
	gobjeùs
[
e
.
soid
] = &(
log
.
back
());

516 ià(
	gšdexed_d©a
 & 
	gPGLOG_INDEXED_CALLER_OPS
) {

517 ià(
	ge
.
»qid_is_šdexed
()) {

518 
	gÿÎ”_İs
[
e
.
»qid
] = &(
log
.
back
());

522 ià(
	gšdexed_d©a
 & 
	gPGLOG_INDEXED_EXTRA_CALLER_OPS
) {

523 autØ
	gj
 = 
e
.
exŒa_»qids
.
begš
();

524 
	gj
 !ğ
e
.
exŒa_»qids
.
’d
();

525 ++
	gj
) {

526 
	gexŒa_ÿÎ”_İs
.
š£¹
(
make_·œ
(
j
->
fœ¡
, &(
log
.
back
())));

530 ià(!
	g­¶›d
) {

531 
sk_ÿn_rŞlback_to_to_h—d
();

535 
Œim
(

536 
C•hCÚ‹xt
* 
cù
,

537 
ev”siÚ_t
 
s
,

538 
£t
<
ev”siÚ_t
> *
Œimmed
,

539 
£t
<
¡ršg
>* 
Œimmed_dups
,

540 
ev”siÚ_t
 *
wr™e_äom_dups
);

542 
	go¡»am
& 
´št
(
o¡»am
& 
out
) const;

546 
	g´Ùeùed
:

549 
pg_missšg_Œack”_t
 
missšg
;

550 
IndexedLog
 
	glog
;

552 
ev”siÚ_t
 
	gdœty_to
;

553 
ev”siÚ_t
 
	gdœty_äom
;

554 
ev”siÚ_t
 
	gwr™eout_äom
;

555 
	g£t
<
	gev”siÚ_t
> 
	gŒimmed
;

556 
ev”siÚ_t
 
	gdœty_to_dups
;

557 
ev”siÚ_t
 
	gdœty_äom_dups
;

558 
ev”siÚ_t
 
	gwr™e_äom_dups
;

559 
	g£t
<
	g¡ršg
> 
	gŒimmed_dups
;

560 
C•hCÚ‹xt
 *
	gcù
;

561 
boŞ
 
	gpg_log_debug
;

563 
boŞ
 
	gtouched_log
;

564 
boŞ
 
	gş—r_div”g’t_´iÜs
;

565 
boŞ
 
	g»but_missšg_w™h_d–‘es
 = 
çl£
;

567 
	$m¬k_dœty_to
(
ev”siÚ_t
 
to
) {

568 ià(
to
 > 
dœty_to
)

569 
dœty_to
 = 
to
;

570 
	}
}

571 
	$m¬k_dœty_äom
(
ev”siÚ_t
 
äom
) {

572 ià(
äom
 < 
dœty_äom
)

573 
dœty_äom
 = 
äom
;

574 
	}
}

575 
	$m¬k_wr™eout_äom
(
ev”siÚ_t
 
äom
) {

576 ià(
äom
 < 
wr™eout_äom
)

577 
wr™eout_äom
 = 
äom
;

578 
	}
}

579 
	$m¬k_dœty_to_dups
(
ev”siÚ_t
 
to
) {

580 ià(
to
 > 
dœty_to_dups
)

581 
dœty_to_dups
 = 
to
;

582 
	}
}

583 
	$m¬k_dœty_äom_dups
(
ev”siÚ_t
 
äom
) {

584 ià(
äom
 < 
dœty_äom_dups
)

585 
dœty_äom_dups
 = 
äom
;

586 
	}
}

587 
	gpublic
:

588 
boŞ
 
	$is_dœty
() const {

589  !
touched_log
 ||

590 (
dœty_to
 !ğ
	`ev”siÚ_t
()) ||

591 (
dœty_äom
 !ğ
ev”siÚ_t
::
	`max
()) ||

592 (
wr™eout_äom
 !ğ
ev”siÚ_t
::
	`max
()) ||

593 !(
Œimmed
.
	`em±y
()) ||

594 !
missšg
.
	`is_ş—n
() ||

595 !(
Œimmed_dups
.
	`em±y
()) ||

596 (
dœty_to_dups
 !ğ
	`ev”siÚ_t
()) ||

597 (
dœty_äom_dups
 !ğ
ev”siÚ_t
::
	`max
()) ||

598 (
wr™e_äom_dups
 !ğ
ev”siÚ_t
::
	`max
()) ||

599 
»but_missšg_w™h_d–‘es
;

600 
	}
}

601 
	$m¬k_log_fÜ_»wr™e
() {

602 
	`m¬k_dœty_to
(
ev”siÚ_t
::
	`max
());

603 
	`m¬k_dœty_äom
(
	`ev”siÚ_t
());

604 
	`m¬k_dœty_to_dups
(
ev”siÚ_t
::
	`max
());

605 
	`m¬k_dœty_äom_dups
(
	`ev”siÚ_t
());

606 
touched_log
 = 
çl£
;

607 
	}
}

608 
boŞ
 
	$g‘_»but_missšg_w™h_d–‘es
() const {

609  
»but_missšg_w™h_d–‘es
;

610 
	}
}

611 
	g´Ùeùed
:

614 
£t
<
¡ršg
> 
log_keys_debug
;

615 
ş—r_aá”
(
£t
<
¡ršg
> *
log_keys_debug
, cÚ¡ sŒšg &
lb
) {

616 ià(!
	glog_keys_debug
)

618 
	g£t
<
	g¡ršg
>::
™”©Ü
 
i
 = 
log_keys_debug
->
low”_bound
(
lb
);

619 
	gi
 !ğ
log_keys_debug
->
’d
();

620 
	glog_keys_debug
->
”a£
(
i
++));

622 
ş—r_up_to
(
£t
<
¡ršg
> *
log_keys_debug
, cÚ¡ sŒšg &
ub
) {

623 ià(!
	glog_keys_debug
)

625 
	g£t
<
	g¡ršg
>::
™”©Ü
 
i
 = 
log_keys_debug
->
begš
();

626 
	gi
 !ğ
log_keys_debug
->
’d
(è&& *
i
 < 
ub
;

627 
	glog_keys_debug
->
”a£
(
i
++));

630 
check
();

631 
	$undœty
() {

632 
dœty_to
 = 
	`ev”siÚ_t
();

633 
dœty_äom
 = 
ev”siÚ_t
::
	`max
();

634 
touched_log
 = 
Œue
;

635 
Œimmed
.
	`ş—r
();

636 
Œimmed_dups
.
	`ş—r
();

637 
wr™eout_äom
 = 
ev”siÚ_t
::
	`max
();

638 
	`check
();

639 
missšg
.
	`æush
();

640 
dœty_to_dups
 = 
	`ev”siÚ_t
();

641 
dœty_äom_dups
 = 
ev”siÚ_t
::
	`max
();

642 
wr™e_äom_dups
 = 
ev”siÚ_t
::
	`max
();

643 
	}
}

644 
	gpublic
:

647 
	$PGLog
(
C•hCÚ‹xt
 *
cù
) :

648 
	`dœty_äom
(
ev”siÚ_t
::
	`max
()),

649 
	`wr™eout_äom
(
ev”siÚ_t
::
	`max
()),

650 
	`dœty_äom_dups
(
ev”siÚ_t
::
	`max
()),

651 
	`wr™e_äom_dups
(
ev”siÚ_t
::
	`max
()),

652 
	`cù
(
cù
),

653 
	`pg_log_debug
(!(
cù
 && !(cù->
_cÚf
->
osd_debug_pg_log_wr™eout
))),

654 
	`touched_log
(
çl£
),

655 
	$ş—r_div”g’t_´iÜs
(
çl£
)

656 { 
	}
}

658 
»£t_backfl
();

660 
ş—r
();

664 cÚ¡ 
	gpg_missšg_Œack”_t
& 
	$g‘_missšg
(ècÚ¡ {  
missšg
; 
	}
}

666 
	$missšg_add
(cÚ¡ 
hobjeù_t
& 
oid
, 
ev”siÚ_t
 
Ãed
,ƒv”siÚ_ˆ
have
, 
boŞ
 
is_d–‘e
=
çl£
) {

667 
missšg
.
	`add
(
oid
, 
Ãed
, 
have
, 
is_d–‘e
);

668 
	}
}

670 
	$missšg_add_Ãxt_’Œy
(cÚ¡ 
pg_log_’Œy_t
& 
e
) {

671 
missšg
.
	`add_Ãxt_ev’t
(
e
);

672 
	}
}

676 cÚ¡ 
	gIndexedLog
 &
	$g‘_log
(ècÚ¡ {  
log
; 
	}
}

678 cÚ¡ 
	gev”siÚ_t
 &
	$g‘_
(ècÚ¡ {  
log
.

; 
	}
}

680 
	$£t_
(
ev”siÚ_t
 

è{ 
log
. =a; 
	}
}

682 cÚ¡ 
	gev”siÚ_t
 &
	$g‘_h—d
(ècÚ¡ {  
log
.
h—d
; 
	}
}

684 
	$£t_h—d
(
ev”siÚ_t
 
h—d
è{ 
log
.h—d = h—d; 
	}
}

686 
	$£t_Ï¡_»que¡ed
(
v”siÚ_t
 
Ï¡_»que¡ed
) {

687 
log
.
Ï¡_»que¡ed
 =†ast_requested;

688 
	}
}

690 
	$šdex
(è{ 
log
.
	`šdex
(); 
	}
}

692 
	$unšdex
(è{ 
log
.
	`unšdex
(); 
	}
}

694 
	$add
(cÚ¡ 
pg_log_’Œy_t
& 
e
, 
boŞ
 
­¶›d
 = 
Œue
) {

695 
	`m¬k_wr™eout_äom
(
e
.
v”siÚ
);

696 
log
.
	`add
(
e
, 
­¶›d
);

697 
	}
}

699 
	$»£t_»cov”y_poš‹rs
(è{ 
log
.
	`»£t_»cov”y_poš‹rs
(); 
	}
}

701 
ş—r_šfo_log
(

702 
¥g_t
 
pgid
,

703 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

705 
Œim
(

706 
ev”siÚ_t
 
Œim_to
,

707 
pg_šfo_t
 &
šfo
);

709 
	$rŞl_fÜw¬d_to
(

710 
ev”siÚ_t
 
rŞl_fÜw¬d_to
,

711 
LogEÁryHªdËr
 *
h
) {

712 
log
.
	`rŞl_fÜw¬d_to
(

713 
rŞl_fÜw¬d_to
,

714 
h
);

715 
	}
}

717 
ev”siÚ_t
 
	$g‘_ÿn_rŞlback_to
() const {

718  
log
.
	`g‘_ÿn_rŞlback_to
();

719 
	}
}

721 
	$rŞl_fÜw¬d
(
LogEÁryHªdËr
 *
h
) {

722 
	`rŞl_fÜw¬d_to
(

723 
log
.
h—d
,

724 
h
);

725 
	}
}

729 
	$»£t_backfl_şaim_log
(cÚ¡ 
pg_log_t
 &
o
, 
LogEÁryHªdËr
 *
h
) {

730 
log
.
	`Œim_rŞlback_šfo_to
Öog.
h—d
, 
h
);

731 
log
.
	`şaim_log_ªd_ş—r_rŞlback_šfo
(
o
);

732 
missšg
.
	`ş—r
();

733 
	`m¬k_dœty_to
(
ev”siÚ_t
::
	`max
());

734 
	`m¬k_dœty_to_dups
(
ev”siÚ_t
::
	`max
());

735 
	}
}

737 
	$¥l™_što
(

738 
pg_t
 
chd_pgid
,

739 
¥l™_b™s
,

740 
PGLog
 *
İg_log
) {

741 
log
.
	`¥l™_out_chd
(
chd_pgid
, 
¥l™_b™s
, &
İg_log
->log);

742 
missšg
.
	`¥l™_što
(
chd_pgid
, 
¥l™_b™s
, &(
İg_log
->missing));

743 
İg_log
->
	`m¬k_dœty_to
(
ev”siÚ_t
::
	`max
());

744 
İg_log
->
	`m¬k_dœty_to_dups
(
ev”siÚ_t
::
	`max
());

745 
	`m¬k_dœty_to
(
ev”siÚ_t
::
	`max
());

746 
	`m¬k_dœty_to_dups
(
ev”siÚ_t
::
	`max
());

747 ià(
missšg
.
may_šşude_d–‘es
)

748 
İg_log
->
»but_missšg_w™h_d–‘es
 = 
Œue
;

749 
	}
}

751 
	$»cov”_gÙ
(
hobjeù_t
 
oid
, 
ev”siÚ_t
 
v
, 
pg_šfo_t
 &
šfo
) {

752 ià(
missšg
.
	`is_missšg
(
oid
, 
v
)) {

753 
missšg
.
	`gÙ
(
oid
, 
v
);

756 ià(
missšg
.
	`g‘_™ems
().
	`em±y
()) {

757 
log
.
com¶‘e_to
 =†og.log.
	`’d
();

758 
šfo
.
Ï¡_com¶‘e
 = info.
Ï¡_upd©e
;

760 autØ
Şde¡_Ãed
 = 
missšg
.
	`g‘_Şde¡_Ãed
();

761 
log
.
com¶‘e_to
 !ğlog.log.
	`’d
()) {

762 ià(
Şde¡_Ãed
 <ğ
log
.
com¶‘e_to
->
v”siÚ
)

764 ià(
šfo
.
Ï¡_com¶‘e
 < 
log
.
com¶‘e_to
->
v”siÚ
)

765 
šfo
.
Ï¡_com¶‘e
 = 
log
.
com¶‘e_to
->
v”siÚ
;

766 ++
log
.
com¶‘e_to
;

770 
	`as£¹
(
log
.
	`g‘_ÿn_rŞlback_to
(è>ğ
v
);

771 
	}
}

773 
	$»£t_com¶‘e_to
(
pg_šfo_t
 *
šfo
) {

774 
log
.
com¶‘e_to
 =†og.log.
	`begš
();

775 
	`as£¹
(
log
.
com¶‘e_to
 !ğlog.log.
	`’d
());

776 autØ
Şde¡_Ãed
 = 
missšg
.
	`g‘_Şde¡_Ãed
();

777 ià(
Şde¡_Ãed
 !ğ
	`ev”siÚ_t
()) {

778 
log
.
com¶‘e_to
->
v”siÚ
 < 
Şde¡_Ãed
) {

779 ++
log
.
com¶‘e_to
;

780 
	`as£¹
(
log
.
com¶‘e_to
 !ğlog.log.
	`’d
());

783 ià(!
šfo
)

785 ià(
log
.
com¶‘e_to
 =ğlog.log.
	`begš
()) {

786 
šfo
->
Ï¡_com¶‘e
 = 
	`ev”siÚ_t
();

788 --
log
.
com¶‘e_to
;

789 
šfo
->
Ï¡_com¶‘e
 = 
log
.
com¶‘e_to
->
v”siÚ
;

790 ++
log
.
com¶‘e_to
;

792 
	}
}

794 
	$aùiv©e_nÙ_com¶‘e
(
pg_šfo_t
 &
šfo
) {

795 
	`»£t_com¶‘e_to
(&
šfo
);

796 
log
.
Ï¡_»que¡ed
 = 0;

797 
	}
}

799 
	$´oc_»¶iÿ_log
(
pg_šfo_t
 &
ošfo
,

800 cÚ¡ 
pg_log_t
 &
Şog
,

801 
pg_missšg_t
& 
omissšg
, 
pg_sh¬d_t
 
äom
) const;

803 
	`»bud_missšg_£t_w™h_d–‘es
(
ObjeùStÜe
 *
¡Üe
,

804 
ObjeùStÜe
::
CŞËùiÚHªdË
& 
ch
,

805 cÚ¡ 
pg_šfo_t
 &
šfo
);

807 
´Ùeùed
:

808 
	`¥l™_by_objeù
(

809 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> &
’Œ›s
,

810 
m­
<
hobjeù_t
, 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
>> *
out_’Œ›s
) {

811 !
’Œ›s
.
	`em±y
()) {

812 autØ&
out_li¡
 = (*
out_’Œ›s
)[
’Œ›s
.
	`äÚt
().
soid
];

813 
out_li¡
.
	`¥liû
(out_li¡.
	`’d
(), 
’Œ›s
,ƒÁr›s.
	`begš
());

815 
	}
}

837 
	g‹m¶©e
 <
ty³Çme
 
	gmissšg_ty³
>

838 
_m”ge_objeù_div”g’t_’Œ›s
(

839 cÚ¡ 
IndexedLog
 &
log
,

840 cÚ¡ 
hobjeù_t
 &
hoid
,

841 cÚ¡ 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> &
Üig_’Œ›s
,

842 cÚ¡ 
pg_šfo_t
 &
šfo
,

843 
ev”siÚ_t
 
Şog_ÿn_rŞlback_to
,

844 
missšg_ty³
 &
missšg
,

845 
LogEÁryHªdËr
 *
rŞlback”
,

846 cÚ¡ 
DoutP»fixProvid”
 *
dµ


848 
ldµ_dout
(
dµ
, 20è<< 
	g__func__
 << ": m”gšg hoid " << 
	ghoid


849 << "ƒÁr›s: " << 
	gÜig_’Œ›s
 << 
	gd’dl
;

851 ià(
	ghoid
 > 
	gšfo
.
	gÏ¡_backfl
) {

852 
ldµ_dout
(
dµ
, 10è<< 
	g__func__
 << ": hoid " << 
	ghoid
 << "‡fter†ast_backfill"

853 << 
	gd’dl
;

858 
as£¹
(!
Üig_’Œ›s
.
em±y
());

860 
	gmempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> 
’Œ›s
;

861 
ev”siÚ_t
 
	gÏ¡
;

862 
boŞ
 
	g£’_nÚ_”rÜ
 = 
çl£
;

863 
	gli¡
<
	gpg_log_’Œy_t
>::
cÚ¡_™”©Ü
 
i
 = 
Üig_’Œ›s
.
begš
();

864 
	gi
 !ğ
Üig_’Œ›s
.
’d
();

865 ++
	gi
) {

867 
as£¹
(
i
->
soid
 =ğ
hoid
);

870 
boŞ
 
	gfœ¡_nÚ_”rÜ
 = ! 
£’_nÚ_”rÜ
 && ! 
i
->
is_”rÜ
();

871 ià(! 
	gi
->
is_”rÜ
() ) {

873 
	g£’_nÚ_”rÜ
 = 
Œue
;

881 ià(
	gi
 !ğ
Üig_’Œ›s
.
begš
(è&& 
i
->
´iÜ_v”siÚ
 !ğ
ev”siÚ_t
() &&

882 ! 
fœ¡_nÚ_”rÜ
) {

884 
as£¹
(
i
->
v”siÚ
 > 
Ï¡
);

886 
as£¹
(
i
->
´iÜ_v”siÚ
 =ğ
Ï¡
 || i->
is_”rÜ
());

888 ià(
	gi
->
is_”rÜ
()) {

889 
ldµ_dout
(
dµ
, 20è<< 
	g__func__
 << ": ignÜšg " << *
	gi
 << 
	gd’dl
;

891 
ldµ_dout
(
dµ
, 20è<< 
	g__func__
 << ": k“pšg " << *
	gi
 << 
	gd’dl
;

892 
	g’Œ›s
.
push_back
(*
i
);

893 
	gÏ¡
 = 
i
->
v”siÚ
;

896 ià(
	g’Œ›s
.
em±y
()) {

897 
ldµ_dout
(
dµ
, 10è<< 
	g__func__
 << ":‚ØnÚ-ERRORƒÁr›s" << 
	gd’dl
;

901 cÚ¡ 
ev”siÚ_t
 
	g´iÜ_v”siÚ
 = 
’Œ›s
.
begš
()->
´iÜ_v”siÚ
;

902 cÚ¡ 
ev”siÚ_t
 
	gfœ¡_div”g’t_upd©e
 = 
’Œ›s
.
begš
()->
v”siÚ
;

903 cÚ¡ 
ev”siÚ_t
 
	gÏ¡_div”g’t_upd©e
 = 
’Œ›s
.
rbegš
()->
v”siÚ
;

904 cÚ¡ 
boŞ
 
	gobjeù_nÙ_š_¡Üe
 =

905 !
missšg
.
is_missšg
(
hoid
) &&

906 
’Œ›s
.
rbegš
()->
is_d–‘e
();

907 
ldµ_dout
(
dµ
, 10è<< 
	g__func__
 << ": hoid " << 
	ghoid


908 << "…riÜ_v”siÚ: " << 
	g´iÜ_v”siÚ


909 << " fœ¡_div”g’t_upd©e: " << 
	gfœ¡_div”g’t_upd©e


910 << "†a¡_div”g’t_upd©e: " << 
	gÏ¡_div”g’t_upd©e


911 << 
	gd’dl
;

913 
	gûph
::
unÜd”ed_m­
<
hobjeù_t
, 
	gpg_log_’Œy_t
*>::
cÚ¡_™”©Ü
 
obj™”
 =

914 
log
.
objeùs
.
fšd
(
hoid
);

915 ià(
	gobj™”
 !ğ
log
.
objeùs
.
’d
() &&

916 
obj™”
->
£cÚd
->
v”siÚ
 >ğ
fœ¡_div”g’t_upd©e
) {

918 
ldµ_dout
(
dµ
, 10è<< 
__func__
 << ": more„ecentƒntry found: "

919 << *
obj™”
->
£cÚd
 << ",‡Ì—dy m”ged" << 
d’dl
;

921 
as£¹
(
obj™”
->
£cÚd
->
v”siÚ
 > 
Ï¡_div”g’t_upd©e
);

924 ià(
	gobj™”
->
	g£cÚd
->
is_upd©e
() ||

925 (
	gmissšg
.
	gmay_šşude_d–‘es
 && 
	gobj™”
->
	g£cÚd
->
is_d–‘e
())) {

926 
as£¹
(
missšg
.
is_missšg
(
hoid
) &&

927 
missšg
.
g‘_™ems
().
©
(
hoid
).
Ãed
 =ğ
obj™”
->
£cÚd
->
v”siÚ
);

929 
as£¹
(!
missšg
.
is_missšg
(
hoid
));

931 
	gmissšg
.
»vi£_have
(
hoid
, 
ev”siÚ_t
());

932 ià(
	grŞlback”
) {

933 ià(!
	gobjeù_nÙ_š_¡Üe
) {

934 
	grŞlback”
->
»move
(
hoid
);

936 autØ&&
	gi
: 
’Œ›s
) {

937 
rŞlback”
->
Œim
(
i
);

943 
ldµ_dout
(
dµ
, 10è<< 
	g__func__
 << ": hoid " << 
	ghoid


944 <<" ha nØmÜ»ûÁƒÁr› š†og" << 
	gd’dl
;

945 ià(
	g´iÜ_v”siÚ
 =ğ
ev”siÚ_t
(è|| 
’Œ›s
.
äÚt
().
is_şÚe
()) {

947 
ldµ_dout
(
dµ
, 10è<< 
__func__
 << ": hoid " << 
hoid


950 << 
d’dl
;

951 ià(
	gmissšg
.
is_missšg
(
hoid
))

952 
	gmissšg
.
rm
(
missšg
.
g‘_™ems
().
fšd
(
hoid
));

953 ià(
	grŞlback”
) {

954 ià(!
	gobjeù_nÙ_š_¡Üe
) {

955 
	grŞlback”
->
»move
(
hoid
);

957 autØ&&
	gi
: 
’Œ›s
) {

958 
rŞlback”
->
Œim
(
i
);

964 ià(
	gmissšg
.
is_missšg
(
hoid
)) {

966 
ldµ_dout
(
dµ
, 10è<< 
	g__func__
 << ": hoid " << 
	ghoid


967 << " missšg, " << 
	gmissšg
.
g‘_™ems
().
©
(
hoid
)

968 << "‡dju¡šg" << 
	gd’dl
;

970 ià(
	gmissšg
.
g‘_™ems
().
©
(
hoid
).
	ghave
 =ğ
´iÜ_v”siÚ
) {

971 
ldµ_dout
(
dµ
, 10è<< 
__func__
 << ": hoid " << 
hoid


972 << " missšg.havi ´iÜ_v”siÚ " << 
´iÜ_v”siÚ


973 << "„emovšg from missšg" << 
d’dl
;

974 
	gmissšg
.
rm
(
missšg
.
g‘_™ems
().
fšd
(
hoid
));

976 
ldµ_dout
(
dµ
, 10è<< 
	g__func__
 << ": hoid " << 
	ghoid


977 << " missšg.havi " << 
	gmissšg
.
g‘_™ems
().
©
(
hoid
).
	ghave


978 << ",‡dju¡šg" << 
	gd’dl
;

979 
	gmissšg
.
»vi£_Ãed
(
hoid
, 
´iÜ_v”siÚ
, 
çl£
);

980 ià(
	g´iÜ_v”siÚ
 <ğ
šfo
.
log_
) {

981 
ldµ_dout
(
dµ
, 10è<< 
__func__
 << ": hoid " << 
hoid


982 << "…riÜ_v”siÚ " << 
´iÜ_v”siÚ


984 << 
šfo
.
log_
 << 
d’dl
;

987 ià(
	grŞlback”
) {

988 autØ&&
	gi
: 
’Œ›s
) {

989 
rŞlback”
->
Œim
(
i
);

995 
ldµ_dout
(
dµ
, 10è<< 
	g__func__
 << ": hoid " << 
	ghoid


998 << 
	gd’dl
;

999 
boŞ
 
	gÿn_rŞlback
 = 
Œue
;

1001 
	gli¡
<
	gpg_log_’Œy_t
>::
cÚ¡_»v”£_™”©Ü
 
i
 = 
’Œ›s
.
rbegš
();

1002 
	gi
 !ğ
’Œ›s
.
»nd
();

1003 ++
	gi
) {

1004 ià(!
	gi
->
ÿn_rŞlback
(è|| i->
	gv”siÚ
 <ğ
Şog_ÿn_rŞlback_to
) {

1005 
ldµ_dout
(
dµ
, 10è<< 
__func__
 << ": hoid " << 
hoid
 << " cannot„ollback "

1006 << *
i
 << 
d’dl
;

1007 
	gÿn_rŞlback
 = 
çl£
;

1012 ià(
	gÿn_rŞlback
) {

1014 
	gli¡
<
	gpg_log_’Œy_t
>::
cÚ¡_»v”£_™”©Ü
 
i
 = 
’Œ›s
.
rbegš
();

1015 
	gi
 !ğ
’Œ›s
.
»nd
();

1016 ++
	gi
) {

1017 
as£¹
(
i
->
ÿn_rŞlback
(è&& i->
v”siÚ
 > 
Şog_ÿn_rŞlback_to
);

1018 
ldµ_dout
(
dµ
, 10è<< 
	g__func__
 << ": hoid " << 
	ghoid


1019 << "„Şlšg back " << *
	gi
 << 
	gd’dl
;

1020 ià(
	grŞlback”
)

1021 
	grŞlback”
->
rŞlback
(*
i
);

1023 
ldµ_dout
(
dµ
, 10è<< 
	g__func__
 << ": hoid " << 
	ghoid


1024 << "„ŞËd back" << 
	gd’dl
;

1028 
ldµ_dout
(
dµ
, 10è<< 
	g__func__
 << ": hoid " << 
	ghoid
 << " cannot„oll back, "

1029 << "»movšg‡nd‡ddšgØmissšg" << 
	gd’dl
;

1030 ià(
	grŞlback”
) {

1031 ià(!
	gobjeù_nÙ_š_¡Üe
)

1032 
	grŞlback”
->
»move
(
hoid
);

1033 autØ&&
	gi
: 
’Œ›s
) {

1034 
rŞlback”
->
Œim
(
i
);

1037 
	gmissšg
.
add
(
hoid
, 
´iÜ_v”siÚ
, 
ev”siÚ_t
(), 
çl£
);

1038 ià(
	g´iÜ_v”siÚ
 <ğ
šfo
.
log_
) {

1039 
ldµ_dout
(
dµ
, 10è<< 
__func__
 << ": hoid " << 
hoid


1040 << "…riÜ_v”siÚ " << 
´iÜ_v”siÚ


1042 << 
šfo
.
log_
 << 
d’dl
;

1048 
	g‹m¶©e
 <
ty³Çme
 
	gmissšg_ty³
>

1049 
_m”ge_div”g’t_’Œ›s
(

1050 cÚ¡ 
IndexedLog
 &
log
,

1051 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> &
’Œ›s
,

1052 cÚ¡ 
pg_šfo_t
 &
ošfo
,

1053 
ev”siÚ_t
 
Şog_ÿn_rŞlback_to
,

1054 
missšg_ty³
 &
omissšg
,

1055 
LogEÁryHªdËr
 *
rŞlback”
,

1056 cÚ¡ 
DoutP»fixProvid”
 *
dµ


1058 
	gm­
<
	ghobjeù_t
, 
	gmempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> > 
¥l™
;

1059 
¥l™_by_objeù
(
’Œ›s
, &
¥l™
);

1060 
	gm­
<
	ghobjeù_t
, 
	gmempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
>>::
™”©Ü
 
i
 = 
¥l™
.
begš
();

1061 
	gi
 !ğ
¥l™
.
’d
();

1062 ++
	gi
) {

1063 
_m”ge_objeù_div”g’t_’Œ›s
(

1064 
log
,

1065 
i
->
fœ¡
,

1066 
i
->
£cÚd
,

1067 
ošfo
,

1068 
Şog_ÿn_rŞlback_to
,

1069 
omissšg
,

1070 
rŞlback”
,

1071 
dµ
);

1079 
	$m”ge_Şd_’Œy
(

1080 
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
,

1081 cÚ¡ 
pg_log_’Œy_t
& 
Û
,

1082 cÚ¡ 
pg_šfo_t
& 
šfo
,

1083 
LogEÁryHªdËr
 *
rŞlback”
) {

1084 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> 
’Œ›s
;

1085 
’Œ›s
.
	`push_back
(
Û
);

1086 
	`_m”ge_objeù_div”g’t_’Œ›s
(

1087 
log
,

1088 
Û
.
soid
,

1089 
’Œ›s
,

1090 
šfo
,

1091 
log
.
	`g‘_ÿn_rŞlback_to
(),

1092 
missšg
,

1093 
rŞlback”
,

1094 
this
);

1095 
	}
}

1097 
boŞ
 
m”ge_log_dups
(cÚ¡ 
pg_log_t
& 
Şog
);

1099 
	gpublic
:

1101 
»wšd_div”g’t_log
(
ev”siÚ_t
 
Ãwh—d
,

1102 
pg_šfo_t
 &
šfo
,

1103 
LogEÁryHªdËr
 *
rŞlback”
,

1104 
boŞ
 &
dœty_šfo
,

1105 
boŞ
 &
dœty_big_šfo
);

1107 
m”ge_log
(
pg_šfo_t
 &
ošfo
,

1108 
pg_log_t
 &
Şog
,

1109 
pg_sh¬d_t
 
äom
,

1110 
pg_šfo_t
 &
šfo
, 
LogEÁryHªdËr
 *
rŞlback”
,

1111 
boŞ
 &
dœty_šfo
, boŞ &
dœty_big_šfo
);

1113 
	g‹m¶©e
 <
ty³Çme
 
	gmissšg_ty³
>

1114 
boŞ
 
­³nd_log_’Œ›s_upd©e_missšg
(

1115 cÚ¡ 
hobjeù_t
 &
Ï¡_backfl
,

1116 
boŞ
 
Ï¡_backfl_b™wi£
,

1117 cÚ¡ 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> &
’Œ›s
,

1118 
boŞ
 
mašš_rŞlback
,

1119 
IndexedLog
 *
log
,

1120 
missšg_ty³
 &
missšg
,

1121 
LogEÁryHªdËr
 *
rŞlback”
,

1122 cÚ¡ 
DoutP»fixProvid”
 *
dµ
) {

1123 
boŞ
 
	gšv®id©e_¡©s
 = 
çl£
;

1124 ià(
	glog
 && !
	g’Œ›s
.
em±y
()) {

1125 
as£¹
(
log
->
h—d
 < 
’Œ›s
.
begš
()->
v”siÚ
);

1127 
	gli¡
<
	gpg_log_’Œy_t
>::
cÚ¡_™”©Ü
 
p
 = 
’Œ›s
.
begš
();

1128 
	gp
 !ğ
’Œ›s
.
’d
();

1129 ++
	gp
) {

1130 
	gšv®id©e_¡©s
 = 
šv®id©e_¡©s
 || !
p
->
is_”rÜ
();

1131 ià(
	glog
) {

1132 
ldµ_dout
(
dµ
, 20è<< "upd©missšg,‡µ’d " << *
	gp
 << 
	gd’dl
;

1133 
	glog
->
add
(*
p
);

1135 ià(
	gp
->
	gsoid
 <ğ
Ï¡_backfl
 &&

1136 !
p
->
is_”rÜ
()) {

1137 ià(
missšg
.
may_šşude_d–‘es
) {

1138 
missšg
.
add_Ãxt_ev’t
(*
p
);

1140 ià(
	gp
->
is_d–‘e
()) {

1141 
	gmissšg
.
rm
(
p
->
soid
,…->
v”siÚ
);

1143 
	gmissšg
.
add_Ãxt_ev’t
(*
p
);

1145 ià(
	grŞlback”
) {

1147 ià(
	gmašš_rŞlback
 && 
	gp
->
is_lo¡_d–‘e
(è&&…->
ÿn_rŞlback
()) {

1148 
	grŞlback”
->
Œy_¡ash
(
p
->
soid
,…->
v”siÚ
.version);

1149 } ià(
	gp
->
is_d–‘e
()) {

1150 
	grŞlback”
->
»move
(
p
->
soid
);

1156  
	gšv®id©e_¡©s
;

1158 
boŞ
 
­³nd_Ãw_log_’Œ›s
(

1159 cÚ¡ 
hobjeù_t
 &
Ï¡_backfl
,

1160 
boŞ
 
Ï¡_backfl_b™wi£
,

1161 cÚ¡ 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> &
’Œ›s
,

1162 
LogEÁryHªdËr
 *
rŞlback”
) {

1163 
boŞ
 
	gšv®id©e_¡©s
 = 
­³nd_log_’Œ›s_upd©e_missšg
(

1164 
Ï¡_backfl
,

1165 
Ï¡_backfl_b™wi£
,

1166 
’Œ›s
,

1167 
Œue
,

1168 &
log
,

1169 
missšg
,

1170 
rŞlback”
,

1171 
this
);

1172 ià(!
	g’Œ›s
.
em±y
()) {

1173 
m¬k_wr™eout_äom
(
’Œ›s
.
begš
()->
v”siÚ
);

1174 ià(
	g’Œ›s
.
begš
()->
is_lo¡_d–‘e
()) {

1183 
»£t_com¶‘e_to
(
nuÎ±r
);

1186  
	gšv®id©e_¡©s
;

1189 
wr™e_log_ªd_missšg
(

1190 
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
,

1191 
m­
<
¡ršg
,
bufã¾i¡
> *
km
,

1192 cÚ¡ 
cŞl_t
& 
cŞl
,

1193 cÚ¡ 
ghobjeù_t
 &
log_oid
,

1194 
boŞ
 
»quœe_rŞlback
);

1196 
wr™e_log_ªd_missšg_wo_missšg
(

1197 
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
,

1198 
m­
<
¡ršg
,
bufã¾i¡
>* 
km
,

1199 
pg_log_t
 &
log
,

1200 cÚ¡ 
cŞl_t
& 
cŞl
,

1201 cÚ¡ 
ghobjeù_t
 &
log_oid
, 
m­
<
ev”siÚ_t
, 
hobjeù_t
> &
div”g’t_´iÜs
,

1202 
boŞ
 
»quœe_rŞlback
);

1204 
wr™e_log_ªd_missšg
(

1205 
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
,

1206 
m­
<
¡ršg
,
bufã¾i¡
>* 
km
,

1207 
pg_log_t
 &
log
,

1208 cÚ¡ 
cŞl_t
& 
cŞl
,

1209 cÚ¡ 
ghobjeù_t
 &
log_oid
,

1210 cÚ¡ 
pg_missšg_Œack”_t
 &
missšg
,

1211 
boŞ
 
»quœe_rŞlback
,

1212 
boŞ
 *
»but_missšg_£t_w™h_d–‘es
);

1214 
_wr™e_log_ªd_missšg_wo_missšg
(

1215 
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
,

1216 
m­
<
¡ršg
,
bufã¾i¡
>* 
km
,

1217 
pg_log_t
 &
log
,

1218 cÚ¡ 
cŞl_t
& 
cŞl
, cÚ¡ 
ghobjeù_t
 &
log_oid
,

1219 
m­
<
ev”siÚ_t
, 
hobjeù_t
> &
div”g’t_´iÜs
,

1220 
ev”siÚ_t
 
dœty_to
,

1221 
ev”siÚ_t
 
dœty_äom
,

1222 
ev”siÚ_t
 
wr™eout_äom
,

1223 
boŞ
 
dœty_div”g’t_´iÜs
,

1224 
boŞ
 
touch_log
,

1225 
boŞ
 
»quœe_rŞlback
,

1226 
ev”siÚ_t
 
dœty_to_dups
,

1227 
ev”siÚ_t
 
dœty_äom_dups
,

1228 
ev”siÚ_t
 
wr™e_äom_dups
,

1229 
£t
<
¡ršg
> *
log_keys_debug


1232 
_wr™e_log_ªd_missšg
(

1233 
ObjeùStÜe
::
T¿n§ùiÚ
& 
t
,

1234 
m­
<
¡ršg
,
bufã¾i¡
>* 
km
,

1235 
pg_log_t
 &
log
,

1236 cÚ¡ 
cŞl_t
& 
cŞl
, cÚ¡ 
ghobjeù_t
 &
log_oid
,

1237 
ev”siÚ_t
 
dœty_to
,

1238 
ev”siÚ_t
 
dœty_äom
,

1239 
ev”siÚ_t
 
wr™eout_äom
,

1240 
£t
<
ev”siÚ_t
> &&
Œimmed
,

1241 
£t
<
¡ršg
> &&
Œimmed_dups
,

1242 cÚ¡ 
pg_missšg_Œack”_t
 &
missšg
,

1243 
boŞ
 
touch_log
,

1244 
boŞ
 
»quœe_rŞlback
,

1245 
boŞ
 
ş—r_div”g’t_´iÜs
,

1246 
ev”siÚ_t
 
dœty_to_dups
,

1247 
ev”siÚ_t
 
dœty_äom_dups
,

1248 
ev”siÚ_t
 
wr™e_äom_dups
,

1249 
boŞ
 *
»but_missšg_w™h_d–‘es
,

1250 
£t
<
¡ršg
> *
log_keys_debug


1253 
	$»ad_log_ªd_missšg
(

1254 
ObjeùStÜe
 *
¡Üe
,

1255 
ObjeùStÜe
::
CŞËùiÚHªdË
& 
ch
,

1256 
ghobjeù_t
 
pgm‘a_oid
,

1257 cÚ¡ 
pg_šfo_t
 &
šfo
,

1258 
o¡ršg¡»am
 &
oss
,

1259 
boŞ
 
tŞ”©e_div”g’t_missšg_log
,

1260 
boŞ
 
debug_v”ify_¡Üed_missšg
 = 
çl£


1262  
	`»ad_log_ªd_missšg
(

1263 
¡Üe
, 
ch
, 
pgm‘a_oid
, 
šfo
,

1264 
log
, 
missšg
, 
oss
,

1265 
tŞ”©e_div”g’t_missšg_log
,

1266 &
ş—r_div”g’t_´iÜs
,

1267 
this
,

1268 (
pg_log_debug
 ? &
log_keys_debug
 : 
nuÎ±r
),

1269 
debug_v”ify_¡Üed_missšg
);

1270 
	}
}

1272 
	g‹m¶©e
 <
ty³Çme
 
	gmissšg_ty³
>

1273 
»ad_log_ªd_missšg
(

1274 
ObjeùStÜe
 *
¡Üe
,

1275 
ObjeùStÜe
::
CŞËùiÚHªdË
 &
ch
,

1276 
ghobjeù_t
 
pgm‘a_oid
,

1277 cÚ¡ 
pg_šfo_t
 &
šfo
,

1278 
IndexedLog
 &
log
,

1279 
missšg_ty³
 &
missšg
,

1280 
o¡ršg¡»am
 &
oss
,

1281 
boŞ
 
tŞ”©e_div”g’t_missšg_log
,

1282 
boŞ
 *
ş—r_div”g’t_´iÜs
 = 
nuÎ±r
,

1283 cÚ¡ 
DoutP»fixProvid”
 *
dµ
 = 
nuÎ±r
,

1284 
£t
<
¡ršg
> *
log_keys_debug
 = 
nuÎ±r
,

1285 
boŞ
 
debug_v”ify_¡Üed_missšg
 = 
çl£


1287 
ldµ_dout
(
dµ
, 20è<< "»ad_log_ªd_missšg cŞÈ" << 
ch
->
cid


1288 << " " << 
pgm‘a_oid
 << 
d’dl
;

1291 
¡©
 
	g¡
;

1292 
	gr
 = 
¡Üe
->
¡©
(
ch
, 
pgm‘a_oid
, &
¡
);

1293 
as£¹
(
r
 == 0);

1294 
as£¹
(
¡
.
¡_size
 == 0);

1297 
ev”siÚ_t
 
	gÚ_disk_ÿn_rŞlback_to
 = 
šfo
.
Ï¡_upd©e
;

1298 
ev”siÚ_t
 
	gÚ_disk_rŞlback_šfo_Œimmed_to
 =ƒversion_t();

1299 
	gObjeùM­
::
ObjeùM­I‹¿tÜ
 
p
 = 
¡Üe
->
g‘_om­_™”©Ü
(
ch
,

1300 
pgm‘a_oid
);

1301 
	gm­
<
	gev”siÚ_t
, 
	ghobjeù_t
> 
	gdiv”g’t_´iÜs
;

1302 
boŞ
 
	gmu¡_»bud
 = 
çl£
;

1303 
	gmissšg
.
	gmay_šşude_d–‘es
 = 
çl£
;

1304 
	gli¡
<
	gpg_log_’Œy_t
> 
	g’Œ›s
;

1305 
	gli¡
<
	gpg_log_dup_t
> 
	gdups
;

1306 ià(
	gp
) {

1307 
	gp
->
£ek_to_fœ¡
();…->
v®id
(è;…->
Ãxt
(
çl£
)) {

1309 ià(
	gp
->
key
()[0] == '_')

1311 
bufã¾i¡
 
	gbl
 = 
p
->
v®ue
();

1312 
	gbufã¾i¡
::
™”©Ü
 
bp
 = 
bl
.
begš
();

1313 ià(
	gp
->
key
() == "divergent_priors") {

1314 
decode
(
div”g’t_´iÜs
, 
bp
);

1315 
ldµ_dout
(
dµ
, 20è<< "»ad_log_ªd_missšg " << 
	gdiv”g’t_´iÜs
.
size
()

1316 << " div”g’t_´iÜs" << 
	gd’dl
;

1317 
	gmu¡_»bud
 = 
Œue
;

1318 
	gdebug_v”ify_¡Üed_missšg
 = 
çl£
;

1319 } ià(
	gp
->
key
() == "can_rollback_to") {

1320 
decode
(
Ú_disk_ÿn_rŞlback_to
, 
bp
);

1321 } ià(
	gp
->
key
() == "rollback_info_trimmed_to") {

1322 
decode
(
Ú_disk_rŞlback_šfo_Œimmed_to
, 
bp
);

1323 } ià(
	gp
->
key
() == "may_include_deletes_in_missing") {

1324 
missšg
.
may_šşude_d–‘es
 = 
Œue
;

1325 } ià(
	gp
->
key
().
sub¡r
(0, 7è=ğ
¡ršg
("missing")) {

1326 
hobjeù_t
 
oid
;

1327 
pg_missšg_™em
 
	g™em
;

1328 
decode
(
oid
, 
bp
);

1329 
decode
(
™em
, 
bp
);

1330 ià(
	g™em
.
is_d–‘e
()) {

1331 
as£¹
(
missšg
.
may_šşude_d–‘es
);

1333 
	gmissšg
.
add
(
oid
, 
™em
.
Ãed
, i‹m.
have
, i‹m.
is_d–‘e
());

1334 } ià(
	gp
->
key
().
sub¡r
(0, 4è=ğ
¡ršg
("dup_")) {

1335 
pg_log_dup_t
 
dup
;

1336 
decode
(
dup
, 
bp
);

1337 ià(!
	gdups
.
em±y
()) {

1338 
as£¹
(
dups
.
back
().
v”siÚ
 < 
dup
.version);

1340 
	gdups
.
push_back
(
dup
);

1342 
pg_log_’Œy_t
 
	ge
;

1343 
	ge
.
decode_w™h_checksum
(
bp
);

1344 
ldµ_dout
(
dµ
, 20è<< "»ad_log_ªd_missšg " << 
	ge
 << 
	gd’dl
;

1345 ià(!
	g’Œ›s
.
em±y
()) {

1346 
pg_log_’Œy_t
 
Ï¡_e
(
’Œ›s
.
back
());

1347 
as£¹
(
Ï¡_e
.
v”siÚ
.v”siÚ < 
e
.version.version);

1348 
as£¹
(
Ï¡_e
.
v”siÚ
.
•och
 <ğ
e
.version.epoch);

1350 
	g’Œ›s
.
push_back
(
e
);

1351 ià(
	glog_keys_debug
)

1352 
	glog_keys_debug
->
š£¹
(
e
.
g‘_key_Çme
());

1356 
	glog
 = 
IndexedLog
(

1357 
šfo
.
Ï¡_upd©e
,

1358 
šfo
.
log_
,

1359 
Ú_disk_ÿn_rŞlback_to
,

1360 
Ú_disk_rŞlback_šfo_Œimmed_to
,

1361 
¡d
::
move
(
’Œ›s
),

1362 
¡d
::
move
(
dups
));

1364 ià(
	gmu¡_»bud
 || 
	gdebug_v”ify_¡Üed_missšg
) {

1366 ià(
	gdebug_v”ify_¡Üed_missšg
 || 
	gšfo
.
	gÏ¡_com¶‘e
 < info.
	gÏ¡_upd©e
) {

1367 
ldµ_dout
(
dµ
, 10)

1369 << 
	gšfo
.
	gÏ¡_com¶‘e


1370 << "," << 
	gšfo
.
	gÏ¡_upd©e
 << "]" << 
	gd’dl
;

1372 
	g£t
<
	ghobjeù_t
> 
	gdid
;

1373 
	g£t
<
	ghobjeù_t
> 
	gchecked
;

1374 
	g£t
<
	ghobjeù_t
> 
	gsk³d
;

1375 
	gli¡
<
	gpg_log_’Œy_t
>::
»v”£_™”©Ü
 
i
 = 
log
.log.
rbegš
();

1376 
	gi
 !ğ
log
.log.
»nd
();

1377 ++
	gi
) {

1378 ià(!
	gdebug_v”ify_¡Üed_missšg
 && 
	gi
->
	gv”siÚ
 <ğ
šfo
.
Ï¡_com¶‘e
) ;

1379 ià(
	gi
->
	gsoid
 > 
	gšfo
.
	gÏ¡_backfl
)

1381 ià(
	gi
->
is_”rÜ
())

1383 ià(
	gdid
.
couÁ
(
i
->
soid
)) ;

1384 
	gdid
.
š£¹
(
i
->
soid
);

1386 ià(!
	gmissšg
.
	gmay_šşude_d–‘es
 && 
	gi
->
is_d–‘e
())

1389 
bufã¾i¡
 
	gbv
;

1390 
	gr
 = 
¡Üe
->
g‘©Œ
(

1391 
ch
,

1392 
ghobjeù_t
(
i
->
soid
, ghobjeù_t::
NO_GEN
, 
šfo
.
pgid
.
sh¬d
),

1393 
OI_ATTR
,

1394 
bv
);

1395 ià(
	gr
 >= 0) {

1396 
objeù_šfo_t
 
oi
(
bv
);

1397 ià(
	goi
.
	gv”siÚ
 < 
	gi
->version) {

1398 
ldµ_dout
(
dµ
, 15è<< "»ad_log_ªd_missšg missšg " << *
	gi


1399 << " (hav" << 
	goi
.
	gv”siÚ
 << ")" << 
	gd’dl
;

1400 ià(
	gdebug_v”ify_¡Üed_missšg
) {

1401 autØ
	gm™”
 = 
missšg
.
g‘_™ems
().
fšd
(
i
->
soid
);

1402 
as£¹
(
m™”
 !ğ
missšg
.
g‘_™ems
().
’d
());

1403 
as£¹
(
m™”
->
£cÚd
.
Ãed
 =ğ
i
->
v”siÚ
);

1406 
as£¹
(
m™”
->
£cÚd
.
have
 =ğ
oi
.
v”siÚ
 || m™”->£cÚd.hav=ğ
ev”siÚ_t
());

1407 
	gchecked
.
š£¹
(
i
->
soid
);

1409 
	gmissšg
.
add
(
i
->
soid
, i->
v”siÚ
, 
oi
.v”siÚ, i->
is_d–‘e
());

1413 
ldµ_dout
(
dµ
, 15è<< "»ad_log_ªd_missšg missšg " << *
	gi
 << 
	gd’dl
;

1414 ià(
	gdebug_v”ify_¡Üed_missšg
) {

1415 autØ
	gm™”
 = 
missšg
.
g‘_™ems
().
fšd
(
i
->
soid
);

1416 ià(
	gi
->
is_d–‘e
()) {

1417 
as£¹
(
m™”
 =ğ
missšg
.
g‘_™ems
().
’d
() ||

1418 (
m™”
->
£cÚd
.
Ãed
 =ğ
i
->
v”siÚ
 &&

1419 
m™”
->
£cÚd
.
have
 =ğ
ev”siÚ_t
()));

1421 
as£¹
(
m™”
 !ğ
missšg
.
g‘_™ems
().
’d
());

1422 
as£¹
(
m™”
->
£cÚd
.
Ãed
 =ğ
i
->
v”siÚ
);

1423 
as£¹
(
m™”
->
£cÚd
.
have
 =ğ
ev”siÚ_t
());

1425 
	gchecked
.
š£¹
(
i
->
soid
);

1427 
	gmissšg
.
add
(
i
->
soid
, i->
v”siÚ
, 
ev”siÚ_t
(), i->
is_d–‘e
());

1431 ià(
	gdebug_v”ify_¡Üed_missšg
) {

1432 autØ&&
	gi
: 
missšg
.
g‘_™ems
()) {

1433 ià(
checked
.
couÁ
(
i
.
fœ¡
))

1435 ià(
	gi
.
	gfœ¡
 > 
	gšfo
.
	gÏ¡_backfl
) {

1436 
ldµ_dout
(
dµ
, -1è<< 
	g__func__
 << ": invalid missing setƒntry "

1438 << 
	gi
.
	gfœ¡
 << " " << i.
	g£cÚd


1439 << "†a¡_backfÈğ" << 
	gšfo
.
	gÏ¡_backfl


1440 << 
	gd’dl
;

1441 
as£¹
(0 == "invalid missing setƒntry found");

1443 
bufã¾i¡
 
	gbv
;

1444 
	gr
 = 
¡Üe
->
g‘©Œ
(

1445 
ch
,

1446 
ghobjeù_t
(
i
.
fœ¡
, ghobjeù_t::
NO_GEN
, 
šfo
.
pgid
.
sh¬d
),

1447 
OI_ATTR
,

1448 
bv
);

1449 ià(
	gr
 >= 0) {

1450 
objeù_šfo_t
 
oi
(
bv
);

1451 
as£¹
(
oi
.
v”siÚ
 =ğ
i
.
£cÚd
.
have
 || 
ev”siÚ_t
() == i.second.have);

1453 
as£¹
(
i
.
£cÚd
.
is_d–‘e
(è|| 
ev”siÚ_t
(è=ği.£cÚd.
have
);

1457 
as£¹
(
mu¡_»bud
);

1458 
	gm­
<
	gev”siÚ_t
, 
	ghobjeù_t
>::
»v”£_™”©Ü
 
i
 =

1459 
div”g’t_´iÜs
.
rbegš
();

1460 
	gi
 !ğ
div”g’t_´iÜs
.
»nd
();

1461 ++
	gi
) {

1462 ià(
	gi
->
	gfœ¡
 <ğ
šfo
.
Ï¡_com¶‘e
) ;

1463 ià(
	gi
->
	g£cÚd
 > 
	gšfo
.
	gÏ¡_backfl
)

1465 ià(
	gdid
.
couÁ
(
i
->
£cÚd
)) ;

1466 
	gdid
.
š£¹
(
i
->
£cÚd
);

1467 
bufã¾i¡
 
	gbv
;

1468 
	gr
 = 
¡Üe
->
g‘©Œ
(

1469 
ch
,

1470 
ghobjeù_t
(
i
->
£cÚd
, ghobjeù_t::
NO_GEN
, 
šfo
.
pgid
.
sh¬d
),

1471 
OI_ATTR
,

1472 
bv
);

1473 ià(
	gr
 >= 0) {

1474 
objeù_šfo_t
 
oi
(
bv
);

1492 ià(
	goi
.
	gv”siÚ
 > 
	gi
->
	gfœ¡
 && 
	gtŞ”©e_div”g’t_missšg_log
) {

1493 
ldµ_dout
(
dµ
, 0è<< "»ad_log div”g’t_´iÜ ’Œy (" << *
	gi


1494 << "èšcÚsi¡’ˆw™h disk s‹ (" << 
	goi


1496 << 
	gd’dl
;

1498 
as£¹
(
oi
.
v”siÚ
 =ğ
i
->
fœ¡
);

1501 
ldµ_dout
(
dµ
, 15è<< "»ad_log_ªd_missšg missšg " << *
	gi
 << 
	gd’dl
;

1502 
	gmissšg
.
add
(
i
->
£cÚd
, i->
fœ¡
, 
ev”siÚ_t
(), 
çl£
);

1506 ià(
	gş—r_div”g’t_´iÜs
)

1507 (*
	gş—r_div”g’t_´iÜs
èğ
Œue
;

1511 ià(!
	gmu¡_»bud
) {

1512 ià(
	gş—r_div”g’t_´iÜs
)

1513 (*
	gş—r_div”g’t_´iÜs
èğ
çl£
;

1514 
	gmissšg
.
æush
();

1516 
ldµ_dout
(
dµ
, 10è<< "»ad_log_ªd_missšg dÚe" << 
	gd’dl
;

	@osd/PGPeeringEvent.cc

4 
	~"šşude/mempoŞ.h
"

5 
	~"osd/PGP“ršgEv’t.h
"

6 
	~"mes§ges/MOSDPGLog.h
"

8 
MEMPOOL_DEFINE_OBJECT_FACTORY
(
PGP“ršgEv’t
, 
pg_³”šg_evt
, 
osd
);

	@osd/PGPeeringEvent.h

4 #´agm¨
Úû


6 
	~<boo¡/¡©ech¬t/ev’t.hµ
>

8 
	~"osd/osd_ty³s.h
"

10 
şass
 
	gMOSDPGLog
;

13 
	sPGC»©eInfo
 {

14 
¥g_t
 
	mpgid
;

15 
•och_t
 
	m•och
 = 0;

16 
pg_hi¡Üy_t
 
	mhi¡Üy
;

17 
Pa¡IÁ”v®s
 
	m·¡_š‹rv®s
;

18 
boŞ
 
	mby_mÚ
;

19 
PGC»©eInfo
(
¥g_t
 
p
, 
•och_t
 
e
,

20 cÚ¡ 
pg_hi¡Üy_t
& 
h
,

21 cÚ¡ 
Pa¡IÁ”v®s
& 
pi
,

22 
boŞ
 
mÚ
)

23 : 
pgid
(
p
), 
•och
(
e
), 
hi¡Üy
(
h
), 
·¡_š‹rv®s
(
pi
), 
by_mÚ
(
mÚ
) {}

26 şas 
	cPGP“ršgEv’t
 {

27 
•och_t
 
	m•och_£Á
;

28 
•och_t
 
	m•och_»que¡ed
;

29 
¡ršg
 
	mdesc
;

30 
	mpublic
:

31 
boo¡
::
šŒusive_±r
< cÚ¡ boo¡::
¡©ech¬t
::
ev’t_ba£
 > 
evt
;

32 
boŞ
 
	m»quœes_pg
;

33 
	m¡d
::
unique_±r
<
PGC»©eInfo
> 
ü—‹_šfo
;

34 
MEMPOOL_CLASS_HELPERS
();

35 
	m‹m¶©e
 <
şass
 
	mT
>

36 
	$PGP“ršgEv’t
(

37 
•och_t
 
•och_£Á
,

38 
•och_t
 
•och_»que¡ed
,

39 cÚ¡ 
T
 &
evt_
,

40 
boŞ
 
»q
 = 
Œue
,

41 
PGC»©eInfo
 *
ci
 = 0)

42 : 
	`•och_£Á
(
•och_£Á
),

43 
	`•och_»que¡ed
(
•och_»que¡ed
),

44 
	`evt
(
evt_
.
	`šŒusive_äom_this
()),

45 
	`»quœes_pg
(
»q
),

46 
	$ü—‹_šfo
(
ci
) {

47 
¡ršg¡»am
 
out
;

48 
out
 << "•och_£Á: " << 
•och_£Á


49 << "ƒpoch_»que¡ed: " << 
•och_»que¡ed
 << " ";

50 
evt_
.
	`´št
(&
out
);

51 ià(
ü—‹_šfo
) {

52 
out
 << " +create_info";

54 
desc
 = 
out
.
	`¡r
();

56 
•och_t
 
	$g‘_•och_£Á
() {

57  
•och_£Á
;

58 
	}
}

59 
•och_t
 
	$g‘_•och_»que¡ed
() {

60  
•och_»que¡ed
;

61 
	}
}

62 cÚ¡ 
	gboo¡
::
¡©ech¬t
::
ev’t_ba£
 &
	$g‘_ev’t
() {

63  *
evt
;

64 
	}
}

65 cÚ¡ 
	g¡ršg
& 
	$g‘_desc
() {

66  
desc
;

67 
	}
}

69 
	gûph
::
	tsh¬ed_±r
<
	tPGP“ršgEv’t
> 
	tPGP“ršgEv’tRef
;

71 
	gMInfoRec
 : 
boo¡
::
¡©ech¬t
::
ev’t
< 
MInfoRec
 > {

72 
pg_sh¬d_t
 
äom
;

73 
pg_šfo_t
 
	gšfo
;

74 
•och_t
 
	gmsg_•och
;

75 
MInfoRec
(
pg_sh¬d_t
 
äom
, cÚ¡ 
pg_šfo_t
 &
šfo
, 
•och_t
 
msg_•och
) :

76 
äom
(äom), 
šfo
(šfo), 
msg_•och
(msg_epoch) {}

77 
´št
(
¡d
::
o¡»am
 *
out
) const {

78 *
out
 << "MInfoReøäom " << 
äom
 << " info: " << 
šfo
;

82 
	gMLogRec
 : 
boo¡
::
¡©ech¬t
::
ev’t
< 
MLogRec
 > {

83 
pg_sh¬d_t
 
äom
;

84 
	gboo¡
::
šŒusive_±r
<
MOSDPGLog
> 
msg
;

85 
MLogRec
(
pg_sh¬d_t
 
äom
, 
MOSDPGLog
 *
msg
) :

86 
äom
(äom), 
msg
(msg) {}

87 
´št
(
¡d
::
o¡»am
 *
out
) const {

88 *
out
 << "MLogReøäom " << 
äom
;

92 
	gMNÙifyRec
 : 
boo¡
::
¡©ech¬t
::
ev’t
< 
MNÙifyRec
 > {

93 
¥g_t
 
pgid
;

94 
pg_sh¬d_t
 
	gäom
;

95 
pg_nÙify_t
 
	gnÙify
;

96 
ušt64_t
 
	gã©u»s
;

97 
Pa¡IÁ”v®s
 
	g·¡_š‹rv®s
;

98 
MNÙifyRec
(
¥g_t
 
p
, 
pg_sh¬d_t
 
äom
, cÚ¡ 
pg_nÙify_t
 &
nÙify
, 
ušt64_t
 
f
,

99 cÚ¡ 
Pa¡IÁ”v®s
& 
pi
)

100 : 
pgid
(
p
), 
äom
(äom), 
nÙify
ÒÙify), 
ã©u»s
(
f
), 
·¡_š‹rv®s
(
pi
) {}

101 
´št
(
¡d
::
o¡»am
 *
out
) const {

102 *
out
 << "MNÙifyReø" << 
pgid
 << " from " << 
äom
 << "‚Ùify: " << 
nÙify


103 << " f—tu»s: 0x" << 
hex
 << 
ã©u»s
 << 
dec


104 << " " << 
·¡_š‹rv®s
;

108 
	gMQu”y
 : 
boo¡
::
¡©ech¬t
::
ev’t
< 
MQu”y
 > {

109 
¥g_t
 
pgid
;

110 
pg_sh¬d_t
 
	gäom
;

111 
pg_qu”y_t
 
	gqu”y
;

112 
•och_t
 
	gqu”y_•och
;

113 
MQu”y
(
¥g_t
 
p
, 
pg_sh¬d_t
 
äom
, cÚ¡ 
pg_qu”y_t
 &
qu”y
, 
•och_t
 
qu”y_•och
)

114 : 
pgid
(
p
), 
äom
(äom), 
qu”y
(qu”y), 
qu”y_•och
(query_epoch) {}

115 
´št
(
¡d
::
o¡»am
 *
out
) const {

116 *
out
 << "MQu”y " << 
pgid
 << " from " << 
äom


117 << " qu”y_•och " << 
qu”y_•och


118 << " qu”y: " << 
qu”y
;

122 
	gMTrim
 : 
boo¡
::
¡©ech¬t
::
ev’t
<
MTrim
> {

123 
•och_t
 
•och
;

124 
	gäom
;

125 
sh¬d_id_t
 
	gsh¬d
;

126 
ev”siÚ_t
 
	gŒim_to
;

127 
MTrim
(
•och_t
 
•och
, 
äom
, 
sh¬d_id_t
 
sh¬d
, 
ev”siÚ_t
 
Œim_to
)

128 : 
•och
Ópoch), 
äom
(äom), 
sh¬d
(sh¬d), 
Œim_to
(trim_to) {}

129 
´št
(
¡d
::
o¡»am
 *
out
) const {

130 *
out
 << "MTrimƒpoch " << 
•och
 << " from " << 
äom
 << " sh¬d " << 
sh¬d


131 << "rim_tØ" << 
Œim_to
;

135 
	gReque¡BackflPrio
 : 
boo¡
::
¡©ech¬t
::
ev’t
< 
Reque¡BackflPrio
 > {

136 
´iÜ™y
;

137 
ex¶ic™
 
Reque¡BackflPrio
(
´io
) :

138 
boo¡
::
¡©ech¬t
::
ev’t
< 
Reque¡BackflPrio
 >(),

139 
´iÜ™y
(
´io
) {}

140 
´št
(
¡d
::
o¡»am
 *
out
) const {

141 *
out
 << "Reque¡BackflPrio:…riÜ™y " << 
´iÜ™y
;

145 
	gReque¡Recov”yPrio
 : 
boo¡
::
¡©ech¬t
::
ev’t
< 
Reque¡Recov”yPrio
 > {

146 
´iÜ™y
;

147 
ex¶ic™
 
Reque¡Recov”yPrio
(
´io
) :

148 
boo¡
::
¡©ech¬t
::
ev’t
< 
Reque¡Recov”yPrio
 >(),

149 
´iÜ™y
(
´io
) {}

150 
´št
(
¡d
::
o¡»am
 *
out
) const {

151 *
out
 << "Reque¡Recov”yPrio:…riÜ™y " << 
´iÜ™y
;

155 
	#TrivŸlEv’t
(
T
èT : 
boo¡
::
¡©ech¬t
::
ev’t
< T > { \

156 
	`T
(è: 
boo¡
::
¡©ech¬t
::
ev’t
< 
T
 >() {} \

157 
	`´št
(
¡d
::
o¡»am
 *
out
) const { \

158 *
out
 << #T; \

160 };

	)

162 
	$TrivŸlEv’t
(
NuÎEvt
)

163 
	$TrivŸlEv’t
(
RemÙeBackflRe£rved
)

164 
	$TrivŸlEv’t
(
RemÙeRe£rv©iÚRejeùed
)

165 
	$TrivŸlEv’t
(
RemÙeRe£rv©iÚRevokedTooFuÎ
)

166 
	$TrivŸlEv’t
(
RemÙeRe£rv©iÚRevoked
)

167 
	$TrivŸlEv’t
(
RemÙeRe£rv©iÚCªûËd
)

168 
	$TrivŸlEv’t
(
RemÙeRecov”yRe£rved
)

169 
	$TrivŸlEv’t
(
Recov”yDÚe
)

171 
DeãrRecov”y
 : 
boo¡
::
¡©ech¬t
::
ev’t
<DeferRecovery> {

172 
d–ay
;

173 
ex¶ic™
 
	`DeãrRecov”y
(
d–ay
è: 
	`d–ay
(delay) {}

174 
	`´št
(
¡d
::
o¡»am
 *
out
) const {

175 *
out
 << "DeãrRecov”y: d–ay " << 
d–ay
;

177 
	}
};

179 
	gDeãrBackfl
 : 
boo¡
::
¡©ech¬t
::
ev’t
<
DeãrBackfl
> {

180 
d–ay
;

181 
ex¶ic™
 
DeãrBackfl
(
d–ay
) : delay(delay) {}

182 
´št
(
¡d
::
o¡»am
 *
out
) const {

183 *
out
 << "DeãrBackfl: d–ay " << 
d–ay
;

	@osd/PGTransaction.h

14 #iâdeà
PGTRANSACTION_H


15 
	#PGTRANSACTION_H


	)

17 
	~<m­
>

18 
	~<memÜy
>

19 
	~<boo¡/İtiÚ®.hµ
>

21 
	~"commÚ/hobjeù.h
"

22 
	~"osd/osd_ty³s.h
"

23 
	~"osd/osd_š‹º®_ty³s.h
"

24 
	~"commÚ/š‹rv®_m­.h
"

25 
	~"commÚ/šlše_v¬ŸÁ.h
"

38 şas 
	cPGT¿n§ùiÚ
 {

39 
	mpublic
:

40 
m­
<
hobjeù_t
, 
	mObjeùCÚ‹xtRef
> 
	mobc_m­
;

42 şas 
	cObjeùO³¿tiÚ
 {

43 
	mpublic
:

44 
	sIn™


46 
	sNÚe
 {};

47 
	sC»©e
 {};

48 
	sClÚe
 {

49 
hobjeù_t
 
	msourû
;

51 
	sR’ame
 {

52 
hobjeù_t
 
	msourû
;

55 
usšg
 
	mIn™Ty³
 = 
boo¡
::
v¬ŸÁ
<

56 
In™
::
NÚe
,

57 
	mIn™
::
C»©e
,

58 
	mIn™
::
ClÚe
,

59 
	mIn™
::
R’ame
>;

61 
In™Ty³
 
	mš™_ty³
 = 
In™
::
NÚe
();

62 
boŞ
 
	md–‘e_fœ¡
 = 
çl£
;

87 
boŞ
 
d–‘es_fœ¡
() const {

88  
	md–‘e_fœ¡
;

90 
boŞ
 
is_d–‘e
() const {

91  
	mboo¡
::
g‘
<
In™
::
NÚe
>(&
š™_ty³
è!ğ
nuÎ±r
 && 
d–‘e_fœ¡
;

93 
boŞ
 
is_nÚe
() const {

94  
	mboo¡
::
g‘
<
In™
::
NÚe
>(&
š™_ty³
è!ğ
nuÎ±r
 && !
d–‘e_fœ¡
;

96 
boŞ
 
is_äesh_objeù
() const {

97  
	mboo¡
::
g‘
<
In™
::
NÚe
>(&
š™_ty³
è=ğ
nuÎ±r
;

99 
boŞ
 
is_»Çme
() const {

100  
	mboo¡
::
g‘
<
In™
::
R’ame
>(&
š™_ty³
è!ğ
nuÎ±r
;

102 
boŞ
 
has_sourû
(
hobjeù_t
 *
sourû
 = 
nuÎ±r
) const {

103  
m©ch
(

104 
š™_ty³
,

105 [&](cÚ¡ 
In™
::
ClÚe
 &
İ
è-> 
boŞ
 {

106 ià(
sourû
)

107 *
sourû
 = 
İ
.source;

108  
Œue
;

110 [&](cÚ¡ 
In™
::
R’ame
 &
İ
è-> 
boŞ
 {

111 ià(
sourû
)

112 *
sourû
 = 
İ
.source;

113  
Œue
;

115 [&](cÚ¡ 
In™
::
NÚe
 &è-> 
boŞ
 {  
çl£
; },

116 [&](cÚ¡ 
In™
::
C»©e
 &è-> 
boŞ
 {  
çl£
; });

119 
boŞ
 
	mş—r_om­
 = 
çl£
;

130 
	mboo¡
::
İtiÚ®
<
·œ
<
ušt64_t
, 
	mušt64_t
> > 
	mŒunÿ‹
 = 
boo¡
::
nÚe
;

132 
	m¡d
::
m­
<
¡ršg
, 
	mboo¡
::
İtiÚ®
<
bufã¾i¡
> > 
©Œ_upd©es
;

134 şas 
	cOm­Upd©eTy³
 {
	mRemove
, 
	mIn£¹
};

135 
	m¡d
::
veùÜ
<
¡d
::
·œ
<
Om­Upd©eTy³
, 
	mbufã¾i¡
> > 
	mom­_upd©es
;

137 
	mboo¡
::
İtiÚ®
<
bufã¾i¡
> 
om­_h—d”
;

140 
	mboo¡
::
İtiÚ®
<
·œ
<
£t
<
¢­id_t
>, 
	m£t
<
	m¢­id_t
> > > 
	mupd©ed_¢­s
;

142 
	s®loc_hšt_t
 {

143 
ušt64_t
 
	mex³ùed_objeù_size
;

144 
ušt64_t
 
	mex³ùed_wr™e_size
;

145 
ušt32_t
 
	mæags
;

147 
	mboo¡
::
İtiÚ®
<
®loc_hšt_t
> 
®loc_hšt
;

149 
	sBufãrUpd©e
 {

150 
	sWr™e
 {

151 
bufã¾i¡
 
	mbufãr
;

152 
ušt32_t
 
	mçdvi£_æags
;

154 
	sZ”o
 {

155 
ušt64_t
 
	mËn
;

157 
	sClÚeRªge
 {

158 
hobjeù_t
 
	mäom
;

159 
ušt64_t
 
	moff£t
;

160 
ušt64_t
 
	mËn
;

163 
usšg
 
	mBufãrUpd©eTy³
 = 
boo¡
::
v¬ŸÁ
<

164 
BufãrUpd©e
::
Wr™e
,

165 
	mBufãrUpd©e
::
Z”o
,

166 
	mBufãrUpd©e
::
ClÚeRªge
>;

168 
	m´iv©e
:

169 
	sS¶™M”g”
 {

170 
BufãrUpd©eTy³
 
¥l™
(

171 
ušt64_t
 
off£t
,

172 
ušt64_t
 
Ën
,

173 cÚ¡ 
BufãrUpd©eTy³
 &
bu
) const {

174  
m©ch
(

175 
bu
,

176 [&](cÚ¡ 
BufãrUpd©e
::
Wr™e
 &
w
è-> 
BufãrUpd©eTy³
 {

177 
bufã¾i¡
 
bl
;

178 
bl
.
sub¡r_of
(
w
.
bufãr
, 
off£t
, 
Ën
);

179  
BufãrUpd©e
::
Wr™e
{
bl
, 
w
.
çdvi£_æags
};

181 [&](cÚ¡ 
BufãrUpd©e
::
Z”o
 &è-> 
BufãrUpd©eTy³
 {

182  
BufãrUpd©e
::
Z”o
{
Ën
};

184 [&](cÚ¡ 
BufãrUpd©e
::
ClÚeRªge
 &
c
è-> 
BufãrUpd©eTy³
 {

185  
BufãrUpd©e
::
ClÚeRªge
{
c
.
äom
, c.
off£t
 + off£t, 
Ën
};

188 
ušt64_t
 
Ëngth
(

189 cÚ¡ 
BufãrUpd©eTy³
 &
Ëá
) const {

190  
m©ch
(

191 
Ëá
,

192 [&](cÚ¡ 
BufãrUpd©e
::
Wr™e
 &
w
è-> 
ušt64_t
 {

193  
w
.
bufãr
.
Ëngth
();

195 [&](cÚ¡ 
BufãrUpd©e
::
Z”o
 &
z
è-> 
ušt64_t
 {

196  
z
.
Ën
;

198 [&](cÚ¡ 
BufãrUpd©e
::
ClÚeRªge
 &
c
è-> 
ušt64_t
 {

199  
c
.
Ën
;

202 
boŞ
 
ÿn_m”ge
(

203 cÚ¡ 
BufãrUpd©eTy³
 &
Ëá
,

204 cÚ¡ 
BufãrUpd©eTy³
 &
right
) const {

205  
m©ch
(

206 
Ëá
,

207 [&](cÚ¡ 
BufãrUpd©e
::
Wr™e
 &
w
è-> 
boŞ
 {

208 autØ
r
 = 
boo¡
::
g‘
<
BufãrUpd©e
::
Wr™e
>(&
right
);

209  
r
 !ğ
nuÎ±r
 && (
w
.
çdvi£_æags
 ==„->fadvise_flags);

211 [&](cÚ¡ 
BufãrUpd©e
::
Z”o
 &è-> 
boŞ
 {

212 autØ
r
 = 
boo¡
::
g‘
<
BufãrUpd©e
::
Z”o
>(&
right
);

213  
r
 !ğ
nuÎ±r
;

215 [&](cÚ¡ 
BufãrUpd©e
::
ClÚeRªge
 &
c
è-> 
boŞ
 {

216  
çl£
;

219 
BufãrUpd©eTy³
 
m”ge
(

220 
BufãrUpd©eTy³
 &&
Ëá
,

221 
BufãrUpd©eTy³
 &&
right
) const {

222  
m©ch
(

223 
Ëá
,

224 [&](cÚ¡ 
BufãrUpd©e
::
Wr™e
 &
w
è-> 
BufãrUpd©eTy³
 {

225 autØ
r
 = 
boo¡
::
g‘
<
BufãrUpd©e
::
Wr™e
>(&
right
);

226 
as£¹
(
r
 && 
w
.
çdvi£_æags
 ==„->fadvise_flags);

227 
bufã¾i¡
 
bl
 = 
w
.
bufãr
;

228 
bl
.
­³nd
(
r
->
bufãr
);

229  
BufãrUpd©e
::
Wr™e
{
bl
, 
w
.
çdvi£_æags
};

231 [&](cÚ¡ 
BufãrUpd©e
::
Z”o
 &
z
è-> 
BufãrUpd©eTy³
 {

232 autØ
r
 = 
boo¡
::
g‘
<
BufãrUpd©e
::
Z”o
>(&
right
);

233 
as£¹
(
r
);

234  
BufãrUpd©e
::
Z”o
{
z
.
Ën
 + 
r
->len};

236 [&](cÚ¡ 
BufãrUpd©e
::
ClÚeRªge
 &
c
è-> 
BufãrUpd©eTy³
 {

237 
as£¹
(0 == "violates can_merge condition");

238  
Ëá
;

242 
	mpublic
:

243 
usšg
 
bufãr_upd©e_ty³
 = 
š‹rv®_m­
<

244 
ušt64_t
, 
	mBufãrUpd©eTy³
, 
	mS¶™M”g”
>;

245 
bufãr_upd©e_ty³
 
	mbufãr_upd©es
;

247 
ä›nd
 
şass
 
	mPGT¿n§ùiÚ
;

249 
	gm­
<
	ghobjeù_t
, 
	gObjeùO³¿tiÚ
> 
	gİ_m­
;

250 
	g´iv©e
:

251 
ObjeùO³¿tiÚ
 &
	$g‘_objeù_İ_fÜ_modify
(cÚ¡ 
hobjeù_t
 &
hoid
) {

252 autØ&
İ
 = 
İ_m­
[
hoid
];

253 
	`as£¹
(!
İ
.
	`is_d–‘e
());

254  
İ
;

255 
	}
}

256 
	gObjeùO³¿tiÚ
 &
	$g‘_objeù_İ
(cÚ¡ 
hobjeù_t
 &
hoid
) {

257  
İ_m­
[
hoid
];

258 
	}
}

259 
	gpublic
:

260 
	$add_obc
(

261 
ObjeùCÚ‹xtRef
 
obc
) {

262 
	`as£¹
(
obc
);

263 
obc_m­
[
obc
->
obs
.
oi
.
soid
] = obc;

264 
	}
}

266 
	$ü—‹
(

267 cÚ¡ 
hobjeù_t
 &
hoid


269 autØ&
İ
 = 
İ_m­
[
hoid
];

270 
	`as£¹
(
İ
.
	`is_nÚe
(è|| op.
	`is_d–‘e
());

271 
İ
.
š™_ty³
 = 
ObjeùO³¿tiÚ
::
In™
::
	`C»©e
();

272 
	}
}

275 
	$şÚe
(

276 cÚ¡ 
hobjeù_t
 &
rg‘
,

277 cÚ¡ 
hobjeù_t
 &
sourû


279 autØ&
İ
 = 
İ_m­
[
rg‘
];

280 
	`as£¹
(
İ
.
	`is_nÚe
(è|| op.
	`is_d–‘e
());

281 
İ
.
š™_ty³
 = 
ObjeùO³¿tiÚ
::
In™
::
ClÚe
{
sourû
};

282 
	}
}

285 
	$»Çme
(

286 cÚ¡ 
hobjeù_t
 &
rg‘
,

287 cÚ¡ 
hobjeù_t
 &
sourû


289 
	`as£¹
(
sourû
.
	`is_‹mp
());

290 
	`as£¹
(!
rg‘
.
	`is_‹mp
());

291 autØ&
İ
 = 
İ_m­
[
rg‘
];

292 
	`as£¹
(
İ
.
	`is_nÚe
(è|| op.
	`is_d–‘e
());

294 
boŞ
 
d–_fœ¡
 = 
İ
.
	`is_d–‘e
();

295 autØ
™”
 = 
İ_m­
.
	`fšd
(
sourû
);

296 ià(
™”
 !ğ
İ_m­
.
	`’d
()) {

297 
İ
 = 
™”
->
£cÚd
;

298 
İ_m­
.
	`”a£
(
™”
);

299 
İ
.
d–‘e_fœ¡
 = 
d–_fœ¡
;

302 
İ
.
š™_ty³
 = 
ObjeùO³¿tiÚ
::
In™
::
R’ame
{
sourû
};

303 
	}
}

306 
	$»move
(

307 cÚ¡ 
hobjeù_t
 &
hoid


309 autØ&
İ
 = 
	`g‘_objeù_İ_fÜ_modify
(
hoid
);

310 ià(!
İ
.
	`is_äesh_objeù
()) {

311 
	`as£¹
(!
İ
.
upd©ed_¢­s
);

312 
İ
 = 
	`ObjeùO³¿tiÚ
();

313 
İ
.
d–‘e_fœ¡
 = 
Œue
;

315 
	`as£¹
(!
İ
.
	`is_»Çme
());

316 
İ_m­
.
	`”a£
(
hoid
);

318 
	}
}

320 
upd©e_¢­s
(

321 cÚ¡ 
hobjeù_t
 &
hoid
,

322 cÚ¡ 
£t
<
¢­id_t
> &
Şd_¢­s
,

323 cÚ¡ 
£t
<
¢­id_t
> &
Ãw_¢­s


325 autØ&
	gİ
 = 
g‘_objeù_İ
(
hoid
);

326 
as£¹
(!
İ
.
upd©ed_¢­s
);

327 
as£¹
(
İ
.
bufãr_upd©es
.
em±y
());

328 
as£¹
(!
İ
.
Œunÿ‹
);

329 
	gİ
.
	gupd©ed_¢­s
 = 
make_·œ
(

330 
Şd_¢­s
,

331 
Ãw_¢­s
);

335 
	$om­_ş—r
(

336 cÚ¡ 
hobjeù_t
 &
hoid


338 autØ&
İ
 = 
	`g‘_objeù_İ_fÜ_modify
(
hoid
);

339 
İ
.
ş—r_om­
 = 
Œue
;

340 
İ
.
om­_upd©es
.
	`ş—r
();

341 
İ
.
om­_h—d”
 = 
boo¡
::
nÚe
;

342 
	}
}

343 
	$Œunÿ‹
(

344 cÚ¡ 
hobjeù_t
 &
hoid
,

345 
ušt64_t
 
off


347 autØ&
İ
 = 
	`g‘_objeù_İ_fÜ_modify
(
hoid
);

348 
	`as£¹
(!
İ
.
upd©ed_¢­s
);

349 
İ
.
bufãr_upd©es
.
	`”a£
(

350 
off
,

351 
¡d
::
num”ic_lim™s
<
ušt64_t
>::
	`max
(è- 
off
);

352 ià(!
İ
.
Œunÿ‹
 || 
off
 < op.Œunÿ‹->
fœ¡
) {

353 
İ
.
Œunÿ‹
 = 
¡d
::
·œ
<
ušt64_t
, ušt64_t>(
off
, off);

355 
İ
.
Œunÿ‹
->
£cÚd
 = 
off
;

357 
	}
}

360 
£‰rs
(

361 cÚ¡ 
hobjeù_t
 &
hoid
,

362 
m­
<
¡ršg
, 
bufã¾i¡
> &
©Œs


364 autØ&
	gİ
 = 
g‘_objeù_İ_fÜ_modify
(
hoid
);

365 autØ&&
	gi
: 
©Œs
) {

366 
İ
.
©Œ_upd©es
[
i
.
fœ¡
] = i.
£cÚd
;

369 
	$£‰r
(

370 cÚ¡ 
hobjeù_t
 &
hoid
,

371 cÚ¡ 
¡ršg
 &
©ŒÇme
,

372 
bufã¾i¡
 &
bl


374 autØ&
İ
 = 
	`g‘_objeù_İ_fÜ_modify
(
hoid
);

375 
İ
.
©Œ_upd©es
[
©ŒÇme
] = 
bl
;

376 
	}
}

377 
	$rm©Œ
(

378 cÚ¡ 
hobjeù_t
 &
hoid
,

379 cÚ¡ 
¡ršg
 &
©ŒÇme


381 autØ&
İ
 = 
	`g‘_objeù_İ_fÜ_modify
(
hoid
);

382 
İ
.
©Œ_upd©es
[
©ŒÇme
] = 
boo¡
::
nÚe
;

383 
	}
}

386 
	$£t_®loc_hšt
(

387 cÚ¡ 
hobjeù_t
 &
hoid
,

388 
ušt64_t
 
ex³ùed_objeù_size
,

389 
ušt64_t
 
ex³ùed_wr™e_size
,

390 
ušt32_t
 
æags


392 autØ&
İ
 = 
	`g‘_objeù_İ_fÜ_modify
(
hoid
);

393 
İ
.
®loc_hšt
 = 
ObjeùO³¿tiÚ
::
®loc_hšt_t
{

394 
ex³ùed_objeù_size
, 
ex³ùed_wr™e_size
, 
æags
};

395 
	}
}

398 
	$wr™e
(

399 cÚ¡ 
hobjeù_t
 &
hoid
,

400 
ušt64_t
 
off
,

401 
ušt64_t
 
Ën
,

402 
bufã¾i¡
 &
bl
,

403 
ušt32_t
 
çdvi£_æags
 = 0

405 autØ&
İ
 = 
	`g‘_objeù_İ_fÜ_modify
(
hoid
);

406 
	`as£¹
(!
İ
.
upd©ed_¢­s
);

407 
	`as£¹
(
Ën
 > 0);

408 
	`as£¹
(
Ën
 =ğ
bl
.
	`Ëngth
());

409 
İ
.
bufãr_upd©es
.
	`š£¹
(

410 
off
,

411 
Ën
,

412 
ObjeùO³¿tiÚ
::
BufãrUpd©e
::
Wr™e
{
bl
, 
çdvi£_æags
});

413 
	}
}

414 
	$şÚe_¿nge
(

415 cÚ¡ 
hobjeù_t
 &
äom
,

416 cÚ¡ 
hobjeù_t
 &
to
,

417 
ušt64_t
 
äomoff
,

418 
ušt64_t
 
Ën
,

419 
ušt64_t
 
tooff


421 autØ&
İ
 = 
	`g‘_objeù_İ_fÜ_modify
(
to
);

422 
	`as£¹
(!
İ
.
upd©ed_¢­s
);

423 
İ
.
bufãr_upd©es
.
	`š£¹
(

424 
tooff
,

425 
Ën
,

426 
ObjeùO³¿tiÚ
::
BufãrUpd©e
::
ClÚeRªge
{
äom
, 
äomoff
, 
Ën
});

427 
	}
}

428 
	$z”o
(

429 cÚ¡ 
hobjeù_t
 &
hoid
,

430 
ušt64_t
 
off
,

431 
ušt64_t
 
Ën


433 autØ&
İ
 = 
	`g‘_objeù_İ_fÜ_modify
(
hoid
);

434 
	`as£¹
(!
İ
.
upd©ed_¢­s
);

435 
İ
.
bufãr_upd©es
.
	`š£¹
(

436 
off
,

437 
Ën
,

438 
ObjeùO³¿tiÚ
::
BufãrUpd©e
::
Z”o
{
Ën
});

439 
	}
}

442 
	$om­_£tkeys
(

443 cÚ¡ 
hobjeù_t
 &
hoid
,

444 
bufã¾i¡
 &
keys_bl


446 autØ&
İ
 = 
	`g‘_objeù_İ_fÜ_modify
(
hoid
);

447 
İ
.
om­_upd©es
.
	`em¶aû_back
(

448 
	`make_·œ
(

449 
ObjeùO³¿tiÚ
::
Om­Upd©eTy³
::
In£¹
,

450 
keys_bl
));

451 
	}
}

452 
om­_£tkeys
(

453 cÚ¡ 
hobjeù_t
 &
hoid
,

454 
m­
<
¡ršg
, 
bufã¾i¡
> &
keys


456 
bufã¾i¡
 
	gbl
;

457 
’code
(
keys
, 
bl
);

458 
om­_£tkeys
(
hoid
, 
bl
);

460 
	$om­_rmkeys
(

461 cÚ¡ 
hobjeù_t
 &
hoid
,

462 
bufã¾i¡
 &
keys_bl


464 autØ&
İ
 = 
	`g‘_objeù_İ_fÜ_modify
(
hoid
);

465 
İ
.
om­_upd©es
.
	`em¶aû_back
(

466 
	`make_·œ
(

467 
ObjeùO³¿tiÚ
::
Om­Upd©eTy³
::
Remove
,

468 
keys_bl
));

469 
	}
}

470 
om­_rmkeys
(

471 cÚ¡ 
hobjeù_t
 &
hoid
,

472 
£t
<
¡ršg
> &
keys


474 
bufã¾i¡
 
	gbl
;

475 
’code
(
keys
, 
bl
);

476 
om­_rmkeys
(
hoid
, 
bl
);

478 
	$om­_£th—d”
(

479 cÚ¡ 
hobjeù_t
 &
hoid
,

480 
bufã¾i¡
 &
h—d”


482 autØ&
İ
 = 
	`g‘_objeù_İ_fÜ_modify
(
hoid
);

483 
İ
.
om­_h—d”
 = 
h—d”
;

484 
	}
}

486 
boŞ
 
	$em±y
() const {

487  
İ_m­
.
	`em±y
();

488 
	}
}

490 
ušt64_t
 
	$g‘_by‹s_wr™‹n
() const {

491 
ušt64_t
 
»t
 = 0;

492 autØ&&
i
: 
İ_m­
) {

493 autØ&&
j
: 
i
.
£cÚd
.
bufãr_upd©es
) {

494 
»t
 +ğ
j
.
	`g‘_Ën
();

497  
»t
;

498 
	}
}

500 
	$nİ
(

501 cÚ¡ 
hobjeù_t
 &
hoid


503 
	`g‘_objeù_İ_fÜ_modify
(
hoid
);

504 
	}
}

525 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

526 
	$§ã_ü—‹_Œav”£
(
T
 &&
t
) {

527 
m­
<
hobjeù_t
, 
li¡
<hobjeù_t>> 
dg¿ph
;

528 
li¡
<
hobjeù_t
> 
¡ack
;

531 autØ&&
İaœ
: 
İ_m­
) {

532 
hobjeù_t
 
sourû
;

533 ià(
İaœ
.
£cÚd
.
	`has_sourû
(&
sourû
)) {

534 autØ&
l
 = 
dg¿ph
[
sourû
];

535 ià(
l
.
	`em±y
(è&& !
İ_m­
.
	`couÁ
(
sourû
)) {

538 
¡ack
.
	`push_back
(
sourû
);

540 
l
.
	`push_back
(
İaœ
.
fœ¡
);

542 
¡ack
.
	`push_back
(
İaœ
.
fœ¡
);

553 !
¡ack
.
	`em±y
()) {

554 
hobjeù_t
 &
cur
 = 
¡ack
.
	`äÚt
();

555 autØ
d™”
 = 
dg¿ph
.
	`fšd
(
cur
);

556 ià(
d™”
 =ğ
dg¿ph
.
	`’d
()) {

558 autØ
İ™”
 = 
İ_m­
.
	`fšd
(
cur
);

559 ià(
İ™”
 !ğ
İ_m­
.
	`’d
())

560 
	`t
(*
İ™”
);

561 
¡ack
.
	`pİ_äÚt
();

566 
	`as£¹
(!
d™”
->
£cÚd
.
	`em±y
());

567 
¡ack
.
	`¥liû
(¡ack.
	`begš
(), 
d™”
->
£cÚd
);

568 
dg¿ph
.
	`”a£
(
d™”
);

571 
	}
}

573 
usšg
 
	gPGT¿n§ùiÚUPŒ
 = 
¡d
::
unique_±r
<
PGT¿n§ùiÚ
>;

	@osd/PrimaryLogPG.cc

18 
	~"boo¡/tu¶e/tu¶e.hµ
"

19 
	~"boo¡/šŒusive_±r.hµ
"

20 
	~"PG.h
"

21 
	~"Prim¬yLogPG.h
"

22 
	~"OSD.h
"

23 
	~"OpReque¡.h
"

24 
	~"SüubStÜe.h
"

25 
	~"SessiÚ.h
"

26 
	~"objşass/objşass.h
"

28 
	~"commÚ/”ºo.h
"

29 
	~"commÚ/süub_ty³s.h
"

30 
	~"commÚ/³rf_couÁ”s.h
"

32 
	~"mes§ges/MOSDOp.h
"

33 
	~"mes§ges/MOSDBackoff.h
"

34 
	~"mes§ges/MOSDPGTrim.h
"

35 
	~"mes§ges/MOSDPGSÿn.h
"

36 
	~"mes§ges/MOSDR•Süub.h
"

37 
	~"mes§ges/MOSDPGBackfl.h
"

38 
	~"mes§ges/MOSDPGBackflRemove.h
"

39 
	~"mes§ges/MOSDPGUpd©eLogMissšg.h
"

40 
	~"mes§ges/MOSDPGUpd©eLogMissšgR•ly.h
"

41 
	~"mes§ges/MCommªdR•ly.h
"

42 
	~"mes§ges/MOSDSüubRe£rve.h
"

43 
	~"mds/šode_backŒaû.h
"

44 
	~"commÚ/Ev’tT¿û.h
"

46 
	~"commÚ/cÚfig.h
"

47 
	~"šşude/com·t.h
"

48 
	~"mÚ/MÚCl›Á.h
"

49 
	~"osdc/Objeù”.h
"

50 
	~"jsÚ_¥œ™/jsÚ_¥œ™_v®ue.h
"

51 
	~"jsÚ_¥œ™/jsÚ_¥œ™_»ad”.h
"

52 
	~"šşude/as£¹.h
"

53 
	~"šşude/¿dos/¿dos_ty³s.hµ
"

55 #ifdeà
WITH_LTTNG


56 
	~"Œacšg/osd.h
"

58 
	#Œaûpošt
(...)

	)

61 
	#dout_cÚ‹xt
 
cù


	)

62 
	#dout_subsys
 
ûph_subsys_osd


	)

63 
	#DOUT_PREFIX_ARGS
 
this
, 
osd
->
whßmi
, 
	`g‘_osdm­
()

	)

64 #undeà
dout_´efix


65 
	#dout_´efix
 
	`_´efix
(
_dout
, 
this
)

	)

66 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

67 
	go¡»am
& 
	$_´efix
(
¡d
::
o¡»am
 *
_dout
, 
T
 *
pg
) {

68  
pg
->
	`g’_´efix
(*
_dout
);

69 
	}
}

72 
	~<s¡»am
>

73 
	~<ut™y
>

75 
	~<”ºo.h
>

77 
MEMPOOL_DEFINE_OBJECT_FACTORY
(
Prim¬yLogPG
, 
»¶iÿ‹dpg
, 
osd
);

79 
	gPGLSF‹r
::
	$PGLSF‹r
(è: 
	$cù
(
nuÎ±r
)

81 
	}
}

83 
PGLSF‹r
::~
	$PGLSF‹r
()

85 
	}
}

95 
şass
 
Prim¬yLogPG
::
CİyC®lback
 : 
public
 
G’CÚ‹xt
<
CİyC®lbackResuÉs
> {

96 
´Ùeùed
:

97 
CİyC®lback
() {}

104 
fšish
(
CİyC®lbackResuÉs
 
»suÉs_
è
ov”ride
 = 0;

106 
	gpublic
:

108 ~
CİyC®lback
(è
ov”ride
 {}

111 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

112 
şass
 
	gPrim¬yLogPG
::
BËs£dG’CÚ‹xt
 : 
public
 
G’CÚ‹xt
<
T
> {

113 
Prim¬yLogPGRef
 
pg
;

114 
	gunique_±r
<
	gG’CÚ‹xt
<
	gT
>> 
	gc
;

115 
•och_t
 
	ge
;

116 
	gpublic
:

117 
BËs£dG’CÚ‹xt
(
Prim¬yLogPG
 *
pg
, 
G’CÚ‹xt
<
T
> *
c
, 
•och_t
 
e
)

118 : 
pg
Õg), 
c
(c), 
e
(e) {}

119 
fšish
(
T
 
t
è
	gov”ride
 {

120 
	gpg
->
lock
();

121 ià(
	gpg
->
pg_has_»£t_sšû
(
e
))

122 
	gc
.
»£t
();

124 
	gc
.
»Ëa£
()->
com¶‘e
(
t
);

125 
	gpg
->
uÆock
();

127 
boŞ
 
sync_fšish
(
T
 
t
) {

129 
	gc
.
»Ëa£
()->
com¶‘e
(
t
);

130  
	gŒue
;

134 
	gG’CÚ‹xt
<
	gTh»adPoŞ
::
TPHªdË
&> *
Prim¬yLogPG
::
bËss_g’cÚ‹xt
(

135 
G’CÚ‹xt
<
Th»adPoŞ
::
TPHªdË
&> *
c
) {

136  
Ãw
 
BËs£dG’CÚ‹xt
<
Th»adPoŞ
::
TPHªdË
&>(

137 
this
, 
	gc
, 
g‘_osdm­
()->
g‘_•och
());

140 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

141 
şass
 
	gPrim¬yLogPG
::
UÆockedBËs£dG’CÚ‹xt
 : 
public
 
G’CÚ‹xt
<
T
> {

142 
Prim¬yLogPGRef
 
pg
;

143 
	gunique_±r
<
	gG’CÚ‹xt
<
	gT
>> 
	gc
;

144 
•och_t
 
	ge
;

145 
	gpublic
:

146 
UÆockedBËs£dG’CÚ‹xt
(
Prim¬yLogPG
 *
pg
, 
G’CÚ‹xt
<
T
> *
c
, 
•och_t
 
e
)

147 : 
pg
Õg), 
c
(c), 
e
(e) {}

148 
fšish
(
T
 
t
è
	gov”ride
 {

149 ià(
	gpg
->
pg_has_»£t_sšû
(
e
))

150 
	gc
.
»£t
();

152 
	gc
.
»Ëa£
()->
com¶‘e
(
t
);

154 
boŞ
 
sync_fšish
(
T
 
t
) {

156 
	gc
.
»Ëa£
()->
com¶‘e
(
t
);

157  
	gŒue
;

161 
	gG’CÚ‹xt
<
	gTh»adPoŞ
::
TPHªdË
&> *
Prim¬yLogPG
::
bËss_uÆocked_g’cÚ‹xt
(

162 
G’CÚ‹xt
<
Th»adPoŞ
::
TPHªdË
&> *
c
) {

163  
Ãw
 
UÆockedBËs£dG’CÚ‹xt
<
Th»adPoŞ
::
TPHªdË
&>(

164 
this
, 
	gc
, 
g‘_osdm­
()->
g‘_•och
());

167 şas 
	cPrim¬yLogPG
::
BËs£dCÚ‹xt
 : 
public
 
CÚ‹xt
 {

168 
Prim¬yLogPGRef
 
pg
;

169 
	munique_±r
<
	mCÚ‹xt
> 
	mc
;

170 
•och_t
 
	me
;

171 
	mpublic
:

172 
	$BËs£dCÚ‹xt
(
Prim¬yLogPG
 *
pg
, 
CÚ‹xt
 *
c
, 
•och_t
 
e
)

173 : 
	`pg
(
pg
), 
	`c
(
c
), 
	$e
(
e
) {}

174 
	$fšish
(
r
è
ov”ride
 {

175 
pg
->
	`lock
();

176 ià(
pg
->
	`pg_has_»£t_sšû
(
e
))

177 
c
.
	`»£t
();

179 
c
.
	`»Ëa£
()->
	`com¶‘e
(
r
);

180 
pg
->
	`uÆock
();

181 
	}
}

182 
boŞ
 
	$sync_fšish
(
r
) {

184 
c
.
	`»Ëa£
()->
	`com¶‘e
(
r
);

185  
Œue
;

186 
	}
}

189 
CÚ‹xt
 *
	gPrim¬yLogPG
::
	$bËss_cÚ‹xt
(
CÚ‹xt
 *
c
) {

190  
Ãw
 
	`BËs£dCÚ‹xt
(
this
, 
c
, 
	`g‘_osdm­
()->
	`g‘_•och
());

191 
	}
}

193 şas 
	cPrim¬yLogPG
::
C_PG_ObjeùCÚ‹xt
 : 
public
 
CÚ‹xt
 {

194 
Prim¬yLogPGRef
 
pg
;

195 
ObjeùCÚ‹xt
 *
	mobc
;

196 
	mpublic
:

197 
	$C_PG_ObjeùCÚ‹xt
(
Prim¬yLogPG
 *
p
, 
ObjeùCÚ‹xt
 *
o
) :

198 
	`pg
(
p
), 
	$obc
(
o
) {}

199 
	$fšish
(
r
è
ov”ride
 {

200 
pg
->
	`objeù_cÚ‹xt_de¡ruùÜ_ÿÎback
(
obc
);

201 
	}
}

204 
	gOnR—dCom¶‘e
 : 
public
 
CÚ‹xt
 {

205 
Prim¬yLogPG
 *
pg
;

206 
	gPrim¬yLogPG
::
OpCÚ‹xt
 *
İcÚ‹xt
;

207 
OnR—dCom¶‘e
(

208 
Prim¬yLogPG
 *
pg
,

209 
Prim¬yLogPG
::
OpCÚ‹xt
 *
ùx
è: 
pg
Õg), 
İcÚ‹xt
(ctx) {}

210 
fšish
(
r
è
	gov”ride
 {

211 
	gİcÚ‹xt
->
fšish_»ad
(
pg
);

213 ~
OnR—dCom¶‘e
(è
	gov”ride
 {}

216 şas 
	cPrim¬yLogPG
::
C_OSD_Aµl›dRecov”edObjeù
 : 
public
 
CÚ‹xt
 {

217 
Prim¬yLogPGRef
 
pg
;

218 
ObjeùCÚ‹xtRef
 
	mobc
;

219 
	mpublic
:

220 
	$C_OSD_Aµl›dRecov”edObjeù
(
Prim¬yLogPG
 *
p
, 
ObjeùCÚ‹xtRef
 
o
) :

221 
	`pg
(
p
), 
	$obc
(
o
) {}

222 
boŞ
 
	$sync_fšish
(
r
è
ov”ride
 {

223 
pg
->
	`_­¶›d_»cov”ed_objeù
(
obc
);

224  
Œue
;

225 
	}
}

226 
	$fšish
(
r
è
ov”ride
 {

227 
pg
->
	`lock
();

228 
pg
->
	`_­¶›d_»cov”ed_objeù
(
obc
);

229 
pg
->
	`uÆock
();

230 
	}
}

233 şas 
	cPrim¬yLogPG
::
C_OSD_Comm™‹dPushedObjeù
 : 
public
 
CÚ‹xt
 {

234 
Prim¬yLogPGRef
 
pg
;

235 
•och_t
 
	m•och
;

236 
ev”siÚ_t
 
	mÏ¡_com¶‘e
;

237 
	mpublic
:

238 
	$C_OSD_Comm™‹dPushedObjeù
(

239 
Prim¬yLogPG
 *
p
, 
•och_t
 
•och
, 
ev”siÚ_t
 
lc
) :

240 
	`pg
(
p
), 
	`•och
(
•och
), 
	$Ï¡_com¶‘e
(
lc
) {

242 
	$fšish
(
r
è
ov”ride
 {

243 
pg
->
	`_comm™‹d_pushed_objeù
(
•och
, 
Ï¡_com¶‘e
);

244 
	}
}

247 şas 
	cPrim¬yLogPG
::
C_OSD_Aµl›dRecov”edObjeùR•liÿ
 : 
public
 
CÚ‹xt
 {

248 
Prim¬yLogPGRef
 
pg
;

249 
	mpublic
:

250 
ex¶ic™
 
	$C_OSD_Aµl›dRecov”edObjeùR•liÿ
(
Prim¬yLogPG
 *
p
) :

251 
	$pg
(
p
) {}

252 
boŞ
 
	$sync_fšish
(
r
è
ov”ride
 {

253 
pg
->
	`_­¶›d_»cov”ed_objeù_»¶iÿ
();

254  
Œue
;

255 
	}
}

256 
	$fšish
(
r
è
ov”ride
 {

257 
pg
->
	`lock
();

258 
pg
->
	`_­¶›d_»cov”ed_objeù_»¶iÿ
();

259 
pg
->
	`uÆock
();

260 
	}
}

264 
	gPrim¬yLogPG
::
OpCÚ‹xt
::
	$¡¬t_async_»ads
(
Prim¬yLogPG
 *
pg
)

266 
šæighŒ—ds
 = 1;

267 
li¡
<
·œ
<
boo¡
::
tu¶e
<
ušt64_t
, uint64_t, >,

268 
·œ
<
bufã¾i¡
*, 
CÚ‹xt
*> > > 
š
;

269 
š
.
	`sw­
(
³ndšg_async_»ads
);

270 
pg
->
pgback’d
->
	`objeùs_»ad_async
(

271 
obc
->
obs
.
oi
.
soid
,

272 
š
,

273 
Ãw
 
	`OnR—dCom¶‘e
(
pg
, 
this
),…g->
	`g‘_poŞ
().
ç¡_»ad
);

274 
	}
}

275 
	gPrim¬yLogPG
::
OpCÚ‹xt
::
	$fšish_»ad
(
Prim¬yLogPG
 *
pg
)

277 
	`as£¹
(
šæighŒ—ds
 > 0);

278 --
šæighŒ—ds
;

279 ià(
	`async_»ads_com¶‘e
()) {

280 
	`as£¹
(
pg
->
š_´og»ss_async_»ads
.
	`size
());

281 
	`as£¹
(
pg
->
š_´og»ss_async_»ads
.
	`äÚt
().
£cÚd
 =ğ
this
);

282 
pg
->
š_´og»ss_async_»ads
.
	`pİ_äÚt
();

286 
pg
->
	`execu‹_ùx
(
this
);

288 
	}
}

290 şas 
	cCİyFromC®lback
 : 
public
 
Prim¬yLogPG
::
CİyC®lback
 {

291 
public
:

292 
Prim¬yLogPG
::
CİyResuÉs
 *
»suÉs
 = 
nuÎ±r
;

293 
	mPrim¬yLogPG
::
OpCÚ‹xt
 *
ùx
;

294 
	mOSDOp
 &
	mosd_İ
;

296 
	$CİyFromC®lback
(
Prim¬yLogPG
::
OpCÚ‹xt
 *
ùx
, 
OSDOp
 &
osd_İ
)

297 : 
	`ùx
(
ùx
), 
	$osd_İ
(
osd_İ
) {

299 ~
	$CİyFromC®lback
(è
ov”ride
 {
	}
}

301 
	$fšish
(
Prim¬yLogPG
::
CİyC®lbackResuÉs
 
»suÉs_
è
ov”ride
 {

302 
»suÉs
 = 
»suÉs_
.
g‘
<1>();

303 
r
 = 
»suÉs_
.
g‘
<0>();

306 
ùx
->
u£r_©_v”siÚ
 = 
»suÉs
->
u£r_v”siÚ
;

308 ià(
r
 >= 0) {

309 
ùx
->
pg
->
	`execu‹_ùx
(ctx);

311 ià(
r
 !ğ-
ECANCELED
) {

312 ià(
ùx
->
İ
)

313 
ùx
->
pg
->
osd
->
	`»¶y_İ_”rÜ
(ùx->
İ
, 
r
);

314 } ià(
»suÉs
->
should_»queue
) {

315 ià(
ùx
->
İ
)

316 
ùx
->
pg
->
	`»queue_İ
(ùx->
İ
);

318 
ùx
->
pg
->
	`şo£_İ_ùx
(ctx);

320 
	}
}

322 
boŞ
 
	$is_‹mp_obj_u£d
() {

323  
»suÉs
->
¡¬‹d_‹mp_obj
;

324 
	}
}

325 
ušt64_t
 
	$g‘_d©a_size
() {

326  
»suÉs
->
objeù_size
;

327 
	}
}

330 
	gCİyFromFšish”
 : 
public
 
Prim¬yLogPG
::
OpFšish”
 {

331 
CİyFromC®lback
 *
cİy_äom_ÿÎback
;

333 
ex¶ic™
 
CİyFromFšish”
(
CİyFromC®lback
 *
cİy_äom_ÿÎback
)

334 : 
cİy_äom_ÿÎback
(copy_from_callback) {

337 
execu‹
(è
ov”ride
 {

339 
cİy_äom_ÿÎback
->
ùx
->
pg
->
fšish_cİyäom
(copy_from_callback);

347 
	gPrim¬yLogPG
::
	$Ú_loÿl_»cov”
(

348 cÚ¡ 
hobjeù_t
 &
hoid
,

349 cÚ¡ 
ObjeùRecov”yInfo
 &
_»cov”y_šfo
,

350 
ObjeùCÚ‹xtRef
 
obc
,

351 
boŞ
 
is_d–‘e
,

352 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t


355 
	`dout
(10è<< 
__func__
 << ": " << 
hoid
 << 
d’dl
;

357 
ObjeùRecov”yInfo
 
	`»cov”y_šfo
(
_»cov”y_šfo
);

358 
	`ş—r_objeù_¢­_m­pšg
(
t
, 
hoid
);

359 ià(!
is_d–‘e
 && 
»cov”y_šfo
.
soid
.
	`is_¢­
()) {

360 
OSDriv”
::
OST¿n§ùiÚ
 
	`_t
(
osdriv”
.
	`g‘_Œª§ùiÚ
(
t
));

361 
£t
<
¢­id_t
> 
¢­s
;

362 
	`dout
(20è<< " sÇp£ˆ" << 
»cov”y_šfo
.
ss
 << 
d’dl
;

363 autØ
p
 = 
»cov”y_šfo
.
ss
.
şÚe_¢­s
.
	`fšd
(
hoid
.
¢­
);

364 
	`as£¹
(
p
 !ğ
»cov”y_šfo
.
ss
.
şÚe_¢­s
.
	`’d
());

365 
¢­s
.
	`š£¹
(
p
->
£cÚd
.
	`begš
(),…->£cÚd.
	`’d
());

366 
	`dout
(20è<< " sÇp " << 
¢­s
 << 
d’dl
;

367 
¢­_m­³r
.
	`add_oid
(

368 
»cov”y_šfo
.
soid
,

369 
¢­s
,

370 &
_t
);

372 ià(!
is_d–‘e
 && 
pg_log
.
	`g‘_missšg
().
	`is_missšg
(
»cov”y_šfo
.
soid
) &&

373 
pg_log
.
	`g‘_missšg
().
	`g‘_™ems
().
	`fšd
(
»cov”y_šfo
.
soid
)->
£cÚd
.
Ãed
 >„ecov”y_šfo.
v”siÚ
) {

374 
	`as£¹
(
	`is_´im¬y
());

375 cÚ¡ 
pg_log_’Œy_t
 *
Ï‹¡
 = 
pg_log
.
	`g‘_log
().
objeùs
.
	`fšd
(
»cov”y_šfo
.
soid
)->
£cÚd
;

376 ià(
Ï‹¡
->
İ
 =ğ
pg_log_’Œy_t
::
LOST_REVERT
 &&

377 
Ï‹¡
->
»v”tšg_to
 =ğ
»cov”y_šfo
.
v”siÚ
) {

378 
	`dout
(10è<< " gÙ old„ev”ˆv”siÚ " << 
»cov”y_šfo
.
v”siÚ


379 << " fÜ " << *
Ï‹¡
 << 
d’dl
;

380 
»cov”y_šfo
.
v”siÚ
 = 
Ï‹¡
->version;

382 
»cov”y_šfo
.
oi
.
´iÜ_v”siÚ
 =„ecov”y_šfo.oi.
v”siÚ
;

383 
»cov”y_šfo
.
oi
.
v”siÚ
 = 
Ï‹¡
->version;

384 
bufã¾i¡
 
bl
;

385 
	`’code
(
»cov”y_šfo
.
oi
, 
bl
,

386 
	`g‘_osdm­
()->
	`g‘_ã©u»s
(
CEPH_ENTITY_TYPE_OSD
, 
nuÎ±r
));

387 
	`as£¹
(!
poŞ
.
šfo
.
	`is_”asu»
());

388 
t
->
	`£‰r
(
cŞl
, 
	`ghobjeù_t
(
»cov”y_šfo
.
soid
), 
OI_ATTR
, 
bl
);

389 ià(
obc
)

390 
obc
->
©Œ_ÿche
[
OI_ATTR
] = 
bl
;

395 ++
aùive_pushes
;

397 ià(
»cov”y_šfo
.
v”siÚ
 > 
pg_log
.
	`g‘_ÿn_rŞlback_to
()) {

403 
PGLogEÁryHªdËr
 
h
{
this
, 
t
};

404 
pg_log
.
	`rŞl_fÜw¬d_to
(
»cov”y_šfo
.
v”siÚ
, &
h
);

406 
	`»cov”_gÙ
(
»cov”y_šfo
.
soid
,„ecov”y_šfo.
v”siÚ
);

408 ià(
	`is_´im¬y
()) {

409 ià(!
is_d–‘e
) {

410 
obc
->
obs
.
exi¡s
 = 
Œue
;

412 
boŞ
 
gÙ
 = 
obc
->
	`g‘_»cov”y_»ad
();

413 
	`as£¹
(
gÙ
);

415 
	`as£¹
(
»cov”šg
.
	`couÁ
(
obc
->
obs
.
oi
.
soid
));

416 
»cov”šg
[
obc
->
obs
.
oi
.
soid
] = obc;

417 
obc
->
obs
.
oi
 = 
»cov”y_šfo
.oi;

420 
t
->
	`»gi¡”_Ú_­¶›d
(
Ãw
 
	`C_OSD_Aµl›dRecov”edObjeù
(
this
, 
obc
));

422 
	`publish_¡©s_to_osd
();

423 
	`as£¹
(
missšg_loc
.
	`Ãeds_»cov”y
(
hoid
));

424 ià(!
is_d–‘e
)

425 
missšg_loc
.
	`add_loÿtiÚ
(
hoid
, 
pg_whßmi
);

426 
	`»Ëa£_backoffs
(
hoid
);

427 ià(!
	`is_uÄ—dabË_objeù
(
hoid
)) {

428 autØ
uÄ—dabË_objeù_’Œy
 = 
wa™šg_fÜ_uÄ—dabË_objeù
.
	`fšd
(
hoid
);

429 ià(
uÄ—dabË_objeù_’Œy
 !ğ
wa™šg_fÜ_uÄ—dabË_objeù
.
	`’d
()) {

430 
	`dout
(20è<< " kickšg uÄ—dabË wa™” Ú " << 
hoid
 << 
d’dl
;

431 
	`»queue_İs
(
uÄ—dabË_objeù_’Œy
->
£cÚd
);

432 
wa™šg_fÜ_uÄ—dabË_objeù
.
	`”a£
(
uÄ—dabË_objeù_’Œy
);

436 
t
->
	`»gi¡”_Ú_­¶›d
(

437 
Ãw
 
	`C_OSD_Aµl›dRecov”edObjeùR•liÿ
(
this
));

441 
t
->
	`»gi¡”_Ú_comm™
(

442 
Ãw
 
	`C_OSD_Comm™‹dPushedObjeù
(

443 
this
,

444 
	`g‘_osdm­
()->
	`g‘_•och
(),

445 
šfo
.
Ï¡_com¶‘e
));

448 
dœty_šfo
 = 
Œue
;

449 
	`wr™e_if_dœty
(*
t
);

450 
	}
}

452 
	gPrim¬yLogPG
::
	$Ú_glob®_»cov”
(

453 cÚ¡ 
hobjeù_t
 &
soid
,

454 cÚ¡ 
objeù_¡©_sum_t
 &
¡©_diff
,

455 
boŞ
 
is_d–‘e
)

457 
šfo
.
¡©s
.¡©s.
sum
.
	`add
(
¡©_diff
);

458 
missšg_loc
.
	`»cov”ed
(
soid
);

459 
	`publish_¡©s_to_osd
();

460 
	`dout
(10è<< "pushed " << 
soid
 << "Ø®È»¶iÿs" << 
d’dl
;

461 
m­
<
hobjeù_t
, 
ObjeùCÚ‹xtRef
>::
™”©Ü
 
i
 = 
»cov”šg
.
	`fšd
(
soid
);

462 
	`as£¹
(
i
 !ğ
»cov”šg
.
	`’d
());

464 ià(
i
->
£cÚd
 && i->£cÚd->
rw¡©e
.
»cov”y_»ad_m¬k”
) {

467 
	`as£¹
(
i
->
£cÚd
);

468 
li¡
<
OpReque¡Ref
> 
»queue_li¡
;

469 
i
->
£cÚd
->
	`drİ_»cov”y_»ad
(&
»queue_li¡
);

470 
	`»queue_İs
(
»queue_li¡
);

473 
backfls_š_æight
.
	`”a£
(
soid
);

475 
»cov”šg
.
	`”a£
(
i
);

476 
	`fšish_»cov”y_İ
(
soid
);

477 
	`»Ëa£_backoffs
(
soid
);

478 autØ
deg¿ded_objeù_’Œy
 = 
wa™šg_fÜ_deg¿ded_objeù
.
	`fšd
(
soid
);

479 ià(
deg¿ded_objeù_’Œy
 !ğ
wa™šg_fÜ_deg¿ded_objeù
.
	`’d
()) {

480 
	`dout
(20è<< " kickšg deg¿ded wa™” Ú " << 
soid
 << 
d’dl
;

481 
	`»queue_İs
(
deg¿ded_objeù_’Œy
->
£cÚd
);

482 
wa™šg_fÜ_deg¿ded_objeù
.
	`”a£
(
deg¿ded_objeù_’Œy
);

484 autØ
uÄ—dabË_objeù_’Œy
 = 
wa™šg_fÜ_uÄ—dabË_objeù
.
	`fšd
(
soid
);

485 ià(
uÄ—dabË_objeù_’Œy
 !ğ
wa™šg_fÜ_uÄ—dabË_objeù
.
	`’d
()) {

486 
	`dout
(20è<< " kickšg uÄ—dabË wa™” Ú " << 
soid
 << 
d’dl
;

487 
	`»queue_İs
(
uÄ—dabË_objeù_’Œy
->
£cÚd
);

488 
wa™šg_fÜ_uÄ—dabË_objeù
.
	`”a£
(
uÄ—dabË_objeù_’Œy
);

490 
	`fšish_deg¿ded_objeù
(
soid
);

491 
	}
}

493 
	gPrim¬yLogPG
::
	$Ú_³”_»cov”
(

494 
pg_sh¬d_t
 
³”
,

495 cÚ¡ 
hobjeù_t
 &
soid
,

496 cÚ¡ 
ObjeùRecov”yInfo
 &
»cov”y_šfo
)

498 
	`publish_¡©s_to_osd
();

500 
³”_missšg
[
³”
].
	`gÙ
(
soid
, 
»cov”y_šfo
.
v”siÚ
);

501 
missšg_loc
.
	`add_loÿtiÚ
(
soid
, 
³”
);

502 
	}
}

504 
	gPrim¬yLogPG
::
	$begš_³”_»cov”
(

505 
pg_sh¬d_t
 
³”
,

506 cÚ¡ 
hobjeù_t
 
soid
)

508 
³”_missšg
[
³”
].
	`»vi£_have
(
soid
, 
	`ev”siÚ_t
());

509 
	}
}

511 
	gPrim¬yLogPG
::
scheduË_»cov”y_wÜk
(

512 
G’CÚ‹xt
<
Th»adPoŞ
::
TPHªdË
&> *
c
)

514 
osd
->
queue_»cov”y_cÚ‹xt
(
this
, 
c
);

517 
	gPrim¬yLogPG
::
	$£nd_mes§ge_osd_şu¡”
(

518 
³”
, 
Mes§ge
 *
m
, 
•och_t
 
äom_•och
)

520 
osd
->
	`£nd_mes§ge_osd_şu¡”
(
³”
, 
m
, 
äom_•och
);

521 
	}
}

523 
	gPrim¬yLogPG
::
	$£nd_mes§ge_osd_şu¡”
(

524 
Mes§ge
 *
m
, 
CÚÃùiÚ
 *
cÚ
)

526 
osd
->
	`£nd_mes§ge_osd_şu¡”
(
m
, 
cÚ
);

527 
	}
}

529 
	gPrim¬yLogPG
::
	$£nd_mes§ge_osd_şu¡”
(

530 
Mes§ge
 *
m
, cÚ¡ 
CÚÃùiÚRef
& 
cÚ
)

532 
osd
->
	`£nd_mes§ge_osd_şu¡”
(
m
, 
cÚ
);

533 
	}
}

535 
	gPrim¬yLogPG
::
	$Ú_´im¬y_”rÜ
(

536 cÚ¡ 
hobjeù_t
 &
oid
,

537 
ev”siÚ_t
 
v
)

539 
	`dout
(0è<< 
__func__
 << ": oid " << 
oid
 << " v”siÚ " << 
v
 << 
d’dl
;

540 
	`´im¬y_çed
(
oid
);

541 
	`´im¬y_”rÜ
(
oid
, 
v
);

542 
	`backfl_add_missšg
(
oid
, 
v
);

543 
	}
}

545 
	gPrim¬yLogPG
::
	$backfl_add_missšg
(

546 cÚ¡ 
hobjeù_t
 &
oid
,

547 
ev”siÚ_t
 
v
)

549 
	`dout
(0è<< 
__func__
 << ": oid " << 
oid
 << " v”siÚ " << 
v
 << 
d’dl
;

550 
backfls_š_æight
.
	`”a£
(
oid
);

551 
missšg_loc
.
	`add_missšg
(
oid
, 
v
, 
	`ev”siÚ_t
());

552 
	}
}

554 
boŞ
 
	gPrim¬yLogPG
::
	$should_£nd_İ
(

555 
pg_sh¬d_t
 
³”
,

556 cÚ¡ 
hobjeù_t
 &
hoid
) {

557 ià(
³”
 =ğ
	`g‘_´im¬y
())

558  
Œue
;

559 
	`as£¹
(
³”_šfo
.
	`couÁ
(
³”
));

560 
boŞ
 
should_£nd
 =

561 
hoid
.
poŞ
 !ğ(
št64_t
)
šfo
.
pgid
.
	`poŞ
() ||

562 
hoid
 <ğ
Ï¡_backfl_¡¬‹d
 ||

563 
hoid
 <ğ
³”_šfo
[
³”
].
Ï¡_backfl
;

564 ià(!
should_£nd
) {

565 
	`as£¹
(
	`is_backfl_rg‘s
(
³”
));

566 
	`dout
(10è<< 
__func__
 << " issue_»pİ shpšgƒm±y o±Øosd." << 
³”


567 << ", objeù " << 
hoid


570 << 
³”_šfo
[
³”
].
Ï¡_backfl
 << ")" << 
d’dl
;

571  
should_£nd
;

573 ià(
async_»cov”y_rg‘s
.
	`couÁ
(
³”
è&& 
³”_missšg
[³”].
	`is_missšg
(
hoid
)) {

574 
should_£nd
 = 
çl£
;

575 
	`dout
(10è<< 
__func__
 << " issue_»pİ shpšgƒm±y o±Øosd." << 
³”


576 << ", objeù " << 
hoid


577 << " which i ³ndšg„ecov”y iÀasync_»cov”y_rg‘s" << 
d’dl
;

579  
should_£nd
;

580 
	}
}

583 
CÚÃùiÚRef
 
	gPrim¬yLogPG
::
	$g‘_cÚ_osd_şu¡”
(

584 
³”
, 
•och_t
 
äom_•och
)

586  
osd
->
	`g‘_cÚ_osd_şu¡”
(
³”
, 
äom_•och
);

587 
	}
}

589 
P”fCouÁ”s
 *
	gPrim¬yLogPG
::
	$g‘_logg”
()

591  
osd
->
logg”
;

592 
	}
}

598 
boŞ
 
	gPrim¬yLogPG
::
	$is_missšg_objeù
(cÚ¡ 
hobjeù_t
& 
soid
) const

600  
pg_log
.
	`g‘_missšg
().
	`g‘_™ems
().
	`couÁ
(
soid
);

601 
	}
}

603 
	gPrim¬yLogPG
::
	$maybe_kick_»cov”y
(

604 cÚ¡ 
hobjeù_t
 &
soid
)

606 
ev”siÚ_t
 
v
;

607 
boŞ
 
wÜk_¡¬‹d
 = 
çl£
;

608 ià(!
missšg_loc
.
	`Ãeds_»cov”y
(
soid
, &
v
))

611 
m­
<
hobjeù_t
, 
ObjeùCÚ‹xtRef
>::
cÚ¡_™”©Ü
 
p
 = 
»cov”šg
.
	`fšd
(
soid
);

612 ià(
p
 !ğ
»cov”šg
.
	`’d
()) {

613 
	`dout
(7è<< "objeù " << 
soid
 << " v " << 
v
 << ",‡Ì—dy„ecov”šg." << 
d’dl
;

614 } ià(
missšg_loc
.
	`is_unfound
(
soid
)) {

615 
	`dout
(7è<< "objeù " << 
soid
 << " v " << 
v
 << ", i unfound." << 
d’dl
;

617 
	`dout
(7è<< "objeù " << 
soid
 << " v " << 
v
 << ",„ecov”šg." << 
d’dl
;

618 
PGBack’d
::
Recov”yHªdË
 *
h
 = 
pgback’d
->
	`İ’_»cov”y_İ
();

619 ià(
	`is_missšg_objeù
(
soid
)) {

620 
	`»cov”_missšg
(
soid
, 
v
, 
cù
->
_cÚf
->
osd_ş›Á_İ_´iÜ™y
, 
h
);

621 } ià(
missšg_loc
.
	`is_d–‘ed
(
soid
)) {

622 
	`´•_objeù_»¶iÿ_d–‘es
(
soid
, 
v
, 
h
, &
wÜk_¡¬‹d
);

624 
	`´•_objeù_»¶iÿ_pushes
(
soid
, 
v
, 
h
, &
wÜk_¡¬‹d
);

626 
pgback’d
->
	`run_»cov”y_İ
(
h
, 
cù
->
_cÚf
->
osd_ş›Á_İ_´iÜ™y
);

628 
	}
}

630 
	gPrim¬yLogPG
::
	$wa™_fÜ_uÄ—dabË_objeù
(

631 cÚ¡ 
hobjeù_t
& 
soid
, 
OpReque¡Ref
 
İ
)

633 
	`as£¹
(
	`is_uÄ—dabË_objeù
(
soid
));

634 
	`maybe_kick_»cov”y
(
soid
);

635 
wa™šg_fÜ_uÄ—dabË_objeù
[
soid
].
	`push_back
(
İ
);

636 
İ
->
	`m¬k_d–ayed
("waiting for missing object");

637 
	}
}

639 
boŞ
 
	gPrim¬yLogPG
::
	$is_deg¿ded_Ü_backflšg_objeù
(cÚ¡ 
hobjeù_t
& 
soid
)

645 ià(
wa™šg_fÜ_deg¿ded_objeù
.
	`couÁ
(
soid
))

646  
Œue
;

647 ià(
pg_log
.
	`g‘_missšg
().
	`g‘_™ems
().
	`couÁ
(
soid
))

648  
Œue
;

649 
	`as£¹
(!
aùšg_»cov”y_backfl
.
	`em±y
());

650 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
aùšg_»cov”y_backfl
.
	`begš
();

651 
i
 !ğ
aùšg_»cov”y_backfl
.
	`’d
();

652 ++
i
) {

653 ià(*
i
 =ğ
	`g‘_´im¬y
()) ;

654 
pg_sh¬d_t
 
³”
 = *
i
;

655 autØ
³”_missšg_’Œy
 = 
³”_missšg
.
	`fšd
(
³”
);

658 ià(
³”_missšg_’Œy
 !ğ
³”_missšg
.
	`’d
() &&

659 
³”_missšg_’Œy
->
£cÚd
.
	`g‘_™ems
().
	`couÁ
(
soid
)) {

660 ià(
async_»cov”y_rg‘s
.
	`couÁ
(
³”
))

663  
Œue
;

667 ià(
	`is_backfl_rg‘s
(
³”
) &&

668 
³”_šfo
[
³”
].
Ï¡_backfl
 <ğ
soid
 &&

669 
Ï¡_backfl_¡¬‹d
 >ğ
soid
 &&

670 
backfls_š_æight
.
	`couÁ
(
soid
))

671  
Œue
;

673  
çl£
;

674 
	}
}

676 
boŞ
 
	gPrim¬yLogPG
::
	$is_deg¿ded_Ú_async_»cov”y_rg‘
(cÚ¡ 
hobjeù_t
& 
soid
)

678 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
aùšg_»cov”y_backfl
.
	`begš
();

679 
i
 !ğ
aùšg_»cov”y_backfl
.
	`’d
();

680 ++
i
) {

681 ià(*
i
 =ğ
	`g‘_´im¬y
()) ;

682 
pg_sh¬d_t
 
³”
 = *
i
;

683 autØ
³”_missšg_’Œy
 = 
³”_missšg
.
	`fšd
(
³”
);

684 ià(
³”_missšg_’Œy
 !ğ
³”_missšg
.
	`’d
() &&

685 
³”_missšg_’Œy
->
£cÚd
.
	`g‘_™ems
().
	`couÁ
(
soid
) &&

686 
async_»cov”y_rg‘s
.
	`couÁ
(
³”
)) {

687 
	`dout
(30è<< 
__func__
 << " " << 
soid
 << 
d’dl
;

688  
Œue
;

691  
çl£
;

692 
	}
}

694 
	gPrim¬yLogPG
::
	$wa™_fÜ_deg¿ded_objeù
(cÚ¡ 
hobjeù_t
& 
soid
, 
OpReque¡Ref
 
İ
)

696 
	`as£¹
(
	`is_deg¿ded_Ü_backflšg_objeù
(
soid
è|| 
	`is_deg¿ded_Ú_async_»cov”y_rg‘
(soid));

698 
	`maybe_kick_»cov”y
(
soid
);

699 
wa™šg_fÜ_deg¿ded_objeù
[
soid
].
	`push_back
(
İ
);

700 
İ
->
	`m¬k_d–ayed
("waiting for degraded object");

701 
	}
}

703 
	gPrim¬yLogPG
::
	$block_wr™e_Ú_fuÎ_ÿche
(

704 cÚ¡ 
hobjeù_t
& 
_oid
, 
OpReque¡Ref
 
İ
)

706 cÚ¡ 
hobjeù_t
 
oid
 = 
_oid
.
	`g‘_h—d
();

707 
	`dout
(20è<< 
__func__
 << ": blockšg objeù " << 
oid


708 << " oÀfuÎ cache" << 
d’dl
;

709 
objeùs_blocked_Ú_ÿche_fuÎ
.
	`š£¹
(
oid
);

710 
wa™šg_fÜ_ÿche_nÙ_fuÎ
.
	`push_back
(
İ
);

711 
İ
->
	`m¬k_d–ayed
("waiting for cache‚ot full");

712 
	}
}

714 
	gPrim¬yLogPG
::
	$block_fÜ_ş—n
(

715 cÚ¡ 
hobjeù_t
& 
oid
, 
OpReque¡Ref
 
İ
)

717 
	`dout
(20è<< 
__func__
 << ": blockšg objeù " << 
oid


718 << " oÀ´im¬y„•aœ" << 
d’dl
;

719 
wa™šg_fÜ_ş—n_to_´im¬y_»·œ
.
	`push_back
(
İ
);

720 
İ
->
	`m¬k_d–ayed
("waiting for cleano„epair");

721 
	}
}

723 
	gPrim¬yLogPG
::
	$block_wr™e_Ú_¢­_rŞlback
(

724 cÚ¡ 
hobjeù_t
& 
oid
, 
ObjeùCÚ‹xtRef
 
obc
, 
OpReque¡Ref
 
İ
)

726 
	`dout
(20è<< 
__func__
 << ": blockšg objeù " << 
oid
.
	`g‘_h—d
()

727 << " oÀ¢­…romÙiÚ " << 
obc
->
obs
.
oi
.
soid
 << 
d’dl
;

729 
	`as£¹
(
oid
.
	`is_h—d
());

730 
	`as£¹
(
objeùs_blocked_Ú_¢­_´omÙiÚ
.
	`couÁ
(
oid
) == 0);

731 
objeùs_blocked_Ú_¢­_´omÙiÚ
[
oid
] = 
obc
;

732 
	`wa™_fÜ_blocked_objeù
(
obc
->
obs
.
oi
.
soid
, 
İ
);

733 
	}
}

735 
	gPrim¬yLogPG
::
	$block_wr™e_Ú_deg¿ded_¢­
(

736 cÚ¡ 
hobjeù_t
& 
¢­
, 
OpReque¡Ref
 
İ
)

738 
	`dout
(20è<< 
__func__
 << ": blockšg objeù " << 
¢­
.
	`g‘_h—d
()

739 << " oÀdeg¿ded sÇ°" << 
¢­
 << 
d’dl
;

741 
	`as£¹
(
objeùs_blocked_Ú_deg¿ded_¢­
.
	`couÁ
(
¢­
.
	`g‘_h—d
()) == 0);

742 
objeùs_blocked_Ú_deg¿ded_¢­
[
¢­
.
	`g‘_h—d
()] = snap.snap;

743 
	`wa™_fÜ_deg¿ded_objeù
(
¢­
, 
İ
);

744 
	}
}

746 
boŞ
 
	gPrim¬yLogPG
::
	$maybe_awa™_blocked_h—d
(

747 cÚ¡ 
hobjeù_t
 &
hoid
,

748 
OpReque¡Ref
 
İ
)

750 
ObjeùCÚ‹xtRef
 
obc
;

751 
obc
 = 
objeù_cÚ‹xts
.
	`lookup
(
hoid
.
	`g‘_h—d
());

752 ià(
obc
) {

753 ià(
obc
->
	`is_blocked
()) {

754 
	`wa™_fÜ_blocked_objeù
(
obc
->
obs
.
oi
.
soid
, 
İ
);

755  
Œue
;

757  
çl£
;

760  
çl£
;

761 
	}
}

763 
	gPrim¬yLogPG
::
	$wa™_fÜ_blocked_objeù
(cÚ¡ 
hobjeù_t
& 
soid
, 
OpReque¡Ref
 
İ
)

765 
	`dout
(10è<< 
__func__
 << " " << 
soid
 << " " << 
İ
 << 
d’dl
;

766 
wa™šg_fÜ_blocked_objeù
[
soid
].
	`push_back
(
İ
);

767 
İ
->
	`m¬k_d–ayed
("waiting for blocked object");

768 
	}
}

770 
	gPrim¬yLogPG
::
	$maybe_fÜû_»cov”y
()

773 ià(!
	`is_deg¿ded
() &&

774 !
	`¡©e_‹¡
(
PG_STATE_RECOVERING
 |

775 
PG_STATE_RECOVERY_WAIT
 |

776 
PG_STATE_BACKFILLING
 |

777 
PG_STATE_BACKFILL_WAIT
 |

778 
PG_STATE_BACKFILL_TOOFULL
))

781 ià(
pg_log
.
	`g‘_log
().
	`­´ox_size
() <

782 
cù
->
_cÚf
->
osd_max_pg_log_’Œ›s
 *

783 
cù
->
_cÚf
->
osd_fÜû_»cov”y_pg_log_’Œ›s_çùÜ
)

787 
v”siÚ_t
 
mš_v”siÚ
 = 
pg_log
.
	`g‘_log
().
h—d
.
v”siÚ
;

788 
hobjeù_t
 
soid
;

789 ià(!
pg_log
.
	`g‘_missšg
().
	`g‘_rmissšg
().
	`em±y
()) {

790 
mš_v”siÚ
 = 
pg_log
.
	`g‘_missšg
().
	`g‘_rmissšg
().
	`begš
()->
fœ¡
;

791 
soid
 = 
pg_log
.
	`g‘_missšg
().
	`g‘_rmissšg
().
	`begš
()->
£cÚd
;

793 
	`as£¹
(!
aùšg_»cov”y_backfl
.
	`em±y
());

794 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
™
 = 
aùšg_»cov”y_backfl
.
	`begš
();

795 
™
 !ğ
aùšg_»cov”y_backfl
.
	`’d
();

796 ++
™
) {

797 ià(*
™
 =ğ
	`g‘_´im¬y
()) ;

798 
pg_sh¬d_t
 
³”
 = *
™
;

799 autØ
™_missšg
 = 
³”_missšg
.
	`fšd
(
³”
);

800 ià(
™_missšg
 !ğ
³”_missšg
.
	`’d
() &&

801 !
™_missšg
->
£cÚd
.
	`g‘_rmissšg
().
	`em±y
()) {

802 cÚ¡‡uto& 
mš_obj
 = 
³”_missšg
[
³”
].
	`g‘_rmissšg
().
	`begš
();

803 
	`dout
(20è<< 
__func__
 << "…“¸" << 
³”
 << " mš_v”siÚ " << 
mš_obj
->
fœ¡


804 << " oid " << 
mš_obj
->
£cÚd
 << 
d’dl
;

805 ià(
mš_v”siÚ
 > 
mš_obj
->
fœ¡
) {

806 
mš_v”siÚ
 = 
mš_obj
->
fœ¡
;

807 
soid
 = 
mš_obj
->
£cÚd
;

813 ià(
soid
 !ğ
	`hobjeù_t
())

814 
	`maybe_kick_»cov”y
(
soid
);

815 
	}
}

817 şas 
	cPGLSPÏšF‹r
 : 
public
 
PGLSF‹r
 {

818 
¡ršg
 
v®
;

819 
	mpublic
:

820 
	$š™
(
bufã¾i¡
::
™”©Ü
 &
·¿ms
è
ov”ride


822 
Œy
 {

823 
	`decode
(
x©Œ
, 
·¿ms
);

824 
	`decode
(
v®
, 
·¿ms
);

825 } 
	`ÿtch
 (
bufãr
::
”rÜ
 &
e
) {

826  -
EINVAL
;

831 ~
	$PGLSPÏšF‹r
(è
ov”ride
 {
	}
}

832 
boŞ
 
	$f‹r
(cÚ¡ 
hobjeù_t
 &
obj
, 
bufã¾i¡
& 
x©Œ_d©a
,

833 
bufã¾i¡
& 
outd©a
è
ov”ride
;

834 
	}
};

836 şas 
	cPGLSP¬’tF‹r
 : 
public
 
PGLSF‹r
 {

837 
šod’o_t
 
·»Á_šo
;

838 
	mpublic
:

839 
C•hCÚ‹xt
* 
cù
;

840 
ex¶ic™
 
	$PGLSP¬’tF‹r
(
C•hCÚ‹xt
* 
cù
è: 
	$cù
(
cù
) {

841 
x©Œ
 = "_parent";

843 
	$š™
(
bufã¾i¡
::
™”©Ü
 &
·¿ms
è
ov”ride


845 
Œy
 {

846 
	`decode
(
·»Á_šo
, 
·¿ms
);

847 } 
	`ÿtch
 (
bufãr
::
”rÜ
 &
e
) {

848  -
EINVAL
;

850 
	`g’”ic_dout
(0è<< "·»Á_šo=" << 
·»Á_šo
 << 
d’dl
;

853 
	}
}

854 ~
	$PGLSP¬’tF‹r
(è
ov”ride
 {
	}
}

855 
boŞ
 
	$f‹r
(cÚ¡ 
hobjeù_t
 &
obj
, 
bufã¾i¡
& 
x©Œ_d©a
,

856 
bufã¾i¡
& 
outd©a
è
ov”ride
;

857 
	}
};

859 
boŞ
 
	gPGLSP¬’tF‹r
::
	$f‹r
(cÚ¡ 
hobjeù_t
 &
obj
,

860 
bufã¾i¡
& 
x©Œ_d©a
, bufã¾i¡& 
outd©a
)

862 
bufã¾i¡
::
™”©Ü
 
™”
 = 
x©Œ_d©a
.
	`begš
();

863 
šode_backŒaû_t
 
bt
;

865 
	`g’”ic_dout
(0è<< "PGLSP¬’tF‹r::f‹r" << 
d’dl
;

867 
	`decode
(
bt
, 
™”
);

869 
veùÜ
<
šode_backpoš‹r_t
>::
™”©Ü
 
vi
;

870 
vi
 = 
bt
.
ªû¡Üs
.
	`begš
(); v˜!ğbt.ªû¡Üs.
	`’d
(); ++vi) {

871 
	`g’”ic_dout
(0è<< "vi->dœšo=" << 
vi
->
dœšo
 << "…¬’t_šo=" << 
·»Á_šo
 << 
d’dl
;

872 ià(
vi
->
dœšo
 =ğ
·»Á_šo
) {

873 
	`’code
(*
vi
, 
outd©a
);

874  
Œue
;

878  
çl£
;

879 
	}
}

881 
boŞ
 
	gPGLSPÏšF‹r
::
	$f‹r
(cÚ¡ 
hobjeù_t
 &
obj
,

882 
bufã¾i¡
& 
x©Œ_d©a
, bufã¾i¡& 
outd©a
)

884 ià(
v®
.
	`size
(è!ğ
x©Œ_d©a
.
	`Ëngth
())

885  
çl£
;

887 ià(
	`memcmp
(
v®
.
	`c_¡r
(), 
x©Œ_d©a
.c_¡r(), v®.
	`size
()))

888  
çl£
;

890  
Œue
;

891 
	}
}

893 
boŞ
 
	gPrim¬yLogPG
::
	$pgls_f‹r
(
PGLSF‹r
 *
f‹r
, 
hobjeù_t
& 
sobj
, 
bufã¾i¡
& 
outd©a
)

895 
bufã¾i¡
 
bl
;

898 ià(!
f‹r
->
	`g‘_x©Œ
().
	`em±y
()) {

899 
»t
 = 
pgback’d
->
	`objeùs_g‘_©Œ
(

900 
sobj
,

901 
f‹r
->
	`g‘_x©Œ
(),

902 &
bl
);

903 
	`dout
(0è<< "g‘©Œ (sobj=" << 
sobj
 << ",‡‰r=" << 
f‹r
->
	`g‘_x©Œ
(è<< "è»tuºed " << 
»t
 << 
d’dl
;

904 ià(
»t
 < 0) {

905 ià(
»t
 !ğ-
ENODATA
 || 
f‹r
->
	`»jeù_em±y_x©Œ
()) {

906  
çl£
;

911  
f‹r
->
	`f‹r
(
sobj
, 
bl
, 
outd©a
);

912 
	}
}

914 
	gPrim¬yLogPG
::
	$g‘_pgls_f‹r
(
bufã¾i¡
::
™”©Ü
& 
™”
, 
PGLSF‹r
 **
pf‹r
)

916 
¡ršg
 
ty³
;

917 
PGLSF‹r
 *
f‹r
;

919 
Œy
 {

920 
	`decode
(
ty³
, 
™”
);

922 
	`ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

923  -
EINVAL
;

926 ià(
ty³
.
	`com·»
("parent") == 0) {

927 
f‹r
 = 
Ãw
 
	`PGLSP¬’tF‹r
(
cù
);

928 } ià(
ty³
.
	`com·»
("plain") == 0) {

929 
f‹r
 = 
Ãw
 
	`PGLSPÏšF‹r
();

931 
¡d
::
size_t
 
dÙ
 = 
ty³
.
	`fšd
(".");

932 ià(
dÙ
 =ğ
¡d
::
¡ršg
::
Åos
 || dÙ =ğ0 || dÙ =ğ
ty³
.
	`size
() - 1) {

933  -
EINVAL
;

936 cÚ¡ 
¡d
::
¡ršg
 
şass_Çme
 = 
ty³
.
	`sub¡r
(0, 
dÙ
);

937 cÚ¡ 
¡d
::
¡ršg
 
f‹r_Çme
 = 
ty³
.
	`sub¡r
(
dÙ
 + 1);

938 
CÏssHªdËr
::
CÏssD©a
 *
şs
 = 
NULL
;

939 
r
 = 
osd
->
şass_hªdËr
->
	`İ’_şass
(
şass_Çme
, &
şs
);

940 ià(
r
 != 0) {

941 
d”r
 << "E¼Ü o³nšg cÏs '" << 
şass_Çme
 << "': "

942 << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

943 ià(
r
 !ğ-
EPERM
)

944 
r
 = -
EINVAL
;

945  
r
;

947 
	`as£¹
(
şs
);

950 
CÏssHªdËr
::
CÏssF‹r
 *
şass_f‹r
 = 
şs
->
	`g‘_f‹r
(
f‹r_Çme
);

951 ià(
şass_f‹r
 =ğ
NULL
) {

952 
d”r
 << "E¼Ü fšdšg f‹¸'" << 
f‹r_Çme
 << "' in class "

953 << 
şass_Çme
 << 
d’dl
;

954  -
EINVAL
;

956 
f‹r
 = 
şass_f‹r
->
	`â
();

957 ià(!
f‹r
) {

960 
d”r
 << "Buggy cÏs " << 
şass_Çme
 << " failedo construct "

961 "f‹¸" << 
f‹r_Çme
 << 
d’dl
;

962  -
EINVAL
;

966 
	`as£¹
(
f‹r
);

967 
r
 = 
f‹r
->
	`š™
(
™”
);

968 ià(
r
 < 0) {

969 
d”r
 << "E¼Ü in™Ÿlizšg f‹¸" << 
ty³
 << ": "

970 << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

971 
d–‘e
 
f‹r
;

972  -
EINVAL
;

975 *
pf‹r
 = 
f‹r
;

978 
	}
}

983 
	gPrim¬yLogPG
::
	$do_commªd
(

984 
cmdm­_t
 
cmdm­
,

985 
o¡»am
& 
ss
,

986 
bufã¾i¡
& 
id©a
,

987 
bufã¾i¡
& 
od©a
,

988 
CÚÃùiÚRef
 
cÚ
,

989 
ûph_tid_t
 
tid
)

991 cÚ¡‡utØ&
missšg
 = 
pg_log
.
	`g‘_missšg
();

992 
¡ršg
 
´efix
;

993 
¡ršg
 
fÜm©
;

995 
	`cmd_g‘v®
(
cù
, 
cmdm­
, "fÜm©", 
fÜm©
);

996 
boo¡
::
scİed_±r
<
FÜm©‹r
> 
	`f
(FÜm©‹r::
	`ü—‹
(
fÜm©
, "json-pretty", "json"));

998 
¡ršg
 
commªd
;

999 
	`cmd_g‘v®
(
cù
, 
cmdm­
, "cmd", 
commªd
);

1000 ià(
commªd
 == "query") {

1001 
f
->
	`İ’_objeù_£ùiÚ
("pg");

1002 
f
->
	`dump_¡ršg
("¡©e", 
	`pg_¡©e_¡ršg
(
	`g‘_¡©e
()));

1003 
f
->
	`dump_¡»am
("¢­_Œimq"è<< 
¢­_Œimq
;

1004 
f
->
	`dump_unsigÃd
("¢­_Œimq_Ën", 
¢­_Œimq
.
	`size
());

1005 
f
->
	`dump_unsigÃd
("•och", 
	`g‘_osdm­
()->
	`g‘_•och
());

1006 
f
->
	`İ’_¬¿y_£ùiÚ
("up");

1007 
veùÜ
<>::
™”©Ü
 
p
 = 
up
.
	`begš
();… !ğup.
	`’d
(); ++p)

1008 
f
->
	`dump_unsigÃd
("osd", *
p
);

1009 
f
->
	`şo£_£ùiÚ
();

1010 
f
->
	`İ’_¬¿y_£ùiÚ
("acting");

1011 
veùÜ
<>::
™”©Ü
 
p
 = 
aùšg
.
	`begš
();… !ğaùšg.
	`’d
(); ++p)

1012 
f
->
	`dump_unsigÃd
("osd", *
p
);

1013 
f
->
	`şo£_£ùiÚ
();

1014 ià(!
backfl_rg‘s
.
	`em±y
()) {

1015 
f
->
	`İ’_¬¿y_£ùiÚ
("backfill_targets");

1016 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
p
 = 
backfl_rg‘s
.
	`begš
();

1017 
p
 !ğ
backfl_rg‘s
.
	`’d
();

1018 ++
p
)

1019 
f
->
	`dump_¡»am
("sh¬d"è<< *
p
;

1020 
f
->
	`şo£_£ùiÚ
();

1022 ià(!
async_»cov”y_rg‘s
.
	`em±y
()) {

1023 
f
->
	`İ’_¬¿y_£ùiÚ
("async_recovery_targets");

1024 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
p
 = 
async_»cov”y_rg‘s
.
	`begš
();

1025 
p
 !ğ
async_»cov”y_rg‘s
.
	`’d
();

1026 ++
p
)

1027 
f
->
	`dump_¡»am
("sh¬d"è<< *
p
;

1028 
f
->
	`şo£_£ùiÚ
();

1030 ià(!
aùšg_»cov”y_backfl
.
	`em±y
()) {

1031 
f
->
	`İ’_¬¿y_£ùiÚ
("acting_recovery_backfill");

1032 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
p
 = 
aùšg_»cov”y_backfl
.
	`begš
();

1033 
p
 !ğ
aùšg_»cov”y_backfl
.
	`’d
();

1034 ++
p
)

1035 
f
->
	`dump_¡»am
("sh¬d"è<< *
p
;

1036 
f
->
	`şo£_£ùiÚ
();

1038 
f
->
	`İ’_objeù_£ùiÚ
("info");

1039 
	`_upd©e_ÿlc_¡©s
();

1040 
šfo
.
	`dump
(
f
.
	`g‘
());

1041 
f
->
	`şo£_£ùiÚ
();

1043 
f
->
	`İ’_¬¿y_£ùiÚ
("peer_info");

1044 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
>::
™”©Ü
 
p
 = 
³”_šfo
.
	`begš
();

1045 
p
 !ğ
³”_šfo
.
	`’d
();

1046 ++
p
) {

1047 
f
->
	`İ’_objeù_£ùiÚ
("info");

1048 
f
->
	`dump_¡»am
("³”"è<< 
p
->
fœ¡
;

1049 
p
->
£cÚd
.
	`dump
(
f
.
	`g‘
());

1050 
f
->
	`şo£_£ùiÚ
();

1052 
f
->
	`şo£_£ùiÚ
();

1054 
f
->
	`İ’_¬¿y_£ùiÚ
("recovery_state");

1055 
	`hªdË_qu”y_¡©e
(
f
.
	`g‘
());

1056 
f
->
	`şo£_£ùiÚ
();

1058 
f
->
	`İ’_objeù_£ùiÚ
("agent_state");

1059 ià(
ag’t_¡©e
)

1060 
ag’t_¡©e
->
	`dump
(
f
.
	`g‘
());

1061 
f
->
	`şo£_£ùiÚ
();

1063 
f
->
	`şo£_£ùiÚ
();

1064 
f
->
	`æush
(
od©a
);

1067 ià(
commªd
 == "mark_unfound_lost") {

1068 
¡ršg
 
mulcmd
;

1069 
	`cmd_g‘v®
(
cù
, 
cmdm­
, "mulcmd", 
mulcmd
);

1070 
mode
 = -1;

1071 ià(
mulcmd
 == "revert") {

1072 ià(
poŞ
.
šfo
.
	`is_”asu»
()) {

1073 
ss
 << "mode must be 'delete' forƒc…ool";

1074  -
EINVAL
;

1076 
mode
 = 
pg_log_’Œy_t
::
LOST_REVERT
;

1077 } ià(
mulcmd
 == "delete") {

1078 
mode
 = 
pg_log_’Œy_t
::
LOST_DELETE
;

1080 
ss
 << "mode must be 'revert' or 'delete'; mark‚ot yet implemented";

1081  -
EINVAL
;

1083 
	`as£¹
(
mode
 =ğ
pg_log_’Œy_t
::
LOST_REVERT
 ||

1084 
mode
 =ğ
pg_log_’Œy_t
::
LOST_DELETE
);

1086 ià(!
	`is_´im¬y
()) {

1087 
ss
 << "not…rimary";

1088  -
EROFS
;

1091 
ušt64_t
 
unfound
 = 
missšg_loc
.
	`num_unfound
();

1092 ià(!
unfound
) {

1093 
ss
 << "pg has‚o unfound objects";

1097 ià(!
	`®l_unfound_¬e_qu”›d_Ü_lo¡
(
	`g‘_osdm­
())) {

1098 
ss
 << "pg ha " << 
unfound


1100  -
EINVAL
;

1103 
	`m¬k_®l_unfound_lo¡
(
mode
, 
cÚ
, 
tid
);

1104  -
EAGAIN
;

1106 ià(
commªd
 == "list_missing") {

1107 
hobjeù_t
 
off£t
;

1108 
¡ršg
 
off£t_jsÚ
;

1109 ià(
	`cmd_g‘v®
(
cù
, 
cmdm­
, "off£t", 
off£t_jsÚ
)) {

1110 
jsÚ_¥œ™
::
V®ue
 
v
;

1111 
Œy
 {

1112 ià(!
jsÚ_¥œ™
::
	`»ad
(
off£t_jsÚ
, 
v
))

1113 
throw
 
¡d
::
	`ruÁime_”rÜ
("bad json");

1114 
off£t
.
	`decode
(
v
);

1115 } 
	`ÿtch
 (
¡d
::
ruÁime_”rÜ
& 
e
) {

1116 
ss
 << "”rÜ…¬sšg off£t: " << 
e
.
	`wh©
();

1117  -
EINVAL
;

1120 
f
->
	`İ’_objeù_£ùiÚ
("missing");

1122 
f
->
	`İ’_objeù_£ùiÚ
("offset");

1123 
off£t
.
	`dump
(
f
.
	`g‘
());

1124 
f
->
	`şo£_£ùiÚ
();

1126 
f
->
	`dump_št
("num_missšg", 
missšg
.
	`num_missšg
());

1127 
f
->
	`dump_št
("num_unfound", 
	`g‘_num_unfound
());

1128 cÚ¡ 
m­
<
hobjeù_t
, 
pg_missšg_™em
> &
Ãeds_»cov”y_m­
 =

1129 
missšg_loc
.
	`g‘_Ãeds_»cov”y
();

1130 
m­
<
hobjeù_t
, 
pg_missšg_™em
>::
cÚ¡_™”©Ü
 
p
 =

1131 
Ãeds_»cov”y_m­
.
	`uµ”_bound
(
off£t
);

1133 
f
->
	`İ’_¬¿y_£ùiÚ
("objects");

1134 
št32_t
 
num
 = 0;

1135 ; 
p
 !ğ
Ãeds_»cov”y_m­
.
	`’d
(è&& 
num
 < 
cù
->
_cÚf
->
osd_commªd_max_»cÜds
; ++p) {

1136 ià(
missšg_loc
.
	`is_unfound
(
p
->
fœ¡
)) {

1137 
f
->
	`İ’_objeù_£ùiÚ
("object");

1139 
f
->
	`İ’_objeù_£ùiÚ
("oid");

1140 
p
->
fœ¡
.
	`dump
(
f
.
	`g‘
());

1141 
f
->
	`şo£_£ùiÚ
();

1143 
p
->
£cÚd
.
	`dump
(
f
.
	`g‘
());

1145 
f
->
	`İ’_¬¿y_£ùiÚ
("locations");

1146 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
r
 =

1147 
missšg_loc
.
	`g‘_loÿtiÚs
(
p
->
fœ¡
).
	`begš
();

1148 
r
 !ğ
missšg_loc
.
	`g‘_loÿtiÚs
(
p
->
fœ¡
).
	`’d
();

1149 ++
r
)

1150 
f
->
	`dump_¡»am
("sh¬d"è<< *
r
;

1151 
f
->
	`şo£_£ùiÚ
();

1153 
f
->
	`şo£_£ùiÚ
();

1154 
num
++;

1157 
f
->
	`şo£_£ùiÚ
();

1159 
f
->
	`dump_boŞ
("mÜe", 
p
 !ğ
Ãeds_»cov”y_m­
.
	`’d
());

1160 
f
->
	`şo£_£ùiÚ
();

1161 
f
->
	`æush
(
od©a
);

1165 
ss
 << "unknowÀpg commªd " << 
´efix
;

1166  -
EINVAL
;

1167 
	}
}

1171 
	gPrim¬yLogPG
::
	$do_pg_İ
(
OpReque¡Ref
 
İ
)

1175 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<MOSDO°*>(
İ
->
	`g‘_nÚcÚ¡_»q
());

1176 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
CEPH_MSG_OSD_OP
);

1177 
	`dout
(10è<< "do_pg_İ " << *
m
 << 
d’dl
;

1179 
İ
->
	`m¬k_¡¬‹d
();

1181 
»suÉ
 = 0;

1182 
¡ršg
 
úame
, 
mÇme
;

1183 
PGLSF‹r
 *
f‹r
 = 
NULL
;

1184 
bufã¾i¡
 
f‹r_out
;

1186 
¢­id_t
 
¢­id
 = 
m
->
	`g‘_¢­id
();

1188 
veùÜ
<
OSDOp
> 
İs
 = 
m
->ops;

1190 
veùÜ
<
OSDOp
>::
™”©Ü
 
p
 = 
İs
.
	`begš
();… !ğİs.
	`’d
(); ++p) {

1191 
OSDOp
& 
osd_İ
 = *
p
;

1192 
bufã¾i¡
::
™”©Ü
 
bp
 = 
p
->
šd©a
.
	`begš
();

1193 
p
->
İ
.op) {

1194 
CEPH_OSD_OP_PGNLS_FILTER
:

1195 
Œy
 {

1196 
	`decode
(
úame
, 
bp
);

1197 
	`decode
(
mÇme
, 
bp
);

1199 
	`ÿtch
 (cÚ¡ 
bufãr
::
”rÜ
& 
e
) {

1200 
	`dout
(0è<< "uÇbËØdecodPGLS_FILTER desütiÚ iÀ" << *
m
 << 
d’dl
;

1201 
»suÉ
 = -
EINVAL
;

1204 ià(
f‹r
) {

1205 
d–‘e
 
f‹r
;

1206 
f‹r
 = 
NULL
;

1208 
»suÉ
 = 
	`g‘_pgls_f‹r
(
bp
, &
f‹r
);

1209 ià(
»suÉ
 < 0)

1212 
	`as£¹
(
f‹r
);

1216 
CEPH_OSD_OP_PGNLS
:

1217 ià(
¢­id
 !ğ
CEPH_NOSNAP
) {

1218 
»suÉ
 = -
EINVAL
;

1221 ià(
	`g‘_osdm­
()->
	`¿w_pg_to_pg
(
m
->
	`g‘_pg
()è!ğ
šfo
.
pgid
.pgid) {

1222 
	`dout
(10è<< "…gÆ pg=" << 
m
->
	`g‘_pg
()

1223 << " " << 
	`g‘_osdm­
()->
	`¿w_pg_to_pg
(
m
->
	`g‘_pg
())

1224 << " !ğ" << 
šfo
.
pgid
 << 
d’dl
;

1225 
»suÉ
 = 0;

1227 
li¡_size
 = 
¡d
::
mš
<
ušt64_t
>(
cù
->
_cÚf
->
osd_max_pgls
,

1228 
p
->
İ
.
pgls
.
couÁ
);

1230 
	`dout
(10è<< "…gÆ pg=" << 
m
->
	`g‘_pg
(è<< " couÁ " << 
li¡_size


1231 << 
d’dl
;

1233 
veùÜ
<
hobjeù_t
> 
£Ár›s
;

1234 
pg_Æs_»¥Ú£_t
 
»¥Ú£
;

1235 
Œy
 {

1236 
	`decode
(
»¥Ú£
.
hªdË
, 
bp
);

1238 
	`ÿtch
 (cÚ¡ 
bufãr
::
”rÜ
& 
e
) {

1239 
	`dout
(0è<< "uÇbËØdecodPGNLS hªdË iÀ" << *
m
 << 
d’dl
;

1240 
»suÉ
 = -
EINVAL
;

1244 
hobjeù_t
 
Ãxt
;

1245 
hobjeù_t
 
low”_bound
 = 
»¥Ú£
.
hªdË
;

1246 
hobjeù_t
 
pg_¡¬t
 = 
šfo
.
pgid
.pgid.
	`g‘_hobj_¡¬t
();

1247 
hobjeù_t
 
pg_’d
 = 
šfo
.
pgid
.pgid.
	`g‘_hobj_’d
(
poŞ
.šfo.
	`g‘_pg_num
());

1248 
	`dout
(10è<< "…gÆ low”_bound " << 
low”_bound


1249 << "…g_’d " << 
pg_’d
 << 
d’dl
;

1250 ià(((!
low”_bound
.
	`is_max
(è&&†ow”_bound >ğ
pg_’d
) ||

1251 (
low”_bound
 !ğ
	`hobjeù_t
(è&&†ow”_bound < 
pg_¡¬t
))) {

1253 
	`dout
(10è<< "outsidoàPG bound " << 
pg_¡¬t
 << " .. "

1254 << 
pg_’d
 << 
d’dl
;

1255 
»suÉ
 = -
EINVAL
;

1259 
hobjeù_t
 
cu¼’t
 = 
low”_bound
;

1260 
r
 = 
pgback’d
->
	`objeùs_li¡_·¹Ÿl
(

1261 
cu¼’t
,

1262 
li¡_size
,

1263 
li¡_size
,

1264 &
£Ár›s
,

1265 &
Ãxt
);

1266 ià(
r
 != 0) {

1267 
»suÉ
 = -
EINVAL
;

1271 
m­
<
hobjeù_t
, 
pg_missšg_™em
>::
cÚ¡_™”©Ü
 
missšg_™”
 =

1272 
pg_log
.
	`g‘_missšg
().
	`g‘_™ems
().
	`low”_bound
(
cu¼’t
);

1273 
veùÜ
<
hobjeù_t
>::
™”©Ü
 
ls_™”
 = 
£Ár›s
.
	`begš
();

1274 
hobjeù_t
 
_max
 = hobjeù_t::
	`g‘_max
();

1276 cÚ¡ 
hobjeù_t
 &
mÿnd
 =

1277 
missšg_™”
 =ğ
pg_log
.
	`g‘_missšg
().
	`g‘_™ems
().
	`’d
() ?

1278 
_max
 :

1279 
missšg_™”
->
fœ¡
;

1280 cÚ¡ 
hobjeù_t
 &
lÿnd
 =

1281 
ls_™”
 =ğ
£Ár›s
.
	`’d
() ?

1282 
_max
 :

1283 *
ls_™”
;

1285 
hobjeù_t
 
ÿndid©e
;

1286 ià(
mÿnd
 =ğ
lÿnd
) {

1287 
ÿndid©e
 = 
mÿnd
;

1288 ià(!
mÿnd
.
	`is_max
()) {

1289 ++
ls_™”
;

1290 ++
missšg_™”
;

1292 } ià(
mÿnd
 < 
lÿnd
) {

1293 
ÿndid©e
 = 
mÿnd
;

1294 
	`as£¹
(!
mÿnd
.
	`is_max
());

1295 ++
missšg_™”
;

1297 
ÿndid©e
 = 
lÿnd
;

1298 
	`as£¹
(!
lÿnd
.
	`is_max
());

1299 ++
ls_™”
;

1302 
	`dout
(10è<< "…gÆ ÿndid©0x" << 
¡d
::
hex
 << 
ÿndid©e
.
	`g‘_hash
()

1303 << " v low” bound 0x" << 
low”_bound
.
	`g‘_hash
(è<< 
d’dl
;

1305 ià(
ÿndid©e
 >ğ
Ãxt
) {

1309 ià(
»¥Ú£
.
’Œ›s
.
	`size
(è=ğ
li¡_size
) {

1310 
Ãxt
 = 
ÿndid©e
;

1314 ià(
ÿndid©e
.
¢­
 !ğ
CEPH_NOSNAP
)

1318 ià(
ÿndid©e
.
	`g‘_Çme¥aû
(è=ğ
cù
->
_cÚf
->
osd_h™_£t_Çme¥aû
)

1321 ià(
missšg_loc
.
	`is_d–‘ed
(
ÿndid©e
))

1325 ià(
m
->
	`g‘_hobj
().
n¥aû
 !ğ
lib¿dos
::
®l_n¥aûs
 &&

1326 
ÿndid©e
.
	`g‘_Çme¥aû
(è!ğ
m
->
	`g‘_hobj
().
n¥aû
)

1329 ià(
f‹r
 && !
	`pgls_f‹r
(f‹r, 
ÿndid©e
, 
f‹r_out
))

1332 
	`dout
(20è<< "pgÆ ™em 0x" << 
¡d
::
hex


1333 << 
ÿndid©e
.
	`g‘_hash
()

1334 << ",„ev 0x" << 
hobjeù_t
::
	`_»v”£_b™s
(
ÿndid©e
.
	`g‘_hash
())

1335 << 
¡d
::
dec
 << " "

1336 << 
ÿndid©e
.
oid
.
Çme
 << 
d’dl
;

1338 
lib¿dos
::
Li¡ObjeùIm¶
 
™em
;

1339 
™em
.
n¥aû
 = 
ÿndid©e
.
	`g‘_Çme¥aû
();

1340 
™em
.
oid
 = 
ÿndid©e
.oid.
Çme
;

1341 
™em
.
loÿtÜ
 = 
ÿndid©e
.
	`g‘_key
();

1342 
»¥Ú£
.
’Œ›s
.
	`push_back
(
™em
);

1345 ià(
Ãxt
.
	`is_max
() &&

1346 
missšg_™”
 =ğ
pg_log
.
	`g‘_missšg
().
	`g‘_™ems
().
	`’d
() &&

1347 
ls_™”
 =ğ
£Ár›s
.
	`’d
()) {

1348 
»suÉ
 = 1;

1352 
»¥Ú£
.
hªdË
 = 
šfo
.
pgid
.pgid.
	`g‘_hobj_’d
(
poŞ
.šfo.
	`g‘_pg_num
());

1354 
»¥Ú£
.
hªdË
 = 
Ãxt
;

1356 
	`dout
(10è<< "pgÆ hªdË=" << 
»¥Ú£
.
hªdË
 << 
d’dl
;

1357 
	`’code
(
»¥Ú£
, 
osd_İ
.
outd©a
);

1358 ià(
f‹r
)

1359 
	`’code
(
f‹r_out
, 
osd_İ
.
outd©a
);

1360 
	`dout
(10è<< "…gÆ »suÉ=" << 
»suÉ
 << " outdata.length()="

1361 << 
osd_İ
.
outd©a
.
	`Ëngth
(è<< 
d’dl
;

1365 
CEPH_OSD_OP_PGLS_FILTER
:

1366 
Œy
 {

1367 
	`decode
(
úame
, 
bp
);

1368 
	`decode
(
mÇme
, 
bp
);

1370 
	`ÿtch
 (cÚ¡ 
bufãr
::
”rÜ
& 
e
) {

1371 
	`dout
(0è<< "uÇbËØdecodPGLS_FILTER desütiÚ iÀ" << *
m
 << 
d’dl
;

1372 
»suÉ
 = -
EINVAL
;

1375 ià(
f‹r
) {

1376 
d–‘e
 
f‹r
;

1377 
f‹r
 = 
NULL
;

1379 
»suÉ
 = 
	`g‘_pgls_f‹r
(
bp
, &
f‹r
);

1380 ià(
»suÉ
 < 0)

1383 
	`as£¹
(
f‹r
);

1387 
CEPH_OSD_OP_PGLS
:

1388 ià(
¢­id
 !ğ
CEPH_NOSNAP
) {

1389 
»suÉ
 = -
EINVAL
;

1392 ià(
	`g‘_osdm­
()->
	`¿w_pg_to_pg
(
m
->
	`g‘_pg
()è!ğ
šfo
.
pgid
.pgid) {

1393 
	`dout
(10è<< "…gl pg=" << 
m
->
	`g‘_pg
()

1394 << " " << 
	`g‘_osdm­
()->
	`¿w_pg_to_pg
(
m
->
	`g‘_pg
())

1395 << " !ğ" << 
šfo
.
pgid
 << 
d’dl
;

1396 
»suÉ
 = 0;

1398 
li¡_size
 = 
¡d
::
mš
<
ušt64_t
>(
cù
->
_cÚf
->
osd_max_pgls
,

1399 
p
->
İ
.
pgls
.
couÁ
);

1401 
	`dout
(10è<< "…gl pg=" << 
m
->
	`g‘_pg
(è<< " couÁ " << 
li¡_size
 << 
d’dl
;

1403 
veùÜ
<
hobjeù_t
> 
£Ár›s
;

1404 
pg_ls_»¥Ú£_t
 
»¥Ú£
;

1405 
Œy
 {

1406 
	`decode
(
»¥Ú£
.
hªdË
, 
bp
);

1408 
	`ÿtch
 (cÚ¡ 
bufãr
::
”rÜ
& 
e
) {

1409 
	`dout
(0è<< "uÇbËØdecodPGLS hªdË iÀ" << *
m
 << 
d’dl
;

1410 
»suÉ
 = -
EINVAL
;

1414 
hobjeù_t
 
Ãxt
;

1415 
hobjeù_t
 
cu¼’t
 = 
»¥Ú£
.
hªdË
;

1416 
r
 = 
pgback’d
->
	`objeùs_li¡_·¹Ÿl
(

1417 
cu¼’t
,

1418 
li¡_size
,

1419 
li¡_size
,

1420 &
£Ár›s
,

1421 &
Ãxt
);

1422 ià(
r
 != 0) {

1423 
»suÉ
 = -
EINVAL
;

1427 
	`as£¹
(
¢­id
 =ğ
CEPH_NOSNAP
 || 
pg_log
.
	`g‘_missšg
().
	`g‘_™ems
().
	`em±y
());

1429 
m­
<
hobjeù_t
, 
pg_missšg_™em
>::
cÚ¡_™”©Ü
 
missšg_™”
 =

1430 
pg_log
.
	`g‘_missšg
().
	`g‘_™ems
().
	`low”_bound
(
cu¼’t
);

1431 
veùÜ
<
hobjeù_t
>::
™”©Ü
 
ls_™”
 = 
£Ár›s
.
	`begš
();

1432 
hobjeù_t
 
_max
 = hobjeù_t::
	`g‘_max
();

1434 cÚ¡ 
hobjeù_t
 &
mÿnd
 =

1435 
missšg_™”
 =ğ
pg_log
.
	`g‘_missšg
().
	`g‘_™ems
().
	`’d
() ?

1436 
_max
 :

1437 
missšg_™”
->
fœ¡
;

1438 cÚ¡ 
hobjeù_t
 &
lÿnd
 =

1439 
ls_™”
 =ğ
£Ár›s
.
	`’d
() ?

1440 
_max
 :

1441 *
ls_™”
;

1443 
hobjeù_t
 
ÿndid©e
;

1444 ià(
mÿnd
 =ğ
lÿnd
) {

1445 
ÿndid©e
 = 
mÿnd
;

1446 ià(!
mÿnd
.
	`is_max
()) {

1447 ++
ls_™”
;

1448 ++
missšg_™”
;

1450 } ià(
mÿnd
 < 
lÿnd
) {

1451 
ÿndid©e
 = 
mÿnd
;

1452 
	`as£¹
(!
mÿnd
.
	`is_max
());

1453 ++
missšg_™”
;

1455 
ÿndid©e
 = 
lÿnd
;

1456 
	`as£¹
(!
lÿnd
.
	`is_max
());

1457 ++
ls_™”
;

1460 ià(
ÿndid©e
 >ğ
Ãxt
) {

1464 ià(
»¥Ú£
.
’Œ›s
.
	`size
(è=ğ
li¡_size
) {

1465 
Ãxt
 = 
ÿndid©e
;

1469 ià(
ÿndid©e
.
¢­
 !ğ
CEPH_NOSNAP
)

1473 ià(
ÿndid©e
.
	`g‘_Çme¥aû
(è!ğ
m
->
	`g‘_hobj
().
n¥aû
)

1476 ià(
missšg_loc
.
	`is_d–‘ed
(
ÿndid©e
))

1479 ià(
f‹r
 && !
	`pgls_f‹r
(f‹r, 
ÿndid©e
, 
f‹r_out
))

1482 
»¥Ú£
.
’Œ›s
.
	`push_back
(
	`make_·œ
(
ÿndid©e
.
oid
,

1483 
ÿndid©e
.
	`g‘_key
()));

1485 ià(
Ãxt
.
	`is_max
() &&

1486 
missšg_™”
 =ğ
pg_log
.
	`g‘_missšg
().
	`g‘_™ems
().
	`’d
() &&

1487 
ls_™”
 =ğ
£Ár›s
.
	`’d
()) {

1488 
»suÉ
 = 1;

1490 
»¥Ú£
.
hªdË
 = 
Ãxt
;

1491 
	`’code
(
»¥Ú£
, 
osd_İ
.
outd©a
);

1492 ià(
f‹r
)

1493 
	`’code
(
f‹r_out
, 
osd_İ
.
outd©a
);

1494 
	`dout
(10è<< "…gl »suÉ=" << 
»suÉ
 << " outdata.length()="

1495 << 
osd_İ
.
outd©a
.
	`Ëngth
(è<< 
d’dl
;

1499 
CEPH_OSD_OP_PG_HITSET_LS
:

1501 
li¡
< 
·œ
<
utime_t
,utime_t> > 
ls
;

1502 
li¡
<
pg_h™_£t_šfo_t
>::
cÚ¡_™”©Ü
 
p
 = 
šfo
.
h™_£t
.
hi¡Üy
.
	`begš
();

1503 
p
 !ğ
šfo
.
h™_£t
.
hi¡Üy
.
	`’d
();

1504 ++
p
)

1505 
ls
.
	`push_back
(
	`make_·œ
(
p
->
begš
,…->
’d
));

1506 ià(
h™_£t
)

1507 
ls
.
	`push_back
(
	`make_·œ
(
h™_£t_¡¬t_¡amp
, 
	`utime_t
()));

1508 
	`’code
(
ls
, 
osd_İ
.
outd©a
);

1512 
CEPH_OSD_OP_PG_HITSET_GET
:

1514 
utime_t
 
	`¡amp
(
osd_İ
.
İ
.
h™_£t_g‘
.
¡amp
);

1515 ià(
h™_£t_¡¬t_¡amp
 && 
¡amp
 >= hit_set_start_stamp) {

1518 ià(!
h™_£t
) {

1519 
»suÉ
ğ-
ENOENT
;

1522 
	`’code
(*
h™_£t
, 
osd_İ
.
outd©a
);

1523 
»suÉ
 = 
osd_İ
.
outd©a
.
	`Ëngth
();

1526 
hobjeù_t
 
oid
;

1527 
li¡
<
pg_h™_£t_šfo_t
>::
cÚ¡_™”©Ü
 
p
 = 
šfo
.
h™_£t
.
hi¡Üy
.
	`begš
();

1528 
p
 !ğ
šfo
.
h™_£t
.
hi¡Üy
.
	`’d
();

1529 ++
p
) {

1530 ià(
¡amp
 >ğ
p
->
begš
 && sm°<ğp->
’d
) {

1531 
oid
 = 
	`g‘_h™_£t_¬chive_objeù
(
p
->
begš
,…->
’d
,…->
usšg_gmt
);

1535 ià(
oid
 =ğ
	`hobjeù_t
()) {

1536 
»suÉ
 = -
ENOENT
;

1539 ià(!
poŞ
.
šfo
.
	`is_»¶iÿ‹d
()) {

1541 
»suÉ
 = -
EOPNOTSUPP
;

1544 ià(
	`is_uÄ—dabË_objeù
(
oid
)) {

1545 
	`wa™_fÜ_uÄ—dabË_objeù
(
oid
, 
İ
);

1546 
d–‘e
 
f‹r
;

1549 
»suÉ
 = 
osd
->
¡Üe
->
	`»ad
(
ch
, 
	`ghobjeù_t
(
oid
), 0, 0, 
osd_İ
.
outd©a
);

1554 
CEPH_OSD_OP_SCRUBLS
:

1555 
»suÉ
 = 
	`do_süub_ls
(
m
, &
osd_İ
);

1559 
»suÉ
 = -
EINVAL
;

1563 ià(
»suÉ
 < 0)

1568 
MOSDOpR•ly
 *
»¶y
 = 
Ãw
 
	`MOSDOpR•ly
(
m
, 0, 
	`g‘_osdm­
()->
	`g‘_•och
(),

1569 
CEPH_OSD_FLAG_ACK
 | 
CEPH_OSD_FLAG_ONDISK
,

1570 
çl£
);

1571 
»¶y
->
	`şaim_İ_out_d©a
(
İs
);

1572 
»¶y
->
	`£t_»suÉ
(
»suÉ
);

1573 
»¶y
->
	`£t_»¶y_v”siÚs
(
šfo
.
Ï¡_upd©e
, info.
Ï¡_u£r_v”siÚ
);

1574 
osd
->
	`£nd_mes§ge_osd_ş›Á
(
»¶y
, 
m
->
	`g‘_cÚÃùiÚ
());

1575 
d–‘e
 
f‹r
;

1576 
	}
}

1578 
	gPrim¬yLogPG
::
	$do_süub_ls
(
MOSDOp
 *
m
, 
OSDOp
 *
osd_İ
)

1580 ià(
m
->
	`g‘_pg
(è!ğ
šfo
.
pgid
.pgid) {

1581 
	`dout
(10è<< " süubl pg=" << 
m
->
	`g‘_pg
(è<< " !ğ" << 
šfo
.
pgid
 << 
d’dl
;

1582  -
EINVAL
;

1584 autØ
bp
 = 
osd_İ
->
šd©a
.
	`begš
();

1585 
süub_ls_¬g_t
 
¬g
;

1586 
Œy
 {

1587 
¬g
.
	`decode
(
bp
);

1588 } 
	`ÿtch
 (
bufãr
::
”rÜ
&) {

1589 
	`dout
(10è<< " cÜru±ed süub_ls_¬g_t" << 
d’dl
;

1590  -
EINVAL
;

1592 
r
 = 0;

1593 
süub_ls_»suÉ_t
 
»suÉ
 = {.
š‹rv®
 = 
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû
};

1594 ià(
¬g
.
š‹rv®
 !ğ0 &&‡rg.š‹rv® !ğ
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû
) {

1595 
r
 = -
EAGAIN
;

1596 } ià(!
süubb”
.
¡Üe
) {

1597 
r
 = -
ENOENT
;

1598 } ià(
¬g
.
g‘_¢­£ts
) {

1599 
»suÉ
.
v®s
 = 
süubb”
.
¡Üe
->
	`g‘_¢­_”rÜs
(
osd
->store,

1600 
	`g‘_pgid
().
	`poŞ
(),

1601 
¬g
.
¡¬t_aá”
,

1602 
¬g
.
max_»tuº
);

1604 
»suÉ
.
v®s
 = 
süubb”
.
¡Üe
->
	`g‘_objeù_”rÜs
(
osd
->store,

1605 
	`g‘_pgid
().
	`poŞ
(),

1606 
¬g
.
¡¬t_aá”
,

1607 
¬g
.
max_»tuº
);

1609 
	`’code
(
»suÉ
, 
osd_İ
->
outd©a
);

1610  
r
;

1611 
	}
}

1613 
	gPrim¬yLogPG
::
	$ÿlc_Œim_to
()

1615 
size_t
 
rg‘
 = 
cù
->
_cÚf
->
osd_mš_pg_log_’Œ›s
;

1616 ià(
	`is_deg¿ded
() ||

1617 
	`¡©e_‹¡
(
PG_STATE_RECOVERING
 |

1618 
PG_STATE_RECOVERY_WAIT
 |

1619 
PG_STATE_BACKFILLING
 |

1620 
PG_STATE_BACKFILL_WAIT
 |

1621 
PG_STATE_BACKFILL_TOOFULL
)) {

1622 
rg‘
 = 
cù
->
_cÚf
->
osd_max_pg_log_’Œ›s
;

1625 
ev”siÚ_t
 
lim™
 = 
¡d
::
	`mš
(

1626 
mš_Ï¡_com¶‘e_Údisk
,

1627 
pg_log
.
	`g‘_ÿn_rŞlback_to
());

1628 ià(
lim™
 !ğ
	`ev”siÚ_t
() &&

1629 
lim™
 !ğ
pg_Œim_to
 &&

1630 
pg_log
.
	`g‘_log
().
	`­´ox_size
(è> 
rg‘
) {

1631 
size_t
 
num_to_Œim
 = 
¡d
::
	`mš
(
pg_log
.
	`g‘_log
().
	`­´ox_size
(è- 
rg‘
,

1632 
cù
->
_cÚf
->
osd_pg_log_Œim_max
);

1633 ià(
num_to_Œim
 < 
cù
->
_cÚf
->
osd_pg_log_Œim_mš
 &&

1634 
cù
->
_cÚf
->
osd_pg_log_Œim_max
 >ğcù->_cÚf->
osd_pg_log_Œim_mš
) {

1637 
li¡
<
pg_log_’Œy_t
>::
cÚ¡_™”©Ü
 
™
 = 
pg_log
.
	`g‘_log
().
log
.
	`begš
();

1638 
ev”siÚ_t
 
Ãw_Œim_to
;

1639 
size_t
 
i
 = 0; i < 
num_to_Œim
; ++i) {

1640 
Ãw_Œim_to
 = 
™
->
v”siÚ
;

1641 ++
™
;

1642 ià(
Ãw_Œim_to
 > 
lim™
) {

1643 
Ãw_Œim_to
 = 
lim™
;

1644 
	`dout
(10è<< "ÿlc_Œim_tØŒimmšgØmš_Ï¡_com¶‘e_Údisk" << 
d’dl
;

1648 
	`dout
(10è<< "ÿlc_Œim_tØ" << 
pg_Œim_to
 << " -> " << 
Ãw_Œim_to
 << 
d’dl
;

1649 
pg_Œim_to
 = 
Ãw_Œim_to
;

1650 
	`as£¹
(
pg_Œim_to
 <ğ
pg_log
.
	`g‘_h—d
());

1651 
	`as£¹
(
pg_Œim_to
 <ğ
mš_Ï¡_com¶‘e_Údisk
);

1653 
	}
}

1655 
	gPrim¬yLogPG
::
Prim¬yLogPG
(
OSDS”viû
 *
o
, 
OSDM­Ref
 
curm­
,

1656 cÚ¡ 
PGPoŞ
 &
_poŞ
,

1657 cÚ¡ 
m­
<
¡ršg
,¡ršg>& 
ec_´ofe
, 
¥g_t
 
p
) :

1658 
PG
(
o
, 
curm­
, 
_poŞ
, 
p
),

1659 
pgback’d
(

1660 
PGBack’d
::
bud_pg_back’d
(

1661 
_poŞ
.
šfo
, 
ec_´ofe
, 
this
, 
cŞl_t
(
p
), 
ch
, 
o
->
¡Üe
, 
cù
)),

1662 
objeù_cÚ‹xts
(
o
->
cù
, o->cù->
_cÚf
->
osd_pg_objeù_cÚ‹xt_ÿche_couÁ
),

1663 
¢­£t_cÚ‹xts_lock
("PrimaryLogPG::snapset_contexts_lock"),

1664 
Ãw_backfl
(
çl£
),

1665 
‹mp_£q
(0),

1666 
	$¢­_Œimm”_machše
(
this
)

1668 
missšg_loc
.
	`£t_back’d_´ediÿ‹s
(

1669 
pgback’d
->
	`g‘_is_»adabË_´ediÿ‹
(),

1670 
pgback’d
->
	`g‘_is_»cov”abË_´ediÿ‹
());

1671 
¢­_Œimm”_machše
.
	`š™Ÿ‹
();

1672 
	}
}

1674 
	gPrim¬yLogPG
::
	$g‘_¤c_Şoc
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
, objeù_loÿtÜ_t& 
¤c_Şoc
)

1676 
¤c_Şoc
 = 
Şoc
;

1677 ià(
Şoc
.
key
.
	`em±y
())

1678 
¤c_Şoc
.
key
 = 
oid
.
Çme
;

1679 
	}
}

1681 
	gPrim¬yLogPG
::
	$hªdË_backoff
(
OpReque¡Ref
& 
İ
)

1683 cÚ¡ 
MOSDBackoff
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDBackoff*>(
İ
->
	`g‘_»q
());

1684 
SessiÚRef
 
£ssiÚ
 = 
¡©ic_ÿ¡
<
SessiÚ
*>(
m
->
	`g‘_cÚÃùiÚ
()->
	`g‘_´iv
());

1685 ià(!
£ssiÚ
)

1687 
£ssiÚ
->
	`put
();

1688 
hobjeù_t
 
begš
 = 
šfo
.
pgid
.pgid.
	`g‘_hobj_¡¬t
();

1689 
hobjeù_t
 
’d
 = 
šfo
.
pgid
.pgid.
	`g‘_hobj_’d
(
poŞ
.šfo.
	`g‘_pg_num
());

1690 ià(
begš
 < 
m
->begin) {

1691 
begš
 = 
m
->begin;

1693 ià(
’d
 > 
m
->end) {

1694 
’d
 = 
m
->end;

1696 
	`dout
(10è<< 
__func__
 << " backofàack id " << 
m
->
id


1697 << " [" << 
begš
 << "," << 
’d
 << ")" << 
d’dl
;

1698 
£ssiÚ
->
	`ack_backoff
(
cù
, 
m
->
pgid
, m->
id
, 
begš
, 
’d
);

1699 
	}
}

1701 
	gPrim¬yLogPG
::
	$do_»que¡
(

1702 
OpReque¡Ref
& 
İ
,

1703 
Th»adPoŞ
::
TPHªdË
 &
hªdË
)

1705 ià(
İ
->
osd_Œaû
) {

1706 
İ
->
pg_Œaû
.
	`š™
("pg op", &
Œaû_’dpošt
, &İ->
osd_Œaû
);

1707 
İ
->
pg_Œaû
.
	`ev’t
("do„equest");

1710 autØ
p
 = 
wa™šg_fÜ_m­
.
	`fšd
(
İ
->
	`g‘_sourû
());

1711 ià(
p
 !ğ
wa™šg_fÜ_m­
.
	`’d
()) {

1713 
	`dout
(20è<< 
__func__
 << " waiting_for_map "

1714 << 
p
->
fœ¡
 << "‚Ùƒm±y, queuešg" << 
d’dl
;

1715 
p
->
£cÚd
.
	`push_back
(
İ
);

1716 
İ
->
	`m¬k_d–ayed
("waiting_for_map‚otƒmpty");

1719 ià(!
	`have_§me_Ü_Ãw”_m­
(
İ
->
mš_•och
)) {

1720 
	`dout
(20è<< 
__func__
 << " mš " << 
İ
->
mš_•och


1721 << ", queuÚ wa™šg_fÜ_m­ " << 
İ
->
	`g‘_sourû
(è<< 
d’dl
;

1722 
wa™šg_fÜ_m­
[
İ
->
	`g‘_sourû
()].
	`push_back
(op);

1723 
İ
->
	`m¬k_d–ayed
("op must wait for map");

1724 
osd
->
	`»que¡_osdm­_upd©e
(
İ
->
mš_•och
);

1728 ià(
	`ÿn_disÿrd_»que¡
(
İ
)) {

1733 cÚ¡ 
Mes§ge
 *
m
 = 
İ
->
	`g‘_»q
();

1734 
msg_ty³
 = 
m
->
	`g‘_ty³
();

1735 ià(
m
->
	`g‘_cÚÃùiÚ
()->
	`has_ã©u»
(
CEPH_FEATURE_RADOS_BACKOFF
)) {

1736 
SessiÚRef
 
£ssiÚ
 = 
¡©ic_ÿ¡
<
SessiÚ
*>(
m
->
	`g‘_cÚÃùiÚ
()->
	`g‘_´iv
());

1737 ià(!
£ssiÚ
)

1739 
£ssiÚ
->
	`put
();

1741 ià(
msg_ty³
 =ğ
CEPH_MSG_OSD_OP
) {

1742 ià(
£ssiÚ
->
	`check_backoff
(
cù
, 
šfo
.
pgid
,

1743 
šfo
.
pgid
.pgid.
	`g‘_hobj_¡¬t
(), 
m
)) {

1747 
boŞ
 
backoff
 =

1748 
	`is_down
() ||

1749 
	`is_šcom¶‘e
() ||

1750 (!
	`is_aùive
(è&& 
	`is_³”ed
());

1751 ià(
g_cÚf
->
osd_backoff_Ú_³”šg
 && !
backoff
) {

1752 ià(
	`is_³”šg
()) {

1753 
backoff
 = 
Œue
;

1756 ià(
backoff
) {

1757 
	`add_pg_backoff
(
£ssiÚ
);

1762 ià(
msg_ty³
 =ğ
CEPH_MSG_OSD_BACKOFF
) {

1763 cÚ¡ 
MOSDBackoff
 *
ba
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDBackoff*>(
m
);

1764 ià(
ba
->
begš
 !ğba->
’d
) {

1765 
	`hªdË_backoff
(
İ
);

1771 ià(!
	`is_³”ed
()) {

1773 ià(
pgback’d
->
	`ÿn_hªdË_whe_šaùive
(
İ
)) {

1774 
boŞ
 
hªdËd
 = 
pgback’d
->
	`hªdË_mes§ge
(
İ
);

1775 
	`as£¹
(
hªdËd
);

1778 
wa™šg_fÜ_³”ed
.
	`push_back
(
İ
);

1779 
İ
->
	`m¬k_d–ayed
("waiting for…eered");

1784 ià(
æushes_š_´og»ss
 > 0) {

1785 
	`dout
(20è<< 
æushes_š_´og»ss


1787 << "wa™šg fÜ flush oÀ" << 
İ
 << 
d’dl
;

1788 
wa™šg_fÜ_æush
.
	`push_back
(
İ
);

1789 
İ
->
	`m¬k_d–ayed
("waiting for flush");

1793 
	`as£¹
(
	`is_³”ed
(è&& 
æushes_š_´og»ss
 == 0);

1794 ià(
pgback’d
->
	`hªdË_mes§ge
(
İ
))

1797 
msg_ty³
) {

1798 
CEPH_MSG_OSD_OP
:

1799 
CEPH_MSG_OSD_BACKOFF
:

1800 ià(!
	`is_aùive
()) {

1801 
	`dout
(20è<< "…“»d,‚Ù‡ùive, wa™šg fÜ‡ùivÚ " << 
İ
 << 
d’dl
;

1802 
wa™šg_fÜ_aùive
.
	`push_back
(
İ
);

1803 
İ
->
	`m¬k_d–ayed
("waiting for‡ctive");

1806 
msg_ty³
) {

1807 
CEPH_MSG_OSD_OP
:

1809 ià((
poŞ
.
šfo
.
	`has_t›rs
(è||…oŞ.šfo.
	`is_t›r
()) &&

1810 !
İ
->
	`has_ã©u»
(
CEPH_FEATURE_OSD_CACHEPOOL
)) {

1811 
osd
->
	`»¶y_İ_”rÜ
(
İ
, -
EOPNOTSUPP
);

1814 
	`do_İ
(
İ
);

1816 
CEPH_MSG_OSD_BACKOFF
:

1818 
	`hªdË_backoff
(
İ
);

1823 
MSG_OSD_PG_SCAN
:

1824 
	`do_sÿn
(
İ
, 
hªdË
);

1827 
MSG_OSD_PG_BACKFILL
:

1828 
	`do_backfl
(
İ
);

1831 
MSG_OSD_PG_BACKFILL_REMOVE
:

1832 
	`do_backfl_»move
(
İ
);

1835 
MSG_OSD_SCRUB_RESERVE
:

1837 cÚ¡ 
MOSDSüubRe£rve
 *
m
 =

1838 
¡©ic_ÿ¡
<cÚ¡ 
MOSDSüubRe£rve
*>(
İ
->
	`g‘_»q
());

1839 
m
->
ty³
) {

1840 
MOSDSüubRe£rve
::
REQUEST
:

1841 
	`hªdË_süub_»£rve_»que¡
(
İ
);

1843 
MOSDSüubRe£rve
::
GRANT
:

1844 
	`hªdË_süub_»£rve_g¿Á
(
İ
, 
m
->
äom
);

1846 
MOSDSüubRe£rve
::
REJECT
:

1847 
	`hªdË_süub_»£rve_»jeù
(
İ
, 
m
->
äom
);

1849 
MOSDSüubRe£rve
::
RELEASE
:

1850 
	`hªdË_süub_»£rve_»Ëa£
(
İ
);

1856 
MSG_OSD_REP_SCRUB
:

1857 
	`»¶iÿ_süub
(
İ
, 
hªdË
);

1860 
MSG_OSD_REP_SCRUBMAP
:

1861 
	`do_»¶iÿ_süub_m­
(
İ
);

1864 
MSG_OSD_PG_UPDATE_LOG_MISSING
:

1865 
	`do_upd©e_log_missšg
(
İ
);

1868 
MSG_OSD_PG_UPDATE_LOG_MISSING_REPLY
:

1869 
	`do_upd©e_log_missšg_»¶y
(
İ
);

1873 
	`as£¹
(0 == "bad messageype in do_request");

1875 
	}
}

1877 
hobjeù_t
 
	gPrim¬yLogPG
::
	$—¾›¡_backfl
() const

1879 
hobjeù_t
 
e
 = hobjeù_t::
	`g‘_max
();

1880 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
backfl_rg‘s
.
	`begš
();

1881 
i
 !ğ
backfl_rg‘s
.
	`’d
();

1882 ++
i
) {

1883 
pg_sh¬d_t
 
bt
 = *
i
;

1884 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
>::
cÚ¡_™”©Ü
 
™”
 = 
³”_šfo
.
	`fšd
(
bt
);

1885 
	`as£¹
(
™”
 !ğ
³”_šfo
.
	`’d
());

1886 ià(
™”
->
£cÚd
.
Ï¡_backfl
 < 
e
)

1887 
e
 = 
™”
->
£cÚd
.
Ï¡_backfl
;

1889  
e
;

1890 
	}
}

1896 
	gPrim¬yLogPG
::
	$do_İ
(
OpReque¡Ref
& 
İ
)

1898 
	`FUNCTRACE
(
cù
);

1901 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<MOSDOp*>(
İ
->
	`g‘_nÚcÚ¡_»q
());

1902 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
CEPH_MSG_OSD_OP
);

1903 ià(
m
->
	`fšish_decode
()) {

1904 
İ
->
	`»£t_desc
();

1905 
m
->
	`ş—r_·ylßd
();

1908 
	`dout
(20è<< 
__func__
 << ": o°" << *
m
 << 
d’dl
;

1910 
hobjeù_t
 
h—d
 = 
m
->
	`g‘_hobj
();

1911 
h—d
.
¢­
 = 
CEPH_NOSNAP
;

1913 ià(!
šfo
.
pgid
.pgid.
	`cÚšs
(

1914 
šfo
.
pgid
.pgid.
	`g‘_¥l™_b™s
(
poŞ
.šfo.
	`g‘_pg_num
()), 
h—d
)) {

1915 
d”r
 << 
__func__
 << " " << 
šfo
.
pgid
.pgid << " does‚ot contain "

1916 << 
h—d
 << "…g_num " << 
poŞ
.
šfo
.
	`g‘_pg_num
() << " hash "

1917 << 
¡d
::
hex
 << 
h—d
.
	`g‘_hash
(è<< std::
dec
 << 
d’dl
;

1918 
osd
->
şog
->
	`w¬n
(è<< 
šfo
.
pgid
.pgid << " dÛ nÙ cÚš " << 
h—d


1919 << " o°" << *
m
;

1920 
	`as£¹
(!
cù
->
_cÚf
->
osd_debug_misdœeùed_İs
);

1924 
boŞ
 
ÿn_backoff
 =

1925 
m
->
	`g‘_cÚÃùiÚ
()->
	`has_ã©u»
(
CEPH_FEATURE_RADOS_BACKOFF
);

1926 
SessiÚRef
 
£ssiÚ
;

1927 ià(
ÿn_backoff
) {

1928 
£ssiÚ
 = 
¡©ic_ÿ¡
<
SessiÚ
*>(
m
->
	`g‘_cÚÃùiÚ
()->
	`g‘_´iv
());

1929 ià(!
£ssiÚ
.
	`g‘
()) {

1930 
	`dout
(10è<< 
__func__
 << "‚Ø£ssiÚ" << 
d’dl
;

1933 
£ssiÚ
->
	`put
();

1935 ià(
£ssiÚ
->
	`check_backoff
(
cù
, 
šfo
.
pgid
, 
h—d
, 
m
)) {

1940 ià(
m
->
	`has_æag
(
CEPH_OSD_FLAG_PARALLELEXEC
)) {

1942 
	`dout
(20è<< 
__func__
 << ": PARALLELEXEC‚Ù im¶em’‹d " << *
m
 << 
d’dl
;

1943 
osd
->
	`»¶y_İ_”rÜ
(
İ
, -
EINVAL
);

1947 ià(
İ
->
rmw_æags
 == 0) {

1948 
r
 = 
osd
->osd->
	`š™_İ_æags
(
İ
);

1949 ià(
r
) {

1950 
osd
->
	`»¶y_İ_”rÜ
(
İ
, 
r
);

1955 ià((
m
->
	`g‘_æags
(è& (
CEPH_OSD_FLAG_BALANCE_READS
 |

1956 
CEPH_OSD_FLAG_LOCALIZE_READS
)) &&

1957 
İ
->
	`may_»ad
() &&

1958 !(
İ
->
	`may_wr™e
(è|| op->
	`may_ÿche
())) {

1960 ià(!(
	`is_´im¬y
(è|| 
	`is_»¶iÿ
())) {

1961 
osd
->
	`hªdË_misdœeùed_İ
(
this
, 
İ
);

1966 ià(!
	`is_´im¬y
()) {

1967 
osd
->
	`hªdË_misdœeùed_İ
(
this
, 
İ
);

1972 ià(!
	`İ_has_suffic›Á_ÿps
(
İ
)) {

1973 
osd
->
	`»¶y_İ_”rÜ
(
İ
, -
EPERM
);

1977 ià(
İ
->
	`šşudes_pg_İ
()) {

1978  
	`do_pg_İ
(
İ
);

1982 ià(
m
->
	`g‘_oid
().
Çme
.
	`size
(è> 
cù
->
_cÚf
->
osd_max_objeù_Çme_Ën
) {

1983 
	`dout
(4) << "do_op‚ame is†ongerhan "

1984 << 
cù
->
_cÚf
->
osd_max_objeù_Çme_Ën


1985 << " by‹s" << 
d’dl
;

1986 
osd
->
	`»¶y_İ_”rÜ
(
İ
, -
ENAMETOOLONG
);

1989 ià(
m
->
	`g‘_hobj
().
	`g‘_key
().
	`size
(è> 
cù
->
_cÚf
->
osd_max_objeù_Çme_Ën
) {

1990 
	`dout
(4) << "do_op†ocator is†ongerhan "

1991 << 
cù
->
_cÚf
->
osd_max_objeù_Çme_Ën


1992 << " by‹s" << 
d’dl
;

1993 
osd
->
	`»¶y_İ_”rÜ
(
İ
, -
ENAMETOOLONG
);

1996 ià(
m
->
	`g‘_hobj
().
n¥aû
.
	`size
(è> 
cù
->
_cÚf
->
osd_max_objeù_Çme¥aû_Ën
) {

1997 
	`dout
(4) << "do_op‚amespace is†ongerhan "

1998 << 
cù
->
_cÚf
->
osd_max_objeù_Çme¥aû_Ën


1999 << " by‹s" << 
d’dl
;

2000 
osd
->
	`»¶y_İ_”rÜ
(
İ
, -
ENAMETOOLONG
);

2004 ià(
r
 = 
osd
->
¡Üe
->
	`v®id©e_hobjeù_key
(
h—d
)) {

2005 
	`dout
(4è<< "do_İ objeù " << 
h—d
 << " invalid for backing store: "

2006 << 
r
 << 
d’dl
;

2007 
osd
->
	`»¶y_İ_”rÜ
(
İ
, 
r
);

2012 ià(
	`g‘_osdm­
()->
	`is_bÏckli¡ed
(
m
->
	`g‘_sourû_addr
())) {

2013 
	`dout
(10è<< "do_İ " << 
m
->
	`g‘_sourû_addr
(è<< " i bÏckli¡ed" << 
d’dl
;

2014 
osd
->
	`»¶y_İ_”rÜ
(
İ
, -
EBLACKLISTED
);

2019 
boŞ
 
wr™e_Üd”ed
 = 
İ
->
	`rwÜd”ed
();

2029 ià(
wr™e_Üd”ed
 && !(
m
->
	`g‘_sourû
().
	`is_mds
() ||

2030 
m
->
	`has_æag
(
CEPH_OSD_FLAG_FULL_TRY
) ||

2031 
m
->
	`has_æag
(
CEPH_OSD_FLAG_FULL_FORCE
)) &&

2032 
šfo
.
hi¡Üy
.
Ï¡_•och_m¬ked_fuÎ
 > 
m
->
	`g‘_m­_•och
()) {

2033 
	`dout
(10è<< 
__func__
 << " disÿrdšg o°£Á befÜfuÎ " << 
m
 << " "

2034 << *
m
 << 
d’dl
;

2040 ià(
wr™e_Üd”ed
 && 
osd
->
	`check_ç§ã_fuÎ
(
	`g‘_dµ
()) &&

2041 !
m
->
	`has_æag
(
CEPH_OSD_FLAG_FULL_TRY
)) {

2042 
	`dout
(10è<< 
__func__
 << " fa-§ã fuÎ check faed, drİpšg„eque¡." << 
d’dl
;

2045 
št64_t
 
poŞid
 = 
	`g‘_pgid
().
	`poŞ
();

2046 ià(
İ
->
	`may_wr™e
()) {

2048 cÚ¡ 
pg_poŞ_t
 *
pi
 = 
	`g‘_osdm­
()->
	`g‘_pg_poŞ
(
poŞid
);

2049 ià(!
pi
) {

2054 ià(
m
->
	`g‘_¢­id
(è!ğ
CEPH_NOSNAP
) {

2055 
	`dout
(20è<< 
__func__
 << ": wr™tØşÚnÙ v®id " << *
m
 << 
d’dl
;

2056 
osd
->
	`»¶y_İ_”rÜ
(
İ
, -
EINVAL
);

2061 ià(
cù
->
_cÚf
->
osd_max_wr™e_size
 &&

2062 
m
->
	`g‘_d©a_Ën
(è> 
cù
->
_cÚf
->
osd_max_wr™e_size
 << 20) {

2064 
d”r
 << "do_İ msg d©¨ËÀ" << 
m
->
	`g‘_d©a_Ën
()

2065 << " > osd_max_wr™e_siz" << (
cù
->
_cÚf
->
osd_max_wr™e_size
 << 20)

2066 << " oÀ" << *
m
 << 
d’dl
;

2067 
osd
->
	`»¶y_İ_”rÜ
(
İ
, -
OSD_WRITETOOBIG
);

2072 
	`dout
(10è<< "do_İ " << *
m


2073 << (
İ
->
	`may_wr™e
() ? " may_write" : "")

2074 << (
İ
->
	`may_»ad
() ? " may_read" : "")

2075 << (
İ
->
	`may_ÿche
() ? " may_cache" : "")

2076 << " -> " << (
wr™e_Üd”ed
 ? "write-ordered" : "read-ordered")

2077 << " fÏg " << 
	`ûph_osd_æag_¡ršg
(
m
->
	`g‘_æags
())

2078 << 
d’dl
;

2081 ià(
	`is_uÄ—dabË_objeù
(
h—d
)) {

2082 ià(!
	`is_´im¬y
()) {

2083 
osd
->
	`»¶y_İ_”rÜ
(
İ
, -
EAGAIN
);

2086 ià(
ÿn_backoff
 &&

2087 (
g_cÚf
->
osd_backoff_Ú_deg¿ded
 ||

2088 (
g_cÚf
->
osd_backoff_Ú_unfound
 && 
missšg_loc
.
	`is_unfound
(
h—d
)))) {

2089 
	`add_backoff
(
£ssiÚ
, 
h—d
, head);

2090 
	`maybe_kick_»cov”y
(
h—d
);

2092 
	`wa™_fÜ_uÄ—dabË_objeù
(
h—d
, 
İ
);

2098 ià(
wr™e_Üd”ed
 && 
	`is_deg¿ded_Ü_backflšg_objeù
(
h—d
)) {

2099 ià(
ÿn_backoff
 && 
g_cÚf
->
osd_backoff_Ú_deg¿ded
) {

2100 
	`add_backoff
(
£ssiÚ
, 
h—d
, head);

2101 
	`maybe_kick_»cov”y
(
h—d
);

2103 
	`wa™_fÜ_deg¿ded_objeù
(
h—d
, 
İ
);

2108 ià(
wr™e_Üd”ed
 && 
süubb”
.
	`is_chunky_süub_aùive
() &&

2109 
	`wr™e_blocked_by_süub
(
h—d
)) {

2110 
	`dout
(20è<< 
__func__
 << ": wa™šg fÜ süub" << 
d’dl
;

2111 
wa™šg_fÜ_süub
.
	`push_back
(
İ
);

2112 
İ
->
	`m¬k_d–ayed
("waiting for scrub");

2117 
m­
<
hobjeù_t
, 
¢­id_t
>::
™”©Ü
 
blocked_™”
 =

2118 
objeùs_blocked_Ú_deg¿ded_¢­
.
	`fšd
(
h—d
);

2119 ià(
wr™e_Üd”ed
 && 
blocked_™”
 !ğ
objeùs_blocked_Ú_deg¿ded_¢­
.
	`’d
()) {

2120 
hobjeù_t
 
	`to_wa™_Ú
(
h—d
);

2121 
to_wa™_Ú
.
¢­
 = 
blocked_™”
->
£cÚd
;

2122 
	`wa™_fÜ_deg¿ded_objeù
(
to_wa™_Ú
, 
İ
);

2125 
m­
<
hobjeù_t
, 
ObjeùCÚ‹xtRef
>::
™”©Ü
 
blocked_¢­_´omÙe_™”
 =

2126 
objeùs_blocked_Ú_¢­_´omÙiÚ
.
	`fšd
(
h—d
);

2127 ià(
wr™e_Üd”ed
 &&

2128 
blocked_¢­_´omÙe_™”
 !ğ
objeùs_blocked_Ú_¢­_´omÙiÚ
.
	`’d
()) {

2129 
	`wa™_fÜ_blocked_objeù
(

2130 
blocked_¢­_´omÙe_™”
->
£cÚd
->
obs
.
oi
.
soid
,

2131 
İ
);

2134 ià(
wr™e_Üd”ed
 && 
objeùs_blocked_Ú_ÿche_fuÎ
.
	`couÁ
(
h—d
)) {

2135 
	`block_wr™e_Ú_fuÎ_ÿche
(
h—d
, 
İ
);

2140 ià(
İ
->
	`may_wr™e
(è|| op->
	`may_ÿche
()) {

2146 
ev”siÚ_t
 
v”siÚ
;

2147 
v”siÚ_t
 
u£r_v”siÚ
;

2148 
»tuº_code
 = 0;

2149 
boŞ
 
gÙ
 = 
	`check_š_´og»ss_İ
(

2150 
m
->
	`g‘_»qid
(), &
v”siÚ
, &
u£r_v”siÚ
, &
»tuº_code
);

2151 ià(
gÙ
) {

2152 
	`dout
(3è<< 
__func__
 << " du°" << 
m
->
	`g‘_»qid
()

2153 << " v”siÚ " << 
v”siÚ
 << 
d’dl
;

2154 ià(
	`®»ady_com¶‘e
(
v”siÚ
)) {

2155 
osd
->
	`»¶y_İ_”rÜ
(
İ
, 
»tuº_code
, 
v”siÚ
, 
u£r_v”siÚ
);

2157 
	`dout
(10è<< " wa™šg fÜ " << 
v”siÚ
 << "Øcomm™" << 
d’dl
;

2159 
wa™šg_fÜ_Údisk
[
v”siÚ
].
	`push_back
(
	`make_·œ
(
İ
, 
u£r_v”siÚ
));

2160 
İ
->
	`m¬k_d–ayed
("waiting for ondisk");

2166 
ObjeùCÚ‹xtRef
 
obc
;

2167 
boŞ
 
ÿn_ü—‹
 = 
İ
->
	`may_wr™e
();

2168 
hobjeù_t
 
missšg_oid
;

2171 
hobjeù_t
 
_oid_h—d
;

2172 ià(
m
->
	`g‘_¢­id
(è=ğ
CEPH_SNAPDIR
) {

2173 
_oid_h—d
 = 
m
->
	`g‘_hobj
().
	`g‘_h—d
();

2175 cÚ¡ 
hobjeù_t
& 
oid
 =

2176 
m
->
	`g‘_¢­id
(è=ğ
CEPH_SNAPDIR
 ? 
_oid_h—d
 : m->
	`g‘_hobj
();

2179 
veùÜ
<
OSDOp
>::
™”©Ü
 
p
 = 
m
->
İs
.
	`begš
();… !ğm->İs.
	`’d
(); ++p) {

2180 
OSDOp
& 
osd_İ
 = *
p
;

2182 ià(
osd_İ
.
İ
.İ =ğ
CEPH_OSD_OP_LIST_SNAPS
) {

2183 ià(
m
->
	`g‘_¢­id
(è!ğ
CEPH_SNAPDIR
) {

2184 
	`dout
(10è<< "LIST_SNAPS w™h incÜ»ù cÚ‹xt" << 
d’dl
;

2185 
osd
->
	`»¶y_İ_”rÜ
(
İ
, -
EINVAL
);

2189 ià(
m
->
	`g‘_¢­id
(è=ğ
CEPH_SNAPDIR
) {

2190 
	`dout
(10è<< "nÚ-LIST_SNAPS oÀ¢­dœ" << 
d’dl
;

2191 
osd
->
	`»¶y_İ_”rÜ
(
İ
, -
EINVAL
);

2198 ià(!
m
->
	`has_æag
(
CEPH_OSD_FLAG_FLUSH
) &&

2199 
	`maybe_awa™_blocked_h—d
(
oid
, 
İ
)) {

2203 
r
 = 
	`fšd_objeù_cÚ‹xt
(

2204 
oid
, &
obc
, 
ÿn_ü—‹
,

2205 
m
->
	`has_æag
(
CEPH_OSD_FLAG_MAP_SNAP_CLONE
),

2206 &
missšg_oid
);

2209 ià(
obc
 &&

2210 
m
->
	`g‘_¢­id
(è=ğ
CEPH_SNAPDIR
 &&

2211 !
obc
->
ssc
) {

2212 
obc
->
ssc
 = 
	`g‘_¢­£t_cÚ‹xt
(
oid
, 
Œue
);

2215 ià(
r
 =ğ-
EAGAIN
) {

2218 ià(
	`is_´im¬y
()) {

2220 
	`as£¹
(!
İ
->
	`may_wr™e
());

2221 
	`wa™_fÜ_uÄ—dabË_objeù
(
missšg_oid
, 
İ
);

2224 } ià(
r
 == 0) {

2225 ià(
	`is_uÄ—dabË_objeù
(
obc
->
obs
.
oi
.
soid
)) {

2226 
	`dout
(10è<< 
__func__
 << ": clÚ" << 
obc
->
obs
.
oi
.
soid


2227 << " i uÄ—dabË, wa™šg" << 
d’dl
;

2228 
	`wa™_fÜ_uÄ—dabË_objeù
(
obc
->
obs
.
oi
.
soid
, 
İ
);

2233 ià(
wr™e_Üd”ed
 &&

2234 
obc
->
obs
.
oi
.
soid
.
¢­
 !ğ
CEPH_NOSNAP
 &&

2235 
	`is_deg¿ded_Ü_backflšg_objeù
(
obc
->
obs
.
oi
.
soid
)) {

2236 
	`dout
(10è<< 
__func__
 << ": clÚ" << 
obc
->
obs
.
oi
.
soid


2237 << " i deg¿ded, wa™šg" << 
d’dl
;

2238 
	`wa™_fÜ_deg¿ded_objeù
(
obc
->
obs
.
oi
.
soid
, 
İ
);

2243 
boŞ
 
š_h™_£t
 = 
çl£
;

2244 ià(
h™_£t
) {

2245 ià(
obc
.
	`g‘
()) {

2246 ià(
obc
->
obs
.
oi
.
soid
 !ğ
	`hobjeù_t
(è&& 
h™_£t
->
	`cÚšs
(obc->obs.oi.soid))

2247 
š_h™_£t
 = 
Œue
;

2249 ià(
missšg_oid
 !ğ
	`hobjeù_t
(è&& 
h™_£t
->
	`cÚšs
(missing_oid))

2250 
š_h™_£t
 = 
Œue
;

2252 ià(!
İ
->
h™£t_š£¹ed
) {

2253 
h™_£t
->
	`š£¹
(
oid
);

2254 
İ
->
h™£t_š£¹ed
 = 
Œue
;

2255 ià(
h™_£t
->
	`is_fuÎ
() ||

2256 
h™_£t_¡¬t_¡amp
 + 
poŞ
.
šfo
.
h™_£t_³riod
 <ğ
m
->
	`g‘_»cv_¡amp
()) {

2257 
	`h™_£t_³rsi¡
();

2262 ià(
ag’t_¡©e
) {

2263 ià(
	`ag’t_choo£_mode
(
çl£
, 
İ
))

2267 ià(
obc
.
	`g‘
(è&& obc->
obs
.
exi¡s
 && obc->obs.
oi
.
	`has_mªiã¡
()) {

2268 ià(
	`maybe_hªdË_mªiã¡
(
İ
,

2269 
wr™e_Üd”ed
,

2270 
obc
))

2274 ià(
	`maybe_hªdË_ÿche
(
İ
,

2275 
wr™e_Üd”ed
,

2276 
obc
,

2277 
r
,

2278 
missšg_oid
,

2279 
çl£
,

2280 
š_h™_£t
))

2283 ià(
r
 && (¸!ğ-
ENOENT
 || !
obc
)) {

2285 ià(
r
 =ğ-
ENOENT
 &&

2286 (
m
->
İs
[0].
İ
.İ =ğ
CEPH_OSD_OP_COPY_GET
)) {

2287 
	`fl_š_cİy_g‘_nÛÁ
(
İ
, 
oid
, 
m
->
İs
[0]);

2290 
	`dout
(20è<< 
__func__
 << ": fšd_objeù_cÚ‹xˆgÙƒ¼Ü " << 
r
 << 
d’dl
;

2291 ià(
İ
->
	`may_wr™e
() &&

2292 
	`g‘_osdm­
()->
»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_KRAKEN
) {

2293 
	`»cÜd_wr™e_”rÜ
(
İ
, 
oid
, 
nuÎ±r
, 
r
);

2295 
osd
->
	`»¶y_İ_”rÜ
(
İ
, 
r
);

2301 
objeù_loÿtÜ_t
 
	`Şoc
(
obc
->
obs
.
oi
.
soid
);

2302 ià(
m
->
	`g‘_objeù_loÿtÜ
(è!ğ
Şoc
) {

2303 
	`dout
(10è<< "…rovided†oÿtÜ " << 
m
->
	`g‘_objeù_loÿtÜ
()

2304 << " !ğobjeù' " << 
obc
->
obs
.
oi
.
soid
 << 
d’dl
;

2305 
osd
->
şog
->
	`w¬n
(è<< "bad†oÿtÜ " << 
m
->
	`g‘_objeù_loÿtÜ
()

2306 << " oÀobjeù " << 
Şoc


2307 << " o°" << *
m
;

2311 ià(
obc
->
	`is_blocked
() &&

2312 !
m
->
	`has_æag
(
CEPH_OSD_FLAG_FLUSH
)) {

2313 
	`wa™_fÜ_blocked_objeù
(
obc
->
obs
.
oi
.
soid
, 
İ
);

2317 
	`dout
(25è<< 
__func__
 << " o˜" << 
obc
->
obs
.
oi
 << 
d’dl
;

2319 
OpCÚ‹xt
 *
ùx
 = 
Ãw
 
	`OpCÚ‹xt
(
İ
, 
m
->
	`g‘_»qid
(), &m->
İs
, 
obc
, 
this
);

2321 ià(
m
->
	`has_æag
(
CEPH_OSD_FLAG_SKIPRWLOCKS
)) {

2322 
	`dout
(20è<< 
__func__
 << ": skpšg„w†ocks" << 
d’dl
;

2323 } ià(
m
->
	`g‘_æags
(è& 
CEPH_OSD_FLAG_FLUSH
) {

2324 
	`dout
(20è<< 
__func__
 << ":…¬ˆoàæush, wÈignÜwr™lock" << 
d’dl
;

2328 
m­
<
hobjeù_t
,
FlushOpRef
>::
™”©Ü
 
p
 = 
æush_İs
.
	`fšd
(
obc
->
obs
.
oi
.
soid
);

2329 ià(
p
 =ğ
æush_İs
.
	`’d
()) {

2330 
	`dout
(10è<< 
__func__
 << "‚Øæush iÀ´og»ss,‡bÜtšg" << 
d’dl
;

2331 
	`»¶y_ùx
(
ùx
, -
EINVAL
);

2334 } ià(!
	`g‘_rw_locks
(
wr™e_Üd”ed
, 
ùx
)) {

2335 
	`dout
(20è<< 
__func__
 << " wa™šg fÜ„w†ock " << 
d’dl
;

2336 
İ
->
	`m¬k_d–ayed
("waiting for„w†ocks");

2337 
	`şo£_İ_ùx
(
ùx
);

2340 
	`dout
(20è<< 
__func__
 << " obø" << *
obc
 << 
d’dl
;

2342 ià(
r
) {

2343 
	`dout
(20è<< 
__func__
 << "„‘uºed‡À”rÜ: " << 
r
 << 
d’dl
;

2344 
	`şo£_İ_ùx
(
ùx
);

2345 ià(
İ
->
	`may_wr™e
() &&

2346 
	`g‘_osdm­
()->
»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_KRAKEN
) {

2347 
	`»cÜd_wr™e_”rÜ
(
İ
, 
oid
, 
nuÎ±r
, 
r
);

2349 
osd
->
	`»¶y_İ_”rÜ
(
İ
, 
r
);

2354 ià(
m
->
	`has_æag
(
CEPH_OSD_FLAG_IGNORE_CACHE
)) {

2355 
ùx
->
ignÜe_ÿche
 = 
Œue
;

2358 ià((
İ
->
	`may_»ad
()è&& (
obc
->
obs
.
oi
.
	`is_lo¡
())) {

2360 
	`dout
(20è<< 
__func__
 << ": objeù " << 
obc
->
obs
.
oi
.
soid


2361 << " i lo¡" << 
d’dl
;

2362 
	`»¶y_ùx
(
ùx
, -
ENFILE
);

2365 ià(!
İ
->
	`may_wr™e
() &&

2366 !
İ
->
	`may_ÿche
() &&

2367 (!
obc
->
obs
.
exi¡s
 ||

2368 ((
m
->
	`g‘_¢­id
(è!ğ
CEPH_SNAPDIR
) &&

2369 
obc
->
obs
.
oi
.
	`is_wh™eout
()))) {

2371 ià(
m
->
İs
[0].
İ
.İ =ğ
CEPH_OSD_OP_COPY_GET
) {

2372 
	`fl_š_cİy_g‘_nÛÁ
(
İ
, 
oid
, 
m
->
İs
[0]);

2373 
	`şo£_İ_ùx
(
ùx
);

2376 
	`»¶y_ùx
(
ùx
, -
ENOENT
);

2380 
İ
->
	`m¬k_¡¬‹d
();

2382 
	`execu‹_ùx
(
ùx
);

2383 
utime_t
 
´•¬e_Ï‹ncy
 = 
	`ûph_şock_now
();

2384 
´•¬e_Ï‹ncy
 -ğ
İ
->
	`g‘_dequeued_time
();

2385 
osd
->
logg”
->
	`tšc
(
l_osd_İ_´•¬e_Ït
, 
´•¬e_Ï‹ncy
);

2386 ià(
İ
->
	`may_»ad
(è&& op->
	`may_wr™e
()) {

2387 
osd
->
logg”
->
	`tšc
(
l_osd_İ_rw_´•¬e_Ït
, 
´•¬e_Ï‹ncy
);

2388 } ià(
İ
->
	`may_»ad
()) {

2389 
osd
->
logg”
->
	`tšc
(
l_osd_İ_r_´•¬e_Ït
, 
´•¬e_Ï‹ncy
);

2390 } ià(
İ
->
	`may_wr™e
(è|| op->
	`may_ÿche
()) {

2391 
osd
->
logg”
->
	`tšc
(
l_osd_İ_w_´•¬e_Ït
, 
´•¬e_Ï‹ncy
);

2395 
	`maybe_fÜû_»cov”y
();

2396 
	}
}

2398 
	gPrim¬yLogPG
::
ÿche_»suÉ_t
 
Prim¬yLogPG
::
	$maybe_hªdË_mªiã¡_d‘a
(

2399 
OpReque¡Ref
 
İ
,

2400 
boŞ
 
wr™e_Üd”ed
,

2401 
ObjeùCÚ‹xtRef
 
obc
)

2403 
	`as£¹
(
obc
);

2404 ià(
¡©ic_ÿ¡
<cÚ¡ 
MOSDOp
 *>(
İ
->
	`g‘_»q
())->
	`g‘_æags
() &

2405 
CEPH_OSD_FLAG_IGNORE_REDIRECT
) {

2406 
	`dout
(20è<< 
__func__
 << ": ignÜšg„edœeù dutØæag" << 
d’dl
;

2407  
ÿche_»suÉ_t
::
NOOP
;

2411 ià(
obc
->
	`is_blocked
(è&& 
wr™e_Üd”ed
) {

2413 
	`dout
(20è<< 
__func__
 << " blocked oÀ" << 
obc
->
obs
.
oi
.
soid
 << 
d’dl
;

2414  
ÿche_»suÉ_t
::
NOOP
;

2417 
veùÜ
<
OSDOp
> 
İs
 = 
¡©ic_ÿ¡
<cÚ¡ 
MOSDOp
*>(
İ
->
	`g‘_»q
())->ops;

2418 
veùÜ
<
OSDOp
>::
™”©Ü
 
p
 = 
İs
.
	`begš
();… !ğİs.
	`’d
(); ++p) {

2419 
OSDOp
& 
osd_İ
 = *
p
;

2420 
ûph_osd_İ
& 
İ
 = 
osd_İ
.op;

2421 ià(
İ
.İ =ğ
CEPH_OSD_OP_SET_REDIRECT
 ||

2422 
İ
.İ =ğ
CEPH_OSD_OP_SET_CHUNK
 ||

2423 
İ
.İ =ğ
CEPH_OSD_OP_TIER_PROMOTE
) {

2424  
ÿche_»suÉ_t
::
NOOP
;

2428 
obc
->
obs
.
oi
.
mªiã¡
.
ty³
) {

2429 
objeù_mªiã¡_t
::
TYPE_REDIRECT
:

2430 ià(
İ
->
	`may_wr™e
(è|| 
wr™e_Üd”ed
) {

2431 
	`do_´oxy_wr™e
(
İ
, 
obc
);

2434 ià(
obc
->
obs
.
oi
.
size
 != 0) {

2435  
ÿche_»suÉ_t
::
NOOP
;

2437 
	`do_´oxy_»ad
(
İ
, 
obc
);

2439  
ÿche_»suÉ_t
::
HANDLED_PROXY
;

2440 
objeù_mªiã¡_t
::
TYPE_CHUNKED
:

2442 ià(
	`ÿn_´oxy_chunked_»ad
(
İ
, 
obc
)) {

2443 
m­
<
hobjeù_t
,
FlushOpRef
>::
™”©Ü
 
p
 = 
æush_İs
.
	`fšd
(
obc
->
obs
.
oi
.
soid
);

2444 ià(
p
 !ğ
æush_İs
.
	`’d
()) {

2445 
	`do_´oxy_chunked_İ
(
İ
, 
obc
->
obs
.
oi
.
soid
, obc, 
Œue
);

2446  
ÿche_»suÉ_t
::
HANDLED_PROXY
;

2448 
	`do_´oxy_chunked_İ
(
İ
, 
obc
->
obs
.
oi
.
soid
, obc, 
wr™e_Üd”ed
);

2449  
ÿche_»suÉ_t
::
HANDLED_PROXY
;

2452 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<MOSDOp*>(
İ
->
	`g‘_nÚcÚ¡_»q
());

2453 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
CEPH_MSG_OSD_OP
);

2454 
hobjeù_t
 
h—d
 = 
m
->
	`g‘_hobj
();

2456 ià(
	`is_deg¿ded_Ü_backflšg_objeù
(
h—d
)) {

2457 
	`dout
(20è<< 
__func__
 << ": " << 
h—d
 << " i deg¿ded, wa™šg" << 
d’dl
;

2458 
	`wa™_fÜ_deg¿ded_objeù
(
h—d
, 
İ
);

2459  
ÿche_»suÉ_t
::
BLOCKED_RECOVERY
;

2462 ià(
	`wr™e_blocked_by_süub
(
h—d
)) {

2463 
	`dout
(20è<< 
__func__
 << ": wa™šg fÜ süub" << 
d’dl
;

2464 
wa™šg_fÜ_süub
.
	`push_back
(
İ
);

2465 
İ
->
	`m¬k_d–ayed
("waiting for scrub");

2466  
ÿche_»suÉ_t
::
BLOCKED_RECOVERY
;

2469 auto& 
p
 : 
obc
->
obs
.
oi
.
mªiã¡
.
chunk_m­
) {

2470 ià(
p
.
£cÚd
.
æags
 =ğ
chunk_šfo_t
::
FLAG_MISSING
) {

2471 cÚ¡ 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDOp*>(
İ
->
	`g‘_»q
());

2472 cÚ¡ 
objeù_loÿtÜ_t
 
Şoc
 = 
m
->
	`g‘_objeù_loÿtÜ
();

2473 
	`´omÙe_objeù
(
obc
, obc->
obs
.
oi
.
soid
, 
Şoc
, 
İ
, 
NULL
);

2474  
ÿche_»suÉ_t
::
BLOCKED_PROMOTE
;

2478 
boŞ
 
®l_dœty
 = 
Œue
;

2479 auto& 
p
 : 
obc
->
obs
.
oi
.
mªiã¡
.
chunk_m­
) {

2480 ià(
p
.
£cÚd
.
æags
 !ğ
chunk_šfo_t
::
FLAG_DIRTY
) {

2481 
®l_dœty
 = 
çl£
;

2484 ià(
®l_dœty
) {

2485 
	`¡¬t_æush
(
	`OpReque¡Ref
(), 
obc
, 
Œue
, 
NULL
, 
boo¡
::
nÚe
);

2487  
ÿche_»suÉ_t
::
NOOP
;

2490 
	`as£¹
(0 == "unrecognized manifestype");

2493  
ÿche_»suÉ_t
::
NOOP
;

2494 
	}
}

2496 
	gC_Mªiã¡Flush
 : 
public
 
CÚ‹xt
 {

2497 
Prim¬yLogPGRef
 
pg
;

2498 
hobjeù_t
 
	goid
;

2499 
•och_t
 
	gÏ¡_³”šg_»£t
;

2500 
ûph_tid_t
 
	gtid
;

2501 
utime_t
 
	g¡¬t
;

2502 
ušt64_t
 
	goff£t
;

2503 
ušt64_t
 
	gÏ¡_off£t
;

2504 
C_Mªiã¡Flush
(
Prim¬yLogPG
 *
p
, 
hobjeù_t
 
o
, 
•och_t
 
Ír
)

2505 : 
pg
(
p
), 
oid
(
o
), 
Ï¡_³”šg_»£t
(
Ír
),

2506 
tid
(0), 
¡¬t
(
ûph_şock_now
())

2508 
fšish
(
r
è
	gov”ride
 {

2509 ià(
	gr
 =ğ-
ECANCELED
)

2511 
	gpg
->
lock
();

2512 
	gpg
->
hªdË_mªiã¡_æush
(
oid
, 
tid
, 
r
, 
off£t
, 
Ï¡_off£t
);

2513 
	gpg
->
	gosd
->
	glogg”
->
tšc
(
l_osd_t›r_æush_Ït
, 
ûph_şock_now
(è- 
¡¬t
);

2514 
	gpg
->
uÆock
();

2518 
	gPrim¬yLogPG
::
	$hªdË_mªiã¡_æush
(
hobjeù_t
 
oid
, 
ûph_tid_t
 
tid
, 
r
,

2519 
ušt64_t
 
off£t
, ušt64_ˆ
Ï¡_off£t
)

2521 
m­
<
hobjeù_t
,
FlushOpRef
>::
™”©Ü
 
p
 = 
æush_İs
.
	`fšd
(
oid
);

2522 ià(
p
 =ğ
æush_İs
.
	`’d
()) {

2523 
	`dout
(10è<< 
__func__
 << "‚Øæush_İ found" << 
d’dl
;

2526 ià(
p
->
£cÚd
->
rv®
 < 0) {

2529 
p
->
£cÚd
->
io_»suÉs
[
off£t
] = 
r
;

2530 autØ&
iÜ
: 
p
->
£cÚd
->
io_»suÉs
) {

2531 ià(
iÜ
.
£cÚd
 < 0) {

2532 
	`fšish_mªiã¡_æush
(
oid
, 
tid
, 
r
, 
p
->
£cÚd
->
obc
, 
Ï¡_off£t
);

2533 
p
->
£cÚd
->
rv®
 = 
r
;

2537 ià(
p
->
£cÚd
->
chunks
 =ğp->£cÚd->
io_»suÉs
.
	`size
()) {

2538 ià(
Ï¡_³”šg_»£t
 =ğ
	`g‘_Ï¡_³”šg_»£t
()) {

2539 
	`as£¹
(
p
->
£cÚd
->
obc
);

2540 
	`fšish_mªiã¡_æush
(
oid
, 
tid
, 
r
, 
p
->
£cÚd
->
obc
, 
Ï¡_off£t
);

2543 
	}
}

2545 
	gPrim¬yLogPG
::
¡¬t_mªiã¡_æush
(
OpReque¡Ref
 
İ
, 
ObjeùCÚ‹xtRef
 
obc
, 
boŞ
 
blockšg
,

2546 
boo¡
::
İtiÚ®
<
¡d
::
funùiÚ
<()>> &&
Ú_æush
)

2548 autØ
p
 = 
obc
->
obs
.
oi
.
mªiã¡
.
chunk_m­
.
begš
();

2549 
FlushOpRef
 
mªiã¡_fİ
(
¡d
::
make_sh¬ed
<
FlushOp
>());

2550 
	gmªiã¡_fİ
->
	gİ
 = 
İ
;

2551 
	gmªiã¡_fİ
->
	gobc
 = 
obc
;

2552 
	gmªiã¡_fİ
->
	gæushed_v”siÚ
 = 
obc
->
obs
.
oi
.
u£r_v”siÚ
;

2553 
	gmªiã¡_fİ
->
	gblockšg
 = 
blockšg
;

2554 
	gmªiã¡_fİ
->
	gÚ_æush
 = 
¡d
::
move
(
Ú_æush
);

2555 
	gr
 = 
do_mªiã¡_æush
(
İ
, 
obc
, 
mªiã¡_fİ
, 
p
->
fœ¡
, 
blockšg
);

2556 ià(
	gr
 < 0) {

2557  
	gr
;

2560 
	gæush_İs
[
obc
->
obs
.
oi
.
soid
] = 
mªiã¡_fİ
;

2561  -
	gEINPROGRESS
;

2564 
	gPrim¬yLogPG
::
	$do_mªiã¡_æush
(
OpReque¡Ref
 
İ
, 
ObjeùCÚ‹xtRef
 
obc
, 
FlushOpRef
 
mªiã¡_fİ
,

2565 
ušt64_t
 
¡¬t_off£t
, 
boŞ
 
block
)

2567 
objeù_mªiã¡_t
 &
mªiã¡
 = 
obc
->
obs
.
oi
.manifest;

2568 
hobjeù_t
 
soid
 = 
obc
->
obs
.
oi
.soid;

2569 
ûph_tid_t
 
tid
;

2570 
SÇpCÚ‹xt
 
¢­c
;

2571 
ušt64_t
 
max_cİy_size
 = 0, 
Ï¡_off£t
 = 0;

2573 
m­
<
ušt64_t
, 
chunk_šfo_t
>::
™”©Ü
 
™”
 = 
mªiã¡
.
chunk_m­
.
	`fšd
(
¡¬t_off£t
);

2574 
	`as£¹
(
™”
 !ğ
mªiã¡
.
chunk_m­
.
	`’d
());

2575 ;
™”
 !ğ
mªiã¡
.
chunk_m­
.
	`’d
(); ++iter) {

2576 ià(
™”
->
£cÚd
.
æags
 =ğ
chunk_šfo_t
::
FLAG_DIRTY
) {

2577 
Ï¡_off£t
 = 
™”
->
fœ¡
;

2578 
max_cİy_size
 +ğ
™”
->
£cÚd
.
Ëngth
;

2580 ià(
	`g‘_cİy_chunk_size
(è< 
max_cİy_size
) {

2585 
™”
 = 
mªiã¡
.
chunk_m­
.
	`fšd
(
¡¬t_off£t
);

2586 ;
™”
 !ğ
mªiã¡
.
chunk_m­
.
	`’d
(); ++iter) {

2587 ià(
™”
->
£cÚd
.
æags
 !ğ
chunk_šfo_t
::
FLAG_DIRTY
) {

2590 
ušt64_t
 
tgt_Ëngth
 = 
™”
->
£cÚd
.
Ëngth
;

2591 
ušt64_t
 
tgt_off£t
ğ
™”
->
£cÚd
.
off£t
;

2592 
hobjeù_t
 
tgt_soid
 = 
™”
->
£cÚd
.
oid
;

2593 
objeù_loÿtÜ_t
 
	`Şoc
(
tgt_soid
);

2594 
ObjeùO³¿tiÚ
 
obj_İ
;

2595 
bufã¾i¡
 
chunk_d©a
;

2596 
r
 = 
pgback’d
->
	`objeùs_»ad_sync
(

2597 
soid
, 
™”
->
fœ¡
, 
tgt_Ëngth
, 0, &
chunk_d©a
);

2598 ià(
r
 < 0) {

2599 
	`dout
(0è<< 
__func__
 << "„—d fa " << " off£t: " << 
tgt_off£t


2600 << "†’: " << 
tgt_Ëngth
 << "„: " << 
r
 << 
d’dl
;

2601  
r
;

2603 ià(!
chunk_d©a
.
	`Ëngth
()) {

2604  -
ENODATA
;

2606 
tgt_Ëngth
 = 
chunk_d©a
.
	`Ëngth
();

2607 
obj_İ
.
	`add_d©a
(
CEPH_OSD_OP_WRITE
, 
tgt_off£t
, 
tgt_Ëngth
, 
chunk_d©a
);

2609 
æags
 = 
CEPH_OSD_FLAG_IGNORE_CACHE
 | 
CEPH_OSD_FLAG_IGNORE_OVERLAY
 |

2610 
CEPH_OSD_FLAG_RWORDERED
 ;

2611 
C_Mªiã¡Flush
 *
fš
 = 
Ãw
 
	`C_Mªiã¡Flush
(
this
, 
soid
, 
	`g‘_Ï¡_³”šg_»£t
());

2612 
fš
->
off£t
 = 
™”
->
fœ¡
;

2613 
fš
->
Ï¡_off£t
 =†ast_offset;

2614 
mªiã¡_fİ
->
chunks
++;

2616 
n
 = 
šfo
.
pgid
.
	`hash_to_sh¬d
(
osd
->
m_objeù”_fšish”s
);

2617 
tid
 = 
osd
->
objeù”
->
	`mu‹
(

2618 
tgt_soid
.
oid
, 
Şoc
, 
obj_İ
, 
¢­c
,

2619 
ûph
::
»®_şock
::
	`äom_ûph_time¥ec
(
obc
->
obs
.
oi
.
mtime
),

2620 
æags
, 
Ãw
 
	`C_OnFšish”
(
fš
, 
osd
->
objeù”_fšish”s
[
n
]));

2621 
fš
->
tid
 =id;

2622 
mªiã¡_fİ
->
io_tids
[
™”
->
fœ¡
] = 
tid
;

2624 
	`dout
(20è<< 
__func__
 << " off£t: " << 
tgt_off£t
 << "†’: " << 
tgt_Ëngth


2625 << " oid: " << 
tgt_soid
.
oid
 << " or˜oid: " << 
soid
.oid.
Çme


2626 << "id: " << 
tid
 << 
d’dl
;

2627 ià(
Ï¡_off£t
 < 
™”
->
fœ¡
) {

2633 
	}
}

2635 
	gPrim¬yLogPG
::
	$fšish_mªiã¡_æush
(
hobjeù_t
 
oid
, 
ûph_tid_t
 
tid
, 
r
,

2636 
ObjeùCÚ‹xtRef
 
obc
, 
ušt64_t
 
Ï¡_off£t
)

2638 
	`dout
(10è<< 
__func__
 << " " << 
oid
 << "id " << 
tid


2639 << " " << 
	`ıp_¡»¼Ü
(
r
è<< "†a¡_off£t: " << 
Ï¡_off£t
 << 
d’dl
;

2640 
m­
<
hobjeù_t
,
FlushOpRef
>::
™”©Ü
 
p
 = 
æush_İs
.
	`fšd
(
oid
);

2641 ià(
p
 =ğ
æush_İs
.
	`’d
()) {

2642 
	`dout
(10è<< 
__func__
 << "‚Øæush_İ found" << 
d’dl
;

2645 
m­
<
ušt64_t
, 
chunk_šfo_t
>::
™”©Ü
 
™”
 =

2646 
obc
->
obs
.
oi
.
mªiã¡
.
chunk_m­
.
	`fšd
(
Ï¡_off£t
);

2647 
	`as£¹
(
™”
 !ğ
obc
->
obs
.
oi
.
mªiã¡
.
chunk_m­
.
	`’d
());

2648 ;
™”
 !ğ
obc
->
obs
.
oi
.
mªiã¡
.
chunk_m­
.
	`’d
(); ++iter) {

2649 ià(
™”
->
£cÚd
.
æags
 =ğ
chunk_šfo_t
::
FLAG_DIRTY
 && 
Ï¡_off£t
 < i‹r->
fœ¡
) {

2650 
	`do_mªiã¡_æush
(
p
->
£cÚd
->
İ
, 
obc
,…->£cÚd, 
™”
->
fœ¡
,…->£cÚd->
blockšg
);

2654 
	`fšish_æush
(
oid
, 
tid
, 
r
);

2655 
	}
}

2657 
	gPrim¬yLogPG
::
	$»cÜd_wr™e_”rÜ
(
OpReque¡Ref
 
İ
, cÚ¡ 
hobjeù_t
 &
soid
,

2658 
MOSDOpR•ly
 *
Üig_»¶y
, 
r
)

2660 
	`dout
(20è<< 
__func__
 << "„=" << 
r
 << 
d’dl
;

2661 
	`as£¹
(
İ
->
	`may_wr™e
());

2662 cÚ¡ 
osd_»qid_t
 &
»qid
 = 
¡©ic_ÿ¡
<cÚ¡ 
MOSDOp
*>(
İ
->
	`g‘_»q
())->
	`g‘_»qid
();

2663 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> 
’Œ›s
;

2664 
’Œ›s
.
	`push_back
(
	`pg_log_’Œy_t
(
pg_log_’Œy_t
::
ERROR
, 
soid
,

2665 
	`g‘_Ãxt_v”siÚ
(), 
	`ev”siÚ_t
(), 0,

2666 
»qid
, 
	`utime_t
(), 
r
));

2668 
	sOnCom¶‘e
 {

2669 
Prim¬yLogPG
 *
pg
;

2670 
OpReque¡Ref
 
İ
;

2671 
boo¡
::
šŒusive_±r
<
MOSDOpR•ly
> 
Üig_»¶y
;

2672 
r
;

2673 
	`OnCom¶‘e
(

2674 
Prim¬yLogPG
 *
pg
,

2675 
OpReque¡Ref
 
İ
,

2676 
MOSDOpR•ly
 *
Üig_»¶y
,

2677 
r
)

2678 : 
	`pg
(
pg
), 
	`İ
(
İ
),

2679 
	`Üig_»¶y
(
Üig_»¶y
, 
çl£
 ), 
	`r
(
r
)

2681 
	`İ”©Ü
()() {

2682 
	`ldµ_dout
(
pg
, 20è<< "fšished " << 
__func__
 << "„=" << 
r
 << 
d’dl
;

2683 cÚ¡ 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDOp*>(
İ
->
	`g‘_»q
());

2684 
æags
 = 
m
->
	`g‘_æags
(è& (
CEPH_OSD_FLAG_ACK
 | 
CEPH_OSD_FLAG_ONDISK
);

2685 
MOSDOpR•ly
 *
»¶y
 = 
Üig_»¶y
.
	`d‘ach
();

2686 ià(
»¶y
 =ğ
nuÎ±r
) {

2687 
»¶y
 = 
Ãw
 
	`MOSDOpR•ly
(
m
, 
r
, 
pg
->
	`g‘_osdm­
()->
	`g‘_•och
(),

2688 
æags
, 
Œue
);

2690 
	`ldµ_dout
(
pg
, 10è<< " s’dšg comm™ oÀ" << *
m
 << " " << 
»¶y
 << 
d’dl
;

2691 
pg
->
osd
->
	`£nd_mes§ge_osd_ş›Á
(
»¶y
, 
m
->
	`g‘_cÚÃùiÚ
());

2695 
ObcLockMªag”
 
lock_mªag”
;

2696 
	`subm™_log_’Œ›s
(

2697 
’Œ›s
,

2698 
¡d
::
	`move
(
lock_mªag”
),

2699 
boo¡
::
İtiÚ®
<
¡d
::
funùiÚ
<()> >(

2700 
	`OnCom¶‘e
(
this
, 
İ
, 
Üig_»¶y
, 
r
)),

2701 
İ
,

2702 
r
);

2703 
	}
}

2705 
	gPrim¬yLogPG
::
ÿche_»suÉ_t
 
Prim¬yLogPG
::
	$maybe_hªdË_ÿche_d‘a
(

2706 
OpReque¡Ref
 
İ
,

2707 
boŞ
 
wr™e_Üd”ed
,

2708 
ObjeùCÚ‹xtRef
 
obc
,

2709 
r
, 
hobjeù_t
 
missšg_oid
,

2710 
boŞ
 
mu¡_´omÙe
,

2711 
boŞ
 
š_h™_£t
,

2712 
ObjeùCÚ‹xtRef
 *
´omÙe_obc
)

2715 ià(
poŞ
.
šfo
.
ÿche_mode
 =ğ
pg_poŞ_t
::
CACHEMODE_NONE
)

2716  
ÿche_»suÉ_t
::
NOOP
;

2718 ià(
İ
 &&

2719 
İ
->
	`g‘_»q
() &&

2720 
İ
->
	`g‘_»q
()->
	`g‘_ty³
(è=ğ
CEPH_MSG_OSD_OP
 &&

2721 (
¡©ic_ÿ¡
<cÚ¡ 
MOSDOp
 *>(
İ
->
	`g‘_»q
())->
	`g‘_æags
() &

2722 
CEPH_OSD_FLAG_IGNORE_CACHE
)) {

2723 
	`dout
(20è<< 
__func__
 << ": ignÜšg cachdutØæag" << 
d’dl
;

2724  
ÿche_»suÉ_t
::
NOOP
;

2727 
mu¡_´omÙe
 = mu¡_´omÙ|| 
İ
->
	`Ãed_´omÙe
();

2729 ià(
obc
)

2730 
	`dout
(25è<< 
__func__
 << " " << 
obc
->
obs
.
oi
 << " "

2731 << (
obc
->
obs
.
exi¡s
 ? "exists" : "DNE")

2732 << " missšg_oid " << 
missšg_oid


2733 << " mu¡_´omÙ" << ()
mu¡_´omÙe


2734 << " in_h™_£ˆ" << ()
š_h™_£t


2735 << 
d’dl
;

2737 
	`dout
(25è<< 
__func__
 << " (no obc)"

2738 << " missšg_oid " << 
missšg_oid


2739 << " mu¡_´omÙ" << ()
mu¡_´omÙe


2740 << " in_h™_£ˆ" << ()
š_h™_£t


2741 << 
d’dl
;

2744 ià(
obc
.
	`g‘
(è&& obc->
	`is_blocked
(è&& 
wr™e_Üd”ed
) {

2746 
	`dout
(20è<< 
__func__
 << " blocked oÀ" << 
obc
->
obs
.
oi
.
soid
 << 
d’dl
;

2747  
ÿche_»suÉ_t
::
NOOP
;

2750 ià(
r
 =ğ-
ENOENT
 && 
missšg_oid
 =ğ
	`hobjeù_t
()) {

2752  
ÿche_»suÉ_t
::
NOOP
;

2755 ià(
obc
.
	`g‘
(è&& obc->
obs
.
exi¡s
) {

2756 
osd
->
logg”
->
	`šc
(
l_osd_İ_ÿche_h™
);

2757  
ÿche_»suÉ_t
::
NOOP
;

2759 ià(!
	`is_´im¬y
()) {

2760 
	`dout
(20è<< 
__func__
 << " cachmiss;‡skh´im¬y" << 
d’dl
;

2761 
osd
->
	`»¶y_İ_”rÜ
(
İ
, -
EAGAIN
);

2762  
ÿche_»suÉ_t
::
REPLIED_WITH_EAGAIN
;

2765 ià(
missšg_oid
 =ğ
	`hobjeù_t
(è&& 
obc
.
	`g‘
()) {

2766 
missšg_oid
 = 
obc
->
obs
.
oi
.
soid
;

2769 cÚ¡ 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDOp*>(
İ
->
	`g‘_»q
());

2770 cÚ¡ 
objeù_loÿtÜ_t
 
Şoc
 = 
m
->
	`g‘_objeù_loÿtÜ
();

2772 ià(
İ
->
	`Ãed_sk_hªdË_ÿche
()) {

2773  
ÿche_»suÉ_t
::
NOOP
;

2776 
OpReque¡Ref
 
´omÙe_İ
;

2778 
poŞ
.
šfo
.
ÿche_mode
) {

2779 
pg_poŞ_t
::
CACHEMODE_WRITEBACK
:

2780 ià(
ag’t_¡©e
 &&

2781 
ag’t_¡©e
->
eviù_mode
 =ğ
T›rAg’tS‹
::
EVICT_MODE_FULL
) {

2782 ià(!
İ
->
	`may_wr™e
(è&& !İ->
	`may_ÿche
() &&

2783 !
wr™e_Üd”ed
 && !
mu¡_´omÙe
) {

2784 
	`dout
(20è<< 
__func__
 << " cachpoŞ fuÎ,…roxyšg„—d" << 
d’dl
;

2785 
	`do_´oxy_»ad
(
İ
);

2786  
ÿche_»suÉ_t
::
HANDLED_PROXY
;

2788 
	`dout
(20è<< 
__func__
 << " cachpoŞ fuÎ, wa™šg" << 
d’dl
;

2789 
	`block_wr™e_Ú_fuÎ_ÿche
(
missšg_oid
, 
İ
);

2790  
ÿche_»suÉ_t
::
BLOCKED_FULL
;

2793 ià(
mu¡_´omÙe
 || (!
h™_£t
 && !
İ
->
	`Ãed_sk_´omÙe
())) {

2794 
	`´omÙe_objeù
(
obc
, 
missšg_oid
, 
Şoc
, 
İ
, 
´omÙe_obc
);

2795  
ÿche_»suÉ_t
::
BLOCKED_PROMOTE
;

2798 ià(
İ
->
	`may_wr™e
(è|| op->
	`may_ÿche
()) {

2799 
	`do_´oxy_wr™e
(
İ
);

2802 ià(!
İ
->
	`Ãed_sk_´omÙe
() &&

2803 
	`maybe_´omÙe
(
obc
, 
missšg_oid
, 
Şoc
, 
š_h™_£t
,

2804 
poŞ
.
šfo
.
mš_wr™e_»ûncy_fÜ_´omÙe
,

2805 
	`OpReque¡Ref
(),

2806 
´omÙe_obc
)) {

2807  
ÿche_»suÉ_t
::
BLOCKED_PROMOTE
;

2809  
ÿche_»suÉ_t
::
HANDLED_PROXY
;

2811 
	`do_´oxy_»ad
(
İ
);

2814 ià(
obc
.
	`g‘
(è&& obc->
	`is_blocked
()) {

2815 ià(
´omÙe_obc
)

2816 *
´omÙe_obc
 = 
obc
;

2817  
ÿche_»suÉ_t
::
BLOCKED_PROMOTE
;

2821 ià(!
İ
->
	`Ãed_sk_´omÙe
()) {

2822 ()
	`maybe_´omÙe
(
obc
, 
missšg_oid
, 
Şoc
, 
š_h™_£t
,

2823 
poŞ
.
šfo
.
mš_»ad_»ûncy_fÜ_´omÙe
,

2824 
´omÙe_İ
, 
´omÙe_obc
);

2827  
ÿche_»suÉ_t
::
HANDLED_PROXY
;

2829 
	`as£¹
(0 == "unreachable");

2830  
ÿche_»suÉ_t
::
NOOP
;

2832 
pg_poŞ_t
::
CACHEMODE_FORWARD
:

2834 
	`do_ÿche_»dœeù
(
İ
);

2835  
ÿche_»suÉ_t
::
HANDLED_REDIRECT
;

2837 
pg_poŞ_t
::
CACHEMODE_READONLY
:

2839 ià(!
obc
.
	`g‘
(è&& 
r
 =ğ-
ENOENT
) {

2841 
	`´omÙe_objeù
(
obc
, 
missšg_oid
, 
Şoc
, 
İ
, 
´omÙe_obc
);

2842  
ÿche_»suÉ_t
::
BLOCKED_PROMOTE
;

2844 ià(!
r
) {

2845 
	`do_ÿche_»dœeù
(
İ
);

2846  
ÿche_»suÉ_t
::
HANDLED_REDIRECT
;

2849  
ÿche_»suÉ_t
::
NOOP
;

2851 
pg_poŞ_t
::
CACHEMODE_READFORWARD
:

2853 ià(
İ
->
	`may_wr™e
(è|| 
wr™e_Üd”ed
 || 
mu¡_´omÙe
) {

2854 ià(
ag’t_¡©e
 &&

2855 
ag’t_¡©e
->
eviù_mode
 =ğ
T›rAg’tS‹
::
EVICT_MODE_FULL
) {

2856 
	`dout
(20è<< 
__func__
 << " cachpoŞ fuÎ, wa™šg" << 
d’dl
;

2857 
	`block_wr™e_Ú_fuÎ_ÿche
(
missšg_oid
, 
İ
);

2858  
ÿche_»suÉ_t
::
BLOCKED_FULL
;

2860 
	`´omÙe_objeù
(
obc
, 
missšg_oid
, 
Şoc
, 
İ
, 
´omÙe_obc
);

2861  
ÿche_»suÉ_t
::
BLOCKED_PROMOTE
;

2865 
	`do_ÿche_»dœeù
(
İ
);

2866  
ÿche_»suÉ_t
::
HANDLED_REDIRECT
;

2868 
pg_poŞ_t
::
CACHEMODE_PROXY
:

2869 ià(!
mu¡_´omÙe
) {

2870 ià(
İ
->
	`may_wr™e
(è|| op->
	`may_ÿche
(è|| 
wr™e_Üd”ed
) {

2871 
	`do_´oxy_wr™e
(
İ
);

2872  
ÿche_»suÉ_t
::
HANDLED_PROXY
;

2874 
	`do_´oxy_»ad
(
İ
);

2875  
ÿche_»suÉ_t
::
HANDLED_PROXY
;

2879 ià(
ag’t_¡©e
 &&

2880 
ag’t_¡©e
->
eviù_mode
 =ğ
T›rAg’tS‹
::
EVICT_MODE_FULL
) {

2881 
	`dout
(20è<< 
__func__
 << " cachpoŞ fuÎ, wa™šg" << 
d’dl
;

2882 
	`block_wr™e_Ú_fuÎ_ÿche
(
missšg_oid
, 
İ
);

2883  
ÿche_»suÉ_t
::
BLOCKED_FULL
;

2885 
	`´omÙe_objeù
(
obc
, 
missšg_oid
, 
Şoc
, 
İ
, 
´omÙe_obc
);

2886  
ÿche_»suÉ_t
::
BLOCKED_PROMOTE
;

2888 
pg_poŞ_t
::
CACHEMODE_READPROXY
:

2890 ià(
İ
->
	`may_wr™e
(è|| 
wr™e_Üd”ed
 || 
mu¡_´omÙe
) {

2891 ià(
ag’t_¡©e
 &&

2892 
ag’t_¡©e
->
eviù_mode
 =ğ
T›rAg’tS‹
::
EVICT_MODE_FULL
) {

2893 
	`dout
(20è<< 
__func__
 << " cachpoŞ fuÎ, wa™šg" << 
d’dl
;

2894 
	`block_wr™e_Ú_fuÎ_ÿche
(
missšg_oid
, 
İ
);

2895  
ÿche_»suÉ_t
::
BLOCKED_FULL
;

2897 
	`´omÙe_objeù
(
obc
, 
missšg_oid
, 
Şoc
, 
İ
, 
´omÙe_obc
);

2898  
ÿche_»suÉ_t
::
BLOCKED_PROMOTE
;

2902 
	`do_´oxy_»ad
(
İ
);

2903  
ÿche_»suÉ_t
::
HANDLED_PROXY
;

2906 
	`as£¹
(0 == "unrecognized cache_mode");

2908  
ÿche_»suÉ_t
::
NOOP
;

2909 
	}
}

2911 
boŞ
 
	gPrim¬yLogPG
::
	$maybe_´omÙe
(
ObjeùCÚ‹xtRef
 
obc
,

2912 cÚ¡ 
hobjeù_t
& 
missšg_oid
,

2913 cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2914 
boŞ
 
š_h™_£t
,

2915 
ušt32_t
 
»ûncy
,

2916 
OpReque¡Ref
 
´omÙe_İ
,

2917 
ObjeùCÚ‹xtRef
 *
´omÙe_obc
)

2919 
	`dout
(20è<< 
__func__
 << " missšg_oid " << 
missšg_oid


2920 << " in_h™_£ˆ" << 
š_h™_£t
 << 
d’dl
;

2922 
»ûncy
) {

2927 ià(
š_h™_£t
) {

2931  
çl£
;

2936 
couÁ
 = ()
š_h™_£t
;

2937 ià(
couÁ
) {

2939 cÚ¡ 
hobjeù_t
& 
oid
 = 
obc
.
	`g‘
(è? obc->
obs
.
oi
.
soid
 : 
missšg_oid
;

2940 
m­
<
time_t
,
H™S‘Ref
>::
»v”£_™”©Ü
 
™Ü
 =

2941 
ag’t_¡©e
->
h™_£t_m­
.
	`rbegš
();

2942 
™Ü
 !ğ
ag’t_¡©e
->
h™_£t_m­
.
	`»nd
();

2943 ++
™Ü
) {

2944 ià(!
™Ü
->
£cÚd
->
	`cÚšs
(
oid
)) {

2947 ++
couÁ
;

2948 ià(
couÁ
 >ğ
»ûncy
) {

2953 ià(
couÁ
 >ğ
»ûncy
) {

2956  
çl£
;

2961 ià(
osd
->
	`´omÙe_thrÙe
()) {

2962 
	`dout
(10è<< 
__func__
 << "…romÙthrÙed" << 
d’dl
;

2963  
çl£
;

2965 
	`´omÙe_objeù
(
obc
, 
missšg_oid
, 
Şoc
, 
´omÙe_İ
, 
´omÙe_obc
);

2966  
Œue
;

2967 
	}
}

2969 
	gPrim¬yLogPG
::
	$do_ÿche_»dœeù
(
OpReque¡Ref
 
İ
)

2971 cÚ¡ 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDOp*>(
İ
->
	`g‘_»q
());

2972 
æags
 = 
m
->
	`g‘_æags
(è& (
CEPH_OSD_FLAG_ACK
|
CEPH_OSD_FLAG_ONDISK
);

2973 
MOSDOpR•ly
 *
»¶y
 = 
Ãw
 
	`MOSDOpR•ly
(
m
, -
ENOENT
, 
	`g‘_osdm­
()->
	`g‘_•och
(),

2974 
æags
, 
çl£
);

2975 
»que¡_»dœeù_t
 
	`»dœ
(
m
->
	`g‘_objeù_loÿtÜ
(), 
poŞ
.
šfo
.
t›r_of
);

2976 
»¶y
->
	`£t_»dœeù
(
»dœ
);

2977 
	`dout
(10è<< "£ndšg„edœeùØpoŞ " << 
poŞ
.
šfo
.
t›r_of
 << " for op "

2978 << 
İ
 << 
d’dl
;

2979 
m
->
	`g‘_cÚÃùiÚ
()->
	`£nd_mes§ge
(
»¶y
);

2981 
	}
}

2983 
	gC_ProxyR—d
 : 
public
 
CÚ‹xt
 {

2984 
Prim¬yLogPGRef
 
pg
;

2985 
hobjeù_t
 
	goid
;

2986 
•och_t
 
	gÏ¡_³”šg_»£t
;

2987 
ûph_tid_t
 
	gtid
;

2988 
	gPrim¬yLogPG
::
ProxyR—dOpRef
 
´dİ
;

2989 
utime_t
 
	g¡¬t
;

2990 
C_ProxyR—d
(
Prim¬yLogPG
 *
p
, 
hobjeù_t
 
o
, 
•och_t
 
Ír
,

2991 cÚ¡ 
Prim¬yLogPG
::
ProxyR—dOpRef
& 
´d
)

2992 : 
pg
(
p
), 
oid
(
o
), 
Ï¡_³”šg_»£t
(
Ír
),

2993 
tid
(0), 
´dİ
(
´d
), 
¡¬t
(
ûph_şock_now
())

2995 
fšish
(
r
è
	gov”ride
 {

2996 ià(
	g´dİ
->
	gÿnûËd
)

2998 
	gpg
->
lock
();

2999 ià(
	g´dİ
->
	gÿnûËd
) {

3000 
	gpg
->
uÆock
();

3003 ià(
	gÏ¡_³”šg_»£t
 =ğ
pg
->
g‘_Ï¡_³”šg_»£t
()) {

3004 
pg
->
fšish_´oxy_»ad
(
oid
, 
tid
, 
r
);

3005 
	gpg
->
	gosd
->
	glogg”
->
tšc
(
l_osd_t›r_r_Ït
, 
ûph_şock_now
(è- 
¡¬t
);

3007 
	gpg
->
uÆock
();

3011 
	gC_ProxyChunkR—d
 : 
public
 
CÚ‹xt
 {

3012 
Prim¬yLogPGRef
 
pg
;

3013 
hobjeù_t
 
	goid
;

3014 
•och_t
 
	gÏ¡_³”šg_»£t
;

3015 
ûph_tid_t
 
	gtid
;

3016 
	gPrim¬yLogPG
::
ProxyR—dOpRef
 
´dİ
;

3017 
utime_t
 
	g¡¬t
;

3018 
ObjeùO³¿tiÚ
 *
	gobj_İ
;

3019 
	gİ_šdex
 = 0;

3020 
ušt64_t
 
	g»q_off£t
 = 0;

3021 
ObjeùCÚ‹xtRef
 
	gobc
;

3022 
ušt64_t
 
	g»q_tÙ®_Ën
 = 0;

3023 
C_ProxyChunkR—d
(
Prim¬yLogPG
 *
p
, 
hobjeù_t
 
o
, 
•och_t
 
Ír
,

3024 cÚ¡ 
Prim¬yLogPG
::
ProxyR—dOpRef
& 
´d
)

3025 : 
pg
(
p
), 
oid
(
o
), 
Ï¡_³”šg_»£t
(
Ír
),

3026 
tid
(0), 
´dİ
(
´d
), 
¡¬t
(
ûph_şock_now
()), 
obj_İ
(
NULL
)

3028 
fšish
(
r
è
	gov”ride
 {

3029 ià(
	g´dİ
->
	gÿnûËd
)

3031 
	gpg
->
lock
();

3032 ià(
	g´dİ
->
	gÿnûËd
) {

3033 
	gpg
->
uÆock
();

3036 ià(
	gÏ¡_³”šg_»£t
 =ğ
pg
->
g‘_Ï¡_³”šg_»£t
()) {

3037 ià(
r
 >= 0) {

3038 ià(!
´dİ
->
İs
[
İ_šdex
].
outd©a
.
Ëngth
()) {

3039 
as£¹
(
»q_tÙ®_Ën
);

3040 
bufã¾i¡
 
	gli¡
;

3041 
bufã½Œ
 
b±r
(
»q_tÙ®_Ën
);

3042 
	gli¡
.
push_back
(
¡d
::
move
(
b±r
));

3043 
	g´dİ
->
	gİs
[
İ_šdex
].
	goutd©a
.
­³nd
(
li¡
);

3045 
as£¹
(
obj_İ
);

3046 
ušt64_t
 
	gcİy_off£t
;

3047 ià(
	g»q_off£t
 >ğ
´dİ
->
İs
[
İ_šdex
].
İ
.
ex‹Á
.
off£t
) {

3048 
cİy_off£t
 = 
»q_off£t
 - 
´dİ
->
İs
[
İ_šdex
].
İ
.
ex‹Á
.
off£t
;

3050 
	gcİy_off£t
 = 0;

3052 
	g´dİ
->
	gİs
[
İ_šdex
].
	goutd©a
.
cİy_š
(
cİy_off£t
, 
obj_İ
->
İs
[0].
outd©a
.
Ëngth
(),

3053 
obj_İ
->
İs
[0].
outd©a
.
c_¡r
());

3056 
	gpg
->
fšish_´oxy_»ad
(
oid
, 
tid
, 
r
);

3057 
	gpg
->
	gosd
->
	glogg”
->
tšc
(
l_osd_t›r_r_Ït
, 
ûph_şock_now
(è- 
¡¬t
);

3058 ià(
	gobj_İ
) {

3059 
d–‘e
 
	gobj_İ
;

3062 
	gpg
->
uÆock
();

3066 
	gPrim¬yLogPG
::
	$do_´oxy_»ad
(
OpReque¡Ref
 
İ
, 
ObjeùCÚ‹xtRef
 
obc
)

3070 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<MOSDOp*>(
İ
->
	`g‘_nÚcÚ¡_»q
());

3071 
objeù_loÿtÜ_t
 
Şoc
;

3072 
hobjeù_t
 
soid
;

3074 ià(
obc
 && obc->
obs
.
exi¡s
 && obc->obs.
oi
.
	`has_mªiã¡
()) {

3075 
obc
->
obs
.
oi
.
mªiã¡
.
ty³
) {

3076 
objeù_mªiã¡_t
::
TYPE_REDIRECT
:

3077 
Şoc
 = 
	`objeù_loÿtÜ_t
(
obc
->
obs
.
oi
.
mªiã¡
.
»dœeù_rg‘
);

3078 
soid
 = 
obc
->
obs
.
oi
.
mªiã¡
.
»dœeù_rg‘
;

3081 
	`as£¹
(0 == "unrecognized manifestype");

3085 
soid
 = 
m
->
	`g‘_hobj
();

3086 
Şoc
 = 
	`objeù_loÿtÜ_t
(
m
->
	`g‘_objeù_loÿtÜ
());

3087 
Şoc
.
poŞ
 =…oŞ.
šfo
.
t›r_of
;

3089 
æags
 = 
CEPH_OSD_FLAG_IGNORE_CACHE
 | 
CEPH_OSD_FLAG_IGNORE_OVERLAY
;

3095 
æags
 |ğ
m
->
	`g‘_æags
(è& (
CEPH_OSD_FLAG_RWORDERED
 |

3096 
CEPH_OSD_FLAG_ORDERSNAP
 |

3097 
CEPH_OSD_FLAG_ENFORCE_SNAPC
 |

3098 
CEPH_OSD_FLAG_MAP_SNAP_CLONE
);

3100 
	`dout
(10è<< 
__func__
 << " S¹…roxy„—d fÜ " << *
m
 << 
d’dl
;

3102 
ProxyR—dOpRef
 
	`´dİ
(
¡d
::
make_sh¬ed
<
ProxyR—dOp
>(
İ
, 
soid
, 
m
->
İs
));

3104 
ObjeùO³¿tiÚ
 
obj_İ
;

3105 
obj_İ
.
	`dup
(
´dİ
->
İs
);

3107 ià(
poŞ
.
šfo
.
ÿche_mode
 =ğ
pg_poŞ_t
::
CACHEMODE_WRITEBACK
 &&

3108 (
ag’t_¡©e
 &&‡g’t_¡©e->
eviù_mode
 !ğ
T›rAg’tS‹
::
EVICT_MODE_FULL
)) {

3109 
i
 = 0; i < 
obj_İ
.
İs
.
	`size
(); i++) {

3110 
ûph_osd_İ
 
İ
 = 
obj_İ
.
İs
[
i
].op;

3111 
İ
.op) {

3112 
CEPH_OSD_OP_READ
:

3113 
CEPH_OSD_OP_SYNC_READ
:

3114 
CEPH_OSD_OP_SPARSE_READ
:

3115 
CEPH_OSD_OP_CHECKSUM
:

3116 
CEPH_OSD_OP_CMPEXT
:

3117 
İ
.
æags
 = (İ.æag | 
CEPH_OSD_OP_FLAG_FADVISE_SEQUENTIAL
) &

3118 ~(
CEPH_OSD_OP_FLAG_FADVISE_DONTNEED
 | 
CEPH_OSD_OP_FLAG_FADVISE_NOCACHE
);

3123 
C_ProxyR—d
 *
fš
 = 
Ãw
 
	`C_ProxyR—d
(
this
, 
soid
, 
	`g‘_Ï¡_³”šg_»£t
(),

3124 
´dİ
);

3125 
n
 = 
šfo
.
pgid
.
	`hash_to_sh¬d
(
osd
->
m_objeù”_fšish”s
);

3126 
ûph_tid_t
 
tid
 = 
osd
->
objeù”
->
	`»ad
(

3127 
soid
.
oid
, 
Şoc
, 
obj_İ
,

3128 
m
->
	`g‘_¢­id
(), 
NULL
,

3129 
æags
, 
Ãw
 
	`C_OnFšish”
(
fš
, 
osd
->
objeù”_fšish”s
[
n
]),

3130 &
´dİ
->
u£r_v”siÚ
,

3131 &
´dİ
->
d©a_off£t
,

3132 
m
->
	`g‘_ã©u»s
());

3133 
fš
->
tid
 =id;

3134 
´dİ
->
objeù”_tid
 = 
tid
;

3135 
´oxy»ad_İs
[
tid
] = 
´dİ
;

3136 
š_´og»ss_´oxy_İs
[
soid
].
	`push_back
(
İ
);

3137 
	}
}

3139 
	gPrim¬yLogPG
::
	$fšish_´oxy_»ad
(
hobjeù_t
 
oid
, 
ûph_tid_t
 
tid
, 
r
)

3141 
	`dout
(10è<< 
__func__
 << " " << 
oid
 << "id " << 
tid


3142 << " " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

3144 
m­
<
ûph_tid_t
, 
ProxyR—dOpRef
>::
™”©Ü
 
p
 = 
´oxy»ad_İs
.
	`fšd
(
tid
);

3145 ià(
p
 =ğ
´oxy»ad_İs
.
	`’d
()) {

3146 
	`dout
(10è<< 
__func__
 << "‚Ø´oxy»ad_İ found" << 
d’dl
;

3149 
ProxyR—dOpRef
 
´dİ
 = 
p
->
£cÚd
;

3150 ià(
tid
 !ğ
´dİ
->
objeù”_tid
) {

3151 
	`dout
(10è<< 
__func__
 << "id " << 
tid
 << " !ğ´dİ " << 
´dİ


3152 << "id " << 
´dİ
->
objeù”_tid
 << 
d’dl
;

3155 ià(
oid
 !ğ
´dİ
->
soid
) {

3156 
	`dout
(10è<< 
__func__
 << " oid " << 
oid
 << " !ğ´dİ " << 
´dİ


3157 << " soid " << 
´dİ
->
soid
 << 
d’dl
;

3160 
´oxy»ad_İs
.
	`”a£
(
tid
);

3162 
m­
<
hobjeù_t
, 
li¡
<
OpReque¡Ref
>>::
™”©Ü
 
q
 = 
š_´og»ss_´oxy_İs
.
	`fšd
(
oid
);

3163 ià(
q
 =ğ
š_´og»ss_´oxy_İs
.
	`’d
()) {

3164 
	`dout
(10è<< 
__func__
 << "‚Øš_´og»ss_´oxy_İ found" << 
d’dl
;

3167 
	`as£¹
(
q
->
£cÚd
.
	`size
());

3168 
li¡
<
OpReque¡Ref
>::
™”©Ü
 
™
 = 
¡d
::
	`fšd
(
q
->
£cÚd
.
	`begš
(),

3169 
q
->
£cÚd
.
	`’d
(),

3170 
´dİ
->
İ
);

3171 
	`as£¹
(
™
 !ğ
q
->
£cÚd
.
	`’d
());

3172 
OpReque¡Ref
 
İ
 = *
™
;

3173 
q
->
£cÚd
.
	`”a£
(
™
);

3174 ià(
q
->
£cÚd
.
	`size
() == 0) {

3175 
š_´og»ss_´oxy_İs
.
	`”a£
(
oid
);

3176 } ià(
¡d
::
	`fšd
(
q
->
£cÚd
.
	`begš
(),

3177 
q
->
£cÚd
.
	`’d
(),

3178 
´dİ
->
İ
è!ğ
q
->
£cÚd
.
	`’d
()) {

3180 
	`dout
(20è<< 
__func__
 << " " << 
oid
 << " i nÙ com¶‘ed " << 
d’dl
;

3184 
osd
->
logg”
->
	`šc
(
l_osd_t›r_´oxy_»ad
);

3186 cÚ¡ 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDOp*>(
İ
->
	`g‘_»q
());

3187 
OpCÚ‹xt
 *
ùx
 = 
Ãw
 
	`OpCÚ‹xt
(
İ
, 
m
->
	`g‘_»qid
(), &
´dİ
->
İs
, 
this
);

3188 
ùx
->
»¶y
 = 
Ãw
 
	`MOSDOpR•ly
(
m
, 0, 
	`g‘_osdm­
()->
	`g‘_•och
(), 0, 
çl£
);

3189 
ùx
->
u£r_©_v”siÚ
 = 
´dİ
->
u£r_v”siÚ
;

3190 
ùx
->
d©a_off
 = 
´dİ
->
d©a_off£t
;

3191 
ùx
->
ignÜe_log_İ_¡©s
 = 
Œue
;

3192 
	`com¶‘e_»ad_ùx
(
r
, 
ùx
);

3193 
	}
}

3195 
	gPrim¬yLogPG
::
	$kick_´oxy_İs_blocked
(
hobjeù_t
& 
soid
)

3197 
m­
<
hobjeù_t
, 
li¡
<
OpReque¡Ref
>>::
™”©Ü
 
p
 = 
š_´og»ss_´oxy_İs
.
	`fšd
(
soid
);

3198 ià(
p
 =ğ
š_´og»ss_´oxy_İs
.
	`’d
())

3201 
li¡
<
OpReque¡Ref
>& 
ls
 = 
p
->
£cÚd
;

3202 
	`dout
(10è<< 
__func__
 << " " << 
soid
 << "„equeušg " << 
ls
.
	`size
(è<< "„eque¡s" << 
d’dl
;

3203 
	`»queue_İs
(
ls
);

3204 
š_´og»ss_´oxy_İs
.
	`”a£
(
p
);

3205 
	}
}

3207 
	gPrim¬yLogPG
::
ÿnûl_´oxy_»ad
(
ProxyR—dOpRef
 
´dİ
,

3208 
veùÜ
<
ûph_tid_t
> *
tids
)

3210 
dout
(10è<< 
	g__func__
 << " " << 
	g´dİ
->
	gsoid
 << 
	gd’dl
;

3211 
	g´dİ
->
	gÿnûËd
 = 
Œue
;

3214 ià(
	g´dİ
->
	gobjeù”_tid
) {

3215 
	gtids
->
push_back
(
´dİ
->
objeù”_tid
);

3216 
ušt32_t
 
	gi
 = 0; i < 
	g´dİ
->
	gİs
.
size
(); i++) {

3217 
	g´dİ
->
	gİs
[
i
].
	goutd©a
.
ş—r
();

3219 
	g´oxy»ad_İs
.
”a£
(
´dİ
->
objeù”_tid
);

3220 
	g´dİ
->
	gobjeù”_tid
 = 0;

3224 
	gPrim¬yLogPG
::
ÿnûl_´oxy_İs
(
boŞ
 
»queue
, 
veùÜ
<
ûph_tid_t
> *
tids
)

3226 
dout
(10è<< 
	g__func__
 << 
	gd’dl
;

3229 
	gm­
<
	gûph_tid_t
, 
	gProxyR—dOpRef
>::
™”©Ü
 
p
 = 
´oxy»ad_İs
.
begš
();

3230 
	gp
 !ğ
´oxy»ad_İs
.
’d
()) {

3231 
ÿnûl_´oxy_»ad
((
p
++)->
£cÚd
, 
tids
);

3235 
	gm­
<
	gûph_tid_t
, 
	gProxyWr™eOpRef
>::
™”©Ü
 
q
 = 
´oxywr™e_İs
.
begš
();

3236 
	gq
 !ğ
´oxywr™e_İs
.
’d
()) {

3237 
ÿnûl_´oxy_wr™e
((
q
++)->
£cÚd
, 
tids
);

3240 ià(
	g»queue
) {

3241 
	gm­
<
	ghobjeù_t
, 
	gli¡
<
	gOpReque¡Ref
>>::
™”©Ü
 
p
 =

3242 
š_´og»ss_´oxy_İs
.
begš
();

3243 
	gp
 !ğ
š_´og»ss_´oxy_İs
.
’d
()) {

3244 
li¡
<
OpReque¡Ref
>& 
ls
 = 
p
->
£cÚd
;

3245 
dout
(10è<< 
	g__func__
 << " " << 
	gp
->
	gfœ¡
 << "„equeušg " << 
	gls
.
size
()

3246 << "„eque¡s" << 
	gd’dl
;

3247 
»queue_İs
(
ls
);

3248 
	gš_´og»ss_´oxy_İs
.
”a£
(
p
++);

3251 
	gš_´og»ss_´oxy_İs
.
ş—r
();

3255 
	gC_ProxyWr™e_Comm™
 : 
public
 
CÚ‹xt
 {

3256 
Prim¬yLogPGRef
 
pg
;

3257 
hobjeù_t
 
	goid
;

3258 
•och_t
 
	gÏ¡_³”šg_»£t
;

3259 
ûph_tid_t
 
	gtid
;

3260 
	gPrim¬yLogPG
::
ProxyWr™eOpRef
 
pwİ
;

3261 
C_ProxyWr™e_Comm™
(
Prim¬yLogPG
 *
p
, 
hobjeù_t
 
o
, 
•och_t
 
Ír
,

3262 cÚ¡ 
Prim¬yLogPG
::
ProxyWr™eOpRef
& 
pw
)

3263 : 
pg
(
p
), 
oid
(
o
), 
Ï¡_³”šg_»£t
(
Ír
),

3264 
tid
(0), 
pwİ
(
pw
)

3266 
fšish
(
r
è
	gov”ride
 {

3267 ià(
	gpwİ
->
	gÿnûËd
)

3269 
	gpg
->
lock
();

3270 ià(
	gpwİ
->
	gÿnûËd
) {

3271 
	gpg
->
uÆock
();

3274 ià(
	gÏ¡_³”šg_»£t
 =ğ
pg
->
g‘_Ï¡_³”šg_»£t
()) {

3275 
pg
->
fšish_´oxy_wr™e
(
oid
, 
tid
, 
r
);

3277 
	gpg
->
uÆock
();

3281 
	gPrim¬yLogPG
::
	$do_´oxy_wr™e
(
OpReque¡Ref
 
İ
, 
ObjeùCÚ‹xtRef
 
obc
)

3284 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<MOSDOp*>(
İ
->
	`g‘_nÚcÚ¡_»q
());

3285 
objeù_loÿtÜ_t
 
Şoc
;

3286 
SÇpCÚ‹xt
 
	`¢­c
(
m
->
	`g‘_¢­_£q
(), m->
	`g‘_¢­s
());

3287 
hobjeù_t
 
soid
;

3289 ià(
obc
 && obc->
obs
.
exi¡s
 && obc->obs.
oi
.
	`has_mªiã¡
()) {

3290 
obc
->
obs
.
oi
.
mªiã¡
.
ty³
) {

3291 
objeù_mªiã¡_t
::
TYPE_REDIRECT
:

3292 
Şoc
 = 
	`objeù_loÿtÜ_t
(
obc
->
obs
.
oi
.
mªiã¡
.
»dœeù_rg‘
);

3293 
soid
 = 
obc
->
obs
.
oi
.
mªiã¡
.
»dœeù_rg‘
;

3296 
	`as£¹
(0 == "unrecognized manifestype");

3300 
soid
 = 
m
->
	`g‘_hobj
();

3301 
Şoc
 = 
	`objeù_loÿtÜ_t
(
m
->
	`g‘_objeù_loÿtÜ
());

3302 
Şoc
.
poŞ
 =…oŞ.
šfo
.
t›r_of
;

3305 
æags
 = 
CEPH_OSD_FLAG_IGNORE_CACHE
 | 
CEPH_OSD_FLAG_IGNORE_OVERLAY
;

3306 ià(!(
İ
->
	`may_wr™e
(è|| op->
	`may_ÿche
())) {

3307 
æags
 |ğ
CEPH_OSD_FLAG_RWORDERED
;

3309 
	`dout
(10è<< 
__func__
 << " S¹…roxy wr™fÜ " << *
m
 << 
d’dl
;

3311 
ProxyWr™eOpRef
 
	`pwİ
(
¡d
::
make_sh¬ed
<
ProxyWr™eOp
>(
İ
, 
soid
, 
m
->
İs
, m->
	`g‘_»qid
()));

3312 
pwİ
->
ùx
 = 
Ãw
 
	`OpCÚ‹xt
(
İ
, 
m
->
	`g‘_»qid
(), &pwİ->
İs
, 
this
);

3313 
pwİ
->
mtime
 = 
m
->
	`g‘_mtime
();

3315 
ObjeùO³¿tiÚ
 
obj_İ
;

3316 
obj_İ
.
	`dup
(
pwİ
->
İs
);

3318 
C_ProxyWr™e_Comm™
 *
fš
 = 
Ãw
 
	`C_ProxyWr™e_Comm™
(

3319 
this
, 
soid
, 
	`g‘_Ï¡_³”šg_»£t
(), 
pwİ
);

3320 
n
 = 
šfo
.
pgid
.
	`hash_to_sh¬d
(
osd
->
m_objeù”_fšish”s
);

3321 
ûph_tid_t
 
tid
 = 
osd
->
objeù”
->
	`mu‹
(

3322 
soid
.
oid
, 
Şoc
, 
obj_İ
, 
¢­c
,

3323 
ûph
::
»®_şock
::
	`äom_ûph_time¥ec
(
pwİ
->
mtime
),

3324 
æags
, 
Ãw
 
	`C_OnFšish”
(
fš
, 
osd
->
objeù”_fšish”s
[
n
]),

3325 &
pwİ
->
u£r_v”siÚ
,…wİ->
»qid
);

3326 
fš
->
tid
 =id;

3327 
pwİ
->
objeù”_tid
 = 
tid
;

3328 
´oxywr™e_İs
[
tid
] = 
pwİ
;

3329 
š_´og»ss_´oxy_İs
[
soid
].
	`push_back
(
İ
);

3330 
	}
}

3332 
	gPrim¬yLogPG
::
	$do_´oxy_chunked_İ
(
OpReque¡Ref
 
İ
, cÚ¡ 
hobjeù_t
& 
missšg_oid
,

3333 
ObjeùCÚ‹xtRef
 
obc
, 
boŞ
 
wr™e_Üd”ed
)

3335 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<MOSDOp*>(
İ
->
	`g‘_nÚcÚ¡_»q
());

3336 
OSDOp
 *
osd_İ
 = 
NULL
;

3337 
i
 = 0; i < 
m
->
İs
.
	`size
(); i++) {

3338 
osd_İ
 = &
m
->
İs
[
i
];

3339 
ušt64_t
 
cursÜ
 = 
osd_İ
->
İ
.
ex‹Á
.
off£t
;

3340 
ušt64_t
 
İ_Ëngth
 = 
osd_İ
->
İ
.
ex‹Á
.
off£t
 + osd_İ->İ.ex‹Á.
Ëngth
;

3341 
ušt64_t
 
chunk_Ëngth
 = 0, 
chunk_šdex
 = 0, 
»q_Ën
 = 0;

3342 
objeù_mªiã¡_t
 *
mªiã¡
 = &
obc
->
obs
.
oi
.manifest;

3343 
m­
 <
ušt64_t
, m­<ušt64_t, ušt64_t>> 
chunk_»ad
;

3345 
cursÜ
 < 
İ_Ëngth
) {

3346 
chunk_šdex
 = 0;

3347 
chunk_Ëngth
 = 0;

3349 autØ&
p
 : 
mªiã¡
->
chunk_m­
) {

3350 ià(
p
.
fœ¡
 <ğ
cursÜ
 &&….fœ¡ +….
£cÚd
.
Ëngth
 > cursor) {

3351 
chunk_Ëngth
 = 
p
.
£cÚd
.
Ëngth
;

3352 
chunk_šdex
 = 
p
.
fœ¡
;

3357 ià(!
chunk_šdex
 && !
chunk_Ëngth
) {

3358 ià(
cursÜ
 =ğ
osd_İ
->
İ
.
ex‹Á
.
off£t
) {

3359 
OpCÚ‹xt
 *
ùx
 = 
Ãw
 
	`OpCÚ‹xt
(
İ
, 
m
->
	`g‘_»qid
(), &m->
İs
, 
this
);

3360 
ùx
->
»¶y
 = 
Ãw
 
	`MOSDOpR•ly
(
m
, 0, 
	`g‘_osdm­
()->
	`g‘_•och
(), 0, 
çl£
);

3361 
ùx
->
d©a_off
 = 
osd_İ
->
İ
.
ex‹Á
.
off£t
;

3362 
ùx
->
ignÜe_log_İ_¡©s
 = 
Œue
;

3363 
	`com¶‘e_»ad_ùx
(0, 
ùx
);

3367 
ušt64_t
 
Ãxt_Ëngth
 = 
chunk_Ëngth
;

3370 ià(
cursÜ
 + 
Ãxt_Ëngth
 > 
İ_Ëngth
) {

3371 
Ãxt_Ëngth
 = 
İ_Ëngth
 - 
cursÜ
;

3375 ià(
cursÜ
 + 
Ãxt_Ëngth
 > 
chunk_šdex
 + 
chunk_Ëngth
) {

3376 
Ãxt_Ëngth
 = 
chunk_šdex
 + 
chunk_Ëngth
 - 
cursÜ
;

3379 
chunk_»ad
[
cursÜ
] = {{
chunk_šdex
, 
Ãxt_Ëngth
}};

3380 
cursÜ
 +ğ
Ãxt_Ëngth
;

3383 
»q_Ën
 = 
cursÜ
 - 
osd_İ
->
İ
.
ex‹Á
.
off£t
;

3384 autØ&
p
 : 
chunk_»ad
) {

3385 autØ
chunks
 = 
p
.
£cÚd
.
	`begš
();

3386 
	`dout
(20è<< 
__func__
 << " chunk_šdex: " << 
chunks
->
fœ¡


3387 << "‚ext_Ëngth: " << 
chunks
->
£cÚd
 << " cursor: "

3388 << 
p
.
fœ¡
 << 
d’dl
;

3389 
	`do_´oxy_chunked_»ad
(
İ
, 
obc
, 
i
, 
chunks
->
fœ¡
, 
p
.fœ¡, chunks->
£cÚd
, 
»q_Ën
, 
wr™e_Üd”ed
);

3392 
	}
}

3394 
	gRefCouÁC®lback
 : 
public
 
CÚ‹xt
 {

3395 
public
:

3396 
Prim¬yLogPG
 *
pg
;

3397 
	gPrim¬yLogPG
::
OpCÚ‹xt
 *
ùx
;

3398 
	gOSDOp
& 
	gosd_İ
;

3399 
•och_t
 
	gÏ¡_³”šg_»£t
;

3401 
RefCouÁC®lback
(
Prim¬yLogPG
 *
pg
, Prim¬yLogPG::
OpCÚ‹xt
 *
ùx
,

3402 
OSDOp
 &
osd_İ
, 
•och_t
 
Ír
)

3403 : 
pg
Õg), 
ùx
(ùx), 
osd_İ
(osd_İ), 
Ï¡_³”šg_»£t
(
Ír
)

3405 
fšish
(
r
è
	gov”ride
 {

3406 
	gpg
->
lock
();

3407 ià(
	gÏ¡_³”šg_»£t
 =ğ
pg
->
g‘_Ï¡_³”šg_»£t
()) {

3408 ià(
r
 >= 0) {

3409 
osd_İ
.
rv®
 = 0;

3410 
	gpg
->
execu‹_ùx
(
ùx
);

3412 ià(
	gùx
->
	gİ
) {

3413 
	gpg
->
	gosd
->
»¶y_İ_”rÜ
(
ùx
->
İ
, 
r
);

3415 
	gpg
->
şo£_İ_ùx
(
ùx
);

3418 
	gpg
->
uÆock
();

3422 
	gS‘Mªiã¡Fšish”
 : 
public
 
Prim¬yLogPG
::
OpFšish”
 {

3423 
OSDOp
& 
osd_İ
;

3425 
ex¶ic™
 
S‘Mªiã¡Fšish”
(
OSDOp
& 
osd_İ
) : osd_op(osd_op) {

3428 
execu‹
(è
ov”ride
 {

3429  
osd_İ
.
rv®
;

3433 
	gPrim¬yLogPG
::
	$»fcouÁ_mªiã¡
(
ObjeùCÚ‹xtRef
 
obc
, 
objeù_loÿtÜ_t
 
Şoc
, 
hobjeù_t
 
soid
,

3434 
SÇpCÚ‹xt
 
¢­c
, 
boŞ
 
g‘
, 
CÚ‹xt
 *
cb
, 
ušt64_t
 
off£t
)

3436 
æags
 = 
CEPH_OSD_FLAG_IGNORE_CACHE
 | 
CEPH_OSD_FLAG_IGNORE_OVERLAY
 |

3437 
CEPH_OSD_FLAG_RWORDERED
;

3439 
	`dout
(10è<< 
__func__
 << " S¹„efcouÁ fÜ " << 
soid
 << 
d’dl
;

3441 
ObjeùO³¿tiÚ
 
obj_İ
;

3442 
bufã¾i¡
 
š
;

3443 ià(
g‘
) {

3444 
şs_chunk_»fcouÁ_g‘_İ
 
ÿÎ
;

3445 
ÿÎ
.
sourû
 = 
obc
->
obs
.
oi
.
soid
;

3446 ::
	`’code
(
ÿÎ
, 
š
);

3447 
obj_İ
.
	`ÿÎ
("»fcouÁ", "chunk_g‘", 
š
);

3449 
şs_chunk_»fcouÁ_put_İ
 
ÿÎ
;

3450 
ÿÎ
.
sourû
 = 
obc
->
obs
.
oi
.
soid
;

3451 ::
	`’code
(
ÿÎ
, 
š
);

3452 
obj_İ
.
	`ÿÎ
("»fcouÁ", "chunk_put", 
š
);

3455 
n
 = 
šfo
.
pgid
.
	`hash_to_sh¬d
(
osd
->
m_objeù”_fšish”s
);

3456 
osd
->
objeù”
->
	`mu‹
(

3457 
soid
.
oid
, 
Şoc
, 
obj_İ
, 
¢­c
,

3458 
ûph
::
»®_şock
::
	`äom_ûph_time¥ec
(
obc
->
obs
.
oi
.
mtime
),

3459 
æags
, 
Ãw
 
	`C_OnFšish”
(
cb
, 
osd
->
objeù”_fšish”s
[
n
]));

3460 
	}
}

3462 
	gPrim¬yLogPG
::
	$do_´oxy_chunked_»ad
(
OpReque¡Ref
 
İ
, 
ObjeùCÚ‹xtRef
 
obc
, 
İ_šdex
,

3463 
ušt64_t
 
chunk_šdex
, ušt64_ˆ
»q_off£t
, ušt64_ˆ
»q_Ëngth
,

3464 
ušt64_t
 
»q_tÙ®_Ën
, 
boŞ
 
wr™e_Üd”ed
)

3466 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<MOSDOp*>(
İ
->
	`g‘_nÚcÚ¡_»q
());

3467 
objeù_mªiã¡_t
 *
mªiã¡
 = &
obc
->
obs
.
oi
.manifest;

3468 ià(!
mªiã¡
->
chunk_m­
.
	`couÁ
(
chunk_šdex
)) {

3471 
ušt64_t
 
chunk_Ëngth
 = 
mªiã¡
->
chunk_m­
[
chunk_šdex
].
Ëngth
;

3472 
hobjeù_t
 
soid
 = 
mªiã¡
->
chunk_m­
[
chunk_šdex
].
oid
;

3473 
hobjeù_t
 
Üi_soid
 = 
m
->
	`g‘_hobj
();

3474 
objeù_loÿtÜ_t
 
	`Şoc
(
soid
);

3475 
æags
 = 
CEPH_OSD_FLAG_IGNORE_CACHE
 | 
CEPH_OSD_FLAG_IGNORE_OVERLAY
;

3476 ià(
wr™e_Üd”ed
) {

3477 
æags
 |ğ
CEPH_OSD_FLAG_RWORDERED
;

3480 ià(!
chunk_Ëngth
 || 
soid
 =ğ
	`hobjeù_t
()) {

3485 
æags
 |ğ
m
->
	`g‘_æags
(è& (
CEPH_OSD_FLAG_RWORDERED
 |

3486 
CEPH_OSD_FLAG_ORDERSNAP
 |

3487 
CEPH_OSD_FLAG_ENFORCE_SNAPC
 |

3488 
CEPH_OSD_FLAG_MAP_SNAP_CLONE
);

3490 
	`dout
(10è<< 
__func__
 << " S¹ dØchunk…roxy„—d fÜ " << *
m


3491 << " index: " << 
İ_šdex
 << " oid: " << 
soid
.
oid
.
Çme
 << "„eq_off£t: " << 
»q_off£t


3492 << "„eq_Ëngth: " << 
»q_Ëngth
 << 
d’dl
;

3494 
ProxyR—dOpRef
 
	`´dİ
(
¡d
::
make_sh¬ed
<
ProxyR—dOp
>(
İ
, 
Üi_soid
, 
m
->
İs
));

3496 
ObjeùO³¿tiÚ
 *
pobj_İ
 = 
Ãw
 ObjectOperation;

3497 
OSDOp
 &
osd_İ
 = 
pobj_İ
->
	`add_İ
(
m
->
İs
[
İ_šdex
].
İ
.op);

3499 ià(
chunk_šdex
 <ğ
»q_off£t
) {

3500 
osd_İ
.
İ
.
ex‹Á
.
off£t
 = 
mªiã¡
->
chunk_m­
[
chunk_šdex
].off£ˆ+ 
»q_off£t
 - chunk_index;

3502 
	`as£¹
(0 == "chunk_index >„eq_offset");

3504 
osd_İ
.
İ
.
ex‹Á
.
Ëngth
 = 
»q_Ëngth
;

3506 
ObjeùO³¿tiÚ
 
obj_İ
;

3507 
obj_İ
.
	`dup
(
pobj_İ
->
İs
);

3509 
C_ProxyChunkR—d
 *
fš
 = 
Ãw
 
	`C_ProxyChunkR—d
(
this
, 
Üi_soid
, 
	`g‘_Ï¡_³”šg_»£t
(),

3510 
´dİ
);

3511 
fš
->
obj_İ
 = 
pobj_İ
;

3512 
fš
->
İ_šdex
 = op_index;

3513 
fš
->
»q_off£t
 =„eq_offset;

3514 
fš
->
obc
 = obc;

3515 
fš
->
»q_tÙ®_Ën
 =„eq_total_len;

3517 
n
 = 
šfo
.
pgid
.
	`hash_to_sh¬d
(
osd
->
m_objeù”_fšish”s
);

3518 
ûph_tid_t
 
tid
 = 
osd
->
objeù”
->
	`»ad
(

3519 
soid
.
oid
, 
Şoc
, 
obj_İ
,

3520 
m
->
	`g‘_¢­id
(), 
NULL
,

3521 
æags
, 
Ãw
 
	`C_OnFšish”
(
fš
, 
osd
->
objeù”_fšish”s
[
n
]),

3522 &
´dİ
->
u£r_v”siÚ
,

3523 &
´dİ
->
d©a_off£t
,

3524 
m
->
	`g‘_ã©u»s
());

3525 
fš
->
tid
 =id;

3526 
´dİ
->
objeù”_tid
 = 
tid
;

3527 
´oxy»ad_İs
[
tid
] = 
´dİ
;

3528 
š_´og»ss_´oxy_İs
[
Üi_soid
].
	`push_back
(
İ
);

3529 
	}
}

3531 
boŞ
 
	gPrim¬yLogPG
::
	$ÿn_´oxy_chunked_»ad
(
OpReque¡Ref
 
İ
, 
ObjeùCÚ‹xtRef
 
obc
)

3533 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<MOSDOp*>(
İ
->
	`g‘_nÚcÚ¡_»q
());

3534 
OSDOp
 *
osd_İ
 = 
NULL
;

3535 
boŞ
 
»t
 = 
Œue
;

3536 
i
 = 0; i < 
m
->
İs
.
	`size
(); i++) {

3537 
osd_İ
 = &
m
->
İs
[
i
];

3538 
ûph_osd_İ
 
İ
 = 
osd_İ
->op;

3539 
İ
.op) {

3540 
CEPH_OSD_OP_READ
:

3541 
CEPH_OSD_OP_SYNC_READ
: {

3542 
ušt64_t
 
cursÜ
 = 
osd_İ
->
İ
.
ex‹Á
.
off£t
;

3543 
ušt64_t
 
»maš
 = 
osd_İ
->
İ
.
ex‹Á
.
Ëngth
;

3546 autØ&
p
 : 
obc
->
obs
.
oi
.
mªiã¡
.
chunk_m­
) {

3547 ià(
p
.
fœ¡
 <ğ
cursÜ
 &&….fœ¡ +….
£cÚd
.
Ëngth
 > cursor) {

3548 ià(
p
.
£cÚd
.
æags
 !ğ
chunk_šfo_t
::
FLAG_MISSING
) {

3549  
çl£
;

3551 ià(
p
.
£cÚd
.
Ëngth
 >ğ
»maš
) {

3552 
»maš
 = 0;

3555 
»maš
 =„emaš - 
p
.
£cÚd
.
Ëngth
;

3557 
cursÜ
 +ğ
p
.
£cÚd
.
Ëngth
;

3561 ià(
»maš
) {

3562 
	`dout
(20è<< 
__func__
 << "„eque¡ed chunk dÚ'ˆexi¡ iÀchunk_m­ " << 
d’dl
;

3563  
çl£
;

3568  
çl£
;

3571  
»t
;

3572 
	}
}

3574 
	gPrim¬yLogPG
::
	$fšish_´oxy_wr™e
(
hobjeù_t
 
oid
, 
ûph_tid_t
 
tid
, 
r
)

3576 
	`dout
(10è<< 
__func__
 << " " << 
oid
 << "id " << 
tid


3577 << " " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

3579 
m­
<
ûph_tid_t
, 
ProxyWr™eOpRef
>::
™”©Ü
 
p
 = 
´oxywr™e_İs
.
	`fšd
(
tid
);

3580 ià(
p
 =ğ
´oxywr™e_İs
.
	`’d
()) {

3581 
	`dout
(10è<< 
__func__
 << "‚Ø´oxywr™e_İ found" << 
d’dl
;

3584 
ProxyWr™eOpRef
 
pwİ
 = 
p
->
£cÚd
;

3585 
	`as£¹
(
tid
 =ğ
pwİ
->
objeù”_tid
);

3586 
	`as£¹
(
oid
 =ğ
pwİ
->
soid
);

3588 
´oxywr™e_İs
.
	`”a£
(
tid
);

3590 
m­
<
hobjeù_t
, 
li¡
<
OpReque¡Ref
> >::
™”©Ü
 
q
 = 
š_´og»ss_´oxy_İs
.
	`fšd
(
oid
);

3591 ià(
q
 =ğ
š_´og»ss_´oxy_İs
.
	`’d
()) {

3592 
	`dout
(10è<< 
__func__
 << "‚Øš_´og»ss_´oxy_İ found" << 
d’dl
;

3593 
d–‘e
 
pwİ
->
ùx
;

3594 
pwİ
->
ùx
 = 
NULL
;

3597 
li¡
<
OpReque¡Ref
>& 
š_´og»ss_İ
 = 
q
->
£cÚd
;

3598 
	`as£¹
(
š_´og»ss_İ
.
	`size
());

3599 
li¡
<
OpReque¡Ref
>::
™”©Ü
 
™
 = 
¡d
::
	`fšd
(
š_´og»ss_İ
.
	`begš
(),

3600 
š_´og»ss_İ
.
	`’d
(),

3601 
pwİ
->
İ
);

3602 
	`as£¹
(
™
 !ğ
š_´og»ss_İ
.
	`’d
());

3603 
š_´og»ss_İ
.
	`”a£
(
™
);

3604 ià(
š_´og»ss_İ
.
	`size
() == 0) {

3605 
š_´og»ss_´oxy_İs
.
	`”a£
(
oid
);

3606 } ià(
¡d
::
	`fšd
(
š_´og»ss_İ
.
	`begš
(),

3607 
š_´og»ss_İ
.
	`’d
(),

3608 
pwİ
->
İ
è!ğ
š_´og»ss_İ
.
	`’d
()) {

3609 ià(
pwİ
->
ùx
)

3610 
d–‘e
 
pwİ
->
ùx
;

3611 
pwİ
->
ùx
 = 
NULL
;

3612 
	`dout
(20è<< 
__func__
 << " " << 
oid
 << "id " << 
tid


3614 << 
š_´og»ss_İ
.
	`size
(è<< 
d’dl
;

3618 
osd
->
logg”
->
	`šc
(
l_osd_t›r_´oxy_wr™e
);

3620 cÚ¡ 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDOp*>(
pwİ
->
İ
->
	`g‘_»q
());

3621 
	`as£¹
(
m
 !ğ
NULL
);

3623 ià(!
pwİ
->
£Á_»¶y
) {

3625 
MOSDOpR•ly
 *
»¶y
 = 
pwİ
->
ùx
->reply;

3626 ià(
»¶y
)

3627 
pwİ
->
ùx
->
»¶y
 = 
NULL
;

3629 
»¶y
 = 
Ãw
 
	`MOSDOpR•ly
(
m
, 
r
, 
	`g‘_osdm­
()->
	`g‘_•och
(), 0, 
Œue
);

3630 
»¶y
->
	`£t_»¶y_v”siÚs
(
	`ev”siÚ_t
(), 
pwİ
->
u£r_v”siÚ
);

3632 
»¶y
->
	`add_æags
(
CEPH_OSD_FLAG_ACK
 | 
CEPH_OSD_FLAG_ONDISK
);

3633 
	`dout
(10è<< " s’dšg comm™ oÀ" << 
pwİ
 << " " << 
»¶y
 << 
d’dl
;

3634 
osd
->
	`£nd_mes§ge_osd_ş›Á
(
»¶y
, 
m
->
	`g‘_cÚÃùiÚ
());

3635 
pwİ
->
£Á_»¶y
 = 
Œue
;

3636 
pwİ
->
ùx
->
İ
->
	`m¬k_comm™_£Á
();

3639 
d–‘e
 
pwİ
->
ùx
;

3640 
pwİ
->
ùx
 = 
NULL
;

3641 
	}
}

3643 
	gPrim¬yLogPG
::
ÿnûl_´oxy_wr™e
(
ProxyWr™eOpRef
 
pwİ
,

3644 
veùÜ
<
ûph_tid_t
> *
tids
)

3646 
dout
(10è<< 
	g__func__
 << " " << 
	gpwİ
->
	gsoid
 << 
	gd’dl
;

3647 
	gpwİ
->
	gÿnûËd
 = 
Œue
;

3650 ià(
	gpwİ
->
	gobjeù”_tid
) {

3651 
	gtids
->
push_back
(
pwİ
->
objeù”_tid
);

3652 
d–‘e
 
	gpwİ
->
	gùx
;

3653 
	gpwİ
->
	gùx
 = 
NULL
;

3654 
	g´oxywr™e_İs
.
”a£
(
pwİ
->
objeù”_tid
);

3655 
	gpwİ
->
	gobjeù”_tid
 = 0;

3659 şas 
	cPromÙeC®lback
: 
public
 
Prim¬yLogPG
::
CİyC®lback
 {

3660 
ObjeùCÚ‹xtRef
 
obc
;

3661 
Prim¬yLogPG
 *
	mpg
;

3662 
utime_t
 
	m¡¬t
;

3663 
	mpublic
:

3664 
	$PromÙeC®lback
(
ObjeùCÚ‹xtRef
 
obc_
, 
Prim¬yLogPG
 *
pg_
)

3665 : 
	`obc
(
obc_
),

3666 
	`pg
(
pg_
),

3667 
	`¡¬t
(
	$ûph_şock_now
()) {}

3669 
	$fšish
(
Prim¬yLogPG
::
CİyC®lbackResuÉs
 
»suÉs
è
ov”ride
 {

3670 
Prim¬yLogPG
::
CİyResuÉs
 *
»suÉs_d©a
 = 
»suÉs
.
g‘
<1>();

3671 
r
 = 
»suÉs
.
g‘
<0>();

3672 
pg
->
	`fšish_´omÙe
(
r
, 
»suÉs_d©a
, 
obc
);

3673 
pg
->
osd
->
logg”
->
	`tšc
(
l_osd_t›r_´omÙe_Ït
, 
	`ûph_şock_now
(è- 
¡¬t
);

3674 
	}
}

3677 şas 
	cPromÙeMªiã¡C®lback
: 
public
 
Prim¬yLogPG
::
CİyC®lback
 {

3678 
ObjeùCÚ‹xtRef
 
obc
;

3679 
Prim¬yLogPG
 *
	mpg
;

3680 
utime_t
 
	m¡¬t
;

3681 
	mPrim¬yLogPG
::
OpCÚ‹xt
 *
ùx
;

3682 
	mPrim¬yLogPG
::
CİyC®lbackResuÉs
 
´omÙe_»suÉs
;

3683 
	mpublic
:

3684 
	$PromÙeMªiã¡C®lback
(
ObjeùCÚ‹xtRef
 
obc_
, 
Prim¬yLogPG
 *
pg_
, Prim¬yLogPG::
OpCÚ‹xt
 *
ùx
 = 
NULL
)

3685 : 
	`obc
(
obc_
),

3686 
	`pg
(
pg_
),

3687 
	`¡¬t
(
	`ûph_şock_now
()), 
	$ùx
(
ùx
) {}

3689 
	$fšish
(
Prim¬yLogPG
::
CİyC®lbackResuÉs
 
»suÉs
è
ov”ride
 {

3690 
Prim¬yLogPG
::
CİyResuÉs
 *
»suÉs_d©a
 = 
»suÉs
.
g‘
<1>();

3691 
r
 = 
»suÉs
.
g‘
<0>();

3692 ià(
ùx
) {

3693 
´omÙe_»suÉs
 = 
»suÉs
;

3694 
pg
->
	`execu‹_ùx
(
ùx
);

3696 
pg
->
	`fšish_´omÙe_mªiã¡
(
r
, 
»suÉs_d©a
, 
obc
);

3698 
pg
->
osd
->
logg”
->
	`tšc
(
l_osd_t›r_´omÙe_Ït
, 
	`ûph_şock_now
(è- 
¡¬t
);

3699 
	}
}

3700 
ä›nd
 
	gPromÙeFšish”
;

3703 
	gPromÙeFšish”
 : 
public
 
Prim¬yLogPG
::
OpFšish”
 {

3704 
PromÙeMªiã¡C®lback
 *
´omÙe_ÿÎback
;

3706 
ex¶ic™
 
PromÙeFšish”
(
PromÙeMªiã¡C®lback
 *
´omÙe_ÿÎback
)

3707 : 
´omÙe_ÿÎback
(promote_callback) {

3710 
execu‹
(è
ov”ride
 {

3711 ià(
´omÙe_ÿÎback
->
ùx
->
obc
->
obs
.
oi
.
mªiã¡
.
is_»dœeù
()) {

3712 
´omÙe_ÿÎback
->
ùx
->
pg
->
fšish_´omÙe
ÕromÙe_ÿÎback->
´omÙe_»suÉs
.
g‘
<0>(),

3713 
´omÙe_ÿÎback
->
´omÙe_»suÉs
.
g‘
<1>(),

3714 
´omÙe_ÿÎback
->
obc
);

3715 } ià(
	g´omÙe_ÿÎback
->
	gùx
->
	gobc
->
	gobs
.
	goi
.
	gmªiã¡
.
is_chunked
()) {

3716 
	g´omÙe_ÿÎback
->
	gùx
->
	gpg
->
fšish_´omÙe_mªiã¡
(
´omÙe_ÿÎback
->
´omÙe_»suÉs
.
g‘
<0>(),

3717 
´omÙe_ÿÎback
->
´omÙe_»suÉs
.
g‘
<1>(),

3718 
´omÙe_ÿÎback
->
obc
);

3720 
as£¹
(0 == "unrecognized manifestype");

3726 
	gPrim¬yLogPG
::
	$´omÙe_objeù
(
ObjeùCÚ‹xtRef
 
obc
,

3727 cÚ¡ 
hobjeù_t
& 
missšg_oid
,

3728 cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

3729 
OpReque¡Ref
 
İ
,

3730 
ObjeùCÚ‹xtRef
 *
´omÙe_obc
)

3732 
hobjeù_t
 
hoid
 = 
obc
 ? obc->
obs
.
oi
.
soid
 : 
missšg_oid
;

3733 
	`as£¹
(
hoid
 !ğ
	`hobjeù_t
());

3734 ià(
	`wr™e_blocked_by_süub
(
hoid
)) {

3735 
	`dout
(10è<< 
__func__
 << " " << 
hoid


3736 << " blocked by süub" << 
d’dl
;

3737 ià(
İ
) {

3738 
wa™šg_fÜ_süub
.
	`push_back
(
İ
);

3739 
İ
->
	`m¬k_d–ayed
("waiting for scrub");

3740 
	`dout
(10è<< 
__func__
 << " " << 
hoid


3741 << "…Ïcšg o°š wa™šg_fÜ_süub" << 
d’dl
;

3743 
	`dout
(10è<< 
__func__
 << " " << 
hoid


3744 << "‚Øİ, drİpšg oÀthæoÜ" << 
d’dl
;

3748 ià(!
obc
) {

3749 
	`as£¹
(
missšg_oid
 !ğ
	`hobjeù_t
());

3750 
obc
 = 
	`g‘_objeù_cÚ‹xt
(
missšg_oid
, 
Œue
);

3752 ià(
´omÙe_obc
)

3753 *
´omÙe_obc
 = 
obc
;

3759 
¤c_çdvi£_æags
 = 
LIBRADOS_OP_FLAG_FADVISE_SEQUENTIAL
;

3760 
m­
<
hobjeù_t
, 
li¡
<
OpReque¡Ref
>>::
™”©Ü
 
q
 = 
š_´og»ss_´oxy_İs
.
	`fšd
(
obc
->
obs
.
oi
.
soid
);

3761 ià(
q
 =ğ
š_´og»ss_´oxy_İs
.
	`’d
()) {

3762 
¤c_çdvi£_æags
 |ğ
LIBRADOS_OP_FLAG_FADVISE_DONTNEED
;

3765 
CİyC®lback
 *
cb
;

3766 
objeù_loÿtÜ_t
 
my_Şoc
;

3767 
hobjeù_t
 
¤c_hoid
;

3768 ià(!
obc
->
obs
.
oi
.
	`has_mªiã¡
()) {

3769 
my_Şoc
 = 
Şoc
;

3770 
my_Şoc
.
poŞ
 =…oŞ.
šfo
.
t›r_of
;

3771 
¤c_hoid
 = 
obc
->
obs
.
oi
.
soid
;

3772 
cb
 = 
Ãw
 
	`PromÙeC®lback
(
obc
, 
this
);

3774 ià(
obc
->
obs
.
oi
.
mªiã¡
.
	`is_chunked
()) {

3775 
¤c_hoid
 = 
obc
->
obs
.
oi
.
soid
;

3776 
cb
 = 
Ãw
 
	`PromÙeMªiã¡C®lback
(
obc
, 
this
);

3777 } ià(
obc
->
obs
.
oi
.
mªiã¡
.
	`is_»dœeù
()) {

3778 
objeù_loÿtÜ_t
 
	`¤c_Şoc
(
obc
->
obs
.
oi
.
mªiã¡
.
»dœeù_rg‘
);

3779 
my_Şoc
 = 
¤c_Şoc
;

3780 
¤c_hoid
 = 
obc
->
obs
.
oi
.
mªiã¡
.
»dœeù_rg‘
;

3781 
cb
 = 
Ãw
 
	`PromÙeC®lback
(
obc
, 
this
);

3783 
	`as£¹
(0 == "unrecognized manifestype");

3787 
æags
 = 
CEPH_OSD_COPY_FROM_FLAG_IGNORE_OVERLAY
 |

3788 
CEPH_OSD_COPY_FROM_FLAG_IGNORE_CACHE
 |

3789 
CEPH_OSD_COPY_FROM_FLAG_MAP_SNAP_CLONE
 |

3790 
CEPH_OSD_COPY_FROM_FLAG_RWORDERED
;

3791 
	`¡¬t_cİy
(
cb
, 
obc
, 
¤c_hoid
, 
my_Şoc
, 0, 
æags
,

3792 
obc
->
obs
.
oi
.
soid
.
¢­
 =ğ
CEPH_NOSNAP
,

3793 
¤c_çdvi£_æags
, 0);

3795 
	`as£¹
(
obc
->
	`is_blocked
());

3797 ià(
İ
)

3798 
	`wa™_fÜ_blocked_objeù
(
obc
->
obs
.
oi
.
soid
, 
İ
);

3799 
šfo
.
¡©s
.¡©s.
sum
.
num_´omÙe
++;

3800 
	}
}

3802 
	gPrim¬yLogPG
::
	$execu‹_ùx
(
OpCÚ‹xt
 *
ùx
)

3804 
	`FUNCTRACE
(
cù
);

3805 
	`dout
(10è<< 
__func__
 << " " << 
ùx
 << 
d’dl
;

3806 
ùx
->
	`»£t_obs
(ùx->
obc
);

3807 
ùx
->
upd©e_log_Úly
 = 
çl£
;

3808 
OpReque¡Ref
 
İ
 = 
ùx
->op;

3809 cÚ¡ 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDOp*>(
İ
->
	`g‘_»q
());

3810 
ObjeùCÚ‹xtRef
 
obc
 = 
ùx
->obc;

3811 cÚ¡ 
hobjeù_t
& 
soid
 = 
obc
->
obs
.
oi
.soid;

3815 
ùx
->
İ_t
.
	`»£t
(
Ãw
 
PGT¿n§ùiÚ
);

3817 ià(
İ
->
	`may_wr™e
(è|| op->
	`may_ÿche
()) {

3819 ià(!(
m
->
	`has_æag
(
CEPH_OSD_FLAG_ENFORCE_SNAPC
)) &&

3820 
poŞ
.
šfo
.
	`is_poŞ_¢­s_mode
()) {

3822 
ùx
->
¢­c
 = 
poŞ
.snapc;

3825 
ùx
->
¢­c
.
£q
 = 
m
->
	`g‘_¢­_£q
();

3826 
ùx
->
¢­c
.
¢­s
 = 
m
->
	`g‘_¢­s
();

3827 
	`f‹r_¢­c
(
ùx
->
¢­c
.
¢­s
);

3829 ià((
m
->
	`has_æag
(
CEPH_OSD_FLAG_ORDERSNAP
)) &&

3830 
ùx
->
¢­c
.
£q
 < 
obc
->
ssc
->
¢­£t
.seq) {

3831 
	`dout
(10è<< " ORDERSNAP fÏg s‘‡nd sÇpø£q " << 
ùx
->
¢­c
.
£q


3832 << " < sÇp£ˆ£q " << 
obc
->
ssc
->
¢­£t
.
£q


3833 << " oÀ" << 
obc
->
obs
.
oi
.
soid
 << 
d’dl
;

3834 
	`»¶y_ùx
(
ùx
, -
EOLDSNAPC
);

3839 
ùx
->
©_v”siÚ
 = 
	`g‘_Ãxt_v”siÚ
();

3840 
ùx
->
mtime
 = 
m
->
	`g‘_mtime
();

3842 
	`dout
(10è<< 
__func__
 << " " << 
soid
 << " " << *
ùx
->
İs


3843 << " ov " << 
obc
->
obs
.
oi
.
v”siÚ
 << "‡v " << 
ùx
->
©_v”siÚ


3844 << " sÇpø" << 
ùx
->
¢­c


3845 << " sÇp£ˆ" << 
obc
->
ssc
->
¢­£t


3846 << 
d’dl
;

3848 
	`dout
(10è<< 
__func__
 << " " << 
soid
 << " " << *
ùx
->
İs


3849 << " ov " << 
obc
->
obs
.
oi
.
v”siÚ


3850 << 
d’dl
;

3853 ià(!
ùx
->
u£r_©_v”siÚ
)

3854 
ùx
->
u£r_©_v”siÚ
 = 
obc
->
obs
.
oi
.
u£r_v”siÚ
;

3855 
	`dout
(30è<< 
__func__
 << " u£r_©_v”siÚ " << 
ùx
->
u£r_©_v”siÚ
 << 
d’dl
;

3858 #ifdeà
WITH_LTTNG


3859 
osd_»qid_t
 
»qid
 = 
ùx
->
İ
->
	`g‘_»qid
();

3861 
	`Œaûpošt
(
osd
, 
´•¬e_tx_’‹r
, 
»qid
.
Çme
.
_ty³
,

3862 
»qid
.
Çme
.
_num
,„eqid.
tid
,„eqid.
šc
);

3865 
»suÉ
 = 
	`´•¬e_Œª§ùiÚ
(
ùx
);

3868 #ifdeà
WITH_LTTNG


3869 
osd_»qid_t
 
»qid
 = 
ùx
->
İ
->
	`g‘_»qid
();

3871 
	`Œaûpošt
(
osd
, 
´•¬e_tx_ex™
, 
»qid
.
Çme
.
_ty³
,

3872 
»qid
.
Çme
.
_num
,„eqid.
tid
,„eqid.
šc
);

3875 
boŞ
 
³ndšg_async_»ads
 = !
ùx
->³ndšg_async_»ads.
	`em±y
();

3876 ià(
»suÉ
 =ğ-
EINPROGRESS
 || 
³ndšg_async_»ads
) {

3878 ià(
³ndšg_async_»ads
) {

3879 
	`as£¹
(
poŞ
.
šfo
.
	`is_”asu»
());

3880 
š_´og»ss_async_»ads
.
	`push_back
(
	`make_·œ
(
İ
, 
ùx
));

3881 
ùx
->
	`¡¬t_async_»ads
(
this
);

3886 ià(
»suÉ
 =ğ-
EAGAIN
) {

3888 
	`şo£_İ_ùx
(
ùx
);

3892 
boŞ
 
sucûssful_wr™e
 = !
ùx
->
İ_t
->
	`em±y
(è&& 
İ
->
	`may_wr™e
(è&& 
»suÉ
 >= 0;

3894 
ùx
->
»¶y
 = 
Ãw
 
	`MOSDOpR•ly
(
m
, 0, 
	`g‘_osdm­
()->
	`g‘_•och
(), 0,

3895 
sucûssful_wr™e
);

3904 ià(
sucûssful_wr™e
) {

3906 
	`dout
(20è<< " z”ošg wr™»suÉ cod" << 
»suÉ
 << 
d’dl
;

3907 
»suÉ
 = 0;

3909 
ùx
->
»¶y
->
	`£t_»suÉ
(
»suÉ
);

3912 ià((
ùx
->
İ_t
->
	`em±y
(è|| 
»suÉ
 < 0è&& !ùx->
upd©e_log_Úly
) {

3914 ià(
»suÉ
 >= 0)

3915 
	`do_osd_İ_efãùs
(
ùx
, 
m
->
	`g‘_cÚÃùiÚ
());

3917 
	`com¶‘e_»ad_ùx
(
»suÉ
, 
ùx
);

3921 
ùx
->
»¶y
->
	`£t_»¶y_v”siÚs
(ùx->
©_v”siÚ
, ctx->
u£r_©_v”siÚ
);

3923 
	`as£¹
(
İ
->
	`may_wr™e
(è|| op->
	`may_ÿche
());

3926 
	`ÿlc_Œim_to
();

3929 ià(
cù
->
_cÚf
->
osd_debug_İ_Üd”
 && 
m
->
	`g‘_sourû
().
	`is_ş›Á
() &&

3930 !
poŞ
.
šfo
.
	`is_t›r
(è&& !poŞ.šfo.
	`has_t›rs
()) {

3931 
m­
<
ş›Á_t
,
ûph_tid_t
>& 
cm
 = 
debug_İ_Üd”
[
obc
->
obs
.
oi
.
soid
];

3932 
ûph_tid_t
 
t
 = 
m
->
	`g‘_tid
();

3933 
ş›Á_t
 
n
 = 
m
->
	`g‘_sourû
().
	`num
();

3934 
m­
<
ş›Á_t
,
ûph_tid_t
>::
™”©Ü
 
p
 = 
cm
.
	`fšd
(
n
);

3935 ià(
p
 =ğ
cm
.
	`’d
()) {

3936 
	`dout
(20è<< " o°Üd” cl›Á." << 
n
 << "id " << 
t
 << " (fœ¡)" << 
d’dl
;

3937 
cm
[
n
] = 
t
;

3939 
	`dout
(20è<< " o°Üd” cl›Á." << 
n
 << "id " << 
t
 << "†a¡ wa " << 
p
->
£cÚd
 << 
d’dl
;

3940 ià(
p
->
£cÚd
 > 
t
) {

3941 
d”r
 << "bad o°Üd”,‡Ì—dy‡µl›d " << 
p
->
£cÚd
 << " >hi " << 
t
 << 
d’dl
;

3942 
	`as£¹
(0 == "out of order op");

3944 
p
->
£cÚd
 = 
t
;

3948 ià(
ùx
->
upd©e_log_Úly
) {

3949 ià(
»suÉ
 >= 0)

3950 
	`do_osd_İ_efãùs
(
ùx
, 
m
->
	`g‘_cÚÃùiÚ
());

3952 
	`dout
(20è<< 
__func__
 << " upd©e_log_Úly --„esuÉ=" << 
»suÉ
 << 
d’dl
;

3954 
MOSDOpR•ly
 *
»¶y
 = 
ùx
->reply;

3955 
ùx
->
»¶y
 = 
nuÎ±r
;

3956 
»¶y
->
	`şaim_İ_out_d©a
(*
ùx
->
İs
);

3957 
»¶y
->
	`g‘_h—d”
().
d©a_off
 = (
ùx
->data_off ? *ctx->data_off : 0);

3958 
	`şo£_İ_ùx
(
ùx
);

3960 ià(
»suÉ
 =ğ-
ENOENT
) {

3961 
»¶y
->
	`£t_’ÛÁ_»¶y_v”siÚs
(
šfo
.
Ï¡_upd©e
,

3962 
šfo
.
Ï¡_u£r_v”siÚ
);

3964 
»¶y
->
	`add_æags
(
CEPH_OSD_FLAG_ACK
 | 
CEPH_OSD_FLAG_ONDISK
);

3966 
	`»cÜd_wr™e_”rÜ
(
İ
, 
soid
, 
»¶y
, 
»suÉ
);

3972 
ùx
->
	`»gi¡”_Ú_comm™
(

3973 [
m
, 
ùx
, 
this
](){

3974 ià(
ùx
->
İ
)

3975 
	`log_İ_¡©s
(

3976 
ùx
);

3978 ià(
m
 && !
ùx
->
£Á_»¶y
) {

3979 
MOSDOpR•ly
 *
»¶y
 = 
ùx
->reply;

3980 ià(
»¶y
)

3981 
ùx
->
»¶y
 = 
nuÎ±r
;

3983 
»¶y
 = 
Ãw
 
	`MOSDOpR•ly
(
m
, 0, 
	`g‘_osdm­
()->
	`g‘_•och
(), 0, 
Œue
);

3984 
»¶y
->
	`£t_»¶y_v”siÚs
(
ùx
->
©_v”siÚ
,

3985 
ùx
->
u£r_©_v”siÚ
);

3987 
»¶y
->
	`add_æags
(
CEPH_OSD_FLAG_ACK
 | 
CEPH_OSD_FLAG_ONDISK
);

3988 
	`dout
(10è<< " s’dšg„•ly oÀ" << *
m
 << " " << 
»¶y
 << 
d’dl
;

3989 
osd
->
	`£nd_mes§ge_osd_ş›Á
(
»¶y
, 
m
->
	`g‘_cÚÃùiÚ
());

3990 
ùx
->
£Á_»¶y
 = 
Œue
;

3991 
ùx
->
İ
->
	`m¬k_comm™_£Á
();

3994 
ùx
->
	`»gi¡”_Ú_sucûss
(

3995 [
ùx
, 
this
]() {

3996 
	`do_osd_İ_efãùs
(

3997 
ùx
,

3998 
ùx
->
İ
 ? ctx->İ->
	`g‘_»q
()->
	`g‘_cÚÃùiÚ
() :

3999 
	`CÚÃùiÚRef
());

4001 
ùx
->
	`»gi¡”_Ú_fšish
(

4002 [
ùx
]() {

4003 
d–‘e
 
ùx
;

4007 
ûph_tid_t
 
»p_tid
 = 
osd
->
	`g‘_tid
();

4009 
R•G©h”
 *
»pİ
 = 
	`Ãw_»pİ
(
ùx
, 
obc
, 
»p_tid
);

4011 
	`issue_»pİ
(
»pİ
, 
ùx
);

4012 
	`ev®_»pİ
(
»pİ
);

4013 
»pİ
->
	`put
();

4014 
	}
}

4016 
	gPrim¬yLogPG
::
	$şo£_İ_ùx
(
OpCÚ‹xt
 *
ùx
) {

4017 
	`»Ëa£_objeù_locks
(
ùx
->
lock_mªag”
);

4019 
ùx
->
İ_t
.
	`»£t
();

4021 autØ
p
 = 
ùx
->
Ú_fšish
.
	`begš
();… !ğùx->Ú_fšish.
	`’d
();

4022 
ùx
->
Ú_fšish
.
	`”a£
(
p
++)) {

4023 (*
p
)();

4025 
d–‘e
 
ùx
;

4026 
	}
}

4028 
	gPrim¬yLogPG
::
	$»¶y_ùx
(
OpCÚ‹xt
 *
ùx
, 
r
)

4030 ià(
ùx
->
İ
)

4031 
osd
->
	`»¶y_İ_”rÜ
(
ùx
->
İ
, 
r
);

4032 
	`şo£_İ_ùx
(
ùx
);

4033 
	}
}

4035 
	gPrim¬yLogPG
::
	$»¶y_ùx
(
OpCÚ‹xt
 *
ùx
, 
r
, 
ev”siÚ_t
 
v
, 
v”siÚ_t
 
uv
)

4037 ià(
ùx
->
İ
)

4038 
osd
->
	`»¶y_İ_”rÜ
(
ùx
->
İ
, 
r
, 
v
, 
uv
);

4039 
	`şo£_İ_ùx
(
ùx
);

4040 
	}
}

4042 
	gPrim¬yLogPG
::
	$log_İ_¡©s
(
OpCÚ‹xt
 *
ùx
)

4044 
OpReque¡Ref
 
İ
 = 
ùx
->op;

4045 cÚ¡ 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDOp*>(
İ
->
	`g‘_»q
());

4047 
utime_t
 
now
 = 
	`ûph_şock_now
();

4048 
utime_t
 
Ï‹ncy
 = 
now
;

4049 
Ï‹ncy
 -ğ
ùx
->
İ
->
	`g‘_»q
()->
	`g‘_»cv_¡amp
();

4050 
utime_t
 
´oûss_Ï‹ncy
 = 
now
;

4051 
´oûss_Ï‹ncy
 -ğ
ùx
->
İ
->
	`g‘_dequeued_time
();

4053 
ušt64_t
 
šb
 = 
ùx
->
by‹s_wr™‹n
;

4054 
ušt64_t
 
outb
 = 
ùx
->
by‹s_»ad
;

4056 
osd
->
logg”
->
	`šc
(
l_osd_İ
);

4058 
osd
->
logg”
->
	`šc
(
l_osd_İ_outb
, 
outb
);

4059 
osd
->
logg”
->
	`šc
(
l_osd_İ_šb
, 
šb
);

4060 
osd
->
logg”
->
	`tšc
(
l_osd_İ_Ït
, 
Ï‹ncy
);

4061 
osd
->
logg”
->
	`tšc
(
l_osd_İ_´oûss_Ït
, 
´oûss_Ï‹ncy
);

4063 ià(
İ
->
	`may_»ad
(è&& op->
	`may_wr™e
()) {

4064 
osd
->
logg”
->
	`šc
(
l_osd_İ_rw
);

4065 
osd
->
logg”
->
	`šc
(
l_osd_İ_rw_šb
, 
šb
);

4066 
osd
->
logg”
->
	`šc
(
l_osd_İ_rw_outb
, 
outb
);

4067 
osd
->
logg”
->
	`tšc
(
l_osd_İ_rw_Ït
, 
Ï‹ncy
);

4068 
osd
->
logg”
->
	`hšc
(
l_osd_İ_rw_Ït_šb_hi¡
, 
Ï‹ncy
.
	`to_n£c
(), 
šb
);

4069 
osd
->
logg”
->
	`hšc
(
l_osd_İ_rw_Ït_outb_hi¡
, 
Ï‹ncy
.
	`to_n£c
(), 
outb
);

4070 
osd
->
logg”
->
	`tšc
(
l_osd_İ_rw_´oûss_Ït
, 
´oûss_Ï‹ncy
);

4071 } ià(
İ
->
	`may_»ad
()) {

4072 
osd
->
logg”
->
	`šc
(
l_osd_İ_r
);

4073 
osd
->
logg”
->
	`šc
(
l_osd_İ_r_outb
, 
outb
);

4074 
osd
->
logg”
->
	`tšc
(
l_osd_İ_r_Ït
, 
Ï‹ncy
);

4075 
osd
->
logg”
->
	`hšc
(
l_osd_İ_r_Ït_outb_hi¡
, 
Ï‹ncy
.
	`to_n£c
(), 
outb
);

4076 
osd
->
logg”
->
	`tšc
(
l_osd_İ_r_´oûss_Ït
, 
´oûss_Ï‹ncy
);

4077 } ià(
İ
->
	`may_wr™e
(è|| op->
	`may_ÿche
()) {

4078 
osd
->
logg”
->
	`šc
(
l_osd_İ_w
);

4079 
osd
->
logg”
->
	`šc
(
l_osd_İ_w_šb
, 
šb
);

4080 
osd
->
logg”
->
	`tšc
(
l_osd_İ_w_Ït
, 
Ï‹ncy
);

4081 
osd
->
logg”
->
	`hšc
(
l_osd_İ_w_Ït_šb_hi¡
, 
Ï‹ncy
.
	`to_n£c
(), 
šb
);

4082 
osd
->
logg”
->
	`tšc
(
l_osd_İ_w_´oûss_Ït
, 
´oûss_Ï‹ncy
);

4084 
	`ûph_abÜt
();

4086 
	`dout
(15è<< "log_İ_¡© " << *
m


4087 << " inb " << 
šb


4088 << " outb " << 
outb


4089 << "†© " << 
Ï‹ncy
 << 
d’dl
;

4090 
	}
}

4092 
	gPrim¬yLogPG
::
	$do_sÿn
(

4093 
OpReque¡Ref
 
İ
,

4094 
Th»adPoŞ
::
TPHªdË
 &
hªdË
)

4096 cÚ¡ 
MOSDPGSÿn
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDPGSÿn*>(
İ
->
	`g‘_»q
());

4097 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
MSG_OSD_PG_SCAN
);

4098 
	`dout
(10è<< "do_sÿÀ" << *
m
 << 
d’dl
;

4100 
İ
->
	`m¬k_¡¬‹d
();

4102 
m
->
İ
) {

4103 
MOSDPGSÿn
::
OP_SCAN_GET_DIGEST
:

4105 autØ
dµ
 = 
	`g‘_dµ
();

4106 ià(
osd
->
	`check_backfl_fuÎ
(
dµ
)) {

4107 
	`dout
(1è<< 
__func__
 << ": Cªûlšg backfl: FuÎ." << 
d’dl
;

4108 
	`queue_³”šg_ev’t
(

4109 
	`PGP“ršgEv’tRef
(

4110 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

4111 
	`g‘_osdm­
()->
	`g‘_•och
(),

4112 
	`g‘_osdm­
()->
	`g‘_•och
(),

4113 
	`BackflTooFuÎ
())));

4117 
BackflIÁ”v®
 
bi
;

4118 
bi
.
begš
 = 
m
->begin;

4121 
	`sÿn_¿nge
(

4122 
cù
->
_cÚf
->
osd_backfl_sÿn_mš
,

4123 
cù
->
_cÚf
->
osd_backfl_sÿn_max
,

4124 &
bi
,

4125 
hªdË
);

4126 
MOSDPGSÿn
 *
»¶y
 = 
Ãw
 
	`MOSDPGSÿn
(

4127 
MOSDPGSÿn
::
OP_SCAN_DIGEST
,

4128 
pg_whßmi
,

4129 
	`g‘_osdm­
()->
	`g‘_•och
(), 
m
->
qu”y_•och
,

4130 
	`¥g_t
(
šfo
.
pgid
.pgid, 
	`g‘_´im¬y
().
sh¬d
), 
bi
.
begš
, bi.
’d
);

4131 
	`’code
(
bi
.
objeùs
, 
»¶y
->
	`g‘_d©a
());

4132 
osd
->
	`£nd_mes§ge_osd_şu¡”
(
»¶y
, 
m
->
	`g‘_cÚÃùiÚ
());

4136 
MOSDPGSÿn
::
OP_SCAN_DIGEST
:

4138 
pg_sh¬d_t
 
äom
 = 
m
->from;

4141 
	`as£¹
(
	`is_backfl_rg‘s
(
äom
));

4143 
BackflIÁ”v®
& 
bi
 = 
³”_backfl_šfo
[
äom
];

4144 
bi
.
begš
 = 
m
->begin;

4145 
bi
.
’d
 = 
m
->end;

4146 
bufã¾i¡
::
™”©Ü
 
p
 = 
cÚ¡_ÿ¡
<bufã¾i¡&>(
m
->
	`g‘_d©a
()).
	`begš
();

4149 
bi
.
	`ş—r_objeùs
();

4150 ::
	`decode_noş—r
(
bi
.
objeùs
, 
p
);

4152 ià(
wa™šg_Ú_backfl
.
	`”a£
(
äom
)) {

4153 ià(
wa™šg_Ú_backfl
.
	`em±y
()) {

4154 
	`as£¹
(
³”_backfl_šfo
.
	`size
(è=ğ
backfl_rg‘s
.size());

4155 
	`fšish_»cov”y_İ
(
hobjeù_t
::
	`g‘_max
());

4164 
	}
}

4166 
	gPrim¬yLogPG
::
	$do_backfl
(
OpReque¡Ref
 
İ
)

4168 cÚ¡ 
MOSDPGBackfl
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDPGBackfl*>(
İ
->
	`g‘_»q
());

4169 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
MSG_OSD_PG_BACKFILL
);

4170 
	`dout
(10è<< "do_backfÈ" << *
m
 << 
d’dl
;

4172 
İ
->
	`m¬k_¡¬‹d
();

4174 
m
->
İ
) {

4175 
MOSDPGBackfl
::
OP_BACKFILL_FINISH
:

4177 
	`as£¹
(
cù
->
_cÚf
->
osd_kl_backfl_©
 != 1);

4179 
MOSDPGBackfl
 *
»¶y
 = 
Ãw
 
	`MOSDPGBackfl
(

4180 
MOSDPGBackfl
::
OP_BACKFILL_FINISH_ACK
,

4181 
	`g‘_osdm­
()->
	`g‘_•och
(),

4182 
m
->
qu”y_•och
,

4183 
	`¥g_t
(
šfo
.
pgid
.pgid, 
	`g‘_´im¬y
().
sh¬d
));

4184 
»¶y
->
	`£t_´iÜ™y
(
	`g‘_»cov”y_İ_´iÜ™y
());

4185 
osd
->
	`£nd_mes§ge_osd_şu¡”
(
»¶y
, 
m
->
	`g‘_cÚÃùiÚ
());

4186 
	`queue_³”šg_ev’t
(

4187 
	`PGP“ršgEv’tRef
(

4188 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

4189 
	`g‘_osdm­
()->
	`g‘_•och
(),

4190 
	`g‘_osdm­
()->
	`g‘_•och
(),

4191 
	`Recov”yDÚe
())));

4195 
MOSDPGBackfl
::
OP_BACKFILL_PROGRESS
:

4197 
	`as£¹
(
cù
->
_cÚf
->
osd_kl_backfl_©
 != 2);

4199 
šfo
.
	`£t_Ï¡_backfl
(
m
->
Ï¡_backfl
);

4200 
šfo
.
¡©s
 = 
m
->stats;

4202 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

4203 
dœty_šfo
 = 
Œue
;

4204 
	`wr™e_if_dœty
(
t
);

4205 
Œ
 = 
osd
->
¡Üe
->
	`queue_Œª§ùiÚ
(
ch
, 
¡d
::
	`move
(
t
), 
NULL
);

4206 
	`as£¹
(
Œ
 == 0);

4210 
MOSDPGBackfl
::
OP_BACKFILL_FINISH_ACK
:

4212 
	`as£¹
(
	`is_´im¬y
());

4213 
	`as£¹
(
cù
->
_cÚf
->
osd_kl_backfl_©
 != 3);

4214 
	`fšish_»cov”y_İ
(
hobjeù_t
::
	`g‘_max
());

4218 
	}
}

4220 
	gPrim¬yLogPG
::
	$do_backfl_»move
(
OpReque¡Ref
 
İ
)

4222 cÚ¡ 
MOSDPGBackflRemove
 *
m
 = 
¡©ic_ÿ¡
<const MOSDPGBackfillRemove*>(

4223 
İ
->
	`g‘_»q
());

4224 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
MSG_OSD_PG_BACKFILL_REMOVE
);

4225 
	`dout
(7è<< 
__func__
 << " " << 
m
->
ls
 << 
d’dl
;

4227 
İ
->
	`m¬k_¡¬‹d
();

4229 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

4230 auto& 
p
 : 
m
->
ls
) {

4231 
	`»move_¢­_m­³d_objeù
(
t
, 
p
.
fœ¡
);

4233 
r
 = 
osd
->
¡Üe
->
	`queue_Œª§ùiÚ
(
ch
, 
¡d
::
	`move
(
t
), 
NULL
);

4234 
	`as£¹
(
r
 == 0);

4235 
	}
}

4237 
	gPrim¬yLogPG
::
	$Œim_objeù
(

4238 
boŞ
 
fœ¡
, cÚ¡ 
hobjeù_t
 &
coid
, 
Prim¬yLogPG
::
OpCÚ‹xtUPŒ
 *
ùxp
)

4240 *
ùxp
 = 
NULL
;

4243 
bufã¾i¡
 
bl
;

4244 
ObjeùCÚ‹xtRef
 
obc
 = 
	`g‘_objeù_cÚ‹xt
(
coid
, 
çl£
, 
NULL
);

4245 ià(!
obc
 || !obc->
ssc
 || !obc->ssc->
exi¡s
) {

4246 
osd
->
şog
->
	`”rÜ
(è<< 
__func__
 << ": Cª‚Ùrim " << 
coid


4247 << "„•aœ‚“ded " << (
obc
 ? "(no obc->ssc or !exists)" : "(no obc)");

4248  -
ENOENT
;

4251 
hobjeù_t
 
h—d_oid
 = 
coid
.
	`g‘_h—d
();

4252 
ObjeùCÚ‹xtRef
 
h—d_obc
 = 
	`g‘_objeù_cÚ‹xt
(
h—d_oid
, 
çl£
);

4253 ià(!
h—d_obc
) {

4254 
osd
->
şog
->
	`”rÜ
(è<< 
__func__
 << ": Cª‚Ùrim " << 
coid


4255 << "„•aœ‚“ded,‚Ø¢­£ˆobøfÜ " << 
h—d_oid
;

4256  -
ENOENT
;

4259 
SÇpS‘
& 
¢­£t
 = 
obc
->
ssc
->snapset;

4261 
objeù_šfo_t
 &
coi
 = 
obc
->
obs
.
oi
;

4262 autØ
c™”
 = 
¢­£t
.
şÚe_¢­s
.
	`fšd
(
coid
.
¢­
);

4263 ià(
c™”
 =ğ
¢­£t
.
şÚe_¢­s
.
	`’d
()) {

4264 
osd
->
şog
->
	`”rÜ
(è<< "NØşÚe_¢­ š sÇp£ˆ" << 
¢­£t


4265 << " fÜ objeù " << 
coid
 << "\n";

4266  -
ENOENT
;

4268 
£t
<
¢­id_t
> 
	`Şd_¢­s
(
c™”
->
£cÚd
.
	`begš
(), c™”->£cÚd.
	`’d
());

4269 ià(
Şd_¢­s
.
	`em±y
()) {

4270 
osd
->
şog
->
	`”rÜ
(è<< "NØobjeù infØ¢­ fÜ objeù " << 
coid
;

4271  -
ENOENT
;

4274 
	`dout
(10è<< 
coid
 << " old_¢­ " << 
Şd_¢­s


4275 << " old sÇp£ˆ" << 
¢­£t
 << 
d’dl
;

4276 ià(
¢­£t
.
£q
 == 0) {

4277 
osd
->
şog
->
	`”rÜ
(è<< "NØ¢­£t.£q fÜ objeù " << 
coid
;

4278  -
ENOENT
;

4281 
£t
<
¢­id_t
> 
Ãw_¢­s
;

4282 
£t
<
¢­id_t
>::
™”©Ü
 
i
 = 
Şd_¢­s
.
	`begš
();

4283 
i
 !ğ
Şd_¢­s
.
	`’d
();

4284 ++
i
) {

4285 ià(!
poŞ
.
šfo
.
	`is_»moved_¢­
(*
i
))

4286 
Ãw_¢­s
.
	`š£¹
(*
i
);

4289 
veùÜ
<
¢­id_t
>::
™”©Ü
 
p
 = 
¢­£t
.
şÚes
.
	`’d
();

4291 ià(
Ãw_¢­s
.
	`em±y
()) {

4292 
p
 = 
¡d
::
	`fšd
(
¢­£t
.
şÚes
.
	`begš
(), sÇp£t.şÚes.
	`’d
(), 
coid
.
¢­
);

4293 ià(
p
 =ğ
¢­£t
.
şÚes
.
	`’d
()) {

4294 
osd
->
şog
->
	`”rÜ
(è<< "SÇ°" << 
coid
.
¢­
 << "‚ot in clones";

4295  -
ENOENT
;

4299 
OpCÚ‹xtUPŒ
 
ùx
 = 
	`sim¶e_İc_ü—‹
(
obc
);

4300 
ùx
->
h—d_obc
 = head_obc;

4302 ià(!
ùx
->
lock_mªag”
.
	`g‘_¢­Œimm”_wr™e
(

4303 
coid
,

4304 
obc
,

4305 
fœ¡
)) {

4306 
	`şo£_İ_ùx
(
ùx
.
	`»Ëa£
());

4307 
	`dout
(10è<< 
__func__
 << ": UÇbËØg‘‡ wlock oÀ" << 
coid
 << 
d’dl
;

4308  -
ENOLCK
;

4311 ià(!
ùx
->
lock_mªag”
.
	`g‘_¢­Œimm”_wr™e
(

4312 
h—d_oid
,

4313 
h—d_obc
,

4314 
fœ¡
)) {

4315 
	`şo£_İ_ùx
(
ùx
.
	`»Ëa£
());

4316 
	`dout
(10è<< 
__func__
 << ": UÇbËØg‘‡ wlock oÀ" << 
h—d_oid
 << 
d’dl
;

4317  -
ENOLCK
;

4320 
ùx
->
©_v”siÚ
 = 
	`g‘_Ãxt_v”siÚ
();

4322 
PGT¿n§ùiÚ
 *
t
 = 
ùx
->
İ_t
.
	`g‘
();

4324 ià(
Ãw_¢­s
.
	`em±y
()) {

4326 
	`dout
(10è<< 
coid
 << " sÇp " << 
Şd_¢­s
 << " -> "

4327 << 
Ãw_¢­s
 << " ... d–‘šg" << 
d’dl
;

4330 
	`as£¹
(
p
 !ğ
¢­£t
.
şÚes
.
	`’d
());

4332 
¢­id_t
 
Ï¡
 = 
coid
.
¢­
;

4333 
ùx
->
d–_¡©s
.
num_by‹s
 -ğ
¢­£t
.
	`g‘_şÚe_by‹s
(
Ï¡
);

4335 ià(
p
 !ğ
¢­£t
.
şÚes
.
	`begš
()) {

4337 
veùÜ
<
¢­id_t
>::
™”©Ü
 
n
 = 
p
 - 1;

4338 
hobjeù_t
 
´ev_coid
 = 
coid
;

4339 
´ev_coid
.
¢­
 = *
n
;

4340 
boŞ
 
adju¡_´ev_by‹s
 = 
	`is_´e£Á_şÚe
(
´ev_coid
);

4342 ià(
adju¡_´ev_by‹s
)

4343 
ùx
->
d–_¡©s
.
num_by‹s
 -ğ
¢­£t
.
	`g‘_şÚe_by‹s
(*
n
);

4345 
¢­£t
.
şÚe_ov”Ïp
[*
n
].
	`š‹r£ùiÚ_of
(

4346 
¢­£t
.
şÚe_ov”Ïp
[*
p
]);

4348 ià(
adju¡_´ev_by‹s
)

4349 
ùx
->
d–_¡©s
.
num_by‹s
 +ğ
¢­£t
.
	`g‘_şÚe_by‹s
(*
n
);

4351 
ùx
->
d–_¡©s
.
num_objeùs
--;

4352 ià(
coi
.
	`is_dœty
())

4353 
ùx
->
d–_¡©s
.
num_objeùs_dœty
--;

4354 ià(
coi
.
	`is_om­
())

4355 
ùx
->
d–_¡©s
.
num_objeùs_om­
--;

4356 ià(
coi
.
	`is_wh™eout
()) {

4357 
	`dout
(20è<< 
__func__
 << "rimmšg wh™eouˆÚ " << 
coid
 << 
d’dl
;

4358 
ùx
->
d–_¡©s
.
num_wh™eouts
--;

4360 
ùx
->
d–_¡©s
.
num_objeù_şÚes
--;

4361 ià(
coi
.
	`is_ÿche_pšÃd
())

4362 
ùx
->
d–_¡©s
.
num_objeùs_pšÃd
--;

4363 ià(
coi
.
	`has_mªiã¡
())

4364 
ùx
->
d–_¡©s
.
num_objeùs_mªiã¡
--;

4365 
obc
->
obs
.
exi¡s
 = 
çl£
;

4367 
¢­£t
.
şÚes
.
	`”a£
(
p
);

4368 
¢­£t
.
şÚe_ov”Ïp
.
	`”a£
(
Ï¡
);

4369 
¢­£t
.
şÚe_size
.
	`”a£
(
Ï¡
);

4370 
¢­£t
.
şÚe_¢­s
.
	`”a£
(
Ï¡
);

4372 
ùx
->
log
.
	`push_back
(

4373 
	`pg_log_’Œy_t
(

4374 
pg_log_’Œy_t
::
DELETE
,

4375 
coid
,

4376 
ùx
->
©_v”siÚ
,

4377 
ùx
->
obs
->
oi
.
v”siÚ
,

4379 
	`osd_»qid_t
(),

4380 
ùx
->
mtime
,

4383 
t
->
	`»move
(
coid
);

4384 
t
->
	`upd©e_¢­s
(

4385 
coid
,

4386 
Şd_¢­s
,

4387 
Ãw_¢­s
);

4389 
coi
 = 
	`objeù_šfo_t
(
coid
);

4391 
ùx
->
©_v”siÚ
.
v”siÚ
++;

4394 
	`dout
(10è<< 
coid
 << " sÇp " << 
Şd_¢­s
 << " -> " << 
Ãw_¢­s
 << 
d’dl
;

4395 
¢­£t
.
şÚe_¢­s
[
coid
.
¢­
] =

4396 
veùÜ
<
¢­id_t
>(
Ãw_¢­s
.
	`rbegš
(),‚ew_¢­s.
	`»nd
());

4400 
coi
.
´iÜ_v”siÚ
 = coi.
v”siÚ
;

4401 
coi
.
v”siÚ
 = 
ùx
->
©_v”siÚ
;

4402 
bl
.
	`ş—r
();

4403 
	`’code
(
coi
, 
bl
, 
	`g‘_osdm­
()->
	`g‘_ã©u»s
(
CEPH_ENTITY_TYPE_OSD
, 
nuÎ±r
));

4404 
t
->
	`£‰r
(
coid
, 
OI_ATTR
, 
bl
);

4406 
ùx
->
log
.
	`push_back
(

4407 
	`pg_log_’Œy_t
(

4408 
pg_log_’Œy_t
::
MODIFY
,

4409 
coid
,

4410 
coi
.
v”siÚ
,

4411 
coi
.
´iÜ_v”siÚ
,

4413 
	`osd_»qid_t
(),

4414 
ùx
->
mtime
,

4417 
ùx
->
©_v”siÚ
.
v”siÚ
++;

4419 
t
->
	`upd©e_¢­s
(

4420 
coid
,

4421 
Şd_¢­s
,

4422 
Ãw_¢­s
);

4426 
	`dout
(10è<< 
coid
 << "‚ew sÇp£ˆ" << 
¢­£t
 << " on "

4427 << 
h—d_obc
->
obs
.
oi
 << 
d’dl
;

4428 ià(
¢­£t
.
şÚes
.
	`em±y
() &&

4429 (
h—d_obc
->
obs
.
oi
.
	`is_wh™eout
() &&

4430 !(
h—d_obc
->
obs
.
oi
.
	`is_dœty
(è&& 
poŞ
.
šfo
.
	`is_t›r
()) &&

4431 !
h—d_obc
->
obs
.
oi
.
	`is_ÿche_pšÃd
())) {

4436 
	`dout
(10è<< 
coid
 << "„emovšg " << 
h—d_oid
 << 
d’dl
;

4437 
ùx
->
log
.
	`push_back
(

4438 
	`pg_log_’Œy_t
(

4439 
pg_log_’Œy_t
::
DELETE
,

4440 
h—d_oid
,

4441 
ùx
->
©_v”siÚ
,

4442 
h—d_obc
->
obs
.
oi
.
v”siÚ
,

4444 
	`osd_»qid_t
(),

4445 
ùx
->
mtime
,

4448 
d”r
 << "»movšg sÇ°h—d" << 
d’dl
;

4449 
objeù_šfo_t
& 
oi
 = 
h—d_obc
->
obs
.oi;

4450 
ùx
->
d–_¡©s
.
num_objeùs
--;

4451 ià(
oi
.
	`is_dœty
()) {

4452 
ùx
->
d–_¡©s
.
num_objeùs_dœty
--;

4454 ià(
oi
.
	`is_om­
())

4455 
ùx
->
d–_¡©s
.
num_objeùs_om­
--;

4456 ià(
oi
.
	`is_wh™eout
()) {

4457 
	`dout
(20è<< 
__func__
 << "rimmšg wh™eouˆÚ " << 
oi
.
soid
 << 
d’dl
;

4458 
ùx
->
d–_¡©s
.
num_wh™eouts
--;

4460 ià(
oi
.
	`is_ÿche_pšÃd
()) {

4461 
ùx
->
d–_¡©s
.
num_objeùs_pšÃd
--;

4463 ià(
coi
.
	`has_mªiã¡
())

4464 
ùx
->
d–_¡©s
.
num_objeùs_mªiã¡
--;

4465 
h—d_obc
->
obs
.
exi¡s
 = 
çl£
;

4466 
h—d_obc
->
obs
.
oi
 = 
	`objeù_šfo_t
(
h—d_oid
);

4467 
t
->
	`»move
(
h—d_oid
);

4469 
	`dout
(10è<< 
coid
 << " f‹ršg sÇp£ˆÚ " << 
h—d_oid
 << 
d’dl
;

4470 
¢­£t
.
	`f‹r
(
poŞ
.
šfo
);

4471 
	`dout
(10è<< 
coid
 << " wr™šg upd©ed sÇp£ˆÚ " << 
h—d_oid


4472 << ", sÇp£ˆi " << 
¢­£t
 << 
d’dl
;

4473 
ùx
->
log
.
	`push_back
(

4474 
	`pg_log_’Œy_t
(

4475 
pg_log_’Œy_t
::
MODIFY
,

4476 
h—d_oid
,

4477 
ùx
->
©_v”siÚ
,

4478 
h—d_obc
->
obs
.
oi
.
v”siÚ
,

4480 
	`osd_»qid_t
(),

4481 
ùx
->
mtime
,

4485 
h—d_obc
->
obs
.
oi
.
´iÜ_v”siÚ
 = h—d_obc->obs.oi.
v”siÚ
;

4486 
h—d_obc
->
obs
.
oi
.
v”siÚ
 = 
ùx
->
©_v”siÚ
;

4488 
m­
 <
¡ršg
, 
bufã¾i¡
> 
©Œs
;

4489 
bl
.
	`ş—r
();

4490 
	`’code
(
¢­£t
, 
bl
);

4491 
©Œs
[
SS_ATTR
].
	`şaim
(
bl
);

4493 
bl
.
	`ş—r
();

4494 
	`’code
(
h—d_obc
->
obs
.
oi
, 
bl
,

4495 
	`g‘_osdm­
()->
	`g‘_ã©u»s
(
CEPH_ENTITY_TYPE_OSD
, 
nuÎ±r
));

4496 
©Œs
[
OI_ATTR
].
	`şaim
(
bl
);

4497 
t
->
	`£‰rs
(
h—d_oid
, 
©Œs
);

4500 *
ùxp
 = 
¡d
::
	`move
(
ùx
);

4502 
	}
}

4504 
	gPrim¬yLogPG
::
	$kick_¢­_Œim
()

4506 
	`as£¹
(
	`is_aùive
());

4507 
	`as£¹
(
	`is_´im¬y
());

4508 ià(
	`is_ş—n
(è&& !
¢­_Œimq
.
	`em±y
()) {

4509 ià(
	`g‘_osdm­
()->
	`‹¡_æag
(
CEPH_OSDMAP_NOSNAPTRIM
)) {

4510 
	`dout
(10è<< 
__func__
 << ":‚o¢­Œim s‘,‚Ù kickšg" << 
d’dl
;

4512 
	`dout
(10è<< 
__func__
 << ": cËª‡nd sÇp tØŒim, kickšg" << 
d’dl
;

4513 
¢­_Œimm”_machše
.
	`´oûss_ev’t
(
	`KickTrim
());

4516 
	}
}

4518 
	gPrim¬yLogPG
::
	$¢­_Œimm”_süub_com¶‘e
()

4520 ià(
	`is_´im¬y
(è&& 
	`is_aùive
(è&& 
	`is_ş—n
()) {

4521 
	`as£¹
(!
¢­_Œimq
.
	`em±y
());

4522 
¢­_Œimm”_machše
.
	`´oûss_ev’t
(
	`SüubCom¶‘e
());

4524 
	}
}

4526 
	gPrim¬yLogPG
::
	$¢­_Œimm”
(
•och_t
 
queued
)

4528 ià(
d–‘šg
 || 
	`pg_has_»£t_sšû
(
queued
)) {

4532 
	`as£¹
(
	`is_´im¬y
());

4534 
	`dout
(10è<< "¢­_Œimm”…o¡šg" << 
d’dl
;

4535 
¢­_Œimm”_machše
.
	`´oûss_ev’t
(
	`DoSÇpWÜk
());

4536 
	`dout
(10è<< "¢­_Œimm” com¶‘e" << 
d’dl
;

4538 
	}
}

4540 
	gPrim¬yLogPG
::
	$do_x©Œ_cmp_u64
(
İ
, 
__u64
 
v1
, 
bufã¾i¡
& 
x©Œ
)

4542 
__u64
 
v2
;

4544 
¡ršg
 
	`v2s
(
x©Œ
.
	`c_¡r
(), x©Œ.
	`Ëngth
());

4545 ià(
v2s
.
	`Ëngth
())

4546 
v2
 = 
	`¡¹ouÎ
(
v2s
.
	`c_¡r
(), 
NULL
, 10);

4548 
v2
 = 0;

4550 
	`dout
(20è<< "do_x©Œ_cmp_u64 '" << 
v1
 << "' v '" << 
v2
 << "' o°" << 
İ
 << 
d’dl
;

4552 
İ
) {

4553 
CEPH_OSD_CMPXATTR_OP_EQ
:

4554  (
v1
 =ğ
v2
);

4555 
CEPH_OSD_CMPXATTR_OP_NE
:

4556  (
v1
 !ğ
v2
);

4557 
CEPH_OSD_CMPXATTR_OP_GT
:

4558  (
v1
 > 
v2
);

4559 
CEPH_OSD_CMPXATTR_OP_GTE
:

4560  (
v1
 >ğ
v2
);

4561 
CEPH_OSD_CMPXATTR_OP_LT
:

4562  (
v1
 < 
v2
);

4563 
CEPH_OSD_CMPXATTR_OP_LTE
:

4564  (
v1
 <ğ
v2
);

4566  -
EINVAL
;

4568 
	}
}

4570 
	gPrim¬yLogPG
::
	$do_x©Œ_cmp_¡r
(
İ
, 
¡ršg
& 
v1s
, 
bufã¾i¡
& 
x©Œ
)

4572 
¡ršg
 
	`v2s
(
x©Œ
.
	`c_¡r
(), x©Œ.
	`Ëngth
());

4574 
	`dout
(20è<< "do_x©Œ_cmp_¡¸'" << 
v1s
 << "' v '" << 
v2s
 << "' o°" << 
İ
 << 
d’dl
;

4576 
İ
) {

4577 
CEPH_OSD_CMPXATTR_OP_EQ
:

4578  (
v1s
.
	`com·»
(
v2s
) == 0);

4579 
CEPH_OSD_CMPXATTR_OP_NE
:

4580  (
v1s
.
	`com·»
(
v2s
) != 0);

4581 
CEPH_OSD_CMPXATTR_OP_GT
:

4582  (
v1s
.
	`com·»
(
v2s
) > 0);

4583 
CEPH_OSD_CMPXATTR_OP_GTE
:

4584  (
v1s
.
	`com·»
(
v2s
) >= 0);

4585 
CEPH_OSD_CMPXATTR_OP_LT
:

4586  (
v1s
.
	`com·»
(
v2s
) < 0);

4587 
CEPH_OSD_CMPXATTR_OP_LTE
:

4588  (
v1s
.
	`com·»
(
v2s
) <= 0);

4590  -
EINVAL
;

4592 
	}
}

4594 
	gPrim¬yLogPG
::
	$do_wr™e§me
(
OpCÚ‹xt
 *
ùx
, 
OSDOp
& 
osd_İ
)

4596 
ûph_osd_İ
& 
İ
 = 
osd_İ
.op;

4597 
veùÜ
<
OSDOp
> 
	`wr™e_İs
(1);

4598 
OSDOp
& 
wr™e_İ
 = 
wr™e_İs
[0];

4599 
ušt64_t
 
wr™e_Ëngth
 = 
İ
.
wr™e§me
.
Ëngth
;

4600 
»suÉ
 = 0;

4602 ià(!
wr™e_Ëngth
)

4605 ià(!
İ
.
wr™e§me
.
d©a_Ëngth
 || 
wr™e_Ëngth
 % op.writesame.data_length)

4606  -
EINVAL
;

4608 ià(
İ
.
wr™e§me
.
d©a_Ëngth
 !ğ
osd_İ
.
šd©a
.
	`Ëngth
()) {

4609 
d”r
 << "šv®id†’gth w d©¨Ëngth " << 
İ
.
wr™e§me
.
d©a_Ëngth
 << "‡ùu®†’ " << 
osd_İ
.
šd©a
.
	`Ëngth
(è<< 
d’dl
;

4610  -
EINVAL
;

4613 
wr™e_Ëngth
) {

4614 
wr™e_İ
.
šd©a
.
	`­³nd
(
osd_İ
.indata);

4615 
wr™e_Ëngth
 -ğ
İ
.
wr™e§me
.
d©a_Ëngth
;

4618 
wr™e_İ
.
İ
.İ = 
CEPH_OSD_OP_WRITE
;

4619 
wr™e_İ
.
İ
.
ex‹Á
.
off£t
 = op.
wr™e§me
.offset;

4620 
wr™e_İ
.
İ
.
ex‹Á
.
Ëngth
 = op.
wr™e§me
.length;

4621 
»suÉ
 = 
	`do_osd_İs
(
ùx
, 
wr™e_İs
);

4622 ià(
»suÉ
 < 0)

4623 
d”r
 << "do_wr™e§mdo_osd_İ çed " << 
»suÉ
 << 
d’dl
;

4625  
»suÉ
;

4626 
	}
}

4631 
	gPrim¬yLogPG
::
	$do_tm­2om­
(
OpCÚ‹xt
 *
ùx
, 
æags
)

4633 
	`dout
(20è<< " cÚv”ˆtm­Øom­ fÜ " << 
ùx
->
Ãw_obs
.
oi
.
soid
 << 
d’dl
;

4634 
bufã¾i¡
 
h—d”
, 
v®s
;

4635 
r
 = 
	`_g‘_tm­
(
ùx
, &
h—d”
, &
v®s
);

4636 ià(
r
 < 0) {

4637 ià(
r
 =ğ-
ENODATA
 && (
æags
 & 
CEPH_OSD_TMAP2OMAP_NULLOK
))

4638 
r
 = 0;

4639  
r
;

4642 
veùÜ
<
OSDOp
> 
	`İs
(3);

4644 
İs
[0].
İ
.İ = 
CEPH_OSD_OP_TRUNCATE
;

4645 
İs
[0].
İ
.
ex‹Á
.
off£t
 = 0;

4646 
İs
[0].
İ
.
ex‹Á
.
Ëngth
 = 0;

4648 
İs
[1].
İ
.İ = 
CEPH_OSD_OP_OMAPSETHEADER
;

4649 
İs
[1].
šd©a
.
	`şaim
(
h—d”
);

4651 
İs
[2].
İ
.İ = 
CEPH_OSD_OP_OMAPSETVALS
;

4652 
İs
[2].
šd©a
.
	`şaim
(
v®s
);

4654  
	`do_osd_İs
(
ùx
, 
İs
);

4655 
	}
}

4657 
	gPrim¬yLogPG
::
	$do_tm­up_¦ow
(
OpCÚ‹xt
 *
ùx
, 
bufã¾i¡
::
™”©Ü
& 
bp
, 
OSDOp
& 
osd_İ
,

4658 
bufã¾i¡
& 
bl
)

4661 
bufã¾i¡
 
h—d”
;

4662 
m­
<
¡ršg
, 
bufã¾i¡
> 
m
;

4663 ià(
bl
.
	`Ëngth
()) {

4664 
bufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
	`begš
();

4665 
	`decode
(
h—d”
, 
p
);

4666 
	`decode
(
m
, 
p
);

4667 
	`as£¹
(
p
.
	`’d
());

4671 !
bp
.
	`’d
()) {

4672 
__u8
 
İ
;

4673 
¡ršg
 
key
;

4674 
	`decode
(
İ
, 
bp
);

4676 
İ
) {

4677 
CEPH_OSD_TMAP_SET
:

4679 
	`decode
(
key
, 
bp
);

4680 
bufã¾i¡
 
d©a
;

4681 
	`decode
(
d©a
, 
bp
);

4682 
m
[
key
] = 
d©a
;

4685 
CEPH_OSD_TMAP_RM
:

4686 
	`decode
(
key
, 
bp
);

4687 ià(!
m
.
	`couÁ
(
key
)) {

4688  -
ENOENT
;

4690 
m
.
	`”a£
(
key
);

4692 
CEPH_OSD_TMAP_RMSLOPPY
:

4693 
	`decode
(
key
, 
bp
);

4694 
m
.
	`”a£
(
key
);

4696 
CEPH_OSD_TMAP_HDR
:

4698 
	`decode
(
h—d”
, 
bp
);

4702  -
EINVAL
;

4707 
bufã¾i¡
 
obl
;

4708 
	`’code
(
h—d”
, 
obl
);

4709 
	`’code
(
m
, 
obl
);

4712 
veùÜ
<
OSDOp
> 
	`nİs
(1);

4713 
OSDOp
& 
Ãwİ
 = 
nİs
[0];

4714 
Ãwİ
.
İ
.İ = 
CEPH_OSD_OP_WRITEFULL
;

4715 
Ãwİ
.
İ
.
ex‹Á
.
off£t
 = 0;

4716 
Ãwİ
.
İ
.
ex‹Á
.
Ëngth
 = 
obl
.
	`Ëngth
();

4717 
Ãwİ
.
šd©a
 = 
obl
;

4718 
	`do_osd_İs
(
ùx
, 
nİs
);

4719 
osd_İ
.
outd©a
.
	`şaim
(
Ãwİ
.outdata);

4721 
	}
}

4723 
	gPrim¬yLogPG
::
	$do_tm­up
(
OpCÚ‹xt
 *
ùx
, 
bufã¾i¡
::
™”©Ü
& 
bp
, 
OSDOp
& 
osd_İ
)

4725 
bufã¾i¡
::
™”©Ü
 
Üig_bp
 = 
bp
;

4726 
»suÉ
 = 0;

4727 ià(
bp
.
	`’d
()) {

4728 
	`dout
(10è<< "tm­u°i ¨no-İ" << 
d’dl
;

4731 
veùÜ
<
OSDOp
> 
	`nİs
(1);

4732 
OSDOp
& 
Ãwİ
 = 
nİs
[0];

4733 
Ãwİ
.
İ
.İ = 
CEPH_OSD_OP_READ
;

4734 
Ãwİ
.
İ
.
ex‹Á
.
off£t
 = 0;

4735 
Ãwİ
.
İ
.
ex‹Á
.
Ëngth
 = 0;

4736 
»suÉ
 = 
	`do_osd_İs
(
ùx
, 
nİs
);

4738 
	`dout
(10è<< "tm­u°»ad " << 
Ãwİ
.
outd©a
.
	`Ëngth
(è<< 
d’dl
;

4740 
	`dout
(30) << " starting is \n";

4741 
Ãwİ
.
outd©a
.
	`hexdump
(*
_dout
);

4742 *
_dout
 << 
d’dl
;

4744 
bufã¾i¡
::
™”©Ü
 

 = 
Ãwİ
.
outd©a
.
	`begš
();

4745 
bufã¾i¡
 
obl
;

4747 
	`dout
(30) << "the update command is: \n";

4748 
osd_İ
.
šd©a
.
	`hexdump
(*
_dout
);

4749 *
_dout
 << 
d’dl
;

4752 
bufã¾i¡
 
h—d”
;

4753 
__u32
 
nkeys
 = 0;

4754 ià(
Ãwİ
.
outd©a
.
	`Ëngth
()) {

4755 
	`decode
(
h—d”
, 

);

4756 
	`decode
(
nkeys
, 

);

4758 
	`dout
(10è<< "tm­u°h—d” " << 
h—d”
.
	`Ëngth
(è<< 
d’dl
;

4760 ià(!
bp
.
	`’d
(è&& *b°=ğ
CEPH_OSD_TMAP_HDR
) {

4761 ++
bp
;

4762 
	`decode
(
h—d”
, 
bp
);

4763 
	`dout
(10è<< "tm­u°Ãw h—d” " << 
h—d”
.
	`Ëngth
(è<< 
d’dl
;

4766 
	`’code
(
h—d”
, 
obl
);

4768 
	`dout
(20è<< "tm­u°š™ŸÈnkey " << 
nkeys
 << 
d’dl
;

4771 
bufã¾i¡
 
Ãwkeyd©a
;

4772 
¡ršg
 
Ãxtkey
, 
Ï¡_š_key
;

4773 
bufã¾i¡
 
Ãxtv®
;

4774 
boŞ
 
have_Ãxt
 = 
çl£
;

4775 ià(!

.
	`’d
()) {

4776 
have_Ãxt
 = 
Œue
;

4777 
	`decode
(
Ãxtkey
, 

);

4778 
	`decode
(
Ãxtv®
, 

);

4780 !
bp
.
	`’d
(è&& !
»suÉ
) {

4781 
__u8
 
İ
;

4782 
¡ršg
 
key
;

4783 
Œy
 {

4784 
	`decode
(
İ
, 
bp
);

4785 
	`decode
(
key
, 
bp
);

4787 
	`ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

4788  -
EINVAL
;

4790 ià(
key
 < 
Ï¡_š_key
) {

4791 
	`dout
(5è<< "tm­u°w¬nšg: key '" << 
key
 << "' <…»viou key '" << 
Ï¡_š_key


4792 << "', f®lšg backØª iÃffic›Á (unsÜ‹dèupd©e" << 
d’dl
;

4793 
bp
 = 
Üig_bp
;

4794  
	`do_tm­up_¦ow
(
ùx
, 
bp
, 
osd_İ
, 
Ãwİ
.
outd©a
);

4796 
Ï¡_š_key
 = 
key
;

4798 
	`dout
(10è<< "tm­u°İ " << ()
İ
 << " key " << 
key
 << 
d’dl
;

4801 
boŞ
 
key_exi¡s
 = 
çl£
;

4802 
have_Ãxt
 && !
key_exi¡s
) {

4803 
	`dout
(20è<< " (have_Ãxt=" << 
have_Ãxt
 << "‚extkey=" << 
Ãxtkey
 << ")" << 
d’dl
;

4804 ià(
Ãxtkey
 > 
key
)

4806 ià(
Ãxtkey
 < 
key
) {

4808 
	`’code
(
Ãxtkey
, 
Ãwkeyd©a
);

4809 
	`’code
(
Ãxtv®
, 
Ãwkeyd©a
);

4810 
	`dout
(20è<< " k“°" << 
Ãxtkey
 << " " << 
Ãxtv®
.
	`Ëngth
(è<< 
d’dl
;

4813 
	`dout
(20è<< " drİ " << 
Ãxtkey
 << " " << 
Ãxtv®
.
	`Ëngth
(è<< 
d’dl
;

4814 
key_exi¡s
 = 
Œue
;

4815 
nkeys
--;

4817 ià(!

.
	`’d
()) {

4818 
	`decode
(
Ãxtkey
, 

);

4819 
	`decode
(
Ãxtv®
, 

);

4821 
have_Ãxt
 = 
çl£
;

4825 ià(
İ
 =ğ
CEPH_OSD_TMAP_SET
) {

4826 
bufã¾i¡
 
v®
;

4827 
Œy
 {

4828 
	`decode
(
v®
, 
bp
);

4830 
	`ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

4831  -
EINVAL
;

4833 
	`’code
(
key
, 
Ãwkeyd©a
);

4834 
	`’code
(
v®
, 
Ãwkeyd©a
);

4835 
	`dout
(20è<< " s‘ " << 
key
 << " " << 
v®
.
	`Ëngth
(è<< 
d’dl
;

4836 
nkeys
++;

4837 } ià(
İ
 =ğ
CEPH_OSD_TMAP_CREATE
) {

4838 ià(
key_exi¡s
) {

4839  -
EEXIST
;

4841 
bufã¾i¡
 
v®
;

4842 
Œy
 {

4843 
	`decode
(
v®
, 
bp
);

4845 
	`ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

4846  -
EINVAL
;

4848 
	`’code
(
key
, 
Ãwkeyd©a
);

4849 
	`’code
(
v®
, 
Ãwkeyd©a
);

4850 
	`dout
(20è<< " c»©" << 
key
 << " " << 
v®
.
	`Ëngth
(è<< 
d’dl
;

4851 
nkeys
++;

4852 } ià(
İ
 =ğ
CEPH_OSD_TMAP_RM
) {

4854 ià(!
key_exi¡s
) {

4855  -
ENOENT
;

4857 } ià(
İ
 =ğ
CEPH_OSD_TMAP_RMSLOPPY
) {

4860 
	`dout
(10è<< " inv®idm­ o°" << ()
İ
 << 
d’dl
;

4861  -
EINVAL
;

4866 ià(
have_Ãxt
) {

4867 
	`’code
(
Ãxtkey
, 
Ãwkeyd©a
);

4868 
	`’code
(
Ãxtv®
, 
Ãwkeyd©a
);

4869 
	`dout
(20è<< " k“°" << 
Ãxtkey
 << " " << 
Ãxtv®
.
	`Ëngth
(è<< 
d’dl
;

4871 ià(!

.
	`’d
()) {

4872 
bufã¾i¡
 
»¡
;

4873 
»¡
.
	`sub¡r_of
(
Ãwİ
.
outd©a
, 

.
	`g‘_off
(),‚ewİ.outd©a.
	`Ëngth
() - ip.get_off());

4874 
	`dout
(20è<< " k“°Œašg " << 
»¡
.
	`Ëngth
()

4875 << "‡ˆ" << 
Ãwkeyd©a
.
	`Ëngth
(è<< 
d’dl
;

4876 
Ãwkeyd©a
.
	`şaim_­³nd
(
»¡
);

4880 
	`dout
(20è<< "tm­u°fš®‚key " << 
nkeys
 << 
d’dl
;

4881 
	`’code
(
nkeys
, 
obl
);

4882 
obl
.
	`şaim_­³nd
(
Ãwkeyd©a
);

4885 
	`dout
(30) << " final is \n";

4886 
obl
.
	`hexdump
(*
_dout
);

4887 *
_dout
 << 
d’dl
;

4890 
bufã¾i¡
::
™”©Ü
 

 = 
obl
.
	`begš
();

4891 
bufã¾i¡
 
h
;

4892 
	`decode
(
h
, 

);

4893 
m­
<
¡ršg
,
bufã¾i¡
> 
d
;

4894 
	`decode
(
d
, 

);

4895 
	`as£¹
(

.
	`’d
());

4896 
	`dout
(0è<< " **** debug sª™y check,†ook ok ****" << 
d’dl
;

4900 ià(!
»suÉ
) {

4901 
	`dout
(20è<< "tm­puˆwr™" << 
obl
.
	`Ëngth
(è<< 
d’dl
;

4902 
Ãwİ
.
İ
.İ = 
CEPH_OSD_OP_WRITEFULL
;

4903 
Ãwİ
.
İ
.
ex‹Á
.
off£t
 = 0;

4904 
Ãwİ
.
İ
.
ex‹Á
.
Ëngth
 = 
obl
.
	`Ëngth
();

4905 
Ãwİ
.
šd©a
 = 
obl
;

4906 
	`do_osd_İs
(
ùx
, 
nİs
);

4907 
osd_İ
.
outd©a
.
	`şaim
(
Ãwİ
.outdata);

4910  
»suÉ
;

4911 
	}
}

4913 
	$check_off£t_ªd_Ëngth
(
ušt64_t
 
off£t
, ušt64_ˆ
Ëngth
,

4914 
ušt64_t
 
max
, 
DoutP»fixProvid”
 *
dµ
)

4916 ià(
off£t
 >ğ
max
 ||

4917 
Ëngth
 > 
max
 ||

4918 
off£t
 + 
Ëngth
 > 
max
) {

4919 
	`ldµ_dout
(
dµ
, 10è<< 
__func__
 << " "

4920 << "osd_max_objeù_size: " << 
max


4921 << "; H¬d†im™ oàobjeù sizi 4GB." << 
d’dl
;

4922  -
EFBIG
;

4926 
	}
}

4928 
	gFlInV”ifyEx‹Á
 : 
public
 
CÚ‹xt
 {

4929 
ûph_Ë64
 *
r
;

4930 
št32_t
 *
	grv®
;

4931 
bufã¾i¡
 *
	goutd©­
;

4932 
	gboo¡
::
İtiÚ®
<
ušt32_t
> 
maybe_üc
;

4933 
ušt64_t
 
	gsize
;

4934 
OSDS”viû
 *
	gosd
;

4935 
hobjeù_t
 
	gsoid
;

4936 
__Ë32
 
	gæags
;

4937 
FlInV”ifyEx‹Á
(
ûph_Ë64
 *
r
, 
št32_t
 *
rv
, 
bufã¾i¡
 *
bÍ
,

4938 
boo¡
::
İtiÚ®
<
ušt32_t
> 
mc
, 
ušt64_t
 
size
,

4939 
OSDS”viû
 *
osd
, 
hobjeù_t
 
soid
, 
__Ë32
 
æags
) :

4940 
r
Ô), 
rv®
(
rv
), 
outd©­
(
bÍ
), 
maybe_üc
(
mc
),

4941 
size
(size), 
osd
(osd), 
soid
(soid), 
æags
(flags) {}

4942 
fšish
(
Ën
è
	gov”ride
 {

4943 *
	gr
 = 
Ën
;

4944 ià(
	gËn
 < 0) {

4945 *
	grv®
 = 
Ën
;

4948 *
	grv®
 = 0;

4951 ià(
	gmaybe_üc
 && *
	gr
 =ğ
size
) {

4952 
ušt32_t
 
üc
 = 
outd©­
->
üc32c
(-1);

4953 ià(
	gmaybe_üc
 !ğ
üc
) {

4954 
osd
->
şog
->
”rÜ
(è<< 
¡d
::
hex
 << " fuÎ-objeù„—d crø0x" << 
üc


4955 << " !ğex³ùed 0x" << *
maybe_üc


4956 << 
¡d
::
dec
 << " oÀ" << 
soid
;

4957 ià(!(
	gæags
 & 
	gCEPH_OSD_OP_FLAG_FAILOK
)) {

4958 *
	grv®
 = -
EIO
;

4959 *
	gr
 = 0;

4966 
	gToS·r£R—dResuÉ
 : 
public
 
CÚ‹xt
 {

4967 * 
»suÉ
;

4968 
bufã¾i¡
* 
	gd©a_bl
;

4969 
ušt64_t
 
	gd©a_off£t
;

4970 
ûph_Ë64
* 
	gËn
;

4971 
ToS·r£R—dResuÉ
(* 
»suÉ
, 
bufã¾i¡
* 
bl
, 
ušt64_t
 
off£t
,

4972 
ûph_Ë64
* 
Ën
)

4973 : 
»suÉ
ÔesuÉ), 
d©a_bl
(
bl
), 
d©a_off£t
(
off£t
),
Ën
(len) {}

4974 
fšish
(
r
è
	gov”ride
 {

4975 ià(
	gr
 < 0) {

4976 *
	g»suÉ
 = 
r
;

4979 *
	g»suÉ
 = 0;

4980 *
	gËn
 = 
r
;

4981 
bufã¾i¡
 
	goutd©a
;

4982 
	gm­
<
	gušt64_t
, ušt64_t> 
	gex‹Ás
 = {{
d©a_off£t
, 
r
}};

4983 
’code
(
ex‹Ás
, 
outd©a
);

4984 ::
’code_de¡ruùiv–y
(*
d©a_bl
, 
outd©a
);

4985 
	gd©a_bl
->
sw­
(
outd©a
);

4989 
	g‹m¶©e
<
ty³Çme
 
	gV
>

4990 
¡ršg
 
li¡_keys
(cÚ¡ 
m­
<¡ršg, 
V
>& 
m
) {

4991 
¡ršg
 
	gs
;

4992 
ty³Çme
 
	gm­
<
	g¡ršg
, 
	gV
>::
cÚ¡_™”©Ü
 
™r
 = 
m
.
begš
(); 
	g™r
 !ğm.
’d
(); ++itr) {

4993 ià(!
	gs
.
em±y
()) {

4994 
	gs
.
push_back
(',');

4996 
	gs
.
­³nd
(
™r
->
fœ¡
);

4998  
	gs
;

5001 
	g‹m¶©e
<
ty³Çme
 
	gT
>

5002 
¡ršg
 
	$li¡_’Œ›s
(cÚ¡ 
T
& 
m
) {

5003 
¡ršg
 
s
;

5004 
ty³Çme
 
T
::
cÚ¡_™”©Ü
 
™r
 = 
m
.
	`begš
(); iŒ !ğm.
	`’d
(); ++itr) {

5005 ià(!
s
.
	`em±y
()) {

5006 
s
.
	`push_back
(',');

5008 
s
.
	`­³nd
(*
™r
);

5010  
s
;

5011 
	}
}

5013 
	gPrim¬yLogPG
::
	$maybe_ü—‹_Ãw_objeù
(

5014 
OpCÚ‹xt
 *
ùx
,

5015 
boŞ
 
ignÜe_Œª§ùiÚ
)

5017 
ObjeùS‹
& 
obs
 = 
ùx
->
Ãw_obs
;

5018 ià(!
obs
.
exi¡s
) {

5019 
ùx
->
d–_¡©s
.
num_objeùs
++;

5020 
obs
.
exi¡s
 = 
Œue
;

5021 
	`as£¹
(!
obs
.
oi
.
	`is_wh™eout
());

5022 
obs
.
oi
.
	`Ãw_objeù
();

5023 ià(!
ignÜe_Œª§ùiÚ
)

5024 
ùx
->
İ_t
->
	`ü—‹
(
obs
.
oi
.
soid
);

5025 } ià(
obs
.
oi
.
	`is_wh™eout
()) {

5026 
	`dout
(10è<< 
__func__
 << " cË¬šg wh™eouˆÚ " << 
obs
.
oi
.
soid
 << 
d’dl
;

5027 
ùx
->
Ãw_obs
.
oi
.
	`ş—r_æag
(
objeù_šfo_t
::
FLAG_WHITEOUT
);

5028 --
ùx
->
d–_¡©s
.
num_wh™eouts
;

5030 
	}
}

5032 
	gR—dFšish”
 : 
public
 
Prim¬yLogPG
::
OpFšish”
 {

5033 
OSDOp
& 
osd_İ
;

5035 
ex¶ic™
 
R—dFšish”
(
OSDOp
& 
osd_İ
) : osd_op(osd_op) {

5038 
execu‹
(è
ov”ride
 {

5039  
osd_İ
.
rv®
;

5043 
	gC_ChecksumR—d
 : 
public
 
CÚ‹xt
 {

5044 
Prim¬yLogPG
 *
´im¬y_log_pg
;

5045 
	gOSDOp
 &
	gosd_İ
;

5046 
	gChecksumm”
::
CSumTy³
 
csum_ty³
;

5047 
bufã¾i¡
 
	gš™_v®ue_bl
;

5048 
ûph_Ë64
 
	g»ad_Ëngth
;

5049 
bufã¾i¡
 
	g»ad_bl
;

5050 
CÚ‹xt
 *
	gfl_ex‹Á_ùx
;

5052 
C_ChecksumR—d
(
Prim¬yLogPG
 *
´im¬y_log_pg
, 
OSDOp
 &
osd_İ
,

5053 
Checksumm”
::
CSumTy³
 
csum_ty³
, 
bufã¾i¡
 &&
š™_v®ue_bl
,

5054 
boo¡
::
İtiÚ®
<
ušt32_t
> 
maybe_üc
, 
ušt64_t
 
size
,

5055 
OSDS”viû
 *
osd
, 
hobjeù_t
 
soid
, 
__Ë32
 
æags
)

5056 : 
´im¬y_log_pg
Õrim¬y_log_pg), 
osd_İ
(osd_op),

5057 
csum_ty³
(csum_ty³), 
š™_v®ue_bl
(
¡d
::
move
(init_value_bl)),

5058 
fl_ex‹Á_ùx
(
Ãw
 
FlInV”ifyEx‹Á
(&
»ad_Ëngth
, &
osd_İ
.
rv®
,

5059 &
»ad_bl
, 
maybe_üc
, 
size
,

5060 
osd
, 
soid
, 
æags
)) {

5062 ~
C_ChecksumR—d
(è
	gov”ride
 {

5063 
d–‘e
 
	gfl_ex‹Á_ùx
;

5066 
fšish
(
r
è
	gov”ride
 {

5067 
	gfl_ex‹Á_ùx
->
com¶‘e
(
r
);

5068 
	gfl_ex‹Á_ùx
 = 
nuÎ±r
;

5070 ià(
	gosd_İ
.
	grv®
 >= 0) {

5071 
bufã¾i¡
::
™”©Ü
 
š™_v®ue_bl_™
 = 
š™_v®ue_bl
.
begš
();

5072 
	gosd_İ
.
	grv®
 = 
´im¬y_log_pg
->
fšish_checksum
(
osd_İ
, 
csum_ty³
,

5073 &
š™_v®ue_bl_™
, 
»ad_bl
);

5078 
	gPrim¬yLogPG
::
	$do_checksum
(
OpCÚ‹xt
 *
ùx
, 
OSDOp
& 
osd_İ
,

5079 
bufã¾i¡
::
™”©Ü
 *
bl_™
)

5081 
	`dout
(20è<< 
__func__
 << 
d’dl
;

5083 auto& 
İ
 = 
osd_İ
.op;

5084 ià(
İ
.
checksum
.
chunk_size
 > 0) {

5085 ià(
İ
.
checksum
.
Ëngth
 == 0) {

5086 
	`dout
(10è<< 
__func__
 << ":†ength„equired when chunk size…rovided"

5087 << 
d’dl
;

5088  -
EINVAL
;

5090 ià(
İ
.
checksum
.
Ëngth
 % op.checksum.
chunk_size
 != 0) {

5091 
	`dout
(10è<< 
__func__
 << ":†’gth‚Ù‡ligÃdØchunk size" << 
d’dl
;

5092  -
EINVAL
;

5096 auto& 
oi
 = 
ùx
->
Ãw_obs
.oi;

5097 ià(
İ
.
checksum
.
off£t
 =ğ0 && op.checksum.
Ëngth
 == 0) {

5099 
İ
.
checksum
.
Ëngth
 = 
oi
.
size
;

5100 } ià(
İ
.
checksum
.
off£t
 >ğ
oi
.
size
) {

5104 } ià(
İ
.
ex‹Á
.
off£t
 + op.ex‹Á.
Ëngth
 > 
oi
.
size
) {

5105 
İ
.
ex‹Á
.
Ëngth
 = 
oi
.
size
 - op.ex‹Á.
off£t
;

5106 ià(
İ
.
checksum
.
chunk_size
 > 0 &&

5107 
İ
.
checksum
.
Ëngth
 % op.checksum.
chunk_size
 != 0) {

5108 
	`dout
(10è<< 
__func__
 << ":†ength (trimmedo 0x"

5109 << 
¡d
::
hex
 << 
İ
.
checksum
.
Ëngth


5111 << 
İ
.
checksum
.
chunk_size
 << 
¡d
::
dec


5112 << 
d’dl
;

5113  -
EINVAL
;

5117 
Checksumm”
::
CSumTy³
 
csum_ty³
;

5118 
İ
.
checksum
.
ty³
) {

5119 
CEPH_OSD_CHECKSUM_OP_TYPE_XXHASH32
:

5120 
csum_ty³
 = 
Checksumm”
::
CSUM_XXHASH32
;

5122 
CEPH_OSD_CHECKSUM_OP_TYPE_XXHASH64
:

5123 
csum_ty³
 = 
Checksumm”
::
CSUM_XXHASH64
;

5125 
CEPH_OSD_CHECKSUM_OP_TYPE_CRC32C
:

5126 
csum_ty³
 = 
Checksumm”
::
CSUM_CRC32C
;

5129 
	`dout
(10è<< 
__func__
 << ": unknown crcype ("

5130 << 
¡©ic_ÿ¡
<
ušt32_t
>(
İ
.
checksum
.
ty³
è<< ")" << 
d’dl
;

5131  -
EINVAL
;

5134 
size_t
 
csum_š™_v®ue_size
 = 
Checksumm”
::
	`g‘_csum_š™_v®ue_size
(
csum_ty³
);

5135 ià(
bl_™
->
	`g‘_»maššg
(è< 
csum_š™_v®ue_size
) {

5136 
	`dout
(10è<< 
__func__
 << ": in™ v®unÙ…rovided" << 
d’dl
;

5137  -
EINVAL
;

5140 
bufã¾i¡
 
š™_v®ue_bl
;

5141 
š™_v®ue_bl
.
	`sub¡r_of
(
bl_™
->
	`g‘_bl
(), bl_™->
	`g‘_off
(),

5142 
csum_š™_v®ue_size
);

5143 
bl_™
->
	`advªû
(
csum_š™_v®ue_size
);

5145 ià(
poŞ
.
šfo
.
	`is_”asu»
(è&& 
İ
.
checksum
.
Ëngth
 > 0) {

5148 
boo¡
::
İtiÚ®
<
ušt32_t
> 
maybe_üc
;

5149 ià(
oi
.
	`is_d©a_dige¡
(è&& 
İ
.
checksum
.
off£t
 == 0 &&

5150 
İ
.
checksum
.
Ëngth
 >ğ
oi
.
size
) {

5151 
maybe_üc
 = 
oi
.
d©a_dige¡
;

5155 auto& 
soid
 = 
oi
.soid;

5156 autØ
checksum_ùx
 = 
Ãw
 
	`C_ChecksumR—d
(
this
, 
osd_İ
, 
csum_ty³
,

5157 
¡d
::
	`move
(
š™_v®ue_bl
), 
maybe_üc
,

5158 
oi
.
size
, 
osd
, 
soid
, 
İ
.
æags
);

5160 
ùx
->
³ndšg_async_»ads
.
	`push_back
({

5161 {
İ
.
checksum
.
off£t
, op.checksum.
Ëngth
, op.
æags
},

5162 {&
checksum_ùx
->
»ad_bl
, checksum_ctx}});

5164 
	`dout
(10è<< 
__func__
 << ":‡sync_»ad‚Ùed fÜ " << 
soid
 << 
d’dl
;

5165 
ùx
->
İ_fšish”s
[ùx->
cu¼’t_osd_subİ_num
].
	`»£t
(

5166 
Ãw
 
	`R—dFšish”
(
osd_İ
));

5167  -
EINPROGRESS
;

5171 
¡d
::
veùÜ
<
OSDOp
> 
	`»ad_İs
(1);

5172 auto& 
»ad_İ
 = 
»ad_İs
[0];

5173 ià(
İ
.
checksum
.
Ëngth
 > 0) {

5174 
»ad_İ
.
İ
.İ = 
CEPH_OSD_OP_READ
;

5175 
»ad_İ
.
İ
.
æags
 = op.flags;

5176 
»ad_İ
.
İ
.
ex‹Á
.
off£t
 = op.
checksum
.offset;

5177 
»ad_İ
.
İ
.
ex‹Á
.
Ëngth
 = op.
checksum
.length;

5178 
»ad_İ
.
İ
.
ex‹Á
.
Œunÿ‹_size
 = 0;

5179 
»ad_İ
.
İ
.
ex‹Á
.
Œunÿ‹_£q
 = 0;

5181 
r
 = 
	`do_osd_İs
(
ùx
, 
»ad_İs
);

5182 ià(
r
 < 0) {

5183 
d”r
 << 
__func__
 << ": do_osd_İ çed: " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

5184  
r
;

5188 
bufã¾i¡
::
™”©Ü
 
š™_v®ue_bl_™
 = 
š™_v®ue_bl
.
	`begš
();

5189  
	`fšish_checksum
(
osd_İ
, 
csum_ty³
, &
š™_v®ue_bl_™
,

5190 
»ad_İ
.
outd©a
);

5191 
	}
}

5193 
	gPrim¬yLogPG
::
	$fšish_checksum
(
OSDOp
& 
osd_İ
,

5194 
Checksumm”
::
CSumTy³
 
csum_ty³
,

5195 
bufã¾i¡
::
™”©Ü
 *
š™_v®ue_bl_™
,

5196 cÚ¡ 
bufã¾i¡
 &
»ad_bl
) {

5197 
	`dout
(20è<< 
__func__
 << 
d’dl
;

5199 auto& 
İ
 = 
osd_İ
.op;

5201 ià(
İ
.
checksum
.
Ëngth
 > 0 && 
»ad_bl
.
	`Ëngth
() != op.checksum.length) {

5202 
d”r
 << 
__func__
 << ": by‹ »ad " << 
»ad_bl
.
	`Ëngth
() << " != "

5203 << 
İ
.
checksum
.
Ëngth
 << 
d’dl
;

5204  -
EINVAL
;

5207 
size_t
 
csum_chunk_size
 = (
İ
.
checksum
.
chunk_size
 != 0 ?

5208 
İ
.
checksum
.
chunk_size
 : 
»ad_bl
.
	`Ëngth
());

5209 
ušt32_t
 
csum_couÁ
 = (
csum_chunk_size
 > 0 ?

5210 
»ad_bl
.
	`Ëngth
(è/ 
csum_chunk_size
 : 0);

5212 
bufã¾i¡
 
csum
;

5213 
bufã½Œ
 
csum_d©a
;

5214 ià(
csum_couÁ
 > 0) {

5215 
size_t
 
csum_v®ue_size
 = 
Checksumm”
::
	`g‘_csum_v®ue_size
(
csum_ty³
);

5216 
csum_d©a
 = 
bufãr
::
	`ü—‹
(
csum_v®ue_size
 * 
csum_couÁ
);

5217 
csum_d©a
.
	`z”o
();

5218 
csum
.
	`­³nd
(
csum_d©a
);

5220 
csum_ty³
) {

5221 
Checksumm”
::
CSUM_XXHASH32
:

5223 
Checksumm”
::
xxhash32
::
š™_v®ue_t
 
š™_v®ue
;

5224 
	`decode
(
š™_v®ue
, *
š™_v®ue_bl_™
);

5225 
Checksumm”
::
ÿlcuÏ‹
<Checksumm”::
xxhash32
>(

5226 
š™_v®ue
, 
csum_chunk_size
, 0, 
»ad_bl
.
	`Ëngth
(),„ead_bl,

5227 &
csum_d©a
);

5230 
Checksumm”
::
CSUM_XXHASH64
:

5232 
Checksumm”
::
xxhash64
::
š™_v®ue_t
 
š™_v®ue
;

5233 
	`decode
(
š™_v®ue
, *
š™_v®ue_bl_™
);

5234 
Checksumm”
::
ÿlcuÏ‹
<Checksumm”::
xxhash64
>(

5235 
š™_v®ue
, 
csum_chunk_size
, 0, 
»ad_bl
.
	`Ëngth
(),„ead_bl,

5236 &
csum_d©a
);

5239 
Checksumm”
::
CSUM_CRC32C
:

5241 
Checksumm”
::
üc32c
::
š™_v®ue_t
 
š™_v®ue
;

5242 
	`decode
(
š™_v®ue
, *
š™_v®ue_bl_™
);

5243 
Checksumm”
::
ÿlcuÏ‹
<Checksumm”::
üc32c
>(

5244 
š™_v®ue
, 
csum_chunk_size
, 0, 
»ad_bl
.
	`Ëngth
(),„ead_bl,

5245 &
csum_d©a
);

5253 
	`’code
(
csum_couÁ
, 
osd_İ
.
outd©a
);

5254 
osd_İ
.
outd©a
.
	`şaim_­³nd
(
csum
);

5256 
	}
}

5258 
	gC_Ex‹ÁCmpR—d
 : 
public
 
CÚ‹xt
 {

5259 
Prim¬yLogPG
 *
´im¬y_log_pg
;

5260 
	gOSDOp
 &
	gosd_İ
;

5261 
ûph_Ë64
 
	g»ad_Ëngth
{};

5262 
bufã¾i¡
 
	g»ad_bl
;

5263 
CÚ‹xt
 *
	gfl_ex‹Á_ùx
;

5265 
C_Ex‹ÁCmpR—d
(
Prim¬yLogPG
 *
´im¬y_log_pg
, 
OSDOp
 &
osd_İ
,

5266 
boo¡
::
İtiÚ®
<
ušt32_t
> 
maybe_üc
, 
ušt64_t
 
size
,

5267 
OSDS”viû
 *
osd
, 
hobjeù_t
 
soid
, 
__Ë32
 
æags
)

5268 : 
´im¬y_log_pg
Õrim¬y_log_pg), 
osd_İ
(osd_op),

5269 
fl_ex‹Á_ùx
(
Ãw
 
FlInV”ifyEx‹Á
(&
»ad_Ëngth
, &
osd_İ
.
rv®
,

5270 &
»ad_bl
, 
maybe_üc
, 
size
,

5271 
osd
, 
soid
, 
æags
)) {

5273 ~
C_Ex‹ÁCmpR—d
(è
	gov”ride
 {

5274 
d–‘e
 
	gfl_ex‹Á_ùx
;

5277 
fšish
(
r
è
	gov”ride
 {

5278 ià(
	gr
 =ğ-
ENOENT
) {

5279 
osd_İ
.
rv®
 = 0;

5280 
	g»ad_bl
.
ş—r
();

5281 
d–‘e
 
	gfl_ex‹Á_ùx
;

5283 
	gfl_ex‹Á_ùx
->
com¶‘e
(
r
);

5285 
	gfl_ex‹Á_ùx
 = 
nuÎ±r
;

5287 ià(
	gosd_İ
.
	grv®
 >= 0) {

5288 
osd_İ
.
rv®
 = 
´im¬y_log_pg
->
fšish_ex‹Á_cmp
(osd_İ, 
»ad_bl
);

5293 
	gPrim¬yLogPG
::
	$do_ex‹Á_cmp
(
OpCÚ‹xt
 *
ùx
, 
OSDOp
& 
osd_İ
)

5295 
	`dout
(20è<< 
__func__
 << 
d’dl
;

5296 
ûph_osd_İ
& 
İ
 = 
osd_İ
.op;

5298 auto& 
oi
 = 
ùx
->
Ãw_obs
.oi;

5299 
ušt64_t
 
size
 = 
oi
.size;

5300 ià((
oi
.
Œunÿ‹_£q
 < 
İ
.
ex‹Á
.truncate_seq) &&

5301 (
İ
.
ex‹Á
.
off£t
 + op.ex‹Á.
Ëngth
 > op.ex‹Á.
Œunÿ‹_size
)) {

5302 
size
 = 
İ
.
ex‹Á
.
Œunÿ‹_size
;

5305 ià(
İ
.
ex‹Á
.
off£t
 >ğ
size
) {

5306 
İ
.
ex‹Á
.
Ëngth
 = 0;

5307 } ià(
İ
.
ex‹Á
.
off£t
 + op.ex‹Á.
Ëngth
 > 
size
) {

5308 
İ
.
ex‹Á
.
Ëngth
 = 
size
 - op.ex‹Á.
off£t
;

5311 ià(
İ
.
ex‹Á
.
Ëngth
 == 0) {

5312 
	`dout
(20è<< 
__func__
 << " z”ØËngthƒx‹Á" << 
d’dl
;

5313  
	`fšish_ex‹Á_cmp
(
osd_İ
, 
bufã¾i¡
{});

5314 } ià(!
ùx
->
obs
->
exi¡s
 || ctx->obs->
oi
.
	`is_wh™eout
()) {

5315 
	`dout
(20è<< 
__func__
 << " objeù DNE" << 
d’dl
;

5316  
	`fšish_ex‹Á_cmp
(
osd_İ
, {});

5317 } ià(
poŞ
.
šfo
.
	`is_”asu»
()) {

5320 
boo¡
::
İtiÚ®
<
ušt32_t
> 
maybe_üc
;

5321 ià(
oi
.
	`is_d©a_dige¡
(è&& 
İ
.
checksum
.
off£t
 == 0 &&

5322 
İ
.
checksum
.
Ëngth
 >ğ
oi
.
size
) {

5323 
maybe_üc
 = 
oi
.
d©a_dige¡
;

5327 auto& 
soid
 = 
oi
.soid;

5328 autØ
ex‹Á_cmp_ùx
 = 
Ãw
 
	`C_Ex‹ÁCmpR—d
(
this
, 
osd_İ
, 
maybe_üc
, 
oi
.
size
,

5329 
osd
, 
soid
, 
İ
.
æags
);

5330 
ùx
->
³ndšg_async_»ads
.
	`push_back
({

5331 {
İ
.
ex‹Á
.
off£t
, op.ex‹Á.
Ëngth
, op.
æags
},

5332 {&
ex‹Á_cmp_ùx
->
»ad_bl
,ƒxtent_cmp_ctx}});

5334 
	`dout
(10è<< 
__func__
 << ":‡sync_»ad‚Ùed fÜ " << 
soid
 << 
d’dl
;

5336 
ùx
->
İ_fšish”s
[ùx->
cu¼’t_osd_subİ_num
].
	`»£t
(

5337 
Ãw
 
	`R—dFšish”
(
osd_İ
));

5338  -
EINPROGRESS
;

5342 
veùÜ
<
OSDOp
> 
	`»ad_İs
(1);

5343 
OSDOp
& 
»ad_İ
 = 
»ad_İs
[0];

5345 
»ad_İ
.
İ
.İ = 
CEPH_OSD_OP_SYNC_READ
;

5346 
»ad_İ
.
İ
.
ex‹Á
.
off£t
 = op.extent.offset;

5347 
»ad_İ
.
İ
.
ex‹Á
.
Ëngth
 = op.extent.length;

5348 
»ad_İ
.
İ
.
ex‹Á
.
Œunÿ‹_£q
 = op.extent.truncate_seq;

5349 
»ad_İ
.
İ
.
ex‹Á
.
Œunÿ‹_size
 = op.extent.truncate_size;

5351 
»suÉ
 = 
	`do_osd_İs
(
ùx
, 
»ad_İs
);

5352 ià(
»suÉ
 < 0) {

5353 
d”r
 << 
__func__
 << " faed " << 
»suÉ
 << 
d’dl
;

5354  
»suÉ
;

5356  
	`fšish_ex‹Á_cmp
(
osd_İ
, 
»ad_İ
.
outd©a
);

5357 
	}
}

5359 
	gPrim¬yLogPG
::
	$fšish_ex‹Á_cmp
(
OSDOp
& 
osd_İ
, cÚ¡ 
bufã¾i¡
 &
»ad_bl
)

5361 
ušt64_t
 
idx
 = 0; idx < 
osd_İ
.
šd©a
.
	`Ëngth
(); ++idx) {

5362 
»ad_by‹
 = (
idx
 < 
»ad_bl
.
	`Ëngth
() ?„ead_bl[idx] : 0);

5363 ià(
osd_İ
.
šd©a
[
idx
] !ğ
»ad_by‹
) {

5364  (-
MAX_ERRNO
 - 
idx
);

5369 
	}
}

5371 
	gPrim¬yLogPG
::
	$do_»ad
(
OpCÚ‹xt
 *
ùx
, 
OSDOp
& 
osd_İ
) {

5372 
	`dout
(20è<< 
__func__
 << 
d’dl
;

5373 auto& 
İ
 = 
osd_İ
.op;

5374 auto& 
oi
 = 
ùx
->
Ãw_obs
.oi;

5375 auto& 
soid
 = 
oi
.soid;

5376 
__u32
 
£q
 = 
oi
.
Œunÿ‹_£q
;

5377 
ušt64_t
 
size
 = 
oi
.size;

5378 
boŞ
 
Œimmed_»ad
 = 
çl£
;

5381 iàĞ(
£q
 < 
İ
.
ex‹Á
.
Œunÿ‹_£q
) &&

5382 (
İ
.
ex‹Á
.
off£t
 + op.ex‹Á.
Ëngth
 > op.ex‹Á.
Œunÿ‹_size
) )

5383 
size
 = 
İ
.
ex‹Á
.
Œunÿ‹_size
;

5385 ià(
İ
.
ex‹Á
.
Ëngth
 == 0)

5386 
İ
.
ex‹Á
.
Ëngth
 = 
size
;

5388 ià(
İ
.
ex‹Á
.
off£t
 >ğ
size
) {

5389 
İ
.
ex‹Á
.
Ëngth
 = 0;

5390 
Œimmed_»ad
 = 
Œue
;

5391 } ià(
İ
.
ex‹Á
.
off£t
 + op.ex‹Á.
Ëngth
 > 
size
) {

5392 
İ
.
ex‹Á
.
Ëngth
 = 
size
 - op.ex‹Á.
off£t
;

5393 
Œimmed_»ad
 = 
Œue
;

5397 
»suÉ
 = 0;

5398 ià(
Œimmed_»ad
 && 
İ
.
ex‹Á
.
Ëngth
 == 0) {

5402 } ià(
poŞ
.
šfo
.
	`is_”asu»
()) {

5405 
boo¡
::
İtiÚ®
<
ušt32_t
> 
maybe_üc
 = boo¡::
	`make_İtiÚ®
(
çl£
, 
	`ušt32_t
());

5409 ià(
oi
.
	`is_d©a_dige¡
(è&& 
İ
.
ex‹Á
.
off£t
 == 0 &&

5410 
İ
.
ex‹Á
.
Ëngth
 >ğ
oi
.
size
)

5411 
maybe_üc
 = 
oi
.
d©a_dige¡
;

5412 
ùx
->
³ndšg_async_»ads
.
	`push_back
(

5413 
	`make_·œ
(

5414 
boo¡
::
	`make_tu¶e
(
İ
.
ex‹Á
.
off£t
, op.ex‹Á.
Ëngth
, op.
æags
),

5415 
	`make_·œ
(&
osd_İ
.
outd©a
,

5416 
Ãw
 
	`FlInV”ifyEx‹Á
(&
İ
.
ex‹Á
.
Ëngth
, &
osd_İ
.
rv®
,

5417 &
osd_İ
.
outd©a
, 
maybe_üc
, 
oi
.
size
,

5418 
osd
, 
soid
, 
İ
.
æags
))));

5419 
	`dout
(10è<< "‡sync_»ad‚Ùed fÜ " << 
soid
 << 
d’dl
;

5421 
ùx
->
İ_fšish”s
[ùx->
cu¼’t_osd_subİ_num
].
	`»£t
(

5422 
Ãw
 
	`R—dFšish”
(
osd_İ
));

5424 
r
 = 
pgback’d
->
	`objeùs_»ad_sync
(

5425 
soid
, 
İ
.
ex‹Á
.
off£t
, op.ex‹Á.
Ëngth
, op.
æags
, &
osd_İ
.
outd©a
);

5427 ià(
r
 >ğ0 && 
İ
.
ex‹Á
.
Ëngth
 =ğ
oi
.
size
 && oi.
	`is_d©a_dige¡
()) {

5428 
ušt32_t
 
üc
 = 
osd_İ
.
outd©a
.
	`üc32c
(-1);

5429 ià(
oi
.
d©a_dige¡
 !ğ
üc
) {

5430 
osd
->
şog
->
	`”rÜ
(è<< 
šfo
.
pgid
 << 
¡d
::
hex


5431 << " fuÎ-objeù„—d crø0x" << 
üc


5432 << " !ğex³ùed 0x" << 
oi
.
d©a_dige¡


5433 << 
¡d
::
dec
 << " oÀ" << 
soid
;

5434 
r
 = -
EIO
;

5437 ià(
r
 =ğ-
EIO
) {

5438 
r
 = 
	`»p_»·œ_´im¬y_objeù
(
soid
, 
ùx
->
İ
);

5440 ià(
r
 >= 0)

5441 
İ
.
ex‹Á
.
Ëngth
 = 
r
;

5443 
»suÉ
 = 
r
;

5444 
İ
.
ex‹Á
.
Ëngth
 = 0;

5446 
	`dout
(10è<< "„—d gÙ " << 
r
 << " / " << 
İ
.
ex‹Á
.
Ëngth


5447 << " by‹ äom obj " << 
soid
 << 
d’dl
;

5452 
ùx
->
d–_¡©s
.
num_rd_kb
 +ğ
	`shiá_round_up
(
İ
.
ex‹Á
.
Ëngth
, 10);

5453 
ùx
->
d–_¡©s
.
num_rd
++;

5454  
»suÉ
;

5455 
	}
}

5457 
	gPrim¬yLogPG
::
	$do_¥¬£_»ad
(
OpCÚ‹xt
 *
ùx
, 
OSDOp
& 
osd_İ
) {

5458 
	`dout
(20è<< 
__func__
 << 
d’dl
;

5459 auto& 
İ
 = 
osd_İ
.op;

5460 auto& 
oi
 = 
ùx
->
Ãw_obs
.oi;

5461 auto& 
soid
 = 
oi
.soid;

5463 ià(
İ
.
ex‹Á
.
Œunÿ‹_£q
) {

5464 
	`dout
(0è<< "¥¬£_»ad dÛ nÙ suµÜˆŒunÿtiÚ sequ’û " << 
d’dl
;

5465  -
EINVAL
;

5468 ++
ùx
->
num_»ad
;

5469 ià(
poŞ
.
šfo
.
	`is_”asu»
()) {

5471 
ušt64_t
 
off£t
 = 
İ
.
ex‹Á
.offset;

5472 
ušt64_t
 
Ëngth
 = 
İ
.
ex‹Á
.length;

5473 ià(
off£t
 > 
oi
.
size
) {

5474 
Ëngth
 = 0;

5475 } ià(
off£t
 + 
Ëngth
 > 
oi
.
size
) {

5476 
Ëngth
 = 
oi
.
size
 - 
off£t
;

5479 ià(
Ëngth
 > 0) {

5480 
ùx
->
³ndšg_async_»ads
.
	`push_back
(

5481 
	`make_·œ
(

5482 
boo¡
::
	`make_tu¶e
(
off£t
, 
Ëngth
, 
İ
.
æags
),

5483 
	`make_·œ
(

5484 &
osd_İ
.
outd©a
,

5485 
Ãw
 
	`ToS·r£R—dResuÉ
(&
osd_İ
.
rv®
, &osd_İ.
outd©a
, 
off£t
,

5486 &
İ
.
ex‹Á
.
Ëngth
))));

5487 
	`dout
(10è<< "‡sync_»ad (wa ¥¬£_»adènÙed fÜ " << 
soid
 << 
d’dl
;

5489 
ùx
->
İ_fšish”s
[ùx->
cu¼’t_osd_subİ_num
].
	`»£t
(

5490 
Ãw
 
	`R—dFšish”
(
osd_İ
));

5492 
	`dout
(10è<< " s·r£„—dƒnded u°em±y fÜ " << 
soid
 << 
d’dl
;

5493 
m­
<
ušt64_t
, ušt64_t> 
ex‹Ás
;

5494 
	`’code
(
ex‹Ás
, 
osd_İ
.
outd©a
);

5498 
m­
<
ušt64_t
, ušt64_t> 
m
;

5499 
ušt32_t
 
tÙ®_»ad
 = 0;

5500 
r
 = 
osd
->
¡Üe
->
	`f›m­
(
ch
, 
	`ghobjeù_t
(
soid
, 
ghobjeù_t
::
NO_GEN
,

5501 
šfo
.
pgid
.
sh¬d
),

5502 
İ
.
ex‹Á
.
off£t
, op.ex‹Á.
Ëngth
, 
m
);

5503 ià(
r
 < 0) {

5504  
r
;

5507 
m­
<
ušt64_t
, ušt64_t>::
™”©Ü
 
m™”
;

5508 
bufã¾i¡
 
d©a_bl
;

5509 
ušt64_t
 
Ï¡
 = 
İ
.
ex‹Á
.
off£t
;

5510 
m™”
 = 
m
.
	`begš
(); m™” !ğm.
	`’d
(); ++miter) {

5512 ià(
cù
->
_cÚf
->
osd_v”ify_¥¬£_»ad_hŞes
 &&

5513 
Ï¡
 < 
m™”
->
fœ¡
) {

5514 
bufã¾i¡
 
t
;

5515 
ušt64_t
 
Ën
 = 
m™”
->
fœ¡
 - 
Ï¡
;

5516 
r
 = 
pgback’d
->
	`objeùs_»ad_sync
(
soid
, 
Ï¡
, 
Ën
, 
İ
.
æags
, &
t
);

5517 ià(
r
 < 0) {

5518 
osd
->
şog
->
	`”rÜ
(è<< 
cŞl
 << " " << 
soid


5520 << 
r
;

5521 } ià(!
t
.
	`is_z”o
()) {

5522 
osd
->
şog
->
	`”rÜ
(è<< 
cŞl
 << " " << 
soid


5524 << 
Ï¡
 << "~" << 
Ën
;

5528 
bufã¾i¡
 
tmpbl
;

5529 
r
 = 
pgback’d
->
	`objeùs_»ad_sync
(
soid
, 
m™”
->
fœ¡
, m™”->
£cÚd
,

5530 
İ
.
æags
, &
tmpbl
);

5531 ià(
r
 =ğ-
EIO
) {

5532 
r
 = 
	`»p_»·œ_´im¬y_objeù
(
soid
, 
ùx
->
İ
);

5534 ià(
r
 < 0) {

5535  
r
;

5540 ià(
r
 < ()
m™”
->
£cÚd
)

5541 
m™”
->
£cÚd
 = 
r
;

5542 
tÙ®_»ad
 +ğ
r
;

5543 
	`dout
(10è<< "¥¬£-»ad " << 
m™”
->
fœ¡
 << "@" << m™”->
£cÚd


5544 << 
d’dl
;

5545 
d©a_bl
.
	`şaim_­³nd
(
tmpbl
);

5546 
Ï¡
 = 
m™”
->
fœ¡
 + 
r
;

5550 ià(
cù
->
_cÚf
->
osd_v”ify_¥¬£_»ad_hŞes
) {

5551 
ušt64_t
 
’d
 = 
¡d
::
mš
<ušt64_t>(
İ
.
ex‹Á
.
off£t
 + op.ex‹Á.
Ëngth
,

5552 
oi
.
size
);

5553 ià(
Ï¡
 < 
’d
) {

5554 
bufã¾i¡
 
t
;

5555 
ušt64_t
 
Ën
 = 
’d
 - 
Ï¡
;

5556 
r
 = 
pgback’d
->
	`objeùs_»ad_sync
(
soid
, 
Ï¡
, 
Ën
, 
İ
.
æags
, &
t
);

5557 ià(
r
 < 0) {

5558 
osd
->
şog
->
	`”rÜ
(è<< 
cŞl
 << " " << 
soid


5559 << " s·r£-»ad faedØ»ad: " << 
r
;

5560 } ià(!
t
.
	`is_z”o
()) {

5561 
osd
->
şog
->
	`”rÜ
(è<< 
cŞl
 << " " << 
soid


5563 << 
Ï¡
 << "~" << 
Ën
;

5572 ià(
tÙ®_»ad
 =ğ
oi
.
size
 && oi.
	`is_d©a_dige¡
()) {

5573 
ušt32_t
 
üc
 = 
d©a_bl
.
	`üc32c
(-1);

5574 ià(
oi
.
d©a_dige¡
 !ğ
üc
) {

5575 
osd
->
şog
->
	`”rÜ
(è<< 
šfo
.
pgid
 << 
¡d
::
hex


5576 << " fuÎ-objeù„—d crø0x" << 
üc


5577 << " !ğex³ùed 0x" << 
oi
.
d©a_dige¡


5578 << 
¡d
::
dec
 << " oÀ" << 
soid
;

5580  -
EIO
;

5584 
İ
.
ex‹Á
.
Ëngth
 = 
tÙ®_»ad
;

5586 
	`’code
(
m
, 
osd_İ
.
outd©a
);

5587 ::
	`’code_de¡ruùiv–y
(
d©a_bl
, 
osd_İ
.
outd©a
);

5589 
	`dout
(10è<< " s·r£_»ad gÙ " << 
tÙ®_»ad
 << " bytes from object "

5590 << 
soid
 << 
d’dl
;

5593 
ùx
->
d–_¡©s
.
num_rd_kb
 +ğ
	`shiá_round_up
(
İ
.
ex‹Á
.
Ëngth
, 10);

5594 
ùx
->
d–_¡©s
.
num_rd
++;

5596 
	}
}

5598 
	gPrim¬yLogPG
::
do_osd_İs
(
OpCÚ‹xt
 *
ùx
, 
veùÜ
<
OSDOp
>& 
İs
)

5600 
	g»suÉ
 = 0;

5601 
SÇpS‘CÚ‹xt
 *
	gssc
 = 
ùx
->
obc
->
ssc
;

5602 
	gObjeùS‹
& 
	gobs
 = 
ùx
->
Ãw_obs
;

5603 
	gobjeù_šfo_t
& 
	goi
 = 
obs
.
oi
;

5604 cÚ¡ 
	ghobjeù_t
& 
	gsoid
 = 
oi
.
soid
;

5605 cÚ¡ 
boŞ
 
	gsk_d©a_dige¡
 = 
osd
->
¡Üe
->
has_butš_csum
() &&

5606 
osd
->
osd_sk_d©a_dige¡
;

5608 
PGT¿n§ùiÚ
* 
	gt
 = 
ùx
->
İ_t
.
g‘
();

5610 
dout
(10è<< "do_osd_İ " << 
	gsoid
 << " " << 
	gİs
 << 
	gd’dl
;

5612 
	gùx
->
	gcu¼’t_osd_subİ_num
 = 0;

5613 autØ
	gp
 = 
İs
.
begš
();… !ğİs.
’d
(); ++p, 
	gùx
->
	gcu¼’t_osd_subİ_num
++, ctx->
	g´oûs£d_subİ_couÁ
++) {

5614 
	gOSDOp
& 
	gosd_İ
 = *
p
;

5615 
	gûph_osd_İ
& 
	gİ
 = 
osd_İ
.
İ
;

5617 
OpFšish”
* 
	gİ_fšish”
 = 
nuÎ±r
;

5619 autØ
	gİ_fšish”_™
 = 
ùx
->
İ_fšish”s
.
fšd
(ùx->
cu¼’t_osd_subİ_num
);

5620 ià(
	gİ_fšish”_™
 !ğ
ùx
->
İ_fšish”s
.
’d
()) {

5621 
İ_fšish”
 = 
İ_fšish”_™
->
£cÚd
.
g‘
();

5629 
Œaûpošt
(
osd
, 
do_osd_İ_´e
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
İ
.İ, 
ûph_osd_İ_Çme
(İ.İ), op.
æags
);

5631 
dout
(10è<< "do_osd_İ " << 
	gosd_İ
 << 
	gd’dl
;

5633 
	gbufã¾i¡
::
™”©Ü
 
bp
 = 
osd_İ
.
šd©a
.
begš
();

5636 
	gİ
.op) {

5638 
	gCEPH_OSD_OP_WATCH
:

5639 
CEPH_OSD_OP_CACHE_EVICT
:

5640 
CEPH_OSD_OP_CACHE_FLUSH
:

5641 
CEPH_OSD_OP_CACHE_TRY_FLUSH
:

5642 
CEPH_OSD_OP_UNDIRTY
:

5643 
CEPH_OSD_OP_COPY_FROM
:

5644 
CEPH_OSD_OP_CACHE_PIN
:

5645 
CEPH_OSD_OP_CACHE_UNPIN
:

5646 
CEPH_OSD_OP_SET_REDIRECT
:

5647 
CEPH_OSD_OP_TIER_PROMOTE
:

5650 ià(
İ
.İ & 
CEPH_OSD_OP_MODE_WR
)

5651 
ùx
->
u£r_modify
 = 
Œue
;

5655 ià(
ûph_osd_İ_u£s_ex‹Á
(
İ
.op) &&

5656 
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
 == 1 &&

5657 
İ
.
ex‹Á
.
Œunÿ‹_size
 == (-1ULL)) {

5658 
İ
.
ex‹Á
.
Œunÿ‹_size
 = 0;

5659 
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
 = 0;

5663 ià(
	gİ
.İ =ğ
CEPH_OSD_OP_ZERO
 &&

5664 
obs
.
exi¡s
 &&

5665 
İ
.
ex‹Á
.
off£t
 < 
osd
->
osd_max_objeù_size
 &&

5666 
İ
.
ex‹Á
.
Ëngth
 >= 1 &&

5667 
İ
.
ex‹Á
.
Ëngth
 <ğ
osd
->
osd_max_objeù_size
 &&

5668 
İ
.
ex‹Á
.
off£t
 + op.ex‹Á.
Ëngth
 >ğ
oi
.
size
) {

5669 ià(
İ
.
ex‹Á
.
off£t
 >ğ
oi
.
size
) {

5671 
ç
;

5673 
dout
(10è<< " mungšg ZERO " << 
	gİ
.
	gex‹Á
.
	goff£t
 << "~" << op.ex‹Á.
	gËngth


5674 << " -> TRUNCATE " << 
	gİ
.
	gex‹Á
.
	goff£t
 << " (Şd sizi " << 
	goi
.
	gsize
 << ")" << 
	gd’dl
;

5675 
	gİ
.İ = 
CEPH_OSD_OP_TRUNCATE
;

5678 
	gİ
.op) {

5682 
	gCEPH_OSD_OP_CMPEXT
:

5683 ++
ùx
->
num_»ad
;

5684 
Œaûpošt
(
osd
, 
do_osd_İ_´e_ex‹Á_cmp
, 
soid
.
oid
.
Çme
.
c_¡r
(),

5685 
soid
.
¢­
.
v®
, 
oi
.
size
, oi.
Œunÿ‹_£q
, 
İ
.
ex‹Á
.
off£t
,

5686 
İ
.
ex‹Á
.
Ëngth
, op.ex‹Á.
Œunÿ‹_size
,

5687 
İ
.
ex‹Á
.
Œunÿ‹_£q
);

5689 ià(
	gİ_fšish”
 =ğ
nuÎ±r
) {

5690 
»suÉ
 = 
do_ex‹Á_cmp
(
ùx
, 
osd_İ
);

5692 
	g»suÉ
 = 
İ_fšish”
->
execu‹
();

5696 
	gCEPH_OSD_OP_SYNC_READ
:

5697 ià(
poŞ
.
šfo
.
is_”asu»
()) {

5698 
»suÉ
 = -
EOPNOTSUPP
;

5702 
	gCEPH_OSD_OP_READ
:

5703 ++
ùx
->
num_»ad
;

5704 
Œaûpošt
(
osd
, 
do_osd_İ_´e_»ad
, 
soid
.
oid
.
Çme
.
c_¡r
(),

5705 
soid
.
¢­
.
v®
, 
oi
.
size
, oi.
Œunÿ‹_£q
, 
İ
.
ex‹Á
.
off£t
,

5706 
İ
.
ex‹Á
.
Ëngth
, op.ex‹Á.
Œunÿ‹_size
,

5707 
İ
.
ex‹Á
.
Œunÿ‹_£q
);

5708 ià(
	gİ_fšish”
 =ğ
nuÎ±r
) {

5709 ià(!
ùx
->
d©a_off
) {

5710 
ùx
->
d©a_off
 = 
İ
.
ex‹Á
.
off£t
;

5712 
	g»suÉ
 = 
do_»ad
(
ùx
, 
osd_İ
);

5714 
	g»suÉ
 = 
İ_fšish”
->
execu‹
();

5718 
	gCEPH_OSD_OP_CHECKSUM
:

5719 ++
ùx
->
num_»ad
;

5721 
Œaûpošt
(
osd
, 
do_osd_İ_´e_checksum
, 
soid
.
oid
.
Çme
.
c_¡r
(),

5722 
soid
.
¢­
.
v®
, 
oi
.
size
, oi.
Œunÿ‹_£q
, 
İ
.
checksum
.
ty³
,

5723 
İ
.
checksum
.
off£t
, op.checksum.
Ëngth
,

5724 
İ
.
checksum
.
chunk_size
);

5726 ià(
	gİ_fšish”
 =ğ
nuÎ±r
) {

5727 
»suÉ
 = 
do_checksum
(
ùx
, 
osd_İ
, &
bp
);

5729 
	g»suÉ
 = 
İ_fšish”
->
execu‹
();

5735 
	gCEPH_OSD_OP_MAPEXT
:

5736 
Œaûpošt
(
osd
, 
do_osd_İ_´e_m­ext
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
İ
.
ex‹Á
.
off£t
, op.ex‹Á.
Ëngth
);

5737 ià(
	gpoŞ
.
	gšfo
.
is_”asu»
()) {

5738 
	g»suÉ
 = -
EOPNOTSUPP
;

5741 ++
	gùx
->
	gnum_»ad
;

5744 
bufã¾i¡
 
	gbl
;

5745 
	gr
 = 
osd
->
¡Üe
->
f›m­
(
ch
, 
ghobjeù_t
(
soid
, ghobjeù_t::
NO_GEN
,

5746 
šfo
.
pgid
.
sh¬d
),

5747 
İ
.
ex‹Á
.
off£t
, op.ex‹Á.
Ëngth
, 
bl
);

5748 
	gosd_İ
.
	goutd©a
.
şaim
(
bl
);

5749 ià(
	gr
 < 0)

5750 
	g»suÉ
 = 
r
;

5752 
	gùx
->
	gd–_¡©s
.
	gnum_rd_kb
 +ğ
shiá_round_up
(
bl
.
Ëngth
(), 10);

5753 
	gùx
->
	gd–_¡©s
.
	gnum_rd
++;

5754 
dout
(10è<< " m­_ex‹Á dÚÚ objeù " << 
	gsoid
 << 
	gd’dl
;

5759 
	gCEPH_OSD_OP_SPARSE_READ
:

5760 
Œaûpošt
(
osd
, 
do_osd_İ_´e_¥¬£_»ad
, 
soid
.
oid
.
Çme
.
c_¡r
(),

5761 
soid
.
¢­
.
v®
, 
oi
.
size
, oi.
Œunÿ‹_£q
, 
İ
.
ex‹Á
.
off£t
,

5762 
İ
.
ex‹Á
.
Ëngth
, op.ex‹Á.
Œunÿ‹_size
,

5763 
İ
.
ex‹Á
.
Œunÿ‹_£q
);

5764 ià(
	gİ_fšish”
 =ğ
nuÎ±r
) {

5765 
»suÉ
 = 
do_¥¬£_»ad
(
ùx
, 
osd_İ
);

5767 
	g»suÉ
 = 
İ_fšish”
->
execu‹
();

5771 
	gCEPH_OSD_OP_CALL
:

5773 
¡ršg
 
úame
, 
	gmÇme
;

5774 
bufã¾i¡
 
	gšd©a
;

5775 
	gŒy
 {

5776 
	gbp
.
cİy
(
İ
.
şs
.
şass_Ën
, 
úame
);

5777 
	gbp
.
cİy
(
İ
.
şs
.
m‘hod_Ën
, 
mÇme
);

5778 
	gbp
.
cİy
(
İ
.
şs
.
šd©a_Ën
, 
šd©a
);

5779 } 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

5780 
dout
(10è<< "ÿÎ uÇbËØdecodşas + m‘hod + ind©a" << 
d’dl
;

5781 
dout
(30) << "in dump: ";

5782 
	gosd_İ
.
	gšd©a
.
hexdump
(*
_dout
);

5783 *
	g_dout
 << 
	gd’dl
;

5784 
	g»suÉ
 = -
EINVAL
;

5785 
Œaûpošt
(
osd
, 
do_osd_İ_´e_ÿÎ
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, "???", "???");

5788 
Œaûpošt
(
osd
, 
do_osd_İ_´e_ÿÎ
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
úame
.c_¡r(), 
mÇme
.c_str());

5790 
	gCÏssHªdËr
::
CÏssD©a
 *
şs
;

5791 
	g»suÉ
 = 
osd
->
şass_hªdËr
->
İ’_şass
(
úame
, &
şs
);

5792 
as£¹
(
»suÉ
 == 0);

5794 
	gCÏssHªdËr
::
CÏssM‘hod
 *
m‘hod
 = 
şs
->
g‘_m‘hod
(
mÇme
.
c_¡r
());

5795 ià(!
	gm‘hod
) {

5796 
dout
(10è<< "ÿÎ m‘hod " << 
	gúame
 << "." << 
	gmÇme
 << " dÛ nÙƒxi¡" << 
	gd’dl
;

5797 
	g»suÉ
 = -
EOPNOTSUPP
;

5801 
	gæags
 = 
m‘hod
->
g‘_æags
();

5802 ià(
	gæags
 & 
	gCLS_METHOD_WR
)

5803 
	gùx
->
	gu£r_modify
 = 
Œue
;

5805 
bufã¾i¡
 
	goutd©a
;

5806 
dout
(10è<< "ÿÎ m‘hod " << 
	gúame
 << "." << 
	gmÇme
 << 
	gd’dl
;

5807 
	g´ev_rd
 = 
ùx
->
num_»ad
;

5808 
	g´ev_wr
 = 
ùx
->
num_wr™e
;

5809 
	g»suÉ
 = 
m‘hod
->
exec
((
şs_m‘hod_cÚ‹xt_t
)&
ùx
, 
šd©a
, 
outd©a
);

5811 ià(
	gùx
->
	gnum_»ad
 > 
	g´ev_rd
 && !(
	gæags
 & 
	gCLS_METHOD_RD
)) {

5812 
	gd”r
 << "m‘hod " << 
	gúame
 << "." << 
	gmÇme
 << "r›dØ»ad objeù buˆi nÙ m¬ked RD" << 
	gd’dl
;

5813 
	g»suÉ
 = -
EIO
;

5816 ià(
	gùx
->
	gnum_wr™e
 > 
	g´ev_wr
 && !(
	gæags
 & 
	gCLS_METHOD_WR
)) {

5817 
	gd”r
 << "m‘hod " << 
	gúame
 << "." << 
	gmÇme
 << "r›dØupd©objeù buˆi nÙ m¬ked WR" << 
	gd’dl
;

5818 
	g»suÉ
 = -
EIO
;

5822 
dout
(10è<< "m‘hod c®Ëd„e¥Ú£†’gth=" << 
	goutd©a
.
Ëngth
(è<< 
	gd’dl
;

5823 
	gİ
.
	gex‹Á
.
	gËngth
 = 
outd©a
.
Ëngth
();

5824 
	gosd_İ
.
	goutd©a
.
şaim_­³nd
(
outd©a
);

5825 
dout
(30) << "out dump: ";

5826 
	gosd_İ
.
	goutd©a
.
hexdump
(*
_dout
);

5827 *
	g_dout
 << 
	gd’dl
;

5831 
	gCEPH_OSD_OP_STAT
:

5834 
Œaûpošt
(
osd
, 
do_osd_İ_´e_¡©
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

5836 ià(
	gobs
.
	gexi¡s
 && !
	goi
.
is_wh™eout
()) {

5837 
’code
(
oi
.
size
, 
osd_İ
.
outd©a
);

5838 
’code
(
oi
.
mtime
, 
osd_İ
.
outd©a
);

5839 
dout
(10è<< "¡© o˜ha " << 
	goi
.
	gsize
 << " " << oi.
	gmtime
 << 
	gd’dl
;

5841 
	g»suÉ
 = -
ENOENT
;

5842 
dout
(10è<< "¡© o˜objeù dÛ nÙƒxi¡" << 
	gd’dl
;

5845 
	gùx
->
	gd–_¡©s
.
	gnum_rd
++;

5849 
	gCEPH_OSD_OP_ISDIRTY
:

5850 ++
ùx
->
num_»ad
;

5852 
Œaûpošt
(
osd
, 
do_osd_İ_´e_isdœty
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

5853 
boŞ
 
	gis_dœty
 = 
obs
.
oi
.
is_dœty
();

5854 
’code
(
is_dœty
, 
osd_İ
.
outd©a
);

5855 
	gùx
->
	gd–_¡©s
.
	gnum_rd
++;

5856 
	g»suÉ
 = 0;

5860 
	gCEPH_OSD_OP_UNDIRTY
:

5861 ++
ùx
->
num_wr™e
;

5863 
Œaûpošt
(
osd
, 
do_osd_İ_´e_undœty
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

5864 ià(
	goi
.
is_dœty
()) {

5865 
	gùx
->
	gundœty
 = 
Œue
;

5866 
	gùx
->
	gmodify
 = 
Œue
;

5867 
	gùx
->
	gd–_¡©s
.
	gnum_wr
++;

5869 
	g»suÉ
 = 0;

5873 
	gCEPH_OSD_OP_CACHE_TRY_FLUSH
:

5874 ++
ùx
->
num_wr™e
;

5876 
Œaûpošt
(
osd
, 
do_osd_İ_´e_Œy_æush
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

5877 ià(
	gùx
->
	glock_ty³
 !ğ
ObjeùCÚ‹xt
::
RWS‹
::
RWNONE
) {

5878 
dout
(10è<< "ÿche-Œy-æush w™houˆSKIPRWLOCKS fÏg s‘" << 
d’dl
;

5879 
	g»suÉ
 = -
EINVAL
;

5882 ià(
	gpoŞ
.
	gšfo
.
	gÿche_mode
 =ğ
pg_poŞ_t
::
CACHEMODE_NONE
) {

5883 
»suÉ
 = -
EINVAL
;

5886 ià(!
	gobs
.
	gexi¡s
) {

5887 
	g»suÉ
 = 0;

5890 ià(
	goi
.
is_ÿche_pšÃd
()) {

5891 
dout
(10è<< "ÿche-Œy-æush oÀ¨pšÃd objeù, cÚsid” uÅšhi objeù fœ¡" << 
	gd’dl
;

5892 
	g»suÉ
 = -
EPERM
;

5895 ià(
	goi
.
is_dœty
()) {

5896 
	g»suÉ
 = 
¡¬t_æush
(
ùx
->
İ
, ctx->
obc
, 
çl£
, 
NULL
, 
boo¡
::
nÚe
);

5897 ià(
	g»suÉ
 =ğ-
EINPROGRESS
)

5898 
»suÉ
 = -
EAGAIN
;

5900 
	g»suÉ
 = 0;

5905 
	gCEPH_OSD_OP_CACHE_FLUSH
:

5906 ++
ùx
->
num_wr™e
;

5908 
Œaûpošt
(
osd
, 
do_osd_İ_´e_ÿche_æush
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

5909 ià(
	gùx
->
	glock_ty³
 =ğ
ObjeùCÚ‹xt
::
RWS‹
::
RWNONE
) {

5910 
dout
(10è<< "ÿche-æush w™h SKIPRWLOCKS fÏg s‘" << 
d’dl
;

5911 
	g»suÉ
 = -
EINVAL
;

5914 ià(
	gpoŞ
.
	gšfo
.
	gÿche_mode
 =ğ
pg_poŞ_t
::
CACHEMODE_NONE
) {

5915 
»suÉ
 = -
EINVAL
;

5918 ià(!
	gobs
.
	gexi¡s
) {

5919 
	g»suÉ
 = 0;

5922 ià(
	goi
.
is_ÿche_pšÃd
()) {

5923 
dout
(10è<< "ÿche-æush oÀ¨pšÃd objeù, cÚsid” uÅšhi objeù fœ¡" << 
	gd’dl
;

5924 
	g»suÉ
 = -
EPERM
;

5927 
hobjeù_t
 
	gmissšg
;

5928 ià(
	goi
.
is_dœty
()) {

5929 
	g»suÉ
 = 
¡¬t_æush
(
ùx
->
İ
, ctx->
obc
, 
Œue
, &
missšg
, 
boo¡
::
nÚe
);

5930 ià(
	g»suÉ
 =ğ-
EINPROGRESS
)

5931 
»suÉ
 = -
EAGAIN
;

5933 
	g»suÉ
 = 0;

5936 ià(
	g»suÉ
 =ğ-
ENOENT
) {

5937 
dout
(10è<< 
__func__
 << " CEPH_OSD_OP_CACHE_FLUSH gÙ ENOENT" << 
d’dl
;

5938 
as£¹
(!
missšg
.
is_mš
());

5939 
wa™_fÜ_uÄ—dabË_objeù
(
missšg
, 
ùx
->
İ
);

5941 
	g»suÉ
 = -
EAGAIN
;

5946 
	gCEPH_OSD_OP_CACHE_EVICT
:

5947 ++
ùx
->
num_wr™e
;

5949 
Œaûpošt
(
osd
, 
do_osd_İ_´e_ÿche_eviù
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

5950 ià(
	gpoŞ
.
	gšfo
.
	gÿche_mode
 =ğ
pg_poŞ_t
::
CACHEMODE_NONE
) {

5951 
»suÉ
 = -
EINVAL
;

5954 ià(!
	gobs
.
	gexi¡s
) {

5955 
	g»suÉ
 = 0;

5958 ià(
	goi
.
is_ÿche_pšÃd
()) {

5959 
dout
(10è<< "ÿche-eviù oÀ¨pšÃd objeù, cÚsid” uÅšhi objeù fœ¡" << 
	gd’dl
;

5960 
	g»suÉ
 = -
EPERM
;

5963 ià(
	goi
.
is_dœty
()) {

5964 
	g»suÉ
 = -
EBUSY
;

5967 ià(!
	goi
.
	gw©ch”s
.
em±y
()) {

5968 
	g»suÉ
 = -
EBUSY
;

5971 ià(
	gsoid
.
	g¢­
 =ğ
CEPH_NOSNAP
) {

5972 
»suÉ
 = 
_v”ify_no_h—d_şÚes
(
soid
, 
ssc
->
¢­£t
);

5973 ià(
	g»suÉ
 < 0)

5976 
	g»suÉ
 = 
_d–‘e_oid
(
ùx
, 
Œue
, 
çl£
);

5977 ià(
	g»suÉ
 >= 0) {

5980 
ùx
->
ÿche_eviù
 = 
Œue
;

5982 
	gosd
->
	glogg”
->
šc
(
l_osd_t›r_eviù
);

5986 
	gCEPH_OSD_OP_GETXATTR
:

5987 ++
ùx
->
num_»ad
;

5989 
¡ršg
 
	gªame
;

5990 
	gbp
.
cİy
(
İ
.
x©Œ
.
Çme_Ën
, 
ªame
);

5991 
Œaûpošt
(
osd
, 
do_osd_İ_´e_g‘x©Œ
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
ªame
.c_str());

5992 
¡ršg
 
	gÇme
 = "_" + 
ªame
;

5993 
	gr
 = 
g‘©Œ_maybe_ÿche
(

5994 
ùx
->
obc
,

5995 
Çme
,

5996 &(
osd_İ
.
outd©a
));

5997 ià(
	gr
 >= 0) {

5998 
İ
.
x©Œ
.
v®ue_Ën
 = 
osd_İ
.
outd©a
.
Ëngth
();

5999 
	g»suÉ
 = 0;

6000 
	gùx
->
	gd–_¡©s
.
	gnum_rd_kb
 +ğ
shiá_round_up
(
osd_İ
.
outd©a
.
Ëngth
(), 10);

6002 
	g»suÉ
 = 
r
;

6004 
	gùx
->
	gd–_¡©s
.
	gnum_rd
++;

6008 
	gCEPH_OSD_OP_GETXATTRS
:

6009 ++
ùx
->
num_»ad
;

6011 
Œaûpošt
(
osd
, 
do_osd_İ_´e_g‘x©Œs
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

6012 
	gm­
<
	g¡ršg
, 
	gbufã¾i¡
> 
	gout
;

6013 
	g»suÉ
 = 
g‘©Œs_maybe_ÿche
(

6014 
ùx
->
obc
,

6015 &
out
);

6017 
bufã¾i¡
 
	gbl
;

6018 
’code
(
out
, 
bl
);

6019 
	gùx
->
	gd–_¡©s
.
	gnum_rd_kb
 +ğ
shiá_round_up
(
bl
.
Ëngth
(), 10);

6020 
	gùx
->
	gd–_¡©s
.
	gnum_rd
++;

6021 
	gosd_İ
.
	goutd©a
.
şaim_­³nd
(
bl
);

6025 
	gCEPH_OSD_OP_CMPXATTR
:

6026 ++
ùx
->
num_»ad
;

6028 
¡ršg
 
	gªame
;

6029 
	gbp
.
cİy
(
İ
.
x©Œ
.
Çme_Ën
, 
ªame
);

6030 
Œaûpošt
(
osd
, 
do_osd_İ_´e_cmpx©Œ
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
ªame
.c_str());

6031 
¡ršg
 
	gÇme
 = "_" + 
ªame
;

6032 
	gÇme
[
İ
.
x©Œ
.
Çme_Ën
 + 1] = 0;

6034 
bufã¾i¡
 
	gx©Œ
;

6035 
	g»suÉ
 = 
g‘©Œ_maybe_ÿche
(

6036 
ùx
->
obc
,

6037 
Çme
,

6038 &
x©Œ
);

6039 ià(
	g»suÉ
 < 0 &&„esuÉ !ğ-
EEXIST
 && 
»suÉ
 !ğ-
ENODATA
)

6042 
	gùx
->
	gd–_¡©s
.
	gnum_rd
++;

6043 
	gùx
->
	gd–_¡©s
.
	gnum_rd_kb
 +ğ
shiá_round_up
(
x©Œ
.
Ëngth
(), 10);

6045 
	gİ
.
	gx©Œ
.
	gcmp_mode
) {

6046 
	gCEPH_OSD_CMPXATTR_MODE_STRING
:

6048 
¡ršg
 
v®
;

6049 
	gbp
.
cİy
(
İ
.
x©Œ
.
v®ue_Ën
, 
v®
);

6050 
	gv®
[
İ
.
x©Œ
.
v®ue_Ën
] = 0;

6051 
dout
(10è<< "CEPH_OSD_OP_CMPXATTR‚ame=" << 
	gÇme
 << " v®=" << 
	gv®


6052 << " op=" << ()
	gİ
.
	gx©Œ
.
	gcmp_İ
 << " mode=" << ()İ.x©Œ.
	gcmp_mode
 << 
	gd’dl
;

6053 
	g»suÉ
 = 
do_x©Œ_cmp_¡r
(
İ
.
x©Œ
.
cmp_İ
, 
v®
, xattr);

6057 
	gCEPH_OSD_CMPXATTR_MODE_U64
:

6059 
ušt64_t
 
u64v®
;

6060 
	gŒy
 {

6061 
decode
(
u64v®
, 
bp
);

6063 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

6064 
»suÉ
 = -
EINVAL
;

6065 
	gç
;

6067 
dout
(10è<< "CEPH_OSD_OP_CMPXATTR‚ame=" << 
	gÇme
 << " v®=" << 
	gu64v®


6068 << " op=" << ()
	gİ
.
	gx©Œ
.
	gcmp_İ
 << " mode=" << ()İ.x©Œ.
	gcmp_mode
 << 
	gd’dl
;

6069 
	g»suÉ
 = 
do_x©Œ_cmp_u64
(
İ
.
x©Œ
.
cmp_İ
, 
u64v®
, xattr);

6074 
dout
(10è<< "bad cm°mod" << ()
İ
.
x©Œ
.
cmp_mode
 << 
d’dl
;

6075 
	g»suÉ
 = -
EINVAL
;

6078 ià(!
	g»suÉ
) {

6079 
dout
(10è<< "com·risÚ„‘uºed f®£" << 
	gd’dl
;

6080 
	g»suÉ
 = -
ECANCELED
;

6083 ià(
	g»suÉ
 < 0) {

6084 
dout
(10è<< "com·risÚ„‘uºed " << 
	g»suÉ
 << " " << 
ıp_¡»¼Ü
(-
»suÉ
è<< 
	gd’dl
;

6088 
dout
(10è<< "com·risÚ„‘uºedrue" << 
	gd’dl
;

6092 
	gCEPH_OSD_OP_ASSERT_VER
:

6093 ++
ùx
->
num_»ad
;

6095 
ušt64_t
 
	gv”
 = 
İ
.
as£¹_v”
.
v”
;

6096 
Œaûpošt
(
osd
, 
do_osd_İ_´e_as£¹_v”
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
v”
);

6097 ià(!
	gv”
)

6098 
	g»suÉ
 = -
EINVAL
;

6099 ià(
	gv”
 < 
	goi
.
	gu£r_v”siÚ
)

6100 
	g»suÉ
 = -
ERANGE
;

6101 ià(
	gv”
 > 
	goi
.
	gu£r_v”siÚ
)

6102 
	g»suÉ
 = -
EOVERFLOW
;

6106 
	gCEPH_OSD_OP_LIST_WATCHERS
:

6107 ++
ùx
->
num_»ad
;

6109 
Œaûpošt
(
osd
, 
do_osd_İ_´e_li¡_w©ch”s
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

6110 
obj_li¡_w©ch_»¥Ú£_t
 
	g»¥
;

6112 
	gm­
<
	g·œ
<
	gušt64_t
, 
	g’t™y_Çme_t
>, 
	gw©ch_šfo_t
>::
cÚ¡_™”©Ü
 
oi_™”
;

6113 
	goi_™”
 = 
oi
.
w©ch”s
.
begš
(); oi_™” !ğoi.w©ch”s.
’d
();

6114 ++
	goi_™”
) {

6115 
dout
(20è<< "key cook›=" << 
	goi_™”
->
	gfœ¡
.first

6116 << "ƒÁ™y=" << 
	goi_™”
->
	gfœ¡
.
	g£cÚd
 << " "

6117 << 
	goi_™”
->
	g£cÚd
 << 
	gd’dl
;

6118 
as£¹
(
oi_™”
->
fœ¡
.fœ¡ =ğoi_™”->
£cÚd
.
cook›
);

6119 
as£¹
(
oi_™”
->
fœ¡
.
£cÚd
.
is_ş›Á
());

6121 
w©ch_™em_t
 
wi
(
oi_™”
->
fœ¡
.
£cÚd
, oi_™”->£cÚd.
cook›
,

6122 
oi_™”
->
£cÚd
.
timeout_£cÚds
, oi_™”->£cÚd.
addr
);

6123 
	g»¥
.
	g’Œ›s
.
push_back
(
wi
);

6126 
	g»¥
.
’code
(
osd_İ
.
outd©a
, 
ùx
->
g‘_ã©u»s
());

6127 
	g»suÉ
 = 0;

6129 
	gùx
->
	gd–_¡©s
.
	gnum_rd
++;

6133 
	gCEPH_OSD_OP_LIST_SNAPS
:

6134 ++
ùx
->
num_»ad
;

6136 
Œaûpošt
(
osd
, 
do_osd_İ_´e_li¡_¢­s
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

6137 
obj_li¡_¢­_»¥Ú£_t
 
	g»¥
;

6139 ià(!
	gssc
) {

6140 
	gssc
 = 
ùx
->
obc
->
ssc
 = 
g‘_¢­£t_cÚ‹xt
(
soid
, 
çl£
);

6142 
as£¹
(
ssc
);

6143 
dout
(20è<< " sÇp£ˆ" << 
	gssc
->
	g¢­£t
 << 
	gd’dl
;

6145 
	gşÚecouÁ
 = 
ssc
->
¢­£t
.
şÚes
.
size
();

6146 
	gşÚecouÁ
++;

6147 
	g»¥
.
	gşÚes
.
»£rve
(
şÚecouÁ
);

6148 autØ
	gşÚe_™”
 = 
ssc
->
¢­£t
.
şÚes
.
begš
();

6149 
	gşÚe_™”
 !ğ
ssc
->
¢­£t
.
şÚes
.
’d
(); ++clone_iter) {

6150 
şÚe_šfo
 
	gci
;

6151 
	gci
.
	gşÚeid
 = *
şÚe_™”
;

6153 
hobjeù_t
 
	gşÚe_oid
 = 
soid
;

6154 
	gşÚe_oid
.
	g¢­
 = *
şÚe_™”
;

6156 autØ
	gp
 = 
ssc
->
¢­£t
.
şÚe_¢­s
.
fšd
(*
şÚe_™”
);

6157 ià(
	gp
 =ğ
ssc
->
¢­£t
.
şÚe_¢­s
.
’d
()) {

6158 
osd
->
şog
->
”rÜ
(è<< "osd." << osd->
whßmi


6160 << 
soid
 << " clÚ" << *
şÚe_™”


6161 << " sÇp£ˆ" << 
ssc
->
¢­£t
;

6162 
	g»suÉ
 = -
EINVAL
;

6165 autØ
	gq
 = 
p
->
£cÚd
.
rbegš
(); q !ğp->£cÚd.
»nd
(); ++q) {

6166 
	gci
.
	g¢­s
.
push_back
(*
q
);

6169 
dout
(20è<< " clÚ" << *
	gşÚe_™”
 << " sÇp " << 
	gci
.
	g¢­s
 << 
	gd’dl
;

6171 
	gm­
<
	g¢­id_t
, 
	gš‹rv®_£t
<
	gušt64_t
> >::
cÚ¡_™”©Ü
 
coi
;

6172 
	gcoi
 = 
ssc
->
¢­£t
.
şÚe_ov”Ïp
.
fšd
(
ci
.
şÚeid
);

6173 ià(
	gcoi
 =ğ
ssc
->
¢­£t
.
şÚe_ov”Ïp
.
’d
()) {

6174 
osd
->
şog
->
”rÜ
(è<< "osd." << osd->
whßmi


6176 << 
soid
 << " clÚ" << *
şÚe_™”
;

6177 
	g»suÉ
 = -
EINVAL
;

6180 cÚ¡ 
	gš‹rv®_£t
<
	gušt64_t
> &
	go
 = 
coi
->
£cÚd
;

6181 
	gci
.
	gov”Ïp
.
»£rve
(
o
.
num_š‹rv®s
());

6182 
	gš‹rv®_£t
<
	gušt64_t
>::
cÚ¡_™”©Ü
 
r
 = 
o
.
begš
();

6183 
	gr
 !ğ
o
.
’d
(); ++r) {

6184 
	gci
.
	gov”Ïp
.
push_back
(
·œ
<
ušt64_t
,ušt64_t>(
r
.
g‘_¡¬t
(),

6185 
r
.
g‘_Ën
()));

6188 
	gm­
<
	g¢­id_t
, 
	gušt64_t
>::
cÚ¡_™”©Ü
 
si
;

6189 
	gsi
 = 
ssc
->
¢­£t
.
şÚe_size
.
fšd
(
ci
.
şÚeid
);

6190 ià(
	gsi
 =ğ
ssc
->
¢­£t
.
şÚe_size
.
’d
()) {

6191 
osd
->
şog
->
”rÜ
(è<< "osd." << osd->
whßmi


6193 << 
soid
 << " clÚ" << *
şÚe_™”
;

6194 
	g»suÉ
 = -
EINVAL
;

6197 
	gci
.
	gsize
 = 
si
->
£cÚd
;

6199 
	g»¥
.
	gşÚes
.
push_back
(
ci
);

6201 ià(
	g»suÉ
 < 0) {

6204 ià(!
	gùx
->
	gobc
->
	gobs
.
	goi
.
is_wh™eout
()) {

6205 
as£¹
(
obs
.
exi¡s
);

6206 
şÚe_šfo
 
	gci
;

6207 
	gci
.
	gşÚeid
 = 
CEPH_NOSNAP
;

6210 
	gci
.
	gsize
 = 
oi
.
size
;

6212 
	g»¥
.
	gşÚes
.
push_back
(
ci
);

6214 
	g»¥
.
	g£q
 = 
ssc
->
¢­£t
.
£q
;

6216 
	g»¥
.
’code
(
osd_İ
.
outd©a
);

6217 
	g»suÉ
 = 0;

6219 
	gùx
->
	gd–_¡©s
.
	gnum_rd
++;

6223 
	gCEPH_OSD_OP_NOTIFY
:

6224 ++
ùx
->
num_»ad
;

6226 
ušt32_t
 
	gtimeout
;

6227 
bufã¾i¡
 
	gbl
;

6229 
	gŒy
 {

6230 
ušt32_t
 
	gv”
;

6231 
decode
(
v”
, 
bp
);

6232 
decode
(
timeout
, 
bp
);

6233 
decode
(
bl
, 
bp
);

6234 } 
ÿtch
 (cÚ¡ 
bufãr
::
”rÜ
 &
e
) {

6235 
timeout
 = 0;

6237 
Œaûpošt
(
osd
, 
do_osd_İ_´e_nÙify
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
timeout
);

6238 ià(!
	gtimeout
)

6239 
	gtimeout
 = 
cù
->
_cÚf
->
osd_deçuÉ_nÙify_timeout
;

6241 
nÙify_šfo_t
 
	gn
;

6242 
	gn
.
	gtimeout
 = 
timeout
;

6243 
	gn
.
	gnÙify_id
 = 
osd
->
g‘_Ãxt_id
(
g‘_osdm­
()->
g‘_•och
());

6244 
	gn
.
	gcook›
 = 
İ
.
w©ch
.
cook›
;

6245 
	gn
.
	gbl
 = 
bl
;

6246 
	gùx
->
	gnÙif›s
.
push_back
(
n
);

6249 
’code
(
n
.
nÙify_id
, 
osd_İ
.
outd©a
);

6253 
	gCEPH_OSD_OP_NOTIFY_ACK
:

6254 ++
ùx
->
num_»ad
;

6256 
	gŒy
 {

6257 
ušt64_t
 
	gnÙify_id
 = 0;

6258 
ušt64_t
 
	gw©ch_cook›
 = 0;

6259 
decode
(
nÙify_id
, 
bp
);

6260 
decode
(
w©ch_cook›
, 
bp
);

6261 
bufã¾i¡
 
	g»¶y_bl
;

6262 ià(!
	gbp
.
’d
()) {

6263 
decode
(
»¶y_bl
, 
bp
);

6265 
Œaûpošt
(
osd
, 
do_osd_İ_´e_nÙify_ack
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
nÙify_id
, 
w©ch_cook›
, "Y");

6266 
	gOpCÚ‹xt
::
NÙifyAck
 
ack
(
nÙify_id
, 
w©ch_cook›
, 
»¶y_bl
);

6267 
	gùx
->
	gnÙify_acks
.
push_back
(
ack
);

6268 } 
ÿtch
 (cÚ¡ 
bufãr
::
”rÜ
 &
e
) {

6269 
Œaûpošt
(
osd
, 
do_osd_İ_´e_nÙify_ack
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
İ
.
w©ch
.
cook›
, 0, "N");

6270 
	gOpCÚ‹xt
::
NÙifyAck
 
ack
(

6272 
İ
.
w©ch
.
cook›


6274 
	gùx
->
	gnÙify_acks
.
push_back
(
ack
);

6279 
	gCEPH_OSD_OP_SETALLOCHINT
:

6280 ++
ùx
->
num_wr™e
;

6282 
Œaûpošt
(
osd
, 
do_osd_İ_´e_£Îochšt
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
İ
.
®loc_hšt
.
ex³ùed_objeù_size
, op.®loc_hšt.
ex³ùed_wr™e_size
);

6283 
maybe_ü—‹_Ãw_objeù
(
ùx
);

6284 
	goi
.
	gex³ùed_objeù_size
 = 
İ
.
®loc_hšt
.
ex³ùed_objeù_size
;

6285 
	goi
.
	gex³ùed_wr™e_size
 = 
İ
.
®loc_hšt
.
ex³ùed_wr™e_size
;

6286 
	goi
.
	g®loc_hšt_æags
 = 
İ
.
®loc_hšt
.
æags
;

6287 
	gt
->
£t_®loc_hšt
(
soid
, 
İ
.
®loc_hšt
.
ex³ùed_objeù_size
,

6288 
İ
.
®loc_hšt
.
ex³ùed_wr™e_size
,

6289 
İ
.
®loc_hšt
.
æags
);

6290 
	gùx
->
	gd–_¡©s
.
	gnum_wr
++;

6291 
	g»suÉ
 = 0;

6300 
	gCEPH_OSD_OP_WRITE
:

6301 ++
ùx
->
num_wr™e
;

6303 
__u32
 
	g£q
 = 
oi
.
Œunÿ‹_£q
;

6304 
Œaûpošt
(
osd
, 
do_osd_İ_´e_wr™e
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
oi
.
size
, 
£q
, 
İ
.
ex‹Á
.
off£t
, op.ex‹Á.
Ëngth
, op.ex‹Á.
Œunÿ‹_size
, op.ex‹Á.
Œunÿ‹_£q
);

6305 ià(
	gİ
.
	gex‹Á
.
	gËngth
 !ğ
osd_İ
.
šd©a
.
Ëngth
()) {

6306 
»suÉ
 = -
EINVAL
;

6310 ià(
	gpoŞ
.
	gšfo
.
has_æag
(
pg_poŞ_t
::
FLAG_WRITE_FADVISE_DONTNEED
))

6311 
İ
.
æags
 = op.æag | 
CEPH_OSD_OP_FLAG_FADVISE_DONTNEED
;

6313 ià(
	gpoŞ
.
	gšfo
.
»quœes_®igÃd_­³nd
() &&

6314 (
	gİ
.
	gex‹Á
.
	goff£t
 % 
	gpoŞ
.
	gšfo
.
»quœed_®ignm’t
() != 0)) {

6315 
»suÉ
 = -
EOPNOTSUPP
;

6319 ià(!
	gobs
.
	gexi¡s
) {

6320 ià(
	gpoŞ
.
	gšfo
.
»quœes_®igÃd_­³nd
(è&& 
	gİ
.
	gex‹Á
.
	goff£t
) {

6321 
	g»suÉ
 = -
EOPNOTSUPP
;

6324 } ià(
	gİ
.
	gex‹Á
.
	goff£t
 !ğ
oi
.
size
 &&

6325 
poŞ
.
šfo
.
»quœes_®igÃd_­³nd
()) {

6326 
»suÉ
 = -
EOPNOTSUPP
;

6330 ià(
	g£q
 && (£q > 
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
) &&

6331 (
	gİ
.
	gex‹Á
.
	goff£t
 + op.ex‹Á.
	gËngth
 > 
	goi
.
	gsize
)) {

6333 
	gİ
.
	gex‹Á
.
	gËngth
 = (
İ
.
ex‹Á
.
off£t
 > 
oi
.
size
 ? 0 : oi.size - op.extent.offset);

6334 
dout
(10è<< " oldrunÿ‹_£q " << 
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
 << " < cu¼’ˆ" << 
	g£q


6335 << ",‡dju¡šg wr™ËngthØ" << 
	gİ
.
	gex‹Á
.
	gËngth
 << 
	gd’dl
;

6336 
bufã¾i¡
 
	gt
;

6337 
	gt
.
sub¡r_of
(
osd_İ
.
šd©a
, 0, 
İ
.
ex‹Á
.
Ëngth
);

6338 
	gosd_İ
.
	gšd©a
.
sw­
(
t
);

6340 ià(
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
 > 
	g£q
) {

6342 ià(
	gobs
.
	gexi¡s
 && !
	goi
.
is_wh™eout
()) {

6343 
dout
(10è<< "runÿ‹_£q " << 
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
 << " > cu¼’ˆ" << 
	g£q


6344 << ",runÿtšgØ" << 
	gİ
.
	gex‹Á
.
	gŒunÿ‹_size
 << 
	gd’dl
;

6345 
	gt
->
Œunÿ‹
(
soid
, 
İ
.
ex‹Á
.
Œunÿ‹_size
);

6346 
	goi
.
	gŒunÿ‹_£q
 = 
İ
.
ex‹Á
.
Œunÿ‹_£q
;

6347 
	goi
.
	gŒunÿ‹_size
 = 
İ
.
ex‹Á
.
Œunÿ‹_size
;

6348 ià(
	goi
.
	gsize
 > 
	gİ
.
	gex‹Á
.
	gŒunÿ‹_size
) {

6349 
	gš‹rv®_£t
<
	gušt64_t
> 
	gŒim
;

6350 
	gŒim
.
š£¹
(
İ
.
ex‹Á
.
Œunÿ‹_size
,

6351 
oi
.
size
 - 
İ
.
ex‹Á
.
Œunÿ‹_size
);

6352 
	gùx
->
	gmodif›d_¿nges
.
uniÚ_of
(
Œim
);

6354 ià(
	gİ
.
	gex‹Á
.
	gŒunÿ‹_size
 !ğ
oi
.
size
) {

6355 
Œunÿ‹_upd©e_size_ªd_u§ge
(
ùx
->
d–_¡©s
,

6356 
oi
,

6357 
İ
.
ex‹Á
.
Œunÿ‹_size
);

6360 
dout
(10è<< "runÿ‹_£q " << 
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
 << " > cu¼’ˆ" << 
	g£q


6361 << ", buˆobjeù i Ãw" << 
	gd’dl
;

6362 
	goi
.
	gŒunÿ‹_£q
 = 
İ
.
ex‹Á
.
Œunÿ‹_£q
;

6363 
	goi
.
	gŒunÿ‹_size
 = 
İ
.
ex‹Á
.
Œunÿ‹_size
;

6366 
	g»suÉ
 = 
check_off£t_ªd_Ëngth
(
İ
.
ex‹Á
.
off£t
, op.ex‹Á.
Ëngth
,

6367 
osd
->
osd_max_objeù_size
, 
g‘_dµ
());

6368 ià(
	g»suÉ
 < 0)

6371 
maybe_ü—‹_Ãw_objeù
(
ùx
);

6373 ià(
	gİ
.
	gex‹Á
.
	gËngth
 == 0) {

6374 ià(
İ
.
ex‹Á
.
off£t
 > 
oi
.
size
) {

6375 
t
->
Œunÿ‹
(

6376 
soid
, 
İ
.
ex‹Á
.
off£t
);

6378 
	gt
->
nİ
(
soid
);

6381 
	gt
->
wr™e
(

6382 
soid
, 
İ
.
ex‹Á
.
off£t
, op.ex‹Á.
Ëngth
, 
osd_İ
.
šd©a
, op.
æags
);

6385 ià(
	gİ
.
	gex‹Á
.
	goff£t
 =ğ0 && 
İ
.
ex‹Á
.
Ëngth
 >ğ
oi
.
size


6386 && !
sk_d©a_dige¡
) {

6387 
obs
.
oi
.
£t_d©a_dige¡
(
osd_İ
.
šd©a
.
üc32c
(-1));

6388 } ià(
	gİ
.
	gex‹Á
.
	goff£t
 =ğ
oi
.
size
 && 
obs
.oi.
is_d©a_dige¡
()) {

6389 ià(
sk_d©a_dige¡
) {

6390 
obs
.
oi
.
ş—r_d©a_dige¡
();

6392 
	gobs
.
	goi
.
£t_d©a_dige¡
(
osd_İ
.
šd©a
.
üc32c
(
obs
.
oi
.
d©a_dige¡
));

6395 
	gobs
.
	goi
.
ş—r_d©a_dige¡
();

6397 
wr™e_upd©e_size_ªd_u§ge
(
ùx
->
d–_¡©s
, 
oi
, ctx->
modif›d_¿nges
,

6398 
İ
.
ex‹Á
.
off£t
, op.ex‹Á.
Ëngth
);

6403 
	gCEPH_OSD_OP_WRITEFULL
:

6404 ++
ùx
->
num_wr™e
;

6406 
Œaûpošt
(
osd
, 
do_osd_İ_´e_wr™efuÎ
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
oi
.
size
, 0, 
İ
.
ex‹Á
.
Ëngth
);

6408 ià(
	gİ
.
	gex‹Á
.
	gËngth
 !ğ
osd_İ
.
šd©a
.
Ëngth
()) {

6409 
»suÉ
 = -
EINVAL
;

6412 
	g»suÉ
 = 
check_off£t_ªd_Ëngth
(0, 
İ
.
ex‹Á
.
Ëngth
,

6413 
osd
->
osd_max_objeù_size
, 
g‘_dµ
());

6414 ià(
	g»suÉ
 < 0)

6417 ià(
	gpoŞ
.
	gšfo
.
has_æag
(
pg_poŞ_t
::
FLAG_WRITE_FADVISE_DONTNEED
))

6418 
İ
.
æags
 = op.æag | 
CEPH_OSD_OP_FLAG_FADVISE_DONTNEED
;

6420 
maybe_ü—‹_Ãw_objeù
(
ùx
);

6421 ià(
	gpoŞ
.
	gšfo
.
is_”asu»
()) {

6422 
	gt
->
Œunÿ‹
(
soid
, 0);

6423 } ià(
	gobs
.
	gexi¡s
 && 
	gİ
.
	gex‹Á
.
	gËngth
 < 
	goi
.
	gsize
) {

6424 
	gt
->
Œunÿ‹
(
soid
, 
İ
.
ex‹Á
.
Ëngth
);

6426 ià(
	gİ
.
	gex‹Á
.
	gËngth
) {

6427 
	gt
->
wr™e
(
soid
, 0, 
İ
.
ex‹Á
.
Ëngth
, 
osd_İ
.
šd©a
, op.
æags
);

6429 ià(!
	gsk_d©a_dige¡
) {

6430 
	gobs
.
	goi
.
£t_d©a_dige¡
(
osd_İ
.
šd©a
.
üc32c
(-1));

6432 
	gobs
.
	goi
.
ş—r_d©a_dige¡
();

6435 
wr™e_upd©e_size_ªd_u§ge
(
ùx
->
d–_¡©s
, 
oi
, ctx->
modif›d_¿nges
,

6436 0, 
İ
.
ex‹Á
.
Ëngth
, 
Œue
);

6440 
	gCEPH_OSD_OP_WRITESAME
:

6441 ++
ùx
->
num_wr™e
;

6442 
Œaûpošt
(
osd
, 
do_osd_İ_´e_wr™e§me
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
oi
.
size
, 
İ
.
wr™e§me
.
off£t
, op.wr™e§me.
Ëngth
, op.wr™e§me.
d©a_Ëngth
);

6443 
	g»suÉ
 = 
do_wr™e§me
(
ùx
, 
osd_İ
);

6446 
	gCEPH_OSD_OP_ROLLBACK
 :

6447 ++
ùx
->
num_wr™e
;

6448 
Œaûpošt
(
osd
, 
do_osd_İ_´e_rŞlback
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

6449 
	g»suÉ
 = 
_rŞlback_to
(
ùx
, 
İ
);

6452 
	gCEPH_OSD_OP_ZERO
:

6453 
Œaûpošt
(
osd
, 
do_osd_İ_´e_z”o
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
İ
.
ex‹Á
.
off£t
, op.ex‹Á.
Ëngth
);

6454 ià(
	gpoŞ
.
	gšfo
.
»quœes_®igÃd_­³nd
()) {

6455 
	g»suÉ
 = -
EOPNOTSUPP
;

6458 ++
	gùx
->
	gnum_wr™e
;

6460 
	g»suÉ
 = 
check_off£t_ªd_Ëngth
(
İ
.
ex‹Á
.
off£t
, op.ex‹Á.
Ëngth
,

6461 
osd
->
osd_max_objeù_size
, 
g‘_dµ
());

6462 ià(
	g»suÉ
 < 0)

6465 
as£¹
(
İ
.
ex‹Á
.
Ëngth
);

6466 ià(
	gobs
.
	gexi¡s
 && !
	goi
.
is_wh™eout
()) {

6467 
	gt
->
z”o
(
soid
, 
İ
.
ex‹Á
.
off£t
, op.ex‹Á.
Ëngth
);

6468 
	gš‹rv®_£t
<
	gušt64_t
> 
	gch
;

6469 
	gch
.
š£¹
(
İ
.
ex‹Á
.
off£t
, op.ex‹Á.
Ëngth
);

6470 
	gùx
->
	gmodif›d_¿nges
.
uniÚ_of
(
ch
);

6471 
	gùx
->
	gd–_¡©s
.
	gnum_wr
++;

6472 
	goi
.
ş—r_d©a_dige¡
();

6478 
	gCEPH_OSD_OP_CREATE
:

6479 ++
ùx
->
num_wr™e
;

6481 
Œaûpošt
(
osd
, 
do_osd_İ_´e_ü—‹
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

6482 
	gæags
 = 
Ë32_to_ıu
(
İ
.
æags
);

6483 ià(
	gobs
.
	gexi¡s
 && !
	goi
.
is_wh™eout
() &&

6484 (
	gæags
 & 
	gCEPH_OSD_OP_FLAG_EXCL
)) {

6485 
	g»suÉ
 = -
EEXIST
;

6487 ià(
	gosd_İ
.
	gšd©a
.
Ëngth
()) {

6488 
	gbufã¾i¡
::
™”©Ü
 
p
 = 
osd_İ
.
šd©a
.
begš
();

6489 
¡ršg
 
	gÿ‹gÜy
;

6490 
	gŒy
 {

6491 
decode
(
ÿ‹gÜy
, 
p
);

6493 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

6494 
»suÉ
 = -
EINVAL
;

6495 
	gç
;

6499 ià(
	g»suÉ
 >= 0) {

6500 
maybe_ü—‹_Ãw_objeù
(
ùx
);

6501 
	gt
->
nİ
(
soid
);

6507 
	gCEPH_OSD_OP_TRIMTRUNC
:

6508 
İ
.
ex‹Á
.
off£t
 = op.ex‹Á.
Œunÿ‹_size
;

6511 
	gCEPH_OSD_OP_TRUNCATE
:

6512 
Œaûpošt
(
osd
, 
do_osd_İ_´e_Œunÿ‹
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
oi
.
size
, oi.
Œunÿ‹_£q
, 
İ
.
ex‹Á
.
off£t
, op.ex‹Á.
Ëngth
, op.ex‹Á.
Œunÿ‹_size
, op.extent.truncate_seq);

6513 ià(
	gpoŞ
.
	gšfo
.
»quœes_®igÃd_­³nd
()) {

6514 
	g»suÉ
 = -
EOPNOTSUPP
;

6517 ++
	gùx
->
	gnum_wr™e
;

6520 ià(!
	gobs
.
	gexi¡s
 || 
	goi
.
is_wh™eout
()) {

6521 
dout
(10è<< " objeù dÃ,runÿ‹ i ¨no-İ" << 
	gd’dl
;

6525 
	g»suÉ
 = 
check_off£t_ªd_Ëngth
(
İ
.
ex‹Á
.
off£t
, op.ex‹Á.
Ëngth
,

6526 
osd
->
osd_max_objeù_size
, 
g‘_dµ
());

6527 ià(
	g»suÉ
 < 0)

6530 ià(
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
) {

6531 
as£¹
(
İ
.
ex‹Á
.
off£t
 =ğİ.ex‹Á.
Œunÿ‹_size
);

6532 ià(
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
 <ğ
oi
.
Œunÿ‹_£q
) {

6533 
dout
(10è<< "runÿ‹ seq " << 
İ
.
ex‹Á
.
Œunÿ‹_£q
 << " <ğcu¼’ˆ" << 
oi
.truncate_seq

6534 << ",‚o-İ" << 
d’dl
;

6537 
dout
(10è<< "runÿ‹ seq " << 
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
 << " > cu¼’ˆ" << 
	goi
.truncate_seq

6538 << ",runÿtšg" << 
	gd’dl
;

6539 
	goi
.
	gŒunÿ‹_£q
 = 
İ
.
ex‹Á
.
Œunÿ‹_£q
;

6540 
	goi
.
	gŒunÿ‹_size
 = 
İ
.
ex‹Á
.
Œunÿ‹_size
;

6543 
maybe_ü—‹_Ãw_objeù
(
ùx
);

6544 
	gt
->
Œunÿ‹
(
soid
, 
İ
.
ex‹Á
.
off£t
);

6545 ià(
	goi
.
	gsize
 > 
	gİ
.
	gex‹Á
.
	goff£t
) {

6546 
	gš‹rv®_£t
<
	gušt64_t
> 
	gŒim
;

6547 
	gŒim
.
š£¹
(
İ
.
ex‹Á
.
off£t
, 
oi
.
size
-op.extent.offset);

6548 
	gùx
->
	gmodif›d_¿nges
.
uniÚ_of
(
Œim
);

6550 ià(
	gİ
.
	gex‹Á
.
	goff£t
 !ğ
oi
.
size
) {

6551 
Œunÿ‹_upd©e_size_ªd_u§ge
(
ùx
->
d–_¡©s
,

6552 
oi
,

6553 
İ
.
ex‹Á
.
off£t
);

6555 
	gùx
->
	gd–_¡©s
.
	gnum_wr
++;

6558 
	goi
.
ş—r_d©a_dige¡
();

6562 
	gCEPH_OSD_OP_DELETE
:

6563 ++
ùx
->
num_wr™e
;

6564 
Œaûpošt
(
osd
, 
do_osd_İ_´e_d–‘e
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

6566 ià(
	goi
.
has_mªiã¡
()) {

6567 ià((
	goi
.
	gæags
 & 
	gobjeù_šfo_t
::
FLAG_REDIRECT_HAS_REFERENCE
è&& 
oi
.
mªiã¡
.
is_»dœeù
()) {

6568 
ùx
->
»gi¡”_Ú_comm™
(

6569 [
oi
, 
ùx
, 
this
](){

6570 
objeù_loÿtÜ_t
 
rg‘_Şoc
(
oi
.
mªiã¡
.
»dœeù_rg‘
);

6571 
»fcouÁ_mªiã¡
(
ùx
->
obc
, 
rg‘_Şoc
, 
oi
.
mªiã¡
.
»dœeù_rg‘
,

6572 
SÇpCÚ‹xt
(), 
çl£
, 
NULL
, 0);

6574 } ià(
	goi
.
	gmªiã¡
.
is_chunked
()) {

6575 
	gùx
->
»gi¡”_Ú_comm™
(

6576 [
oi
, 
ùx
, 
this
](){

6577 autØ
p
 : 
oi
.
mªiã¡
.
chunk_m­
) {

6578 ià(
p
.
£cÚd
.
æags
 & 
chunk_šfo_t
::
FLAG_HAS_REFERENCE
) {

6579 
objeù_loÿtÜ_t
 
rg‘_Şoc
(
p
.
£cÚd
.
oid
);

6580 
»fcouÁ_mªiã¡
(
ùx
->
obc
, 
rg‘_Şoc
, 
p
.
£cÚd
.
oid
,

6581 
SÇpCÚ‹xt
(), 
çl£
, 
NULL
, 
p
.
fœ¡
);

6587 
	g»suÉ
 = 
_d–‘e_oid
(
ùx
, 
çl£
, ctx->
ignÜe_ÿche
);

6591 
	gCEPH_OSD_OP_WATCH
:

6592 ++
ùx
->
num_wr™e
;

6594 
Œaûpošt
(
osd
, 
do_osd_İ_´e_w©ch
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
,

6595 
İ
.
w©ch
.
cook›
, op.watch.op);

6596 ià(!
	gobs
.
	gexi¡s
) {

6597 
	g»suÉ
 = -
ENOENT
;

6600 
ušt64_t
 
	gcook›
 = 
İ
.
w©ch
.
cook›
;

6601 
’t™y_Çme_t
 
	g’t™y
 = 
ùx
->
»qid
.
Çme
;

6602 
ObjeùCÚ‹xtRef
 
	gobc
 = 
ùx
->
obc
;

6604 
dout
(10è<< "w©ch " << 
ûph_osd_w©ch_İ_Çme
(
İ
.
w©ch
.op)

6605 << ": ctx->obc=" << (*)
	gobc
.
g‘
(è<< " cook›=" << 
	gcook›


6606 << " oi.v”siÚ=" << 
	goi
.
	gv”siÚ
.v”siÚ << " ctx->©_v”siÚ=" << 
	gùx
->
	g©_v”siÚ
 << 
	gd’dl
;

6607 
dout
(10è<< "w©ch: oi.u£r_v”siÚ=" << 
	goi
.
	gu£r_v”siÚ
<< 
	gd’dl
;

6608 
dout
(10) << "watch:…eer_addr="

6609 << 
	gùx
->
	gİ
->
g‘_»q
()->
g‘_cÚÃùiÚ
()->
g‘_³”_addr
(è<< 
	gd’dl
;

6611 
ušt32_t
 
	gtimeout
 = 
cù
->
_cÚf
->
osd_ş›Á_w©ch_timeout
;

6612 ià(
	gİ
.
	gw©ch
.
	gtimeout
 != 0) {

6613 
timeout
 = 
İ
.
w©ch
.timeout;

6616 
w©ch_šfo_t
 
w
(
cook›
, 
timeout
,

6617 
ùx
->
İ
->
g‘_»q
()->
g‘_cÚÃùiÚ
()->
g‘_³”_addr
());

6618 ià(
	gİ
.
	gw©ch
.İ =ğ
CEPH_OSD_WATCH_OP_WATCH
 ||

6619 
İ
.
w©ch
.İ =ğ
CEPH_OSD_WATCH_OP_LEGACY_WATCH
) {

6620 ià(
oi
.
w©ch”s
.
couÁ
(
make_·œ
(
cook›
, 
’t™y
))) {

6621 
dout
(10è<< " foundƒxi¡šg w©ch " << 
w
 << " by " << 
’t™y
 << 
d’dl
;

6623 
dout
(10è<< "„egi¡”ed‚ew w©ch " << 
	gw
 << " by " << 
	g’t™y
 << 
	gd’dl
;

6624 
	goi
.
	gw©ch”s
[
make_·œ
(
cook›
, 
’t™y
)] = 
w
;

6625 
	gt
->
nİ
(
soid
);

6627 
boŞ
 
	gwl_pšg
 = (
İ
.
w©ch
.İ =ğ
CEPH_OSD_WATCH_OP_WATCH
);

6628 
	gùx
->
	gw©ch_cÚÃùs
.
push_back
(
make_·œ
(
w
, 
wl_pšg
));

6629 } ià(
	gİ
.
	gw©ch
.İ =ğ
CEPH_OSD_WATCH_OP_RECONNECT
) {

6630 ià(!
oi
.
w©ch”s
.
couÁ
(
make_·œ
(
cook›
, 
’t™y
))) {

6631 
»suÉ
 = -
ENOTCONN
;

6634 
dout
(10è<< " foundƒxi¡šg w©ch " << 
	gw
 << " by " << 
	g’t™y
 << 
	gd’dl
;

6635 
	gùx
->
	gw©ch_cÚÃùs
.
push_back
(
make_·œ
(
w
, 
Œue
));

6636 } ià(
	gİ
.
	gw©ch
.İ =ğ
CEPH_OSD_WATCH_OP_PING
) {

6640 ià(!
oi
.
w©ch”s
.
couÁ
(
make_·œ
(
cook›
, 
’t™y
))) {

6641 
»suÉ
 = -
ENOTCONN
;

6644 
	gm­
<
	g·œ
<
	gušt64_t
,
	g’t™y_Çme_t
>,
	gW©chRef
>::
™”©Ü
 
p
 =

6645 
obc
->
w©ch”s
.
fšd
(
make_·œ
(
cook›
, 
’t™y
));

6646 ià(
	gp
 =ğ
obc
->
w©ch”s
.
’d
() ||

6647 !
p
->
£cÚd
->
is_cÚÃùed
()) {

6649 
»suÉ
 = -
ETIMEDOUT
;

6652 
dout
(10è<< " foundƒxi¡šg w©ch " << 
	gw
 << " by " << 
	g’t™y
 << 
	gd’dl
;

6653 
	gp
->
	g£cÚd
->
gÙ_pšg
(
ûph_şock_now
());

6654 
	g»suÉ
 = 0;

6655 } ià(
	gİ
.
	gw©ch
.İ =ğ
CEPH_OSD_WATCH_OP_UNWATCH
) {

6656 
m­
<
·œ
<
ušt64_t
, 
’t™y_Çme_t
>, 
w©ch_šfo_t
>::
™”©Ü
 
oi_™”
 =

6657 
oi
.
w©ch”s
.
fšd
(
make_·œ
(
cook›
, 
’t™y
));

6658 ià(
	goi_™”
 !ğ
oi
.
w©ch”s
.
’d
()) {

6659 
dout
(10è<< "„emoved w©ch " << 
oi_™”
->
£cÚd
 << " by "

6660 << 
’t™y
 << 
d’dl
;

6661 
	goi
.
	gw©ch”s
.
”a£
(
oi_™”
);

6662 
	gt
->
nİ
(
soid
);

6663 
	gùx
->
	gw©ch_discÚÃùs
.
push_back
(

6664 
w©ch_discÚÃù_t
(
cook›
, 
’t™y
, 
çl£
));

6666 
dout
(10è<< " cª'ˆ»move:‚Øw©ch by " << 
	g’t™y
 << 
	gd’dl
;

6672 
	gCEPH_OSD_OP_CACHE_PIN
:

6673 
Œaûpošt
(
osd
, 
do_osd_İ_´e_ÿche_pš
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

6674 ià((!
	gpoŞ
.
	gšfo
.
is_t›r
() ||

6675 
	gpoŞ
.
	gšfo
.
	gÿche_mode
 =ğ
pg_poŞ_t
::
CACHEMODE_NONE
)) {

6676 
»suÉ
 = -
EINVAL
;

6677 
dout
(10è<< "…š objeù i Úly‡Îowed oÀthÿcht›¸" << 
	gd’dl
;

6680 ++
	gùx
->
	gnum_wr™e
;

6682 ià(!
	gobs
.
	gexi¡s
 || 
	goi
.
is_wh™eout
()) {

6683 
	g»suÉ
 = -
ENOENT
;

6687 ià(!
	goi
.
is_ÿche_pšÃd
()) {

6688 
	goi
.
£t_æag
(
objeù_šfo_t
::
FLAG_CACHE_PIN
);

6689 
	gùx
->
	gmodify
 = 
Œue
;

6690 
	gùx
->
	gd–_¡©s
.
	gnum_objeùs_pšÃd
++;

6691 
	gùx
->
	gd–_¡©s
.
	gnum_wr
++;

6693 
	g»suÉ
 = 0;

6697 
	gCEPH_OSD_OP_CACHE_UNPIN
:

6698 
Œaûpošt
(
osd
, 
do_osd_İ_´e_ÿche_uÅš
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

6699 ià((!
	gpoŞ
.
	gšfo
.
is_t›r
() ||

6700 
	gpoŞ
.
	gšfo
.
	gÿche_mode
 =ğ
pg_poŞ_t
::
CACHEMODE_NONE
)) {

6701 
»suÉ
 = -
EINVAL
;

6702 
dout
(10è<< "…š objeù i Úly‡Îowed oÀthÿcht›¸" << 
	gd’dl
;

6705 ++
	gùx
->
	gnum_wr™e
;

6707 ià(!
	gobs
.
	gexi¡s
 || 
	goi
.
is_wh™eout
()) {

6708 
	g»suÉ
 = -
ENOENT
;

6712 ià(
	goi
.
is_ÿche_pšÃd
()) {

6713 
	goi
.
ş—r_æag
(
objeù_šfo_t
::
FLAG_CACHE_PIN
);

6714 
	gùx
->
	gmodify
 = 
Œue
;

6715 
	gùx
->
	gd–_¡©s
.
	gnum_objeùs_pšÃd
--;

6716 
	gùx
->
	gd–_¡©s
.
	gnum_wr
++;

6718 
	g»suÉ
 = 0;

6722 
	gCEPH_OSD_OP_SET_REDIRECT
:

6723 ++
ùx
->
num_wr™e
;

6725 ià(
	gpoŞ
.
	gšfo
.
is_t›r
()) {

6726 
	g»suÉ
 = -
EINVAL
;

6729 ià(!
	gobs
.
	gexi¡s
) {

6730 
	g»suÉ
 = -
ENOENT
;

6733 ià(
g‘_osdm­
()->
	g»quœe_osd_»Ëa£
 < 
	gCEPH_RELEASE_LUMINOUS
) {

6734 
	g»suÉ
 = -
EOPNOTSUPP
;

6738 
objeù_t
 
	grg‘_Çme
;

6739 
objeù_loÿtÜ_t
 
	grg‘_Şoc
;

6740 
¢­id_t
 
	grg‘_¢­id
 = (
ušt64_t
)
İ
.
cİy_äom
.
¢­id
;

6741 
v”siÚ_t
 
	grg‘_v”siÚ
 = 
İ
.
cİy_äom
.
¤c_v”siÚ
;

6742 
	gŒy
 {

6743 
decode
(
rg‘_Çme
, 
bp
);

6744 
decode
(
rg‘_Şoc
, 
bp
);

6746 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

6747 
»suÉ
 = -
EINVAL
;

6748 
	gç
;

6750 
pg_t
 
	g¿w_pg
;

6751 
g‘_osdm­
()->
objeù_loÿtÜ_to_pg
(
rg‘_Çme
, 
rg‘_Şoc
, 
¿w_pg
);

6752 
hobjeù_t
 
rg‘
(
rg‘_Çme
, 
rg‘_Şoc
.
key
, 
rg‘_¢­id
,

6753 
¿w_pg
.
ps
(),„aw_pg.
poŞ
(),

6754 
rg‘_Şoc
.
n¥aû
);

6755 ià(
	grg‘
 =ğ
soid
) {

6756 
dout
(20è<< " s‘-»dœeù s–ài šv®id" << 
d’dl
;

6757 
	g»suÉ
 = -
EINVAL
;

6761 
boŞ
 
	gÃed_»ã»nû
 = (
osd_İ
.
İ
.
æags
 & 
CEPH_OSD_OP_FLAG_WITH_REFERENCE
);

6762 
boŞ
 
	ghas_»ã»nû
 = (
oi
.
æags
 & 
objeù_šfo_t
::
FLAG_REDIRECT_HAS_REFERENCE
);

6763 ià(
	ghas_»ã»nû
) {

6764 
	g»suÉ
 = -
EINVAL
;

6765 
dout
(5è<< "hobjeù i ®»ady‡ mªiã¡ " << 
	gd’dl
;

6768 ià(
	gİ_fšish”
 =ğ
nuÎ±r
 && 
Ãed_»ã»nû
) {

6770 
ùx
->
İ_fšish”s
[ùx->
cu¼’t_osd_subİ_num
].
»£t
(

6771 
Ãw
 
S‘Mªiã¡Fšish”
(
osd_İ
));

6772 
RefCouÁC®lback
 *
	gfš
 = 
Ãw
 RefCountCallback(

6773 
this
, 
ùx
, 
osd_İ
, 
g‘_Ï¡_³”šg_»£t
());

6774 
»fcouÁ_mªiã¡
(
ùx
->
obc
, 
rg‘_Şoc
, 
rg‘
, 
SÇpCÚ‹xt
(),

6775 
Œue
, 
fš
, 0);

6776 
	g»suÉ
 = -
EINPROGRESS
;

6779 ià(
	gİ_fšish”
) {

6780 
	g»suÉ
 = 
İ_fšish”
->
execu‹
();

6781 
as£¹
(
»suÉ
 == 0);

6784 ià(!
	goi
.
has_mªiã¡
(è&& !oi.
	gmªiã¡
.
is_»dœeù
())

6785 
	gùx
->
	gd–_¡©s
.
	gnum_objeùs_mªiã¡
++;

6787 
	goi
.
£t_æag
(
objeù_šfo_t
::
FLAG_MANIFEST
);

6788 
	goi
.
	gmªiã¡
.
	g»dœeù_rg‘
 = 
rg‘
;

6789 
	goi
.
	gmªiã¡
.
	gty³
 = 
objeù_mªiã¡_t
::
TYPE_REDIRECT
;

6790 
	gt
->
Œunÿ‹
(
soid
, 0);

6791 ià(
	goi
.
is_om­
(è&& 
	gpoŞ
.
	gšfo
.
suµÜts_om­
()) {

6792 
	gt
->
om­_ş—r
(
soid
);

6793 
	gobs
.
	goi
.
ş—r_om­_dige¡
();

6794 
	gobs
.
	goi
.
ş—r_æag
(
objeù_šfo_t
::
FLAG_OMAP
);

6796 
	gùx
->
	gd–_¡©s
.
	gnum_by‹s
 -ğ
oi
.
size
;

6797 
	goi
.
	gsize
 = 0;

6798 
	goi
.
Ãw_objeù
();

6799 
	goi
.
	gu£r_v”siÚ
 = 
rg‘_v”siÚ
;

6800 
	gùx
->
	gu£r_©_v”siÚ
 = 
rg‘_v”siÚ
;

6802 
	gm­
<
	g¡ršg
,
	gbufã¾i¡
> 
	grm©Œs
;

6803 
	g»suÉ
 = 
g‘©Œs_maybe_ÿche
(
ùx
->
obc
, &
rm©Œs
);

6804 ià(
	g»suÉ
 < 0) {

6805  
	g»suÉ
;

6807 
	gm­
<
	g¡ršg
, 
	gbufã¾i¡
>::
™”©Ü
 
™”
;

6808 
	g™”
 = 
rm©Œs
.
begš
(); i‹¸!ğrm©Œs.
’d
(); ++iter) {

6809 cÚ¡ 
	g¡ršg
& 
	gÇme
 = 
™”
->
fœ¡
;

6810 
	gt
->
rm©Œ
(
soid
, 
Çme
);

6812 
dout
(10è<< "£t-»dœeù oid:" << 
	goi
.
	gsoid
 << " u£r_v”siÚ: " << oi.
	gu£r_v”siÚ
 << 
	gd’dl
;

6813 ià(
	gİ_fšish”
) {

6814 
	gùx
->
	gİ_fšish”s
.
”a£
(
ùx
->
cu¼’t_osd_subİ_num
);

6821 
	gCEPH_OSD_OP_SET_CHUNK
:

6822 ++
ùx
->
num_wr™e
;

6824 ià(
	gpoŞ
.
	gšfo
.
is_t›r
()) {

6825 
	g»suÉ
 = -
EINVAL
;

6828 ià(!
	gobs
.
	gexi¡s
) {

6829 
	g»suÉ
 = -
ENOENT
;

6832 ià(
g‘_osdm­
()->
	g»quœe_osd_»Ëa£
 < 
	gCEPH_RELEASE_LUMINOUS
) {

6833 
	g»suÉ
 = -
EOPNOTSUPP
;

6837 
objeù_loÿtÜ_t
 
	gtgt_Şoc
;

6838 
ušt64_t
 
	g¤c_off£t
, 
	g¤c_Ëngth
, 
	gtgt_off£t
;

6839 
objeù_t
 
	gtgt_Çme
;

6840 
	gŒy
 {

6841 
decode
(
¤c_off£t
, 
bp
);

6842 
decode
(
¤c_Ëngth
, 
bp
);

6843 
decode
(
tgt_Şoc
, 
bp
);

6844 
decode
(
tgt_Çme
, 
bp
);

6845 
decode
(
tgt_off£t
, 
bp
);

6847 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

6848 
»suÉ
 = -
EINVAL
;

6849 
	gç
;

6852 ià(!
	g¤c_Ëngth
) {

6853 
	g»suÉ
 = -
EINVAL
;

6854 
	gç
;

6857 autØ&
	gp
 : 
oi
.
mªiã¡
.
chunk_m­
) {

6858 ià((
p
.
fœ¡
 <ğ
¤c_off£t
 &&….fœ¡ +….
£cÚd
.
Ëngth
 > src_offset) ||

6859 (
p
.
fœ¡
 > 
¤c_off£t
 &&….fœ¡ <ğ¤c_off£ˆ+ 
¤c_Ëngth
)) {

6860 
dout
(20è<< 
__func__
 << " ov”Ïµed !! off£t: " << 
¤c_off£t
 << "†’gth: " << 
¤c_Ëngth


6861 << " chunk_šfo: " << 
p
 << 
d’dl
;

6862 
	g»suÉ
 = -
EOPNOTSUPP
;

6863 
	gç
;

6867 ià(!
	goi
.
	gmªiã¡
.
is_chunked
()) {

6868 
	goi
.
	gmªiã¡
.
ş—r
();

6871 
pg_t
 
	g¿w_pg
;

6872 
chunk_šfo_t
 
	gchunk_šfo
;

6873 
g‘_osdm­
()->
objeù_loÿtÜ_to_pg
(
tgt_Çme
, 
tgt_Şoc
, 
¿w_pg
);

6874 
hobjeù_t
 
rg‘
(
tgt_Çme
, 
tgt_Şoc
.
key
, 
¢­id_t
(),

6875 
¿w_pg
.
ps
(),„aw_pg.
poŞ
(),

6876 
tgt_Şoc
.
n¥aû
);

6877 
boŞ
 
	gÃed_»ã»nû
 = (
osd_İ
.
İ
.
æags
 & 
CEPH_OSD_OP_FLAG_WITH_REFERENCE
);

6878 
boŞ
 
	ghas_»ã»nû
 = (
oi
.
mªiã¡
.
chunk_m­
.
fšd
(
¤c_off£t
è!ğoi.mªiã¡.chunk_m­.
’d
()) &&

6879 (
oi
.
mªiã¡
.
chunk_m­
[
¤c_off£t
].
æags
 & 
chunk_šfo_t
::
FLAG_HAS_REFERENCE
);

6880 ià(
	ghas_»ã»nû
) {

6881 
	g»suÉ
 = -
EINVAL
;

6882 
dout
(5è<< "hobjeù i ®»ady‡ mªiã¡ " << 
	gd’dl
;

6885 ià(
	gİ_fšish”
 =ğ
nuÎ±r
 && 
Ãed_»ã»nû
) {

6887 
ùx
->
İ_fšish”s
[ùx->
cu¼’t_osd_subİ_num
].
»£t
(

6888 
Ãw
 
S‘Mªiã¡Fšish”
(
osd_İ
));

6889 
RefCouÁC®lback
 *
	gfš
 = 
Ãw
 RefCountCallback(

6890 
this
, 
ùx
, 
osd_İ
, 
g‘_Ï¡_³”šg_»£t
());

6891 
»fcouÁ_mªiã¡
(
ùx
->
obc
, 
tgt_Şoc
, 
rg‘
, 
SÇpCÚ‹xt
(),

6892 
Œue
, 
fš
, 
¤c_off£t
);

6893 
	g»suÉ
 = -
EINPROGRESS
;

6895 ià(
	gİ_fšish”
) {

6896 
	g»suÉ
 = 
İ_fšish”
->
execu‹
();

6897 
as£¹
(
»suÉ
 == 0);

6900 
chunk_šfo_t
 
	gchunk_šfo
;

6901 
	gchunk_šfo
.
	gæags
 = 
chunk_šfo_t
::
FLAG_MISSING
;

6902 
	gchunk_šfo
.
	goid
 = 
rg‘
;

6903 
	gchunk_šfo
.
	goff£t
 = 
tgt_off£t
;

6904 
	gchunk_šfo
.
	gËngth
ğ
¤c_Ëngth
;

6905 
	goi
.
	gmªiã¡
.
	gchunk_m­
[
¤c_off£t
] = 
chunk_šfo
;

6906 ià(!
	goi
.
has_mªiã¡
(è&& !oi.
	gmªiã¡
.
is_chunked
())

6907 
	gùx
->
	gd–_¡©s
.
	gnum_objeùs_mªiã¡
++;

6908 
	goi
.
£t_æag
(
objeù_šfo_t
::
FLAG_MANIFEST
);

6909 
	goi
.
	gmªiã¡
.
	gty³
 = 
objeù_mªiã¡_t
::
TYPE_CHUNKED
;

6910 
	gùx
->
	gmodify
 = 
Œue
;

6912 
dout
(10è<< "£t-chunked oid:" << 
	goi
.
	gsoid
 << " u£r_v”siÚ: " << oi.
	gu£r_v”siÚ


6913 << " chunk_šfo: " << 
	gchunk_šfo
 << 
	gd’dl
;

6914 ià(
	gİ_fšish”
) {

6915 
	gùx
->
	gİ_fšish”s
.
”a£
(
ùx
->
cu¼’t_osd_subİ_num
);

6922 
	gCEPH_OSD_OP_TIER_PROMOTE
:

6923 ++
ùx
->
num_wr™e
;

6925 ià(
	gpoŞ
.
	gšfo
.
is_t›r
()) {

6926 
	g»suÉ
 = -
EINVAL
;

6929 ià(!
	gobs
.
	gexi¡s
) {

6930 
	g»suÉ
 = -
ENOENT
;

6933 ià(
g‘_osdm­
()->
	g»quœe_osd_»Ëa£
 < 
	gCEPH_RELEASE_LUMINOUS
) {

6934 
	g»suÉ
 = -
EOPNOTSUPP
;

6937 ià(!
	gobs
.
	goi
.
has_mªiã¡
()) {

6938 
	g»suÉ
 = 0;

6942 ià(
	gİ_fšish”
 =ğ
nuÎ±r
) {

6943 
PromÙeMªiã¡C®lback
 *
cb
;

6944 
objeù_loÿtÜ_t
 
	gmy_Şoc
;

6945 
hobjeù_t
 
	g¤c_hoid
;

6947 ià(
	gobs
.
	goi
.
	gmªiã¡
.
is_chunked
()) {

6948 
	g¤c_hoid
 = 
obs
.
oi
.
soid
;

6949 
	gcb
 = 
Ãw
 
PromÙeMªiã¡C®lback
(
ùx
->
obc
, 
this
, ctx);

6950 } ià(
	gobs
.
	goi
.
	gmªiã¡
.
is_»dœeù
()) {

6951 
objeù_loÿtÜ_t
 
¤c_Şoc
(
obs
.
oi
.
mªiã¡
.
»dœeù_rg‘
);

6952 
	gmy_Şoc
 = 
¤c_Şoc
;

6953 
	g¤c_hoid
 = 
obs
.
oi
.
mªiã¡
.
»dœeù_rg‘
;

6954 
	gcb
 = 
Ãw
 
PromÙeMªiã¡C®lback
(
ùx
->
obc
, 
this
, ctx);

6956 
as£¹
(0 == "unrecognized manifestype");

6958 
	gùx
->
	gİ_fšish”s
[
ùx
->
cu¼’t_osd_subİ_num
].
»£t
(

6959 
Ãw
 
PromÙeFšish”
(
cb
));

6960 
	gæags
 = 
CEPH_OSD_COPY_FROM_FLAG_IGNORE_OVERLAY
 |

6961 
CEPH_OSD_COPY_FROM_FLAG_IGNORE_CACHE
 |

6962 
CEPH_OSD_COPY_FROM_FLAG_MAP_SNAP_CLONE
 |

6963 
CEPH_OSD_COPY_FROM_FLAG_RWORDERED
;

6964 
	g¤c_çdvi£_æags
 = 
LIBRADOS_OP_FLAG_FADVISE_SEQUENTIAL
;

6965 
¡¬t_cİy
(
cb
, 
ùx
->
obc
, 
¤c_hoid
, 
my_Şoc
, 0, 
æags
,

6966 
obs
.
oi
.
soid
.
¢­
 =ğ
CEPH_NOSNAP
,

6967 
¤c_çdvi£_æags
, 0);

6969 
dout
(10è<< "t›r-´omÙoid:" << 
	goi
.
	gsoid
 << " mªiã¡: " << 
	gobs
.oi.
	gmªiã¡
 << 
	gd’dl
;

6970 
	g»suÉ
 = -
EINPROGRESS
;

6972 
	g»suÉ
 = 
İ_fšish”
->
execu‹
();

6973 
as£¹
(
»suÉ
 == 0);

6974 
	gùx
->
	gİ_fšish”s
.
”a£
(
ùx
->
cu¼’t_osd_subİ_num
);

6982 
	gCEPH_OSD_OP_SETXATTR
:

6983 ++
ùx
->
num_wr™e
;

6985 ià(
	gcù
->
	g_cÚf
->
	gosd_max_©Œ_size
 > 0 &&

6986 
	gİ
.
	gx©Œ
.
	gv®ue_Ën
 > 
	gcù
->
	g_cÚf
->
	gosd_max_©Œ_size
) {

6987 
Œaûpošt
(
osd
, 
do_osd_İ_´e_£tx©Œ
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, "???");

6988 
	g»suÉ
 = -
EFBIG
;

6991 
	gmax_Çme_Ën
 =

6992 
¡d
::
mš
<
ušt64_t
>(
osd
->
¡Üe
->
g‘_max_©Œ_Çme_Ëngth
(),

6993 
	gcù
->
	g_cÚf
->
	gosd_max_©Œ_Çme_Ën
);

6994 ià(
	gİ
.
	gx©Œ
.
	gÇme_Ën
 > 
	gmax_Çme_Ën
) {

6995 
	g»suÉ
 = -
ENAMETOOLONG
;

6998 
maybe_ü—‹_Ãw_objeù
(
ùx
);

6999 
¡ršg
 
	gªame
;

7000 
	gbp
.
cİy
(
İ
.
x©Œ
.
Çme_Ën
, 
ªame
);

7001 
Œaûpošt
(
osd
, 
do_osd_İ_´e_£tx©Œ
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
ªame
.c_str());

7002 
¡ršg
 
	gÇme
 = "_" + 
ªame
;

7003 
bufã¾i¡
 
	gbl
;

7004 
	gbp
.
cİy
(
İ
.
x©Œ
.
v®ue_Ën
, 
bl
);

7005 
	gt
->
£‰r
(
soid
, 
Çme
, 
bl
);

7006 
	gùx
->
	gd–_¡©s
.
	gnum_wr
++;

7010 
	gCEPH_OSD_OP_RMXATTR
:

7011 ++
ùx
->
num_wr™e
;

7013 
¡ršg
 
	gªame
;

7014 
	gbp
.
cİy
(
İ
.
x©Œ
.
Çme_Ën
, 
ªame
);

7015 
Œaûpošt
(
osd
, 
do_osd_İ_´e_rmx©Œ
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
ªame
.c_str());

7016 ià(!
	gobs
.
	gexi¡s
 || 
	goi
.
is_wh™eout
()) {

7017 
	g»suÉ
 = -
ENOENT
;

7020 
¡ršg
 
	gÇme
 = "_" + 
ªame
;

7021 
	gt
->
rm©Œ
(
soid
, 
Çme
);

7022 
	gùx
->
	gd–_¡©s
.
	gnum_wr
++;

7028 
	gCEPH_OSD_OP_APPEND
:

7030 
Œaûpošt
(
osd
, 
do_osd_İ_´e_­³nd
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
oi
.
size
, oi.
Œunÿ‹_£q
, 
İ
.
ex‹Á
.
off£t
, op.ex‹Á.
Ëngth
, op.ex‹Á.
Œunÿ‹_size
, op.extent.truncate_seq);

7033 
	gveùÜ
<
	gOSDOp
> 
nİs
(1);

7034 
	gOSDOp
& 
	gÃwİ
 = 
nİs
[0];

7035 
	gÃwİ
.
	gİ
.İ = 
CEPH_OSD_OP_WRITE
;

7036 
	gÃwİ
.
	gİ
.
	gex‹Á
.
	goff£t
 = 
oi
.
size
;

7037 
	gÃwİ
.
	gİ
.
	gex‹Á
.
	gËngth
 = 
İ
.
ex‹Á
.
Ëngth
;

7038 
	gÃwİ
.
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
 = 
oi
.
Œunÿ‹_£q
;

7039 
	gÃwİ
.
	gšd©a
 = 
osd_İ
.
šd©a
;

7040 
	g»suÉ
 = 
do_osd_İs
(
ùx
, 
nİs
);

7041 
	gosd_İ
.
	goutd©a
.
şaim
(
Ãwİ
.
outd©a
);

7045 
	gCEPH_OSD_OP_STARTSYNC
:

7046 
t
->
nİ
(
soid
);

7050 
	gCEPH_OSD_OP_TMAPGET
:

7051 
Œaûpošt
(
osd
, 
do_osd_İ_´e_tm­g‘
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

7052 ià(
	gpoŞ
.
	gšfo
.
is_”asu»
()) {

7053 
	g»suÉ
 = -
EOPNOTSUPP
;

7057 
	gveùÜ
<
	gOSDOp
> 
nİs
(1);

7058 
	gOSDOp
& 
	gÃwİ
 = 
nİs
[0];

7059 
	gÃwİ
.
	gİ
.İ = 
CEPH_OSD_OP_SYNC_READ
;

7060 
	gÃwİ
.
	gİ
.
	gex‹Á
.
	goff£t
 = 0;

7061 
	gÃwİ
.
	gİ
.
	gex‹Á
.
	gËngth
 = 0;

7062 
do_osd_İs
(
ùx
, 
nİs
);

7063 
	gosd_İ
.
	goutd©a
.
şaim
(
Ãwİ
.
outd©a
);

7067 
	gCEPH_OSD_OP_TMAPPUT
:

7068 
Œaûpošt
(
osd
, 
do_osd_İ_´e_tm­put
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

7069 ià(
	gpoŞ
.
	gšfo
.
is_”asu»
()) {

7070 
	g»suÉ
 = -
EOPNOTSUPP
;

7079 
boŞ
 
	gunsÜ‹d
 = 
çl£
;

7080 ià(
	gŒue
) {

7081 
bufã¾i¡
 
	gh—d”
;

7082 
decode
(
h—d”
, 
bp
);

7083 
ušt32_t
 
	gn
;

7084 
decode
(
n
, 
bp
);

7085 
¡ršg
 
	gÏ¡_key
;

7086 
	gn
--) {

7087 
¡ršg
 
	gkey
;

7088 
decode
(
key
, 
bp
);

7089 
dout
(10è<< "tm­puˆkey " << 
	gkey
 << 
	gd’dl
;

7090 
bufã¾i¡
 
	gv®
;

7091 
decode
(
v®
, 
bp
);

7092 ià(
	gkey
 < 
	gÏ¡_key
) {

7093 
dout
(10è<< "TMAPPUT i unÜd”ed;„esÜtšg" << 
	gd’dl
;

7094 
	gunsÜ‹d
 = 
Œue
;

7097 
	gÏ¡_key
 = 
key
;

7102 
	gveùÜ
<
	gOSDOp
> 
nİs
(1);

7103 
	gOSDOp
& 
	gÃwİ
 = 
nİs
[0];

7104 
	gÃwİ
.
	gİ
.İ = 
CEPH_OSD_OP_WRITEFULL
;

7105 
	gÃwİ
.
	gİ
.
	gex‹Á
.
	goff£t
 = 0;

7106 
	gÃwİ
.
	gİ
.
	gex‹Á
.
	gËngth
 = 
osd_İ
.
šd©a
.
Ëngth
();

7107 
	gÃwİ
.
	gšd©a
 = 
osd_İ
.
šd©a
;

7109 ià(
	gunsÜ‹d
) {

7110 
	gbp
 = 
osd_İ
.
šd©a
.
begš
();

7111 
bufã¾i¡
 
	gh—d”
;

7112 
	gm­
<
	g¡ršg
, 
	gbufã¾i¡
> 
	gm
;

7113 
decode
(
h—d”
, 
bp
);

7114 
decode
(
m
, 
bp
);

7115 
as£¹
(
bp
.
’d
());

7116 
bufã¾i¡
 
	gÃwbl
;

7117 
’code
(
h—d”
, 
Ãwbl
);

7118 
’code
(
m
, 
Ãwbl
);

7119 
	gÃwİ
.
	gšd©a
 = 
Ãwbl
;

7121 
	g»suÉ
 = 
do_osd_İs
(
ùx
, 
nİs
);

7122 
as£¹
(
»suÉ
 == 0);

7126 
	gCEPH_OSD_OP_TMAPUP
:

7127 
Œaûpošt
(
osd
, 
do_osd_İ_´e_tm­up
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

7128 ià(
	gpoŞ
.
	gšfo
.
is_”asu»
()) {

7129 
	g»suÉ
 = -
EOPNOTSUPP
;

7132 ++
	gùx
->
	gnum_wr™e
;

7133 
	g»suÉ
 = 
do_tm­up
(
ùx
, 
bp
, 
osd_İ
);

7136 
	gCEPH_OSD_OP_TMAP2OMAP
:

7137 ++
ùx
->
num_wr™e
;

7138 
Œaûpošt
(
osd
, 
do_osd_İ_´e_tm­2om­
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

7139 
	g»suÉ
 = 
do_tm­2om­
(
ùx
, 
İ
.
tm­2om­
.
æags
);

7143 
	gCEPH_OSD_OP_OMAPGETKEYS
:

7144 ++
ùx
->
num_»ad
;

7146 
¡ršg
 
	g¡¬t_aá”
;

7147 
ušt64_t
 
	gmax_»tuº
;

7148 
	gŒy
 {

7149 
decode
(
¡¬t_aá”
, 
bp
);

7150 
decode
(
max_»tuº
, 
bp
);

7152 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

7153 
»suÉ
 = -
EINVAL
;

7154 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­g‘keys
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, "???", 0);

7155 
	gç
;

7157 ià(
	gmax_»tuº
 > 
	gcù
->
	g_cÚf
->
	gosd_max_om­_’Œ›s_³r_»que¡
) {

7158 
	gmax_»tuº
 = 
cù
->
_cÚf
->
osd_max_om­_’Œ›s_³r_»que¡
;

7160 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­g‘keys
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
¡¬t_aá”
.c_¡r(), 
max_»tuº
);

7162 
bufã¾i¡
 
	gbl
;

7163 
ušt32_t
 
	gnum
 = 0;

7164 
boŞ
 
	gŒunÿ‹d
 = 
çl£
;

7165 ià(
	goi
.
is_om­
()) {

7166 
	gObjeùM­
::
ObjeùM­I‹¿tÜ
 
™”
 = 
osd
->
¡Üe
->
g‘_om­_™”©Ü
(

7167 
ch
, 
ghobjeù_t
(
soid
)

7169 
as£¹
(
™”
);

7170 
	g™”
->
uµ”_bound
(
¡¬t_aá”
);

7171 
	gnum
 = 0; 
	g™”
->
v®id
(); ++num, i‹r->
Ãxt
(
çl£
)) {

7172 ià(
	gnum
 >ğ
max_»tuº
 ||

7173 
bl
.
Ëngth
(è>ğ
cù
->
_cÚf
->
osd_max_om­_by‹s_³r_»que¡
) {

7174 
Œunÿ‹d
 = 
Œue
;

7177 
’code
(
™”
->
key
(), 
bl
);

7180 
’code
(
num
, 
osd_İ
.
outd©a
);

7181 
	gosd_İ
.
	goutd©a
.
şaim_­³nd
(
bl
);

7182 
’code
(
Œunÿ‹d
, 
osd_İ
.
outd©a
);

7183 
	gùx
->
	gd–_¡©s
.
	gnum_rd_kb
 +ğ
shiá_round_up
(
osd_İ
.
outd©a
.
Ëngth
(), 10);

7184 
	gùx
->
	gd–_¡©s
.
	gnum_rd
++;

7188 
	gCEPH_OSD_OP_OMAPGETVALS
:

7189 ++
ùx
->
num_»ad
;

7191 
¡ršg
 
	g¡¬t_aá”
;

7192 
ušt64_t
 
	gmax_»tuº
;

7193 
¡ršg
 
	gf‹r_´efix
;

7194 
	gŒy
 {

7195 
decode
(
¡¬t_aá”
, 
bp
);

7196 
decode
(
max_»tuº
, 
bp
);

7197 
decode
(
f‹r_´efix
, 
bp
);

7199 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

7200 
»suÉ
 = -
EINVAL
;

7201 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­g‘v®s
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, "???", 0, "???");

7202 
	gç
;

7204 ià(
	gmax_»tuº
 > 
	gcù
->
	g_cÚf
->
	gosd_max_om­_’Œ›s_³r_»que¡
) {

7205 
	gmax_»tuº
 = 
cù
->
_cÚf
->
osd_max_om­_’Œ›s_³r_»que¡
;

7207 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­g‘v®s
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
¡¬t_aá”
.c_¡r(), 
max_»tuº
, 
f‹r_´efix
.c_str());

7209 
ušt32_t
 
	gnum
 = 0;

7210 
boŞ
 
	gŒunÿ‹d
 = 
çl£
;

7211 
bufã¾i¡
 
	gbl
;

7212 ià(
	goi
.
is_om­
()) {

7213 
	gObjeùM­
::
ObjeùM­I‹¿tÜ
 
™”
 = 
osd
->
¡Üe
->
g‘_om­_™”©Ü
(

7214 
ch
, 
ghobjeù_t
(
soid
)

7216 ià(!
	g™”
) {

7217 
	g»suÉ
 = -
ENOENT
;

7218 
	gç
;

7220 
	g™”
->
uµ”_bound
(
¡¬t_aá”
);

7221 ià(
	gf‹r_´efix
 > 
	g¡¬t_aá”
è
	g™”
->
low”_bound
(
f‹r_´efix
);

7222 
	gnum
 = 0;

7223 
	g™”
->
v®id
() &&

7224 
	g™”
->
key
().
sub¡r
(0, 
f‹r_´efix
.
size
()) == filter_prefix;

7225 ++
	gnum
, 
	g™”
->
Ãxt
(
çl£
)) {

7226 
dout
(20è<< "Found key " << 
	g™”
->
key
(è<< 
	gd’dl
;

7227 ià(
	gnum
 >ğ
max_»tuº
 ||

7228 
bl
.
Ëngth
(è>ğ
cù
->
_cÚf
->
osd_max_om­_by‹s_³r_»que¡
) {

7229 
Œunÿ‹d
 = 
Œue
;

7232 
’code
(
™”
->
key
(), 
bl
);

7233 
’code
(
™”
->
v®ue
(), 
bl
);

7236 
’code
(
num
, 
osd_İ
.
outd©a
);

7237 
	gosd_İ
.
	goutd©a
.
şaim_­³nd
(
bl
);

7238 
’code
(
Œunÿ‹d
, 
osd_İ
.
outd©a
);

7239 
	gùx
->
	gd–_¡©s
.
	gnum_rd_kb
 +ğ
shiá_round_up
(
osd_İ
.
outd©a
.
Ëngth
(), 10);

7240 
	gùx
->
	gd–_¡©s
.
	gnum_rd
++;

7244 
	gCEPH_OSD_OP_OMAPGETHEADER
:

7245 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­g‘h—d”
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

7246 ià(!
	goi
.
is_om­
()) {

7250 ++
	gùx
->
	gnum_»ad
;

7252 
	gosd
->
	g¡Üe
->
om­_g‘_h—d”
(
ch
, 
ghobjeù_t
(
soid
), &
osd_İ
.
outd©a
);

7253 
	gùx
->
	gd–_¡©s
.
	gnum_rd_kb
 +ğ
shiá_round_up
(
osd_İ
.
outd©a
.
Ëngth
(), 10);

7254 
	gùx
->
	gd–_¡©s
.
	gnum_rd
++;

7258 
	gCEPH_OSD_OP_OMAPGETVALSBYKEYS
:

7259 ++
ùx
->
num_»ad
;

7261 
	g£t
<
	g¡ršg
> 
	gkeys_to_g‘
;

7262 
	gŒy
 {

7263 
decode
(
keys_to_g‘
, 
bp
);

7265 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

7266 
»suÉ
 = -
EINVAL
;

7267 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­g‘v®sbykeys
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, "???");

7268 
	gç
;

7270 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­g‘v®sbykeys
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
li¡_’Œ›s
(
keys_to_g‘
).c_str());

7271 
	gm­
<
	g¡ršg
, 
	gbufã¾i¡
> 
	gout
;

7272 ià(
	goi
.
is_om­
()) {

7273 
	gosd
->
	g¡Üe
->
om­_g‘_v®ues
(
ch
, 
ghobjeù_t
(
soid
), 
keys_to_g‘
, &
out
);

7275 
’code
(
out
, 
osd_İ
.
outd©a
);

7276 
	gùx
->
	gd–_¡©s
.
	gnum_rd_kb
 +ğ
shiá_round_up
(
osd_İ
.
outd©a
.
Ëngth
(), 10);

7277 
	gùx
->
	gd–_¡©s
.
	gnum_rd
++;

7281 
	gCEPH_OSD_OP_OMAP_CMP
:

7282 ++
ùx
->
num_»ad
;

7284 ià(!
	gobs
.
	gexi¡s
 || 
	goi
.
is_wh™eout
()) {

7285 
	g»suÉ
 = -
ENOENT
;

7286 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­_cmp
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, "???");

7289 
	gm­
<
	g¡ršg
, 
	g·œ
<
	gbufã¾i¡
, > > 
	gas£¹iÚs
;

7290 
	gŒy
 {

7291 
decode
(
as£¹iÚs
, 
bp
);

7293 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

7294 
»suÉ
 = -
EINVAL
;

7295 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­_cmp
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, "???");

7296 
	gç
;

7298 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­_cmp
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
li¡_keys
(
as£¹iÚs
).c_str());

7300 
	gm­
<
	g¡ršg
, 
	gbufã¾i¡
> 
	gout
;

7302 ià(
	goi
.
is_om­
()) {

7303 
	g£t
<
	g¡ršg
> 
	gto_g‘
;

7304 
	gm­
<
	g¡ršg
, 
	g·œ
<
	gbufã¾i¡
, > >::
™”©Ü
 
i
 = 
as£¹iÚs
.
begš
();

7305 
	gi
 !ğ
as£¹iÚs
.
’d
();

7306 ++
	gi
)

7307 
	gto_g‘
.
š£¹
(
i
->
fœ¡
);

7308 
	gr
 = 
osd
->
¡Üe
->
om­_g‘_v®ues
(
ch
, 
ghobjeù_t
(
soid
),

7309 
to_g‘
, &
out
);

7310 ià(
	gr
 < 0) {

7311 
	g»suÉ
 = 
r
;

7317 
	gùx
->
	gd–_¡©s
.
	gnum_rd
++;

7319 
	gr
 = 0;

7320 
bufã¾i¡
 
	gem±y
;

7321 
	gm­
<
	g¡ršg
, 
	g·œ
<
	gbufã¾i¡
, > >::
™”©Ü
 
i
 = 
as£¹iÚs
.
begš
();

7322 
	gi
 !ğ
as£¹iÚs
.
’d
();

7323 ++
	gi
) {

7324 autØ
	gout_’Œy
 = 
out
.
fšd
(
i
->
fœ¡
);

7325 
	gbufã¾i¡
 &
	gbl
 = (
out_’Œy
 !ğ
out
.
’d
()) ?

7326 
out_’Œy
->
£cÚd
 : 
em±y
;

7327 
	gi
->
	g£cÚd
.second) {

7328 
	gCEPH_OSD_CMPXATTR_OP_EQ
:

7329 ià(!(
bl
 =ğ
i
->
£cÚd
.
fœ¡
)) {

7330 
r
 = -
ECANCELED
;

7333 
	gCEPH_OSD_CMPXATTR_OP_LT
:

7334 ià(!(
bl
 < 
i
->
£cÚd
.
fœ¡
)) {

7335 
r
 = -
ECANCELED
;

7338 
	gCEPH_OSD_CMPXATTR_OP_GT
:

7339 ià(!(
bl
 > 
i
->
£cÚd
.
fœ¡
)) {

7340 
r
 = -
ECANCELED
;

7344 
r
 = -
EINVAL
;

7347 ià(
	gr
 < 0)

7350 ià(
	gr
 < 0) {

7351 
	g»suÉ
 = 
r
;

7357 
	gCEPH_OSD_OP_OMAPSETVALS
:

7358 ià(!
poŞ
.
šfo
.
suµÜts_om­
()) {

7359 
»suÉ
 = -
EOPNOTSUPP
;

7360 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­£tv®s
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

7363 ++
	gùx
->
	gnum_wr™e
;

7365 
maybe_ü—‹_Ãw_objeù
(
ùx
);

7366 
bufã¾i¡
 
	gto_£t_bl
;

7367 
	gŒy
 {

7368 
decode_¡r_¡r_m­_to_bl
(
bp
, &
to_£t_bl
);

7370 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

7371 
»suÉ
 = -
EINVAL
;

7372 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­£tv®s
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

7373 
	gç
;

7375 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­£tv®s
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

7376 ià(
	gcù
->
	g_cÚf
->
	gsubsys
.
	gshould_g©h”
<
	gdout_subsys
, 20>()) {

7377 
dout
(20è<< "£‰šg v®s: " << 
	gd’dl
;

7378 
	gm­
<
	g¡ršg
,
	gbufã¾i¡
> 
	gto_£t
;

7379 
	gbufã¾i¡
::
™”©Ü
 
±
 = 
to_£t_bl
.
begš
();

7380 
decode
(
to_£t
, 
±
);

7381 
	gm­
<
	g¡ršg
, 
	gbufã¾i¡
>::
™”©Ü
 
i
 = 
to_£t
.
begš
();

7382 
	gi
 !ğ
to_£t
.
’d
();

7383 ++
	gi
) {

7384 
dout
(20è<< "\t" << 
	gi
->
	gfœ¡
 << 
	gd’dl
;

7387 
	gt
->
om­_£tkeys
(
soid
, 
to_£t_bl
);

7388 
	gùx
->
	gd–_¡©s
.
	gnum_wr
++;

7389 
	gùx
->
	gd–_¡©s
.
	gnum_wr_kb
 +ğ
shiá_round_up
(
to_£t_bl
.
Ëngth
(), 10);

7391 
	gobs
.
	goi
.
£t_æag
(
objeù_šfo_t
::
FLAG_OMAP
);

7392 
	gobs
.
	goi
.
ş—r_om­_dige¡
();

7395 
	gCEPH_OSD_OP_OMAPSETHEADER
:

7396 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­£th—d”
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

7397 ià(!
	gpoŞ
.
	gšfo
.
suµÜts_om­
()) {

7398 
	g»suÉ
 = -
EOPNOTSUPP
;

7401 ++
	gùx
->
	gnum_wr™e
;

7403 
maybe_ü—‹_Ãw_objeù
(
ùx
);

7404 
	gt
->
om­_£th—d”
(
soid
, 
osd_İ
.
šd©a
);

7405 
	gùx
->
	gd–_¡©s
.
	gnum_wr
++;

7407 
	gobs
.
	goi
.
£t_æag
(
objeù_šfo_t
::
FLAG_OMAP
);

7408 
	gobs
.
	goi
.
ş—r_om­_dige¡
();

7411 
	gCEPH_OSD_OP_OMAPCLEAR
:

7412 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­ş—r
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

7413 ià(!
	gpoŞ
.
	gšfo
.
suµÜts_om­
()) {

7414 
	g»suÉ
 = -
EOPNOTSUPP
;

7417 ++
	gùx
->
	gnum_wr™e
;

7419 ià(!
	gobs
.
	gexi¡s
 || 
	goi
.
is_wh™eout
()) {

7420 
	g»suÉ
 = -
ENOENT
;

7423 ià(
	goi
.
is_om­
()) {

7424 
	gt
->
om­_ş—r
(
soid
);

7425 
	gùx
->
	gd–_¡©s
.
	gnum_wr
++;

7426 
	gobs
.
	goi
.
ş—r_om­_dige¡
();

7427 
	gobs
.
	goi
.
ş—r_æag
(
objeù_šfo_t
::
FLAG_OMAP
);

7432 
	gCEPH_OSD_OP_OMAPRMKEYS
:

7433 ià(!
poŞ
.
šfo
.
suµÜts_om­
()) {

7434 
»suÉ
 = -
EOPNOTSUPP
;

7435 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­rmkeys
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

7438 ++
	gùx
->
	gnum_wr™e
;

7440 ià(!
	gobs
.
	gexi¡s
 || 
	goi
.
is_wh™eout
()) {

7441 
	g»suÉ
 = -
ENOENT
;

7442 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­rmkeys
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

7445 
bufã¾i¡
 
	gto_rm_bl
;

7446 
	gŒy
 {

7447 
decode_¡r_£t_to_bl
(
bp
, &
to_rm_bl
);

7449 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

7450 
»suÉ
 = -
EINVAL
;

7451 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­rmkeys
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

7452 
	gç
;

7454 
Œaûpošt
(
osd
, 
do_osd_İ_´e_om­rmkeys
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
);

7455 
	gt
->
om­_rmkeys
(
soid
, 
to_rm_bl
);

7456 
	gùx
->
	gd–_¡©s
.
	gnum_wr
++;

7458 
	gobs
.
	goi
.
ş—r_om­_dige¡
();

7461 
	gCEPH_OSD_OP_COPY_GET
:

7462 ++
ùx
->
num_»ad
;

7463 
Œaûpošt
(
osd
, 
do_osd_İ_´e_cİy_g‘
, 
soid
.
oid
.
Çme
.
c_¡r
(),

7464 
soid
.
¢­
.
v®
);

7465 ià(
	gİ_fšish”
 =ğ
nuÎ±r
) {

7466 
»suÉ
 = 
do_cİy_g‘
(
ùx
, 
bp
, 
osd_İ
, ctx->
obc
);

7468 
	g»suÉ
 = 
İ_fšish”
->
execu‹
();

7472 
	gCEPH_OSD_OP_COPY_FROM
:

7473 ++
ùx
->
num_wr™e
;

7475 
objeù_t
 
	g¤c_Çme
;

7476 
objeù_loÿtÜ_t
 
	g¤c_Şoc
;

7477 
¢­id_t
 
	g¤c_¢­id
 = (
ušt64_t
)
İ
.
cİy_äom
.
¢­id
;

7478 
v”siÚ_t
 
	g¤c_v”siÚ
 = 
İ
.
cİy_äom
.
¤c_v”siÚ
;

7479 
	gŒy
 {

7480 
decode
(
¤c_Çme
, 
bp
);

7481 
decode
(
¤c_Şoc
, 
bp
);

7483 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

7484 
»suÉ
 = -
EINVAL
;

7485 
Œaûpošt
(
osd
,

7486 
do_osd_İ_´e_cİy_äom
,

7487 
soid
.
oid
.
Çme
.
c_¡r
(),

7488 
soid
.
¢­
.
v®
,

7494 
¤c_¢­id
,

7495 
¤c_v”siÚ
);

7496 
	gç
;

7498 
Œaûpošt
(
osd
,

7499 
do_osd_İ_´e_cİy_äom
,

7500 
soid
.
oid
.
Çme
.
c_¡r
(),

7501 
soid
.
¢­
.
v®
,

7502 
¤c_Çme
.
Çme
.
c_¡r
(),

7503 
¤c_Şoc
.
poŞ
,

7504 
¤c_Şoc
.
key
.
c_¡r
(),

7505 
¤c_Şoc
.
n¥aû
.
c_¡r
(),

7506 
¤c_Şoc
.
hash
,

7507 
¤c_¢­id
,

7508 
¤c_v”siÚ
);

7509 ià(
	gİ_fšish”
 =ğ
nuÎ±r
) {

7511 
pg_t
 
¿w_pg
;

7512 
g‘_osdm­
()->
objeù_loÿtÜ_to_pg
(
¤c_Çme
, 
¤c_Şoc
, 
¿w_pg
);

7513 
hobjeù_t
 
¤c
(
¤c_Çme
, 
¤c_Şoc
.
key
, 
¤c_¢­id
,

7514 
¿w_pg
.
ps
(),„aw_pg.
poŞ
(),

7515 
¤c_Şoc
.
n¥aû
);

7516 ià(
	g¤c
 =ğ
soid
) {

7517 
dout
(20è<< " cİy from s–ài šv®id" << 
d’dl
;

7518 
	g»suÉ
 = -
EINVAL
;

7521 
CİyFromC®lback
 *
	gcb
 = 
Ãw
 CİyFromC®lback(
ùx
, 
osd_İ
);

7522 
	gùx
->
	gİ_fšish”s
[
ùx
->
cu¼’t_osd_subİ_num
].
»£t
(

7523 
Ãw
 
CİyFromFšish”
(
cb
));

7524 
¡¬t_cİy
(
cb
, 
ùx
->
obc
, 
¤c
, 
¤c_Şoc
, 
¤c_v”siÚ
,

7525 
İ
.
cİy_äom
.
æags
,

7526 
çl£
,

7527 
İ
.
cİy_äom
.
¤c_çdvi£_æags
,

7528 
İ
.
æags
);

7529 
	g»suÉ
 = -
EINPROGRESS
;

7532 
	g»suÉ
 = 
İ_fšish”
->
execu‹
();

7533 
as£¹
(
»suÉ
 == 0);

7536 
	gùx
->
	gİ_fšish”s
.
”a£
(
ùx
->
cu¼’t_osd_subİ_num
);

7542 
Œaûpošt
(
osd
, 
do_osd_İ_´e_unknown
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
İ
.İ, 
ûph_osd_İ_Çme
(op.op));

7543 
dout
(1è<< "uÄecognized osd o°" << 
	gİ
.op

7544 << " " << 
ûph_osd_İ_Çme
(
İ
.op)

7545 << 
	gd’dl
;

7546 
	g»suÉ
 = -
EOPNOTSUPP
;

7549 
	gç
:

7550 
osd_İ
.
rv®
 = 
»suÉ
;

7551 
Œaûpošt
(
osd
, 
do_osd_İ_po¡
, 
soid
.
oid
.
Çme
.
c_¡r
(), soid.
¢­
.
v®
, 
İ
.İ, 
ûph_osd_İ_Çme
(İ.İ), op.
æags
, 
»suÉ
);

7552 ià(
	g»suÉ
 < 0 && (
	gİ
.
	gæags
 & 
	gCEPH_OSD_OP_FLAG_FAILOK
) &&

7553 
	g»suÉ
 !ğ-
EAGAIN
 && 
»suÉ
 !ğ-
EINPROGRESS
)

7554 
»suÉ
 = 0;

7556 ià(
	g»suÉ
 < 0)

7559  
	g»suÉ
;

7562 
	gPrim¬yLogPG
::
	$_g‘_tm­
(
OpCÚ‹xt
 *
ùx
, 
bufã¾i¡
 *
h—d”
, bufã¾i¡ *
v®s
)

7564 ià(
ùx
->
Ãw_obs
.
oi
.
size
 == 0) {

7565 
	`dout
(20è<< "uÇbËØg‘m­ fÜ z”Øsized " << 
ùx
->
Ãw_obs
.
oi
.
soid
 << 
d’dl
;

7566  -
ENODATA
;

7568 
veùÜ
<
OSDOp
> 
	`nİs
(1);

7569 
OSDOp
 &
Ãwİ
 = 
nİs
[0];

7570 
Ãwİ
.
İ
.İ = 
CEPH_OSD_OP_TMAPGET
;

7571 
	`do_osd_İs
(
ùx
, 
nİs
);

7572 
Œy
 {

7573 
bufã¾i¡
::
™”©Ü
 
i
 = 
Ãwİ
.
outd©a
.
	`begš
();

7574 
	`decode
(*
h—d”
, 
i
);

7575 (*
v®s
).
	`sub¡r_of
(
Ãwİ
.
outd©a
, 
i
.
	`g‘_off
(), i.
	`g‘_»maššg
());

7576 } 
	`ÿtch
 (...) {

7577 
	`dout
(20è<< "unsucûssfuÈ© decodšgm­ fÜ " << 
ùx
->
Ãw_obs
.
oi
.
soid


7578 << 
d’dl
;

7579  -
EINVAL
;

7581 
	`dout
(20è<< "sucûssfuÈ© decodšgm­ fÜ " << 
ùx
->
Ãw_obs
.
oi
.
soid


7582 << 
d’dl
;

7584 
	}
}

7586 
	gPrim¬yLogPG
::
	$_v”ify_no_h—d_şÚes
(cÚ¡ 
hobjeù_t
& 
soid
,

7587 cÚ¡ 
SÇpS‘
& 
ss
)

7590 
	`dout
(20è<< 
__func__
 << " verifying clones‡re‡bsent "

7591 << 
ss
 << 
d’dl
;

7592 
veùÜ
<
¢­id_t
>::
cÚ¡_™”©Ü
 
p
 = 
ss
.
şÚes
.
	`begš
();

7593 
p
 !ğ
ss
.
şÚes
.
	`’d
();

7594 ++
p
) {

7595 
hobjeù_t
 
şÚe_oid
 = 
soid
;

7596 
şÚe_oid
.
¢­
 = *
p
;

7597 ià(
	`is_missšg_objeù
(
şÚe_oid
))

7598  -
EBUSY
;

7599 
ObjeùCÚ‹xtRef
 
şÚe_obc
 = 
	`g‘_objeù_cÚ‹xt
(
şÚe_oid
, 
çl£
);

7600 ià(
şÚe_obc
 && clÚe_obc->
obs
.
exi¡s
) {

7601 
	`dout
(10è<< 
__func__
 << " cannotƒvict head before clone "

7602 << 
şÚe_oid
 << 
d’dl
;

7603  -
EBUSY
;

7605 ià(
cİy_İs
.
	`couÁ
(
şÚe_oid
)) {

7606 
	`dout
(10è<< 
__func__
 << " cannotƒvict head,…ending…romote on clone "

7607 << 
şÚe_oid
 << 
d’dl
;

7608  -
EBUSY
;

7612 
	}
}

7614 
šlše
 
	gPrim¬yLogPG
::
	$_d–‘e_oid
(

7615 
OpCÚ‹xt
 *
ùx
,

7616 
boŞ
 
no_wh™eout
,

7617 
boŞ
 
Œy_no_wh™eout
)

7619 
SÇpS‘
& 
¢­£t
 = 
ùx
->
Ãw_¢­£t
;

7620 
ObjeùS‹
& 
obs
 = 
ùx
->
Ãw_obs
;

7621 
objeù_šfo_t
& 
oi
 = 
obs
.oi;

7622 cÚ¡ 
hobjeù_t
& 
soid
 = 
oi
.soid;

7623 
PGT¿n§ùiÚ
* 
t
 = 
ùx
->
İ_t
.
	`g‘
();

7626 
boŞ
 
wh™eout
 = 
çl£
;

7627 ià(
poŞ
.
šfo
.
ÿche_mode
 !ğ
pg_poŞ_t
::
CACHEMODE_NONE


7628 && !
no_wh™eout


7629 && !
Œy_no_wh™eout
) {

7630 
wh™eout
 = 
Œue
;

7636 ià(!
¢­£t
.
şÚes
.
	`em±y
() ||

7637 (!
ùx
->
¢­c
.
¢­s
.
	`em±y
(è&& ctx->¢­c.¢­s[0] > 
¢­£t
.
£q
)) {

7638 ià(
no_wh™eout
) {

7639 
	`dout
(20è<< 
__func__
 << " has or will have clones but‚o_whiteout=1"

7640 << 
d’dl
;

7642 
	`dout
(20è<< 
__func__
 << " has or will have clones; will whiteout"

7643 << 
d’dl
;

7644 
wh™eout
 = 
Œue
;

7647 
	`dout
(20è<< 
__func__
 << " " << 
soid
 << " wh™eout=" << ()
wh™eout


7648 << "‚o_wh™eout=" << ()
no_wh™eout


7649 << "ry_no_wh™eout=" << ()
Œy_no_wh™eout


7650 << 
d’dl
;

7651 ià(!
obs
.
exi¡s
 || (obs.
oi
.
	`is_wh™eout
(è&& 
wh™eout
))

7652  -
ENOENT
;

7654 
t
->
	`»move
(
soid
);

7656 ià(
oi
.
size
 > 0) {

7657 
š‹rv®_£t
<
ušt64_t
> 
ch
;

7658 
ch
.
	`š£¹
(0, 
oi
.
size
);

7659 
ùx
->
modif›d_¿nges
.
	`uniÚ_of
(
ch
);

7662 
ùx
->
d–_¡©s
.
num_wr
++;

7663 ià(
soid
.
	`is_¢­
()) {

7664 
	`as£¹
(
ùx
->
obc
->
ssc
->
¢­£t
.
şÚe_ov”Ïp
.
	`couÁ
(
soid
.
¢­
));

7665 
ùx
->
d–_¡©s
.
num_by‹s
 -ğùx->
obc
->
ssc
->
¢­£t
.
	`g‘_şÚe_by‹s
(
soid
.
¢­
);

7667 
ùx
->
d–_¡©s
.
num_by‹s
 -ğ
oi
.
size
;

7669 
oi
.
size
 = 0;

7670 
oi
.
	`Ãw_objeù
();

7673 
m­
<
·œ
<
ušt64_t
, 
’t™y_Çme_t
>, 
w©ch_šfo_t
>::
™”©Ü
 
p
 =

7674 
oi
.
w©ch”s
.
	`begš
();

7675 
p
 !ğ
oi
.
w©ch”s
.
	`’d
();

7676 ++
p
) {

7677 
	`dout
(20è<< 
__func__
 << " wÈdiscÚÃù w©ch” " << 
p
->
fœ¡
 << 
d’dl
;

7678 
ùx
->
w©ch_discÚÃùs
.
	`push_back
(

7679 
	`w©ch_discÚÃù_t
(
p
->
fœ¡
.fœ¡,…->fœ¡.
£cÚd
, 
Œue
));

7681 
oi
.
w©ch”s
.
	`ş—r
();

7683 ià(
wh™eout
) {

7684 
	`dout
(20è<< 
__func__
 << " s‘tšg wh™eouˆÚ " << 
soid
 << 
d’dl
;

7685 
oi
.
	`£t_æag
(
objeù_šfo_t
::
FLAG_WHITEOUT
);

7686 
ùx
->
d–_¡©s
.
num_wh™eouts
++;

7687 
t
->
	`ü—‹
(
soid
);

7688 
osd
->
logg”
->
	`šc
(
l_osd_t›r_wh™eout
);

7693 
ùx
->
d–_¡©s
.
num_objeùs
--;

7694 ià(
soid
.
	`is_¢­
())

7695 
ùx
->
d–_¡©s
.
num_objeù_şÚes
--;

7696 ià(
oi
.
	`is_wh™eout
()) {

7697 
	`dout
(20è<< 
__func__
 << " d–‘šg wh™eouˆÚ " << 
soid
 << 
d’dl
;

7698 
ùx
->
d–_¡©s
.
num_wh™eouts
--;

7699 
oi
.
	`ş—r_æag
(
objeù_šfo_t
::
FLAG_WHITEOUT
);

7701 ià(
oi
.
	`is_ÿche_pšÃd
()) {

7702 
ùx
->
d–_¡©s
.
num_objeùs_pšÃd
--;

7704 ià(
oi
.
	`has_mªiã¡
()) {

7705 
ùx
->
d–_¡©s
.
num_objeùs_mªiã¡
--;

7707 
obs
.
exi¡s
 = 
çl£
;

7709 
	}
}

7711 
	gPrim¬yLogPG
::
	$_rŞlback_to
(
OpCÚ‹xt
 *
ùx
, 
ûph_osd_İ
& 
İ
)

7713 
SÇpS‘
& 
¢­£t
 = 
ùx
->
Ãw_¢­£t
;

7714 
ObjeùS‹
& 
obs
 = 
ùx
->
Ãw_obs
;

7715 
objeù_šfo_t
& 
oi
 = 
obs
.oi;

7716 cÚ¡ 
hobjeù_t
& 
soid
 = 
oi
.soid;

7717 
PGT¿n§ùiÚ
* 
t
 = 
ùx
->
İ_t
.
	`g‘
();

7718 
¢­id_t
 
¢­id
 = (
ušt64_t
)
İ
.
¢­
.snapid;

7719 
hobjeù_t
 
missšg_oid
;

7721 
	`dout
(10è<< "_rŞlback_tØ" << 
soid
 << " sÇpid " << 
¢­id
 << 
d’dl
;

7723 
ObjeùCÚ‹xtRef
 
rŞlback_to
;

7725 
»t
 = 
	`fšd_objeù_cÚ‹xt
(

7726 
	`hobjeù_t
(
soid
.
oid
, soid.
	`g‘_key
(), 
¢­id
, soid.
	`g‘_hash
(), 
šfo
.
pgid
.
	`poŞ
(),

7727 
soid
.
	`g‘_Çme¥aû
()),

7728 &
rŞlback_to
, 
çl£
, f®£, &
missšg_oid
);

7729 ià(
»t
 =ğ-
EAGAIN
) {

7731 
	`as£¹
(
	`is_deg¿ded_Ü_backflšg_objeù
(
missšg_oid
è|| 
	`is_deg¿ded_Ú_async_»cov”y_rg‘
(missing_oid));

7732 
	`dout
(20) << "_rollback_to‡ttemptedo„oll backo‡ missing or backfilling clone "

7733 << 
missšg_oid
 << " (»que¡ed sÇpid: ) " << 
¢­id
 << 
d’dl
;

7734 
	`block_wr™e_Ú_deg¿ded_¢­
(
missšg_oid
, 
ùx
->
İ
);

7735  
»t
;

7738 
ObjeùCÚ‹xtRef
 
´omÙe_obc
;

7739 
ÿche_»suÉ_t
 
t›r_mode_»suÉ
;

7740 ià(
obs
.
exi¡s
 && obs.
oi
.
	`has_mªiã¡
()) {

7741 
t›r_mode_»suÉ
 =

7742 
	`maybe_hªdË_mªiã¡_d‘a
(

7743 
ùx
->
İ
,

7744 
Œue
,

7745 
rŞlback_to
);

7747 
t›r_mode_»suÉ
 =

7748 
	`maybe_hªdË_ÿche_d‘a
(

7749 
ùx
->
İ
,

7750 
Œue
,

7751 
rŞlback_to
,

7752 
»t
,

7753 
missšg_oid
,

7754 
Œue
,

7755 
çl£
,

7756 &
´omÙe_obc
);

7758 
t›r_mode_»suÉ
) {

7759 
ÿche_»suÉ_t
::
NOOP
:

7761 
ÿche_»suÉ_t
::
BLOCKED_PROMOTE
:

7762 
	`as£¹
(
´omÙe_obc
);

7763 
	`block_wr™e_Ú_¢­_rŞlback
(
soid
, 
´omÙe_obc
, 
ùx
->
İ
);

7764  -
EAGAIN
;

7765 
ÿche_»suÉ_t
::
BLOCKED_FULL
:

7766 
	`block_wr™e_Ú_fuÎ_ÿche
(
soid
, 
ùx
->
İ
);

7767  -
EAGAIN
;

7768 
ÿche_»suÉ_t
::
REPLIED_WITH_EAGAIN
:

7769 
	`as£¹
(0 == "this can't happen,‚o„ollback on„eplica");

7771 
	`as£¹
(0 == "must…romote was set, other values‡re‚ot valid");

7772  -
EAGAIN
;

7776 ià(
»t
 =ğ-
ENOENT
 || (
rŞlback_to
 &&„Şlback_to->
obs
.
oi
.
	`is_wh™eout
())) {

7779 
	`dout
(20è<< "_rŞlback_tØd–‘šg h—d oÀ" << 
soid
.
oid


7780 << " beÿu£ gÙ ENOENT|wh™eouˆÚ fšd_objeù_cÚ‹xt" << 
d’dl
;

7781 ià(
ùx
->
obc
->
obs
.
oi
.
w©ch”s
.
	`size
()) {

7783 
»t
 = -
EBUSY
;

7785 
	`_d–‘e_oid
(
ùx
, 
çl£
, false);

7786 
»t
 = 0;

7788 } ià(
»t
) {

7790 
	`as£¹
(0 == "unexpectedƒrror code in _rollback_to");

7792 
hobjeù_t
& 
rŞlback_to_sobjeù
 = 
rŞlback_to
->
obs
.
oi
.
soid
;

7793 ià(
	`is_deg¿ded_Ü_backflšg_objeù
(
rŞlback_to_sobjeù
) ||

7794 
	`is_deg¿ded_Ú_async_»cov”y_rg‘
(
rŞlback_to_sobjeù
)) {

7795 
	`dout
(20) << "_rollback_to‡ttemptedo„oll backo‡ degraded object "

7796 << 
rŞlback_to_sobjeù
 << " (»que¡ed sÇpid: ) " << 
¢­id
 << 
d’dl
;

7797 
	`block_wr™e_Ú_deg¿ded_¢­
(
rŞlback_to_sobjeù
, 
ùx
->
İ
);

7798 
»t
 = -
EAGAIN
;

7799 } ià(
rŞlback_to
->
obs
.
oi
.
soid
.
¢­
 =ğ
CEPH_NOSNAP
) {

7801 
ùx
->
modify
 = 
Œue
;

7807 
	`dout
(10è<< "_rŞlback_tØd–‘šg " << 
soid
.
oid


7808 << "‡nd„Şlšg backØŞd sÇp" << 
d’dl
;

7810 ià(
obs
.
exi¡s
) {

7811 
t
->
	`»move
(
soid
);

7813 
t
->
	`şÚe
(
soid
, 
rŞlback_to_sobjeù
);

7814 
t
->
	`add_obc
(
rŞlback_to
);

7816 
m­
<
¢­id_t
, 
š‹rv®_£t
<
ušt64_t
> >::
™”©Ü
 
™”
 =

7817 
¢­£t
.
şÚe_ov”Ïp
.
	`low”_bound
(
¢­id
);

7818 
	`as£¹
(
™”
 !ğ
¢­£t
.
şÚe_ov”Ïp
.
	`’d
());

7819 
š‹rv®_£t
<
ušt64_t
> 
ov”Ïps
 = 
™”
->
£cÚd
;

7821 
™”
 !ğ
¢­£t
.
şÚe_ov”Ïp
.
	`’d
();

7822 ++
™”
)

7823 
ov”Ïps
.
	`š‹r£ùiÚ_of
(
™”
->
£cÚd
);

7825 ià(
obs
.
oi
.
size
 > 0) {

7826 
š‹rv®_£t
<
ušt64_t
> 
modif›d
;

7827 
modif›d
.
	`š£¹
(0, 
obs
.
oi
.
size
);

7828 
ov”Ïps
.
	`š‹r£ùiÚ_of
(
modif›d
);

7829 
modif›d
.
	`subŒaù
(
ov”Ïps
);

7830 
ùx
->
modif›d_¿nges
.
	`uniÚ_of
(
modif›d
);

7834 
	`maybe_ü—‹_Ãw_objeù
(
ùx
, 
Œue
);

7835 
ùx
->
d–_¡©s
.
num_by‹s
 -ğ
obs
.
oi
.
size
;

7836 
ùx
->
d–_¡©s
.
num_by‹s
 +ğ
rŞlback_to
->
obs
.
oi
.
size
;

7837 
obs
.
oi
.
size
 = 
rŞlback_to
->obs.oi.size;

7838 ià(
rŞlback_to
->
obs
.
oi
.
	`is_d©a_dige¡
())

7839 
obs
.
oi
.
	`£t_d©a_dige¡
(
rŞlback_to
->obs.oi.
d©a_dige¡
);

7841 
obs
.
oi
.
	`ş—r_d©a_dige¡
();

7842 ià(
rŞlback_to
->
obs
.
oi
.
	`is_om­_dige¡
())

7843 
obs
.
oi
.
	`£t_om­_dige¡
(
rŞlback_to
->obs.oi.
om­_dige¡
);

7845 
obs
.
oi
.
	`ş—r_om­_dige¡
();

7847 ià(
rŞlback_to
->
obs
.
oi
.
	`is_om­
()) {

7848 
	`dout
(10è<< 
__func__
 << " s‘tšg om­ fÏg oÀ" << 
obs
.
oi
.
soid
 << 
d’dl
;

7849 
obs
.
oi
.
	`£t_æag
(
objeù_šfo_t
::
FLAG_OMAP
);

7851 
	`dout
(10è<< 
__func__
 << " cË¬šg om­ fÏg oÀ" << 
obs
.
oi
.
soid
 << 
d’dl
;

7852 
obs
.
oi
.
	`ş—r_æag
(
objeù_šfo_t
::
FLAG_OMAP
);

7856  
»t
;

7857 
	}
}

7859 
	gPrim¬yLogPG
::
	$_make_şÚe
(

7860 
OpCÚ‹xt
 *
ùx
,

7861 
PGT¿n§ùiÚ
* 
t
,

7862 
ObjeùCÚ‹xtRef
 
obc
,

7863 cÚ¡ 
hobjeù_t
& 
h—d
, cÚ¡ hobjeù_t& 
coid
,

7864 
objeù_šfo_t
 *
poi
)

7866 
bufã¾i¡
 
bv
;

7867 
	`’code
(*
poi
, 
bv
, 
	`g‘_osdm­
()->
	`g‘_ã©u»s
(
CEPH_ENTITY_TYPE_OSD
, 
nuÎ±r
));

7869 
t
->
	`şÚe
(
coid
, 
h—d
);

7870 
	`£‰r_maybe_ÿche
(
obc
, 
t
, 
OI_ATTR
, 
bv
);

7871 
	`rm©Œ_maybe_ÿche
(
obc
, 
t
, 
SS_ATTR
);

7872 
	}
}

7874 
	gPrim¬yLogPG
::
	$make_wr™—bË
(
OpCÚ‹xt
 *
ùx
)

7876 cÚ¡ 
hobjeù_t
& 
soid
 = 
ùx
->
obs
->
oi
.soid;

7877 
SÇpCÚ‹xt
& 
¢­c
 = 
ùx
->snapc;

7880 
	`as£¹
(
soid
.
¢­
 =ğ
CEPH_NOSNAP
);

7881 
	`dout
(20è<< "make_wr™—bË " << 
soid
 << " sÇp£t=" << 
ùx
->
Ãw_¢­£t


7882 << " sÇpc=" << 
¢­c
 << 
d’dl
;

7884 
boŞ
 
was_dœty
 = 
ùx
->
obc
->
obs
.
oi
.
	`is_dœty
();

7885 ià(
ùx
->
Ãw_obs
.
exi¡s
) {

7887 ià(
ùx
->
undœty
 && 
was_dœty
) {

7888 
	`dout
(20è<< " cË¬šg DIRTY fÏg" << 
d’dl
;

7889 
	`as£¹
(
ùx
->
Ãw_obs
.
oi
.
	`is_dœty
());

7890 
ùx
->
Ãw_obs
.
oi
.
	`ş—r_æag
(
objeù_šfo_t
::
FLAG_DIRTY
);

7891 --
ùx
->
d–_¡©s
.
num_objeùs_dœty
;

7892 
osd
->
logg”
->
	`šc
(
l_osd_t›r_ş—n
);

7893 } ià(!
was_dœty
 && !
ùx
->
undœty
) {

7894 
	`dout
(20è<< " s‘tšg DIRTY fÏg" << 
d’dl
;

7895 
ùx
->
Ãw_obs
.
oi
.
	`£t_æag
(
objeù_šfo_t
::
FLAG_DIRTY
);

7896 ++
ùx
->
d–_¡©s
.
num_objeùs_dœty
;

7897 
osd
->
logg”
->
	`šc
(
l_osd_t›r_dœty
);

7900 ià(
was_dœty
) {

7901 
	`dout
(20è<< " d–‘iÚ, deüem’tšg‚um_dœty‡nd cË¬šg fÏg" << 
d’dl
;

7902 
ùx
->
Ãw_obs
.
oi
.
	`ş—r_æag
(
objeù_šfo_t
::
FLAG_DIRTY
);

7903 --
ùx
->
d–_¡©s
.
num_objeùs_dœty
;

7907 ià((
ùx
->
Ãw_obs
.
exi¡s
 &&

7908 
ùx
->
Ãw_obs
.
oi
.
	`is_om­
()) &&

7909 (!
ùx
->
obc
->
obs
.
exi¡s
 ||

7910 !
ùx
->
obc
->
obs
.
oi
.
	`is_om­
())) {

7911 ++
ùx
->
d–_¡©s
.
num_objeùs_om­
;

7913 ià((!
ùx
->
Ãw_obs
.
exi¡s
 ||

7914 !
ùx
->
Ãw_obs
.
oi
.
	`is_om­
()) &&

7915 (
ùx
->
obc
->
obs
.
exi¡s
 &&

7916 
ùx
->
obc
->
obs
.
oi
.
	`is_om­
())) {

7917 --
ùx
->
d–_¡©s
.
num_objeùs_om­
;

7920 ià(
ùx
->
Ãw_¢­£t
.
£q
 > 
¢­c
.seq) {

7921 
	`dout
(10è<< " o°¢­£ˆi Şd" << 
d’dl
;

7924 ià((
ùx
->
obs
->
exi¡s
 && !ùx->obs->
oi
.
	`is_wh™eout
()) &&

7925 
¢­c
.
¢­s
.
	`size
() &&

7926 !
ùx
->
ÿche_eviù
 &&

7927 
¢­c
.
¢­s
[0] > 
ùx
->
Ãw_¢­£t
.
£q
) {

7929 
hobjeù_t
 
coid
 = 
soid
;

7930 
coid
.
¢­
 = 
¢­c
.
£q
;

7932 
l
;

7933 
l
 = 1;

7934 
l
 < 
¢­c
.
¢­s
.
	`size
(è&& sÇpc.¢­s[l] > 
ùx
->
Ãw_¢­£t
.
£q
;

7935 
l
++) ;

7937 
veùÜ
<
¢­id_t
> 
	`¢­s
(
l
);

7938 
i
=0; i<
l
; i++)

7939 
¢­s
[
i
] = 
¢­c
.snaps[i];

7942 
objeù_šfo_t
 
	`¡©ic_¢­_oi
(
coid
);

7943 
objeù_šfo_t
 *
¢­_oi
;

7944 ià(
	`is_´im¬y
()) {

7945 
ùx
->
şÚe_obc
 = 
objeù_cÚ‹xts
.
	`lookup_Ü_ü—‹
(
¡©ic_¢­_oi
.
soid
);

7946 
ùx
->
şÚe_obc
->
de¡ruùÜ_ÿÎback
 =

7947 
Ãw
 
	`C_PG_ObjeùCÚ‹xt
(
this
, 
ùx
->
şÚe_obc
.
	`g‘
());

7948 
ùx
->
şÚe_obc
->
obs
.
oi
 = 
¡©ic_¢­_oi
;

7949 
ùx
->
şÚe_obc
->
obs
.
exi¡s
 = 
Œue
;

7950 
ùx
->
şÚe_obc
->
ssc
 = ctx->
obc
->ssc;

7951 
ùx
->
şÚe_obc
->
ssc
->
»f
++;

7952 ià(
poŞ
.
šfo
.
	`is_”asu»
())

7953 
ùx
->
şÚe_obc
->
©Œ_ÿche
 = ctx->
obc
->attr_cache;

7954 
¢­_oi
 = &
ùx
->
şÚe_obc
->
obs
.
oi
;

7955 
boŞ
 
gÙ
 = 
ùx
->
lock_mªag”
.
	`g‘_wr™e_g»edy
(

7956 
coid
,

7957 
ùx
->
şÚe_obc
,

7958 
ùx
->
İ
);

7959 
	`as£¹
(
gÙ
);

7960 
	`dout
(20è<< " gÙ g»edy wr™Ú clÚe_obø" << *
ùx
->
şÚe_obc
 << 
d’dl
;

7962 
¢­_oi
 = &
¡©ic_¢­_oi
;

7964 
¢­_oi
->
v”siÚ
 = 
ùx
->
©_v”siÚ
;

7965 
¢­_oi
->
´iÜ_v”siÚ
 = 
ùx
->
obs
->
oi
.
v”siÚ
;

7966 
¢­_oi
->
	`cİy_u£r_b™s
(
ùx
->
obs
->
oi
);

7968 
	`_make_şÚe
(
ùx
, ctx->
İ_t
.
	`g‘
(), ctx->
şÚe_obc
, 
soid
, 
coid
, 
¢­_oi
);

7970 
ùx
->
d–_¡©s
.
num_objeùs
++;

7971 ià(
¢­_oi
->
	`is_dœty
()) {

7972 
ùx
->
d–_¡©s
.
num_objeùs_dœty
++;

7973 
osd
->
logg”
->
	`šc
(
l_osd_t›r_dœty
);

7975 ià(
¢­_oi
->
	`is_om­
())

7976 
ùx
->
d–_¡©s
.
num_objeùs_om­
++;

7977 ià(
¢­_oi
->
	`is_ÿche_pšÃd
())

7978 
ùx
->
d–_¡©s
.
num_objeùs_pšÃd
++;

7979 ià(
¢­_oi
->
	`has_mªiã¡
())

7980 
ùx
->
d–_¡©s
.
num_objeùs_mªiã¡
++;

7981 
ùx
->
d–_¡©s
.
num_objeù_şÚes
++;

7982 
ùx
->
Ãw_¢­£t
.
şÚes
.
	`push_back
(
coid
.
¢­
);

7983 
ùx
->
Ãw_¢­£t
.
şÚe_size
[
coid
.
¢­
] = ctx->
obs
->
oi
.
size
;

7984 
ùx
->
Ãw_¢­£t
.
şÚe_¢­s
[
coid
.
¢­
] = 
¢­s
;

7988 
ùx
->
Ãw_¢­£t
.
şÚe_ov”Ïp
[
coid
.
¢­
];

7989 ià(
ùx
->
obs
->
oi
.
size
)

7990 
ùx
->
Ãw_¢­£t
.
şÚe_ov”Ïp
[
coid
.
¢­
].
	`š£¹
(0, ctx->
obs
->
oi
.
size
);

7993 
	`dout
(10è<< " clÚšg v " << 
ùx
->
obs
->
oi
.
v”siÚ


7994 << "Ø" << 
coid
 << " v " << 
ùx
->
©_v”siÚ


7995 << " sÇps=" << 
¢­s


7996 << " sÇp£t=" << 
ùx
->
Ãw_¢­£t
 << 
d’dl
;

7997 
ùx
->
log
.
	`push_back
(
	`pg_log_’Œy_t
(

7998 
pg_log_’Œy_t
::
CLONE
, 
coid
, 
ùx
->
©_v”siÚ
,

7999 
ùx
->
obs
->
oi
.
v”siÚ
,

8000 
ùx
->
obs
->
oi
.
u£r_v”siÚ
,

8001 
	`osd_»qid_t
(), 
ùx
->
Ãw_obs
.
oi
.
mtime
, 0));

8002 
	`’code
(
¢­s
, 
ùx
->
log
.
	`back
().snaps);

8004 
ùx
->
©_v”siÚ
.
v”siÚ
++;

8008 ià(
ùx
->
Ãw_¢­£t
.
şÚes
.
	`size
() > 0) {

8011 
hobjeù_t
 
Ï¡_şÚe_oid
 = 
soid
;

8012 
Ï¡_şÚe_oid
.
¢­
 = 
ùx
->
Ãw_¢­£t
.
şÚe_ov”Ïp
.
	`rbegš
()->
fœ¡
;

8013 ià(
	`is_´e£Á_şÚe
(
Ï¡_şÚe_oid
)) {

8014 
š‹rv®_£t
<
ušt64_t
> &
Ãwe¡_ov”Ïp
 =

8015 
ùx
->
Ãw_¢­£t
.
şÚe_ov”Ïp
.
	`rbegš
()->
£cÚd
;

8016 
ùx
->
modif›d_¿nges
.
	`š‹r£ùiÚ_of
(
Ãwe¡_ov”Ïp
);

8018 
ùx
->
d–_¡©s
.
num_by‹s
 +ğùx->
modif›d_¿nges
.
	`size
();

8019 
Ãwe¡_ov”Ïp
.
	`subŒaù
(
ùx
->
modif›d_¿nges
);

8023 ià(
¢­c
.
£q
 > 
ùx
->
Ãw_¢­£t
.seq) {

8025 
ùx
->
Ãw_¢­£t
.
£q
 = 
¢­c
.seq;

8026 
ùx
->
Ãw_¢­£t
.
¢­s
 = 
¢­c
.snaps;

8028 
	`dout
(20è<< "make_wr™—bË " << 
soid


8029 << " dÚe, sÇp£t=" << 
ùx
->
Ãw_¢­£t
 << 
d’dl
;

8030 
	}
}

8033 
	gPrim¬yLogPG
::
wr™e_upd©e_size_ªd_u§ge
(
objeù_¡©_sum_t
& 
d–_¡©s
, 
objeù_šfo_t
& 
oi
,

8034 
š‹rv®_£t
<
ušt64_t
>& 
modif›d
, ušt64_ˆ
off£t
,

8035 
ušt64_t
 
Ëngth
, 
boŞ
 
wr™e_fuÎ
)

8037 
	gš‹rv®_£t
<
	gušt64_t
> 
	gch
;

8038 ià(
	gwr™e_fuÎ
) {

8039 ià(
	goi
.
	gsize
)

8040 
	gch
.
š£¹
(0, 
oi
.
size
);

8041 } ià(
	gËngth
)

8042 
	gch
.
š£¹
(
off£t
, 
Ëngth
);

8043 
	gmodif›d
.
uniÚ_of
(
ch
);

8044 ià(
	gwr™e_fuÎ
 ||

8045 (
	goff£t
 + 
	gËngth
 > 
	goi
.
	gsize
 &&†ength)) {

8046 
ušt64_t
 
	gÃw_size
 = 
off£t
 + 
Ëngth
;

8047 
	gd–_¡©s
.
	gnum_by‹s
 -ğ
oi
.
size
;

8048 
	gd–_¡©s
.
	gnum_by‹s
 +ğ
Ãw_size
;

8049 
	goi
.
	gsize
 = 
Ãw_size
;

8052 ià(
	goi
.
has_mªiã¡
(è&& oi.
	gmªiã¡
.
is_chunked
()) {

8053 autØ&
	gp
 : 
oi
.
mªiã¡
.
chunk_m­
) {

8054 ià((
p
.
fœ¡
 <ğ
off£t
 &&….fœ¡ +….
£cÚd
.
Ëngth
 > offset) ||

8055 (
p
.
fœ¡
 > 
off£t
 &&….fœ¡ <ğoff£ˆ+ 
Ëngth
)) {

8056 
p
.
£cÚd
.
æags
 = 
chunk_šfo_t
::
FLAG_DIRTY
;

8060 
	gd–_¡©s
.
	gnum_wr
++;

8061 
	gd–_¡©s
.
	gnum_wr_kb
 +ğ
shiá_round_up
(
Ëngth
, 10);

8064 
	gPrim¬yLogPG
::
	$Œunÿ‹_upd©e_size_ªd_u§ge
(

8065 
objeù_¡©_sum_t
& 
d–_¡©s
,

8066 
objeù_šfo_t
& 
oi
,

8067 
ušt64_t
 
Œunÿ‹_size
)

8069 ià(
oi
.
size
 !ğ
Œunÿ‹_size
) {

8070 
d–_¡©s
.
num_by‹s
 -ğ
oi
.
size
;

8071 
d–_¡©s
.
num_by‹s
 +ğ
Œunÿ‹_size
;

8072 
oi
.
size
 = 
Œunÿ‹_size
;

8074 
	}
}

8076 
	gPrim¬yLogPG
::
com¶‘e_discÚÃù_w©ches
(

8077 
ObjeùCÚ‹xtRef
 
obc
,

8078 cÚ¡ 
li¡
<
w©ch_discÚÃù_t
> &
to_discÚÃù
)

8080 
	gli¡
<
	gw©ch_discÚÃù_t
>::
cÚ¡_™”©Ü
 
i
 =

8081 
to_discÚÃù
.
begš
();

8082 
	gi
 !ğ
to_discÚÃù
.
’d
();

8083 ++
	gi
) {

8084 
	g·œ
<
	gušt64_t
, 
	g’t™y_Çme_t
> 
w©ch”
(
i
->
cook›
, i->
Çme
);

8085 autØ
	gw©ch”s_’Œy
 = 
obc
->
w©ch”s
.
fšd
(
w©ch”
);

8086 ià(
	gw©ch”s_’Œy
 !ğ
obc
->
w©ch”s
.
’d
()) {

8087 
W©chRef
 
w©ch
 = 
w©ch”s_’Œy
->
£cÚd
;

8088 
dout
(10è<< "do_osd_İ_efãù discÚÃù w©ch” " << 
	gw©ch”
 << 
	gd’dl
;

8089 
	gobc
->
	gw©ch”s
.
”a£
(
w©ch”
);

8090 
	gw©ch
->
»move
(
i
->
£nd_discÚÃù
);

8092 
dout
(10) << "do_osd_op_effects disconnect failedo find watcher "

8093 << 
	gw©ch”
 << 
	gd’dl
;

8098 
	gPrim¬yLogPG
::
	$do_osd_İ_efãùs
(
OpCÚ‹xt
 *
ùx
, cÚ¡ 
CÚÃùiÚRef
& 
cÚn
)

8100 
’t™y_Çme_t
 
’t™y
 = 
ùx
->
»qid
.
Çme
;

8101 
	`dout
(15è<< "do_osd_İ_efãù " << 
’t™y
 << " cÚ " << 
cÚn
.
	`g‘
(è<< 
d’dl
;

8104 
	`com¶‘e_discÚÃù_w©ches
(
ùx
->
obc
, ctx->
w©ch_discÚÃùs
);

8106 
	`as£¹
(
cÚn
);

8108 
boo¡
::
šŒusive_±r
<
SessiÚ
> 
	`£ssiÚ
((SessiÚ *)
cÚn
->
	`g‘_´iv
());

8109 ià(!
£ssiÚ
.
	`g‘
())

8111 
£ssiÚ
->
	`put
();

8113 
li¡
<
·œ
<
w©ch_šfo_t
,
boŞ
> >::
™”©Ü
 
i
 = 
ùx
->
w©ch_cÚÃùs
.
	`begš
();

8114 
i
 !ğ
ùx
->
w©ch_cÚÃùs
.
	`’d
();

8115 ++
i
) {

8116 
·œ
<
ušt64_t
, 
’t™y_Çme_t
> 
	`w©ch”
(
i
->
fœ¡
.
cook›
, 
’t™y
);

8117 
	`dout
(15) << "do_osd_op_effects‡pplying watch connect on session "

8118 << 
£ssiÚ
.
	`g‘
(è<< " w©ch” " << 
w©ch”
 << 
d’dl
;

8119 
W©chRef
 
w©ch
;

8120 ià(
ùx
->
obc
->
w©ch”s
.
	`couÁ
(
w©ch”
)) {

8121 
	`dout
(15è<< "do_osd_İ_efãù foundƒxi¡šg w©ch w©ch” " << 
w©ch”


8122 << 
d’dl
;

8123 
w©ch
 = 
ùx
->
obc
->
w©ch”s
[
w©ch”
];

8125 
	`dout
(15è<< "do_osd_İ_efãù Ãw w©ch” " << 
w©ch”


8126 << 
d’dl
;

8127 
w©ch
 = 
W©ch
::
	`makeW©chRef
(

8128 
this
, 
osd
, 
ùx
->
obc
, 
i
->
fœ¡
.
timeout_£cÚds
,

8129 
i
->
fœ¡
.
cook›
, 
’t™y
, 
cÚn
->
	`g‘_³”_addr
());

8130 
ùx
->
obc
->
w©ch”s
.
	`š£¹
(

8131 
	`make_·œ
(

8132 
w©ch”
,

8133 
w©ch
));

8135 
w©ch
->
	`cÚÃù
(
cÚn
, 
i
->
£cÚd
);

8138 
li¡
<
nÙify_šfo_t
>::
™”©Ü
 
p
 = 
ùx
->
nÙif›s
.
	`begš
();

8139 
p
 !ğ
ùx
->
nÙif›s
.
	`’d
();

8140 ++
p
) {

8141 
	`dout
(10è<< "do_osd_İ_efãùs,‚Ùify " << *
p
 << 
d’dl
;

8142 
CÚÃùiÚRef
 
	`cÚn
(
ùx
->
İ
->
	`g‘_»q
()->
	`g‘_cÚÃùiÚ
());

8143 
NÙifyRef
 
	`nÙif
(

8144 
NÙify
::
	`makeNÙifyRef
(

8145 
cÚn
,

8146 
ùx
->
»qid
.
Çme
.
	`num
(),

8147 
p
->
bl
,

8148 
p
->
timeout
,

8149 
p
->
cook›
,

8150 
p
->
nÙify_id
,

8151 
ùx
->
obc
->
obs
.
oi
.
u£r_v”siÚ
,

8152 
osd
));

8153 
m­
<
·œ
<
ušt64_t
, 
’t™y_Çme_t
>, 
W©chRef
>::
™”©Ü
 
i
 =

8154 
ùx
->
obc
->
w©ch”s
.
	`begš
();

8155 
i
 !ğ
ùx
->
obc
->
w©ch”s
.
	`’d
();

8156 ++
i
) {

8157 
	`dout
(10è<< "¡¬tšg‚Ùify oÀw©ch " << 
i
->
fœ¡
 << 
d’dl
;

8158 
i
->
£cÚd
->
	`¡¬t_nÙify
(
nÙif
);

8160 
nÙif
->
	`š™
();

8163 
li¡
<
OpCÚ‹xt
::
NÙifyAck
>::
™”©Ü
 
p
 = 
ùx
->
nÙify_acks
.
	`begš
();

8164 
p
 !ğ
ùx
->
nÙify_acks
.
	`’d
();

8165 ++
p
) {

8166 ià(
p
->
w©ch_cook›
)

8167 
	`dout
(10è<< "nÙify_ack " << 
	`make_·œ
(
p
->
w©ch_cook›
.
	`g‘
(),…->
nÙify_id
è<< 
d’dl
;

8169 
	`dout
(10è<< "nÙify_ack " << 
	`make_·œ
("NULL", 
p
->
nÙify_id
è<< 
d’dl
;

8170 
m­
<
·œ
<
ušt64_t
, 
’t™y_Çme_t
>, 
W©chRef
>::
™”©Ü
 
i
 =

8171 
ùx
->
obc
->
w©ch”s
.
	`begš
();

8172 
i
 !ğ
ùx
->
obc
->
w©ch”s
.
	`’d
();

8173 ++
i
) {

8174 ià(
i
->
fœ¡
.
£cÚd
 !ğ
’t™y
) ;

8175 ià(
p
->
w©ch_cook›
 &&

8176 
p
->
w©ch_cook›
.
	`g‘
(è!ğ
i
->
fœ¡
.first) ;

8177 
	`dout
(10è<< "ackšg‚Ùify oÀw©ch " << 
i
->
fœ¡
 << 
d’dl
;

8178 
i
->
£cÚd
->
	`nÙify_ack
(
p
->
nÙify_id
,…->
»¶y_bl
);

8181 
	}
}

8183 
hobjeù_t
 
	gPrim¬yLogPG
::
	$g’”©e_‹mp_objeù
(cÚ¡ 
hobjeù_t
& 
rg‘
)

8185 
o¡ršg¡»am
 
ss
;

8186 
ss
 << "‹mp_" << 
šfo
.
pgid
 << "_" << 
	`g‘_rŞe
()

8187 << "_" << 
osd
->
mÚc
->
	`g‘_glob®_id
(è<< "_" << (++
‹mp_£q
);

8188 
hobjeù_t
 
hoid
 = 
rg‘
.
	`make_‹mp_hobjeù
(
ss
.
	`¡r
());

8189 
	`dout
(20è<< 
__func__
 << " " << 
hoid
 << 
d’dl
;

8190  
hoid
;

8191 
	}
}

8193 
hobjeù_t
 
	gPrim¬yLogPG
::
	$g‘_‹mp_»cov”y_objeù
(

8194 cÚ¡ 
hobjeù_t
& 
rg‘
,

8195 
ev”siÚ_t
 
v”siÚ
)

8197 
o¡ršg¡»am
 
ss
;

8198 
ss
 << "‹mp_»cov”šg_" << 
šfo
.
pgid


8199 << "_" << 
v”siÚ


8200 << "_" << 
šfo
.
hi¡Üy
.
§me_š‹rv®_sšû


8201 << "_" << 
rg‘
.
¢­
;

8203 
hobjeù_t
 
hoid
 = 
rg‘
.
	`make_‹mp_hobjeù
(
ss
.
	`¡r
());

8204 
	`dout
(20è<< 
__func__
 << " " << 
hoid
 << 
d’dl
;

8205  
hoid
;

8206 
	}
}

8208 
	gPrim¬yLogPG
::
	$´•¬e_Œª§ùiÚ
(
OpCÚ‹xt
 *
ùx
)

8210 
	`as£¹
(!
ùx
->
İs
->
	`em±y
());

8213 ià(!
ùx
->
¢­c
.
	`is_v®id
()) {

8214 
	`dout
(10è<< " inv®id sÇpø" << 
ùx
->
¢­c
 << 
d’dl
;

8215  -
EINVAL
;

8219 
»suÉ
 = 
	`do_osd_İs
(
ùx
, *ùx->
İs
);

8220 ià(
»suÉ
 < 0) {

8221 ià(
ùx
->
İ
->
	`may_wr™e
() &&

8222 
	`g‘_osdm­
()->
»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_KRAKEN
) {

8225 
ùx
->
upd©e_log_Úly
 = 
Œue
;

8227  
»suÉ
;

8231 ià(
ùx
->
İ_t
->
	`em±y
(è&& !ùx->
modify
) {

8232 ià(
ùx
->
³ndšg_async_»ads
.
	`em±y
())

8233 
un¡abË_¡©s
.
	`add
(
ùx
->
d–_¡©s
);

8234 ià(
ùx
->
İ
->
	`may_wr™e
() &&

8235 
	`g‘_osdm­
()->
»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_KRAKEN
) {

8236 
ùx
->
upd©e_log_Úly
 = 
Œue
;

8238  
»suÉ
;

8242 ià((
ùx
->
d–_¡©s
.
num_by‹s
 > 0 ||

8243 
ùx
->
d–_¡©s
.
num_objeùs
 > 0) &&

8244 (
poŞ
.
šfo
.
	`has_æag
(
pg_poŞ_t
::
FLAG_FULL
) ||

8245 
	`g‘_osdm­
()->
	`‹¡_æag
(
CEPH_OSDMAP_FULL
))) {

8246 cÚ¡ 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDOp*>(
ùx
->
İ
->
	`g‘_»q
());

8247 ià(
ùx
->
»qid
.
Çme
.
	`is_mds
() ||

8248 
m
->
	`has_æag
(
CEPH_OSD_FLAG_FULL_FORCE
)) {

8249 
	`dout
(20è<< 
__func__
 << " full, but…roceeding dueo FULL_FORCE or MDS"

8250 << 
d’dl
;

8251 } ià(
m
->
	`has_æag
(
CEPH_OSD_FLAG_FULL_TRY
)) {

8253 
	`dout
(20è<< 
__func__
 << " fuÎ,„•lyšgØFULL_TRY op" << 
d’dl
;

8254  
poŞ
.
šfo
.
	`has_æag
(
pg_poŞ_t
::
FLAG_FULL_QUOTA
è? -
EDQUOT
 : -
ENOSPC
;

8257 
	`dout
(20è<< 
__func__
 << " fuÎ, drİpšg„eque¡ (bad cl›Á)" << 
d’dl
;

8258  -
EAGAIN
;

8262 cÚ¡ 
hobjeù_t
& 
soid
 = 
ùx
->
obs
->
oi
.soid;

8264 ià(
soid
.
¢­
 =ğ
CEPH_NOSNAP
)

8265 
	`make_wr™—bË
(
ùx
);

8267 
	`fšish_ùx
(
ùx
,

8268 
ùx
->
Ãw_obs
.
exi¡s
 ? 
pg_log_’Œy_t
::
MODIFY
 :

8269 
pg_log_’Œy_t
::
DELETE
);

8271  
»suÉ
;

8272 
	}
}

8274 
	gPrim¬yLogPG
::
	$fšish_ùx
(
OpCÚ‹xt
 *
ùx
, 
log_İ_ty³
)

8276 cÚ¡ 
hobjeù_t
& 
soid
 = 
ùx
->
obs
->
oi
.soid;

8277 
	`dout
(20è<< 
__func__
 << " " << 
soid
 << " " << 
ùx


8278 << " o°" << 
pg_log_’Œy_t
::
	`g‘_İ_Çme
(
log_İ_ty³
)

8279 << 
d’dl
;

8280 
utime_t
 
now
 = 
	`ûph_şock_now
();

8283 ià(
ùx
->
u£r_modify
) {

8285 
ùx
->
u£r_©_v”siÚ
 = 
¡d
::
	`max
(
šfo
.
Ï¡_u£r_v”siÚ
, ctx->
Ãw_obs
.
oi
.
u£r_v”siÚ
) + 1;

8290 ià(
ùx
->
©_v”siÚ
.
v”siÚ
 > ctx->
u£r_©_v”siÚ
)

8291 
ùx
->
u£r_©_v”siÚ
 = ctx->
©_v”siÚ
.
v”siÚ
;

8292 
ùx
->
Ãw_obs
.
oi
.
u£r_v”siÚ
 = ctx->
u£r_©_v”siÚ
;

8294 
ùx
->
by‹s_wr™‹n
 = ctx->
İ_t
->
	`g‘_by‹s_wr™‹n
();

8296 ià(
ùx
->
Ãw_obs
.
exi¡s
) {

8297 
ùx
->
Ãw_obs
.
oi
.
v”siÚ
 = ctx->
©_v”siÚ
;

8298 
ùx
->
Ãw_obs
.
oi
.
´iÜ_v”siÚ
 = ctx->
obs
->oi.
v”siÚ
;

8299 
ùx
->
Ãw_obs
.
oi
.
Ï¡_»qid
 = ctx->
»qid
;

8300 ià(
ùx
->
mtime
 !ğ
	`utime_t
()) {

8301 
ùx
->
Ãw_obs
.
oi
.
mtime
 = ctx->mtime;

8302 
	`dout
(10è<< " s‘ mtimtØ" << 
ùx
->
Ãw_obs
.
oi
.
mtime
 << 
d’dl
;

8303 
ùx
->
Ãw_obs
.
oi
.
loÿl_mtime
 = 
now
;

8305 
	`dout
(10è<< " mtimunchªged‡ˆ" << 
ùx
->
Ãw_obs
.
oi
.
mtime
 << 
d’dl
;

8309 
m­
 <
¡ršg
, 
bufã¾i¡
> 
©Œs
;

8310 
bufã¾i¡
 
	`bv
((
ùx
->
Ãw_obs
.
oi
));

8311 
	`’code
(
ùx
->
Ãw_obs
.
oi
, 
bv
,

8312 
	`g‘_osdm­
()->
	`g‘_ã©u»s
(
CEPH_ENTITY_TYPE_OSD
, 
nuÎ±r
));

8313 
©Œs
[
OI_ATTR
].
	`şaim
(
bv
);

8316 ià(
soid
.
¢­
 =ğ
CEPH_NOSNAP
) {

8317 
	`dout
(10è<< " fš® sÇp£ˆ" << 
ùx
->
Ãw_¢­£t


8318 << " iÀ" << 
soid
 << 
d’dl
;

8319 
bufã¾i¡
 
bss
;

8320 
	`’code
(
ùx
->
Ãw_¢­£t
, 
bss
);

8321 
©Œs
[
SS_ATTR
].
	`şaim
(
bss
);

8323 
	`dout
(10è<< "‚Ø¢­£ˆÑhi i ¨şÚe)" << 
d’dl
;

8325 
ùx
->
İ_t
->
	`£‰rs
(
soid
, 
©Œs
);

8328 
ùx
->
Ãw_obs
.
oi
 = 
	`objeù_šfo_t
(ùx->
obc
->
obs
.oi.
soid
);

8332 
ùx
->
log
.
	`push_back
(
	`pg_log_’Œy_t
(
log_İ_ty³
, 
soid
, ctx->
©_v”siÚ
,

8333 
ùx
->
obs
->
oi
.
v”siÚ
,

8334 
ùx
->
u£r_©_v”siÚ
, ctx->
»qid
,

8335 
ùx
->
mtime
, 0));

8336 ià(
soid
.
¢­
 < 
CEPH_NOSNAP
) {

8337 
log_İ_ty³
) {

8338 
pg_log_’Œy_t
::
MODIFY
:

8339 
pg_log_’Œy_t
::
PROMOTE
:

8340 
pg_log_’Œy_t
::
CLEAN
:

8341 
	`dout
(20è<< 
__func__
 << "ƒncodšg sÇp äom " << 
ùx
->
Ãw_¢­£t


8342 << 
d’dl
;

8343 
	`’code
(
ùx
->
Ãw_¢­£t
.
şÚe_¢­s
[
soid
.
¢­
], ctx->
log
.
	`back
().
¢­s
);

8350 ià(!
ùx
->
exŒa_»qids
.
	`em±y
()) {

8351 
	`dout
(20è<< 
__func__
 << "ƒxŒa_»qid " << 
ùx
->
exŒa_»qids
 << 
d’dl
;

8352 
ùx
->
log
.
	`back
().
exŒa_»qids
.
	`sw­
(ctx->extra_reqids);

8356 
ùx
->
obc
->
obs
 = ctx->
Ãw_obs
;

8358 ià(
soid
.
	`is_h—d
(è&& !
ùx
->
obc
->
obs
.
exi¡s
) {

8359 
ùx
->
obc
->
ssc
->
exi¡s
 = 
çl£
;

8360 
ùx
->
obc
->
ssc
->
¢­£t
 = 
	`SÇpS‘
();

8362 
ùx
->
obc
->
ssc
->
exi¡s
 = 
Œue
;

8363 
ùx
->
obc
->
ssc
->
¢­£t
 = ctx->
Ãw_¢­£t
;

8365 
	}
}

8367 
	gPrim¬yLogPG
::
	$­¶y_¡©s
(

8368 cÚ¡ 
hobjeù_t
 &
soid
,

8369 cÚ¡ 
objeù_¡©_sum_t
 &
d–_¡©s
) {

8371 
šfo
.
¡©s
.¡©s.
	`add
(
d–_¡©s
);

8373 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
backfl_rg‘s
.
	`begš
();

8374 
i
 !ğ
backfl_rg‘s
.
	`’d
();

8375 ++
i
) {

8376 
pg_sh¬d_t
 
bt
 = *
i
;

8377 
pg_šfo_t
& 
pšfo
 = 
³”_šfo
[
bt
];

8378 ià(
soid
 <ğ
pšfo
.
Ï¡_backfl
)

8379 
pšfo
.
¡©s
.¡©s.
	`add
(
d–_¡©s
);

8380 ià(
soid
 <ğ
Ï¡_backfl_¡¬‹d
)

8381 
³ndšg_backfl_upd©es
[
soid
].
¡©s
.
	`add
(
d–_¡©s
);

8384 ià(
	`is_´im¬y
(è&& 
süubb”
.
aùive
) {

8385 ià(
soid
 < 
süubb”
.
¡¬t
) {

8386 
	`dout
(20è<< 
__func__
 << " " << 
soid
 << " < [" << 
süubb”
.
¡¬t


8387 << "," << 
süubb”
.
’d
 << ")" << 
d’dl
;

8388 
süub_c¡©
.
	`add
(
d–_¡©s
);

8390 
	`dout
(20è<< 
__func__
 << " " << 
soid
 << " >ğ[" << 
süubb”
.
¡¬t


8391 << "," << 
süubb”
.
’d
 << ")" << 
d’dl
;

8394 
	}
}

8396 
	gPrim¬yLogPG
::
	$com¶‘e_»ad_ùx
(
»suÉ
, 
OpCÚ‹xt
 *
ùx
)

8398 cÚ¡ 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDOp*>(
ùx
->
İ
->
	`g‘_»q
());

8399 
	`as£¹
(
ùx
->
	`async_»ads_com¶‘e
());

8401 
veùÜ
<
OSDOp
>::
™”©Ü
 
p
 = 
ùx
->
İs
->
	`begš
();

8402 
p
 !ğ
ùx
->
İs
->
	`’d
(è&& 
»suÉ
 >= 0; ++p) {

8403 ià(
p
->
rv®
 < 0 && !Õ->
İ
.
æags
 & 
CEPH_OSD_OP_FLAG_FAILOK
)) {

8404 
»suÉ
 = 
p
->
rv®
;

8407 
ùx
->
by‹s_»ad
 +ğ
p
->
outd©a
.
	`Ëngth
();

8409 
ùx
->
»¶y
->
	`şaim_İ_out_d©a
(*ùx->
İs
);

8410 
ùx
->
»¶y
->
	`g‘_h—d”
().
d©a_off
 = (ctx->data_off ? *ctx->data_off : 0);

8412 
MOSDOpR•ly
 *
»¶y
 = 
ùx
->reply;

8413 
ùx
->
»¶y
 = 
nuÎ±r
;

8415 ià(
»suÉ
 >= 0) {

8416 ià(!
ùx
->
ignÜe_log_İ_¡©s
) {

8417 
	`log_İ_¡©s
(
ùx
);

8418 
	`publish_¡©s_to_osd
();

8422 ià(
ùx
->
obs
) {

8423 
»¶y
->
	`£t_»¶y_v”siÚs
(
	`ev”siÚ_t
(), 
ùx
->
obs
->
oi
.
u£r_v”siÚ
);

8425 
»¶y
->
	`£t_»¶y_v”siÚs
(
	`ev”siÚ_t
(), 
ùx
->
u£r_©_v”siÚ
);

8427 } ià(
»suÉ
 =ğ-
ENOENT
) {

8429 
»¶y
->
	`£t_’ÛÁ_»¶y_v”siÚs
(
šfo
.
Ï¡_upd©e
, info.
Ï¡_u£r_v”siÚ
);

8432 
»¶y
->
	`£t_»suÉ
(
»suÉ
);

8433 
»¶y
->
	`add_æags
(
CEPH_OSD_FLAG_ACK
 | 
CEPH_OSD_FLAG_ONDISK
);

8434 
osd
->
	`£nd_mes§ge_osd_ş›Á
(
»¶y
, 
m
->
	`g‘_cÚÃùiÚ
());

8435 
	`şo£_İ_ùx
(
ùx
);

8436 
	}
}

8441 
	gC_Cİyäom
 : 
public
 
CÚ‹xt
 {

8442 
Prim¬yLogPGRef
 
pg
;

8443 
hobjeù_t
 
	goid
;

8444 
•och_t
 
	gÏ¡_³”šg_»£t
;

8445 
ûph_tid_t
 
	gtid
;

8446 
	gPrim¬yLogPG
::
CİyOpRef
 
cİ
;

8447 
C_Cİyäom
(
Prim¬yLogPG
 *
p
, 
hobjeù_t
 
o
, 
•och_t
 
Ír
,

8448 cÚ¡ 
Prim¬yLogPG
::
CİyOpRef
& 
c
)

8449 : 
pg
(
p
), 
oid
(
o
), 
Ï¡_³”šg_»£t
(
Ír
),

8450 
tid
(0), 
cİ
(
c
)

8452 
fšish
(
r
è
	gov”ride
 {

8453 ià(
	gr
 =ğ-
ECANCELED
)

8455 
	gpg
->
lock
();

8456 ià(
	gÏ¡_³”šg_»£t
 =ğ
pg
->
g‘_Ï¡_³”šg_»£t
()) {

8457 
pg
->
´oûss_cİy_chunk
(
oid
, 
tid
, 
r
);

8459 
	gpg
->
uÆock
();

8463 
	gC_CİyFrom_AsyncR—dCb
 : 
public
 
CÚ‹xt
 {

8464 
OSDOp
 *
osd_İ
;

8465 
objeù_cİy_d©a_t
 
	g»¶y_obj
;

8466 
ušt64_t
 
	gã©u»s
;

8467 
size_t
 
	gËn
;

8468 
C_CİyFrom_AsyncR—dCb
(
OSDOp
 *
osd_İ
, 
ušt64_t
 
ã©u»s
) :

8469 
osd_İ
(osd_İ), 
ã©u»s
(ã©u»s), 
Ën
(0) {}

8470 
fšish
(
r
è
	gov”ride
 {

8471 
	gosd_İ
->
	grv®
 = 
r
;

8472 ià(
	gr
 < 0) {

8476 
as£¹
(
Ën
 > 0);

8477 
as£¹
(
Ën
 <ğ
»¶y_obj
.
d©a
.
Ëngth
());

8478 
bufã¾i¡
 
	gbl
;

8479 
	gbl
.
sub¡r_of
(
»¶y_obj
.
d©a
, 0, 
Ën
);

8480 
	g»¶y_obj
.
	gd©a
.
sw­
(
bl
);

8481 
’code
(
»¶y_obj
, 
osd_İ
->
outd©a
, 
ã©u»s
);

8485 
	gC_CİyChunk
 : 
public
 
CÚ‹xt
 {

8486 
Prim¬yLogPGRef
 
pg
;

8487 
hobjeù_t
 
	goid
;

8488 
•och_t
 
	gÏ¡_³”šg_»£t
;

8489 
ûph_tid_t
 
	gtid
;

8490 
	gPrim¬yLogPG
::
CİyOpRef
 
cİ
;

8491 
ušt64_t
 
	goff£t
 = 0;

8492 
C_CİyChunk
(
Prim¬yLogPG
 *
p
, 
hobjeù_t
 
o
, 
•och_t
 
Ír
,

8493 cÚ¡ 
Prim¬yLogPG
::
CİyOpRef
& 
c
)

8494 : 
pg
(
p
), 
oid
(
o
), 
Ï¡_³”šg_»£t
(
Ír
),

8495 
tid
(0), 
cİ
(
c
)

8497 
fšish
(
r
è
	gov”ride
 {

8498 ià(
	gr
 =ğ-
ECANCELED
)

8500 
	gpg
->
lock
();

8501 ià(
	gÏ¡_³”šg_»£t
 =ğ
pg
->
g‘_Ï¡_³”šg_»£t
()) {

8502 
pg
->
´oûss_cİy_chunk_mªiã¡
(
oid
, 
tid
, 
r
, 
off£t
);

8504 
	gpg
->
uÆock
();

8508 
	gPrim¬yLogPG
::
	$do_cİy_g‘
(
OpCÚ‹xt
 *
ùx
, 
bufã¾i¡
::
™”©Ü
& 
bp
,

8509 
OSDOp
& 
osd_İ
, 
ObjeùCÚ‹xtRef
 &
obc
)

8511 
objeù_šfo_t
& 
oi
 = 
obc
->
obs
.oi;

8512 
hobjeù_t
& 
soid
 = 
oi
.soid;

8513 
»suÉ
 = 0;

8514 
objeù_cİy_cursÜ_t
 
cursÜ
;

8515 
ušt64_t
 
out_max
;

8516 
Œy
 {

8517 
	`decode
(
cursÜ
, 
bp
);

8518 
	`decode
(
out_max
, 
bp
);

8520 
	`ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

8521 
»suÉ
 = -
EINVAL
;

8522  
»suÉ
;

8525 cÚ¡ 
MOSDOp
 *
İ
 = 
»š‹½»t_ÿ¡
<cÚ¡ MOSDOp*>(
ùx
->İ->
	`g‘_»q
());

8526 
ušt64_t
 
ã©u»s
 = 
İ
->
	`g‘_ã©u»s
();

8528 
boŞ
 
async_»ad_¡¬‹d
 = 
çl£
;

8529 
objeù_cİy_d©a_t
 
_»¶y_obj
;

8530 
C_CİyFrom_AsyncR—dCb
 *
cb
 = 
nuÎ±r
;

8531 ià(
poŞ
.
šfo
.
	`is_”asu»
()) {

8532 
cb
 = 
Ãw
 
	`C_CİyFrom_AsyncR—dCb
(&
osd_İ
, 
ã©u»s
);

8534 
objeù_cİy_d©a_t
 &
»¶y_obj
 = 
cb
 ? cb->»¶y_obj : 
_»¶y_obj
;

8536 
»¶y_obj
.
size
 = 
oi
.size;

8537 
»¶y_obj
.
mtime
 = 
oi
.mtime;

8538 
	`as£¹
(
obc
->
ssc
);

8539 ià(
soid
.
¢­
 < 
CEPH_NOSNAP
) {

8540 autØ
p
 = 
obc
->
ssc
->
¢­£t
.
şÚe_¢­s
.
	`fšd
(
soid
.
¢­
);

8541 
	`as£¹
(
p
 !ğ
obc
->
ssc
->
¢­£t
.
şÚe_¢­s
.
	`’d
());

8542 
»¶y_obj
.
¢­s
 = 
p
->
£cÚd
;

8544 
»¶y_obj
.
¢­_£q
 = 
obc
->
ssc
->
¢­£t
.
£q
;

8546 ià(
oi
.
	`is_d©a_dige¡
()) {

8547 
»¶y_obj
.
æags
 |ğ
objeù_cİy_d©a_t
::
FLAG_DATA_DIGEST
;

8548 
»¶y_obj
.
d©a_dige¡
 = 
oi
.data_digest;

8550 ià(
oi
.
	`is_om­_dige¡
()) {

8551 
»¶y_obj
.
æags
 |ğ
objeù_cİy_d©a_t
::
FLAG_OMAP_DIGEST
;

8552 
»¶y_obj
.
om­_dige¡
 = 
oi
.omap_digest;

8554 
»¶y_obj
.
Œunÿ‹_£q
 = 
oi
.truncate_seq;

8555 
»¶y_obj
.
Œunÿ‹_size
 = 
oi
.truncate_size;

8558 
m­
<
¡ršg
,
bufã¾i¡
>& 
out_©Œs
 = 
»¶y_obj
.
©Œs
;

8559 ià(!
cursÜ
.
©Œ_com¶‘e
) {

8560 
»suÉ
 = 
	`g‘©Œs_maybe_ÿche
(

8561 
ùx
->
obc
,

8562 &
out_©Œs
);

8563 ià(
»suÉ
 < 0) {

8564 ià(
cb
) {

8565 
d–‘e
 
cb
;

8567  
»suÉ
;

8569 
cursÜ
.
©Œ_com¶‘e
 = 
Œue
;

8570 
	`dout
(20è<< " gÙ‡‰rs" << 
d’dl
;

8573 
št64_t
 
Ëá
 = 
out_max
 - 
osd_İ
.
outd©a
.
	`Ëngth
();

8576 
bufã¾i¡
& 
bl
 = 
»¶y_obj
.
d©a
;

8577 ià(
Ëá
 > 0 && !
cursÜ
.
d©a_com¶‘e
) {

8578 ià(
cursÜ
.
d©a_off£t
 < 
oi
.
size
) {

8579 
ušt64_t
 
max_»ad
 = 
¡d
::
	`mš
(
oi
.
size
 - 
cursÜ
.
d©a_off£t
, (ušt64_t)
Ëá
);

8580 ià(
cb
) {

8581 
async_»ad_¡¬‹d
 = 
Œue
;

8582 
ùx
->
³ndšg_async_»ads
.
	`push_back
(

8583 
	`make_·œ
(

8584 
boo¡
::
	`make_tu¶e
(
cursÜ
.
d©a_off£t
, 
max_»ad
, 
osd_İ
.
İ
.
æags
),

8585 
	`make_·œ
(&
bl
, 
cb
)));

8586 
cb
->
Ën
 = 
max_»ad
;

8588 
ùx
->
İ_fšish”s
[ùx->
cu¼’t_osd_subİ_num
].
	`»£t
(

8589 
Ãw
 
	`R—dFšish”
(
osd_İ
));

8590 
»suÉ
 = -
EINPROGRESS
;

8592 
	`dout
(10è<< 
__func__
 << ":‡sync_»ad‚Ùed fÜ " << 
soid
 << 
d’dl
;

8594 
»suÉ
 = 
pgback’d
->
	`objeùs_»ad_sync
(

8595 
oi
.
soid
, 
cursÜ
.
d©a_off£t
, 
max_»ad
, 
osd_İ
.
İ
.
æags
, &
bl
);

8596 ià(
»suÉ
 < 0)

8597  
»suÉ
;

8599 
Ëá
 -ğ
max_»ad
;

8600 
cursÜ
.
d©a_off£t
 +ğ
max_»ad
;

8602 ià(
cursÜ
.
d©a_off£t
 =ğ
oi
.
size
) {

8603 
cursÜ
.
d©a_com¶‘e
 = 
Œue
;

8604 
	`dout
(20è<< " gÙ d©a" << 
d’dl
;

8606 
	`as£¹
(
cursÜ
.
d©a_off£t
 <ğ
oi
.
size
);

8610 
ušt32_t
 
om­_keys
 = 0;

8611 ià(!
poŞ
.
šfo
.
	`suµÜts_om­
(è|| !
oi
.
	`is_om­
()) {

8612 
cursÜ
.
om­_com¶‘e
 = 
Œue
;

8614 ià(
Ëá
 > 0 && !
cursÜ
.
om­_com¶‘e
) {

8615 
	`as£¹
(
cursÜ
.
d©a_com¶‘e
);

8616 ià(
cursÜ
.
om­_off£t
.
	`em±y
()) {

8617 
osd
->
¡Üe
->
	`om­_g‘_h—d”
(
ch
, 
	`ghobjeù_t
(
oi
.
soid
),

8618 &
»¶y_obj
.
om­_h—d”
);

8620 
bufã¾i¡
 
om­_d©a
;

8621 
ObjeùM­
::
ObjeùM­I‹¿tÜ
 
™”
 =

8622 
osd
->
¡Üe
->
	`g‘_om­_™”©Ü
(
ch
, 
	`ghobjeù_t
(
oi
.
soid
));

8623 
	`as£¹
(
™”
);

8624 
™”
->
	`uµ”_bound
(
cursÜ
.
om­_off£t
);

8625 ; 
™”
->
	`v®id
(); i‹r->
	`Ãxt
(
çl£
)) {

8626 ++
om­_keys
;

8627 
	`’code
(
™”
->
	`key
(), 
om­_d©a
);

8628 
	`’code
(
™”
->
	`v®ue
(), 
om­_d©a
);

8629 
Ëá
 -ğ
™”
->
	`key
().
	`Ëngth
(è+ 4 + i‹r->
	`v®ue
().length() + 4;

8630 ià(
Ëá
 <= 0)

8633 ià(
om­_keys
) {

8634 
	`’code
(
om­_keys
, 
»¶y_obj
.
om­_d©a
);

8635 
»¶y_obj
.
om­_d©a
.
	`şaim_­³nd
(omap_data);

8637 ià(
™”
->
	`v®id
()) {

8638 
cursÜ
.
om­_off£t
 = 
™”
->
	`key
();

8640 
cursÜ
.
om­_com¶‘e
 = 
Œue
;

8641 
	`dout
(20è<< " gÙ om­" << 
d’dl
;

8646 ià(
cursÜ
.
	`is_com¶‘e
()) {

8649 
pg_log
.
	`g‘_log
().
	`g‘_objeù_»qids
(
ùx
->
obc
->
obs
.
oi
.
soid
, 10, &
»¶y_obj
.
»qids
);

8650 
	`dout
(20è<< " gÙ„eqids" << 
d’dl
;

8653 
	`dout
(20è<< " cursÜ.is_com¶‘e=" << 
cursÜ
.
	`is_com¶‘e
()

8654 << " " << 
out_©Œs
.
	`size
() << "‡ttrs"

8655 << " " << 
bl
.
	`Ëngth
() << " bytes"

8656 << " " << 
»¶y_obj
.
om­_h—d”
.
	`Ëngth
() << " omap header bytes"

8657 << " " << 
»¶y_obj
.
om­_d©a
.
	`Ëngth
() << " omap data bytes in "

8658 << 
om­_keys
 << " keys"

8659 << " " << 
»¶y_obj
.
»qids
.
	`size
() << "„eqids"

8660 << 
d’dl
;

8661 
»¶y_obj
.
cursÜ
 = cursor;

8662 ià(!
async_»ad_¡¬‹d
) {

8663 
	`’code
(
»¶y_obj
, 
osd_İ
.
outd©a
, 
ã©u»s
);

8665 ià(
cb
 && !
async_»ad_¡¬‹d
) {

8666 
d–‘e
 
cb
;

8669 ià(
»suÉ
 > 0) {

8670 
»suÉ
 = 0;

8672  
»suÉ
;

8673 
	}
}

8675 
	gPrim¬yLogPG
::
	$fl_š_cİy_g‘_nÛÁ
(
OpReque¡Ref
& 
İ
, 
hobjeù_t
 
oid
,

8676 
OSDOp
& 
osd_İ
)

8681 
MOSDOp
 *
m
 = 
¡©ic_ÿ¡
<MOSDOp*>(
İ
->
	`g‘_nÚcÚ¡_»q
());

8682 
ušt64_t
 
ã©u»s
 = 
m
->
	`g‘_ã©u»s
();

8683 
objeù_cİy_d©a_t
 
»¶y_obj
;

8685 
pg_log
.
	`g‘_log
().
	`g‘_objeù_»qids
(
oid
, 10, &
»¶y_obj
.
»qids
);

8686 
	`dout
(20è<< 
__func__
 << " gÙ„eqid " << 
»¶y_obj
.
»qids
 << 
d’dl
;

8687 
	`’code
(
»¶y_obj
, 
osd_İ
.
outd©a
, 
ã©u»s
);

8688 
osd_İ
.
rv®
 = -
ENOENT
;

8689 
MOSDOpR•ly
 *
»¶y
 = 
Ãw
 
	`MOSDOpR•ly
(
m
, 0, 
	`g‘_osdm­
()->
	`g‘_•och
(), 0, 
çl£
);

8690 
»¶y
->
	`şaim_İ_out_d©a
(
m
->
İs
);

8691 
»¶y
->
	`£t_»suÉ
(-
ENOENT
);

8692 
»¶y
->
	`add_æags
(
CEPH_OSD_FLAG_ACK
 | 
CEPH_OSD_FLAG_ONDISK
);

8693 
osd
->
	`£nd_mes§ge_osd_ş›Á
(
»¶y
, 
m
->
	`g‘_cÚÃùiÚ
());

8694 
	}
}

8696 
	gPrim¬yLogPG
::
	$¡¬t_cİy
(
CİyC®lback
 *
cb
, 
ObjeùCÚ‹xtRef
 
obc
,

8697 
hobjeù_t
 
¤c
, 
objeù_loÿtÜ_t
 
Şoc
,

8698 
v”siÚ_t
 
v”siÚ
, 
æags
,

8699 
boŞ
 
mœrÜ_¢­£t
,

8700 
¤c_obj_çdvi£_æags
,

8701 
de¡_obj_çdvi£_æags
)

8703 cÚ¡ 
hobjeù_t
& 
de¡
 = 
obc
->
obs
.
oi
.
soid
;

8704 
	`dout
(10è<< 
__func__
 << " " << 
de¡


8705 << " from " << 
¤c
 << " " << 
Şoc
 << " v" << 
v”siÚ


8706 << " fÏg " << 
æags


8707 << (
mœrÜ_¢­£t
 ? " mirror_snapset" : "")

8708 << 
d’dl
;

8710 
	`as£¹
(!
mœrÜ_¢­£t
 || 
¤c
.
¢­
 =ğ
CEPH_NOSNAP
);

8713 ià(
cİy_İs
.
	`couÁ
(
de¡
)) {

8716 
CİyOpRef
 
cİ
 = 
cİy_İs
[
de¡
];

8717 
veùÜ
<
ûph_tid_t
> 
tids
;

8718 
	`ÿnûl_cİy
(
cİ
, 
çl£
, &
tids
);

8719 
osd
->
objeù”
->
	`İ_ÿnûl
(
tids
, -
ECANCELED
);

8722 
CİyOpRef
 
	`cİ
(
¡d
::
make_sh¬ed
<
CİyOp
>(
cb
, 
obc
, 
¤c
, 
Şoc
, 
v”siÚ
, 
æags
,

8723 
mœrÜ_¢­£t
, 
¤c_obj_çdvi£_æags
,

8724 
de¡_obj_çdvi£_æags
));

8725 
cİy_İs
[
de¡
] = 
cİ
;

8726 
obc
->
	`¡¬t_block
();

8728 ià(!
obc
->
obs
.
oi
.
	`has_mªiã¡
()) {

8729 
	`_cİy_some
(
obc
, 
cİ
);

8731 ià(
obc
->
obs
.
oi
.
mªiã¡
.
	`is_»dœeù
()) {

8732 
	`_cİy_some
(
obc
, 
cİ
);

8733 } ià(
obc
->
obs
.
oi
.
mªiã¡
.
	`is_chunked
()) {

8734 autØ
p
 = 
obc
->
obs
.
oi
.
mªiã¡
.
chunk_m­
.
	`begš
();

8735 
	`_cİy_some_mªiã¡
(
obc
, 
cİ
, 
p
->
fœ¡
);

8737 
	`as£¹
(0 == "unrecognized manifestype");

8740 
	}
}

8742 
	gPrim¬yLogPG
::
	$_cİy_some
(
ObjeùCÚ‹xtRef
 
obc
, 
CİyOpRef
 
cİ
)

8744 
	`dout
(10è<< 
__func__
 << " " << *
obc
 << " " << 
cİ
 << 
d’dl
;

8746 
æags
 = 0;

8747 ià(
cİ
->
æags
 & 
CEPH_OSD_COPY_FROM_FLAG_FLUSH
)

8748 
æags
 |ğ
CEPH_OSD_FLAG_FLUSH
;

8749 ià(
cİ
->
æags
 & 
CEPH_OSD_COPY_FROM_FLAG_IGNORE_CACHE
)

8750 
æags
 |ğ
CEPH_OSD_FLAG_IGNORE_CACHE
;

8751 ià(
cİ
->
æags
 & 
CEPH_OSD_COPY_FROM_FLAG_IGNORE_OVERLAY
)

8752 
æags
 |ğ
CEPH_OSD_FLAG_IGNORE_OVERLAY
;

8753 ià(
cİ
->
æags
 & 
CEPH_OSD_COPY_FROM_FLAG_MAP_SNAP_CLONE
)

8754 
æags
 |ğ
CEPH_OSD_FLAG_MAP_SNAP_CLONE
;

8755 ià(
cİ
->
æags
 & 
CEPH_OSD_COPY_FROM_FLAG_RWORDERED
)

8756 
æags
 |ğ
CEPH_OSD_FLAG_RWORDERED
;

8758 
C_G©h”Bud”
 
	`g©h”
(
cù
);

8760 ià(
cİ
->
cursÜ
.
	`is_š™Ÿl
(è&& cİ->
mœrÜ_¢­£t
) {

8762 
	`as£¹
(
cİ
->
¤c
.
¢­
 =ğ
CEPH_NOSNAP
);

8763 
ObjeùO³¿tiÚ
 
İ
;

8764 
İ
.
	`li¡_¢­s
(&
cİ
->
»suÉs
.
¢­£t
, 
NULL
);

8765 
ûph_tid_t
 
tid
 = 
osd
->
objeù”
->
	`»ad
(
cİ
->
¤c
.
oid
, cİ->
Şoc
, 
İ
,

8766 
CEPH_SNAPDIR
, 
NULL
,

8767 
æags
, 
g©h”
.
	`Ãw_sub
(), 
NULL
);

8768 
cİ
->
objeù”_tid2
 = 
tid
;

8771 
ObjeùO³¿tiÚ
 
İ
;

8772 ià(
cİ
->
»suÉs
.
u£r_v”siÚ
) {

8773 
İ
.
	`as£¹_v”siÚ
(
cİ
->
»suÉs
.
u£r_v”siÚ
);

8777 
	`as£¹
(
cİ
->
cursÜ
.
	`is_š™Ÿl
());

8779 
İ
.
	`cİy_g‘
(&
cİ
->
cursÜ
, 
	`g‘_cİy_chunk_size
(),

8780 &
cİ
->
»suÉs
.
objeù_size
, &cİ->»suÉs.
mtime
,

8781 &
cİ
->
©Œs
, &cİ->
d©a
, &cİ->
om­_h—d”
, &cİ->
om­_d©a
,

8782 &
cİ
->
»suÉs
.
¢­s
, &cİ->»suÉs.
¢­_£q
,

8783 &
cİ
->
»suÉs
.
æags
,

8784 &
cİ
->
»suÉs
.
sourû_d©a_dige¡
,

8785 &
cİ
->
»suÉs
.
sourû_om­_dige¡
,

8786 &
cİ
->
»suÉs
.
»qids
,

8787 &
cİ
->
»suÉs
.
Œunÿ‹_£q
,

8788 &
cİ
->
»suÉs
.
Œunÿ‹_size
,

8789 &
cİ
->
rv®
);

8790 
İ
.
	`£t_Ï¡_İ_æags
(
cİ
->
¤c_obj_çdvi£_æags
);

8792 
C_Cİyäom
 *
fš
 = 
Ãw
 
	`C_Cİyäom
(
this
, 
obc
->
obs
.
oi
.
soid
,

8793 
	`g‘_Ï¡_³”šg_»£t
(), 
cİ
);

8794 
n
 = 
šfo
.
pgid
.
	`hash_to_sh¬d
(
osd
->
m_objeù”_fšish”s
);

8795 
g©h”
.
	`£t_fšish”
(
Ãw
 
	`C_OnFšish”
(
fš
,

8796 
osd
->
objeù”_fšish”s
[
n
]));

8798 
ûph_tid_t
 
tid
 = 
osd
->
objeù”
->
	`»ad
(
cİ
->
¤c
.
oid
, cİ->
Şoc
, 
İ
,

8799 
cİ
->
¤c
.
¢­
, 
NULL
,

8800 
æags
,

8801 
g©h”
.
	`Ãw_sub
(),

8803 
cİ
->
»suÉs
.
u£r_v”siÚ
 ? 
NULL
 : &cop->results.user_version);

8804 
fš
->
tid
 =id;

8805 
cİ
->
objeù”_tid
 = 
tid
;

8806 
g©h”
.
	`aùiv©e
();

8807 
	}
}

8809 
	gPrim¬yLogPG
::
	$_cİy_some_mªiã¡
(
ObjeùCÚ‹xtRef
 
obc
, 
CİyOpRef
 
cİ
, 
ušt64_t
 
¡¬t_off£t
)

8811 
	`dout
(10è<< 
__func__
 << " " << *
obc
 << " " << 
cİ
 << 
d’dl
;

8813 
æags
 = 0;

8814 ià(
cİ
->
æags
 & 
CEPH_OSD_COPY_FROM_FLAG_FLUSH
)

8815 
æags
 |ğ
CEPH_OSD_FLAG_FLUSH
;

8816 ià(
cİ
->
æags
 & 
CEPH_OSD_COPY_FROM_FLAG_IGNORE_CACHE
)

8817 
æags
 |ğ
CEPH_OSD_FLAG_IGNORE_CACHE
;

8818 ià(
cİ
->
æags
 & 
CEPH_OSD_COPY_FROM_FLAG_IGNORE_OVERLAY
)

8819 
æags
 |ğ
CEPH_OSD_FLAG_IGNORE_OVERLAY
;

8820 ià(
cİ
->
æags
 & 
CEPH_OSD_COPY_FROM_FLAG_MAP_SNAP_CLONE
)

8821 
æags
 |ğ
CEPH_OSD_FLAG_MAP_SNAP_CLONE
;

8822 ià(
cİ
->
æags
 & 
CEPH_OSD_COPY_FROM_FLAG_RWORDERED
)

8823 
æags
 |ğ
CEPH_OSD_FLAG_RWORDERED
;

8825 
num_chunks
 = 0;

8826 
ušt64_t
 
Ï¡_off£t
 = 0, 
chunks_size
 = 0;

8827 
objeù_mªiã¡_t
 *
mªiã¡
 = &
obc
->
obs
.
oi
.manifest;

8828 
m­
<
ušt64_t
, 
chunk_šfo_t
>::
™”©Ü
 
™”
 = 
mªiã¡
->
chunk_m­
.
	`fšd
(
¡¬t_off£t
);

8829 ;
™”
 !ğ
mªiã¡
->
chunk_m­
.
	`’d
(); ++iter) {

8830 
num_chunks
++;

8831 
chunks_size
 +ğ
™”
->
£cÚd
.
Ëngth
;

8832 
Ï¡_off£t
 = 
™”
->
fœ¡
;

8833 ià(
	`g‘_cİy_chunk_size
(è< 
chunks_size
) {

8838 
cİ
->
num_chunk
 = 
num_chunks
;

8839 
cİ
->
¡¬t_off£t
 = start_offset;

8840 
cİ
->
Ï¡_off£t
 =†ast_offset;

8841 
	`dout
(20è<< 
__func__
 << " oid " << 
obc
->
obs
.
oi
.
soid
 << "‚um_chunks: " << 
num_chunks


8842 << " s¹_off£t: " << 
¡¬t_off£t
 << " chunks_size: " << 
chunks_size


8843 << "†a¡_off£t: " << 
Ï¡_off£t
 << 
d’dl
;

8845 
™”
 = 
mªiã¡
->
chunk_m­
.
	`fšd
(
¡¬t_off£t
);

8846 ;
™”
 !ğ
mªiã¡
->
chunk_m­
.
	`’d
(); ++iter) {

8847 
ušt64_t
 
obj_off£t
 = 
™”
->
fœ¡
;

8848 
ušt64_t
 
Ëngth
 = 
mªiã¡
->
chunk_m­
[
™”
->
fœ¡
].length;

8849 
hobjeù_t
 
soid
 = 
mªiã¡
->
chunk_m­
[
™”
->
fœ¡
].
oid
;

8850 
objeù_loÿtÜ_t
 
	`Şoc
(
soid
);

8851 
CİyC®lback
 * 
cb
 = 
NULL
;

8852 
CİyOpRef
 
	`sub_cİ
(
¡d
::
make_sh¬ed
<
CİyOp
>(
cb
, 
	`ObjeùCÚ‹xtRef
(), 
cİ
->
¤c
, 
Şoc
,

8853 
cİ
->
»suÉs
.
u£r_v”siÚ
, cİ->
æags
, cİ->
mœrÜ_¢­£t
,

8854 
cİ
->
¤c_obj_çdvi£_æags
, cİ->
de¡_obj_çdvi£_æags
));

8855 
sub_cİ
->
cursÜ
.
d©a_off£t
 = 
obj_off£t
;

8856 
cİ
->
chunk_cİs
[
obj_off£t
] = 
sub_cİ
;

8858 
s
 = 
sub_cİ
->
chunk_İs
.
	`size
();

8859 
sub_cİ
->
chunk_İs
.
	`»size
(
s
+1);

8860 
sub_cİ
->
chunk_İs
[
s
].
İ
.İ = 
CEPH_OSD_OP_READ
;

8861 
sub_cİ
->
chunk_İs
[
s
].
İ
.
ex‹Á
.
off£t
 = 
mªiã¡
->
chunk_m­
[
™”
->
fœ¡
].offset;

8862 
sub_cİ
->
chunk_İs
[
s
].
İ
.
ex‹Á
.
Ëngth
 =†ength;

8864 
ObjeùO³¿tiÚ
 
İ
;

8865 
İ
.
	`dup
(
sub_cİ
->
chunk_İs
);

8867 
	`dout
(20è<< 
__func__
 << "gt_oid: " << 
soid
.
oid
 << "gt_offset: "

8868 << 
mªiã¡
->
chunk_m­
[
™”
->
fœ¡
].
off£t


8869 << "†’gth: " << 
Ëngth
 << "…oŞ id: " << 
Şoc
.
poŞ
 << 
d’dl
;

8871 ià(
cİ
->
»suÉs
.
u£r_v”siÚ
) {

8872 
İ
.
	`as£¹_v”siÚ
(
cİ
->
»suÉs
.
u£r_v”siÚ
);

8876 
	`as£¹
(
cİ
->
cursÜ
.
	`is_š™Ÿl
());

8878 
İ
.
	`£t_Ï¡_İ_æags
(
cİ
->
¤c_obj_çdvi£_æags
);

8880 
C_CİyChunk
 *
fš
 = 
Ãw
 
	`C_CİyChunk
(
this
, 
obc
->
obs
.
oi
.
soid
,

8881 
	`g‘_Ï¡_³”šg_»£t
(), 
cİ
);

8882 
fš
->
off£t
 = 
obj_off£t
;

8883 
n
 = 
šfo
.
pgid
.
	`hash_to_sh¬d
(
osd
->
m_objeù”_fšish”s
);

8885 
ûph_tid_t
 
tid
 = 
osd
->
objeù”
->
	`»ad
(
soid
.
oid
, 
Şoc
, 
İ
,

8886 
sub_cİ
->
¤c
.
¢­
, 
NULL
,

8887 
æags
,

8888 
Ãw
 
	`C_OnFšish”
(
fš
, 
osd
->
objeù”_fšish”s
[
n
]),

8890 
sub_cİ
->
»suÉs
.
u£r_v”siÚ
 ? 
NULL
 : &sub_cop->results.user_version);

8891 
fš
->
tid
 =id;

8892 
sub_cİ
->
objeù”_tid
 = 
tid
;

8893 ià(
Ï¡_off£t
 < 
™”
->
fœ¡
) {

8897 
	}
}

8899 
	gPrim¬yLogPG
::
	$´oûss_cİy_chunk
(
hobjeù_t
 
oid
, 
ûph_tid_t
 
tid
, 
r
)

8901 
	`dout
(10è<< 
__func__
 << " " << 
oid
 << "id " << 
tid


8902 << " " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

8903 
m­
<
hobjeù_t
,
CİyOpRef
>::
™”©Ü
 
p
 = 
cİy_İs
.
	`fšd
(
oid
);

8904 ià(
p
 =ğ
cİy_İs
.
	`’d
()) {

8905 
	`dout
(10è<< 
__func__
 << "‚Øcİy_İ found" << 
d’dl
;

8908 
CİyOpRef
 
cİ
 = 
p
->
£cÚd
;

8909 ià(
tid
 !ğ
cİ
->
objeù”_tid
) {

8910 
	`dout
(10è<< 
__func__
 << "id " << 
tid
 << " !ğcİ " << 
cİ


8911 << "id " << 
cİ
->
objeù”_tid
 << 
d’dl
;

8915 ià(
cİ
->
om­_d©a
.
	`Ëngth
(è|| cİ->
om­_h—d”
.length())

8916 
cİ
->
»suÉs
.
has_om­
 = 
Œue
;

8918 ià(
r
 >ğ0 && !
poŞ
.
šfo
.
	`suµÜts_om­
() &&

8919 (
cİ
->
om­_d©a
.
	`Ëngth
(è|| cİ->
om­_h—d”
.length())) {

8920 
r
 = -
EOPNOTSUPP
;

8922 
cİ
->
objeù”_tid
 = 0;

8923 
cİ
->
objeù”_tid2
 = 0;

8924 
ObjeùCÚ‹xtRef
& 
cobc
 = 
cİ
->
obc
;

8926 ià(
r
 < 0)

8927 
out
;

8929 
	`as£¹
(
cİ
->
rv®
 >= 0);

8931 ià(
oid
.
¢­
 < 
CEPH_NOSNAP
 && !
cİ
->
»suÉs
.
¢­s
.
	`em±y
()) {

8933 
veùÜ
<
¢­id_t
>::
™”©Ü
 
p
 = 
cİ
->
»suÉs
.
¢­s
.
	`begš
();

8934 
p
 !ğ
cİ
->
»suÉs
.
¢­s
.
	`’d
()) {

8935 ià(
poŞ
.
šfo
.
	`is_»moved_¢­
(*
p
)) {

8936 
	`dout
(10è<< 
__func__
 << " clÚ¢­ " << *
p
 << " has been deleted"

8937 << 
d’dl
;

8938 
veùÜ
<
¢­id_t
>::
™”©Ü
 
q
 = 
p
 + 1;

8939 
q
 !ğ
cİ
->
»suÉs
.
¢­s
.
	`’d
();

8940 ++
q
)

8941 *(
q
 - 1) = *q;

8942 
cİ
->
»suÉs
.
¢­s
.
	`»size
(cİ->»suÉs.¢­s.
	`size
() - 1);

8944 ++
p
;

8947 ià(
cİ
->
»suÉs
.
¢­s
.
	`em±y
()) {

8948 
	`dout
(10è<< 
__func__
 << "‚ØmÜ¢­ fÜ " << 
oid
 << 
d’dl
;

8949 
r
 = -
ENOENT
;

8950 
out
;

8954 
	`as£¹
(
cİ
->
rv®
 >= 0);

8956 ià(!
cİ
->
‹mp_cursÜ
.
d©a_com¶‘e
) {

8957 
cİ
->
»suÉs
.
d©a_dige¡
 = cİ->
d©a
.
	`üc32c
(cop->results.data_digest);

8959 ià(
poŞ
.
šfo
.
	`suµÜts_om­
(è&& !
cİ
->
‹mp_cursÜ
.
om­_com¶‘e
) {

8960 ià(
cİ
->
om­_h—d”
.
	`Ëngth
()) {

8961 
cİ
->
»suÉs
.
om­_dige¡
 =

8962 
cİ
->
om­_h—d”
.
	`üc32c
(cİ->
»suÉs
.
om­_dige¡
);

8964 ià(
cİ
->
om­_d©a
.
	`Ëngth
()) {

8965 
bufã¾i¡
 
keys
;

8966 
keys
.
	`sub¡r_of
(
cİ
->
om­_d©a
, 4, cİ->om­_d©a.
	`Ëngth
() - 4);

8967 
cİ
->
»suÉs
.
om­_dige¡
 = 
keys
.
	`üc32c
(cop->results.omap_digest);

8971 ià(!
cİ
->
‹mp_cursÜ
.
©Œ_com¶‘e
) {

8972 
m­
<
¡ršg
,
bufã¾i¡
>::
™”©Ü
 
p
 = 
cİ
->
©Œs
.
	`begš
();

8973 
p
 !ğ
cİ
->
©Œs
.
	`’d
();

8974 ++
p
) {

8975 
cİ
->
»suÉs
.
©Œs
[
	`¡ršg
("_"è+ 
p
->
fœ¡
] =…->
£cÚd
;

8977 
cİ
->
©Œs
.
	`ş—r
();

8980 ià(!
cİ
->
cursÜ
.
	`is_com¶‘e
()) {

8982 ià(
cİ
->
‹mp_cursÜ
.
	`is_š™Ÿl
()) {

8983 
	`as£¹
(!
cİ
->
»suÉs
.
¡¬‹d_‹mp_obj
);

8984 
cİ
->
»suÉs
.
¡¬‹d_‹mp_obj
 = 
Œue
;

8985 
cİ
->
»suÉs
.
‹mp_oid
 = 
	`g’”©e_‹mp_objeù
(
oid
);

8986 
	`dout
(20è<< 
__func__
 << " usšgem°" << 
cİ
->
»suÉs
.
‹mp_oid
 << 
d’dl
;

8988 
ObjeùCÚ‹xtRef
 
‹mpobc
 = 
	`g‘_objeù_cÚ‹xt
(
cİ
->
»suÉs
.
‹mp_oid
, 
Œue
);

8989 
OpCÚ‹xtUPŒ
 
ùx
 = 
	`sim¶e_İc_ü—‹
(
‹mpobc
);

8990 ià(
cİ
->
‹mp_cursÜ
.
	`is_š™Ÿl
()) {

8991 
ùx
->
Ãw_‹mp_oid
 = 
cİ
->
»suÉs
.
‹mp_oid
;

8993 
	`_wr™e_cİy_chunk
(
cİ
, 
ùx
->
İ_t
.
	`g‘
());

8994 
	`sim¶e_İc_subm™
(
¡d
::
	`move
(
ùx
));

8995 
	`dout
(10è<< 
__func__
 << " f‘chšg mÜe" << 
d’dl
;

8996 
	`_cİy_some
(
cobc
, 
cİ
);

9001 ià(
cİ
->
»suÉs
.
	`is_d©a_dige¡
(è|| cİ->»suÉs.
	`is_om­_dige¡
()) {

9002 
	`dout
(20è<< 
__func__
 << 
¡d
::
hex


9003 << " gÙ dige¡:„x d©¨0x" << 
cİ
->
»suÉs
.
d©a_dige¡


9004 << " om­ 0x" << 
cİ
->
»suÉs
.
om­_dige¡


9005 << ", sourû: d©¨0x" << 
cİ
->
»suÉs
.
sourû_d©a_dige¡


9006 << " om­ 0x" << 
cİ
->
»suÉs
.
sourû_om­_dige¡


9007 << 
¡d
::
dec


9008 << " fÏg " << 
cİ
->
»suÉs
.
æags


9009 << 
d’dl
;

9011 ià(
cİ
->
»suÉs
.
	`is_d©a_dige¡
() &&

9012 
cİ
->
»suÉs
.
d©a_dige¡
 !ğcİ->»suÉs.
sourû_d©a_dige¡
) {

9013 
d”r
 << 
__func__
 << 
¡d
::
hex
 << " d©¨dige¡ 0x" << 
cİ
->
»suÉs
.
d©a_dige¡


9014 << " !ğsourû 0x" << 
cİ
->
»suÉs
.
sourû_d©a_dige¡
 << 
¡d
::
dec


9015 << 
d’dl
;

9016 
osd
->
şog
->
	`”rÜ
(è<< 
šfo
.
pgid
 << " cİy from " << 
cİ
->
¤c


9017 << "Ø" << 
cİ
->
obc
->
obs
.
oi
.
soid
 << 
¡d
::
hex


9018 << " d©¨dige¡ 0x" << 
cİ
->
»suÉs
.
d©a_dige¡


9019 << " !ğsourû 0x" << 
cİ
->
»suÉs
.
sourû_d©a_dige¡


9020 << 
¡d
::
dec
;

9021 
r
 = -
EIO
;

9022 
out
;

9024 ià(
cİ
->
»suÉs
.
	`is_om­_dige¡
() &&

9025 
cİ
->
»suÉs
.
om­_dige¡
 !ğcİ->»suÉs.
sourû_om­_dige¡
) {

9026 
d”r
 << 
__func__
 << 
¡d
::
hex


9027 << " om­ dige¡ 0x" << 
cİ
->
»suÉs
.
om­_dige¡


9028 << " !ğsourû 0x" << 
cİ
->
»suÉs
.
sourû_om­_dige¡


9029 << 
¡d
::
dec
 << 
d’dl
;

9030 
osd
->
şog
->
	`”rÜ
(è<< 
šfo
.
pgid
 << " cİy from " << 
cİ
->
¤c


9031 << "Ø" << 
cİ
->
obc
->
obs
.
oi
.
soid
 << 
¡d
::
hex


9032 << " om­ dige¡ 0x" << 
cİ
->
»suÉs
.
om­_dige¡


9033 << " !ğsourû 0x" << 
cİ
->
»suÉs
.
sourû_om­_dige¡


9034 << 
¡d
::
dec
;

9035 
r
 = -
EIO
;

9036 
out
;

9038 ià(
cù
->
_cÚf
->
osd_debug_šjeù_cİyäom_”rÜ
) {

9039 
d”r
 << 
__func__
 << " injeùšg cİyäom fau»" << 
d’dl
;

9040 
r
 = -
EIO
;

9041 
out
;

9044 
cİ
->
»suÉs
.
fl_š_fš®_tx
 = 
¡d
::
funùiÚ
<(
PGT¿n§ùiÚ
*)>(

9045 [
this
, &
cİ
 ](
PGT¿n§ùiÚ
 *
t
) {

9046 
ObjeùS‹
& 
obs
 = 
cİ
->
obc
->obs;

9047 ià(
cİ
->
‹mp_cursÜ
.
	`is_š™Ÿl
()) {

9048 
	`dout
(20) << "fill_in_final_tx: writing "

9049 << "dœeùlyØfš® objeù" << 
d’dl
;

9051 
cİ
->
»suÉs
.
‹mp_oid
 = 
obs
.
oi
.
soid
;

9052 
	`_wr™e_cİy_chunk
(
cİ
, 
t
);

9055 
	`dout
(20è<< "fl_š_fš®_tx: wr™šgØ‹m°objeù" << 
d’dl
;

9056 
	`_wr™e_cİy_chunk
(
cİ
, 
t
);

9057 
t
->
	`»Çme
(
obs
.
oi
.
soid
, 
cİ
->
»suÉs
.
‹mp_oid
);

9059 
t
->
	`£‰rs
(
obs
.
oi
.
soid
, 
cİ
->
»suÉs
.
©Œs
);

9062 
	`dout
(20è<< 
__func__
 << " sucûss; comm™tšg" << 
d’dl
;

9064 
out
:

9065 
	`dout
(20è<< 
__func__
 << " com¶‘¸ğ" << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

9066 
CİyC®lbackResuÉs
 
	`»suÉs
(
r
, &
cİ
->
»suÉs
);

9067 
cİ
->
cb
->
	`com¶‘e
(
»suÉs
);

9069 
cİy_İs
.
	`”a£
(
cobc
->
obs
.
oi
.
soid
);

9070 
cobc
->
	`¡İ_block
();

9072 ià(
r
 < 0 && 
cİ
->
»suÉs
.
¡¬‹d_‹mp_obj
) {

9073 
	`dout
(10è<< 
__func__
 << " deleting…artialemp object "

9074 << 
cİ
->
»suÉs
.
‹mp_oid
 << 
d’dl
;

9075 
ObjeùCÚ‹xtRef
 
‹mpobc
 = 
	`g‘_objeù_cÚ‹xt
(
cİ
->
»suÉs
.
‹mp_oid
, 
Œue
);

9076 
OpCÚ‹xtUPŒ
 
ùx
 = 
	`sim¶e_İc_ü—‹
(
‹mpobc
);

9077 
ùx
->
İ_t
->
	`»move
(
cİ
->
»suÉs
.
‹mp_oid
);

9078 
ùx
->
disÿrd_‹mp_oid
 = 
cİ
->
»suÉs
.
‹mp_oid
;

9079 
	`sim¶e_İc_subm™
(
¡d
::
	`move
(
ùx
));

9083 ià(!
r
) {

9084 
	`ÿnûl_ªd_»queue_´oxy_İs
(
cobc
->
obs
.
oi
.
soid
);

9087 
	`kick_objeù_cÚ‹xt_blocked
(
cobc
);

9088 
	}
}

9090 
	gPrim¬yLogPG
::
	$´oûss_cİy_chunk_mªiã¡
(
hobjeù_t
 
oid
, 
ûph_tid_t
 
tid
, 
r
, 
ušt64_t
 
off£t
)

9092 
	`dout
(10è<< 
__func__
 << " " << 
oid
 << "id " << 
tid


9093 << " " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

9094 
m­
<
hobjeù_t
,
CİyOpRef
>::
™”©Ü
 
p
 = 
cİy_İs
.
	`fšd
(
oid
);

9095 ià(
p
 =ğ
cİy_İs
.
	`’d
()) {

9096 
	`dout
(10è<< 
__func__
 << "‚Øcİy_İ found" << 
d’dl
;

9099 
CİyOpRef
 
obj_cİ
 = 
p
->
£cÚd
;

9100 
CİyOpRef
 
chunk_cİ
 = 
obj_cİ
->
chunk_cİs
[
off£t
];

9102 ià(
tid
 !ğ
chunk_cİ
->
objeù”_tid
) {

9103 
	`dout
(10è<< 
__func__
 << "id " << 
tid
 << " !ğcİ " << 
chunk_cİ


9104 << "id " << 
chunk_cİ
->
objeù”_tid
 << 
d’dl
;

9108 ià(
chunk_cİ
->
om­_d©a
.
	`Ëngth
(è|| chunk_cİ->
om­_h—d”
.length()) {

9109 
r
 = -
EOPNOTSUPP
;

9112 
chunk_cİ
->
objeù”_tid
 = 0;

9113 
chunk_cİ
->
objeù”_tid2
 = 0;

9114 
ObjeùCÚ‹xtRef
& 
cobc
 = 
obj_cİ
->
obc
;

9115 
OSDOp
 &
chunk_d©a
 = 
chunk_cİ
->
chunk_İs
[0];

9117 ià(
r
 < 0) {

9118 
obj_cİ
->
çed
 = 
Œue
;

9119 
out
;

9122 ià(
obj_cİ
->
çed
) {

9125 ià(!
chunk_d©a
.
outd©a
.
	`Ëngth
()) {

9126 
r
 = -
EIO
;

9127 
obj_cİ
->
çed
 = 
Œue
;

9128 
out
;

9131 
obj_cİ
->
num_chunk
--;

9134 ià(
obj_cİ
->
num_chunk
) {

9135 
	`dout
(20è<< 
__func__
 << "‚um_chunk: " << 
obj_cİ
->
num_chunk
 << 
d’dl
;

9140 
OpCÚ‹xtUPŒ
 
ùx
 = 
	`sim¶e_İc_ü—‹
(
obj_cİ
->
obc
);

9141 ià(!
ùx
->
lock_mªag”
.
	`ke_wr™e_lock
(

9142 
obj_cİ
->
obc
->
obs
.
oi
.
soid
,

9143 
obj_cİ
->
obc
)) {

9146 
r
 = -
EAGAIN
;

9147 
obj_cİ
->
çed
 = 
Œue
;

9148 
	`şo£_İ_ùx
(
ùx
.
	`»Ëa£
());

9149 
out
;

9151 
	`dout
(20è<< 
__func__
 << "ook†ock oÀobc, " << 
obj_cİ
->
obc
->
rw¡©e
 << 
d’dl
;

9153 
PGT¿n§ùiÚ
 *
t
 = 
ùx
->
İ_t
.
	`g‘
();

9154 
ObjeùS‹
& 
obs
 = 
ùx
->
Ãw_obs
;

9155 autØ
p
 : 
obj_cİ
->
chunk_cİs
) {

9156 
OSDOp
 &
sub_chunk
 = 
p
.
£cÚd
->
chunk_İs
[0];

9157 
t
->
	`wr™e
(
cobc
->
obs
.
oi
.
soid
,

9158 
p
.
£cÚd
->
cursÜ
.
d©a_off£t
,

9159 
sub_chunk
.
outd©a
.
	`Ëngth
(),

9160 
sub_chunk
.
outd©a
,

9161 
p
.
£cÚd
->
de¡_obj_çdvi£_æags
);

9162 
	`dout
(20è<< 
__func__
 << " off£t: " << 
p
.
£cÚd
->
cursÜ
.
d©a_off£t


9163 << "†’gth: " << 
sub_chunk
.
outd©a
.
	`Ëngth
(è<< 
d’dl
;

9164 
	`wr™e_upd©e_size_ªd_u§ge
(
ùx
->
d–_¡©s
, 
obs
.
oi
, ctx->
modif›d_¿nges
,

9165 
p
.
£cÚd
->
cursÜ
.
d©a_off£t
, 
sub_chunk
.
outd©a
.
	`Ëngth
());

9166 
obs
.
oi
.
mªiã¡
.
chunk_m­
[
p
.
£cÚd
->
cursÜ
.
d©a_off£t
].
æags
 = 0;

9167 
sub_chunk
.
outd©a
.
	`ş—r
();

9169 
obs
.
oi
.
	`ş—r_d©a_dige¡
();

9170 
ùx
->
©_v”siÚ
 = 
	`g‘_Ãxt_v”siÚ
();

9171 
	`fšish_ùx
(
ùx
.
	`g‘
(), 
pg_log_’Œy_t
::
PROMOTE
);

9172 
	`sim¶e_İc_subm™
(
¡d
::
	`move
(
ùx
));

9174 autØ
p
 = 
cobc
->
obs
.
oi
.
mªiã¡
.
chunk_m­
.
	`rbegš
();

9176 ià(
p
 !ğ
cobc
->
obs
.
oi
.
mªiã¡
.
chunk_m­
.
	`»nd
()) {

9177 ià(
obj_cİ
->
Ï¡_off£t
 >ğ
p
->
fœ¡
 +…->
£cÚd
.
Ëngth
) {

9178 autØ&
’
 : 
cobc
->
obs
.
oi
.
mªiã¡
.
chunk_m­
) {

9179 ià(
obj_cİ
->
Ï¡_off£t
 < 
’
.
fœ¡
) {

9180 
	`_cİy_some_mªiã¡
(
cobc
, 
obj_cİ
, 
’
.
fœ¡
);

9188 
out
:

9189 
	`dout
(20è<< 
__func__
 << " com¶‘¸ğ" << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

9190 
CİyC®lbackResuÉs
 
	`»suÉs
(
r
, &
obj_cİ
->
»suÉs
);

9191 
obj_cİ
->
cb
->
	`com¶‘e
(
»suÉs
);

9193 
cİy_İs
.
	`”a£
(
cobc
->
obs
.
oi
.
soid
);

9194 
cobc
->
	`¡İ_block
();

9197 ià(!
r
) {

9198 
	`ÿnûl_ªd_»queue_´oxy_İs
(
cobc
->
obs
.
oi
.
soid
);

9201 
	`kick_objeù_cÚ‹xt_blocked
(
cobc
);

9202 
	}
}

9204 
	gPrim¬yLogPG
::
	$ÿnûl_ªd_»queue_´oxy_İs
(
hobjeù_t
 
oid
) {

9205 
veùÜ
<
ûph_tid_t
> 
tids
;

9206 
m­
<
ûph_tid_t
, 
ProxyR—dOpRef
>::
™”©Ü
 
™
 = 
´oxy»ad_İs
.
	`begš
();

9207 
™
 !ğ
´oxy»ad_İs
.
	`’d
();) {

9208 ià(
™
->
£cÚd
->
soid
 =ğ
oid
) {

9209 
	`ÿnûl_´oxy_»ad
((
™
++)->
£cÚd
, &
tids
);

9211 ++
™
;

9214 
m­
<
ûph_tid_t
, 
ProxyWr™eOpRef
>::
™”©Ü
 
™
 = 
´oxywr™e_İs
.
	`begš
();

9215 
™
 !ğ
´oxywr™e_İs
.
	`’d
();) {

9216 ià(
™
->
£cÚd
->
soid
 =ğ
oid
) {

9217 
	`ÿnûl_´oxy_wr™e
((
™
++)->
£cÚd
, &
tids
);

9219 ++
™
;

9222 
osd
->
objeù”
->
	`İ_ÿnûl
(
tids
, -
ECANCELED
);

9223 
	`kick_´oxy_İs_blocked
(
oid
);

9224 
	}
}

9226 
	gPrim¬yLogPG
::
	$_wr™e_cİy_chunk
(
CİyOpRef
 
cİ
, 
PGT¿n§ùiÚ
 *
t
)

9228 
	`dout
(20è<< 
__func__
 << " " << 
cİ


9229 << " " << 
cİ
->
©Œs
.
	`size
() << "‡ttrs"

9230 << " " << 
cİ
->
d©a
.
	`Ëngth
() << " bytes"

9231 << " " << 
cİ
->
om­_h—d”
.
	`Ëngth
() << " omap header bytes"

9232 << " " << 
cİ
->
om­_d©a
.
	`Ëngth
() << " omap data bytes"

9233 << 
d’dl
;

9234 ià(!
cİ
->
‹mp_cursÜ
.
©Œ_com¶‘e
) {

9235 
t
->
	`ü—‹
(
cİ
->
»suÉs
.
‹mp_oid
);

9237 ià(!
cİ
->
‹mp_cursÜ
.
d©a_com¶‘e
) {

9238 
	`as£¹
(
cİ
->
d©a
.
	`Ëngth
(è+ cİ->
‹mp_cursÜ
.
d©a_off£t
 ==

9239 
cİ
->
cursÜ
.
d©a_off£t
);

9240 ià(
poŞ
.
šfo
.
	`»quœes_®igÃd_­³nd
() &&

9241 !
cİ
->
cursÜ
.
d©a_com¶‘e
) {

9246 
	`as£¹
(
cİ
->
‹mp_cursÜ
.
d©a_off£t
 %

9247 
poŞ
.
šfo
.
	`»quœed_®ignm’t
() == 0);

9248 ià(
cİ
->
d©a
.
	`Ëngth
(è% 
poŞ
.
šfo
.
	`»quœed_®ignm’t
() != 0) {

9249 
ušt64_t
 
to_Œim
 =

9250 
cİ
->
d©a
.
	`Ëngth
(è% 
poŞ
.
šfo
.
	`»quœed_®ignm’t
();

9251 
bufã¾i¡
 
bl
;

9252 
bl
.
	`sub¡r_of
(
cİ
->
d©a
, 0, cİ->d©a.
	`Ëngth
(è- 
to_Œim
);

9253 
cİ
->
d©a
.
	`sw­
(
bl
);

9254 
cİ
->
cursÜ
.
d©a_off£t
 -ğ
to_Œim
;

9255 
	`as£¹
(
cİ
->
d©a
.
	`Ëngth
(è+ cİ->
‹mp_cursÜ
.
d©a_off£t
 ==

9256 
cİ
->
cursÜ
.
d©a_off£t
);

9259 ià(
cİ
->
d©a
.
	`Ëngth
()) {

9260 
t
->
	`wr™e
(

9261 
cİ
->
»suÉs
.
‹mp_oid
,

9262 
cİ
->
‹mp_cursÜ
.
d©a_off£t
,

9263 
cİ
->
d©a
.
	`Ëngth
(),

9264 
cİ
->
d©a
,

9265 
cİ
->
de¡_obj_çdvi£_æags
);

9267 
cİ
->
d©a
.
	`ş—r
();

9269 ià(
poŞ
.
šfo
.
	`suµÜts_om­
()) {

9270 ià(!
cİ
->
‹mp_cursÜ
.
om­_com¶‘e
) {

9271 ià(
cİ
->
om­_h—d”
.
	`Ëngth
()) {

9272 
t
->
	`om­_£th—d”
(

9273 
cİ
->
»suÉs
.
‹mp_oid
,

9274 
cİ
->
om­_h—d”
);

9275 
cİ
->
om­_h—d”
.
	`ş—r
();

9277 ià(
cİ
->
om­_d©a
.
	`Ëngth
()) {

9278 
m­
<
¡ršg
,
bufã¾i¡
> 
om­
;

9279 
bufã¾i¡
::
™”©Ü
 
p
 = 
cİ
->
om­_d©a
.
	`begš
();

9280 
	`decode
(
om­
, 
p
);

9281 
t
->
	`om­_£tkeys
(
cİ
->
»suÉs
.
‹mp_oid
, 
om­
);

9282 
cİ
->
om­_d©a
.
	`ş—r
();

9286 
	`as£¹
(
cİ
->
om­_h—d”
.
	`Ëngth
() == 0);

9287 
	`as£¹
(
cİ
->
om­_d©a
.
	`Ëngth
() == 0);

9289 
cİ
->
‹mp_cursÜ
 = cİ->
cursÜ
;

9290 
	}
}

9292 
	gPrim¬yLogPG
::
	$fšish_cİyäom
(
CİyFromC®lback
 *
cb
)

9294 
OpCÚ‹xt
 *
ùx
 = 
cb
->ctx;

9295 
	`dout
(20è<< "fšish_cİyäom oÀ" << 
ùx
->
obs
->
oi
.
soid
 << 
d’dl
;

9297 
ObjeùS‹
& 
obs
 = 
ùx
->
Ãw_obs
;

9298 ià(
obs
.
exi¡s
) {

9299 
	`dout
(20è<< 
__func__
 << ":ƒxi¡s,„emovšg" << 
d’dl
;

9300 
ùx
->
İ_t
->
	`»move
(
obs
.
oi
.
soid
);

9302 
ùx
->
d–_¡©s
.
num_objeùs
++;

9303 
obs
.
exi¡s
 = 
Œue
;

9305 ià(
cb
->
	`is_‹mp_obj_u£d
()) {

9306 
ùx
->
disÿrd_‹mp_oid
 = 
cb
->
»suÉs
->
‹mp_oid
;

9308 
cb
->
»suÉs
->
	`fl_š_fš®_tx
(
ùx
->
İ_t
.
	`g‘
());

9311 
obs
.
oi
.
u£r_v”siÚ
 = 
ùx
->
u£r_©_v”siÚ
;

9313 ià(
cb
->
»suÉs
->
	`is_d©a_dige¡
()) {

9314 
obs
.
oi
.
	`£t_d©a_dige¡
(
cb
->
»suÉs
->
d©a_dige¡
);

9316 
obs
.
oi
.
	`ş—r_d©a_dige¡
();

9318 ià(
cb
->
»suÉs
->
	`is_om­_dige¡
()) {

9319 
obs
.
oi
.
	`£t_om­_dige¡
(
cb
->
»suÉs
->
om­_dige¡
);

9321 
obs
.
oi
.
	`ş—r_om­_dige¡
();

9324 
obs
.
oi
.
Œunÿ‹_£q
 = 
cb
->
»suÉs
->truncate_seq;

9325 
obs
.
oi
.
Œunÿ‹_size
 = 
cb
->
»suÉs
->truncate_size;

9327 
ùx
->
exŒa_»qids
 = 
cb
->
»suÉs
->
»qids
;

9330 ià(
obs
.
oi
.
	`is_wh™eout
()) {

9331 
	`dout
(10è<< 
__func__
 << " cË¬šg wh™eouˆÚ " << 
obs
.
oi
.
soid
 << 
d’dl
;

9332 
obs
.
oi
.
	`ş—r_æag
(
objeù_šfo_t
::
FLAG_WHITEOUT
);

9333 --
ùx
->
d–_¡©s
.
num_wh™eouts
;

9336 ià(
cb
->
»suÉs
->
has_om­
) {

9337 
	`dout
(10è<< 
__func__
 << " s‘tšg om­ fÏg oÀ" << 
obs
.
oi
.
soid
 << 
d’dl
;

9338 
obs
.
oi
.
	`£t_æag
(
objeù_šfo_t
::
FLAG_OMAP
);

9340 
	`dout
(10è<< 
__func__
 << " cË¬šg om­ fÏg oÀ" << 
obs
.
oi
.
soid
 << 
d’dl
;

9341 
obs
.
oi
.
	`ş—r_æag
(
objeù_šfo_t
::
FLAG_OMAP
);

9344 
š‹rv®_£t
<
ušt64_t
> 
ch
;

9345 ià(
obs
.
oi
.
size
 > 0)

9346 
ch
.
	`š£¹
(0, 
obs
.
oi
.
size
);

9347 
ùx
->
modif›d_¿nges
.
	`uniÚ_of
(
ch
);

9349 ià(
cb
->
	`g‘_d©a_size
(è!ğ
obs
.
oi
.
size
) {

9350 
ùx
->
d–_¡©s
.
num_by‹s
 -ğ
obs
.
oi
.
size
;

9351 
obs
.
oi
.
size
 = 
cb
->
	`g‘_d©a_size
();

9352 
ùx
->
d–_¡©s
.
num_by‹s
 +ğ
obs
.
oi
.
size
;

9354 
ùx
->
d–_¡©s
.
num_wr
++;

9355 
ùx
->
d–_¡©s
.
num_wr_kb
 +ğ
	`shiá_round_up
(
obs
.
oi
.
size
, 10);

9357 
osd
->
logg”
->
	`šc
(
l_osd_cİyäom
);

9358 
	}
}

9360 
	gPrim¬yLogPG
::
	$fšish_´omÙe
(
r
, 
CİyResuÉs
 *
»suÉs
,

9361 
ObjeùCÚ‹xtRef
 
obc
)

9363 cÚ¡ 
hobjeù_t
& 
soid
 = 
obc
->
obs
.
oi
.soid;

9364 
	`dout
(10è<< 
__func__
 << " " << 
soid
 << "„=" << 
r


9365 << " uv" << 
»suÉs
->
u£r_v”siÚ
 << 
d’dl
;

9367 ià(
r
 =ğ-
ECANCELED
) {

9371 ià(
r
 !ğ-
ENOENT
 && 
soid
.
	`is_¢­
()) {

9372 ià(
»suÉs
->
¢­s
.
	`em±y
()) {

9378 
SÇpS‘
& 
¢­£t
 = 
obc
->
ssc
->snapset;

9379 
veùÜ
<
¢­id_t
>::
™”©Ü
 
p
 = 
¢­£t
.
¢­s
.
	`begš
();

9380 
p
 !ğ
¢­£t
.
¢­s
.
	`’d
(è&& *°> 
soid
.
¢­
)

9381 ++
p
;

9382 
p
 !ğ
¢­£t
.
¢­s
.
	`’d
(è&& *°> 
»suÉs
->
¢­_£q
) {

9383 
»suÉs
->
¢­s
.
	`push_back
(*
p
);

9384 ++
p
;

9388 
	`dout
(20è<< 
__func__
 << " sÇp " << 
»suÉs
->
¢­s
 << 
d’dl
;

9389 
	`f‹r_¢­c
(
»suÉs
->
¢­s
);

9391 
	`dout
(20è<< 
__func__
 << " f‹»d sÇp " << 
»suÉs
->
¢­s
 << 
d’dl
;

9392 ià(
»suÉs
->
¢­s
.
	`em±y
()) {

9393 
	`dout
(20è<< 
__func__


9395 << " s‘tšg„ØENOENT" << 
d’dl
;

9396 
r
 = -
ENOENT
;

9400 ià(
r
 < 0 && 
»suÉs
->
¡¬‹d_‹mp_obj
) {

9401 
	`dout
(10è<< 
__func__
 << "‡bÜt; wÈş—Àu°·¹ŸÈwÜk" << 
d’dl
;

9402 
ObjeùCÚ‹xtRef
 
‹mpobc
 = 
	`g‘_objeù_cÚ‹xt
(
»suÉs
->
‹mp_oid
, 
çl£
);

9403 
	`as£¹
(
‹mpobc
);

9404 
OpCÚ‹xtUPŒ
 
ùx
 = 
	`sim¶e_İc_ü—‹
(
‹mpobc
);

9405 
ùx
->
İ_t
->
	`»move
(
»suÉs
->
‹mp_oid
);

9406 
	`sim¶e_İc_subm™
(
¡d
::
	`move
(
ùx
));

9407 
»suÉs
->
¡¬‹d_‹mp_obj
 = 
çl£
;

9410 ià(
r
 =ğ-
ENOENT
 && 
soid
.
	`is_¢­
()) {

9411 
	`dout
(10è<< 
__func__


9412 << ":ƒnÛÁ whŒyšgØ´omÙşÚe, " << 
soid


9414 << 
d’dl
;

9415 
hobjeù_t
 
	`h—d
(
soid
.
	`g‘_h—d
());

9416 
ObjeùCÚ‹xtRef
 
obc
 = 
	`g‘_objeù_cÚ‹xt
(
h—d
, 
çl£
);

9417 
	`as£¹
(
obc
);

9419 
OpCÚ‹xtUPŒ
 
tùx
 = 
	`sim¶e_İc_ü—‹
(
obc
);

9420 
tùx
->
©_v”siÚ
 = 
	`g‘_Ãxt_v”siÚ
();

9421 
	`f‹r_¢­c
(
tùx
->
Ãw_¢­£t
.
¢­s
);

9422 
veùÜ
<
¢­id_t
> 
Ãw_şÚes
;

9423 
m­
<
¢­id_t
, 
veùÜ
<¢­id_t>> 
Ãw_şÚe_¢­s
;

9424 
veùÜ
<
¢­id_t
>::
™”©Ü
 
i
 = 
tùx
->
Ãw_¢­£t
.
şÚes
.
	`begš
();

9425 
i
 !ğ
tùx
->
Ãw_¢­£t
.
şÚes
.
	`’d
();

9426 ++
i
) {

9427 ià(*
i
 !ğ
soid
.
¢­
) {

9428 
Ãw_şÚes
.
	`push_back
(*
i
);

9429 autØ
p
 = 
tùx
->
Ãw_¢­£t
.
şÚe_¢­s
.
	`fšd
(*
i
);

9430 ià(
p
 !ğ
tùx
->
Ãw_¢­£t
.
şÚe_¢­s
.
	`’d
()) {

9431 
Ãw_şÚe_¢­s
[*
i
] = 
p
->
£cÚd
;

9435 
tùx
->
Ãw_¢­£t
.
şÚes
.
	`sw­
(
Ãw_şÚes
);

9436 
tùx
->
Ãw_¢­£t
.
şÚe_ov”Ïp
.
	`”a£
(
soid
.
¢­
);

9437 
tùx
->
Ãw_¢­£t
.
şÚe_size
.
	`”a£
(
soid
.
¢­
);

9438 
tùx
->
Ãw_¢­£t
.
şÚe_¢­s
.
	`sw­
(
Ãw_şÚe_¢­s
);

9441 ià(!
tùx
->
lock_mªag”
.
	`ke_wr™e_lock
(

9442 
h—d
,

9443 
obc
)) {

9444 
	`as£¹
(0 == "problem!");

9446 
	`dout
(20è<< 
__func__
 << "ook†ock oÀobc, " << 
obc
->
rw¡©e
 << 
d’dl
;

9448 
	`fšish_ùx
(
tùx
.
	`g‘
(), 
pg_log_’Œy_t
::
PROMOTE
);

9450 
	`sim¶e_İc_subm™
(
¡d
::
	`move
(
tùx
));

9454 
boŞ
 
wh™eout
 = 
çl£
;

9455 ià(
r
 =ğ-
ENOENT
) {

9456 
	`as£¹
(
soid
.
¢­
 =ğ
CEPH_NOSNAP
);

9457 
	`dout
(10è<< 
__func__
 << " wh™eouˆ" << 
soid
 << 
d’dl
;

9458 
wh™eout
 = 
Œue
;

9461 ià(
r
 < 0 && !
wh™eout
) {

9462 
d”r
 << 
__func__
 << " uÃx³ùed…romÙ”rÜ " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

9466 
m­
<
hobjeù_t
,
li¡
<
OpReque¡Ref
>>::
™”©Ü
 
blocked_™”
 =

9467 
wa™šg_fÜ_blocked_objeù
.
	`fšd
(
soid
);

9468 ià(
blocked_™”
 !ğ
wa™šg_fÜ_blocked_objeù
.
	`’d
()) {

9469 !
blocked_™”
->
£cÚd
.
	`em±y
()) {

9470 
osd
->
	`»¶y_İ_”rÜ
(
blocked_™”
->
£cÚd
.
	`äÚt
(), 
r
);

9471 
blocked_™”
->
£cÚd
.
	`pİ_äÚt
();

9473 
wa™šg_fÜ_blocked_objeù
.
	`”a£
(
blocked_™”
);

9478 
osd
->
	`´omÙe_fšish
(
»suÉs
->
objeù_size
);

9480 
OpCÚ‹xtUPŒ
 
tùx
 = 
	`sim¶e_İc_ü—‹
(
obc
);

9481 
tùx
->
©_v”siÚ
 = 
	`g‘_Ãxt_v”siÚ
();

9483 ià(!
obc
->
obs
.
oi
.
	`has_mªiã¡
()) {

9484 ++
tùx
->
d–_¡©s
.
num_objeùs
;

9486 ià(
soid
.
¢­
 < 
CEPH_NOSNAP
)

9487 ++
tùx
->
d–_¡©s
.
num_objeù_şÚes
;

9488 
tùx
->
Ãw_obs
.
exi¡s
 = 
Œue
;

9490 
tùx
->
exŒa_»qids
 = 
»suÉs
->
»qids
;

9492 ià(
wh™eout
) {

9494 
tùx
->
İ_t
->
	`ü—‹
(
soid
);

9495 
tùx
->
Ãw_obs
.
oi
.
	`£t_æag
(
objeù_šfo_t
::
FLAG_WHITEOUT
);

9496 ++
tùx
->
d–_¡©s
.
num_wh™eouts
;

9497 
	`dout
(20è<< 
__func__
 << " c»©šg wh™eouˆÚ " << 
soid
 << 
d’dl
;

9498 
osd
->
logg”
->
	`šc
(
l_osd_t›r_wh™eout
);

9500 ià(
»suÉs
->
has_om­
) {

9501 
	`dout
(10è<< 
__func__
 << " s‘tšg om­ fÏg oÀ" << 
soid
 << 
d’dl
;

9502 
tùx
->
Ãw_obs
.
oi
.
	`£t_æag
(
objeù_šfo_t
::
FLAG_OMAP
);

9503 ++
tùx
->
d–_¡©s
.
num_objeùs_om­
;

9506 
»suÉs
->
	`fl_š_fš®_tx
(
tùx
->
İ_t
.
	`g‘
());

9507 ià(
»suÉs
->
¡¬‹d_‹mp_obj
) {

9508 
tùx
->
disÿrd_‹mp_oid
 = 
»suÉs
->
‹mp_oid
;

9510 
tùx
->
Ãw_obs
.
oi
.
size
 = 
»suÉs
->
objeù_size
;

9511 
tùx
->
Ãw_obs
.
oi
.
u£r_v”siÚ
 = 
»suÉs
->user_version;

9512 ià(
»suÉs
->
	`is_d©a_dige¡
()) {

9513 
tùx
->
Ãw_obs
.
oi
.
	`£t_d©a_dige¡
(
»suÉs
->
d©a_dige¡
);

9515 
tùx
->
Ãw_obs
.
oi
.
	`ş—r_d©a_dige¡
();

9517 ià(
»suÉs
->
	`is_om­_dige¡
()) {

9518 
tùx
->
Ãw_obs
.
oi
.
	`£t_om­_dige¡
(
»suÉs
->
om­_dige¡
);

9520 
tùx
->
Ãw_obs
.
oi
.
	`ş—r_om­_dige¡
();

9522 
tùx
->
Ãw_obs
.
oi
.
Œunÿ‹_£q
 = 
»suÉs
->truncate_seq;

9523 
tùx
->
Ãw_obs
.
oi
.
Œunÿ‹_size
 = 
»suÉs
->truncate_size;

9525 ià(
soid
.
¢­
 !ğ
CEPH_NOSNAP
) {

9526 
	`as£¹
(
obc
->
ssc
->
¢­£t
.
şÚe_¢­s
.
	`couÁ
(
soid
.
¢­
));

9527 
	`as£¹
(
obc
->
ssc
->
¢­£t
.
şÚe_size
.
	`couÁ
(
soid
.
¢­
));

9528 
	`as£¹
(
obc
->
ssc
->
¢­£t
.
şÚe_size
[
soid
.
¢­
] ==

9529 
»suÉs
->
objeù_size
);

9530 
	`as£¹
(
obc
->
ssc
->
¢­£t
.
şÚe_ov”Ïp
.
	`couÁ
(
soid
.
¢­
));

9532 
tùx
->
d–_¡©s
.
num_by‹s
 +ğ
obc
->
ssc
->
¢­£t
.
	`g‘_şÚe_by‹s
(
soid
.
¢­
);

9534 
tùx
->
d–_¡©s
.
num_by‹s
 +ğ
»suÉs
->
objeù_size
;

9538 ià(
»suÉs
->
mœrÜ_¢­£t
) {

9539 
	`as£¹
(
tùx
->
Ãw_obs
.
oi
.
soid
.
¢­
 =ğ
CEPH_NOSNAP
);

9540 
tùx
->
Ãw_¢­£t
.
	`äom_¢­_£t
(

9541 
»suÉs
->
¢­£t
,

9542 
	`g‘_osdm­
()->
»quœe_osd_»Ëa£
 < 
CEPH_RELEASE_LUMINOUS
);

9544 
	`dout
(20è<< 
__func__
 << "‚ew_¢­£ˆ" << 
tùx
->
Ãw_¢­£t
 << 
d’dl
;

9547 ià(!
tùx
->
lock_mªag”
.
	`ke_wr™e_lock
(

9548 
obc
->
obs
.
oi
.
soid
,

9549 
obc
)) {

9550 
	`as£¹
(0 == "problem!");

9552 
	`dout
(20è<< 
__func__
 << "ook†ock oÀobc, " << 
obc
->
rw¡©e
 << 
d’dl
;

9554 
	`fšish_ùx
(
tùx
.
	`g‘
(), 
pg_log_’Œy_t
::
PROMOTE
);

9556 
	`sim¶e_İc_subm™
(
¡d
::
	`move
(
tùx
));

9558 
osd
->
logg”
->
	`šc
(
l_osd_t›r_´omÙe
);

9560 ià(
ag’t_¡©e
 &&

9561 
ag’t_¡©e
->
	`is_idË
())

9562 
	`ag’t_choo£_mode
();

9563 
	}
}

9565 
	gPrim¬yLogPG
::
	$fšish_´omÙe_mªiã¡
(
r
, 
CİyResuÉs
 *
»suÉs
,

9566 
ObjeùCÚ‹xtRef
 
obc
)

9568 cÚ¡ 
hobjeù_t
& 
soid
 = 
obc
->
obs
.
oi
.soid;

9569 
	`dout
(10è<< 
__func__
 << " " << 
soid
 << "„=" << 
r


9570 << " uv" << 
»suÉs
->
u£r_v”siÚ
 << 
d’dl
;

9572 ià(
r
 =ğ-
ECANCELED
 ||„ =ğ-
EAGAIN
) {

9576 ià(
r
 < 0) {

9577 
d”r
 << 
__func__
 << " uÃx³ùed…romÙ”rÜ " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

9581 
m­
<
hobjeù_t
,
li¡
<
OpReque¡Ref
>>::
™”©Ü
 
blocked_™”
 =

9582 
wa™šg_fÜ_blocked_objeù
.
	`fšd
(
soid
);

9583 ià(
blocked_™”
 !ğ
wa™šg_fÜ_blocked_objeù
.
	`’d
()) {

9584 !
blocked_™”
->
£cÚd
.
	`em±y
()) {

9585 
osd
->
	`»¶y_İ_”rÜ
(
blocked_™”
->
£cÚd
.
	`äÚt
(), 
r
);

9586 
blocked_™”
->
£cÚd
.
	`pİ_äÚt
();

9588 
wa™šg_fÜ_blocked_objeù
.
	`”a£
(
blocked_™”
);

9593 
osd
->
	`´omÙe_fšish
(
»suÉs
->
objeù_size
);

9594 
osd
->
logg”
->
	`šc
(
l_osd_t›r_´omÙe
);

9596 ià(
ag’t_¡©e
 &&

9597 
ag’t_¡©e
->
	`is_idË
())

9598 
	`ag’t_choo£_mode
();

9599 
	}
}

9601 
	gPrim¬yLogPG
::
ÿnûl_cİy
(
CİyOpRef
 
cİ
, 
boŞ
 
»queue
,

9602 
veùÜ
<
ûph_tid_t
> *
tids
)

9604 
dout
(10è<< 
	g__func__
 << " " << 
	gcİ
->
	gobc
->
	gobs
.
	goi
.
	gsoid


9605 << " from " << 
	gcİ
->
	g¤c
 << " " << cİ->
	gŞoc


9606 << " v" << 
	gcİ
->
	g»suÉs
.
	gu£r_v”siÚ
 << 
	gd’dl
;

9609 ià(
	gcİ
->
	gobjeù”_tid
) {

9610 
	gtids
->
push_back
(
cİ
->
objeù”_tid
);

9611 
	gcİ
->
	gobjeù”_tid
 = 0;

9612 ià(
	gcİ
->
	gobjeù”_tid2
) {

9613 
	gtids
->
push_back
(
cİ
->
objeù”_tid2
);

9614 
	gcİ
->
	gobjeù”_tid2
 = 0;

9618 
	gcİy_İs
.
”a£
(
cİ
->
obc
->
obs
.
oi
.
soid
);

9619 
	gcİ
->
	gobc
->
¡İ_block
();

9621 
kick_objeù_cÚ‹xt_blocked
(
cİ
->
obc
);

9622 
	gcİ
->
	g»suÉs
.
	gshould_»queue
 = 
»queue
;

9623 
CİyC®lbackResuÉs
 
»suÉ
(-
ECANCELED
, &
cİ
->
»suÉs
);

9624 
	gcİ
->
	gcb
->
com¶‘e
(
»suÉ
);

9629 
	gcİ
->
	gobc
 = 
ObjeùCÚ‹xtRef
();

9632 
	gPrim¬yLogPG
::
ÿnûl_cİy_İs
(
boŞ
 
»queue
, 
veùÜ
<
ûph_tid_t
> *
tids
)

9634 
dout
(10è<< 
	g__func__
 << 
	gd’dl
;

9635 
	gm­
<
	ghobjeù_t
,
	gCİyOpRef
>::
™”©Ü
 
p
 = 
cİy_İs
.
begš
();

9636 
	gp
 !ğ
cİy_İs
.
’d
()) {

9638 
ÿnûl_cİy
((
p
++)->
£cÚd
, 
»queue
, 
tids
);

9672 
	gC_Flush
 : 
public
 
CÚ‹xt
 {

9673 
Prim¬yLogPGRef
 
pg
;

9674 
hobjeù_t
 
	goid
;

9675 
•och_t
 
	gÏ¡_³”šg_»£t
;

9676 
ûph_tid_t
 
	gtid
;

9677 
utime_t
 
	g¡¬t
;

9678 
C_Flush
(
Prim¬yLogPG
 *
p
, 
hobjeù_t
 
o
, 
•och_t
 
Ír
)

9679 : 
pg
(
p
), 
oid
(
o
), 
Ï¡_³”šg_»£t
(
Ír
),

9680 
tid
(0), 
¡¬t
(
ûph_şock_now
())

9682 
fšish
(
r
è
	gov”ride
 {

9683 ià(
	gr
 =ğ-
ECANCELED
)

9685 
	gpg
->
lock
();

9686 ià(
	gÏ¡_³”šg_»£t
 =ğ
pg
->
g‘_Ï¡_³”šg_»£t
()) {

9687 
pg
->
fšish_æush
(
oid
, 
tid
, 
r
);

9688 
	gpg
->
	gosd
->
	glogg”
->
tšc
(
l_osd_t›r_æush_Ït
, 
ûph_şock_now
(è- 
¡¬t
);

9690 
	gpg
->
uÆock
();

9694 
	gPrim¬yLogPG
::
¡¬t_æush
(

9695 
OpReque¡Ref
 
İ
, 
ObjeùCÚ‹xtRef
 
obc
,

9696 
boŞ
 
blockšg
, 
hobjeù_t
 *
pmissšg
,

9697 
boo¡
::
İtiÚ®
<
¡d
::
funùiÚ
<()>> &&
Ú_æush
)

9699 cÚ¡ 
objeù_šfo_t
& 
oi
 = 
obc
->
obs
.oi;

9700 cÚ¡ 
	ghobjeù_t
& 
	gsoid
 = 
oi
.
soid
;

9701 
dout
(10è<< 
	g__func__
 << " " << 
	gsoid


9702 << " v" << 
	goi
.
	gv”siÚ


9703 << " uv" << 
	goi
.
	gu£r_v”siÚ


9704 << " " << (
	gblockšg
 ? "blocking" : "non-blocking/best-effort")

9705 << 
d’dl
;

9708 
SÇpS‘
 
	g¢­£t
 = 
obc
->
ssc
->
¢­£t
.
g‘_f‹»d
(
poŞ
.
šfo
);

9712 
dout
(20è<< " sÇp£ˆ" << 
	g¢­£t
 << 
	gd’dl
;

9713 
	gveùÜ
<
	g¢­id_t
>::
»v”£_™”©Ü
 
p
 = 
¢­£t
.
şÚes
.
rbegš
();

9714 
	gp
 !ğ
¢­£t
.
şÚes
.
»nd
(è&& *
p
 >ğ
soid
.
¢­
)

9715 ++
p
;

9716 ià(
	gp
 !ğ
¢­£t
.
şÚes
.
»nd
()) {

9717 
hobjeù_t
 
Ãxt
 = 
soid
;

9718 
	gÃxt
.
	g¢­
 = *
p
;

9719 
as£¹
(
Ãxt
.
¢­
 < 
soid
.snap);

9720 ià(
	gpg_log
.
g‘_missšg
().
is_missšg
(
Ãxt
)) {

9721 
dout
(10è<< 
	g__func__
 << " missšg clÚi " << 
	gÃxt
 << 
	gd’dl
;

9722 ià(
	gpmissšg
)

9723 *
	gpmissšg
 = 
Ãxt
;

9724  -
	gENOENT
;

9726 
ObjeùCÚ‹xtRef
 
	gŞd”_obc
 = 
g‘_objeù_cÚ‹xt
(
Ãxt
, 
çl£
);

9727 ià(
	gŞd”_obc
) {

9728 
dout
(20è<< 
	g__func__
 << "‚exˆŞde¡ clÚi " << 
	gŞd”_obc
->
	gobs
.
	goi


9729 << 
	gd’dl
;

9730 ià(
	gŞd”_obc
->
	gobs
.
	goi
.
is_dœty
()) {

9731 
dout
(10è<< 
	g__func__
 << "‚ext oldest clone is dirty: "

9732 << 
	gŞd”_obc
->
	gobs
.
	goi
 << 
	gd’dl
;

9733  -
	gEBUSY
;

9736 
dout
(20è<< 
	g__func__
 << "‚exˆŞde¡ clÚ" << 
	gÃxt


9737 << " i nÙ…»£Á; im¶ic™ly cËª" << 
	gd’dl
;

9740 
dout
(20è<< 
	g__func__
 << "‚ØŞd” clÚes" << 
	gd’dl
;

9744 ià(
	gblockšg
)

9745 
	gobc
->
¡¬t_block
();

9747 
	gm­
<
	ghobjeù_t
,
	gFlushOpRef
>::
™”©Ü
 
p
 = 
æush_İs
.
fšd
(
soid
);

9748 ià(
	gp
 !ğ
æush_İs
.
’d
()) {

9749 
FlushOpRef
 
fİ
 = 
p
->
£cÚd
;

9750 ià(
	gfİ
->
	gİ
 =ğ
İ
) {

9753  
Œy_æush_m¬k_ş—n
(
fİ
);

9755 ià(
	gfİ
->
	gæushed_v”siÚ
 =ğ
obc
->
obs
.
oi
.
u£r_v”siÚ
 &&

9756 (
fİ
->
blockšg
 || !blocking)) {

9759 
dout
(20è<< 
__func__
 << "…iggybackšg oÀexi¡šg flush " << 
d’dl
;

9760 ià(
	gİ
)

9761 
	gfİ
->
	gdup_İs
.
push_back
(
İ
);

9762  -
	gEAGAIN
;

9767 
dout
(20è<< 
	g__func__
 << " cªûlšg…»viou æush; iˆwÈç" << 
	gd’dl
;

9768 ià(
	gfİ
->
	gİ
)

9769 
	gosd
->
»¶y_İ_”rÜ
(
fİ
->
İ
, -
EBUSY
);

9770 !
	gfİ
->
	gdup_İs
.
em±y
()) {

9771 
	gosd
->
»¶y_İ_”rÜ
(
fİ
->
dup_İs
.
äÚt
(), -
EBUSY
);

9772 
	gfİ
->
	gdup_İs
.
pİ_äÚt
();

9774 
	gveùÜ
<
	gûph_tid_t
> 
	gtids
;

9775 
ÿnûl_æush
(
fİ
, 
çl£
, &
tids
);

9776 
	gosd
->
	gobjeù”
->
İ_ÿnûl
(
tids
, -
ECANCELED
);

9779 ià(
	gobc
->
	gobs
.
	goi
.
has_mªiã¡
(è&& obc->obs.oi.
	gmªiã¡
.
is_chunked
()) {

9780 
	gr
 = 
¡¬t_mªiã¡_æush
(
İ
, 
obc
, 
blockšg
, 
¡d
::
move
(
Ú_æush
));

9781 ià(
	gr
 !ğ-
EINPROGRESS
) {

9782 ià(
blockšg
)

9783 
obc
->
¡İ_block
();

9785  
	gr
;

9808 
SÇpCÚ‹xt
 
	g¢­c
, 
	gd¢­c
;

9809 ià(
	g¢­£t
.
	g£q
 != 0) {

9810 ià(
soid
.
¢­
 =ğ
CEPH_NOSNAP
) {

9811 
¢­c
.
£q
 = 
¢­£t
.seq;

9812 
	g¢­c
.
	g¢­s
 = 
¢­£t
.
¢­s
;

9814 
¢­id_t
 
	gmš_šşuded_¢­
;

9815 autØ
	gp
 = 
¢­£t
.
şÚe_¢­s
.
fšd
(
soid
.
¢­
);

9816 
as£¹
(
p
 !ğ
¢­£t
.
şÚe_¢­s
.
’d
());

9817 
	gmš_šşuded_¢­
 = 
p
->
£cÚd
.
back
();

9818 
	g¢­c
 = 
¢­£t
.
g‘_ssc_as_of
(
mš_šşuded_¢­
 - 1);

9821 
¢­id_t
 
	g´ev_¢­c
 = 0;

9822 
	gveùÜ
<
	g¢­id_t
>::
»v”£_™”©Ü
 
c™”
 = 
¢­£t
.
şÚes
.
rbegš
();

9823 
	gc™”
 !ğ
¢­£t
.
şÚes
.
»nd
();

9824 ++
	gc™”
) {

9825 ià(*
	gc™”
 < 
	gsoid
.
	g¢­
) {

9826 
	g´ev_¢­c
 = *
c™”
;

9831 
	gd¢­c
 = 
¢­£t
.
g‘_ssc_as_of
(
´ev_¢­c
);

9834 
objeù_loÿtÜ_t
 
ba£_Şoc
(
soid
);

9835 
	gba£_Şoc
.
	gpoŞ
 = 
poŞ
.
šfo
.
t›r_of
;

9837 ià(
	gd¢­c
.
	g£q
 < 
	g¢­c
.seq) {

9838 
ObjeùO³¿tiÚ
 
	go
;

9839 
	go
.
»move
();

9840 
	gosd
->
	gobjeù”
->
mu‹
(

9841 
soid
.
oid
,

9842 
ba£_Şoc
,

9843 
o
,

9844 
d¢­c
,

9845 
ûph
::
»®_şock
::
äom_ûph_time¥ec
(
oi
.
mtime
),

9846 (
CEPH_OSD_FLAG_IGNORE_OVERLAY
 |

9847 
CEPH_OSD_FLAG_ENFORCE_SNAPC
),

9848 
NULL
 );

9851 
FlushOpRef
 
fİ
(
¡d
::
make_sh¬ed
<
FlushOp
>());

9852 
	gfİ
->
	gobc
 = 
obc
;

9853 
	gfİ
->
	gæushed_v”siÚ
 = 
oi
.
u£r_v”siÚ
;

9854 
	gfİ
->
	gblockšg
 = 
blockšg
;

9855 
	gfİ
->
	gÚ_æush
 = 
¡d
::
move
(
Ú_æush
);

9856 
	gfİ
->
	gİ
 = 
İ
;

9858 
ObjeùO³¿tiÚ
 
	go
;

9859 ià(
	goi
.
is_wh™eout
()) {

9860 
	gfİ
->
	g»mov®
 = 
Œue
;

9861 
	go
.
»move
();

9863 
objeù_loÿtÜ_t
 
Şoc
(
soid
);

9864 
	go
.
cİy_äom
(
soid
.
oid
.
Çme
, soid.
¢­
, 
Şoc
, 
oi
.
u£r_v”siÚ
,

9865 
CEPH_OSD_COPY_FROM_FLAG_FLUSH
 |

9866 
CEPH_OSD_COPY_FROM_FLAG_IGNORE_OVERLAY
 |

9867 
CEPH_OSD_COPY_FROM_FLAG_IGNORE_CACHE
 |

9868 
CEPH_OSD_COPY_FROM_FLAG_MAP_SNAP_CLONE
,

9869 
LIBRADOS_OP_FLAG_FADVISE_SEQUENTIAL
|
LIBRADOS_OP_FLAG_FADVISE_NOCACHE
);

9872 ià(
	gag’t_¡©e
 &&‡g’t_¡©e->
	geviù_mode
 !ğ
T›rAg’tS‹
::
EVICT_MODE_FULL
)

9873 
o
.
£t_Ï¡_İ_æags
(
LIBRADOS_OP_FLAG_FADVISE_DONTNEED
);

9875 
C_Flush
 *
	gfš
 = 
Ãw
 C_Flush(
this
, 
soid
, 
g‘_Ï¡_³”šg_»£t
());

9877 
	gn
 = 
šfo
.
pgid
.
hash_to_sh¬d
(
osd
->
m_objeù”_fšish”s
);

9878 
ûph_tid_t
 
	gtid
 = 
osd
->
objeù”
->
mu‹
(

9879 
soid
.
oid
, 
ba£_Şoc
, 
o
, 
¢­c
,

9880 
ûph
::
»®_şock
::
äom_ûph_time¥ec
(
oi
.
mtime
),

9881 
CEPH_OSD_FLAG_IGNORE_OVERLAY
 | 
CEPH_OSD_FLAG_ENFORCE_SNAPC
,

9882 
Ãw
 
C_OnFšish”
(
fš
,

9883 
osd
->
objeù”_fšish”s
[
n
]));

9885 
	gfš
->
	gtid
 = 
tid
;

9886 
	gfİ
->
	gobjeù”_tid
 = 
tid
;

9888 
	gæush_İs
[
soid
] = 
fİ
;

9889 
	gšfo
.
	g¡©s
.¡©s.
	gsum
.
	gnum_æush
++;

9890 
	gšfo
.
	g¡©s
.¡©s.
	gsum
.
	gnum_æush_kb
 +ğ
shiá_round_up
(
oi
.
size
, 10);

9891  -
	gEINPROGRESS
;

9894 
	gPrim¬yLogPG
::
	$fšish_æush
(
hobjeù_t
 
oid
, 
ûph_tid_t
 
tid
, 
r
)

9896 
	`dout
(10è<< 
__func__
 << " " << 
oid
 << "id " << 
tid


9897 << " " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

9898 
m­
<
hobjeù_t
,
FlushOpRef
>::
™”©Ü
 
p
 = 
æush_İs
.
	`fšd
(
oid
);

9899 ià(
p
 =ğ
æush_İs
.
	`’d
()) {

9900 
	`dout
(10è<< 
__func__
 << "‚Øæush_İ found" << 
d’dl
;

9903 
FlushOpRef
 
fİ
 = 
p
->
£cÚd
;

9904 ià(
tid
 !ğ
fİ
->
objeù”_tid
 && !fİ->
obc
->
obs
.
oi
.
	`has_mªiã¡
()) {

9905 
	`dout
(10è<< 
__func__
 << "id " << 
tid
 << " !ğfİ " << 
fİ


9906 << "id " << 
fİ
->
objeù”_tid
 << 
d’dl
;

9909 
ObjeùCÚ‹xtRef
 
obc
 = 
fİ
->obc;

9910 
fİ
->
objeù”_tid
 = 0;

9912 ià(
r
 < 0 && !Ô =ğ-
ENOENT
 && 
fİ
->
»mov®
)) {

9913 ià(
fİ
->
İ
)

9914 
osd
->
	`»¶y_İ_”rÜ
(
fİ
->
İ
, -
EBUSY
);

9915 ià(
fİ
->
blockšg
) {

9916 
obc
->
	`¡İ_block
();

9917 
	`kick_objeù_cÚ‹xt_blocked
(
obc
);

9920 ià(!
fİ
->
dup_İs
.
	`em±y
()) {

9921 
	`dout
(20è<< 
__func__
 << "„equeuešg dups" << 
d’dl
;

9922 
	`»queue_İs
(
fİ
->
dup_İs
);

9924 ià(
fİ
->
Ú_æush
) {

9925 (*(
fİ
->
Ú_æush
))();

9926 
fİ
->
Ú_æush
 = 
boo¡
::
nÚe
;

9928 
æush_İs
.
	`”a£
(
oid
);

9932 
r
 = 
	`Œy_æush_m¬k_ş—n
(
fİ
);

9933 ià(
r
 =ğ-
EBUSY
 && 
fİ
->
İ
) {

9934 
osd
->
	`»¶y_İ_”rÜ
(
fİ
->
İ
, 
r
);

9936 
	}
}

9938 
	gPrim¬yLogPG
::
	$Œy_æush_m¬k_ş—n
(
FlushOpRef
 
fİ
)

9940 
ObjeùCÚ‹xtRef
 
obc
 = 
fİ
->obc;

9941 cÚ¡ 
hobjeù_t
& 
oid
 = 
obc
->
obs
.
oi
.
soid
;

9943 ià(
fİ
->
blockšg
) {

9944 
obc
->
	`¡İ_block
();

9945 
	`kick_objeù_cÚ‹xt_blocked
(
obc
);

9948 ià(
fİ
->
æushed_v”siÚ
 !ğ
obc
->
obs
.
oi
.
u£r_v”siÚ
 ||

9949 !
obc
->
obs
.
exi¡s
) {

9950 ià(
obc
->
obs
.
exi¡s
)

9951 
	`dout
(10è<< 
__func__
 << " flushed_v”siÚ " << 
fİ
->
æushed_v”siÚ


9952 << " !ğcu¼’ˆ" << 
obc
->
obs
.
oi
.
u£r_v”siÚ


9953 << 
d’dl
;

9955 
	`dout
(10è<< 
__func__
 << " objeù‚ØlÚg”ƒxi¡s" << 
d’dl
;

9957 ià(!
fİ
->
dup_İs
.
	`em±y
()) {

9958 
	`dout
(20è<< 
__func__
 << "„equeuešg dups" << 
d’dl
;

9959 
	`»queue_İs
(
fİ
->
dup_İs
);

9961 ià(
fİ
->
Ú_æush
) {

9962 (*(
fİ
->
Ú_æush
))();

9963 
fİ
->
Ú_æush
 = 
boo¡
::
nÚe
;

9965 
æush_İs
.
	`”a£
(
oid
);

9966 ià(
fİ
->
blockšg
)

9967 
osd
->
logg”
->
	`šc
(
l_osd_t›r_æush_ç
);

9969 
osd
->
logg”
->
	`šc
(
l_osd_t›r_Œy_æush_ç
);

9970  -
EBUSY
;

9973 ià(!
fİ
->
blockšg
 &&

9974 
	`wr™e_blocked_by_süub
(
oid
)) {

9975 ià(
fİ
->
İ
) {

9976 
	`dout
(10è<< 
__func__
 << " blocked by süub" << 
d’dl
;

9977 
	`»queue_İ
(
fİ
->
İ
);

9978 
	`»queue_İs
(
fİ
->
dup_İs
);

9979  -
EAGAIN
;

9981 
osd
->
logg”
->
	`šc
(
l_osd_t›r_Œy_æush_ç
);

9982 
veùÜ
<
ûph_tid_t
> 
tids
;

9983 
	`ÿnûl_æush
(
fİ
, 
çl£
, &
tids
);

9984 
osd
->
objeù”
->
	`İ_ÿnûl
(
tids
, -
ECANCELED
);

9985  -
ECANCELED
;

9990 ià(!
obc
->
obs
.
oi
.
	`has_mªiã¡
(è&& !
fİ
->
İ
 && 
ag’t_¡©e
->
eviù_mode
 !ğ
T›rAg’tS‹
::
EVICT_MODE_IDLE
 &&

9991 
	`ag’t_maybe_eviù
(
obc
, 
Œue
)) {

9992 
osd
->
logg”
->
	`šc
(
l_osd_t›r_ş—n
);

9993 ià(
fİ
->
Ú_æush
) {

9994 (*(
fİ
->
Ú_æush
))();

9995 
fİ
->
Ú_æush
 = 
boo¡
::
nÚe
;

9997 
æush_İs
.
	`”a£
(
oid
);

10001 
	`dout
(10è<< 
__func__
 << " cË¬šg DIRTY fÏg fÜ " << 
oid
 << 
d’dl
;

10002 
OpCÚ‹xtUPŒ
 
ùx
 = 
	`sim¶e_İc_ü—‹
(
fİ
->
obc
);

10007 ià(
ùx
->
lock_mªag”
.
	`g‘_lock_ty³
(

10008 
ObjeùCÚ‹xt
::
RWS‹
::
RWWRITE
,

10009 
oid
,

10010 
obc
,

10011 
fİ
->
İ
)) {

10012 
	`dout
(20è<< 
__func__
 << "ook wr™lock" << 
d’dl
;

10013 } ià(
fİ
->
İ
) {

10014 
	`dout
(10è<< 
__func__
 << " wa™šg oÀwr™lock " << 
fİ
->
İ
 << " "

10015 << 
fİ
->
dup_İs
 << 
d’dl
;

10016 
	`şo£_İ_ùx
(
ùx
.
	`»Ëa£
());

10018 autØ
İ
 : 
fİ
->
dup_İs
) {

10019 
boŞ
 
locked
 = 
ùx
->
lock_mªag”
.
	`g‘_lock_ty³
(

10020 
ObjeùCÚ‹xt
::
RWS‹
::
RWWRITE
,

10021 
oid
,

10022 
obc
,

10023 
İ
);

10024 
	`as£¹
(!
locked
);

10026  -
EAGAIN
;

10028 
	`dout
(10è<< 
__func__
 << " faed wr™lock,‚Øİ; fašg" << 
d’dl
;

10029 
	`şo£_İ_ùx
(
ùx
.
	`»Ëa£
());

10030 
osd
->
logg”
->
	`šc
(
l_osd_t›r_Œy_æush_ç
);

10031 
veùÜ
<
ûph_tid_t
> 
tids
;

10032 
	`ÿnûl_æush
(
fİ
, 
çl£
, &
tids
);

10033 
osd
->
objeù”
->
	`İ_ÿnûl
(
tids
, -
ECANCELED
);

10034  -
ECANCELED
;

10037 ià(
fİ
->
Ú_æush
) {

10038 
ùx
->
	`»gi¡”_Ú_fšish
(*(
fİ
->
Ú_æush
));

10039 
fİ
->
Ú_æush
 = 
boo¡
::
nÚe
;

10042 
ùx
->
©_v”siÚ
 = 
	`g‘_Ãxt_v”siÚ
();

10044 
ùx
->
Ãw_obs
 = 
obc
->
obs
;

10045 
ùx
->
Ãw_obs
.
oi
.
	`ş—r_æag
(
objeù_šfo_t
::
FLAG_DIRTY
);

10046 --
ùx
->
d–_¡©s
.
num_objeùs_dœty
;

10047 ià(
fİ
->
obc
->
obs
.
oi
.
	`has_mªiã¡
()) {

10048 
	`as£¹
(
obc
->
obs
.
oi
.
mªiã¡
.
	`is_chunked
());

10049 
PGT¿n§ùiÚ
* 
t
 = 
ùx
->
İ_t
.
	`g‘
();

10050 
ušt64_t
 
chunks_size
 = 0;

10051 autØ&
p
 : 
ùx
->
Ãw_obs
.
oi
.
mªiã¡
.
chunk_m­
) {

10052 
chunks_size
 +ğ
p
.
£cÚd
.
Ëngth
;

10054 ià(
ùx
->
Ãw_obs
.
oi
.
	`is_om­
(è&& 
poŞ
.
šfo
.
	`suµÜts_om­
()) {

10055 
t
->
	`om­_ş—r
(
oid
);

10056 
ùx
->
Ãw_obs
.
oi
.
	`ş—r_om­_dige¡
();

10057 
ùx
->
Ãw_obs
.
oi
.
	`ş—r_æag
(
objeù_šfo_t
::
FLAG_OMAP
);

10059 ià(
obc
->
obs
.
oi
.
size
 =ğ
chunks_size
) {

10060 
t
->
	`Œunÿ‹
(
oid
, 0);

10061 
š‹rv®_£t
<
ušt64_t
> 
Œim
;

10062 
Œim
.
	`š£¹
(0, 
ùx
->
Ãw_obs
.
oi
.
size
);

10063 
ùx
->
modif›d_¿nges
.
	`uniÚ_of
(
Œim
);

10064 
	`Œunÿ‹_upd©e_size_ªd_u§ge
(
ùx
->
d–_¡©s
,

10065 
ùx
->
Ãw_obs
.
oi
,

10067 
ùx
->
Ãw_obs
.
oi
.
	`Ãw_objeù
();

10068 autØ&
p
 : 
ùx
->
Ãw_obs
.
oi
.
mªiã¡
.
chunk_m­
) {

10069 
p
.
£cÚd
.
æags
 = 
chunk_šfo_t
::
FLAG_MISSING
;

10072 autØ&
p
 : 
ùx
->
Ãw_obs
.
oi
.
mªiã¡
.
chunk_m­
) {

10073 ià(
p
.
£cÚd
.
æags
 =ğ
chunk_šfo_t
::
FLAG_DIRTY
) {

10074 
	`dout
(20è<< 
__func__
 << " off£t: " << 
p
.
£cÚd
.
off£t


10075 << "†’gth: " << 
p
.
£cÚd
.
Ëngth
 << 
d’dl
;

10076 
p
.
£cÚd
.
æags
 = 0;

10082 
	`fšish_ùx
(
ùx
.
	`g‘
(), 
pg_log_’Œy_t
::
CLEAN
);

10084 
osd
->
logg”
->
	`šc
(
l_osd_t›r_ş—n
);

10086 ià(!
fİ
->
dup_İs
.
	`em±y
(è|| fİ->
İ
) {

10087 
	`dout
(20è<< 
__func__
 << "„equeuešg fÜ " << 
ùx
->
©_v”siÚ
 << 
d’dl
;

10088 
li¡
<
OpReque¡Ref
> 
ls
;

10089 ià(
fİ
->
İ
)

10090 
ls
.
	`push_back
(
fİ
->
İ
);

10091 
ls
.
	`¥liû
Ös.
	`’d
(), 
fİ
->
dup_İs
);

10092 
	`»queue_İs
(
ls
);

10095 
	`sim¶e_İc_subm™
(
¡d
::
	`move
(
ùx
));

10097 
æush_İs
.
	`”a£
(
oid
);

10099 ià(
fİ
->
blockšg
)

10100 
osd
->
logg”
->
	`šc
(
l_osd_t›r_æush
);

10102 
osd
->
logg”
->
	`šc
(
l_osd_t›r_Œy_æush
);

10104  -
EINPROGRESS
;

10105 
	}
}

10107 
	gPrim¬yLogPG
::
ÿnûl_æush
(
FlushOpRef
 
fİ
, 
boŞ
 
»queue
,

10108 
veùÜ
<
ûph_tid_t
> *
tids
)

10110 
dout
(10è<< 
	g__func__
 << " " << 
	gfİ
->
	gobc
->
	gobs
.
	goi
.
	gsoid
 << "id "

10111 << 
	gfİ
->
	gobjeù”_tid
 << 
	gd’dl
;

10112 ià(
	gfİ
->
	gobjeù”_tid
) {

10113 
	gtids
->
push_back
(
fİ
->
objeù”_tid
);

10114 
	gfİ
->
	gobjeù”_tid
 = 0;

10116 ià(
	gfİ
->
	gio_tids
.
size
()) {

10117 autØ&
	gp
 : 
fİ
->
io_tids
) {

10118 
tids
->
push_back
(
p
.
£cÚd
);

10119 
	gp
.
	g£cÚd
 = 0;

10122 ià(
	gfİ
->
	gblockšg
 && fİ->
	gobc
->
is_blocked
()) {

10123 
	gfİ
->
	gobc
->
¡İ_block
();

10124 
kick_objeù_cÚ‹xt_blocked
(
fİ
->
obc
);

10126 ià(
	g»queue
) {

10127 ià(
	gfİ
->
	gİ
)

10128 
»queue_İ
(
fİ
->
İ
);

10129 
»queue_İs
(
fİ
->
dup_İs
);

10131 ià(
	gfİ
->
	gÚ_æush
) {

10132 (*(
	gfİ
->
	gÚ_æush
))();

10133 
	gfİ
->
	gÚ_æush
 = 
boo¡
::
nÚe
;

10135 
	gæush_İs
.
”a£
(
fİ
->
obc
->
obs
.
oi
.
soid
);

10138 
	gPrim¬yLogPG
::
ÿnûl_æush_İs
(
boŞ
 
»queue
, 
veùÜ
<
ûph_tid_t
> *
tids
)

10140 
dout
(10è<< 
	g__func__
 << 
	gd’dl
;

10141 
	gm­
<
	ghobjeù_t
,
	gFlushOpRef
>::
™”©Ü
 
p
 = 
æush_İs
.
begš
();

10142 
	gp
 !ğ
æush_İs
.
’d
()) {

10143 
ÿnûl_æush
((
p
++)->
£cÚd
, 
»queue
, 
tids
);

10147 
boŞ
 
	gPrim¬yLogPG
::
	$is_´e£Á_şÚe
(
hobjeù_t
 
coid
)

10149 ià(!
poŞ
.
šfo
.
	`®low_šcom¶‘e_şÚes
())

10150  
Œue
;

10151 ià(
	`is_missšg_objeù
(
coid
))

10152  
Œue
;

10153 
ObjeùCÚ‹xtRef
 
obc
 = 
	`g‘_objeù_cÚ‹xt
(
coid
, 
çl£
);

10154  
obc
 && obc->
obs
.
exi¡s
;

10155 
	}
}

10160 şas 
	cC_OSD_R•İComm™
 : 
public
 
CÚ‹xt
 {

10161 
Prim¬yLogPGRef
 
pg
;

10162 
	mboo¡
::
šŒusive_±r
<
Prim¬yLogPG
::
R•G©h”
> 
»pİ
;

10163 
	mpublic
:

10164 
	$C_OSD_R•İComm™
(
Prim¬yLogPG
 *
pg
, Prim¬yLogPG::
R•G©h”
 *
»pİ
)

10165 : 
	`pg
(
pg
), 
	$»pİ
(
»pİ
) {}

10166 
	$fšish
(è
ov”ride
 {

10167 
pg
->
	`»pİ_®l_comm™‹d
(
»pİ
.
	`g‘
());

10168 
	}
}

10171 
	gPrim¬yLogPG
::
	$»pİ_®l_comm™‹d
(
R•G©h”
 *
»pİ
)

10173 
	`dout
(10è<< 
__func__
 << ":„•İid " << 
»pİ
->
»p_tid
 << "‡ll committed "

10174 << 
d’dl
;

10175 
»pİ
->
®l_comm™‹d
 = 
Œue
;

10176 ià(!
»pİ
->
»p_abÜ‹d
) {

10177 ià(
»pİ
->
v
 !ğ
	`ev”siÚ_t
()) {

10178 
Ï¡_upd©e_Údisk
 = 
»pİ
->
v
;

10179 
Ï¡_com¶‘e_Údisk
 = 
»pİ
->
pg_loÿl_Ï¡_com¶‘e
;

10181 
	`ev®_»pİ
(
»pİ
);

10183 
	}
}

10185 
	gPrim¬yLogPG
::
	$İ_­¶›d
(cÚ¡ 
ev”siÚ_t
 &
­¶›d_v”siÚ
)

10187 
	`dout
(10è<< "İ_­¶›d v”siÚ " << 
­¶›d_v”siÚ
 << 
d’dl
;

10188 
	`as£¹
(
­¶›d_v”siÚ
 !ğ
	`ev”siÚ_t
());

10189 
	`as£¹
(
­¶›d_v”siÚ
 <ğ
šfo
.
Ï¡_upd©e
);

10190 
Ï¡_upd©e_­¶›d
 = 
­¶›d_v”siÚ
;

10191 ià(
	`is_´im¬y
()) {

10192 ià(
süubb”
.
aùive
) {

10193 ià(
Ï¡_upd©e_­¶›d
 >ğ
süubb”
.
sub£t_Ï¡_upd©e
) {

10194 
	`»queue_süub
(
	`İs_blocked_by_süub
());

10197 
	`as£¹
(
süubb”
.
¡¬t
 =ğsüubb”.
’d
);

10200 
	}
}

10202 
	gPrim¬yLogPG
::
	$ev®_»pİ
(
R•G©h”
 *
»pİ
)

10204 cÚ¡ 
MOSDOp
 *
m
 = 
NULL
;

10205 ià(
»pİ
->
İ
)

10206 
m
 = 
¡©ic_ÿ¡
<cÚ¡ 
MOSDOp
 *>(
»pİ
->
İ
->
	`g‘_»q
());

10208 ià(
m
)

10209 
	`dout
(10è<< "ev®_»pİ " << *
»pİ
 << 
d’dl
;

10211 
	`dout
(10è<< "ev®_»pİ " << *
»pİ
 << " (nØİ)" << 
d’dl
;

10214 ià(
»pİ
->
®l_comm™‹d
) {

10215 
	`dout
(10è<< " comm™: " << *
»pİ
 << 
d’dl
;

10216 autØ
p
 = 
»pİ
->
Ú_comm™‹d
.
	`begš
();

10217 
p
 !ğ
»pİ
->
Ú_comm™‹d
.
	`’d
();

10218 
»pİ
->
Ú_comm™‹d
.
	`”a£
(
p
++)) {

10219 (*
p
)();

10222 autØ
™
 = 
wa™šg_fÜ_Údisk
.
	`fšd
(
»pİ
->
v
);

10223 ià(
™
 !ğ
wa™šg_fÜ_Údisk
.
	`’d
()) {

10224 
	`as£¹
(
wa™šg_fÜ_Údisk
.
	`begš
()->
fœ¡
 =ğ
»pİ
->
v
);

10225 
li¡
<
·œ
<
OpReque¡Ref
, 
v”siÚ_t
> >::
™”©Ü
 
i
 =

10226 
™
->
£cÚd
.
	`begš
();

10227 
i
 !ğ
™
->
£cÚd
.
	`’d
();

10228 ++
i
) {

10229 
osd
->
	`»¶y_İ_”rÜ
(
i
->
fœ¡
, 
»pİ
->
r
,„•İ->
v
,

10230 
i
->
£cÚd
);

10232 
wa™šg_fÜ_Údisk
.
	`”a£
(
™
);

10235 
	`publish_¡©s_to_osd
();

10236 
	`ÿlc_mš_Ï¡_com¶‘e_Údisk
();

10238 
	`dout
(10è<< "„emovšg " << *
»pİ
 << 
d’dl
;

10239 
	`as£¹
(!
»pİ_queue
.
	`em±y
());

10240 
	`dout
(20è<< " q frÚˆi " << *
»pİ_queue
.
	`äÚt
(è<< 
d’dl
;

10241 ià(
»pİ_queue
.
	`äÚt
(è=ğ
»pİ
) {

10242 
R•G©h”
 *
to_»move
 = 
nuÎ±r
;

10243 !
»pİ_queue
.
	`em±y
() &&

10244 (
to_»move
 = 
»pİ_queue
.
	`äÚt
())->
®l_comm™‹d
) {

10245 
»pİ_queue
.
	`pİ_äÚt
();

10246 autØ
p
 = 
to_»move
->
Ú_sucûss
.
	`begš
();

10247 
p
 !ğ
to_»move
->
Ú_sucûss
.
	`’d
();

10248 
to_»move
->
Ú_sucûss
.
	`”a£
(
p
++)) {

10249 (*
p
)();

10251 
	`»move_»pİ
(
to_»move
);

10255 
	}
}

10257 
	gPrim¬yLogPG
::
	$issue_»pİ
(
R•G©h”
 *
»pİ
, 
OpCÚ‹xt
 *
ùx
)

10259 
	`FUNCTRACE
(
cù
);

10260 cÚ¡ 
hobjeù_t
& 
soid
 = 
ùx
->
obs
->
oi
.soid;

10261 
	`dout
(7è<< "issue_»pİ„•_tid " << 
»pİ
->
»p_tid


10262 << " o " << 
soid


10263 << 
d’dl
;

10265 
»pİ
->
v
 = 
ùx
->
©_v”siÚ
;

10266 ià(
ùx
->
©_v”siÚ
 > 
	`ev”siÚ_t
()) {

10267 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
aùšg_»cov”y_backfl
.
	`begš
();

10268 
i
 !ğ
aùšg_»cov”y_backfl
.
	`’d
();

10269 ++
i
) {

10270 ià(*
i
 =ğ
	`g‘_´im¬y
()) ;

10271 
pg_šfo_t
 &
pšfo
 = 
³”_šfo
[*
i
];

10273 ià(
pšfo
.
Ï¡_com¶‘e
 =ğpšfo.
Ï¡_upd©e
)

10274 
pšfo
.
Ï¡_com¶‘e
 = 
ùx
->
©_v”siÚ
;

10275 
pšfo
.
Ï¡_upd©e
 = 
ùx
->
©_v”siÚ
;

10279 
ùx
->
İ_t
->
	`add_obc
(ùx->
obc
);

10280 ià(
ùx
->
şÚe_obc
) {

10281 
ùx
->
İ_t
->
	`add_obc
(ùx->
şÚe_obc
);

10283 ià(
ùx
->
h—d_obc
) {

10284 
ùx
->
İ_t
->
	`add_obc
(ùx->
h—d_obc
);

10287 
CÚ‹xt
 *
Ú_®l_comm™
 = 
Ãw
 
	`C_OSD_R•İComm™
(
this
, 
»pİ
);

10288 ià(!(
ùx
->
log
.
	`em±y
())) {

10289 
	`as£¹
(
ùx
->
©_v”siÚ
 >ğ
´ojeùed_Ï¡_upd©e
);

10290 
´ojeùed_Ï¡_upd©e
 = 
ùx
->
©_v”siÚ
;

10292 autØ&&
’Œy
: 
ùx
->
log
) {

10293 
´ojeùed_log
.
	`add
(
’Œy
);

10296 
boŞ
 
»quœes_missšg_loc
 = 
çl£
;

10297 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
async_»cov”y_rg‘s
.
	`begš
();

10298 
i
 !ğ
async_»cov”y_rg‘s
.
	`’d
();

10299 ++
i
) {

10300 ià(*
i
 =ğ
	`g‘_´im¬y
(è|| !
³”_missšg
[*i].
	`is_missšg
(
soid
)) ;

10301 
»quœes_missšg_loc
 = 
Œue
;

10302 autØ&&
’Œy
: 
ùx
->
log
) {

10303 
³”_missšg
[*
i
].
	`add_Ãxt_ev’t
(
’Œy
);

10307 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
i
 = 
aùšg_»cov”y_backfl
.
	`begš
();

10308 
i
 !ğ
aùšg_»cov”y_backfl
.
	`’d
();

10309 ++
i
) {

10310 
pg_sh¬d_t
 
	`³”
(*
i
);

10311 ià(
³”
 =ğ
pg_whßmi
) ;

10312 ià(
async_»cov”y_rg‘s
.
	`couÁ
(
³”
è&& 
³”_missšg
[³”].
	`is_missšg
(
soid
)) {

10313 autØ&&
’Œy
: 
ùx
->
log
) {

10314 
missšg_loc
.
	`add_missšg
(
soid
, 
ùx
->
©_v”siÚ
, 
	`ev”siÚ_t
(), 
’Œy
.
	`is_d–‘e
());

10319 
	`dout
(30è<< 
__func__
 << " missšg_loøbefÜe: " << 
missšg_loc
.
	`g‘_loÿtiÚs
(
soid
è<< 
d’dl
;

10321 ià(
»quœes_missšg_loc
) {

10323 
missšg_loc
.
	`ş—r_loÿtiÚ
(
soid
);

10324 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
i
 = 
aùšg£t
.
	`begš
();

10325 
i
 !ğ
aùšg£t
.
	`’d
();

10326 ++
i
) {

10327 
pg_sh¬d_t
 
	`³”
(*
i
);

10328 ià(!
³”_missšg
[
³”
].
	`is_missšg
(
soid
))

10329 
missšg_loc
.
	`add_loÿtiÚ
(
soid
, 
³”
);

10332 
	`dout
(30è<< 
__func__
 << " missšg_loøaá”: " << 
missšg_loc
.
	`g‘_loÿtiÚs
(
soid
è<< 
d’dl
;

10334 
pgback’d
->
	`subm™_Œª§ùiÚ
(

10335 
soid
,

10336 
ùx
->
d–_¡©s
,

10337 
ùx
->
©_v”siÚ
,

10338 
¡d
::
	`move
(
ùx
->
İ_t
),

10339 
pg_Œim_to
,

10340 
mš_Ï¡_com¶‘e_Údisk
,

10341 
ùx
->
log
,

10342 
ùx
->
upd©ed_h£t_hi¡Üy
,

10343 
Ú_®l_comm™
,

10344 
»pİ
->
»p_tid
,

10345 
ùx
->
»qid
,

10346 
ùx
->
İ
);

10347 
	}
}

10349 
	gPrim¬yLogPG
::
R•G©h”
 *
Prim¬yLogPG
::
	$Ãw_»pİ
(

10350 
OpCÚ‹xt
 *
ùx
, 
ObjeùCÚ‹xtRef
 
obc
,

10351 
ûph_tid_t
 
»p_tid
)

10353 ià(
ùx
->
İ
)

10354 
	`dout
(10è<< "Ãw_»pİ„•_tid " << 
»p_tid
 << " oÀ" << *
ùx
->
İ
->
	`g‘_»q
(è<< 
d’dl
;

10356 
	`dout
(10è<< "Ãw_»pİ„•_tid " << 
»p_tid
 << " (nØİ)" << 
d’dl
;

10358 
R•G©h”
 *
»pİ
 = 
Ãw
 
	`R•G©h”
(

10359 
ùx
, 
»p_tid
, 
šfo
.
Ï¡_com¶‘e
);

10361 
»pİ
->
¡¬t
 = 
	`ûph_şock_now
();

10363 
»pİ_queue
.
	`push_back
(&
»pİ
->
queue_™em
);

10364 
»pİ
->
	`g‘
();

10366 
osd
->
logg”
->
	`šc
(
l_osd_İ_w
);

10368 
	`dout
(10è<< 
__func__
 << ": " << *
»pİ
 << 
d’dl
;

10369  
»pİ
;

10370 
	}
}

10372 
	gboo¡
::
šŒusive_±r
<
Prim¬yLogPG
::
R•G©h”
> Prim¬yLogPG::
Ãw_»pİ
(

10373 
ev”siÚ_t
 
v”siÚ
,

10374 
r
,

10375 
ObcLockMªag”
 &&
mªag”
,

10376 
OpReque¡Ref
 &&
İ
,

10377 
boo¡
::
İtiÚ®
<
¡d
::
funùiÚ
<()> > &&
Ú_com¶‘e
)

10379 
R•G©h”
 *
»pİ
 = 
Ãw
 RepGather(

10380 
¡d
::
move
(
mªag”
),

10381 
¡d
::
move
(
İ
),

10382 
¡d
::
move
(
Ú_com¶‘e
),

10383 
osd
->
g‘_tid
(),

10384 
šfo
.
Ï¡_com¶‘e
,

10385 
r
);

10386 
	g»pİ
->
	gv
 = 
v”siÚ
;

10388 
	g»pİ
->
	g¡¬t
 = 
ûph_şock_now
();

10390 
	g»pİ_queue
.
push_back
(&
»pİ
->
queue_™em
);

10392 
	gosd
->
	glogg”
->
šc
(
l_osd_İ_w
);

10394 
dout
(10è<< 
	g__func__
 << ": " << *
	g»pİ
 << 
	gd’dl
;

10395  
	gboo¡
::
šŒusive_±r
<
R•G©h”
>(
»pİ
);

10398 
	gPrim¬yLogPG
::
	$»move_»pİ
(
R•G©h”
 *
»pİ
)

10400 
	`dout
(20è<< 
__func__
 << " " << *
»pİ
 << 
d’dl
;

10402 autØ
p
 = 
»pİ
->
Ú_fšish
.
	`begš
();

10403 
p
 !ğ
»pİ
->
Ú_fšish
.
	`’d
();

10404 
»pİ
->
Ú_fšish
.
	`”a£
(
p
++)) {

10405 (*
p
)();

10408 
	`»Ëa£_objeù_locks
(

10409 
»pİ
->
lock_mªag”
);

10410 
»pİ
->
	`put
();

10412 
osd
->
logg”
->
	`dec
(
l_osd_İ_w
);

10413 
	}
}

10415 
	gPrim¬yLogPG
::
OpCÚ‹xtUPŒ
 
Prim¬yLogPG
::
	$sim¶e_İc_ü—‹
(
ObjeùCÚ‹xtRef
 
obc
)

10417 
	`dout
(20è<< 
__func__
 << " " << 
obc
->
obs
.
oi
.
soid
 << 
d’dl
;

10418 
ûph_tid_t
 
»p_tid
 = 
osd
->
	`g‘_tid
();

10419 
osd_»qid_t
 
	`»qid
(
osd
->
	`g‘_şu¡”_msgr_Çme
(), 0, 
»p_tid
);

10420 
OpCÚ‹xtUPŒ
 
	`ùx
(
Ãw
 
	`OpCÚ‹xt
(
	`OpReque¡Ref
(), 
»qid
, 
nuÎ±r
, 
obc
, 
this
));

10421 
ùx
->
İ_t
.
	`»£t
(
Ãw
 
	`PGT¿n§ùiÚ
());

10422 
ùx
->
mtime
 = 
	`ûph_şock_now
();

10423  
ùx
;

10424 
	}
}

10426 
	gPrim¬yLogPG
::
	$sim¶e_İc_subm™
(
OpCÚ‹xtUPŒ
 
ùx
)

10428 
R•G©h”
 *
»pİ
 = 
	`Ãw_»pİ
(
ùx
.
	`g‘
(), ctx->
obc
, ctx->
»qid
.
tid
);

10429 
	`dout
(20è<< 
__func__
 << " " << 
»pİ
 << 
d’dl
;

10430 
	`issue_»pİ
(
»pİ
, 
ùx
.
	`g‘
());

10431 
	`ev®_»pİ
(
»pİ
);

10432 
	`ÿlc_Œim_to
();

10433 
»pİ
->
	`put
();

10434 
	}
}

10437 
	gPrim¬yLogPG
::
subm™_log_’Œ›s
(

10438 cÚ¡ 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> &
’Œ›s
,

10439 
ObcLockMªag”
 &&
mªag”
,

10440 
boo¡
::
İtiÚ®
<
¡d
::
funùiÚ
<()> > &&
_Ú_com¶‘e
,

10441 
OpReque¡Ref
 
İ
,

10442 
r
)

10444 
dout
(10è<< 
	g__func__
 << " " << 
	g’Œ›s
 << 
	gd’dl
;

10445 
as£¹
(
is_´im¬y
());

10447 
ev”siÚ_t
 
	gv”siÚ
;

10448 ià(!
	g’Œ›s
.
em±y
()) {

10449 
as£¹
(
’Œ›s
.
rbegš
()->
v”siÚ
 >ğ
´ojeùed_Ï¡_upd©e
);

10450 
	gv”siÚ
 = 
´ojeùed_Ï¡_upd©e
 = 
’Œ›s
.
rbegš
()->
v”siÚ
;

10453 
	gboo¡
::
šŒusive_±r
<
R•G©h”
> 
»pİ
;

10454 
	gboo¡
::
İtiÚ®
<
¡d
::
funùiÚ
<()> > 
Ú_com¶‘e
;

10455 ià(
g‘_osdm­
()->
	g»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_JEWEL
) {

10456 
»pİ
 = 
Ãw_»pİ
(

10457 
v”siÚ
,

10458 
r
,

10459 
¡d
::
move
(
mªag”
),

10460 
¡d
::
move
(
İ
),

10461 
¡d
::
move
(
_Ú_com¶‘e
));

10463 
	gÚ_com¶‘e
 = 
¡d
::
move
(
_Ú_com¶‘e
);

10466 
	gpgback’d
->
ÿÎ_wr™e_Üd”ed
(

10467 [
this
, 
’Œ›s
, 
»pİ
, 
Ú_com¶‘e
]() {

10468 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

10469 
ev”siÚ_t
 
Şd_Ï¡_upd©e
 = 
šfo
.
Ï¡_upd©e
;

10470 
m”ge_Ãw_log_’Œ›s
(
’Œ›s
, 
t
, 
pg_Œim_to
, 
mš_Ï¡_com¶‘e_Údisk
);

10473 
£t
<
pg_sh¬d_t
> 
wa™šg_Ú
;

10474 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
i
 = 
aùšg_»cov”y_backfl
.
begš
();

10475 
i
 !ğ
aùšg_»cov”y_backfl
.
’d
();

10476 ++
i
) {

10477 
pg_sh¬d_t
 
³”
(*
i
);

10478 ià(
³”
 =ğ
pg_whßmi
) ;

10479 
as£¹
(
³”_missšg
.
couÁ
(
³”
));

10480 
as£¹
(
³”_šfo
.
couÁ
(
³”
));

10481 ià(
g‘_osdm­
()->
»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_JEWEL
) {

10482 
as£¹
(
»pİ
);

10483 
MOSDPGUpd©eLogMissšg
 *
m
 = 
Ãw
 MOSDPGUpdateLogMissing(

10484 
’Œ›s
,

10485 
¥g_t
(
šfo
.
pgid
.pgid, 
i
->
sh¬d
),

10486 
pg_whßmi
.
sh¬d
,

10487 
g‘_osdm­
()->
g‘_•och
(),

10488 
Ï¡_³”šg_»£t
,

10489 
»pİ
->
»p_tid
,

10490 
pg_Œim_to
,

10491 
mš_Ï¡_com¶‘e_Údisk
);

10492 
osd
->
£nd_mes§ge_osd_şu¡”
(

10493 
³”
.
osd
, 
m
, 
g‘_osdm­
()->
g‘_•och
());

10494 
wa™šg_Ú
.
š£¹
(
³”
);

10496 
MOSDPGLog
 *
m
 = 
Ãw
 MOSDPGLog(

10497 
³”
.
sh¬d
, 
pg_whßmi
.shard,

10498 
šfo
.
Ï¡_upd©e
.
•och
,

10499 
šfo
);

10500 
m
->
log
.log = 
’Œ›s
;

10501 
m
->
log
.

 = 
Şd_Ï¡_upd©e
;

10502 
m
->
log
.
h—d
 = 
šfo
.
Ï¡_upd©e
;

10503 
osd
->
£nd_mes§ge_osd_şu¡”
(

10504 
³”
.
osd
, 
m
, 
g‘_osdm­
()->
g‘_•och
());

10507 
ûph_tid_t
 
»p_tid
 = 
»pİ
->rep_tid;

10508 
wa™šg_Ú
.
š£¹
(
pg_whßmi
);

10509 
log_’Œy_upd©e_wa™šg_Ú
.
š£¹
(

10510 
make_·œ
(

10511 
»p_tid
,

10512 
LogUpd©eCtx
{
¡d
::
move
(
»pİ
), std::move(
wa™šg_Ú
)}

10514 
OnCom¶‘e
 : 
public
 
CÚ‹xt
 {

10515 
Prim¬yLogPGRef
 
pg
;

10516 
ûph_tid_t
 
»p_tid
;

10517 
•och_t
 
•och
;

10518 
OnCom¶‘e
(

10519 
Prim¬yLogPGRef
 
pg
,

10520 
ûph_tid_t
 
»p_tid
,

10521 
•och_t
 
•och
)

10522 : 
pg
Õg), 
»p_tid
Ô•_tid), 
•och
(epoch) {}

10523 
fšish
(è
ov”ride
 {

10524 
pg
->
lock
();

10525 ià(!
pg
->
pg_has_»£t_sšû
(
•och
)) {

10526 autØ
™
 = 
pg
->
log_’Œy_upd©e_wa™šg_Ú
.
fšd
(
»p_tid
);

10527 
as£¹
(
™
 !ğ
pg
->
log_’Œy_upd©e_wa™šg_Ú
.
’d
());

10528 autØ
™2
 = 
™
->
£cÚd
.
wa™šg_Ú
.
fšd
(
pg
->
pg_whßmi
);

10529 
as£¹
(
™2
 !ğ
™
->
£cÚd
.
wa™šg_Ú
.
’d
());

10530 
™
->
£cÚd
.
wa™šg_Ú
.
”a£
(
™2
);

10531 ià(
™
->
£cÚd
.
wa™šg_Ú
.
em±y
()) {

10532 
pg
->
»pİ_®l_comm™‹d
(
™
->
£cÚd
.
»pİ
.
g‘
());

10533 
pg
->
log_’Œy_upd©e_wa™šg_Ú
.
”a£
(
™
);

10536 
pg
->
uÆock
();

10539 
t
.
»gi¡”_Ú_comm™
(

10540 
Ãw
 
OnCom¶‘e
{
this
, 
»p_tid
, 
g‘_osdm­
()->
g‘_•och
()});

10541 
r
 = 
osd
->
¡Üe
->
queue_Œª§ùiÚ
(
ch
, 
¡d
::
move
(
t
), 
NULL
);

10542 
as£¹
(
r
 == 0);

10543 
İ_­¶›d
(
šfo
.
Ï¡_upd©e
);

10546 
ÿlc_Œim_to
();

10549 
	gPrim¬yLogPG
::
	$ÿnûl_log_upd©es
()

10553 
log_’Œy_upd©e_wa™šg_Ú
.
	`ş—r
();

10554 
	}
}

10558 
	gPrim¬yLogPG
::
g‘_w©ch”s
(
li¡
<
obj_w©ch_™em_t
> *
ls
)

10560 
lock
();

10561 
	g·œ
<
	ghobjeù_t
, 
	gObjeùCÚ‹xtRef
> 
	gi
;

10562 
	gobjeù_cÚ‹xts
.
g‘_Ãxt
(
i
.
fœ¡
, &i)) {

10563 
ObjeùCÚ‹xtRef
 
obc
(
i
.
£cÚd
);

10564 
g‘_obc_w©ch”s
(
obc
, *
ls
);

10566 
uÆock
();

10569 
	gPrim¬yLogPG
::
g‘_obc_w©ch”s
(
ObjeùCÚ‹xtRef
 
obc
, 
li¡
<
obj_w©ch_™em_t
> &
pg_w©ch”s
)

10571 
	gm­
<
	g·œ
<
	gušt64_t
, 
	g’t™y_Çme_t
>, 
	gW©chRef
>::
™”©Ü
 
j
 =

10572 
obc
->
w©ch”s
.
begš
();

10573 
	gj
 !ğ
obc
->
w©ch”s
.
’d
();

10574 ++
	gj
) {

10575 
obj_w©ch_™em_t
 
	gowi
;

10577 
	gowi
.
	gobj
 = 
obc
->
obs
.
oi
.
soid
;

10578 
	gowi
.
	gwi
.
	gaddr
 = 
j
->
£cÚd
->
g‘_³”_addr
();

10579 
	gowi
.
	gwi
.
	gÇme
 = 
j
->
£cÚd
->
g‘_’t™y
();

10580 
	gowi
.
	gwi
.
	gcook›
 = 
j
->
£cÚd
->
g‘_cook›
();

10581 
	gowi
.
	gwi
.
	gtimeout_£cÚds
 = 
j
->
£cÚd
->
g‘_timeout
();

10583 
dout
(30è<< "w©ch: Found oid=" << 
	gowi
.
	gobj
 << "‡ddr=" << owi.
	gwi
.
	gaddr


10584 << "‚ame=" << 
	gowi
.
	gwi
.
	gÇme
 << " cook›=" << owi.wi.
	gcook›
 << 
	gd’dl
;

10586 
	gpg_w©ch”s
.
push_back
(
owi
);

10590 
	gPrim¬yLogPG
::
	$check_bÏckli¡ed_w©ch”s
()

10592 
	`dout
(20è<< "Prim¬yLogPG::check_bÏckli¡ed_w©ch” fÜ…g " << 
	`g‘_pgid
(è<< 
d’dl
;

10593 
·œ
<
hobjeù_t
, 
ObjeùCÚ‹xtRef
> 
i
;

10594 
objeù_cÚ‹xts
.
	`g‘_Ãxt
(
i
.
fœ¡
, &i))

10595 
	`check_bÏckli¡ed_obc_w©ch”s
(
i
.
£cÚd
);

10596 
	}
}

10598 
	gPrim¬yLogPG
::
	$check_bÏckli¡ed_obc_w©ch”s
(
ObjeùCÚ‹xtRef
 
obc
)

10600 
	`dout
(20è<< "Prim¬yLogPG::check_bÏckli¡ed_obc_w©ch” fÜ obø" << 
obc
->
obs
.
oi
.
soid
 << 
d’dl
;

10601 
m­
<
·œ
<
ušt64_t
, 
’t™y_Çme_t
>, 
W©chRef
>::
™”©Ü
 
k
 =

10602 
obc
->
w©ch”s
.
	`begš
();

10603 
k
 !ğ
obc
->
w©ch”s
.
	`’d
();

10606 
m­
<
·œ
<
ušt64_t
, 
’t™y_Çme_t
>, 
W©chRef
>::
™”©Ü
 
j
 = 
k
++;

10607 
	`dout
(30è<< "w©ch: Found " << 
j
->
£cÚd
->
	`g‘_’t™y
(è<< " cook› " << j->£cÚd->
	`g‘_cook›
(è<< 
d’dl
;

10608 
’t™y_addr_t
 
—
 = 
j
->
£cÚd
->
	`g‘_³”_addr
();

10609 
	`dout
(30è<< "w©ch: CheckƒÁ™y_addr_ˆ" << 
—
 << 
d’dl
;

10610 ià(
	`g‘_osdm­
()->
	`is_bÏckli¡ed
(
—
)) {

10611 
	`dout
(10è<< "w©ch: Found bÏckli¡ed w©ch” fÜ " << 
—
 << 
d’dl
;

10612 
	`as£¹
(
j
->
£cÚd
->
	`g‘_pg
(è=ğ
this
);

10613 
j
->
£cÚd
->
	`uÄegi¡”_cb
();

10614 
	`hªdË_w©ch_timeout
(
j
->
£cÚd
);

10617 
	}
}

10619 
	gPrim¬yLogPG
::
	$pİuÏ‹_obc_w©ch”s
(
ObjeùCÚ‹xtRef
 
obc
)

10621 
	`as£¹
(
	`is_aùive
());

10622 autØ
™_objeùs
 = 
pg_log
.
	`g‘_log
().
objeùs
.
	`fšd
(
obc
->
obs
.
oi
.
soid
);

10623 
	`as£¹
((
»cov”šg
.
	`couÁ
(
obc
->
obs
.
oi
.
soid
) ||

10624 !
	`is_missšg_objeù
(
obc
->
obs
.
oi
.
soid
)) ||

10625 (
™_objeùs
 !ğ
pg_log
.
	`g‘_log
().
objeùs
.
	`’d
() &&

10626 
™_objeùs
->
£cÚd
->
İ
 ==

10627 
pg_log_’Œy_t
::
LOST_REVERT
 &&

10628 
™_objeùs
->
£cÚd
->
»v”tšg_to
 ==

10629 
obc
->
obs
.
oi
.
v”siÚ
));

10631 
	`dout
(10è<< "pİuÏ‹_obc_w©ch” " << 
obc
->
obs
.
oi
.
soid
 << 
d’dl
;

10632 
	`as£¹
(
obc
->
w©ch”s
.
	`em±y
());

10634 
m­
<
·œ
<
ušt64_t
, 
’t™y_Çme_t
>, 
w©ch_šfo_t
>::
™”©Ü
 
p
 =

10635 
obc
->
obs
.
oi
.
w©ch”s
.
	`begš
();

10636 
p
 !ğ
obc
->
obs
.
oi
.
w©ch”s
.
	`’d
();

10637 ++
p
) {

10638 
utime_t
 
expœe
 = 
šfo
.
¡©s
.
Ï¡_beÿme_aùive
;

10639 
expœe
 +ğ
p
->
£cÚd
.
timeout_£cÚds
;

10640 
	`dout
(10è<< " uncÚÃùed w©ch” " << 
p
->
fœ¡
 << " wÈexpœ" << 
expœe
 << 
d’dl
;

10641 
W©chRef
 
	`w©ch
(

10642 
W©ch
::
	`makeW©chRef
(

10643 
this
, 
osd
, 
obc
, 
p
->
£cÚd
.
timeout_£cÚds
,…->
fœ¡
.first,

10644 
p
->
fœ¡
.
£cÚd
,…->£cÚd.
addr
));

10645 
w©ch
->
	`discÚÃù
();

10646 
obc
->
w©ch”s
.
	`š£¹
(

10647 
	`make_·œ
(

10648 
	`make_·œ
(
p
->
fœ¡
.fœ¡,…->fœ¡.
£cÚd
),

10649 
w©ch
));

10652 
	`check_bÏckli¡ed_obc_w©ch”s
(
obc
);

10653 
	}
}

10655 
	gPrim¬yLogPG
::
	$hªdË_w©ch_timeout
(
W©chRef
 
w©ch
)

10657 
ObjeùCÚ‹xtRef
 
obc
 = 
w©ch
->
	`g‘_obc
();

10658 
	`dout
(10è<< "hªdË_w©ch_timeouˆobø" << 
obc
 << 
d’dl
;

10660 ià(!
	`is_aùive
()) {

10661 
	`dout
(10è<< "hªdË_w©ch_timeouˆnÙ‡ùive,‚o-İ" << 
d’dl
;

10664 ià(
	`is_deg¿ded_Ü_backflšg_objeù
(
obc
->
obs
.
oi
.
soid
)) {

10665 
ÿÎbacks_fÜ_deg¿ded_objeù
[
obc
->
obs
.
oi
.
soid
].
	`push_back
(

10666 
w©ch
->
	`g‘_d–ayed_cb
()

10668 
	`dout
(10) << "handle_watch_timeout waiting for degraded on obj "

10669 << 
obc
->
obs
.
oi
.
soid


10670 << 
d’dl
;

10674 ià(
	`wr™e_blocked_by_süub
(
obc
->
obs
.
oi
.
soid
)) {

10675 
	`dout
(10) << "handle_watch_timeout waiting for scrub on obj "

10676 << 
obc
->
obs
.
oi
.
soid


10677 << 
d’dl
;

10678 
süubb”
.
	`add_ÿÎback
(

10679 
w©ch
->
	`g‘_d–ayed_cb
()

10684 
OpCÚ‹xtUPŒ
 
ùx
 = 
	`sim¶e_İc_ü—‹
(
obc
);

10685 
ùx
->
©_v”siÚ
 = 
	`g‘_Ãxt_v”siÚ
();

10687 
objeù_šfo_t
& 
oi
 = 
ùx
->
Ãw_obs
.oi;

10688 
oi
.
w©ch”s
.
	`”a£
(
	`make_·œ
(
w©ch
->
	`g‘_cook›
(),

10689 
w©ch
->
	`g‘_’t™y
()));

10691 
li¡
<
w©ch_discÚÃù_t
> 
w©ch_discÚÃùs
 = {

10692 
	`w©ch_discÚÃù_t
(
w©ch
->
	`g‘_cook›
(), w©ch->
	`g‘_’t™y
(), 
Œue
)

10694 
ùx
->
	`»gi¡”_Ú_sucûss
(

10695 [
this
, 
obc
, 
w©ch_discÚÃùs
]() {

10696 
	`com¶‘e_discÚÃù_w©ches
(
obc
, 
w©ch_discÚÃùs
);

10700 
PGT¿n§ùiÚ
 *
t
 = 
ùx
->
İ_t
.
	`g‘
();

10701 
ùx
->
log
.
	`push_back
(
	`pg_log_’Œy_t
(
pg_log_’Œy_t
::
MODIFY
, 
obc
->
obs
.
oi
.
soid
,

10702 
ùx
->
©_v”siÚ
,

10703 
oi
.
v”siÚ
,

10705 
	`osd_»qid_t
(), 
ùx
->
mtime
, 0));

10707 
oi
.
´iÜ_v”siÚ
 = 
obc
->
obs
.oi.
v”siÚ
;

10708 
oi
.
v”siÚ
 = 
ùx
->
©_v”siÚ
;

10709 
bufã¾i¡
 
bl
;

10710 
	`’code
(
oi
, 
bl
, 
	`g‘_osdm­
()->
	`g‘_ã©u»s
(
CEPH_ENTITY_TYPE_OSD
, 
nuÎ±r
));

10711 
t
->
	`£‰r
(
obc
->
obs
.
oi
.
soid
, 
OI_ATTR
, 
bl
);

10714 
ùx
->
obc
->
obs
 = ctx->
Ãw_obs
;

10717 
	`sim¶e_İc_subm™
(
¡d
::
	`move
(
ùx
));

10718 
	}
}

10720 
ObjeùCÚ‹xtRef
 
	gPrim¬yLogPG
::
	$ü—‹_objeù_cÚ‹xt
(cÚ¡ 
objeù_šfo_t
& 
oi
,

10721 
SÇpS‘CÚ‹xt
 *
ssc
)

10723 
ObjeùCÚ‹xtRef
 
	`obc
(
objeù_cÚ‹xts
.
	`lookup_Ü_ü—‹
(
oi
.
soid
));

10724 
	`as£¹
(
obc
->
de¡ruùÜ_ÿÎback
 =ğ
NULL
);

10725 
obc
->
de¡ruùÜ_ÿÎback
 = 
Ãw
 
	`C_PG_ObjeùCÚ‹xt
(
this
, obc.
	`g‘
());

10726 
obc
->
obs
.
oi
 = oi;

10727 
obc
->
obs
.
exi¡s
 = 
çl£
;

10728 
obc
->
ssc
 = ssc;

10729 ià(
ssc
)

10730 
	`»gi¡”_¢­£t_cÚ‹xt
(
ssc
);

10731 
	`dout
(10è<< "ü—‹_objeù_cÚ‹xˆ" << (*)
obc
.
	`g‘
(è<< " " << 
oi
.
soid
 << " " << 
d’dl
;

10732 ià(
	`is_aùive
())

10733 
	`pİuÏ‹_obc_w©ch”s
(
obc
);

10734  
obc
;

10735 
	}
}

10737 
ObjeùCÚ‹xtRef
 
	gPrim¬yLogPG
::
g‘_objeù_cÚ‹xt
(

10738 cÚ¡ 
hobjeù_t
& 
soid
,

10739 
boŞ
 
ÿn_ü—‹
,

10740 cÚ¡ 
m­
<
¡ršg
, 
bufã¾i¡
> *
©Œs
)

10742 autØ
	g™_objeùs
 = 
pg_log
.
g‘_log
().
objeùs
.
fšd
(
soid
);

10743 
as£¹
(

10744 
©Œs
 || !
pg_log
.
g‘_missšg
().
is_missšg
(
soid
) ||

10746 (
™_objeùs
 !ğ
pg_log
.
g‘_log
().
objeùs
.
’d
() &&

10747 
™_objeùs
->
£cÚd
->
İ
 ==

10748 
pg_log_’Œy_t
::
LOST_REVERT
));

10749 
ObjeùCÚ‹xtRef
 
	gobc
 = 
objeù_cÚ‹xts
.
lookup
(
soid
);

10750 
	gosd
->
	glogg”
->
šc
(
l_osd_objeù_ùx_ÿche_tÙ®
);

10751 ià(
	gobc
) {

10752 
	gosd
->
	glogg”
->
šc
(
l_osd_objeù_ùx_ÿche_h™
);

10753 
dout
(10è<< 
	g__func__
 << ": found obøš cache: " << 
	gobc


10754 << 
	gd’dl
;

10756 
dout
(10è<< 
	g__func__
 << ": obøNOT found iÀÿche: " << 
	gsoid
 << 
	gd’dl
;

10758 
bufã¾i¡
 
	gbv
;

10759 ià(
	g©Œs
) {

10760 autØ
	g™_oi
 = 
©Œs
->
fšd
(
OI_ATTR
);

10761 
as£¹
(
™_oi
 !ğ
©Œs
->
’d
());

10762 
	gbv
 = 
™_oi
->
£cÚd
;

10764 
	gr
 = 
pgback’d
->
objeùs_g‘_©Œ
(
soid
, 
OI_ATTR
, &
bv
);

10765 ià(
	gr
 < 0) {

10766 ià(!
	gÿn_ü—‹
) {

10767 
dout
(10è<< 
	g__func__
 << ":‚o obc for soid "

10768 << 
	gsoid
 << "‡nd !can_create"

10769 << 
	gd’dl
;

10770  
ObjeùCÚ‹xtRef
();

10773 
dout
(10è<< 
	g__func__
 << ":‚o obc for soid "

10774 << 
	gsoid
 << " but can_create"

10775 << 
	gd’dl
;

10777 
objeù_šfo_t
 
oi
(
soid
);

10778 
SÇpS‘CÚ‹xt
 *
	gssc
 = 
g‘_¢­£t_cÚ‹xt
(

10779 
soid
, 
Œue
, 0, 
çl£
);

10780 
as£¹
(
ssc
);

10781 
	gobc
 = 
ü—‹_objeù_cÚ‹xt
(
oi
, 
ssc
);

10782 
dout
(10è<< 
	g__func__
 << ": " << 
	gobc
 << " " << 
	gsoid


10783 << " " << 
	gobc
->
	grw¡©e


10784 << " oi: " << 
	gobc
->
	gobs
.
	goi


10785 << " ssc: " << 
	gobc
->
	gssc


10786 << " sÇp£t: " << 
	gobc
->
	gssc
->
	g¢­£t
 << 
	gd’dl
;

10787  
	gobc
;

10791 
objeù_šfo_t
 
	goi
;

10792 
	gŒy
 {

10793 
	gbufã¾i¡
::
™”©Ü
 
bl™”
 = 
bv
.
begš
();

10794 
decode
(
oi
, 
bl™”
);

10795 } 
ÿtch
 (...) {

10796 
dout
(0è<< 
	g__func__
 << ": obøcÜru±: " << 
	gsoid
 << 
	gd’dl
;

10797  
ObjeùCÚ‹xtRef
();

10800 
as£¹
(
oi
.
soid
.
poŞ
 =ğ(
št64_t
)
šfo
.
pgid
.pool());

10802 
	gobc
 = 
objeù_cÚ‹xts
.
lookup_Ü_ü—‹
(
oi
.
soid
);

10803 
	gobc
->
	gde¡ruùÜ_ÿÎback
 = 
Ãw
 
C_PG_ObjeùCÚ‹xt
(
this
, 
obc
.
g‘
());

10804 
	gobc
->
	gobs
.
	goi
 = 
oi
;

10805 
	gobc
->
	gobs
.
	gexi¡s
 = 
Œue
;

10807 
	gobc
->
	gssc
 = 
g‘_¢­£t_cÚ‹xt
(

10808 
soid
, 
Œue
,

10809 
soid
.
has_¢­£t
(è? 
©Œs
 : 0);

10811 ià(
is_aùive
())

10812 
pİuÏ‹_obc_w©ch”s
(
obc
);

10814 ià(
	gpoŞ
.
	gšfo
.
is_”asu»
()) {

10815 ià(
	g©Œs
) {

10816 
	gobc
->
	g©Œ_ÿche
 = *
©Œs
;

10818 
	gr
 = 
pgback’d
->
objeùs_g‘_©Œs
(

10819 
soid
,

10820 &
obc
->
©Œ_ÿche
);

10821 
as£¹
(
r
 == 0);

10825 
dout
(10è<< 
	g__func__
 << ": c»©šg obøäom disk: " << 
	gobc


10826 << 
	gd’dl
;

10830 ià(
	gobc
->
	gssc
 =ğ
NULL
) {

10831 
d”r
 << 
__func__
 << ": obc->ssønÙ‡vaabË,‚Ù„‘uºšg cÚ‹xt" << 
d’dl
;

10832  
ObjeùCÚ‹xtRef
();

10835 
dout
(10è<< 
	g__func__
 << ": " << 
	gobc
 << " " << 
	gsoid


10836 << " " << 
	gobc
->
	grw¡©e


10837 << " oi: " << 
	gobc
->
	gobs
.
	goi


10838 << "ƒxi¡s: " << ()
	gobc
->
	gobs
.
	gexi¡s


10839 << " ssc: " << 
	gobc
->
	gssc


10840 << " sÇp£t: " << 
	gobc
->
	gssc
->
	g¢­£t
 << 
	gd’dl
;

10841  
	gobc
;

10844 
	gPrim¬yLogPG
::
	$cÚ‹xt_»gi¡ry_Ú_chªge
()

10846 
·œ
<
hobjeù_t
, 
ObjeùCÚ‹xtRef
> 
i
;

10847 
objeù_cÚ‹xts
.
	`g‘_Ãxt
(
i
.
fœ¡
, &i)) {

10848 
ObjeùCÚ‹xtRef
 
	`obc
(
i
.
£cÚd
);

10849 ià(
obc
) {

10850 
m­
<
·œ
<
ušt64_t
, 
’t™y_Çme_t
>, 
W©chRef
>::
™”©Ü
 
j
 =

10851 
obc
->
w©ch”s
.
	`begš
();

10852 
j
 !ğ
obc
->
w©ch”s
.
	`’d
();

10853 
obc
->
w©ch”s
.
	`”a£
(
j
++)) {

10854 
j
->
£cÚd
->
	`disÿrd
();

10858 
	}
}

10871 
	gPrim¬yLogPG
::
	$fšd_objeù_cÚ‹xt
(cÚ¡ 
hobjeù_t
& 
oid
,

10872 
ObjeùCÚ‹xtRef
 *
pobc
,

10873 
boŞ
 
ÿn_ü—‹
,

10874 
boŞ
 
m­_¢­id_to_şÚe
,

10875 
hobjeù_t
 *
pmissšg
)

10877 
	`FUNCTRACE
(
cù
);

10878 
	`as£¹
(
oid
.
poŞ
 =ğ
¡©ic_ÿ¡
<
št64_t
>(
šfo
.
pgid
.
	`poŞ
()));

10880 ià(
oid
.
¢­
 =ğ
CEPH_NOSNAP
) {

10881 
ObjeùCÚ‹xtRef
 
obc
 = 
	`g‘_objeù_cÚ‹xt
(
oid
, 
ÿn_ü—‹
);

10882 ià(!
obc
) {

10883 ià(
pmissšg
)

10884 *
pmissšg
 = 
oid
;

10885  -
ENOENT
;

10887 
	`dout
(10è<< 
__func__
 << " " << 
oid


10888 << " @" << 
oid
.
¢­


10889 << " oi=" << 
obc
->
obs
.
oi


10890 << 
d’dl
;

10891 *
pobc
 = 
obc
;

10896 
hobjeù_t
 
h—d
 = 
oid
.
	`g‘_h—d
();

10899 ià(!
m­_¢­id_to_şÚe
 && 
poŞ
.
šfo
.
	`is_»moved_¢­
(
oid
.
¢­
)) {

10900 
	`dout
(10è<< 
__func__
 << " sÇ°" << 
oid
.
¢­
 << " i »moved" << 
d’dl
;

10901  -
ENOENT
;

10904 
SÇpS‘CÚ‹xt
 *
ssc
 = 
	`g‘_¢­£t_cÚ‹xt
(
oid
, 
ÿn_ü—‹
);

10905 ià(!
ssc
 || !(ssc->
exi¡s
 || 
ÿn_ü—‹
)) {

10906 
	`dout
(20è<< 
__func__
 << " " << 
oid
 << "‚Ø¢­£t" << 
d’dl
;

10907 ià(
pmissšg
)

10908 *
pmissšg
 = 
h—d
;

10909 ià(
ssc
)

10910 
	`put_¢­£t_cÚ‹xt
(
ssc
);

10911  -
ENOENT
;

10914 ià(
m­_¢­id_to_şÚe
) {

10915 
	`dout
(10è<< 
__func__
 << " " << 
oid
 << " @" << oid.
¢­


10916 << " sÇp£ˆ" << 
ssc
->
¢­£t


10917 << " m­_¢­id_to_şÚeñrue" << 
d’dl
;

10918 ià(
oid
.
¢­
 > 
ssc
->
¢­£t
.
£q
) {

10920 
ObjeùCÚ‹xtRef
 
obc
 = 
	`g‘_objeù_cÚ‹xt
(
h—d
, 
çl£
);

10921 
	`dout
(10è<< 
__func__
 << " " << 
oid
 << " @" << oid.
¢­


10922 << " sÇp£ˆ" << 
ssc
->
¢­£t


10923 << " m­ tØh—d" << 
d’dl
;

10924 *
pobc
 = 
obc
;

10925 
	`put_¢­£t_cÚ‹xt
(
ssc
);

10926  (
obc
 && obc->
obs
.
exi¡s
è? 0 : -
ENOENT
;

10928 
veùÜ
<
¢­id_t
>::
cÚ¡_™”©Ü
 
c™”
 = 
¡d
::
	`fšd
(

10929 
ssc
->
¢­£t
.
şÚes
.
	`begš
(),

10930 
ssc
->
¢­£t
.
şÚes
.
	`’d
(),

10931 
oid
.
¢­
);

10932 ià(
c™”
 =ğ
ssc
->
¢­£t
.
şÚes
.
	`’d
()) {

10933 
	`dout
(10è<< 
__func__
 << " " << 
oid
 << " @" << oid.
¢­


10934 << " sÇp£ˆ" << 
ssc
->
¢­£t


10935 << " m­ tØnÙhšg" << 
d’dl
;

10936 
	`put_¢­£t_cÚ‹xt
(
ssc
);

10937  -
ENOENT
;

10940 
	`dout
(10è<< 
__func__
 << " " << 
oid
 << " @" << oid.
¢­


10941 << " sÇp£ˆ" << 
ssc
->
¢­£t


10942 << " m­ tØ" << 
oid
 << 
d’dl
;

10944 ià(
pg_log
.
	`g‘_missšg
().
	`is_missšg
(
oid
)) {

10945 
	`dout
(10è<< 
__func__
 << " " << 
oid
 << " @" << oid.
¢­


10946 << " sÇp£ˆ" << 
ssc
->
¢­£t


10947 << " " << 
oid
 << " i missšg" << 
d’dl
;

10948 ià(
pmissšg
)

10949 *
pmissšg
 = 
oid
;

10950 
	`put_¢­£t_cÚ‹xt
(
ssc
);

10951  -
EAGAIN
;

10954 
ObjeùCÚ‹xtRef
 
obc
 = 
	`g‘_objeù_cÚ‹xt
(
oid
, 
çl£
);

10955 ià(!
obc
 || !obc->
obs
.
exi¡s
) {

10956 
	`dout
(10è<< 
__func__
 << " " << 
oid
 << " @" << oid.
¢­


10957 << " sÇp£ˆ" << 
ssc
->
¢­£t


10958 << " " << 
oid
 << " i nÙ…»£Á" << 
d’dl
;

10959 ià(
pmissšg
)

10960 *
pmissšg
 = 
oid
;

10961 
	`put_¢­£t_cÚ‹xt
(
ssc
);

10962  -
ENOENT
;

10964 
	`dout
(10è<< 
__func__
 << " " << 
oid
 << " @" << oid.
¢­


10965 << " sÇp£ˆ" << 
ssc
->
¢­£t


10966 << " " << 
oid
 << " HIT" << 
d’dl
;

10967 *
pobc
 = 
obc
;

10968 
	`put_¢­£t_cÚ‹xt
(
ssc
);

10971 
	`ûph_abÜt
();

10974 
	`dout
(10è<< 
__func__
 << " " << 
oid
 << " @" << oid.
¢­


10975 << " sÇp£ˆ" << 
ssc
->
¢­£t
 << 
d’dl
;

10978 ià(
oid
.
¢­
 > 
ssc
->
¢­£t
.
£q
) {

10979 
ObjeùCÚ‹xtRef
 
obc
 = 
	`g‘_objeù_cÚ‹xt
(
h—d
, 
çl£
);

10980 
	`dout
(10è<< 
__func__
 << " " << 
h—d


10981 << " wªˆ" << 
oid
.
¢­
 << " > sÇp£ˆ£q " << 
ssc
->
¢­£t
.
£q


10982 << " -- HIT " << 
obc
->
obs


10983 << 
d’dl
;

10984 ià(!
obc
->
ssc
)

10985 
obc
->
ssc
 = ssc;

10987 
	`as£¹
(
ssc
 =ğ
obc
->ssc);

10988 
	`put_¢­£t_cÚ‹xt
(
ssc
);

10990 *
pobc
 = 
obc
;

10995 
k
 = 0;

10996 
k
 < 
ssc
->
¢­£t
.
şÚes
.
	`size
() &&

10997 
ssc
->
¢­£t
.
şÚes
[
k
] < 
oid
.
¢­
)

10998 
k
++;

10999 ià(
k
 =ğ
ssc
->
¢­£t
.
şÚes
.
	`size
()) {

11000 
	`dout
(10è<< 
__func__
 << "‚o clones with†ast >= oid.snap "

11001 << 
oid
.
¢­
 << " -- DNE" << 
d’dl
;

11002 
	`put_¢­£t_cÚ‹xt
(
ssc
);

11003  -
ENOENT
;

11005 
hobjeù_t
 
	`soid
(
oid
.oid, oid.
	`g‘_key
(), 
ssc
->
¢­£t
.
şÚes
[
k
], oid.
	`g‘_hash
(),

11006 
šfo
.
pgid
.
	`poŞ
(), 
oid
.
	`g‘_Çme¥aû
());

11008 ià(
pg_log
.
	`g‘_missšg
().
	`is_missšg
(
soid
)) {

11009 
	`dout
(20è<< 
__func__
 << " " << 
soid
 << " missing,ry‡gain†ater"

11010 << 
d’dl
;

11011 ià(
pmissšg
)

11012 *
pmissšg
 = 
soid
;

11013 
	`put_¢­£t_cÚ‹xt
(
ssc
);

11014  -
EAGAIN
;

11017 
ObjeùCÚ‹xtRef
 
obc
 = 
	`g‘_objeù_cÚ‹xt
(
soid
, 
çl£
);

11018 ià(!
obc
 || !obc->
obs
.
exi¡s
) {

11019 ià(
pmissšg
)

11020 *
pmissšg
 = 
soid
;

11021 
	`put_¢­£t_cÚ‹xt
(
ssc
);

11022 ià(
	`is_deg¿ded_Ü_backflšg_objeù
(
soid
)) {

11023 
	`dout
(20è<< 
__func__
 << " clÚi deg¿ded o¸backflšg " << 
soid
 << 
d’dl
;

11024  -
EAGAIN
;

11025 } ià(
	`is_deg¿ded_Ú_async_»cov”y_rg‘
(
soid
)) {

11026 
	`dout
(20è<< 
__func__
 << " clÚi »cov”šg " << 
soid
 << 
d’dl
;

11027  -
EAGAIN
;

11029 
	`dout
(20è<< 
__func__
 << " missšg clÚ" << 
soid
 << 
d’dl
;

11030  -
ENOENT
;

11034 ià(!
obc
->
ssc
) {

11035 
obc
->
ssc
 = ssc;

11037 
	`as£¹
(
obc
->
ssc
 == ssc);

11038 
	`put_¢­£t_cÚ‹xt
(
ssc
);

11040 
ssc
 = 0;

11043 
	`dout
(20è<< 
__func__
 << " " << 
soid


11044 << " sÇp£ˆ" << 
obc
->
ssc
->
¢­£t


11045 << 
d’dl
;

11046 
¢­id_t
 
fœ¡
, 
Ï¡
;

11047 autØ
p
 = 
obc
->
ssc
->
¢­£t
.
şÚe_¢­s
.
	`fšd
(
soid
.
¢­
);

11048 
	`as£¹
(
p
 !ğ
obc
->
ssc
->
¢­£t
.
şÚe_¢­s
.
	`’d
());

11049 ià(
p
->
£cÚd
.
	`em±y
()) {

11050 
	`dout
(1è<< 
__func__
 << " " << 
soid
 << "ƒm±y sÇp£ˆ-- DNE" << 
d’dl
;

11051 
	`as£¹
(!
cù
->
_cÚf
->
osd_debug_v”ify_¢­s
);

11052  -
ENOENT
;

11054 
fœ¡
 = 
p
->
£cÚd
.
	`back
();

11055 
Ï¡
 = 
p
->
£cÚd
.
	`äÚt
();

11056 ià(
fœ¡
 <ğ
oid
.
¢­
) {

11057 
	`dout
(20è<< 
__func__
 << " " << 
soid
 << " [" << 
fœ¡
 << "," << 
Ï¡


11058 << "] cÚš " << 
oid
.
¢­
 << " -- HIT " << 
obc
->
obs
 << 
d’dl
;

11059 *
pobc
 = 
obc
;

11062 
	`dout
(20è<< 
__func__
 << " " << 
soid
 << " [" << 
fœ¡
 << "," << 
Ï¡


11063 << "] dÛ nÙ cÚš " << 
oid
.
¢­
 << " -- DNE" << 
d’dl
;

11064  -
ENOENT
;

11066 
	}
}

11068 
	gPrim¬yLogPG
::
	$objeù_cÚ‹xt_de¡ruùÜ_ÿÎback
(
ObjeùCÚ‹xt
 *
obc
)

11070 ià(
obc
->
ssc
)

11071 
	`put_¢­£t_cÚ‹xt
(
obc
->
ssc
);

11072 
	}
}

11074 
	gPrim¬yLogPG
::
	$add_objeù_cÚ‹xt_to_pg_¡©
(
ObjeùCÚ‹xtRef
 
obc
, 
pg_¡©_t
 *
pg¡©
)

11076 
objeù_šfo_t
& 
oi
 = 
obc
->
obs
.oi;

11078 
	`dout
(10è<< 
__func__
 << " " << 
oi
.
soid
 << 
d’dl
;

11079 
	`as£¹
(!
oi
.
soid
.
	`is_¢­dœ
());

11081 
objeù_¡©_sum_t
 
¡©
;

11082 
¡©
.
num_objeùs
++;

11083 ià(
oi
.
	`is_dœty
())

11084 
¡©
.
num_objeùs_dœty
++;

11085 ià(
oi
.
	`is_wh™eout
())

11086 
¡©
.
num_wh™eouts
++;

11087 ià(
oi
.
	`is_om­
())

11088 
¡©
.
num_objeùs_om­
++;

11089 ià(
oi
.
	`is_ÿche_pšÃd
())

11090 
¡©
.
num_objeùs_pšÃd
++;

11091 ià(
oi
.
	`has_mªiã¡
())

11092 
¡©
.
num_objeùs_mªiã¡
++;

11094 ià(
oi
.
soid
.
	`is_¢­
()) {

11095 
¡©
.
num_objeù_şÚes
++;

11097 ià(!
obc
->
ssc
)

11098 
obc
->
ssc
 = 
	`g‘_¢­£t_cÚ‹xt
(
oi
.
soid
, 
çl£
);

11099 
	`as£¹
(
obc
->
ssc
);

11100 
¡©
.
num_by‹s
 +ğ
obc
->
ssc
->
¢­£t
.
	`g‘_şÚe_by‹s
(
oi
.
soid
.
¢­
);

11102 
¡©
.
num_by‹s
 +ğ
oi
.
size
;

11106 
pg¡©
->
¡©s
.
sum
.
	`add
(
¡©
);

11107 
	}
}

11109 
	gPrim¬yLogPG
::
	$kick_objeù_cÚ‹xt_blocked
(
ObjeùCÚ‹xtRef
 
obc
)

11111 cÚ¡ 
hobjeù_t
& 
soid
 = 
obc
->
obs
.
oi
.soid;

11112 ià(
obc
->
	`is_blocked
()) {

11113 
	`dout
(10è<< 
__func__
 << " " << 
soid
 << " stÈblocked" << 
d’dl
;

11117 
m­
<
hobjeù_t
, 
li¡
<
OpReque¡Ref
>>::
™”©Ü
 
p
 = 
wa™šg_fÜ_blocked_objeù
.
	`fšd
(
soid
);

11118 ià(
p
 !ğ
wa™šg_fÜ_blocked_objeù
.
	`’d
()) {

11119 
li¡
<
OpReque¡Ref
>& 
ls
 = 
p
->
£cÚd
;

11120 
	`dout
(10è<< 
__func__
 << " " << 
soid
 << "„equeušg " << 
ls
.
	`size
(è<< "„eque¡s" << 
d’dl
;

11121 
	`»queue_İs
(
ls
);

11122 
wa™šg_fÜ_blocked_objeù
.
	`”a£
(
p
);

11125 
m­
<
hobjeù_t
, 
ObjeùCÚ‹xtRef
>::
™”©Ü
 
i
 =

11126 
objeùs_blocked_Ú_¢­_´omÙiÚ
.
	`fšd
(
obc
->
obs
.
oi
.
soid
.
	`g‘_h—d
());

11127 ià(
i
 !ğ
objeùs_blocked_Ú_¢­_´omÙiÚ
.
	`’d
()) {

11128 
	`as£¹
(
i
->
£cÚd
 =ğ
obc
);

11129 
objeùs_blocked_Ú_¢­_´omÙiÚ
.
	`”a£
(
i
);

11132 ià(
obc
->
»queue_süub_Ú_unblock
) {

11133 
obc
->
»queue_süub_Ú_unblock
 = 
çl£
;

11134 
	`»queue_süub
();

11136 
	}
}

11138 
SÇpS‘CÚ‹xt
 *
	gPrim¬yLogPG
::
g‘_¢­£t_cÚ‹xt
(

11139 cÚ¡ 
hobjeù_t
& 
oid
,

11140 
boŞ
 
ÿn_ü—‹
,

11141 cÚ¡ 
m­
<
¡ršg
, 
bufã¾i¡
> *
©Œs
,

11142 
boŞ
 
oid_exi¡ed
)

11144 
	gMu‹x
::
Lock”
 
l
(
¢­£t_cÚ‹xts_lock
);

11145 
SÇpS‘CÚ‹xt
 *
	gssc
;

11146 
	gm­
<
	ghobjeù_t
, 
	gSÇpS‘CÚ‹xt
*>::
™”©Ü
 
p
 = 
¢­£t_cÚ‹xts
.
fšd
(

11147 
oid
.
g‘_¢­dœ
());

11148 ià(
	gp
 !ğ
¢­£t_cÚ‹xts
.
’d
()) {

11149 ià(
ÿn_ü—‹
 || 
p
->
£cÚd
->
exi¡s
) {

11150 
ssc
 = 
p
->
£cÚd
;

11152  
	gNULL
;

11155 
bufã¾i¡
 
	gbv
;

11156 ià(!
	g©Œs
) {

11157 
	gr
 = -
ENOENT
;

11158 ià(!(
	goid
.
is_h—d
(è&& !
	goid_exi¡ed
)) {

11159 
	gr
 = 
pgback’d
->
objeùs_g‘_©Œ
(
oid
.
g‘_h—d
(), 
SS_ATTR
, &
bv
);

11161 ià(
	gr
 < 0 && !
	gÿn_ü—‹
)

11162  
	gNULL
;

11164 autØ
	g™_ss
 = 
©Œs
->
fšd
(
SS_ATTR
);

11165 
as£¹
(
™_ss
 !ğ
©Œs
->
’d
());

11166 
	gbv
 = 
™_ss
->
£cÚd
;

11168 
	gssc
 = 
Ãw
 
SÇpS‘CÚ‹xt
(
oid
.
g‘_¢­dœ
());

11169 
_»gi¡”_¢­£t_cÚ‹xt
(
ssc
);

11170 ià(
	gbv
.
Ëngth
()) {

11171 
	gbufã¾i¡
::
™”©Ü
 
bvp
 = 
bv
.
begš
();

11172 
	gŒy
 {

11173 
	gssc
->
	g¢­£t
.
decode
(
bvp
);

11174 } 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

11175 
dout
(0è<< 
__func__
 << " Cª'ˆdecod¢­£t: " << 
e
 << 
d’dl
;

11176  
	gNULL
;

11178 
	gssc
->
	gexi¡s
 = 
Œue
;

11180 
	gssc
->
	gexi¡s
 = 
çl£
;

11183 
as£¹
(
ssc
);

11184 
	gssc
->
	g»f
++;

11185  
	gssc
;

11188 
	gPrim¬yLogPG
::
	$put_¢­£t_cÚ‹xt
(
SÇpS‘CÚ‹xt
 *
ssc
)

11190 
Mu‹x
::
Lock”
 
	`l
(
¢­£t_cÚ‹xts_lock
);

11191 --
ssc
->
»f
;

11192 ià(
ssc
->
»f
 == 0) {

11193 ià(
ssc
->
»gi¡”ed
)

11194 
¢­£t_cÚ‹xts
.
	`”a£
(
ssc
->
oid
);

11195 
d–‘e
 
ssc
;

11197 
	}
}

11205 ’um { 
	mPULL_NONE
, 
	mPULL_HEAD
, 
	mPULL_YES
 };

11207 
	gPrim¬yLogPG
::
	$»cov”_missšg
(

11208 cÚ¡ 
hobjeù_t
 &
soid
, 
ev”siÚ_t
 
v
,

11209 
´iÜ™y
,

11210 
PGBack’d
::
Recov”yHªdË
 *
h
)

11212 ià(
missšg_loc
.
	`is_unfound
(
soid
)) {

11213 
	`dout
(7è<< 
__func__
 << " " << 
soid


11214 << " v " << 
v


11215 << " buˆ™ i unfound" << 
d’dl
;

11216  
PULL_NONE
;

11219 ià(
missšg_loc
.
	`is_d–‘ed
(
soid
)) {

11220 
	`¡¬t_»cov”y_İ
(
soid
);

11221 
	`as£¹
(!
»cov”šg
.
	`couÁ
(
soid
));

11222 
»cov”šg
.
	`š£¹
(
	`make_·œ
(
soid
, 
	`ObjeùCÚ‹xtRef
()));

11223 
•och_t
 
cur_•och
 = 
	`g‘_osdm­
()->
	`g‘_•och
();

11224 
	`»move_missšg_objeù
(
soid
, 
v
, 
Ãw
 
	`FunùiÚCÚ‹xt
(

11226 
	`lock
();

11227 ià(!
	`pg_has_»£t_sšû
(
cur_•och
)) {

11228 
boŞ
 
objeù_missšg
 = 
çl£
;

11229 cÚ¡‡uto& 
sh¬d
 : 
aùšg_»cov”y_backfl
) {

11230 ià(
sh¬d
 =ğ
pg_whßmi
)

11232 ià(
³”_missšg
[
sh¬d
].
	`is_missšg
(
soid
)) {

11233 
	`dout
(20è<< 
__func__
 << ": soid " << 
soid
 << "‚“d tØbd–‘ed from„•liÿ " << 
sh¬d
 << 
d’dl
;

11234 
objeù_missšg
 = 
Œue
;

11238 ià(!
objeù_missšg
) {

11239 
objeù_¡©_sum_t
 
¡©_diff
;

11240 
¡©_diff
.
num_objeùs_»cov”ed
 = 1;

11241 
	`Ú_glob®_»cov”
(
soid
, 
¡©_diff
, 
Œue
);

11243 autØ
»cov”y_hªdË
 = 
pgback’d
->
	`İ’_»cov”y_İ
();

11244 
pgback’d
->
	`»cov”_d–‘e_objeù
(
soid
, 
v
, 
»cov”y_hªdË
);

11245 
pgback’d
->
	`run_»cov”y_İ
(
»cov”y_hªdË
, 
´iÜ™y
);

11248 
	`uÆock
();

11250  
PULL_YES
;

11254 
ObjeùCÚ‹xtRef
 
obc
;

11255 
ObjeùCÚ‹xtRef
 
h—d_obc
;

11256 ià(
soid
.
¢­
 && soid.¢­ < 
CEPH_NOSNAP
) {

11258 
hobjeù_t
 
h—d
 = 
soid
.
	`g‘_h—d
();

11259 ià(
pg_log
.
	`g‘_missšg
().
	`is_missšg
(
h—d
)) {

11260 ià(
»cov”šg
.
	`couÁ
(
h—d
)) {

11261 
	`dout
(10è<< " missšg buˆ®»ady„ecov”šg h—d " << 
h—d
 << 
d’dl
;

11262  
PULL_NONE
;

11264 
r
 = 
	`»cov”_missšg
(

11265 
h—d
, 
pg_log
.
	`g‘_missšg
().
	`g‘_™ems
().
	`fšd
(h—d)->
£cÚd
.
Ãed
, 
´iÜ™y
,

11266 
h
);

11267 ià(
r
 !ğ
PULL_NONE
)

11268  
PULL_HEAD
;

11269  
PULL_NONE
;

11272 
h—d_obc
 = 
	`g‘_objeù_cÚ‹xt
(

11273 
h—d
,

11274 
çl£
,

11276 
	`as£¹
(
h—d_obc
);

11278 
	`¡¬t_»cov”y_İ
(
soid
);

11279 
	`as£¹
(!
»cov”šg
.
	`couÁ
(
soid
));

11280 
»cov”šg
.
	`š£¹
(
	`make_·œ
(
soid
, 
obc
));

11281 
r
 = 
pgback’d
->
	`»cov”_objeù
(

11282 
soid
,

11283 
v
,

11284 
h—d_obc
,

11285 
obc
,

11286 
h
);

11288 
	`as£¹
(
r
 >= 0);

11289  
PULL_YES
;

11290 
	}
}

11292 
	gPrim¬yLogPG
::
	$»move_missšg_objeù
(cÚ¡ 
hobjeù_t
 &
soid
,

11293 
ev”siÚ_t
 
v
, 
CÚ‹xt
 *
Ú_com¶‘e
)

11295 
	`dout
(20è<< 
__func__
 << " " << 
soid
 << " " << 
v
 << 
d’dl
;

11296 
	`as£¹
(
Ú_com¶‘e
 !ğ
nuÎ±r
);

11298 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

11299 
	`»move_¢­_m­³d_objeù
(
t
, 
soid
);

11301 
ObjeùRecov”yInfo
 
»cov”y_šfo
;

11302 
»cov”y_šfo
.
soid
 = soid;

11303 
»cov”y_šfo
.
v”siÚ
 = 
v
;

11305 
•och_t
 
cur_•och
 = 
	`g‘_osdm­
()->
	`g‘_•och
();

11306 
t
.
	`»gi¡”_Ú_com¶‘e
(
Ãw
 
	`FunùiÚCÚ‹xt
(

11308 
	`lock
();

11309 ià(!
	`pg_has_»£t_sšû
(
cur_•och
)) {

11310 
ObjeùStÜe
::
T¿n§ùiÚ
 
t2
;

11311 
	`Ú_loÿl_»cov”
(
soid
, 
»cov”y_šfo
, 
	`ObjeùCÚ‹xtRef
(), 
Œue
, &
t2
);

11312 
t2
.
	`»gi¡”_Ú_com¶‘e
(
Ú_com¶‘e
);

11313 
r
 = 
osd
->
¡Üe
->
	`queue_Œª§ùiÚ
(
ch
, 
¡d
::
	`move
(
t2
), 
nuÎ±r
);

11314 
	`as£¹
(
r
 == 0);

11315 
	`uÆock
();

11317 
	`uÆock
();

11318 
Ú_com¶‘e
->
	`com¶‘e
(-
EAGAIN
);

11321 
r
 = 
osd
->
¡Üe
->
	`queue_Œª§ùiÚ
(
ch
, 
¡d
::
	`move
(
t
), 
nuÎ±r
);

11322 
	`as£¹
(
r
 == 0);

11323 
	}
}

11325 
	gPrim¬yLogPG
::
	$fšish_deg¿ded_objeù
(cÚ¡ 
hobjeù_t
& 
oid
)

11327 
	`dout
(10è<< 
__func__
 << " " << 
oid
 << 
d’dl
;

11328 ià(
ÿÎbacks_fÜ_deg¿ded_objeù
.
	`couÁ
(
oid
)) {

11329 
li¡
<
CÚ‹xt
*> 
cÚ‹xts
;

11330 
cÚ‹xts
.
	`sw­
(
ÿÎbacks_fÜ_deg¿ded_objeù
[
oid
]);

11331 
ÿÎbacks_fÜ_deg¿ded_objeù
.
	`”a£
(
oid
);

11332 
li¡
<
CÚ‹xt
*>::
™”©Ü
 
i
 = 
cÚ‹xts
.
	`begš
();

11333 
i
 !ğ
cÚ‹xts
.
	`’d
();

11334 ++
i
) {

11335 (*
i
)->
	`com¶‘e
(0);

11338 
m­
<
hobjeù_t
, 
¢­id_t
>::
™”©Ü
 
i
 = 
objeùs_blocked_Ú_deg¿ded_¢­
.
	`fšd
(

11339 
oid
.
	`g‘_h—d
());

11340 ià(
i
 !ğ
objeùs_blocked_Ú_deg¿ded_¢­
.
	`’d
() &&

11341 
i
->
£cÚd
 =ğ
oid
.
¢­
)

11342 
objeùs_blocked_Ú_deg¿ded_¢­
.
	`”a£
(
i
);

11343 
	}
}

11345 
	gPrim¬yLogPG
::
	$_comm™‹d_pushed_objeù
(

11346 
•och_t
 
•och
, 
ev”siÚ_t
 
Ï¡_com¶‘e
)

11348 
	`lock
();

11349 ià(!
	`pg_has_»£t_sšû
(
•och
)) {

11350 
	`dout
(10è<< 
__func__
 << "†a¡_com¶‘" << 
Ï¡_com¶‘e
 << "‚ow ondisk" << 
d’dl
;

11351 
Ï¡_com¶‘e_Údisk
 = 
Ï¡_com¶‘e
;

11353 ià(
Ï¡_com¶‘e_Údisk
 =ğ
šfo
.
Ï¡_upd©e
) {

11354 ià(!
	`is_´im¬y
()) {

11357 
osd
->
	`£nd_mes§ge_osd_şu¡”
(

11358 
	`g‘_´im¬y
().
osd
,

11359 
Ãw
 
	`MOSDPGTrim
(

11360 
	`g‘_osdm­
()->
	`g‘_•och
(),

11361 
	`¥g_t
(
šfo
.
pgid
.pgid, 
	`g‘_´im¬y
().
sh¬d
),

11362 
Ï¡_com¶‘e_Údisk
),

11363 
	`g‘_osdm­
()->
	`g‘_•och
());

11365 
	`ÿlc_mš_Ï¡_com¶‘e_Údisk
();

11370 
	`dout
(10è<< 
__func__
 << "…g ha chªged,‚Ùouchšg†a¡_com¶‘e_Údisk" << 
d’dl
;

11373 
	`uÆock
();

11374 
	}
}

11376 
	gPrim¬yLogPG
::
	$_­¶›d_»cov”ed_objeù
(
ObjeùCÚ‹xtRef
 
obc
)

11378 
	`dout
(20è<< 
__func__
 << 
d’dl
;

11379 ià(
obc
) {

11380 
	`dout
(20è<< "obøğ" << *
obc
 << 
d’dl
;

11382 
	`as£¹
(
aùive_pushes
 >= 1);

11383 --
aùive_pushes
;

11386 ià(!
d–‘šg
 && 
aùive_pushes
 == 0

11387 && 
süubb”
.
	`is_chunky_süub_aùive
()) {

11388 
	`»queue_süub
(
	`İs_blocked_by_süub
());

11390 
	}
}

11392 
	gPrim¬yLogPG
::
	$_­¶›d_»cov”ed_objeù_»¶iÿ
()

11394 
	`dout
(20è<< 
__func__
 << 
d’dl
;

11395 
	`as£¹
(
aùive_pushes
 >= 1);

11396 --
aùive_pushes
;

11399 ià(!
d–‘šg
 && 
aùive_pushes
 == 0 &&

11400 
süubb”
.
aùive_»p_süub
 && 
¡©ic_ÿ¡
<cÚ¡ 
MOSDR•Süub
*>(

11401 
süubb”
.
aùive_»p_süub
->
	`g‘_»q
())->
chunky
) {

11402 auto& 
İ
 = 
süubb”
.
aùive_»p_süub
;

11403 
osd
->
	`’queue_back
(

11404 
	`OpQueueI‹m
(

11405 
unique_±r
<
OpQueueI‹m
::
OpQueu—bË
>(
Ãw
 
	`PGOpI‹m
(
šfo
.
pgid
, 
İ
)),

11406 
İ
->
	`g‘_»q
()->
	`g‘_co¡
(),

11407 
İ
->
	`g‘_»q
()->
	`g‘_´iÜ™y
(),

11408 
İ
->
	`g‘_»q
()->
	`g‘_»cv_¡amp
(),

11409 
İ
->
	`g‘_»q
()->
	`g‘_sourû
().
	`num
(),

11410 
	`g‘_osdm­
()->
	`g‘_•och
()));

11411 
süubb”
.
aùive_»p_süub
.
	`»£t
();

11413 
	}
}

11415 
	gPrim¬yLogPG
::
	$»cov”_gÙ
(
hobjeù_t
 
oid
, 
ev”siÚ_t
 
v
)

11417 
	`dout
(10è<< "gÙ missšg " << 
oid
 << " v " << 
v
 << 
d’dl
;

11418 
pg_log
.
	`»cov”_gÙ
(
oid
, 
v
, 
šfo
);

11419 ià(
pg_log
.
	`g‘_log
().
com¶‘e_to
 !ğpg_log.g‘_log().
log
.
	`’d
()) {

11420 
	`dout
(10è<< "Ï¡_com¶‘now " << 
šfo
.
Ï¡_com¶‘e


11421 << "†og.com¶‘e_tØ" << 
pg_log
.
	`g‘_log
().
com¶‘e_to
->
v”siÚ


11422 << 
d’dl
;

11424 
	`dout
(10è<< "Ï¡_com¶‘now " << 
šfo
.
Ï¡_com¶‘e


11425 << "†og.com¶‘e_tØ©ƒnd" << 
d’dl
;

11428 
	`as£¹
(
šfo
.
Ï¡_com¶‘e
 =ğšfo.
Ï¡_upd©e
);

11430 
	}
}

11432 
	gPrim¬yLogPG
::
	$´im¬y_çed
(cÚ¡ 
hobjeù_t
 &
soid
)

11434 
li¡
<
pg_sh¬d_t
> 
æ
 = { 
pg_whßmi
 };

11435 
	`çed_push
(
æ
, 
soid
);

11436 
	}
}

11438 
	gPrim¬yLogPG
::
çed_push
(cÚ¡ 
li¡
<
pg_sh¬d_t
> &
äom
, cÚ¡ 
hobjeù_t
 &
soid
)

11440 
dout
(20è<< 
	g__func__
 << ": " << 
	gsoid
 << 
	gd’dl
;

11441 
as£¹
(
»cov”šg
.
couÁ
(
soid
));

11442 autØ
	gobc
 = 
»cov”šg
[
soid
];

11443 ià(
	gobc
) {

11444 
	gli¡
<
	gOpReque¡Ref
> 
	gblocked_İs
;

11445 
	gobc
->
drİ_»cov”y_»ad
(&
blocked_İs
);

11446 
»queue_İs
(
blocked_İs
);

11448 
	g»cov”šg
.
”a£
(
soid
);

11449 auto&& 
	gi
 : 
äom
)

11450 
missšg_loc
.
»move_loÿtiÚ
(
soid
, 
i
);

11451 
dout
(0è<< 
	g__func__
 << " " << 
	gsoid
 << " from sh¬d " << 
	gäom


11452 << ",„• Ú " << 
	gmissšg_loc
.
g‘_loÿtiÚs
(
soid
)

11453 << " unfound? " << 
	gmissšg_loc
.
is_unfound
(
soid
è<< 
	gd’dl
;

11454 
fšish_»cov”y_İ
(
soid
);

11457 
ev”siÚ_t
 
	gPrim¬yLogPG
::
	$pick_Ãwe¡_avaabË
(cÚ¡ 
hobjeù_t
& 
oid
)

11459 
ev”siÚ_t
 
v
;

11460 
pg_missšg_™em
 
pmi
;

11461 
boŞ
 
is_missšg
 = 
pg_log
.
	`g‘_missšg
().
	`is_missšg
(
oid
, &
pmi
);

11462 
	`as£¹
(
is_missšg
);

11463 
v
 = 
pmi
.
have
;

11464 
	`dout
(10è<< "pick_Ãwe¡_avaabË " << 
oid
 << " " << 
v
 << " oÀosd." << 
osd
->
whßmi
 << " (loÿl)" << 
d’dl
;

11466 
	`as£¹
(!
aùšg_»cov”y_backfl
.
	`em±y
());

11467 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
aùšg_»cov”y_backfl
.
	`begš
();

11468 
i
 !ğ
aùšg_»cov”y_backfl
.
	`’d
();

11469 ++
i
) {

11470 ià(*
i
 =ğ
	`g‘_´im¬y
()) ;

11471 
pg_sh¬d_t
 
³”
 = *
i
;

11472 ià(!
³”_missšg
[
³”
].
	`is_missšg
(
oid
)) {

11475 
ev”siÚ_t
 
h
 = 
³”_missšg
[
³”
].
	`g‘_™ems
().
	`©
(
oid
).
have
;

11476 
	`dout
(10è<< "pick_Ãwe¡_avaabË " << 
oid
 << " " << 
h
 << " oÀosd." << 
³”
 << 
d’dl
;

11477 ià(
h
 > 
v
)

11478 
v
 = 
h
;

11481 
	`dout
(10è<< "pick_Ãwe¡_avaabË " << 
oid
 << " " << 
v
 << " (Ãwe¡)" << 
d’dl
;

11482  
v
;

11483 
	}
}

11485 
	gPrim¬yLogPG
::
	$do_upd©e_log_missšg
(
OpReque¡Ref
 &
İ
)

11487 cÚ¡ 
MOSDPGUpd©eLogMissšg
 *
m
 = 
¡©ic_ÿ¡
<const MOSDPGUpdateLogMissing*>(

11488 
İ
->
	`g‘_»q
());

11489 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
MSG_OSD_PG_UPDATE_LOG_MISSING
);

11490 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

11491 
boo¡
::
İtiÚ®
<
ev”siÚ_t
> 
İ_Œim_to
, 
İ_rŞl_fÜw¬d_to
;

11492 ià(
m
->
pg_Œim_to
 !ğ
	`ev”siÚ_t
())

11493 
İ_Œim_to
 = 
m
->
pg_Œim_to
;

11494 ià(
m
->
pg_rŞl_fÜw¬d_to
 !ğ
	`ev”siÚ_t
())

11495 
İ_rŞl_fÜw¬d_to
 = 
m
->
pg_rŞl_fÜw¬d_to
;

11497 
	`dout
(20è<< 
__func__
 << " op_Œim_tØğ" << 
İ_Œim_to
 << " op_rŞl_fÜw¬d_tØğ" << 
İ_rŞl_fÜw¬d_to
 << 
d’dl
;

11499 
	`­³nd_log_’Œ›s_upd©e_missšg
(
m
->
’Œ›s
, 
t
, 
İ_Œim_to
, 
İ_rŞl_fÜw¬d_to
);

11500 
ev”siÚ_t
 
Ãw_lcod
 = 
šfo
.
Ï¡_com¶‘e
;

11502 
CÚ‹xt
 *
com¶‘e
 = 
Ãw
 
	`FunùiÚCÚ‹xt
(

11504 cÚ¡ 
MOSDPGUpd©eLogMissšg
 *
msg
 = 
¡©ic_ÿ¡
<const MOSDPGUpdateLogMissing*>(

11505 
İ
->
	`g‘_»q
());

11506 
	`lock
();

11507 ià(!
	`pg_has_»£t_sšû
(
msg
->
	`g‘_•och
())) {

11508 
	`upd©e_Ï¡_com¶‘e_Údisk
(
Ãw_lcod
);

11509 
MOSDPGUpd©eLogMissšgR•ly
 *
»¶y
 =

11510 
Ãw
 
	`MOSDPGUpd©eLogMissšgR•ly
(

11511 
	`¥g_t
(
šfo
.
pgid
.pgid, 
	`´im¬y_sh¬d
().
sh¬d
),

11512 
pg_whßmi
.
sh¬d
,

11513 
msg
->
	`g‘_•och
(),

11514 
msg
->
mš_•och
,

11515 
msg
->
	`g‘_tid
(),

11516 
Ãw_lcod
);

11517 
»¶y
->
	`£t_´iÜ™y
(
CEPH_MSG_PRIO_HIGH
);

11518 
msg
->
	`g‘_cÚÃùiÚ
()->
	`£nd_mes§ge
(
»¶y
);

11520 
	`uÆock
();

11523 ià(
	`g‘_osdm­
()->
»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_KRAKEN
) {

11524 
t
.
	`»gi¡”_Ú_comm™
(
com¶‘e
);

11531 ià(
poŞ
.
šfo
.
	`is_”asu»
()) {

11532 
t
.
	`»gi¡”_Ú_com¶‘e
(
com¶‘e
);

11534 
t
.
	`»gi¡”_Ú_comm™
(
com¶‘e
);

11537 
Œ
 = 
osd
->
¡Üe
->
	`queue_Œª§ùiÚ
(

11538 
ch
,

11539 
¡d
::
	`move
(
t
),

11540 
nuÎ±r
);

11541 
	`as£¹
(
Œ
 == 0);

11542 
	`İ_­¶›d
(
šfo
.
Ï¡_upd©e
);

11543 
	}
}

11545 
	gPrim¬yLogPG
::
	$do_upd©e_log_missšg_»¶y
(
OpReque¡Ref
 &
İ
)

11547 cÚ¡ 
MOSDPGUpd©eLogMissšgR•ly
 *
m
 =

11548 
¡©ic_ÿ¡
<cÚ¡ 
MOSDPGUpd©eLogMissšgR•ly
*>(

11549 
İ
->
	`g‘_»q
());

11550 
	`dout
(20è<< 
__func__
 << " got„eply from "

11551 << 
m
->
	`g‘_äom
(è<< 
d’dl
;

11553 autØ
™
 = 
log_’Œy_upd©e_wa™šg_Ú
.
	`fšd
(
m
->
	`g‘_tid
());

11554 ià(
™
 !ğ
log_’Œy_upd©e_wa™šg_Ú
.
	`’d
()) {

11555 ià(
™
->
£cÚd
.
wa™šg_Ú
.
	`couÁ
(
m
->
	`g‘_äom
())) {

11556 
™
->
£cÚd
.
wa™šg_Ú
.
	`”a£
(
m
->
	`g‘_äom
());

11557 ià(
m
->
Ï¡_com¶‘e_Údisk
 !ğ
	`ev”siÚ_t
()) {

11558 
	`upd©e_³”_Ï¡_com¶‘e_Údisk
(
m
->
	`g‘_äom
(), m->
Ï¡_com¶‘e_Údisk
);

11561 
osd
->
şog
->
	`”rÜ
()

11562 << 
šfo
.
pgid
 << " got„eply "

11563 << *
m
 << " from shard we‡re‚ot waiting for "

11564 << 
m
->
	`g‘_äom
();

11567 ià(
™
->
£cÚd
.
wa™šg_Ú
.
	`em±y
()) {

11568 
	`»pİ_®l_comm™‹d
(
™
->
£cÚd
.
»pİ
.
	`g‘
());

11569 
log_’Œy_upd©e_wa™šg_Ú
.
	`”a£
(
™
);

11572 
osd
->
şog
->
	`”rÜ
()

11573 << 
šfo
.
pgid
 << " got„eply "

11574 << *
m
 << " oÀunknowÀtid " << m->
	`g‘_tid
();

11576 
	}
}

11580 
	gPrim¬yLogPG
::
	$m¬k_®l_unfound_lo¡
(

11581 
wh©
,

11582 
CÚÃùiÚRef
 
cÚ
,

11583 
ûph_tid_t
 
tid
)

11585 
	`dout
(3è<< 
__func__
 << " " << 
pg_log_’Œy_t
::
	`g‘_İ_Çme
(
wh©
è<< 
d’dl
;

11586 
li¡
<
hobjeù_t
> 
oids
;

11588 
	`dout
(30è<< 
__func__
 << ":†og before:\n";

11589 
pg_log
.
	`g‘_log
().
	`´št
(*
_dout
);

11590 *
_dout
 << 
d’dl
;

11592 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> 
log_’Œ›s
;

11594 
utime_t
 
mtime
 = 
	`ûph_şock_now
();

11595 
m­
<
hobjeù_t
, 
pg_missšg_™em
>::
cÚ¡_™”©Ü
 
m
 =

11596 
missšg_loc
.
	`g‘_Ãeds_»cov”y
().
	`begš
();

11597 
m­
<
hobjeù_t
, 
pg_missšg_™em
>::
cÚ¡_™”©Ü
 
m’d
 =

11598 
missšg_loc
.
	`g‘_Ãeds_»cov”y
().
	`’d
();

11600 
ObcLockMªag”
 
mªag”
;

11601 
ev”siÚ_t
 
v
 = 
	`g‘_Ãxt_v”siÚ
();

11602 
v
.
•och
 = 
	`g‘_osdm­
()->
	`g‘_•och
();

11603 
ušt64_t
 
num_unfound
 = 
missšg_loc
.
	`num_unfound
();

11604 
m
 !ğ
m’d
) {

11605 cÚ¡ 
hobjeù_t
 &
	`oid
(
m
->
fœ¡
);

11606 ià(!
missšg_loc
.
	`is_unfound
(
oid
)) {

11608 ++
m
;

11612 
ObjeùCÚ‹xtRef
 
obc
;

11613 
ev”siÚ_t
 
´ev
;

11615 
wh©
) {

11616 
pg_log_’Œy_t
::
LOST_MARK
:

11617 
	`as£¹
(0 == "actually,‚ot implemented yet!");

11620 
pg_log_’Œy_t
::
LOST_REVERT
:

11621 
´ev
 = 
	`pick_Ãwe¡_avaabË
(
oid
);

11622 ià(
´ev
 > 
	`ev”siÚ_t
()) {

11624 
pg_log_’Œy_t
 
	`e
(

11625 
pg_log_’Œy_t
::
LOST_REVERT
, 
oid
, 
v
,

11626 
m
->
£cÚd
.
Ãed
, 0, 
	`osd_»qid_t
(), 
mtime
, 0);

11627 
e
.
»v”tšg_to
 = 
´ev
;

11628 
e
.
	`m¬k_uÄŞlbackabË
();

11629 
log_’Œ›s
.
	`push_back
(
e
);

11630 
	`dout
(10è<< 
e
 << 
d’dl
;

11633 ++
v
.
v”siÚ
;

11634 ++
m
;

11638 
pg_log_’Œy_t
::
LOST_DELETE
:

11640 
pg_log_’Œy_t
 
	`e
Õg_log_’Œy_t::
LOST_DELETE
, 
oid
, 
v
, 
m
->
£cÚd
.
Ãed
,

11641 0, 
	`osd_»qid_t
(), 
mtime
, 0);

11642 ià(
	`g‘_osdm­
()->
»quœe_osd_»Ëa£
 >ğ
CEPH_RELEASE_JEWEL
) {

11643 ià(
poŞ
.
šfo
.
	`»quœe_rŞlback
()) {

11644 
e
.
mod_desc
.
	`Œy_rmobjeù
(
v
.
v”siÚ
);

11646 
e
.
	`m¬k_uÄŞlbackabË
();

11649 
	`dout
(10è<< 
e
 << 
d’dl
;

11650 
log_’Œ›s
.
	`push_back
(
e
);

11651 
oids
.
	`push_back
(
oid
);

11656 
obc
 = 
objeù_cÚ‹xts
.
	`lookup
(
oid
);

11657 ià(
obc
)

11658 
obc
->
obs
.
exi¡s
 = 
çl£
;

11660 ++
v
.
v”siÚ
;

11661 ++
m
;

11666 
	`ûph_abÜt
();

11670 
šfo
.
¡©s
.
¡©s_šv®id
 = 
Œue
;

11672 
	`subm™_log_’Œ›s
(

11673 
log_’Œ›s
,

11674 
¡d
::
	`move
(
mªag”
),

11675 
boo¡
::
İtiÚ®
<
¡d
::
funùiÚ
<()> >(

11676 [
this
, 
oids
, 
cÚ
, 
num_unfound
, 
tid
]() {

11677 ià(
	`³rfÜm_d–‘es_duršg_³”šg
()) {

11678 autØ
oid
 : 
oids
) {

11682 
missšg_loc
.
	`»cov”ed
(
oid
);

11686 ià(
	`is_»cov”y_unfound
()) {

11687 
	`queue_³”šg_ev’t
(

11688 
	`PGP“ršgEv’tRef
(

11689 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

11690 
	`g‘_osdm­
()->
	`g‘_•och
(),

11691 
	`g‘_osdm­
()->
	`g‘_•och
(),

11692 
	`DoRecov”y
())));

11693 } ià(
	`is_backfl_unfound
()) {

11694 
	`queue_³”šg_ev’t
(

11695 
	`PGP“ršgEv’tRef
(

11696 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

11697 
	`g‘_osdm­
()->
	`g‘_•och
(),

11698 
	`g‘_osdm­
()->
	`g‘_•och
(),

11699 
	`Reque¡Backfl
())));

11701 
	`queue_»cov”y
();

11704 
¡ršg¡»am
 
ss
;

11705 
ss
 << "pg ha " << 
num_unfound


11707 
¡ršg
 
rs
 = 
ss
.
	`¡r
();

11708 
	`dout
(0è<< "do_commªd„=" << 0 << " " << 
rs
 << 
d’dl
;

11709 
osd
->
şog
->
	`šfo
(è<< 
rs
;

11710 ià(
cÚ
) {

11711 
MCommªdR•ly
 *
»¶y
 = 
Ãw
 
	`MCommªdR•ly
(0, 
rs
);

11712 
»¶y
->
	`£t_tid
(
tid
);

11713 
cÚ
->
	`£nd_mes§ge
(
»¶y
);

11716 
	`OpReque¡Ref
());

11717 
	}
}

11719 
	gPrim¬yLogPG
::
	$_¥l™_što
(
pg_t
 
chd_pgid
, 
PG
 *
chd
, 
¥l™_b™s
)

11721 
	`as£¹
(
»pİ_queue
.
	`em±y
());

11722 
	}
}

11728 
	gPrim¬yLogPG
::
	$­¶y_ªd_æush_»pİs
(
boŞ
 
»queue
)

11730 
li¡
<
OpReque¡Ref
> 
rq
;

11733 !
»pİ_queue
.
	`em±y
()) {

11734 
R•G©h”
 *
»pİ
 = 
»pİ_queue
.
	`äÚt
();

11735 
»pİ_queue
.
	`pİ_äÚt
();

11736 
	`dout
(10è<< " cªûlšg„•İid " << 
»pİ
->
»p_tid
 << 
d’dl
;

11737 
»pİ
->
»p_abÜ‹d
 = 
Œue
;

11738 
»pİ
->
Ú_comm™‹d
.
	`ş—r
();

11739 
»pİ
->
Ú_sucûss
.
	`ş—r
();

11741 ià(
»queue
) {

11742 ià(
»pİ
->
İ
) {

11743 
	`dout
(10è<< "„equeušg " << *
»pİ
->
İ
->
	`g‘_»q
(è<< 
d’dl
;

11744 
rq
.
	`push_back
(
»pİ
->
İ
);

11745 
»pİ
->
İ
 = 
	`OpReque¡Ref
();

11749 
m­
<
ev”siÚ_t
, 
li¡
<
·œ
<
OpReque¡Ref
, 
v”siÚ_t
> > >::
™”©Ü
 
p
 =

11750 
wa™šg_fÜ_Údisk
.
	`fšd
(
»pİ
->
v
);

11751 ià(
p
 !ğ
wa™šg_fÜ_Údisk
.
	`’d
()) {

11752 
	`dout
(10è<< "‡lsØ»queušg ondisk wa™” " << 
p
->
£cÚd
 << 
d’dl
;

11753 
li¡
<
·œ
<
OpReque¡Ref
, 
v”siÚ_t
> >::
™”©Ü
 
i
 =

11754 
p
->
£cÚd
.
	`begš
();

11755 
i
 !ğ
p
->
£cÚd
.
	`’d
();

11756 ++
i
) {

11757 
rq
.
	`push_back
(
i
->
fœ¡
);

11759 
wa™šg_fÜ_Údisk
.
	`”a£
(
p
);

11763 
	`»move_»pİ
(
»pİ
);

11766 
	`as£¹
(
»pİ_queue
.
	`em±y
());

11768 ià(
»queue
) {

11769 
	`»queue_İs
(
rq
);

11770 ià(!
wa™šg_fÜ_Údisk
.
	`em±y
()) {

11771 
m­
<
ev”siÚ_t
, 
li¡
<
·œ
<
OpReque¡Ref
, 
v”siÚ_t
> > >::
™”©Ü
 
i
 =

11772 
wa™šg_fÜ_Údisk
.
	`begš
();

11773 
i
 !ğ
wa™šg_fÜ_Údisk
.
	`’d
();

11774 ++
i
) {

11775 
li¡
<
·œ
<
OpReque¡Ref
, 
v”siÚ_t
> >::
™”©Ü
 
j
 =

11776 
i
->
£cÚd
.
	`begš
();

11777 
j
 !ğ
i
->
£cÚd
.
	`’d
();

11778 ++
j
) {

11779 
d”r
 << 
__func__
 << ": o°" << *(
j
->
fœ¡
->
	`g‘_»q
()) << " waiting on "

11780 << 
i
->
fœ¡
 << 
d’dl
;

11783 
	`as£¹
(
wa™šg_fÜ_Údisk
.
	`em±y
());

11787 
wa™šg_fÜ_Údisk
.
	`ş—r
();

11788 
	}
}

11790 
	gPrim¬yLogPG
::
	$Ú_æushed
()

11792 
	`as£¹
(
æushes_š_´og»ss
 > 0);

11793 
æushes_š_´og»ss
--;

11794 ià(
æushes_š_´og»ss
 == 0) {

11795 
	`»queue_İs
(
wa™šg_fÜ_æush
);

11797 ià(!
	`is_³”ed
(è|| !
	`is_´im¬y
()) {

11798 
·œ
<
hobjeù_t
, 
ObjeùCÚ‹xtRef
> 
i
;

11799 
objeù_cÚ‹xts
.
	`g‘_Ãxt
(
i
.
fœ¡
, &i)) {

11800 
d”r
 << 
__func__
 << ": objeù " << 
i
.
fœ¡
 << " obø¡È®ive" << 
d’dl
;

11802 
	`as£¹
(
objeù_cÚ‹xts
.
	`em±y
());

11804 
	}
}

11806 
	gPrim¬yLogPG
::
	$Ú_»mov®
(
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

11808 
	`dout
(10è<< 
__func__
 << 
d’dl
;

11811 
šfo
.
	`£t_Ï¡_backfl
(
	`hobjeù_t
());

11812 
pg_log
.
	`»£t_backfl
();

11813 
dœty_šfo
 = 
Œue
;

11816 
PGLogEÁryHªdËr
 
rŞlback”
{
this
, 
t
};

11817 
pg_log
.
	`rŞl_fÜw¬d
(&
rŞlback”
);

11819 
	`Ú_shutdown
();

11820 
	}
}

11822 
	gPrim¬yLogPG
::
	$ş—r_async_»ads
()

11824 
	`dout
(10è<< 
__func__
 << 
d’dl
;

11825 auto& 
i
 : 
š_´og»ss_async_»ads
) {

11826 
	`dout
(10) << "clear ctx: "

11827 << "OpReque¡Reà" << 
i
.
fœ¡


11828 << " OpCÚ‹xˆ" << 
i
.
£cÚd


11829 << 
d’dl
;

11830 
	`şo£_İ_ùx
(
i
.
£cÚd
);

11832 
	}
}

11834 
	gPrim¬yLogPG
::
	$Ú_shutdown
()

11836 
	`dout
(10è<< 
__func__
 << 
d’dl
;

11839 
d–‘šg
 = 
Œue
;

11841 ià(
»cov”y_queued
) {

11842 
»cov”y_queued
 = 
çl£
;

11843 
osd
->
	`ş—r_queued_»cov”y
(
this
);

11846 
	`ş—r_süub_»£rved
();

11847 
	`süub_ş—r_¡©e
();

11849 
	`uÄeg_Ãxt_süub
();

11851 
veùÜ
<
ûph_tid_t
> 
tids
;

11852 
	`ÿnûl_cİy_İs
(
çl£
, &
tids
);

11853 
	`ÿnûl_æush_İs
(
çl£
, &
tids
);

11854 
	`ÿnûl_´oxy_İs
(
çl£
, &
tids
);

11855 
osd
->
objeù”
->
	`İ_ÿnûl
(
tids
, -
ECANCELED
);

11857 
	`­¶y_ªd_æush_»pİs
(
çl£
);

11858 
	`ÿnûl_log_upd©es
();

11860 
	`ş—r_backoffs
();

11862 
¢­_Œimm”_machše
.
	`´oûss_ev’t
(
	`Re£t
());

11864 
pgback’d
->
	`Ú_chªge
();

11866 
	`cÚ‹xt_»gi¡ry_Ú_chªge
();

11867 
objeù_cÚ‹xts
.
	`ş—r
();

11869 
	`ş—r_async_»ads
();

11871 
osd
->
»mÙe_»£rv”
.
	`ÿnûl_»£rv©iÚ
(
šfo
.
pgid
);

11872 
osd
->
loÿl_»£rv”
.
	`ÿnûl_»£rv©iÚ
(
šfo
.
pgid
);

11874 
	`ş—r_´im¬y_¡©e
();

11875 
	`ÿnûl_»cov”y
();

11876 
	}
}

11878 
	gPrim¬yLogPG
::
	$Ú_aùiv©e
()

11881 ià(
	`Ãeds_»cov”y
()) {

11882 
	`dout
(10è<< "aùiv©nÙ‡Î„•liÿ ¬up-to-d©e, queuešg„ecov”y" << 
d’dl
;

11883 
	`queue_³”šg_ev’t
(

11884 
	`PGP“ršgEv’tRef
(

11885 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

11886 
	`g‘_osdm­
()->
	`g‘_•och
(),

11887 
	`g‘_osdm­
()->
	`g‘_•och
(),

11888 
	`DoRecov”y
())));

11889 } ià(
	`Ãeds_backfl
()) {

11890 
	`dout
(10è<< "aùiv©queuešg backfl" << 
d’dl
;

11891 
	`queue_³”šg_ev’t
(

11892 
	`PGP“ršgEv’tRef
(

11893 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

11894 
	`g‘_osdm­
()->
	`g‘_•och
(),

11895 
	`g‘_osdm­
()->
	`g‘_•och
(),

11896 
	`Reque¡Backfl
())));

11898 
	`dout
(10è<< "aùiv©®È»¶iÿ ş—n,‚Ø»cov”y" << 
d’dl
;

11899 
eio_”rÜs_to_´oûss
 = 
çl£
;

11900 
	`queue_³”šg_ev’t
(

11901 
	`PGP“ršgEv’tRef
(

11902 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

11903 
	`g‘_osdm­
()->
	`g‘_•och
(),

11904 
	`g‘_osdm­
()->
	`g‘_•och
(),

11905 
	`AÎR•liÿsRecov”ed
())));

11908 
	`publish_¡©s_to_osd
();

11910 ià(!
backfl_rg‘s
.
	`em±y
()) {

11911 
Ï¡_backfl_¡¬‹d
 = 
	`—¾›¡_backfl
();

11912 
Ãw_backfl
 = 
Œue
;

11913 
	`as£¹
(!
Ï¡_backfl_¡¬‹d
.
	`is_max
());

11914 
	`dout
(5è<< 
__func__
 << ": bá=" << 
backfl_rg‘s


11915 << " from " << 
Ï¡_backfl_¡¬‹d
 << 
d’dl
;

11916 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
backfl_rg‘s
.
	`begš
();

11917 
i
 !ğ
backfl_rg‘s
.
	`’d
();

11918 ++
i
) {

11919 
	`dout
(5è<< "rg‘ sh¬d " << *
i


11920 << " from " << 
³”_šfo
[*
i
].
Ï¡_backfl


11921 << 
d’dl
;

11925 
	`h™_£t_£tup
();

11926 
	`ag’t_£tup
();

11927 
	}
}

11929 
	gPrim¬yLogPG
::
	$_Ú_Ãw_š‹rv®
()

11931 
	`dout
(20è<< 
__func__
 << " checkšg missšg s‘ d–‘e æag. missšg = " << 
pg_log
.
	`g‘_missšg
(è<< 
d’dl
;

11932 ià(!
pg_log
.
	`g‘_missšg
().
may_šşude_d–‘es
 &&

11933 
	`g‘_osdm­
()->
	`‹¡_æag
(
CEPH_OSDMAP_RECOVERY_DELETES
)) {

11934 
pg_log
.
	`»bud_missšg_£t_w™h_d–‘es
(
osd
->
¡Üe
, 
ch
, 
šfo
);

11936 
	`as£¹
(
pg_log
.
	`g‘_missšg
().
may_šşude_d–‘es
 =ğ
	`g‘_osdm­
()->
	`‹¡_æag
(
CEPH_OSDMAP_RECOVERY_DELETES
));

11937 
	}
}

11939 
	gPrim¬yLogPG
::
	$Ú_chªge
(
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

11941 
	`dout
(10è<< 
__func__
 << 
d’dl
;

11943 ià(
h™_£t
 && h™_£t->
	`š£¹_couÁ
() == 0) {

11944 
	`dout
(20è<< " disÿrdšgƒm±y h™_£t" << 
d’dl
;

11945 
	`h™_£t_ş—r
();

11948 ià(
»cov”y_queued
) {

11949 
»cov”y_queued
 = 
çl£
;

11950 
osd
->
	`ş—r_queued_»cov”y
(
this
);

11955 
	`»queue_İs
(
wa™šg_fÜ_³”ed
);

11956 
	`»queue_İs
(
wa™šg_fÜ_æush
);

11957 
	`»queue_İs
(
wa™šg_fÜ_aùive
);

11959 
	`ş—r_süub_»£rved
();

11961 
veùÜ
<
ûph_tid_t
> 
tids
;

11962 
	`ÿnûl_cİy_İs
(
	`is_´im¬y
(), &
tids
);

11963 
	`ÿnûl_æush_İs
(
	`is_´im¬y
(), &
tids
);

11964 
	`ÿnûl_´oxy_İs
(
	`is_´im¬y
(), &
tids
);

11965 
osd
->
objeù”
->
	`İ_ÿnûl
(
tids
, -
ECANCELED
);

11968 auto& 
p
 : 
wa™šg_fÜ_uÄ—dabË_objeù
) {

11969 
	`»Ëa£_backoffs
(
p
.
fœ¡
);

11971 ià(
	`is_´im¬y
()) {

11972 
	`»queue_objeù_wa™”s
(
wa™šg_fÜ_uÄ—dabË_objeù
);

11974 
wa™šg_fÜ_uÄ—dabË_objeù
.
	`ş—r
();

11976 
m­
<
hobjeù_t
,
li¡
<
OpReque¡Ref
>>::
™”©Ü
 
p
 = 
wa™šg_fÜ_deg¿ded_objeù
.
	`begš
();

11977 
p
 !ğ
wa™šg_fÜ_deg¿ded_objeù
.
	`’d
();

11978 
wa™šg_fÜ_deg¿ded_objeù
.
	`”a£
(
p
++)) {

11979 
	`»Ëa£_backoffs
(
p
->
fœ¡
);

11980 ià(
	`is_´im¬y
())

11981 
	`»queue_İs
(
p
->
£cÚd
);

11983 
p
->
£cÚd
.
	`ş—r
();

11984 
	`fšish_deg¿ded_objeù
(
p
->
fœ¡
);

11988 
	`süub_ş—r_¡©e
();

11990 autØ
p
 = 
wa™šg_fÜ_blocked_objeù
.
	`begš
();

11991 
p
 !ğ
wa™šg_fÜ_blocked_objeù
.
	`’d
();

11992 
wa™šg_fÜ_blocked_objeù
.
	`”a£
(
p
++)) {

11993 ià(
	`is_´im¬y
())

11994 
	`»queue_İs
(
p
->
£cÚd
);

11996 
p
->
£cÚd
.
	`ş—r
();

11998 autØ
i
 = 
ÿÎbacks_fÜ_deg¿ded_objeù
.
	`begš
();

11999 
i
 !ğ
ÿÎbacks_fÜ_deg¿ded_objeù
.
	`’d
();

12001 
	`fšish_deg¿ded_objeù
((
i
++)->
fœ¡
);

12003 
	`as£¹
(
ÿÎbacks_fÜ_deg¿ded_objeù
.
	`em±y
());

12005 ià(
	`is_´im¬y
()) {

12006 
	`»queue_İs
(
wa™šg_fÜ_ÿche_nÙ_fuÎ
);

12008 
wa™šg_fÜ_ÿche_nÙ_fuÎ
.
	`ş—r
();

12010 
objeùs_blocked_Ú_ÿche_fuÎ
.
	`ş—r
();

12012 
li¡
<
·œ
<
OpReque¡Ref
, 
OpCÚ‹xt
*> >::
™”©Ü
 
i
 =

12013 
š_´og»ss_async_»ads
.
	`begš
();

12014 
i
 !ğ
š_´og»ss_async_»ads
.
	`’d
();

12015 
š_´og»ss_async_»ads
.
	`”a£
(
i
++)) {

12016 
	`şo£_İ_ùx
(
i
->
£cÚd
);

12017 ià(
	`is_´im¬y
())

12018 
	`»queue_İ
(
i
->
fœ¡
);

12023 
	`­¶y_ªd_æush_»pİs
(
	`is_´im¬y
());

12024 
	`ÿnûl_log_upd©es
();

12028 
	`cÚ‹xt_»gi¡ry_Ú_chªge
();

12030 
pgback’d
->
	`Ú_chªge_ş—nup
(
t
);

12031 
süubb”
.
	`ş—nup_¡Üe
(
t
);

12032 
pgback’d
->
	`Ú_chªge
();

12035 
¢­_Œimm”_machše
.
	`´oûss_ev’t
(
	`Re£t
());

12037 
debug_İ_Üd”
.
	`ş—r
();

12038 
un¡abË_¡©s
.
	`ş—r
();

12043 
objeù_cÚ‹xts
.
	`ş—r
();

12046 
	`as£¹
(
objeùs_blocked_Ú_deg¿ded_¢­
.
	`em±y
());

12047 
	}
}

12049 
	gPrim¬yLogPG
::
	$Ú_rŞe_chªge
()

12051 
	`dout
(10è<< 
__func__
 << 
d’dl
;

12052 ià(
	`g‘_rŞe
(è!ğ0 && 
h™_£t
) {

12053 
	`dout
(10è<< " cË¬šg h™ s‘" << 
d’dl
;

12054 
	`h™_£t_ş—r
();

12056 
	}
}

12058 
	gPrim¬yLogPG
::
	$Ú_poŞ_chªge
()

12060 
	`dout
(10è<< 
__func__
 << 
d’dl
;

12065 ià(
	`is_aùive
() &&

12066 
poŞ
.
šfo
.
ÿche_mode
 !ğ
pg_poŞ_t
::
CACHEMODE_WRITEBACK
 &&

12067 !
wa™šg_fÜ_ÿche_nÙ_fuÎ
.
	`em±y
()) {

12068 
	`dout
(10è<< 
__func__
 << "„equeuing full waiters (not in writeback) "

12069 << 
d’dl
;

12070 
	`»queue_İs
(
wa™šg_fÜ_ÿche_nÙ_fuÎ
);

12071 
objeùs_blocked_Ú_ÿche_fuÎ
.
	`ş—r
();

12073 
	`h™_£t_£tup
();

12074 
	`ag’t_£tup
();

12075 
	}
}

12078 
	gPrim¬yLogPG
::
	$_ş—r_»cov”y_¡©e
()

12080 
missšg_loc
.
	`ş—r
();

12081 #ifdeà
DEBUG_RECOVERY_OIDS


12082 
»cov”šg_oids
.
	`ş—r
();

12084 
Ï¡_backfl_¡¬‹d
 = 
	`hobjeù_t
();

12085 
£t
<
hobjeù_t
>::
™”©Ü
 
i
 = 
backfls_š_æight
.
	`begš
();

12086 
i
 !ğ
backfls_š_æight
.
	`’d
()) {

12087 
	`as£¹
(
»cov”šg
.
	`couÁ
(*
i
));

12088 
backfls_š_æight
.
	`”a£
(
i
++);

12091 
li¡
<
OpReque¡Ref
> 
blocked_İs
;

12092 
m­
<
hobjeù_t
, 
ObjeùCÚ‹xtRef
>::
™”©Ü
 
i
 = 
»cov”šg
.
	`begš
();

12093 
i
 !ğ
»cov”šg
.
	`’d
();

12094 
»cov”šg
.
	`”a£
(
i
++)) {

12095 ià(
i
->
£cÚd
) {

12096 
i
->
£cÚd
->
	`drİ_»cov”y_»ad
(&
blocked_İs
);

12097 
	`»queue_İs
(
blocked_İs
);

12100 
	`as£¹
(
backfls_š_æight
.
	`em±y
());

12101 
³ndšg_backfl_upd©es
.
	`ş—r
();

12102 
	`as£¹
(
»cov”šg
.
	`em±y
());

12103 
pgback’d
->
	`ş—r_»cov”y_¡©e
();

12104 
	}
}

12106 
	gPrim¬yLogPG
::
	$ÿnûl_puÎ
(cÚ¡ 
hobjeù_t
 &
soid
)

12108 
	`dout
(20è<< 
__func__
 << ": " << 
soid
 << 
d’dl
;

12109 
	`as£¹
(
»cov”šg
.
	`couÁ
(
soid
));

12110 
ObjeùCÚ‹xtRef
 
obc
 = 
»cov”šg
[
soid
];

12111 ià(
obc
) {

12112 
li¡
<
OpReque¡Ref
> 
blocked_İs
;

12113 
obc
->
	`drİ_»cov”y_»ad
(&
blocked_İs
);

12114 
	`»queue_İs
(
blocked_İs
);

12116 
»cov”šg
.
	`”a£
(
soid
);

12117 
	`fšish_»cov”y_İ
(
soid
);

12118 
	`»Ëa£_backoffs
(
soid
);

12119 ià(
wa™šg_fÜ_deg¿ded_objeù
.
	`couÁ
(
soid
)) {

12120 
	`dout
(20è<< " kickšg deg¿ded wa™” Ú " << 
soid
 << 
d’dl
;

12121 
	`»queue_İs
(
wa™šg_fÜ_deg¿ded_objeù
[
soid
]);

12122 
wa™šg_fÜ_deg¿ded_objeù
.
	`”a£
(
soid
);

12124 ià(
wa™šg_fÜ_uÄ—dabË_objeù
.
	`couÁ
(
soid
)) {

12125 
	`dout
(20è<< " kickšg uÄ—dabË wa™” Ú " << 
soid
 << 
d’dl
;

12126 
	`»queue_İs
(
wa™šg_fÜ_uÄ—dabË_objeù
[
soid
]);

12127 
wa™šg_fÜ_uÄ—dabË_objeù
.
	`”a£
(
soid
);

12129 ià(
	`is_missšg_objeù
(
soid
))

12130 
pg_log
.
	`£t_Ï¡_»que¡ed
(0);

12131 
	`fšish_deg¿ded_objeù
(
soid
);

12132 
	}
}

12134 
	gPrim¬yLogPG
::
	$check_»cov”y_sourûs
(cÚ¡ 
OSDM­Ref
& 
osdm­
)

12140 
missšg_loc
.
	`check_»cov”y_sourûs
(
osdm­
);

12141 
pgback’d
->
	`check_»cov”y_sourûs
(
osdm­
);

12143 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
³”_log_»que¡ed
.
	`begš
();

12144 
i
 !ğ
³”_log_»que¡ed
.
	`’d
();

12146 ià(!
osdm­
->
	`is_up
(
i
->
osd
)) {

12147 
	`dout
(10è<< "³”_log_»que¡ed„emovšg " << *
i
 << 
d’dl
;

12148 
³”_log_»que¡ed
.
	`”a£
(
i
++);

12150 ++
i
;

12154 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
³”_missšg_»que¡ed
.
	`begš
();

12155 
i
 !ğ
³”_missšg_»que¡ed
.
	`’d
();

12157 ià(!
osdm­
->
	`is_up
(
i
->
osd
)) {

12158 
	`dout
(10è<< "³”_missšg_»que¡ed„emovšg " << *
i
 << 
d’dl
;

12159 
³”_missšg_»que¡ed
.
	`”a£
(
i
++);

12161 ++
i
;

12164 
	}
}

12166 
boŞ
 
	gPrim¬yLogPG
::
	$¡¬t_»cov”y_İs
(

12167 
ušt64_t
 
max
,

12168 
Th»adPoŞ
::
TPHªdË
 &
hªdË
,

12169 
ušt64_t
 *
İs_¡¬‹d
)

12171 
ušt64_t
& 
¡¬‹d
 = *
İs_¡¬‹d
;

12172 
¡¬‹d
 = 0;

12173 
boŞ
 
wÜk_š_´og»ss
 = 
çl£
;

12174 
boŞ
 
»cov”y_¡¬‹d
 = 
çl£
;

12175 
	`as£¹
(
	`is_´im¬y
());

12176 
	`as£¹
(
	`is_³”ed
());

12177 
	`as£¹
(!
	`is_d–‘šg
());

12179 
	`as£¹
(
»cov”y_queued
);

12180 
»cov”y_queued
 = 
çl£
;

12182 ià(!
	`¡©e_‹¡
(
PG_STATE_RECOVERING
) &&

12183 !
	`¡©e_‹¡
(
PG_STATE_BACKFILLING
)) {

12186 
	`dout
(10è<< "»cov”y„aûd‡nd w”queuedwiû, ignÜšg!" << 
d’dl
;

12187  
	`have_unfound
();

12190 cÚ¡‡utØ&
missšg
 = 
pg_log
.
	`g‘_missšg
();

12192 
num_missšg
 = 
missšg
.
	`num_missšg
();

12193 
ušt64_t
 
num_unfound
 = 
	`g‘_num_unfound
();

12195 ià(
num_missšg
 == 0) {

12196 
šfo
.
Ï¡_com¶‘e
 = info.
Ï¡_upd©e
;

12199 ià(
num_missšg
 =ğ
num_unfound
) {

12202 
¡¬‹d
 = 
	`»cov”_»¶iÿs
(
max
, 
hªdË
, &
»cov”y_¡¬‹d
);

12204 ià(!
¡¬‹d
) {

12206 
¡¬‹d
 +ğ
	`»cov”_´im¬y
(
max
, 
hªdË
);

12208 ià(!
¡¬‹d
 && 
num_unfound
 !ğ
	`g‘_num_unfound
()) {

12210 
¡¬‹d
 = 
	`»cov”_»¶iÿs
(
max
, 
hªdË
, &
»cov”y_¡¬‹d
);

12213 ià(
¡¬‹d
 || 
»cov”y_¡¬‹d
)

12214 
wÜk_š_´og»ss
 = 
Œue
;

12216 
boŞ
 
deã¼ed_backfl
 = 
çl£
;

12217 ià(
»cov”šg
.
	`em±y
() &&

12218 
	`¡©e_‹¡
(
PG_STATE_BACKFILLING
) &&

12219 !
backfl_rg‘s
.
	`em±y
(è&& 
¡¬‹d
 < 
max
 &&

12220 
missšg
.
	`num_missšg
() == 0 &&

12221 
wa™šg_Ú_backfl
.
	`em±y
()) {

12222 ià(
	`g‘_osdm­
()->
	`‹¡_æag
(
CEPH_OSDMAP_NOBACKFILL
)) {

12223 
	`dout
(10è<< "deã¼šg backfÈdutØNOBACKFILL" << 
d’dl
;

12224 
deã¼ed_backfl
 = 
Œue
;

12225 } ià(
	`g‘_osdm­
()->
	`‹¡_æag
(
CEPH_OSDMAP_NOREBALANCE
) &&

12226 !
	`is_deg¿ded
()) {

12227 
	`dout
(10è<< "deã¼šg backfÈdutØNOREBALANCE" << 
d’dl
;

12228 
deã¼ed_backfl
 = 
Œue
;

12229 } ià(!
backfl_»£rved
) {

12230 
	`dout
(10è<< "deã¼šg backfÈdutØ!backfl_»£rved" << 
d’dl
;

12231 ià(!
backfl_»£rvšg
) {

12232 
	`dout
(10è<< "queuešg Reque¡Backfl" << 
d’dl
;

12233 
backfl_»£rvšg
 = 
Œue
;

12234 
	`queue_³”šg_ev’t
(

12235 
	`PGP“ršgEv’tRef
(

12236 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

12237 
	`g‘_osdm­
()->
	`g‘_•och
(),

12238 
	`g‘_osdm­
()->
	`g‘_•och
(),

12239 
	`Reque¡Backfl
())));

12241 
deã¼ed_backfl
 = 
Œue
;

12243 
¡¬‹d
 +ğ
	`»cov”_backfl
(
max
 - s¹ed, 
hªdË
, &
wÜk_š_´og»ss
);

12247 
	`dout
(10è<< " s¹ed " << 
¡¬‹d
 << 
d’dl
;

12248 
osd
->
logg”
->
	`šc
(
l_osd_rİ
, 
¡¬‹d
);

12250 ià(!
»cov”šg
.
	`em±y
() ||

12251 
wÜk_š_´og»ss
 || 
»cov”y_İs_aùive
 > 0 || 
deã¼ed_backfl
)

12252  !
wÜk_š_´og»ss
 && 
	`have_unfound
();

12254 
	`as£¹
(
»cov”šg
.
	`em±y
());

12255 
	`as£¹
(
»cov”y_İs_aùive
 == 0);

12257 
	`dout
(10è<< 
__func__
 << "‚eeds_recovery: "

12258 << 
missšg_loc
.
	`g‘_Ãeds_»cov”y
()

12259 << 
d’dl
;

12260 
	`dout
(10è<< 
__func__
 << " missing_loc: "

12261 << 
missšg_loc
.
	`g‘_missšg_locs
()

12262 << 
d’dl
;

12263 
unfound
 = 
	`g‘_num_unfound
();

12264 ià(
unfound
) {

12265 
	`dout
(10è<< " stÈhav" << 
unfound
 << " unfound" << 
d’dl
;

12266  
Œue
;

12269 ià(
missšg
.
	`num_missšg
() > 0) {

12271 
osd
->
şog
->
	`”rÜ
(è<< 
šfo
.
pgid
 << " Unexpected Error:„ecoveryƒnding with "

12272 << 
missšg
.
	`num_missšg
(è<< ": " << missšg.
	`g‘_™ems
();

12273  
çl£
;

12276 ià(
	`Ãeds_»cov”y
()) {

12279 
osd
->
şog
->
	`”rÜ
(è<< 
šfo
.
pgid


12281  
çl£
;

12284 ià(
	`¡©e_‹¡
(
PG_STATE_RECOVERING
)) {

12285 
	`¡©e_ş—r
(
PG_STATE_RECOVERING
);

12286 
	`¡©e_ş—r
(
PG_STATE_FORCED_RECOVERY
);

12287 ià(
	`Ãeds_backfl
()) {

12288 
	`dout
(10è<< "»cov”y dÚe, queušg backfl" << 
d’dl
;

12289 
	`queue_³”šg_ev’t
(

12290 
	`PGP“ršgEv’tRef
(

12291 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

12292 
	`g‘_osdm­
()->
	`g‘_•och
(),

12293 
	`g‘_osdm­
()->
	`g‘_•och
(),

12294 
	`Reque¡Backfl
())));

12296 
	`dout
(10è<< "»cov”y dÚe,‚Øbackfl" << 
d’dl
;

12297 
eio_”rÜs_to_´oûss
 = 
çl£
;

12298 
	`¡©e_ş—r
(
PG_STATE_FORCED_BACKFILL
);

12299 
	`queue_³”šg_ev’t
(

12300 
	`PGP“ršgEv’tRef
(

12301 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

12302 
	`g‘_osdm­
()->
	`g‘_•och
(),

12303 
	`g‘_osdm­
()->
	`g‘_•och
(),

12304 
	`AÎR•liÿsRecov”ed
())));

12307 
	`¡©e_ş—r
(
PG_STATE_BACKFILLING
);

12308 
	`¡©e_ş—r
(
PG_STATE_FORCED_BACKFILL
);

12309 
	`¡©e_ş—r
(
PG_STATE_FORCED_RECOVERY
);

12310 
	`dout
(10è<< "»cov”y dÚe, backfÈdÚe" << 
d’dl
;

12311 
eio_”rÜs_to_´oûss
 = 
çl£
;

12312 
	`queue_³”šg_ev’t
(

12313 
	`PGP“ršgEv’tRef
(

12314 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

12315 
	`g‘_osdm­
()->
	`g‘_•och
(),

12316 
	`g‘_osdm­
()->
	`g‘_•och
(),

12317 
	`BackfËd
())));

12320  
çl£
;

12321 
	}
}

12327 
ušt64_t
 
	gPrim¬yLogPG
::
	$»cov”_´im¬y
(
ušt64_t
 
max
, 
Th»adPoŞ
::
TPHªdË
 &
hªdË
)

12329 
	`as£¹
(
	`is_´im¬y
());

12331 cÚ¡‡utØ&
missšg
 = 
pg_log
.
	`g‘_missšg
();

12333 
	`dout
(10è<< 
__func__
 << "„ecov”šg " << 
»cov”šg
.
	`size
()

12335 << " missšg " << 
missšg
 << 
d’dl
;

12337 
	`dout
(25è<< 
__func__
 << " " << 
missšg
.
	`g‘_™ems
(è<< 
d’dl
;

12340 
pg_log_’Œy_t
 *
Ï‹¡
 = 0;

12341 
¡¬‹d
 = 0;

12342 
sk³d
 = 0;

12344 
PGBack’d
::
Recov”yHªdË
 *
h
 = 
pgback’d
->
	`İ’_»cov”y_İ
();

12345 
m­
<
v”siÚ_t
, 
hobjeù_t
>::
cÚ¡_™”©Ü
 
p
 =

12346 
missšg
.
	`g‘_rmissšg
().
	`low”_bound
(
pg_log
.
	`g‘_log
().
Ï¡_»que¡ed
);

12347 
p
 !ğ
missšg
.
	`g‘_rmissšg
().
	`’d
()) {

12348 
hªdË
.
	`»£t__timeout
();

12349 
hobjeù_t
 
soid
;

12350 
v”siÚ_t
 
v
 = 
p
->
fœ¡
;

12352 autØ
™_objeùs
 = 
pg_log
.
	`g‘_log
().
objeùs
.
	`fšd
(
p
->
£cÚd
);

12353 ià(
™_objeùs
 !ğ
pg_log
.
	`g‘_log
().
objeùs
.
	`’d
()) {

12354 
Ï‹¡
 = 
™_objeùs
->
£cÚd
;

12355 
	`as£¹
(
Ï‹¡
->
	`is_upd©e
(è||†©e¡->
	`is_d–‘e
());

12356 
soid
 = 
Ï‹¡
->soid;

12358 
Ï‹¡
 = 0;

12359 
soid
 = 
p
->
£cÚd
;

12361 cÚ¡ 
pg_missšg_™em
& 
™em
 = 
missšg
.
	`g‘_™ems
().
	`fšd
(
p
->
£cÚd
)->second;

12362 ++
p
;

12364 
hobjeù_t
 
h—d
 = 
soid
.
	`g‘_h—d
();

12366 
ev”siÚ_t
 
Ãed
 = 
™em
.need;

12368 
	`dout
(10è<< 
__func__
 << " "

12369 << 
soid
 << " " << 
™em
.
Ãed


12370 << (
missšg
.
	`is_missšg
(
soid
) ? " (missing)":"")

12371 << (
missšg
.
	`is_missšg
(
h—d
) ? " (missing head)":"")

12372 << (
»cov”šg
.
	`couÁ
(
soid
) ? " (recovering)":"")

12373 << (
»cov”šg
.
	`couÁ
(
h—d
) ? " (recovering head)":"")

12374 << 
d’dl
;

12376 ià(
Ï‹¡
) {

12377 
Ï‹¡
->
İ
) {

12378 
pg_log_’Œy_t
::
CLONE
:

12386 
pg_log_’Œy_t
::
LOST_REVERT
:

12388 ià(
™em
.
have
 =ğ
Ï‹¡
->
»v”tšg_to
) {

12389 
ObjeùCÚ‹xtRef
 
obc
 = 
	`g‘_objeù_cÚ‹xt
(
soid
, 
Œue
);

12391 ià(
obc
->
obs
.
oi
.
v”siÚ
 =ğ
Ï‹¡
->version) {

12393 
	`dout
(10è<< "‡Ì—dy„ev”tšg " << 
soid
 << 
d’dl
;

12395 
	`dout
(10è<< "„ev”tšg " << 
soid
 << "Ø" << 
Ï‹¡
->
´iÜ_v”siÚ
 << 
d’dl
;

12396 
obc
->
obs
.
oi
.
v”siÚ
 = 
Ï‹¡
->version;

12398 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

12399 
bufã¾i¡
 
b2
;

12400 
obc
->
obs
.
oi
.
	`’code
(

12401 
b2
,

12402 
	`g‘_osdm­
()->
	`g‘_ã©u»s
(
CEPH_ENTITY_TYPE_OSD
, 
nuÎ±r
));

12403 
	`as£¹
(!
poŞ
.
šfo
.
	`»quœe_rŞlback
());

12404 
t
.
	`£‰r
(
cŞl
, 
	`ghobjeù_t
(
soid
), 
OI_ATTR
, 
b2
);

12406 
	`»cov”_gÙ
(
soid
, 
Ï‹¡
->
v”siÚ
);

12407 
missšg_loc
.
	`add_loÿtiÚ
(
soid
, 
pg_whßmi
);

12409 ++
aùive_pushes
;

12411 
t
.
	`»gi¡”_Ú_­¶›d
(
Ãw
 
	`C_OSD_Aµl›dRecov”edObjeù
(
this
, 
obc
));

12412 
t
.
	`»gi¡”_Ú_comm™
(
Ãw
 
	`C_OSD_Comm™‹dPushedObjeù
(

12413 
this
,

12414 
	`g‘_osdm­
()->
	`g‘_•och
(),

12415 
šfo
.
Ï¡_com¶‘e
));

12416 
osd
->
¡Üe
->
	`queue_Œª§ùiÚ
(
ch
, 
¡d
::
	`move
(
t
));

12431 
ev”siÚ_t
 
®‹º©e_Ãed
 = 
Ï‹¡
->
»v”tšg_to
;

12432 
	`dout
(10è<< "‚“dØpuÎ…riÜ_v”siÚ " << 
®‹º©e_Ãed
 << " fÜ„ev”ˆ" << 
™em
 << 
d’dl
;

12434 
m­
<
pg_sh¬d_t
, 
pg_missšg_t
>::
™”©Ü
 
p
 = 
³”_missšg
.
	`begš
();

12435 
p
 !ğ
³”_missšg
.
	`’d
();

12436 ++
p
)

12437 ià(
p
->
£cÚd
.
	`is_missšg
(
soid
, 
Ãed
) &&

12438 
p
->
£cÚd
.
	`g‘_™ems
().
	`©
(
soid
).
have
 =ğ
®‹º©e_Ãed
) {

12439 
missšg_loc
.
	`add_loÿtiÚ
(
soid
, 
p
->
fœ¡
);

12441 
	`dout
(10è<< " wÈpuÎ " << 
®‹º©e_Ãed
 << " o¸" << 
Ãed


12442 << " from oÃ oà" << 
missšg_loc
.
	`g‘_loÿtiÚs
(
soid
)

12443 << 
d’dl
;

12450 ià(!
»cov”šg
.
	`couÁ
(
soid
)) {

12451 ià(
»cov”šg
.
	`couÁ
(
h—d
)) {

12452 ++
sk³d
;

12454 
r
 = 
	`»cov”_missšg
(

12455 
soid
, 
Ãed
, 
	`g‘_»cov”y_İ_´iÜ™y
(), 
h
);

12456 
r
) {

12457 
PULL_YES
:

12458 ++
¡¬‹d
;

12460 
PULL_HEAD
:

12461 ++
¡¬‹d
;

12462 
PULL_NONE
:

12463 ++
sk³d
;

12466 
	`ûph_abÜt
();

12468 ià(
¡¬‹d
 >ğ
max
)

12474 ià(!
sk³d
)

12475 
pg_log
.
	`£t_Ï¡_»que¡ed
(
v
);

12478 
pgback’d
->
	`run_»cov”y_İ
(
h
, 
	`g‘_»cov”y_İ_´iÜ™y
());

12479  
¡¬‹d
;

12480 
	}
}

12482 
boŞ
 
	gPrim¬yLogPG
::
	$´im¬y_”rÜ
(

12483 cÚ¡ 
hobjeù_t
& 
soid
, 
ev”siÚ_t
 
v
)

12485 
pg_log
.
	`missšg_add
(
soid
, 
v
, 
	`ev”siÚ_t
());

12486 
pg_log
.
	`£t_Ï¡_»que¡ed
(0);

12487 
missšg_loc
.
	`»move_loÿtiÚ
(
soid
, 
pg_whßmi
);

12488 
boŞ
 
uhoh
 = 
Œue
;

12489 
	`as£¹
(!
aùšg_»cov”y_backfl
.
	`em±y
());

12490 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
aùšg_»cov”y_backfl
.
	`begš
();

12491 
i
 !ğ
aùšg_»cov”y_backfl
.
	`’d
();

12492 ++
i
) {

12493 ià(*
i
 =ğ
	`g‘_´im¬y
()) ;

12494 
pg_sh¬d_t
 
³”
 = *
i
;

12495 ià(!
³”_missšg
[
³”
].
	`is_missšg
(
soid
, 
v
)) {

12496 
missšg_loc
.
	`add_loÿtiÚ
(
soid
, 
³”
);

12497 
	`dout
(10è<< 
šfo
.
pgid
 << " uÃx³ùedly missšg " << 
soid
 << " v" << 
v


12498 << ",h”should b¨cİy oÀsh¬d " << 
³”
 << 
d’dl
;

12499 
uhoh
 = 
çl£
;

12502 ià(
uhoh
)

12503 
osd
->
şog
->
	`”rÜ
(è<< 
šfo
.
pgid
 << " missšg…rim¬y cİy oà" << 
soid
 << ", unfound";

12505 
osd
->
şog
->
	`”rÜ
(è<< 
šfo
.
pgid
 << " missšg…rim¬y cİy oà" << 
soid


12506 << ", wÈŒy cİ› Ú " << 
missšg_loc
.
	`g‘_loÿtiÚs
(
soid
);

12507  
uhoh
;

12508 
	}
}

12510 
	gPrim¬yLogPG
::
	$´•_objeù_»¶iÿ_d–‘es
(

12511 cÚ¡ 
hobjeù_t
& 
soid
, 
ev”siÚ_t
 
v
,

12512 
PGBack’d
::
Recov”yHªdË
 *
h
,

12513 
boŞ
 *
wÜk_¡¬‹d
)

12515 
	`as£¹
(
	`is_´im¬y
());

12516 
	`dout
(10è<< 
__func__
 << ": oÀ" << 
soid
 << 
d’dl
;

12518 
ObjeùCÚ‹xtRef
 
obc
 = 
	`g‘_objeù_cÚ‹xt
(
soid
, 
çl£
);

12519 ià(
obc
) {

12520 ià(!
obc
->
	`g‘_»cov”y_»ad
()) {

12521 
	`dout
(20è<< "»¶iÿ d–‘d–ayed oÀ" << 
soid


12522 << "; could‚Ù g‘„w_mªag”†ock" << 
d’dl
;

12523 *
wÜk_¡¬‹d
 = 
Œue
;

12526 
	`dout
(20è<< "»¶iÿ d–‘gÙ„ecov”y„—d†ock oÀ" << 
soid


12527 << 
d’dl
;

12531 
	`¡¬t_»cov”y_İ
(
soid
);

12532 
	`as£¹
(!
»cov”šg
.
	`couÁ
(
soid
));

12533 ià(!
obc
)

12534 
»cov”šg
.
	`š£¹
(
	`make_·œ
(
soid
, 
	`ObjeùCÚ‹xtRef
()));

12536 
»cov”šg
.
	`š£¹
(
	`make_·œ
(
soid
, 
obc
));

12538 
pgback’d
->
	`»cov”_d–‘e_objeù
(
soid
, 
v
, 
h
);

12540 
	}
}

12542 
	gPrim¬yLogPG
::
	$´•_objeù_»¶iÿ_pushes
(

12543 cÚ¡ 
hobjeù_t
& 
soid
, 
ev”siÚ_t
 
v
,

12544 
PGBack’d
::
Recov”yHªdË
 *
h
,

12545 
boŞ
 *
wÜk_¡¬‹d
)

12547 
	`as£¹
(
	`is_´im¬y
());

12548 
	`dout
(10è<< 
__func__
 << ": oÀ" << 
soid
 << 
d’dl
;

12551 
ObjeùCÚ‹xtRef
 
obc
 = 
	`g‘_objeù_cÚ‹xt
(
soid
, 
çl£
);

12552 ià(!
obc
) {

12553 
	`´im¬y_”rÜ
(
soid
, 
v
);

12557 ià(!
obc
->
	`g‘_»cov”y_»ad
()) {

12558 
	`dout
(20è<< "»cov”y d–ayed oÀ" << 
soid


12559 << "; could‚Ù g‘„w_mªag”†ock" << 
d’dl
;

12560 *
wÜk_¡¬‹d
 = 
Œue
;

12563 
	`dout
(20è<< "»cov”y gÙ„ecov”y„—d†ock oÀ" << 
soid


12564 << 
d’dl
;

12567 
	`¡¬t_»cov”y_İ
(
soid
);

12568 
	`as£¹
(!
»cov”šg
.
	`couÁ
(
soid
));

12569 
»cov”šg
.
	`š£¹
(
	`make_·œ
(
soid
, 
obc
));

12576 
r
 = 
pgback’d
->
	`»cov”_objeù
(

12577 
soid
,

12578 
v
,

12579 
	`ObjeùCÚ‹xtRef
(),

12580 
obc
,

12581 
h
);

12582 ià(
r
 < 0) {

12583 
	`dout
(0è<< 
__func__
 << " E¼Ü " << 
r
 << " oÀoid " << 
soid
 << 
d’dl
;

12584 
	`´im¬y_çed
(
soid
);

12585 
	`´im¬y_”rÜ
(
soid
, 
v
);

12589 
	}
}

12591 
ušt64_t
 
	gPrim¬yLogPG
::
	$»cov”_»¶iÿs
(
ušt64_t
 
max
, 
Th»adPoŞ
::
TPHªdË
 &
hªdË
,

12592 
boŞ
 *
wÜk_¡¬‹d
)

12594 
	`dout
(10è<< 
__func__
 << "(" << 
max
 << ")" << 
d’dl
;

12595 
ušt64_t
 
¡¬‹d
 = 0;

12597 
PGBack’d
::
Recov”yHªdË
 *
h
 = 
pgback’d
->
	`İ’_»cov”y_İ
();

12600 
	`as£¹
(!
aùšg_»cov”y_backfl
.
	`em±y
());

12603 
¡d
::
veùÜ
<¡d::
·œ
<, 
pg_sh¬d_t
>> 
»¶iÿs_by_num_missšg
;

12604 
»¶iÿs_by_num_missšg
.
	`»£rve
(
aùšg_»cov”y_backfl
.
	`size
() - 1);

12605 autØ&
p
: 
aùšg_»cov”y_backfl
) {

12606 ià(
p
 =ğ
	`g‘_´im¬y
()) {

12609 autØ
pm
 = 
³”_missšg
.
	`fšd
(
p
);

12610 
	`as£¹
(
pm
 !ğ
³”_missšg
.
	`’d
());

12611 autØ
nm
 = 
pm
->
£cÚd
.
	`num_missšg
();

12612 ià(
nm
 != 0) {

12613 
»¶iÿs_by_num_missšg
.
	`push_back
(
	`make_·œ
(
nm
, 
p
));

12617 
¡d
::
	`sÜt
(
»¶iÿs_by_num_missšg
.
	`begš
(),„•liÿs_by_num_missšg.
	`’d
(),

12618 [](cÚ¡ 
¡d
::
·œ
<, 
pg_sh¬d_t
> &
lhs
,

12619 cÚ¡ 
¡d
::
·œ
<, 
pg_sh¬d_t
> &
rhs
) {

12620  
lhs
.
fœ¡
 < 
rhs
.first;

12623 autØ&
»¶iÿ
: 
»¶iÿs_by_num_missšg
) {

12624 
pg_sh¬d_t
 &
³”
 = 
»¶iÿ
.
£cÚd
;

12625 
	`as£¹
(
³”
 !ğ
	`g‘_´im¬y
());

12626 
m­
<
pg_sh¬d_t
, 
pg_missšg_t
>::
cÚ¡_™”©Ü
 
pm
 = 
³”_missšg
.
	`fšd
(
³”
);

12627 
	`as£¹
(
pm
 !ğ
³”_missšg
.
	`’d
());

12628 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
>::
cÚ¡_™”©Ü
 
pi
 = 
³”_šfo
.
	`fšd
(
³”
);

12629 
	`as£¹
(
pi
 !ğ
³”_šfo
.
	`’d
());

12630 
size_t
 
m_sz
 = 
pm
->
£cÚd
.
	`num_missšg
();

12632 
	`dout
(10è<< "…“¸osd." << 
³”
 << " missšg " << 
m_sz
 << " objeùs." << 
d’dl
;

12633 
	`dout
(20è<< "…“¸osd." << 
³”
 << " missšg " << 
pm
->
£cÚd
.
	`g‘_™ems
(è<< 
d’dl
;

12636 cÚ¡ 
pg_missšg_t
 &
	`m
(
pm
->
£cÚd
);

12637 
m­
<
v”siÚ_t
, 
hobjeù_t
>::
cÚ¡_™”©Ü
 
p
 = 
m
.
	`g‘_rmissšg
().
	`begš
();

12638 
p
 !ğ
m
.
	`g‘_rmissšg
().
	`’d
(è&& 
¡¬‹d
 < 
max
;

12639 ++
p
) {

12640 
hªdË
.
	`»£t__timeout
();

12641 cÚ¡ 
hobjeù_t
 
	`soid
(
p
->
£cÚd
);

12643 ià(
missšg_loc
.
	`is_unfound
(
soid
)) {

12644 
	`dout
(10è<< 
__func__
 << ": " << 
soid
 << " stÈunfound" << 
d’dl
;

12648 ià(
soid
 > 
pi
->
£cÚd
.
Ï¡_backfl
) {

12649 ià(!
»cov”šg
.
	`couÁ
(
soid
)) {

12650 
d”r
 << 
__func__
 << ": objeù " << 
soid
 << "†a¡_backfÈ" << 
pi
->
£cÚd
.
Ï¡_backfl
 << 
d’dl
;

12651 
d”r
 << 
__func__
 << ": object‡ddedo missing set for backfill, but "

12652 << "i nÙ iÀ»cov”šg,ƒ¼Ü!" << 
d’dl
;

12653 
	`ûph_abÜt
();

12658 ià(
»cov”šg
.
	`couÁ
(
soid
)) {

12659 
	`dout
(10è<< 
__func__
 << ":‡Ì—dy„ecov”šg " << 
soid
 << 
d’dl
;

12663 ià(
missšg_loc
.
	`is_d–‘ed
(
soid
)) {

12664 
	`dout
(10è<< 
__func__
 << ": " << 
soid
 << " i ¨d–‘e,„emovšg" << 
d’dl
;

12665 
m­
<
hobjeù_t
,
pg_missšg_™em
>::
cÚ¡_™”©Ü
 
r
 = 
m
.
	`g‘_™ems
().
	`fšd
(
soid
);

12666 
¡¬‹d
 +ğ
	`´•_objeù_»¶iÿ_d–‘es
(
soid
, 
r
->
£cÚd
.
Ãed
, 
h
, 
wÜk_¡¬‹d
);

12670 ià(
soid
.
	`is_¢­
(è&& 
pg_log
.
	`g‘_missšg
().
	`is_missšg
(soid.
	`g‘_h—d
())) {

12671 
	`dout
(10è<< 
__func__
 << ": " << 
soid
.
	`g‘_h—d
()

12672 << " stÈmissšg oÀ´im¬y" << 
d’dl
;

12676 ià(
pg_log
.
	`g‘_missšg
().
	`is_missšg
(
soid
)) {

12677 
	`dout
(10è<< 
__func__
 << ": " << 
soid
 << " stÈmissšg oÀ´im¬y" << 
d’dl
;

12681 
	`dout
(10è<< 
__func__
 << ":„ecov”_objeù_»¶iÿs(" << 
soid
 << ")" << 
d’dl
;

12682 
m­
<
hobjeù_t
,
pg_missšg_™em
>::
cÚ¡_™”©Ü
 
r
 = 
m
.
	`g‘_™ems
().
	`fšd
(
soid
);

12683 
¡¬‹d
 +ğ
	`´•_objeù_»¶iÿ_pushes
(
soid
, 
r
->
£cÚd
.
Ãed
, 
h
, 
wÜk_¡¬‹d
);

12687 
pgback’d
->
	`run_»cov”y_İ
(
h
, 
	`g‘_»cov”y_İ_´iÜ™y
());

12688  
¡¬‹d
;

12689 
	}
}

12691 
hobjeù_t
 
	gPrim¬yLogPG
::
	$—¾›¡_³”_backfl
() const

12693 
hobjeù_t
 
e
 = hobjeù_t::
	`g‘_max
();

12694 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
i
 = 
backfl_rg‘s
.
	`begš
();

12695 
i
 !ğ
backfl_rg‘s
.
	`’d
();

12696 ++
i
) {

12697 
pg_sh¬d_t
 
³”
 = *
i
;

12698 
m­
<
pg_sh¬d_t
, 
BackflIÁ”v®
>::
cÚ¡_™”©Ü
 
™”
 =

12699 
³”_backfl_šfo
.
	`fšd
(
³”
);

12700 
	`as£¹
(
™”
 !ğ
³”_backfl_šfo
.
	`’d
());

12701 ià(
™”
->
£cÚd
.
begš
 < 
e
)

12702 
e
 = 
™”
->
£cÚd
.
begš
;

12704  
e
;

12705 
	}
}

12707 
boŞ
 
	gPrim¬yLogPG
::
	$®l_³”_dÚe
() const

12710 
	`as£¹
(
backfl_šfo
.
	`em±y
());

12712 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
i
 = 
backfl_rg‘s
.
	`begš
();

12713 
i
 !ğ
backfl_rg‘s
.
	`’d
();

12714 ++
i
) {

12715 
pg_sh¬d_t
 
bt
 = *
i
;

12716 
m­
<
pg_sh¬d_t
, 
BackflIÁ”v®
>::
cÚ¡_™”©Ü
 
p™”
 =

12717 
³”_backfl_šfo
.
	`fšd
(
bt
);

12718 
	`as£¹
(
p™”
 !ğ
³”_backfl_šfo
.
	`’d
());

12719 cÚ¡ 
BackflIÁ”v®
& 
pbi
 = 
p™”
->
£cÚd
;

12721 ià(!
pbi
.
	`ex‹nds_to_’d
(è|| !pbi.
	`em±y
())

12722  
çl£
;

12724  
Œue
;

12725 
	}
}

12755 
ušt64_t
 
	gPrim¬yLogPG
::
	$»cov”_backfl
(

12756 
ušt64_t
 
max
,

12757 
Th»adPoŞ
::
TPHªdË
 &
hªdË
, 
boŞ
 *
wÜk_¡¬‹d
)

12759 
	`dout
(10è<< 
__func__
 << " (" << 
max
 << ")"

12760 << " bá=" << 
backfl_rg‘s


12761 << "†a¡_backfl_¡¬‹d " << 
Ï¡_backfl_¡¬‹d


12762 << (
Ãw_backfl
 ? "‚ew_backfill":"")

12763 << 
d’dl
;

12764 
	`as£¹
(!
backfl_rg‘s
.
	`em±y
());

12767 ià(
Ãw_backfl
) {

12769 
	`as£¹
(
Ï¡_backfl_¡¬‹d
 =ğ
	`—¾›¡_backfl
());

12770 
Ãw_backfl
 = 
çl£
;

12773 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
backfl_rg‘s
.
	`begš
();

12774 
i
 !ğ
backfl_rg‘s
.
	`’d
();

12775 ++
i
) {

12776 
³”_backfl_šfo
[*
i
].
	`»£t
(
³”_šfo
[*i].
Ï¡_backfl
);

12778 
backfl_šfo
.
	`»£t
(
Ï¡_backfl_¡¬‹d
);

12780 
backfls_š_æight
.
	`ş—r
();

12781 
³ndšg_backfl_upd©es
.
	`ş—r
();

12784 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
backfl_rg‘s
.
	`begš
();

12785 
i
 !ğ
backfl_rg‘s
.
	`’d
();

12786 ++
i
) {

12787 
	`dout
(10è<< "³” osd." << *
i


12788 << " infØ" << 
³”_šfo
[*
i
]

12789 << " iÁ”v® " << 
³”_backfl_šfo
[*
i
].
begš


12790 << "-" << 
³”_backfl_šfo
[*
i
].
’d


12791 << " " << 
³”_backfl_šfo
[*
i
].
objeùs
.
	`size
() << " objects"

12792 << 
d’dl
;

12796 
backfl_šfo
.
begš
 = 
Ï¡_backfl_¡¬‹d
;

12797 
	`upd©e_¿nge
(&
backfl_šfo
, 
hªdË
);

12799 
İs
 = 0;

12800 
veùÜ
<
boo¡
::
tu¶e
<
hobjeù_t
, 
ev”siÚ_t
, 
pg_sh¬d_t
> > 
to_»move
;

12801 
£t
<
hobjeù_t
> 
add_to_¡©
;

12803 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
backfl_rg‘s
.
	`begš
();

12804 
i
 !ğ
backfl_rg‘s
.
	`’d
();

12805 ++
i
) {

12806 
³”_backfl_šfo
[*
i
].
	`Œim_to
(

12807 
¡d
::
	`max
(
³”_šfo
[*
i
].
Ï¡_backfl
, 
Ï¡_backfl_¡¬‹d
));

12809 
backfl_šfo
.
	`Œim_to
(
Ï¡_backfl_¡¬‹d
);

12811 
PGBack’d
::
Recov”yHªdË
 *
h
 = 
pgback’d
->
	`İ’_»cov”y_İ
();

12812 
İs
 < 
max
) {

12813 ià(
backfl_šfo
.
begš
 <ğ
	`—¾›¡_³”_backfl
() &&

12814 !
backfl_šfo
.
	`ex‹nds_to_’d
(è&& backfl_šfo.
	`em±y
()) {

12815 
hobjeù_t
 
Ãxt
 = 
backfl_šfo
.
’d
;

12816 
backfl_šfo
.
	`»£t
(
Ãxt
);

12817 
backfl_šfo
.
’d
 = 
hobjeù_t
::
	`g‘_max
();

12818 
	`upd©e_¿nge
(&
backfl_šfo
, 
hªdË
);

12819 
backfl_šfo
.
	`Œim
();

12822 
	`dout
(20è<< " my backfÈš‹rv® " << 
backfl_šfo
 << 
d’dl
;

12824 
boŞ
 
£Á_sÿn
 = 
çl£
;

12825 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
backfl_rg‘s
.
	`begš
();

12826 
i
 !ğ
backfl_rg‘s
.
	`’d
();

12827 ++
i
) {

12828 
pg_sh¬d_t
 
bt
 = *
i
;

12829 
BackflIÁ”v®
& 
pbi
 = 
³”_backfl_šfo
[
bt
];

12831 
	`dout
(20è<< "…“¸sh¬d " << 
bt
 << " backfÈ" << 
pbi
 << 
d’dl
;

12832 ià(
pbi
.
begš
 <ğ
backfl_šfo
.begin &&

12833 !
pbi
.
	`ex‹nds_to_’d
(è&&…bi.
	`em±y
()) {

12834 
	`dout
(10è<< " sÿÂšg…“¸osd." << 
bt
 << " from " << 
pbi
.
’d
 << 
d’dl
;

12835 
•och_t
 
e
 = 
	`g‘_osdm­
()->
	`g‘_•och
();

12836 
MOSDPGSÿn
 *
m
 = 
Ãw
 
	`MOSDPGSÿn
(

12837 
MOSDPGSÿn
::
OP_SCAN_GET_DIGEST
, 
pg_whßmi
, 
e
, 
Ï¡_³”šg_»£t
,

12838 
	`¥g_t
(
šfo
.
pgid
.pgid, 
bt
.
sh¬d
),

12839 
pbi
.
’d
, 
	`hobjeù_t
());

12840 
osd
->
	`£nd_mes§ge_osd_şu¡”
(
bt
.osd, 
m
, 
	`g‘_osdm­
()->
	`g‘_•och
());

12841 
	`as£¹
(
wa™šg_Ú_backfl
.
	`fšd
(
bt
è=ğwa™šg_Ú_backfl.
	`’d
());

12842 
wa™šg_Ú_backfl
.
	`š£¹
(
bt
);

12843 
£Á_sÿn
 = 
Œue
;

12848 ià(
£Á_sÿn
) {

12849 
İs
++;

12850 
	`¡¬t_»cov”y_İ
(
hobjeù_t
::
	`g‘_max
());

12854 ià(
backfl_šfo
.
	`em±y
(è&& 
	`®l_³”_dÚe
()) {

12855 
	`dout
(10è<< "„—chedƒnd fÜ bÙh†oÿÈªd‡Î…“rs" << 
d’dl
;

12861 
hobjeù_t
 
check
 = 
	`—¾›¡_³”_backfl
();

12863 ià(
check
 < 
backfl_šfo
.
begš
) {

12865 
£t
<
pg_sh¬d_t
> 
check_rg‘s
;

12866 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
backfl_rg‘s
.
	`begš
();

12867 
i
 !ğ
backfl_rg‘s
.
	`’d
();

12868 ++
i
) {

12869 
pg_sh¬d_t
 
bt
 = *
i
;

12870 
BackflIÁ”v®
& 
pbi
 = 
³”_backfl_šfo
[
bt
];

12871 ià(
pbi
.
begš
 =ğ
check
)

12872 
check_rg‘s
.
	`š£¹
(
bt
);

12874 
	`as£¹
(!
check_rg‘s
.
	`em±y
());

12876 
	`dout
(20è<< " BACKFILL„emovšg " << 
check


12877 << " from…“r " << 
check_rg‘s
 << 
d’dl
;

12878 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
check_rg‘s
.
	`begš
();

12879 
i
 !ğ
check_rg‘s
.
	`’d
();

12880 ++
i
) {

12881 
pg_sh¬d_t
 
bt
 = *
i
;

12882 
BackflIÁ”v®
& 
pbi
 = 
³”_backfl_šfo
[
bt
];

12883 
	`as£¹
(
pbi
.
begš
 =ğ
check
);

12885 
to_»move
.
	`push_back
(
boo¡
::
	`make_tu¶e
(
check
, 
pbi
.
objeùs
.
	`begš
()->
£cÚd
, 
bt
));

12886 
pbi
.
	`pİ_äÚt
();

12889 
Ï¡_backfl_¡¬‹d
 = 
check
;

12896 
ev”siÚ_t
& 
obj_v
 = 
backfl_šfo
.
objeùs
.
	`begš
()->
£cÚd
;

12898 
veùÜ
<
pg_sh¬d_t
> 
Ãed_v”_rgs
, 
missšg_rgs
, 
k“p_v”_rgs
, 
sk_rgs
;

12899 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
backfl_rg‘s
.
	`begš
();

12900 
i
 !ğ
backfl_rg‘s
.
	`’d
();

12901 ++
i
) {

12902 
pg_sh¬d_t
 
bt
 = *
i
;

12903 
BackflIÁ”v®
& 
pbi
 = 
³”_backfl_šfo
[
bt
];

12905 ià(
check
 =ğ
backfl_šfo
.
begš
 && check =ğ
pbi
.begin) {

12906 ià(
pbi
.
objeùs
.
	`begš
()->
£cÚd
 !ğ
obj_v
) {

12907 
Ãed_v”_rgs
.
	`push_back
(
bt
);

12909 
k“p_v”_rgs
.
	`push_back
(
bt
);

12912 
pg_šfo_t
& 
pšfo
 = 
³”_šfo
[
bt
];

12917 ià(
backfl_šfo
.
begš
 > 
pšfo
.
Ï¡_backfl
)

12918 
missšg_rgs
.
	`push_back
(
bt
);

12920 
sk_rgs
.
	`push_back
(
bt
);

12924 ià(!
k“p_v”_rgs
.
	`em±y
()) {

12926 
	`dout
(20è<< " BACKFILL k“pšg " << 
check


12927 << " w™h v” " << 
obj_v


12928 << " oÀ³” " << 
k“p_v”_rgs
 << 
d’dl
;

12931 ià(!
Ãed_v”_rgs
.
	`em±y
(è|| !
missšg_rgs
.empty()) {

12932 
ObjeùCÚ‹xtRef
 
obc
 = 
	`g‘_objeù_cÚ‹xt
(
backfl_šfo
.
begš
, 
çl£
);

12933 
	`as£¹
(
obc
);

12934 ià(
obc
->
	`g‘_»cov”y_»ad
()) {

12935 ià(!
Ãed_v”_rgs
.
	`em±y
()) {

12936 
	`dout
(20è<< " BACKFILL„•Ïcšg " << 
check


12937 << " w™h v” " << 
obj_v


12938 << "Ø³” " << 
Ãed_v”_rgs
 << 
d’dl
;

12940 ià(!
missšg_rgs
.
	`em±y
()) {

12941 
	`dout
(20è<< " BACKFILL…ushšg " << 
backfl_šfo
.
begš


12942 << " w™h v” " << 
obj_v


12943 << "Ø³” " << 
missšg_rgs
 << 
d’dl
;

12945 
veùÜ
<
pg_sh¬d_t
> 
®l_push
 = 
Ãed_v”_rgs
;

12946 
®l_push
.
	`š£¹
×Î_push.
	`’d
(), 
missšg_rgs
.
	`begš
(), missing_targs.end());

12948 
hªdË
.
	`»£t__timeout
();

12949 
r
 = 
	`´•_backfl_objeù_push
(
backfl_šfo
.
begš
, 
obj_v
, 
obc
, 
®l_push
, 
h
);

12950 ià(
r
 < 0) {

12951 *
wÜk_¡¬‹d
 = 
Œue
;

12952 
	`dout
(0è<< 
__func__
 << " E¼Ü " << 
r
 << "ryšgØbackfÈ" << 
backfl_šfo
.
begš
 << 
d’dl
;

12955 
İs
++;

12957 *
wÜk_¡¬‹d
 = 
Œue
;

12958 
	`dout
(20è<< "backfÈblockšg oÀ" << 
backfl_šfo
.
begš


12959 << "; could‚Ù g‘„w_mªag”†ock" << 
d’dl
;

12963 
	`dout
(20è<< "Ãed_v”_rgs=" << 
Ãed_v”_rgs


12964 << " k“p_v”_rgs=" << 
k“p_v”_rgs
 << 
d’dl
;

12965 
	`dout
(20è<< "backfl_rg‘s=" << 
backfl_rg‘s


12966 << " missšg_rgs=" << 
missšg_rgs


12967 << " sk_rgs=" << 
sk_rgs
 << 
d’dl
;

12969 
Ï¡_backfl_¡¬‹d
 = 
backfl_šfo
.
begš
;

12970 
add_to_¡©
.
	`š£¹
(
backfl_šfo
.
begš
);

12971 
backfl_šfo
.
	`pİ_äÚt
();

12972 
veùÜ
<
pg_sh¬d_t
> 
check_rg‘s
 = 
Ãed_v”_rgs
;

12973 
check_rg‘s
.
	`š£¹
(check_rg‘s.
	`’d
(), 
k“p_v”_rgs
.
	`begš
(), keep_ver_targs.end());

12974 
veùÜ
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
check_rg‘s
.
	`begš
();

12975 
i
 !ğ
check_rg‘s
.
	`’d
();

12976 ++
i
) {

12977 
pg_sh¬d_t
 
bt
 = *
i
;

12978 
BackflIÁ”v®
& 
pbi
 = 
³”_backfl_šfo
[
bt
];

12979 
pbi
.
	`pİ_äÚt
();

12984 
hobjeù_t
 
backfl_pos
 =

12985 
¡d
::
	`mš
(
backfl_šfo
.
begš
, 
	`—¾›¡_³”_backfl
());

12987 
£t
<
hobjeù_t
>::
™”©Ü
 
i
 = 
add_to_¡©
.
	`begš
();

12988 
i
 !ğ
add_to_¡©
.
	`’d
();

12989 ++
i
) {

12990 
ObjeùCÚ‹xtRef
 
obc
 = 
	`g‘_objeù_cÚ‹xt
(*
i
, 
çl£
);

12991 
	`as£¹
(
obc
);

12992 
pg_¡©_t
 
¡©
;

12993 
	`add_objeù_cÚ‹xt_to_pg_¡©
(
obc
, &
¡©
);

12994 
³ndšg_backfl_upd©es
[*
i
] = 
¡©
;

12996 
m­
<
pg_sh¬d_t
,
MOSDPGBackflRemove
*> 
»qs
;

12997 
i
 = 0; i < 
to_»move
.
	`size
(); ++i) {

12998 
hªdË
.
	`»£t__timeout
();

12999 cÚ¡ 
hobjeù_t
& 
oid
 = 
to_»move
[
i
].
g‘
<0>();

13000 
ev”siÚ_t
 
v
 = 
to_»move
[
i
].
g‘
<1>();

13001 
pg_sh¬d_t
 
³”
 = 
to_»move
[
i
].
g‘
<2>();

13002 
MOSDPGBackflRemove
 *
m
;

13003 autØ
™
 = 
»qs
.
	`fšd
(
³”
);

13004 ià(
™
 !ğ
»qs
.
	`’d
()) {

13005 
m
 = 
™
->
£cÚd
;

13007 
m
 = 
»qs
[
³”
] = 
Ãw
 
	`MOSDPGBackflRemove
(

13008 
	`¥g_t
(
šfo
.
pgid
.pgid, 
³”
.
sh¬d
),

13009 
	`g‘_osdm­
()->
	`g‘_•och
());

13011 
m
->
ls
.
	`push_back
(
	`make_·œ
(
oid
, 
v
));

13013 ià(
oid
 <ğ
Ï¡_backfl_¡¬‹d
)

13014 
³ndšg_backfl_upd©es
[
oid
];

13016 autØ
p
 : 
»qs
) {

13017 
osd
->
	`£nd_mes§ge_osd_şu¡”
(
p
.
fœ¡
.osd,….
£cÚd
,

13018 
	`g‘_osdm­
()->
	`g‘_•och
());

13021 
pgback’d
->
	`run_»cov”y_İ
(
h
, 
	`g‘_»cov”y_İ_´iÜ™y
());

13023 
	`dout
(5è<< "backfl_po i " << 
backfl_pos
 << 
d’dl
;

13024 
£t
<
hobjeù_t
>::
™”©Ü
 
i
 = 
backfls_š_æight
.
	`begš
();

13025 
i
 !ğ
backfls_š_æight
.
	`’d
();

13026 ++
i
) {

13027 
	`dout
(20è<< *
i
 << " i ¡Èš flight" << 
d’dl
;

13030 
hobjeù_t
 
Ãxt_backfl_to_com¶‘e
 = 
backfls_š_æight
.
	`em±y
() ?

13031 
backfl_pos
 : *(
backfls_š_æight
.
	`begš
());

13032 
hobjeù_t
 
Ãw_Ï¡_backfl
 = 
	`—¾›¡_backfl
();

13033 
	`dout
(10è<< "¡¬tšg‚ew_Ï¡_backfÈ© " << 
Ãw_Ï¡_backfl
 << 
d’dl
;

13034 
m­
<
hobjeù_t
, 
pg_¡©_t
>::
™”©Ü
 
i
 =

13035 
³ndšg_backfl_upd©es
.
	`begš
();

13036 
i
 !ğ
³ndšg_backfl_upd©es
.
	`’d
() &&

13037 
i
->
fœ¡
 < 
Ãxt_backfl_to_com¶‘e
;

13038 
³ndšg_backfl_upd©es
.
	`”a£
(
i
++)) {

13039 
	`dout
(20è<< "…’dšg_backfl_upd©" << 
i
->
fœ¡
 << 
d’dl
;

13040 
	`as£¹
(
i
->
fœ¡
 > 
Ãw_Ï¡_backfl
);

13041 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
j
 = 
backfl_rg‘s
.
	`begš
();

13042 
j
 !ğ
backfl_rg‘s
.
	`’d
();

13043 ++
j
) {

13044 
pg_sh¬d_t
 
bt
 = *
j
;

13045 
pg_šfo_t
& 
pšfo
 = 
³”_šfo
[
bt
];

13047 ià(
i
->
fœ¡
 > 
pšfo
.
Ï¡_backfl
)

13048 
pšfo
.
¡©s
.
	`add
(
i
->
£cÚd
);

13050 
Ãw_Ï¡_backfl
 = 
i
->
fœ¡
;

13052 
	`dout
(10è<< "possibË‚ew_Ï¡_backfÈ© " << 
Ãw_Ï¡_backfl
 << 
d’dl
;

13054 
	`as£¹
(!
³ndšg_backfl_upd©es
.
	`em±y
() ||

13055 
Ãw_Ï¡_backfl
 =ğ
Ï¡_backfl_¡¬‹d
);

13056 ià(
³ndšg_backfl_upd©es
.
	`em±y
() &&

13057 
backfl_pos
.
	`is_max
()) {

13058 
	`as£¹
(
backfls_š_æight
.
	`em±y
());

13059 
Ãw_Ï¡_backfl
 = 
backfl_pos
;

13060 
Ï¡_backfl_¡¬‹d
 = 
backfl_pos
;

13062 
	`dout
(10è<< "fš®‚ew_Ï¡_backfÈ© " << 
Ãw_Ï¡_backfl
 << 
d’dl
;

13067 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 = 
backfl_rg‘s
.
	`begš
();

13068 
i
 !ğ
backfl_rg‘s
.
	`’d
();

13069 ++
i
) {

13070 
pg_sh¬d_t
 
bt
 = *
i
;

13071 
pg_šfo_t
& 
pšfo
 = 
³”_šfo
[
bt
];

13073 ià(
Ãw_Ï¡_backfl
 > 
pšfo
.
Ï¡_backfl
) {

13074 
pšfo
.
	`£t_Ï¡_backfl
(
Ãw_Ï¡_backfl
);

13075 
•och_t
 
e
 = 
	`g‘_osdm­
()->
	`g‘_•och
();

13076 
MOSDPGBackfl
 *
m
 = 
NULL
;

13077 ià(
pšfo
.
Ï¡_backfl
.
	`is_max
()) {

13078 
m
 = 
Ãw
 
	`MOSDPGBackfl
(

13079 
MOSDPGBackfl
::
OP_BACKFILL_FINISH
,

13080 
e
,

13081 
Ï¡_³”šg_»£t
,

13082 
	`¥g_t
(
šfo
.
pgid
.pgid, 
bt
.
sh¬d
));

13087 
pšfo
.
¡©s
 = 
šfo
.stats;

13088 
	`¡¬t_»cov”y_İ
(
hobjeù_t
::
	`g‘_max
());

13090 
m
 = 
Ãw
 
	`MOSDPGBackfl
(

13091 
MOSDPGBackfl
::
OP_BACKFILL_PROGRESS
,

13092 
e
,

13093 
Ï¡_³”šg_»£t
,

13094 
	`¥g_t
(
šfo
.
pgid
.pgid, 
bt
.
sh¬d
));

13097 
m
->
Ï¡_backfl
 = 
pšfo
.last_backfill;

13098 
m
->
¡©s
 = 
pšfo
.stats;

13099 
osd
->
	`£nd_mes§ge_osd_şu¡”
(
bt
.osd, 
m
, 
	`g‘_osdm­
()->
	`g‘_•och
());

13100 
	`dout
(10è<< "…“¸" << 
bt


13101 << "‚um_objeù now " << 
pšfo
.
¡©s
.¡©s.
sum
.
num_objeùs


13102 << " / " << 
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs
 << 
d’dl
;

13106 ià(
İs
)

13107 *
wÜk_¡¬‹d
 = 
Œue
;

13108  
İs
;

13109 
	}
}

13111 
	gPrim¬yLogPG
::
´•_backfl_objeù_push
(

13112 
hobjeù_t
 
oid
, 
ev”siÚ_t
 
v
,

13113 
ObjeùCÚ‹xtRef
 
obc
,

13114 
veùÜ
<
pg_sh¬d_t
> 
³”s
,

13115 
PGBack’d
::
Recov”yHªdË
 *
h
)

13117 
dout
(10è<< 
__func__
 << " " << 
oid
 << " v " << 
v
 << "Ø³” " << 
³”s
 << 
d’dl
;

13118 
as£¹
(!
³”s
.
em±y
());

13120 
	gbackfls_š_æight
.
š£¹
(
oid
);

13121 
	gi
 = 0 ; i < 
	g³”s
.
size
(); ++i) {

13122 
	gm­
<
	gpg_sh¬d_t
, 
	gpg_missšg_t
>::
™”©Ü
 
bpm
 = 
³”_missšg
.
fšd
(
³”s
[
i
]);

13123 
as£¹
(
bpm
 !ğ
³”_missšg
.
’d
());

13124 
	gbpm
->
	g£cÚd
.
add
(
oid
, 
ev”siÚ_t
(),ƒv”siÚ_t(), 
çl£
);

13127 
as£¹
(!
»cov”šg
.
couÁ
(
oid
));

13129 
¡¬t_»cov”y_İ
(
oid
);

13130 
	g»cov”šg
.
š£¹
(
make_·œ
(
oid
, 
obc
));

13133 
	gr
 = 
pgback’d
->
»cov”_objeù
(

13134 
oid
,

13135 
v
,

13136 
ObjeùCÚ‹xtRef
(),

13137 
obc
,

13138 
h
);

13139 ià(
	gr
 < 0) {

13140 
dout
(0è<< 
	g__func__
 << " E¼Ü " << 
	gr
 << " oÀoid " << 
	goid
 << 
	gd’dl
;

13141 
´im¬y_çed
(
oid
);

13142 
´im¬y_”rÜ
(
oid
, 
v
);

13143 
	gbackfls_š_æight
.
”a£
(
oid
);

13144 
	gmissšg_loc
.
add_missšg
(
oid
, 
v
, 
ev”siÚ_t
());

13146  
	gr
;

13149 
	gPrim¬yLogPG
::
	$upd©e_¿nge
(

13150 
BackflIÁ”v®
 *
bi
,

13151 
Th»adPoŞ
::
TPHªdË
 &
hªdË
)

13153 
loÿl_mš
 = 
cù
->
_cÚf
->
osd_backfl_sÿn_mš
;

13154 
loÿl_max
 = 
cù
->
_cÚf
->
osd_backfl_sÿn_max
;

13156 ià(
bi
->
v”siÚ
 < 
šfo
.
log_
) {

13157 
	`dout
(10è<< 
__func__
<< ": bi is old,„escanning†ocal backfill_info"

13158 << 
d’dl
;

13159 
bi
->
v”siÚ
 = 
šfo
.
Ï¡_upd©e
;

13160 
	`sÿn_¿nge
(
loÿl_mš
, 
loÿl_max
, 
bi
, 
hªdË
);

13163 ià(
bi
->
v”siÚ
 >ğ
´ojeùed_Ï¡_upd©e
) {

13164 
	`dout
(10è<< 
__func__
<< ": b˜i cu¼’ˆ" << 
d’dl
;

13165 
	`as£¹
(
bi
->
v”siÚ
 =ğ
´ojeùed_Ï¡_upd©e
);

13166 } ià(
bi
->
v”siÚ
 >ğ
šfo
.
log_
) {

13167 ià(
pg_log
.
	`g‘_log
().
	`em±y
(è&& 
´ojeùed_log
.empty()) {

13174 
	`as£¹
(
bi
->
v”siÚ
 =ğ
	`ev”siÚ_t
());

13178 
	`dout
(10è<< 
__func__
<< ": b˜i Şd, (" << 
bi
->
v”siÚ


13180 << 
´ojeùed_Ï¡_upd©e
 << 
d’dl
;

13182 autØ
func
 = [&](cÚ¡ 
pg_log_’Œy_t
 &
e
) {

13183 
	`dout
(10è<< 
__func__
 << ": upd©šg from v”siÚ " << 
e
.
v”siÚ


13184 << 
d’dl
;

13185 cÚ¡ 
hobjeù_t
 &
soid
 = 
e
.soid;

13186 ià(
soid
 >ğ
bi
->
begš
 &&

13187 
soid
 < 
bi
->
’d
) {

13188 ià(
e
.
	`is_upd©e
()) {

13189 
	`dout
(10è<< 
__func__
 << ": " << 
e
.
soid
 << " updatedo version "

13190 << 
e
.
v”siÚ
 << 
d’dl
;

13191 
bi
->
objeùs
.
	`”a£
(
e
.
soid
);

13192 
bi
->
objeùs
.
	`š£¹
(

13193 
	`make_·œ
(

13194 
e
.
soid
,

13195 
e
.
v”siÚ
));

13196 } ià(
e
.
	`is_d–‘e
()) {

13197 
	`dout
(10è<< 
__func__
 << ": " << 
e
.
soid
 << "„emoved" << 
d’dl
;

13198 
bi
->
objeùs
.
	`”a£
(
e
.
soid
);

13202 
	`dout
(10è<< "sÿÂšg…g†og fœ¡" << 
d’dl
;

13203 
pg_log
.
	`g‘_log
().
	`sÿn_log_aá”
(
bi
->
v”siÚ
, 
func
);

13204 
	`dout
(10è<< "sÿÂšg…rojeùed†og" << 
d’dl
;

13205 
´ojeùed_log
.
	`sÿn_log_aá”
(
bi
->
v”siÚ
, 
func
);

13206 
bi
->
v”siÚ
 = 
´ojeùed_Ï¡_upd©e
;

13208 
	`as£¹
(0 == "scan_range should have„aised bi->version…ast†og_tail");

13210 
	}
}

13212 
	gPrim¬yLogPG
::
	$sÿn_¿nge
(

13213 
mš
, 
max
, 
BackflIÁ”v®
 *
bi
,

13214 
Th»adPoŞ
::
TPHªdË
 &
hªdË
)

13216 
	`as£¹
(
	`is_locked
());

13217 
	`dout
(10è<< "sÿn_¿ngäom " << 
bi
->
begš
 << 
d’dl
;

13218 
bi
->
	`ş—r_objeùs
();

13220 
veùÜ
<
hobjeù_t
> 
ls
;

13221 
ls
.
	`»£rve
(
max
);

13222 
r
 = 
pgback’d
->
	`objeùs_li¡_·¹Ÿl
(
bi
->
begš
, 
mš
, 
max
, &
ls
, &bi->
’d
);

13223 
	`as£¹
(
r
 >= 0);

13224 
	`dout
(10è<< " gÙ " << 
ls
.
	`size
(è<< " i‹ms,‚exˆ" << 
bi
->
’d
 << 
d’dl
;

13225 
	`dout
(20è<< 
ls
 << 
d’dl
;

13227 
veùÜ
<
hobjeù_t
>::
™”©Ü
 
p
 = 
ls
.
	`begš
();… !ğls.
	`’d
(); ++p) {

13228 
hªdË
.
	`»£t__timeout
();

13229 
ObjeùCÚ‹xtRef
 
obc
;

13230 ià(
	`is_´im¬y
())

13231 
obc
 = 
objeù_cÚ‹xts
.
	`lookup
(*
p
);

13232 ià(
obc
) {

13233 
bi
->
objeùs
[*
p
] = 
obc
->
obs
.
oi
.
v”siÚ
;

13234 
	`dout
(20è<< " " << *
p
 << " " << 
obc
->
obs
.
oi
.
v”siÚ
 << 
d’dl
;

13236 
bufã¾i¡
 
bl
;

13237 
r
 = 
pgback’d
->
	`objeùs_g‘_©Œ
(*
p
, 
OI_ATTR
, &
bl
);

13243 ià(
r
 =ğ-
ENOENT
)

13246 
	`as£¹
(
r
 >= 0);

13247 
objeù_šfo_t
 
	`oi
(
bl
);

13248 
bi
->
objeùs
[*
p
] = 
oi
.
v”siÚ
;

13249 
	`dout
(20è<< " " << *
p
 << " " << 
oi
.
v”siÚ
 << 
d’dl
;

13252 
	}
}

13259 
	gPrim¬yLogPG
::
	$check_loÿl
()

13261 
	`dout
(10è<< 
__func__
 << 
d’dl
;

13263 
	`as£¹
(
šfo
.
Ï¡_upd©e
 >ğ
pg_log
.
	`g‘_
());

13265 ià(!
cù
->
_cÚf
->
osd_debug_v”ify_¡¿y_Ú_aùiv©e
)

13269 
£t
<
hobjeù_t
> 
did
;

13270 
li¡
<
pg_log_’Œy_t
>::
cÚ¡_»v”£_™”©Ü
 
p
 = 
pg_log
.
	`g‘_log
().
log
.
	`rbegš
();

13271 
p
 !ğ
pg_log
.
	`g‘_log
().
log
.
	`»nd
();

13272 ++
p
) {

13273 ià(
did
.
	`couÁ
(
p
->
soid
))

13275 
did
.
	`š£¹
(
p
->
soid
);

13277 ià(
p
->
	`is_d–‘e
(è&& !
	`is_missšg_objeù
Õ->
soid
)) {

13278 
	`dout
(10è<< " checkšg " << 
p
->
soid


13279 << "‡ˆ" << 
p
->
v”siÚ
 << 
d’dl
;

13280 
¡©
 
¡
;

13281 
r
 = 
osd
->
¡Üe
->
	`¡©
(

13282 
ch
,

13283 
	`ghobjeù_t
(
p
->
soid
, 
ghobjeù_t
::
NO_GEN
, 
pg_whßmi
.
sh¬d
),

13284 &
¡
);

13285 ià(
r
 !ğ-
ENOENT
) {

13286 
d”r
 << 
__func__
 << " " << 
p
->
soid
 << "ƒxists, but should have been "

13287 << "d–‘ed" << 
d’dl
;

13288 
	`as£¹
(0 == "erroneously…resent object");

13294 
	}
}

13301 
hobjeù_t
 
	gPrim¬yLogPG
::
	$g‘_h™_£t_cu¼’t_objeù
(
utime_t
 
¡amp
)

13303 
o¡ršg¡»am
 
ss
;

13304 
ss
 << "h™_£t_" << 
šfo
.
pgid
.pgid << "_cu¼’t_" << 
¡amp
;

13305 
hobjeù_t
 
	`hoid
(
	`sobjeù_t
(
ss
.
	`¡r
(), 
CEPH_NOSNAP
), "",

13306 
šfo
.
pgid
.
	`ps
(), info.pgid.
	`poŞ
(),

13307 
cù
->
_cÚf
->
osd_h™_£t_Çme¥aû
);

13308 
	`dout
(20è<< 
__func__
 << " " << 
hoid
 << 
d’dl
;

13309  
hoid
;

13310 
	}
}

13312 
hobjeù_t
 
	gPrim¬yLogPG
::
	$g‘_h™_£t_¬chive_objeù
(
utime_t
 
¡¬t
,

13313 
utime_t
 
’d
,

13314 
boŞ
 
usšg_gmt
)

13316 
o¡ršg¡»am
 
ss
;

13317 
ss
 << "h™_£t_" << 
šfo
.
pgid
.pgid << "_archive_";

13318 ià(
usšg_gmt
) {

13319 
¡¬t
.
	`gmtime
(
ss
) << "_";

13320 
’d
.
	`gmtime
(
ss
);

13322 
¡¬t
.
	`loÿÉime
(
ss
) << "_";

13323 
’d
.
	`loÿÉime
(
ss
);

13325 
hobjeù_t
 
	`hoid
(
	`sobjeù_t
(
ss
.
	`¡r
(), 
CEPH_NOSNAP
), "",

13326 
šfo
.
pgid
.
	`ps
(), info.pgid.
	`poŞ
(),

13327 
cù
->
_cÚf
->
osd_h™_£t_Çme¥aû
);

13328 
	`dout
(20è<< 
__func__
 << " " << 
hoid
 << 
d’dl
;

13329  
hoid
;

13330 
	}
}

13332 
	gPrim¬yLogPG
::
	$h™_£t_ş—r
()

13334 
	`dout
(20è<< 
__func__
 << 
d’dl
;

13335 
h™_£t
.
	`»£t
();

13336 
h™_£t_¡¬t_¡amp
 = 
	`utime_t
();

13337 
	}
}

13339 
	gPrim¬yLogPG
::
	$h™_£t_£tup
()

13341 ià(!
	`is_aùive
() ||

13342 !
	`is_´im¬y
()) {

13343 
	`h™_£t_ş—r
();

13347 ià(
	`is_aùive
(è&& 
	`is_´im¬y
() &&

13348 (!
poŞ
.
šfo
.
h™_£t_couÁ
 ||

13349 !
poŞ
.
šfo
.
h™_£t_³riod
 ||

13350 
poŞ
.
šfo
.
h™_£t_·¿ms
.
	`g‘_ty³
(è=ğ
H™S‘
::
TYPE_NONE
)) {

13351 
	`h™_£t_ş—r
();

13354 
	`h™_£t_»move_®l
();

13359 
	`h™_£t_ü—‹
();

13363 
	`h™_£t_­¶y_log
();

13364 
	}
}

13366 
	gPrim¬yLogPG
::
	$h™_£t_»move_®l
()

13369 
li¡
<
pg_h™_£t_šfo_t
>::
™”©Ü
 
p
 = 
šfo
.
h™_£t
.
hi¡Üy
.
	`begš
();

13370 
p
 !ğ
šfo
.
h™_£t
.
hi¡Üy
.
	`’d
();

13371 ++
p
) {

13372 
hobjeù_t
 
aoid
 = 
	`g‘_h™_£t_¬chive_objeù
(
p
->
begš
,…->
’d
,…->
usšg_gmt
);

13375 ià(
	`is_deg¿ded_Ü_backflšg_objeù
(
aoid
))

13377 ià(
	`wr™e_blocked_by_süub
(
aoid
))

13381 ià(!
šfo
.
h™_£t
.
hi¡Üy
.
	`em±y
()) {

13382 
li¡
<
pg_h™_£t_šfo_t
>::
»v”£_™”©Ü
 
p
 = 
šfo
.
h™_£t
.
hi¡Üy
.
	`rbegš
();

13383 
	`as£¹
(
p
 !ğ
šfo
.
h™_£t
.
hi¡Üy
.
	`»nd
());

13384 
hobjeù_t
 
oid
 = 
	`g‘_h™_£t_¬chive_objeù
(
p
->
begš
,…->
’d
,…->
usšg_gmt
);

13385 
	`as£¹
(!
	`is_deg¿ded_Ü_backflšg_objeù
(
oid
));

13386 
ObjeùCÚ‹xtRef
 
obc
 = 
	`g‘_objeù_cÚ‹xt
(
oid
, 
çl£
);

13387 
	`as£¹
(
obc
);

13389 
OpCÚ‹xtUPŒ
 
ùx
 = 
	`sim¶e_İc_ü—‹
(
obc
);

13390 
ùx
->
©_v”siÚ
 = 
	`g‘_Ãxt_v”siÚ
();

13391 
ùx
->
upd©ed_h£t_hi¡Üy
 = 
šfo
.
h™_£t
;

13392 
utime_t
 
now
 = 
	`ûph_şock_now
();

13393 
ùx
->
mtime
 = 
now
;

13394 
	`h™_£t_Œim
(
ùx
, 0);

13395 
	`sim¶e_İc_subm™
(
¡d
::
	`move
(
ùx
));

13398 
šfo
.
h™_£t
 = 
	`pg_h™_£t_hi¡Üy_t
();

13399 ià(
ag’t_¡©e
) {

13400 
ag’t_¡©e
->
	`disÿrd_h™_£ts
();

13402 
	}
}

13404 
	gPrim¬yLogPG
::
	$h™_£t_ü—‹
()

13406 
utime_t
 
now
 = 
	`ûph_şock_now
();

13408 
H™S‘
::
P¬ams
 
	`·¿ms
(
poŞ
.
šfo
.
h™_£t_·¿ms
);

13410 
	`dout
(20è<< 
__func__
 << " " << 
·¿ms
 << 
d’dl
;

13411 ià(
poŞ
.
šfo
.
h™_£t_·¿ms
.
	`g‘_ty³
(è=ğ
H™S‘
::
TYPE_BLOOM
) {

13412 
BloomH™S‘
::
P¬ams
 *
p
 =

13413 
¡©ic_ÿ¡
<
BloomH™S‘
::
P¬ams
*>(
·¿ms
.
im¶
.
	`g‘
());

13416 
p
->
	`£t_åp
Õ->
	`g‘_åp
(è/ 
poŞ
.
šfo
.
h™_£t_couÁ
);

13417 ià(
p
->
	`g‘_åp
() <= 0.0)

13418 
p
->
	`£t_åp
(.01);

13422 ià(
p
->
rg‘_size
 =ğ0 && 
h™_£t
) {

13423 
utime_t
 
dur
 = 
now
 - 
h™_£t_¡¬t_¡amp
;

13424 
unique
 = 
h™_£t
->
	`­´ox_unique_š£¹_couÁ
();

13425 
	`dout
(20è<< 
__func__
 << "…»viou £ˆhad‡µrox " << 
unique


13426 << " uniqu™em ov” " << 
dur
 << " secÚds" << 
d’dl
;

13427 
p
->
rg‘_size
 = ()
unique
 * ()
poŞ
.
šfo
.
h™_£t_³riod


13428 / ()
dur
;

13430 ià(
p
->
rg‘_size
 <

13431 
¡©ic_ÿ¡
<
ušt64_t
>(
cù
->
_cÚf
->
osd_h™_£t_mš_size
))

13432 
p
->
rg‘_size
 = 
cù
->
_cÚf
->
osd_h™_£t_mš_size
;

13434 ià(
p
->
rg‘_size


13435 > 
¡©ic_ÿ¡
<
ušt64_t
>(
cù
->
_cÚf
->
osd_h™_£t_max_size
))

13436 
p
->
rg‘_size
 = 
cù
->
_cÚf
->
osd_h™_£t_max_size
;

13438 
p
->
£ed
 = 
now
.
	`£c
();

13440 
	`dout
(10è<< 
__func__
 << "¬g‘_siz" << 
p
->
rg‘_size


13441 << " fµ " << 
p
->
	`g‘_åp
(è<< 
d’dl
;

13443 
h™_£t
.
	`»£t
(
Ãw
 
	`H™S‘
(
·¿ms
));

13444 
h™_£t_¡¬t_¡amp
 = 
now
;

13445 
	}
}

13453 
boŞ
 
	gPrim¬yLogPG
::
	$h™_£t_­¶y_log
()

13455 ià(!
h™_£t
)

13456  
çl£
;

13458 
ev”siÚ_t
 
to
 = 
šfo
.
Ï¡_upd©e
;

13459 
ev”siÚ_t
 
äom
 = 
šfo
.
h™_£t
.
cu¼’t_Ï¡_upd©e
;

13460 ià(
to
 <ğ
äom
) {

13461 
	`dout
(20è<< 
__func__
 << "‚Øupd©e" << 
d’dl
;

13462  
çl£
;

13465 
	`dout
(20è<< 
__func__
 << " " << 
to
 << " .. " << 
šfo
.
Ï¡_upd©e
 << 
d’dl
;

13466 
li¡
<
pg_log_’Œy_t
>::
cÚ¡_»v”£_™”©Ü
 
p
 = 
pg_log
.
	`g‘_log
().
log
.
	`rbegš
();

13467 
p
 !ğ
pg_log
.
	`g‘_log
().
log
.
	`»nd
(è&&…->
v”siÚ
 > 
to
)

13468 ++
p
;

13469 
p
 !ğ
pg_log
.
	`g‘_log
().
log
.
	`»nd
(è&&…->
v”siÚ
 > 
äom
) {

13470 
h™_£t
->
	`š£¹
(
p
->
soid
);

13471 ++
p
;

13474  
Œue
;

13475 
	}
}

13477 
	gPrim¬yLogPG
::
	$h™_£t_³rsi¡
()

13479 
	`dout
(10è<< 
__func__
 << 
d’dl
;

13480 
bufã¾i¡
 
bl
;

13481 
max
 = 
poŞ
.
šfo
.
h™_£t_couÁ
;

13483 
utime_t
 
now
 = 
	`ûph_şock_now
();

13484 
hobjeù_t
 
oid
;

13488 
li¡
<
pg_h™_£t_šfo_t
>::
™”©Ü
 
p
 = 
šfo
.
h™_£t
.
hi¡Üy
.
	`begš
();

13489 
p
 !ğ
šfo
.
h™_£t
.
hi¡Üy
.
	`’d
();

13490 ++
p
) {

13491 
hobjeù_t
 
aoid
 = 
	`g‘_h™_£t_¬chive_objeù
(
p
->
begš
,…->
’d
,…->
usšg_gmt
);

13494 ià(
	`is_deg¿ded_Ü_backflšg_objeù
(
aoid
))

13496 ià(
	`wr™e_blocked_by_süub
(
aoid
))

13506 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
p
 = 
backfl_rg‘s
.
	`begš
();

13507 
p
 !ğ
backfl_rg‘s
.
	`’d
();

13508 ++
p
) {

13509 
	`as£¹
(
³”_šfo
.
	`couÁ
(*
p
));

13510 cÚ¡ 
pg_šfo_t
& 
pi
 = 
³”_šfo
[*
p
];

13511 ià(
pi
.
Ï¡_backfl
 =ğ
	`hobjeù_t
() ||

13512 
pi
.
Ï¡_backfl
.
	`g‘_hash
(è=ğ
šfo
.
pgid
.
	`ps
()) {

13513 
	`dout
(10è<< 
__func__
 << " backfÈrg‘ osd." << *
p


13515 << 
d’dl
;

13521 
pg_h™_£t_šfo_t
 
Ãw_h£t
 = 
	`pg_h™_£t_šfo_t
(
poŞ
.
šfo
.
u£_gmt_h™£t
);

13522 
Ãw_h£t
.
begš
 = 
h™_£t_¡¬t_¡amp
;

13523 
Ãw_h£t
.
’d
 = 
now
;

13524 
oid
 = 
	`g‘_h™_£t_¬chive_objeù
(

13525 
Ãw_h£t
.
begš
,

13526 
Ãw_h£t
.
’d
,

13527 
Ãw_h£t
.
usšg_gmt
);

13530 ià(
	`wr™e_blocked_by_süub
(
oid
))

13533 
h™_£t
->
	`£®
();

13534 
	`’code
(*
h™_£t
, 
bl
);

13535 
	`dout
(20è<< 
__func__
 << "‡rchiv" << 
oid
 << 
d’dl
;

13537 ià(
ag’t_¡©e
) {

13538 
ag’t_¡©e
->
	`add_h™_£t
(
Ãw_h£t
.
begš
, 
h™_£t
);

13539 
ušt32_t
 
size
 = 
ag’t_¡©e
->
h™_£t_m­
.
	`size
();

13540 ià(
size
 >ğ
poŞ
.
šfo
.
h™_£t_couÁ
) {

13541 
size
 = 
poŞ
.
šfo
.
h™_£t_couÁ
 > 0 ?…ool.info.hit_set_count - 1: 0;

13543 
	`h™_£t_š_memÜy_Œim
(
size
);

13546 
ObjeùCÚ‹xtRef
 
obc
 = 
	`g‘_objeù_cÚ‹xt
(
oid
, 
Œue
);

13547 
OpCÚ‹xtUPŒ
 
ùx
 = 
	`sim¶e_İc_ü—‹
(
obc
);

13549 
ùx
->
©_v”siÚ
 = 
	`g‘_Ãxt_v”siÚ
();

13550 
ùx
->
upd©ed_h£t_hi¡Üy
 = 
šfo
.
h™_£t
;

13551 
pg_h™_£t_hi¡Üy_t
 &
upd©ed_h™_£t_hi¡
 = *(
ùx
->
upd©ed_h£t_hi¡Üy
);

13553 
upd©ed_h™_£t_hi¡
.
cu¼’t_Ï¡_upd©e
 = 
šfo
.
Ï¡_upd©e
;

13554 
Ãw_h£t
.
v”siÚ
 = 
ùx
->
©_v”siÚ
;

13556 
upd©ed_h™_£t_hi¡
.
hi¡Üy
.
	`push_back
(
Ãw_h£t
);

13557 
	`h™_£t_ü—‹
();

13560 
obc
->
obs
.
oi
.
v”siÚ
 = 
ùx
->
©_v”siÚ
;

13561 
obc
->
obs
.
oi
.
mtime
 = 
now
;

13562 
obc
->
obs
.
oi
.
size
 = 
bl
.
	`Ëngth
();

13563 
obc
->
obs
.
exi¡s
 = 
Œue
;

13564 
obc
->
obs
.
oi
.
	`£t_d©a_dige¡
(
bl
.
	`üc32c
(-1));

13566 
ùx
->
Ãw_obs
 = 
obc
->
obs
;

13568 
ùx
->
Ãw_¢­£t
 = 
obc
->
ssc
->
¢­£t
;

13570 
ùx
->
d–_¡©s
.
num_objeùs
++;

13571 
ùx
->
d–_¡©s
.
num_objeùs_h™_£t_¬chive
++;

13573 
ùx
->
d–_¡©s
.
num_by‹s
 +ğ
bl
.
	`Ëngth
();

13574 
ùx
->
d–_¡©s
.
num_by‹s_h™_£t_¬chive
 +ğ
bl
.
	`Ëngth
();

13576 
bufã¾i¡
 
bss
;

13577 
	`’code
(
ùx
->
Ãw_¢­£t
, 
bss
);

13578 
bufã¾i¡
 
	`boi
((
ùx
->
Ãw_obs
.
oi
));

13579 
	`’code
(
ùx
->
Ãw_obs
.
oi
, 
boi
,

13580 
	`g‘_osdm­
()->
	`g‘_ã©u»s
(
CEPH_ENTITY_TYPE_OSD
, 
nuÎ±r
));

13582 
ùx
->
İ_t
->
	`ü—‹
(
oid
);

13583 ià(
bl
.
	`Ëngth
()) {

13584 
ùx
->
İ_t
->
	`wr™e
(
oid
, 0, 
bl
.
	`Ëngth
(), bl, 0);

13586 
m­
 <
¡ršg
, 
bufã¾i¡
> 
©Œs
;

13587 
©Œs
[
OI_ATTR
].
	`şaim
(
boi
);

13588 
©Œs
[
SS_ATTR
].
	`şaim
(
bss
);

13589 
	`£‰rs_maybe_ÿche
(
ùx
->
obc
, ctx->
İ_t
.
	`g‘
(), 
©Œs
);

13590 
ùx
->
log
.
	`push_back
(

13591 
	`pg_log_’Œy_t
(

13592 
pg_log_’Œy_t
::
MODIFY
,

13593 
oid
,

13594 
ùx
->
©_v”siÚ
,

13595 
	`ev”siÚ_t
(),

13597 
	`osd_»qid_t
(),

13598 
ùx
->
mtime
,

13602 
	`h™_£t_Œim
(
ùx
, 
max
);

13604 
	`sim¶e_İc_subm™
(
¡d
::
	`move
(
ùx
));

13605 
	}
}

13607 
	gPrim¬yLogPG
::
	$h™_£t_Œim
(
OpCÚ‹xtUPŒ
 &
ùx
, 
max
)

13609 
	`as£¹
(
ùx
->
upd©ed_h£t_hi¡Üy
);

13610 
pg_h™_£t_hi¡Üy_t
 &
upd©ed_h™_£t_hi¡
 =

13611 *(
ùx
->
upd©ed_h£t_hi¡Üy
);

13612 
num
 = 
upd©ed_h™_£t_hi¡
.
hi¡Üy
.
	`size
();‚um > 
max
; --num) {

13613 
li¡
<
pg_h™_£t_šfo_t
>::
™”©Ü
 
p
 = 
upd©ed_h™_£t_hi¡
.
hi¡Üy
.
	`begš
();

13614 
	`as£¹
(
p
 !ğ
upd©ed_h™_£t_hi¡
.
hi¡Üy
.
	`’d
());

13615 
hobjeù_t
 
oid
 = 
	`g‘_h™_£t_¬chive_objeù
(
p
->
begš
,…->
’d
,…->
usšg_gmt
);

13617 
	`as£¹
(!
	`is_deg¿ded_Ü_backflšg_objeù
(
oid
));

13619 
	`dout
(20è<< 
__func__
 << "„emovšg " << 
oid
 << 
d’dl
;

13620 ++
ùx
->
©_v”siÚ
.
v”siÚ
;

13621 
ùx
->
log
.
	`push_back
(

13622 
	`pg_log_’Œy_t
(
pg_log_’Œy_t
::
DELETE
,

13623 
oid
,

13624 
ùx
->
©_v”siÚ
,

13625 
p
->
v”siÚ
,

13627 
	`osd_»qid_t
(),

13628 
ùx
->
mtime
,

13631 
ùx
->
İ_t
->
	`»move
(
oid
);

13632 
upd©ed_h™_£t_hi¡
.
hi¡Üy
.
	`pİ_äÚt
();

13634 
ObjeùCÚ‹xtRef
 
obc
 = 
	`g‘_objeù_cÚ‹xt
(
oid
, 
çl£
);

13635 
	`as£¹
(
obc
);

13636 --
ùx
->
d–_¡©s
.
num_objeùs
;

13637 --
ùx
->
d–_¡©s
.
num_objeùs_h™_£t_¬chive
;

13638 
ùx
->
d–_¡©s
.
num_by‹s
 -ğ
obc
->
obs
.
oi
.
size
;

13639 
ùx
->
d–_¡©s
.
num_by‹s_h™_£t_¬chive
 -ğ
obc
->
obs
.
oi
.
size
;

13641 
	}
}

13643 
	gPrim¬yLogPG
::
	$h™_£t_š_memÜy_Œim
(
ušt32_t
 
max_š_memÜy
)

13645 
ag’t_¡©e
->
h™_£t_m­
.
	`size
(è> 
max_š_memÜy
) {

13646 
ag’t_¡©e
->
	`»move_Şde¡_h™_£t
();

13648 
	}
}

13654 
	gPrim¬yLogPG
::
	$ag’t_£tup
()

13656 
	`as£¹
(
	`is_locked
());

13657 ià(!
	`is_aùive
() ||

13658 !
	`is_´im¬y
() ||

13659 
poŞ
.
šfo
.
ÿche_mode
 =ğ
pg_poŞ_t
::
CACHEMODE_NONE
 ||

13660 
poŞ
.
šfo
.
t›r_of
 < 0 ||

13661 !
	`g‘_osdm­
()->
	`have_pg_poŞ
(
poŞ
.
šfo
.
t›r_of
)) {

13662 
	`ag’t_ş—r
();

13665 ià(!
ag’t_¡©e
) {

13666 
ag’t_¡©e
.
	`»£t
(
Ãw
 
T›rAg’tS‹
);

13669 
ag’t_¡©e
->
pos™iÚ
 = 
	`hobjeù_t
();

13670 
ag’t_¡©e
->
pos™iÚ
.
poŞ
 = 
šfo
.
pgid
.
	`poŞ
();

13671 
ag’t_¡©e
->
pos™iÚ
.
	`£t_hash
(
poŞ
.
šfo
.
	`g‘_¿ndom_pg_pos™iÚ
(

13672 
šfo
.
pgid
.pgid,

13673 
	`¿nd
()));

13674 
ag’t_¡©e
->
¡¬t
 =‡g’t_¡©e->
pos™iÚ
;

13676 
	`dout
(10è<< 
__func__
 << "‡llocated‚ew state,…osition "

13677 << 
ag’t_¡©e
->
pos™iÚ
 << 
d’dl
;

13679 
	`dout
(10è<< 
__func__
 << " k“pšgƒxi¡šg s‹" << 
d’dl
;

13682 ià(
šfo
.
¡©s
.
¡©s_šv®id
) {

13683 
osd
->
şog
->
	`w¬n
(è<< "pg " << 
šfo
.
pgid
 << " has invalid (post-split) stats; must scrub beforeier‡gent can‡ctivate";

13686 
	`ag’t_choo£_mode
();

13687 
	}
}

13689 
	gPrim¬yLogPG
::
	$ag’t_ş—r
()

13691 
	`ag’t_¡İ
();

13692 
ag’t_¡©e
.
	`»£t
(
NULL
);

13693 
	}
}

13696 
boŞ
 
	gPrim¬yLogPG
::
	$ag’t_wÜk
(
¡¬t_max
, 
ag’t_æush_quÙa
)

13698 
	`lock
();

13699 ià(!
ag’t_¡©e
) {

13700 
	`dout
(10è<< 
__func__
 << "‚Øag’ˆ¡©e, stİpšg" << 
d’dl
;

13701 
	`uÆock
();

13702  
Œue
;

13705 
	`as£¹
(!
d–‘šg
);

13707 ià(
ag’t_¡©e
->
	`is_idË
()) {

13708 
	`dout
(10è<< 
__func__
 << " idË, stİpšg" << 
d’dl
;

13709 
	`uÆock
();

13710  
Œue
;

13713 
osd
->
logg”
->
	`šc
(
l_osd_ag’t_wake
);

13715 
	`dout
(10è<< 
__func__


13716 << " max " << 
¡¬t_max


13717 << ", flush " << 
ag’t_¡©e
->
	`g‘_æush_mode_Çme
()

13718 << ",ƒviù " << 
ag’t_¡©e
->
	`g‘_eviù_mode_Çme
()

13719 << ",…o " << 
ag’t_¡©e
->
pos™iÚ


13720 << 
d’dl
;

13721 
	`as£¹
(
	`is_´im¬y
());

13722 
	`as£¹
(
	`is_aùive
());

13724 
	`ag’t_lßd_h™_£ts
();

13726 cÚ¡ 
pg_poŞ_t
 *
ba£_poŞ
 = 
	`g‘_osdm­
()->
	`g‘_pg_poŞ
(
poŞ
.
šfo
.
t›r_of
);

13727 
	`as£¹
(
ba£_poŞ
);

13729 
ls_mš
 = 1;

13730 
ls_max
 = 
cù
->
_cÚf
->
osd_poŞ_deçuÉ_ÿche_max_eviù_check_size
;

13737 
veùÜ
<
hobjeù_t
> 
ls
;

13738 
hobjeù_t
 
Ãxt
;

13739 
r
 = 
pgback’d
->
	`objeùs_li¡_·¹Ÿl
(
ag’t_¡©e
->
pos™iÚ
, 
ls_mš
, 
ls_max
,

13740 &
ls
, &
Ãxt
);

13741 
	`as£¹
(
r
 >= 0);

13742 
	`dout
(20è<< 
__func__
 << " gÙ " << 
ls
.
	`size
(è<< " objeùs" << 
d’dl
;

13743 
¡¬‹d
 = 0;

13744 
veùÜ
<
hobjeù_t
>::
™”©Ü
 
p
 = 
ls
.
	`begš
();

13745 
p
 !ğ
ls
.
	`’d
();

13746 ++
p
) {

13747 ià(
p
->
n¥aû
 =ğ
cù
->
_cÚf
->
osd_h™_£t_Çme¥aû
) {

13748 
	`dout
(20è<< 
__func__
 << " sk (h™ s‘è" << *
p
 << 
d’dl
;

13749 
osd
->
logg”
->
	`šc
(
l_osd_ag’t_sk
);

13752 ià(
	`is_deg¿ded_Ü_backflšg_objeù
(*
p
)) {

13753 
	`dout
(20è<< 
__func__
 << " sk (deg¿dedè" << *
p
 << 
d’dl
;

13754 
osd
->
logg”
->
	`šc
(
l_osd_ag’t_sk
);

13757 ià(
	`is_missšg_objeù
(
p
->
	`g‘_h—d
())) {

13758 
	`dout
(20è<< 
__func__
 << " sk (missšg h—dè" << *
p
 << 
d’dl
;

13759 
osd
->
logg”
->
	`šc
(
l_osd_ag’t_sk
);

13762 
ObjeùCÚ‹xtRef
 
obc
 = 
	`g‘_objeù_cÚ‹xt
(*
p
, 
çl£
, 
NULL
);

13763 ià(!
obc
) {

13765 
	`dout
(20è<< 
__func__
 << " sk (nØobcè" << *
p
 << 
d’dl
;

13766 
osd
->
logg”
->
	`šc
(
l_osd_ag’t_sk
);

13769 ià(!
obc
->
obs
.
exi¡s
) {

13770 
	`dout
(20è<< 
__func__
 << " sk (dÃè" << 
obc
->
obs
.
oi
.
soid
 << 
d’dl
;

13771 
osd
->
logg”
->
	`šc
(
l_osd_ag’t_sk
);

13774 ià(
	`¿nge_š‹r£ùs_süub
(
obc
->
obs
.
oi
.
soid
,

13775 
obc
->
obs
.
oi
.
soid
.
	`g‘_h—d
())) {

13776 
	`dout
(20è<< 
__func__
 << " sk (süubbšgè" << 
obc
->
obs
.
oi
 << 
d’dl
;

13777 
osd
->
logg”
->
	`šc
(
l_osd_ag’t_sk
);

13780 ià(
obc
->
	`is_blocked
()) {

13781 
	`dout
(20è<< 
__func__
 << " sk (blockedè" << 
obc
->
obs
.
oi
 << 
d’dl
;

13782 
osd
->
logg”
->
	`šc
(
l_osd_ag’t_sk
);

13785 ià(
obc
->
	`is_»que¡_³ndšg
()) {

13786 
	`dout
(20è<< 
__func__
 << " sk (»que¡…’dšgè" << 
obc
->
obs
.
oi
 << 
d’dl
;

13787 
osd
->
logg”
->
	`šc
(
l_osd_ag’t_sk
);

13792 ià(!
ba£_poŞ
->
	`suµÜts_om­
() &&

13793 
obc
->
obs
.
oi
.
	`is_om­
()) {

13794 
	`dout
(20è<< 
__func__
 << " sk (om­ØECè" << 
obc
->
obs
.
oi
 << 
d’dl
;

13795 
osd
->
logg”
->
	`šc
(
l_osd_ag’t_sk
);

13799 ià(
ag’t_¡©e
->
eviù_mode
 !ğ
T›rAg’tS‹
::
EVICT_MODE_IDLE
 &&

13800 
	`ag’t_maybe_eviù
(
obc
, 
çl£
))

13801 ++
¡¬‹d
;

13802 ià(
ag’t_¡©e
->
æush_mode
 !ğ
T›rAg’tS‹
::
FLUSH_MODE_IDLE
 &&

13803 
ag’t_æush_quÙa
 > 0 && 
	`ag’t_maybe_æush
(
obc
)) {

13804 ++
¡¬‹d
;

13805 --
ag’t_æush_quÙa
;

13807 ià(
¡¬‹d
 >ğ
¡¬t_max
) {

13809 ià(++
p
 !ğ
ls
.
	`’d
())

13810 
Ãxt
 = *
p
;

13815 ià(++
ag’t_¡©e
->
hi¡_age
 > 
cù
->
_cÚf
->
osd_ag’t_hi¡_h®æiã
) {

13816 
	`dout
(20è<< 
__func__
 << "„e£‰šg‡timªdem°hi¡og¿ms" << 
d’dl
;

13817 
ag’t_¡©e
->
hi¡_age
 = 0;

13818 
ag’t_¡©e
->
‹mp_hi¡
.
	`deÿy
();

13822 
tÙ®_¡¬‹d
 = 
ag’t_¡©e
->
¡¬‹d
 + started;

13823 
boŞ
 
Ãed_d–ay
 = 
çl£
;

13825 
	`dout
(20è<< 
__func__
 << " s¹…o " << 
ag’t_¡©e
->
pos™iÚ


13826 << "‚exˆ¡¬ˆpo " << 
Ãxt


13827 << " s¹ed " << 
tÙ®_¡¬‹d
 << 
d’dl
;

13832 ià(
ag’t_¡©e
->
pos™iÚ
 <‡g’t_¡©e->
¡¬t
 &&

13833 
Ãxt
 >ğ
ag’t_¡©e
->
¡¬t
) {

13834 
	`dout
(20è<< 
__func__
 << " w¿°¬ound " << 
ag’t_¡©e
->
¡¬t
 << 
d’dl
;

13835 ià(
tÙ®_¡¬‹d
 == 0)

13836 
Ãed_d–ay
 = 
Œue
;

13838 
tÙ®_¡¬‹d
 = 0;

13839 
ag’t_¡©e
->
¡¬t
 = 
Ãxt
;

13841 
ag’t_¡©e
->
¡¬‹d
 = 
tÙ®_¡¬‹d
;

13844 ià(
Ãxt
.
	`is_max
())

13845 
ag’t_¡©e
->
pos™iÚ
 = 
	`hobjeù_t
();

13847 
ag’t_¡©e
->
pos™iÚ
 = 
Ãxt
;

13850 
	`h™_£t_š_memÜy_Œim
(
poŞ
.
šfo
.
h™_£t_couÁ
);

13852 ià(
Ãed_d–ay
) {

13853 
	`as£¹
(
ag’t_¡©e
->
d–ayšg
 =ğ
çl£
);

13854 
	`ag’t_d–ay
();

13855 
	`uÆock
();

13856  
çl£
;

13858 
	`ag’t_choo£_mode
();

13859 
	`uÆock
();

13860  
Œue
;

13861 
	}
}

13863 
	gPrim¬yLogPG
::
	$ag’t_lßd_h™_£ts
()

13865 ià(
ag’t_¡©e
->
eviù_mode
 =ğ
T›rAg’tS‹
::
EVICT_MODE_IDLE
) {

13869 ià(
ag’t_¡©e
->
h™_£t_m­
.
	`size
(è< 
šfo
.
h™_£t
.
hi¡Üy
.size()) {

13870 
	`dout
(10è<< 
__func__
 << 
d’dl
;

13871 
li¡
<
pg_h™_£t_šfo_t
>::
™”©Ü
 
p
 = 
šfo
.
h™_£t
.
hi¡Üy
.
	`begš
();

13872 
p
 !ğ
šfo
.
h™_£t
.
hi¡Üy
.
	`’d
(); ++p) {

13873 ià(
ag’t_¡©e
->
h™_£t_m­
.
	`couÁ
(
p
->
begš
.
	`£c
()) == 0) {

13874 
	`dout
(10è<< 
__func__
 << "†ßdšg " << 
p
->
begš
 << "-"

13875 << 
p
->
’d
 << 
d’dl
;

13876 ià(!
poŞ
.
šfo
.
	`is_»¶iÿ‹d
()) {

13878 
d”r
 << 
__func__
 << " oÀnÚ-»¶iÿ‹d…oŞ" << 
d’dl
;

13882 
hobjeù_t
 
oid
 = 
	`g‘_h™_£t_¬chive_objeù
(
p
->
begš
,…->
’d
,…->
usšg_gmt
);

13883 ià(
	`is_uÄ—dabË_objeù
(
oid
)) {

13884 
	`dout
(10è<< 
__func__
 << " uÄ—dabË " << 
oid
 << ", wa™šg" << 
d’dl
;

13888 
ObjeùCÚ‹xtRef
 
obc
 = 
	`g‘_objeù_cÚ‹xt
(
oid
, 
çl£
);

13889 ià(!
obc
) {

13890 
d”r
 << 
__func__
 << ": could‚Ù†ßd h™£ˆ" << 
oid
 << 
d’dl
;

13894 
bufã¾i¡
 
bl
;

13896 
r
 = 
osd
->
¡Üe
->
	`»ad
(
ch
, 
	`ghobjeù_t
(
oid
), 0, 0, 
bl
);

13897 
	`as£¹
(
r
 >= 0);

13899 
H™S‘Ref
 
	`hs
(
Ãw
 
H™S‘
);

13900 
bufã¾i¡
::
™”©Ü
 
pbl
 = 
bl
.
	`begš
();

13901 
	`decode
(*
hs
, 
pbl
);

13902 
ag’t_¡©e
->
	`add_h™_£t
(
p
->
begš
.
	`£c
(), 
hs
);

13906 
	}
}

13908 
boŞ
 
	gPrim¬yLogPG
::
	$ag’t_maybe_æush
(
ObjeùCÚ‹xtRef
& 
obc
)

13910 ià(!
obc
->
obs
.
oi
.
	`is_dœty
()) {

13911 
	`dout
(20è<< 
__func__
 << " sk (ş—nè" << 
obc
->
obs
.
oi
 << 
d’dl
;

13912 
osd
->
logg”
->
	`šc
(
l_osd_ag’t_sk
);

13913  
çl£
;

13915 ià(
obc
->
obs
.
oi
.
	`is_ÿche_pšÃd
()) {

13916 
	`dout
(20è<< 
__func__
 << " sk (ÿche_pšÃdè" << 
obc
->
obs
.
oi
 << 
d’dl
;

13917 
osd
->
logg”
->
	`šc
(
l_osd_ag’t_sk
);

13918  
çl£
;

13921 
utime_t
 
now
 = 
	`ûph_şock_now
();

13922 
utime_t
 
ob_loÿl_mtime
;

13923 ià(
obc
->
obs
.
oi
.
loÿl_mtime
 !ğ
	`utime_t
()) {

13924 
ob_loÿl_mtime
 = 
obc
->
obs
.
oi
.
loÿl_mtime
;

13926 
ob_loÿl_mtime
 = 
obc
->
obs
.
oi
.
mtime
;

13928 
boŞ
 
eviù_mode_fuÎ
 =

13929 (
ag’t_¡©e
->
eviù_mode
 =ğ
T›rAg’tS‹
::
EVICT_MODE_FULL
);

13930 ià(!
eviù_mode_fuÎ
 &&

13931 
obc
->
obs
.
oi
.
soid
.
¢­
 =ğ
CEPH_NOSNAP
 &&

13932 (
ob_loÿl_mtime
 + 
	`utime_t
(
poŞ
.
šfo
.
ÿche_mš_æush_age
, 0è> 
now
)) {

13933 
	`dout
(20è<< 
__func__
 << " sk (toØyoungè" << 
obc
->
obs
.
oi
 << 
d’dl
;

13934 
osd
->
logg”
->
	`šc
(
l_osd_ag’t_sk
);

13935  
çl£
;

13938 ià(
osd
->
	`ag’t_is_aùive_oid
(
obc
->
obs
.
oi
.
soid
)) {

13939 
	`dout
(20è<< 
__func__
 << " sk (æushšgè" << 
obc
->
obs
.
oi
 << 
d’dl
;

13940 
osd
->
logg”
->
	`šc
(
l_osd_ag’t_sk
);

13941  
çl£
;

13944 
	`dout
(10è<< 
__func__
 << " flushšg " << 
obc
->
obs
.
oi
 << 
d’dl
;

13949 
hobjeù_t
 
oid
 = 
obc
->
obs
.
oi
.
soid
;

13950 
osd
->
	`ag’t_¡¬t_İ
(
oid
);

13952 
¡d
::
funùiÚ
<()> 
Ú_æush
 = [
this
, 
oid
]() {

13953 
osd
->
	`ag’t_fšish_İ
(
oid
);

13956 
»suÉ
 = 
	`¡¬t_æush
(

13957 
	`OpReque¡Ref
(), 
obc
, 
çl£
, 
NULL
,

13958 
Ú_æush
);

13959 ià(
»suÉ
 !ğ-
EINPROGRESS
) {

13960 
	`Ú_æush
();

13961 
	`dout
(10è<< 
__func__
 << " s¹_æush(èçed " << 
obc
->
obs
.
oi


13962 << " w™h " << 
»suÉ
 << 
d’dl
;

13963 
osd
->
logg”
->
	`šc
(
l_osd_ag’t_sk
);

13964  
çl£
;

13967 
osd
->
logg”
->
	`šc
(
l_osd_ag’t_æush
);

13968  
Œue
;

13969 
	}
}

13971 
boŞ
 
	gPrim¬yLogPG
::
	$ag’t_maybe_eviù
(
ObjeùCÚ‹xtRef
& 
obc
, 
boŞ
 
aá”_æush
)

13973 cÚ¡ 
hobjeù_t
& 
soid
 = 
obc
->
obs
.
oi
.soid;

13974 ià(!
aá”_æush
 && 
obc
->
obs
.
oi
.
	`is_dœty
()) {

13975 
	`dout
(20è<< 
__func__
 << " sk (dœtyè" << 
obc
->
obs
.
oi
 << 
d’dl
;

13976  
çl£
;

13978 ià(!
obc
->
obs
.
oi
.
w©ch”s
.
	`em±y
()) {

13979 
	`dout
(20è<< 
__func__
 << " sk (w©ch”sè" << 
obc
->
obs
.
oi
 << 
d’dl
;

13980  
çl£
;

13982 ià(
obc
->
	`is_blocked
()) {

13983 
	`dout
(20è<< 
__func__
 << " sk (blockedè" << 
obc
->
obs
.
oi
 << 
d’dl
;

13984  
çl£
;

13986 ià(
obc
->
obs
.
oi
.
	`is_ÿche_pšÃd
()) {

13987 
	`dout
(20è<< 
__func__
 << " sk (ÿche_pšÃdè" << 
obc
->
obs
.
oi
 << 
d’dl
;

13988  
çl£
;

13991 ià(
soid
.
¢­
 =ğ
CEPH_NOSNAP
) {

13992 
»suÉ
 = 
	`_v”ify_no_h—d_şÚes
(
soid
, 
obc
->
ssc
->
¢­£t
);

13993 ià(
»suÉ
 < 0) {

13994 
	`dout
(20è<< 
__func__
 << " sk (şÚesè" << 
obc
->
obs
.
oi
 << 
d’dl
;

13995  
çl£
;

13999 ià(
ag’t_¡©e
->
eviù_mode
 !ğ
T›rAg’tS‹
::
EVICT_MODE_FULL
) {

14001 
utime_t
 
now
 = 
	`ûph_şock_now
();

14002 
utime_t
 
ob_loÿl_mtime
;

14003 ià(
obc
->
obs
.
oi
.
loÿl_mtime
 !ğ
	`utime_t
()) {

14004 
ob_loÿl_mtime
 = 
obc
->
obs
.
oi
.
loÿl_mtime
;

14006 
ob_loÿl_mtime
 = 
obc
->
obs
.
oi
.
mtime
;

14008 ià(
ob_loÿl_mtime
 + 
	`utime_t
(
poŞ
.
šfo
.
ÿche_mš_eviù_age
, 0è> 
now
) {

14009 
	`dout
(20è<< 
__func__
 << " sk (toØyoungè" << 
obc
->
obs
.
oi
 << 
d’dl
;

14010 
osd
->
logg”
->
	`šc
(
l_osd_ag’t_sk
);

14011  
çl£
;

14014 
‹mp
 = 0;

14015 
ušt64_t
 
‹mp_uµ”
 = 0, 
‹mp_low”
 = 0;

14016 ià(
h™_£t
)

14017 
	`ag’t_e¡im©e_‹mp
(
soid
, &
‹mp
);

14018 
ag’t_¡©e
->
‹mp_hi¡
.
	`add
(
‹mp
);

14019 
ag’t_¡©e
->
‹mp_hi¡
.
	`g‘_pos™iÚ_miüo
(
‹mp
, &
‹mp_low”
, &
‹mp_uµ”
);

14021 
	`dout
(20è<< 
__func__


14022 << "em°" << 
‹mp


14023 << "…o " << 
‹mp_low”
 << "-" << 
‹mp_uµ”


14024 << ",ƒviù_effÜˆ" << 
ag’t_¡©e
->
eviù_effÜt


14025 << 
d’dl
;

14026 
	`dout
(30) << "agent_state:\n";

14027 
FÜm©‹r
 *
f
 = FÜm©‹r::
	`ü—‹
("");

14028 
f
->
	`İ’_objeù_£ùiÚ
("agent_state");

14029 
ag’t_¡©e
->
	`dump
(
f
);

14030 
f
->
	`şo£_£ùiÚ
();

14031 
f
->
	`æush
(*
_dout
);

14032 
d–‘e
 
f
;

14033 *
_dout
 << 
d’dl
;

14035 ià(1000000 - 
‹mp_uµ”
 >ğ
ag’t_¡©e
->
eviù_effÜt
)

14036  
çl£
;

14039 
	`dout
(10è<< 
__func__
 << "ƒviùšg " << 
obc
->
obs
.
oi
 << 
d’dl
;

14040 
OpCÚ‹xtUPŒ
 
ùx
 = 
	`sim¶e_İc_ü—‹
(
obc
);

14042 autØ
nuÎ_İ_»q
 = 
	`OpReque¡Ref
();

14043 ià(!
ùx
->
lock_mªag”
.
	`g‘_lock_ty³
(

14044 
ObjeùCÚ‹xt
::
RWS‹
::
RWWRITE
,

14045 
obc
->
obs
.
oi
.
soid
,

14046 
obc
,

14047 
nuÎ_İ_»q
)) {

14048 
	`şo£_İ_ùx
(
ùx
.
	`»Ëa£
());

14049 
	`dout
(20è<< 
__func__
 << " sk (ÿÂÙ g‘†ockè" << 
obc
->
obs
.
oi
 << 
d’dl
;

14050  
çl£
;

14053 
osd
->
	`ag’t_¡¬t_eviù_İ
();

14054 
ùx
->
	`»gi¡”_Ú_fšish
(

14055 [
this
]() {

14056 
osd
->
	`ag’t_fšish_eviù_İ
();

14059 
ùx
->
©_v”siÚ
 = 
	`g‘_Ãxt_v”siÚ
();

14060 
	`as£¹
(
ùx
->
Ãw_obs
.
exi¡s
);

14061 
r
 = 
	`_d–‘e_oid
(
ùx
.
	`g‘
(), 
Œue
, 
çl£
);

14062 ià(
obc
->
obs
.
oi
.
	`is_om­
())

14063 
ùx
->
d–_¡©s
.
num_objeùs_om­
--;

14064 
ùx
->
d–_¡©s
.
num_eviù
++;

14065 
ùx
->
d–_¡©s
.
num_eviù_kb
 +ğ
	`shiá_round_up
(
obc
->
obs
.
oi
.
size
, 10);

14066 ià(
obc
->
obs
.
oi
.
	`is_dœty
())

14067 --
ùx
->
d–_¡©s
.
num_objeùs_dœty
;

14068 
	`as£¹
(
r
 == 0);

14069 
	`fšish_ùx
(
ùx
.
	`g‘
(), 
pg_log_’Œy_t
::
DELETE
);

14070 
	`sim¶e_İc_subm™
(
¡d
::
	`move
(
ùx
));

14071 
osd
->
logg”
->
	`šc
(
l_osd_t›r_eviù
);

14072 
osd
->
logg”
->
	`šc
(
l_osd_ag’t_eviù
);

14073  
Œue
;

14074 
	}
}

14076 
	gPrim¬yLogPG
::
	$ag’t_¡İ
()

14078 
	`dout
(20è<< 
__func__
 << 
d’dl
;

14079 ià(
ag’t_¡©e
 && !ag’t_¡©e->
	`is_idË
()) {

14080 
ag’t_¡©e
->
eviù_mode
 = 
T›rAg’tS‹
::
EVICT_MODE_IDLE
;

14081 
ag’t_¡©e
->
æush_mode
 = 
T›rAg’tS‹
::
FLUSH_MODE_IDLE
;

14082 
osd
->
	`ag’t_di§bË_pg
(
this
, 
ag’t_¡©e
->
eviù_effÜt
);

14084 
	}
}

14086 
	gPrim¬yLogPG
::
	$ag’t_d–ay
()

14088 
	`dout
(20è<< 
__func__
 << 
d’dl
;

14089 ià(
ag’t_¡©e
 && !ag’t_¡©e->
	`is_idË
()) {

14090 
	`as£¹
(
ag’t_¡©e
->
d–ayšg
 =ğ
çl£
);

14091 
ag’t_¡©e
->
d–ayšg
 = 
Œue
;

14092 
osd
->
	`ag’t_di§bË_pg
(
this
, 
ag’t_¡©e
->
eviù_effÜt
);

14094 
	}
}

14096 
	gPrim¬yLogPG
::
	$ag’t_choo£_mode_»¡¬t
()

14098 
	`dout
(20è<< 
__func__
 << 
d’dl
;

14099 
	`lock
();

14100 ià(
ag’t_¡©e
 &&‡g’t_¡©e->
d–ayšg
) {

14101 
ag’t_¡©e
->
d–ayšg
 = 
çl£
;

14102 
	`ag’t_choo£_mode
(
Œue
);

14104 
	`uÆock
();

14105 
	}
}

14107 
boŞ
 
	gPrim¬yLogPG
::
	$ag’t_choo£_mode
(
boŞ
 
»¡¬t
, 
OpReque¡Ref
 
İ
)

14109 
boŞ
 
»queued
 = 
çl£
;

14111 ià(
ag’t_¡©e
->
d–ayšg
) {

14112 
	`dout
(20è<< 
__func__
 << " " << 
this
 << " d–ayšg, ignÜed" << 
d’dl
;

14113  
»queued
;

14116 
T›rAg’tS‹
::
æush_mode_t
 
æush_mode
 = T›rAg’tS‹::
FLUSH_MODE_IDLE
;

14117 
T›rAg’tS‹
::
eviù_mode_t
 
eviù_mode
 = T›rAg’tS‹::
EVICT_MODE_IDLE
;

14118 
eviù_effÜt
 = 0;

14120 ià(
šfo
.
¡©s
.
¡©s_šv®id
) {

14122 
	`dout
(20è<< 
__func__
 << " st šv®id (po¡-¥l™), idË" << 
d’dl
;

14123 
sk_ÿlc
;

14127 
ušt64_t
 
divisÜ
 = 
poŞ
.
šfo
.
	`g‘_pg_num_divisÜ
(šfo.
pgid
.pgid);

14128 
	`as£¹
(
divisÜ
 > 0);

14133 
ušt64_t
 
unæushabË
 = 
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs_h™_£t_¬chive
;

14136 cÚ¡ 
pg_poŞ_t
 *
ba£_poŞ
 = 
	`g‘_osdm­
()->
	`g‘_pg_poŞ
(
poŞ
.
šfo
.
t›r_of
);

14137 
	`as£¹
(
ba£_poŞ
);

14138 ià(!
ba£_poŞ
->
	`suµÜts_om­
())

14139 
unæushabË
 +ğ
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs_om­
;

14141 
ušt64_t
 
num_u£r_objeùs
 = 
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs
;

14142 ià(
num_u£r_objeùs
 > 
unæushabË
)

14143 
num_u£r_objeùs
 -ğ
unæushabË
;

14145 
num_u£r_objeùs
 = 0;

14147 
ušt64_t
 
num_u£r_by‹s
 = 
šfo
.
¡©s
.¡©s.
sum
.
num_by‹s
;

14148 
ušt64_t
 
unæushabË_by‹s
 = 
šfo
.
¡©s
.¡©s.
sum
.
num_by‹s_h™_£t_¬chive
;

14149 
num_u£r_by‹s
 -ğ
unæushabË_by‹s
;

14150 
ušt64_t
 
num_ov”h—d_by‹s
 = 
osd
->
¡Üe
->
	`e¡im©e_objeùs_ov”h—d
(
num_u£r_objeùs
);

14151 
num_u£r_by‹s
 +ğ
num_ov”h—d_by‹s
;

14154 
št64_t
 
num_dœty
 = 
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs_dœty
;

14155 ià(!
ba£_poŞ
->
	`suµÜts_om­
()) {

14156 ià(
num_dœty
 > 
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs_om­
)

14157 
num_dœty
 -ğ
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs_om­
;

14159 
num_dœty
 = 0;

14162 
	`dout
(10è<< 
__func__


14164 << 
T›rAg’tS‹
::
	`g‘_æush_mode_Çme
(
ag’t_¡©e
->
æush_mode
)

14166 << 
T›rAg’tS‹
::
	`g‘_eviù_mode_Çme
(
ag’t_¡©e
->
eviù_mode
)

14167 << "‚um_objeùs: " << 
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs


14168 << "‚um_by‹s: " << 
šfo
.
¡©s
.¡©s.
sum
.
num_by‹s


14169 << "‚um_objeùs_dœty: " << 
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs_dœty


14170 << "‚um_objeùs_om­: " << 
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs_om­


14171 << "‚um_dœty: " << 
num_dœty


14172 << "‚um_u£r_objeùs: " << 
num_u£r_objeùs


14173 << "‚um_u£r_by‹s: " << 
num_u£r_by‹s


14174 << "‚um_ov”h—d_by‹s: " << 
num_ov”h—d_by‹s


14175 << "…oŞ.šfo.rg‘_max_by‹s: " << 
poŞ
.
šfo
.
rg‘_max_by‹s


14176 << "…oŞ.šfo.rg‘_max_objeùs: " << 
poŞ
.
šfo
.
rg‘_max_objeùs


14177 << 
d’dl
;

14180 
ušt64_t
 
dœty_miüo
 = 0;

14181 
ušt64_t
 
fuÎ_miüo
 = 0;

14182 ià(
poŞ
.
šfo
.
rg‘_max_by‹s
 && 
num_u£r_objeùs
 > 0) {

14183 
ušt64_t
 
avg_size
 = 
num_u£r_by‹s
 / 
num_u£r_objeùs
;

14184 
dœty_miüo
 =

14185 
num_dœty
 * 
avg_size
 * 1000000 /

14186 
¡d
::
max
<
ušt64_t
>(
poŞ
.
šfo
.
rg‘_max_by‹s
 / 
divisÜ
, 1);

14187 
fuÎ_miüo
 =

14188 
num_u£r_objeùs
 * 
avg_size
 * 1000000 /

14189 
¡d
::
max
<
ušt64_t
>(
poŞ
.
šfo
.
rg‘_max_by‹s
 / 
divisÜ
, 1);

14191 ià(
poŞ
.
šfo
.
rg‘_max_objeùs
 > 0) {

14192 
ušt64_t
 
dœty_objeùs_miüo
 =

14193 
num_dœty
 * 1000000 /

14194 
¡d
::
max
<
ušt64_t
>(
poŞ
.
šfo
.
rg‘_max_objeùs
 / 
divisÜ
, 1);

14195 ià(
dœty_objeùs_miüo
 > 
dœty_miüo
)

14196 
dœty_miüo
 = 
dœty_objeùs_miüo
;

14197 
ušt64_t
 
fuÎ_objeùs_miüo
 =

14198 
num_u£r_objeùs
 * 1000000 /

14199 
¡d
::
max
<
ušt64_t
>(
poŞ
.
šfo
.
rg‘_max_objeùs
 / 
divisÜ
, 1);

14200 ià(
fuÎ_objeùs_miüo
 > 
fuÎ_miüo
)

14201 
fuÎ_miüo
 = 
fuÎ_objeùs_miüo
;

14203 
	`dout
(20è<< 
__func__
 << " dœty " << (()
dœty_miüo
 / 1000000.0)

14204 << " fuÎ " << (()
fuÎ_miüo
 / 1000000.0)

14205 << 
d’dl
;

14208 
ušt64_t
 
æush_rg‘
 = 
poŞ
.
šfo
.
ÿche_rg‘_dœty_¿tio_miüo
;

14209 
ušt64_t
 
æush_high_rg‘
 = 
poŞ
.
šfo
.
ÿche_rg‘_dœty_high_¿tio_miüo
;

14210 
ušt64_t
 
æush_¦İ
 = ()
æush_rg‘
 * 
cù
->
_cÚf
->
osd_ag’t_¦İ
;

14211 ià(
»¡¬t
 || 
ag’t_¡©e
->
æush_mode
 =ğ
T›rAg’tS‹
::
FLUSH_MODE_IDLE
) {

14212 
æush_rg‘
 +ğ
æush_¦İ
;

14213 
æush_high_rg‘
 +ğ
æush_¦İ
;

14215 
æush_rg‘
 -ğ
¡d
::
	`mš
(æush_rg‘, 
æush_¦İ
);

14216 
æush_high_rg‘
 -ğ
¡d
::
	`mš
(æush_high_rg‘, 
æush_¦İ
);

14219 ià(
dœty_miüo
 > 
æush_high_rg‘
) {

14220 
æush_mode
 = 
T›rAg’tS‹
::
FLUSH_MODE_HIGH
;

14221 } ià(
dœty_miüo
 > 
æush_rg‘
) {

14222 
æush_mode
 = 
T›rAg’tS‹
::
FLUSH_MODE_LOW
;

14226 
ušt64_t
 
eviù_rg‘
 = 
poŞ
.
šfo
.
ÿche_rg‘_fuÎ_¿tio_miüo
;

14227 
ušt64_t
 
eviù_¦İ
 = ()
eviù_rg‘
 * 
cù
->
_cÚf
->
osd_ag’t_¦İ
;

14228 ià(
»¡¬t
 || 
ag’t_¡©e
->
eviù_mode
 =ğ
T›rAg’tS‹
::
EVICT_MODE_IDLE
)

14229 
eviù_rg‘
 +ğ
eviù_¦İ
;

14231 
eviù_rg‘
 -ğ
¡d
::
	`mš
Óviù_rg‘, 
eviù_¦İ
);

14233 ià(
fuÎ_miüo
 > 1000000) {

14235 
eviù_mode
 = 
T›rAg’tS‹
::
EVICT_MODE_FULL
;

14236 
eviù_effÜt
 = 1000000;

14237 } ià(
fuÎ_miüo
 > 
eviù_rg‘
) {

14239 
eviù_mode
 = 
T›rAg’tS‹
::
EVICT_MODE_SOME
;

14240 
ušt64_t
 
ov”
 = 
fuÎ_miüo
 - 
eviù_rg‘
;

14241 
ušt64_t
 
¥ª
 = 1000000 - 
eviù_rg‘
;

14242 
eviù_effÜt
 = 
¡d
::
	`max
(
ov”
 * 1000000 / 
¥ª
,

14243 
	`ušt64_t
(1000000.0 *

14244 
cù
->
_cÚf
->
osd_ag’t_mš_eviù_effÜt
));

14247 
ušt64_t
 
šc
 = 
cù
->
_cÚf
->
osd_ag’t_quªtize_effÜt
 * 1000000;

14248 
	`as£¹
(
šc
 > 0);

14249 
ušt64_t
 
was
 = 
eviù_effÜt
;

14250 
eviù_effÜt
 -ğeviù_effÜˆ% 
šc
;

14251 ià(
eviù_effÜt
 < 
šc
)

14252 
eviù_effÜt
 = 
šc
;

14253 
	`as£¹
(
eviù_effÜt
 >ğ
šc
 &&ƒvict_effort <= 1000000);

14254 
	`dout
(30è<< 
__func__
 << "ƒviù_effÜˆ" << 
was
 << " quªtized by " << 
šc
 << "Ø" << 
eviù_effÜt
 << 
d’dl
;

14258 
sk_ÿlc
:

14259 
boŞ
 
Şd_idË
 = 
ag’t_¡©e
->
	`is_idË
();

14260 ià(
æush_mode
 !ğ
ag’t_¡©e
->flush_mode) {

14261 
	`dout
(5è<< 
__func__
 << " flush_mode "

14262 << 
T›rAg’tS‹
::
	`g‘_æush_mode_Çme
(
ag’t_¡©e
->
æush_mode
)

14264 << 
T›rAg’tS‹
::
	`g‘_æush_mode_Çme
(
æush_mode
)

14265 << 
d’dl
;

14266 ià(
æush_mode
 =ğ
T›rAg’tS‹
::
FLUSH_MODE_HIGH
) {

14267 
osd
->
	`ag’t_šc_high_couÁ
();

14268 
šfo
.
¡©s
.¡©s.
sum
.
num_æush_mode_high
 = 1;

14269 } ià(
æush_mode
 =ğ
T›rAg’tS‹
::
FLUSH_MODE_LOW
) {

14270 
šfo
.
¡©s
.¡©s.
sum
.
num_æush_mode_low
 = 1;

14272 ià(
ag’t_¡©e
->
æush_mode
 =ğ
T›rAg’tS‹
::
FLUSH_MODE_HIGH
) {

14273 
osd
->
	`ag’t_dec_high_couÁ
();

14274 
šfo
.
¡©s
.¡©s.
sum
.
num_æush_mode_high
 = 0;

14275 } ià(
ag’t_¡©e
->
æush_mode
 =ğ
T›rAg’tS‹
::
FLUSH_MODE_LOW
) {

14276 
šfo
.
¡©s
.¡©s.
sum
.
num_æush_mode_low
 = 0;

14278 
ag’t_¡©e
->
æush_mode
 = flush_mode;

14280 ià(
eviù_mode
 !ğ
ag’t_¡©e
->evict_mode) {

14281 
	`dout
(5è<< 
__func__
 << "ƒvict_mode "

14282 << 
T›rAg’tS‹
::
	`g‘_eviù_mode_Çme
(
ag’t_¡©e
->
eviù_mode
)

14284 << 
T›rAg’tS‹
::
	`g‘_eviù_mode_Çme
(
eviù_mode
)

14285 << 
d’dl
;

14286 ià(
ag’t_¡©e
->
eviù_mode
 =ğ
T›rAg’tS‹
::
EVICT_MODE_FULL
 &&

14287 
	`is_aùive
()) {

14288 ià(
İ
)

14289 
	`»queue_İ
(
İ
);

14290 
	`»queue_İs
(
wa™šg_fÜ_æush
);

14291 
	`»queue_İs
(
wa™šg_fÜ_aùive
);

14292 
	`»queue_İs
(
wa™šg_fÜ_süub
);

14293 
	`»queue_İs
(
wa™šg_fÜ_ÿche_nÙ_fuÎ
);

14294 
objeùs_blocked_Ú_ÿche_fuÎ
.
	`ş—r
();

14295 
»queued
 = 
Œue
;

14297 ià(
eviù_mode
 =ğ
T›rAg’tS‹
::
EVICT_MODE_SOME
) {

14298 
šfo
.
¡©s
.¡©s.
sum
.
num_eviù_mode_some
 = 1;

14299 } ià(
eviù_mode
 =ğ
T›rAg’tS‹
::
EVICT_MODE_FULL
) {

14300 
šfo
.
¡©s
.¡©s.
sum
.
num_eviù_mode_fuÎ
 = 1;

14302 ià(
ag’t_¡©e
->
eviù_mode
 =ğ
T›rAg’tS‹
::
EVICT_MODE_SOME
) {

14303 
šfo
.
¡©s
.¡©s.
sum
.
num_eviù_mode_some
 = 0;

14304 } ià(
ag’t_¡©e
->
eviù_mode
 =ğ
T›rAg’tS‹
::
EVICT_MODE_FULL
) {

14305 
šfo
.
¡©s
.¡©s.
sum
.
num_eviù_mode_fuÎ
 = 0;

14307 
ag’t_¡©e
->
eviù_mode
 =ƒvict_mode;

14309 
ušt64_t
 
Şd_effÜt
 = 
ag’t_¡©e
->
eviù_effÜt
;

14310 ià(
eviù_effÜt
 !ğ
ag’t_¡©e
->evict_effort) {

14311 
	`dout
(5è<< 
__func__
 << "ƒvict_effort "

14312 << (()
ag’t_¡©e
->
eviù_effÜt
 / 1000000.0)

14314 << (()
eviù_effÜt
 / 1000000.0)

14315 << 
d’dl
;

14316 
ag’t_¡©e
->
eviù_effÜt
 =ƒvict_effort;

14322 ià(
ag’t_¡©e
->
	`is_idË
()) {

14323 ià(!
»¡¬t
 && !
Şd_idË
) {

14324 
osd
->
	`ag’t_di§bË_pg
(
this
, 
Şd_effÜt
);

14327 ià(
»¡¬t
 || 
Şd_idË
) {

14328 
osd
->
	`ag’t_’abË_pg
(
this
, 
ag’t_¡©e
->
eviù_effÜt
);

14329 } ià(
Şd_effÜt
 !ğ
ag’t_¡©e
->
eviù_effÜt
) {

14330 
osd
->
	`ag’t_adju¡_pg
(
this
, 
Şd_effÜt
, 
ag’t_¡©e
->
eviù_effÜt
);

14333  
»queued
;

14334 
	}
}

14336 
	gPrim¬yLogPG
::
	$ag’t_e¡im©e_‹mp
(cÚ¡ 
hobjeù_t
& 
oid
, *
‹mp
)

14338 
	`as£¹
(
h™_£t
);

14339 
	`as£¹
(
‹mp
);

14340 *
‹mp
 = 0;

14341 ià(
h™_£t
->
	`cÚšs
(
oid
))

14342 *
‹mp
 = 1000000;

14343 
i
 = 0;

14344 
Ï¡_n
 = 
poŞ
.
šfo
.
h™_£t_£¬ch_Ï¡_n
;

14345 
m­
<
time_t
,
H™S‘Ref
>::
»v”£_™”©Ü
 
p
 =

14346 
ag’t_¡©e
->
h™_£t_m­
.
	`rbegš
(); 
Ï¡_n
 > 0 &&

14347 
p
 !ğ
ag’t_¡©e
->
h™_£t_m­
.
	`»nd
(); ++p, ++
i
) {

14348 ià(
p
->
£cÚd
->
	`cÚšs
(
oid
)) {

14349 *
‹mp
 +ğ
poŞ
.
šfo
.
	`g‘_g¿de
(
i
);

14350 --
Ï¡_n
;

14353 
	}
}

14357 
boŞ
 
	gPrim¬yLogPG
::
	$®»ady_com¶‘e
(
ev”siÚ_t
 
v
)

14359 
	`dout
(20è<< 
__func__
 << ": " << 
v
 << 
d’dl
;

14360 
xli¡
<
R•G©h”
*>::
™”©Ü
 
i
 = 
»pİ_queue
.
	`begš
();

14361 !
i
.
	`’d
();

14362 ++
i
) {

14363 
	`dout
(20è<< 
__func__
 << ": " << **
i
 << 
d’dl
;

14365 ià((*
i
)->
v
 =ğ
	`ev”siÚ_t
()) {

14366 
	`dout
(20è<< 
__func__
 << ": " << **
i


14367 << " v”siÚ i em±y" << 
d’dl
;

14370 ià((*
i
)->
v
 > v) {

14371 
	`dout
(20è<< 
__func__
 << ": " << **
i


14372 << " (*i)->v…a¡ v" << 
d’dl
;

14375 ià(!(*
i
)->
®l_comm™‹d
) {

14376 
	`dout
(20è<< 
__func__
 << ": " << **
i


14378 << 
d’dl
;

14379  
çl£
;

14382 
	`dout
(20è<< 
__func__
 << ":„‘uºšgrue" << 
d’dl
;

14383  
Œue
;

14384 
	}
}

14386 
boŞ
 
	gPrim¬yLogPG
::
	$®»ady_ack
(
ev”siÚ_t
 
v
)

14388 
	`dout
(20è<< 
__func__
 << ": " << 
v
 << 
d’dl
;

14389 
xli¡
<
R•G©h”
*>::
™”©Ü
 
i
 = 
»pİ_queue
.
	`begš
();

14390 !
i
.
	`’d
();

14391 ++
i
) {

14393 ià((*
i
)->
v
 =ğ
	`ev”siÚ_t
()) {

14394 
	`dout
(20è<< 
__func__
 << ": " << **
i


14395 << " v”siÚ i em±y" << 
d’dl
;

14398 ià((*
i
)->
v
 > v) {

14399 
	`dout
(20è<< 
__func__
 << ": " << **
i


14400 << " (*i)->v…a¡ v" << 
d’dl
;

14404 
	`dout
(20è<< 
__func__
 << ":„‘uºšgrue" << 
d’dl
;

14405  
Œue
;

14406 
	}
}

14413 
boŞ
 
	gPrim¬yLogPG
::
	$_¿nge_avaabË_fÜ_süub
(

14414 cÚ¡ 
hobjeù_t
 &
begš
, cÚ¡ hobjeù_ˆ&
’d
)

14416 
·œ
<
hobjeù_t
, 
ObjeùCÚ‹xtRef
> 
Ãxt
;

14417 
Ãxt
.
£cÚd
 = 
objeù_cÚ‹xts
.
	`lookup
(
begš
);

14418 
Ãxt
.
fœ¡
 = 
begš
;

14419 
boŞ
 
mÜe
 = 
Œue
;

14420 
mÜe
 && 
Ãxt
.
fœ¡
 < 
’d
) {

14421 ià(
Ãxt
.
£cÚd
 &&‚ext.£cÚd->
	`is_blocked
()) {

14422 
Ãxt
.
£cÚd
->
»queue_süub_Ú_unblock
 = 
Œue
;

14423 
	`dout
(10è<< 
__func__
 << ": scrub delayed, "

14424 << 
Ãxt
.
fœ¡
 << " is blocked"

14425 << 
d’dl
;

14426  
çl£
;

14428 
mÜe
 = 
objeù_cÚ‹xts
.
	`g‘_Ãxt
(
Ãxt
.
fœ¡
, &next);

14430  
Œue
;

14431 
	}
}

14433 
boŞ
 
došg_şÚes
(cÚ¡ 
boo¡
::
İtiÚ®
<
SÇpS‘
> &
¢­£t
,

14434 cÚ¡ 
veùÜ
<
¢­id_t
>::
»v”£_™”©Ü
 &
curşÚe
) {

14435  
¢­£t
 && 
curşÚe
 !ğ¢­£t.
g‘
().
şÚes
.
»nd
();

14438 
	gPrim¬yLogPG
::
log_missšg
(
missšg
,

14439 cÚ¡ 
boo¡
::
İtiÚ®
<
hobjeù_t
> &
h—d
,

14440 
LogChªÃlRef
 
şog
,

14441 cÚ¡ 
¥g_t
 &
pgid
,

14442 cÚ¡ *
func
,

14443 cÚ¡ *
mode
,

14444 
boŞ
 
®low_šcom¶‘e_şÚes
)

14446 
as£¹
(
h—d
);

14447 ià(
	g®low_šcom¶‘e_şÚes
) {

14448 
dout
(20è<< 
	gfunc
 << " " << 
	gmode
 << " " << 
	gpgid
 << " " << 
	gh—d
.
g‘
()

14449 << " sk³d " << 
	gmissšg
 << " clÚe(sèš cacht›r" << 
	gd’dl
;

14451 
	gşog
->
šfo
(è<< 
	gmode
 << " " << 
	gpgid
 << " " << 
	gh—d
.
g‘
()

14452 << " " << 
	gmissšg
 << " missing clone(s)";

14456 
	gPrim¬yLogPG
::
´oûss_şÚes_to
(cÚ¡ 
boo¡
::
İtiÚ®
<
hobjeù_t
> &
h—d
,

14457 cÚ¡ 
boo¡
::
İtiÚ®
<
SÇpS‘
> &
¢­£t
,

14458 
LogChªÃlRef
 
şog
,

14459 cÚ¡ 
¥g_t
 &
pgid
,

14460 cÚ¡ *
mode
,

14461 
boŞ
 
®low_šcom¶‘e_şÚes
,

14462 
boo¡
::
İtiÚ®
<
¢­id_t
> 
rg‘
,

14463 
veùÜ
<
¢­id_t
>::
»v”£_™”©Ü
 *
curşÚe
,

14464 
šcÚsi¡’t_¢­£t_w¿µ”
 &
e
)

14466 
as£¹
(
h—d
);

14467 
as£¹
(
¢­£t
);

14468 
	gmissšg
 = 0;

14471 
hobjeù_t
 
Ãxt_şÚe
(
h—d
.
g‘
());

14472 
došg_şÚes
(
¢­£t
, *
curşÚe
è&& (!
	grg‘
 || **
	gcurşÚe
 > *target)) {

14473 ++
	gmissšg
;

14476 ià(!
	g®low_šcom¶‘e_şÚes
) {

14477 
	gÃxt_şÚe
.
	g¢­
 = **
curşÚe
;

14478 
	gşog
->
”rÜ
(è<< 
	gmode
 << " " << 
	gpgid
 << " " << 
	gh—d
.
g‘
()

14479 << "ƒx³ùed clÚ" << 
	gÃxt_şÚe
 << " " << 
	gmissšg


14481 ++
	gsüubb”
.
	gsh®low_”rÜs
;

14482 
	ge
.
£t_şÚe_missšg
(
Ãxt_şÚe
.
¢­
);

14485 ++(*
	gcurşÚe
);

14487  
	gmissšg
;

14515 
	gPrim¬yLogPG
::
süub_¢­shÙ_m‘ad©a
(

14516 
SüubM­
 &
süubm­
,

14517 cÚ¡ 
m­
<
hobjeù_t
,

14518 
·œ
<
boo¡
::
İtiÚ®
<
ušt32_t
>,

14519 
boo¡
::
İtiÚ®
<
ušt32_t
>>> &
missšg_dige¡
)

14521 
dout
(10è<< 
__func__
 << 
d’dl
;

14523 
boŞ
 
	g»·œ
 = 
¡©e_‹¡
(
PG_STATE_REPAIR
);

14524 
boŞ
 
	gd“p_süub
 = 
¡©e_‹¡
(
PG_STATE_DEEP_SCRUB
);

14525 cÚ¡ *
	gmode
 = (
»·œ
 ? "»·œ": (
d“p_süub
 ? "deep-scrub" : "scrub"));

14526 
	gboo¡
::
İtiÚ®
<
¢­id_t
> 
®l_şÚes
;

14529 
	gboo¡
::
İtiÚ®
<
hobjeù_t
> 
h—d
;

14530 
	gboo¡
::
İtiÚ®
<
SÇpS‘
> 
¢­£t
;

14531 
	gveùÜ
<
	g¢­id_t
>::
»v”£_™”©Ü
 
curşÚe
;

14532 
	gmissšg
 = 0;

14533 
šcÚsi¡’t_¢­£t_w¿µ”
 
	gsoid_”rÜ
, 
	gh—d_”rÜ
;

14534 
	gsoid_”rÜ_couÁ
 = 0;

14536 
	gm­
<
	ghobjeù_t
,
	gSüubM­
::
objeù
>::
»v”£_™”©Ü


14537 
p
 = 
süubm­
.
objeùs
.
rbegš
(); 
	gp
 !ğsüubm­.objeùs.
»nd
(); ++p) {

14538 cÚ¡ 
	ghobjeù_t
& 
	gsoid
 = 
p
->
fœ¡
;

14539 
as£¹
(!
soid
.
is_¢­dœ
());

14540 
	gsoid_”rÜ
 = 
šcÚsi¡’t_¢­£t_w¿µ”
{
soid
};

14541 
objeù_¡©_sum_t
 
	g¡©
;

14542 
	gboo¡
::
İtiÚ®
<
objeù_šfo_t
> 
oi
;

14544 
	g¡©
.
	gnum_objeùs
++;

14546 ià(
	gsoid
.
	gn¥aû
 =ğ
cù
->
_cÚf
->
osd_h™_£t_Çme¥aû
)

14547 
¡©
.
num_objeùs_h™_£t_¬chive
++;

14549 ià(
	gsoid
.
is_¢­
()) {

14551 
	g¡©
.
	gnum_objeù_şÚes
++;

14555 ià(
	gp
->
	g£cÚd
.
	g©Œs
.
couÁ
(
OI_ATTR
) == 0) {

14556 
oi
 = 
boo¡
::
nÚe
;

14557 
	gosd
->
	gşog
->
”rÜ
(è<< 
	gmode
 << " " << 
	gšfo
.
	gpgid
 << " " << 
	gsoid


14558 << "‚Ø'" << 
	gOI_ATTR
 << "'‡ttr";

14559 ++
	gsüubb”
.
	gsh®low_”rÜs
;

14560 
	gsoid_”rÜ
.
£t_šfo_missšg
();

14562 
bufã¾i¡
 
	gbv
;

14563 
	gbv
.
push_back
(
p
->
£cÚd
.
©Œs
[
OI_ATTR
]);

14564 
	gŒy
 {

14565 
	goi
 = 
objeù_šfo_t
();

14566 
	goi
.
g‘
().
decode
(
bv
);

14567 } 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

14568 
oi
 = 
boo¡
::
nÚe
;

14569 
	gosd
->
	gşog
->
”rÜ
(è<< 
	gmode
 << " " << 
	gšfo
.
	gpgid
 << " " << 
	gsoid


14570 << " cª'ˆdecod'" << 
	gOI_ATTR
 << "'‡‰¸" << 
	ge
.
wh©
();

14571 ++
	gsüubb”
.
	gsh®low_”rÜs
;

14572 
	gsoid_”rÜ
.
£t_šfo_cÜru±ed
();

14573 
	gsoid_”rÜ
.
£t_šfo_missšg
();

14577 ià(
	goi
) {

14578 ià(
	gpgback’d
->
be_g‘_Údisk_size
(
oi
->
size
è!ğ
p
->
£cÚd
.size) {

14579 
osd
->
şog
->
”rÜ
(è<< 
mode
 << " " << 
šfo
.
pgid
 << " " << 
soid


14580 << " oÀdisk siz(" << 
p
->
£cÚd
.
size


14582 << 
oi
->
size
 << ")‡djusted for ondisko ("

14583 << 
pgback’d
->
be_g‘_Údisk_size
(
oi
->
size
)

14585 
	gsoid_”rÜ
.
£t_size_mism©ch
();

14586 ++
	gsüubb”
.
	gsh®low_”rÜs
;

14589 
dout
(20è<< 
	gmode
 << " " << 
	gsoid
 << " " << 
	goi
.
g‘
(è<< 
	gd’dl
;

14592 ià(!
	gsoid
.
is_¢­
()) {

14593 
	g¡©
.
	gnum_by‹s
 +ğ
oi
->
size
;

14595 ià(
	gsoid
.
	gn¥aû
 =ğ
cù
->
_cÚf
->
osd_h™_£t_Çme¥aû
)

14596 
¡©
.
num_by‹s_h™_£t_¬chive
 +ğ
oi
->
size
;

14598 ià(
	goi
->
is_dœty
())

14599 ++
	g¡©
.
	gnum_objeùs_dœty
;

14600 ià(
	goi
->
is_wh™eout
())

14601 ++
	g¡©
.
	gnum_wh™eouts
;

14602 ià(
	goi
->
is_om­
())

14603 ++
	g¡©
.
	gnum_objeùs_om­
;

14604 ià(
	goi
->
is_ÿche_pšÃd
())

14605 ++
	g¡©
.
	gnum_objeùs_pšÃd
;

14606 ià(
	goi
->
has_mªiã¡
())

14607 ++
	g¡©
.
	gnum_objeùs_mªiã¡
;

14611 ià(
došg_şÚes
(
¢­£t
, 
curşÚe
)) {

14612 
	gboo¡
::
İtiÚ®
<
¢­id_t
> 
rg‘
;

14614 ià(
	gsoid
.
has_¢­£t
(è|| soid.
g‘_h—d
(è!ğ
h—d
->get_head()) {

14616 
dout
(10è<< 
__func__
 << " " << 
mode
 << " " << 
šfo
.
pgid
 << "‚ew object "

14617 << 
soid
 << " wh´oûssšg " << 
h—d
.
g‘
(è<< 
d’dl
;

14619 
	grg‘
 = 
®l_şÚes
;

14621 
as£¹
(
soid
.
is_¢­
());

14622 
	grg‘
 = 
soid
.
¢­
;

14627 
	gmissšg
 +ğ
´oûss_şÚes_to
(
h—d
, 
¢­£t
, 
osd
->
şog
, 
šfo
.
pgid
, 
mode
,

14628 
poŞ
.
šfo
.
®low_šcom¶‘e_şÚes
(), 
rg‘
, &
curşÚe
,

14629 
h—d_”rÜ
);

14631 
boŞ
 
	gex³ùed
;

14633 ià(
došg_şÚes
(
¢­£t
, 
curşÚe
)) {

14636 
as£¹
(
soid
.
is_¢­
(è&& *
curşÚe
 <ğsoid.
¢­
);

14639 
	gex³ùed
 = (*
curşÚe
 =ğ
soid
.
¢­
);

14642 
	gex³ùed
 = 
soid
.
has_¢­£t
();

14644 ià(!
	gex³ùed
) {

14646 ià(
	gh—d
 && !
	g¢­£t
) {

14647 
	gosd
->
	gşog
->
”rÜ
(è<< 
	gmode
 << " " << 
	gšfo
.
	gpgid
 << " " << 
	gsoid


14650 
	gosd
->
	gşog
->
”rÜ
(è<< 
	gmode
 << " " << 
	gšfo
.
	gpgid
 << " " << 
	gsoid


14653 ++
	gsüubb”
.
	gsh®low_”rÜs
;

14654 
	gsoid_”rÜ
.
£t_h—dËss
();

14655 
	gsüubb”
.
	g¡Üe
->
add_¢­_”rÜ
(
poŞ
.
id
, 
soid_”rÜ
);

14656 ++
	gsoid_”rÜ_couÁ
;

14657 ià(
	gh—d
 && 
	gsoid
.
g‘_h—d
(è=ğ
h—d
->get_head())

14658 
h—d_”rÜ
.
£t_şÚe
(
soid
.
¢­
);

14663 ià(
	gsoid
.
has_¢­£t
()) {

14665 ià(
	gmissšg
) {

14666 
log_missšg
(
missšg
, 
h—d
, 
osd
->
şog
, 
šfo
.
pgid
, 
__func__
, 
mode
,

14667 
poŞ
.
šfo
.
®low_šcom¶‘e_şÚes
());

14671 ià(
	gh—d
 && (
	gh—d_”rÜ
.
	g”rÜs
 || 
	gsoid_”rÜ_couÁ
))

14672 
	gsüubb”
.
	g¡Üe
->
add_¢­_”rÜ
(
poŞ
.
id
, 
h—d_”rÜ
);

14674 
	gh—d
 = 
soid
;

14675 
	gmissšg
 = 0;

14676 
	gh—d_”rÜ
 = 
soid_”rÜ
;

14677 
	gsoid_”rÜ_couÁ
 = 0;

14679 
dout
(20è<< 
	g__func__
 << " " << 
	gmode
 << "‚ew h—d " << 
	gh—d
 << 
	gd’dl
;

14681 ià(
	gp
->
	g£cÚd
.
	g©Œs
.
couÁ
(
SS_ATTR
) == 0) {

14682 
osd
->
şog
->
”rÜ
(è<< 
mode
 << " " << 
šfo
.
pgid
 << " " << 
soid


14683 << "‚Ø'" << 
SS_ATTR
 << "'‡ttr";

14684 ++
	gsüubb”
.
	gsh®low_”rÜs
;

14685 
	g¢­£t
 = 
boo¡
::
nÚe
;

14686 
	gh—d_”rÜ
.
£t_¢­£t_missšg
();

14688 
bufã¾i¡
 
	gbl
;

14689 
	gbl
.
push_back
(
p
->
£cÚd
.
©Œs
[
SS_ATTR
]);

14690 
	gbufã¾i¡
::
™”©Ü
 
bÍ
 = 
bl
.
begš
();

14691 
	gŒy
 {

14692 
	g¢­£t
 = 
SÇpS‘
();

14693 
decode
(
¢­£t
.
g‘
(), 
bÍ
);

14694 
	gh—d_”rÜ
.
	gss_bl
.
push_back
(
p
->
£cÚd
.
©Œs
[
SS_ATTR
]);

14695 } 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

14696 
¢­£t
 = 
boo¡
::
nÚe
;

14697 
	gosd
->
	gşog
->
”rÜ
(è<< 
	gmode
 << " " << 
	gšfo
.
	gpgid
 << " " << 
	gsoid


14698 << " cª'ˆdecod'" << 
	gSS_ATTR
 << "'‡‰¸" << 
	ge
.
wh©
();

14699 ++
	gsüubb”
.
	gsh®low_”rÜs
;

14700 
	gh—d_”rÜ
.
£t_¢­£t_cÜru±ed
();

14704 ià(
	g¢­£t
) {

14706 
	gcurşÚe
 = 
¢­£t
->
şÚes
.
rbegš
();

14708 ià(!
	g¢­£t
->
	gşÚes
.
em±y
()) {

14709 
dout
(20è<< " sÇp£ˆ" << 
	g¢­£t
.
g‘
(è<< 
	gd’dl
;

14710 ià(
	g¢­£t
->
	g£q
 == 0) {

14711 
osd
->
şog
->
”rÜ
(è<< 
mode
 << " " << 
šfo
.
pgid
 << " " << 
soid


14713 ++
	gsüubb”
.
	gsh®low_”rÜs
;

14714 
	gh—d_”rÜ
.
£t_¢­£t_”rÜ
();

14719 
as£¹
(
soid
.
is_¢­
());

14720 
as£¹
(
h—d
);

14721 
as£¹
(
¢­£t
);

14722 
as£¹
(
soid
.
¢­
 =ğ*
curşÚe
);

14724 
dout
(20è<< 
	g__func__
 << " " << 
	gmode
 << " m©ched clÚ" << 
	gsoid
 << 
	gd’dl
;

14726 ià(
	g¢­£t
->
	gşÚe_size
.
couÁ
(
soid
.
¢­
) == 0) {

14727 
osd
->
şog
->
”rÜ
(è<< 
mode
 << " " << 
šfo
.
pgid
 << " " << 
soid


14729 ++
	gsüubb”
.
	gsh®low_”rÜs
;

14730 
	gsoid_”rÜ
.
£t_size_mism©ch
();

14732 ià(
	goi
 && oi->
	gsize
 !ğ
¢­£t
->
şÚe_size
[
soid
.
¢­
]) {

14733 
osd
->
şog
->
”rÜ
(è<< 
mode
 << " " << 
šfo
.
pgid
 << " " << 
soid


14734 << " siz" << 
oi
->
size
 << " != clone_size "

14735 << 
¢­£t
->
şÚe_size
[*
curşÚe
];

14736 ++
	gsüubb”
.
	gsh®low_”rÜs
;

14737 
	gsoid_”rÜ
.
£t_size_mism©ch
();

14740 ià(
	g¢­£t
->
	gşÚe_ov”Ïp
.
couÁ
(
soid
.
¢­
) == 0) {

14741 
osd
->
şog
->
”rÜ
(è<< 
mode
 << " " << 
šfo
.
pgid
 << " " << 
soid


14743 ++
	gsüubb”
.
	gsh®low_”rÜs
;

14744 
	gsoid_”rÜ
.
£t_size_mism©ch
();

14750 
ušt64_t
 
	gsize
 = 
¢­£t
->
şÚe_size
.
fšd
(
soid
.
¢­
)->
£cÚd
;

14751 cÚ¡ 
	gš‹rv®_£t
<
	gušt64_t
> &
	gov”Ïp
 =

14752 
¢­£t
->
şÚe_ov”Ïp
.
fšd
(
soid
.
¢­
)->
£cÚd
;

14753 
boŞ
 
	gbad_š‹rv®_£t
 = 
çl£
;

14754 
	gš‹rv®_£t
<
	gušt64_t
>::
cÚ¡_™”©Ü
 
i
 = 
ov”Ïp
.
begš
();

14755 
	gi
 !ğ
ov”Ïp
.
’d
(); ++i) {

14756 ià(
	gsize
 < 
	gi
.
g‘_Ën
()) {

14757 
	gbad_š‹rv®_£t
 = 
Œue
;

14760 
	gsize
 -ğ
i
.
g‘_Ën
();

14763 ià(
	gbad_š‹rv®_£t
) {

14764 
	gosd
->
	gşog
->
”rÜ
(è<< 
	gmode
 << " " << 
	gšfo
.
	gpgid
 << " " << 
	gsoid


14766 ++
	gsüubb”
.
	gsh®low_”rÜs
;

14767 
	gsoid_”rÜ
.
£t_size_mism©ch
();

14769 
	g¡©
.
	gnum_by‹s
 +ğ
¢­£t
->
g‘_şÚe_by‹s
(
soid
.
¢­
);

14775 ++
	gcurşÚe
;

14776 ià(
	gsoid_”rÜ
.
	g”rÜs
) {

14777 
	gsüubb”
.
	g¡Üe
->
add_¢­_”rÜ
(
poŞ
.
id
, 
soid_”rÜ
);

14778 ++
	gsoid_”rÜ_couÁ
;

14782 
	gsüub_c¡©
.
add
(
¡©
);

14785 ià(
došg_şÚes
(
¢­£t
, 
curşÚe
)) {

14786 
dout
(10è<< 
	g__func__
 << " " << 
	gmode
 << " " << 
	gšfo
.
	gpgid


14787 << " NØmÜobjeù wh´oûssšg " << 
	gh—d
.
g‘
(è<< 
	gd’dl
;

14789 
	gmissšg
 +ğ
´oûss_şÚes_to
(
h—d
, 
¢­£t
, 
osd
->
şog
, 
šfo
.
pgid
, 
mode
,

14790 
poŞ
.
šfo
.
®low_šcom¶‘e_şÚes
(), 
®l_şÚes
, &
curşÚe
,

14791 
h—d_”rÜ
);

14795 ià(
	gmissšg
) {

14796 
log_missšg
(
missšg
, 
h—d
, 
osd
->
şog
, 
šfo
.
pgid
, 
__func__
,

14797 
mode
, 
poŞ
.
šfo
.
®low_šcom¶‘e_şÚes
());

14799 ià(
	gh—d
 && (
	gh—d_”rÜ
.
	g”rÜs
 || 
	gsoid_”rÜ_couÁ
))

14800 
	gsüubb”
.
	g¡Üe
->
add_¢­_”rÜ
(
poŞ
.
id
, 
h—d_”rÜ
);

14802 autØ
	gp
 = 
missšg_dige¡
.
begš
();… !ğmissšg_dige¡.
’d
(); ++p) {

14803 
as£¹
(!
p
->
fœ¡
.
is_¢­dœ
());

14804 
dout
(10è<< 
	g__func__
 << "„ecÜdšg dige¡ fÜ " << 
	gp
->
	gfœ¡
 << 
	gd’dl
;

14805 
ObjeùCÚ‹xtRef
 
	gobc
 = 
g‘_objeù_cÚ‹xt
(
p
->
fœ¡
, 
çl£
);

14806 ià(!
	gobc
) {

14807 
	gosd
->
	gşog
->
”rÜ
(è<< 
	gšfo
.
	gpgid
 << " " << 
	gmode


14809 << 
	gp
->
	gfœ¡
;

14811 } ià(
	gobc
->
	gobs
.
	goi
.
	gsoid
 !ğ
p
->
fœ¡
) {

14812 
osd
->
şog
->
”rÜ
(è<< 
šfo
.
pgid
 << " " << 
mode


14813 << " objeù " << 
p
->
fœ¡


14815 << " obc->obs.oi.soid: " << 
obc
->
obs
.
oi
.
soid
;

14818 
OpCÚ‹xtUPŒ
 
	gùx
 = 
sim¶e_İc_ü—‹
(
obc
);

14819 
	gùx
->
	g©_v”siÚ
 = 
g‘_Ãxt_v”siÚ
();

14820 
	gùx
->
	gmtime
 = 
utime_t
();

14821 ià(
	gp
->
	g£cÚd
.
	gfœ¡
) {

14822 
	gùx
->
	gÃw_obs
.
	goi
.
£t_d©a_dige¡
(*
p
->
£cÚd
.
fœ¡
);

14824 
	gùx
->
	gÃw_obs
.
	goi
.
ş—r_d©a_dige¡
();

14826 ià(
	gp
->
	g£cÚd
.second) {

14827 
	gùx
->
	gÃw_obs
.
	goi
.
£t_om­_dige¡
(*
p
->
£cÚd
.second);

14829 
	gùx
->
	gÃw_obs
.
	goi
.
ş—r_om­_dige¡
();

14831 
fšish_ùx
(
ùx
.
g‘
(), 
pg_log_’Œy_t
::
MODIFY
);

14833 
	gùx
->
»gi¡”_Ú_sucûss
(

14834 [
this
]() {

14835 
dout
(20è<< "upd©šg süub dige¡" << 
d’dl
;

14836 ià(--
süubb”
.
num_dige¡_upd©es_³ndšg
 == 0) {

14837 
»queue_süub
();

14841 
sim¶e_İc_subm™
(
¡d
::
move
(
ùx
));

14842 ++
	gsüubb”
.
	gnum_dige¡_upd©es_³ndšg
;

14845 
dout
(10è<< 
	g__func__
 << " (" << 
	gmode
 << "èfšish" << 
	gd’dl
;

14848 
	gPrim¬yLogPG
::
	$_süub_ş—r_¡©e
()

14850 
süub_c¡©
 = 
	`objeù_¡©_cŞËùiÚ_t
();

14851 
	}
}

14853 
	gPrim¬yLogPG
::
	$_süub_fšish
()

14855 
boŞ
 
»·œ
 = 
	`¡©e_‹¡
(
PG_STATE_REPAIR
);

14856 
boŞ
 
d“p_süub
 = 
	`¡©e_‹¡
(
PG_STATE_DEEP_SCRUB
);

14857 cÚ¡ *
mode
 = (
»·œ
 ? "»·œ": (
d“p_süub
 ? "deep-scrub" : "scrub"));

14859 ià(
šfo
.
¡©s
.
¡©s_šv®id
) {

14860 
šfo
.
¡©s
.¡© ğ
süub_c¡©
;

14861 
šfo
.
¡©s
.
¡©s_šv®id
 = 
çl£
;

14863 ià(
ag’t_¡©e
)

14864 
	`ag’t_choo£_mode
();

14867 
	`dout
(10è<< 
mode
 << " got "

14868 << 
süub_c¡©
.
sum
.
num_objeùs
 << "/" << 
šfo
.
¡©s
.stats.sum.num_objects << " objects, "

14869 << 
süub_c¡©
.
sum
.
num_objeù_şÚes
 << "/" << 
šfo
.
¡©s
.stats.sum.num_object_clones << " clones, "

14870 << 
süub_c¡©
.
sum
.
num_objeùs_dœty
 << "/" << 
šfo
.
¡©s
.stats.sum.num_objects_dirty << " dirty, "

14871 << 
süub_c¡©
.
sum
.
num_objeùs_om­
 << "/" << 
šfo
.
¡©s
.stats.sum.num_objects_omap << " omap, "

14872 << 
süub_c¡©
.
sum
.
num_objeùs_pšÃd
 << "/" << 
šfo
.
¡©s
.stats.sum.num_objects_pinned << "…inned, "

14873 << 
süub_c¡©
.
sum
.
num_objeùs_h™_£t_¬chive
 << "/" << 
šfo
.
¡©s
.stats.sum.num_objects_hit_set_archive << " hit_set_archive, "

14874 << 
süub_c¡©
.
sum
.
num_by‹s
 << "/" << 
šfo
.
¡©s
.stats.sum.num_bytes << " bytes, "

14875 << 
süub_c¡©
.
sum
.
num_objeùs_mªiã¡
 << "/" << 
šfo
.
¡©s
.stats.sum.num_objects_manifest << " manifest objects, "

14876 << 
süub_c¡©
.
sum
.
num_by‹s_h™_£t_¬chive
 << "/" << 
šfo
.
¡©s
.stats.sum.num_bytes_hit_set_archive << " hit_set_archive bytes."

14877 << 
d’dl
;

14879 ià(
süub_c¡©
.
sum
.
num_objeùs
 !ğ
šfo
.
¡©s
.stats.sum.num_objects ||

14880 
süub_c¡©
.
sum
.
num_objeù_şÚes
 !ğ
šfo
.
¡©s
.stats.sum.num_object_clones ||

14881 (
süub_c¡©
.
sum
.
num_objeùs_dœty
 !ğ
šfo
.
¡©s
.stats.sum.num_objects_dirty &&

14882 !
šfo
.
¡©s
.
dœty_¡©s_šv®id
) ||

14883 (
süub_c¡©
.
sum
.
num_objeùs_om­
 !ğ
šfo
.
¡©s
.stats.sum.num_objects_omap &&

14884 !
šfo
.
¡©s
.
om­_¡©s_šv®id
) ||

14885 (
süub_c¡©
.
sum
.
num_objeùs_pšÃd
 !ğ
šfo
.
¡©s
.stats.sum.num_objects_pinned &&

14886 !
šfo
.
¡©s
.
pš_¡©s_šv®id
) ||

14887 (
süub_c¡©
.
sum
.
num_objeùs_h™_£t_¬chive
 !ğ
šfo
.
¡©s
.stats.sum.num_objects_hit_set_archive &&

14888 !
šfo
.
¡©s
.
h™£t_¡©s_šv®id
) ||

14889 (
süub_c¡©
.
sum
.
num_by‹s_h™_£t_¬chive
 !ğ
šfo
.
¡©s
.stats.sum.num_bytes_hit_set_archive &&

14890 !
šfo
.
¡©s
.
h™£t_by‹s_¡©s_šv®id
) ||

14891 (
süub_c¡©
.
sum
.
num_objeùs_mªiã¡
 !ğ
šfo
.
¡©s
.stats.sum.num_objects_manifest &&

14892 !
šfo
.
¡©s
.
mªiã¡_¡©s_šv®id
) ||

14893 
süub_c¡©
.
sum
.
num_wh™eouts
 !ğ
šfo
.
¡©s
.stats.sum.num_whiteouts ||

14894 
süub_c¡©
.
sum
.
num_by‹s
 !ğ
šfo
.
¡©s
.stats.sum.num_bytes) {

14895 
osd
->
şog
->
	`”rÜ
(è<< 
šfo
.
pgid
 << " " << 
mode


14897 << 
süub_c¡©
.
sum
.
num_objeùs
 << "/" << 
šfo
.
¡©s
.stats.sum.num_objects << " objects, "

14898 << 
süub_c¡©
.
sum
.
num_objeù_şÚes
 << "/" << 
šfo
.
¡©s
.stats.sum.num_object_clones << " clones, "

14899 << 
süub_c¡©
.
sum
.
num_objeùs_dœty
 << "/" << 
šfo
.
¡©s
.stats.sum.num_objects_dirty << " dirty, "

14900 << 
süub_c¡©
.
sum
.
num_objeùs_om­
 << "/" << 
šfo
.
¡©s
.stats.sum.num_objects_omap << " omap, "

14901 << 
süub_c¡©
.
sum
.
num_objeùs_pšÃd
 << "/" << 
šfo
.
¡©s
.stats.sum.num_objects_pinned << "…inned, "

14902 << 
süub_c¡©
.
sum
.
num_objeùs_h™_£t_¬chive
 << "/" << 
šfo
.
¡©s
.stats.sum.num_objects_hit_set_archive << " hit_set_archive, "

14903 << 
süub_c¡©
.
sum
.
num_wh™eouts
 << "/" << 
šfo
.
¡©s
.stats.sum.num_whiteouts << " whiteouts, "

14904 << 
süub_c¡©
.
sum
.
num_by‹s
 << "/" << 
šfo
.
¡©s
.stats.sum.num_bytes << " bytes, "

14905 << 
süub_c¡©
.
sum
.
num_objeùs_mªiã¡
 << "/" << 
šfo
.
¡©s
.stats.sum.num_objects_manifest << " manifest objects, "

14906 << 
süub_c¡©
.
sum
.
num_by‹s_h™_£t_¬chive
 << "/" << 
šfo
.
¡©s
.stats.sum.num_bytes_hit_set_archive << " hit_set_archive bytes.";

14907 ++
süubb”
.
sh®low_”rÜs
;

14909 ià(
»·œ
) {

14910 ++
süubb”
.
fixed
;

14911 
šfo
.
¡©s
.¡© ğ
süub_c¡©
;

14912 
šfo
.
¡©s
.
dœty_¡©s_šv®id
 = 
çl£
;

14913 
šfo
.
¡©s
.
om­_¡©s_šv®id
 = 
çl£
;

14914 
šfo
.
¡©s
.
h™£t_¡©s_šv®id
 = 
çl£
;

14915 
šfo
.
¡©s
.
h™£t_by‹s_¡©s_šv®id
 = 
çl£
;

14916 
šfo
.
¡©s
.
pš_¡©s_šv®id
 = 
çl£
;

14917 
šfo
.
¡©s
.
mªiã¡_¡©s_šv®id
 = 
çl£
;

14918 
	`publish_¡©s_to_osd
();

14919 
	`sh¬e_pg_šfo
();

14923 ià(
»·œ
)

14924 
objeù_cÚ‹xts
.
	`ş—r
();

14925 
	}
}

14927 
boŞ
 
	gPrim¬yLogPG
::
check_osdm­_fuÎ
(cÚ¡ 
£t
<
pg_sh¬d_t
> &
missšg_Ú
)

14929  
osd
->
check_osdm­_fuÎ
(
missšg_Ú
);

14932 
	gPrim¬yLogPG
::
	$»p_»·œ_´im¬y_objeù
(cÚ¡ 
hobjeù_t
& 
soid
, 
OpReque¡Ref
 
İ
)

14935 
	`as£¹
(!
poŞ
.
šfo
.
	`is_”asu»
());

14936 
	`as£¹
(
	`is_´im¬y
());

14938 
	`dout
(10è<< 
__func__
 << " " << 
soid


14939 << "…“r osd.{" << 
aùšg_»cov”y_backfl
 << "}" << 
d’dl
;

14941 ià(!
	`is_ş—n
()) {

14942 
	`block_fÜ_ş—n
(
soid
, 
İ
);

14943  -
EAGAIN
;

14946 
	`as£¹
(!
pg_log
.
	`g‘_missšg
().
	`is_missšg
(
soid
));

14947 
bufã¾i¡
 
bv
;

14948 
objeù_šfo_t
 
oi
;

14949 
ev”siÚ_t
 
v
;

14950 
r
 = 
	`g‘_pgback’d
()->
	`objeùs_g‘_©Œ
(
soid
, 
OI_ATTR
, &
bv
);

14951 ià(
r
 < 0) {

14953 
	`dout
(0è<< 
__func__
 << ": Need version of„eplica, objects_get_attr failed: "

14954 << 
soid
 << "ƒ¼Ü=" << 
r
 << 
d’dl
;

14955 } 
Œy
 {

14956 
bufã¾i¡
::
™”©Ü
 
bl™”
 = 
bv
.
	`begš
();

14957 
	`decode
(
oi
, 
bl™”
);

14958 
v
 = 
oi
.
v”siÚ
;

14959 } 
	`ÿtch
 (...) {

14962 
	`dout
(0è<< 
__func__
 << ": N“d v”siÚ oà»¶iÿ, bad objeù_šfo_t: " << 
soid
 << 
d’dl
;

14965 
missšg_loc
.
	`add_missšg
(
soid
, 
v
, 
	`ev”siÚ_t
());

14966 ià(
	`´im¬y_”rÜ
(
soid
, 
v
)) {

14967 
	`dout
(0è<< 
__func__
 << " NØÙh”„•liÿ avaabË fÜ " << 
soid
 << 
d’dl
;

14977 
wa™šg_fÜ_uÄ—dabË_objeù
[
soid
].
	`push_back
(
İ
);

14978 
İ
->
	`m¬k_d–ayed
("waiting for missing object");

14980 ià(!
eio_”rÜs_to_´oûss
) {

14981 
eio_”rÜs_to_´oûss
 = 
Œue
;

14982 
	`as£¹
(
	`is_ş—n
());

14983 
	`queue_³”šg_ev’t
(

14984 
	`PGP“ršgEv’tRef
(

14985 
¡d
::
make_sh¬ed
<
PGP“ršgEv’t
>(

14986 
	`g‘_osdm­
()->
	`g‘_•och
(),

14987 
	`g‘_osdm­
()->
	`g‘_•och
(),

14988 
	`DoRecov”y
())));

14993 
	`dout
(5è<< 
__func__
<< ": R—dƒ¼Ü oÀ" << 
soid
 << ", buˆ®»ady s“À”rÜs" << 
d’dl
;

14996  -
EAGAIN
;

14997 
	}
}

15000 #undeà
dout_´efix


15001 
	#dout_´efix
 
pg
->
	`g’_´efix
(*
_dout
)

	)

15003 
	gPrim¬yLogPG
::
SÇpTrimm”
::
	$log_’‹r
(cÚ¡ *
¡©e_Çme
)

15005 
	`ldout
(
pg
->
cù
, 20è<< "’‹¸" << 
¡©e_Çme
 << 
d’dl
;

15006 
	}
}

15008 
	gPrim¬yLogPG
::
SÇpTrimm”
::
	$log_ex™
(cÚ¡ *
¡©e_Çme
, 
utime_t
 
’‹r_time
)

15010 
	`ldout
(
pg
->
cù
, 20è<< "ex™ " << 
¡©e_Çme
 << 
d’dl
;

15011 
	}
}

15014 #undeà
dout_´efix


15015 
	#dout_´efix
 (
cÚ‹xt
< 
SÇpTrimm”
 >().
pg
->
	`g’_´efix
(*
_dout
) \

15016 << "SÇpTrimm” s‹<" << 
	`g‘_¡©e_Çme
(è<< ">: ")

	)

15019 
	gPrim¬yLogPG
::
NÙTrimmšg
::
	$NÙTrimmšg
(
my_cÚ‹xt
 
ùx
)

15020 : 
	`my_ba£
(
ùx
),

15021 
	`NamedS‹
(
cÚ‹xt
< 
SÇpTrimm”
 >().
pg
, "NotTrimming")

15023 
cÚ‹xt
< 
SÇpTrimm”
 >().
	`log_’‹r
(
¡©e_Çme
);

15024 
	}
}

15026 
	gPrim¬yLogPG
::
NÙTrimmšg
::
	$ex™
()

15028 
cÚ‹xt
< 
SÇpTrimm”
 >().
	`log_ex™
(
¡©e_Çme
, 
’‹r_time
);

15029 
	}
}

15031 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
Prim¬yLogPG
::
NÙTrimmšg
::
	$»aù
(cÚ¡ 
KickTrim
&)

15033 
Prim¬yLogPG
 *
pg
 = 
cÚ‹xt
< 
SÇpTrimm”
 >().pg;

15034 
	`ldout
(
pg
->
cù
, 10è<< "NÙTrimmšg„—ù KickTrim" << 
d’dl
;

15036 ià(!(
pg
->
	`is_´im¬y
(è&&…g->
	`is_aùive
())) {

15037 
	`ldout
(
pg
->
cù
, 10è<< "NÙTrimmšg‚Ù…rim¬y o¸aùive" << 
d’dl
;

15038  
	`disÿrd_ev’t
();

15040 ià(!
pg
->
	`is_ş—n
() ||

15041 
pg
->
¢­_Œimq
.
	`em±y
()) {

15042 
	`ldout
(
pg
->
cù
, 10è<< "NÙTrimmšg‚Ù cËª o¸nÙhšgØŒim" << 
d’dl
;

15043  
	`disÿrd_ev’t
();

15045 ià(
pg
->
süubb”
.
aùive
) {

15046 
	`ldout
(
pg
->
cù
, 10è<< " süubbšg, wÈ»queu¢­_Œimm”‡á”" << 
d’dl
;

15047  
Œªs™
< 
Wa™Süub
 >();

15049  
Œªs™
< 
Trimmšg
 >();

15051 
	}
}

15053 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
Prim¬yLogPG
::
Wa™Re£rv©iÚ
::
	$»aù
(cÚ¡ 
SÇpTrimRe£rved
&)

15055 
Prim¬yLogPG
 *
pg
 = 
cÚ‹xt
< 
SÇpTrimm”
 >().pg;

15056 
	`ldout
(
pg
->
cù
, 10è<< "Wa™Re£rv©iÚ„—ù SÇpTrimRe£rved" << 
d’dl
;

15058 
³ndšg
 = 
nuÎ±r
;

15059 ià(!
cÚ‹xt
< 
SÇpTrimm”
 >().
	`ÿn_Œim
()) {

15060 
	`po¡_ev’t
(
	`KickTrim
());

15061  
Œªs™
< 
NÙTrimmšg
 >();

15064 
cÚ‹xt
<
Trimmšg
>().
¢­_to_Œim
 = 
pg
->
¢­_Œimq
.
	`¿nge_¡¬t
();

15065 
	`ldout
(
pg
->
cù
, 10) << "NotTrimming:rimming "

15066 << 
pg
->
¢­_Œimq
.
	`¿nge_¡¬t
()

15067 << 
d’dl
;

15068  
Œªs™
< 
Awa™AsyncWÜk
 >();

15069 
	}
}

15072 
	gPrim¬yLogPG
::
Awa™AsyncWÜk
::
	$Awa™AsyncWÜk
(
my_cÚ‹xt
 
ùx
)

15073 : 
	`my_ba£
(
ùx
),

15074 
	`NamedS‹
(
cÚ‹xt
< 
SÇpTrimm”
 >().
pg
, "Trimming/AwaitAsyncWork")

15076 autØ*
pg
 = 
cÚ‹xt
< 
SÇpTrimm”
 >().pg;

15077 
cÚ‹xt
< 
SÇpTrimm”
 >().
	`log_’‹r
(
¡©e_Çme
);

15078 
cÚ‹xt
< 
SÇpTrimm”
 >().
pg
->
osd
->
	`queue_fÜ_¢­_Œim
(pg);

15079 
pg
->
	`¡©e_£t
(
PG_STATE_SNAPTRIM
);

15080 
pg
->
	`¡©e_ş—r
(
PG_STATE_SNAPTRIM_ERROR
);

15081 
pg
->
	`publish_¡©s_to_osd
();

15082 
	}
}

15084 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
Prim¬yLogPG
::
Awa™AsyncWÜk
::
	$»aù
(cÚ¡ 
DoSÇpWÜk
&)

15086 
Prim¬yLogPGRef
 
pg
 = 
cÚ‹xt
< 
SÇpTrimm”
 >().pg;

15087 
¢­id_t
 
¢­_to_Œim
 = 
cÚ‹xt
<
Trimmšg
>().snap_to_trim;

15088 autØ&
š_æight
 = 
cÚ‹xt
<
Trimmšg
>().in_flight;

15089 
	`as£¹
(
š_æight
.
	`em±y
());

15091 
	`as£¹
(
pg
->
	`is_´im¬y
(è&&…g->
	`is_aùive
());

15092 ià(!
cÚ‹xt
< 
SÇpTrimm”
 >().
	`ÿn_Œim
()) {

15093 
	`ldout
(
pg
->
cù
, 10è<< "som‘hšg chªged,„ev”tšgØNÙTrimmšg" << 
d’dl
;

15094 
	`po¡_ev’t
(
	`KickTrim
());

15095  
Œªs™
< 
NÙTrimmšg
 >();

15098 
	`ldout
(
pg
->
cù
, 10è<< "Awa™AsyncWÜk:rimmšg sÇ°" << 
¢­_to_Œim
 << 
d’dl
;

15100 
veùÜ
<
hobjeù_t
> 
to_Œim
;

15101 
max
 = 
pg
->
cù
->
_cÚf
->
osd_pg_max_cÚcu¼’t_¢­_Œims
;

15102 
to_Œim
.
	`»£rve
(
max
);

15103 
r
 = 
pg
->
¢­_m­³r
.
	`g‘_Ãxt_objeùs_to_Œim
(

15104 
¢­_to_Œim
,

15105 
max
,

15106 &
to_Œim
);

15107 ià(
r
 !ğ0 &&„ !ğ-
ENOENT
) {

15108 
	`ld”r
(
pg
->
cù
) << "get_next_objects_to_trim„eturned "

15109 << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

15110 
	`as£¹
(0 == "get_next_objects_to_trim„eturned‡n invalid code");

15111 } ià(
r
 =ğ-
ENOENT
) {

15113 
	`ldout
(
pg
->
cù
, 10è<< "gÙ ENOENT" << 
d’dl
;

15115 
	`ldout
(
pg
->
cù
, 10è<< "addšg sÇ°" << 
¢­_to_Œim


15117 << 
d’dl
;

15118 
pg
->
šfo
.
purged_¢­s
.
	`š£¹
(
¢­_to_Œim
);

15119 
pg
->
¢­_Œimq
.
	`”a£
(
¢­_to_Œim
);

15120 
	`ldout
(
pg
->
cù
, 10) << "purged_snaps‚ow "

15121 << 
pg
->
šfo
.
purged_¢­s
 << ", snap_trimq‚ow "

15122 << 
pg
->
¢­_Œimq
 << 
d’dl
;

15124 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

15125 
pg
->
dœty_big_šfo
 = 
Œue
;

15126 
pg
->
	`wr™e_if_dœty
(
t
);

15127 
Œ
 = 
pg
->
osd
->
¡Üe
->
	`queue_Œª§ùiÚ
Õg->
ch
, 
¡d
::
	`move
(
t
), 
NULL
);

15128 
	`as£¹
(
Œ
 == 0);

15130 
pg
->
	`sh¬e_pg_šfo
();

15131 
	`po¡_ev’t
(
	`KickTrim
());

15132  
Œªs™
< 
NÙTrimmšg
 >();

15134 
	`as£¹
(!
to_Œim
.
	`em±y
());

15136 autØ&&
objeù
: 
to_Œim
) {

15138 
	`ldout
(
pg
->
cù
, 10è<< "Awa™AsyncWÜk„—ùrimmšg " << 
objeù
 << 
d’dl
;

15139 
OpCÚ‹xtUPŒ
 
ùx
;

15140 
”rÜ
 = 
pg
->
	`Œim_objeù
(
š_æight
.
	`em±y
(), 
objeù
, &
ùx
);

15141 ià(
”rÜ
) {

15142 ià(
”rÜ
 =ğ-
ENOLCK
) {

15143 
	`ldout
(
pg
->
cù
, 10) << "could‚ot get write†ock on obj "

15144 << 
objeù
 << 
d’dl
;

15146 
pg
->
	`¡©e_£t
(
PG_STATE_SNAPTRIM_ERROR
);

15147 
	`ldout
(
pg
->
cù
, 10è<< "SÇ±rimƒ¼Ü=" << 
”rÜ
 << 
d’dl
;

15149 ià(!
š_æight
.
	`em±y
()) {

15150 
	`ldout
(
pg
->
cù
, 10è<< "Ë‰šghÚe w®»ady s¹ed fšish" << 
d’dl
;

15151  
Œªs™
< 
Wa™R•İs
 >();

15153 ià(
”rÜ
 =ğ-
ENOLCK
) {

15154 
	`ldout
(
pg
->
cù
, 10) << "waiting for ito clear"

15155 << 
d’dl
;

15156  
Œªs™
< 
Wa™RWLock
 >();

15158  
Œªs™
< 
NÙTrimmšg
 >();

15162 
š_æight
.
	`š£¹
(
objeù
);

15163 
ùx
->
	`»gi¡”_Ú_sucûss
(

15164 [
pg
, 
objeù
, &
š_æight
]() {

15165 
	`as£¹
(
š_æight
.
	`fšd
(
objeù
è!ğš_æight.
	`’d
());

15166 
š_æight
.
	`”a£
(
objeù
);

15167 ià(
š_æight
.
	`em±y
()) {

15168 ià(
pg
->
	`¡©e_‹¡
(
PG_STATE_SNAPTRIM_ERROR
)) {

15169 
pg
->
¢­_Œimm”_machše
.
	`´oûss_ev’t
(
	`Re£t
());

15171 
pg
->
¢­_Œimm”_machše
.
	`´oûss_ev’t
(
	`R•İsCom¶‘e
());

15176 
pg
->
	`sim¶e_İc_subm™
(
¡d
::
	`move
(
ùx
));

15179  
Œªs™
< 
Wa™R•İs
 >();

15180 
	}
}

15182 
	gPrim¬yLogPG
::
	$£‰r_maybe_ÿche
(

15183 
ObjeùCÚ‹xtRef
 
obc
,

15184 
PGT¿n§ùiÚ
 *
t
,

15185 cÚ¡ 
¡ršg
 &
key
,

15186 
bufã¾i¡
 &
v®
)

15188 
t
->
	`£‰r
(
obc
->
obs
.
oi
.
soid
, 
key
, 
v®
);

15189 
	}
}

15191 
	gPrim¬yLogPG
::
£‰rs_maybe_ÿche
(

15192 
ObjeùCÚ‹xtRef
 
obc
,

15193 
PGT¿n§ùiÚ
 *
t
,

15194 
m­
<
¡ršg
, 
bufã¾i¡
> &
©Œs
)

15196 
	gt
->
£‰rs
(
obc
->
obs
.
oi
.
soid
, 
©Œs
);

15199 
	gPrim¬yLogPG
::
	$rm©Œ_maybe_ÿche
(

15200 
ObjeùCÚ‹xtRef
 
obc
,

15201 
PGT¿n§ùiÚ
 *
t
,

15202 cÚ¡ 
¡ršg
 &
key
)

15204 
t
->
	`rm©Œ
(
obc
->
obs
.
oi
.
soid
, 
key
);

15205 
	}
}

15207 
	gPrim¬yLogPG
::
	$g‘©Œ_maybe_ÿche
(

15208 
ObjeùCÚ‹xtRef
 
obc
,

15209 cÚ¡ 
¡ršg
 &
key
,

15210 
bufã¾i¡
 *
v®
)

15212 ià(
poŞ
.
šfo
.
	`is_”asu»
()) {

15213 
m­
<
¡ršg
, 
bufã¾i¡
>::
™”©Ü
 
i
 = 
obc
->
©Œ_ÿche
.
	`fšd
(
key
);

15214 ià(
i
 !ğ
obc
->
©Œ_ÿche
.
	`’d
()) {

15215 ià(
v®
)

15216 *
v®
 = 
i
->
£cÚd
;

15219  -
ENODATA
;

15222  
pgback’d
->
	`objeùs_g‘_©Œ
(
obc
->
obs
.
oi
.
soid
, 
key
, 
v®
);

15223 
	}
}

15225 
	gPrim¬yLogPG
::
g‘©Œs_maybe_ÿche
(

15226 
ObjeùCÚ‹xtRef
 
obc
,

15227 
m­
<
¡ršg
, 
bufã¾i¡
> *
out
)

15229 
	gr
 = 0;

15230 
as£¹
(
out
);

15231 ià(
	gpoŞ
.
	gšfo
.
is_”asu»
()) {

15232 *
	gout
 = 
obc
->
©Œ_ÿche
;

15234 
	gr
 = 
pgback’d
->
objeùs_g‘_©Œs
(
obc
->
obs
.
oi
.
soid
, 
out
);

15236 
	gm­
<
	g¡ršg
, 
	gbufã¾i¡
> 
	gtmp
;

15237 
	gm­
<
	g¡ršg
, 
	gbufã¾i¡
>::
™”©Ü
 
i
 = 
out
->
begš
();

15238 
	gi
 !ğ
out
->
’d
();

15239 ++
	gi
) {

15240 ià(
	gi
->
	gfœ¡
.
size
() > 1 && i->first[0] == '_')

15241 
tmp
[
i
->
fœ¡
.
sub¡r
(1, i->fœ¡.
size
())].
şaim
(i->
£cÚd
);

15243 
	gtmp
.
sw­
(*
out
);

15244  
	gr
;

15247 
boŞ
 
	gPrim¬yLogPG
::
	$check_ç§ã_fuÎ
() {

15248  
osd
->
	`check_ç§ã_fuÎ
(
	`g‘_dµ
());

15249 
	}
}

15251 
	$šŒusive_±r_add_»f
(
Prim¬yLogPG
 *
pg
è{…g->
	`g‘
("šŒ"); 
	}
}

15252 
	$šŒusive_±r_»Ëa£
(
Prim¬yLogPG
 *
pg
è{…g->
	`put
("šŒ"); 
	}
}

15254 #ifdeà
PG_DEBUG_REFS


15255 
ušt64_t
 
	$g‘_w™h_id
(
Prim¬yLogPG
 *
pg
è{ …g->
	`g‘_w™h_id
(); 
	}
}

15256 
	$put_w™h_id
(
Prim¬yLogPG
 *
pg
, 
ušt64_t
 
id
è{ …g->
	`put_w™h_id
(id); 
	}
}

15259 
	$šŒusive_±r_add_»f
(
Prim¬yLogPG
::
R•G©h”
 *
»pİ
è{„•İ->
	`g‘
(); 
	}
}

15260 
	$šŒusive_±r_»Ëa£
(
Prim¬yLogPG
::
R•G©h”
 *
»pİ
è{„•İ->
	`put
(); 
	}
}

	@osd/PrimaryLogPG.h

17 #iâdeà
CEPH_REPLICATEDPG_H


18 
	#CEPH_REPLICATEDPG_H


	)

20 
	~<boo¡/tu¶e/tu¶e.hµ
>

21 
	~"šşude/as£¹.h
"

22 
	~"PG.h
"

23 
	~"W©ch.h
"

24 
	~"T›rAg’tS‹.h
"

25 
	~"mes§ges/MOSDOpR•ly.h
"

26 
	~"commÚ/Checksumm”.h
"

27 
	~"commÚ/sh¬ed±r_»gi¡ry.hµ
"

28 
	~"R•liÿ‹dBack’d.h
"

29 
	~"PGT¿n§ùiÚ.h
"

30 
	~"şs/»fcouÁ/şs_»fcouÁ_İs.h
"

32 
şass
 
	gCİyFromC®lback
;

33 
şass
 
	gPromÙeC®lback
;

35 
şass
 
	gPrim¬yLogPG
;

36 
şass
 
	gPGLSF‹r
;

37 
şass
 
	gH™S‘
;

38 
	gT›rAg’tS‹
;

39 
şass
 
	gMOSDOp
;

40 
şass
 
	gMOSDOpR•ly
;

41 
şass
 
	gOSDS”viû
;

43 
šŒusive_±r_add_»f
(
Prim¬yLogPG
 *
pg
);

44 
šŒusive_±r_»Ëa£
(
Prim¬yLogPG
 *
pg
);

45 
ušt64_t
 
g‘_w™h_id
(
Prim¬yLogPG
 *
pg
);

46 
put_w™h_id
(
Prim¬yLogPG
 *
pg
, 
ušt64_t
 
id
);

48 #ifdeà
PG_DEBUG_REFS


49 
	gT¿ckedIÁPŒ
<
	tPrim¬yLogPG
> 
	tPrim¬yLogPGRef
;

51 
	gboo¡
::
	tšŒusive_±r
<
	tPrim¬yLogPG
> 
	tPrim¬yLogPGRef
;

54 
	gšcÚsi¡’t_¢­£t_w¿µ”
;

56 
şass
 
	gPrim¬yLogPG
 : 
public
 
PG
,…ubliø
	gPGBack’d
::
Li¡’”
 {

57 
ä›nd
 
şass
 
OSD
;

58 
ä›nd
 
şass
 
	gW©ch
;

60 
	gpublic
:

61 
MEMPOOL_CLASS_HELPERS
();

66 
	gOpCÚ‹xt
;

67 
şass
 
	gCİyC®lback
;

72 
	sCİyResuÉs
 {

73 
	gûph
::
»®_time
 
mtime
;

74 
ušt64_t
 
	gobjeù_size
;

75 
boŞ
 
	g¡¬‹d_‹mp_obj
;

76 
hobjeù_t
 
	g‹mp_oid
;

83 
	g¡d
::
funùiÚ
<(
PGT¿n§ùiÚ
 *)> 
fl_š_fš®_tx
;

85 
v”siÚ_t
 
	gu£r_v”siÚ
;

86 
boŞ
 
	gshould_»queue
;

87 
	gveùÜ
<
	g¢­id_t
> 
	g¢­s
;

88 
¢­id_t
 
	g¢­_£q
;

89 
	glib¿dos
::
¢­_£t_t
 
¢­£t
;

90 
boŞ
 
	gmœrÜ_¢­£t
;

91 
boŞ
 
	ghas_om­
;

92 
ušt32_t
 
	gæags
;

93 
ušt32_t
 
	gsourû_d©a_dige¡
, 
	gsourû_om­_dige¡
;

94 
ušt32_t
 
	gd©a_dige¡
, 
	gom­_dige¡
;

95 
	gmempoŞ
::
osd_pglog
::
veùÜ
<
·œ
<
osd_»qid_t
, 
	gv”siÚ_t
> > 
	g»qids
;

96 
	gm­
<
	g¡ršg
, 
	gbufã¾i¡
> 
	g©Œs
;

97 
ušt64_t
 
	gŒunÿ‹_£q
;

98 
ušt64_t
 
	gŒunÿ‹_size
;

99 
boŞ
 
is_d©a_dige¡
() {

100  
	gæags
 & 
	gobjeù_cİy_d©a_t
::
FLAG_DATA_DIGEST
;

102 
boŞ
 
is_om­_dige¡
() {

103  
	gæags
 & 
	gobjeù_cİy_d©a_t
::
FLAG_OMAP_DIGEST
;

105 
CİyResuÉs
()

106 : 
objeù_size
(0), 
¡¬‹d_‹mp_obj
(
çl£
),

107 
u£r_v”siÚ
(0),

108 
should_»queue
(
çl£
), 
mœrÜ_¢­£t
(false),

109 
has_om­
(
çl£
),

110 
æags
(0),

111 
sourû_d©a_dige¡
(-1), 
sourû_om­_dige¡
(-1),

112 
d©a_dige¡
(-1), 
om­_dige¡
(-1),

113 
Œunÿ‹_£q
(0), 
Œunÿ‹_size
(0)

117 
	gCİyOp
;

118 
	gûph
::
	tsh¬ed_±r
<
	tCİyOp
> 
	tCİyOpRef
;

120 
	sCİyOp
 {

121 
CİyC®lback
 *
	gcb
;

122 
ObjeùCÚ‹xtRef
 
	gobc
;

123 
hobjeù_t
 
	g¤c
;

124 
objeù_loÿtÜ_t
 
	gŞoc
;

125 
	gæags
;

126 
boŞ
 
	gmœrÜ_¢­£t
;

128 
CİyResuÉs
 
	g»suÉs
;

130 
ûph_tid_t
 
	gobjeù”_tid
;

131 
ûph_tid_t
 
	gobjeù”_tid2
;

133 
objeù_cİy_cursÜ_t
 
	gcursÜ
;

134 
	gm­
<
	g¡ršg
,
	gbufã¾i¡
> 
	g©Œs
;

135 
bufã¾i¡
 
	gd©a
;

136 
bufã¾i¡
 
	gom­_h—d”
;

137 
bufã¾i¡
 
	gom­_d©a
;

138 
	grv®
;

140 
objeù_cİy_cursÜ_t
 
	g‹mp_cursÜ
;

149 
	g¤c_obj_çdvi£_æags
;

150 
	gde¡_obj_çdvi£_æags
;

152 
	gm­
<
	gušt64_t
, 
	gCİyOpRef
> 
	gchunk_cİs
;

153 
	gnum_chunk
;

154 
boŞ
 
	gçed
;

155 
ušt64_t
 
	g¡¬t_off£t
 = 0;

156 
ušt64_t
 
	gÏ¡_off£t
 = 0;

157 
	gveùÜ
<
	gOSDOp
> 
	gchunk_İs
;

159 
CİyOp
(
CİyC®lback
 *
cb_
, 
ObjeùCÚ‹xtRef
 
_obc
, 
hobjeù_t
 
s
,

160 
objeù_loÿtÜ_t
 
l
,

161 
v”siÚ_t
 
v
,

162 
f
,

163 
boŞ
 
ms
,

164 
¤c_obj_çdvi£_æags
,

165 
de¡_obj_çdvi£_æags
)

166 : 
cb
(
cb_
), 
obc
(
_obc
), 
¤c
(
s
), 
Şoc
(
l
), 
æags
(
f
),

167 
mœrÜ_¢­£t
(
ms
),

168 
objeù”_tid
(0),

169 
objeù”_tid2
(0),

170 
rv®
(-1),

171 
¤c_obj_çdvi£_æags
(src_obj_fadvise_flags),

172 
de¡_obj_çdvi£_æags
(dest_obj_fadvise_flags),

173 
num_chunk
(0),

174 
çed
(
çl£
)

176 
	g»suÉs
.
	gu£r_v”siÚ
 = 
v
;

177 
	g»suÉs
.
	gmœrÜ_¢­£t
 = 
mœrÜ_¢­£t
;

189 
	gboo¡
::
	ttu¶e
<, 
	tCİyResuÉs
*> 
	tCİyC®lbackResuÉs
;

191 
ä›nd
 
şass
 
	gCİyFromC®lback
;

192 
ä›nd
 
şass
 
	gCİyFromFšish”
;

193 
ä›nd
 
şass
 
	gPromÙeC®lback
;

194 
ä›nd
 
şass
 
	gPromÙeFšish”
;

196 
	sProxyR—dOp
 {

197 
OpReque¡Ref
 
	gİ
;

198 
hobjeù_t
 
	gsoid
;

199 
ûph_tid_t
 
	gobjeù”_tid
;

200 
	gveùÜ
<
	gOSDOp
> &
	gİs
;

201 
v”siÚ_t
 
	gu£r_v”siÚ
;

202 
	gd©a_off£t
;

203 
boŞ
 
	gÿnûËd
;

205 
ProxyR—dOp
(
OpReque¡Ref
 
_İ
, 
hobjeù_t
 
oid
, 
veùÜ
<
OSDOp
>& 
_İs
)

206 : 
İ
(
_İ
), 
soid
(
oid
),

207 
objeù”_tid
(0), 
İs
(
_İs
),

208 
u£r_v”siÚ
(0), 
d©a_off£t
(0),

209 
ÿnûËd
(
çl£
) { }

211 
	gûph
::
	tsh¬ed_±r
<
	tProxyR—dOp
> 
	tProxyR—dOpRef
;

213 
	sProxyWr™eOp
 {

214 
OpCÚ‹xt
 *
	gùx
;

215 
OpReque¡Ref
 
	gİ
;

216 
hobjeù_t
 
	gsoid
;

217 
ûph_tid_t
 
	gobjeù”_tid
;

218 
	gveùÜ
<
	gOSDOp
> &
	gİs
;

219 
v”siÚ_t
 
	gu£r_v”siÚ
;

220 
boŞ
 
	g£Á_»¶y
;

221 
utime_t
 
	gmtime
;

222 
boŞ
 
	gÿnûËd
;

223 
osd_»qid_t
 
	g»qid
;

225 
ProxyWr™eOp
(
OpReque¡Ref
 
_İ
, 
hobjeù_t
 
oid
, 
veùÜ
<
OSDOp
>& 
_İs
, 
osd_»qid_t
 
_»qid
)

226 : 
ùx
(
NULL
), 
İ
(
_İ
), 
soid
(
oid
),

227 
objeù”_tid
(0), 
İs
(
_İs
),

228 
u£r_v”siÚ
(0), 
£Á_»¶y
(
çl£
),

229 
ÿnûËd
(
çl£
),

230 
»qid
(
_»qid
) { }

232 
	gûph
::
	tsh¬ed_±r
<
	tProxyWr™eOp
> 
	tProxyWr™eOpRef
;

234 
	sFlushOp
 {

235 
ObjeùCÚ‹xtRef
 
	gobc
;

236 
OpReque¡Ref
 
	gİ
;

237 
	gli¡
<
	gOpReque¡Ref
> 
	gdup_İs
;

238 
v”siÚ_t
 
	gæushed_v”siÚ
;

239 
ûph_tid_t
 
	gobjeù”_tid
;

240 
	grv®
;

241 
boŞ
 
	gblockšg
;

242 
boŞ
 
	g»mov®
;

243 
	gboo¡
::
İtiÚ®
<
¡d
::
funùiÚ
<()>> 
Ú_æush
;

245 
	gm­
<
	gušt64_t
, > 
	gio_»suÉs
;

246 
	gm­
<
	gušt64_t
, 
	gûph_tid_t
> 
	gio_tids
;

247 
ušt64_t
 
	gchunks
;

249 
FlushOp
()

250 : 
æushed_v”siÚ
(0), 
objeù”_tid
(0), 
rv®
(0),

251 
blockšg
(
çl£
), 
»mov®
(çl£), 
chunks
(0) {}

252 ~
FlushOp
(è{ 
as£¹
(!
Ú_æush
); }

254 
	gûph
::
	tsh¬ed_±r
<
	tFlushOp
> 
	tFlushOpRef
;

256 
	gboo¡
::
scİed_±r
<
PGBack’d
> 
pgback’d
;

257 
PGBack’d
 *
g‘_pgback’d
(è
	gov”ride
 {

258  
	gpgback’d
.
g‘
();

261 cÚ¡ 
PGBack’d
 *
g‘_pgback’d
(ècÚ¡ 
	gov”ride
 {

262  
	gpgback’d
.
g‘
();

266 
DoutP»fixProvid”
 *
g‘_dµ
(è
	gov”ride
 {

267  
	gthis
;

270 
Ú_loÿl_»cov”
(

271 cÚ¡ 
hobjeù_t
 &
oid
,

272 cÚ¡ 
ObjeùRecov”yInfo
 &
»cov”y_šfo
,

273 
ObjeùCÚ‹xtRef
 
obc
,

274 
boŞ
 
is_d–‘e
,

275 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t


276 è
ov”ride
;

277 
Ú_³”_»cov”
(

278 
pg_sh¬d_t
 
³”
,

279 cÚ¡ 
hobjeù_t
 &
oid
,

280 cÚ¡ 
ObjeùRecov”yInfo
 &
»cov”y_šfo


281 è
	gov”ride
;

282 
begš_³”_»cov”
(

283 
pg_sh¬d_t
 
³”
,

284 cÚ¡ 
hobjeù_t
 
oid
è
	gov”ride
;

285 
Ú_glob®_»cov”
(

286 cÚ¡ 
hobjeù_t
 &
oid
,

287 cÚ¡ 
objeù_¡©_sum_t
 &
¡©_diff
,

288 
boŞ
 
is_d–‘e
è
	gov”ride
;

289 
çed_push
(cÚ¡ 
li¡
<
pg_sh¬d_t
> &
äom
, cÚ¡ 
hobjeù_t
 &
soid
è
	gov”ride
;

290 
´im¬y_çed
(cÚ¡ 
hobjeù_t
 &
soid
è
	gov”ride
;

291 
boŞ
 
´im¬y_”rÜ
(cÚ¡ 
hobjeù_t
& 
soid
, 
ev”siÚ_t
 
v
è
	gov”ride
;

292 
ÿnûl_puÎ
(cÚ¡ 
hobjeù_t
 &
soid
è
	gov”ride
;

293 
­¶y_¡©s
(

294 cÚ¡ 
hobjeù_t
 &
soid
,

295 cÚ¡ 
objeù_¡©_sum_t
 &
d–_¡©s
è
	gov”ride
;

296 
Ú_´im¬y_”rÜ
(cÚ¡ 
hobjeù_t
 &
oid
, 
ev”siÚ_t
 
v
è
	gov”ride
;

297 
backfl_add_missšg
(cÚ¡ 
hobjeù_t
 &
oid
, 
ev”siÚ_t
 
v
è
	gov”ride
;

298 
»move_missšg_objeù
(cÚ¡ 
hobjeù_t
 &
oid
,

299 
ev”siÚ_t
 
v
,

300 
CÚ‹xt
 *
Ú_com¶‘e
è
	gov”ride
;

302 
	g‹m¶©e
<
şass
 
	gT
> cÏs 
	gBËs£dG’CÚ‹xt
;

303 
	g‹m¶©e
<
şass
 
	gT
> cÏs 
	gUÆockedBËs£dG’CÚ‹xt
;

304 
şass
 
	gBËs£dCÚ‹xt
;

305 
CÚ‹xt
 *
bËss_cÚ‹xt
(CÚ‹xˆ*
c
è
	gov”ride
;

307 
	gG’CÚ‹xt
<
	gTh»adPoŞ
::
TPHªdË
&> *
bËss_g’cÚ‹xt
(

308 
G’CÚ‹xt
<
Th»adPoŞ
::
TPHªdË
&> *
c
è
ov”ride
;

309 
	gG’CÚ‹xt
<
	gTh»adPoŞ
::
TPHªdË
&> *
bËss_uÆocked_g’cÚ‹xt
(

310 
G’CÚ‹xt
<
Th»adPoŞ
::
TPHªdË
&> *
c
è
ov”ride
;

312 
£nd_mes§ge
(
to_osd
, 
Mes§ge
 *
m
è
	gov”ride
 {

313 
	gosd
->
£nd_mes§ge_osd_şu¡”
(
to_osd
, 
m
, 
g‘_osdm­
()->
g‘_•och
());

315 
queue_Œª§ùiÚ
(
ObjeùStÜe
::
T¿n§ùiÚ
&& 
t
,

316 
OpReque¡Ref
 
İ
è
	gov”ride
 {

317 
	gosd
->
	g¡Üe
->
queue_Œª§ùiÚ
(
ch
, 
¡d
::
move
(
t
), 
İ
);

319 
queue_Œª§ùiÚs
(
veùÜ
<
ObjeùStÜe
::
T¿n§ùiÚ
>& 
s
,

320 
OpReque¡Ref
 
İ
è
	gov”ride
 {

321 
	gosd
->
	g¡Üe
->
queue_Œª§ùiÚs
(
ch
, 
s
, 
İ
, 
NULL
);

323 
•och_t
 
g‘_•och
(ècÚ¡ 
	gov”ride
 {

324  
g‘_osdm­
()->
g‘_•och
();

326 
•och_t
 
g‘_š‹rv®_¡¬t_•och
(ècÚ¡ 
	gov”ride
 {

327  
	gšfo
.
	ghi¡Üy
.
	g§me_š‹rv®_sšû
;

329 
•och_t
 
g‘_Ï¡_³”šg_»£t_•och
(ècÚ¡ 
	gov”ride
 {

330  
g‘_Ï¡_³”šg_»£t
();

332 cÚ¡ 
	g£t
<
	gpg_sh¬d_t
> &
g‘_aùšg_»cov”y_backfl_sh¬ds
(ècÚ¡ 
	gov”ride
 {

333  
	gaùšg_»cov”y_backfl
;

335 cÚ¡ 
	g£t
<
	gpg_sh¬d_t
> &
g‘_aùšg_sh¬ds
(ècÚ¡ 
	gov”ride
 {

336  
	gaùšg£t
;

338 cÚ¡ 
	g£t
<
	gpg_sh¬d_t
> &
g‘_backfl_sh¬ds
(ècÚ¡ 
	gov”ride
 {

339  
	gbackfl_rg‘s
;

342 
	g¡d
::
o¡»am
& 
g’_dbg_´efix
(
¡d
::o¡»am& 
out
ècÚ¡ 
ov”ride
 {

343  
g’_´efix
(
out
);

346 cÚ¡ 
	gm­
<
	ghobjeù_t
, 
	g£t
<
	gpg_sh¬d_t
>>

347 &
g‘_missšg_loc_sh¬ds
(ècÚ¡ 
	gov”ride
 {

348  
	gmissšg_loc
.
g‘_missšg_locs
();

350 cÚ¡ 
	gm­
<
	gpg_sh¬d_t
, 
	gpg_missšg_t
> &
g‘_sh¬d_missšg
(ècÚ¡ 
	gov”ride
 {

351  
	g³”_missšg
;

353 
usšg
 
	gPGBack’d
::
Li¡’”
::
g‘_sh¬d_missšg
;

354 cÚ¡ 
	gm­
<
	gpg_sh¬d_t
, 
	gpg_šfo_t
> &
g‘_sh¬d_šfo
(ècÚ¡ 
	gov”ride
 {

355  
	g³”_šfo
;

357 
usšg
 
	gPGBack’d
::
Li¡’”
::
g‘_sh¬d_šfo
;

358 cÚ¡ 
	gpg_missšg_Œack”_t
 &
g‘_loÿl_missšg
(ècÚ¡ 
	gov”ride
 {

359  
	gpg_log
.
g‘_missšg
();

361 cÚ¡ 
	gPGLog
 &
g‘_log
(ècÚ¡ 
	gov”ride
 {

362  
	gpg_log
;

364 
add_loÿl_Ãxt_ev’t
(cÚ¡ 
pg_log_’Œy_t
& 
e
è
	gov”ride
 {

365 
	gpg_log
.
missšg_add_Ãxt_’Œy
(
e
);

367 
boŞ
 
pgb_is_´im¬y
(ècÚ¡ 
	gov”ride
 {

368  
is_´im¬y
();

370 
OSDM­Ref
 
pgb_g‘_osdm­
(ècÚ¡ 
	gov”ride
 {

371  
g‘_osdm­
();

373 cÚ¡ 
	gpg_šfo_t
 &
g‘_šfo
(ècÚ¡ 
	gov”ride
 {

374  
	gšfo
;

376 cÚ¡ 
	gpg_poŞ_t
 &
g‘_poŞ
(ècÚ¡ 
	gov”ride
 {

377  
	gpoŞ
.
	gšfo
;

380 
ObjeùCÚ‹xtRef
 
g‘_obc
(

381 cÚ¡ 
hobjeù_t
 &
hoid
,

382 cÚ¡ 
m­
<
¡ršg
, 
bufã¾i¡
> &
©Œs
è
	gov”ride
 {

383  
g‘_objeù_cÚ‹xt
(
hoid
, 
Œue
, &
©Œs
);

386 
boŞ
 
Œy_lock_fÜ_»ad
(

387 cÚ¡ 
hobjeù_t
 &
hoid
,

388 
ObcLockMªag”
 &
mªag”
è
	gov”ride
 {

389 ià(
is_missšg_objeù
(
hoid
))

390  
	gçl£
;

391 autØ
	gobc
 = 
g‘_objeù_cÚ‹xt
(
hoid
, 
çl£
, 
nuÎ±r
);

392 ià(!
	gobc
)

393  
	gçl£
;

394  
	gmªag”
.
Œy_g‘_»ad_lock
(
hoid
, 
obc
);

397 
»Ëa£_locks
(
ObcLockMªag”
 &
mªag”
è
	gov”ride
 {

398 
»Ëa£_objeù_locks
(
mªag”
);

401 
pgb_£t_objeù_¢­_m­pšg
(

402 cÚ¡ 
hobjeù_t
 &
soid
,

403 cÚ¡ 
£t
<
¢­id_t
> &
¢­s
,

404 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
è
ov”ride
 {

405  
upd©e_objeù_¢­_m­pšg
(
t
, 
soid
, 
¢­s
);

407 
pgb_ş—r_objeù_¢­_m­pšg
(

408 cÚ¡ 
hobjeù_t
 &
soid
,

409 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
è
ov”ride
 {

410  
ş—r_objeù_¢­_m­pšg
(
t
, 
soid
);

413 
log_İ”©iÚ
(

414 cÚ¡ 
veùÜ
<
pg_log_’Œy_t
> &
logv
,

415 cÚ¡ 
boo¡
::
İtiÚ®
<
pg_h™_£t_hi¡Üy_t
> &
h£t_hi¡Üy
,

416 cÚ¡ 
ev”siÚ_t
 &
Œim_to
,

417 cÚ¡ 
ev”siÚ_t
 &
rŞl_fÜw¬d_to
,

418 
boŞ
 
Œª§ùiÚ_­¶›d
,

419 
ObjeùStÜe
::
T¿n§ùiÚ
 &
t
è
ov”ride
 {

420 ià(
h£t_hi¡Üy
) {

421 
šfo
.
h™_£t
 = *
h£t_hi¡Üy
;

423 
­³nd_log
(
logv
, 
Œim_to
, 
rŞl_fÜw¬d_to
, 
t
, 
Œª§ùiÚ_­¶›d
);

426 
İ_­¶›d
(cÚ¡ 
ev”siÚ_t
 &
­¶›d_v”siÚ
è
	gov”ride
;

428 
boŞ
 
should_£nd_İ
(

429 
pg_sh¬d_t
 
³”
,

430 cÚ¡ 
hobjeù_t
 &
hoid
è
	gov”ride
;

432 
boŞ
 
pg_is_und”sized
(ècÚ¡ 
	gov”ride
 {

433  
is_und”sized
();

436 
upd©e_³”_Ï¡_com¶‘e_Údisk
(

437 
pg_sh¬d_t
 
äomosd
,

438 
ev”siÚ_t
 
lcod
è
	gov”ride
 {

439 
	g³”_Ï¡_com¶‘e_Údisk
[
äomosd
] = 
lcod
;

442 
upd©e_Ï¡_com¶‘e_Údisk
(

443 
ev”siÚ_t
 
lcod
è
	gov”ride
 {

444 
	gÏ¡_com¶‘e_Údisk
 = 
lcod
;

447 
upd©e_¡©s
(

448 cÚ¡ 
pg_¡©_t
 &
¡©
è
	gov”ride
 {

449 
	gšfo
.
	g¡©s
 = 
¡©
;

452 
scheduË_»cov”y_wÜk
(

453 
G’CÚ‹xt
<
Th»adPoŞ
::
TPHªdË
&> *
c
è
ov”ride
;

455 
pg_sh¬d_t
 
whßmi_sh¬d
(ècÚ¡ 
	gov”ride
 {

456  
	gpg_whßmi
;

458 
¥g_t
 
´im¬y_¥g_t
(ècÚ¡ 
	gov”ride
 {

459  
¥g_t
(
šfo
.
pgid
.pgid, 
´im¬y
.
sh¬d
);

461 
pg_sh¬d_t
 
´im¬y_sh¬d
(ècÚ¡ 
	gov”ride
 {

462  
	g´im¬y
;

464 
ušt64_t
 
mš_³”_ã©u»s
(ècÚ¡ 
	gov”ride
 {

465  
g‘_mš_³”_ã©u»s
();

468 
£nd_mes§ge_osd_şu¡”
(

469 
³”
, 
Mes§ge
 *
m
, 
•och_t
 
äom_•och
è
	gov”ride
;

470 
£nd_mes§ge_osd_şu¡”
(

471 
Mes§ge
 *
m
, 
CÚÃùiÚ
 *
cÚ
è
	gov”ride
;

472 
£nd_mes§ge_osd_şu¡”
(

473 
Mes§ge
 *
m
, cÚ¡ 
CÚÃùiÚRef
& 
cÚ
è
	gov”ride
;

474 
CÚÃùiÚRef
 
g‘_cÚ_osd_şu¡”
(
³”
, 
•och_t
 
äom_•och
è
	gov”ride
;

475 
’t™y_Çme_t
 
g‘_şu¡”_msgr_Çme
(è
	gov”ride
 {

476  
	gosd
->
g‘_şu¡”_msgr_Çme
();

479 
P”fCouÁ”s
 *
g‘_logg”
(è
	gov”ride
;

481 
ûph_tid_t
 
g‘_tid
(è
	gov”ride
 {  
	gosd
->get_tid(); }

483 
LogCl›ÁTemp
 
şog_”rÜ
(è
	gov”ride
 {  
	gosd
->
	gşog
->
”rÜ
(); }

484 
LogCl›ÁTemp
 
şog_w¬n
(è
	gov”ride
 {  
	gosd
->
	gşog
->
w¬n
(); }

486 
	sw©ch_discÚÃù_t
 {

487 
ušt64_t
 
	gcook›
;

488 
’t™y_Çme_t
 
	gÇme
;

489 
boŞ
 
	g£nd_discÚÃù
;

490 
w©ch_discÚÃù_t
(
ušt64_t
 
c
, 
’t™y_Çme_t
 
n
, 
boŞ
 
sd
)

491 : 
cook›
(
c
), 
Çme
(
n
), 
£nd_discÚÃù
(
sd
) {}

493 
com¶‘e_discÚÃù_w©ches
(

494 
ObjeùCÚ‹xtRef
 
obc
,

495 cÚ¡ 
li¡
<
w©ch_discÚÃù_t
> &
to_discÚÃù
);

497 
	sOpFšish”
 {

498 
	gvœtu®
 ~
OpFšish”
() {

501 
vœtu®
 
execu‹
() = 0;

507 
	sOpCÚ‹xt
 {

508 
OpReque¡Ref
 
	gİ
;

509 
osd_»qid_t
 
	g»qid
;

510 
	gveùÜ
<
	gOSDOp
> *
	gİs
;

512 cÚ¡ 
ObjeùS‹
 *
	gobs
;

513 cÚ¡ 
SÇpS‘
 *
	g¢­£t
;

515 
ObjeùS‹
 
	gÃw_obs
;

516 
SÇpS‘
 
	gÃw_¢­£t
;

518 
objeù_¡©_sum_t
 
	gd–_¡©s
;

520 
boŞ
 
	gmodify
;

521 
boŞ
 
	gu£r_modify
;

522 
boŞ
 
	gundœty
;

523 
boŞ
 
	gÿche_eviù
;

524 
boŞ
 
	gignÜe_ÿche
;

525 
boŞ
 
	gignÜe_log_İ_¡©s
;

526 
boŞ
 
	gupd©e_log_Úly
;

529 
	gli¡
<
	g·œ
<
	gw©ch_šfo_t
,
	gboŞ
> > 
	gw©ch_cÚÃùs
;

530 
	gli¡
<
	gw©ch_discÚÃù_t
> 
	gw©ch_discÚÃùs
;

531 
	gli¡
<
	gnÙify_šfo_t
> 
	gnÙif›s
;

532 
	sNÙifyAck
 {

533 
	gboo¡
::
İtiÚ®
<
ušt64_t
> 
w©ch_cook›
;

534 
ušt64_t
 
	gnÙify_id
;

535 
bufã¾i¡
 
	g»¶y_bl
;

536 
ex¶ic™
 
NÙifyAck
(
ušt64_t
 
nÙify_id
) :‚otify_id(notify_id) {}

537 
NÙifyAck
(
ušt64_t
 
nÙify_id
, ušt64_ˆ
cook›
, 
bufã¾i¡
& 
rbl
)

538 : 
w©ch_cook›
(
cook›
), 
nÙify_id
(notify_id) {

539 
	g»¶y_bl
.
şaim
(
rbl
);

542 
	gli¡
<
	gNÙifyAck
> 
	gnÙify_acks
;

544 
ušt64_t
 
	gby‹s_wr™‹n
, 
	gby‹s_»ad
;

546 
utime_t
 
	gmtime
;

547 
SÇpCÚ‹xt
 
	g¢­c
;

548 
ev”siÚ_t
 
	g©_v”siÚ
;

549 
v”siÚ_t
 
	gu£r_©_v”siÚ
;

552 
	gcu¼’t_osd_subİ_num
;

554 
	g´oûs£d_subİ_couÁ
 = 0;

556 
PGT¿n§ùiÚUPŒ
 
	gİ_t
;

557 
	gveùÜ
<
	gpg_log_’Œy_t
> 
	glog
;

558 
	gboo¡
::
İtiÚ®
<
pg_h™_£t_hi¡Üy_t
> 
upd©ed_h£t_hi¡Üy
;

560 
	gš‹rv®_£t
<
	gušt64_t
> 
	gmodif›d_¿nges
;

561 
ObjeùCÚ‹xtRef
 
	gobc
;

562 
ObjeùCÚ‹xtRef
 
	gşÚe_obc
;

563 
ObjeùCÚ‹xtRef
 
	gh—d_obc
;

566 
	gboo¡
::
İtiÚ®
<> 
d©a_off
 = 
boo¡
::
nÚe
;

568 
MOSDOpR•ly
 *
	g»¶y
;

570 
Prim¬yLogPG
 *
	gpg
;

572 
	gnum_»ad
;

573 
	gnum_wr™e
;

575 
	gmempoŞ
::
osd_pglog
::
veùÜ
<
·œ
<
osd_»qid_t
, 
	gv”siÚ_t
> > 
	gexŒa_»qids
;

577 
hobjeù_t
 
	gÃw_‹mp_oid
, 
	gdisÿrd_‹mp_oid
;

579 
	gli¡
<
	g¡d
::
funùiÚ
<()>> 
Ú_­¶›d
;

580 
	gli¡
<
	g¡d
::
funùiÚ
<()>> 
Ú_comm™‹d
;

581 
	gli¡
<
	g¡d
::
funùiÚ
<()>> 
Ú_fšish
;

582 
	gli¡
<
	g¡d
::
funùiÚ
<()>> 
Ú_sucûss
;

583 
	g‹m¶©e
 <
ty³Çme
 
	gF
>

584 
»gi¡”_Ú_fšish
(
F
 &&
f
) {

585 
	gÚ_fšish
.
em¶aû_back
(
¡d
::
fÜw¬d
<
F
>(
f
));

587 
	g‹m¶©e
 <
ty³Çme
 
	gF
>

588 
»gi¡”_Ú_sucûss
(
F
 &&
f
) {

589 
	gÚ_sucûss
.
em¶aû_back
(
¡d
::
fÜw¬d
<
F
>(
f
));

591 
	g‹m¶©e
 <
ty³Çme
 
	gF
>

592 
»gi¡”_Ú_­¶›d
(
F
 &&
f
) {

593 
	gÚ_­¶›d
.
em¶aû_back
(
¡d
::
fÜw¬d
<
F
>(
f
));

595 
	g‹m¶©e
 <
ty³Çme
 
	gF
>

596 
»gi¡”_Ú_comm™
(
F
 &&
f
) {

597 
	gÚ_comm™‹d
.
em¶aû_back
(
¡d
::
fÜw¬d
<
F
>(
f
));

600 
boŞ
 
	g£Á_»¶y
 = 
çl£
;

603 
	gli¡
<
	g·œ
<
	gboo¡
::
tu¶e
<
ušt64_t
, 
	gušt64_t
, >,

604 
	g·œ
<
	gbufã¾i¡
*, 
	gCÚ‹xt
*> > > 
	g³ndšg_async_»ads
;

605 
	gšæighŒ—ds
;

606 
ä›nd
 
	gOnR—dCom¶‘e
;

607 
¡¬t_async_»ads
(
Prim¬yLogPG
 *
pg
);

608 
fšish_»ad
(
Prim¬yLogPG
 *
pg
);

609 
boŞ
 
async_»ads_com¶‘e
() {

610  
	gšæighŒ—ds
 == 0;

613 
	gObjeùCÚ‹xt
::
RWS‹
::
S‹
 
lock_ty³
;

614 
ObcLockMªag”
 
	glock_mªag”
;

616 
	g¡d
::
m­
<, std::
unique_±r
<
OpFšish”
>> 
İ_fšish”s
;

618 
OpCÚ‹xt
(cÚ¡ OpCÚ‹xt& 
Ùh”
);

619 cÚ¡ 
	gOpCÚ‹xt
& 
	gİ”©Ü
=(cÚ¡ 
OpCÚ‹xt
& 
Ùh”
);

621 
OpCÚ‹xt
(
OpReque¡Ref
 
_İ
, 
osd_»qid_t
 
_»qid
, 
veùÜ
<
OSDOp
>* 
_İs
,

622 
ObjeùCÚ‹xtRef
& 
obc
,

623 
Prim¬yLogPG
 *
_pg
) :

624 
İ
(
_İ
), 
»qid
(
_»qid
), 
İs
(
_İs
),

625 
obs
(&
obc
->obs),

626 
¢­£t
(0),

627 
Ãw_obs
(
obs
->
oi
, obs->
exi¡s
),

628 
modify
(
çl£
), 
u£r_modify
(çl£), 
undœty
(çl£), 
ÿche_eviù
(false),

629 
ignÜe_ÿche
(
çl£
), 
ignÜe_log_İ_¡©s
(çl£), 
upd©e_log_Úly
(false),

630 
by‹s_wr™‹n
(0), 
by‹s_»ad
(0), 
u£r_©_v”siÚ
(0),

631 
cu¼’t_osd_subİ_num
(0),

632 
obc
(obc),

633 
»¶y
(
NULL
), 
pg
(
_pg
),

634 
num_»ad
(0),

635 
num_wr™e
(0),

636 
£Á_»¶y
(
çl£
),

637 
šæighŒ—ds
(0),

638 
lock_ty³
(
ObjeùCÚ‹xt
::
RWS‹
::
RWNONE
) {

639 ià(
obc
->
ssc
) {

640 
Ãw_¢­£t
 = 
obc
->
ssc
->
¢­£t
;

641 
	g¢­£t
 = &
obc
->
ssc
->
¢­£t
;

644 
OpCÚ‹xt
(
OpReque¡Ref
 
_İ
, 
osd_»qid_t
 
_»qid
,

645 
veùÜ
<
OSDOp
>* 
_İs
, 
Prim¬yLogPG
 *
_pg
) :

646 
İ
(
_İ
), 
»qid
(
_»qid
), 
İs
(
_İs
), 
obs
(
NULL
), 
¢­£t
(0),

647 
modify
(
çl£
), 
u£r_modify
(çl£), 
undœty
(çl£), 
ÿche_eviù
(false),

648 
ignÜe_ÿche
(
çl£
), 
ignÜe_log_İ_¡©s
(çl£), 
upd©e_log_Úly
(false),

649 
by‹s_wr™‹n
(0), 
by‹s_»ad
(0), 
u£r_©_v”siÚ
(0),

650 
cu¼’t_osd_subİ_num
(0),

651 
»¶y
(
NULL
), 
pg
(
_pg
),

652 
num_»ad
(0),

653 
num_wr™e
(0),

654 
šæighŒ—ds
(0),

655 
lock_ty³
(
ObjeùCÚ‹xt
::
RWS‹
::
RWNONE
) {}

656 
»£t_obs
(
ObjeùCÚ‹xtRef
 
obc
) {

657 
Ãw_obs
 = 
ObjeùS‹
(
obc
->
obs
.
oi
, obc->obs.
exi¡s
);

658 ià(
	gobc
->
	gssc
) {

659 
	gÃw_¢­£t
 = 
obc
->
ssc
->
¢­£t
;

660 
	g¢­£t
 = &
obc
->
ssc
->
¢­£t
;

663 ~
OpCÚ‹xt
() {

664 
as£¹
(!
İ_t
);

665 ià(
	g»¶y
)

666 
	g»¶y
->
put
();

667 
	gli¡
<
	g·œ
<
	gboo¡
::
tu¶e
<
ušt64_t
, 
	gušt64_t
, >,

668 
	g·œ
<
	gbufã¾i¡
*, 
	gCÚ‹xt
*> > >::
™”©Ü
 
i
 =

669 
³ndšg_async_»ads
.
begš
();

670 
	gi
 !ğ
³ndšg_async_»ads
.
’d
();

671 
	g³ndšg_async_»ads
.
”a£
(
i
++)) {

672 
d–‘e
 
	gi
->
	g£cÚd
.second;

675 
ušt64_t
 
g‘_ã©u»s
() {

676 ià(
	gİ
 && op->
g‘_»q
()) {

677  
	gİ
->
g‘_»q
()->
g‘_cÚÃùiÚ
()->
g‘_ã©u»s
();

682 
usšg
 
	gOpCÚ‹xtUPŒ
 = 
¡d
::
unique_±r
<
OpCÚ‹xt
>;

683 
ä›nd
 
	gOpCÚ‹xt
;

688 şas 
	cR•G©h”
 {

689 
	gpublic
:

690 
hobjeù_t
 
hoid
;

691 
OpReque¡Ref
 
	gİ
;

692 
	gxli¡
<
	gR•G©h”
*>::
™em
 
queue_™em
;

693 
	gÄef
;

695 
ev”siÚ_t
 
	gv
;

696 
	gr
 = 0;

698 
ûph_tid_t
 
	g»p_tid
;

700 
boŞ
 
	g»p_abÜ‹d
;

701 
boŞ
 
	g®l_comm™‹d
;

703 
utime_t
 
	g¡¬t
;

705 
ev”siÚ_t
 
	gpg_loÿl_Ï¡_com¶‘e
;

707 
ObcLockMªag”
 
	glock_mªag”
;

709 
	gli¡
<
	g¡d
::
funùiÚ
<()>> 
Ú_comm™‹d
;

710 
	gli¡
<
	g¡d
::
funùiÚ
<()>> 
Ú_sucûss
;

711 
	gli¡
<
	g¡d
::
funùiÚ
<()>> 
Ú_fšish
;

713 
R•G©h”
(

714 
OpCÚ‹xt
 *
c
, 
ûph_tid_t
 
¹
,

715 
ev”siÚ_t
 
lc
) :

716 
hoid
(
c
->
obc
->
obs
.
oi
.
soid
),

717 
İ
(
c
->op),

718 
queue_™em
(
this
),

719 
Äef
(1),

720 
»p_tid
(
¹
),

721 
»p_abÜ‹d
(
çl£
),

722 
®l_comm™‹d
(
çl£
),

723 
pg_loÿl_Ï¡_com¶‘e
(
lc
),

724 
lock_mªag”
(
¡d
::
move
(
c
->lock_manager)),

725 
Ú_comm™‹d
(
¡d
::
move
(
c
->on_committed)),

726 
Ú_sucûss
(
¡d
::
move
(
c
->on_success)),

727 
Ú_fšish
(
¡d
::
move
(
c
->on_finish)) {}

729 
R•G©h”
(

730 
ObcLockMªag”
 &&
mªag”
,

731 
OpReque¡Ref
 &&
o
,

732 
boo¡
::
İtiÚ®
<
¡d
::
funùiÚ
<()> > &&
Ú_com¶‘e
,

733 
ûph_tid_t
 
¹
,

734 
ev”siÚ_t
 
lc
,

735 
r
) :

736 
İ
(
o
),

737 
queue_™em
(
this
),

738 
Äef
(1),

739 
r
(r),

740 
»p_tid
(
¹
),

741 
»p_abÜ‹d
(
çl£
),

742 
®l_comm™‹d
(
çl£
),

743 
pg_loÿl_Ï¡_com¶‘e
(
lc
),

744 
lock_mªag”
(
¡d
::
move
(
mªag”
)) {

745 ià(
Ú_com¶‘e
) {

746 
Ú_sucûss
.
push_back
(
¡d
::
move
(*
Ú_com¶‘e
));

750 
R•G©h”
 *
g‘
() {

751 
	gÄef
++;

752  
	gthis
;

754 
put
() {

755 
as£¹
(
Äef
 > 0);

756 ià(--
	gÄef
 == 0) {

757 
d–‘e
 
this
;

764 
	g´Ùeùed
:

772 
boŞ
 
	$g‘_rw_locks
(
boŞ
 
wr™e_Üd”ed
, 
OpCÚ‹xt
 *
ùx
) {

778 ià(
wr™e_Üd”ed
 && 
ùx
->
İ
->
	`may_»ad
()) {

779 
ùx
->
lock_ty³
 = 
ObjeùCÚ‹xt
::
RWS‹
::
RWEXCL
;

780 } ià(
wr™e_Üd”ed
) {

781 
ùx
->
lock_ty³
 = 
ObjeùCÚ‹xt
::
RWS‹
::
RWWRITE
;

783 
	`as£¹
(
ùx
->
İ
->
	`may_»ad
());

784 
ùx
->
lock_ty³
 = 
ObjeùCÚ‹xt
::
RWS‹
::
RWREAD
;

787 ià(
ùx
->
h—d_obc
) {

788 
	`as£¹
(!
ùx
->
obc
->
obs
.
exi¡s
);

789 ià(!
ùx
->
lock_mªag”
.
	`g‘_lock_ty³
(

790 
ùx
->
lock_ty³
,

791 
ùx
->
h—d_obc
->
obs
.
oi
.
soid
,

792 
ùx
->
h—d_obc
,

793 
ùx
->
İ
)) {

794 
ùx
->
lock_ty³
 = 
ObjeùCÚ‹xt
::
RWS‹
::
RWNONE
;

795  
çl£
;

798 ià(
ùx
->
lock_mªag”
.
	`g‘_lock_ty³
(

799 
ùx
->
lock_ty³
,

800 
ùx
->
obc
->
obs
.
oi
.
soid
,

801 
ùx
->
obc
,

802 
ùx
->
İ
)) {

803  
Œue
;

805 
	`as£¹
(!
ùx
->
h—d_obc
);

806 
ùx
->
lock_ty³
 = 
ObjeùCÚ‹xt
::
RWS‹
::
RWNONE
;

807  
çl£
;

809 
	}
}

816 
şo£_İ_ùx
(
OpCÚ‹xt
 *
ùx
);

823 
	$»Ëa£_objeù_locks
(

824 
ObcLockMªag”
 &
lock_mªag”
) {

825 
li¡
<
·œ
<
ObjeùCÚ‹xtRef
,†i¡<
OpReque¡Ref
> > > 
to_»q
;

826 
boŞ
 
»queue_»cov”y
 = 
çl£
;

827 
boŞ
 
»queue_¢­Œim
 = 
çl£
;

828 
lock_mªag”
.
	`put_locks
(

829 &
to_»q
,

830 &
»queue_»cov”y
,

831 &
»queue_¢­Œim
);

832 ià(
»queue_»cov”y
)

833 
	`queue_»cov”y
();

834 ià(
»queue_¢­Œim
)

835 
¢­_Œimm”_machše
.
	`´oûss_ev’t
(
	`TrimWr™eUnblocked
());

837 ià(!
to_»q
.
	`em±y
()) {

839 autØ&&
p
: 
to_»q
) {

840 ià(
	`wr™e_blocked_by_süub
(
p
.
fœ¡
->
obs
.
oi
.
soid
.
	`g‘_h—d
())) {

841 auto& 
İ
 : 
p
.
£cÚd
) {

842 
İ
->
	`m¬k_d–ayed
("waiting for scrub");

845 
wa™šg_fÜ_süub
.
	`¥liû
(

846 
wa™šg_fÜ_süub
.
	`begš
(),

847 
p
.
£cÚd
,

848 
p
.
£cÚd
.
	`begš
(),

849 
p
.
£cÚd
.
	`’d
());

851 
	`»queue_İs
(
p
.
£cÚd
);

855 
	}
}

859 
	gxli¡
<
	gR•G©h”
*> 
	g»pİ_queue
;

861 
ä›nd
 
şass
 
	gC_OSD_R•İComm™
;

862 
»pİ_®l_comm™‹d
(
R•G©h”
 *
»pİ
);

863 
ev®_»pİ
(
R•G©h”
*);

864 
issue_»pİ
(
R•G©h”
 *
»pİ
, 
OpCÚ‹xt
 *
ùx
);

865 
R•G©h”
 *
Ãw_»pİ
(

866 
OpCÚ‹xt
 *
ùx
,

867 
ObjeùCÚ‹xtRef
 
obc
,

868 
ûph_tid_t
 
»p_tid
);

869 
	gboo¡
::
šŒusive_±r
<
R•G©h”
> 
Ãw_»pİ
(

870 
ev”siÚ_t
 
v”siÚ
,

871 
r
,

872 
ObcLockMªag”
 &&
mªag”
,

873 
OpReque¡Ref
 &&
İ
,

874 
boo¡
::
İtiÚ®
<
¡d
::
funùiÚ
<()> > &&
Ú_com¶‘e
);

875 
»move_»pİ
(
R•G©h”
 *
»pİ
);

877 
OpCÚ‹xtUPŒ
 
sim¶e_İc_ü—‹
(
ObjeùCÚ‹xtRef
 
obc
);

878 
sim¶e_İc_subm™
(
OpCÚ‹xtUPŒ
 
ùx
);

886 
subm™_log_’Œ›s
(

887 cÚ¡ 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> &
’Œ›s
,

888 
ObcLockMªag”
 &&
mªag”
,

889 
boo¡
::
İtiÚ®
<
¡d
::
funùiÚ
<()> > &&
Ú_com¶‘e
,

890 
OpReque¡Ref
 
İ
 = OpRequestRef(),

891 
r
 = 0);

892 
	sLogUpd©eCtx
 {

893 
	gboo¡
::
šŒusive_±r
<
R•G©h”
> 
»pİ
;

894 
	g£t
<
	gpg_sh¬d_t
> 
	gwa™šg_Ú
;

896 
ÿnûl_log_upd©es
();

897 
	gm­
<
	gûph_tid_t
, 
	gLogUpd©eCtx
> 
	glog_’Œy_upd©e_wa™šg_Ú
;

901 
H™S‘Ref
 
	gh™_£t
;

902 
utime_t
 
	gh™_£t_¡¬t_¡amp
;

905 
h™_£t_ş—r
();

906 
h™_£t_£tup
();

907 
h™_£t_ü—‹
();

908 
h™_£t_³rsi¡
();

909 
boŞ
 
h™_£t_­¶y_log
();

910 
h™_£t_Œim
(
OpCÚ‹xtUPŒ
 &
ùx
, 
max
);

911 
h™_£t_š_memÜy_Œim
(
ušt32_t
 
max_š_memÜy
);

912 
h™_£t_»move_®l
();

914 
hobjeù_t
 
g‘_h™_£t_cu¼’t_objeù
(
utime_t
 
¡amp
);

915 
hobjeù_t
 
g‘_h™_£t_¬chive_objeù
(
utime_t
 
¡¬t
,

916 
utime_t
 
’d
,

917 
boŞ
 
usšg_gmt
);

920 
	gboo¡
::
scİed_±r
<
T›rAg’tS‹
> 
ag’t_¡©e
;

922 
ag’t_£tup
();

923 
boŞ
 
	$ag’t_wÜk
(
max
è
ov”ride


925  
	`ag’t_wÜk
(
max
, max);

926 
	}
}

927 
boŞ
 
	$ag’t_wÜk
(
max
, 
ag’t_æush_quÙa
è
ov”ride
;

928 
boŞ
 
	`ag’t_maybe_æush
(
ObjeùCÚ‹xtRef
& 
obc
);

929 
boŞ
 
	`ag’t_maybe_eviù
(
ObjeùCÚ‹xtRef
& 
obc
, boŞ 
aá”_æush
);

931 
	`ag’t_lßd_h™_£ts
();

937 
	`ag’t_e¡im©e_‹mp
(cÚ¡ 
hobjeù_t
& 
oid
, *
‹m³¿tu»
);

940 
	$ag’t_¡İ
(è
ov”ride
;

941 
	$ag’t_d–ay
(è
ov”ride
;

944 
	$ag’t_ş—r
(è
ov”ride
;

947 
boŞ
 
	`ag’t_choo£_mode
(boŞ 
»¡¬t
 = 
çl£
, 
OpReque¡Ref
 
İ
 = 
	`OpReque¡Ref
());

948 
	$ag’t_choo£_mode_»¡¬t
(è
ov”ride
;

951 
boŞ
 
	`®»ady_com¶‘e
(
ev”siÚ_t
 
v
);

953 
boŞ
 
	`®»ady_ack
(
ev”siÚ_t
 
v
);

956 
Sh¬edLRU
<
hobjeù_t
, 
ObjeùCÚ‹xt
> 
objeù_cÚ‹xts
;

958 
m­
<
hobjeù_t
, 
SÇpS‘CÚ‹xt
*> 
¢­£t_cÚ‹xts
;

959 
Mu‹x
 
¢­£t_cÚ‹xts_lock
;

962 
m­
<
hobjeù_t
, m­<
ş›Á_t
, 
ûph_tid_t
>> 
debug_İ_Üd”
;

964 
	`pİuÏ‹_obc_w©ch”s
(
ObjeùCÚ‹xtRef
 
obc
);

965 
	`check_bÏckli¡ed_obc_w©ch”s
(
ObjeùCÚ‹xtRef
 
obc
);

966 
	$check_bÏckli¡ed_w©ch”s
(è
ov”ride
;

967 
	`g‘_w©ch”s
(
li¡
<
obj_w©ch_™em_t
> *
ls
è
ov”ride
;

968 
	`g‘_obc_w©ch”s
(
ObjeùCÚ‹xtRef
 
obc
, 
li¡
<
obj_w©ch_™em_t
> &
pg_w©ch”s
);

969 
public
:

970 
	`hªdË_w©ch_timeout
(
W©chRef
 
w©ch
);

971 
´Ùeùed
:

973 
ObjeùCÚ‹xtRef
 
	`ü—‹_objeù_cÚ‹xt
(cÚ¡ 
objeù_šfo_t
& 
oi
, 
SÇpS‘CÚ‹xt
 *
ssc
);

974 
ObjeùCÚ‹xtRef
 
	`g‘_objeù_cÚ‹xt
(

975 cÚ¡ 
hobjeù_t
& 
soid
,

976 
boŞ
 
ÿn_ü—‹
,

977 cÚ¡ 
m­
<
¡ršg
, 
bufã¾i¡
> *
©Œs
 = 0

980 
	`cÚ‹xt_»gi¡ry_Ú_chªge
();

981 
	`objeù_cÚ‹xt_de¡ruùÜ_ÿÎback
(
ObjeùCÚ‹xt
 *
obc
);

982 
şass
 
C_PG_ObjeùCÚ‹xt
;

984 
	`fšd_objeù_cÚ‹xt
(cÚ¡ 
hobjeù_t
& 
oid
,

985 
ObjeùCÚ‹xtRef
 *
pobc
,

986 
boŞ
 
ÿn_ü—‹
,

987 
boŞ
 
m­_¢­id_to_şÚe
=
çl£
,

988 
hobjeù_t
 *
missšg_oid
=
NULL
);

990 
	`add_objeù_cÚ‹xt_to_pg_¡©
(
ObjeùCÚ‹xtRef
 
obc
, 
pg_¡©_t
 *
¡©
);

992 
	`g‘_¤c_Şoc
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
, objeù_loÿtÜ_t& 
¤c_Şoc
);

994 
SÇpS‘CÚ‹xt
 *
	`g‘_¢­£t_cÚ‹xt
(

995 cÚ¡ 
hobjeù_t
& 
oid
,

996 
boŞ
 
ÿn_ü—‹
,

997 cÚ¡ 
m­
<
¡ršg
, 
bufã¾i¡
> *
©Œs
 = 0,

998 
boŞ
 
oid_exi¡ed
 = 
Œue


1000 
	$»gi¡”_¢­£t_cÚ‹xt
(
SÇpS‘CÚ‹xt
 *
ssc
) {

1001 
Mu‹x
::
Lock”
 
	`l
(
¢­£t_cÚ‹xts_lock
);

1002 
	`_»gi¡”_¢­£t_cÚ‹xt
(
ssc
);

1003 
	}
}

1004 
	$_»gi¡”_¢­£t_cÚ‹xt
(
SÇpS‘CÚ‹xt
 *
ssc
) {

1005 
	`as£¹
(
¢­£t_cÚ‹xts_lock
.
	`is_locked
());

1006 ià(!
ssc
->
»gi¡”ed
) {

1007 
	`as£¹
(
¢­£t_cÚ‹xts
.
	`couÁ
(
ssc
->
oid
) == 0);

1008 
ssc
->
»gi¡”ed
 = 
Œue
;

1009 
¢­£t_cÚ‹xts
[
ssc
->
oid
] = ssc;

1011 
	}
}

1012 
put_¢­£t_cÚ‹xt
(
SÇpS‘CÚ‹xt
 *
ssc
);

1014 
	gm­
<
	ghobjeù_t
, 
	gObjeùCÚ‹xtRef
> 
	g»cov”šg
;

1030 
	g£t
<
	ghobjeù_t
> 
	gbackfls_š_æight
;

1031 
	gm­
<
	ghobjeù_t
, 
	gpg_¡©_t
> 
	g³ndšg_backfl_upd©es
;

1033 
	$dump_»cov”y_šfo
(
FÜm©‹r
 *
f
ècÚ¡ 
ov”ride
 {

1034 
f
->
	`İ’_¬¿y_£ùiÚ
("backfill_targets");

1035 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
p
 = 
backfl_rg‘s
.
	`begš
();

1036 
p
 !ğ
backfl_rg‘s
.
	`’d
(); ++p)

1037 
f
->
	`dump_¡»am
("»¶iÿ"è<< *
p
;

1038 
f
->
	`şo£_£ùiÚ
();

1039 
f
->
	`İ’_¬¿y_£ùiÚ
("waiting_on_backfill");

1040 
£t
<
pg_sh¬d_t
>::
cÚ¡_™”©Ü
 
p
 = 
wa™šg_Ú_backfl
.
	`begš
();

1041 
p
 !ğ
wa™šg_Ú_backfl
.
	`’d
(); ++p)

1042 
f
->
	`dump_¡»am
("osd"è<< *
p
;

1043 
f
->
	`şo£_£ùiÚ
();

1044 
f
->
	`dump_¡»am
("Ï¡_backfl_¡¬‹d"è<< 
Ï¡_backfl_¡¬‹d
;

1046 
f
->
	`İ’_objeù_£ùiÚ
("backfill_info");

1047 
backfl_šfo
.
	`dump
(
f
);

1048 
f
->
	`şo£_£ùiÚ
();

1051 
f
->
	`İ’_¬¿y_£ùiÚ
("peer_backfill_info");

1052 
m­
<
pg_sh¬d_t
, 
BackflIÁ”v®
>::
cÚ¡_™”©Ü
 
pbi
 =

1053 
³”_backfl_šfo
.
	`begš
();

1054 
pbi
 !ğ
³”_backfl_šfo
.
	`’d
(); ++pbi) {

1055 
f
->
	`dump_¡»am
("osd"è<< 
pbi
->
fœ¡
;

1056 
f
->
	`İ’_objeù_£ùiÚ
("BackfillInterval");

1057 
pbi
->
£cÚd
.
	`dump
(
f
);

1058 
f
->
	`şo£_£ùiÚ
();

1060 
f
->
	`şo£_£ùiÚ
();

1063 
f
->
	`İ’_¬¿y_£ùiÚ
("backfills_in_flight");

1064 
£t
<
hobjeù_t
>::
cÚ¡_™”©Ü
 
i
 = 
backfls_š_æight
.
	`begš
();

1065 
i
 !ğ
backfls_š_æight
.
	`’d
();

1066 ++
i
) {

1067 
f
->
	`dump_¡»am
("objeù"è<< *
i
;

1069 
f
->
	`şo£_£ùiÚ
();

1072 
f
->
	`İ’_¬¿y_£ùiÚ
("recovering");

1073 
m­
<
hobjeù_t
, 
ObjeùCÚ‹xtRef
>::
cÚ¡_™”©Ü
 
i
 = 
»cov”šg
.
	`begš
();

1074 
i
 !ğ
»cov”šg
.
	`’d
();

1075 ++
i
) {

1076 
f
->
	`dump_¡»am
("objeù"è<< 
i
->
fœ¡
;

1078 
f
->
	`şo£_£ùiÚ
();

1081 
f
->
	`İ’_objeù_£ùiÚ
("pg_backend");

1082 
pgback’d
->
	`dump_»cov”y_šfo
(
f
);

1083 
f
->
	`şo£_£ùiÚ
();

1085 
	}
}

1088 
hobjeù_t
 
	gÏ¡_backfl_¡¬‹d
;

1089 
boŞ
 
	gÃw_backfl
;

1091 
´•_objeù_»¶iÿ_pushes
(cÚ¡ 
hobjeù_t
& 
soid
, 
ev”siÚ_t
 
v
,

1092 
PGBack’d
::
Recov”yHªdË
 *
h
,

1093 
boŞ
 *
wÜk_¡¬‹d
);

1094 
´•_objeù_»¶iÿ_d–‘es
(cÚ¡ 
hobjeù_t
& 
soid
, 
ev”siÚ_t
 
v
,

1095 
PGBack’d
::
Recov”yHªdË
 *
h
,

1096 
boŞ
 *
wÜk_¡¬‹d
);

1098 
	$fšish_deg¿ded_objeù
(cÚ¡ 
hobjeù_t
& 
oid
è
ov”ride
;

1101 
	$check_»cov”y_sourûs
(cÚ¡ 
OSDM­Ref
& 
m­
è
ov”ride
 ;

1103 
	`»cov”_missšg
(

1104 cÚ¡ 
hobjeù_t
& 
oid
,

1105 
ev”siÚ_t
 
v
,

1106 
´iÜ™y
,

1107 
PGBack’d
::
Recov”yHªdË
 *
h
);

1111 
	`_make_şÚe
(

1112 
OpCÚ‹xt
 *
ùx
,

1113 
PGT¿n§ùiÚ
* 
t
,

1114 
ObjeùCÚ‹xtRef
 
obc
,

1115 cÚ¡ 
hobjeù_t
& 
h—d
, cÚ¡ hobjeù_t& 
coid
,

1116 
objeù_šfo_t
 *
poi
);

1117 
	`execu‹_ùx
(
OpCÚ‹xt
 *
ùx
);

1118 
	`fšish_ùx
(
OpCÚ‹xt
 *
ùx
, 
log_İ_ty³
);

1119 
	`»¶y_ùx
(
OpCÚ‹xt
 *
ùx
, 
”r
);

1120 
	`»¶y_ùx
(
OpCÚ‹xt
 *
ùx
, 
”r
, 
ev”siÚ_t
 
v
, 
v”siÚ_t
 
uv
);

1121 
	`make_wr™—bË
(
OpCÚ‹xt
 *
ùx
);

1122 
	`log_İ_¡©s
(
OpCÚ‹xt
 *
ùx
);

1124 
	`wr™e_upd©e_size_ªd_u§ge
(
objeù_¡©_sum_t
& 
¡©s
, 
objeù_šfo_t
& 
oi
,

1125 
š‹rv®_£t
<
ušt64_t
>& 
modif›d
, ušt64_ˆ
off£t
,

1126 
ušt64_t
 
Ëngth
, 
boŞ
 
wr™e_fuÎ
=
çl£
);

1127 
šlše
 
	`Œunÿ‹_upd©e_size_ªd_u§ge
(

1128 
objeù_¡©_sum_t
& 
d–_¡©s
,

1129 
objeù_šfo_t
& 
oi
,

1130 
ušt64_t
 
Œunÿ‹_size
);

1132 şas 
	cÿche_»suÉ_t
 {

1133 
NOOP
,

1134 
BLOCKED_FULL
,

1135 
BLOCKED_PROMOTE
,

1136 
HANDLED_PROXY
,

1137 
HANDLED_REDIRECT
,

1138 
REPLIED_WITH_EAGAIN
,

1139 
BLOCKED_RECOVERY
,

1140 
	}
};

1141 
ÿche_»suÉ_t
 
maybe_hªdË_ÿche_d‘a
(
OpReque¡Ref
 
İ
,

1142 
boŞ
 
wr™e_Üd”ed
,

1143 
ObjeùCÚ‹xtRef
 
obc
, 
r
,

1144 
hobjeù_t
 
missšg_oid
,

1145 
boŞ
 
mu¡_´omÙe
,

1146 
boŞ
 
š_h™_£t
,

1147 
ObjeùCÚ‹xtRef
 *
´omÙe_obc
);

1148 
ÿche_»suÉ_t
 
maybe_hªdË_mªiã¡_d‘a
(
OpReque¡Ref
 
İ
,

1149 
boŞ
 
wr™e_Üd”ed
,

1150 
ObjeùCÚ‹xtRef
 
obc
);

1151 
boŞ
 
	$maybe_hªdË_mªiã¡
(
OpReque¡Ref
 
İ
,

1152 
boŞ
 
wr™e_Üd”ed
,

1153 
ObjeùCÚ‹xtRef
 
obc
) {

1154  
ÿche_»suÉ_t
::
NOOP
 !ğ
	`maybe_hªdË_mªiã¡_d‘a
(

1155 
İ
,

1156 
wr™e_Üd”ed
,

1157 
obc
);

1158 
	}
}

1164 
boŞ
 
	$maybe_hªdË_ÿche
(
OpReque¡Ref
 
İ
,

1165 
boŞ
 
wr™e_Üd”ed
,

1166 
ObjeùCÚ‹xtRef
 
obc
, 
r
,

1167 cÚ¡ 
hobjeù_t
& 
missšg_oid
,

1168 
boŞ
 
mu¡_´omÙe
,

1169 
boŞ
 
š_h™_£t
 = 
çl£
) {

1170  
ÿche_»suÉ_t
::
NOOP
 !ğ
	`maybe_hªdË_ÿche_d‘a
(

1171 
İ
,

1172 
wr™e_Üd”ed
,

1173 
obc
,

1174 
r
,

1175 
missšg_oid
,

1176 
mu¡_´omÙe
,

1177 
š_h™_£t
,

1178 
nuÎ±r
);

1179 
	}
}

1184 
boŞ
 
maybe_´omÙe
(
ObjeùCÚ‹xtRef
 
obc
,

1185 cÚ¡ 
hobjeù_t
& 
missšg_oid
,

1186 cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

1187 
boŞ
 
š_h™_£t
,

1188 
ušt32_t
 
»ûncy
,

1189 
OpReque¡Ref
 
´omÙe_İ
,

1190 
ObjeùCÚ‹xtRef
 *
´omÙe_obc
 = 
nuÎ±r
);

1194 
do_ÿche_»dœeù
(
OpReque¡Ref
 
İ
);

1201 
´omÙe_objeù
(

1202 
ObjeùCÚ‹xtRef
 
obc
,

1203 cÚ¡ 
hobjeù_t
& 
missšg_objeù
,

1204 cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

1205 
OpReque¡Ref
 
İ
,

1206 
ObjeùCÚ‹xtRef
 *
´omÙe_obc
 = 
nuÎ±r


1209 
´•¬e_Œª§ùiÚ
(
OpCÚ‹xt
 *
ùx
);

1210 
	gli¡
<
	g·œ
<
	gOpReque¡Ref
, 
	gOpCÚ‹xt
*> > 
	gš_´og»ss_async_»ads
;

1211 
com¶‘e_»ad_ùx
(
»suÉ
, 
OpCÚ‹xt
 *
ùx
);

1214 
	$check_loÿl
(è
ov”ride
;

1216 
	$_ş—r_»cov”y_¡©e
(è
ov”ride
;

1218 
boŞ
 
	$¡¬t_»cov”y_İs
(

1219 
ušt64_t
 
max
,

1220 
Th»adPoŞ
::
TPHªdË
 &
hªdË
, 
ušt64_t
 *
¡¬‹d
è
ov”ride
;

1222 
ušt64_t
 
	`»cov”_´im¬y
(ušt64_ˆ
max
, 
Th»adPoŞ
::
TPHªdË
 &
hªdË
);

1223 
ušt64_t
 
	`»cov”_»¶iÿs
(ušt64_ˆ
max
, 
Th»adPoŞ
::
TPHªdË
 &
hªdË
,

1224 
boŞ
 *
»cov”y_¡¬‹d
);

1225 
hobjeù_t
 
	$—¾›¡_³”_backfl
() const;

1226 
boŞ
 
	$®l_³”_dÚe
() const;

1231 
ušt64_t
 
	`»cov”_backfl
(ušt64_ˆ
max
, 
Th»adPoŞ
::
TPHªdË
 &
hªdË
,

1232 
boŞ
 *
wÜk_¡¬‹d
);

1242 
	`sÿn_¿nge
(

1243 
mš
, 
max
, 
BackflIÁ”v®
 *
bi
,

1244 
Th»adPoŞ
::
TPHªdË
 &
hªdË


1248 
	`upd©e_¿nge
(

1249 
BackflIÁ”v®
 *
bi
,

1250 
Th»adPoŞ
::
TPHªdË
 &
hªdË


1253 
	`´•_backfl_objeù_push
(

1254 
hobjeù_t
 
oid
, 
ev”siÚ_t
 
v
, 
ObjeùCÚ‹xtRef
 
obc
,

1255 
veùÜ
<
pg_sh¬d_t
> 
³”s
,

1256 
PGBack’d
::
Recov”yHªdË
 *
h
);

1257 
	`£nd_»move_İ
(cÚ¡ 
hobjeù_t
& 
oid
, 
ev”siÚ_t
 
v
, 
pg_sh¬d_t
 
³”
);

1260 
şass
 
C_OSD_Aµl›dRecov”edObjeù
;

1261 
şass
 
C_OSD_Comm™‹dPushedObjeù
;

1262 
şass
 
C_OSD_Aµl›dRecov”edObjeùR•liÿ
;

1264 
	`_­¶›d_»cov”ed_objeù
(
ObjeùCÚ‹xtRef
 
obc
);

1265 
	`_­¶›d_»cov”ed_objeù_»¶iÿ
();

1266 
	`_comm™‹d_pushed_objeù
(
•och_t
 
•och
, 
ev”siÚ_t
 
lc
);

1267 
	`»cov”_gÙ
(
hobjeù_t
 
oid
, 
ev”siÚ_t
 
v
);

1270 
m­
<
hobjeù_t
, 
CİyOpRef
> 
cİy_İs
;

1272 
	`do_cİy_g‘
(
OpCÚ‹xt
 *
ùx
, 
bufã¾i¡
::
™”©Ü
& 
bp
, 
OSDOp
& 
İ
,

1273 
ObjeùCÚ‹xtRef
& 
obc
);

1274 
	`fšish_cİy_g‘
();

1276 
	`fl_š_cİy_g‘_nÛÁ
(
OpReque¡Ref
& 
İ
, 
hobjeù_t
 
oid
,

1277 
OSDOp
& 
osd_İ
);

1288 
	`¡¬t_cİy
(
CİyC®lback
 *
cb
, 
ObjeùCÚ‹xtRef
 
obc
, 
hobjeù_t
 
¤c
,

1289 
objeù_loÿtÜ_t
 
Şoc
, 
v”siÚ_t
 
v”siÚ
, 
æags
,

1290 
boŞ
 
mœrÜ_¢­£t
, 
¤c_obj_çdvi£_æags
,

1291 
de¡_obj_çdvi£_æags
);

1292 
	`´oûss_cİy_chunk
(
hobjeù_t
 
oid
, 
ûph_tid_t
 
tid
, 
r
);

1293 
	`_wr™e_cİy_chunk
(
CİyOpRef
 
cİ
, 
PGT¿n§ùiÚ
 *
t
);

1294 
ušt64_t
 
	$g‘_cİy_chunk_size
() const {

1295 
ušt64_t
 
size
 = 
cù
->
_cÚf
->
osd_cİyäom_max_chunk
;

1296 ià(
poŞ
.
šfo
.
	`»quœes_®igÃd_­³nd
()) {

1297 
ušt64_t
 
®ignm’t
 = 
poŞ
.
šfo
.
	`»quœed_®ignm’t
();

1298 ià(
size
 % 
®ignm’t
) {

1299 
size
 +ğ
®ignm’t
 - (size %‡lignment);

1302  
size
;

1303 
	}
}

1304 
_cİy_some
(
ObjeùCÚ‹xtRef
 
obc
, 
CİyOpRef
 
cİ
);

1305 
fšish_cİyäom
(
CİyFromC®lback
 *
cb
);

1306 
fšish_´omÙe
(
r
, 
CİyResuÉs
 *
»suÉs
, 
ObjeùCÚ‹xtRef
 
obc
);

1307 
ÿnûl_cİy
(
CİyOpRef
 
cİ
, 
boŞ
 
»queue
, 
veùÜ
<
ûph_tid_t
> *
tids
);

1308 
ÿnûl_cİy_İs
(
boŞ
 
»queue
, 
veùÜ
<
ûph_tid_t
> *
tids
);

1310 
ä›nd
 
	gC_Cİyäom
;

1313 
	gm­
<
	ghobjeù_t
, 
	gFlushOpRef
> 
	gæush_İs
;

1316 
¡¬t_æush
(

1317 
OpReque¡Ref
 
İ
, 
ObjeùCÚ‹xtRef
 
obc
,

1318 
boŞ
 
blockšg
, 
hobjeù_t
 *
pmissšg
,

1319 
boo¡
::
İtiÚ®
<
¡d
::
funùiÚ
<()>> &&
Ú_æush
);

1320 
fšish_æush
(
hobjeù_t
 
oid
, 
ûph_tid_t
 
tid
, 
r
);

1321 
Œy_æush_m¬k_ş—n
(
FlushOpRef
 
fİ
);

1322 
ÿnûl_æush
(
FlushOpRef
 
fİ
, 
boŞ
 
»queue
, 
veùÜ
<
ûph_tid_t
> *
tids
);

1323 
ÿnûl_æush_İs
(
boŞ
 
»queue
, 
veùÜ
<
ûph_tid_t
> *
tids
);

1326 
boŞ
 
is_´e£Á_şÚe
(
hobjeù_t
 
coid
);

1328 
ä›nd
 
	gC_Flush
;

1331 
boŞ
 
	$_¿nge_avaabË_fÜ_süub
(

1332 cÚ¡ 
hobjeù_t
 &
begš
, cÚ¡ hobjeù_ˆ&
’d
è
ov”ride
;

1333 
	`süub_¢­shÙ_m‘ad©a
(

1334 
SüubM­
 &
m­
,

1335 cÚ¡ 
¡d
::
m­
<
hobjeù_t
,

1336 
·œ
<
boo¡
::
İtiÚ®
<
ušt32_t
>,

1337 
boo¡
::
İtiÚ®
<
ušt32_t
>>> &
missšg_dige¡
è
ov”ride
;

1338 
	$_süub_ş—r_¡©e
(è
ov”ride
;

1339 
	$_süub_fšish
(è
ov”ride
;

1340 
objeù_¡©_cŞËùiÚ_t
 
süub_c¡©
;

1342 
	$_¥l™_što
(
pg_t
 
chd_pgid
, 
PG
 *
chd
,

1343 
¥l™_b™s
è
ov”ride
;

1344 
	`­¶y_ªd_æush_»pİs
(
boŞ
 
»queue
);

1346 
	$ÿlc_Œim_to
(è
ov”ride
;

1347 
	`do_x©Œ_cmp_u64
(
İ
, 
__u64
 
v1
, 
bufã¾i¡
& 
x©Œ
);

1348 
	`do_x©Œ_cmp_¡r
(
İ
, 
¡ršg
& 
v1s
, 
bufã¾i¡
& 
x©Œ
);

1351 
	`do_checksum
(
OpCÚ‹xt
 *
ùx
, 
OSDOp
& 
osd_İ
, 
bufã¾i¡
::
™”©Ü
 *
bl_™
);

1352 
	`fšish_checksum
(
OSDOp
& 
osd_İ
, 
Checksumm”
::
CSumTy³
 
csum_ty³
,

1353 
bufã¾i¡
::
™”©Ü
 *
š™_v®ue_bl_™
,

1354 cÚ¡ 
bufã¾i¡
 &
»ad_bl
);

1356 
ä›nd
 
şass
 
C_ChecksumR—d
;

1358 
	`do_ex‹Á_cmp
(
OpCÚ‹xt
 *
ùx
, 
OSDOp
& 
osd_İ
);

1359 
	`fšish_ex‹Á_cmp
(
OSDOp
& 
osd_İ
, cÚ¡ 
bufã¾i¡
 &
»ad_bl
);

1361 
ä›nd
 
şass
 
C_Ex‹ÁCmpR—d
;

1363 
	`do_»ad
(
OpCÚ‹xt
 *
ùx
, 
OSDOp
& 
osd_İ
);

1364 
	`do_¥¬£_»ad
(
OpCÚ‹xt
 *
ùx
, 
OSDOp
& 
osd_İ
);

1365 
	`do_wr™e§me
(
OpCÚ‹xt
 *
ùx
, 
OSDOp
& 
osd_İ
);

1367 
boŞ
 
	`pgls_f‹r
(
PGLSF‹r
 *
f‹r
, 
hobjeù_t
& 
sobj
, 
bufã¾i¡
& 
outd©a
);

1368 
	`g‘_pgls_f‹r
(
bufã¾i¡
::
™”©Ü
& 
™”
, 
PGLSF‹r
 **
pf‹r
);

1370 
m­
<
hobjeù_t
, 
li¡
<
OpReque¡Ref
>> 
š_´og»ss_´oxy_İs
;

1371 
	`kick_´oxy_İs_blocked
(
hobjeù_t
& 
soid
);

1372 
	`ÿnûl_´oxy_İs
(
boŞ
 
»queue
, 
veùÜ
<
ûph_tid_t
> *
tids
);

1375 
m­
<
ûph_tid_t
, 
ProxyR—dOpRef
> 
´oxy»ad_İs
;

1377 
	`do_´oxy_»ad
(
OpReque¡Ref
 
İ
, 
ObjeùCÚ‹xtRef
 
obc
 = 
NULL
);

1378 
	`fšish_´oxy_»ad
(
hobjeù_t
 
oid
, 
ûph_tid_t
 
tid
, 
r
);

1379 
	`ÿnûl_´oxy_»ad
(
ProxyR—dOpRef
 
´dİ
, 
veùÜ
<
ûph_tid_t
> *
tids
);

1381 
ä›nd
 
C_ProxyR—d
;

1384 
m­
<
ûph_tid_t
, 
ProxyWr™eOpRef
> 
´oxywr™e_İs
;

1386 
	`do_´oxy_wr™e
(
OpReque¡Ref
 
İ
, 
ObjeùCÚ‹xtRef
 
obc
 = 
NULL
);

1387 
	`fšish_´oxy_wr™e
(
hobjeù_t
 
oid
, 
ûph_tid_t
 
tid
, 
r
);

1388 
	`ÿnûl_´oxy_wr™e
(
ProxyWr™eOpRef
 
pwİ
, 
veùÜ
<
ûph_tid_t
> *
tids
);

1390 
ä›nd
 
C_ProxyWr™e_Comm™
;

1393 
	`do_´oxy_chunked_İ
(
OpReque¡Ref
 
İ
, cÚ¡ 
hobjeù_t
& 
missšg_oid
,

1394 
ObjeùCÚ‹xtRef
 
obc
, 
boŞ
 
wr™e_Üd”ed
);

1395 
	`do_´oxy_chunked_»ad
(
OpReque¡Ref
 
İ
, 
ObjeùCÚ‹xtRef
 
obc
, 
İ_šdex
,

1396 
ušt64_t
 
chunk_šdex
, ušt64_ˆ
»q_off£t
, ušt64_ˆ
»q_Ëngth
,

1397 
ušt64_t
 
»q_tÙ®_Ën
, 
boŞ
 
wr™e_Üd”ed
);

1398 
boŞ
 
	`ÿn_´oxy_chunked_»ad
(
OpReque¡Ref
 
İ
, 
ObjeùCÚ‹xtRef
 
obc
);

1399 
	`_cİy_some_mªiã¡
(
ObjeùCÚ‹xtRef
 
obc
, 
CİyOpRef
 
cİ
, 
ušt64_t
 
¡¬t_off£t
);

1400 
	`´oûss_cİy_chunk_mªiã¡
(
hobjeù_t
 
oid
, 
ûph_tid_t
 
tid
, 
r
, 
ušt64_t
 
off£t
);

1401 
	`fšish_´omÙe_mªiã¡
(
r
, 
CİyResuÉs
 *
»suÉs
, 
ObjeùCÚ‹xtRef
 
obc
);

1402 
	`ÿnûl_ªd_»queue_´oxy_İs
(
hobjeù_t
 
oid
);

1403 
	`do_mªiã¡_æush
(
OpReque¡Ref
 
İ
, 
ObjeùCÚ‹xtRef
 
obc
, 
FlushOpRef
 
mªiã¡_fİ
,

1404 
ušt64_t
 
¡¬t_off£t
, 
boŞ
 
block
);

1405 
	`¡¬t_mªiã¡_æush
(
OpReque¡Ref
 
İ
, 
ObjeùCÚ‹xtRef
 
obc
, 
boŞ
 
blockšg
,

1406 
boo¡
::
İtiÚ®
<
¡d
::
funùiÚ
<()>> &&
Ú_æush
);

1407 
	`fšish_mªiã¡_æush
(
hobjeù_t
 
oid
, 
ûph_tid_t
 
tid
, 
r
, 
ObjeùCÚ‹xtRef
 
obc
,

1408 
ušt64_t
 
Ï¡_off£t
);

1409 
	`hªdË_mªiã¡_æush
(
hobjeù_t
 
oid
, 
ûph_tid_t
 
tid
, 
r
,

1410 
ušt64_t
 
off£t
, ušt64_ˆ
Ï¡_off£t
);

1411 
	`»fcouÁ_mªiã¡
(
ObjeùCÚ‹xtRef
 
obc
, 
objeù_loÿtÜ_t
 
Şoc
, 
hobjeù_t
 
soid
,

1412 
SÇpCÚ‹xt
 
¢­c
, 
boŞ
 
g‘
, 
CÚ‹xt
 *
cb
, 
ušt64_t
 
off£t
);

1414 
ä›nd
 
C_ProxyChunkR—d
;

1415 
ä›nd
 
şass
 
PromÙeMªiã¡C®lback
;

1416 
ä›nd
 
şass
 
C_CİyChunk
;

1417 
ä›nd
 
C_Mªiã¡Flush
;

1418 
ä›nd
 
RefCouÁC®lback
;

1420 
public
:

1421 
	`Prim¬yLogPG
(
OSDS”viû
 *
o
, 
OSDM­Ref
 
curm­
,

1422 cÚ¡ 
PGPoŞ
 &
_poŞ
,

1423 cÚ¡ 
m­
<
¡ršg
,¡ršg>& 
ec_´ofe
,

1424 
¥g_t
 
p
);

1425 ~
	$Prim¬yLogPG
(è
ov”ride
 {
	}
}

1427 
	$do_commªd
(

1428 
cmdm­_t
 
cmdm­
,

1429 
o¡»am
& 
ss
,

1430 
bufã¾i¡
& 
id©a
,

1431 
bufã¾i¡
& 
od©a
,

1432 
CÚÃùiÚRef
 
cÚn
,

1433 
ûph_tid_t
 
tid
è
ov”ride
;

1435 
	$do_»que¡
(

1436 
OpReque¡Ref
& 
İ
,

1437 
Th»adPoŞ
::
TPHªdË
 &
hªdË
è
ov”ride
;

1438 
	`do_İ
(
OpReque¡Ref
& 
İ
);

1439 
	`»cÜd_wr™e_”rÜ
(
OpReque¡Ref
 
İ
, cÚ¡ 
hobjeù_t
 &
soid
,

1440 
MOSDOpR•ly
 *
Üig_»¶y
, 
r
);

1441 
	`do_pg_İ
(
OpReque¡Ref
 
İ
);

1442 
	`do_sÿn
(

1443 
OpReque¡Ref
 
İ
,

1444 
Th»adPoŞ
::
TPHªdË
 &
hªdË
);

1445 
	`do_backfl
(
OpReque¡Ref
 
İ
);

1446 
	`do_backfl_»move
(
OpReque¡Ref
 
İ
);

1448 
	`hªdË_backoff
(
OpReque¡Ref
& 
İ
);

1450 
	`Œim_objeù
(
boŞ
 
fœ¡
, cÚ¡ 
hobjeù_t
 &
coid
, 
OpCÚ‹xtUPŒ
 *
ùxp
);

1451 
	$¢­_Œimm”
(
•och_t
 
e
è
ov”ride
;

1452 
	$kick_¢­_Œim
(è
ov”ride
;

1453 
	$¢­_Œimm”_süub_com¶‘e
(è
ov”ride
;

1454 
	`do_osd_İs
(
OpCÚ‹xt
 *
ùx
, 
veùÜ
<
OSDOp
>& 
İs
);

1456 
	`_g‘_tm­
(
OpCÚ‹xt
 *
ùx
, 
bufã¾i¡
 *
h—d”
, bufã¾i¡ *
v®s
);

1457 
	`do_tm­2om­
(
OpCÚ‹xt
 *
ùx
, 
æags
);

1458 
	`do_tm­up
(
OpCÚ‹xt
 *
ùx
, 
bufã¾i¡
::
™”©Ü
& 
bp
, 
OSDOp
& 
osd_İ
);

1459 
	`do_tm­up_¦ow
(
OpCÚ‹xt
 *
ùx
, 
bufã¾i¡
::
™”©Ü
& 
bp
, 
OSDOp
& 
osd_İ
, bufã¾i¡& 
bl
);

1461 
	`do_osd_İ_efãùs
(
OpCÚ‹xt
 *
ùx
, cÚ¡ 
CÚÃùiÚRef
& 
cÚn
);

1462 
´iv©e
:

1463 
	`do_süub_ls
(
MOSDOp
 *
İ
, 
OSDOp
 *
osd_İ
);

1464 
hobjeù_t
 
	$—¾›¡_backfl
() const;

1465 
boŞ
 
	$check_¤c_rg
(cÚ¡ 
hobjeù_t
& 
soid
, cÚ¡ hobjeù_t& 
toid
) const;

1467 
ušt64_t
 
‹mp_£q
;

1469 
hobjeù_t
 
	`g’”©e_‹mp_objeù
(cÚ¡ hobjeù_t& 
rg‘
);

1471 
hobjeù_t
 
	$g‘_‹mp_»cov”y_objeù
(cÚ¡ 
hobjeù_t
& 
rg‘
,

1472 
ev”siÚ_t
 
v”siÚ
è
ov”ride
;

1473 
	$g‘_»cov”y_İ_´iÜ™y
() const {

1474 
´i
 = 0;

1475 
poŞ
.
šfo
.
İts
.
	`g‘
(
poŞ_İts_t
::
RECOVERY_OP_PRIORITY
, &
´i
);

1476  
´i
 > 0 ?…r˜: 
cù
->
_cÚf
->
osd_»cov”y_İ_´iÜ™y
;

1477 
	}
}

1478 
log_missšg
(
missšg
,

1479 cÚ¡ 
boo¡
::
İtiÚ®
<
hobjeù_t
> &
h—d
,

1480 
LogChªÃlRef
 
şog
,

1481 cÚ¡ 
¥g_t
 &
pgid
,

1482 cÚ¡ *
func
,

1483 cÚ¡ *
mode
,

1484 
boŞ
 
®low_šcom¶‘e_şÚes
);

1485 
´oûss_şÚes_to
(cÚ¡ 
boo¡
::
İtiÚ®
<
hobjeù_t
> &
h—d
,

1486 cÚ¡ 
boo¡
::
İtiÚ®
<
SÇpS‘
> &
¢­£t
,

1487 
LogChªÃlRef
 
şog
,

1488 cÚ¡ 
¥g_t
 &
pgid
,

1489 cÚ¡ *
mode
,

1490 
boŞ
 
®low_šcom¶‘e_şÚes
,

1491 
boo¡
::
İtiÚ®
<
¢­id_t
> 
rg‘
,

1492 
veùÜ
<
¢­id_t
>::
»v”£_™”©Ü
 *
curşÚe
,

1493 
šcÚsi¡’t_¢­£t_w¿µ”
 &
¢­_”rÜ
);

1495 
	gpublic
:

1496 
cŞl_t
 
	$g‘_cŞl
() {

1497  
cŞl
;

1498 
	}
}

1499 
	$¥l™_cŞls
(

1500 
¥g_t
 
chd
,

1501 
¥l™_b™s
,

1502 
£ed
,

1503 cÚ¡ 
pg_poŞ_t
 *
poŞ
,

1504 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
è
ov”ride
 {

1505 
cŞl_t
 
rg‘
 = 
	`cŞl_t
(
chd
);

1506 
PG
::
	`_ü—‹
(*
t
, 
chd
, 
¥l™_b™s
);

1507 
t
->
	`¥l™_cŞËùiÚ
(

1508 
cŞl
,

1509 
¥l™_b™s
,

1510 
£ed
,

1511 
rg‘
);

1512 
PG
::
	`_š™
(*
t
, 
chd
, 
poŞ
);

1513 
	}
}

1514 
	g´iv©e
:

1516 
DoSÇpWÜk
 : 
boo¡
::
¡©ech¬t
::
ev’t
< DoSnapWork > {

1517 
DoSÇpWÜk
(è: 
boo¡
::
¡©ech¬t
::
ev’t
 < DoSnapWork >() {}

1519 
	gKickTrim
 : 
boo¡
::
¡©ech¬t
::
ev’t
< 
KickTrim
 > {

1520 
KickTrim
(è: 
boo¡
::
¡©ech¬t
::
ev’t
 < KickTrim >() {}

1522 
	gR•İsCom¶‘e
 : 
boo¡
::
¡©ech¬t
::
ev’t
< 
R•İsCom¶‘e
 > {

1523 
R•İsCom¶‘e
(è: 
boo¡
::
¡©ech¬t
::
ev’t
 < RepopsComplete >() {}

1525 
	gSüubCom¶‘e
 : 
boo¡
::
¡©ech¬t
::
ev’t
< 
SüubCom¶‘e
 > {

1526 
SüubCom¶‘e
(è: 
boo¡
::
¡©ech¬t
::
ev’t
 < ScrubComplete >() {}

1528 
	gTrimWr™eUnblocked
 : 
boo¡
::
¡©ech¬t
::
ev’t
< 
TrimWr™eUnblocked
 > {

1529 
TrimWr™eUnblocked
(è: 
boo¡
::
¡©ech¬t
::
ev’t
 < TrimWriteUnblocked >() {}

1531 
	gRe£t
 : 
boo¡
::
¡©ech¬t
::
ev’t
< 
Re£t
 > {

1532 
Re£t
(è: 
boo¡
::
¡©ech¬t
::
ev’t
< Reset >() {}

1534 
	gSÇpTrimRe£rved
 : 
boo¡
::
¡©ech¬t
::
ev’t
< 
SÇpTrimRe£rved
 > {

1535 
SÇpTrimRe£rved
(è: 
boo¡
::
¡©ech¬t
::
ev’t
< SnapTrimReserved >() {}

1537 
	gSÇpTrimTim”R—dy
 : 
boo¡
::
¡©ech¬t
::
ev’t
< 
SÇpTrimTim”R—dy
 > {

1538 
SÇpTrimTim”R—dy
(è: 
boo¡
::
¡©ech¬t
::
ev’t
< SnapTrimTimerReady >() {}

1541 
	gNÙTrimmšg
;

1542 
	gSÇpTrimm”
 : 
public
 
boo¡
::
¡©ech¬t
::
¡©e_machše
< 
SÇpTrimm”
, 
	gNÙTrimmšg
 > {

1543 
Prim¬yLogPG
 *
	gpg
;

1544 
ex¶ic™
 
SÇpTrimm”
(
Prim¬yLogPG
 *
pg
) :…g(pg) {}

1545 
log_’‹r
(cÚ¡ *
¡©e_Çme
);

1546 
log_ex™
(cÚ¡ *
¡©e_Çme
, 
utime_t
 
du¿tiÚ
);

1547 
boŞ
 
ÿn_Œim
() {

1549 
	gpg
->
is_ş—n
() &&

1550 !
	gpg
->
	gsüubb”
.
	gaùive
 &&

1551 !
	gpg
->
	g¢­_Œimq
.
em±y
() &&

1552 !
	gpg
->
g‘_osdm­
()->
‹¡_æag
(
CEPH_OSDMAP_NOSNAPTRIM
);

1554 } 
	g¢­_Œimm”_machše
;

1556 
	gWa™Re£rv©iÚ
;

1557 
	gTrimmšg
 : 
boo¡
::
¡©ech¬t
::
¡©e
< 
Trimmšg
, 
	gSÇpTrimm”
, 
	gWa™Re£rv©iÚ
 >, 
	gNamedS‹
 {

1558 
	gboo¡
::
	tm¶
::
	tli¡
 <

1559 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tKickTrim
 >,

1560 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tRe£t
, 
	tNÙTrimmšg
 >

1561 > 
	t»aùiÚs
;

1563 
	g£t
<
	ghobjeù_t
> 
	gš_æight
;

1564 
¢­id_t
 
	g¢­_to_Œim
;

1566 
ex¶ic™
 
Trimmšg
(
my_cÚ‹xt
 
ùx
)

1567 : 
my_ba£
(
ùx
),

1568 
NamedS‹
(
cÚ‹xt
< 
SÇpTrimm”
 >().
pg
, "Trimming") {

1569 
	gcÚ‹xt
< 
	gSÇpTrimm”
 >().
log_’‹r
(
¡©e_Çme
);

1570 
as£¹
(
cÚ‹xt
< 
SÇpTrimm”
 >().
ÿn_Œim
());

1571 
as£¹
(
š_æight
.
em±y
());

1573 
ex™
() {

1574 
	gcÚ‹xt
< 
	gSÇpTrimm”
 >().
log_ex™
(
¡©e_Çme
, 
’‹r_time
);

1575 autØ*
	gpg
 = 
cÚ‹xt
< 
SÇpTrimm”
 >().
pg
;

1576 
	gpg
->
	gosd
->
	g¢­_»£rv”
.
ÿnûl_»£rv©iÚ
(
pg
->
g‘_pgid
());

1577 
	gpg
->
¡©e_ş—r
(
PG_STATE_SNAPTRIM
);

1578 
	gpg
->
publish_¡©s_to_osd
();

1580 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
»aù
(cÚ¡ 
KickTrim
&) {

1581  
disÿrd_ev’t
();

1586 
	gWa™TrimTim”
 : 
boo¡
::
¡©ech¬t
::
¡©e
< 
Wa™TrimTim”
, 
	gTrimmšg
 >, 
	gNamedS‹
 {

1587 
	gboo¡
::
	tm¶
::
	tli¡
 <

1588 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tSÇpTrimTim”R—dy
 >

1589 > 
	t»aùiÚs
;

1590 
CÚ‹xt
 *
	gwakeup
 = 
nuÎ±r
;

1591 
ex¶ic™
 
Wa™TrimTim”
(
my_cÚ‹xt
 
ùx
)

1592 : 
my_ba£
(
ùx
),

1593 
NamedS‹
(
cÚ‹xt
< 
SÇpTrimm”
 >().
pg
, "Trimming/WaitTrimTimer") {

1594 
	gcÚ‹xt
< 
	gSÇpTrimm”
 >().
log_’‹r
(
¡©e_Çme
);

1595 
as£¹
(
cÚ‹xt
<
Trimmšg
>().
š_æight
.
em±y
());

1596 
	gOnTim”
 : 
CÚ‹xt
 {

1597 
Prim¬yLogPGRef
 
pg
;

1598 
•och_t
 
	g•och
;

1599 
OnTim”
(
Prim¬yLogPGRef
 
pg
, 
•och_t
 
•och
) :…g(pg),ƒpoch(epoch) {}

1600 
fšish
(è
	gov”ride
 {

1601 
	gpg
->
lock
();

1602 ià(!
	gpg
->
pg_has_»£t_sšû
(
•och
))

1603 
	gpg
->
	g¢­_Œimm”_machše
.
´oûss_ev’t
(
SÇpTrimTim”R—dy
());

1604 
	gpg
->
uÆock
();

1607 autØ*
	gpg
 = 
cÚ‹xt
< 
SÇpTrimm”
 >().
pg
;

1608 ià(
	gpg
->
	gcù
->
	g_cÚf
->
	gosd_¢­_Œim_¦“p
 > 0) {

1609 
	gMu‹x
::
Lock”
 
l
(
pg
->
osd
->
¢­_¦“p_lock
);

1610 
	gwakeup
 = 
pg
->
osd
->
¢­_¦“p_tim”
.
add_ev’t_aá”
(

1611 
pg
->
cù
->
_cÚf
->
osd_¢­_Œim_¦“p
,

1612 
Ãw
 
OnTim”
{
pg
,…g->
g‘_osdm­
()->
g‘_•och
()});

1614 
po¡_ev’t
(
SÇpTrimTim”R—dy
());

1617 
ex™
() {

1618 
	gcÚ‹xt
< 
	gSÇpTrimm”
 >().
log_ex™
(
¡©e_Çme
, 
’‹r_time
);

1619 autØ*
	gpg
 = 
cÚ‹xt
< 
SÇpTrimm”
 >().
pg
;

1620 ià(
	gwakeup
) {

1621 
	gMu‹x
::
Lock”
 
l
(
pg
->
osd
->
¢­_¦“p_lock
);

1622 
	gpg
->
	gosd
->
	g¢­_¦“p_tim”
.
ÿnûl_ev’t
(
wakeup
);

1623 
	gwakeup
 = 
nuÎ±r
;

1626 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
»aù
(cÚ¡ 
SÇpTrimTim”R—dy
 &) {

1627 
wakeup
 = 
nuÎ±r
;

1628 ià(!
	gcÚ‹xt
< 
	gSÇpTrimm”
 >().
ÿn_Œim
()) {

1629 
po¡_ev’t
(
KickTrim
());

1630  
	gŒªs™
< 
	gNÙTrimmšg
 >();

1632  
	gŒªs™
< 
	gAwa™AsyncWÜk
 >();

1637 
	gWa™RWLock
 : 
boo¡
::
¡©ech¬t
::
¡©e
< 
Wa™RWLock
, 
	gTrimmšg
 >, 
	gNamedS‹
 {

1638 
	gboo¡
::
	tm¶
::
	tli¡
 <

1639 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tTrimWr™eUnblocked
 >

1640 > 
	t»aùiÚs
;

1641 
ex¶ic™
 
Wa™RWLock
(
my_cÚ‹xt
 
ùx
)

1642 : 
my_ba£
(
ùx
),

1643 
NamedS‹
(
cÚ‹xt
< 
SÇpTrimm”
 >().
pg
, "Trimming/WaitRWLock") {

1644 
	gcÚ‹xt
< 
	gSÇpTrimm”
 >().
log_’‹r
(
¡©e_Çme
);

1645 
as£¹
(
cÚ‹xt
<
Trimmšg
>().
š_æight
.
em±y
());

1647 
ex™
() {

1648 
	gcÚ‹xt
< 
	gSÇpTrimm”
 >().
log_ex™
(
¡©e_Çme
, 
’‹r_time
);

1650 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
»aù
(cÚ¡ 
TrimWr™eUnblocked
&) {

1651 ià(!
cÚ‹xt
< 
SÇpTrimm”
 >().
ÿn_Œim
()) {

1652 
po¡_ev’t
(
KickTrim
());

1653  
	gŒªs™
< 
	gNÙTrimmšg
 >();

1655  
	gŒªs™
< 
	gAwa™AsyncWÜk
 >();

1660 
	gWa™R•İs
 : 
boo¡
::
¡©ech¬t
::
¡©e
< 
Wa™R•İs
, 
	gTrimmšg
 >, 
	gNamedS‹
 {

1661 
	gboo¡
::
	tm¶
::
	tli¡
 <

1662 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tR•İsCom¶‘e
 >

1663 > 
	t»aùiÚs
;

1664 
ex¶ic™
 
Wa™R•İs
(
my_cÚ‹xt
 
ùx
)

1665 : 
my_ba£
(
ùx
),

1666 
NamedS‹
(
cÚ‹xt
< 
SÇpTrimm”
 >().
pg
, "Trimming/WaitRepops") {

1667 
	gcÚ‹xt
< 
	gSÇpTrimm”
 >().
log_’‹r
(
¡©e_Çme
);

1668 
as£¹
(!
cÚ‹xt
<
Trimmšg
>().
š_æight
.
em±y
());

1670 
ex™
() {

1671 
	gcÚ‹xt
< 
	gSÇpTrimm”
 >().
log_ex™
(
¡©e_Çme
, 
’‹r_time
);

1673 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
»aù
(cÚ¡ 
R•İsCom¶‘e
&) {

1674 ià(!
cÚ‹xt
< 
SÇpTrimm”
 >().
ÿn_Œim
()) {

1675 
po¡_ev’t
(
KickTrim
());

1676  
	gŒªs™
< 
	gNÙTrimmšg
 >();

1678  
	gŒªs™
< 
	gWa™TrimTim”
 >();

1683 
	gAwa™AsyncWÜk
 : 
boo¡
::
¡©ech¬t
::
¡©e
< 
Awa™AsyncWÜk
, 
	gTrimmšg
 >, 
	gNamedS‹
 {

1684 
	gboo¡
::
	tm¶
::
	tli¡
 <

1685 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tDoSÇpWÜk
 >

1686 > 
	t»aùiÚs
;

1687 
ex¶ic™
 
Awa™AsyncWÜk
(
my_cÚ‹xt
 
ùx
);

1688 
ex™
() {

1689 
	gcÚ‹xt
< 
	gSÇpTrimm”
 >().
log_ex™
(
¡©e_Çme
, 
’‹r_time
);

1691 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
»aù
(cÚ¡ 
DoSÇpWÜk
&);

1694 
	gWa™Re£rv©iÚ
 : 
boo¡
::
¡©ech¬t
::
¡©e
< 
Wa™Re£rv©iÚ
, 
	gTrimmšg
 >, 
	gNamedS‹
 {

1697 
	gboo¡
::
	tm¶
::
	tli¡
 <

1698 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tSÇpTrimRe£rved
 >

1699 > 
	t»aùiÚs
;

1700 
	gRe£rv©iÚCB
 : 
public
 
CÚ‹xt
 {

1701 
Prim¬yLogPGRef
 
pg
;

1702 
boŞ
 
	gÿnûËd
;

1703 
ex¶ic™
 
Re£rv©iÚCB
(
Prim¬yLogPG
 *
pg
è:…gÕg), 
ÿnûËd
(
çl£
) {}

1704 
fšish
(è
	gov”ride
 {

1705 
	gpg
->
lock
();

1706 ià(!
	gÿnûËd
)

1707 
	gpg
->
	g¢­_Œimm”_machše
.
´oûss_ev’t
(
SÇpTrimRe£rved
());

1708 
	gpg
->
uÆock
();

1710 
ÿnûl
() {

1711 
as£¹
(
pg
->
is_locked
());

1712 
as£¹
(!
ÿnûËd
);

1713 
	gÿnûËd
 = 
Œue
;

1716 
Re£rv©iÚCB
 *
	g³ndšg
 = 
nuÎ±r
;

1718 
ex¶ic™
 
Wa™Re£rv©iÚ
(
my_cÚ‹xt
 
ùx
)

1719 : 
my_ba£
(
ùx
),

1720 
NamedS‹
(
cÚ‹xt
< 
SÇpTrimm”
 >().
pg
, "Trimming/WaitReservation") {

1721 
	gcÚ‹xt
< 
	gSÇpTrimm”
 >().
log_’‹r
(
¡©e_Çme
);

1722 
as£¹
(
cÚ‹xt
<
Trimmšg
>().
š_æight
.
em±y
());

1723 autØ*
	gpg
 = 
cÚ‹xt
< 
SÇpTrimm”
 >().
pg
;

1724 
	g³ndšg
 = 
Ãw
 
Re£rv©iÚCB
(
pg
);

1725 
	gpg
->
	gosd
->
	g¢­_»£rv”
.
»que¡_»£rv©iÚ
(

1726 
pg
->
g‘_pgid
(),

1727 
³ndšg
,

1729 
	gpg
->
¡©e_£t
(
PG_STATE_SNAPTRIM_WAIT
);

1730 
	gpg
->
publish_¡©s_to_osd
();

1732 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
»aù
(cÚ¡ 
SÇpTrimRe£rved
&);

1733 
ex™
() {

1734 
	gcÚ‹xt
< 
	gSÇpTrimm”
 >().
log_ex™
(
¡©e_Çme
, 
’‹r_time
);

1735 ià(
	g³ndšg
)

1736 
	g³ndšg
->
ÿnûl
();

1737 
	g³ndšg
 = 
nuÎ±r
;

1738 autØ*
	gpg
 = 
cÚ‹xt
< 
SÇpTrimm”
 >().
pg
;

1739 
	gpg
->
¡©e_ş—r
(
PG_STATE_SNAPTRIM_WAIT
);

1740 
	gpg
->
¡©e_ş—r
(
PG_STATE_SNAPTRIM_ERROR
);

1741 
	gpg
->
publish_¡©s_to_osd
();

1745 
	gWa™Süub
 : 
boo¡
::
¡©ech¬t
::
¡©e
< 
Wa™Süub
, 
	gSÇpTrimm”
 >, 
	gNamedS‹
 {

1746 
	gboo¡
::
	tm¶
::
	tli¡
 <

1747 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tSüubCom¶‘e
 >,

1748 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tKickTrim
 >,

1749 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tRe£t
, 
	tNÙTrimmšg
 >

1750 > 
	t»aùiÚs
;

1751 
ex¶ic™
 
Wa™Süub
(
my_cÚ‹xt
 
ùx
)

1752 : 
my_ba£
(
ùx
),

1753 
NamedS‹
(
cÚ‹xt
< 
SÇpTrimm”
 >().
pg
, "Trimming/WaitScrub") {

1754 
	gcÚ‹xt
< 
	gSÇpTrimm”
 >().
log_’‹r
(
¡©e_Çme
);

1756 
ex™
() {

1757 
	gcÚ‹xt
< 
	gSÇpTrimm”
 >().
log_ex™
(
¡©e_Çme
, 
’‹r_time
);

1759 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
»aù
(cÚ¡ 
SüubCom¶‘e
&) {

1760 
po¡_ev’t
(
KickTrim
());

1761  
	gŒªs™
< 
	gNÙTrimmšg
 >();

1763 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
»aù
(cÚ¡ 
KickTrim
&) {

1764  
disÿrd_ev’t
();

1768 
	gNÙTrimmšg
 : 
boo¡
::
¡©ech¬t
::
¡©e
< 
NÙTrimmšg
, 
	gSÇpTrimm”
 >, 
	gNamedS‹
 {

1769 
	gboo¡
::
	tm¶
::
	tli¡
 <

1770 
	tboo¡
::
	t¡©ech¬t
::
	tcu¡om_»aùiÚ
< 
	tKickTrim
 >,

1771 
	tboo¡
::
	t¡©ech¬t
::
	tŒªs™iÚ
< 
	tRe£t
, 
	tNÙTrimmšg
 >

1772 > 
	t»aùiÚs
;

1773 
ex¶ic™
 
NÙTrimmšg
(
my_cÚ‹xt
 
ùx
);

1774 
ex™
();

1775 
	gboo¡
::
¡©ech¬t
::
»suÉ
 
»aù
(cÚ¡ 
KickTrim
&);

1778 
_v”ify_no_h—d_şÚes
(cÚ¡ 
hobjeù_t
& 
soid
,

1779 cÚ¡ 
SÇpS‘
& 
ss
);

1782 
maybe_ü—‹_Ãw_objeù
(
OpCÚ‹xt
 *
ùx
, 
boŞ
 
ignÜe_Œª§ùiÚ
=
çl£
);

1783 
_d–‘e_oid
(
OpCÚ‹xt
 *
ùx
, 
boŞ
 
no_wh™eout
, boŞ 
Œy_no_wh™eout
);

1784 
_rŞlback_to
(
OpCÚ‹xt
 *
ùx
, 
ûph_osd_İ
& 
İ
);

1785 
	gpublic
:

1786 
boŞ
 
	$is_missšg_objeù
(cÚ¡ 
hobjeù_t
& 
oid
) const;

1787 
boŞ
 
	$is_uÄ—dabË_objeù
(cÚ¡ 
hobjeù_t
 &
oid
) const {

1788  
	`is_missšg_objeù
(
oid
) ||

1789 !
missšg_loc
.
	`»adabË_w™h_aùšg
(
oid
, 
aùšg£t
);

1790 
	}
}

1791 
maybe_kick_»cov”y
(cÚ¡ 
hobjeù_t
 &
soid
);

1792 
wa™_fÜ_uÄ—dabË_objeù
(cÚ¡ 
hobjeù_t
& 
oid
, 
OpReque¡Ref
 
İ
);

1793 
wa™_fÜ_®l_missšg
(
OpReque¡Ref
 
İ
);

1795 
boŞ
 
is_deg¿ded_Ü_backflšg_objeù
(cÚ¡ 
hobjeù_t
& 
oid
);

1796 
boŞ
 
is_deg¿ded_Ú_async_»cov”y_rg‘
(cÚ¡ 
hobjeù_t
& 
soid
);

1797 
wa™_fÜ_deg¿ded_objeù
(cÚ¡ 
hobjeù_t
& 
oid
, 
OpReque¡Ref
 
İ
);

1799 
block_wr™e_Ú_fuÎ_ÿche
(

1800 cÚ¡ 
hobjeù_t
& 
oid
, 
OpReque¡Ref
 
İ
);

1801 
block_fÜ_ş—n
(

1802 cÚ¡ 
hobjeù_t
& 
oid
, 
OpReque¡Ref
 
İ
);

1803 
block_wr™e_Ú_¢­_rŞlback
(

1804 cÚ¡ 
hobjeù_t
& 
oid
, 
ObjeùCÚ‹xtRef
 
obc
, 
OpReque¡Ref
 
İ
);

1805 
block_wr™e_Ú_deg¿ded_¢­
(cÚ¡ 
hobjeù_t
& 
oid
, 
OpReque¡Ref
 
İ
);

1807 
boŞ
 
maybe_awa™_blocked_h—d
(cÚ¡ 
hobjeù_t
 &
soid
, 
OpReque¡Ref
 
İ
);

1808 
wa™_fÜ_blocked_objeù
(cÚ¡ 
hobjeù_t
& 
soid
, 
OpReque¡Ref
 
İ
);

1809 
kick_objeù_cÚ‹xt_blocked
(
ObjeùCÚ‹xtRef
 
obc
);

1811 
maybe_fÜû_»cov”y
();

1813 
m¬k_®l_unfound_lo¡
(

1814 
wh©
,

1815 
CÚÃùiÚRef
 
cÚ
,

1816 
ûph_tid_t
 
tid
);

1817 
ev”siÚ_t
 
pick_Ãwe¡_avaabË
(cÚ¡ 
hobjeù_t
& 
oid
);

1819 
do_upd©e_log_missšg
(

1820 
OpReque¡Ref
 &
İ
);

1822 
do_upd©e_log_missšg_»¶y
(

1823 
OpReque¡Ref
 &
İ
);

1825 
	$Ú_rŞe_chªge
(è
ov”ride
;

1826 
	$Ú_poŞ_chªge
(è
ov”ride
;

1827 
	$_Ú_Ãw_š‹rv®
(è
ov”ride
;

1828 
	`ş—r_async_»ads
();

1829 
	$Ú_chªge
(
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
è
ov”ride
;

1830 
	$Ú_aùiv©e
(è
ov”ride
;

1831 
	$Ú_æushed
(è
ov”ride
;

1832 
	$Ú_»mov®
(
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
è
ov”ride
;

1833 
	$Ú_shutdown
(è
ov”ride
;

1834 
boŞ
 
	$check_ç§ã_fuÎ
(è
ov”ride
;

1835 
boŞ
 
	`check_osdm­_fuÎ
(cÚ¡ 
£t
<
pg_sh¬d_t
> &
missšg_Ú
è
ov”ride
;

1836 
boŞ
 
	$maybe_´“m±_»¶iÿ_süub
(cÚ¡ 
hobjeù_t
& 
oid
è
ov”ride
 {

1837  
	`wr™e_blocked_by_süub
(
oid
);

1838 
	}
}

1839 
»p_»·œ_´im¬y_objeù
(cÚ¡ 
hobjeù_t
& 
soid
, 
OpReque¡Ref
 
İ
);

1842 
£‰r_maybe_ÿche
(

1843 
ObjeùCÚ‹xtRef
 
obc
,

1844 
PGT¿n§ùiÚ
 *
t
,

1845 cÚ¡ 
¡ršg
 &
key
,

1846 
bufã¾i¡
 &
v®
);

1847 
£‰rs_maybe_ÿche
(

1848 
ObjeùCÚ‹xtRef
 
obc
,

1849 
PGT¿n§ùiÚ
 *
t
,

1850 
m­
<
¡ršg
, 
bufã¾i¡
> &
©Œs
);

1851 
rm©Œ_maybe_ÿche
(

1852 
ObjeùCÚ‹xtRef
 
obc
,

1853 
PGT¿n§ùiÚ
 *
t
,

1854 cÚ¡ 
¡ršg
 &
key
);

1855 
g‘©Œ_maybe_ÿche
(

1856 
ObjeùCÚ‹xtRef
 
obc
,

1857 cÚ¡ 
¡ršg
 &
key
,

1858 
bufã¾i¡
 *
v®
);

1859 
g‘©Œs_maybe_ÿche
(

1860 
ObjeùCÚ‹xtRef
 
obc
,

1861 
m­
<
¡ršg
, 
bufã¾i¡
> *
out
);

1864 
šlše
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gPrim¬yLogPG
::
R•G©h”
& 
»pİ
)

1866 
out
 << "»pg©h”(" << &
»pİ


1867 << " " << 
»pİ
.
v


1868 << "„•_tid=" << 
»pİ
.
»p_tid


1869 << " comm™‹d?=" << 
»pİ
.
®l_comm™‹d


1870 << "„=" << 
»pİ
.
r


1872  
	gout
;

1875 
šlše
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
,

1876 cÚ¡ 
	gPrim¬yLogPG
::
ProxyWr™eOpRef
& 
pwİ
)

1878 
out
 << "´oxywr™e(" << &
pwİ


1879 << " " << 
pwİ
->
u£r_v”siÚ


1880 << "…wİ_tid=" << 
pwİ
->
objeù”_tid
;

1881 ià(
	gpwİ
->
	gùx
->
	gİ
)

1882 
	gout
 << " op=" << *(
	gpwİ
->
	gùx
->
	gİ
->
g‘_»q
());

1883 
	gout
 << ")";

1884  
	gout
;

1887 
šŒusive_±r_add_»f
(
Prim¬yLogPG
::
R•G©h”
 *
»pİ
);

1888 
šŒusive_±r_»Ëa£
(
Prim¬yLogPG
::
R•G©h”
 *
»pİ
);

	@osd/ReplicatedBackend.cc

14 
	~"commÚ/”ºo.h
"

15 
	~"R•liÿ‹dBack’d.h
"

16 
	~"mes§ges/MOSDOp.h
"

17 
	~"mes§ges/MOSDR•Op.h
"

18 
	~"mes§ges/MOSDR•OpR•ly.h
"

19 
	~"mes§ges/MOSDPGPush.h
"

20 
	~"mes§ges/MOSDPGPuÎ.h
"

21 
	~"mes§ges/MOSDPGPushR•ly.h
"

22 
	~"commÚ/Ev’tT¿û.h
"

23 
	~"šşude/¿ndom.h
"

25 
	#dout_cÚ‹xt
 
cù


	)

26 
	#dout_subsys
 
ûph_subsys_osd


	)

27 
	#DOUT_PREFIX_ARGS
 
this


	)

28 #undeà
dout_´efix


29 
	#dout_´efix
 
	`_´efix
(
_dout
, 
this
)

	)

30 
	go¡»am
& 
	$_´efix
(
¡d
::
o¡»am
 *
_dout
, 
R•liÿ‹dBack’d
 *
pgb
) {

31  
pgb
->
	`g‘_·»Á
()->
	`g’_dbg_´efix
(*
_dout
);

32 
	}
}

34 
	gÇme¥aû
 {

35 şas 
	cPG_S’dMes§geOnCÚn
: 
public
 
CÚ‹xt
 {

36 
PGBack’d
::
Li¡’”
 *
pg
;

37 
Mes§ge
 *
	g»¶y
;

38 
CÚÃùiÚRef
 
	gcÚn
;

39 
	gpublic
:

40 
PG_S’dMes§geOnCÚn
(

41 
PGBack’d
::
Li¡’”
 *
pg
,

42 
Mes§ge
 *
»¶y
,

43 
CÚÃùiÚRef
 
cÚn
è: 
pg
Õg), 
»¶y
(reply), conn(conn) {}

44 
fšish
(è
	gov”ride
 {

45 
	gpg
->
£nd_mes§ge_osd_şu¡”
(
»¶y
, 
cÚn
.
g‘
());

49 şas 
	cPG_Recov”yQueueAsync
 : 
public
 
CÚ‹xt
 {

50 
PGBack’d
::
Li¡’”
 *
pg
;

51 
	gunique_±r
<
	gG’CÚ‹xt
<
	gTh»adPoŞ
::
TPHªdË
&>> 
c
;

52 
	gpublic
:

53 
PG_Recov”yQueueAsync
(

54 
PGBack’d
::
Li¡’”
 *
pg
,

55 
G’CÚ‹xt
<
Th»adPoŞ
::
TPHªdË
&> *
c
è: 
pg
(pg), c(c) {}

56 
fšish
(è
	gov”ride
 {

57 
	gpg
->
scheduË_»cov”y_wÜk
(
c
.
»Ëa£
());

62 
	gR•liÿ‹dBack’d
::
C_OSD_R•ModifyComm™
 : 
public
 
CÚ‹xt
 {

63 
R•liÿ‹dBack’d
 *
pg
;

64 
R•ModifyRef
 
	grm
;

65 
C_OSD_R•ModifyComm™
(
R•liÿ‹dBack’d
 *
pg
, 
R•ModifyRef
 
r
)

66 : 
pg
Õg), 
rm
(
r
) {}

67 
fšish
(
r
è
	gov”ride
 {

68 
	gpg
->
»pİ_comm™
(
rm
);

72 
	$log_subİ_¡©s
(

73 
P”fCouÁ”s
 *
logg”
,

74 
OpReque¡Ref
 
İ
, 
subİ
)

76 
utime_t
 
now
 = 
	`ûph_şock_now
();

77 
utime_t
 
Ï‹ncy
 = 
now
;

78 
Ï‹ncy
 -ğ
İ
->
	`g‘_»q
()->
	`g‘_»cv_¡amp
();

81 
logg”
->
	`šc
(
l_osd_sİ
);

82 
logg”
->
	`tšc
(
l_osd_sİ_Ït
, 
Ï‹ncy
);

83 
logg”
->
	`šc
(
subİ
);

85 ià(
subİ
 !ğ
l_osd_sİ_puÎ
) {

86 
ušt64_t
 
šb
 = 
İ
->
	`g‘_»q
()->
	`g‘_d©a
().
	`Ëngth
();

87 
logg”
->
	`šc
(
l_osd_sİ_šb
, 
šb
);

88 ià(
subİ
 =ğ
l_osd_sİ_w
) {

89 
logg”
->
	`šc
(
l_osd_sİ_w_šb
, 
šb
);

90 
logg”
->
	`tšc
(
l_osd_sİ_w_Ït
, 
Ï‹ncy
);

91 } ià(
subİ
 =ğ
l_osd_sİ_push
) {

92 
logg”
->
	`šc
(
l_osd_sİ_push_šb
, 
šb
);

93 
logg”
->
	`tšc
(
l_osd_sİ_push_Ït
, 
Ï‹ncy
);

95 
	`as£¹
("no support subop" == 0);

97 
logg”
->
	`tšc
(
l_osd_sİ_puÎ_Ït
, 
Ï‹ncy
);

99 
	}
}

101 
	gR•liÿ‹dBack’d
::
	$R•liÿ‹dBack’d
(

102 
PGBack’d
::
Li¡’”
 *
pg
,

103 cÚ¡ 
cŞl_t
 &
cŞl
,

104 
ObjeùStÜe
::
CŞËùiÚHªdË
 &
c
,

105 
ObjeùStÜe
 *
¡Üe
,

106 
C•hCÚ‹xt
 *
cù
) :

107 
	$PGBack’d
(
cù
, 
pg
, 
¡Üe
, 
cŞl
, 
c
è{
	}
}

109 
	gR•liÿ‹dBack’d
::
	$run_»cov”y_İ
(

110 
PGBack’d
::
Recov”yHªdË
 *
_h
,

111 
´iÜ™y
)

113 
RPGHªdË
 *
h
 = 
¡©ic_ÿ¡
<RPGHªdË *>(
_h
);

114 
	`£nd_pushes
(
´iÜ™y
, 
h
->
pushes
);

115 
	`£nd_puÎs
(
´iÜ™y
, 
h
->
puÎs
);

116 
	`£nd_»cov”y_d–‘es
(
´iÜ™y
, 
h
->
d–‘es
);

117 
d–‘e
 
h
;

118 
	}
}

120 
	gR•liÿ‹dBack’d
::
	$»cov”_objeù
(

121 cÚ¡ 
hobjeù_t
 &
hoid
,

122 
ev”siÚ_t
 
v
,

123 
ObjeùCÚ‹xtRef
 
h—d
,

124 
ObjeùCÚ‹xtRef
 
obc
,

125 
Recov”yHªdË
 *
_h


128 
	`dout
(10è<< 
__func__
 << ": " << 
hoid
 << 
d’dl
;

129 
RPGHªdË
 *
h
 = 
¡©ic_ÿ¡
<RPGHªdË *>(
_h
);

130 ià(
	`g‘_·»Á
()->
	`g‘_loÿl_missšg
().
	`is_missšg
(
hoid
)) {

131 
	`as£¹
(!
obc
);

133 
	`´•¬e_puÎ
(

134 
v
,

135 
hoid
,

136 
h—d
,

137 
h
);

139 
	`as£¹
(
obc
);

140 
¡¬‹d
 = 
	`¡¬t_pushes
(

141 
hoid
,

142 
obc
,

143 
h
);

144 ià(
¡¬‹d
 < 0) {

145 
pushšg
[
hoid
].
	`ş—r
();

146  
¡¬‹d
;

150 
	}
}

152 
	gR•liÿ‹dBack’d
::
	$check_»cov”y_sourûs
(cÚ¡ 
OSDM­Ref
& 
osdm­
)

154 
m­
<
pg_sh¬d_t
, 
£t
<
hobjeù_t
> >::
™”©Ü
 
i
 = 
puÎ_äom_³”
.
	`begš
();

155 
i
 !ğ
puÎ_äom_³”
.
	`’d
();

157 ià(
osdm­
->
	`is_down
(
i
->
fœ¡
.
osd
)) {

158 
	`dout
(10è<< "check_»cov”y_sourû »£‰šg…uÎ äom osd." << 
i
->
fœ¡


159 << ", osdm­ ha ™ m¬ked down" << 
d’dl
;

160 
£t
<
hobjeù_t
>::
™”©Ü
 
j
 = 
i
->
£cÚd
.
	`begš
();

161 
j
 !ğ
i
->
£cÚd
.
	`’d
();

162 ++
j
) {

163 
	`g‘_·»Á
()->
	`ÿnûl_puÎ
(*
j
);

164 
	`ş—r_puÎ
(
puÎšg
.
	`fšd
(*
j
), 
çl£
);

166 
puÎ_äom_³”
.
	`”a£
(
i
++);

168 ++
i
;

171 
	}
}

173 
boŞ
 
	gR•liÿ‹dBack’d
::
	$ÿn_hªdË_whe_šaùive
(
OpReque¡Ref
 
İ
)

175 
	`dout
(10è<< 
__func__
 << ": " << 
İ
 << 
d’dl
;

176 
İ
->
	`g‘_»q
()->
	`g‘_ty³
()) {

177 
MSG_OSD_PG_PULL
:

178  
Œue
;

180  
çl£
;

182 
	}
}

184 
boŞ
 
	gR•liÿ‹dBack’d
::
	$_hªdË_mes§ge
(

185 
OpReque¡Ref
 
İ


188 
	`dout
(10è<< 
__func__
 << ": " << 
İ
 << 
d’dl
;

189 
İ
->
	`g‘_»q
()->
	`g‘_ty³
()) {

190 
MSG_OSD_PG_PUSH
:

191 
	`do_push
(
İ
);

192  
Œue
;

194 
MSG_OSD_PG_PULL
:

195 
	`do_puÎ
(
İ
);

196  
Œue
;

198 
MSG_OSD_PG_PUSH_REPLY
:

199 
	`do_push_»¶y
(
İ
);

200  
Œue
;

202 
MSG_OSD_REPOP
: {

203 
	`do_»pİ
(
İ
);

204  
Œue
;

207 
MSG_OSD_REPOPREPLY
: {

208 
	`do_»pİ_»¶y
(
İ
);

209  
Œue
;

215  
çl£
;

216 
	}
}

218 
	gR•liÿ‹dBack’d
::
	$ş—r_»cov”y_¡©e
()

221 autØ&&
i
: 
pushšg
) {

222 autØ&&
j
: 
i
.
£cÚd
) {

223 
	`g‘_·»Á
()->
	`»Ëa£_locks
(
j
.
£cÚd
.
lock_mªag”
);

226 
pushšg
.
	`ş—r
();

228 autØ&&
i
: 
puÎšg
) {

229 
	`g‘_·»Á
()->
	`»Ëa£_locks
(
i
.
£cÚd
.
lock_mªag”
);

231 
puÎšg
.
	`ş—r
();

232 
puÎ_äom_³”
.
	`ş—r
();

233 
	}
}

235 
	gR•liÿ‹dBack’d
::
	$Ú_chªge
()

237 
	`dout
(10è<< 
__func__
 << 
d’dl
;

238 auto& 
İ
 : 
š_´og»ss_İs
) {

239 
d–‘e
 
İ
.
£cÚd
.
Ú_comm™
;

241 
š_´og»ss_İs
.
	`ş—r
();

242 
	`ş—r_»cov”y_¡©e
();

243 
	}
}

245 
	gR•liÿ‹dBack’d
::
	$objeùs_»ad_sync
(

246 cÚ¡ 
hobjeù_t
 &
hoid
,

247 
ušt64_t
 
off
,

248 
ušt64_t
 
Ën
,

249 
ušt32_t
 
İ_æags
,

250 
bufã¾i¡
 *
bl
)

252  
¡Üe
->
	`»ad
(
ch
, 
	`ghobjeù_t
(
hoid
), 
off
, 
Ën
, *
bl
, 
İ_æags
);

253 
	}
}

255 
	gR•liÿ‹dBack’d
::
objeùs_»ad_async
(

256 cÚ¡ 
hobjeù_t
 &
hoid
,

257 cÚ¡ 
li¡
<
·œ
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
>,

258 
·œ
<
bufã¾i¡
*, 
CÚ‹xt
*> > > &
to_»ad
,

259 
CÚ‹xt
 *
Ú_com¶‘e
,

260 
boŞ
 
ç¡_»ad
)

262 
as£¹
(0 == "async„ead is‚ot used by„eplica…ool");

265 şas 
	cC_OSD_OnOpComm™
 : 
public
 
CÚ‹xt
 {

266 
R•liÿ‹dBack’d
 *
pg
;

267 
	mR•liÿ‹dBack’d
::
InProg»ssOp
 *
İ
;

268 
	mpublic
:

269 
	$C_OSD_OnOpComm™
(
R•liÿ‹dBack’d
 *
pg
, R•liÿ‹dBack’d::
InProg»ssOp
 *
İ
)

270 : 
	`pg
(
pg
), 
	$İ
(
İ
) {}

271 
	$fšish
(è
ov”ride
 {

272 
pg
->
	`İ_comm™
(
İ
);

273 
	}
}

276 
g’”©e_Œª§ùiÚ
(

277 
PGT¿n§ùiÚUPŒ
 &
pgt
,

278 cÚ¡ 
cŞl_t
 &
cŞl
,

279 
veùÜ
<
pg_log_’Œy_t
> &
log_’Œ›s
,

280 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
,

281 
£t
<
hobjeù_t
> *
added
,

282 
£t
<
hobjeù_t
> *
»moved
)

284 
as£¹
(
t
);

285 
as£¹
(
added
);

286 
as£¹
(
»moved
);

288 autØ&&
	gË
: 
log_’Œ›s
) {

289 
Ë
.
m¬k_uÄŞlbackabË
();

290 autØ
	go™”
 = 
pgt
->
İ_m­
.
fšd
(
Ë
.
soid
);

291 ià(
	go™”
 !ğ
pgt
->
İ_m­
.
’d
(è&& 
o™”
->
£cÚd
.
upd©ed_¢­s
) {

292 
bufã¾i¡
 
bl
(
o™”
->
£cÚd
.
upd©ed_¢­s
->£cÚd.
size
() * 8 + 8);

293 
’code
(
o™”
->
£cÚd
.
upd©ed_¢­s
->£cÚd, 
bl
);

294 
	gË
.
	g¢­s
.
sw­
(
bl
);

295 
	gË
.
	g¢­s
.
»assign_to_mempoŞ
(
mempoŞ
::
mempoŞ_osd_pglog
);

299 
	gpgt
->
§ã_ü—‹_Œav”£
(

300 [&](
·œ
<cÚ¡ 
hobjeù_t
, 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
> &
obj_İ
) {

301 cÚ¡ 
hobjeù_t
 &
oid
 = 
obj_İ
.
fœ¡
;

302 cÚ¡ 
ghobjeù_t
 
goid
 =

303 
ghobjeù_t
(
oid
, ghobjeù_t::
NO_GEN
, 
sh¬d_id_t
::
NO_SHARD
);

304 cÚ¡ 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
 &
İ
 = 
obj_İ
.
£cÚd
;

306 ià(
oid
.
is_‹mp
()) {

307 ià(
İ
.
is_äesh_objeù
()) {

308 
added
->
š£¹
(
oid
);

309 } ià(
İ
.
is_d–‘e
()) {

310 
»moved
->
š£¹
(
oid
);

314 ià(
İ
.
d–‘e_fœ¡
) {

315 
t
->
»move
(
cŞl
, 
goid
);

318 
m©ch
(

319 
İ
.
š™_ty³
,

320 [&](cÚ¡ 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
::
In™
::
NÚe
 &) {

322 [&](cÚ¡ 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
::
In™
::
C»©e
 &
İ
) {

323 
t
->
touch
(
cŞl
, 
goid
);

325 [&](cÚ¡ 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
::
In™
::
ClÚe
 &
İ
) {

326 
t
->
şÚe
(

327 
cŞl
,

328 
ghobjeù_t
(

329 
İ
.
sourû
, 
ghobjeù_t
::
NO_GEN
, 
sh¬d_id_t
::
NO_SHARD
),

330 
goid
);

332 [&](cÚ¡ 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
::
In™
::
R’ame
 &
İ
) {

333 
as£¹
(
İ
.
sourû
.
is_‹mp
());

334 
t
->
cŞËùiÚ_move_»Çme
(

335 
cŞl
,

336 
ghobjeù_t
(

337 
İ
.
sourû
, 
ghobjeù_t
::
NO_GEN
, 
sh¬d_id_t
::
NO_SHARD
),

338 
cŞl
,

339 
goid
);

342 ià(
İ
.
Œunÿ‹
) {

343 
t
->
Œunÿ‹
(
cŞl
, 
goid
, 
İ
.Œunÿ‹->
fœ¡
);

344 ià(
İ
.
Œunÿ‹
->
fœ¡
 !ğİ.Œunÿ‹->
£cÚd
)

345 
t
->
Œunÿ‹
(
cŞl
, 
goid
, 
İ
.Œunÿ‹->
£cÚd
);

348 ià(!
İ
.
©Œ_upd©es
.
em±y
()) {

349 
m­
<
¡ršg
, 
bufã¾i¡
> 
©Œs
;

350 autØ&&
p
: 
İ
.
©Œ_upd©es
) {

351 ià(
p
.
£cÚd
)

352 
©Œs
[
p
.
fœ¡
] = *Õ.
£cÚd
);

354 
t
->
rm©Œ
(
cŞl
, 
goid
, 
p
.
fœ¡
);

356 
t
->
£‰rs
(
cŞl
, 
goid
, 
©Œs
);

359 ià(
İ
.
ş—r_om­
)

360 
t
->
om­_ş—r
(
cŞl
, 
goid
);

361 ià(
İ
.
om­_h—d”
)

362 
t
->
om­_£th—d”
(
cŞl
, 
goid
, *(
İ
.
om­_h—d”
));

364 autØ&&
up
: 
İ
.
om­_upd©es
) {

365 
usšg
 
Upd©eTy³
 = 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
::
Om­Upd©eTy³
;

366 
up
.
fœ¡
) {

367 
Upd©eTy³
::
Remove
:

368 
t
->
om­_rmkeys
(
cŞl
, 
goid
, 
up
.
£cÚd
);

370 
Upd©eTy³
::
In£¹
:

371 
t
->
om­_£tkeys
(
cŞl
, 
goid
, 
up
.
£cÚd
);

378 ià(
İ
.
®loc_hšt
) {

379 autØ&
hšt
 = *(
İ
.
®loc_hšt
);

380 
t
->
£t_®loc_hšt
(

381 
cŞl
,

382 
goid
,

383 
hšt
.
ex³ùed_objeù_size
,

384 
hšt
.
ex³ùed_wr™e_size
,

385 
hšt
.
æags
);

388 autØ&&
ex‹Á
: 
İ
.
bufãr_upd©es
) {

389 
usšg
 
BufãrUpd©e
 = 
PGT¿n§ùiÚ
::
ObjeùO³¿tiÚ
::BufferUpdate;

390 
m©ch
(

391 
ex‹Á
.
g‘_v®
(),

392 [&](cÚ¡ 
BufãrUpd©e
::
Wr™e
 &
İ
) {

393 
t
->
wr™e
(

394 
cŞl
,

395 
goid
,

396 
ex‹Á
.
g‘_off
(),

397 
ex‹Á
.
g‘_Ën
(),

398 
İ
.
bufãr
);

400 [&](cÚ¡ 
BufãrUpd©e
::
Z”o
 &
İ
) {

401 
t
->
z”o
(

402 
cŞl
,

403 
goid
,

404 
ex‹Á
.
g‘_off
(),

405 
ex‹Á
.
g‘_Ën
());

407 [&](cÚ¡ 
BufãrUpd©e
::
ClÚeRªge
 &
İ
) {

408 
as£¹
(
İ
.
Ën
 =ğ
ex‹Á
.
g‘_Ën
());

409 
t
->
şÚe_¿nge
(

410 
cŞl
,

411 
ghobjeù_t
(
İ
.
äom
, ghobjeù_t::
NO_GEN
, 
sh¬d_id_t
::
NO_SHARD
),

412 
goid
,

413 
İ
.
off£t
,

414 
ex‹Á
.
g‘_Ën
(),

415 
ex‹Á
.
g‘_off
());

421 
	gR•liÿ‹dBack’d
::
subm™_Œª§ùiÚ
(

422 cÚ¡ 
hobjeù_t
 &
soid
,

423 cÚ¡ 
objeù_¡©_sum_t
 &
d–_¡©s
,

424 cÚ¡ 
ev”siÚ_t
 &
©_v”siÚ
,

425 
PGT¿n§ùiÚUPŒ
 &&
_t
,

426 cÚ¡ 
ev”siÚ_t
 &
Œim_to
,

427 cÚ¡ 
ev”siÚ_t
 &
rŞl_fÜw¬d_to
,

428 cÚ¡ 
veùÜ
<
pg_log_’Œy_t
> &
_log_’Œ›s
,

429 
boo¡
::
İtiÚ®
<
pg_h™_£t_hi¡Üy_t
> &
h£t_hi¡Üy
,

430 
CÚ‹xt
 *
Ú_®l_comm™
,

431 
ûph_tid_t
 
tid
,

432 
osd_»qid_t
 
»qid
,

433 
OpReque¡Ref
 
Üig_İ
)

435 
	g·»Á
->
­¶y_¡©s
(

436 
soid
,

437 
d–_¡©s
);

439 
	gveùÜ
<
	gpg_log_’Œy_t
> 
log_’Œ›s
(
_log_’Œ›s
);

440 
	gObjeùStÜe
::
T¿n§ùiÚ
 
İ_t
;

441 
PGT¿n§ùiÚUPŒ
 
t
(
¡d
::
move
(
_t
));

442 
	g£t
<
	ghobjeù_t
> 
	gadded
, 
	g»moved
;

443 
g’”©e_Œª§ùiÚ
(

444 
t
,

445 
cŞl
,

446 
log_’Œ›s
,

447 &
İ_t
,

448 &
added
,

449 &
»moved
);

450 
as£¹
(
added
.
size
() <= 1);

451 
as£¹
(
»moved
.
size
() <= 1);

453 autØ
	gš£¹_»s
 = 
š_´og»ss_İs
.
š£¹
(

454 
make_·œ
(

455 
tid
,

456 
InProg»ssOp
(

457 
tid
, 
Ú_®l_comm™
,

458 
Üig_İ
, 
©_v”siÚ
)

461 
as£¹
(
š£¹_»s
.
£cÚd
);

462 
	gInProg»ssOp
 &
	gİ
 = 
š£¹_»s
.
fœ¡
->
£cÚd
;

464 
	gİ
.
	gwa™šg_fÜ_comm™
.
š£¹
(

465 
·»Á
->
g‘_aùšg_»cov”y_backfl_sh¬ds
().
begš
(),

466 
·»Á
->
g‘_aùšg_»cov”y_backfl_sh¬ds
().
’d
());

468 
issue_İ
(

469 
soid
,

470 
©_v”siÚ
,

471 
tid
,

472 
»qid
,

473 
Œim_to
,

474 
©_v”siÚ
,

475 
added
.
size
(è? *×dded.
begš
()è: 
hobjeù_t
(),

476 
»moved
.
size
(è? *Ôemoved.
begš
()è: 
hobjeù_t
(),

477 
log_’Œ›s
,

478 
h£t_hi¡Üy
,

479 &
İ
,

480 
İ_t
);

482 
add_‹mp_objs
(
added
);

483 
ş—r_‹mp_objs
(
»moved
);

485 
	g·»Á
->
log_İ”©iÚ
(

486 
log_’Œ›s
,

487 
h£t_hi¡Üy
,

488 
Œim_to
,

489 
©_v”siÚ
,

490 
Œue
,

491 
İ_t
);

493 
	gİ_t
.
»gi¡”_Ú_comm™
(

494 
·»Á
->
bËss_cÚ‹xt
(

495 
Ãw
 
C_OSD_OnOpComm™
(
this
, &
İ
)));

497 
	gveùÜ
<
	gObjeùStÜe
::
T¿n§ùiÚ
> 
s
;

498 
	gs
.
push_back
(
¡d
::
move
(
İ_t
));

500 
	g·»Á
->
queue_Œª§ùiÚs
(
s
, 
İ
.op);

501 ià(
	g©_v”siÚ
 !ğ
ev”siÚ_t
()) {

502 
·»Á
->
İ_­¶›d
(
©_v”siÚ
);

506 
	gR•liÿ‹dBack’d
::
	$İ_comm™
(

507 
InProg»ssOp
 *
İ
)

509 
	`FUNCTRACE
(
cù
);

510 
	`OID_EVENT_TRACE_WITH_MSG
((
İ
 && op->İè? op->İ->
	`g‘_»q
(è: 
NULL
, "OP_COMMIT_BEGIN", 
Œue
);

511 
	`dout
(10è<< 
__func__
 << ": " << 
İ
->
tid
 << 
d’dl
;

512 ià(
İ
->op) {

513 
İ
->İ->
	`m¬k_ev’t
("op_commit");

514 
İ
->İ->
pg_Œaû
.
	`ev’t
("op commit");

517 
İ
->
wa™šg_fÜ_comm™
.
	`”a£
(
	`g‘_·»Á
()->
	`whßmi_sh¬d
());

519 ià(
İ
->
wa™šg_fÜ_comm™
.
	`em±y
()) {

520 
İ
->
Ú_comm™
->
	`com¶‘e
(0);

521 
İ
->
Ú_comm™
 = 0;

522 
	`as£¹
(!
İ
->
Ú_comm™
);

523 
š_´og»ss_İs
.
	`”a£
(
İ
->
tid
);

525 
	}
}

527 
	gR•liÿ‹dBack’d
::
	$do_»pİ_»¶y
(
OpReque¡Ref
 
İ
)

529 
¡©ic_ÿ¡
<
MOSDR•OpR•ly
*>(
İ
->
	`g‘_nÚcÚ¡_»q
())->
	`fšish_decode
();

530 cÚ¡ 
MOSDR•OpR•ly
 *
r
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDR•OpR•ly *>(
İ
->
	`g‘_»q
());

531 
	`as£¹
(
r
->
	`g‘_h—d”
().
ty³
 =ğ
MSG_OSD_REPOPREPLY
);

533 
İ
->
	`m¬k_¡¬‹d
();

536 
ûph_tid_t
 
»p_tid
 = 
r
->
	`g‘_tid
();

537 
pg_sh¬d_t
 
äom
 = 
r
->from;

539 autØ
™”
 = 
š_´og»ss_İs
.
	`fšd
(
»p_tid
);

540 ià(
™”
 !ğ
š_´og»ss_İs
.
	`’d
()) {

541 
InProg»ssOp
 &
_İ
 = 
™”
->
£cÚd
;

542 cÚ¡ 
MOSDOp
 *
m
 = 
NULL
;

543 ià(
_İ
.
İ
)

544 
m
 = 
¡©ic_ÿ¡
<cÚ¡ 
MOSDOp
 *>(
_İ
.
İ
->
	`g‘_»q
());

546 ià(
m
)

547 
	`dout
(7è<< 
__func__
 << ":id " << 
_İ
.
tid
 << " op "

548 << "‡ck_ty³ " << ()
r
->
ack_ty³


549 << " from " << 
äom


550 << 
d’dl
;

552 
	`dout
(7è<< 
__func__
 << ":id " << 
_İ
.
tid
 << " (no op) "

553 << "‡ck_ty³ " << ()
r
->
ack_ty³


554 << " from " << 
äom


555 << 
d’dl
;

559 ià(
r
->
ack_ty³
 & 
CEPH_OSD_FLAG_ONDISK
) {

560 
	`as£¹
(
_İ
.
wa™šg_fÜ_comm™
.
	`couÁ
(
äom
));

561 
_İ
.
wa™šg_fÜ_comm™
.
	`”a£
(
äom
);

562 ià(
_İ
.
İ
) {

563 
o¡ršg¡»am
 
ss
;

564 
ss
 << "sub_İ_comm™_»øäom " << 
äom
;

565 
_İ
.
İ
->
	`m¬k_ev’t_¡ršg
(
ss
.
	`¡r
());

566 
_İ
.
İ
->
pg_Œaû
.
	`ev’t
("sub_op_commit_rec");

572 
·»Á
->
	`upd©e_³”_Ï¡_com¶‘e_Údisk
(

573 
äom
,

574 
r
->
	`g‘_Ï¡_com¶‘e_Údisk
());

576 ià(
_İ
.
wa™šg_fÜ_comm™
.
	`em±y
() &&

577 
_İ
.
Ú_comm™
) {

578 
_İ
.
Ú_comm™
->
	`com¶‘e
(0);

579 
_İ
.
Ú_comm™
 = 0;

580 
š_´og»ss_İs
.
	`”a£
(
™”
);

583 
	}
}

585 
	gR•liÿ‹dBack’d
::
	$be_d“p_süub
(

586 cÚ¡ 
hobjeù_t
 &
poid
,

587 
SüubM­
 &
m­
,

588 
SüubM­Bud”
 &
pos
,

589 
SüubM­
::
objeù
 &
o
)

591 
	`dout
(10è<< 
__func__
 << " " << 
poid
 << "…o " << 
pos
 << 
d’dl
;

592 
r
;

593 
ušt32_t
 
çdvi£_æags
 = 
CEPH_OSD_OP_FLAG_FADVISE_SEQUENTIAL
 |

594 
CEPH_OSD_OP_FLAG_FADVISE_DONTNEED
;

596 
boŞ
 
sk_d©a_dige¡
 = 
¡Üe
->
	`has_butš_csum
() &&

597 
g_cÚf
->
osd_sk_d©a_dige¡
;

599 
utime_t
 
¦“±ime
;

600 
¦“±ime
.
	`£t_äom_doubË
(
cù
->
_cÚf
->
osd_debug_d“p_süub_¦“p
);

601 ià(
¦“±ime
 !ğ
	`utime_t
()) {

602 
	`lg’”ic_d”r
(
cù
è<< 
__func__
 << " sË•šg fÜ " << 
¦“±ime
 << 
d’dl
;

603 
¦“±ime
.
	`¦“p
();

606 
	`as£¹
(
poid
 =ğ
pos
.
ls
[pos.pos]);

607 ià(!
pos
.
	`d©a_dÚe
()) {

608 ià(
pos
.
d©a_pos
 == 0) {

609 
pos
.
d©a_hash
 = 
	`bufãrhash
(-1);

612 
bufã¾i¡
 
bl
;

613 
r
 = 
¡Üe
->
	`»ad
(

614 
ch
,

615 
	`ghobjeù_t
(

616 
poid
, 
ghobjeù_t
::
NO_GEN
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
),

617 
pos
.
d©a_pos
,

618 
cù
->
_cÚf
->
osd_d“p_süub_¡ride
, 
bl
,

619 
çdvi£_æags
);

620 ià(
r
 < 0) {

621 
	`dout
(20è<< 
__func__
 << " " << 
poid
 << " got "

622 << 
r
 << " oÀ»ad,„—d_”rÜ" << 
d’dl
;

623 
o
.
»ad_”rÜ
 = 
Œue
;

626 ià(
r
 > 0 && !
sk_d©a_dige¡
) {

627 
pos
.
d©a_hash
 << 
bl
;

629 
pos
.
d©a_pos
 +ğ
r
;

630 ià(
r
 =ğ
cù
->
_cÚf
->
osd_d“p_süub_¡ride
) {

631 
	`dout
(20è<< 
__func__
 << " " << 
poid
 << " more data, digest so far 0x"

632 << 
¡d
::
hex
 << 
pos
.
d©a_hash
.
	`dige¡
(è<< std::
dec
 << 
d’dl
;

633  -
EINPROGRESS
;

636 
pos
.
d©a_pos
 = -1;

637 ià(!
sk_d©a_dige¡
) {

638 
o
.
dige¡
 = 
pos
.
d©a_hash
.
	`dige¡
();

639 
o
.
dige¡_´e£Á
 = 
Œue
;

641 
	`dout
(20è<< 
__func__
 << " " << 
poid
 << " done with data, digest 0x"

642 << 
¡d
::
hex
 << 
o
.
dige¡
 << std::
dec
 << 
d’dl
;

646 ià(
pos
.
om­_pos
.
	`em±y
()) {

647 
pos
.
om­_hash
 = 
	`bufãrhash
(-1);

649 
bufã¾i¡
 
hdrbl
;

650 
r
 = 
¡Üe
->
	`om­_g‘_h—d”
(

651 
ch
,

652 
	`ghobjeù_t
(

653 
poid
, 
ghobjeù_t
::
NO_GEN
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
),

654 &
hdrbl
, 
Œue
);

655 ià(
r
 =ğ-
EIO
) {

656 
	`dout
(20è<< 
__func__
 << " " << 
poid
 << " got "

657 << 
r
 << " oÀom­ h—d”„—d,„—d_”rÜ" << 
d’dl
;

658 
o
.
»ad_”rÜ
 = 
Œue
;

661 ià(
r
 =ğ0 && 
hdrbl
.
	`Ëngth
()) {

662 
	`dout
(25è<< "CRC h—d” " << 
	`¡ršg
(
hdrbl
.
	`c_¡r
(), hdrbl.
	`Ëngth
())

663 << 
d’dl
;

664 
pos
.
om­_hash
 << 
hdrbl
;

669 
ObjeùM­
::
ObjeùM­I‹¿tÜ
 
™”
 = 
¡Üe
->
	`g‘_om­_™”©Ü
(

670 
ch
,

671 
	`ghobjeù_t
(

672 
poid
, 
ghobjeù_t
::
NO_GEN
, 
	`g‘_·»Á
()->
	`whßmi_sh¬d
().
sh¬d
));

673 
	`as£¹
(
™”
);

674 ià(
pos
.
om­_pos
.
	`Ëngth
()) {

675 
™”
->
	`low”_bound
(
pos
.
om­_pos
);

677 
™”
->
	`£ek_to_fœ¡
();

679 
max
 = 
g_cÚf
->
osd_d“p_süub_keys
;

680 
™”
->
	`¡©us
(è=ğ0 && i‹r->
	`v®id
()) {

681 
pos
.
om­_by‹s
 +ğ
™”
->
	`v®ue
().
	`Ëngth
();

682 ++
pos
.
om­_keys
;

683 --
max
;

685 
bufã¾i¡
 
bl
;

686 
	`’code
(
™”
->
	`key
(), 
bl
);

687 
	`’code
(
™”
->
	`v®ue
(), 
bl
);

688 
pos
.
om­_hash
 << 
bl
;

690 
™”
->
	`Ãxt
();

692 ià(
™”
->
	`v®id
(è&& 
max
 == 0) {

693 
pos
.
om­_pos
 = 
™”
->
	`key
();

694  -
EINPROGRESS
;

696 ià(
™”
->
	`¡©us
() < 0) {

697 
	`dout
(25è<< 
__func__
 << " " << 
poid


698 << " oÀom­ sÿn, db stu ”rÜ" << 
d’dl
;

699 
o
.
»ad_”rÜ
 = 
Œue
;

704 ià(
pos
.
om­_keys
 > 
cù
->
_cÚf
->

705 
osd_d“p_süub_Ïrge_om­_objeù_key_th»shŞd
 ||

706 
pos
.
om­_by‹s
 > 
cù
->
_cÚf
->

707 
osd_d“p_süub_Ïrge_om­_objeù_v®ue_sum_th»shŞd
) {

708 
	`dout
(25è<< 
__func__
 << " " << 
poid


709 << "†¬gom­ objeù d‘eùed. Objeù ha " << 
pos
.
om­_keys


710 << " key ªd siz" << 
pos
.
om­_by‹s
 << " by‹s" << 
d’dl
;

711 
o
.
Ïrge_om­_objeù_found
 = 
Œue
;

712 
o
.
Ïrge_om­_objeù_key_couÁ
 = 
pos
.
om­_keys
;

713 
o
.
Ïrge_om­_objeù_v®ue_size
 = 
pos
.
om­_by‹s
;

714 
m­
.
has_Ïrge_om­_objeù_”rÜs
 = 
Œue
;

717 
o
.
om­_dige¡
 = 
pos
.
om­_hash
.
	`dige¡
();

718 
o
.
om­_dige¡_´e£Á
 = 
Œue
;

719 
	`dout
(20è<< 
__func__
 << " dÚw™h " << 
poid
 << " omap_digest "

720 << 
¡d
::
hex
 << 
o
.
om­_dige¡
 << std::
dec
 << 
d’dl
;

724 
	}
}

726 
	gR•liÿ‹dBack’d
::
	$_do_push
(
OpReque¡Ref
 
İ
)

728 cÚ¡ 
MOSDPGPush
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDPGPush *>(
İ
->
	`g‘_»q
());

729 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
MSG_OSD_PG_PUSH
);

730 
pg_sh¬d_t
 
äom
 = 
m
->from;

732 
İ
->
	`m¬k_¡¬‹d
();

734 
veùÜ
<
PushR•lyOp
> 
»¶›s
;

735 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

736 ià(
	`g‘_·»Á
()->
	`check_ç§ã_fuÎ
()) {

737 
	`dout
(10è<< 
__func__
 << " Ouˆoà¥aû (ç§ãè´oûssšg…ush„eque¡." << 
d’dl
;

738 
	`ûph_abÜt
();

740 
veùÜ
<
PushOp
>::
cÚ¡_™”©Ü
 
i
 = 
m
->
pushes
.
	`begš
();

741 
i
 !ğ
m
->
pushes
.
	`’d
();

742 ++
i
) {

743 
»¶›s
.
	`push_back
(
	`PushR•lyOp
());

744 
	`hªdË_push
(
äom
, *
i
, &(
»¶›s
.
	`back
()), &
t
);

747 
MOSDPGPushR•ly
 *
»¶y
 = 
Ãw
 MOSDPGPushReply;

748 
»¶y
->
äom
 = 
	`g‘_·»Á
()->
	`whßmi_sh¬d
();

749 
»¶y
->
	`£t_´iÜ™y
(
m
->
	`g‘_´iÜ™y
());

750 
»¶y
->
pgid
 = 
	`g‘_šfo
().pgid;

751 
»¶y
->
m­_•och
 = 
m
->map_epoch;

752 
»¶y
->
mš_•och
 = 
m
->min_epoch;

753 
»¶y
->
»¶›s
.
	`sw­
(replies);

754 
»¶y
->
	`compu‹_co¡
(
cù
);

756 
t
.
	`»gi¡”_Ú_com¶‘e
(

757 
Ãw
 
	`PG_S’dMes§geOnCÚn
(

758 
	`g‘_·»Á
(), 
»¶y
, 
m
->
	`g‘_cÚÃùiÚ
()));

760 
	`g‘_·»Á
()->
	`queue_Œª§ùiÚ
(
¡d
::
	`move
(
t
));

761 
	}
}

763 
	gC_R•liÿ‹dBack’d_OnPuÎCom¶‘e
 : 
G’CÚ‹xt
<
Th»adPoŞ
::
TPHªdË
&> {

764 
R•liÿ‹dBack’d
 *
bc
;

765 
	gli¡
<
	gR•liÿ‹dBack’d
::
puÎ_com¶‘e_šfo
> 
to_cÚtšue
;

766 
	g´iÜ™y
;

767 
C_R•liÿ‹dBack’d_OnPuÎCom¶‘e
(
R•liÿ‹dBack’d
 *
bc
, 
´iÜ™y
)

768 : 
bc
(bc), 
´iÜ™y
(priority) {}

770 
fšish
(
Th»adPoŞ
::
TPHªdË
 &
hªdË
è
ov”ride
 {

771 
R•liÿ‹dBack’d
::
RPGHªdË
 *
h
 = 
bc
->
_İ’_»cov”y_İ
();

772 autØ&&
	gi
: 
to_cÚtšue
) {

773 autØ
j
 = 
bc
->
puÎšg
.
fšd
(
i
.
hoid
);

774 
as£¹
(
j
 !ğ
bc
->
puÎšg
.
’d
());

775 
ObjeùCÚ‹xtRef
 
	gobc
 = 
j
->
£cÚd
.
obc
;

776 
	gbc
->
ş—r_puÎ
(
j
, 
çl£
 );

777 
	g¡¬‹d
 = 
bc
->
¡¬t_pushes
(
i
.
hoid
, 
obc
, 
h
);

778 ià(
	g¡¬‹d
 < 0) {

779 
	gbc
->
	gpushšg
[
i
.
hoid
].
ş—r
();

780 
	gbc
->
g‘_·»Á
()->
´im¬y_çed
(
i
.
hoid
);

781 
	gbc
->
g‘_·»Á
()->
´im¬y_”rÜ
(
i
.
hoid
, 
obc
->
obs
.
oi
.
v”siÚ
);

782 } ià(!
	g¡¬‹d
) {

783 
	gbc
->
g‘_·»Á
()->
Ú_glob®_»cov”
(

784 
i
.
hoid
, i.
¡©
, 
çl£
);

786 
	ghªdË
.
»£t__timeout
();

788 
	gbc
->
run_»cov”y_İ
(
h
, 
´iÜ™y
);

792 
	gR•liÿ‹dBack’d
::
	$_do_puÎ_»¥Ú£
(
OpReque¡Ref
 
İ
)

794 cÚ¡ 
MOSDPGPush
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDPGPush *>(
İ
->
	`g‘_»q
());

795 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
MSG_OSD_PG_PUSH
);

796 
pg_sh¬d_t
 
äom
 = 
m
->from;

798 
İ
->
	`m¬k_¡¬‹d
();

800 
veùÜ
<
PuÎOp
> 
	`»¶›s
(1);

801 ià(
	`g‘_·»Á
()->
	`check_ç§ã_fuÎ
()) {

802 
	`dout
(10è<< 
__func__
 << " Ouˆoà¥aû (ç§ãè´oûssšg…uÎ„e¥Ú£ (push)." << 
d’dl
;

803 
	`ûph_abÜt
();

806 
ObjeùStÜe
::
T¿n§ùiÚ
 
t
;

807 
li¡
<
puÎ_com¶‘e_šfo
> 
to_cÚtšue
;

808 
veùÜ
<
PushOp
>::
cÚ¡_™”©Ü
 
i
 = 
m
->
pushes
.
	`begš
();

809 
i
 !ğ
m
->
pushes
.
	`’d
();

810 ++
i
) {

811 
boŞ
 
mÜe
 = 
	`hªdË_puÎ_»¥Ú£
(
äom
, *
i
, &(
»¶›s
.
	`back
()), &
to_cÚtšue
, &
t
);

812 ià(
mÜe
)

813 
»¶›s
.
	`push_back
(
	`PuÎOp
());

815 ià(!
to_cÚtšue
.
	`em±y
()) {

816 
C_R•liÿ‹dBack’d_OnPuÎCom¶‘e
 *
c
 =

817 
Ãw
 
	`C_R•liÿ‹dBack’d_OnPuÎCom¶‘e
(

818 
this
,

819 
m
->
	`g‘_´iÜ™y
());

820 
c
->
to_cÚtšue
.
	`sw­
(to_continue);

821 
t
.
	`»gi¡”_Ú_com¶‘e
(

822 
Ãw
 
	`PG_Recov”yQueueAsync
(

823 
	`g‘_·»Á
(),

824 
	`g‘_·»Á
()->
	`bËss_uÆocked_g’cÚ‹xt
(
c
)));

826 
»¶›s
.
	`”a£
Ô•l›s.
	`’d
() - 1);

828 ià(
»¶›s
.
	`size
()) {

829 
MOSDPGPuÎ
 *
»¶y
 = 
Ãw
 MOSDPGPull;

830 
»¶y
->
äom
 = 
·»Á
->
	`whßmi_sh¬d
();

831 
»¶y
->
	`£t_´iÜ™y
(
m
->
	`g‘_´iÜ™y
());

832 
»¶y
->
pgid
 = 
	`g‘_šfo
().pgid;

833 
»¶y
->
m­_•och
 = 
m
->map_epoch;

834 
»¶y
->
mš_•och
 = 
m
->min_epoch;

835 
»¶y
->
	`£t_puÎs
(&
»¶›s
);

836 
»¶y
->
	`compu‹_co¡
(
cù
);

838 
t
.
	`»gi¡”_Ú_com¶‘e
(

839 
Ãw
 
	`PG_S’dMes§geOnCÚn
(

840 
	`g‘_·»Á
(), 
»¶y
, 
m
->
	`g‘_cÚÃùiÚ
()));

843 
	`g‘_·»Á
()->
	`queue_Œª§ùiÚ
(
¡d
::
	`move
(
t
));

844 
	}
}

846 
	gR•liÿ‹dBack’d
::
	$do_puÎ
(
OpReque¡Ref
 
İ
)

848 
MOSDPGPuÎ
 *
m
 = 
¡©ic_ÿ¡
<MOSDPGPuÎ *>(
İ
->
	`g‘_nÚcÚ¡_»q
());

849 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
MSG_OSD_PG_PULL
);

850 
pg_sh¬d_t
 
äom
 = 
m
->from;

852 
m­
<
pg_sh¬d_t
, 
veùÜ
<
PushOp
> > 
»¶›s
;

853 
veùÜ
<
PuÎOp
> 
puÎs
;

854 
m
->
	`ke_puÎs
(&
puÎs
);

855 auto& 
i
 : 
puÎs
) {

856 
»¶›s
[
äom
].
	`push_back
(
	`PushOp
());

857 
	`hªdË_puÎ
(
äom
, 
i
, &(
»¶›s
[äom].
	`back
()));

859 
	`£nd_pushes
(
m
->
	`g‘_´iÜ™y
(), 
»¶›s
);

860 
	}
}

862 
	gR•liÿ‹dBack’d
::
	$do_push_»¶y
(
OpReque¡Ref
 
İ
)

864 cÚ¡ 
MOSDPGPushR•ly
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDPGPushR•ly *>(
İ
->
	`g‘_»q
());

865 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
MSG_OSD_PG_PUSH_REPLY
);

866 
pg_sh¬d_t
 
äom
 = 
m
->from;

868 
veùÜ
<
PushOp
> 
	`»¶›s
(1);

869 
veùÜ
<
PushR•lyOp
>::
cÚ¡_™”©Ü
 
i
 = 
m
->
»¶›s
.
	`begš
();

870 
i
 !ğ
m
->
»¶›s
.
	`’d
();

871 ++
i
) {

872 
boŞ
 
mÜe
 = 
	`hªdË_push_»¶y
(
äom
, *
i
, &(
»¶›s
.
	`back
()));

873 ià(
mÜe
)

874 
»¶›s
.
	`push_back
(
	`PushOp
());

876 
»¶›s
.
	`”a£
Ô•l›s.
	`’d
() - 1);

878 
m­
<
pg_sh¬d_t
, 
veùÜ
<
PushOp
> > 
_»¶›s
;

879 
_»¶›s
[
äom
].
	`sw­
(
»¶›s
);

880 
	`£nd_pushes
(
m
->
	`g‘_´iÜ™y
(), 
_»¶›s
);

881 
	}
}

883 
Mes§ge
 * 
	gR•liÿ‹dBack’d
::
g’”©e_subİ
(

884 cÚ¡ 
hobjeù_t
 &
soid
,

885 cÚ¡ 
ev”siÚ_t
 &
©_v”siÚ
,

886 
ûph_tid_t
 
tid
,

887 
osd_»qid_t
 
»qid
,

888 
ev”siÚ_t
 
pg_Œim_to
,

889 
ev”siÚ_t
 
pg_rŞl_fÜw¬d_to
,

890 
hobjeù_t
 
Ãw_‹mp_oid
,

891 
hobjeù_t
 
disÿrd_‹mp_oid
,

892 cÚ¡ 
bufã¾i¡
 &
log_’Œ›s
,

893 
boo¡
::
İtiÚ®
<
pg_h™_£t_hi¡Üy_t
> &
h£t_hi¡
,

894 
ObjeùStÜe
::
T¿n§ùiÚ
 &
İ_t
,

895 
pg_sh¬d_t
 
³”
,

896 cÚ¡ 
pg_šfo_t
 &
pšfo
)

898 
	gacks_wª‹d
 = 
CEPH_OSD_FLAG_ACK
 | 
CEPH_OSD_FLAG_ONDISK
;

900 
MOSDR•Op
 *
	gwr
 = 
Ãw
 MOSDRepOp(

901 
»qid
, 
·»Á
->
whßmi_sh¬d
(),

902 
¥g_t
(
g‘_šfo
().
pgid
.pgid, 
³”
.
sh¬d
),

903 
soid
, 
acks_wª‹d
,

904 
g‘_osdm­
()->
g‘_•och
(),

905 
·»Á
->
g‘_Ï¡_³”šg_»£t_•och
(),

906 
tid
, 
©_v”siÚ
);

909 ià(!
	g·»Á
->
should_£nd_İ
(
³”
, 
soid
)) {

910 
	gObjeùStÜe
::
T¿n§ùiÚ
 
t
;

911 
’code
(
t
, 
wr
->
g‘_d©a
());

913 
’code
(
İ_t
, 
wr
->
g‘_d©a
());

914 
	gwr
->
g‘_h—d”
().
	gd©a_off
 = 
İ_t
.
g‘_d©a_®ignm’t
();

917 
	gwr
->
	glogbl
 = 
log_’Œ›s
;

919 ià(
	gpšfo
.
is_šcom¶‘e
())

920 
	gwr
->
	gpg_¡©s
 = 
pšfo
.
¡©s
;

922 
	gwr
->
	gpg_¡©s
 = 
g‘_šfo
().
¡©s
;

924 
	gwr
->
	gpg_Œim_to
 = 
pg_Œim_to
;

925 
	gwr
->
	gpg_rŞl_fÜw¬d_to
 = 
pg_rŞl_fÜw¬d_to
;

927 
	gwr
->
	gÃw_‹mp_oid
 = 
Ãw_‹mp_oid
;

928 
	gwr
->
	gdisÿrd_‹mp_oid
 = 
disÿrd_‹mp_oid
;

929 
	gwr
->
	gupd©ed_h™_£t_hi¡Üy
 = 
h£t_hi¡
;

930  
	gwr
;

933 
	gR•liÿ‹dBack’d
::
issue_İ
(

934 cÚ¡ 
hobjeù_t
 &
soid
,

935 cÚ¡ 
ev”siÚ_t
 &
©_v”siÚ
,

936 
ûph_tid_t
 
tid
,

937 
osd_»qid_t
 
»qid
,

938 
ev”siÚ_t
 
pg_Œim_to
,

939 
ev”siÚ_t
 
pg_rŞl_fÜw¬d_to
,

940 
hobjeù_t
 
Ãw_‹mp_oid
,

941 
hobjeù_t
 
disÿrd_‹mp_oid
,

942 cÚ¡ 
veùÜ
<
pg_log_’Œy_t
> &
log_’Œ›s
,

943 
boo¡
::
İtiÚ®
<
pg_h™_£t_hi¡Üy_t
> &
h£t_hi¡
,

944 
InProg»ssOp
 *
İ
,

945 
ObjeùStÜe
::
T¿n§ùiÚ
 &
İ_t
)

947 ià(
·»Á
->
g‘_aùšg_»cov”y_backfl_sh¬ds
().
size
() > 1) {

948 ià(
İ
->op) {

949 
İ
->İ->
pg_Œaû
.
ev’t
("issue„eplication ops");

950 
o¡ršg¡»am
 
	gss
;

951 
	g£t
<
	gpg_sh¬d_t
> 
	g»¶iÿs
 = 
·»Á
->
g‘_aùšg_»cov”y_backfl_sh¬ds
();

952 
	g»¶iÿs
.
”a£
(
·»Á
->
whßmi_sh¬d
());

953 
	gss
 << "wa™šg fÜ subİ äom " << 
	g»¶iÿs
;

954 
	gİ
->İ->
m¬k_sub_İ_£Á
(
ss
.
¡r
());

958 
bufã¾i¡
 
	glogs
;

959 
’code
(
log_’Œ›s
, 
logs
);

961 cÚ¡‡uto& 
	gsh¬d
 : 
g‘_·»Á
()->
g‘_aùšg_»cov”y_backfl_sh¬ds
()) {

962 ià(
sh¬d
 =ğ
·»Á
->
whßmi_sh¬d
()) ;

963 cÚ¡ 
	gpg_šfo_t
 &
	gpšfo
 = 
·»Á
->
g‘_sh¬d_šfo
().
fšd
(
sh¬d
)->
£cÚd
;

965 
Mes§ge
 *
	gwr
;

966 
	gwr
 = 
g’”©e_subİ
(

967 
soid
,

968 
©_v”siÚ
,

969 
tid
,

970 
»qid
,

971 
pg_Œim_to
,

972 
pg_rŞl_fÜw¬d_to
,

973 
Ãw_‹mp_oid
,

974 
disÿrd_‹mp_oid
,

975 
logs
,

976 
h£t_hi¡
,

977 
İ_t
,

978 
sh¬d
,

979 
pšfo
);

980 ià(
	gİ
->İ && op->İ->
	gpg_Œaû
)

981 
	gwr
->
	gŒaû
.
š™
("»¶iÿ‹d op", 
nuÎ±r
, &
İ
->İ->
pg_Œaû
);

982 
g‘_·»Á
()->
£nd_mes§ge_osd_şu¡”
(

983 
sh¬d
.
osd
, 
wr
, 
g‘_osdm­
()->
g‘_•och
());

989 
	gR•liÿ‹dBack’d
::
	$do_»pİ
(
OpReque¡Ref
 
İ
)

991 
¡©ic_ÿ¡
<
MOSDR•Op
*>(
İ
->
	`g‘_nÚcÚ¡_»q
())->
	`fšish_decode
();

992 cÚ¡ 
MOSDR•Op
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDR•O°*>(
İ
->
	`g‘_»q
());

993 
msg_ty³
 = 
m
->
	`g‘_ty³
();

994 
	`as£¹
(
MSG_OSD_REPOP
 =ğ
msg_ty³
);

996 cÚ¡ 
hobjeù_t
& 
soid
 = 
m
->
poid
;

998 
	`dout
(10è<< 
__func__
 << " " << 
soid


999 << " v " << 
m
->
v”siÚ


1000 << (
m
->
logbl
.
	`Ëngth
() ? " (transaction)" : " (parallelƒxec")

1001 << " " << 
m
->
logbl
.
	`Ëngth
()

1002 << 
d’dl
;

1005 
	`as£¹
(
m
->
m­_•och
 >ğ
	`g‘_šfo
().
hi¡Üy
.
§me_š‹rv®_sšû
);

1007 
	`dout
(30è<< 
__func__
 << " missšg befÜ" << 
	`g‘_·»Á
()->
	`g‘_log
().
	`g‘_missšg
().
	`g‘_™ems
(è<< 
d’dl
;

1008 
·»Á
->
	`maybe_´“m±_»¶iÿ_süub
(
soid
);

1010 
ack”osd
 = 
m
->
	`g‘_sourû
().
	`num
();

1012 
İ
->
	`m¬k_¡¬‹d
();

1014 
R•ModifyRef
 
	`rm
(
¡d
::
make_sh¬ed
<
R•Modify
>());

1015 
rm
->
İ
 = op;

1016 
rm
->
ack”osd
 =‡ckerosd;

1017 
rm
->
Ï¡_com¶‘e
 = 
	`g‘_šfo
().last_complete;

1018 
rm
->
•och_¡¬‹d
 = 
	`g‘_osdm­
()->
	`g‘_•och
();

1020 
	`as£¹
(
m
->
logbl
.
	`Ëngth
());

1022 
veùÜ
<
pg_log_’Œy_t
> 
log
;

1024 
bufã¾i¡
::
™”©Ü
 
p
 = 
cÚ¡_ÿ¡
<bufã¾i¡&>(
m
->
	`g‘_d©a
()).
	`begš
();

1025 
	`decode
(
rm
->
İt
, 
p
);

1027 ià(
m
->
Ãw_‹mp_oid
 !ğ
	`hobjeù_t
()) {

1028 
	`dout
(20è<< 
__func__
 << " s¹¿ckšgem°" << 
m
->
Ãw_‹mp_oid
 << 
d’dl
;

1029 
	`add_‹mp_obj
(
m
->
Ãw_‹mp_oid
);

1031 ià(
m
->
disÿrd_‹mp_oid
 !ğ
	`hobjeù_t
()) {

1032 
	`dout
(20è<< 
__func__
 << " stİ¿ckšgem°" << 
m
->
disÿrd_‹mp_oid
 << 
d’dl
;

1033 ià(
rm
->
İt
.
	`em±y
()) {

1034 
	`dout
(10è<< 
__func__
 << ":„emovšg objeù " << 
m
->
disÿrd_‹mp_oid


1035 << " sšû wwÚ'ˆg‘hŒª§ùiÚ" << 
d’dl
;

1036 
rm
->
loÿÉ
.
	`»move
(
cŞl
, 
	`ghobjeù_t
(
m
->
disÿrd_‹mp_oid
));

1038 
	`ş—r_‹mp_obj
(
m
->
disÿrd_‹mp_oid
);

1041 
p
 = 
cÚ¡_ÿ¡
<
bufã¾i¡
&>(
m
->
logbl
).
	`begš
();

1042 
	`decode
(
log
, 
p
);

1043 
rm
->
İt
.
	`£t_çdvi£_æag
(
CEPH_OSD_OP_FLAG_FADVISE_DONTNEED
);

1045 
boŞ
 
upd©e_¢­s
 = 
çl£
;

1046 ià(!
rm
->
İt
.
	`em±y
()) {

1051 
upd©e_¢­s
 = 
Œue
;

1054 
pg_missšg_Œack”_t
 
pmissšg
 = 
	`g‘_·»Á
()->
	`g‘_loÿl_missšg
();

1055 ià(
pmissšg
.
	`is_missšg
(
soid
)) {

1056 
	`dout
(30è<< 
__func__
 << " is_missšg " << 
pmissšg
.
	`is_missšg
(
soid
è<< 
d’dl
;

1057 autØ&&
e
: 
log
) {

1058 
	`dout
(30è<< "‡dd_Ãxt_ev’ˆ’Œy " << 
e
 << 
d’dl
;

1059 
	`g‘_·»Á
()->
	`add_loÿl_Ãxt_ev’t
(
e
);

1060 
	`dout
(30è<< "ƒÁry is_d–‘" << 
e
.
	`is_d–‘e
(è<< 
d’dl
;

1064 
·»Á
->
	`upd©e_¡©s
(
m
->
pg_¡©s
);

1065 
·»Á
->
	`log_İ”©iÚ
(

1066 
log
,

1067 
m
->
upd©ed_h™_£t_hi¡Üy
,

1068 
m
->
pg_Œim_to
,

1069 
m
->
pg_rŞl_fÜw¬d_to
,

1070 
upd©e_¢­s
,

1071 
rm
->
loÿÉ
);

1073 
rm
->
İt
.
	`»gi¡”_Ú_comm™
(

1074 
·»Á
->
	`bËss_cÚ‹xt
(

1075 
Ãw
 
	`C_OSD_R•ModifyComm™
(
this
, 
rm
)));

1076 
veùÜ
<
ObjeùStÜe
::
T¿n§ùiÚ
> 
s
;

1077 
s
.
	`»£rve
(2);

1078 
s
.
	`push_back
(
¡d
::
	`move
(
rm
->
loÿÉ
));

1079 
s
.
	`push_back
(
¡d
::
	`move
(
rm
->
İt
));

1080 
·»Á
->
	`queue_Œª§ùiÚs
(
s
, 
İ
);

1082 
	`dout
(30è<< 
__func__
 << " missšg‡á”" << 
	`g‘_·»Á
()->
	`g‘_log
().
	`g‘_missšg
().
	`g‘_™ems
(è<< 
d’dl
;

1083 
	}
}

1085 
	gR•liÿ‹dBack’d
::
	$»pİ_comm™
(
R•ModifyRef
 
rm
)

1087 
rm
->
İ
->
	`m¬k_comm™_£Á
();

1088 
rm
->
İ
->
pg_Œaû
.
	`ev’t
("sup_op_commit");

1089 
rm
->
comm™‹d
 = 
Œue
;

1092 cÚ¡ 
MOSDR•Op
 *
m
 = 
¡©ic_ÿ¡
<cÚ¡ MOSDR•Op*>(
rm
->
İ
->
	`g‘_»q
());

1093 
	`as£¹
(
m
->
	`g‘_ty³
(è=ğ
MSG_OSD_REPOP
);

1094 
	`dout
(10è<< 
__func__
 << " oÀİ " << *
m


1095 << ", s’dšg comm™Øosd." << 
rm
->
ack”osd


1096 << 
d’dl
;

1097 
	`as£¹
(
	`g‘_osdm­
()->
	`is_up
(
rm
->
ack”osd
));

1099 
	`g‘_·»Á
()->
	`upd©e_Ï¡_com¶‘e_Údisk
(
rm
->
Ï¡_com¶‘e
);

1101 
MOSDR•OpR•ly
 *
»¶y
 = 
Ãw
 
	`MOSDR•OpR•ly
(

1102 
m
,

1103 
	`g‘_·»Á
()->
	`whßmi_sh¬d
(),

1104 0, 
	`g‘_osdm­
()->
	`g‘_•och
(), 
m
->
	`g‘_mš_•och
(), 
CEPH_OSD_FLAG_ONDISK
);

1105 
»¶y
->
	`£t_Ï¡_com¶‘e_Údisk
(
rm
->
Ï¡_com¶‘e
);

1106 
»¶y
->
	`£t_´iÜ™y
(
CEPH_MSG_PRIO_HIGH
);

1107 
»¶y
->
Œaû
 = 
rm
->
İ
->
pg_Œaû
;

1108 
	`g‘_·»Á
()->
	`£nd_mes§ge_osd_şu¡”
(

1109 
rm
->
ack”osd
, 
»¶y
, 
	`g‘_osdm­
()->
	`g‘_•och
());

1111 
	`log_subİ_¡©s
(
	`g‘_·»Á
()->
	`g‘_logg”
(), 
rm
->
İ
, 
l_osd_sİ_w
);

1112 
	}
}

1117 
	gR•liÿ‹dBack’d
::
ÿlc_h—d_sub£ts
(

1118 
ObjeùCÚ‹xtRef
 
obc
, 
SÇpS‘
& 
¢­£t
, cÚ¡ 
hobjeù_t
& 
h—d
,

1119 cÚ¡ 
pg_missšg_t
& 
missšg
,

1120 cÚ¡ 
hobjeù_t
 &
Ï¡_backfl
,

1121 
š‹rv®_£t
<
ušt64_t
>& 
d©a_sub£t
,

1122 
m­
<
hobjeù_t
, 
š‹rv®_£t
<
ušt64_t
>>& 
şÚe_sub£ts
,

1123 
ObcLockMªag”
 &
mªag”
)

1125 
dout
(10è<< "ÿlc_h—d_sub£t " << 
	gh—d


1126 << " clÚe_ov”Ï°" << 
	g¢­£t
.
	gşÚe_ov”Ïp
 << 
	gd’dl
;

1128 
ušt64_t
 
	gsize
 = 
obc
->
obs
.
oi
.
size
;

1129 ià(
	gsize
)

1130 
	gd©a_sub£t
.
š£¹
(0, 
size
);

1132 ià(
g‘_·»Á
()->
g‘_poŞ
().
®low_šcom¶‘e_şÚes
()) {

1133 
dout
(10è<< 
	g__func__
 << ": cachšg (wasè’abËd, skpšg clÚsub£ts" << 
	gd’dl
;

1137 ià(!
	gcù
->
	g_cÚf
->
	gosd_»cov”_şÚe_ov”Ïp
) {

1138 
dout
(10è<< "ÿlc_h—d_sub£t " << 
	gh—d
 << " -- osd_»cov”_şÚe_ov”Ï°di§bËd" << 
	gd’dl
;

1143 
	gš‹rv®_£t
<
	gušt64_t
> 
	gşÚšg
;

1144 
	gš‹rv®_£t
<
	gušt64_t
> 
	g´ev
;

1145 ià(
	gsize
)

1146 
	g´ev
.
š£¹
(0, 
size
);

1148 
	gj
=
¢­£t
.
şÚes
.
size
()-1; j>=0; j--) {

1149 
hobjeù_t
 
	gc
 = 
h—d
;

1150 
	gc
.
	g¢­
 = 
¢­£t
.
şÚes
[
j
];

1151 
	g´ev
.
š‹r£ùiÚ_of
(
¢­£t
.
şÚe_ov”Ïp
[¢­£t.
şÚes
[
j
]]);

1152 ià(!
	gmissšg
.
is_missšg
(
c
) &&

1153 
	gc
 < 
	gÏ¡_backfl
 &&

1154 
g‘_·»Á
()->
Œy_lock_fÜ_»ad
(
c
, 
mªag”
)) {

1155 
dout
(10è<< "ÿlc_h—d_sub£t " << 
	gh—d
 << " ha ´ev " << 
	gc


1156 << " ov”Ï°" << 
	g´ev
 << 
	gd’dl
;

1157 
	gşÚe_sub£ts
[
c
] = 
´ev
;

1158 
	gşÚšg
.
uniÚ_of
(
´ev
);

1161 
dout
(10è<< "ÿlc_h—d_sub£t " << 
	gh—d
 << " dÛ nÙ hav´ev " << 
	gc


1162 << " ov”Ï°" << 
	g´ev
 << 
	gd’dl
;

1166 ià(
	gşÚšg
.
num_š‹rv®s
(è> 
	gcù
->
	g_cÚf
->
	gosd_»cov”_şÚe_ov”Ïp_lim™
) {

1167 
dout
(10è<< "skpšg clÚe,oØmªy hŞes" << 
	gd’dl
;

1168 
g‘_·»Á
()->
»Ëa£_locks
(
mªag”
);

1169 
	gşÚe_sub£ts
.
ş—r
();

1170 
	gşÚšg
.
ş—r
();

1174 
	gd©a_sub£t
.
subŒaù
(
şÚšg
);

1176 
dout
(10è<< "ÿlc_h—d_sub£t " << 
	gh—d


1177 << " d©a_sub£ˆ" << 
	gd©a_sub£t


1178 << " clÚe_sub£t " << 
	gşÚe_sub£ts
 << 
	gd’dl
;

1181 
	gR•liÿ‹dBack’d
::
ÿlc_şÚe_sub£ts
(

1182 
SÇpS‘
& 
¢­£t
, cÚ¡ 
hobjeù_t
& 
soid
,

1183 cÚ¡ 
pg_missšg_t
& 
missšg
,

1184 cÚ¡ 
hobjeù_t
 &
Ï¡_backfl
,

1185 
š‹rv®_£t
<
ušt64_t
>& 
d©a_sub£t
,

1186 
m­
<
hobjeù_t
, 
š‹rv®_£t
<
ušt64_t
>>& 
şÚe_sub£ts
,

1187 
ObcLockMªag”
 &
mªag”
)

1189 
dout
(10è<< "ÿlc_şÚe_sub£t " << 
	gsoid


1190 << " clÚe_ov”Ï°" << 
	g¢­£t
.
	gşÚe_ov”Ïp
 << 
	gd’dl
;

1192 
ušt64_t
 
	gsize
 = 
¢­£t
.
şÚe_size
[
soid
.
¢­
];

1193 ià(
	gsize
)

1194 
	gd©a_sub£t
.
š£¹
(0, 
size
);

1196 ià(
g‘_·»Á
()->
g‘_poŞ
().
®low_šcom¶‘e_şÚes
()) {

1197 
dout
(10è<< 
	g__func__
 << ": cachšg (wasè’abËd, skpšg clÚsub£ts" << 
	gd’dl
;

1201 ià(!
	gcù
->
	g_cÚf
->
	gosd_»cov”_şÚe_ov”Ïp
) {

1202 
dout
(10è<< "ÿlc_şÚe_sub£t " << 
	gsoid
 << " -- osd_»cov”_şÚe_ov”Ï°di§bËd" << 
	gd’dl
;

1206 
	gi
;

1207 
	gi
=0; i < 
	g¢­£t
.
	gşÚes
.
size
(); i++)

1208 ià(
	g¢­£t
.
	gşÚes
[
i
] =ğ
soid
.
¢­
)

1212 
	gš‹rv®_£t
<
	gušt64_t
> 
	gşÚšg
;

1213 
	gš‹rv®_£t
<
	gušt64_t
> 
	g´ev
;

1214 ià(
	gsize
)

1215 
	g´ev
.
š£¹
(0, 
size
);

1216 
	gj
=
i
-1; j>=0; j--) {

1217 
hobjeù_t
 
	gc
 = 
soid
;

1218 
	gc
.
	g¢­
 = 
¢­£t
.
şÚes
[
j
];

1219 
	g´ev
.
š‹r£ùiÚ_of
(
¢­£t
.
şÚe_ov”Ïp
[¢­£t.
şÚes
[
j
]]);

1220 ià(!
	gmissšg
.
is_missšg
(
c
) &&

1221 
	gc
 < 
	gÏ¡_backfl
 &&

1222 
g‘_·»Á
()->
Œy_lock_fÜ_»ad
(
c
, 
mªag”
)) {

1223 
dout
(10è<< "ÿlc_şÚe_sub£t " << 
	gsoid
 << " ha ´ev " << 
	gc


1224 << " ov”Ï°" << 
	g´ev
 << 
	gd’dl
;

1225 
	gşÚe_sub£ts
[
c
] = 
´ev
;

1226 
	gşÚšg
.
uniÚ_of
(
´ev
);

1229 
dout
(10è<< "ÿlc_şÚe_sub£t " << 
	gsoid
 << " dÛ nÙ hav´ev " << 
	gc


1230 << " ov”Ï°" << 
	g´ev
 << 
	gd’dl
;

1234 
	gš‹rv®_£t
<
	gušt64_t
> 
	gÃxt
;

1235 ià(
	gsize
)

1236 
	gÃxt
.
š£¹
(0, 
size
);

1237 
	gj
=
i
+1; j<
	g¢­£t
.
	gşÚes
.
size
(); j++) {

1238 
hobjeù_t
 
	gc
 = 
soid
;

1239 
	gc
.
	g¢­
 = 
¢­£t
.
şÚes
[
j
];

1240 
	gÃxt
.
š‹r£ùiÚ_of
(
¢­£t
.
şÚe_ov”Ïp
[¢­£t.
şÚes
[
j
-1]]);

1241 ià(!
	gmissšg
.
is_missšg
(
c
) &&

1242 
	gc
 < 
	gÏ¡_backfl
 &&

1243 
g‘_·»Á
()->
Œy_lock_fÜ_»ad
(
c
, 
mªag”
)) {

1244 
dout
(10è<< "ÿlc_şÚe_sub£t " << 
	gsoid
 << " ha Ãxˆ" << 
	gc


1245 << " ov”Ï°" << 
	gÃxt
 << 
	gd’dl
;

1246 
	gşÚe_sub£ts
[
c
] = 
Ãxt
;

1247 
	gşÚšg
.
uniÚ_of
(
Ãxt
);

1250 
dout
(10è<< "ÿlc_şÚe_sub£t " << 
	gsoid
 << " dÛ nÙ havÃxˆ" << 
	gc


1251 << " ov”Ï°" << 
	gÃxt
 << 
	gd’dl
;

1254 ià(
	gşÚšg
.
num_š‹rv®s
(è> 
	gcù
->
	g_cÚf
->
	gosd_»cov”_şÚe_ov”Ïp_lim™
) {

1255 
dout
(10è<< "skpšg clÚe,oØmªy hŞes" << 
	gd’dl
;

1256 
g‘_·»Á
()->
»Ëa£_locks
(
mªag”
);

1257 
	gşÚe_sub£ts
.
ş—r
();

1258 
	gşÚšg
.
ş—r
();

1263 
	gd©a_sub£t
.
subŒaù
(
şÚšg
);

1265 
dout
(10è<< "ÿlc_şÚe_sub£t " << 
	gsoid


1266 << " d©a_sub£ˆ" << 
	gd©a_sub£t


1267 << " clÚe_sub£t " << 
	gşÚe_sub£ts
 << 
	gd’dl
;

1270 
	gR•liÿ‹dBack’d
::
	$´•¬e_puÎ
(

1271 
ev”siÚ_t
 
v
,

1272 cÚ¡ 
hobjeù_t
& 
soid
,

1273 
ObjeùCÚ‹xtRef
 
h—dùx
,

1274 
RPGHªdË
 *
h
)

1276 
	`as£¹
(
	`g‘_·»Á
()->
	`g‘_loÿl_missšg
().
	`g‘_™ems
().
	`couÁ
(
soid
));

1277 
ev”siÚ_t
 
_v
 = 
	`g‘_·»Á
()->
	`g‘_loÿl_missšg
().
	`g‘_™ems
().
	`fšd
(

1278 
soid
)->
£cÚd
.
Ãed
;

1279 
	`as£¹
(
_v
 =ğ
v
);

1280 cÚ¡ 
m­
<
hobjeù_t
, 
£t
<
pg_sh¬d_t
>> &
	`missšg_loc
(

1281 
	`g‘_·»Á
()->
	`g‘_missšg_loc_sh¬ds
());

1282 cÚ¡ 
m­
<
pg_sh¬d_t
, 
pg_missšg_t
 > &
	`³”_missšg
(

1283 
	`g‘_·»Á
()->
	`g‘_sh¬d_missšg
());

1284 
m­
<
hobjeù_t
, 
£t
<
pg_sh¬d_t
>>::
cÚ¡_™”©Ü
 
q
 = 
missšg_loc
.
	`fšd
(
soid
);

1285 
	`as£¹
(
q
 !ğ
missšg_loc
.
	`’d
());

1286 
	`as£¹
(!
q
->
£cÚd
.
	`em±y
());

1289 autØ
p
 = 
q
->
£cÚd
.
	`begš
();

1290 
¡d
::
	`advªû
(
p
,

1291 
ut
::
g’”©e_¿ndom_numb”
<>(0,

1292 
q
->
£cÚd
.
	`size
() - 1));

1293 
	`as£¹
(
	`g‘_osdm­
()->
	`is_up
(
p
->
osd
));

1294 
pg_sh¬d_t
 
äomsh¬d
 = *
p
;

1296 
	`dout
(7è<< "puÎ " << 
soid


1297 << " v " << 
v


1298 << " oÀosd " << 
q
->
£cÚd


1299 << " from osd." << 
äomsh¬d


1300 << 
d’dl
;

1302 
	`as£¹
(
³”_missšg
.
	`couÁ
(
äomsh¬d
));

1303 cÚ¡ 
pg_missšg_t
 &
pmissšg
 = 
³”_missšg
.
	`fšd
(
äomsh¬d
)->
£cÚd
;

1304 ià(
pmissšg
.
	`is_missšg
(
soid
, 
v
)) {

1305 
	`as£¹
(
pmissšg
.
	`g‘_™ems
().
	`fšd
(
soid
)->
£cÚd
.
have
 !ğ
v
);

1306 
	`dout
(10è<< "puÎšg soid " << 
soid
 << " from osd " << 
äomsh¬d


1307 << "‡ˆv”siÚ " << 
pmissšg
.
	`g‘_™ems
().
	`fšd
(
soid
)->
£cÚd
.
have


1308 << "„©h”hª‡ˆv”siÚ " << 
v
 << 
d’dl
;

1309 
v
 = 
pmissšg
.
	`g‘_™ems
().
	`fšd
(
soid
)->
£cÚd
.
have
;

1310 
	`as£¹
(
	`g‘_·»Á
()->
	`g‘_log
().g‘_log().
objeùs
.
	`couÁ
(
soid
) &&

1311 (
	`g‘_·»Á
()->
	`g‘_log
().g‘_log().
objeùs
.
	`fšd
(
soid
)->
£cÚd
->
İ
 ==

1312 
pg_log_’Œy_t
::
LOST_REVERT
) &&

1313 (
	`g‘_·»Á
()->
	`g‘_log
().g‘_log().
objeùs
.
	`fšd
(

1314 
soid
)->
£cÚd
->
»v”tšg_to
 ==

1315 
v
));

1318 
ObjeùRecov”yInfo
 
»cov”y_šfo
;

1319 
ObcLockMªag”
 
lock_mªag”
;

1321 ià(
soid
.
	`is_¢­
()) {

1322 
	`as£¹
(!
	`g‘_·»Á
()->
	`g‘_loÿl_missšg
().
	`is_missšg
(
soid
.
	`g‘_h—d
()));

1323 
	`as£¹
(
h—dùx
);

1325 
SÇpS‘CÚ‹xt
 *
ssc
 = 
h—dùx
->ssc;

1326 
	`as£¹
(
ssc
);

1327 
	`dout
(10è<< " sÇp£ˆ" << 
ssc
->
¢­£t
 << 
d’dl
;

1328 
»cov”y_šfo
.
ss
 = 
ssc
->
¢­£t
;

1329 
	`ÿlc_şÚe_sub£ts
(

1330 
ssc
->
¢­£t
, 
soid
, 
	`g‘_·»Á
()->
	`g‘_loÿl_missšg
(),

1331 
	`g‘_šfo
().
Ï¡_backfl
,

1332 
»cov”y_šfo
.
cİy_sub£t
,

1333 
»cov”y_šfo
.
şÚe_sub£t
,

1334 
lock_mªag”
);

1336 
	`dout
(10è<< "…uÎšg " << 
»cov”y_šfo
 << 
d’dl
;

1338 
	`as£¹
(
ssc
->
¢­£t
.
şÚe_size
.
	`couÁ
(
soid
.
¢­
));

1339 
»cov”y_šfo
.
size
 = 
ssc
->
¢­£t
.
şÚe_size
[
soid
.
¢­
];

1343 
»cov”y_šfo
.
cİy_sub£t
.
	`š£¹
(0, (
ušt64_t
)-1);

1344 
»cov”y_šfo
.
size
 = ((
ušt64_t
)-1);

1347 
h
->
puÎs
[
äomsh¬d
].
	`push_back
(
	`PuÎOp
());

1348 
PuÎOp
 &
İ
 = 
h
->
puÎs
[
äomsh¬d
].
	`back
();

1349 
İ
.
soid
 = soid;

1351 
İ
.
»cov”y_šfo
 =„ecovery_info;

1352 
İ
.
»cov”y_šfo
.
soid
 = soid;

1353 
İ
.
»cov”y_šfo
.
v”siÚ
 = 
v
;

1354 
İ
.
»cov”y_´og»ss
.
d©a_com¶‘e
 = 
çl£
;

1355 
İ
.
»cov”y_´og»ss
.
om­_com¶‘e
 = 
çl£
;

1356 
İ
.
»cov”y_´og»ss
.
d©a_»cov”ed_to
 = 0;

1357 
İ
.
»cov”y_´og»ss
.
fœ¡
 = 
Œue
;

1359 
	`as£¹
(!
puÎšg
.
	`couÁ
(
soid
));

1360 
puÎ_äom_³”
[
äomsh¬d
].
	`š£¹
(
soid
);

1361 
PuÎInfo
 &
pi
 = 
puÎšg
[
soid
];

1362 
pi
.
äom
 = 
äomsh¬d
;

1363 
pi
.
soid
 = soid;

1364 
pi
.
h—d_ùx
 = 
h—dùx
;

1365 
pi
.
»cov”y_šfo
 = 
İ
.recovery_info;

1366 
pi
.
»cov”y_´og»ss
 = 
İ
.recovery_progress;

1367 
pi
.
ÿche_dÚt_Ãed
 = 
h
->cache_dont_need;

1368 
pi
.
lock_mªag”
 = 
¡d
::
	`move
(lock_manager);

1369 
	}
}

1375 
	gR•liÿ‹dBack’d
::
	$´•_push_to_»¶iÿ
(

1376 
ObjeùCÚ‹xtRef
 
obc
, cÚ¡ 
hobjeù_t
& 
soid
, 
pg_sh¬d_t
 
³”
,

1377 
PushOp
 *
pİ
, 
boŞ
 
ÿche_dÚt_Ãed
)

1379 cÚ¡ 
objeù_šfo_t
& 
oi
 = 
obc
->
obs
.oi;

1380 
ušt64_t
 
size
 = 
obc
->
obs
.
oi
.size;

1382 
	`dout
(10è<< 
__func__
 << ": " << 
soid
 << " v" << 
oi
.
v”siÚ


1383 << " siz" << 
size
 << "Øosd." << 
³”
 << 
d’dl
;

1385 
m­
<
hobjeù_t
, 
š‹rv®_£t
<
ušt64_t
>> 
şÚe_sub£ts
;

1386 
š‹rv®_£t
<
ušt64_t
> 
d©a_sub£t
;

1388 
ObcLockMªag”
 
lock_mªag”
;

1390 ià(
soid
.
¢­
 && soid.¢­ < 
CEPH_NOSNAP
) {

1391 
hobjeù_t
 
h—d
 = 
soid
;

1392 
h—d
.
¢­
 = 
CEPH_NOSNAP
;

1396 ià(
	`g‘_·»Á
()->
	`g‘_loÿl_missšg
().
	`is_missšg
(
h—d
)) {

1397 
	`dout
(15è<< "push_to_»¶iÿ missšg h—d " << 
h—d
 << ",…ushšg„aw clÚe" << 
d’dl
;

1398  
	`´•_push
(
obc
, 
soid
, 
³”
, 
pİ
, 
ÿche_dÚt_Ãed
);

1401 
SÇpS‘CÚ‹xt
 *
ssc
 = 
obc
->ssc;

1402 
	`as£¹
(
ssc
);

1403 
	`dout
(15è<< "push_to_»¶iÿ sÇp£ˆi " << 
ssc
->
¢­£t
 << 
d’dl
;

1404 
pİ
->
»cov”y_šfo
.
ss
 = 
ssc
->
¢­£t
;

1405 
m­
<
pg_sh¬d_t
, 
pg_missšg_t
>::
cÚ¡_™”©Ü
 
pm
 =

1406 
	`g‘_·»Á
()->
	`g‘_sh¬d_missšg
().
	`fšd
(
³”
);

1407 
	`as£¹
(
pm
 !ğ
	`g‘_·»Á
()->
	`g‘_sh¬d_missšg
().
	`’d
());

1408 
m­
<
pg_sh¬d_t
, 
pg_šfo_t
>::
cÚ¡_™”©Ü
 
pi
 =

1409 
	`g‘_·»Á
()->
	`g‘_sh¬d_šfo
().
	`fšd
(
³”
);

1410 
	`as£¹
(
pi
 !ğ
	`g‘_·»Á
()->
	`g‘_sh¬d_šfo
().
	`’d
());

1411 
	`ÿlc_şÚe_sub£ts
(

1412 
ssc
->
¢­£t
, 
soid
,

1413 
pm
->
£cÚd
,

1414 
pi
->
£cÚd
.
Ï¡_backfl
,

1415 
d©a_sub£t
, 
şÚe_sub£ts
,

1416 
lock_mªag”
);

1417 } ià(
soid
.
¢­
 =ğ
CEPH_NOSNAP
) {

1420 
SÇpS‘CÚ‹xt
 *
ssc
 = 
obc
->ssc;

1421 
	`as£¹
(
ssc
);

1422 
	`dout
(15è<< "push_to_»¶iÿ sÇp£ˆi " << 
ssc
->
¢­£t
 << 
d’dl
;

1423 
	`ÿlc_h—d_sub£ts
(

1424 
obc
,

1425 
ssc
->
¢­£t
, 
soid
, 
	`g‘_·»Á
()->
	`g‘_sh¬d_missšg
().
	`fšd
(
³”
)->
£cÚd
,

1426 
	`g‘_·»Á
()->
	`g‘_sh¬d_šfo
().
	`fšd
(
³”
)->
£cÚd
.
Ï¡_backfl
,

1427 
d©a_sub£t
, 
şÚe_sub£ts
,

1428 
lock_mªag”
);

1431  
	`´•_push
(

1432 
obc
,

1433 
soid
,

1434 
³”
,

1435 
oi
.
v”siÚ
,

1436 
d©a_sub£t
,

1437 
şÚe_sub£ts
,

1438 
pİ
,

1439 
ÿche_dÚt_Ãed
,

1440 
¡d
::
	`move
(
lock_mªag”
));

1441 
	}
}

1443 
	gR•liÿ‹dBack’d
::
	$´•_push
(
ObjeùCÚ‹xtRef
 
obc
,

1444 cÚ¡ 
hobjeù_t
& 
soid
, 
pg_sh¬d_t
 
³”
,

1445 
PushOp
 *
pİ
, 
boŞ
 
ÿche_dÚt_Ãed
)

1447 
š‹rv®_£t
<
ušt64_t
> 
d©a_sub£t
;

1448 ià(
obc
->
obs
.
oi
.
size
)

1449 
d©a_sub£t
.
	`š£¹
(0, 
obc
->
obs
.
oi
.
size
);

1450 
m­
<
hobjeù_t
, 
š‹rv®_£t
<
ušt64_t
>> 
şÚe_sub£ts
;

1452  
	`´•_push
(
obc
, 
soid
, 
³”
,

1453 
obc
->
obs
.
oi
.
v”siÚ
, 
d©a_sub£t
, 
şÚe_sub£ts
,

1454 
pİ
, 
ÿche_dÚt_Ãed
, 
	`ObcLockMªag”
());

1455 
	}
}

1457 
	gR•liÿ‹dBack’d
::
´•_push
(

1458 
ObjeùCÚ‹xtRef
 
obc
,

1459 cÚ¡ 
hobjeù_t
& 
soid
, 
pg_sh¬d_t
 
³”
,

1460 
ev”siÚ_t
 
v”siÚ
,

1461 
š‹rv®_£t
<
ušt64_t
> &
d©a_sub£t
,

1462 
m­
<
hobjeù_t
, 
š‹rv®_£t
<
ušt64_t
>>& 
şÚe_sub£ts
,

1463 
PushOp
 *
pİ
,

1464 
boŞ
 
ÿche_dÚt_Ãed
,

1465 
ObcLockMªag”
 &&
lock_mªag”
)

1467 
g‘_·»Á
()->
begš_³”_»cov”
(
³”
, 
soid
);

1469 
	gPushInfo
 &
	gpi
 = 
pushšg
[
soid
][
³”
];

1470 
	gpi
.
	gobc
 = 
obc
;

1471 
	gpi
.
	g»cov”y_šfo
.
	gsize
 = 
obc
->
obs
.
oi
.
size
;

1472 
	gpi
.
	g»cov”y_šfo
.
	gcİy_sub£t
 = 
d©a_sub£t
;

1473 
	gpi
.
	g»cov”y_šfo
.
	gşÚe_sub£t
 = 
şÚe_sub£ts
;

1474 
	gpi
.
	g»cov”y_šfo
.
	gsoid
 = 
soid
;

1475 
	gpi
.
	g»cov”y_šfo
.
	goi
 = 
obc
->
obs
.
oi
;

1476 
	gpi
.
	g»cov”y_šfo
.
	gss
 = 
pİ
->
»cov”y_šfo
.
ss
;

1477 
	gpi
.
	g»cov”y_šfo
.
	gv”siÚ
 = 
v”siÚ
;

1478 
	gpi
.
	glock_mªag”
 = 
¡d
::
move
(
lock_mªag”
);

1480 
ObjeùRecov”yProg»ss
 
	gÃw_´og»ss
;

1481 
	gr
 = 
bud_push_İ
(
pi
.
»cov”y_šfo
,

1482 
pi
.
»cov”y_´og»ss
,

1483 &
Ãw_´og»ss
,

1484 
pİ
,

1485 &(
pi
.
¡©
), 
ÿche_dÚt_Ãed
);

1486 ià(
	gr
 < 0)

1487  
	gr
;

1488 
	gpi
.
	g»cov”y_´og»ss
 = 
Ãw_´og»ss
;

1492 
	gR•liÿ‹dBack’d
::
subm™_push_d©a
(

1493 cÚ¡ 
ObjeùRecov”yInfo
 &
»cov”y_šfo
,

1494 
boŞ
 
fœ¡
,

1495 
boŞ
 
com¶‘e
,

1496 
boŞ
 
ÿche_dÚt_Ãed
,

1497 cÚ¡ 
š‹rv®_£t
<
ušt64_t
> &
š‹rv®s_šşuded
,

1498 
bufã¾i¡
 
d©a_šşuded
,

1499 
bufã¾i¡
 
om­_h—d”
,

1500 cÚ¡ 
m­
<
¡ršg
, 
bufã¾i¡
> &
©Œs
,

1501 cÚ¡ 
m­
<
¡ršg
, 
bufã¾i¡
> &
om­_’Œ›s
,

1502 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

1504 
hobjeù_t
 
rg‘_oid
;

1505 ià(
	gfœ¡
 && 
	gcom¶‘e
) {

1506 
	grg‘_oid
 = 
»cov”y_šfo
.
soid
;

1508 
	grg‘_oid
 = 
g‘_·»Á
()->
g‘_‹mp_»cov”y_objeù
(
»cov”y_šfo
.
soid
,

1509 
»cov”y_šfo
.
v”siÚ
);

1510 ià(
	gfœ¡
) {

1511 
dout
(10è<< 
	g__func__
 << ": Adding oid "

1512 << 
	grg‘_oid
 << " iÀth‹m°cŞËùiÚ" << 
	gd’dl
;

1513 
add_‹mp_obj
(
rg‘_oid
);

1517 ià(
	gfœ¡
) {

1518 
	gt
->
»move
(
cŞl
, 
ghobjeù_t
(
rg‘_oid
));

1519 
	gt
->
touch
(
cŞl
, 
ghobjeù_t
(
rg‘_oid
));

1520 
	gt
->
Œunÿ‹
(
cŞl
, 
ghobjeù_t
(
rg‘_oid
), 
»cov”y_šfo
.
size
);

1521 ià(
	gom­_h—d”
.
Ëngth
())

1522 
	gt
->
om­_£th—d”
(
cŞl
, 
ghobjeù_t
(
rg‘_oid
), 
om­_h—d”
);

1524 
bufã¾i¡
 
	gbv
 = 
©Œs
.
©
(
OI_ATTR
);

1525 
objeù_šfo_t
 
oi
(
bv
);

1526 
	gt
->
£t_®loc_hšt
(
cŞl
, 
ghobjeù_t
(
rg‘_oid
),

1527 
oi
.
ex³ùed_objeù_size
,

1528 
oi
.
ex³ùed_wr™e_size
,

1529 
oi
.
®loc_hšt_æags
);

1531 
ušt64_t
 
	goff
 = 0;

1532 
ušt32_t
 
	gçdvi£_æags
 = 
CEPH_OSD_OP_FLAG_FADVISE_SEQUENTIAL
;

1533 ià(
	gÿche_dÚt_Ãed
)

1534 
	gçdvi£_æags
 |ğ
CEPH_OSD_OP_FLAG_FADVISE_DONTNEED
;

1535 
	gš‹rv®_£t
<
	gušt64_t
>::
cÚ¡_™”©Ü
 
p
 = 
š‹rv®s_šşuded
.
begš
();

1536 
	gp
 !ğ
š‹rv®s_šşuded
.
’d
();

1537 ++
	gp
) {

1538 
bufã¾i¡
 
	gb™
;

1539 
	gb™
.
sub¡r_of
(
d©a_šşuded
, 
off
, 
p
.
g‘_Ën
());

1540 
	gt
->
wr™e
(
cŞl
, 
ghobjeù_t
(
rg‘_oid
),

1541 
p
.
g‘_¡¬t
(),….
g‘_Ën
(), 
b™
, 
çdvi£_æags
);

1542 
	goff
 +ğ
p
.
g‘_Ën
();

1545 ià(!
	gom­_’Œ›s
.
em±y
())

1546 
	gt
->
om­_£tkeys
(
cŞl
, 
ghobjeù_t
(
rg‘_oid
), 
om­_’Œ›s
);

1547 ià(!
	g©Œs
.
em±y
())

1548 
	gt
->
£‰rs
(
cŞl
, 
ghobjeù_t
(
rg‘_oid
), 
©Œs
);

1550 ià(
	gcom¶‘e
) {

1551 ià(!
	gfœ¡
) {

1552 
dout
(10è<< 
	g__func__
 << ": Removing oid "

1553 << 
	grg‘_oid
 << " fromh‹m°cŞËùiÚ" << 
	gd’dl
;

1554 
ş—r_‹mp_obj
(
rg‘_oid
);

1555 
	gt
->
»move
(
cŞl
, 
ghobjeù_t
(
»cov”y_šfo
.
soid
));

1556 
	gt
->
cŞËùiÚ_move_»Çme
(
cŞl
, 
ghobjeù_t
(
rg‘_oid
),

1557 
cŞl
, 
ghobjeù_t
(
»cov”y_šfo
.
soid
));

1560 
subm™_push_com¶‘e
(
»cov”y_šfo
, 
t
);

1564 
	gR•liÿ‹dBack’d
::
	$subm™_push_com¶‘e
(

1565 cÚ¡ 
ObjeùRecov”yInfo
 &
»cov”y_šfo
,

1566 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

1568 
m­
<
hobjeù_t
, 
š‹rv®_£t
<
ušt64_t
>>::
cÚ¡_™”©Ü
 
p
 =

1569 
»cov”y_šfo
.
şÚe_sub£t
.
	`begš
();

1570 
p
 !ğ
»cov”y_šfo
.
şÚe_sub£t
.
	`’d
();

1571 ++
p
) {

1572 
š‹rv®_£t
<
ušt64_t
>::
cÚ¡_™”©Ü
 
q
 = 
p
->
£cÚd
.
	`begš
();

1573 
q
 !ğ
p
->
£cÚd
.
	`’d
();

1574 ++
q
) {

1575 
	`dout
(15è<< " clÚe_¿ng" << 
p
->
fœ¡
 << " "

1576 << 
q
.
	`g‘_¡¬t
(è<< "~" << q.
	`g‘_Ën
(è<< 
d’dl
;

1577 
t
->
	`şÚe_¿nge
(
cŞl
, 
	`ghobjeù_t
(
p
->
fœ¡
), ghobjeù_t(
»cov”y_šfo
.
soid
),

1578 
q
.
	`g‘_¡¬t
(), q.
	`g‘_Ën
(), q.get_start());

1581 
	}
}

1583 
ObjeùRecov”yInfo
 
	gR•liÿ‹dBack’d
::
	$»ÿlc_sub£ts
(

1584 cÚ¡ 
ObjeùRecov”yInfo
& 
»cov”y_šfo
,

1585 
SÇpS‘CÚ‹xt
 *
ssc
,

1586 
ObcLockMªag”
 &
mªag”
)

1588 ià(!
»cov”y_šfo
.
soid
.
¢­
 ||„ecov”y_šfo.soid.¢­ >ğ
CEPH_NOSNAP
)

1589  
»cov”y_šfo
;

1590 
ObjeùRecov”yInfo
 
Ãw_šfo
 = 
»cov”y_šfo
;

1591 
Ãw_šfo
.
cİy_sub£t
.
	`ş—r
();

1592 
Ãw_šfo
.
şÚe_sub£t
.
	`ş—r
();

1593 
	`as£¹
(
ssc
);

1594 
	`g‘_·»Á
()->
	`»Ëa£_locks
(
mªag”
);

1595 
	`ÿlc_şÚe_sub£ts
(

1596 
ssc
->
¢­£t
, 
Ãw_šfo
.
soid
, 
	`g‘_·»Á
()->
	`g‘_loÿl_missšg
(),

1597 
	`g‘_šfo
().
Ï¡_backfl
,

1598 
Ãw_šfo
.
cİy_sub£t
,‚ew_šfo.
şÚe_sub£t
,

1599 
mªag”
);

1600  
Ãw_šfo
;

1601 
	}
}

1603 
boŞ
 
	gR•liÿ‹dBack’d
::
hªdË_puÎ_»¥Ú£
(

1604 
pg_sh¬d_t
 
äom
, cÚ¡ 
PushOp
 &
pİ
, 
PuÎOp
 *
»¥Ú£
,

1605 
li¡
<
puÎ_com¶‘e_šfo
> *
to_cÚtšue
,

1606 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

1608 
š‹rv®_£t
<
ušt64_t
> 
d©a_šşuded
 = 
pİ
.data_included;

1609 
bufã¾i¡
 
	gd©a
;

1610 
	gd©a
 = 
pİ
.
d©a
;

1611 
dout
(10) << "handle_pull_response "

1612 << 
	gpİ
.
	g»cov”y_šfo


1613 << 
	gpİ
.
	gaá”_´og»ss


1614 << " d©a.size(èi " << 
	gd©a
.
Ëngth
()

1615 << " d©a_šşuded: " << 
	gd©a_šşuded


1616 << 
	gd’dl
;

1617 ià(
	gpİ
.
	gv”siÚ
 =ğ
ev”siÚ_t
()) {

1619 
_çed_puÎ
(
äom
, 
pİ
.
soid
);

1620  
	gçl£
;

1623 cÚ¡ 
	ghobjeù_t
 &
	ghoid
 = 
pİ
.
soid
;

1624 
as£¹
((
d©a_šşuded
.
em±y
(è&& 
d©a
.
Ëngth
() == 0) ||

1625 (!
d©a_šşuded
.
em±y
(è&& 
d©a
.
Ëngth
() > 0));

1627 autØ
	gp™”
 = 
puÎšg
.
fšd
(
hoid
);

1628 ià(
	gp™”
 =ğ
puÎšg
.
’d
()) {

1629  
çl£
;

1632 
	gPuÎInfo
 &
	gpi
 = 
p™”
->
£cÚd
;

1633 ià(
	gpi
.
	g»cov”y_šfo
.
	gsize
 =ğ(
ušt64_t
(-1))) {

1634 
pi
.
»cov”y_šfo
.
size
 = 
pİ
.recovery_info.size;

1635 
	gpi
.
	g»cov”y_šfo
.
	gcİy_sub£t
.
š‹r£ùiÚ_of
(

1636 
pİ
.
»cov”y_šfo
.
cİy_sub£t
);

1639 ià(
	gpi
.
	g»cov”y_šfo
.
	gv”siÚ
 =ğ
ev”siÚ_t
()) {

1640 
pi
.
»cov”y_šfo
.
v”siÚ
 = 
pİ
.version;

1643 
boŞ
 
	gfœ¡
 = 
pi
.
»cov”y_´og»ss
.
fœ¡
;

1644 ià(
	gfœ¡
) {

1651 autØ
	g©Œ£t
 = 
pİ
.
©Œ£t
;

1652 auto& 
	ga
 : 
©Œ£t
) {

1653 
a
.
£cÚd
.
»bud
();

1655 
	gpi
.
	gobc
 = 
g‘_·»Á
()->
g‘_obc
(
pi
.
»cov”y_šfo
.
soid
, 
©Œ£t
);

1656 
	gpi
.
	g»cov”y_šfo
.
	goi
 = 
pi
.
obc
->
obs
.
oi
;

1657 
	gpi
.
	g»cov”y_šfo
 = 
»ÿlc_sub£ts
(

1658 
pi
.
»cov”y_šfo
,

1659 
pi
.
obc
->
ssc
,

1660 
pi
.
lock_mªag”
);

1664 
	gš‹rv®_£t
<
	gušt64_t
> 
	gu§bË_š‹rv®s
;

1665 
bufã¾i¡
 
	gu§bË_d©a
;

1666 
Œim_pushed_d©a
(
pi
.
»cov”y_šfo
.
cİy_sub£t
,

1667 
d©a_šşuded
,

1668 
d©a
,

1669 &
u§bË_š‹rv®s
,

1670 &
u§bË_d©a
);

1671 
	gd©a_šşuded
 = 
u§bË_š‹rv®s
;

1672 
	gd©a
.
şaim
(
u§bË_d©a
);

1675 
	gpi
.
	g»cov”y_´og»ss
 = 
pİ
.
aá”_´og»ss
;

1677 
dout
(10è<< "Ãw„ecov”y_šfØ" << 
	gpi
.
	g»cov”y_šfo


1678 << ",‚ew…rog»s " << 
	gpi
.
	g»cov”y_´og»ss


1679 << 
	gd’dl
;

1681 
boŞ
 
	gcom¶‘e
 = 
pi
.
is_com¶‘e
();

1683 
subm™_push_d©a
(
pi
.
»cov”y_šfo
, 
fœ¡
,

1684 
com¶‘e
, 
pi
.
ÿche_dÚt_Ãed
,

1685 
d©a_šşuded
, 
d©a
,

1686 
pİ
.
om­_h—d”
,

1687 
pİ
.
©Œ£t
,

1688 
pİ
.
om­_’Œ›s
,

1689 
t
);

1691 
	gpi
.
	g¡©
.
	gnum_keys_»cov”ed
 +ğ
pİ
.
om­_’Œ›s
.
size
();

1692 
	gpi
.
	g¡©
.
	gnum_by‹s_»cov”ed
 +ğ
d©a
.
Ëngth
();

1694 ià(
	gcom¶‘e
) {

1695 
	gpi
.
	g¡©
.
	gnum_objeùs_»cov”ed
++;

1696 
ş—r_puÎ_äom
(
p™”
);

1697 
	gto_cÚtšue
->
push_back
({
hoid
, 
pi
.
¡©
});

1698 
g‘_·»Á
()->
Ú_loÿl_»cov”
(

1699 
hoid
, 
pi
.
»cov”y_šfo
,…i.
obc
, 
çl£
, 
t
);

1700  
	gçl£
;

1702 
	g»¥Ú£
->
	gsoid
 = 
pİ
.
soid
;

1703 
	g»¥Ú£
->
	g»cov”y_šfo
 = 
pi
.
»cov”y_šfo
;

1704 
	g»¥Ú£
->
	g»cov”y_´og»ss
 = 
pi
.
»cov”y_´og»ss
;

1705  
	gŒue
;

1709 
	gR•liÿ‹dBack’d
::
	$hªdË_push
(

1710 
pg_sh¬d_t
 
äom
, cÚ¡ 
PushOp
 &
pİ
, 
PushR•lyOp
 *
»¥Ú£
,

1711 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

1713 
	`dout
(10) << "handle_push "

1714 << 
pİ
.
»cov”y_šfo


1715 << 
pİ
.
aá”_´og»ss


1716 << 
d’dl
;

1717 
bufã¾i¡
 
d©a
;

1718 
d©a
 = 
pİ
.data;

1719 
boŞ
 
fœ¡
 = 
pİ
.
befÜe_´og»ss
.first;

1720 
boŞ
 
com¶‘e
 = 
pİ
.
aá”_´og»ss
.
d©a_com¶‘e
 &&

1721 
pİ
.
aá”_´og»ss
.
om­_com¶‘e
;

1723 
»¥Ú£
->
soid
 = 
pİ
.
»cov”y_šfo
.soid;

1724 
	`subm™_push_d©a
(
pİ
.
»cov”y_šfo
,

1725 
fœ¡
,

1726 
com¶‘e
,

1727 
Œue
,

1728 
pİ
.
d©a_šşuded
,

1729 
d©a
,

1730 
pİ
.
om­_h—d”
,

1731 
pİ
.
©Œ£t
,

1732 
pİ
.
om­_’Œ›s
,

1733 
t
);

1735 ià(
com¶‘e
)

1736 
	`g‘_·»Á
()->
	`Ú_loÿl_»cov”
(

1737 
pİ
.
»cov”y_šfo
.
soid
,

1738 
pİ
.
»cov”y_šfo
,

1739 
	`ObjeùCÚ‹xtRef
(),

1740 
çl£
,

1741 
t
);

1742 
	}
}

1744 
	gR•liÿ‹dBack’d
::
£nd_pushes
(
´io
, 
m­
<
pg_sh¬d_t
, 
veùÜ
<
PushOp
> > &
pushes
)

1746 
	gm­
<
	gpg_sh¬d_t
, 
	gveùÜ
<
	gPushOp
> >::
™”©Ü
 
i
 = 
pushes
.
begš
();

1747 
	gi
 !ğ
pushes
.
’d
();

1748 ++
	gi
) {

1749 
CÚÃùiÚRef
 
	gcÚ
 = 
g‘_·»Á
()->
g‘_cÚ_osd_şu¡”
(

1750 
i
->
fœ¡
.
osd
,

1751 
g‘_osdm­
()->
g‘_•och
());

1752 ià(!
	gcÚ
)

1754 
	gveùÜ
<
	gPushOp
>::
™”©Ü
 
j
 = 
i
->
£cÚd
.
begš
();

1755 
	gj
 !ğ
i
->
£cÚd
.
’d
()) {

1756 
ušt64_t
 
co¡
 = 0;

1757 
ušt64_t
 
	gpushes
 = 0;

1758 
MOSDPGPush
 *
	gmsg
 = 
Ãw
 MOSDPGPush();

1759 
	gmsg
->
	gäom
 = 
g‘_·»Á
()->
whßmi_sh¬d
();

1760 
	gmsg
->
	gpgid
 = 
g‘_·»Á
()->
´im¬y_¥g_t
();

1761 
	gmsg
->
	gm­_•och
 = 
g‘_osdm­
()->
g‘_•och
();

1762 
	gmsg
->
	gmš_•och
 = 
g‘_·»Á
()->
g‘_Ï¡_³”šg_»£t_•och
();

1763 
	gmsg
->
£t_´iÜ™y
(
´io
);

1765 (
	gj
 !ğ
i
->
£cÚd
.
’d
() &&

1766 
co¡
 < 
cù
->
_cÚf
->
osd_max_push_co¡
 &&

1767 
pushes
 < 
cù
->
_cÚf
->
osd_max_push_objeùs
) ;

1768 ++
	gj
) {

1769 
dout
(20è<< 
	g__func__
 << ": s’dšg…ush " << *
	gj


1770 << "Øosd." << 
	gi
->
	gfœ¡
 << 
	gd’dl
;

1771 
	gco¡
 +ğ
j
->
co¡
(
cù
);

1772 
	gpushes
 += 1;

1773 
	gmsg
->
	gpushes
.
push_back
(*
j
);

1775 
	gmsg
->
£t_co¡
(
co¡
);

1776 
g‘_·»Á
()->
£nd_mes§ge_osd_şu¡”
(
msg
, 
cÚ
);

1781 
	gR•liÿ‹dBack’d
::
£nd_puÎs
(
´io
, 
m­
<
pg_sh¬d_t
, 
veùÜ
<
PuÎOp
> > &
puÎs
)

1783 
	gm­
<
	gpg_sh¬d_t
, 
	gveùÜ
<
	gPuÎOp
> >::
™”©Ü
 
i
 = 
puÎs
.
begš
();

1784 
	gi
 !ğ
puÎs
.
’d
();

1785 ++
	gi
) {

1786 
CÚÃùiÚRef
 
	gcÚ
 = 
g‘_·»Á
()->
g‘_cÚ_osd_şu¡”
(

1787 
i
->
fœ¡
.
osd
,

1788 
g‘_osdm­
()->
g‘_•och
());

1789 ià(!
	gcÚ
)

1791 
dout
(20è<< 
	g__func__
 << ": s’dšg…uÎ " << 
	gi
->
	g£cÚd


1792 << "Øosd." << 
	gi
->
	gfœ¡
 << 
	gd’dl
;

1793 
MOSDPGPuÎ
 *
	gmsg
 = 
Ãw
 MOSDPGPull();

1794 
	gmsg
->
	gäom
 = 
·»Á
->
whßmi_sh¬d
();

1795 
	gmsg
->
£t_´iÜ™y
(
´io
);

1796 
	gmsg
->
	gpgid
 = 
g‘_·»Á
()->
´im¬y_¥g_t
();

1797 
	gmsg
->
	gm­_•och
 = 
g‘_osdm­
()->
g‘_•och
();

1798 
	gmsg
->
	gmš_•och
 = 
g‘_·»Á
()->
g‘_Ï¡_³”šg_»£t_•och
();

1799 
	gmsg
->
£t_puÎs
(&
i
->
£cÚd
);

1800 
	gmsg
->
compu‹_co¡
(
cù
);

1801 
g‘_·»Á
()->
£nd_mes§ge_osd_şu¡”
(
msg
, 
cÚ
);

1805 
	gR•liÿ‹dBack’d
::
	$bud_push_İ
(cÚ¡ 
ObjeùRecov”yInfo
 &
»cov”y_šfo
,

1806 cÚ¡ 
ObjeùRecov”yProg»ss
 &
´og»ss
,

1807 
ObjeùRecov”yProg»ss
 *
out_´og»ss
,

1808 
PushOp
 *
out_İ
,

1809 
objeù_¡©_sum_t
 *
¡©
,

1810 
boŞ
 
ÿche_dÚt_Ãed
)

1812 
ObjeùRecov”yProg»ss
 
_Ãw_´og»ss
;

1813 ià(!
out_´og»ss
)

1814 
out_´og»ss
 = &
_Ãw_´og»ss
;

1815 
ObjeùRecov”yProg»ss
 &
Ãw_´og»ss
 = *
out_´og»ss
;

1816 
Ãw_´og»ss
 = 
´og»ss
;

1818 
	`dout
(7è<< 
__func__
 << " " << 
»cov”y_šfo
.
soid


1819 << " v " << 
»cov”y_šfo
.
v”siÚ


1820 << " siz" << 
»cov”y_šfo
.
size


1821 << "„ecov”y_šfo: " << 
»cov”y_šfo


1822 << 
d’dl
;

1824 
ev”siÚ_t
 
v
 = 
»cov”y_šfo
.
v”siÚ
;

1825 ià(
´og»ss
.
fœ¡
) {

1826 
r
 = 
¡Üe
->
	`om­_g‘_h—d”
(
ch
, 
	`ghobjeù_t
(
»cov”y_šfo
.
soid
), &
out_İ
->
om­_h—d”
);

1827 if(
r
 < 0) {

1828 
	`dout
(1è<< 
__func__
 << " g‘ om­ h—d” faed: " << 
	`ıp_¡»¼Ü
(-
r
è<< 
d’dl
;

1829  
r
;

1831 
r
 = 
¡Üe
->
	`g‘©Œs
(
ch
, 
	`ghobjeù_t
(
»cov”y_šfo
.
soid
), 
out_İ
->
©Œ£t
);

1832 if(
r
 < 0) {

1833 
	`dout
(1è<< 
__func__
 << " g‘©Œ çed: " << 
	`ıp_¡»¼Ü
(-
r
è<< 
d’dl
;

1834  
r
;

1838 
bufã¾i¡
 
bv
 = 
out_İ
->
©Œ£t
[
OI_ATTR
];

1839 
objeù_šfo_t
 
oi
;

1840 
Œy
 {

1841 
bufã¾i¡
::
™”©Ü
 
bl™”
 = 
bv
.
	`begš
();

1842 
	`decode
(
oi
, 
bl™”
);

1843 } 
	`ÿtch
 (...) {

1844 
	`dout
(0è<< 
__func__
 << ": bad objeù_šfo_t: " << 
»cov”y_šfo
.
soid
 << 
d’dl
;

1845  -
EINVAL
;

1849 ià(
v
 =ğ
	`ev”siÚ_t
()) {

1850 
v
 = 
oi
.
v”siÚ
;

1851 } ià(
oi
.
v”siÚ
 !ğ
v
) {

1852 
	`g‘_·»Á
()->
	`şog_”rÜ
(è<< 
	`g‘_šfo
().
pgid
 << "…ush "

1853 << 
»cov”y_šfo
.
soid
 << " v "

1854 << 
»cov”y_šfo
.
v”siÚ


1856 << 
oi
.
v”siÚ
;

1857  -
EINVAL
;

1860 
Ãw_´og»ss
.
fœ¡
 = 
çl£
;

1864 
	`as£¹
(
v
 !ğ
	`ev”siÚ_t
());

1866 
ušt64_t
 
avaabË
 = 
cù
->
_cÚf
->
osd_»cov”y_max_chunk
;

1867 ià(!
´og»ss
.
om­_com¶‘e
) {

1868 
ObjeùM­
::
ObjeùM­I‹¿tÜ
 
™”
 =

1869 
¡Üe
->
	`g‘_om­_™”©Ü
(
ch
,

1870 
	`ghobjeù_t
(
»cov”y_šfo
.
soid
));

1871 
	`as£¹
(
™”
);

1872 
™”
->
	`low”_bound
(
´og»ss
.
om­_»cov”ed_to
);

1873 
™”
->
	`v®id
();

1874 
™”
->
	`Ãxt
(
çl£
)) {

1875 ià(!
out_İ
->
om­_’Œ›s
.
	`em±y
() &&

1876 ((
cù
->
_cÚf
->
osd_»cov”y_max_om­_’Œ›s_³r_chunk
 > 0 &&

1877 
out_İ
->
om­_’Œ›s
.
	`size
(è>ğ
cù
->
_cÚf
->
osd_»cov”y_max_om­_’Œ›s_³r_chunk
) ||

1878 
avaabË
 <ğ
™”
->
	`key
().
	`size
(è+ i‹r->
	`v®ue
().
	`Ëngth
()))

1880 
out_İ
->
om­_’Œ›s
.
	`š£¹
(
	`make_·œ
(
™”
->
	`key
(), i‹r->
	`v®ue
()));

1882 ià((
™”
->
	`key
().
	`size
(è+ i‹r->
	`v®ue
().
	`Ëngth
()è<ğ
avaabË
)

1883 
avaabË
 -ğ(
™”
->
	`key
().
	`size
(è+ i‹r->
	`v®ue
().
	`Ëngth
());

1885 
avaabË
 = 0;

1887 ià(!
™”
->
	`v®id
())

1888 
Ãw_´og»ss
.
om­_com¶‘e
 = 
Œue
;

1890 
Ãw_´og»ss
.
om­_»cov”ed_to
 = 
™”
->
	`key
();

1893 ià(
avaabË
 > 0) {

1894 ià(!
»cov”y_šfo
.
cİy_sub£t
.
	`em±y
()) {

1895 
š‹rv®_£t
<
ušt64_t
> 
cİy_sub£t
 = 
»cov”y_šfo
.copy_subset;

1896 
m­
<
ušt64_t
, ušt64_t> 
m
;

1897 
r
 = 
¡Üe
->
	`f›m­
(
ch
, 
	`ghobjeù_t
(
»cov”y_šfo
.
soid
), 0,

1898 
cİy_sub£t
.
	`¿nge_’d
(), 
m
);

1899 ià(
r
 >= 0) {

1900 
š‹rv®_£t
<
ušt64_t
> 
	`f›m­_šşuded
(
m
);

1901 
cİy_sub£t
.
	`š‹r£ùiÚ_of
(
f›m­_šşuded
);

1904 
cİy_sub£t
.
	`ş—r
();

1907 
out_İ
->
d©a_šşuded
.
	`¥ª_of
(
cİy_sub£t
, 
´og»ss
.
d©a_»cov”ed_to
,

1908 
avaabË
);

1909 ià(
out_İ
->
d©a_šşuded
.
	`em±y
())

1910 
Ãw_´og»ss
.
d©a_»cov”ed_to
 = 
»cov”y_šfo
.
cİy_sub£t
.
	`¿nge_’d
();

1912 
Ãw_´og»ss
.
d©a_»cov”ed_to
 = 
out_İ
->
d©a_šşuded
.
	`¿nge_’d
();

1915 
out_İ
->
d©a_šşuded
.
	`ş—r
();

1918 
š‹rv®_£t
<
ušt64_t
>::
™”©Ü
 
p
 = 
out_İ
->
d©a_šşuded
.
	`begš
();

1919 
p
 !ğ
out_İ
->
d©a_šşuded
.
	`’d
();

1920 ++
p
) {

1921 
bufã¾i¡
 
b™
;

1922 
r
 = 
¡Üe
->
	`»ad
(
ch
, 
	`ghobjeù_t
(
»cov”y_šfo
.
soid
),

1923 
p
.
	`g‘_¡¬t
(),….
	`g‘_Ën
(), 
b™
,

1924 
ÿche_dÚt_Ãed
 ? 
CEPH_OSD_OP_FLAG_FADVISE_DONTNEED
: 0);

1925 ià(
cù
->
_cÚf
->
osd_debug_¿ndom_push_»ad_”rÜ
 &&

1926 (
	`¿nd
(è% ()(
cù
->
_cÚf
->
osd_debug_¿ndom_push_»ad_”rÜ
 * 100.0)) == 0) {

1927 
	`dout
(0è<< 
__func__
 << ": injeù EIO " << 
»cov”y_šfo
.
soid
 << 
d’dl
;

1928 
r
 = -
EIO
;

1930 ià(
r
 < 0) {

1931  
r
;

1933 ià(
p
.
	`g‘_Ën
(è!ğ
b™
.
	`Ëngth
()) {

1934 
	`dout
(10è<< "ƒx‹Á " << 
p
.
	`g‘_¡¬t
(è<< "~" <<….
	`g‘_Ën
()

1935 << " i aùu®ly " << 
p
.
	`g‘_¡¬t
(è<< "~" << 
b™
.
	`Ëngth
()

1936 << 
d’dl
;

1937 
š‹rv®_£t
<
ušt64_t
>::
™”©Ü
 
§ve
 = 
p
++;

1938 ià(
b™
.
	`Ëngth
() == 0)

1939 
out_İ
->
d©a_šşuded
.
	`”a£
(
§ve
);

1941 
§ve
.
	`£t_Ën
(
b™
.
	`Ëngth
());

1943 
p
 !ğ
out_İ
->
d©a_šşuded
.
	`’d
()) {

1944 
š‹rv®_£t
<
ušt64_t
>::
™”©Ü
 
§ve
 = 
p
++;

1945 
out_İ
->
d©a_šşuded
.
	`”a£
(
§ve
);

1947 
Ãw_´og»ss
.
d©a_com¶‘e
 = 
Œue
;

1948 
out_İ
->
d©a
.
	`şaim_­³nd
(
b™
);

1951 
out_İ
->
d©a
.
	`şaim_­³nd
(
b™
);

1954 ià(
Ãw_´og»ss
.
	`is_com¶‘e
(
»cov”y_šfo
)) {

1955 
Ãw_´og»ss
.
d©a_com¶‘e
 = 
Œue
;

1956 ià(
¡©
)

1957 
¡©
->
num_objeùs_»cov”ed
++;

1960 ià(
¡©
) {

1961 
¡©
->
num_keys_»cov”ed
 +ğ
out_İ
->
om­_’Œ›s
.
	`size
();

1962 
¡©
->
num_by‹s_»cov”ed
 +ğ
out_İ
->
d©a
.
	`Ëngth
();

1965 
	`g‘_·»Á
()->
	`g‘_logg”
()->
	`šc
(
l_osd_push
);

1966 
	`g‘_·»Á
()->
	`g‘_logg”
()->
	`šc
(
l_osd_push_outb
, 
out_İ
->
d©a
.
	`Ëngth
());

1969 
out_İ
->
v”siÚ
 = 
v
;

1970 
out_İ
->
soid
 = 
»cov”y_šfo
.soid;

1971 
out_İ
->
»cov”y_šfo
 =„ecovery_info;

1972 
out_İ
->
aá”_´og»ss
 = 
Ãw_´og»ss
;

1973 
out_İ
->
befÜe_´og»ss
 = 
´og»ss
;

1975 
	}
}

1977 
	gR•liÿ‹dBack’d
::
	$´•_push_İ_bÏnk
(cÚ¡ 
hobjeù_t
& 
soid
, 
PushOp
 *
İ
)

1979 
İ
->
»cov”y_šfo
.
v”siÚ
 = 
	`ev”siÚ_t
();

1980 
İ
->
v”siÚ
 = 
	`ev”siÚ_t
();

1981 
İ
->
soid
 = soid;

1982 
	}
}

1984 
boŞ
 
	gR•liÿ‹dBack’d
::
	$hªdË_push_»¶y
(

1985 
pg_sh¬d_t
 
³”
, cÚ¡ 
PushR•lyOp
 &
İ
, 
PushOp
 *
»¶y
)

1987 cÚ¡ 
hobjeù_t
 &
soid
 = 
İ
.soid;

1988 ià(
pushšg
.
	`couÁ
(
soid
) == 0) {

1989 
	`dout
(10è<< "huh, i wa¢'ˆpushšg " << 
soid
 << "Øosd." << 
³”


1991 << 
d’dl
;

1992  
çl£
;

1993 } ià(
pushšg
[
soid
].
	`couÁ
(
³”
) == 0) {

1994 
	`dout
(10è<< "huh, i wa¢'ˆpushšg " << 
soid
 << "Øosd." << 
³”


1995 << 
d’dl
;

1996  
çl£
;

1998 
PushInfo
 *
pi
 = &
pushšg
[
soid
][
³”
];

1999 
boŞ
 
”rÜ
 = 
pushšg
[
soid
].
	`begš
()->
£cÚd
.
»cov”y_´og»ss
.error;

2001 ià(!
pi
->
»cov”y_´og»ss
.
d©a_com¶‘e
 && !
”rÜ
) {

2002 
	`dout
(10) << "…ushing more from, "

2003 << 
pi
->
»cov”y_´og»ss
.
d©a_»cov”ed_to


2004 << " oà" << 
pi
->
»cov”y_šfo
.
cİy_sub£t
 << 
d’dl
;

2005 
ObjeùRecov”yProg»ss
 
Ãw_´og»ss
;

2006 
r
 = 
	`bud_push_İ
(

2007 
pi
->
»cov”y_šfo
,

2008 
pi
->
»cov”y_´og»ss
, &
Ãw_´og»ss
, 
»¶y
,

2009 &(
pi
->
¡©
));

2012 ià(
r
 < 0) {

2013 
	`dout
(5è<< 
__func__
 << ": oid " << 
soid
 << "ƒ¼Ü " << 
r
 << 
d’dl
;

2015 
”rÜ
 = 
Œue
;

2016 
dÚe
;

2018 
pi
->
»cov”y_´og»ss
 = 
Ãw_´og»ss
;

2019  
Œue
;

2022 
dÚe
:

2023 ià(!
”rÜ
)

2024 
	`g‘_·»Á
()->
	`Ú_³”_»cov”
Ğ
³”
, 
soid
, 
pi
->
»cov”y_šfo
);

2026 
	`g‘_·»Á
()->
	`»Ëa£_locks
(
pi
->
lock_mªag”
);

2027 
objeù_¡©_sum_t
 
¡©
 = 
pi
->stat;

2028 
ev”siÚ_t
 
v
 = 
pi
->
»cov”y_šfo
.
v”siÚ
;

2029 
pushšg
[
soid
].
	`”a£
(
³”
);

2030 
pi
 = 
NULL
;

2032 ià(
pushšg
[
soid
].
	`em±y
()) {

2033 ià(!
”rÜ
)

2034 
	`g‘_·»Á
()->
	`Ú_glob®_»cov”
(
soid
, 
¡©
, 
çl£
);

2036 
	`g‘_·»Á
()->
	`Ú_´im¬y_”rÜ
(
soid
, 
v
);

2037 
pushšg
.
	`”a£
(
soid
);

2041 ià(
”rÜ
)

2042 
pushšg
[
soid
].
	`begš
()->
£cÚd
.
»cov”y_´og»ss
.
”rÜ
 = 
Œue
;

2043 
	`dout
(10è<< "pushed " << 
soid
 << ", still waiting for…ush‡ck from "

2044 << 
pushšg
[
soid
].
	`size
(è<< " oth”s" << 
d’dl
;

2046  
çl£
;

2049 
	}
}

2051 
	gR•liÿ‹dBack’d
::
	$hªdË_puÎ
(
pg_sh¬d_t
 
³”
, 
PuÎOp
 &
İ
, 
PushOp
 *
»¶y
)

2053 cÚ¡ 
hobjeù_t
 &
soid
 = 
İ
.soid;

2054 
¡©
 
¡
;

2055 
r
 = 
¡Üe
->
	`¡©
(
ch
, 
	`ghobjeù_t
(
soid
), &
¡
);

2056 ià(
r
 != 0) {

2057 
	`g‘_·»Á
()->
	`şog_”rÜ
(è<< 
	`g‘_šfo
().
pgid
 << " "

2058 << 
³”
 << "r›dØpuÎ " << 
soid


2059 << " buˆgÙ " << 
	`ıp_¡»¼Ü
(-
r
);

2060 
	`´•_push_İ_bÏnk
(
soid
, 
»¶y
);

2062 
ObjeùRecov”yInfo
 &
»cov”y_šfo
 = 
İ
.recovery_info;

2063 
ObjeùRecov”yProg»ss
 &
´og»ss
 = 
İ
.
»cov”y_´og»ss
;

2064 ià(
´og»ss
.
fœ¡
 && 
»cov”y_šfo
.
size
 =ğ((
ušt64_t
)-1)) {

2066 
»cov”y_šfo
.
size
 = 
¡
.
¡_size
;

2067 
»cov”y_šfo
.
cİy_sub£t
.
	`ş—r
();

2068 ià(
¡
.
¡_size
)

2069 
»cov”y_šfo
.
cİy_sub£t
.
	`š£¹
(0, 
¡
.
¡_size
);

2070 
	`as£¹
(
»cov”y_šfo
.
şÚe_sub£t
.
	`em±y
());

2073 
r
 = 
	`bud_push_İ
(
»cov”y_šfo
, 
´og»ss
, 0, 
»¶y
);

2074 ià(
r
 < 0)

2075 
	`´•_push_İ_bÏnk
(
soid
, 
»¶y
);

2077 
	}
}

2088 
	gR•liÿ‹dBack’d
::
Œim_pushed_d©a
(

2089 cÚ¡ 
š‹rv®_£t
<
ušt64_t
> &
cİy_sub£t
,

2090 cÚ¡ 
š‹rv®_£t
<
ušt64_t
> &
š‹rv®s_»ûived
,

2091 
bufã¾i¡
 
d©a_»ûived
,

2092 
š‹rv®_£t
<
ušt64_t
> *
š‹rv®s_u§bË
,

2093 
bufã¾i¡
 *
d©a_u§bË
)

2095 ià(
	gš‹rv®s_»ûived
.
sub£t_of
(
cİy_sub£t
)) {

2096 *
	gš‹rv®s_u§bË
 = 
š‹rv®s_»ûived
;

2097 *
	gd©a_u§bË
 = 
d©a_»ûived
;

2101 
	gš‹rv®s_u§bË
->
š‹r£ùiÚ_of
(
cİy_sub£t
,

2102 
š‹rv®s_»ûived
);

2104 
ušt64_t
 
	goff
 = 0;

2105 
	gš‹rv®_£t
<
	gušt64_t
>::
cÚ¡_™”©Ü
 
p
 = 
š‹rv®s_»ûived
.
begš
();

2106 
	gp
 !ğ
š‹rv®s_»ûived
.
’d
();

2107 ++
	gp
) {

2108 
	gš‹rv®_£t
<
	gušt64_t
> 
	gx
;

2109 
	gx
.
š£¹
(
p
.
g‘_¡¬t
(),….
g‘_Ën
());

2110 
	gx
.
š‹r£ùiÚ_of
(
cİy_sub£t
);

2111 
	gš‹rv®_£t
<
	gušt64_t
>::
cÚ¡_™”©Ü
 
q
 = 
x
.
begš
();

2112 
	gq
 !ğ
x
.
’d
();

2113 ++
	gq
) {

2114 
bufã¾i¡
 
	gsub
;

2115 
ušt64_t
 
	gd©a_off
 = 
off
 + (
q
.
g‘_¡¬t
(è- 
p
.get_start());

2116 
	gsub
.
sub¡r_of
(
d©a_»ûived
, 
d©a_off
, 
q
.
g‘_Ën
());

2117 
	gd©a_u§bË
->
şaim_­³nd
(
sub
);

2119 
	goff
 +ğ
p
.
g‘_Ën
();

2123 
	gR•liÿ‹dBack’d
::
	$_çed_puÎ
(
pg_sh¬d_t
 
äom
, cÚ¡ 
hobjeù_t
 &
soid
)

2125 
	`dout
(20è<< 
__func__
 << ": " << 
soid
 << " from " << 
äom
 << 
d’dl
;

2126 
li¡
<
pg_sh¬d_t
> 
æ
 = { 
äom
 };

2127 
	`g‘_·»Á
()->
	`çed_push
(
æ
, 
soid
);

2129 
	`ş—r_puÎ
(
puÎšg
.
	`fšd
(
soid
));

2130 
	}
}

2132 
	gR•liÿ‹dBack’d
::
ş—r_puÎ_äom
(

2133 
m­
<
hobjeù_t
, 
PuÎInfo
>::
™”©Ü
 
p™”
)

2135 autØ
äom
 = 
p™”
->
£cÚd
.from;

2136 
	gpuÎ_äom_³”
[
äom
].
”a£
(
p™”
->
£cÚd
.
soid
);

2137 ià(
	gpuÎ_äom_³”
[
äom
].
em±y
())

2138 
	gpuÎ_äom_³”
.
”a£
(
äom
);

2141 
	gR•liÿ‹dBack’d
::
ş—r_puÎ
(

2142 
m­
<
hobjeù_t
, 
PuÎInfo
>::
™”©Ü
 
p™”
,

2143 
boŞ
 
ş—r_puÎ_äom_³”
)

2145 ià(
	gş—r_puÎ_äom_³”
) {

2146 
ş—r_puÎ_äom
(
p™”
);

2148 
g‘_·»Á
()->
»Ëa£_locks
(
p™”
->
£cÚd
.
lock_mªag”
);

2149 
	gpuÎšg
.
”a£
(
p™”
);

2152 
	gR•liÿ‹dBack’d
::
	$¡¬t_pushes
(

2153 cÚ¡ 
hobjeù_t
 &
soid
,

2154 
ObjeùCÚ‹xtRef
 
obc
,

2155 
RPGHªdË
 *
h
)

2157 
li¡
< 
m­
<
pg_sh¬d_t
, 
pg_missšg_t
>::
cÚ¡_™”©Ü
 > 
sh¬ds
;

2159 
	`dout
(20è<< 
__func__
 << " soid " << 
soid
 << 
d’dl
;

2161 
	`as£¹
(
	`g‘_·»Á
()->
	`g‘_aùšg_»cov”y_backfl_sh¬ds
().
	`size
() > 0);

2162 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
i
 =

2163 
	`g‘_·»Á
()->
	`g‘_aùšg_»cov”y_backfl_sh¬ds
().
	`begš
();

2164 
i
 !ğ
	`g‘_·»Á
()->
	`g‘_aùšg_»cov”y_backfl_sh¬ds
().
	`’d
();

2165 ++
i
) {

2166 ià(*
i
 =ğ
	`g‘_·»Á
()->
	`whßmi_sh¬d
()) ;

2167 
pg_sh¬d_t
 
³”
 = *
i
;

2168 
m­
<
pg_sh¬d_t
, 
pg_missšg_t
>::
cÚ¡_™”©Ü
 
j
 =

2169 
	`g‘_·»Á
()->
	`g‘_sh¬d_missšg
().
	`fšd
(
³”
);

2170 
	`as£¹
(
j
 !ğ
	`g‘_·»Á
()->
	`g‘_sh¬d_missšg
().
	`’d
());

2171 ià(
j
->
£cÚd
.
	`is_missšg
(
soid
)) {

2172 
sh¬ds
.
	`push_back
(
j
);

2177 
boŞ
 
ÿche
 = 
sh¬ds
.
	`size
(è=ğ1 ? 
h
->
ÿche_dÚt_Ãed
 : 
çl£
;

2179 autØ
j
 : 
sh¬ds
) {

2180 
pg_sh¬d_t
 
³”
 = 
j
->
fœ¡
;

2181 
h
->
pushes
[
³”
].
	`push_back
(
	`PushOp
());

2182 
r
 = 
	`´•_push_to_»¶iÿ
(
obc
, 
soid
, 
³”
,

2183 &(
h
->
pushes
[
³”
].
	`back
()), 
ÿche
);

2184 ià(
r
 < 0) {

2186 autØ
k
 : 
sh¬ds
) {

2187 
pg_sh¬d_t
 
p
 = 
k
->
fœ¡
;

2188 
	`dout
(10è<< 
__func__
 << " cËª u°³” " << 
p
 << 
d’dl
;

2189 
h
->
pushes
[
p
].
	`pİ_back
();

2190 ià(
p
 =ğ
³”
) ;

2192  
r
;

2195  
sh¬ds
.
	`size
();

2196 
	}
}

	@osd/ReplicatedBackend.h

15 #iâdeà
REPBACKEND_H


16 
	#REPBACKEND_H


	)

18 
	~"OSD.h
"

19 
	~"PGBack’d.h
"

20 
	~"šşude/memÜy.h
"

22 
	gC_R•liÿ‹dBack’d_OnPuÎCom¶‘e
;

23 şas 
	cR•liÿ‹dBack’d
 : 
public
 
PGBack’d
 {

24 
RPGHªdË
 : 
public
 
PGBack’d
::
Recov”yHªdË
 {

25 
m­
<
pg_sh¬d_t
, 
	mveùÜ
<
	mPushOp
> > 
	mpushes
;

26 
	mm­
<
	mpg_sh¬d_t
, 
	mveùÜ
<
	mPuÎOp
> > 
	mpuÎs
;

28 
ä›nd
 
	gC_R•liÿ‹dBack’d_OnPuÎCom¶‘e
;

29 
	gpublic
:

30 
R•liÿ‹dBack’d
(

31 
PGBack’d
::
Li¡’”
 *
pg
,

32 cÚ¡ 
cŞl_t
 &
cŞl
,

33 
ObjeùStÜe
::
CŞËùiÚHªdË
 &
ch
,

34 
ObjeùStÜe
 *
¡Üe
,

35 
C•hCÚ‹xt
 *
cù
);

38 
RPGHªdË
 *
	$_İ’_»cov”y_İ
() {

39  
Ãw
 
	`RPGHªdË
();

40 
	}
}

41 
	gPGBack’d
::
Recov”yHªdË
 *
	$İ’_»cov”y_İ
(è
ov”ride
 {

42  
	`_İ’_»cov”y_İ
();

43 
	}
}

46 
	$run_»cov”y_İ
(

47 
PGBack’d
::
Recov”yHªdË
 *
h
,

48 
´iÜ™y
è
ov”ride
;

51 
	$»cov”_objeù
(

52 cÚ¡ 
hobjeù_t
 &
hoid
,

53 
ev”siÚ_t
 
v
,

54 
ObjeùCÚ‹xtRef
 
h—d
,

55 
ObjeùCÚ‹xtRef
 
obc
,

56 
Recov”yHªdË
 *
h


57 è
ov”ride
;

59 
	$check_»cov”y_sourûs
(cÚ¡ 
OSDM­Ref
& 
osdm­
è
ov”ride
;

61 
boŞ
 
	$ÿn_hªdË_whe_šaùive
(
OpReque¡Ref
 
İ
è
ov”ride
;

64 
boŞ
 
	$_hªdË_mes§ge
(

65 
OpReque¡Ref
 
İ


66 è
ov”ride
;

68 
	$Ú_chªge
(è
ov”ride
;

69 
	$ş—r_»cov”y_¡©e
(è
ov”ride
;

71 şas 
	cRPCRecP»d
 : 
public
 
IsPGRecov”abËP»diÿ‹
 {

72 
public
:

73 
boŞ
 
	`İ”©Ü
()(cÚ¡ 
£t
<
pg_sh¬d_t
> &
have
ècÚ¡ 
ov”ride
 {

74  !
have
.
	`em±y
();

76 
	}
};

77 
IsPGRecov”abËP»diÿ‹
 *
	$g‘_is_»cov”abË_´ediÿ‹
(ècÚ¡ 
ov”ride
 {

78  
Ãw
 
RPCRecP»d
;

79 
	}
}

81 şas 
	cRPCR—dP»d
 : 
public
 
IsPGR—dabËP»diÿ‹
 {

82 
pg_sh¬d_t
 
whßmi
;

83 
	gpublic
:

84 
ex¶ic™
 
RPCR—dP»d
(
pg_sh¬d_t
 
whßmi
) : whoami(whoami) {}

85 
boŞ
 
İ”©Ü
()(cÚ¡ 
£t
<
pg_sh¬d_t
> &
have
ècÚ¡ 
ov”ride
 {

86  
have
.
couÁ
(
whßmi
);

89 
IsPGR—dabËP»diÿ‹
 *
	$g‘_is_»adabË_´ediÿ‹
(ècÚ¡ 
ov”ride
 {

90  
Ãw
 
	`RPCR—dP»d
(
	`g‘_·»Á
()->
	`whßmi_sh¬d
());

91 
	}
}

93 
	$dump_»cov”y_šfo
(
FÜm©‹r
 *
f
ècÚ¡ 
ov”ride
 {

95 
f
->
	`İ’_¬¿y_£ùiÚ
("pull_from_peer");

96 
m­
<
pg_sh¬d_t
, 
£t
<
hobjeù_t
> >::
cÚ¡_™”©Ü
 
i
 = 
puÎ_äom_³”
.
	`begš
();

97 
i
 !ğ
puÎ_äom_³”
.
	`’d
();

98 ++
i
) {

99 
f
->
	`İ’_objeù_£ùiÚ
("pulling_from");

100 
f
->
	`dump_¡»am
("puÎ_äom"è<< 
i
->
fœ¡
;

102 
f
->
	`İ’_¬¿y_£ùiÚ
("pulls");

103 
£t
<
hobjeù_t
>::
cÚ¡_™”©Ü
 
j
 = 
i
->
£cÚd
.
	`begš
();

104 
j
 !ğ
i
->
£cÚd
.
	`’d
();

105 ++
j
) {

106 
f
->
	`İ’_objeù_£ùiÚ
("pull_info");

107 
	`as£¹
(
puÎšg
.
	`couÁ
(*
j
));

108 
puÎšg
.
	`fšd
(*
j
)->
£cÚd
.
	`dump
(
f
);

109 
f
->
	`şo£_£ùiÚ
();

111 
f
->
	`şo£_£ùiÚ
();

113 
f
->
	`şo£_£ùiÚ
();

115 
f
->
	`şo£_£ùiÚ
();

118 
f
->
	`İ’_¬¿y_£ùiÚ
("pushing");

119 
m­
<
hobjeù_t
, m­<
pg_sh¬d_t
, 
PushInfo
>>::
cÚ¡_™”©Ü
 
i
 =

120 
pushšg
.
	`begš
();

121 
i
 !ğ
pushšg
.
	`’d
();

122 ++
i
) {

123 
f
->
	`İ’_objeù_£ùiÚ
("object");

124 
f
->
	`dump_¡»am
("pushšg"è<< 
i
->
fœ¡
;

126 
f
->
	`İ’_¬¿y_£ùiÚ
("pushing_to");

127 
m­
<
pg_sh¬d_t
, 
PushInfo
>::
cÚ¡_™”©Ü
 
j
 = 
i
->
£cÚd
.
	`begš
();

128 
j
 !ğ
i
->
£cÚd
.
	`’d
();

129 ++
j
) {

130 
f
->
	`İ’_objeù_£ùiÚ
("push_progress");

131 
f
->
	`dump_¡»am
("pushšg_to"è<< 
j
->
fœ¡
;

133 
f
->
	`İ’_objeù_£ùiÚ
("push_info");

134 
j
->
£cÚd
.
	`dump
(
f
);

135 
f
->
	`şo£_£ùiÚ
();

137 
f
->
	`şo£_£ùiÚ
();

139 
f
->
	`şo£_£ùiÚ
();

141 
f
->
	`şo£_£ùiÚ
();

143 
f
->
	`şo£_£ùiÚ
();

145 
	}
}

147 
	$objeùs_»ad_sync
(

148 cÚ¡ 
hobjeù_t
 &
hoid
,

149 
ušt64_t
 
off
,

150 
ušt64_t
 
Ën
,

151 
ušt32_t
 
İ_æags
,

152 
bufã¾i¡
 *
bl
è
ov”ride
;

154 
	`objeùs_»ad_async
(

155 cÚ¡ 
hobjeù_t
 &
hoid
,

156 cÚ¡ 
li¡
<
·œ
<
boo¡
::
tu¶e
<
ušt64_t
, ušt64_t, 
ušt32_t
>,

157 
·œ
<
bufã¾i¡
*, 
CÚ‹xt
*> > > &
to_»ad
,

158 
CÚ‹xt
 *
Ú_com¶‘e
,

159 
boŞ
 
ç¡_»ad
 = 
çl£
è
ov”ride
;

161 
´iv©e
:

163 
	sPushInfo
 {

164 
ObjeùRecov”yProg»ss
 
»cov”y_´og»ss
;

165 
ObjeùRecov”yInfo
 
»cov”y_šfo
;

166 
ObjeùCÚ‹xtRef
 
obc
;

167 
objeù_¡©_sum_t
 
¡©
;

168 
ObcLockMªag”
 
lock_mªag”
;

170 
	`dump
(
FÜm©‹r
 *
f
) const {

172 
f
->
	`İ’_objeù_£ùiÚ
("recovery_progress");

173 
»cov”y_´og»ss
.
	`dump
(
f
);

174 
f
->
	`şo£_£ùiÚ
();

177 
f
->
	`İ’_objeù_£ùiÚ
("recovery_info");

178 
»cov”y_šfo
.
	`dump
(
f
);

179 
f
->
	`şo£_£ùiÚ
();

182 
	}
};

183 
	gm­
<
	ghobjeù_t
, m­<
	gpg_sh¬d_t
, 
	gPushInfo
>> 
	gpushšg
;

186 
	sPuÎInfo
 {

187 
pg_sh¬d_t
 
	gäom
;

188 
hobjeù_t
 
	gsoid
;

189 
ObjeùRecov”yProg»ss
 
	g»cov”y_´og»ss
;

190 
ObjeùRecov”yInfo
 
	g»cov”y_šfo
;

191 
ObjeùCÚ‹xtRef
 
	gh—d_ùx
;

192 
ObjeùCÚ‹xtRef
 
	gobc
;

193 
objeù_¡©_sum_t
 
	g¡©
;

194 
boŞ
 
	gÿche_dÚt_Ãed
;

195 
ObcLockMªag”
 
	glock_mªag”
;

197 
dump
(
FÜm©‹r
 *
f
) const {

199 
	gf
->
İ’_objeù_£ùiÚ
("recovery_progress");

200 
	g»cov”y_´og»ss
.
dump
(
f
);

201 
	gf
->
şo£_£ùiÚ
();

204 
	gf
->
İ’_objeù_£ùiÚ
("recovery_info");

205 
	g»cov”y_šfo
.
dump
(
f
);

206 
	gf
->
şo£_£ùiÚ
();

210 
boŞ
 
is_com¶‘e
() const {

211  
	g»cov”y_´og»ss
.
is_com¶‘e
(
»cov”y_šfo
);

215 
	gm­
<
	ghobjeù_t
, 
	gPuÎInfo
> 
	gpuÎšg
;

218 
	gm­
<
	gpg_sh¬d_t
, 
	g£t
<
	ghobjeù_t
> > 
	gpuÎ_äom_³”
;

219 
ş—r_puÎ
(

220 
m­
<
hobjeù_t
, 
PuÎInfo
>::
™”©Ü
 
p™”
,

221 
boŞ
 
ş—r_puÎ_äom_³”
 = 
Œue
);

222 
ş—r_puÎ_äom
(

223 
m­
<
hobjeù_t
, 
PuÎInfo
>::
™”©Ü
 
p™”
);

225 
_do_push
(
OpReque¡Ref
 
İ
);

226 
_do_puÎ_»¥Ú£
(
OpReque¡Ref
 
İ
);

227 
	$do_push
(
OpReque¡Ref
 
İ
) {

228 ià(
	`is_´im¬y
()) {

229 
	`_do_puÎ_»¥Ú£
(
İ
);

231 
	`_do_push
(
İ
);

233 
	}
}

234 
do_puÎ
(
OpReque¡Ref
 
İ
);

235 
do_push_»¶y
(
OpReque¡Ref
 
İ
);

237 
boŞ
 
hªdË_push_»¶y
(
pg_sh¬d_t
 
³”
, cÚ¡ 
PushR•lyOp
 &
İ
, 
PushOp
 *
»¶y
);

238 
hªdË_puÎ
(
pg_sh¬d_t
 
³”
, 
PuÎOp
 &
İ
, 
PushOp
 *
»¶y
);

240 
	spuÎ_com¶‘e_šfo
 {

241 
hobjeù_t
 
	ghoid
;

242 
objeù_¡©_sum_t
 
	g¡©
;

244 
boŞ
 
hªdË_puÎ_»¥Ú£
(

245 
pg_sh¬d_t
 
äom
, cÚ¡ 
PushOp
 &
İ
, 
PuÎOp
 *
»¥Ú£
,

246 
li¡
<
puÎ_com¶‘e_šfo
> *
to_cÚtšue
,

247 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

248 
hªdË_push
(
pg_sh¬d_t
 
äom
, cÚ¡ 
PushOp
 &
İ
, 
PushR•lyOp
 *
»¥Ú£
,

249 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

251 
Œim_pushed_d©a
(cÚ¡ 
š‹rv®_£t
<
ušt64_t
> &
cİy_sub£t
,

252 cÚ¡ 
š‹rv®_£t
<
ušt64_t
> &
š‹rv®s_»ûived
,

253 
bufã¾i¡
 
d©a_»ûived
,

254 
š‹rv®_£t
<
ušt64_t
> *
š‹rv®s_u§bË
,

255 
bufã¾i¡
 *
d©a_u§bË
);

256 
_çed_puÎ
(
pg_sh¬d_t
 
äom
, cÚ¡ 
hobjeù_t
 &
soid
);

258 
£nd_pushes
(
´io
, 
m­
<
pg_sh¬d_t
, 
veùÜ
<
PushOp
> > &
pushes
);

259 
´•_push_İ_bÏnk
(cÚ¡ 
hobjeù_t
& 
soid
, 
PushOp
 *
İ
);

260 
£nd_puÎs
(

261 
´iÜ™y
,

262 
m­
<
pg_sh¬d_t
, 
veùÜ
<
PuÎOp
> > &
puÎs
);

264 
bud_push_İ
(cÚ¡ 
ObjeùRecov”yInfo
 &
»cov”y_šfo
,

265 cÚ¡ 
ObjeùRecov”yProg»ss
 &
´og»ss
,

266 
ObjeùRecov”yProg»ss
 *
out_´og»ss
,

267 
PushOp
 *
out_İ
,

268 
objeù_¡©_sum_t
 *
¡©
 = 0,

269 
boŞ
 
ÿche_dÚt_Ãed
 = 
Œue
);

270 
subm™_push_d©a
(cÚ¡ 
ObjeùRecov”yInfo
 &
»cov”y_šfo
,

271 
boŞ
 
fœ¡
,

272 
boŞ
 
com¶‘e
,

273 
boŞ
 
ÿche_dÚt_Ãed
,

274 cÚ¡ 
š‹rv®_£t
<
ušt64_t
> &
š‹rv®s_šşuded
,

275 
bufã¾i¡
 
d©a_šşuded
,

276 
bufã¾i¡
 
om­_h—d”
,

277 cÚ¡ 
m­
<
¡ršg
, 
bufã¾i¡
> &
©Œs
,

278 cÚ¡ 
m­
<
¡ršg
, 
bufã¾i¡
> &
om­_’Œ›s
,

279 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

280 
subm™_push_com¶‘e
(cÚ¡ 
ObjeùRecov”yInfo
 &
»cov”y_šfo
,

281 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
);

283 
ÿlc_şÚe_sub£ts
(

284 
SÇpS‘
& 
¢­£t
, cÚ¡ 
hobjeù_t
& 
poid
, cÚ¡ 
pg_missšg_t
& 
missšg
,

285 cÚ¡ 
hobjeù_t
 &
Ï¡_backfl
,

286 
š‹rv®_£t
<
ušt64_t
>& 
d©a_sub£t
,

287 
m­
<
hobjeù_t
, 
š‹rv®_£t
<
ušt64_t
>>& 
şÚe_sub£ts
,

288 
ObcLockMªag”
 &
lock_mªag”
);

289 
´•¬e_puÎ
(

290 
ev”siÚ_t
 
v
,

291 cÚ¡ 
hobjeù_t
& 
soid
,

292 
ObjeùCÚ‹xtRef
 
h—dùx
,

293 
RPGHªdË
 *
h
);

294 
¡¬t_pushes
(

295 cÚ¡ 
hobjeù_t
 &
soid
,

296 
ObjeùCÚ‹xtRef
 
obj
,

297 
RPGHªdË
 *
h
);

298 
´•_push_to_»¶iÿ
(

299 
ObjeùCÚ‹xtRef
 
obc
, cÚ¡ 
hobjeù_t
& 
soid
, 
pg_sh¬d_t
 
³”
,

300 
PushOp
 *
pİ
, 
boŞ
 
ÿche_dÚt_Ãed
 = 
Œue
);

301 
´•_push
(

302 
ObjeùCÚ‹xtRef
 
obc
,

303 cÚ¡ 
hobjeù_t
& 
oid
, 
pg_sh¬d_t
 
de¡
,

304 
PushOp
 *
İ
,

305 
boŞ
 
ÿche_dÚt_Ãed
);

306 
´•_push
(

307 
ObjeùCÚ‹xtRef
 
obc
,

308 cÚ¡ 
hobjeù_t
& 
soid
, 
pg_sh¬d_t
 
³”
,

309 
ev”siÚ_t
 
v”siÚ
,

310 
š‹rv®_£t
<
ušt64_t
> &
d©a_sub£t
,

311 
m­
<
hobjeù_t
, 
š‹rv®_£t
<
ušt64_t
>>& 
şÚe_sub£ts
,

312 
PushOp
 *
İ
,

313 
boŞ
 
ÿche
,

314 
ObcLockMªag”
 &&
lock_mªag”
);

315 
ÿlc_h—d_sub£ts
(

316 
ObjeùCÚ‹xtRef
 
obc
, 
SÇpS‘
& 
¢­£t
, cÚ¡ 
hobjeù_t
& 
h—d
,

317 cÚ¡ 
pg_missšg_t
& 
missšg
,

318 cÚ¡ 
hobjeù_t
 &
Ï¡_backfl
,

319 
š‹rv®_£t
<
ušt64_t
>& 
d©a_sub£t
,

320 
m­
<
hobjeù_t
, 
š‹rv®_£t
<
ušt64_t
>>& 
şÚe_sub£ts
,

321 
ObcLockMªag”
 &
lock_mªag”
);

322 
ObjeùRecov”yInfo
 
»ÿlc_sub£ts
(

323 cÚ¡ 
ObjeùRecov”yInfo
& 
»cov”y_šfo
,

324 
SÇpS‘CÚ‹xt
 *
ssc
,

325 
ObcLockMªag”
 &
lock_mªag”
);

330 
	sInProg»ssOp
 {

331 
ûph_tid_t
 
	gtid
;

332 
	g£t
<
	gpg_sh¬d_t
> 
	gwa™šg_fÜ_comm™
;

333 
CÚ‹xt
 *
	gÚ_comm™
;

334 
OpReque¡Ref
 
	gİ
;

335 
ev”siÚ_t
 
	gv
;

336 
InProg»ssOp
(

337 
ûph_tid_t
 
tid
, 
CÚ‹xt
 *
Ú_comm™
,

338 
OpReque¡Ref
 
İ
, 
ev”siÚ_t
 
v
)

339 : 
tid
Ñid), 
Ú_comm™
(on_commit),

340 
İ
(İ), 
v
(v) {}

341 
boŞ
 
dÚe
() const {

342  
	gwa™šg_fÜ_comm™
.
em±y
();

345 
	gm­
<
	gûph_tid_t
, 
	gInProg»ssOp
> 
	gš_´og»ss_İs
;

346 
	gpublic
:

347 
ä›nd
 
şass
 
C_OSD_OnOpComm™
;

349 
ÿÎ_wr™e_Üd”ed
(
¡d
::
funùiÚ
<()> &&
cb
è
ov”ride
 {

352 
cb
();

355 
subm™_Œª§ùiÚ
(

356 cÚ¡ 
hobjeù_t
 &
hoid
,

357 cÚ¡ 
objeù_¡©_sum_t
 &
d–_¡©s
,

358 cÚ¡ 
ev”siÚ_t
 &
©_v”siÚ
,

359 
PGT¿n§ùiÚUPŒ
 &&
t
,

360 cÚ¡ 
ev”siÚ_t
 &
Œim_to
,

361 cÚ¡ 
ev”siÚ_t
 &
rŞl_fÜw¬d_to
,

362 cÚ¡ 
veùÜ
<
pg_log_’Œy_t
> &
log_’Œ›s
,

363 
boo¡
::
İtiÚ®
<
pg_h™_£t_hi¡Üy_t
> &
h£t_hi¡Üy
,

364 
CÚ‹xt
 *
Ú_®l_comm™
,

365 
ûph_tid_t
 
tid
,

366 
osd_»qid_t
 
»qid
,

367 
OpReque¡Ref
 
İ


368 è
	gov”ride
;

370 
	g´iv©e
:

371 
Mes§ge
 * 
g’”©e_subİ
(

372 cÚ¡ 
hobjeù_t
 &
soid
,

373 cÚ¡ 
ev”siÚ_t
 &
©_v”siÚ
,

374 
ûph_tid_t
 
tid
,

375 
osd_»qid_t
 
»qid
,

376 
ev”siÚ_t
 
pg_Œim_to
,

377 
ev”siÚ_t
 
pg_rŞl_fÜw¬d_to
,

378 
hobjeù_t
 
Ãw_‹mp_oid
,

379 
hobjeù_t
 
disÿrd_‹mp_oid
,

380 cÚ¡ 
bufã¾i¡
 &
log_’Œ›s
,

381 
boo¡
::
İtiÚ®
<
pg_h™_£t_hi¡Üy_t
> &
h£t_hi¡Üy
,

382 
ObjeùStÜe
::
T¿n§ùiÚ
 &
İ_t
,

383 
pg_sh¬d_t
 
³”
,

384 cÚ¡ 
pg_šfo_t
 &
pšfo
);

385 
issue_İ
(

386 cÚ¡ 
hobjeù_t
 &
soid
,

387 cÚ¡ 
ev”siÚ_t
 &
©_v”siÚ
,

388 
ûph_tid_t
 
tid
,

389 
osd_»qid_t
 
»qid
,

390 
ev”siÚ_t
 
pg_Œim_to
,

391 
ev”siÚ_t
 
pg_rŞl_fÜw¬d_to
,

392 
hobjeù_t
 
Ãw_‹mp_oid
,

393 
hobjeù_t
 
disÿrd_‹mp_oid
,

394 cÚ¡ 
veùÜ
<
pg_log_’Œy_t
> &
log_’Œ›s
,

395 
boo¡
::
İtiÚ®
<
pg_h™_£t_hi¡Üy_t
> &
h£t_hi¡Üy
,

396 
InProg»ssOp
 *
İ
,

397 
ObjeùStÜe
::
T¿n§ùiÚ
 &
İ_t
);

398 
İ_comm™
(
InProg»ssOp
 *
İ
);

399 
do_»pİ_»¶y
(
OpReque¡Ref
 
İ
);

400 
do_»pİ
(
OpReque¡Ref
 
İ
);

402 
	sR•Modify
 {

403 
OpReque¡Ref
 
	gİ
;

404 
boŞ
 
	gcomm™‹d
;

405 
	gack”osd
;

406 
ev”siÚ_t
 
	gÏ¡_com¶‘e
;

407 
•och_t
 
	g•och_¡¬‹d
;

409 
	gObjeùStÜe
::
T¿n§ùiÚ
 
İt
, 
	gloÿÉ
;

411 
R•Modify
(è: 
comm™‹d
(
çl£
), 
ack”osd
(-1),

412 
•och_¡¬‹d
(0) {}

414 
	gûph
::
	tsh¬ed_±r
<
	tR•Modify
> 
	tR•ModifyRef
;

416 
	gC_OSD_R•ModifyComm™
;

418 
»pİ_comm™
(
R•ModifyRef
 
rm
);

419 
boŞ
 
	$auto_»·œ_suµÜ‹d
(ècÚ¡ 
ov”ride
 {  
çl£
; 
	}
}

422 
	$be_d“p_süub
(

423 cÚ¡ 
hobjeù_t
 &
poid
,

424 
SüubM­
 &
m­
,

425 
SüubM­Bud”
 &
pos
,

426 
SüubM­
::
objeù
 &
o
è
ov”ride
;

427 
ušt64_t
 
	$be_g‘_Údisk_size
(
ušt64_t
 
logiÿl_size
è
ov”ride
 { †ogiÿl_size; 
	}
}

	@osd/ScrubStore.cc

4 
	~"SüubStÜe.h
"

5 
	~"osd_ty³s.h
"

6 
	~"commÚ/süub_ty³s.h
"

7 
	~"šşude/¿dos/¿dos_ty³s.hµ
"

9 
	gÇme¥aû
 {

10 
ghobjeù_t
 
make_süub_objeù
(cÚ¡ 
¥g_t
& 
pgid
)

12 
o¡ršg¡»am
 
	gss
;

13 
	gss
 << "süub_" << 
	gpgid
;

14  
	gpgid
.
make_‹mp_ghobjeù
(
ss
.
¡r
());

17 
¡ršg
 
fœ¡_objeù_key
(
št64_t
 
poŞ
)

19 autØ
	ghoid
 = 
hobjeù_t
(
objeù_t
(),

23 
poŞ
,

25 
	ghoid
.
bud_hash_ÿche
();

26  "SCRUB_OBJ_" + 
	ghoid
.
to_¡r
();

30 
¡ršg
 
to_objeù_key
(
št64_t
 
poŞ
, cÚ¡ 
lib¿dos
::
objeù_id_t
& 
oid
)

32 autØ
hoid
 = 
hobjeù_t
(
objeù_t
(
oid
.
Çme
),

33 
oid
.
loÿtÜ
,

34 
oid
.
¢­
,

36 
poŞ
,

37 
oid
.
n¥aû
);

38 
	ghoid
.
bud_hash_ÿche
();

39  "SCRUB_OBJ_" + 
	ghoid
.
to_¡r
();

42 
¡ršg
 
Ï¡_objeù_key
(
št64_t
 
poŞ
)

44 autØ
	ghoid
 = 
hobjeù_t
(
objeù_t
(),

48 
poŞ
,

50 
	ghoid
.
bud_hash_ÿche
();

51  "SCRUB_OBJ_" + 
	ghoid
.
to_¡r
();

54 
¡ršg
 
fœ¡_¢­_key
(
št64_t
 
poŞ
)

59 autØ
	ghoid
 = 
hobjeù_t
(
objeù_t
(),

63 
poŞ
,

65 
	ghoid
.
bud_hash_ÿche
();

66  "SCRUB_SS_" + 
	ghoid
.
to_¡r
();

69 
¡ršg
 
to_¢­_key
(
št64_t
 
poŞ
, cÚ¡ 
lib¿dos
::
objeù_id_t
& 
oid
)

71 autØ
hoid
 = 
hobjeù_t
(
objeù_t
(
oid
.
Çme
),

72 
oid
.
loÿtÜ
,

73 
oid
.
¢­
,

75 
poŞ
,

76 
oid
.
n¥aû
);

77 
	ghoid
.
bud_hash_ÿche
();

78  "SCRUB_SS_" + 
	ghoid
.
to_¡r
();

81 
¡ršg
 
Ï¡_¢­_key
(
št64_t
 
poŞ
)

83 autØ
	ghoid
 = 
hobjeù_t
(
objeù_t
(),

87 
poŞ
,

89 
	ghoid
.
bud_hash_ÿche
();

90  "SCRUB_SS_" + 
	ghoid
.
to_¡r
();

94 
Çme¥aû
 
	gSüub
 {

96 
StÜe
*

97 
	gStÜe
::
ü—‹
(
ObjeùStÜe
* 
¡Üe
,

98 
ObjeùStÜe
::
T¿n§ùiÚ
* 
t
,

99 cÚ¡ 
¥g_t
& 
pgid
,

100 cÚ¡ 
cŞl_t
& 
cŞl
)

102 
as£¹
(
¡Üe
);

103 
as£¹
(
t
);

104 
ghobjeù_t
 
	goid
 = 
make_süub_objeù
(
pgid
);

105 
	gt
->
touch
(
cŞl
, 
oid
);

106  
Ãw
 
	gStÜe
{
	gcŞl
, 
	goid
, 
	g¡Üe
};

109 
	gStÜe
::
StÜe
(cÚ¡ 
cŞl_t
& 
cŞl
, cÚ¡ 
ghobjeù_t
& 
oid
, 
ObjeùStÜe
* 
¡Üe
)

110 : 
cŞl
(coll),

111 
hoid
(
oid
),

112 
driv”
(
¡Üe
, 
cŞl
, 
hoid
),

113 
back’d
(&
driv”
)

116 
	gStÜe
::~
StÜe
()

118 
as£¹
(
»suÉs
.
em±y
());

121 
	gStÜe
::
add_objeù_”rÜ
(
št64_t
 
poŞ
, cÚ¡ 
šcÚsi¡’t_obj_w¿µ”
& 
e
)

123 
bufã¾i¡
 
	gbl
;

124 
	ge
.
’code
(
bl
);

125 
	g»suÉs
[
to_objeù_key
(
poŞ
, 
e
.
objeù
)] = 
bl
;

128 
	gStÜe
::
add_¢­_”rÜ
(
št64_t
 
poŞ
, cÚ¡ 
šcÚsi¡’t_¢­£t_w¿µ”
& 
e
)

130 
bufã¾i¡
 
	gbl
;

131 
	ge
.
’code
(
bl
);

132 
	g»suÉs
[
to_¢­_key
(
poŞ
, 
e
.
objeù
)] = 
bl
;

135 
boŞ
 
	gStÜe
::
em±y
() const

137  
»suÉs
.
em±y
();

140 
	gStÜe
::
æush
(
ObjeùStÜe
::
T¿n§ùiÚ
* 
t
)

142 ià(
t
) {

143 
OSDriv”
::
OST¿n§ùiÚ
 
txn
 = 
driv”
.
g‘_Œª§ùiÚ
(
t
);

144 
	gback’d
.
£t_keys
(
»suÉs
, &
txn
);

146 
	g»suÉs
.
ş—r
();

149 
	gStÜe
::
ş—nup
(
ObjeùStÜe
::
T¿n§ùiÚ
* 
t
)

151 
t
->
»move
(
cŞl
, 
hoid
);

154 
	g¡d
::
veùÜ
<
bufã¾i¡
>

155 
StÜe
::
g‘_¢­_”rÜs
(
ObjeùStÜe
* 
¡Üe
,

156 
št64_t
 
poŞ
,

157 cÚ¡ 
lib¿dos
::
objeù_id_t
& 
¡¬t
,

158 
ušt64_t
 
max_»tuº
)

160 cÚ¡ 
¡ršg
 
	gbegš
 = (
¡¬t
.
Çme
.
em±y
() ?

161 
fœ¡_¢­_key
(
poŞ
è: 
to_¢­_key
ÕoŞ, 
¡¬t
));

162 cÚ¡ 
¡ršg
 
	g’d
 = 
Ï¡_¢­_key
(
poŞ
);

163  
g‘_”rÜs
(
¡Üe
, 
begš
, 
’d
, 
max_»tuº
);

166 
	g¡d
::
veùÜ
<
bufã¾i¡
>

167 
StÜe
::
g‘_objeù_”rÜs
(
ObjeùStÜe
* 
¡Üe
,

168 
št64_t
 
poŞ
,

169 cÚ¡ 
lib¿dos
::
objeù_id_t
& 
¡¬t
,

170 
ušt64_t
 
max_»tuº
)

172 cÚ¡ 
¡ršg
 
	gbegš
 = (
¡¬t
.
Çme
.
em±y
() ?

173 
fœ¡_objeù_key
(
poŞ
è: 
to_objeù_key
ÕoŞ, 
¡¬t
));

174 cÚ¡ 
¡ršg
 
	g’d
 = 
Ï¡_objeù_key
(
poŞ
);

175  
g‘_”rÜs
(
¡Üe
, 
begš
, 
’d
, 
max_»tuº
);

178 
	g¡d
::
veùÜ
<
bufã¾i¡
>

179 
StÜe
::
g‘_”rÜs
(
ObjeùStÜe
* 
¡Üe
,

180 cÚ¡ 
¡ršg
& 
begš
,

181 cÚ¡ 
¡ršg
& 
’d
,

182 
ušt64_t
 
max_»tuº
)

184 
	gveùÜ
<
	gbufã¾i¡
> 
	g”rÜs
;

185 autØ
	gÃxt
 = 
¡d
::
make_·œ
(
begš
, 
bufã¾i¡
{});

186 
	gmax_»tuº
 && !
	gback’d
.
g‘_Ãxt
(
Ãxt
.
fœ¡
, &next)) {

187 ià(
	gÃxt
.
	gfœ¡
 >ğ
’d
)

189 
	g”rÜs
.
push_back
(
Ãxt
.
£cÚd
);

190 
	gmax_»tuº
--;

192  
	g”rÜs
;

	@osd/ScrubStore.h

4 #iâdeà
CEPH_SCRUB_RESULT_H


5 
	#CEPH_SCRUB_RESULT_H


	)

7 
	~"SÇpM­³r.h
"

8 
	~"commÚ/m­_ÿch”.hµ
"

10 
Çme¥aû
 
	glib¿dos
 {

11 
	gobjeù_id_t
;

14 
	gšcÚsi¡’t_obj_w¿µ”
;

15 
	gšcÚsi¡’t_¢­£t_w¿µ”
;

17 
Çme¥aû
 
	gSüub
 {

19 şas 
	cStÜe
 {

20 
	gpublic
:

21 ~
StÜe
();

22 
StÜe
* 
ü—‹
(
ObjeùStÜe
* 
¡Üe
,

23 
ObjeùStÜe
::
T¿n§ùiÚ
* 
t
,

24 cÚ¡ 
¥g_t
& 
pgid
,

25 cÚ¡ 
cŞl_t
& 
cŞl
);

26 
add_objeù_”rÜ
(
št64_t
 
poŞ
, cÚ¡ 
šcÚsi¡’t_obj_w¿µ”
& 
e
);

27 
add_¢­_”rÜ
(
št64_t
 
poŞ
, cÚ¡ 
šcÚsi¡’t_¢­£t_w¿µ”
& 
e
);

28 
boŞ
 
em±y
() const;

29 
æush
(
ObjeùStÜe
::
T¿n§ùiÚ
 *);

30 
ş—nup
(
ObjeùStÜe
::
T¿n§ùiÚ
 *);

31 
	g¡d
::
veùÜ
<
bufã¾i¡
> 
g‘_¢­_”rÜs
(
ObjeùStÜe
* 
¡Üe
,

32 
št64_t
 
poŞ
,

33 cÚ¡ 
lib¿dos
::
objeù_id_t
& 
¡¬t
,

34 
ušt64_t
 
max_»tuº
);

35 
	g¡d
::
veùÜ
<
bufã¾i¡
> 
g‘_objeù_”rÜs
(
ObjeùStÜe
* 
¡Üe
,

36 
št64_t
 
poŞ
,

37 cÚ¡ 
lib¿dos
::
objeù_id_t
& 
¡¬t
,

38 
ušt64_t
 
max_»tuº
);

39 
	g´iv©e
:

40 
StÜe
(cÚ¡ 
cŞl_t
& 
cŞl
, cÚ¡ 
ghobjeù_t
& 
oid
, 
ObjeùStÜe
* 
¡Üe
);

41 
	g¡d
::
veùÜ
<
bufã¾i¡
> 
g‘_”rÜs
(
ObjeùStÜe
* 
¡Üe
,

42 cÚ¡ 
¡ršg
& 
¡¬t
, cÚ¡ sŒšg& 
’d
,

43 
ušt64_t
 
max_»tuº
);

44 
	g´iv©e
:

45 cÚ¡ 
cŞl_t
 
cŞl
;

46 cÚ¡ 
ghobjeù_t
 
	ghoid
;

49 
OSDriv”
 
	gdriv”
;

50 
	gM­Cach”
::
M­Cach”
<
¡d
::
¡ršg
, 
	gbufã¾i¡
> 
	gback’d
;

51 
	gm­
<
	g¡ršg
, 
	gbufã¾i¡
> 
	g»suÉs
;

	@osd/Session.cc

4 
	~"PG.h
"

5 
	~"SessiÚ.h
"

7 
	~"commÚ/debug.h
"

9 
	#dout_cÚ‹xt
 
cù


	)

10 
	#dout_subsys
 
ûph_subsys_osd


	)

12 
	gSessiÚ
::
	$ş—r_backoffs
()

14 
m­
<
¥g_t
,m­<
hobjeù_t
,
£t
<
BackoffRef
>>> 
ls
;

16 
Mu‹x
::
Lock”
 
	`l
(
backoff_lock
);

17 
ls
.
	`sw­
(
backoffs
);

18 
backoff_couÁ
 = 0;

20 auto& 
i
 : 
ls
) {

21 auto& 
p
 : 
i
.
£cÚd
) {

22 auto& 
b
 : 
p
.
£cÚd
) {

23 
Mu‹x
::
Lock”
 
	`l
(
b
->
lock
);

24 ià(
b
->
pg
) {

25 
	`as£¹
(
b
->
£ssiÚ
 =ğ
this
);

26 
	`as£¹
(
b
->
	`is_Ãw
(è|| b->
	`is_acked
());

27 
b
->
pg
->
	`rm_backoff
(b);

28 
b
->
pg
.
	`»£t
();

29 
b
->
£ssiÚ
.
	`»£t
();

30 } ià(
b
->
£ssiÚ
) {

31 
	`as£¹
(
b
->
£ssiÚ
 =ğ
this
);

32 
	`as£¹
(
b
->
	`is_d–‘šg
());

33 
b
->
£ssiÚ
.
	`»£t
();

38 
	}
}

40 
	gSessiÚ
::
	$ack_backoff
(

41 
C•hCÚ‹xt
 *
cù
,

42 
¥g_t
 
pgid
,

43 
ušt64_t
 
id
,

44 cÚ¡ 
hobjeù_t
& 
begš
,

45 cÚ¡ 
hobjeù_t
& 
’d
)

47 
Mu‹x
::
Lock”
 
	`l
(
backoff_lock
);

48 autØ
p
 = 
backoffs
.
	`fšd
(
pgid
);

49 ià(
p
 =ğ
backoffs
.
	`’d
()) {

50 
	`dout
(20è<< 
__func__
 << " " << 
pgid
 << " " << 
id
 << " [" << 
begš
 << ","

51 << 
’d
 << "èpg‚Ù found" << 
d’dl
;

54 autØ
q
 = 
p
->
£cÚd
.
	`fšd
(
begš
);

55 ià(
q
 =ğ
p
->
£cÚd
.
	`’d
()) {

56 
	`dout
(20è<< 
__func__
 << " " << 
pgid
 << " " << 
id
 << " [" << 
begš
 << ","

57 << 
’d
 << "èbegš‚Ù found" << 
d’dl
;

60 autØ
i
 = 
q
->
£cÚd
.
	`begš
(); i !ğq->£cÚd.
	`’d
(); ++i) {

61 
Backoff
 *
b
 = (*
i
).
	`g‘
();

62 ià(
b
->
id
 == id) {

63 ià(
b
->
	`is_Ãw
()) {

64 
b
->
¡©e
 = 
Backoff
::
STATE_ACKED
;

65 
	`dout
(20è<< 
__func__
 << "‚ow " << *
b
 << 
d’dl
;

66 } ià(
b
->
	`is_d–‘šg
()) {

67 
	`dout
(20è<< 
__func__
 << " d–‘šg " << *
b
 << 
d’dl
;

68 
q
->
£cÚd
.
	`”a£
(
i
);

69 --
backoff_couÁ
;

74 ià(
q
->
£cÚd
.
	`em±y
()) {

75 
	`dout
(20è<< 
__func__
 << " cË¬šg begš bš " << 
q
->
fœ¡
 << 
d’dl
;

76 
p
->
£cÚd
.
	`”a£
(
q
);

77 ià(
p
->
£cÚd
.
	`em±y
()) {

78 
	`dout
(20è<< 
__func__
 << " cË¬šg…g bš " << 
p
->
fœ¡
 << 
d’dl
;

79 
backoffs
.
	`”a£
(
p
);

82 
	`as£¹
(!
backoff_couÁ
 =ğ
backoffs
.
	`em±y
());

83 
	}
}

85 
boŞ
 
	gSessiÚ
::
	$check_backoff
(

86 
C•hCÚ‹xt
 *
cù
, 
¥g_t
 
pgid
, cÚ¡ 
hobjeù_t
& 
oid
, cÚ¡ 
Mes§ge
 *
m
)

88 
BackoffRef
 
	`b
(
	`have_backoff
(
pgid
, 
oid
));

89 ià(
b
) {

90 
	`dout
(10è<< 
__func__
 << " sessiÚ " << 
this
 << " ha backofà" << *
b


91 << " fÜ " << *
m
 << 
d’dl
;

92 
	`as£¹
(!
b
->
	`is_acked
(è|| !
g_cÚf
->
osd_debug_üash_Ú_ignÜed_backoff
);

93  
Œue
;

98 ià(!
cÚ
) {

99 
	`dout
(10è<< 
__func__
 << " sessiÚ " << 
this
 << " discÚÃùed" << 
d’dl
;

100  
Œue
;

102  
çl£
;

103 
	}
}

	@osd/Session.h

15 #iâdeà
CEPH_OSD_SESSION_H


16 
	#CEPH_OSD_SESSION_H


	)

18 
	~"commÚ/RefCouÁedObj.h
"

19 
	~"commÚ/Mu‹x.h
"

20 
	~"šşude/¥šlock.h
"

21 
	~"OSDC­.h
"

22 
	~"W©ch.h
"

23 
	~"OSDM­.h
"

27 
	gSessiÚ
;

28 
	gboo¡
::
	tšŒusive_±r
<
	tSessiÚ
> 
	tSessiÚRef
;

29 
	gBackoff
;

30 
	gboo¡
::
	tšŒusive_±r
<
	tBackoff
> 
	tBackoffRef
;

31 
şass
 
	gPG
;

32 #ifdeà
PG_DEBUG_REFS


33 
	~"commÚ/Œacked_št_±r.hµ
"

34 
	gT¿ckedIÁPŒ
<
	tPG
> 
	tPGRef
;

36 
	gboo¡
::
	tšŒusive_±r
<
	tPG
> 
	tPGRef
;

70 
	gBackoff
 : 
public
 
RefCouÁedObjeù
 {

72 
STATE_NEW
 = 1,

73 
	gSTATE_ACKED
 = 2,

74 
	gSTATE_DELETING
 = 3

76 
	g¡d
::
©omic
<> 
¡©e
 = {
STATE_NEW
};

77 
¥g_t
 
	gpgid
;

78 
ušt64_t
 
	gid
 = 0;

80 
boŞ
 
is_Ãw
() const {

81  
	g¡©e
.
lßd
(è=ğ
STATE_NEW
;

83 
boŞ
 
is_acked
() const {

84  
	g¡©e
.
lßd
(è=ğ
STATE_ACKED
;

86 
boŞ
 
is_d–‘šg
() const {

87  
	g¡©e
.
lßd
(è=ğ
STATE_DELETING
;

89 cÚ¡ *
g‘_¡©e_Çme
() const {

90 
	g¡©e
.
lßd
()) {

91 
	gSTATE_NEW
:  "new";

92 
	gSTATE_ACKED
:  "acked";

93 
	gSTATE_DELETING
:  "deleting";

98 
Mu‹x
 
	glock
;

103 
PGRef
 
	gpg
;

104 
SessiÚRef
 
	g£ssiÚ
;

105 
hobjeù_t
 
	gbegš
, 
	g’d
;

107 
Backoff
(
¥g_t
 
pgid
, 
PGRef
 
pg
, 
SessiÚRef
 
s
,

108 
ušt64_t
 
i
,

109 cÚ¡ 
hobjeù_t
& 
b
, cÚ¡ hobjeù_t& 
e
)

110 : 
RefCouÁedObjeù
(
g_ûph_cÚ‹xt
, 0),

111 
pgid
(pgid),

112 
id
(
i
),

113 
lock
("Backoff::lock"),

114 
pg
(pg),

115 
£ssiÚ
(
s
),

116 
begš
(
b
),

117 
’d
(
e
) {}

119 
ä›nd
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gBackoff
& 
	gb
) {

120  
	gout
 << "Backoff(" << &
	gb
 << " " << b.
	gpgid
 << " " << b.
	gid


121 << " " << 
	gb
.
g‘_¡©e_Çme
()

122 << " [" << 
	gb
.
	gbegš
 << "," << b.
	g’d
 << ") "

123 << " sessiÚ " << 
	gb
.
	g£ssiÚ


124 << "…g " << 
	gb
.
	gpg
 << ")";

130 
	gSessiÚ
 : 
public
 
RefCouÁedObjeù
 {

131 
EÁ™yName
 
’t™y_Çme
;

132 
OSDC­
 
	gÿps
;

133 
št64_t
 
	gauid
;

134 
CÚÃùiÚRef
 
	gcÚ
;

135 
W©chCÚS‹
 
	gw¡©e
;

137 
Mu‹x
 
	g£ssiÚ_di¥©ch_lock
;

138 
	gboo¡
::
šŒusive
::
li¡
<
OpReque¡
> 
wa™šg_Ú_m­
;

140 
	gûph
::
¥šlock
 
£Á_•och_lock
;

141 
•och_t
 
	gÏ¡_£Á_•och
;

142 
	gûph
::
¥šlock
 
»ûived_m­_lock
;

143 
•och_t
 
	g»ûived_m­_•och
;

146 
Mu‹x
 
	gbackoff_lock
;

147 
	g¡d
::
©omic
<> 
backoff_couÁ
= {0};

148 
	gm­
<
	g¥g_t
,m­<
	ghobjeù_t
,
	g£t
<
	gBackoffRef
>>> 
	gbackoffs
;

150 
	g¡d
::
©omic
<
ušt64_t
> 
backoff_£q
 = {0};

152 
ex¶ic™
 
SessiÚ
(
C•hCÚ‹xt
 *
cù
) :

153 
RefCouÁedObjeù
(
cù
),

154 
auid
(-1), 
cÚ
(0),

155 
w¡©e
(
cù
),

156 
£ssiÚ_di¥©ch_lock
("Session::session_dispatch_lock"),

157 
Ï¡_£Á_•och
(0), 
»ûived_m­_•och
(0),

158 
backoff_lock
("Session::backoff_lock")

161 
ack_backoff
(

162 
C•hCÚ‹xt
 *
cù
,

163 
¥g_t
 
pgid
,

164 
ušt64_t
 
id
,

165 cÚ¡ 
hobjeù_t
& 
¡¬t
,

166 cÚ¡ 
hobjeù_t
& 
’d
);

168 
BackoffRef
 
have_backoff
(
¥g_t
 
pgid
, cÚ¡ 
hobjeù_t
& 
oid
) {

169 ià(!
	gbackoff_couÁ
.
lßd
()) {

170  
	gnuÎ±r
;

172 
	gMu‹x
::
Lock”
 
l
(
backoff_lock
);

173 
as£¹
(!
backoff_couÁ
 =ğ
backoffs
.
em±y
());

174 autØ
	gi
 = 
backoffs
.
fšd
(
pgid
);

175 ià(
	gi
 =ğ
backoffs
.
’d
()) {

176  
nuÎ±r
;

178 autØ
	gp
 = 
i
->
£cÚd
.
low”_bound
(
oid
);

179 ià(
	gp
 !ğ
i
->
£cÚd
.
begš
() &&

180 
p
->
fœ¡
 > 
oid
) {

181 --
p
;

183 ià(
	gp
 !ğ
i
->
£cÚd
.
’d
()) {

184 
r
 = 
cmp
(
oid
, 
p
->
fœ¡
);

185 ià(
	gr
 =ğ0 || 
r
 > 0) {

186 auto& 
q
 : 
p
->
£cÚd
) {

187 ià(
r
 =ğ0 || 
oid
 < 
q
->
’d
) {

188  &(*
q
);

193  
	gnuÎ±r
;

196 
boŞ
 
check_backoff
(

197 
C•hCÚ‹xt
 *
cù
, 
¥g_t
 
pgid
, cÚ¡ 
hobjeù_t
& 
oid
, cÚ¡ 
Mes§ge
 *
m
);

199 
add_backoff
(
BackoffRef
 
b
) {

200 
	gMu‹x
::
Lock”
 
l
(
backoff_lock
);

201 
as£¹
(!
backoff_couÁ
 =ğ
backoffs
.
em±y
());

202 
	gbackoffs
[
b
->
pgid
][b->
begš
].
š£¹
(b);

203 ++
	gbackoff_couÁ
;

207 
rm_backoff
(
BackoffRef
 
b
) {

208 
	gMu‹x
::
Lock”
 
l
(
backoff_lock
);

209 
as£¹
(
b
->
lock
.
is_locked_by_me
());

210 
as£¹
(
b
->
£ssiÚ
 =ğ
this
);

211 autØ
	gi
 = 
backoffs
.
fšd
(
b
->
pgid
);

212 ià(
	gi
 !ğ
backoffs
.
’d
()) {

214 autØ
p
 = 
i
->
£cÚd
.
fšd
(
b
->
begš
);

215 ià(
	gp
 !ğ
i
->
£cÚd
.
’d
()) {

216 autØ
q
 = 
p
->
£cÚd
.
fšd
(
b
);

217 ià(
	gq
 !ğ
p
->
£cÚd
.
’d
()) {

218 
p
->
£cÚd
.
”a£
(
q
);

219 --
	gbackoff_couÁ
;

220 ià(
	gp
->
	g£cÚd
.
em±y
()) {

221 
	gi
->
	g£cÚd
.
”a£
(
p
);

222 ià(
	gi
->
	g£cÚd
.
em±y
()) {

223 
	gbackoffs
.
”a£
(
i
);

229 
as£¹
(!
backoff_couÁ
 =ğ
backoffs
.
em±y
());

231 
ş—r_backoffs
();

	@osd/SnapMapper.cc

15 
	~"SÇpM­³r.h
"

17 
	#dout_cÚ‹xt
 
cù


	)

18 
	#dout_subsys
 
ûph_subsys_osd


	)

19 #undeà
dout_´efix


20 
	#dout_´efix
 *
_dout
 << "¢­_m­³r."

	)

22 
usšg
 
	g¡d
::
¡ršg
;

24 cÚ¡ 
¡ršg
 
	gSÇpM­³r
::
MAPPING_PREFIX
 = "MAP_";

25 cÚ¡ 
¡ršg
 
	gSÇpM­³r
::
OBJECT_PREFIX
 = "OBJ_";

27 
	gOSDriv”
::
g‘_keys
(

28 cÚ¡ 
¡d
::
£t
<¡d::
¡ršg
> &
keys
,

29 
¡d
::
m­
<¡d::
¡ršg
, 
bufã¾i¡
> *
out
)

31  
	gos
->
om­_g‘_v®ues
(
ch
, 
hoid
, 
keys
, 
out
);

34 
	gOSDriv”
::
g‘_Ãxt
(

35 cÚ¡ 
¡d
::
¡ršg
 &
key
,

36 
·œ
<
¡d
::
¡ršg
, 
bufã¾i¡
> *
Ãxt
)

38 
	gObjeùM­
::
ObjeùM­I‹¿tÜ
 
™”
 =

39 
os
->
g‘_om­_™”©Ü
(
ch
, 
hoid
);

40 ià(!
	g™”
) {

41 
ûph_abÜt
();

42  -
	gEINVAL
;

44 
	g™”
->
uµ”_bound
(
key
);

45 ià(
	g™”
->
v®id
()) {

46 ià(
	gÃxt
)

47 *
	gÃxt
 = 
make_·œ
(
™”
->
key
(), i‹r->
v®ue
());

50  -
	gENOENT
;

54 
	sM­pšg
 {

55 
¢­id_t
 
	m¢­
;

56 
hobjeù_t
 
	mhoid
;

57 
ex¶ic™
 
M­pšg
(cÚ¡ 
·œ
<
¢­id_t
, 
hobjeù_t
> &
š
)

58 : 
¢­
(
š
.
fœ¡
), 
hoid
(š.
£cÚd
) {}

59 
M­pšg
(è: 
¢­
(0) {}

60 
’code
(
bufã¾i¡
 &
bl
) const {

61 
ENCODE_START
(1, 1, 
bl
);

62 
’code
(
¢­
, 
bl
);

63 
’code
(
hoid
, 
bl
);

64 
ENCODE_FINISH
(
bl
);

66 
decode
(
bufã¾i¡
::
™”©Ü
 &
bl
) {

67 
DECODE_START
(1, 
bl
);

68 
decode
(
¢­
, 
bl
);

69 
decode
(
hoid
, 
bl
);

70 
DECODE_FINISH
(
bl
);

73 
	$WRITE_CLASS_ENCODER
(
M­pšg
)

75 
¡ršg
 
SÇpM­³r
::
	$g‘_´efix
(
¢­id_t
 
¢­
)

77 
buf
[100];

78 
Ën
 = 
	`¢´štf
(

79 
buf
, (buf),

80 "%.*X_", ()((
¢­
)*2),

81 
¡©ic_ÿ¡
<>(
¢­
));

82  
MAPPING_PREFIX
 + 
	`¡ršg
(
buf
, 
Ën
);

83 
	}
}

85 
¡ršg
 
	gSÇpM­³r
::
to_¿w_key
(

86 cÚ¡ 
·œ
<
¢­id_t
, 
hobjeù_t
> &
š
)

88  
g‘_´efix
(
š
.
fœ¡
è+ 
	gsh¬d_´efix
 + 
	gš
.
	g£cÚd
.
to_¡r
();

91 
	g·œ
<
	g¡ršg
, 
	gbufã¾i¡
> 
	gSÇpM­³r
::
to_¿w
(

92 cÚ¡ 
·œ
<
¢­id_t
, 
hobjeù_t
> &
š
)

94 
bufã¾i¡
 
	gbl
;

95 
’code
(
M­pšg
(
š
), 
bl
);

96  
make_·œ
(

97 
to_¿w_key
(
š
),

98 
bl
);

101 
	g·œ
<
	g¢­id_t
, 
	ghobjeù_t
> 
	gSÇpM­³r
::
äom_¿w
(

102 cÚ¡ 
·œ
<
¡d
::
¡ršg
, 
bufã¾i¡
> &
image
)

104 
M­pšg
 
	gm­
;

105 
bufã¾i¡
 
bl
(
image
.
£cÚd
);

106 
	gbufã¾i¡
::
™”©Ü
 
bp
(
bl
.
begš
());

107 
decode
(
m­
, 
bp
);

108  
make_·œ
(
m­
.
¢­
, m­.
hoid
);

111 
boŞ
 
	gSÇpM­³r
::
	$is_m­pšg
(cÚ¡ 
¡ršg
 &
to_‹¡
)

113  
to_‹¡
.
	`sub¡r
(0, 
MAPPING_PREFIX
.
	`size
()) == MAPPING_PREFIX;

114 
	}
}

116 
¡ršg
 
	gSÇpM­³r
::
	$to_objeù_key
(cÚ¡ 
hobjeù_t
 &
hoid
)

118  
OBJECT_PREFIX
 + 
sh¬d_´efix
 + 
hoid
.
	`to_¡r
();

119 
	}
}

121 
	gSÇpM­³r
::
objeù_¢­s
::
	$’code
(
bufã¾i¡
 &
bl
) const

123 
	`ENCODE_START
(1, 1, 
bl
);

124 
	`’code
(
oid
, 
bl
);

125 
	`’code
(
¢­s
, 
bl
);

126 
	`ENCODE_FINISH
(
bl
);

127 
	}
}

129 
	gSÇpM­³r
::
objeù_¢­s
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

131 
	`DECODE_START
(1, 
bl
);

132 
	`decode
(
oid
, 
bl
);

133 
	`decode
(
¢­s
, 
bl
);

134 
	`DECODE_FINISH
(
bl
);

135 
	}
}

137 
boŞ
 
	gSÇpM­³r
::
	$check
(cÚ¡ 
hobjeù_t
 &
hoid
) const

139 ià(
hoid
.
	`m©ch
(
mask_b™s
, 
m©ch
)) {

140  
Œue
;

142 
d”r
 << 
__func__
 << " " << 
hoid
 << " mask_b™ " << 
mask_b™s


143 << " m©ch 0x" << 
¡d
::
hex
 << 
m©ch
 << std::
dec
 << " is false"

144 << 
d’dl
;

145  
çl£
;

146 
	}
}

148 
	gSÇpM­³r
::
	$g‘_¢­s
(

149 cÚ¡ 
hobjeù_t
 &
oid
,

150 
objeù_¢­s
 *
out
)

152 
	`as£¹
(
	`check
(
oid
));

153 
£t
<
¡ršg
> 
keys
;

154 
m­
<
¡ršg
, 
bufã¾i¡
> 
gÙ
;

155 
keys
.
	`š£¹
(
	`to_objeù_key
(
oid
));

156 
r
 = 
back’d
.
	`g‘_keys
(
keys
, &
gÙ
);

157 ià(
r
 < 0) {

158 
	`dout
(20è<< 
__func__
 << " " << 
oid
 << " gÙƒ¼ " << 
r
 << 
d’dl
;

159  
r
;

161 ià(
gÙ
.
	`em±y
()) {

162 
	`dout
(20è<< 
__func__
 << " " << 
oid
 << " gÙ.em±y()" << 
d’dl
;

163  -
ENOENT
;

165 ià(
out
) {

166 
bufã¾i¡
::
™”©Ü
 
bp
 = 
gÙ
.
	`begš
()->
£cÚd
.begin();

167 
	`decode
(*
out
, 
bp
);

168 
	`dout
(20è<< 
__func__
 << " " << 
oid
 << " " << 
out
->
¢­s
 << 
d’dl
;

169 ià(
out
->
¢­s
.
	`em±y
()) {

170 
	`dout
(1è<< 
__func__
 << " " << 
oid
 << "ƒm±y sÇp£t" << 
d’dl
;

171 
	`as£¹
(!
cù
->
_cÚf
->
osd_debug_v”ify_¢­s
);

174 
	`dout
(20è<< 
__func__
 << " " << 
oid
 << " (ouˆ=ğNULL)" << 
d’dl
;

177 
	}
}

179 
	gSÇpM­³r
::
ş—r_¢­s
(

180 cÚ¡ 
hobjeù_t
 &
oid
,

181 
M­Cach”
::
T¿n§ùiÚ
<
¡d
::
¡ršg
, 
bufã¾i¡
> *
t
)

183 
dout
(20è<< 
	g__func__
 << " " << 
	goid
 << 
	gd’dl
;

184 
as£¹
(
check
(
oid
));

185 
	g£t
<
	g¡ršg
> 
	gto_»move
;

186 
	gto_»move
.
š£¹
(
to_objeù_key
(
oid
));

187 ià(
	gg_cÚf
->
	gsubsys
.
	gshould_g©h”
<
	gûph_subsys_osd
, 20>()) {

188 auto& 
	gi
 : 
to_»move
) {

189 
dout
(20è<< 
__func__
 << "„m " << 
i
 << 
d’dl
;

192 
	gback’d
.
»move_keys
(
to_»move
, 
t
);

195 
	gSÇpM­³r
::
£t_¢­s
(

196 cÚ¡ 
hobjeù_t
 &
oid
,

197 cÚ¡ 
objeù_¢­s
 &
š
,

198 
M­Cach”
::
T¿n§ùiÚ
<
¡d
::
¡ršg
, 
bufã¾i¡
> *
t
)

200 
as£¹
(
check
(
oid
));

201 
	gm­
<
	g¡ršg
, 
	gbufã¾i¡
> 
	gto_£t
;

202 
bufã¾i¡
 
	gbl
;

203 
’code
(
š
, 
bl
);

204 
	gto_£t
[
to_objeù_key
(
oid
)] = 
bl
;

205 
dout
(20è<< 
	g__func__
 << " " << 
	goid
 << " " << 
	gš
.
	g¢­s
 << 
	gd’dl
;

206 ià(
	gg_cÚf
->
	gsubsys
.
	gshould_g©h”
<
	gûph_subsys_osd
, 20>()) {

207 auto& 
	gi
 : 
to_£t
) {

208 
dout
(20è<< 
__func__
 << " s‘ " << 
i
.
fœ¡
 << 
d’dl
;

211 
	gback’d
.
£t_keys
(
to_£t
, 
t
);

214 
	gSÇpM­³r
::
upd©e_¢­s
(

215 cÚ¡ 
hobjeù_t
 &
oid
,

216 cÚ¡ 
£t
<
¢­id_t
> &
Ãw_¢­s
,

217 cÚ¡ 
£t
<
¢­id_t
> *
Şd_¢­s_check
,

218 
M­Cach”
::
T¿n§ùiÚ
<
¡d
::
¡ršg
, 
bufã¾i¡
> *
t
)

220 
dout
(20è<< 
	g__func__
 << " " << 
	goid
 << " " << 
	gÃw_¢­s


221 << " wa " << (
	gŞd_¢­s_check
 ? *Şd_¢­s_check : 
£t
<
¢­id_t
>())

222 << 
d’dl
;

223 
as£¹
(
check
(
oid
));

224 ià(
	gÃw_¢­s
.
em±y
())

225  
»move_oid
(
oid
, 
t
);

227 
objeù_¢­s
 
	gout
;

228 
	gr
 = 
g‘_¢­s
(
oid
, &
out
);

229 ià(
	gr
 < 0)

230  
	gr
;

231 ià(
	gŞd_¢­s_check
)

232 
as£¹
(
out
.
¢­s
 =ğ*
Şd_¢­s_check
);

234 
objeù_¢­s
 
š
(
oid
, 
Ãw_¢­s
);

235 
£t_¢­s
(
oid
, 
š
, 
t
);

237 
	g£t
<
	g¡ršg
> 
	gto_»move
;

238 
	g£t
<
	g¢­id_t
>::
™”©Ü
 
i
 = 
out
.
¢­s
.
begš
();

239 
	gi
 !ğ
out
.
¢­s
.
’d
();

240 ++
	gi
) {

241 ià(!
	gÃw_¢­s
.
couÁ
(*
i
)) {

242 
	gto_»move
.
š£¹
(
to_¿w_key
(
make_·œ
(*
i
, 
oid
)));

245 ià(
	gg_cÚf
->
	gsubsys
.
	gshould_g©h”
<
	gûph_subsys_osd
, 20>()) {

246 auto& 
	gi
 : 
to_»move
) {

247 
dout
(20è<< 
__func__
 << "„m " << 
i
 << 
d’dl
;

250 
	gback’d
.
»move_keys
(
to_»move
, 
t
);

254 
	gSÇpM­³r
::
add_oid
(

255 cÚ¡ 
hobjeù_t
 &
oid
,

256 cÚ¡ 
£t
<
¢­id_t
>& 
¢­s
,

257 
M­Cach”
::
T¿n§ùiÚ
<
¡d
::
¡ršg
, 
bufã¾i¡
> *
t
)

259 
dout
(20è<< 
	g__func__
 << " " << 
	goid
 << " " << 
	g¢­s
 << 
	gd’dl
;

260 
as£¹
(!
¢­s
.
em±y
());

261 
as£¹
(
check
(
oid
));

263 
objeù_¢­s
 
	gout
;

264 
	gr
 = 
g‘_¢­s
(
oid
, &
out
);

265 ià(
	gr
 !ğ-
ENOENT
) {

266 
d”r
 << 
__func__
 << " foundƒxi¡šg sÇp m­³d oÀ" << 
oid


267 << ",„emovšg" << 
d’dl
;

268 
as£¹
(!
cù
->
_cÚf
->
osd_debug_v”ify_¢­s
);

269 
»move_oid
(
oid
, 
t
);

273 
objeù_¢­s
 
_¢­s
(
oid
, 
¢­s
);

274 
£t_¢­s
(
oid
, 
_¢­s
, 
t
);

276 
	gm­
<
	g¡ršg
, 
	gbufã¾i¡
> 
	gto_add
;

277 
	g£t
<
	g¢­id_t
>::
™”©Ü
 
i
 = 
¢­s
.
begš
();

278 
	gi
 !ğ
¢­s
.
’d
();

279 ++
	gi
) {

280 
	gto_add
.
š£¹
(
to_¿w
(
make_·œ
(*
i
, 
oid
)));

282 ià(
	gg_cÚf
->
	gsubsys
.
	gshould_g©h”
<
	gûph_subsys_osd
, 20>()) {

283 auto& 
	gi
 : 
to_add
) {

284 
dout
(20è<< 
__func__
 << " s‘ " << 
i
.
fœ¡
 << 
d’dl
;

287 
	gback’d
.
£t_keys
(
to_add
, 
t
);

290 
	gSÇpM­³r
::
g‘_Ãxt_objeùs_to_Œim
(

291 
¢­id_t
 
¢­
,

292 
max
,

293 
veùÜ
<
hobjeù_t
> *
out
)

295 
as£¹
(
out
);

296 
as£¹
(
out
->
em±y
());

297 
	gr
 = 0;

298 
	g£t
<
	g¡ršg
>::
™”©Ü
 
i
 = 
´efixes
.
begš
();

299 
	gi
 !ğ
´efixes
.
’d
(è&& 
out
->
size
(è< 
max
 && 
r
 == 0;

300 ++
	gi
) {

301 
¡ršg
 
´efix
(
g‘_´efix
(
¢­
è+ *
i
);

302 
¡ršg
 
	gpos
 = 
´efix
;

303 
	gout
->
size
(è< 
	gmax
) {

304 
	g·œ
<
	g¡ršg
, 
	gbufã¾i¡
> 
	gÃxt
;

305 
	gr
 = 
back’d
.
g‘_Ãxt
(
pos
, &
Ãxt
);

306 
dout
(20è<< 
	g__func__
 << " g‘_Ãxt(" << 
	gpos
 << "è»tuº " << 
	gr


307 << " " << 
	gÃxt
 << 
	gd’dl
;

308 ià(
	gr
 != 0) {

312 ià(
	gÃxt
.
	gfœ¡
.
sub¡r
(0, 
´efix
.
size
()) !=

313 
´efix
) {

317 
as£¹
(
is_m­pšg
(
Ãxt
.
fœ¡
));

319 
dout
(20è<< 
	g__func__
 << " " << 
	gÃxt
.
	gfœ¡
 << 
	gd’dl
;

320 
	g·œ
<
	g¢­id_t
, 
	ghobjeù_t
> 
Ãxt_decoded
(
äom_¿w
(
Ãxt
));

321 
as£¹
(
Ãxt_decoded
.
fœ¡
 =ğ
¢­
);

322 
as£¹
(
check
(
Ãxt_decoded
.
£cÚd
));

324 
	gout
->
push_back
(
Ãxt_decoded
.
£cÚd
);

325 
	gpos
 = 
Ãxt
.
fœ¡
;

328 ià(
	gout
->
size
() == 0) {

329  -
ENOENT
;

336 
	gSÇpM­³r
::
»move_oid
(

337 cÚ¡ 
hobjeù_t
 &
oid
,

338 
M­Cach”
::
T¿n§ùiÚ
<
¡d
::
¡ršg
, 
bufã¾i¡
> *
t
)

340 
dout
(20è<< 
	g__func__
 << " " << 
	goid
 << 
	gd’dl
;

341 
as£¹
(
check
(
oid
));

342  
_»move_oid
(
oid
, 
t
);

345 
	gSÇpM­³r
::
_»move_oid
(

346 cÚ¡ 
hobjeù_t
 &
oid
,

347 
M­Cach”
::
T¿n§ùiÚ
<
¡d
::
¡ršg
, 
bufã¾i¡
> *
t
)

349 
dout
(20è<< 
	g__func__
 << " " << 
	goid
 << 
	gd’dl
;

350 
objeù_¢­s
 
	gout
;

351 
	gr
 = 
g‘_¢­s
(
oid
, &
out
);

352 ià(
	gr
 < 0)

353  
	gr
;

355 
ş—r_¢­s
(
oid
, 
t
);

357 
	g£t
<
	g¡ršg
> 
	gto_»move
;

358 
	g£t
<
	g¢­id_t
>::
™”©Ü
 
i
 = 
out
.
¢­s
.
begš
();

359 
	gi
 !ğ
out
.
¢­s
.
’d
();

360 ++
	gi
) {

361 
	gto_»move
.
š£¹
(
to_¿w_key
(
make_·œ
(*
i
, 
oid
)));

363 ià(
	gg_cÚf
->
	gsubsys
.
	gshould_g©h”
<
	gûph_subsys_osd
, 20>()) {

364 auto& 
	gi
 : 
to_»move
) {

365 
dout
(20è<< 
__func__
 << "„m " << 
i
 << 
d’dl
;

368 
	gback’d
.
»move_keys
(
to_»move
, 
t
);

372 
	gSÇpM­³r
::
g‘_¢­s
(

373 cÚ¡ 
hobjeù_t
 &
oid
,

374 
¡d
::
£t
<
¢­id_t
> *
¢­s
)

376 
as£¹
(
check
(
oid
));

377 
objeù_¢­s
 
	gout
;

378 
	gr
 = 
g‘_¢­s
(
oid
, &
out
);

379 ià(
	gr
 < 0)

380  
	gr
;

381 ià(
	g¢­s
)

382 
	g¢­s
->
sw­
(
out
.
¢­s
);

	@osd/SnapMapper.h

15 #iâdeà
SNAPMAPPER_H


16 
	#SNAPMAPPER_H


	)

18 
	~<¡ršg
>

19 
	~<£t
>

20 
	~<ut™y
>

21 
	~<¡ršg.h
>

23 
	~"commÚ/m­_ÿch”.hµ
"

24 
	~"commÚ/hobjeù.h
"

25 
	~"šşude/bufãr.h
"

26 
	~"šşude/’codšg.h
"

27 
	~"šşude/objeù.h
"

28 
	~"os/ObjeùStÜe.h
"

30 
şass
 
	gOSDriv”
 : 
public
 
M­Cach”
::
StÜeDriv”
<
¡d
::
¡ršg
, 
	gbufã¾i¡
> {

31 
ObjeùStÜe
 *
	gos
;

32 
	gObjeùStÜe
::
CŞËùiÚHªdË
 
ch
;

33 
ghobjeù_t
 
	ghoid
;

35 
	gpublic
:

36 
şass
 
OST¿n§ùiÚ
 : 
public
 
M­Cach”
::
T¿n§ùiÚ
<
¡d
::
¡ršg
, 
	gbufã¾i¡
> {

37 
ä›nd
 
şass
 
	gOSDriv”
;

38 
cŞl_t
 
	gcid
;

39 
ghobjeù_t
 
	ghoid
;

40 
	gObjeùStÜe
::
T¿n§ùiÚ
 *
t
;

41 
OST¿n§ùiÚ
(

42 cÚ¡ 
cŞl_t
 &
cid
,

43 cÚ¡ 
ghobjeù_t
 &
hoid
,

44 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
)

45 : 
cid
(cid), 
hoid
(hoid), 
t
(t) {}

46 
	gpublic
:

47 
£t_keys
(

48 cÚ¡ 
¡d
::
m­
<¡d::
¡ršg
, 
bufã¾i¡
> &
to_£t
è
	gov”ride
 {

49 
	gt
->
om­_£tkeys
(
cid
, 
hoid
, 
to_£t
);

51 
»move_keys
(

52 cÚ¡ 
¡d
::
£t
<¡d::
¡ršg
> &
to_»move
è
ov”ride
 {

53 
t
->
om­_rmkeys
(
cid
, 
hoid
, 
to_»move
);

55 
add_ÿÎback
(

56 
CÚ‹xt
 *
c
è
	gov”ride
 {

57 
	gt
->
»gi¡”_Ú_­¶›d
(
c
);

61 
OST¿n§ùiÚ
 
g‘_Œª§ùiÚ
(

62 
ObjeùStÜe
::
T¿n§ùiÚ
 *
t
) {

63  
OST¿n§ùiÚ
(
ch
->
cid
, 
hoid
, 
t
);

66 
OSDriv”
(
ObjeùStÜe
 *
os
, cÚ¡ 
cŞl_t
& 
cid
, cÚ¡ 
ghobjeù_t
 &
hoid
) :

67 
os
(os),

68 
hoid
(hoid) {

69 
	gch
 = 
os
->
İ’_cŞËùiÚ
(
cid
);

71 
g‘_keys
(

72 cÚ¡ 
¡d
::
£t
<¡d::
¡ršg
> &
keys
,

73 
¡d
::
m­
<¡d::
¡ršg
, 
bufã¾i¡
> *
out
è
	gov”ride
;

74 
g‘_Ãxt
(

75 cÚ¡ 
¡d
::
¡ršg
 &
key
,

76 
·œ
<
¡d
::
¡ršg
, 
bufã¾i¡
> *
Ãxt
è
	gov”ride
;

101 şas 
	cSÇpM­³r
 {

102 
	mpublic
:

103 
C•hCÚ‹xt
* 
cù
;

104 
	sobjeù_¢­s
 {

105 
hobjeù_t
 
	moid
;

106 
	m¡d
::
£t
<
¢­id_t
> 
¢­s
;

107 
objeù_¢­s
(
hobjeù_t
 
oid
, cÚ¡ 
¡d
::
£t
<
¢­id_t
> &
¢­s
)

108 : 
oid
(oid), 
¢­s
(snaps) {}

109 
objeù_¢­s
() {}

110 
’code
(
bufã¾i¡
 &
bl
) const;

111 
decode
(
bufã¾i¡
::
™”©Ü
 &
bp
);

114 
	g´iv©e
:

115 
M­Cach”
::M­Cach”<
¡d
::
¡ršg
, 
	gbufã¾i¡
> 
	gback’d
;

117 cÚ¡ 
	g¡d
::
¡ršg
 
MAPPING_PREFIX
;

118 cÚ¡ 
	g¡d
::
¡ršg
 
OBJECT_PREFIX
;

120 
	g¡d
::
¡ršg
 
g‘_´efix
(
¢­id_t
 
¢­
);

122 
	g¡d
::
¡ršg
 
to_¿w_key
(

123 cÚ¡ 
¡d
::
·œ
<
¢­id_t
, 
hobjeù_t
> &
to_m­
);

125 
	g¡d
::
·œ
<
¡d
::
¡ršg
, 
	gbufã¾i¡
> 
to_¿w
(

126 cÚ¡ 
¡d
::
·œ
<
¢­id_t
, 
hobjeù_t
> &
to_m­
);

128 
boŞ
 
is_m­pšg
(cÚ¡ 
¡d
::
¡ršg
 &
to_‹¡
);

130 
	g¡d
::
·œ
<
¢­id_t
, 
	ghobjeù_t
> 
äom_¿w
(

131 cÚ¡ 
¡d
::
·œ
<¡d::
¡ršg
, 
bufã¾i¡
> &
image
);

133 
	g¡d
::
¡ršg
 
to_objeù_key
(cÚ¡ 
hobjeù_t
 &
hoid
);

135 
g‘_¢­s
(cÚ¡ 
hobjeù_t
 &
oid
, 
objeù_¢­s
 *
out
);

137 
£t_¢­s
(

138 cÚ¡ 
hobjeù_t
 &
oid
,

139 cÚ¡ 
objeù_¢­s
 &
out
,

140 
M­Cach”
::
T¿n§ùiÚ
<
¡d
::
¡ršg
, 
bufã¾i¡
> *
t
);

142 
ş—r_¢­s
(

143 cÚ¡ 
hobjeù_t
 &
oid
,

144 
M­Cach”
::
T¿n§ùiÚ
<
¡d
::
¡ršg
, 
bufã¾i¡
> *
t
);

147 
boŞ
 
	$check
(cÚ¡ 
hobjeù_t
 &
hoid
) const;

149 
	`_»move_oid
(

150 cÚ¡ 
hobjeù_t
 &
oid
,

151 
M­Cach”
::
T¿n§ùiÚ
<
¡d
::
¡ršg
, 
bufã¾i¡
> *
t


154 
public
:

155 
¡ršg
 
	$make_sh¬d_´efix
(
sh¬d_id_t
 
sh¬d
) {

156 ià(
sh¬d
 =ğ
sh¬d_id_t
::
NO_SHARD
)

157  
	`¡ršg
();

158 
buf
[20];

159 
r
 = 
	`¢´štf
(
buf
, (buf), ".%x", ()
sh¬d
);

160 
	`as£¹
(
r
 < ()(
buf
));

161  
	`¡ršg
(
buf
, 
r
) + '_';

162 
	}
}

163 
ušt32_t
 
	gmask_b™s
;

164 cÚ¡ 
ušt32_t
 
	gm©ch
;

165 
¡ršg
 
	gÏ¡_key_checked
;

166 cÚ¡ 
št64_t
 
	gpoŞ
;

167 cÚ¡ 
sh¬d_id_t
 
	gsh¬d
;

168 cÚ¡ 
¡ršg
 
	gsh¬d_´efix
;

169 
SÇpM­³r
(

170 
C•hCÚ‹xt
* 
cù
,

171 
M­Cach”
::
StÜeDriv”
<
¡d
::
¡ršg
, 
bufã¾i¡
> *
driv”
,

172 
ušt32_t
 
m©ch
,

173 
ušt32_t
 
b™s
,

174 
št64_t
 
poŞ
,

175 
sh¬d_id_t
 
sh¬d


177 : 
cù
(cù), 
back’d
(
driv”
), 
mask_b™s
(
b™s
), 
m©ch
(m©ch), 
poŞ
(pool),

178 
sh¬d
(sh¬d), 
sh¬d_´efix
(
	$make_sh¬d_´efix
(
sh¬d
)) {

179 
	`upd©e_b™s
(
mask_b™s
);

180 
	}
}

182 
	g£t
<
	g¡ršg
> 
	g´efixes
;

184 
	$upd©e_b™s
(

185 
ušt32_t
 
Ãw_b™s


187 
	`as£¹
(
Ãw_b™s
 >ğ
mask_b™s
);

188 
mask_b™s
 = 
Ãw_b™s
;

189 
£t
<
¡ršg
> 
_´efixes
 = 
hobjeù_t
::
	`g‘_´efixes
(

190 
mask_b™s
,

191 
m©ch
,

192 
poŞ
);

193 
´efixes
.
	`ş—r
();

194 
£t
<
¡ršg
>::
™”©Ü
 
i
 = 
_´efixes
.
	`begš
();

195 
i
 !ğ
_´efixes
.
	`’d
();

196 ++
i
) {

197 
´efixes
.
	`š£¹
(
sh¬d_´efix
 + *
i
);

199 
	}
}

202 
upd©e_¢­s
(

203 cÚ¡ 
hobjeù_t
 &
oid
,

204 cÚ¡ 
¡d
::
£t
<
¢­id_t
> &
Ãw_¢­s
,

205 cÚ¡ 
¡d
::
£t
<
¢­id_t
> *
Şd_¢­s
,

206 
M­Cach”
::
T¿n§ùiÚ
<
¡d
::
¡ršg
, 
bufã¾i¡
> *
t


210 
add_oid
(

211 cÚ¡ 
hobjeù_t
 &
oid
,

212 cÚ¡ 
¡d
::
£t
<
¢­id_t
>& 
Ãw_¢­s
,

213 
M­Cach”
::
T¿n§ùiÚ
<
¡d
::
¡ršg
, 
bufã¾i¡
> *
t


217 
g‘_Ãxt_objeùs_to_Œim
(

218 
¢­id_t
 
¢­
,

219 
max
,

220 
veùÜ
<
hobjeù_t
> *
out


224 
»move_oid
(

225 cÚ¡ 
hobjeù_t
 &
oid
,

226 
M­Cach”
::
T¿n§ùiÚ
<
¡d
::
¡ršg
, 
bufã¾i¡
> *
t


230 
g‘_¢­s
(

231 cÚ¡ 
hobjeù_t
 &
oid
,

232 
¡d
::
£t
<
¢­id_t
> *
¢­s


235 
	$WRITE_CLASS_ENCODER
(
SÇpM­³r
::
objeù_¢­s
)

	@osd/TierAgentState.h

14 #iâdeà
CEPH_OSD_TIERAGENT_H


15 
	#CEPH_OSD_TIERAGENT_H


	)

17 
	sT›rAg’tS‹
 {

19 
hobjeù_t
 
	mpos™iÚ
;

21 
	m¡¬‹d
;

22 
hobjeù_t
 
	m¡¬t
;

23 
boŞ
 
	md–ayšg
;

26 
pow2_hi¡_t
 
	m‹mp_hi¡
;

27 
	mhi¡_age
;

30 
	mm­
<
	mtime_t
,
	mH™S‘Ref
> 
	mh™_£t_m­
;

33 
	mli¡
<
	mhobjeù_t
> 
	m»ûÁ_ş—n
;

35 
	eæush_mode_t
 {

36 
	mFLUSH_MODE_IDLE
,

37 
	mFLUSH_MODE_LOW
,

38 
	mFLUSH_MODE_HIGH
,

39 } 
	mæush_mode
;

40 cÚ¡ *
g‘_æush_mode_Çme
(
æush_mode_t
 
m
) {

41 
	mm
) {

42 
	mFLUSH_MODE_IDLE
:  "idle";

43 
	mFLUSH_MODE_LOW
:  "low";

44 
	mFLUSH_MODE_HIGH
:  "high";

45 : 
as£¹
(0 == "bad flush mode");

48 cÚ¡ *
g‘_æush_mode_Çme
() const {

49  
g‘_æush_mode_Çme
(
æush_mode
);

52 
	eeviù_mode_t
 {

53 
	mEVICT_MODE_IDLE
,

54 
	mEVICT_MODE_SOME
,

55 
	mEVICT_MODE_FULL
,

56 } 
	meviù_mode
;

57 cÚ¡ *
g‘_eviù_mode_Çme
(
eviù_mode_t
 
m
) {

58 
	mm
) {

59 
	mEVICT_MODE_IDLE
:  "idle";

60 
	mEVICT_MODE_SOME
:  "some";

61 
	mEVICT_MODE_FULL
:  "full";

62 : 
as£¹
(0 == "badƒvict mode");

65 cÚ¡ *
g‘_eviù_mode_Çme
() const {

66  
g‘_eviù_mode_Çme
(
eviù_mode
);

71 
	meviù_effÜt
;

73 
T›rAg’tS‹
()

74 : 
¡¬‹d
(0),

75 
d–ayšg
(
çl£
),

76 
hi¡_age
(0),

77 
æush_mode
(
FLUSH_MODE_IDLE
),

78 
eviù_mode
(
EVICT_MODE_IDLE
),

79 
eviù_effÜt
(0)

83 
boŞ
 
is_idË
() const {

85 
	md–ayšg
 ||

86 (
	mæush_mode
 =ğ
FLUSH_MODE_IDLE
 &&

87 
eviù_mode
 =ğ
EVICT_MODE_IDLE
);

91 
add_h™_£t
(
time_t
 
¡¬t
, 
H™S‘Ref
 
hs
) {

92 
	mh™_£t_m­
.
š£¹
(
make_·œ
(
¡¬t
, 
hs
));

96 
»move_Şde¡_h™_£t
() {

97 ià(!
	mh™_£t_m­
.
em±y
())

98 
	mh™_£t_m­
.
”a£
(
h™_£t_m­
.
begš
());

102 
disÿrd_h™_£ts
() {

103 
	mh™_£t_m­
.
ş—r
();

106 
dump
(
FÜm©‹r
 *
f
) const {

107 
	mf
->
dump_¡ršg
("æush_mode", 
g‘_æush_mode_Çme
());

108 
	mf
->
dump_¡ršg
("eviù_mode", 
g‘_eviù_mode_Çme
());

109 
	mf
->
dump_unsigÃd
("eviù_effÜt", 
eviù_effÜt
);

110 
	mf
->
dump_¡»am
("pos™iÚ"è<< 
	mpos™iÚ
;

111 
	mf
->
İ’_objeù_£ùiÚ
("temp_hist");

112 
	m‹mp_hi¡
.
dump
(
f
);

113 
	mf
->
şo£_£ùiÚ
();

	@osd/Watch.cc

2 
	~"PG.h
"

4 
	~"šşude/ty³s.h
"

5 
	~"mes§ges/MW©chNÙify.h
"

7 
	~<m­
>

9 
	~"OSD.h
"

10 
	~"Prim¬yLogPG.h
"

11 
	~"W©ch.h
"

12 
	~"SessiÚ.h
"

14 
	~"commÚ/cÚfig.h
"

16 
	gCªûÏbËCÚ‹xt
 : 
public
 
CÚ‹xt
 {

17 
vœtu®
 
ÿnûl
() = 0;

20 
	#dout_cÚ‹xt
 
osd
->
cù


	)

21 
	#dout_subsys
 
ûph_subsys_osd


	)

22 #undeà
dout_´efix


23 
	#dout_´efix
 
	`_´efix
(
_dout
, 
this
)

	)

25 
	go¡»am
& 
	$_´efix
(

26 
¡d
::
o¡»am
* 
_dout
,

27 
NÙify
 *
nÙify
) {

28  
nÙify
->
	`g’_dbg_´efix
(*
_dout
);

29 
	}
}

31 
	gNÙify
::
	$NÙify
(

32 
CÚÃùiÚRef
 
ş›Á
,

33 
ušt64_t
 
ş›Á_gid
,

34 
bufã¾i¡
 &
·ylßd
,

35 
ušt32_t
 
timeout
,

36 
ušt64_t
 
cook›
,

37 
ušt64_t
 
nÙify_id
,

38 
ušt64_t
 
v”siÚ
,

39 
OSDS”viû
 *
osd
)

40 : 
	`ş›Á
(
ş›Á
), 
	`ş›Á_gid
(
ş›Á_gid
),

41 
	`com¶‘e
(
çl£
),

42 
	`disÿrded
(
çl£
),

43 
	`timed_out
(
çl£
),

44 
	`·ylßd
(
·ylßd
),

45 
	`timeout
(
timeout
),

46 
	`cook›
(
cook›
),

47 
	`nÙify_id
(
nÙify_id
),

48 
	`v”siÚ
(
v”siÚ
),

49 
	`osd
(
osd
),

50 
	`cb
(
NULL
),

51 
	`lock
("NÙify::lock"è{
	}
}

53 
NÙifyRef
 
	gNÙify
::
	$makeNÙifyRef
(

54 
CÚÃùiÚRef
 
ş›Á
,

55 
ušt64_t
 
ş›Á_gid
,

56 
bufã¾i¡
 &
·ylßd
,

57 
ušt32_t
 
timeout
,

58 
ušt64_t
 
cook›
,

59 
ušt64_t
 
nÙify_id
,

60 
ušt64_t
 
v”siÚ
,

61 
OSDS”viû
 *
osd
) {

62 
NÙifyRef
 
	`»t
(

63 
Ãw
 
	`NÙify
(

64 
ş›Á
, 
ş›Á_gid
,

65 
·ylßd
, 
timeout
,

66 
cook›
, 
nÙify_id
,

67 
v”siÚ
, 
osd
));

68 
»t
->
	`£t_£lf
(ret);

69  
»t
;

70 
	}
}

72 şas 
	cNÙifyTimeoutCB
 : 
public
 
CªûÏbËCÚ‹xt
 {

73 
NÙifyRef
 
nÙif
;

74 
boŞ
 
	mÿnûËd
;

75 
	mpublic
:

76 
ex¶ic™
 
	$NÙifyTimeoutCB
(
NÙifyRef
 
nÙif
è: 
	`nÙif
ÒÙif), 
	$ÿnûËd
(
çl£
) {}

77 
	$fšish
(è
ov”ride
 {

78 
nÙif
->
osd
->
w©ch_lock
.
	`UÆock
();

79 
nÙif
->
lock
.
	`Lock
();

80 ià(!
ÿnûËd
)

81 
nÙif
->
	`do_timeout
();

83 
nÙif
->
lock
.
	`UÆock
();

84 
nÙif
->
osd
->
w©ch_lock
.
	`Lock
();

85 
	}
}

86 
	$ÿnûl
(è
ov”ride
 {

87 
	`as£¹
(
nÙif
->
lock
.
	`is_locked_by_me
());

88 
ÿnûËd
 = 
Œue
;

89 
	}
}

92 
	gNÙify
::
	$do_timeout
()

94 
	`as£¹
(
lock
.
	`is_locked_by_me
());

95 
	`dout
(10è<< "timeout" << 
d’dl
;

96 
cb
 = 
nuÎ±r
;

97 ià(
	`is_disÿrded
()) {

98 
lock
.
	`UÆock
();

102 
timed_out
 = 
Œue
;

103 
	`maybe_com¶‘e_nÙify
();

104 
	`as£¹
(
com¶‘e
);

105 
£t
<
W©chRef
> 
_w©ch”s
;

106 
_w©ch”s
.
	`sw­
(
w©ch”s
);

107 
lock
.
	`UÆock
();

109 
£t
<
W©chRef
>::
™”©Ü
 
i
 = 
_w©ch”s
.
	`begš
();

110 
i
 !ğ
_w©ch”s
.
	`’d
();

111 ++
i
) {

112 
boo¡
::
šŒusive_±r
<
Prim¬yLogPG
> 
	`pg
((*
i
)->
	`g‘_pg
());

113 
pg
->
	`lock
();

114 ià(!(*
i
)->
	`is_disÿrded
()) {

115 (*
i
)->
	`ÿnûl_nÙify
(
£lf
.
	`lock
());

117 
pg
->
	`uÆock
();

119 
	}
}

121 
	gNÙify
::
	$»gi¡”_cb
()

123 
	`as£¹
(
lock
.
	`is_locked_by_me
());

125 
osd
->
w©ch_lock
.
	`Lock
();

126 
cb
 = 
Ãw
 
	`NÙifyTimeoutCB
(
£lf
.
	`lock
());

127 ià(!
osd
->
w©ch_tim”
.
	`add_ev’t_aá”
(
timeout
, 
cb
)) {

128 
cb
 = 
nuÎ±r
;

130 
osd
->
w©ch_lock
.
	`UÆock
();

132 
	}
}

134 
	gNÙify
::
	$uÄegi¡”_cb
()

136 
	`as£¹
(
lock
.
	`is_locked_by_me
());

137 ià(!
cb
)

139 
cb
->
	`ÿnûl
();

141 
osd
->
w©ch_lock
.
	`Lock
();

142 
osd
->
w©ch_tim”
.
	`ÿnûl_ev’t
(
cb
);

143 
cb
 = 
nuÎ±r
;

144 
osd
->
w©ch_lock
.
	`UÆock
();

146 
	}
}

148 
	gNÙify
::
	$¡¬t_w©ch”
(
W©chRef
 
w©ch
)

150 
Mu‹x
::
Lock”
 
	`l
(
lock
);

151 
	`dout
(10è<< "¡¬t_w©ch”" << 
d’dl
;

152 
w©ch”s
.
	`š£¹
(
w©ch
);

153 
	}
}

155 
	gNÙify
::
	$com¶‘e_w©ch”
(
W©chRef
 
w©ch
, 
bufã¾i¡
& 
»¶y_bl
)

157 
Mu‹x
::
Lock”
 
	`l
(
lock
);

158 
	`dout
(10è<< "com¶‘e_w©ch”" << 
d’dl
;

159 ià(
	`is_disÿrded
())

161 
	`as£¹
(
w©ch”s
.
	`couÁ
(
w©ch
));

162 
w©ch”s
.
	`”a£
(
w©ch
);

163 
nÙify_»¶›s
.
	`š£¹
(
	`make_·œ
(make_·œ(
w©ch
->
	`g‘_w©ch”_gid
(),

164 
w©ch
->
	`g‘_cook›
()),

165 
»¶y_bl
));

166 
	`maybe_com¶‘e_nÙify
();

167 
	}
}

169 
	gNÙify
::
	$com¶‘e_w©ch”_»move
(
W©chRef
 
w©ch
)

171 
Mu‹x
::
Lock”
 
	`l
(
lock
);

172 
	`dout
(10è<< 
__func__
 << 
d’dl
;

173 ià(
	`is_disÿrded
())

175 
	`as£¹
(
w©ch”s
.
	`couÁ
(
w©ch
));

176 
w©ch”s
.
	`”a£
(
w©ch
);

177 
	`maybe_com¶‘e_nÙify
();

178 
	}
}

180 
	gNÙify
::
	$maybe_com¶‘e_nÙify
()

182 
	`dout
(10) << "maybe_complete_notify -- "

183 << 
w©ch”s
.
	`size
()

184 << " iÀ´og»s w©ch” " << 
d’dl
;

185 ià(
w©ch”s
.
	`em±y
(è|| 
timed_out
) {

187 
bufã¾i¡
 
bl
;

188 
	`’code
(
nÙify_»¶›s
, 
bl
);

189 
li¡
<
·œ
<
ušt64_t
,ušt64_t> > 
mis£d
;

190 
£t
<
W©chRef
>::
™”©Ü
 
p
 = 
w©ch”s
.
	`begš
();… !ğw©ch”s.
	`’d
(); ++p) {

191 
mis£d
.
	`push_back
(
	`make_·œ
((*
p
)->
	`g‘_w©ch”_gid
(),

192 (*
p
)->
	`g‘_cook›
()));

194 
	`’code
(
mis£d
, 
bl
);

196 
bufã¾i¡
 
em±y
;

197 
MW©chNÙify
 *
	`»¶y
(
Ãw
 
	`MW©chNÙify
(
cook›
, 
v”siÚ
, 
nÙify_id
,

198 
CEPH_WATCH_EVENT_NOTIFY_COMPLETE
, 
em±y
));

199 
»¶y
->
nÙif›r_gid
 = 
ş›Á_gid
;

200 
»¶y
->
	`£t_d©a
(
bl
);

201 ià(
timed_out
)

202 
»¶y
->
»tuº_code
 = -
ETIMEDOUT
;

203 
ş›Á
->
	`£nd_mes§ge
(
»¶y
);

204 
	`uÄegi¡”_cb
();

206 
com¶‘e
 = 
Œue
;

208 
	}
}

210 
	gNÙify
::
	$disÿrd
()

212 
Mu‹x
::
Lock”
 
	`l
(
lock
);

213 
disÿrded
 = 
Œue
;

214 
	`uÄegi¡”_cb
();

215 
w©ch”s
.
	`ş—r
();

216 
	}
}

218 
	gNÙify
::
	$š™
()

220 
Mu‹x
::
Lock”
 
	`l
(
lock
);

221 
	`»gi¡”_cb
();

222 
	`maybe_com¶‘e_nÙify
();

223 
	}
}

225 
	#dout_subsys
 
ûph_subsys_osd


	)

226 #undeà
dout_´efix


227 
	#dout_´efix
 
	`_´efix
(
_dout
, 
w©ch
.
	`g‘
())

	)

229 
	go¡»am
& 
	$_´efix
(

230 
¡d
::
o¡»am
* 
_dout
,

231 
W©ch
 *
w©ch
) {

232  
w©ch
->
	`g’_dbg_´efix
(*
_dout
);

233 
	}
}

235 şas 
	cHªdËW©chTimeout
 : 
public
 
CªûÏbËCÚ‹xt
 {

236 
W©chRef
 
w©ch
;

237 
	mpublic
:

238 
boŞ
 
ÿnûËd
;

239 
ex¶ic™
 
	$HªdËW©chTimeout
(
W©chRef
 
w©ch
è: 
	`w©ch
(w©ch), 
	$ÿnûËd
(
çl£
) {}

240 
	$ÿnûl
(è
ov”ride
 {

241 
ÿnûËd
 = 
Œue
;

242 
	}
}

243 
	$fšish
(è
ov”ride
 { 
	`ûph_abÜt
(); 
	}
}

244 
	$com¶‘e
(è
ov”ride
 {

245 
OSDS”viû
 *
	`osd
(
w©ch
->
osd
);

246 
	`ldout
(
osd
->
cù
, 10è<< "HªdËW©chTimeout" << 
d’dl
;

247 
boo¡
::
šŒusive_±r
<
Prim¬yLogPG
> 
	`pg
(
w©ch
->
pg
);

248 
osd
->
w©ch_lock
.
	`UÆock
();

249 
pg
->
	`lock
();

250 
w©ch
->
cb
 = 
nuÎ±r
;

251 ià(!
w©ch
->
	`is_disÿrded
(è&& !
ÿnûËd
)

252 
w©ch
->
pg
->
	`hªdË_w©ch_timeout
(watch);

253 
d–‘e
 
this
;

254 
pg
->
	`uÆock
();

255 
osd
->
w©ch_lock
.
	`Lock
();

256 
	}
}

259 şas 
	cHªdËD–ayedW©chTimeout
 : 
public
 
CªûÏbËCÚ‹xt
 {

260 
W©chRef
 
w©ch
;

261 
	mpublic
:

262 
boŞ
 
ÿnûËd
;

263 
ex¶ic™
 
	$HªdËD–ayedW©chTimeout
(
W©chRef
 
w©ch
è: 
	`w©ch
(w©ch), 
	$ÿnûËd
(
çl£
) {}

264 
	$ÿnûl
(è
ov”ride
 {

265 
ÿnûËd
 = 
Œue
;

266 
	}
}

267 
	$fšish
(è
ov”ride
 {

268 
OSDS”viû
 *
	`osd
(
w©ch
->
osd
);

269 
	`dout
(10è<< "HªdËW©chTimeoutD–ayed" << 
d’dl
;

270 
	`as£¹
(
w©ch
->
pg
->
	`is_locked
());

271 
w©ch
->
cb
 = 
nuÎ±r
;

272 ià(!
w©ch
->
	`is_disÿrded
(è&& !
ÿnûËd
)

273 
w©ch
->
pg
->
	`hªdË_w©ch_timeout
(watch);

274 
	}
}

277 
	#dout_subsys
 
ûph_subsys_osd


	)

278 #undeà
dout_´efix


279 
	#dout_´efix
 
	`_´efix
(
_dout
, 
this
)

	)

281 
	g¡d
::
o¡»am
& 
W©ch
::
	$g’_dbg_´efix
(
¡d
::
o¡»am
& 
out
) {

282  
pg
->
	`g’_´efix
(
out
) << " -- Watch("

283 << 
	`make_·œ
(
cook›
, 
’t™y
) << ") ";

284 
	}
}

286 
	gW©ch
::
	$W©ch
(

287 
Prim¬yLogPG
 *
pg
,

288 
OSDS”viû
 *
osd
,

289 
ObjeùCÚ‹xtRef
 
obc
,

290 
ušt32_t
 
timeout
,

291 
ušt64_t
 
cook›
,

292 
’t™y_Çme_t
 
’t™y
,

293 cÚ¡ 
’t™y_addr_t
 &
addr
)

294 : 
	`cb
(
NULL
),

295 
	`osd
(
osd
),

296 
	`pg
(
pg
),

297 
	`obc
(
obc
),

298 
	`timeout
(
timeout
),

299 
	`cook›
(
cook›
),

300 
	`addr
(
addr
),

301 
	`wl_pšg
(
çl£
),

302 
	`’t™y
(
’t™y
),

303 
	$disÿrded
(
çl£
) {

304 
	`dout
(10è<< "W©ch()" << 
d’dl
;

305 
	}
}

307 
	gW©ch
::~
	$W©ch
() {

308 
	`dout
(10è<< "~W©ch" << 
d’dl
;

310 
	`as£¹
(!
obc
);

311 
	`as£¹
(!
cÚn
);

312 
	}
}

314 
boŞ
 
	gW©ch
::
	$cÚÃùed
(è{  !!
cÚn
; 
	}
}

316 
CÚ‹xt
 *
	gW©ch
::
	$g‘_d–ayed_cb
()

318 
	`as£¹
(!
cb
);

319 
cb
 = 
Ãw
 
	`HªdËD–ayedW©chTimeout
(
£lf
.
	`lock
());

320  
cb
;

321 
	}
}

323 
	gW©ch
::
	$»gi¡”_cb
()

325 
Mu‹x
::
Lock”
 
	`l
(
osd
->
w©ch_lock
);

326 ià(
cb
) {

327 
	`dout
(15è<< "»-»gi¡”šg c®lback,imeout: " << 
timeout
 << 
d’dl
;

328 
cb
->
	`ÿnûl
();

329 
osd
->
w©ch_tim”
.
	`ÿnûl_ev’t
(
cb
);

331 
	`dout
(15è<< "»gi¡”šg c®lback,imeout: " << 
timeout
 << 
d’dl
;

333 
cb
 = 
Ãw
 
	`HªdËW©chTimeout
(
£lf
.
	`lock
());

334 ià(!
osd
->
w©ch_tim”
.
	`add_ev’t_aá”
(
timeout
, 
cb
)) {

335 
cb
 = 
nuÎ±r
;

337 
	}
}

339 
	gW©ch
::
	$uÄegi¡”_cb
()

341 
	`dout
(15è<< "uÄegi¡”_cb" << 
d’dl
;

342 ià(!
cb
)

344 
	`dout
(15è<< "aùu®ly„egi¡”ed, cªûÎšg" << 
d’dl
;

345 
cb
->
	`ÿnûl
();

347 
Mu‹x
::
Lock”
 
	`l
(
osd
->
w©ch_lock
);

348 
osd
->
w©ch_tim”
.
	`ÿnûl_ev’t
(
cb
);

350 
cb
 = 
nuÎ±r
;

351 
	}
}

353 
	gW©ch
::
	$gÙ_pšg
(
utime_t
 
t
)

355 
Ï¡_pšg
 = 
t
;

356 ià(
cÚn
) {

357 
	`»gi¡”_cb
();

359 
	}
}

361 
	gW©ch
::
	$cÚÃù
(
CÚÃùiÚRef
 
cÚ
, 
boŞ
 
_wl_pšg
)

363 ià(
cÚn
 =ğ
cÚ
) {

364 
	`dout
(10è<< 
__func__
 << " cÚ " << 
cÚ
 << " -‡Ì—dy cÚÃùed" << 
d’dl
;

367 
	`dout
(10è<< 
__func__
 << " cÚ " << 
cÚ
 << 
d’dl
;

368 
cÚn
 = 
cÚ
;

369 
wl_pšg
 = 
_wl_pšg
;

370 
SessiÚ
* 
	`£ssiÚ»f
(
¡©ic_ÿ¡
<SessiÚ*>(
cÚ
->
	`g‘_´iv
()));

371 ià(
£ssiÚ»f
) {

372 
£ssiÚ»f
->
w¡©e
.
	`addW©ch
(
£lf
.
	`lock
());

373 
£ssiÚ»f
->
	`put
();

374 
m­
<
ušt64_t
, 
NÙifyRef
>::
™”©Ü
 
i
 = 
š_´og»ss_nÙif›s
.
	`begš
();

375 
i
 !ğ
š_´og»ss_nÙif›s
.
	`’d
();

376 ++
i
) {

377 
	`£nd_nÙify
(
i
->
£cÚd
);

380 ià(
wl_pšg
) {

381 
Ï¡_pšg
 = 
	`ûph_şock_now
();

382 
	`»gi¡”_cb
();

384 
	`uÄegi¡”_cb
();

386 
	}
}

388 
	gW©ch
::
	$discÚÃù
()

390 
	`dout
(10è<< "discÚÃù (cÚ wa " << 
cÚn
 << ")" << 
d’dl
;

391 
cÚn
 = 
	`CÚÃùiÚRef
();

392 ià(!
wl_pšg
)

393 
	`»gi¡”_cb
();

394 
	}
}

396 
	gW©ch
::
	$disÿrd
()

398 
	`dout
(10è<< "disÿrd" << 
d’dl
;

399 
m­
<
ušt64_t
, 
NÙifyRef
>::
™”©Ü
 
i
 = 
š_´og»ss_nÙif›s
.
	`begš
();

400 
i
 !ğ
š_´og»ss_nÙif›s
.
	`’d
();

401 ++
i
) {

402 
i
->
£cÚd
->
	`disÿrd
();

404 
	`disÿrd_¡©e
();

405 
	}
}

407 
	gW©ch
::
	$disÿrd_¡©e
()

409 
	`as£¹
(
pg
->
	`is_locked
());

410 
	`as£¹
(!
disÿrded
);

411 
	`as£¹
(
obc
);

412 
š_´og»ss_nÙif›s
.
	`ş—r
();

413 
	`uÄegi¡”_cb
();

414 
disÿrded
 = 
Œue
;

415 ià(
cÚn
) {

416 
SessiÚ
* 
	`£ssiÚ»f
(
¡©ic_ÿ¡
<SessiÚ*>(
cÚn
->
	`g‘_´iv
()));

417 ià(
£ssiÚ»f
) {

418 
£ssiÚ»f
->
w¡©e
.
	`»moveW©ch
(
£lf
.
	`lock
());

419 
£ssiÚ»f
->
	`put
();

421 
cÚn
 = 
	`CÚÃùiÚRef
();

423 
obc
 = 
	`ObjeùCÚ‹xtRef
();

424 
	}
}

426 
boŞ
 
	gW©ch
::
	$is_disÿrded
() const

428  
disÿrded
;

429 
	}
}

431 
	gW©ch
::
	$»move
(
boŞ
 
£nd_discÚÃù
)

433 
	`dout
(10è<< "»move" << 
d’dl
;

434 ià(
£nd_discÚÃù
 && 
cÚn
) {

435 
bufã¾i¡
 
em±y
;

436 
MW©chNÙify
 *
	`»¶y
(
Ãw
 
	`MW©chNÙify
(
cook›
, 0, 0,

437 
CEPH_WATCH_EVENT_DISCONNECT
, 
em±y
));

438 
cÚn
->
	`£nd_mes§ge
(
»¶y
);

440 
m­
<
ušt64_t
, 
NÙifyRef
>::
™”©Ü
 
i
 = 
š_´og»ss_nÙif›s
.
	`begš
();

441 
i
 !ğ
š_´og»ss_nÙif›s
.
	`’d
();

442 ++
i
) {

443 
i
->
£cÚd
->
	`com¶‘e_w©ch”_»move
(
£lf
.
	`lock
());

445 
	`disÿrd_¡©e
();

446 
	}
}

448 
	gW©ch
::
	$¡¬t_nÙify
(
NÙifyRef
 
nÙif
)

450 
	`as£¹
(
š_´og»ss_nÙif›s
.
	`fšd
(
nÙif
->
nÙify_id
) ==

451 
š_´og»ss_nÙif›s
.
	`’d
());

452 ià(
wl_pšg
) {

453 
utime_t
 
cutoff
 = 
	`ûph_şock_now
();

454 
cutoff
.
	`£c_»f
(è-ğ
timeout
;

455 ià(
Ï¡_pšg
 < 
cutoff
) {

456 
	`dout
(10è<< 
__func__
 << " " << 
nÙif
->
nÙify_id


457 << "†a¡_pšg " << 
Ï¡_pšg
 << " < cutofà" << 
cutoff


458 << ", discÚÃùšg" << 
d’dl
;

459 
	`discÚÃù
();

463 
	`dout
(10è<< "¡¬t_nÙify " << 
nÙif
->
nÙify_id
 << 
d’dl
;

464 
š_´og»ss_nÙif›s
[
nÙif
->
nÙify_id
] =‚otif;

465 
nÙif
->
	`¡¬t_w©ch”
(
£lf
.
	`lock
());

466 ià(
	`cÚÃùed
())

467 
	`£nd_nÙify
(
nÙif
);

468 
	}
}

470 
	gW©ch
::
	$ÿnûl_nÙify
(
NÙifyRef
 
nÙif
)

472 
	`dout
(10è<< "ÿnûl_nÙify " << 
nÙif
->
nÙify_id
 << 
d’dl
;

473 
š_´og»ss_nÙif›s
.
	`”a£
(
nÙif
->
nÙify_id
);

474 
	}
}

476 
	gW©ch
::
	$£nd_nÙify
(
NÙifyRef
 
nÙif
)

478 
	`dout
(10è<< "£nd_nÙify" << 
d’dl
;

479 
MW©chNÙify
 *
nÙify_msg
 = 
Ãw
 
	`MW©chNÙify
(

480 
cook›
, 
nÙif
->
v”siÚ
,‚Ùif->
nÙify_id
,

481 
CEPH_WATCH_EVENT_NOTIFY
, 
nÙif
->
·ylßd
);

482 
nÙify_msg
->
nÙif›r_gid
 = 
nÙif
->
ş›Á_gid
;

483 
cÚn
->
	`£nd_mes§ge
(
nÙify_msg
);

484 
	}
}

486 
	gW©ch
::
	$nÙify_ack
(
ušt64_t
 
nÙify_id
, 
bufã¾i¡
& 
»¶y_bl
)

488 
	`dout
(10è<< "nÙify_ack" << 
d’dl
;

489 
m­
<
ušt64_t
, 
NÙifyRef
>::
™”©Ü
 
i
 = 
š_´og»ss_nÙif›s
.
	`fšd
(
nÙify_id
);

490 ià(
i
 !ğ
š_´og»ss_nÙif›s
.
	`’d
()) {

491 
i
->
£cÚd
->
	`com¶‘e_w©ch”
(
£lf
.
	`lock
(), 
»¶y_bl
);

492 
š_´og»ss_nÙif›s
.
	`”a£
(
i
);

494 
	}
}

496 
W©chRef
 
	gW©ch
::
	$makeW©chRef
(

497 
Prim¬yLogPG
 *
pg
, 
OSDS”viû
 *
osd
,

498 
ObjeùCÚ‹xtRef
 
obc
, 
ušt32_t
 
timeout
, 
ušt64_t
 
cook›
, 
’t™y_Çme_t
 
’t™y
, cÚ¡ 
’t™y_addr_t
& 
addr
)

500 
W©chRef
 
	`»t
(
Ãw
 
	`W©ch
(
pg
, 
osd
, 
obc
, 
timeout
, 
cook›
, 
’t™y
, 
addr
));

501 
»t
->
	`£t_£lf
(ret);

502  
»t
;

503 
	}
}

505 
	gW©chCÚS‹
::
	$addW©ch
(
W©chRef
 
w©ch
)

507 
Mu‹x
::
Lock”
 
	`l
(
lock
);

508 
w©ches
.
	`š£¹
(
w©ch
);

509 
	}
}

511 
	gW©chCÚS‹
::
	$»moveW©ch
(
W©chRef
 
w©ch
)

513 
Mu‹x
::
Lock”
 
	`l
(
lock
);

514 
w©ches
.
	`”a£
(
w©ch
);

515 
	}
}

517 
	gW©chCÚS‹
::
	$»£t
(
CÚÃùiÚ
 *
cÚ
)

519 
£t
<
W©chRef
> 
_w©ches
;

521 
Mu‹x
::
Lock”
 
	`l
(
lock
);

522 
_w©ches
.
	`sw­
(
w©ches
);

524 
£t
<
W©chRef
>::
™”©Ü
 
i
 = 
_w©ches
.
	`begš
();

525 
i
 !ğ
_w©ches
.
	`’d
();

526 ++
i
) {

527 
boo¡
::
šŒusive_±r
<
Prim¬yLogPG
> 
	`pg
((*
i
)->
	`g‘_pg
());

528 
pg
->
	`lock
();

529 ià(!(*
i
)->
	`is_disÿrded
()) {

530 ià((*
i
)->
	`is_cÚÃùed
(
cÚ
)) {

531 (*
i
)->
	`discÚÃù
();

533 
	`lg’”ic_d”r
(
cù
è<< 
__func__
 << "‚Ù stÈcÚÃùedØ" << (*
i
è<< 
d’dl
;

536 
pg
->
	`uÆock
();

538 
	}
}

	@osd/Watch.h

14 #iâdeà
CEPH_WATCH_H


15 
	#CEPH_WATCH_H


	)

17 
	~"šşude/memÜy.h
"

18 
	~<£t
>

20 
	~"msg/Mes£ng”.h
"

21 
	~"šşude/CÚ‹xt.h
"

23 
	eW©ch”S‹
 {

24 
	mWATCHER_PENDING
,

25 
	mWATCHER_NOTIFIED
,

28 
şass
 
	gOSDS”viû
;

29 
şass
 
	gPrim¬yLogPG
;

30 
šŒusive_±r_add_»f
(
Prim¬yLogPG
 *
pg
);

31 
šŒusive_±r_»Ëa£
(
Prim¬yLogPG
 *
pg
);

32 
	gObjeùCÚ‹xt
;

33 
şass
 
	gMW©chNÙify
;

35 
şass
 
	gW©ch
;

36 
	gûph
::
	tsh¬ed_±r
<
	tW©ch
> 
	tW©chRef
;

37 
	gûph
::
	tw—k_±r
<
	tW©ch
> 
	tWW©chRef
;

39 
şass
 
	gNÙify
;

40 
	gûph
::
	tsh¬ed_±r
<
	tNÙify
> 
	tNÙifyRef
;

41 
	gûph
::
	tw—k_±r
<
	tNÙify
> 
	tWNÙifyRef
;

43 
	gCªûÏbËCÚ‹xt
;

50 şas 
	cNÙify
 {

51 
ä›nd
 
şass
 
	mNÙifyTimeoutCB
;

52 
ä›nd
 
şass
 
	mW©ch
;

53 
WNÙifyRef
 
	m£lf
;

54 
CÚÃùiÚRef
 
	mş›Á
;

55 
ušt64_t
 
	mş›Á_gid
;

56 
boŞ
 
	mcom¶‘e
;

57 
boŞ
 
	mdisÿrded
;

58 
boŞ
 
	mtimed_out
;

59 
	m£t
<
	mW©chRef
> 
	mw©ch”s
;

61 
bufã¾i¡
 
	m·ylßd
;

62 
ušt32_t
 
	mtimeout
;

63 
ušt64_t
 
	mcook›
;

64 
ušt64_t
 
	mnÙify_id
;

65 
ušt64_t
 
	mv”siÚ
;

67 
OSDS”viû
 *
	mosd
;

68 
CªûÏbËCÚ‹xt
 *
	mcb
;

69 
Mu‹x
 
	mlock
;

72 
	mmuÉim­
<
	m·œ
<
	mušt64_t
,ušt64_t>,
	mbufã¾i¡
> 
	mnÙify_»¶›s
;

75 
boŞ
 
	$is_disÿrded
() {

76  
disÿrded
 || 
com¶‘e
;

80 
	`maybe_com¶‘e_nÙify
();

83 
	`do_timeout
();

85 
	`NÙify
(

86 
CÚÃùiÚRef
 
ş›Á
,

87 
ušt64_t
 
ş›Á_gid
,

88 
bufã¾i¡
 &
·ylßd
,

89 
ušt32_t
 
timeout
,

90 
ušt64_t
 
cook›
,

91 
ušt64_t
 
nÙify_id
,

92 
ušt64_t
 
v”siÚ
,

93 
OSDS”viû
 *
osd
);

96 
	`»gi¡”_cb
();

99 
	`uÄegi¡”_cb
();

100 
public
:

102 
¡d
::
o¡»am
& 
	$g’_dbg_´efix
(
¡d
::
o¡»am
& 
out
) {

103  
out
 << "NÙify(" << 
	`make_·œ
(
cook›
, 
nÙify_id
) << " "

104 << " w©ch”s=" << 
w©ch”s
.
	`size
()

106 
	}
}

107 
	$£t_£lf
(
NÙifyRef
 
_£lf
) {

108 
£lf
 = 
_£lf
;

109 
	}
}

110 
NÙifyRef
 
makeNÙifyRef
(

111 
CÚÃùiÚRef
 
ş›Á
,

112 
ušt64_t
 
ş›Á_gid
,

113 
bufã¾i¡
 &
·ylßd
,

114 
ušt32_t
 
timeout
,

115 
ušt64_t
 
cook›
,

116 
ušt64_t
 
nÙify_id
,

117 
ušt64_t
 
v”siÚ
,

118 
OSDS”viû
 *
osd
);

121 
š™
();

124 
¡¬t_w©ch”
(

125 
W©chRef
 
w©ch”


129 
com¶‘e_w©ch”
(

130 
W©chRef
 
w©ch”
,

131 
bufã¾i¡
& 
»¶y_bl


134 
com¶‘e_w©ch”_»move
(

135 
W©chRef
 
w©ch”


139 
disÿrd
();

147 
şass
 
	gHªdËW©chTimeout
;

148 
şass
 
	gHªdËD–ayedW©chTimeout
;

149 şas 
	cW©ch
 {

150 
WW©chRef
 
	m£lf
;

151 
ä›nd
 
şass
 
	mHªdËW©chTimeout
;

152 
ä›nd
 
şass
 
	mHªdËD–ayedW©chTimeout
;

153 
CÚÃùiÚRef
 
	mcÚn
;

154 
CªûÏbËCÚ‹xt
 *
	mcb
;

156 
OSDS”viû
 *
	mosd
;

157 
	mboo¡
::
šŒusive_±r
<
Prim¬yLogPG
> 
pg
;

158 
	mûph
::
sh¬ed_±r
<
ObjeùCÚ‹xt
> 
obc
;

160 
	m¡d
::
m­
<
ušt64_t
, 
	mNÙifyRef
> 
	mš_´og»ss_nÙif›s
;

163 
ušt32_t
 
	mtimeout
;

164 
ušt64_t
 
	mcook›
;

165 
’t™y_addr_t
 
	maddr
;

167 
boŞ
 
	mwl_pšg
;

168 
utime_t
 
	mÏ¡_pšg
;

170 
’t™y_Çme_t
 
	m’t™y
;

171 
boŞ
 
	mdisÿrded
;

173 
W©ch
(

174 
Prim¬yLogPG
 *
pg
, 
OSDS”viû
 *
osd
,

175 
ûph
::
sh¬ed_±r
<
ObjeùCÚ‹xt
> 
obc
, 
ušt32_t
 
timeout
,

176 
ušt64_t
 
cook›
, 
’t™y_Çme_t
 
’t™y
,

177 cÚ¡ 
’t™y_addr_t
& 
addr
);

180 
»gi¡”_cb
();

183 
£nd_nÙify
(
NÙifyRef
 
nÙif
);

186 
disÿrd_¡©e
();

187 
	mpublic
:

189 
uÄegi¡”_cb
();

192 
gÙ_pšg
(
utime_t
 
t
);

193 
utime_t
 
	$g‘_Ï¡_pšg
() const {

194  
Ï¡_pšg
;

197 
boŞ
 
	$is_cÚÃùed
() const {

198  
cÚn
.
	`g‘
(è!ğ
NULL
;

199 
	}
}

200 
boŞ
 
	$is_cÚÃùed
(
CÚÃùiÚ
 *
cÚ
) const {

201  
cÚn
.
	`g‘
(è=ğ
cÚ
;

202 
	}
}

205 ~
W©ch
();

207 
ušt64_t
 
	$g‘_w©ch”_gid
() const {

208  
’t™y
.
	`num
();

209 
	}
}

211 
	g¡d
::
o¡»am
& 
g’_dbg_´efix
(
¡d
::o¡»am& 
out
);

212 
W©chRef
 
makeW©chRef
(

213 
Prim¬yLogPG
 *
pg
, 
OSDS”viû
 *
osd
,

214 
ûph
::
sh¬ed_±r
<
ObjeùCÚ‹xt
> 
obc
, 
ušt32_t
 
timeout
, 
ušt64_t
 
cook›
, 
’t™y_Çme_t
 
’t™y
, cÚ¡ 
’t™y_addr_t
 &
addr
);

215 
	$£t_£lf
(
W©chRef
 
_£lf
) {

216 
£lf
 = 
_£lf
;

217 
	}
}

220 
	gboo¡
::
šŒusive_±r
<
Prim¬yLogPG
> 
	$g‘_pg
(è{  
pg
; 
	}
}

222 
	gûph
::
sh¬ed_±r
<
ObjeùCÚ‹xt
> 
	$g‘_obc
(è{  
obc
; 
	}
}

224 
ušt64_t
 
	$g‘_cook›
(ècÚ¡ {  
cook›
; 
	}
}

225 
’t™y_Çme_t
 
	$g‘_’t™y
(ècÚ¡ {  
’t™y
; 
	}
}

226 
’t™y_addr_t
 
	$g‘_³”_addr
(ècÚ¡ {  
addr
; 
	}
}

227 
ušt32_t
 
	$g‘_timeout
(ècÚ¡ {  
timeout
; 
	}
}

230 
CÚ‹xt
 *
g‘_d–ayed_cb
();

233 
boŞ
 
cÚÃùed
();

236 
cÚÃù
(

237 
CÚÃùiÚRef
 
cÚ
,

238 
boŞ
 
wl_pšg


242 
discÚÃù
();

245 
disÿrd
();

248 
boŞ
 
	$is_disÿrded
() const;

251 
	`»move
(
boŞ
 
£nd_discÚÃù
);

254 
	`¡¬t_nÙify
(

255 
NÙifyRef
 
nÙif


259 
	`ÿnûl_nÙify
(

260 
NÙifyRef
 
nÙif


264 
	`nÙify_ack
(

265 
ušt64_t
 
nÙify_id
,

266 
bufã¾i¡
& 
»¶y_bl


268 
	}
};

274 şas 
	cW©chCÚS‹
 {

275 
Mu‹x
 
	mlock
;

276 
	m¡d
::
£t
<
W©chRef
> 
w©ches
;

277 
	mpublic
:

278 
C•hCÚ‹xt
* 
cù
;

279 
ex¶ic™
 
	$W©chCÚS‹
(
C•hCÚ‹xt
* 
cù
è: 
	`lock
("W©chCÚS‹"), 
	$cù
(
cù
) {}

282 
	`addW©ch
(

283 
W©chRef
 
w©ch


287 
	`»moveW©ch
(

288 
W©chRef
 
w©ch


292 
	`»£t
(
CÚÃùiÚ
 *
cÚ
);

293 
	}
};

	@osd/mClockClientQueue.cc

16 
	~<memÜy
>

18 
	~"osd/mClockCl›ÁQueue.h
"

19 
	~"commÚ/dout.h
"

21 
Çme¥aû
 
	gdmc
 = 
üimsÚ
::
dmşock
;

22 
usšg
 
Çme¥aû
 
	g¡d
::
¶aûhŞd”s
;

24 
	#dout_cÚ‹xt
 
cù


	)

25 
	#dout_subsys
 
ûph_subsys_osd


	)

26 #undeà
dout_´efix


27 
	#dout_´efix
 *
_dout


	)

30 
Çme¥aû
 
	gûph
 {

36 
	gmClockCl›ÁQueue
::
mClockCl›ÁQueue
(
C•hCÚ‹xt
 *
cù
) :

37 
queue
(
¡d
::
bšd
(&
mClockCl›ÁQueue
::
İ_şass_ş›Á_šfo_f
, 
this
, 
_1
),

38 
cù
->
_cÚf
->
osd_İ_queue_mşock_ªtic©iÚ_timeout
),

39 
ş›Á_šfo_mgr
(
cù
)

44 cÚ¡ 
	gdmc
::
Cl›ÁInfo
* 
mClockCl›ÁQueue
::
İ_şass_ş›Á_šfo_f
(

45 cÚ¡ 
mClockCl›ÁQueue
::
IÂ”Cl›Á
& 
ş›Á
)

47  
ş›Á_šfo_mgr
.
g‘_ş›Á_šfo
(
ş›Á
.
£cÚd
);

50 
	gmClockCl›ÁQueue
::
IÂ”Cl›Á


51 
šlše
 
mClockCl›ÁQueue
::
g‘_šÃr_ş›Á
(cÚ¡ 
Cl›Á
& 
ş
,

52 cÚ¡ 
Reque¡
& 
»que¡
) {

53  
IÂ”Cl›Á
(
ş
, 
ş›Á_šfo_mgr
.
osd_İ_ty³
(
»que¡
));

57 
šlše
 
	gmClockCl›ÁQueue
::
dump
(
ûph
::
FÜm©‹r
 *
f
) const {

58 
queue
.
dump
(
f
);

61 
šlše
 
	gmClockCl›ÁQueue
::
’queue_¡riù
(
Cl›Á
 
ş
,

62 
´iÜ™y
,

63 
Reque¡
&& 
™em
) {

64 
	gqueue
.
’queue_¡riù
(
g‘_šÃr_ş›Á
(
ş
, 
™em
), 
´iÜ™y
,

65 
¡d
::
move
(
™em
));

69 
šlše
 
	gmClockCl›ÁQueue
::
’queue_¡riù_äÚt
(
Cl›Á
 
ş
,

70 
´iÜ™y
,

71 
Reque¡
&& 
™em
) {

72 
	gqueue
.
’queue_¡riù_äÚt
(
g‘_šÃr_ş›Á
(
ş
, 
™em
), 
´iÜ™y
,

73 
¡d
::
move
(
™em
));

77 
šlše
 
	gmClockCl›ÁQueue
::
’queue
(
Cl›Á
 
ş
,

78 
´iÜ™y
,

79 
co¡
,

80 
Reque¡
&& 
™em
) {

81 
	gqueue
.
’queue
(
g‘_šÃr_ş›Á
(
ş
, 
™em
), 
´iÜ™y
, 0u, 
¡d
::
move
(item));

85 
šlše
 
	gmClockCl›ÁQueue
::
’queue_äÚt
(
Cl›Á
 
ş
,

86 
´iÜ™y
,

87 
co¡
,

88 
Reque¡
&& 
™em
) {

89 
	gqueue
.
’queue_äÚt
(
g‘_šÃr_ş›Á
(
ş
, 
™em
), 
´iÜ™y
, 0u,

90 
¡d
::
move
(
™em
));

94 
šlše
 
Reque¡
 
	gmClockCl›ÁQueue
::
dequeue
() {

95  
queue
.
dequeue
();

	@osd/mClockClientQueue.h

16 #´agm¨
Úû


18 
	~<o¡»am
>

20 
	~"boo¡/v¬ŸÁ.hµ
"

22 
	~"commÚ/cÚfig.h
"

23 
	~"commÚ/ûph_cÚ‹xt.h
"

24 
	~"commÚ/mClockPriÜ™yQueue.h
"

25 
	~"osd/OpQueueI‹m.h
"

26 
	~"osd/mClockOpCÏssSuµÜt.h
"

29 
Çme¥aû
 
	gûph
 {

31 
usšg
 
	gReque¡
 = 
OpQueueI‹m
;

32 
usšg
 
	gCl›Á
 = 
ušt64_t
;

38 
şass
 
	gmClockCl›ÁQueue
 : 
public
 
OpQueue
<
Reque¡
, 
	gCl›Á
> {

40 
usšg
 
	gosd_İ_ty³_t
 = 
ûph
::
mşock
::
osd_İ_ty³_t
;

42 
usšg
 
	gIÂ”Cl›Á
 = 
¡d
::
·œ
<
ušt64_t
,
	gosd_İ_ty³_t
>;

44 
usšg
 
	gqueue_t
 = 
mClockQueue
<
Reque¡
, 
	gIÂ”Cl›Á
>;

46 
queue_t
 
	gqueue
;

48 
	gûph
::
mşock
::
OpCÏssCl›ÁInfoMgr
 
ş›Á_šfo_mgr
;

50 
	gpublic
:

52 
mClockCl›ÁQueue
(
C•hCÚ‹xt
 *
cù
);

54 cÚ¡ 
	güimsÚ
::
dmşock
::
Cl›ÁInfo
* 
İ_şass_ş›Á_šfo_f
(cÚ¡ 
IÂ”Cl›Á
& 
ş›Á
);

56 
šlše
 
Ëngth
(ècÚ¡ 
ov”ride
 
	gfš®
 {

57  
	gqueue
.
Ëngth
();

61 
šlše
 
»move_by_şass
(
Cl›Á
 
ş
,

62 
¡d
::
li¡
<
Reque¡
> *
out
è
ov”ride
 
fš®
 {

63 
queue
.
»move_by_f‹r
(

64 [&
ş
, 
out
] (
Reque¡
&& 
r
è-> 
boŞ
 {

65 ià(
ş
 =ğ
r
.
g‘_owÃr
()) {

66 
out
->
push_äÚt
(
¡d
::
move
(
r
));

67  
Œue
;

69  
çl£
;

74 
’queue_¡riù
(
Cl›Á
 
ş
,

75 
´iÜ™y
,

76 
Reque¡
&& 
™em
è
ov”ride
 
	gfš®
;

79 
’queue_¡riù_äÚt
(
Cl›Á
 
ş
,

80 
´iÜ™y
,

81 
Reque¡
&& 
™em
è
ov”ride
 
	gfš®
;

84 
’queue
(
Cl›Á
 
ş
,

85 
´iÜ™y
,

86 
co¡
,

87 
Reque¡
&& 
™em
è
ov”ride
 
	gfš®
;

90 
’queue_äÚt
(
Cl›Á
 
ş
,

91 
´iÜ™y
,

92 
co¡
,

93 
Reque¡
&& 
™em
è
ov”ride
 
	gfš®
;

96 
Reque¡
 
dequeue
(è
ov”ride
 
	gfš®
;

99 
šlše
 
boŞ
 
em±y
(ècÚ¡ 
ov”ride
 
	gfš®
 {

100  
	gqueue
.
em±y
();

104 
dump
(
ûph
::
FÜm©‹r
 *
f
ècÚ¡ 
ov”ride
 
fš®
;

106 
	g´Ùeùed
:

108 
IÂ”Cl›Á
 
g‘_šÃr_ş›Á
(cÚ¡ 
Cl›Á
& 
ş
, cÚ¡ 
Reque¡
& 
»que¡
);

	@osd/mClockOpClassQueue.cc

16 
	~<memÜy
>

18 
	~"osd/mClockOpCÏssQueue.h
"

19 
	~"commÚ/dout.h
"

21 
Çme¥aû
 
	gdmc
 = 
üimsÚ
::
dmşock
;

22 
usšg
 
Çme¥aû
 
	g¡d
::
¶aûhŞd”s
;

24 
	#dout_cÚ‹xt
 
cù


	)

25 
	#dout_subsys
 
ûph_subsys_osd


	)

26 #undeà
dout_´efix


27 
	#dout_´efix
 *
_dout


	)

30 
Çme¥aû
 
	gûph
 {

36 
	gmClockOpCÏssQueue
::
mClockOpCÏssQueue
(
C•hCÚ‹xt
 *
cù
) :

37 
queue
(
¡d
::
bšd
(&
mClockOpCÏssQueue
::
İ_şass_ş›Á_šfo_f
, 
this
, 
_1
),

38 
cù
->
_cÚf
->
osd_İ_queue_mşock_ªtic©iÚ_timeout
),

39 
ş›Á_šfo_mgr
(
cù
)

44 cÚ¡ 
	gdmc
::
Cl›ÁInfo
* 
mClockOpCÏssQueue
::
İ_şass_ş›Á_šfo_f
(

45 cÚ¡ 
osd_İ_ty³_t
& 
İ_ty³
)

47  
ş›Á_šfo_mgr
.
g‘_ş›Á_šfo
(
İ_ty³
);

51 
	gmClockOpCÏssQueue
::
dump
(
ûph
::
FÜm©‹r
 *
f
) const {

52 
queue
.
dump
(
f
);

	@osd/mClockOpClassQueue.h

16 #´agm¨
Úû


18 
	~<o¡»am
>

20 
	~"boo¡/v¬ŸÁ.hµ
"

21 
	~"boo¡/cÚš”/æ©_£t.hµ
"

23 
	~"commÚ/cÚfig.h
"

24 
	~"commÚ/ûph_cÚ‹xt.h
"

25 
	~"commÚ/mClockPriÜ™yQueue.h
"

26 
	~"osd/OpQueueI‹m.h
"

27 
	~"osd/mClockOpCÏssSuµÜt.h
"

30 
Çme¥aû
 
	gûph
 {

32 
usšg
 
	gReque¡
 = 
OpQueueI‹m
;

33 
usšg
 
	gCl›Á
 = 
ušt64_t
;

39 
şass
 
	gmClockOpCÏssQueue
 : 
public
 
OpQueue
<
Reque¡
, 
	gCl›Á
> {

41 
usšg
 
	gosd_İ_ty³_t
 = 
ûph
::
mşock
::
osd_İ_ty³_t
;

43 
usšg
 
	gqueue_t
 = 
mClockQueue
<
Reque¡
, 
	gosd_İ_ty³_t
>;

44 
queue_t
 
	gqueue
;

46 
	gûph
::
mşock
::
OpCÏssCl›ÁInfoMgr
 
ş›Á_šfo_mgr
;

48 
	gpublic
:

50 
mClockOpCÏssQueue
(
C•hCÚ‹xt
 *
cù
);

52 cÚ¡ 
	güimsÚ
::
dmşock
::
Cl›ÁInfo
*

53 
İ_şass_ş›Á_šfo_f
(cÚ¡ 
osd_İ_ty³_t
& 
İ_ty³
);

55 
šlše
 
Ëngth
(ècÚ¡ 
ov”ride
 
	gfš®
 {

56  
	gqueue
.
Ëngth
();

60 
šlše
 
»move_by_şass
(
Cl›Á
 
ş
,

61 
¡d
::
li¡
<
Reque¡
> *
out
è
ov”ride
 
fš®
 {

62 
queue
.
»move_by_f‹r
(

63 [&
ş
, 
out
] (
Reque¡
&& 
r
è-> 
boŞ
 {

64 ià(
ş
 =ğ
r
.
g‘_owÃr
()) {

65 
out
->
push_äÚt
(
¡d
::
move
(
r
));

66  
Œue
;

68  
çl£
;

73 
šlše
 
’queue_¡riù
(
Cl›Á
 
ş
,

74 
´iÜ™y
,

75 
Reque¡
&& 
™em
è
ov”ride
 
	gfš®
 {

76 
	gqueue
.
’queue_¡riù
(
ş›Á_šfo_mgr
.
osd_İ_ty³
(
™em
),

77 
´iÜ™y
,

78 
¡d
::
move
(
™em
));

82 
šlše
 
’queue_¡riù_äÚt
(
Cl›Á
 
ş
,

83 
´iÜ™y
,

84 
Reque¡
&& 
™em
è
ov”ride
 
	gfš®
 {

85 
	gqueue
.
’queue_¡riù_äÚt
(
ş›Á_šfo_mgr
.
osd_İ_ty³
(
™em
),

86 
´iÜ™y
,

87 
¡d
::
move
(
™em
));

91 
šlše
 
’queue
(
Cl›Á
 
ş
,

92 
´iÜ™y
,

93 
co¡
,

94 
Reque¡
&& 
™em
è
ov”ride
 
	gfš®
 {

95 
	gqueue
.
’queue
(
ş›Á_šfo_mgr
.
osd_İ_ty³
(
™em
),

96 
´iÜ™y
,

98 
¡d
::
move
(
™em
));

102 
šlše
 
’queue_äÚt
(
Cl›Á
 
ş
,

103 
´iÜ™y
,

104 
co¡
,

105 
Reque¡
&& 
™em
è
ov”ride
 
	gfš®
 {

106 
	gqueue
.
’queue_äÚt
(
ş›Á_šfo_mgr
.
osd_İ_ty³
(
™em
),

107 
´iÜ™y
,

109 
¡d
::
move
(
™em
));

113 
šlše
 
boŞ
 
em±y
(ècÚ¡ 
ov”ride
 
	gfš®
 {

114  
	gqueue
.
em±y
();

118 
šlše
 
Reque¡
 
dequeue
(è
ov”ride
 
	gfš®
 {

119  
	gqueue
.
dequeue
();

123 
dump
(
ûph
::
FÜm©‹r
 *
f
ècÚ¡ 
ov”ride
 
fš®
;

	@osd/mClockOpClassSupport.cc

16 
	~"commÚ/dout.h
"

17 
	~"osd/mClockOpCÏssSuµÜt.h
"

18 
	~"osd/OpQueueI‹m.h
"

20 
	~"šşude/as£¹.h
"

22 
Çme¥aû
 
	gûph
 {

24 
Çme¥aû
 
	gmşock
 {

26 
	gOpCÏssCl›ÁInfoMgr
::
OpCÏssCl›ÁInfoMgr
(
C•hCÚ‹xt
 *
cù
) :

27 
ş›Á_İ
(
cù
->
_cÚf
->
osd_İ_queue_mşock_ş›Á_İ_»s
,

28 
cù
->
_cÚf
->
osd_İ_queue_mşock_ş›Á_İ_wgt
,

29 
cù
->
_cÚf
->
osd_İ_queue_mşock_ş›Á_İ_lim
),

30 
osd_»p_İ
(
cù
->
_cÚf
->
osd_İ_queue_mşock_osd_»p_İ_»s
,

31 
cù
->
_cÚf
->
osd_İ_queue_mşock_osd_»p_İ_wgt
,

32 
cù
->
_cÚf
->
osd_İ_queue_mşock_osd_»p_İ_lim
),

33 
¢­Œim
(
cù
->
_cÚf
->
osd_İ_queue_mşock_¢­_»s
,

34 
cù
->
_cÚf
->
osd_İ_queue_mşock_¢­_wgt
,

35 
cù
->
_cÚf
->
osd_İ_queue_mşock_¢­_lim
),

36 
»cov
(
cù
->
_cÚf
->
osd_İ_queue_mşock_»cov_»s
,

37 
cù
->
_cÚf
->
osd_İ_queue_mşock_»cov_wgt
,

38 
cù
->
_cÚf
->
osd_İ_queue_mşock_»cov_lim
),

39 
süub
(
cù
->
_cÚf
->
osd_İ_queue_mşock_süub_»s
,

40 
cù
->
_cÚf
->
osd_İ_queue_mşock_süub_wgt
,

41 
cù
->
_cÚf
->
osd_İ_queue_mşock_süub_lim
),

42 
pg_d–‘e
(
cù
->
_cÚf
->
osd_İ_queue_mşock_pg_d–‘e_»s
,

43 
cù
->
_cÚf
->
osd_İ_queue_mşock_pg_d–‘e_wgt
,

44 
cù
->
_cÚf
->
osd_İ_queue_mşock_pg_d–‘e_lim
),

45 
³”šg_ev’t
(
cù
->
_cÚf
->
osd_İ_queue_mşock_³”šg_ev’t_»s
,

46 
cù
->
_cÚf
->
osd_İ_queue_mşock_³”šg_ev’t_wgt
,

47 
cù
->
_cÚf
->
osd_İ_queue_mşock_³”šg_ev’t_lim
)

49 
cÚ¡ex´
 
	g»p_İs
[] = {

50 
MSG_OSD_REPOP
,

51 
MSG_OSD_REPOPREPLY
,

52 
MSG_OSD_PG_UPDATE_LOG_MISSING
,

53 
MSG_OSD_PG_UPDATE_LOG_MISSING_REPLY
,

54 
MSG_OSD_EC_WRITE
,

55 
MSG_OSD_EC_WRITE_REPLY
,

56 
MSG_OSD_EC_READ
,

57 
MSG_OSD_EC_READ_REPLY


59 autØ
	gİ
 : 
»p_İs
) {

60 
add_»p_İ_msg
(
İ
);

63 
lg’”ic_subdout
(
cù
, 
osd
, 20) <<

65 "ş›Á_İ:" << 
	gş›Á_İ
 <<

66 "; osd_»p_İ:" << 
	gosd_»p_İ
 <<

67 "; sÇ±rim:" << 
	g¢­Œim
 <<

68 ";„ecov:" << 
	g»cov
 <<

69 "; süub:" << 
	gsüub
 <<

70 
	gd’dl
;

72 
lg’”ic_subdout
(
cù
, 
osd
, 30) <<

74 
	g»p_İ_msg_b™£t
.
to_¡ršg
(è<< 
	gd’dl
;

77 
	gOpCÏssCl›ÁInfoMgr
::
add_»p_İ_msg
(
mes§ge_code
) {

78 
as£¹
(
mes§ge_code
 >ğ0 && mes§ge_cod< (
»p_İ_msg_b™£t_size
));

79 
	g»p_İ_msg_b™£t
.
£t
(
mes§ge_code
);

82 
osd_İ_ty³_t


83 
	gOpCÏssCl›ÁInfoMgr
::
osd_İ_ty³
(cÚ¡ 
OpQueueI‹m
& 
İ
) const {

84 
osd_İ_ty³_t
 
ty³
 = 
cÚv”t_İ_ty³
(
İ
.
g‘_İ_ty³
());

85 ià(
	gosd_İ_ty³_t
::
ş›Á_İ
 !ğ
ty³
) {

86  
ty³
;

91 
	gboo¡
::
İtiÚ®
<
OpReque¡Ref
> 
İ_»f_maybe
 = 
İ
.
maybe_g‘_İ
();

92 
as£¹
(
İ_»f_maybe
);

93 
__Ë16
 
	gmty³_Ë
 = (*
İ_»f_maybe
)->
g‘_»q
()->
g‘_h—d”
().
ty³
;

94 
__u16
 
	gmty³
 = 
Ë16_to_ıu
(
mty³_Ë
);

95 ià(
	g»p_İ_msg_b™£t
.
‹¡
(
mty³
)) {

96  
	gosd_İ_ty³_t
::
osd_»p_İ
;

98  
	gosd_İ_ty³_t
::
ş›Á_İ
;

105 
boŞ
 
	gOpCÏssCl›ÁInfoMgr
::
is_»p_İ
(
ušt16_t
 
mty³
) {

107 
MSG_OSD_REPOP
 =ğ
mty³
 ||

108 
MSG_OSD_REPOPREPLY
 =ğ
mty³
 ||

109 
MSG_OSD_PG_UPDATE_LOG_MISSING
 =ğ
mty³
 ||

110 
MSG_OSD_PG_UPDATE_LOG_MISSING_REPLY
 =ğ
mty³
 ||

111 
MSG_OSD_EC_WRITE
 =ğ
mty³
 ||

112 
MSG_OSD_EC_WRITE_REPLY
 =ğ
mty³
 ||

113 
MSG_OSD_EC_READ
 =ğ
mty³
 ||

114 
MSG_OSD_EC_READ_REPLY
 =ğ
mty³
;

	@osd/mClockOpClassSupport.h

16 #´agm¨
Úû


18 
	~<b™£t
>

20 
	~"dmşock/¤c/dmşock_£rv”.h
"

21 
	~"osd/OpReque¡.h
"

22 
	~"osd/OpQueueI‹m.h
"

25 
Çme¥aû
 
	gûph
 {

26 
Çme¥aû
 
	gmşock
 {

28 
usšg
 
	gİ_™em_ty³_t
 = 
OpQueueI‹m
::
OpQueu—bË
::
İ_ty³_t
;

30 şas 
	cosd_İ_ty³_t
 {

31 
	gş›Á_İ
, 
	gosd_»p_İ
, 
	gbg_¢­Œim
, 
	gbg_»cov”y
, 
	gbg_süub
, 
	gbg_pg_d–‘e
,

32 
	g³”šg_ev’t


35 şas 
	cOpCÏssCl›ÁInfoMgr
 {

36 
	güimsÚ
::
dmşock
::
Cl›ÁInfo
 
ş›Á_İ
;

37 
	güimsÚ
::
dmşock
::
Cl›ÁInfo
 
osd_»p_İ
;

38 
	güimsÚ
::
dmşock
::
Cl›ÁInfo
 
¢­Œim
;

39 
	güimsÚ
::
dmşock
::
Cl›ÁInfo
 
»cov
;

40 
	güimsÚ
::
dmşock
::
Cl›ÁInfo
 
süub
;

41 
	güimsÚ
::
dmşock
::
Cl›ÁInfo
 
pg_d–‘e
;

42 
	güimsÚ
::
dmşock
::
Cl›ÁInfo
 
³”šg_ev’t
;

44 
cÚ¡ex´
 
	g¡d
::
size_t
 
»p_İ_msg_b™£t_size
 = 128;

45 
	g¡d
::
b™£t
<
»p_İ_msg_b™£t_size
> 
»p_İ_msg_b™£t
;

46 
add_»p_İ_msg
(
mes§ge_code
);

48 
	gpublic
:

50 
OpCÏssCl›ÁInfoMgr
(
C•hCÚ‹xt
 *
cù
);

52 
šlše
 cÚ¡ 
	güimsÚ
::
dmşock
::
Cl›ÁInfo
*

53 
g‘_ş›Á_šfo
(
osd_İ_ty³_t
 
ty³
) {

54 
ty³
) {

55 
osd_İ_ty³_t
::
ş›Á_İ
:

56  &
ş›Á_İ
;

57 
	gosd_İ_ty³_t
::
osd_»p_İ
:

58  &
osd_»p_İ
;

59 
	gosd_İ_ty³_t
::
bg_¢­Œim
:

60  &
¢­Œim
;

61 
	gosd_İ_ty³_t
::
bg_»cov”y
:

62  &
»cov
;

63 
	gosd_İ_ty³_t
::
bg_süub
:

64  &
süub
;

65 
	gosd_İ_ty³_t
::
bg_pg_d–‘e
:

66  &
pg_d–‘e
;

67 
	gosd_İ_ty³_t
::
³”šg_ev’t
:

68  &
³”šg_ev’t
;

70 
ûph_abÜt
();

71  
	gnuÎ±r
;

77 
šlše
 
osd_İ_ty³_t
 
cÚv”t_İ_ty³
(
İ_™em_ty³_t
 
t
) {

78 
	gt
) {

79 
	gİ_™em_ty³_t
::
ş›Á_İ
:

80  
osd_İ_ty³_t
::
ş›Á_İ
;

81 
	gİ_™em_ty³_t
::
bg_¢­Œim
:

82  
osd_İ_ty³_t
::
bg_¢­Œim
;

83 
	gİ_™em_ty³_t
::
bg_»cov”y
:

84  
osd_İ_ty³_t
::
bg_»cov”y
;

85 
	gİ_™em_ty³_t
::
bg_süub
:

86  
osd_İ_ty³_t
::
bg_süub
;

87 
	gİ_™em_ty³_t
::
bg_pg_d–‘e
:

88  
osd_İ_ty³_t
::
bg_pg_d–‘e
;

89 
	gİ_™em_ty³_t
::
³”šg_ev’t
:

90  
osd_İ_ty³_t
::
³”šg_ev’t
;

92 
ûph_abÜt
();

96 
osd_İ_ty³_t
 
osd_İ_ty³
(cÚ¡ 
OpQueueI‹m
&) const;

100 
boŞ
 
is_»p_İ
(
ušt16_t
);

	@osd/osd_internal_types.h

4 #iâdeà
CEPH_OSD_INTERNAL_TYPES_H


5 
	#CEPH_OSD_INTERNAL_TYPES_H


	)

7 
	~"osd_ty³s.h
"

8 
	~"OpReque¡.h
"

17 
	sSÇpS‘CÚ‹xt
 {

18 
hobjeù_t
 
	moid
;

19 
SÇpS‘
 
	m¢­£t
;

20 
	m»f
;

21 
boŞ
 
	m»gi¡”ed
 : 1;

22 
boŞ
 
	mexi¡s
 : 1;

24 
ex¶ic™
 
SÇpS‘CÚ‹xt
(cÚ¡ 
hobjeù_t
& 
o
) :

25 
oid
(
o
), 
»f
(0), 
»gi¡”ed
(
çl£
), 
exi¡s
(
Œue
) { }

28 
	gObjeùCÚ‹xt
;

30 
	sObjeùS‹
 {

31 
objeù_šfo_t
 
	moi
;

32 
boŞ
 
	mexi¡s
;

34 
ObjeùS‹
(è: 
exi¡s
(
çl£
) {}

36 
ObjeùS‹
(cÚ¡ 
objeù_šfo_t
 &
oi_
, 
boŞ
 
exi¡s_
)

37 : 
oi
(
oi_
), 
exi¡s
(
exi¡s_
) {}

40 
	gûph
::
	tsh¬ed_±r
<
	tObjeùCÚ‹xt
> 
	tObjeùCÚ‹xtRef
;

42 
	sObjeùCÚ‹xt
 {

43 
ObjeùS‹
 
	mobs
;

45 
SÇpS‘CÚ‹xt
 *
	mssc
;

47 
CÚ‹xt
 *
	mde¡ruùÜ_ÿÎback
;

49 
	mpublic
:

52 
m­
<
·œ
<
ušt64_t
, 
	m’t™y_Çme_t
>, 
	mW©chRef
> 
	mw©ch”s
;

55 
	mm­
<
	m¡ršg
, 
	mbufã¾i¡
> 
	m©Œ_ÿche
;

57 
	sRWS‹
 {

58 
	eS‹
 {

59 
	mRWNONE
,

60 
	mRWREAD
,

61 
	mRWWRITE
,

62 
	mRWEXCL
,

64 cÚ¡ *
g‘_¡©e_Çme
(
S‹
 
s
) {

65 
	ms
) {

66 
	mRWNONE
:  "none";

67 
	mRWREAD
:  "read";

68 
	mRWWRITE
:  "write";

69 
	mRWEXCL
:  "excl";

73 cÚ¡ *
g‘_¡©e_Çme
() const {

74  
g‘_¡©e_Çme
(
¡©e
);

77 
	m¡d
::
li¡
<
OpReque¡Ref
> 
wa™”s
;

78 
	mcouÁ
;

80 
S‹
 
	m¡©e
:4;

82 
boŞ
 
	m»cov”y_»ad_m¬k”
:1;

84 
boŞ
 
	m¢­Œimm”_wr™e_m¬k”
:1;

86 
RWS‹
()

87 : 
couÁ
(0),

88 
¡©e
(
RWNONE
),

89 
»cov”y_»ad_m¬k”
(
çl£
),

90 
¢­Œimm”_wr™e_m¬k”
(
çl£
)

92 
boŞ
 
g‘_»ad
(
OpReque¡Ref
& 
İ
) {

93 ià(
g‘_»ad_lock
()) {

94  
	mŒue
;

97 
	mwa™”s
.
em¶aû_back
(
İ
);

98  
	mçl£
;

101 
boŞ
 
g‘_»ad_lock
() {

103 ià(!
	mwa™”s
.
em±y
()) {

104  
	mçl£
;

106 
	m¡©e
) {

107 
	mRWNONE
:

108 
as£¹
(
couÁ
 == 0);

109 
	m¡©e
 = 
RWREAD
;

111 
	mRWREAD
:

112 
couÁ
++;

113  
	mŒue
;

114 
	mRWWRITE
:

115  
çl£
;

116 
	mRWEXCL
:

117  
çl£
;

119 
as£¹
(0 == "unhandled case");

120  
	mçl£
;

124 
boŞ
 
g‘_wr™e
(
OpReque¡Ref
& 
İ
, boŞ 
g»edy
=
çl£
) {

125 ià(
g‘_wr™e_lock
(
g»edy
)) {

126  
Œue
;

128 ià(
	mİ
)

129 
	mwa™”s
.
em¶aû_back
(
İ
);

130  
	mçl£
;

132 
boŞ
 
g‘_wr™e_lock
(boŞ 
g»edy
=
çl£
) {

133 ià(!
g»edy
) {

135 ià(!
wa™”s
.
em±y
() ||

136 
»cov”y_»ad_m¬k”
) {

137  
çl£
;

140 
	m¡©e
) {

141 
	mRWNONE
:

142 
as£¹
(
couÁ
 == 0);

143 
	m¡©e
 = 
RWWRITE
;

145 
	mRWWRITE
:

146 
couÁ
++;

147  
	mŒue
;

148 
	mRWREAD
:

149  
çl£
;

150 
	mRWEXCL
:

151  
çl£
;

153 
as£¹
(0 == "unhandled case");

154  
	mçl£
;

157 
boŞ
 
g‘_exş_lock
() {

158 
	m¡©e
) {

159 
	mRWNONE
:

160 
as£¹
(
couÁ
 == 0);

161 
	m¡©e
 = 
RWEXCL
;

162 
	mcouÁ
 = 1;

163  
	mŒue
;

164 
	mRWWRITE
:

165  
çl£
;

166 
	mRWREAD
:

167  
çl£
;

168 
	mRWEXCL
:

169  
çl£
;

171 
as£¹
(0 == "unhandled case");

172  
	mçl£
;

175 
boŞ
 
g‘_exş
(
OpReque¡Ref
& 
İ
) {

176 ià(
g‘_exş_lock
()) {

177  
	mŒue
;

179 ià(
	mİ
)

180 
	mwa™”s
.
em¶aû_back
(
İ
);

181  
	mçl£
;

184 
boŞ
 
ke_wr™e_lock
() {

185 ià(
	m¡©e
 =ğ
RWWRITE
) {

186 
couÁ
++;

187  
	mŒue
;

189  
g‘_wr™e_lock
();

191 
dec
(
li¡
<
OpReque¡Ref
> *
»queue
) {

192 
as£¹
(
couÁ
 > 0);

193 
as£¹
(
»queue
);

194 
	mcouÁ
--;

195 ià(
	mcouÁ
 == 0) {

196 
¡©e
 = 
RWNONE
;

197 
	m»queue
->
¥liû
(
»queue
->
’d
(), 
wa™”s
);

200 
put_»ad
(
li¡
<
OpReque¡Ref
> *
»queue
) {

201 
as£¹
(
¡©e
 =ğ
RWREAD
);

202 
dec
(
»queue
);

204 
put_wr™e
(
li¡
<
OpReque¡Ref
> *
»queue
) {

205 
as£¹
(
¡©e
 =ğ
RWWRITE
);

206 
dec
(
»queue
);

208 
put_exş
(
li¡
<
OpReque¡Ref
> *
»queue
) {

209 
as£¹
(
¡©e
 =ğ
RWEXCL
);

210 
dec
(
»queue
);

212 
boŞ
 
em±y
(ècÚ¡ {  
	m¡©e
 =ğ
RWNONE
; }

213 } 
	mrw¡©e
;

215 
boŞ
 
g‘_»ad
(
OpReque¡Ref
& 
İ
) {

216  
	mrw¡©e
.
g‘_»ad
(
İ
);

218 
boŞ
 
g‘_wr™e
(
OpReque¡Ref
& 
İ
) {

219  
	mrw¡©e
.
g‘_wr™e
(
İ
, 
çl£
);

221 
boŞ
 
g‘_exş
(
OpReque¡Ref
 
İ
) {

222  
	mrw¡©e
.
g‘_exş
(
İ
);

224 
boŞ
 
g‘_lock_ty³
(
OpReque¡Ref
& 
İ
, 
RWS‹
::
S‹
 
ty³
) {

225 
ty³
) {

226 
RWS‹
::
RWWRITE
:

227  
g‘_wr™e
(
İ
);

228 
	mRWS‹
::
RWREAD
:

229  
g‘_»ad
(
İ
);

230 
	mRWS‹
::
RWEXCL
:

231  
g‘_exş
(
İ
);

233 
as£¹
(0 == "invalid†ockype");

234  
	mŒue
;

237 
boŞ
 
g‘_wr™e_g»edy
(
OpReque¡Ref
& 
İ
) {

238  
	mrw¡©e
.
g‘_wr™e
(
İ
, 
Œue
);

240 
boŞ
 
g‘_¢­Œimm”_wr™e
(boŞ 
m¬k_if_unsucûssful
) {

241 ià(
	mrw¡©e
.
g‘_wr™e_lock
()) {

242  
	mŒue
;

244 ià(
	mm¬k_if_unsucûssful
)

245 
	mrw¡©e
.
	m¢­Œimm”_wr™e_m¬k”
 = 
Œue
;

246  
	mçl£
;

249 
boŞ
 
g‘_»cov”y_»ad
() {

250 
	mrw¡©e
.
	m»cov”y_»ad_m¬k”
 = 
Œue
;

251 ià(
	mrw¡©e
.
g‘_»ad_lock
()) {

252  
	mŒue
;

254  
	mçl£
;

256 
boŞ
 
Œy_g‘_»ad_lock
() {

257  
	mrw¡©e
.
g‘_»ad_lock
();

259 
drİ_»cov”y_»ad
(
li¡
<
OpReque¡Ref
> *
ls
) {

260 
as£¹
(
rw¡©e
.
»cov”y_»ad_m¬k”
);

261 
	mrw¡©e
.
put_»ad
(
ls
);

262 
	mrw¡©e
.
	m»cov”y_»ad_m¬k”
 = 
çl£
;

264 
put_lock_ty³
(

265 
ObjeùCÚ‹xt
::
RWS‹
::
S‹
 
ty³
,

266 
li¡
<
OpReque¡Ref
> *
to_wake
,

267 
boŞ
 *
»queue_»cov”y
,

268 
boŞ
 *
»queue_¢­Œimm”
) {

269 
	mty³
) {

270 
	mObjeùCÚ‹xt
::
RWS‹
::
RWWRITE
:

271 
rw¡©e
.
put_wr™e
(
to_wake
);

273 
	mObjeùCÚ‹xt
::
RWS‹
::
RWREAD
:

274 
rw¡©e
.
put_»ad
(
to_wake
);

276 
	mObjeùCÚ‹xt
::
RWS‹
::
RWEXCL
:

277 
rw¡©e
.
put_exş
(
to_wake
);

280 
as£¹
(0 == "invalid†ockype");

282 ià(
	mrw¡©e
.
em±y
(è&&„w¡©e.
	m»cov”y_»ad_m¬k”
) {

283 
	mrw¡©e
.
	m»cov”y_»ad_m¬k”
 = 
çl£
;

284 *
	m»queue_»cov”y
 = 
Œue
;

286 ià(
	mrw¡©e
.
em±y
(è&&„w¡©e.
	m¢­Œimm”_wr™e_m¬k”
) {

287 
	mrw¡©e
.
	m¢­Œimm”_wr™e_m¬k”
 = 
çl£
;

288 *
	m»queue_¢­Œimm”
 = 
Œue
;

291 
boŞ
 
is_»que¡_³ndšg
() {

292  (
	mrw¡©e
.
	mcouÁ
 > 0);

295 
ObjeùCÚ‹xt
()

296 : 
ssc
(
NULL
),

297 
de¡ruùÜ_ÿÎback
(0),

298 
blocked
(
çl£
), 
»queue_süub_Ú_unblock
(false) {}

300 ~
ObjeùCÚ‹xt
() {

301 
as£¹
(
rw¡©e
.
em±y
());

302 ià(
	mde¡ruùÜ_ÿÎback
)

303 
	mde¡ruùÜ_ÿÎback
->
com¶‘e
(0);

306 
¡¬t_block
() {

307 
as£¹
(!
blocked
);

308 
	mblocked
 = 
Œue
;

310 
¡İ_block
() {

311 
as£¹
(
blocked
);

312 
	mblocked
 = 
çl£
;

314 
boŞ
 
is_blocked
() const {

315  
	mblocked
;

319 
boŞ
 
	mblocked
:1;

320 
boŞ
 
	m»queue_süub_Ú_unblock
:1;

324 
šlše
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gObjeùS‹
& 
	gobs
)

326 
	gout
 << 
	gobs
.
	goi
.
	gsoid
;

327 ià(!
	gobs
.
	gexi¡s
)

328 
	gout
 << "(dne)";

329  
	gout
;

332 
šlše
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gObjeùCÚ‹xt
::
RWS‹
& 
rw
)

334  
out
 << "rw¡©e(" << 
rw
.
g‘_¡©e_Çme
()

335 << "‚=" << 
rw
.
couÁ


336 << " w=" << 
rw
.
wa™”s
.
size
()

340 
šlše
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gObjeùCÚ‹xt
& 
	gobc
)

342  
	gout
 << "obc(" << 
	gobc
.
	gobs
 << " " << obc.
	grw¡©e
 << ")";

345 şas 
	cObcLockMªag”
 {

346 
	sObjeùLockS‹
 {

347 
ObjeùCÚ‹xtRef
 
	mobc
;

348 
	mObjeùCÚ‹xt
::
RWS‹
::
S‹
 
ty³
;

349 
ObjeùLockS‹
(

350 
ObjeùCÚ‹xtRef
 
obc
,

351 
ObjeùCÚ‹xt
::
RWS‹
::
S‹
 
ty³
)

352 : 
obc
(
¡d
::
move
(obc)), 
ty³
(type) {}

354 
	gm­
<
	ghobjeù_t
, 
	gObjeùLockS‹
> 
	glocks
;

355 
	gpublic
:

356 
ObcLockMªag”
() = ;

357 
ObcLockMªag”
(ObcLockManager &&) = ;

358 
ObcLockMªag”
(cÚ¡ ObcLockMªag” &èğ
d–‘e
;

359 
	gObcLockMªag”
 &
	gİ”©Ü
=(
ObcLockMªag”
 &&) = ;

360 
boŞ
 
	$em±y
() const {

361  
locks
.
	`em±y
();

362 
	}
}

363 
boŞ
 
	$g‘_lock_ty³
(

364 
ObjeùCÚ‹xt
::
RWS‹
::
S‹
 
ty³
,

365 cÚ¡ 
hobjeù_t
 &
hoid
,

366 
ObjeùCÚ‹xtRef
& 
obc
,

367 
OpReque¡Ref
& 
İ
) {

368 
	`as£¹
(
locks
.
	`fšd
(
hoid
è=ğlocks.
	`’d
());

369 ià(
obc
->
	`g‘_lock_ty³
(
İ
, 
ty³
)) {

370 
locks
.
	`š£¹
(
	`make_·œ
(
hoid
, 
	`ObjeùLockS‹
(
obc
, 
ty³
)));

371  
Œue
;

373  
çl£
;

375 
	}
}

377 
boŞ
 
	$ke_wr™e_lock
(

378 cÚ¡ 
hobjeù_t
 &
hoid
,

379 
ObjeùCÚ‹xtRef
 
obc
) {

380 
	`as£¹
(
locks
.
	`fšd
(
hoid
è=ğlocks.
	`’d
());

381 ià(
obc
->
rw¡©e
.
	`ke_wr™e_lock
()) {

382 
locks
.
	`š£¹
(

383 
	`make_·œ
(

384 
hoid
, 
	`ObjeùLockS‹
(
obc
, 
ObjeùCÚ‹xt
::
RWS‹
::
RWWRITE
)));

385  
Œue
;

387  
çl£
;

389 
	}
}

391 
boŞ
 
	$g‘_¢­Œimm”_wr™e
(

392 cÚ¡ 
hobjeù_t
 &
hoid
,

393 
ObjeùCÚ‹xtRef
 
obc
,

394 
boŞ
 
m¬k_if_unsucûssful
) {

395 
	`as£¹
(
locks
.
	`fšd
(
hoid
è=ğlocks.
	`’d
());

396 ià(
obc
->
	`g‘_¢­Œimm”_wr™e
(
m¬k_if_unsucûssful
)) {

397 
locks
.
	`š£¹
(

398 
	`make_·œ
(

399 
hoid
, 
	`ObjeùLockS‹
(
obc
, 
ObjeùCÚ‹xt
::
RWS‹
::
RWWRITE
)));

400  
Œue
;

402  
çl£
;

404 
	}
}

406 
boŞ
 
	$g‘_wr™e_g»edy
(

407 cÚ¡ 
hobjeù_t
 &
hoid
,

408 
ObjeùCÚ‹xtRef
 
obc
,

409 
OpReque¡Ref
 
İ
) {

410 
	`as£¹
(
locks
.
	`fšd
(
hoid
è=ğlocks.
	`’d
());

411 ià(
obc
->
	`g‘_wr™e_g»edy
(
İ
)) {

412 
locks
.
	`š£¹
(

413 
	`make_·œ
(

414 
hoid
, 
	`ObjeùLockS‹
(
obc
, 
ObjeùCÚ‹xt
::
RWS‹
::
RWWRITE
)));

415  
Œue
;

417  
çl£
;

419 
	}
}

422 
boŞ
 
	$Œy_g‘_»ad_lock
(

423 cÚ¡ 
hobjeù_t
 &
hoid
,

424 
ObjeùCÚ‹xtRef
 
obc
) {

425 
	`as£¹
(
locks
.
	`fšd
(
hoid
è=ğlocks.
	`’d
());

426 ià(
obc
->
	`Œy_g‘_»ad_lock
()) {

427 
locks
.
	`š£¹
(

428 
	`make_·œ
(

429 
hoid
,

430 
	`ObjeùLockS‹
(
obc
, 
ObjeùCÚ‹xt
::
RWS‹
::
RWREAD
)));

431  
Œue
;

433  
çl£
;

435 
	}
}

437 
put_locks
(

438 
li¡
<
·œ
<
ObjeùCÚ‹xtRef
,†i¡<
OpReque¡Ref
> > > *
to_»queue
,

439 
boŞ
 *
»queue_»cov”y
,

440 
boŞ
 *
»queue_¢­Œimm”
) {

441 auto& 
	gp
: 
locks
) {

442 
li¡
<
OpReque¡Ref
> 
_to_»queue
;

443 
	gp
.
	g£cÚd
.
	gobc
->
put_lock_ty³
(

444 
p
.
£cÚd
.
ty³
,

445 &
_to_»queue
,

446 
»queue_»cov”y
,

447 
»queue_¢­Œimm”
);

448 ià(
	gto_»queue
) {

451 
	gto_»queue
->
em¶aû_back
(
¡d
::
move
(
p
.
£cÚd
.
obc
),

452 
¡d
::
move
(
_to_»queue
));

455 
	glocks
.
ş—r
();

457 ~
	$ObcLockMªag”
() {

458 
	`as£¹
(
locks
.
	`em±y
());

459 
	}
}

	@osd/osd_types.cc

18 
	~<boo¡/assign/li¡_of.hµ
>

20 
	~"osd_ty³s.h
"

21 
	~"šşude/ûph_ã©u»s.h
"

23 
	~"üush/hash.h
"

25 
	~"PG.h
"

26 
	~"OSDM­.h
"

27 
	~"PGBack’d.h
"

29 cÚ¡ *
	$ûph_osd_æag_Çme
(
æag
)

31 
æag
) {

32 
CEPH_OSD_FLAG_ACK
:  "ack";

33 
CEPH_OSD_FLAG_ONNVRAM
:  "onnvram";

34 
CEPH_OSD_FLAG_ONDISK
:  "ondisk";

35 
CEPH_OSD_FLAG_RETRY
:  "retry";

36 
CEPH_OSD_FLAG_READ
:  "read";

37 
CEPH_OSD_FLAG_WRITE
:  "write";

38 
CEPH_OSD_FLAG_ORDERSNAP
:  "ordersnap";

39 
CEPH_OSD_FLAG_PEERSTAT_OLD
:  "peerstat_old";

40 
CEPH_OSD_FLAG_BALANCE_READS
:  "balance_reads";

41 
CEPH_OSD_FLAG_PARALLELEXEC
:  "parallelexec";

42 
CEPH_OSD_FLAG_PGOP
:  "pgop";

43 
CEPH_OSD_FLAG_EXEC
:  "exec";

44 
CEPH_OSD_FLAG_EXEC_PUBLIC
:  "exec_public";

45 
CEPH_OSD_FLAG_LOCALIZE_READS
:  "localize_reads";

46 
CEPH_OSD_FLAG_RWORDERED
:  "rwordered";

47 
CEPH_OSD_FLAG_IGNORE_CACHE
:  "ignore_cache";

48 
CEPH_OSD_FLAG_SKIPRWLOCKS
:  "skiprwlocks";

49 
CEPH_OSD_FLAG_IGNORE_OVERLAY
:  "ignore_overlay";

50 
CEPH_OSD_FLAG_FLUSH
:  "flush";

51 
CEPH_OSD_FLAG_MAP_SNAP_CLONE
:  "map_snap_clone";

52 
CEPH_OSD_FLAG_ENFORCE_SNAPC
:  "enforce_snapc";

53 
CEPH_OSD_FLAG_REDIRECTED
:  "redirected";

54 
CEPH_OSD_FLAG_KNOWN_REDIR
:  "known_if_redirected";

55 
CEPH_OSD_FLAG_FULL_TRY
:  "full_try";

56 
CEPH_OSD_FLAG_FULL_FORCE
:  "full_force";

57 
CEPH_OSD_FLAG_IGNORE_REDIRECT
:  "ignore_redirect";

60 
	}
}

62 
¡ršg
 
	$ûph_osd_æag_¡ršg
(
æags
)

64 
¡ršg
 
s
;

65 
i
=0; i<32; ++i) {

66 ià(
æags
 & (1u<<
i
)) {

67 ià(
s
.
	`Ëngth
())

68 
s
 += "+";

69 
s
 +ğ
	`ûph_osd_æag_Çme
(1u << 
i
);

72 ià(
s
.
	`Ëngth
())

73  
s
;

74  
	`¡ršg
("-");

75 
	}
}

77 cÚ¡ * 
	$ûph_osd_İ_æag_Çme
(
æag
)

79 cÚ¡ *
Çme
;

81 
æag
) {

82 
CEPH_OSD_OP_FLAG_EXCL
:

83 
Çme
 = "excl";

85 
CEPH_OSD_OP_FLAG_FAILOK
:

86 
Çme
 = "failok";

88 
CEPH_OSD_OP_FLAG_FADVISE_RANDOM
:

89 
Çme
 = "fadvise_random";

91 
CEPH_OSD_OP_FLAG_FADVISE_SEQUENTIAL
:

92 
Çme
 = "fadvise_sequential";

94 
CEPH_OSD_OP_FLAG_FADVISE_WILLNEED
:

95 
Çme
 = "favise_willneed";

97 
CEPH_OSD_OP_FLAG_FADVISE_DONTNEED
:

98 
Çme
 = "fadvise_dontneed";

100 
CEPH_OSD_OP_FLAG_FADVISE_NOCACHE
:

101 
Çme
 = "fadvise_nocache";

104 
Çme
 = "???";

107  
Çme
;

108 
	}
}

110 
¡ršg
 
	$ûph_osd_İ_æag_¡ršg
(
æags
)

112 
¡ršg
 
s
;

113 
i
=0; i<32; ++i) {

114 ià(
æags
 & (1u<<
i
)) {

115 ià(
s
.
	`Ëngth
())

116 
s
 += "+";

117 
s
 +ğ
	`ûph_osd_İ_æag_Çme
(1u << 
i
);

120 ià(
s
.
	`Ëngth
())

121  
s
;

122  
	`¡ršg
("-");

123 
	}
}

125 
¡ršg
 
	$ûph_osd_®loc_hšt_æag_¡ršg
(
æags
)

127 
¡ršg
 
s
;

128 
i
=0; i<32; ++i) {

129 ià(
æags
 & (1u<<
i
)) {

130 ià(
s
.
	`Ëngth
())

131 
s
 += "+";

132 
s
 +ğ
	`ûph_osd_®loc_hšt_æag_Çme
(1u << 
i
);

135 ià(
s
.
	`Ëngth
())

136  
s
;

137  
	`¡ršg
("-");

138 
	}
}

140 
pg_sh¬d_t
::
	$’code
(
bufã¾i¡
 &
bl
) const

142 
	`ENCODE_START
(1, 1, 
bl
);

143 
	`’code
(
osd
, 
bl
);

144 
	`’code
(
sh¬d
, 
bl
);

145 
	`ENCODE_FINISH
(
bl
);

146 
	}
}

147 
pg_sh¬d_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

149 
	`DECODE_START
(1, 
bl
);

150 
	`decode
(
osd
, 
bl
);

151 
	`decode
(
sh¬d
, 
bl
);

152 
	`DECODE_FINISH
(
bl
);

153 
	}
}

155 
o¡»am
 &
İ”©Ü
<<(o¡»am &
lhs
, cÚ¡ 
pg_sh¬d_t
 &
rhs
)

157 ià(
rhs
.
is_undefšed
())

158  
lhs
 << "?";

159 ià(
rhs
.
sh¬d
 =ğ
sh¬d_id_t
::
NO_SHARD
)

160  
lhs
 << 
rhs
.
g‘_osd
();

161  
lhs
 << 
rhs
.
g‘_osd
(è<< '(' << ()Ôhs.
sh¬d
) << ')';

165 
osd_»qid_t
::
	$dump
(
FÜm©‹r
 *
f
) const

167 
f
->
	`dump_¡»am
("Çme"è<< 
Çme
;

168 
f
->
	`dump_št
("šc", 
šc
);

169 
f
->
	`dump_unsigÃd
("tid", 
tid
);

170 
	}
}

172 
osd_»qid_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<osd_»qid_t*>& 
o
)

174 
o
.
push_back
(
Ãw
 
osd_»qid_t
);

175 
o
.
push_back
(
Ãw
 
osd_»qid_t
(
’t™y_Çme_t
::
CLIENT
(123), 1, 45678));

180 
objeù_loÿtÜ_t
::
	$’code
(
bufã¾i¡
& 
bl
) const

183 
	`as£¹
(
hash
 =ğ-1 || 
key
.
	`em±y
());

184 
__u8
 
’code_com·t
 = 3;

185 
	`ENCODE_START
(6, 
’code_com·t
, 
bl
);

186 
	`’code
(
poŞ
, 
bl
);

187 
št32_t
 
´eã¼ed
 = -1;

188 
	`’code
(
´eã¼ed
, 
bl
);

189 
	`’code
(
key
, 
bl
);

190 
	`’code
(
n¥aû
, 
bl
);

191 
	`’code
(
hash
, 
bl
);

192 ià(
hash
 != -1)

193 
’code_com·t
 = 
¡d
::
max
<¡d::
ušt8_t
>(encode_compat, 6);

194 
	`ENCODE_FINISH_NEW_COMPAT
(
bl
, 
’code_com·t
);

195 
	}
}

197 
objeù_loÿtÜ_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
p
)

199 
	`DECODE_START_LEGACY_COMPAT_LEN
(6, 3, 3, 
p
);

200 ià(
¡ruù_v
 < 2) {

201 
št32_t
 
İ
;

202 
	`decode
(
İ
, 
p
);

203 
poŞ
 = 
İ
;

204 
št16_t
 
´ef
;

205 
	`decode
(
´ef
, 
p
);

207 
	`decode
(
poŞ
, 
p
);

208 
št32_t
 
´eã¼ed
;

209 
	`decode
(
´eã¼ed
, 
p
);

211 
	`decode
(
key
, 
p
);

212 ià(
¡ruù_v
 >= 5)

213 
	`decode
(
n¥aû
, 
p
);

214 ià(
¡ruù_v
 >= 6)

215 
	`decode
(
hash
, 
p
);

217 
hash
 = -1;

218 
	`DECODE_FINISH
(
p
);

220 
	`as£¹
(
hash
 =ğ-1 || 
key
.
	`em±y
());

221 
	}
}

223 
objeù_loÿtÜ_t
::
	$dump
(
FÜm©‹r
 *
f
) const

225 
f
->
	`dump_št
("poŞ", 
poŞ
);

226 
f
->
	`dump_¡ršg
("key", 
key
);

227 
f
->
	`dump_¡ršg
("Çme¥aû", 
n¥aû
);

228 
f
->
	`dump_št
("hash", 
hash
);

229 
	}
}

231 
objeù_loÿtÜ_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<objeù_loÿtÜ_t*>& 
o
)

233 
o
.
push_back
(
Ãw
 
objeù_loÿtÜ_t
);

234 
o
.
push_back
(
Ãw
 
objeù_loÿtÜ_t
(123));

235 
o
.
push_back
(
Ãw
 
objeù_loÿtÜ_t
(123, 876));

236 
o
.
push_back
(
Ãw
 
objeù_loÿtÜ_t
(1, "n2"));

237 
o
.
push_back
(
Ãw
 
objeù_loÿtÜ_t
(1234, "", "key"));

238 
o
.
push_back
(
Ãw
 
objeù_loÿtÜ_t
(12, "n1", "key2"));

242 
»que¡_»dœeù_t
::
	$’code
(
bufã¾i¡
& 
bl
) const

244 
	`ENCODE_START
(1, 1, 
bl
);

245 
	`’code
(
»dœeù_loÿtÜ
, 
bl
);

246 
	`’code
(
»dœeù_objeù
, 
bl
);

247 
	`’code
(
osd_š¡ruùiÚs
, 
bl
);

248 
	`ENCODE_FINISH
(
bl
);

249 
	}
}

251 
»que¡_»dœeù_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
)

253 
	`DECODE_START
(1, 
bl
);

254 
	`decode
(
»dœeù_loÿtÜ
, 
bl
);

255 
	`decode
(
»dœeù_objeù
, 
bl
);

256 
	`decode
(
osd_š¡ruùiÚs
, 
bl
);

257 
	`DECODE_FINISH
(
bl
);

258 
	}
}

260 
»que¡_»dœeù_t
::
	$dump
(
FÜm©‹r
 *
f
) const

262 
f
->
	`dump_¡ršg
("objeù", 
»dœeù_objeù
);

263 
f
->
	`İ’_objeù_£ùiÚ
("locator");

264 
»dœeù_loÿtÜ
.
	`dump
(
f
);

265 
f
->
	`şo£_£ùiÚ
();

266 
	}
}

268 
»que¡_»dœeù_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<»que¡_»dœeù_t*>& 
o
)

270 
objeù_loÿtÜ_t
 
loc
(1, "redir_obj");

271 
o
.
push_back
(
Ãw
 
»que¡_»dœeù_t
());

272 
o
.
push_back
(
Ãw
 
»que¡_»dœeù_t
(
loc
, 0));

273 
o
.
push_back
(
Ãw
 
»que¡_»dœeù_t
(
loc
, "redir_obj"));

274 
o
.
push_back
(
Ãw
 
»que¡_»dœeù_t
(
loc
));

277 
objeù¡Üe_³rf_¡©_t
::
	$dump
(
FÜm©‹r
 *
f
) const

280 
f
->
	`dump_æßt
("comm™_Ï‹ncy_ms", 
os_comm™_Ï‹ncy_ns
 / 1000000.0);

281 
f
->
	`dump_æßt
("­¶y_Ï‹ncy_ms", 
os_­¶y_Ï‹ncy_ns
 / 1000000.0);

282 
f
->
	`dump_unsigÃd
("comm™_Ï‹ncy_ns", 
os_comm™_Ï‹ncy_ns
);

283 
f
->
	`dump_unsigÃd
("­¶y_Ï‹ncy_ns", 
os_­¶y_Ï‹ncy_ns
);

284 
	}
}

286 
objeù¡Üe_³rf_¡©_t
::
	$’code
(
bufã¾i¡
 &
bl
, 
ušt64_t
 
ã©u»s
) const

288 
ušt8_t
 
rg‘_v
 = 2;

289 ià(!
	`HAVE_FEATURE
(
ã©u»s
, 
OS_PERF_STAT_NS
)) {

290 
rg‘_v
 = 1;

292 
	`ENCODE_START
(
rg‘_v
,¬g‘_v, 
bl
);

293 ià(
rg‘_v
 >= 2) {

294 
	`’code
(
os_comm™_Ï‹ncy_ns
, 
bl
);

295 
	`’code
(
os_­¶y_Ï‹ncy_ns
, 
bl
);

297 
cÚ¡ex´
‡utØ
NS_PER_MS
 = 
¡d
::
chrÚo
::
	`Çno£cÚds
(1
ms
).
	`couÁ
();

298 
ušt32_t
 
comm™_Ï‹ncy_ms
 = 
os_comm™_Ï‹ncy_ns
 / 
NS_PER_MS
;

299 
ušt32_t
 
­¶y_Ï‹ncy_ms
 = 
os_­¶y_Ï‹ncy_ns
 / 
NS_PER_MS
;

300 
	`’code
(
comm™_Ï‹ncy_ms
, 
bl
);

301 
	`’code
(
­¶y_Ï‹ncy_ms
, 
bl
);

303 
	`ENCODE_FINISH
(
bl
);

304 
	}
}

306 
objeù¡Üe_³rf_¡©_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

308 
	`DECODE_START
(2, 
bl
);

309 ià(
¡ruù_v
 >= 2) {

310 
	`decode
(
os_comm™_Ï‹ncy_ns
, 
bl
);

311 
	`decode
(
os_­¶y_Ï‹ncy_ns
, 
bl
);

313 
ušt32_t
 
comm™_Ï‹ncy_ms
;

314 
ušt32_t
 
­¶y_Ï‹ncy_ms
;

315 
	`decode
(
comm™_Ï‹ncy_ms
, 
bl
);

316 
	`decode
(
­¶y_Ï‹ncy_ms
, 
bl
);

317 
cÚ¡ex´
‡utØ
NS_PER_MS
 = 
¡d
::
chrÚo
::
	`Çno£cÚds
(1
ms
).
	`couÁ
();

318 
os_comm™_Ï‹ncy_ns
 = 
comm™_Ï‹ncy_ms
 * 
NS_PER_MS
;

319 
os_­¶y_Ï‹ncy_ns
 = 
­¶y_Ï‹ncy_ms
 * 
NS_PER_MS
;

321 
	`DECODE_FINISH
(
bl
);

322 
	}
}

324 
objeù¡Üe_³rf_¡©_t
::
g’”©e_‹¡_š¡ªûs
(
¡d
::
li¡
<objeù¡Üe_³rf_¡©_t*>& 
o
)

326 
o
.
push_back
(
Ãw
 
objeù¡Üe_³rf_¡©_t
());

327 
o
.
push_back
(
Ãw
 
objeù¡Üe_³rf_¡©_t
());

328 
o
.
back
()->
os_comm™_Ï‹ncy_ns
 = 20000000;

329 
o
.
back
()->
os_­¶y_Ï‹ncy_ns
 = 30000000;

333 
osd_¡©_t
::
	$dump
(
FÜm©‹r
 *
f
) const

335 
f
->
	`dump_unsigÃd
("up_äom", 
up_äom
);

336 
f
->
	`dump_unsigÃd
("£q", 
£q
);

337 
f
->
	`dump_unsigÃd
("num_pgs", 
num_pgs
);

338 
f
->
	`dump_unsigÃd
("kb", 
kb
);

339 
f
->
	`dump_unsigÃd
("kb_u£d", 
kb_u£d
);

340 
f
->
	`dump_unsigÃd
("kb_ava", 
kb_ava
);

341 
f
->
	`İ’_¬¿y_£ùiÚ
("hb_peers");

342 autØ
p
 : 
hb_³”s
)

343 
f
->
	`dump_št
("osd", 
p
);

344 
f
->
	`şo£_£ùiÚ
();

345 
f
->
	`dump_št
("¢­_Œim_queue_Ën", 
¢­_Œim_queue_Ën
);

346 
f
->
	`dump_št
("num_¢­_Œimmšg", 
num_¢­_Œimmšg
);

347 
f
->
	`İ’_objeù_£ùiÚ
("op_queue_age_hist");

348 
İ_queue_age_hi¡
.
	`dump
(
f
);

349 
f
->
	`şo£_£ùiÚ
();

350 
f
->
	`İ’_objeù_£ùiÚ
("perf_stat");

351 
os_³rf_¡©
.
	`dump
(
f
);

352 
f
->
	`şo£_£ùiÚ
();

353 
	}
}

355 
osd_¡©_t
::
	$’code
(
bufã¾i¡
 &
bl
, 
ušt64_t
 
ã©u»s
) const

357 
	`ENCODE_START
(7, 2, 
bl
);

358 
	`’code
(
kb
, 
bl
);

359 
	`’code
(
kb_u£d
, 
bl
);

360 
	`’code
(
kb_ava
, 
bl
);

361 
	`’code
(
¢­_Œim_queue_Ën
, 
bl
);

362 
	`’code
(
num_¢­_Œimmšg
, 
bl
);

363 
	`’code
(
hb_³”s
, 
bl
);

364 
	`’code
((
ušt32_t
)0, 
bl
);

365 
	`’code
(
İ_queue_age_hi¡
, 
bl
);

366 
	`’code
(
os_³rf_¡©
, 
bl
, 
ã©u»s
);

367 
	`’code
(
up_äom
, 
bl
);

368 
	`’code
(
£q
, 
bl
);

369 
	`’code
(
num_pgs
, 
bl
);

370 
	`ENCODE_FINISH
(
bl
);

371 
	}
}

373 
osd_¡©_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

375 
	`DECODE_START_LEGACY_COMPAT_LEN
(6, 2, 2, 
bl
);

376 
	`decode
(
kb
, 
bl
);

377 
	`decode
(
kb_u£d
, 
bl
);

378 
	`decode
(
kb_ava
, 
bl
);

379 
	`decode
(
¢­_Œim_queue_Ën
, 
bl
);

380 
	`decode
(
num_¢­_Œimmšg
, 
bl
);

381 
	`decode
(
hb_³”s
, 
bl
);

382 
veùÜ
<> 
num_hb_out
;

383 
	`decode
(
num_hb_out
, 
bl
);

384 ià(
¡ruù_v
 >= 3)

385 
	`decode
(
İ_queue_age_hi¡
, 
bl
);

386 ià(
¡ruù_v
 >= 4)

387 
	`decode
(
os_³rf_¡©
, 
bl
);

388 ià(
¡ruù_v
 >= 6) {

389 
	`decode
(
up_äom
, 
bl
);

390 
	`decode
(
£q
, 
bl
);

392 ià(
¡ruù_v
 >= 7) {

393 
	`decode
(
num_pgs
, 
bl
);

395 
	`DECODE_FINISH
(
bl
);

396 
	}
}

398 
osd_¡©_t
::
g’”©e_‹¡_š¡ªûs
(
¡d
::
li¡
<osd_¡©_t*>& 
o
)

400 
o
.
push_back
(
Ãw
 
osd_¡©_t
);

402 
o
.
push_back
(
Ãw
 
osd_¡©_t
);

403 
o
.
back
()->
kb
 = 1;

404 
o
.
back
()->
kb_u£d
 = 2;

405 
o
.
back
()->
kb_ava
 = 3;

406 
o
.
back
()->
hb_³”s
.
push_back
(7);

407 
o
.
back
()->
¢­_Œim_queue_Ën
 = 8;

408 
o
.
back
()->
num_¢­_Œimmšg
 = 99;

413 
pg_t
::
	$´št
(*
o
, 
maxËn
) const

415  
	`¢´štf
(
o
, 
maxËn
, "%Îu.%x", ()
	`poŞ
(), 
	`ps
());

416 
	}
}

418 
boŞ
 
pg_t
::
	$·r£
(cÚ¡ *
s
)

420 
ušt64_t
 
µoŞ
;

421 
ušt32_t
 
p£ed
;

422 
r
 = 
	`ssÿnf
(
s
, "%Îu.%x", (*)&
µoŞ
, &
p£ed
);

423 ià(
r
 < 2)

424  
çl£
;

425 
m_poŞ
 = 
µoŞ
;

426 
m_£ed
 = 
p£ed
;

427  
Œue
;

428 
	}
}

430 
boŞ
 
¥g_t
::
	$·r£
(cÚ¡ *
s
)

432 
sh¬d
 = 
sh¬d_id_t
::
NO_SHARD
;

433 
ušt64_t
 
µoŞ
;

434 
ušt32_t
 
p£ed
;

435 
ušt32_t
 
psh¬d
;

436 
r
 = 
	`ssÿnf
(
s
, "%Îu.%x", (*)&
µoŞ
, &
p£ed
);

437 ià(
r
 < 2)

438  
çl£
;

439 
pgid
.
	`£t_poŞ
(
µoŞ
);

440 
pgid
.
	`£t_ps
(
p£ed
);

442 cÚ¡ *
p
 = 
	`¡rchr
(
s
, 's');

443 ià(
p
) {

444 
r
 = 
	`ssÿnf
(
p
, "s%u", &
psh¬d
);

445 ià(
r
 == 1) {

446 
sh¬d
 = 
	`sh¬d_id_t
(
psh¬d
);

448  
çl£
;

451  
Œue
;

452 
	}
}

454 *
¥g_t
::
	$ÿlc_Çme
(*
buf
, cÚ¡ *
suffix_backwÜds
) const

456 *
suffix_backwÜds
)

457 *--
buf
 = *
suffix_backwÜds
++;

459 ià(!
	`is_no_sh¬d
()) {

460 
buf
 = 
r™ß
<
ušt8_t
, 10>((ušt8_t)
sh¬d
.
id
, buf);

461 *--
buf
 = 's';

464  
pgid
.
	`ÿlc_Çme
(
buf
, "");

465 
	}
}

467 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
¥g_t
 &
pg
)

469 
buf
[
¥g_t
::
ÿlc_Çme_buf_size
];

470 
buf
[
¥g_t
::
ÿlc_Çme_buf_size
 - 1] = '\0';

471 
out
 << 
pg
.
ÿlc_Çme
(
buf
 + 
¥g_t
::
ÿlc_Çme_buf_size
 - 1, "");

472  
out
;

475 
pg_t
…g_t::
	$g‘_ªû¡Ü
(
Şd_pg_num
) const

477 
Şd_b™s
 = 
	`cb™s
(
Şd_pg_num
);

478 
Şd_mask
 = (1 << 
Şd_b™s
) - 1;

479 
pg_t
 
»t
 = *
this
;

480 
»t
.
m_£ed
 = 
	`ûph_¡abË_mod
(m_£ed, 
Şd_pg_num
, 
Şd_mask
);

481  
»t
;

482 
	}
}

484 
boŞ
 
pg_t
::
is_¥l™
(
Şd_pg_num
, 
Ãw_pg_num
, 
£t
<pg_t> *
chd»n
) const

486 
as£¹
(
m_£ed
 < 
Şd_pg_num
);

487 ià(
Ãw_pg_num
 <ğ
Şd_pg_num
)

488  
çl£
;

490 
boŞ
 
¥l™
 = 
çl£
;

491 ià(
Œue
) {

492 
Şd_b™s
 = 
cb™s
(
Şd_pg_num
);

493 
Şd_mask
 = (1 << 
Şd_b™s
) - 1;

494 
n
 = 1; ;‚++) {

495 
Ãxt_b™
 = (
n
 << (
Şd_b™s
-1));

496 
s
 = 
Ãxt_b™
 | 
m_£ed
;

498 ià(
s
 < 
Şd_pg_num
 || s =ğ
m_£ed
)

500 ià(
s
 >ğ
Ãw_pg_num
)

502 ià(()
ûph_¡abË_mod
(
s
, 
Şd_pg_num
, 
Şd_mask
è=ğ
m_£ed
) {

503 
¥l™
 = 
Œue
;

504 ià(
chd»n
)

505 
chd»n
->
š£¹
(
pg_t
(
s
, 
m_poŞ
));

509 ià(
çl£
) {

511 
Şd_b™s
 = 
cb™s
(
Şd_pg_num
);

512 
Şd_mask
 = (1 << 
Şd_b™s
) - 1;

513 
x
 = 
Şd_pg_num
; x < 
Ãw_pg_num
; ++x) {

514 
o
 = 
ûph_¡abË_mod
(
x
, 
Şd_pg_num
, 
Şd_mask
);

515 ià(
o
 =ğ
m_£ed
) {

516 
¥l™
 = 
Œue
;

517 
chd»n
->
š£¹
(
pg_t
(
x
, 
m_poŞ
));

521  
¥l™
;

524 
pg_t
::
	$g‘_¥l™_b™s
(
pg_num
) const {

525 ià(
pg_num
 == 1)

527 
	`as£¹
(
pg_num
 > 1);

530 
p
 = 
	`cb™s
(
pg_num
);

531 
	`as£¹
(
p
);

533 ià((
m_£ed
 % (1<<(
p
-1))è< (
pg_num
 % (1<<(p-1))))

534  
p
;

536  
p
 - 1;

537 
	}
}

539 
pg_t
…g_t::
	$g‘_·»Á
() const

541 
b™s
 = 
	`cb™s
(
m_£ed
);

542 
	`as£¹
(
b™s
);

543 
pg_t
 
»tv®
 = *
this
;

544 
»tv®
.
m_£ed
 &ğ~((~0)<<(
b™s
 - 1));

545  
»tv®
;

546 
	}
}

548 
hobjeù_t
 
pg_t
::
	$g‘_hobj_¡¬t
() const

550  
	`hobjeù_t
(
	`objeù_t
(), 
	`¡ršg
(), 0, 
m_£ed
, 
m_poŞ
,

551 
	`¡ršg
());

552 
	}
}

554 
hobjeù_t
 
pg_t
::
	$g‘_hobj_’d
(
pg_num
) const

559 
b™s
 = 
	`g‘_¥l™_b™s
(
pg_num
);

560 
ušt64_t
 
»v_¡¬t
 = 
hobjeù_t
::
	`_»v”£_b™s
(
m_£ed
);

561 
ušt64_t
 
»v_’d
 = (
»v_¡¬t
 | (0xfffffffà>> 
b™s
)) + 1;

562 ià(
»v_’d
 >= 0x100000000) {

563 
	`as£¹
(
»v_’d
 == 0x100000000);

564  
hobjeù_t
::
	`g‘_max
();

566  
	`hobjeù_t
(
	`objeù_t
(), 
	`¡ršg
(), 
CEPH_NOSNAP
,

567 
hobjeù_t
::
	`_»v”£_b™s
(
»v_’d
), 
m_poŞ
,

568 
	`¡ršg
());

570 
	}
}

572 
pg_t
::
	$dump
(
FÜm©‹r
 *
f
) const

574 
f
->
	`dump_unsigÃd
("poŞ", 
m_poŞ
);

575 
f
->
	`dump_unsigÃd
("£ed", 
m_£ed
);

576 
	}
}

578 
pg_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<pg_t*>& 
o
)

580 
o
.
push_back
(
Ãw
 
pg_t
);

581 
o
.
push_back
(
Ãw
 
pg_t
(1, 2));

582 
o
.
push_back
(
Ãw
 
pg_t
(13123, 3));

583 
o
.
push_back
(
Ãw
 
pg_t
(131223, 4));

586 *
pg_t
::
	$ÿlc_Çme
(*
buf
, cÚ¡ *
suffix_backwÜds
) const

588 *
suffix_backwÜds
)

589 *--
buf
 = *
suffix_backwÜds
++;

591 
buf
 = 
r™ß
<
ušt32_t
, 16>(
m_£ed
, buf);

593 *--
buf
 = '.';

595  
r™ß
<
ušt64_t
, 10>(
m_poŞ
, 
buf
);

596 
	}
}

598 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
pg_t
 &
pg
)

600 
buf
[
pg_t
::
ÿlc_Çme_buf_size
];

601 
buf
[
pg_t
::
ÿlc_Çme_buf_size
 - 1] = '\0';

602 
out
 << 
pg
.
ÿlc_Çme
(
buf
 + 
pg_t
::
ÿlc_Çme_buf_size
 - 1, "");

603  
out
;

609 
cŞl_t
::
	$ÿlc_¡r
()

611 
ty³
) {

612 
TYPE_META
:

613 
	`¡rıy
(
_¡r_buff
, "meta");

614 
_¡r
 = 
_¡r_buff
;

616 
TYPE_PG
:

617 
_¡r_buff
[
¥g_t
::
ÿlc_Çme_buf_size
 - 1] = '\0';

618 
_¡r
 = 
pgid
.
	`ÿlc_Çme
(
_¡r_buff
 + 
¥g_t
::
ÿlc_Çme_buf_size
 - 1, "daeh_");

620 
TYPE_PG_TEMP
:

621 
_¡r_buff
[
¥g_t
::
ÿlc_Çme_buf_size
 - 1] = '\0';

622 
_¡r
 = 
pgid
.
	`ÿlc_Çme
(
_¡r_buff
 + 
¥g_t
::
ÿlc_Çme_buf_size
 - 1, "PMET_");

625 
	`as£¹
(0 == "unknown collectionype");

627 
	}
}

629 
boŞ
 
cŞl_t
::
	$·r£
(cÚ¡ 
¡d
::
¡ršg
& 
s
)

631 ià(
s
 == "meta") {

632 
ty³
 = 
TYPE_META
;

633 
pgid
 = 
	`¥g_t
();

634 
»mov®_£q
 = 0;

635 
	`ÿlc_¡r
();

636 
	`as£¹
(
s
 =ğ
_¡r
);

637  
Œue
;

639 ià(
s
.
	`fšd
("_h—d"è=ğs.
	`Ëngth
() - 5 &&

640 
pgid
.
	`·r£
(
s
.
	`sub¡r
(0, s.
	`Ëngth
() - 5))) {

641 
ty³
 = 
TYPE_PG
;

642 
»mov®_£q
 = 0;

643 
	`ÿlc_¡r
();

644 
	`as£¹
(
s
 =ğ
_¡r
);

645  
Œue
;

647 ià(
s
.
	`fšd
("_TEMP"è=ğs.
	`Ëngth
() - 5 &&

648 
pgid
.
	`·r£
(
s
.
	`sub¡r
(0, s.
	`Ëngth
() - 5))) {

649 
ty³
 = 
TYPE_PG_TEMP
;

650 
»mov®_£q
 = 0;

651 
	`ÿlc_¡r
();

652 
	`as£¹
(
s
 =ğ
_¡r
);

653  
Œue
;

655  
çl£
;

656 
	}
}

658 
cŞl_t
::
	$’code
(
bufã¾i¡
& 
bl
) const

660 
usšg
 
ûph
::
’code
;

662 ià(
	`is_‹mp
()) {

664 
__u8
 
¡ruù_v
 = 3;

665 
	`’code
(
¡ruù_v
, 
bl
);

666 
	`’code
(
	`to_¡r
(), 
bl
);

668 
__u8
 
¡ruù_v
 = 2;

669 
	`’code
(
¡ruù_v
, 
bl
);

670 
	`’code
((
__u8
)
ty³
, 
bl
);

671 
	`’code
(
pgid
, 
bl
);

672 
¢­id_t
 
¢­
 = 
CEPH_NOSNAP
;

673 
	`’code
(
¢­
, 
bl
);

675 
	}
}

677 
size_t
 
cŞl_t
::
	$’coded_size
() const

679 
size_t
 
r
 = (
__u8
);

680 ià(
	`is_‹mp
()) {

682 
r
 +ğ(
__u32
);

683 ià(
_¡r
) {

684 
r
 +ğ
	`¡¾’
(
_¡r
);

689 
r
 +ğ(
__u8
);

692 
r
 +ğ(
ûph_Ë32
è+ 2 * (
__u8
);

694 
r
 +ğ(
__u8
è+ (
ušt64_t
è+ 2 * (
ušt32_t
);

696 
r
 +ğ(
št8_t
);

698 
r
 +ğ(
ušt64_t
);

701  
r
;

702 
	}
}

704 
cŞl_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
)

706 
usšg
 
ûph
::
decode
;

707 
__u8
 
¡ruù_v
;

708 
	`decode
(
¡ruù_v
, 
bl
);

709 
¡ruù_v
) {

712 
¢­id_t
 
¢­
;

713 
	`decode
(
pgid
, 
bl
);

714 
	`decode
(
¢­
, 
bl
);

717 ià(
pgid
 =ğ
	`¥g_t
(è&& 
¢­
 == 0) {

718 
ty³
 = 
TYPE_META
;

720 
ty³
 = 
TYPE_PG
;

722 
»mov®_£q
 = 0;

728 
__u8
 
_ty³
;

729 
¢­id_t
 
¢­
;

730 
	`decode
(
_ty³
, 
bl
);

731 
	`decode
(
pgid
, 
bl
);

732 
	`decode
(
¢­
, 
bl
);

733 
ty³
 = (
ty³_t
)
_ty³
;

734 
»mov®_£q
 = 0;

740 
¡ršg
 
¡r
;

741 
	`decode
(
¡r
, 
bl
);

742 
boŞ
 
ok
 = 
	`·r£
(
¡r
);

743 ià(!
ok
)

744 
throw
 
¡d
::
	`domaš_”rÜ
(¡d::
	`¡ršg
("uÇbËØ·r£…g "è+ 
¡r
);

750 
o¡ršg¡»am
 
oss
;

751 
oss
 << "coll_t::decode(): don't know howo decode version "

752 << 
¡ruù_v
;

753 
throw
 
¡d
::
	`domaš_”rÜ
(
oss
.
	`¡r
());

756 
	}
}

758 
cŞl_t
::
	$dump
(
FÜm©‹r
 *
f
) const

760 
f
->
	`dump_unsigÃd
("ty³_id", ()
ty³
);

761 ià(
ty³
 !ğ
TYPE_META
)

762 
f
->
	`dump_¡»am
("pgid"è<< 
pgid
;

763 
f
->
	`dump_¡ršg
("Çme", 
	`to_¡r
());

764 
	}
}

766 
cŞl_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<cŞl_t*>& 
o
)

768 
o
.
push_back
(
Ãw
 
cŞl_t
());

769 
o
.
push_back
(
Ãw
 
cŞl_t
(
¥g_t
(
pg_t
(1, 0), 
sh¬d_id_t
::
NO_SHARD
)));

770 
o
.
push_back
(
Ãw
 
cŞl_t
(o.
back
()->
g‘_‹mp
()));

771 
o
.
push_back
(
Ãw
 
cŞl_t
(
¥g_t
(
pg_t
(3, 2), 
sh¬d_id_t
(12))));

772 
o
.
push_back
(
Ãw
 
cŞl_t
(o.
back
()->
g‘_‹mp
()));

773 
o
.
push_back
(
Ãw
 
cŞl_t
());

778 
¡d
::
¡ršg
 
pg_veùÜ_¡ršg
(cÚ¡ 
veùÜ
<
št32_t
> &
a
)

780 
o¡ršg¡»am
 
oss
;

781 
oss
 << "[";

782 
veùÜ
<
št32_t
>::
cÚ¡_™”©Ü
 
i
 = 
a
.
begš
(); i !ğa.
’d
(); ++i) {

783 ià(
i
 !ğ
a
.
begš
())

784 
oss
 << ",";

785 ià(*
i
 !ğ
CRUSH_ITEM_NONE
)

786 
oss
 << *
i
;

788 
oss
 << "NONE";

790 
oss
 << "]";

791  
oss
.
¡r
();

794 
¡d
::
¡ršg
 
	$pg_¡©e_¡ršg
(
ušt64_t
 
¡©e
)

796 
o¡ršg¡»am
 
oss
;

797 ià(
¡©e
 & 
PG_STATE_STALE
)

798 
oss
 << "stale+";

799 ià(
¡©e
 & 
PG_STATE_CREATING
)

800 
oss
 << "creating+";

801 ià(
¡©e
 & 
PG_STATE_ACTIVE
)

802 
oss
 << "active+";

803 ià(
¡©e
 & 
PG_STATE_ACTIVATING
)

804 
oss
 << "activating+";

805 ià(
¡©e
 & 
PG_STATE_CLEAN
)

806 
oss
 << "clean+";

807 ià(
¡©e
 & 
PG_STATE_RECOVERY_WAIT
)

808 
oss
 << "recovery_wait+";

809 ià(
¡©e
 & 
PG_STATE_RECOVERY_TOOFULL
)

810 
oss
 << "recovery_toofull+";

811 ià(
¡©e
 & 
PG_STATE_RECOVERING
)

812 
oss
 << "recovering+";

813 ià(
¡©e
 & 
PG_STATE_FORCED_RECOVERY
)

814 
oss
 << "forced_recovery+";

815 ià(
¡©e
 & 
PG_STATE_DOWN
)

816 
oss
 << "down+";

817 ià(
¡©e
 & 
PG_STATE_RECOVERY_UNFOUND
)

818 
oss
 << "recovery_unfound+";

819 ià(
¡©e
 & 
PG_STATE_BACKFILL_UNFOUND
)

820 
oss
 << "backfill_unfound+";

821 ià(
¡©e
 & 
PG_STATE_UNDERSIZED
)

822 
oss
 << "undersized+";

823 ià(
¡©e
 & 
PG_STATE_DEGRADED
)

824 
oss
 << "degraded+";

825 ià(
¡©e
 & 
PG_STATE_REMAPPED
)

826 
oss
 << "remapped+";

827 ià(
¡©e
 & 
PG_STATE_SCRUBBING
)

828 
oss
 << "scrubbing+";

829 ià(
¡©e
 & 
PG_STATE_DEEP_SCRUB
)

830 
oss
 << "deep+";

831 ià(
¡©e
 & 
PG_STATE_INCONSISTENT
)

832 
oss
 << "inconsistent+";

833 ià(
¡©e
 & 
PG_STATE_PEERING
)

834 
oss
 << "peering+";

835 ià(
¡©e
 & 
PG_STATE_REPAIR
)

836 
oss
 << "repair+";

837 ià(
¡©e
 & 
PG_STATE_BACKFILL_WAIT
)

838 
oss
 << "backfill_wait+";

839 ià(
¡©e
 & 
PG_STATE_BACKFILLING
)

840 
oss
 << "backfilling+";

841 ià(
¡©e
 & 
PG_STATE_FORCED_BACKFILL
)

842 
oss
 << "forced_backfill+";

843 ià(
¡©e
 & 
PG_STATE_BACKFILL_TOOFULL
)

844 
oss
 << "backfill_toofull+";

845 ià(
¡©e
 & 
PG_STATE_INCOMPLETE
)

846 
oss
 << "incomplete+";

847 ià(
¡©e
 & 
PG_STATE_PEERED
)

848 
oss
 << "peered+";

849 ià(
¡©e
 & 
PG_STATE_SNAPTRIM
)

850 
oss
 << "snaptrim+";

851 ià(
¡©e
 & 
PG_STATE_SNAPTRIM_WAIT
)

852 
oss
 << "snaptrim_wait+";

853 ià(
¡©e
 & 
PG_STATE_SNAPTRIM_ERROR
)

854 
oss
 << "snaptrim_error+";

855 
¡ršg
 
	`»t
(
oss
.
	`¡r
());

856 ià(
»t
.
	`Ëngth
() > 0)

857 
»t
.
	`»size
Ô‘.
	`Ëngth
() - 1);

859 
»t
 = "unknown";

860  
»t
;

861 
	}
}

863 
boo¡
::
İtiÚ®
<
ušt64_t
> 
	$pg_¡ršg_¡©e
(cÚ¡ 
¡d
::
¡ršg
& 
¡©e
)

865 
boo¡
::
İtiÚ®
<
ušt64_t
> 
ty³
;

866 ià(
¡©e
 == "active")

867 
ty³
 = 
PG_STATE_ACTIVE
;

868 ià(
¡©e
 == "clean")

869 
ty³
 = 
PG_STATE_CLEAN
;

870 ià(
¡©e
 == "down")

871 
ty³
 = 
PG_STATE_DOWN
;

872 ià(
¡©e
 == "recovery_unfound")

873 
ty³
 = 
PG_STATE_RECOVERY_UNFOUND
;

874 ià(
¡©e
 == "backfill_unfound")

875 
ty³
 = 
PG_STATE_BACKFILL_UNFOUND
;

876 ià(
¡©e
 == "scrubbing")

877 
ty³
 = 
PG_STATE_SCRUBBING
;

878 ià(
¡©e
 == "degraded")

879 
ty³
 = 
PG_STATE_DEGRADED
;

880 ià(
¡©e
 == "inconsistent")

881 
ty³
 = 
PG_STATE_INCONSISTENT
;

882 ià(
¡©e
 == "peering")

883 
ty³
 = 
PG_STATE_PEERING
;

884 ià(
¡©e
 == "repair")

885 
ty³
 = 
PG_STATE_REPAIR
;

886 ià(
¡©e
 == "recovering")

887 
ty³
 = 
PG_STATE_RECOVERING
;

888 ià(
¡©e
 == "forced_recovery")

889 
ty³
 = 
PG_STATE_FORCED_RECOVERY
;

890 ià(
¡©e
 == "backfill_wait")

891 
ty³
 = 
PG_STATE_BACKFILL_WAIT
;

892 ià(
¡©e
 == "incomplete")

893 
ty³
 = 
PG_STATE_INCOMPLETE
;

894 ià(
¡©e
 == "stale")

895 
ty³
 = 
PG_STATE_STALE
;

896 ià(
¡©e
 == "remapped")

897 
ty³
 = 
PG_STATE_REMAPPED
;

898 ià(
¡©e
 == "deep")

899 
ty³
 = 
PG_STATE_DEEP_SCRUB
;

900 ià(
¡©e
 == "backfilling")

901 
ty³
 = 
PG_STATE_BACKFILLING
;

902 ià(
¡©e
 == "forced_backfill")

903 
ty³
 = 
PG_STATE_FORCED_BACKFILL
;

904 ià(
¡©e
 == "backfill_toofull")

905 
ty³
 = 
PG_STATE_BACKFILL_TOOFULL
;

906 ià(
¡©e
 == "recovery_wait")

907 
ty³
 = 
PG_STATE_RECOVERY_WAIT
;

908 ià(
¡©e
 == "recovery_toofull")

909 
ty³
 = 
PG_STATE_RECOVERY_TOOFULL
;

910 ià(
¡©e
 == "undersized")

911 
ty³
 = 
PG_STATE_UNDERSIZED
;

912 ià(
¡©e
 == "activating")

913 
ty³
 = 
PG_STATE_ACTIVATING
;

914 ià(
¡©e
 == "peered")

915 
ty³
 = 
PG_STATE_PEERED
;

916 ià(
¡©e
 == "snaptrim")

917 
ty³
 = 
PG_STATE_SNAPTRIM
;

918 ià(
¡©e
 == "snaptrim_wait")

919 
ty³
 = 
PG_STATE_SNAPTRIM_WAIT
;

920 ià(
¡©e
 == "snaptrim_error")

921 
ty³
 = 
PG_STATE_SNAPTRIM_ERROR
;

923 
ty³
 = 
boo¡
::
nÚe
;

924  
ty³
;

925 
	}
}

928 
¡ršg
 
ev”siÚ_t
::
	$g‘_key_Çme
() const

930 
¡d
::
¡ršg
 
	`key
(32, ' ');

931 
	`g‘_key_Çme
(&
key
[0]);

932 
key
.
	`»size
(31);

933  
key
;

934 
	}
}

937 
poŞ_¢­_šfo_t
::
	$dump
(
FÜm©‹r
 *
f
) const

939 
f
->
	`dump_unsigÃd
("¢­id", 
¢­id
);

940 
f
->
	`dump_¡»am
("¡amp"è<< 
¡amp
;

941 
f
->
	`dump_¡ršg
("Çme", 
Çme
);

942 
	}
}

944 
poŞ_¢­_šfo_t
::
	$’code
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
) const

946 
usšg
 
ûph
::
’code
;

947 ià((
ã©u»s
 & 
CEPH_FEATURE_PGPOOL3
) == 0) {

948 
__u8
 
¡ruù_v
 = 1;

949 
	`’code
(
¡ruù_v
, 
bl
);

950 
	`’code
(
¢­id
, 
bl
);

951 
	`’code
(
¡amp
, 
bl
);

952 
	`’code
(
Çme
, 
bl
);

955 
	`ENCODE_START
(2, 2, 
bl
);

956 
	`’code
(
¢­id
, 
bl
);

957 
	`’code
(
¡amp
, 
bl
);

958 
	`’code
(
Çme
, 
bl
);

959 
	`ENCODE_FINISH
(
bl
);

960 
	}
}

962 
poŞ_¢­_šfo_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
)

964 
	`DECODE_START_LEGACY_COMPAT_LEN
(2, 2, 2, 
bl
);

965 
	`decode
(
¢­id
, 
bl
);

966 
	`decode
(
¡amp
, 
bl
);

967 
	`decode
(
Çme
, 
bl
);

968 
	`DECODE_FINISH
(
bl
);

969 
	}
}

971 
poŞ_¢­_šfo_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<poŞ_¢­_šfo_t*>& 
o
)

973 
o
.
push_back
(
Ãw
 
poŞ_¢­_šfo_t
);

974 
o
.
push_back
(
Ãw
 
poŞ_¢­_šfo_t
);

975 
o
.
back
()->
¢­id
 = 1;

976 
o
.
back
()->
¡amp
 = 
utime_t
(1, 2);

977 
o
.
back
()->
Çme
 = "foo";

982 
¡d
::
	tm­
<
	t¡d
::
	t¡ršg
, 
	tpoŞ_İts_t
::
	tİt_desc_t
> 
	tİt_m­pšg_t
;

983 
İt_m­pšg_t
 
	gİt_m­pšg
 = 
boo¡
::
assign
::
m­_li¡_of


984 ("süub_mš_š‹rv®", 
	gpoŞ_İts_t
::
İt_desc_t
(

985 
poŞ_İts_t
::
SCRUB_MIN_INTERVAL
,…oŞ_İts_t::
DOUBLE
))

986 ("süub_max_š‹rv®", 
	gpoŞ_İts_t
::
İt_desc_t
(

987 
poŞ_İts_t
::
SCRUB_MAX_INTERVAL
,…oŞ_İts_t::
DOUBLE
))

988 ("d“p_süub_š‹rv®", 
	gpoŞ_İts_t
::
İt_desc_t
(

989 
poŞ_İts_t
::
DEEP_SCRUB_INTERVAL
,…oŞ_İts_t::
DOUBLE
))

990 ("»cov”y_´iÜ™y", 
	gpoŞ_İts_t
::
İt_desc_t
(

991 
poŞ_İts_t
::
RECOVERY_PRIORITY
,…oŞ_İts_t::
INT
))

992 ("»cov”y_İ_´iÜ™y", 
	gpoŞ_İts_t
::
İt_desc_t
(

993 
poŞ_İts_t
::
RECOVERY_OP_PRIORITY
,…oŞ_İts_t::
INT
))

994 ("süub_´iÜ™y", 
	gpoŞ_İts_t
::
İt_desc_t
(

995 
poŞ_İts_t
::
SCRUB_PRIORITY
,…oŞ_İts_t::
INT
))

996 ("com´essiÚ_mode", 
	gpoŞ_İts_t
::
İt_desc_t
(

997 
poŞ_İts_t
::
COMPRESSION_MODE
,…oŞ_İts_t::
STR
))

998 ("com´essiÚ_®gÜ™hm", 
	gpoŞ_İts_t
::
İt_desc_t
(

999 
poŞ_İts_t
::
COMPRESSION_ALGORITHM
,…oŞ_İts_t::
STR
))

1000 ("com´essiÚ_»quœed_¿tio", 
	gpoŞ_İts_t
::
İt_desc_t
(

1001 
poŞ_İts_t
::
COMPRESSION_REQUIRED_RATIO
,…oŞ_İts_t::
DOUBLE
))

1002 ("com´essiÚ_max_blob_size", 
	gpoŞ_İts_t
::
İt_desc_t
(

1003 
poŞ_İts_t
::
COMPRESSION_MAX_BLOB_SIZE
,…oŞ_İts_t::
INT
))

1004 ("com´essiÚ_mš_blob_size", 
	gpoŞ_İts_t
::
İt_desc_t
(

1005 
poŞ_İts_t
::
COMPRESSION_MIN_BLOB_SIZE
,…oŞ_İts_t::
INT
))

1006 ("csum_ty³", 
	gpoŞ_İts_t
::
İt_desc_t
(

1007 
poŞ_İts_t
::
CSUM_TYPE
,…oŞ_İts_t::
INT
))

1008 ("csum_max_block", 
	gpoŞ_İts_t
::
İt_desc_t
(

1009 
poŞ_İts_t
::
CSUM_MAX_BLOCK
,…oŞ_İts_t::
INT
))

1010 ("csum_mš_block", 
	gpoŞ_İts_t
::
İt_desc_t
(

1011 
poŞ_İts_t
::
CSUM_MIN_BLOCK
,…oŞ_İts_t::
INT
));

1013 
boŞ
 
	gpoŞ_İts_t
::
	$is_İt_Çme
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
) {

1014  
İt_m­pšg
.
	`couÁ
(
Çme
);

1015 
	}
}

1017 
	gpoŞ_İts_t
::
İt_desc_t
 
poŞ_İts_t
::
	$g‘_İt_desc
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
) {

1018 
İt_m­pšg_t
::
™”©Ü
 
i
 = 
İt_m­pšg
.
	`fšd
(
Çme
);

1019 
	`as£¹
(
i
 !ğ
İt_m­pšg
.
	`’d
());

1020  
i
->
£cÚd
;

1021 
	}
}

1023 
boŞ
 
	gpoŞ_İts_t
::
	$is_£t
(
poŞ_İts_t
::
key_t
 
key
) const {

1024  
İts
.
	`couÁ
(
key
);

1025 
	}
}

1027 cÚ¡ 
	gpoŞ_İts_t
::
v®ue_t
& 
poŞ_İts_t
::
	$g‘
(
poŞ_İts_t
::
key_t
 
key
) const {

1028 
İts_t
::
cÚ¡_™”©Ü
 
i
 = 
İts
.
	`fšd
(
key
);

1029 
	`as£¹
(
i
 !ğ
İts
.
	`’d
());

1030  
i
->
£cÚd
;

1031 
	}
}

1033 
boŞ
 
	gpoŞ_İts_t
::
	$un£t
(
poŞ_İts_t
::
key_t
 
key
) {

1034  
İts
.
	`”a£
(
key
) > 0;

1035 
	}
}

1037 
şass
 
	gpoŞ_İts_dum³r_t
 : 
public
 
boo¡
::
¡©ic_vis™Ü
<>

1039 
public
:

1040 
poŞ_İts_dum³r_t
(cÚ¡ 
¡d
::
¡ršg
& 
Çme_
, 
FÜm©‹r
* 
f_
) :

1041 
Çme
(
Çme_
.
c_¡r
()), 
f
(
f_
) {}

1043 
İ”©Ü
()(
	g¡d
::
¡ršg
 
s
) const {

1044 
f
->
dump_¡ršg
(
Çme
, 
s
);

1046 
İ”©Ü
()(
	gi
) const {

1047 
	gf
->
dump_št
(
Çme
, 
i
);

1049 
İ”©Ü
()(
	gd
) const {

1050 
	gf
->
dump_æßt
(
Çme
, 
d
);

1053 
	g´iv©e
:

1054 cÚ¡ * 
Çme
;

1055 
FÜm©‹r
* 
	gf
;

1058 
	gpoŞ_İts_t
::
	$dump
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, 
FÜm©‹r
* 
f
) const

1060 cÚ¡ 
İt_desc_t
& 
desc
 = 
	`g‘_İt_desc
(
Çme
);

1061 
İts_t
::
cÚ¡_™”©Ü
 
i
 = 
İts
.
	`fšd
(
desc
.
key
);

1062 ià(
i
 =ğ
İts
.
	`’d
()) {

1065 
boo¡
::
	`­¶y_vis™Ü
(
	`poŞ_İts_dum³r_t
(
Çme
, 
f
), 
i
->
£cÚd
);

1066 
	}
}

1068 
	gpoŞ_İts_t
::
	$dump
(
FÜm©‹r
* 
f
) const

1070 
İt_m­pšg_t
::
™”©Ü
 
i
 = 
İt_m­pšg
.
	`begš
(); i !ğİt_m­pšg.
	`’d
();

1071 ++
i
) {

1072 cÚ¡ 
¡d
::
¡ršg
& 
Çme
 = 
i
->
fœ¡
;

1073 cÚ¡ 
İt_desc_t
& 
desc
 = 
i
->
£cÚd
;

1074 
İts_t
::
cÚ¡_™”©Ü
 
j
 = 
İts
.
	`fšd
(
desc
.
key
);

1075 ià(
j
 =ğ
İts
.
	`’d
()) {

1078 
boo¡
::
	`­¶y_vis™Ü
(
	`poŞ_İts_dum³r_t
(
Çme
, 
f
), 
j
->
£cÚd
);

1080 
	}
}

1082 
şass
 
	gpoŞ_İts_’cod”_t
 : 
public
 
boo¡
::
¡©ic_vis™Ü
<>

1084 
public
:

1085 
ex¶ic™
 
poŞ_İts_’cod”_t
(
bufã¾i¡
& 
bl_
è: 
bl
(bl_) {}

1087 
İ”©Ü
()(cÚ¡ 
¡d
::
¡ršg
 &
s
) const {

1088 
’code
(
¡©ic_ÿ¡
<
št32_t
>(
poŞ_İts_t
::
STR
), 
bl
);

1089 
’code
(
s
, 
bl
);

1091 
İ”©Ü
()(
	gi
) const {

1092 
’code
(
¡©ic_ÿ¡
<
št32_t
>(
poŞ_İts_t
::
INT
), 
bl
);

1093 
’code
(
i
, 
bl
);

1095 
İ”©Ü
()(
	gd
) const {

1096 
’code
(
¡©ic_ÿ¡
<
št32_t
>(
poŞ_İts_t
::
DOUBLE
), 
bl
);

1097 
’code
(
d
, 
bl
);

1100 
	g´iv©e
:

1101 
bufã¾i¡
& 
bl
;

1104 
	gpoŞ_İts_t
::
	$’code
(
bufã¾i¡
& 
bl
) const {

1105 
	`ENCODE_START
(1, 1, 
bl
);

1106 
ušt32_t
 
n
 = 
¡©ic_ÿ¡
<ušt32_t>(
İts
.
	`size
());

1107 
	`’code
(
n
, 
bl
);

1108 
İts_t
::
cÚ¡_™”©Ü
 
i
 = 
İts
.
	`begš
(); i !ğİts.
	`’d
(); ++i) {

1109 
	`’code
(
¡©ic_ÿ¡
<
št32_t
>(
i
->
fœ¡
), 
bl
);

1110 
boo¡
::
	`­¶y_vis™Ü
(
	`poŞ_İts_’cod”_t
(
bl
), 
i
->
£cÚd
);

1112 
	`ENCODE_FINISH
(
bl
);

1113 
	}
}

1115 
	gpoŞ_İts_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
) {

1116 
	`DECODE_START
(1, 
bl
);

1117 
__u32
 
n
;

1118 
	`decode
(
n
, 
bl
);

1119 
İts
.
	`ş—r
();

1120 
n
--) {

1121 
št32_t
 
k
, 
t
;

1122 
	`decode
(
k
, 
bl
);

1123 
	`decode
(
t
, 
bl
);

1124 ià(
t
 =ğ
STR
) {

1125 
¡d
::
¡ršg
 
s
;

1126 
	`decode
(
s
, 
bl
);

1127 
İts
[
¡©ic_ÿ¡
<
key_t
>(
k
)] = 
s
;

1128 } ià(
t
 =ğ
INT
) {

1129 
i
;

1130 
	`decode
(
i
, 
bl
);

1131 
İts
[
¡©ic_ÿ¡
<
key_t
>(
k
)] = 
i
;

1132 } ià(
t
 =ğ
DOUBLE
) {

1133 
d
;

1134 
	`decode
(
d
, 
bl
);

1135 
İts
[
¡©ic_ÿ¡
<
key_t
>(
k
)] = 
d
;

1137 
	`as£¹
(!"invalidype");

1140 
	`DECODE_FINISH
(
bl
);

1141 
	}
}

1143 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gpoŞ_İts_t
& 
	gİts
)

1145 
	gİt_m­pšg_t
::
™”©Ü
 
i
 = 
İt_m­pšg
.
begš
(); 
	gi
 !ğİt_m­pšg.
’d
();

1146 ++
	gi
) {

1147 cÚ¡ 
	g¡d
::
¡ršg
& 
Çme
 = 
i
->
fœ¡
;

1148 cÚ¡ 
	gpoŞ_İts_t
::
İt_desc_t
& 
desc
 = 
i
->
£cÚd
;

1149 
	gpoŞ_İts_t
::
İts_t
::
cÚ¡_™”©Ü
 
j
 = 
İts
.İts.
fšd
(
desc
.
key
);

1150 ià(
	gj
 =ğ
İts
.İts.
’d
()) {

1153 
	gout
 << " " << 
	gÇme
 << " " << 
	gj
->
	g£cÚd
;

1155  
	gout
;

1160 cÚ¡ *
	gpg_poŞ_t
::
APPLICATION_NAME_CEPHFS
("cephfs");

1161 cÚ¡ *
	gpg_poŞ_t
::
APPLICATION_NAME_RBD
("rbd");

1162 cÚ¡ *
	gpg_poŞ_t
::
APPLICATION_NAME_RGW
("rgw");

1164 
	gpg_poŞ_t
::
	$dump
(
FÜm©‹r
 *
f
) const

1166 
f
->
	`dump_¡»am
("ü—‹_time"è<< 
	`g‘_ü—‹_time
();

1167 
f
->
	`dump_unsigÃd
("æags", 
	`g‘_æags
());

1168 
f
->
	`dump_¡ršg
("æags_Çmes", 
	`g‘_æags_¡ršg
());

1169 
f
->
	`dump_št
("ty³", 
	`g‘_ty³
());

1170 
f
->
	`dump_št
("size", 
	`g‘_size
());

1171 
f
->
	`dump_št
("mš_size", 
	`g‘_mš_size
());

1172 
f
->
	`dump_št
("üush_ruË", 
	`g‘_üush_ruË
());

1173 
f
->
	`dump_št
("objeù_hash", 
	`g‘_objeù_hash
());

1174 
f
->
	`dump_unsigÃd
("pg_num", 
	`g‘_pg_num
());

1175 
f
->
	`dump_unsigÃd
("pg_¶aûm’t_num", 
	`g‘_pgp_num
());

1176 
f
->
	`dump_¡»am
("Ï¡_chªge"è<< 
	`g‘_Ï¡_chªge
();

1177 
f
->
	`dump_¡»am
("Ï¡_fÜû_İ_»£nd"è<< 
	`g‘_Ï¡_fÜû_İ_»£nd
();

1178 
f
->
	`dump_¡»am
("last_force_op_resend_preluminous")

1179 << 
	`g‘_Ï¡_fÜû_İ_»£nd_´–umšous
();

1180 
f
->
	`dump_unsigÃd
("auid", 
	`g‘_auid
());

1181 
f
->
	`dump_¡ršg
("¢­_mode", 
	`is_poŞ_¢­s_mode
() ? "pool" : "selfmanaged");

1182 
f
->
	`dump_unsigÃd
("¢­_£q", 
	`g‘_¢­_£q
());

1183 
f
->
	`dump_unsigÃd
("¢­_•och", 
	`g‘_¢­_•och
());

1184 
f
->
	`İ’_¬¿y_£ùiÚ
("pool_snaps");

1185 
m­
<
¢­id_t
, 
poŞ_¢­_šfo_t
>::
cÚ¡_™”©Ü
 
p
 = 
¢­s
.
	`begš
();… !ğ¢­s.
	`’d
(); ++p) {

1186 
f
->
	`İ’_objeù_£ùiÚ
("pool_snap_info");

1187 
p
->
£cÚd
.
	`dump
(
f
);

1188 
f
->
	`şo£_£ùiÚ
();

1190 
f
->
	`şo£_£ùiÚ
();

1191 
f
->
	`dump_¡»am
("»moved_¢­s"è<< 
»moved_¢­s
;

1192 
f
->
	`dump_unsigÃd
("quÙa_max_by‹s", 
quÙa_max_by‹s
);

1193 
f
->
	`dump_unsigÃd
("quÙa_max_objeùs", 
quÙa_max_objeùs
);

1194 
f
->
	`İ’_¬¿y_£ùiÚ
("tiers");

1195 
£t
<
ušt64_t
>::
cÚ¡_™”©Ü
 
p
 = 
t›rs
.
	`begš
();… !ğt›rs.
	`’d
(); ++p)

1196 
f
->
	`dump_unsigÃd
("poŞ_id", *
p
);

1197 
f
->
	`şo£_£ùiÚ
();

1198 
f
->
	`dump_št
("t›r_of", 
t›r_of
);

1199 
f
->
	`dump_št
("»ad_t›r", 
»ad_t›r
);

1200 
f
->
	`dump_št
("wr™e_t›r", 
wr™e_t›r
);

1201 
f
->
	`dump_¡ršg
("ÿche_mode", 
	`g‘_ÿche_mode_Çme
());

1202 
f
->
	`dump_unsigÃd
("rg‘_max_by‹s", 
rg‘_max_by‹s
);

1203 
f
->
	`dump_unsigÃd
("rg‘_max_objeùs", 
rg‘_max_objeùs
);

1204 
f
->
	`dump_unsigÃd
("cache_target_dirty_ratio_micro",

1205 
ÿche_rg‘_dœty_¿tio_miüo
);

1206 
f
->
	`dump_unsigÃd
("cache_target_dirty_high_ratio_micro",

1207 
ÿche_rg‘_dœty_high_¿tio_miüo
);

1208 
f
->
	`dump_unsigÃd
("cache_target_full_ratio_micro",

1209 
ÿche_rg‘_fuÎ_¿tio_miüo
);

1210 
f
->
	`dump_unsigÃd
("ÿche_mš_æush_age", 
ÿche_mš_æush_age
);

1211 
f
->
	`dump_unsigÃd
("ÿche_mš_eviù_age", 
ÿche_mš_eviù_age
);

1212 
f
->
	`dump_¡ršg
("”asu»_code_´ofe", 
”asu»_code_´ofe
);

1213 
f
->
	`İ’_objeù_£ùiÚ
("hit_set_params");

1214 
h™_£t_·¿ms
.
	`dump
(
f
);

1215 
f
->
	`şo£_£ùiÚ
();

1216 
f
->
	`dump_unsigÃd
("h™_£t_³riod", 
h™_£t_³riod
);

1217 
f
->
	`dump_unsigÃd
("h™_£t_couÁ", 
h™_£t_couÁ
);

1218 
f
->
	`dump_boŞ
("u£_gmt_h™£t", 
u£_gmt_h™£t
);

1219 
f
->
	`dump_unsigÃd
("mš_»ad_»ûncy_fÜ_´omÙe", 
mš_»ad_»ûncy_fÜ_´omÙe
);

1220 
f
->
	`dump_unsigÃd
("mš_wr™e_»ûncy_fÜ_´omÙe", 
mš_wr™e_»ûncy_fÜ_´omÙe
);

1221 
f
->
	`dump_unsigÃd
("h™_£t_g¿de_deÿy_¿‹", 
h™_£t_g¿de_deÿy_¿‹
);

1222 
f
->
	`dump_unsigÃd
("h™_£t_£¬ch_Ï¡_n", 
h™_£t_£¬ch_Ï¡_n
);

1223 
f
->
	`İ’_¬¿y_£ùiÚ
("grade_table");

1224 
i
 = 0; i < 
h™_£t_couÁ
; ++i)

1225 
f
->
	`dump_unsigÃd
("v®ue", 
	`g‘_g¿de
(
i
));

1226 
f
->
	`şo£_£ùiÚ
();

1227 
f
->
	`dump_unsigÃd
("¡re_width", 
	`g‘_¡re_width
());

1228 
f
->
	`dump_unsigÃd
("ex³ùed_num_objeùs", 
ex³ùed_num_objeùs
);

1229 
f
->
	`dump_boŞ
("ç¡_»ad", 
ç¡_»ad
);

1230 
f
->
	`İ’_objeù_£ùiÚ
("options");

1231 
İts
.
	`dump
(
f
);

1232 
f
->
	`şo£_£ùiÚ
();

1233 
f
->
	`İ’_objeù_£ùiÚ
("application_metadata");

1234 autØ&
­p_·œ
 : 
­¶iÿtiÚ_m‘ad©a
) {

1235 
f
->
	`İ’_objeù_£ùiÚ
(
­p_·œ
.
fœ¡
.
	`c_¡r
());

1236 autØ&
kv_·œ
 : 
­p_·œ
.
£cÚd
) {

1237 
f
->
	`dump_¡ršg
(
kv_·œ
.
fœ¡
.
	`c_¡r
(), kv_·œ.
£cÚd
);

1239 
f
->
	`şo£_£ùiÚ
();

1241 
f
->
	`şo£_£ùiÚ
();

1242 
	}
}

1244 
	gpg_poŞ_t
::
cÚv”t_to_pg_sh¬ds
(cÚ¡ 
veùÜ
<> &
äom
, 
£t
<
pg_sh¬d_t
>* 
to
) const {

1245 
size_t
 
	gi
 = 0; i < 
	gäom
.
size
(); ++i) {

1246 ià(
	gäom
[
i
] !ğ
CRUSH_ITEM_NONE
) {

1247 
to
->
š£¹
(

1248 
pg_sh¬d_t
(

1249 
äom
[
i
],

1250 
is_”asu»
(è? 
sh¬d_id_t
(
i
è: sh¬d_id_t::
NO_SHARD
));

1255 
	gpg_poŞ_t
::
	$ÿlc_pg_masks
()

1257 
pg_num_mask
 = (1 << 
	`cb™s
(
pg_num
-1)) - 1;

1258 
pgp_num_mask
 = (1 << 
	`cb™s
(
pgp_num
-1)) - 1;

1259 
	}
}

1261 
	gpg_poŞ_t
::
	$g‘_pg_num_divisÜ
(
pg_t
 
pgid
) const

1263 ià(
pg_num
 =ğ
pg_num_mask
 + 1)

1264  
pg_num
;

1265 
mask
 = 
pg_num_mask
 >> 1;

1266 ià((
pgid
.
	`ps
(è& 
mask
è< (
pg_num
 & mask))

1267  
pg_num_mask
 + 1;

1269  (
pg_num_mask
 + 1) >> 1;

1270 
	}
}

1279 
boŞ
 
	gpg_poŞ_t
::
	$is_poŞ_¢­s_mode
() const

1281  
	`has_æag
(
FLAG_POOL_SNAPS
);

1282 
	}
}

1284 
boŞ
 
	gpg_poŞ_t
::
	$is_unmªaged_¢­s_mode
() const

1286  
	`has_æag
(
FLAG_SELFMANAGED_SNAPS
);

1287 
	}
}

1289 
boŞ
 
	gpg_poŞ_t
::
	$is_»moved_¢­
(
¢­id_t
 
s
) const

1291 ià(
	`is_poŞ_¢­s_mode
())

1292  
s
 <ğ
	`g‘_¢­_£q
(è&& 
¢­s
.
	`couÁ
(s) == 0;

1294  
»moved_¢­s
.
	`cÚšs
(
s
);

1295 
	}
}

1301 
	gpg_poŞ_t
::
bud_»moved_¢­s
(
š‹rv®_£t
<
¢­id_t
>& 
rs
) const

1303 ià(
is_poŞ_¢­s_mode
()) {

1304 
rs
.
ş—r
();

1305 
¢­id_t
 
	gs
 = 1; s <ğ
g‘_¢­_£q
(); s = 
s
 + 1)

1306 ià(
¢­s
.
couÁ
(
s
) == 0)

1307 
rs
.
š£¹
(
s
);

1309 
	grs
 = 
»moved_¢­s
;

1313 
boŞ
 
	gpg_poŞ_t
::
maybe_upd©ed_»moved_¢­s
(cÚ¡ 
š‹rv®_£t
<
¢­id_t
>& 
ÿched
) const

1315 ià(
is_unmªaged_¢­s_mode
()) {

1316 ià(
»moved_¢­s
.
em±y
(è|| 
ÿched
.empty())

1317  
»moved_¢­s
.
em±y
(è!ğ
ÿched
.empty();

1318  
	g»moved_¢­s
.
¿nge_’d
(è!ğ
ÿched
.range_end();

1320  
	gŒue
;

1323 
¢­id_t
 
	gpg_poŞ_t
::
	$¢­_exi¡s
(cÚ¡ *
s
) const

1325 
m­
<
¢­id_t
,
poŞ_¢­_šfo_t
>::
cÚ¡_™”©Ü
 
p
 = 
¢­s
.
	`begš
();

1326 
p
 !ğ
¢­s
.
	`’d
();

1327 ++
p
)

1328 ià(
p
->
£cÚd
.
Çme
 =ğ
s
)

1329  
p
->
£cÚd
.
¢­id
;

1331 
	}
}

1333 
	gpg_poŞ_t
::
	$add_¢­
(cÚ¡ *
n
, 
utime_t
 
¡amp
)

1335 
	`as£¹
(!
	`is_unmªaged_¢­s_mode
());

1336 
æags
 |ğ
FLAG_POOL_SNAPS
;

1337 
¢­id_t
 
s
 = 
	`g‘_¢­_£q
() + 1;

1338 
¢­_£q
 = 
s
;

1339 
¢­s
[
s
].
¢­id
 = s;

1340 
¢­s
[
s
].
Çme
 = 
n
;

1341 
¢­s
[
s
].
¡amp
 = stamp;

1342 
	}
}

1344 
	gpg_poŞ_t
::
	$add_unmªaged_¢­
(
ušt64_t
& 
¢­id
)

1346 
	`as£¹
(!
	`is_poŞ_¢­s_mode
());

1347 ià(
¢­_£q
 == 0) {

1351 
»moved_¢­s
.
	`š£¹
(
	`¢­id_t
(1));

1352 
¢­_£q
 = 1;

1354 
æags
 |ğ
FLAG_SELFMANAGED_SNAPS
;

1355 
¢­id
 = 
¢­_£q
 = snap_seq + 1;

1356 
	}
}

1358 
	gpg_poŞ_t
::
	$»move_¢­
(
¢­id_t
 
s
)

1360 
	`as£¹
(
¢­s
.
	`couÁ
(
s
));

1361 
¢­s
.
	`”a£
(
s
);

1362 
¢­_£q
 = snap_seq + 1;

1363 
	}
}

1365 
	gpg_poŞ_t
::
	$»move_unmªaged_¢­
(
¢­id_t
 
s
)

1367 
	`as£¹
(
	`is_unmªaged_¢­s_mode
());

1368 
»moved_¢­s
.
	`š£¹
(
s
);

1369 
¢­_£q
 = snap_seq + 1;

1371 ià(!
»moved_¢­s
.
	`cÚšs
(
	`g‘_¢­_£q
())) {

1372 
»moved_¢­s
.
	`š£¹
(
	`g‘_¢­_£q
());

1374 
	}
}

1376 
SÇpCÚ‹xt
 
	gpg_poŞ_t
::
	$g‘_¢­_cÚ‹xt
() const

1378 
veùÜ
<
¢­id_t
> 
	`s
(
¢­s
.
	`size
());

1379 
i
 = 0;

1380 
m­
<
¢­id_t
, 
poŞ_¢­_šfo_t
>::
cÚ¡_»v”£_™”©Ü
 
p
 = 
¢­s
.
	`rbegš
();

1381 
p
 !ğ
¢­s
.
	`»nd
();

1382 ++
p
)

1383 
s
[
i
++] = 
p
->
fœ¡
;

1384  
	`SÇpCÚ‹xt
(
	`g‘_¢­_£q
(), 
s
);

1385 
	}
}

1387 
ušt32_t
 
	gpg_poŞ_t
::
	$hash_key
(cÚ¡ 
¡ršg
& 
key
, cÚ¡ sŒšg& 
ns
) const

1389 ià(
ns
.
	`em±y
())

1390  
	`ûph_¡r_hash
(
objeù_hash
, 
key
.
	`d©a
(), key.
	`Ëngth
());

1391 
n¦
 = 
ns
.
	`Ëngth
();

1392 
Ën
 = 
key
.
	`Ëngth
(è+ 
n¦
 + 1;

1393 
buf
[
Ën
];

1394 
	`memıy
(&
buf
[0], 
ns
.
	`d©a
(), 
n¦
);

1395 
buf
[
n¦
] = '\037';

1396 
	`memıy
(&
buf
[
n¦
+1], 
key
.
	`d©a
(), key.
	`Ëngth
());

1397  
	`ûph_¡r_hash
(
objeù_hash
, &
buf
[0], 
Ën
);

1398 
	}
}

1400 
ušt32_t
 
	gpg_poŞ_t
::
	$¿w_hash_to_pg
(
ušt32_t
 
v
) const

1402  
	`ûph_¡abË_mod
(
v
, 
pg_num
, 
pg_num_mask
);

1403 
	}
}

1408 
pg_t
 
	gpg_poŞ_t
::
	$¿w_pg_to_pg
(
pg_t
 
pg
) const

1410 
pg
.
	`£t_ps
(
	`ûph_¡abË_mod
Õg.
	`ps
(), 
pg_num
, 
pg_num_mask
));

1411  
pg
;

1412 
	}
}

1419 
ps_t
 
	gpg_poŞ_t
::
	$¿w_pg_to_µs
(
pg_t
 
pg
) const

1421 ià(
æags
 & 
FLAG_HASHPSPOOL
) {

1424 
	`üush_hash32_2
(
CRUSH_HASH_RJENKINS1
,

1425 
	`ûph_¡abË_mod
(
pg
.
	`ps
(), 
pgp_num
, 
pgp_num_mask
),

1426 
pg
.
	`poŞ
());

1432 
	`ûph_¡abË_mod
(
pg
.
	`ps
(), 
pgp_num
, 
pgp_num_mask
) +

1433 
pg
.
	`poŞ
();

1435 
	}
}

1437 
ušt32_t
 
	gpg_poŞ_t
::
	$g‘_¿ndom_pg_pos™iÚ
(
pg_t
 
pg
, 
ušt32_t
 
£ed
) const

1439 
ušt32_t
 
r
 = 
	`üush_hash32_2
(
CRUSH_HASH_RJENKINS1
, 
£ed
, 123);

1440 ià(
pg_num
 =ğ
pg_num_mask
 + 1) {

1441 
r
 &ğ~
pg_num_mask
;

1443 
sm®Ër_mask
 = 
pg_num_mask
 >> 1;

1444 ià((
pg
.
	`ps
(è& 
sm®Ër_mask
è< (
pg_num
 & smaller_mask)) {

1445 
r
 &ğ~
pg_num_mask
;

1447 
r
 &ğ~
sm®Ër_mask
;

1450 
r
 |ğ
pg
.
	`ps
();

1451  
r
;

1452 
	}
}

1454 
	gpg_poŞ_t
::
	$’code
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
) const

1456 
usšg
 
ûph
::
’code
;

1457 ià((
ã©u»s
 & 
CEPH_FEATURE_PGPOOL3
) == 0) {

1459 
__u8
 
¡ruù_v
 = 2;

1460 
	`’code
(
¡ruù_v
, 
bl
);

1461 
	`’code
(
ty³
, 
bl
);

1462 
	`’code
(
size
, 
bl
);

1463 
	`’code
(
üush_ruË
, 
bl
);

1464 
	`’code
(
objeù_hash
, 
bl
);

1465 
	`’code
(
pg_num
, 
bl
);

1466 
	`’code
(
pgp_num
, 
bl
);

1467 
__u32
 
Íg_num
 = 0, 
Ígp_num
 = 0;

1468 
	`’code
(
Íg_num
, 
bl
);

1469 
	`’code
(
Ígp_num
, 
bl
);

1470 
	`’code
(
Ï¡_chªge
, 
bl
);

1471 
	`’code
(
¢­_£q
, 
bl
);

1472 
	`’code
(
¢­_•och
, 
bl
);

1474 
__u32
 
n
 = 
¢­s
.
	`size
();

1475 
	`’code
(
n
, 
bl
);

1476 
n
 = 
»moved_¢­s
.
	`num_š‹rv®s
();

1477 
	`’code
(
n
, 
bl
);

1479 
	`’code
(
auid
, 
bl
);

1481 
	`’code_noh—d
(
¢­s
, 
bl
, 
ã©u»s
);

1482 
	`’code_noh—d
(
»moved_¢­s
, 
bl
);

1486 ià((
ã©u»s
 & 
CEPH_FEATURE_OSDENC
) == 0) {

1487 
__u8
 
¡ruù_v
 = 4;

1488 
	`’code
(
¡ruù_v
, 
bl
);

1489 
	`’code
(
ty³
, 
bl
);

1490 
	`’code
(
size
, 
bl
);

1491 
	`’code
(
üush_ruË
, 
bl
);

1492 
	`’code
(
objeù_hash
, 
bl
);

1493 
	`’code
(
pg_num
, 
bl
);

1494 
	`’code
(
pgp_num
, 
bl
);

1495 
__u32
 
Íg_num
 = 0, 
Ígp_num
 = 0;

1496 
	`’code
(
Íg_num
, 
bl
);

1497 
	`’code
(
Ígp_num
, 
bl
);

1498 
	`’code
(
Ï¡_chªge
, 
bl
);

1499 
	`’code
(
¢­_£q
, 
bl
);

1500 
	`’code
(
¢­_•och
, 
bl
);

1501 
	`’code
(
¢­s
, 
bl
, 
ã©u»s
);

1502 
	`’code
(
»moved_¢­s
, 
bl
);

1503 
	`’code
(
auid
, 
bl
);

1504 
	`’code
(
æags
, 
bl
);

1505 
	`’code
((
ušt32_t
)0, 
bl
);

1509 ià((
ã©u»s
 & 
CEPH_FEATURE_OSD_POOLRESEND
) == 0) {

1515 
	`ENCODE_START
(14, 5, 
bl
);

1516 
	`’code
(
ty³
, 
bl
);

1517 
	`’code
(
size
, 
bl
);

1518 
	`’code
(
üush_ruË
, 
bl
);

1519 
	`’code
(
objeù_hash
, 
bl
);

1520 
	`’code
(
pg_num
, 
bl
);

1521 
	`’code
(
pgp_num
, 
bl
);

1522 
__u32
 
Íg_num
 = 0, 
Ígp_num
 = 0;

1523 
	`’code
(
Íg_num
, 
bl
);

1524 
	`’code
(
Ígp_num
, 
bl
);

1525 
	`’code
(
Ï¡_chªge
, 
bl
);

1526 
	`’code
(
¢­_£q
, 
bl
);

1527 
	`’code
(
¢­_•och
, 
bl
);

1528 
	`’code
(
¢­s
, 
bl
, 
ã©u»s
);

1529 
	`’code
(
»moved_¢­s
, 
bl
);

1530 
	`’code
(
auid
, 
bl
);

1531 
	`’code
(
æags
, 
bl
);

1532 
	`’code
((
ušt32_t
)0, 
bl
);

1533 
	`’code
(
mš_size
, 
bl
);

1534 
	`’code
(
quÙa_max_by‹s
, 
bl
);

1535 
	`’code
(
quÙa_max_objeùs
, 
bl
);

1536 
	`’code
(
t›rs
, 
bl
);

1537 
	`’code
(
t›r_of
, 
bl
);

1538 
__u8
 
c
 = 
ÿche_mode
;

1539 
	`’code
(
c
, 
bl
);

1540 
	`’code
(
»ad_t›r
, 
bl
);

1541 
	`’code
(
wr™e_t›r
, 
bl
);

1542 
	`’code
(
´İ”t›s
, 
bl
);

1543 
	`’code
(
h™_£t_·¿ms
, 
bl
);

1544 
	`’code
(
h™_£t_³riod
, 
bl
);

1545 
	`’code
(
h™_£t_couÁ
, 
bl
);

1546 
	`’code
(
¡re_width
, 
bl
);

1547 
	`’code
(
rg‘_max_by‹s
, 
bl
);

1548 
	`’code
(
rg‘_max_objeùs
, 
bl
);

1549 
	`’code
(
ÿche_rg‘_dœty_¿tio_miüo
, 
bl
);

1550 
	`’code
(
ÿche_rg‘_fuÎ_¿tio_miüo
, 
bl
);

1551 
	`’code
(
ÿche_mš_æush_age
, 
bl
);

1552 
	`’code
(
ÿche_mš_eviù_age
, 
bl
);

1553 
	`’code
(
”asu»_code_´ofe
, 
bl
);

1554 
	`ENCODE_FINISH
(
bl
);

1558 
ušt8_t
 
v
 = 27;

1561 ià(!(
ã©u»s
 & 
CEPH_FEATURE_NEW_OSDOP_ENCODING
)) {

1564 
v
 = 21;

1565 } ià(!
	`HAVE_FEATURE
(
ã©u»s
, 
SERVER_LUMINOUS
)) {

1566 
v
 = 24;

1567 } ià(!
	`HAVE_FEATURE
(
ã©u»s
, 
SERVER_MIMIC
)) {

1568 
v
 = 26;

1571 
	`ENCODE_START
(
v
, 5, 
bl
);

1572 
	`’code
(
ty³
, 
bl
);

1573 
	`’code
(
size
, 
bl
);

1574 
	`’code
(
üush_ruË
, 
bl
);

1575 
	`’code
(
objeù_hash
, 
bl
);

1576 
	`’code
(
pg_num
, 
bl
);

1577 
	`’code
(
pgp_num
, 
bl
);

1578 
__u32
 
Íg_num
 = 0, 
Ígp_num
 = 0;

1579 
	`’code
(
Íg_num
, 
bl
);

1580 
	`’code
(
Ígp_num
, 
bl
);

1581 
	`’code
(
Ï¡_chªge
, 
bl
);

1582 
	`’code
(
¢­_£q
, 
bl
);

1583 
	`’code
(
¢­_•och
, 
bl
);

1584 
	`’code
(
¢­s
, 
bl
, 
ã©u»s
);

1585 
	`’code
(
»moved_¢­s
, 
bl
);

1586 
	`’code
(
auid
, 
bl
);

1587 ià(
v
 >= 27) {

1588 
	`’code
(
æags
, 
bl
);

1590 autØ
tmp
 = 
æags
;

1591 
tmp
 &ğ~(
FLAG_SELFMANAGED_SNAPS
 | 
FLAG_POOL_SNAPS
);

1592 
	`’code
(
tmp
, 
bl
);

1594 
	`’code
((
ušt32_t
)0, 
bl
);

1595 
	`’code
(
mš_size
, 
bl
);

1596 
	`’code
(
quÙa_max_by‹s
, 
bl
);

1597 
	`’code
(
quÙa_max_objeùs
, 
bl
);

1598 
	`’code
(
t›rs
, 
bl
);

1599 
	`’code
(
t›r_of
, 
bl
);

1600 
__u8
 
c
 = 
ÿche_mode
;

1601 
	`’code
(
c
, 
bl
);

1602 
	`’code
(
»ad_t›r
, 
bl
);

1603 
	`’code
(
wr™e_t›r
, 
bl
);

1604 
	`’code
(
´İ”t›s
, 
bl
);

1605 
	`’code
(
h™_£t_·¿ms
, 
bl
);

1606 
	`’code
(
h™_£t_³riod
, 
bl
);

1607 
	`’code
(
h™_£t_couÁ
, 
bl
);

1608 
	`’code
(
¡re_width
, 
bl
);

1609 
	`’code
(
rg‘_max_by‹s
, 
bl
);

1610 
	`’code
(
rg‘_max_objeùs
, 
bl
);

1611 
	`’code
(
ÿche_rg‘_dœty_¿tio_miüo
, 
bl
);

1612 
	`’code
(
ÿche_rg‘_fuÎ_¿tio_miüo
, 
bl
);

1613 
	`’code
(
ÿche_mš_æush_age
, 
bl
);

1614 
	`’code
(
ÿche_mš_eviù_age
, 
bl
);

1615 
	`’code
(
”asu»_code_´ofe
, 
bl
);

1616 
	`’code
(
Ï¡_fÜû_İ_»£nd_´–umšous
, 
bl
);

1617 
	`’code
(
mš_»ad_»ûncy_fÜ_´omÙe
, 
bl
);

1618 
	`’code
(
ex³ùed_num_objeùs
, 
bl
);

1619 ià(
v
 >= 19) {

1620 
	`’code
(
ÿche_rg‘_dœty_high_¿tio_miüo
, 
bl
);

1622 ià(
v
 >= 20) {

1623 
	`’code
(
mš_wr™e_»ûncy_fÜ_´omÙe
, 
bl
);

1625 ià(
v
 >= 21) {

1626 
	`’code
(
u£_gmt_h™£t
, 
bl
);

1628 ià(
v
 >= 22) {

1629 
	`’code
(
ç¡_»ad
, 
bl
);

1631 ià(
v
 >= 23) {

1632 
	`’code
(
h™_£t_g¿de_deÿy_¿‹
, 
bl
);

1633 
	`’code
(
h™_£t_£¬ch_Ï¡_n
, 
bl
);

1635 ià(
v
 >= 24) {

1636 
	`’code
(
İts
, 
bl
);

1638 ià(
v
 >= 25) {

1639 
	`’code
(
Ï¡_fÜû_İ_»£nd
, 
bl
);

1641 ià(
v
 >= 26) {

1642 
	`’code
(
­¶iÿtiÚ_m‘ad©a
, 
bl
);

1644 ià(
v
 >= 27) {

1645 
	`’code
(
ü—‹_time
, 
bl
);

1647 
	`ENCODE_FINISH
(
bl
);

1648 
	}
}

1650 
	gpg_poŞ_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
)

1652 
	`DECODE_START_LEGACY_COMPAT_LEN
(27, 5, 5, 
bl
);

1653 
	`decode
(
ty³
, 
bl
);

1654 
	`decode
(
size
, 
bl
);

1655 
	`decode
(
üush_ruË
, 
bl
);

1656 
	`decode
(
objeù_hash
, 
bl
);

1657 
	`decode
(
pg_num
, 
bl
);

1658 
	`decode
(
pgp_num
, 
bl
);

1660 
__u32
 
Íg_num
, 
Ígp_num
;

1661 
	`decode
(
Íg_num
, 
bl
);

1662 
	`decode
(
Ígp_num
, 
bl
);

1664 
	`decode
(
Ï¡_chªge
, 
bl
);

1665 
	`decode
(
¢­_£q
, 
bl
);

1666 
	`decode
(
¢­_•och
, 
bl
);

1668 ià(
¡ruù_v
 >= 3) {

1669 
	`decode
(
¢­s
, 
bl
);

1670 
	`decode
(
»moved_¢­s
, 
bl
);

1671 
	`decode
(
auid
, 
bl
);

1673 
__u32
 
n
, 
m
;

1674 
	`decode
(
n
, 
bl
);

1675 
	`decode
(
m
, 
bl
);

1676 
	`decode
(
auid
, 
bl
);

1677 
	`decode_noh—d
(
n
, 
¢­s
, 
bl
);

1678 
	`decode_noh—d
(
m
, 
»moved_¢­s
, 
bl
);

1681 ià(
¡ruù_v
 >= 4) {

1682 
	`decode
(
æags
, 
bl
);

1683 
ušt32_t
 
üash_»¶ay_š‹rv®
;

1684 
	`decode
(
üash_»¶ay_š‹rv®
, 
bl
);

1686 
æags
 = 0;

1689 ià(
¢­_£q
 > 0 && (
æags
 & (
FLAG_SELFMANAGED_SNAPS
|
FLAG_POOL_SNAPS
)) == 0) {

1690 ià(!
»moved_¢­s
.
	`em±y
()) {

1691 
æags
 |ğ
FLAG_SELFMANAGED_SNAPS
;

1693 
æags
 |ğ
FLAG_POOL_SNAPS
;

1696 ià(
¡ruù_v
 >= 7) {

1697 
	`decode
(
mš_size
, 
bl
);

1699 
mš_size
 = 
size
 - size/2;

1701 ià(
¡ruù_v
 >= 8) {

1702 
	`decode
(
quÙa_max_by‹s
, 
bl
);

1703 
	`decode
(
quÙa_max_objeùs
, 
bl
);

1705 ià(
¡ruù_v
 >= 9) {

1706 
	`decode
(
t›rs
, 
bl
);

1707 
	`decode
(
t›r_of
, 
bl
);

1708 
__u8
 
v
;

1709 
	`decode
(
v
, 
bl
);

1710 
ÿche_mode
 = (
ÿche_mode_t
)
v
;

1711 
	`decode
(
»ad_t›r
, 
bl
);

1712 
	`decode
(
wr™e_t›r
, 
bl
);

1714 ià(
¡ruù_v
 >= 10) {

1715 
	`decode
(
´İ”t›s
, 
bl
);

1717 ià(
¡ruù_v
 >= 11) {

1718 
	`decode
(
h™_£t_·¿ms
, 
bl
);

1719 
	`decode
(
h™_£t_³riod
, 
bl
);

1720 
	`decode
(
h™_£t_couÁ
, 
bl
);

1722 
pg_poŞ_t
 
def
;

1723 
h™_£t_³riod
 = 
def
.hit_set_period;

1724 
h™_£t_couÁ
 = 
def
.hit_set_count;

1726 ià(
¡ruù_v
 >= 12) {

1727 
	`decode
(
¡re_width
, 
bl
);

1729 
	`£t_¡re_width
(0);

1731 ià(
¡ruù_v
 >= 13) {

1732 
	`decode
(
rg‘_max_by‹s
, 
bl
);

1733 
	`decode
(
rg‘_max_objeùs
, 
bl
);

1734 
	`decode
(
ÿche_rg‘_dœty_¿tio_miüo
, 
bl
);

1735 
	`decode
(
ÿche_rg‘_fuÎ_¿tio_miüo
, 
bl
);

1736 
	`decode
(
ÿche_mš_æush_age
, 
bl
);

1737 
	`decode
(
ÿche_mš_eviù_age
, 
bl
);

1739 
rg‘_max_by‹s
 = 0;

1740 
rg‘_max_objeùs
 = 0;

1741 
ÿche_rg‘_dœty_¿tio_miüo
 = 0;

1742 
ÿche_rg‘_fuÎ_¿tio_miüo
 = 0;

1743 
ÿche_mš_æush_age
 = 0;

1744 
ÿche_mš_eviù_age
 = 0;

1746 ià(
¡ruù_v
 >= 14) {

1747 
	`decode
(
”asu»_code_´ofe
, 
bl
);

1749 ià(
¡ruù_v
 >= 15) {

1750 
	`decode
(
Ï¡_fÜû_İ_»£nd_´–umšous
, 
bl
);

1752 
Ï¡_fÜû_İ_»£nd_´–umšous
 = 0;

1754 ià(
¡ruù_v
 >= 16) {

1755 
	`decode
(
mš_»ad_»ûncy_fÜ_´omÙe
, 
bl
);

1757 
mš_»ad_»ûncy_fÜ_´omÙe
 = 1;

1759 ià(
¡ruù_v
 >= 17) {

1760 
	`decode
(
ex³ùed_num_objeùs
, 
bl
);

1762 
ex³ùed_num_objeùs
 = 0;

1764 ià(
¡ruù_v
 >= 19) {

1765 
	`decode
(
ÿche_rg‘_dœty_high_¿tio_miüo
, 
bl
);

1767 
ÿche_rg‘_dœty_high_¿tio_miüo
 = 
ÿche_rg‘_dœty_¿tio_miüo
;

1769 ià(
¡ruù_v
 >= 20) {

1770 
	`decode
(
mš_wr™e_»ûncy_fÜ_´omÙe
, 
bl
);

1772 
mš_wr™e_»ûncy_fÜ_´omÙe
 = 1;

1774 ià(
¡ruù_v
 >= 21) {

1775 
	`decode
(
u£_gmt_h™£t
, 
bl
);

1777 
u£_gmt_h™£t
 = 
çl£
;

1779 ià(
¡ruù_v
 >= 22) {

1780 
	`decode
(
ç¡_»ad
, 
bl
);

1782 
ç¡_»ad
 = 
çl£
;

1784 ià(
¡ruù_v
 >= 23) {

1785 
	`decode
(
h™_£t_g¿de_deÿy_¿‹
, 
bl
);

1786 
	`decode
(
h™_£t_£¬ch_Ï¡_n
, 
bl
);

1788 
h™_£t_g¿de_deÿy_¿‹
 = 0;

1789 
h™_£t_£¬ch_Ï¡_n
 = 1;

1791 ià(
¡ruù_v
 >= 24) {

1792 
	`decode
(
İts
, 
bl
);

1794 ià(
¡ruù_v
 >= 25) {

1795 
	`decode
(
Ï¡_fÜû_İ_»£nd
, 
bl
);

1797 
Ï¡_fÜû_İ_»£nd
 = 
Ï¡_fÜû_İ_»£nd_´–umšous
;

1799 ià(
¡ruù_v
 >= 26) {

1800 
	`decode
(
­¶iÿtiÚ_m‘ad©a
, 
bl
);

1802 ià(
¡ruù_v
 >= 27) {

1803 
	`decode
(
ü—‹_time
, 
bl
);

1805 
	`DECODE_FINISH
(
bl
);

1806 
	`ÿlc_pg_masks
();

1807 
	`ÿlc_g¿de_bË
();

1808 
	}
}

1810 
	gpg_poŞ_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_poŞ_t
*>& 
o
)

1812 
pg_poŞ_t
 
a
;

1813 
	go
.
push_back
(
Ãw
 
pg_poŞ_t
(
a
));

1815 
	ga
.
	gü—‹_time
 = 
utime_t
(4,5);

1816 
	ga
.
	gty³
 = 
TYPE_REPLICATED
;

1817 
	ga
.
	gsize
 = 2;

1818 
	ga
.
	güush_ruË
 = 3;

1819 
	ga
.
	gobjeù_hash
 = 4;

1820 
	ga
.
	gpg_num
 = 6;

1821 
	ga
.
	gpgp_num
 = 5;

1822 
	ga
.
	gÏ¡_chªge
 = 9;

1823 
	ga
.
	gÏ¡_fÜû_İ_»£nd
 = 123823;

1824 
	ga
.
	gÏ¡_fÜû_İ_»£nd_´–umšous
 = 123824;

1825 
	ga
.
	g¢­_£q
 = 10;

1826 
	ga
.
	g¢­_•och
 = 11;

1827 
	ga
.
	gæags
 = 
FLAG_POOL_SNAPS
;

1828 
	ga
.
	gauid
 = 12;

1829 
	ga
.
	gquÙa_max_by‹s
 = 473;

1830 
	ga
.
	gquÙa_max_objeùs
 = 474;

1831 
	go
.
push_back
(
Ãw
 
pg_poŞ_t
(
a
));

1833 
	ga
.
	g¢­s
[3].
	gÇme
 = "asdf";

1834 
	ga
.
	g¢­s
[3].
	g¢­id
 = 3;

1835 
	ga
.
	g¢­s
[3].
	g¡amp
 = 
utime_t
(123, 4);

1836 
	ga
.
	g¢­s
[6].
	gÇme
 = "qwer";

1837 
	ga
.
	g¢­s
[6].
	g¢­id
 = 6;

1838 
	ga
.
	g¢­s
[6].
	g¡amp
 = 
utime_t
(23423, 4);

1839 
	go
.
push_back
(
Ãw
 
pg_poŞ_t
(
a
));

1841 
	ga
.
	gæags
 = 
FLAG_SELFMANAGED_SNAPS
;

1842 
	ga
.
	g¢­s
.
ş—r
();

1843 
	ga
.
	g»moved_¢­s
.
š£¹
(2);

1844 
	ga
.
	gquÙa_max_by‹s
 = 2473;

1845 
	ga
.
	gquÙa_max_objeùs
 = 4374;

1846 
	ga
.
	gt›rs
.
š£¹
(0);

1847 
	ga
.
	gt›rs
.
š£¹
(1);

1848 
	ga
.
	gt›r_of
 = 2;

1849 
	ga
.
	gÿche_mode
 = 
CACHEMODE_WRITEBACK
;

1850 
	ga
.
	g»ad_t›r
 = 1;

1851 
	ga
.
	gwr™e_t›r
 = 1;

1852 
	ga
.
	gh™_£t_·¿ms
 = 
H™S‘
::
P¬ams
(
Ãw
 
BloomH™S‘
::Params);

1853 
	ga
.
	gh™_£t_³riod
 = 3600;

1854 
	ga
.
	gh™_£t_couÁ
 = 8;

1855 
	ga
.
	gmš_»ad_»ûncy_fÜ_´omÙe
 = 1;

1856 
	ga
.
	gmš_wr™e_»ûncy_fÜ_´omÙe
 = 1;

1857 
	ga
.
	gh™_£t_g¿de_deÿy_¿‹
 = 50;

1858 
	ga
.
	gh™_£t_£¬ch_Ï¡_n
 = 1;

1859 
	ga
.
ÿlc_g¿de_bË
();

1860 
	ga
.
£t_¡re_width
(12345);

1861 
	ga
.
	grg‘_max_by‹s
 = 1238132132;

1862 
	ga
.
	grg‘_max_objeùs
 = 1232132;

1863 
	ga
.
	gÿche_rg‘_dœty_¿tio_miüo
 = 187232;

1864 
	ga
.
	gÿche_rg‘_dœty_high_¿tio_miüo
 = 309856;

1865 
	ga
.
	gÿche_rg‘_fuÎ_¿tio_miüo
 = 987222;

1866 
	ga
.
	gÿche_mš_æush_age
 = 231;

1867 
	ga
.
	gÿche_mš_eviù_age
 = 2321;

1868 
	ga
.
	g”asu»_code_´ofe
 = "profile in osdmap";

1869 
	ga
.
	gex³ùed_num_objeùs
 = 123456;

1870 
	ga
.
	gç¡_»ad
 = 
çl£
;

1871 
	ga
.
	g­¶iÿtiÚ_m‘ad©a
 = {{"rbd", {{"key", "value"}}}};

1872 
	go
.
push_back
(
Ãw
 
pg_poŞ_t
(
a
));

1875 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gpg_poŞ_t
& 
	gp
)

1877 
	gout
 << 
	gp
.
g‘_ty³_Çme
()

1878 << " siz" << 
	gp
.
g‘_size
()

1879 << " mš_siz" << 
	gp
.
g‘_mš_size
()

1880 << " crush_ruË " << 
	gp
.
g‘_üush_ruË
()

1881 << " objeù_hash " << 
	gp
.
g‘_objeù_hash_Çme
()

1882 << "…g_num " << 
	gp
.
g‘_pg_num
()

1883 << "…gp_num " << 
	gp
.
g‘_pgp_num
()

1884 << "†a¡_chªg" << 
	gp
.
g‘_Ï¡_chªge
();

1885 ià(
	gp
.
g‘_Ï¡_fÜû_İ_»£nd
() ||

1886 
	gp
.
g‘_Ï¡_fÜû_İ_»£nd_´–umšous
())

1887 
	gout
 << "†fÜ " << 
	gp
.
g‘_Ï¡_fÜû_İ_»£nd
() << "/"

1888 << 
	gp
.
g‘_Ï¡_fÜû_İ_»£nd_´–umšous
();

1889 ià(
	gp
.
g‘_auid
())

1890 
	gout
 << " owÃ¸" << 
	gp
.
g‘_auid
();

1891 ià(
	gp
.
	gæags
)

1892 
	gout
 << " fÏg " << 
	gp
.
g‘_æags_¡ršg
();

1893 ià(
	gp
.
	gquÙa_max_by‹s
)

1894 
	gout
 << " max_by‹ " << 
	gp
.
	gquÙa_max_by‹s
;

1895 ià(
	gp
.
	gquÙa_max_objeùs
)

1896 
	gout
 << " max_objeù " << 
	gp
.
	gquÙa_max_objeùs
;

1897 ià(!
	gp
.
	gt›rs
.
em±y
())

1898 
	gout
 << "›r " << 
	gp
.
	gt›rs
;

1899 ià(
	gp
.
is_t›r
())

1900 
	gout
 << "›r_oà" << 
	gp
.
	gt›r_of
;

1901 ià(
	gp
.
has_»ad_t›r
())

1902 
	gout
 << "„—d_t›¸" << 
	gp
.
	g»ad_t›r
;

1903 ià(
	gp
.
has_wr™e_t›r
())

1904 
	gout
 << " wr™e_t›¸" << 
	gp
.
	gwr™e_t›r
;

1905 ià(
	gp
.
	gÿche_mode
)

1906 
	gout
 << " cache_mod" << 
	gp
.
g‘_ÿche_mode_Çme
();

1907 ià(
	gp
.
	grg‘_max_by‹s
)

1908 
	gout
 << "¬g‘_by‹ " << 
	gp
.
	grg‘_max_by‹s
;

1909 ià(
	gp
.
	grg‘_max_objeùs
)

1910 
	gout
 << "¬g‘_objeù " << 
	gp
.
	grg‘_max_objeùs
;

1911 ià(
	gp
.
	gh™_£t_·¿ms
.
g‘_ty³
(è!ğ
H™S‘
::
TYPE_NONE
) {

1912 
out
 << " h™_£ˆ" << 
p
.
h™_£t_·¿ms


1913 << " " << 
p
.
h™_£t_³riod
 << "s"

1914 << " x" << 
p
.
h™_£t_couÁ
 << " decay_rate "

1915 << 
p
.
h™_£t_g¿de_deÿy_¿‹


1916 << " s—rch_Ï¡_À" << 
p
.
h™_£t_£¬ch_Ï¡_n
;

1918 ià(
	gp
.
	gmš_»ad_»ûncy_fÜ_´omÙe
)

1919 
	gout
 << " mš_»ad_»ûncy_fÜ_´omÙ" << 
	gp
.
	gmš_»ad_»ûncy_fÜ_´omÙe
;

1920 ià(
	gp
.
	gmš_wr™e_»ûncy_fÜ_´omÙe
)

1921 
	gout
 << " mš_wr™e_»ûncy_fÜ_´omÙ" << 
	gp
.
	gmš_wr™e_»ûncy_fÜ_´omÙe
;

1922 
	gout
 << " sŒe_width " << 
	gp
.
g‘_¡re_width
();

1923 ià(
	gp
.
	gex³ùed_num_objeùs
)

1924 
	gout
 << "ƒx³ùed_num_objeù " << 
	gp
.
	gex³ùed_num_objeùs
;

1925 ià(
	gp
.
	gç¡_»ad
)

1926 
	gout
 << " fa¡_»ad " << 
	gp
.
	gç¡_»ad
;

1927 
	gout
 << 
	gp
.
	gİts
;

1928 ià(!
	gp
.
	g­¶iÿtiÚ_m‘ad©a
.
em±y
()) {

1929 
	gout
 << "‡pplication ";

1930 autØ
	g™
 = 
p
.
­¶iÿtiÚ_m‘ad©a
.
begš
();

1931 
	g™
 !ğ
p
.
­¶iÿtiÚ_m‘ad©a
.
’d
(); ++it) {

1932 ià(
	g™
 !ğ
p
.
­¶iÿtiÚ_m‘ad©a
.
begš
())

1933 
out
 << ",";

1934 
	gout
 << 
	g™
->
	gfœ¡
;

1937  
	gout
;

1943 
	gobjeù_¡©_sum_t
::
	$dump
(
FÜm©‹r
 *
f
) const

1945 
f
->
	`dump_št
("num_by‹s", 
num_by‹s
);

1946 
f
->
	`dump_št
("num_objeùs", 
num_objeùs
);

1947 
f
->
	`dump_št
("num_objeù_şÚes", 
num_objeù_şÚes
);

1948 
f
->
	`dump_št
("num_objeù_cİ›s", 
num_objeù_cİ›s
);

1949 
f
->
	`dump_št
("num_objeùs_missšg_Ú_´im¬y", 
num_objeùs_missšg_Ú_´im¬y
);

1950 
f
->
	`dump_št
("num_objeùs_missšg", 
num_objeùs_missšg
);

1951 
f
->
	`dump_št
("num_objeùs_deg¿ded", 
num_objeùs_deg¿ded
);

1952 
f
->
	`dump_št
("num_objeùs_mi¥Ïûd", 
num_objeùs_mi¥Ïûd
);

1953 
f
->
	`dump_št
("num_objeùs_unfound", 
num_objeùs_unfound
);

1954 
f
->
	`dump_št
("num_objeùs_dœty", 
num_objeùs_dœty
);

1955 
f
->
	`dump_št
("num_wh™eouts", 
num_wh™eouts
);

1956 
f
->
	`dump_št
("num_»ad", 
num_rd
);

1957 
f
->
	`dump_št
("num_»ad_kb", 
num_rd_kb
);

1958 
f
->
	`dump_št
("num_wr™e", 
num_wr
);

1959 
f
->
	`dump_št
("num_wr™e_kb", 
num_wr_kb
);

1960 
f
->
	`dump_št
("num_süub_”rÜs", 
num_süub_”rÜs
);

1961 
f
->
	`dump_št
("num_sh®low_süub_”rÜs", 
num_sh®low_süub_”rÜs
);

1962 
f
->
	`dump_št
("num_d“p_süub_”rÜs", 
num_d“p_süub_”rÜs
);

1963 
f
->
	`dump_št
("num_objeùs_»cov”ed", 
num_objeùs_»cov”ed
);

1964 
f
->
	`dump_št
("num_by‹s_»cov”ed", 
num_by‹s_»cov”ed
);

1965 
f
->
	`dump_št
("num_keys_»cov”ed", 
num_keys_»cov”ed
);

1966 
f
->
	`dump_št
("num_objeùs_om­", 
num_objeùs_om­
);

1967 
f
->
	`dump_št
("num_objeùs_h™_£t_¬chive", 
num_objeùs_h™_£t_¬chive
);

1968 
f
->
	`dump_št
("num_by‹s_h™_£t_¬chive", 
num_by‹s_h™_£t_¬chive
);

1969 
f
->
	`dump_št
("num_æush", 
num_æush
);

1970 
f
->
	`dump_št
("num_æush_kb", 
num_æush_kb
);

1971 
f
->
	`dump_št
("num_eviù", 
num_eviù
);

1972 
f
->
	`dump_št
("num_eviù_kb", 
num_eviù_kb
);

1973 
f
->
	`dump_št
("num_´omÙe", 
num_´omÙe
);

1974 
f
->
	`dump_št
("num_æush_mode_high", 
num_æush_mode_high
);

1975 
f
->
	`dump_št
("num_æush_mode_low", 
num_æush_mode_low
);

1976 
f
->
	`dump_št
("num_eviù_mode_some", 
num_eviù_mode_some
);

1977 
f
->
	`dump_št
("num_eviù_mode_fuÎ", 
num_eviù_mode_fuÎ
);

1978 
f
->
	`dump_št
("num_objeùs_pšÃd", 
num_objeùs_pšÃd
);

1979 
f
->
	`dump_št
("num_Ëgacy_¢­£ts", 
num_Ëgacy_¢­£ts
);

1980 
f
->
	`dump_št
("num_Ïrge_om­_objeùs", 
num_Ïrge_om­_objeùs
);

1981 
f
->
	`dump_št
("num_objeùs_mªiã¡", 
num_objeùs_mªiã¡
);

1982 
	}
}

1984 
	gobjeù_¡©_sum_t
::
	$’code
(
bufã¾i¡
& 
bl
) const

1986 
	`ENCODE_START
(18, 14, 
bl
);

1987 #ià
	`defšed
(
CEPH_LITTLE_ENDIAN
)

1988 
bl
.
	`­³nd
((*)(&
num_by‹s
), (
objeù_¡©_sum_t
));

1990 
	`’code
(
num_by‹s
, 
bl
);

1991 
	`’code
(
num_objeùs
, 
bl
);

1992 
	`’code
(
num_objeù_şÚes
, 
bl
);

1993 
	`’code
(
num_objeù_cİ›s
, 
bl
);

1994 
	`’code
(
num_objeùs_missšg_Ú_´im¬y
, 
bl
);

1995 
	`’code
(
num_objeùs_deg¿ded
, 
bl
);

1996 
	`’code
(
num_objeùs_unfound
, 
bl
);

1997 
	`’code
(
num_rd
, 
bl
);

1998 
	`’code
(
num_rd_kb
, 
bl
);

1999 
	`’code
(
num_wr
, 
bl
);

2000 
	`’code
(
num_wr_kb
, 
bl
);

2001 
	`’code
(
num_süub_”rÜs
, 
bl
);

2002 
	`’code
(
num_objeùs_»cov”ed
, 
bl
);

2003 
	`’code
(
num_by‹s_»cov”ed
, 
bl
);

2004 
	`’code
(
num_keys_»cov”ed
, 
bl
);

2005 
	`’code
(
num_sh®low_süub_”rÜs
, 
bl
);

2006 
	`’code
(
num_d“p_süub_”rÜs
, 
bl
);

2007 
	`’code
(
num_objeùs_dœty
, 
bl
);

2008 
	`’code
(
num_wh™eouts
, 
bl
);

2009 
	`’code
(
num_objeùs_om­
, 
bl
);

2010 
	`’code
(
num_objeùs_h™_£t_¬chive
, 
bl
);

2011 
	`’code
(
num_objeùs_mi¥Ïûd
, 
bl
);

2012 
	`’code
(
num_by‹s_h™_£t_¬chive
, 
bl
);

2013 
	`’code
(
num_æush
, 
bl
);

2014 
	`’code
(
num_æush_kb
, 
bl
);

2015 
	`’code
(
num_eviù
, 
bl
);

2016 
	`’code
(
num_eviù_kb
, 
bl
);

2017 
	`’code
(
num_´omÙe
, 
bl
);

2018 
	`’code
(
num_æush_mode_high
, 
bl
);

2019 
	`’code
(
num_æush_mode_low
, 
bl
);

2020 
	`’code
(
num_eviù_mode_some
, 
bl
);

2021 
	`’code
(
num_eviù_mode_fuÎ
, 
bl
);

2022 
	`’code
(
num_objeùs_pšÃd
, 
bl
);

2023 
	`’code
(
num_objeùs_missšg
, 
bl
);

2024 
	`’code
(
num_Ëgacy_¢­£ts
, 
bl
);

2025 
	`’code
(
num_Ïrge_om­_objeùs
, 
bl
);

2026 
	`’code
(
num_objeùs_mªiã¡
, 
bl
);

2028 
	`ENCODE_FINISH
(
bl
);

2029 
	}
}

2031 
	gobjeù_¡©_sum_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
)

2033 
boŞ
 
decode_fšish
 = 
çl£
;

2034 
	`DECODE_START
(18, 
bl
);

2035 #ià
	`defšed
(
CEPH_LITTLE_ENDIAN
)

2036 ià(
¡ruù_v
 >= 18) {

2037 
bl
.
	`cİy
((
objeù_¡©_sum_t
), (*)(&
num_by‹s
));

2038 
decode_fšish
 = 
Œue
;

2041 ià(!
decode_fšish
) {

2042 
	`decode
(
num_by‹s
, 
bl
);

2043 
	`decode
(
num_objeùs
, 
bl
);

2044 
	`decode
(
num_objeù_şÚes
, 
bl
);

2045 
	`decode
(
num_objeù_cİ›s
, 
bl
);

2046 
	`decode
(
num_objeùs_missšg_Ú_´im¬y
, 
bl
);

2047 
	`decode
(
num_objeùs_deg¿ded
, 
bl
);

2048 
	`decode
(
num_objeùs_unfound
, 
bl
);

2049 
	`decode
(
num_rd
, 
bl
);

2050 
	`decode
(
num_rd_kb
, 
bl
);

2051 
	`decode
(
num_wr
, 
bl
);

2052 
	`decode
(
num_wr_kb
, 
bl
);

2053 
	`decode
(
num_süub_”rÜs
, 
bl
);

2054 
	`decode
(
num_objeùs_»cov”ed
, 
bl
);

2055 
	`decode
(
num_by‹s_»cov”ed
, 
bl
);

2056 
	`decode
(
num_keys_»cov”ed
, 
bl
);

2057 
	`decode
(
num_sh®low_süub_”rÜs
, 
bl
);

2058 
	`decode
(
num_d“p_süub_”rÜs
, 
bl
);

2059 
	`decode
(
num_objeùs_dœty
, 
bl
);

2060 
	`decode
(
num_wh™eouts
, 
bl
);

2061 
	`decode
(
num_objeùs_om­
, 
bl
);

2062 
	`decode
(
num_objeùs_h™_£t_¬chive
, 
bl
);

2063 
	`decode
(
num_objeùs_mi¥Ïûd
, 
bl
);

2064 
	`decode
(
num_by‹s_h™_£t_¬chive
, 
bl
);

2065 
	`decode
(
num_æush
, 
bl
);

2066 
	`decode
(
num_æush_kb
, 
bl
);

2067 
	`decode
(
num_eviù
, 
bl
);

2068 
	`decode
(
num_eviù_kb
, 
bl
);

2069 
	`decode
(
num_´omÙe
, 
bl
);

2070 
	`decode
(
num_æush_mode_high
, 
bl
);

2071 
	`decode
(
num_æush_mode_low
, 
bl
);

2072 
	`decode
(
num_eviù_mode_some
, 
bl
);

2073 
	`decode
(
num_eviù_mode_fuÎ
, 
bl
);

2074 
	`decode
(
num_objeùs_pšÃd
, 
bl
);

2075 
	`decode
(
num_objeùs_missšg
, 
bl
);

2076 ià(
¡ruù_v
 >= 16) {

2077 
	`decode
(
num_Ëgacy_¢­£ts
, 
bl
);

2079 
num_Ëgacy_¢­£ts
 = 
num_objeù_şÚes
;

2081 ià(
¡ruù_v
 >= 17) {

2082 
	`decode
(
num_Ïrge_om­_objeùs
, 
bl
);

2084 ià(
¡ruù_v
 >= 18) {

2085 
	`decode
(
num_objeùs_mªiã¡
, 
bl
);

2088 
	`DECODE_FINISH
(
bl
);

2089 
	}
}

2091 
	gobjeù_¡©_sum_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
objeù_¡©_sum_t
*>& 
o
)

2093 
objeù_¡©_sum_t
 
a
;

2095 
	ga
.
	gnum_by‹s
 = 1;

2096 
	ga
.
	gnum_objeùs
 = 3;

2097 
	ga
.
	gnum_objeù_şÚes
 = 4;

2098 
	ga
.
	gnum_objeù_cİ›s
 = 5;

2099 
	ga
.
	gnum_objeùs_missšg_Ú_´im¬y
 = 6;

2100 
	ga
.
	gnum_objeùs_missšg
 = 123;

2101 
	ga
.
	gnum_objeùs_deg¿ded
 = 7;

2102 
	ga
.
	gnum_objeùs_unfound
 = 8;

2103 
	ga
.
	gnum_rd
 = 9;‡.
	gnum_rd_kb
 = 10;

2104 
	ga
.
	gnum_wr
 = 11;‡.
	gnum_wr_kb
 = 12;

2105 
	ga
.
	gnum_objeùs_»cov”ed
 = 14;

2106 
	ga
.
	gnum_by‹s_»cov”ed
 = 15;

2107 
	ga
.
	gnum_keys_»cov”ed
 = 16;

2108 
	ga
.
	gnum_d“p_süub_”rÜs
 = 17;

2109 
	ga
.
	gnum_sh®low_süub_”rÜs
 = 18;

2110 
	ga
.
	gnum_süub_”rÜs
 = 
a
.
num_d“p_süub_”rÜs
 +‡.
num_sh®low_süub_”rÜs
;

2111 
	ga
.
	gnum_objeùs_dœty
 = 21;

2112 
	ga
.
	gnum_wh™eouts
 = 22;

2113 
	ga
.
	gnum_objeùs_mi¥Ïûd
 = 1232;

2114 
	ga
.
	gnum_objeùs_h™_£t_¬chive
 = 2;

2115 
	ga
.
	gnum_by‹s_h™_£t_¬chive
 = 27;

2116 
	ga
.
	gnum_æush
 = 5;

2117 
	ga
.
	gnum_æush_kb
 = 6;

2118 
	ga
.
	gnum_eviù
 = 7;

2119 
	ga
.
	gnum_eviù_kb
 = 8;

2120 
	ga
.
	gnum_´omÙe
 = 9;

2121 
	ga
.
	gnum_æush_mode_high
 = 0;

2122 
	ga
.
	gnum_æush_mode_low
 = 1;

2123 
	ga
.
	gnum_eviù_mode_some
 = 1;

2124 
	ga
.
	gnum_eviù_mode_fuÎ
 = 0;

2125 
	ga
.
	gnum_objeùs_pšÃd
 = 20;

2126 
	ga
.
	gnum_Ïrge_om­_objeùs
 = 5;

2127 
	ga
.
	gnum_objeùs_mªiã¡
 = 2;

2128 
	go
.
push_back
(
Ãw
 
objeù_¡©_sum_t
(
a
));

2131 
	gobjeù_¡©_sum_t
::
	$add
(cÚ¡ 
objeù_¡©_sum_t
& 
o
)

2133 
num_by‹s
 +ğ
o
.num_bytes;

2134 
num_objeùs
 +ğ
o
.num_objects;

2135 
num_objeù_şÚes
 +ğ
o
.num_object_clones;

2136 
num_objeù_cİ›s
 +ğ
o
.num_object_copies;

2137 
num_objeùs_missšg_Ú_´im¬y
 +ğ
o
.num_objects_missing_on_primary;

2138 
num_objeùs_missšg
 +ğ
o
.num_objects_missing;

2139 
num_objeùs_deg¿ded
 +ğ
o
.num_objects_degraded;

2140 
num_objeùs_mi¥Ïûd
 +ğ
o
.num_objects_misplaced;

2141 
num_rd
 +ğ
o
.num_rd;

2142 
num_rd_kb
 +ğ
o
.num_rd_kb;

2143 
num_wr
 +ğ
o
.num_wr;

2144 
num_wr_kb
 +ğ
o
.num_wr_kb;

2145 
num_objeùs_unfound
 +ğ
o
.num_objects_unfound;

2146 
num_süub_”rÜs
 +ğ
o
.num_scrub_errors;

2147 
num_sh®low_süub_”rÜs
 +ğ
o
.num_shallow_scrub_errors;

2148 
num_d“p_süub_”rÜs
 +ğ
o
.num_deep_scrub_errors;

2149 
num_objeùs_»cov”ed
 +ğ
o
.num_objects_recovered;

2150 
num_by‹s_»cov”ed
 +ğ
o
.num_bytes_recovered;

2151 
num_keys_»cov”ed
 +ğ
o
.num_keys_recovered;

2152 
num_objeùs_dœty
 +ğ
o
.num_objects_dirty;

2153 
num_wh™eouts
 +ğ
o
.num_whiteouts;

2154 
num_objeùs_om­
 +ğ
o
.num_objects_omap;

2155 
num_objeùs_h™_£t_¬chive
 +ğ
o
.num_objects_hit_set_archive;

2156 
num_by‹s_h™_£t_¬chive
 +ğ
o
.num_bytes_hit_set_archive;

2157 
num_æush
 +ğ
o
.num_flush;

2158 
num_æush_kb
 +ğ
o
.num_flush_kb;

2159 
num_eviù
 +ğ
o
.num_evict;

2160 
num_eviù_kb
 +ğ
o
.num_evict_kb;

2161 
num_´omÙe
 +ğ
o
.num_promote;

2162 
num_æush_mode_high
 +ğ
o
.num_flush_mode_high;

2163 
num_æush_mode_low
 +ğ
o
.num_flush_mode_low;

2164 
num_eviù_mode_some
 +ğ
o
.num_evict_mode_some;

2165 
num_eviù_mode_fuÎ
 +ğ
o
.num_evict_mode_full;

2166 
num_objeùs_pšÃd
 +ğ
o
.num_objects_pinned;

2167 
num_Ëgacy_¢­£ts
 +ğ
o
.num_legacy_snapsets;

2168 
num_Ïrge_om­_objeùs
 +ğ
o
.num_large_omap_objects;

2169 
num_objeùs_mªiã¡
 +ğ
o
.num_objects_manifest;

2170 
	}
}

2172 
	gobjeù_¡©_sum_t
::
	$sub
(cÚ¡ 
objeù_¡©_sum_t
& 
o
)

2174 
num_by‹s
 -ğ
o
.num_bytes;

2175 
num_objeùs
 -ğ
o
.num_objects;

2176 
num_objeù_şÚes
 -ğ
o
.num_object_clones;

2177 
num_objeù_cİ›s
 -ğ
o
.num_object_copies;

2178 
num_objeùs_missšg_Ú_´im¬y
 -ğ
o
.num_objects_missing_on_primary;

2179 
num_objeùs_missšg
 -ğ
o
.num_objects_missing;

2180 
num_objeùs_deg¿ded
 -ğ
o
.num_objects_degraded;

2181 
num_objeùs_mi¥Ïûd
 -ğ
o
.num_objects_misplaced;

2182 
num_rd
 -ğ
o
.num_rd;

2183 
num_rd_kb
 -ğ
o
.num_rd_kb;

2184 
num_wr
 -ğ
o
.num_wr;

2185 
num_wr_kb
 -ğ
o
.num_wr_kb;

2186 
num_objeùs_unfound
 -ğ
o
.num_objects_unfound;

2187 
num_süub_”rÜs
 -ğ
o
.num_scrub_errors;

2188 
num_sh®low_süub_”rÜs
 -ğ
o
.num_shallow_scrub_errors;

2189 
num_d“p_süub_”rÜs
 -ğ
o
.num_deep_scrub_errors;

2190 
num_objeùs_»cov”ed
 -ğ
o
.num_objects_recovered;

2191 
num_by‹s_»cov”ed
 -ğ
o
.num_bytes_recovered;

2192 
num_keys_»cov”ed
 -ğ
o
.num_keys_recovered;

2193 
num_objeùs_dœty
 -ğ
o
.num_objects_dirty;

2194 
num_wh™eouts
 -ğ
o
.num_whiteouts;

2195 
num_objeùs_om­
 -ğ
o
.num_objects_omap;

2196 
num_objeùs_h™_£t_¬chive
 -ğ
o
.num_objects_hit_set_archive;

2197 
num_by‹s_h™_£t_¬chive
 -ğ
o
.num_bytes_hit_set_archive;

2198 
num_æush
 -ğ
o
.num_flush;

2199 
num_æush_kb
 -ğ
o
.num_flush_kb;

2200 
num_eviù
 -ğ
o
.num_evict;

2201 
num_eviù_kb
 -ğ
o
.num_evict_kb;

2202 
num_´omÙe
 -ğ
o
.num_promote;

2203 
num_æush_mode_high
 -ğ
o
.num_flush_mode_high;

2204 
num_æush_mode_low
 -ğ
o
.num_flush_mode_low;

2205 
num_eviù_mode_some
 -ğ
o
.num_evict_mode_some;

2206 
num_eviù_mode_fuÎ
 -ğ
o
.num_evict_mode_full;

2207 
num_objeùs_pšÃd
 -ğ
o
.num_objects_pinned;

2208 
num_Ëgacy_¢­£ts
 -ğ
o
.num_legacy_snapsets;

2209 
num_Ïrge_om­_objeùs
 -ğ
o
.num_large_omap_objects;

2210 
num_objeùs_mªiã¡
 -ğ
o
.num_objects_manifest;

2211 
	}
}

2213 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
objeù_¡©_sum_t
& 
l
, cÚ¡ 
	gobjeù_¡©_sum_t
& 
	gr
)

2216 
	gl
.
	gnum_by‹s
 =ğ
r
.
num_by‹s
 &&

2217 
l
.
num_objeùs
 =ğ
r
.num_objects &&

2218 
l
.
num_objeù_şÚes
 =ğ
r
.num_object_clones &&

2219 
l
.
num_objeù_cİ›s
 =ğ
r
.num_object_copies &&

2220 
l
.
num_objeùs_missšg_Ú_´im¬y
 =ğ
r
.num_objects_missing_on_primary &&

2221 
l
.
num_objeùs_missšg
 =ğ
r
.num_objects_missing &&

2222 
l
.
num_objeùs_deg¿ded
 =ğ
r
.num_objects_degraded &&

2223 
l
.
num_objeùs_mi¥Ïûd
 =ğ
r
.num_objects_misplaced &&

2224 
l
.
num_objeùs_unfound
 =ğ
r
.num_objects_unfound &&

2225 
l
.
num_rd
 =ğ
r
.num_rd &&

2226 
l
.
num_rd_kb
 =ğ
r
.num_rd_kb &&

2227 
l
.
num_wr
 =ğ
r
.num_wr &&

2228 
l
.
num_wr_kb
 =ğ
r
.num_wr_kb &&

2229 
l
.
num_süub_”rÜs
 =ğ
r
.num_scrub_errors &&

2230 
l
.
num_sh®low_süub_”rÜs
 =ğ
r
.num_shallow_scrub_errors &&

2231 
l
.
num_d“p_süub_”rÜs
 =ğ
r
.num_deep_scrub_errors &&

2232 
l
.
num_objeùs_»cov”ed
 =ğ
r
.num_objects_recovered &&

2233 
l
.
num_by‹s_»cov”ed
 =ğ
r
.num_bytes_recovered &&

2234 
l
.
num_keys_»cov”ed
 =ğ
r
.num_keys_recovered &&

2235 
l
.
num_objeùs_dœty
 =ğ
r
.num_objects_dirty &&

2236 
l
.
num_wh™eouts
 =ğ
r
.num_whiteouts &&

2237 
l
.
num_objeùs_om­
 =ğ
r
.num_objects_omap &&

2238 
l
.
num_objeùs_h™_£t_¬chive
 =ğ
r
.num_objects_hit_set_archive &&

2239 
l
.
num_by‹s_h™_£t_¬chive
 =ğ
r
.num_bytes_hit_set_archive &&

2240 
l
.
num_æush
 =ğ
r
.num_flush &&

2241 
l
.
num_æush_kb
 =ğ
r
.num_flush_kb &&

2242 
l
.
num_eviù
 =ğ
r
.num_evict &&

2243 
l
.
num_eviù_kb
 =ğ
r
.num_evict_kb &&

2244 
l
.
num_´omÙe
 =ğ
r
.num_promote &&

2245 
l
.
num_æush_mode_high
 =ğ
r
.num_flush_mode_high &&

2246 
l
.
num_æush_mode_low
 =ğ
r
.num_flush_mode_low &&

2247 
l
.
num_eviù_mode_some
 =ğ
r
.num_evict_mode_some &&

2248 
l
.
num_eviù_mode_fuÎ
 =ğ
r
.num_evict_mode_full &&

2249 
l
.
num_objeùs_pšÃd
 =ğ
r
.num_objects_pinned &&

2250 
l
.
num_Ëgacy_¢­£ts
 =ğ
r
.num_legacy_snapsets &&

2251 
l
.
num_Ïrge_om­_objeùs
 =ğ
r
.num_large_omap_objects &&

2252 
l
.
num_objeùs_mªiã¡
 =ğ
r
.num_objects_manifest;

2257 
	gobjeù_¡©_cŞËùiÚ_t
::
	$dump
(
FÜm©‹r
 *
f
) const

2259 
f
->
	`İ’_objeù_£ùiÚ
("stat_sum");

2260 
sum
.
	`dump
(
f
);

2261 
f
->
	`şo£_£ùiÚ
();

2262 
	}
}

2264 
	gobjeù_¡©_cŞËùiÚ_t
::
	$’code
(
bufã¾i¡
& 
bl
) const

2266 
	`ENCODE_START
(2, 2, 
bl
);

2267 
	`’code
(
sum
, 
bl
);

2268 
	`’code
((
__u32
)0, 
bl
);

2269 
	`ENCODE_FINISH
(
bl
);

2270 
	}
}

2272 
	gobjeù_¡©_cŞËùiÚ_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
)

2274 
	`DECODE_START_LEGACY_COMPAT_LEN
(2, 2, 2, 
bl
);

2275 
	`decode
(
sum
, 
bl
);

2277 
m­
<
¡ršg
,
objeù_¡©_sum_t
> 
ÿt_sum
;

2278 
	`decode
(
ÿt_sum
, 
bl
);

2280 
	`DECODE_FINISH
(
bl
);

2281 
	}
}

2283 
	gobjeù_¡©_cŞËùiÚ_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
objeù_¡©_cŞËùiÚ_t
*>& 
o
)

2285 
objeù_¡©_cŞËùiÚ_t
 
a
;

2286 
	go
.
push_back
(
Ãw
 
objeù_¡©_cŞËùiÚ_t
(
a
));

2287 
	gli¡
<
	gobjeù_¡©_sum_t
*> 
	gl
;

2288 
	gobjeù_¡©_sum_t
::
g’”©e_‹¡_š¡ªûs
(
l
);

2289 
	gli¡
<
	gobjeù_¡©_sum_t
*>::
™”©Ü
 
p
 = 
l
.
begš
(); 
	gp
 !ğl.
’d
(); ++p) {

2290 
	ga
.
add
(**
p
);

2291 
	go
.
push_back
(
Ãw
 
objeù_¡©_cŞËùiÚ_t
(
a
));

2298 
boŞ
 
	gpg_¡©_t
::
	$is_aùšg_osd
(
št32_t
 
osd
, 
boŞ
 
´im¬y
) const

2300 ià(
´im¬y
 && 
osd
 =ğ
aùšg_´im¬y
) {

2301  
Œue
;

2302 } ià(!
´im¬y
) {

2303 
veùÜ
<
št32_t
>::
cÚ¡_™”©Ü
 
™
 = 
aùšg
.
	`begš
();

2304 
™
 !ğ
aùšg
.
	`’d
(); ++it)

2306 ià(*
™
 =ğ
osd
)

2307  
Œue
;

2310  
çl£
;

2311 
	}
}

2313 
	gpg_¡©_t
::
	$dump
(
FÜm©‹r
 *
f
) const

2315 
f
->
	`dump_¡»am
("v”siÚ"è<< 
v”siÚ
;

2316 
f
->
	`dump_¡»am
("»pÜ‹d_£q"è<< 
»pÜ‹d_£q
;

2317 
f
->
	`dump_¡»am
("»pÜ‹d_•och"è<< 
»pÜ‹d_•och
;

2318 
f
->
	`dump_¡ršg
("¡©e", 
	`pg_¡©e_¡ršg
(
¡©e
));

2319 
f
->
	`dump_¡»am
("Ï¡_äesh"è<< 
Ï¡_äesh
;

2320 
f
->
	`dump_¡»am
("Ï¡_chªge"è<< 
Ï¡_chªge
;

2321 
f
->
	`dump_¡»am
("Ï¡_aùive"è<< 
Ï¡_aùive
;

2322 
f
->
	`dump_¡»am
("Ï¡_³”ed"è<< 
Ï¡_³”ed
;

2323 
f
->
	`dump_¡»am
("Ï¡_ş—n"è<< 
Ï¡_ş—n
;

2324 
f
->
	`dump_¡»am
("Ï¡_beÿme_aùive"è<< 
Ï¡_beÿme_aùive
;

2325 
f
->
	`dump_¡»am
("Ï¡_beÿme_³”ed"è<< 
Ï¡_beÿme_³”ed
;

2326 
f
->
	`dump_¡»am
("Ï¡_un¡®e"è<< 
Ï¡_un¡®e
;

2327 
f
->
	`dump_¡»am
("Ï¡_undeg¿ded"è<< 
Ï¡_undeg¿ded
;

2328 
f
->
	`dump_¡»am
("Ï¡_fuÎsized"è<< 
Ï¡_fuÎsized
;

2329 
f
->
	`dump_unsigÃd
("m­pšg_•och", 
m­pšg_•och
);

2330 
f
->
	`dump_¡»am
("log_¡¬t"è<< 
log_¡¬t
;

2331 
f
->
	`dump_¡»am
("Údisk_log_¡¬t"è<< 
Údisk_log_¡¬t
;

2332 
f
->
	`dump_unsigÃd
("ü—‹d", 
ü—‹d
);

2333 
f
->
	`dump_unsigÃd
("Ï¡_•och_ş—n", 
Ï¡_•och_ş—n
);

2334 
f
->
	`dump_¡»am
("·»Á"è<< 
·»Á
;

2335 
f
->
	`dump_unsigÃd
("·»Á_¥l™_b™s", 
·»Á_¥l™_b™s
);

2336 
f
->
	`dump_¡»am
("Ï¡_süub"è<< 
Ï¡_süub
;

2337 
f
->
	`dump_¡»am
("Ï¡_süub_¡amp"è<< 
Ï¡_süub_¡amp
;

2338 
f
->
	`dump_¡»am
("Ï¡_d“p_süub"è<< 
Ï¡_d“p_süub
;

2339 
f
->
	`dump_¡»am
("Ï¡_d“p_süub_¡amp"è<< 
Ï¡_d“p_süub_¡amp
;

2340 
f
->
	`dump_¡»am
("Ï¡_ş—n_süub_¡amp"è<< 
Ï¡_ş—n_süub_¡amp
;

2341 
f
->
	`dump_št
("log_size", 
log_size
);

2342 
f
->
	`dump_št
("Údisk_log_size", 
Údisk_log_size
);

2343 
f
->
	`dump_boŞ
("¡©s_šv®id", 
¡©s_šv®id
);

2344 
f
->
	`dump_boŞ
("dœty_¡©s_šv®id", 
dœty_¡©s_šv®id
);

2345 
f
->
	`dump_boŞ
("om­_¡©s_šv®id", 
om­_¡©s_šv®id
);

2346 
f
->
	`dump_boŞ
("h™£t_¡©s_šv®id", 
h™£t_¡©s_šv®id
);

2347 
f
->
	`dump_boŞ
("h™£t_by‹s_¡©s_šv®id", 
h™£t_by‹s_¡©s_šv®id
);

2348 
f
->
	`dump_boŞ
("pš_¡©s_šv®id", 
pš_¡©s_šv®id
);

2349 
f
->
	`dump_boŞ
("mªiã¡_¡©s_šv®id", 
mªiã¡_¡©s_šv®id
);

2350 
f
->
	`dump_unsigÃd
("¢­Œimq_Ën", 
¢­Œimq_Ën
);

2351 
¡©s
.
	`dump
(
f
);

2352 
f
->
	`İ’_¬¿y_£ùiÚ
("up");

2353 
veùÜ
<
št32_t
>::
cÚ¡_™”©Ü
 
p
 = 
up
.
	`begš
();… !ğup.
	`’d
(); ++p)

2354 
f
->
	`dump_št
("osd", *
p
);

2355 
f
->
	`şo£_£ùiÚ
();

2356 
f
->
	`İ’_¬¿y_£ùiÚ
("acting");

2357 
veùÜ
<
št32_t
>::
cÚ¡_™”©Ü
 
p
 = 
aùšg
.
	`begš
();… !ğaùšg.
	`’d
(); ++p)

2358 
f
->
	`dump_št
("osd", *
p
);

2359 
f
->
	`şo£_£ùiÚ
();

2360 
f
->
	`İ’_¬¿y_£ùiÚ
("blocked_by");

2361 
veùÜ
<
št32_t
>::
cÚ¡_™”©Ü
 
p
 = 
blocked_by
.
	`begš
();

2362 
p
 !ğ
blocked_by
.
	`’d
(); ++p)

2363 
f
->
	`dump_št
("osd", *
p
);

2364 
f
->
	`şo£_£ùiÚ
();

2365 
f
->
	`dump_št
("up_´im¬y", 
up_´im¬y
);

2366 
f
->
	`dump_št
("aùšg_´im¬y", 
aùšg_´im¬y
);

2367 
f
->
	`İ’_¬¿y_£ùiÚ
("purged_snaps");

2368 
š‹rv®_£t
<
¢­id_t
>::
cÚ¡_™”©Ü
 
i
 = 
purged_¢­s
.
	`begš
();

2369 
i
 !ğ
purged_¢­s
.
	`’d
();

2370 ++
i
) {

2371 
f
->
	`İ’_objeù_£ùiÚ
("interval");

2372 
f
->
	`dump_¡»am
("¡¬t"è<< 
i
.
	`g‘_¡¬t
();

2373 
f
->
	`dump_¡»am
("Ëngth"è<< 
i
.
	`g‘_Ën
();

2374 
f
->
	`şo£_£ùiÚ
();

2376 
f
->
	`şo£_£ùiÚ
();

2377 
	}
}

2379 
	gpg_¡©_t
::
	$dump_br›f
(
FÜm©‹r
 *
f
) const

2381 
f
->
	`dump_¡ršg
("¡©e", 
	`pg_¡©e_¡ršg
(
¡©e
));

2382 
f
->
	`İ’_¬¿y_£ùiÚ
("up");

2383 
veùÜ
<
št32_t
>::
cÚ¡_™”©Ü
 
p
 = 
up
.
	`begš
();… !ğup.
	`’d
(); ++p)

2384 
f
->
	`dump_št
("osd", *
p
);

2385 
f
->
	`şo£_£ùiÚ
();

2386 
f
->
	`İ’_¬¿y_£ùiÚ
("acting");

2387 
veùÜ
<
št32_t
>::
cÚ¡_™”©Ü
 
p
 = 
aùšg
.
	`begš
();… !ğaùšg.
	`’d
(); ++p)

2388 
f
->
	`dump_št
("osd", *
p
);

2389 
f
->
	`şo£_£ùiÚ
();

2390 
f
->
	`dump_št
("up_´im¬y", 
up_´im¬y
);

2391 
f
->
	`dump_št
("aùšg_´im¬y", 
aùšg_´im¬y
);

2392 
	}
}

2394 
	gpg_¡©_t
::
	$’code
(
bufã¾i¡
 &
bl
) const

2396 
	`ENCODE_START
(25, 22, 
bl
);

2397 
	`’code
(
v”siÚ
, 
bl
);

2398 
	`’code
(
»pÜ‹d_£q
, 
bl
);

2399 
	`’code
(
»pÜ‹d_•och
, 
bl
);

2400 
	`’code
((
__u32
)
¡©e
, 
bl
);

2401 
	`’code
(
log_¡¬t
, 
bl
);

2402 
	`’code
(
Údisk_log_¡¬t
, 
bl
);

2403 
	`’code
(
ü—‹d
, 
bl
);

2404 
	`’code
(
Ï¡_•och_ş—n
, 
bl
);

2405 
	`’code
(
·»Á
, 
bl
);

2406 
	`’code
(
·»Á_¥l™_b™s
, 
bl
);

2407 
	`’code
(
Ï¡_süub
, 
bl
);

2408 
	`’code
(
Ï¡_süub_¡amp
, 
bl
);

2409 
	`’code
(
¡©s
, 
bl
);

2410 
	`’code
(
log_size
, 
bl
);

2411 
	`’code
(
Údisk_log_size
, 
bl
);

2412 
	`’code
(
up
, 
bl
);

2413 
	`’code
(
aùšg
, 
bl
);

2414 
	`’code
(
Ï¡_äesh
, 
bl
);

2415 
	`’code
(
Ï¡_chªge
, 
bl
);

2416 
	`’code
(
Ï¡_aùive
, 
bl
);

2417 
	`’code
(
Ï¡_ş—n
, 
bl
);

2418 
	`’code
(
Ï¡_un¡®e
, 
bl
);

2419 
	`’code
(
m­pšg_•och
, 
bl
);

2420 
	`’code
(
Ï¡_d“p_süub
, 
bl
);

2421 
	`’code
(
Ï¡_d“p_süub_¡amp
, 
bl
);

2422 
	`’code
(
¡©s_šv®id
, 
bl
);

2423 
	`’code
(
Ï¡_ş—n_süub_¡amp
, 
bl
);

2424 
	`’code
(
Ï¡_beÿme_aùive
, 
bl
);

2425 
	`’code
(
dœty_¡©s_šv®id
, 
bl
);

2426 
	`’code
(
up_´im¬y
, 
bl
);

2427 
	`’code
(
aùšg_´im¬y
, 
bl
);

2428 
	`’code
(
om­_¡©s_šv®id
, 
bl
);

2429 
	`’code
(
h™£t_¡©s_šv®id
, 
bl
);

2430 
	`’code
(
blocked_by
, 
bl
);

2431 
	`’code
(
Ï¡_undeg¿ded
, 
bl
);

2432 
	`’code
(
Ï¡_fuÎsized
, 
bl
);

2433 
	`’code
(
h™£t_by‹s_¡©s_šv®id
, 
bl
);

2434 
	`’code
(
Ï¡_³”ed
, 
bl
);

2435 
	`’code
(
Ï¡_beÿme_³”ed
, 
bl
);

2436 
	`’code
(
pš_¡©s_šv®id
, 
bl
);

2437 
	`’code
(
¢­Œimq_Ën
, 
bl
);

2438 
__u32
 
tİ_¡©e
 = (
¡©e
 >> 32);

2439 
	`’code
(
tİ_¡©e
, 
bl
);

2440 
	`’code
(
purged_¢­s
, 
bl
);

2441 
	`’code
(
mªiã¡_¡©s_šv®id
, 
bl
);

2442 
	`ENCODE_FINISH
(
bl
);

2443 
	}
}

2445 
	gpg_¡©_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

2447 
boŞ
 
tmp
;

2448 
ušt32_t
 
Şd_¡©e
;

2449 
	`DECODE_START
(25, 
bl
);

2450 
	`decode
(
v”siÚ
, 
bl
);

2451 
	`decode
(
»pÜ‹d_£q
, 
bl
);

2452 
	`decode
(
»pÜ‹d_•och
, 
bl
);

2453 
	`decode
(
Şd_¡©e
, 
bl
);

2454 
	`decode
(
log_¡¬t
, 
bl
);

2455 
	`decode
(
Údisk_log_¡¬t
, 
bl
);

2456 
	`decode
(
ü—‹d
, 
bl
);

2457 
	`decode
(
Ï¡_•och_ş—n
, 
bl
);

2458 
	`decode
(
·»Á
, 
bl
);

2459 
	`decode
(
·»Á_¥l™_b™s
, 
bl
);

2460 
	`decode
(
Ï¡_süub
, 
bl
);

2461 
	`decode
(
Ï¡_süub_¡amp
, 
bl
);

2462 
	`decode
(
¡©s
, 
bl
);

2463 
	`decode
(
log_size
, 
bl
);

2464 
	`decode
(
Údisk_log_size
, 
bl
);

2465 
	`decode
(
up
, 
bl
);

2466 
	`decode
(
aùšg
, 
bl
);

2467 
	`decode
(
Ï¡_äesh
, 
bl
);

2468 
	`decode
(
Ï¡_chªge
, 
bl
);

2469 
	`decode
(
Ï¡_aùive
, 
bl
);

2470 
	`decode
(
Ï¡_ş—n
, 
bl
);

2471 
	`decode
(
Ï¡_un¡®e
, 
bl
);

2472 
	`decode
(
m­pšg_•och
, 
bl
);

2473 
	`decode
(
Ï¡_d“p_süub
, 
bl
);

2474 
	`decode
(
Ï¡_d“p_süub_¡amp
, 
bl
);

2475 
	`decode
(
tmp
, 
bl
);

2476 
¡©s_šv®id
 = 
tmp
;

2477 
	`decode
(
Ï¡_ş—n_süub_¡amp
, 
bl
);

2478 
	`decode
(
Ï¡_beÿme_aùive
, 
bl
);

2479 
	`decode
(
tmp
, 
bl
);

2480 
dœty_¡©s_šv®id
 = 
tmp
;

2481 
	`decode
(
up_´im¬y
, 
bl
);

2482 
	`decode
(
aùšg_´im¬y
, 
bl
);

2483 
	`decode
(
tmp
, 
bl
);

2484 
om­_¡©s_šv®id
 = 
tmp
;

2485 
	`decode
(
tmp
, 
bl
);

2486 
h™£t_¡©s_šv®id
 = 
tmp
;

2487 
	`decode
(
blocked_by
, 
bl
);

2488 
	`decode
(
Ï¡_undeg¿ded
, 
bl
);

2489 
	`decode
(
Ï¡_fuÎsized
, 
bl
);

2490 
	`decode
(
tmp
, 
bl
);

2491 
h™£t_by‹s_¡©s_šv®id
 = 
tmp
;

2492 
	`decode
(
Ï¡_³”ed
, 
bl
);

2493 
	`decode
(
Ï¡_beÿme_³”ed
, 
bl
);

2494 
	`decode
(
tmp
, 
bl
);

2495 
pš_¡©s_šv®id
 = 
tmp
;

2496 ià(
¡ruù_v
 >= 23) {

2497 
	`decode
(
¢­Œimq_Ën
, 
bl
);

2498 ià(
¡ruù_v
 >= 24) {

2499 
__u32
 
tİ_¡©e
;

2500 
	`decode
(
tİ_¡©e
, 
bl
);

2501 
¡©e
 = (
ušt64_t
)
Şd_¡©e
 | ((ušt64_t)
tİ_¡©e
 << 32);

2502 
	`decode
(
purged_¢­s
, 
bl
);

2504 
¡©e
 = 
Şd_¡©e
;

2506 ià(
¡ruù_v
 >= 25) {

2507 
	`decode
(
tmp
, 
bl
);

2508 
mªiã¡_¡©s_šv®id
 = 
tmp
;

2510 
mªiã¡_¡©s_šv®id
 = 
Œue
;

2513 
	`DECODE_FINISH
(
bl
);

2514 
	}
}

2516 
	gpg_¡©_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_¡©_t
*>& 
o
)

2518 
pg_¡©_t
 
a
;

2519 
	go
.
push_back
(
Ãw
 
pg_¡©_t
(
a
));

2521 
	ga
.
	gv”siÚ
 = 
ev”siÚ_t
(1, 3);

2522 
	ga
.
	g»pÜ‹d_•och
 = 1;

2523 
	ga
.
	g»pÜ‹d_£q
 = 2;

2524 
	ga
.
	g¡©e
 = 123;

2525 
	ga
.
	gm­pšg_•och
 = 998;

2526 
	ga
.
	gÏ¡_äesh
 = 
utime_t
(1002, 1);

2527 
	ga
.
	gÏ¡_chªge
 = 
utime_t
(1002, 2);

2528 
	ga
.
	gÏ¡_aùive
 = 
utime_t
(1002, 3);

2529 
	ga
.
	gÏ¡_ş—n
 = 
utime_t
(1002, 4);

2530 
	ga
.
	gÏ¡_un¡®e
 = 
utime_t
(1002, 5);

2531 
	ga
.
	gÏ¡_undeg¿ded
 = 
utime_t
(1002, 7);

2532 
	ga
.
	gÏ¡_fuÎsized
 = 
utime_t
(1002, 8);

2533 
	ga
.
	glog_¡¬t
 = 
ev”siÚ_t
(1, 4);

2534 
	ga
.
	gÚdisk_log_¡¬t
 = 
ev”siÚ_t
(1, 5);

2535 
	ga
.
	gü—‹d
 = 6;

2536 
	ga
.
	gÏ¡_•och_ş—n
 = 7;

2537 
	ga
.
	g·»Á
 = 
pg_t
(1, 2);

2538 
	ga
.
	g·»Á_¥l™_b™s
 = 12;

2539 
	ga
.
	gÏ¡_süub
 = 
ev”siÚ_t
(9, 10);

2540 
	ga
.
	gÏ¡_süub_¡amp
 = 
utime_t
(11, 12);

2541 
	ga
.
	gÏ¡_d“p_süub
 = 
ev”siÚ_t
(13, 14);

2542 
	ga
.
	gÏ¡_d“p_süub_¡amp
 = 
utime_t
(15, 16);

2543 
	ga
.
	gÏ¡_ş—n_süub_¡amp
 = 
utime_t
(17, 18);

2544 
	ga
.
	g¢­Œimq_Ën
 = 1048576;

2545 
	gli¡
<
	gobjeù_¡©_cŞËùiÚ_t
*> 
	gl
;

2546 
	gobjeù_¡©_cŞËùiÚ_t
::
g’”©e_‹¡_š¡ªûs
(
l
);

2547 
	ga
.
	g¡©s
 = *
l
.
back
();

2548 
	ga
.
	glog_size
 = 99;

2549 
	ga
.
	gÚdisk_log_size
 = 88;

2550 
	ga
.
	gup
.
push_back
(123);

2551 
	ga
.
	gup_´im¬y
 = 123;

2552 
	ga
.
	gaùšg
.
push_back
(456);

2553 
	ga
.
	gaùšg_´im¬y
 = 456;

2554 
	go
.
push_back
(
Ãw
 
pg_¡©_t
(
a
));

2556 
	ga
.
	gup
.
push_back
(124);

2557 
	ga
.
	gup_´im¬y
 = 124;

2558 
	ga
.
	gaùšg
.
push_back
(124);

2559 
	ga
.
	gaùšg_´im¬y
 = 124;

2560 
	ga
.
	gblocked_by
.
push_back
(155);

2561 
	ga
.
	gblocked_by
.
push_back
(156);

2562 
	go
.
push_back
(
Ãw
 
pg_¡©_t
(
a
));

2565 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
pg_¡©_t
& 
l
, cÚ¡ 
	gpg_¡©_t
& 
	gr
)

2568 
	gl
.
	gv”siÚ
 =ğ
r
.
v”siÚ
 &&

2569 
l
.
»pÜ‹d_£q
 =ğ
r
.reported_seq &&

2570 
l
.
»pÜ‹d_•och
 =ğ
r
.reported_epoch &&

2571 
l
.
¡©e
 =ğ
r
.state &&

2572 
l
.
Ï¡_äesh
 =ğ
r
.last_fresh &&

2573 
l
.
Ï¡_chªge
 =ğ
r
.last_change &&

2574 
l
.
Ï¡_aùive
 =ğ
r
.last_active &&

2575 
l
.
Ï¡_³”ed
 =ğ
r
.last_peered &&

2576 
l
.
Ï¡_ş—n
 =ğ
r
.last_clean &&

2577 
l
.
Ï¡_un¡®e
 =ğ
r
.last_unstale &&

2578 
l
.
Ï¡_undeg¿ded
 =ğ
r
.last_undegraded &&

2579 
l
.
Ï¡_fuÎsized
 =ğ
r
.last_fullsized &&

2580 
l
.
log_¡¬t
 =ğ
r
.log_start &&

2581 
l
.
Údisk_log_¡¬t
 =ğ
r
.ondisk_log_start &&

2582 
l
.
ü—‹d
 =ğ
r
.created &&

2583 
l
.
Ï¡_•och_ş—n
 =ğ
r
.last_epoch_clean &&

2584 
l
.
·»Á
 =ğ
r
.parent &&

2585 
l
.
·»Á_¥l™_b™s
 =ğ
r
.parent_split_bits &&

2586 
l
.
Ï¡_süub
 =ğ
r
.last_scrub &&

2587 
l
.
Ï¡_d“p_süub
 =ğ
r
.last_deep_scrub &&

2588 
l
.
Ï¡_süub_¡amp
 =ğ
r
.last_scrub_stamp &&

2589 
l
.
Ï¡_d“p_süub_¡amp
 =ğ
r
.last_deep_scrub_stamp &&

2590 
l
.
Ï¡_ş—n_süub_¡amp
 =ğ
r
.last_clean_scrub_stamp &&

2591 
l
.
¡©s
 =ğ
r
.stats &&

2592 
l
.
¡©s_šv®id
 =ğ
r
.stats_invalid &&

2593 
l
.
log_size
 =ğ
r
.log_size &&

2594 
l
.
Údisk_log_size
 =ğ
r
.ondisk_log_size &&

2595 
l
.
up
 =ğ
r
.up &&

2596 
l
.
aùšg
 =ğ
r
.acting &&

2597 
l
.
m­pšg_•och
 =ğ
r
.mapping_epoch &&

2598 
l
.
blocked_by
 =ğ
r
.blocked_by &&

2599 
l
.
Ï¡_beÿme_aùive
 =ğ
r
.last_became_active &&

2600 
l
.
Ï¡_beÿme_³”ed
 =ğ
r
.last_became_peered &&

2601 
l
.
dœty_¡©s_šv®id
 =ğ
r
.dirty_stats_invalid &&

2602 
l
.
om­_¡©s_šv®id
 =ğ
r
.omap_stats_invalid &&

2603 
l
.
h™£t_¡©s_šv®id
 =ğ
r
.hitset_stats_invalid &&

2604 
l
.
h™£t_by‹s_¡©s_šv®id
 =ğ
r
.hitset_bytes_stats_invalid &&

2605 
l
.
up_´im¬y
 =ğ
r
.up_primary &&

2606 
l
.
aùšg_´im¬y
 =ğ
r
.acting_primary &&

2607 
l
.
pš_¡©s_šv®id
 =ğ
r
.pin_stats_invalid &&

2608 
l
.
mªiã¡_¡©s_šv®id
 =ğ
r
.manifest_stats_invalid &&

2609 
l
.
purged_¢­s
 =ğ
r
.purged_snaps &&

2610 
l
.
¢­Œimq_Ën
 =ğ
r
.snaptrimq_len;

2615 
	gpoŞ_¡©_t
::
	$dump
(
FÜm©‹r
 *
f
) const

2617 
¡©s
.
	`dump
(
f
);

2618 
f
->
	`dump_št
("log_size", 
log_size
);

2619 
f
->
	`dump_št
("Údisk_log_size", 
Údisk_log_size
);

2620 
f
->
	`dump_št
("up", 
up
);

2621 
f
->
	`dump_št
("aùšg", 
aùšg
);

2622 
	}
}

2624 
	gpoŞ_¡©_t
::
	$’code
(
bufã¾i¡
 &
bl
, 
ušt64_t
 
ã©u»s
) const

2626 
usšg
 
ûph
::
’code
;

2627 ià((
ã©u»s
 & 
CEPH_FEATURE_OSDENC
) == 0) {

2628 
__u8
 
v
 = 4;

2629 
	`’code
(
v
, 
bl
);

2630 
	`’code
(
¡©s
, 
bl
);

2631 
	`’code
(
log_size
, 
bl
);

2632 
	`’code
(
Údisk_log_size
, 
bl
);

2636 
	`ENCODE_START
(6, 5, 
bl
);

2637 
	`’code
(
¡©s
, 
bl
);

2638 
	`’code
(
log_size
, 
bl
);

2639 
	`’code
(
Údisk_log_size
, 
bl
);

2640 
	`’code
(
up
, 
bl
);

2641 
	`’code
(
aùšg
, 
bl
);

2642 
	`ENCODE_FINISH
(
bl
);

2643 
	}
}

2645 
	gpoŞ_¡©_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

2647 
	`DECODE_START_LEGACY_COMPAT_LEN
(6, 5, 5, 
bl
);

2648 ià(
¡ruù_v
 >= 4) {

2649 
	`decode
(
¡©s
, 
bl
);

2650 
	`decode
(
log_size
, 
bl
);

2651 
	`decode
(
Údisk_log_size
, 
bl
);

2652 ià(
¡ruù_v
 >= 6) {

2653 
	`decode
(
up
, 
bl
);

2654 
	`decode
(
aùšg
, 
bl
);

2656 
up
 = 0;

2657 
aùšg
 = 0;

2660 
	`decode
(
¡©s
.
sum
.
num_by‹s
, 
bl
);

2661 
ušt64_t
 
num_kb
;

2662 
	`decode
(
num_kb
, 
bl
);

2663 
	`decode
(
¡©s
.
sum
.
num_objeùs
, 
bl
);

2664 
	`decode
(
¡©s
.
sum
.
num_objeù_şÚes
, 
bl
);

2665 
	`decode
(
¡©s
.
sum
.
num_objeù_cİ›s
, 
bl
);

2666 
	`decode
(
¡©s
.
sum
.
num_objeùs_missšg_Ú_´im¬y
, 
bl
);

2667 
	`decode
(
¡©s
.
sum
.
num_objeùs_deg¿ded
, 
bl
);

2668 
	`decode
(
log_size
, 
bl
);

2669 
	`decode
(
Údisk_log_size
, 
bl
);

2670 ià(
¡ruù_v
 >= 2) {

2671 
	`decode
(
¡©s
.
sum
.
num_rd
, 
bl
);

2672 
	`decode
(
¡©s
.
sum
.
num_rd_kb
, 
bl
);

2673 
	`decode
(
¡©s
.
sum
.
num_wr
, 
bl
);

2674 
	`decode
(
¡©s
.
sum
.
num_wr_kb
, 
bl
);

2676 ià(
¡ruù_v
 >= 3) {

2677 
	`decode
(
¡©s
.
sum
.
num_objeùs_unfound
, 
bl
);

2680 
	`DECODE_FINISH
(
bl
);

2681 
	}
}

2683 
	gpoŞ_¡©_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
poŞ_¡©_t
*>& 
o
)

2685 
poŞ_¡©_t
 
a
;

2686 
	go
.
push_back
(
Ãw
 
poŞ_¡©_t
(
a
));

2688 
	gli¡
<
	gobjeù_¡©_cŞËùiÚ_t
*> 
	gl
;

2689 
	gobjeù_¡©_cŞËùiÚ_t
::
g’”©e_‹¡_š¡ªûs
(
l
);

2690 
	ga
.
	g¡©s
 = *
l
.
back
();

2691 
	ga
.
	glog_size
 = 123;

2692 
	ga
.
	gÚdisk_log_size
 = 456;

2693 
	ga
.
	gaùšg
 = 3;

2694 
	ga
.
	gup
 = 4;

2695 
	go
.
push_back
(
Ãw
 
poŞ_¡©_t
(
a
));

2701 
	gpg_hi¡Üy_t
::
	$’code
(
bufã¾i¡
 &
bl
) const

2703 
	`ENCODE_START
(9, 4, 
bl
);

2704 
	`’code
(
•och_ü—‹d
, 
bl
);

2705 
	`’code
(
Ï¡_•och_¡¬‹d
, 
bl
);

2706 
	`’code
(
Ï¡_•och_ş—n
, 
bl
);

2707 
	`’code
(
Ï¡_•och_¥l™
, 
bl
);

2708 
	`’code
(
§me_š‹rv®_sšû
, 
bl
);

2709 
	`’code
(
§me_up_sšû
, 
bl
);

2710 
	`’code
(
§me_´im¬y_sšû
, 
bl
);

2711 
	`’code
(
Ï¡_süub
, 
bl
);

2712 
	`’code
(
Ï¡_süub_¡amp
, 
bl
);

2713 
	`’code
(
Ï¡_d“p_süub
, 
bl
);

2714 
	`’code
(
Ï¡_d“p_süub_¡amp
, 
bl
);

2715 
	`’code
(
Ï¡_ş—n_süub_¡amp
, 
bl
);

2716 
	`’code
(
Ï¡_•och_m¬ked_fuÎ
, 
bl
);

2717 
	`’code
(
Ï¡_š‹rv®_¡¬‹d
, 
bl
);

2718 
	`’code
(
Ï¡_š‹rv®_ş—n
, 
bl
);

2719 
	`’code
(
•och_poŞ_ü—‹d
, 
bl
);

2720 
	`ENCODE_FINISH
(
bl
);

2721 
	}
}

2723 
	gpg_hi¡Üy_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

2725 
	`DECODE_START_LEGACY_COMPAT_LEN
(9, 4, 4, 
bl
);

2726 
	`decode
(
•och_ü—‹d
, 
bl
);

2727 
	`decode
(
Ï¡_•och_¡¬‹d
, 
bl
);

2728 ià(
¡ruù_v
 >= 3)

2729 
	`decode
(
Ï¡_•och_ş—n
, 
bl
);

2731 
Ï¡_•och_ş—n
 = 
Ï¡_•och_¡¬‹d
;

2732 
	`decode
(
Ï¡_•och_¥l™
, 
bl
);

2733 
	`decode
(
§me_š‹rv®_sšû
, 
bl
);

2734 
	`decode
(
§me_up_sšû
, 
bl
);

2735 
	`decode
(
§me_´im¬y_sšû
, 
bl
);

2736 ià(
¡ruù_v
 >= 2) {

2737 
	`decode
(
Ï¡_süub
, 
bl
);

2738 
	`decode
(
Ï¡_süub_¡amp
, 
bl
);

2740 ià(
¡ruù_v
 >= 5) {

2741 
	`decode
(
Ï¡_d“p_süub
, 
bl
);

2742 
	`decode
(
Ï¡_d“p_süub_¡amp
, 
bl
);

2744 ià(
¡ruù_v
 >= 6) {

2745 
	`decode
(
Ï¡_ş—n_süub_¡amp
, 
bl
);

2747 ià(
¡ruù_v
 >= 7) {

2748 
	`decode
(
Ï¡_•och_m¬ked_fuÎ
, 
bl
);

2750 ià(
¡ruù_v
 >= 8) {

2751 
	`decode
(
Ï¡_š‹rv®_¡¬‹d
, 
bl
);

2752 
	`decode
(
Ï¡_š‹rv®_ş—n
, 
bl
);

2754 ià(
Ï¡_•och_¡¬‹d
 >ğ
§me_š‹rv®_sšû
) {

2755 
Ï¡_š‹rv®_¡¬‹d
 = 
§me_š‹rv®_sšû
;

2757 
Ï¡_š‹rv®_¡¬‹d
 = 
Ï¡_•och_¡¬‹d
;

2759 ià(
Ï¡_•och_ş—n
 >ğ
§me_š‹rv®_sšû
) {

2760 
Ï¡_š‹rv®_ş—n
 = 
§me_š‹rv®_sšû
;

2762 
Ï¡_š‹rv®_ş—n
 = 
Ï¡_•och_ş—n
;

2765 ià(
¡ruù_v
 >= 9) {

2766 
	`decode
(
•och_poŞ_ü—‹d
, 
bl
);

2768 
•och_poŞ_ü—‹d
 = 
•och_ü—‹d
;

2770 
	`DECODE_FINISH
(
bl
);

2771 
	}
}

2773 
	gpg_hi¡Üy_t
::
	$dump
(
FÜm©‹r
 *
f
) const

2775 
f
->
	`dump_št
("•och_ü—‹d", 
•och_ü—‹d
);

2776 
f
->
	`dump_št
("•och_poŞ_ü—‹d", 
•och_poŞ_ü—‹d
);

2777 
f
->
	`dump_št
("Ï¡_•och_¡¬‹d", 
Ï¡_•och_¡¬‹d
);

2778 
f
->
	`dump_št
("Ï¡_š‹rv®_¡¬‹d", 
Ï¡_š‹rv®_¡¬‹d
);

2779 
f
->
	`dump_št
("Ï¡_•och_ş—n", 
Ï¡_•och_ş—n
);

2780 
f
->
	`dump_št
("Ï¡_š‹rv®_ş—n", 
Ï¡_š‹rv®_ş—n
);

2781 
f
->
	`dump_št
("Ï¡_•och_¥l™", 
Ï¡_•och_¥l™
);

2782 
f
->
	`dump_št
("Ï¡_•och_m¬ked_fuÎ", 
Ï¡_•och_m¬ked_fuÎ
);

2783 
f
->
	`dump_št
("§me_up_sšû", 
§me_up_sšû
);

2784 
f
->
	`dump_št
("§me_š‹rv®_sšû", 
§me_š‹rv®_sšû
);

2785 
f
->
	`dump_št
("§me_´im¬y_sšû", 
§me_´im¬y_sšû
);

2786 
f
->
	`dump_¡»am
("Ï¡_süub"è<< 
Ï¡_süub
;

2787 
f
->
	`dump_¡»am
("Ï¡_süub_¡amp"è<< 
Ï¡_süub_¡amp
;

2788 
f
->
	`dump_¡»am
("Ï¡_d“p_süub"è<< 
Ï¡_d“p_süub
;

2789 
f
->
	`dump_¡»am
("Ï¡_d“p_süub_¡amp"è<< 
Ï¡_d“p_süub_¡amp
;

2790 
f
->
	`dump_¡»am
("Ï¡_ş—n_süub_¡amp"è<< 
Ï¡_ş—n_süub_¡amp
;

2791 
	}
}

2793 
	gpg_hi¡Üy_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_hi¡Üy_t
*>& 
o
)

2795 
o
.
push_back
(
Ãw
 
pg_hi¡Üy_t
);

2796 
	go
.
push_back
(
Ãw
 
pg_hi¡Üy_t
);

2797 
	go
.
back
()->
	g•och_ü—‹d
 = 1;

2798 
	go
.
back
()->
	g•och_poŞ_ü—‹d
 = 1;

2799 
	go
.
back
()->
	gÏ¡_•och_¡¬‹d
 = 2;

2800 
	go
.
back
()->
	gÏ¡_š‹rv®_¡¬‹d
 = 2;

2801 
	go
.
back
()->
	gÏ¡_•och_ş—n
 = 3;

2802 
	go
.
back
()->
	gÏ¡_š‹rv®_ş—n
 = 2;

2803 
	go
.
back
()->
	gÏ¡_•och_¥l™
 = 4;

2804 
	go
.
back
()->
	g§me_up_sšû
 = 5;

2805 
	go
.
back
()->
	g§me_š‹rv®_sšû
 = 6;

2806 
	go
.
back
()->
	g§me_´im¬y_sšû
 = 7;

2807 
	go
.
back
()->
	gÏ¡_süub
 = 
ev”siÚ_t
(8, 9);

2808 
	go
.
back
()->
	gÏ¡_süub_¡amp
 = 
utime_t
(10, 11);

2809 
	go
.
back
()->
	gÏ¡_d“p_süub
 = 
ev”siÚ_t
(12, 13);

2810 
	go
.
back
()->
	gÏ¡_d“p_süub_¡amp
 = 
utime_t
(14, 15);

2811 
	go
.
back
()->
	gÏ¡_ş—n_süub_¡amp
 = 
utime_t
(16, 17);

2812 
	go
.
back
()->
	gÏ¡_•och_m¬ked_fuÎ
 = 18;

2818 
	gpg_šfo_t
::
	$’code
(
bufã¾i¡
 &
bl
) const

2820 
	`ENCODE_START
(32, 26, 
bl
);

2821 
	`’code
(
pgid
.pgid, 
bl
);

2822 
	`’code
(
Ï¡_upd©e
, 
bl
);

2823 
	`’code
(
Ï¡_com¶‘e
, 
bl
);

2824 
	`’code
(
log_
, 
bl
);

2825 ià(
Ï¡_backfl_b™wi£
 && !
Ï¡_backfl
.
	`is_max
()) {

2826 
	`’code
(
	`hobjeù_t
(), 
bl
);

2828 
	`’code
(
Ï¡_backfl
, 
bl
);

2830 
	`’code
(
¡©s
, 
bl
);

2831 
hi¡Üy
.
	`’code
(
bl
);

2832 
	`’code
(
purged_¢­s
, 
bl
);

2833 
	`’code
(
Ï¡_•och_¡¬‹d
, 
bl
);

2834 
	`’code
(
Ï¡_u£r_v”siÚ
, 
bl
);

2835 
	`’code
(
h™_£t
, 
bl
);

2836 
	`’code
(
pgid
.
sh¬d
, 
bl
);

2837 
	`’code
(
Ï¡_backfl
, 
bl
);

2838 
	`’code
(
Ï¡_backfl_b™wi£
, 
bl
);

2839 
	`’code
(
Ï¡_š‹rv®_¡¬‹d
, 
bl
);

2840 
	`ENCODE_FINISH
(
bl
);

2841 
	}
}

2843 
	gpg_šfo_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

2845 
	`DECODE_START
(32, 
bl
);

2846 
	`decode
(
pgid
.pgid, 
bl
);

2847 
	`decode
(
Ï¡_upd©e
, 
bl
);

2848 
	`decode
(
Ï¡_com¶‘e
, 
bl
);

2849 
	`decode
(
log_
, 
bl
);

2851 
hobjeù_t
 
Şd_Ï¡_backfl
;

2852 
	`decode
(
Şd_Ï¡_backfl
, 
bl
);

2854 
	`decode
(
¡©s
, 
bl
);

2855 
hi¡Üy
.
	`decode
(
bl
);

2856 
	`decode
(
purged_¢­s
, 
bl
);

2857 
	`decode
(
Ï¡_•och_¡¬‹d
, 
bl
);

2858 
	`decode
(
Ï¡_u£r_v”siÚ
, 
bl
);

2859 
	`decode
(
h™_£t
, 
bl
);

2860 
	`decode
(
pgid
.
sh¬d
, 
bl
);

2861 
	`decode
(
Ï¡_backfl
, 
bl
);

2862 
	`decode
(
Ï¡_backfl_b™wi£
, 
bl
);

2863 ià(
¡ruù_v
 >= 32) {

2864 
	`decode
(
Ï¡_š‹rv®_¡¬‹d
, 
bl
);

2866 
Ï¡_š‹rv®_¡¬‹d
 = 
Ï¡_•och_¡¬‹d
;

2868 
	`DECODE_FINISH
(
bl
);

2869 
	}
}

2873 
	gpg_šfo_t
::
	$dump
(
FÜm©‹r
 *
f
) const

2875 
f
->
	`dump_¡»am
("pgid"è<< 
pgid
;

2876 
f
->
	`dump_¡»am
("Ï¡_upd©e"è<< 
Ï¡_upd©e
;

2877 
f
->
	`dump_¡»am
("Ï¡_com¶‘e"è<< 
Ï¡_com¶‘e
;

2878 
f
->
	`dump_¡»am
("log_"è<< 
log_
;

2879 
f
->
	`dump_št
("Ï¡_u£r_v”siÚ", 
Ï¡_u£r_v”siÚ
);

2880 
f
->
	`dump_¡»am
("Ï¡_backfl"è<< 
Ï¡_backfl
;

2881 
f
->
	`dump_št
("Ï¡_backfl_b™wi£", ()
Ï¡_backfl_b™wi£
);

2882 
f
->
	`İ’_¬¿y_£ùiÚ
("purged_snaps");

2883 
š‹rv®_£t
<
¢­id_t
>::
cÚ¡_™”©Ü
 
i
=
purged_¢­s
.
	`begš
();

2884 
i
 !ğ
purged_¢­s
.
	`’d
();

2885 ++
i
) {

2886 
f
->
	`İ’_objeù_£ùiÚ
("purged_snap_interval");

2887 
f
->
	`dump_¡»am
("¡¬t"è<< 
i
.
	`g‘_¡¬t
();

2888 
f
->
	`dump_¡»am
("Ëngth"è<< 
i
.
	`g‘_Ën
();

2889 
f
->
	`şo£_£ùiÚ
();

2891 
f
->
	`şo£_£ùiÚ
();

2892 
f
->
	`İ’_objeù_£ùiÚ
("history");

2893 
hi¡Üy
.
	`dump
(
f
);

2894 
f
->
	`şo£_£ùiÚ
();

2895 
f
->
	`İ’_objeù_£ùiÚ
("stats");

2896 
¡©s
.
	`dump
(
f
);

2897 
f
->
	`şo£_£ùiÚ
();

2899 
f
->
	`dump_št
("em±y", 
	`is_em±y
());

2900 
f
->
	`dump_št
("dÃ", 
	`dÃ
());

2901 
f
->
	`dump_št
("šcom¶‘e", 
	`is_šcom¶‘e
());

2902 
f
->
	`dump_št
("Ï¡_•och_¡¬‹d", 
Ï¡_•och_¡¬‹d
);

2904 
f
->
	`İ’_objeù_£ùiÚ
("hit_set_history");

2905 
h™_£t
.
	`dump
(
f
);

2906 
f
->
	`şo£_£ùiÚ
();

2907 
	}
}

2909 
	gpg_šfo_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_šfo_t
*>& 
o
)

2911 
o
.
push_back
(
Ãw
 
pg_šfo_t
);

2912 
	go
.
push_back
(
Ãw
 
pg_šfo_t
);

2913 
	gli¡
<
	gpg_hi¡Üy_t
*> 
	gh
;

2914 
	gpg_hi¡Üy_t
::
g’”©e_‹¡_š¡ªûs
(
h
);

2915 
	go
.
back
()->
	ghi¡Üy
 = *
h
.back();

2916 
	go
.
back
()->
	gpgid
 = 
¥g_t
(
pg_t
(1, 2), 
sh¬d_id_t
::
NO_SHARD
);

2917 
	go
.
back
()->
	gÏ¡_upd©e
 = 
ev”siÚ_t
(3, 4);

2918 
	go
.
back
()->
	gÏ¡_com¶‘e
 = 
ev”siÚ_t
(5, 6);

2919 
	go
.
back
()->
	gÏ¡_u£r_v”siÚ
 = 2;

2920 
	go
.
back
()->
	glog_
 = 
ev”siÚ_t
(7, 8);

2921 
	go
.
back
()->
	gÏ¡_backfl
 = 
hobjeù_t
(
objeù_t
("objname"), "key", 123, 456, -1, "");

2922 
	go
.
back
()->
	gÏ¡_backfl_b™wi£
 = 
Œue
;

2924 
	gli¡
<
	gpg_¡©_t
*> 
	gs
;

2925 
	gpg_¡©_t
::
g’”©e_‹¡_š¡ªûs
(
s
);

2926 
	go
.
back
()->
	g¡©s
 = *
s
.back();

2929 
	gli¡
<
	gpg_h™_£t_hi¡Üy_t
*> 
	gs
;

2930 
	gpg_h™_£t_hi¡Üy_t
::
g’”©e_‹¡_š¡ªûs
(
s
);

2931 
	go
.
back
()->
	gh™_£t
 = *
s
.back();

2936 
	gpg_nÙify_t
::
	$’code
(
bufã¾i¡
 &
bl
) const

2938 
	`ENCODE_START
(2, 2, 
bl
);

2939 
	`’code
(
qu”y_•och
, 
bl
);

2940 
	`’code
(
•och_£Á
, 
bl
);

2941 
	`’code
(
šfo
, 
bl
);

2942 
	`’code
(
to
, 
bl
);

2943 
	`’code
(
äom
, 
bl
);

2944 
	`ENCODE_FINISH
(
bl
);

2945 
	}
}

2947 
	gpg_nÙify_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

2949 
	`DECODE_START
(2, 
bl
);

2950 
	`decode
(
qu”y_•och
, 
bl
);

2951 
	`decode
(
•och_£Á
, 
bl
);

2952 
	`decode
(
šfo
, 
bl
);

2953 
	`decode
(
to
, 
bl
);

2954 
	`decode
(
äom
, 
bl
);

2955 
	`DECODE_FINISH
(
bl
);

2956 
	}
}

2958 
	gpg_nÙify_t
::
	$dump
(
FÜm©‹r
 *
f
) const

2960 
f
->
	`dump_št
("äom", 
äom
);

2961 
f
->
	`dump_št
("to", 
to
);

2962 
f
->
	`dump_unsigÃd
("qu”y_•och", 
qu”y_•och
);

2963 
f
->
	`dump_unsigÃd
("•och_£Á", 
•och_£Á
);

2965 
f
->
	`İ’_objeù_£ùiÚ
("info");

2966 
šfo
.
	`dump
(
f
);

2967 
f
->
	`şo£_£ùiÚ
();

2969 
	}
}

2971 
	gpg_nÙify_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_nÙify_t
*>& 
o
)

2973 
o
.
push_back
(
Ãw
 
pg_nÙify_t
(
sh¬d_id_t
(3), sh¬d_id_t::
NO_SHARD
, 1, 1, 
pg_šfo_t
()));

2974 
	go
.
push_back
(
Ãw
 
pg_nÙify_t
(
sh¬d_id_t
(0), sh¬d_id_t(0), 3, 10, 
pg_šfo_t
()));

2977 
	go¡»am
 &
	gİ”©Ü
<<(o¡»am &
	glhs
, cÚ¡ 
	gpg_nÙify_t
 &
	gnÙify
)

2979 
	glhs
 << "(qu”y:" << 
	gnÙify
.
	gqu”y_•och


2980 << " s’t:" << 
	gnÙify
.
	g•och_£Á


2981 << " " << 
	gnÙify
.
	gšfo
;

2982 ià(
	gnÙify
.
	gäom
 !ğ
sh¬d_id_t
::
NO_SHARD
 ||

2983 
nÙify
.
to
 !ğ
sh¬d_id_t
::
NO_SHARD
)

2984 
lhs
 << " " << ()
nÙify
.
äom


2985 << "->" << ()
nÙify
.
to
;

2986  
	glhs
 << ")";

2991 
	gPa¡IÁ”v®s
::
pg_š‹rv®_t
::
	$’code
(
bufã¾i¡
& 
bl
) const

2993 
	`ENCODE_START
(4, 2, 
bl
);

2994 
	`’code
(
fœ¡
, 
bl
);

2995 
	`’code
(
Ï¡
, 
bl
);

2996 
	`’code
(
up
, 
bl
);

2997 
	`’code
(
aùšg
, 
bl
);

2998 
	`’code
(
maybe_w’t_rw
, 
bl
);

2999 
	`’code
(
´im¬y
, 
bl
);

3000 
	`’code
(
up_´im¬y
, 
bl
);

3001 
	`ENCODE_FINISH
(
bl
);

3002 
	}
}

3004 
	gPa¡IÁ”v®s
::
pg_š‹rv®_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
)

3006 
	`DECODE_START_LEGACY_COMPAT_LEN
(4, 2, 2, 
bl
);

3007 
	`decode
(
fœ¡
, 
bl
);

3008 
	`decode
(
Ï¡
, 
bl
);

3009 
	`decode
(
up
, 
bl
);

3010 
	`decode
(
aùšg
, 
bl
);

3011 
	`decode
(
maybe_w’t_rw
, 
bl
);

3012 ià(
¡ruù_v
 >= 3) {

3013 
	`decode
(
´im¬y
, 
bl
);

3015 ià(
aùšg
.
	`size
())

3016 
´im¬y
 = 
aùšg
[0];

3018 ià(
¡ruù_v
 >= 4) {

3019 
	`decode
(
up_´im¬y
, 
bl
);

3021 ià(
up
.
	`size
())

3022 
up_´im¬y
 = 
up
[0];

3024 
	`DECODE_FINISH
(
bl
);

3025 
	}
}

3027 
	gPa¡IÁ”v®s
::
pg_š‹rv®_t
::
	$dump
(
FÜm©‹r
 *
f
) const

3029 
f
->
	`dump_unsigÃd
("fœ¡", 
fœ¡
);

3030 
f
->
	`dump_unsigÃd
("Ï¡", 
Ï¡
);

3031 
f
->
	`dump_št
("maybe_w’t_rw", 
maybe_w’t_rw
 ? 1 : 0);

3032 
f
->
	`İ’_¬¿y_£ùiÚ
("up");

3033 
veùÜ
<>::
cÚ¡_™”©Ü
 
p
 = 
up
.
	`begš
();… !ğup.
	`’d
(); ++p)

3034 
f
->
	`dump_št
("osd", *
p
);

3035 
f
->
	`şo£_£ùiÚ
();

3036 
f
->
	`İ’_¬¿y_£ùiÚ
("acting");

3037 
veùÜ
<>::
cÚ¡_™”©Ü
 
p
 = 
aùšg
.
	`begš
();… !ğaùšg.
	`’d
(); ++p)

3038 
f
->
	`dump_št
("osd", *
p
);

3039 
f
->
	`şo£_£ùiÚ
();

3040 
f
->
	`dump_št
("´im¬y", 
´im¬y
);

3041 
f
->
	`dump_št
("up_´im¬y", 
up_´im¬y
);

3042 
	}
}

3044 
	gPa¡IÁ”v®s
::
pg_š‹rv®_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<pg_š‹rv®_t*>& 
o
)

3046 
o
.
push_back
(
Ãw
 
pg_š‹rv®_t
);

3047 
	go
.
push_back
(
Ãw
 
pg_š‹rv®_t
);

3048 
	go
.
back
()->
	gup
.
push_back
(1);

3049 
	go
.
back
()->
	gaùšg
.
push_back
(2);

3050 
	go
.
back
()->
	gaùšg
.
push_back
(3);

3051 
	go
.
back
()->
	gfœ¡
 = 4;

3052 
	go
.
back
()->
	gÏ¡
 = 5;

3053 
	go
.
back
()->
	gmaybe_w’t_rw
 = 
Œue
;

3056 
	$WRITE_CLASS_ENCODER
(
Pa¡IÁ”v®s
::
pg_š‹rv®_t
)

3076 
	scom·ù_š‹rv®_t
 {

3077 
•och_t
 
fœ¡
;

3078 
•och_t
 
Ï¡
;

3079 
£t
<
pg_sh¬d_t
> 
aùšg
;

3080 
boŞ
 
	`su³r£des
(cÚ¡ 
com·ù_š‹rv®_t
 &
Ùh”
) {

3081 autØ&&
i
: 
aùšg
) {

3082 ià(!
Ùh”
.
aùšg
.
	`couÁ
(
i
))

3083  
çl£
;

3085  
Œue
;

3087 
	`dump
(
FÜm©‹r
 *
f
) const {

3088 
f
->
	`İ’_objeù_£ùiÚ
("compact_interval_t");

3089 
f
->
	`dump_¡»am
("fœ¡"è<< 
fœ¡
;

3090 
f
->
	`dump_¡»am
("Ï¡"è<< 
Ï¡
;

3091 
f
->
	`dump_¡»am
("aùšg"è<< 
aùšg
;

3092 
f
->
	`şo£_£ùiÚ
();

3094 
	`’code
(
bufã¾i¡
 &
bl
) const {

3095 
	`ENCODE_START
(1, 1, 
bl
);

3096 
	`’code
(
fœ¡
, 
bl
);

3097 
	`’code
(
Ï¡
, 
bl
);

3098 
	`’code
(
aùšg
, 
bl
);

3099 
	`ENCODE_FINISH
(
bl
);

3101 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
) {

3102 
	`DECODE_START
(1, 
bl
);

3103 
	`decode
(
fœ¡
, 
bl
);

3104 
	`decode
(
Ï¡
, 
bl
);

3105 
	`decode
(
aùšg
, 
bl
);

3106 
	`DECODE_FINISH
(
bl
);

3108 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
com·ù_š‹rv®_t
*> & 
o
) {

3112 
o¡»am
 &
İ”©Ü
<<(o¡»am &
o
, cÚ¡ 
com·ù_š‹rv®_t
 &
rhs
)

3114  
o
 << "([" << 
rhs
.
fœ¡
 << "," <<„hs.
Ï¡


3115 << "]‡ùšg " << 
rhs
.
aùšg
 << ")";

3116 
	}
}

3117 
	$WRITE_CLASS_ENCODER
(
com·ù_š‹rv®_t
)

3119 şas 
	cpi_com·ù_»p
 : 
public
 
Pa¡IÁ”v®s
::
š‹rv®_»p
 {

3120 
•och_t
 
fœ¡
 = 0;

3121 
•och_t
 
Ï¡
 = 0;

3122 
£t
<
pg_sh¬d_t
> 
®l_·¹icªts
;

3123 
li¡
<
com·ù_š‹rv®_t
> 
š‹rv®s
;

3124 
	`pi_com·ù_»p
(

3125 
boŞ
 
ec_poŞ
,

3126 
¡d
::
li¡
<
Pa¡IÁ”v®s
::
pg_š‹rv®_t
> &&
š‹rv®s
) {

3127 autØ&&
i
: 
š‹rv®s
)

3128 
	`add_š‹rv®
(
ec_poŞ
, 
i
);

3130 
public
:

3131 
	`pi_com·ù_»p
() = ;

3132 
	`pi_com·ù_»p
(cÚ¡ 
pi_com·ù_»p
 &) = ;

3133 
	`pi_com·ù_»p
(
pi_com·ù_»p
 &&) = ;

3134 
pi_com·ù_»p
 &
İ”©Ü
=(const…i_compact_rep &) = ;

3135 
pi_com·ù_»p
 &
İ”©Ü
=(pi_compact_rep &&) = ;

3137 
size_t
 
	$size
(ècÚ¡ 
ov”ride
 {  
š‹rv®s
.
	`size
(); 
	}
}

3138 
boŞ
 
	$em±y
(ècÚ¡ 
ov”ride
 {

3139  
fœ¡
 > 
Ï¡
 || (first == 0 &&†ast == 0);

3140 
	}
}

3141 
	$ş—r
(è
ov”ride
 {

3142 *
this
 = 
	`pi_com·ù_»p
();

3143 
	}
}

3144 
	g·œ
<
	g•och_t
,ƒpoch_t> 
	$g‘_bounds
(ècÚ¡ 
ov”ride
 {

3145  
	`make_·œ
(
fœ¡
, 
Ï¡
 + 1);

3146 
	}
}

3147 
	g£t
<
	gpg_sh¬d_t
> 
	$g‘_®l_·¹icªts
(

3148 
boŞ
 
ec_poŞ
ècÚ¡ 
ov”ride
 {

3149  
®l_·¹icªts
;

3150 
	}
}

3151 
	$add_š‹rv®
(

3152 
boŞ
 
ec_poŞ
, cÚ¡ 
Pa¡IÁ”v®s
::
pg_š‹rv®_t
 &
š‹rv®
è
ov”ride
 {

3153 ià(
fœ¡
 == 0)

3154 
fœ¡
 = 
š‹rv®
.first;

3155 
	`as£¹
(
š‹rv®
.
Ï¡
 >†ast);

3156 
Ï¡
 = 
š‹rv®
.last;

3157 
£t
<
pg_sh¬d_t
> 
aùšg
;

3158 
i
 = 0; i < 
š‹rv®
.
aùšg
.
	`size
(); ++i) {

3159 ià(
š‹rv®
.
aùšg
[
i
] =ğ
CRUSH_ITEM_NONE
)

3161 
aùšg
.
	`š£¹
(

3162 
	`pg_sh¬d_t
(

3163 
š‹rv®
.
aùšg
[
i
],

3164 
ec_poŞ
 ? 
	`sh¬d_id_t
(
i
è: 
sh¬d_id_t
::
NO_SHARD
));

3166 
®l_·¹icªts
.
	`š£¹
(
aùšg
.
	`begš
(),‡ùšg.
	`’d
());

3167 ià(!
š‹rv®
.
maybe_w’t_rw
)

3169 
š‹rv®s
.
	`push_back
(

3170 
com·ù_š‹rv®_t
{
š‹rv®
.
fœ¡
, iÁ”v®.
Ï¡
, 
aùšg
});

3171 autØ
¶a¡
 = 
š‹rv®s
.
	`’d
();

3172 --
¶a¡
;

3173 autØ
cur
 = 
š‹rv®s
.
	`begš
(); cu¸!ğ
¶a¡
; ) {

3174 ià(
¶a¡
->
	`su³r£des
(*
cur
)) {

3175 
š‹rv®s
.
	`”a£
(
cur
++);

3177 ++
cur
;

3180 
	}
}

3181 
	gunique_±r
<
	gPa¡IÁ”v®s
::
š‹rv®_»p
> 
	$şÚe
(ècÚ¡ 
ov”ride
 {

3182  
unique_±r
<
Pa¡IÁ”v®s
::
š‹rv®_»p
>(
Ãw
 
	`pi_com·ù_»p
(*
this
));

3183 
	}
}

3184 
	go¡»am
 &
	$´št
(
o¡»am
 &
out
ècÚ¡ 
ov”ride
 {

3185  
out
 << "([" << 
fœ¡
 << "," << 
Ï¡


3186 << "] iÁ”v®s=" << 
š‹rv®s
 << ")";

3187 
	}
}

3188 
	$’code
(
bufã¾i¡
 &
bl
ècÚ¡ 
ov”ride
 {

3189 
	`ENCODE_START
(1, 1, 
bl
);

3190 
	`’code
(
fœ¡
, 
bl
);

3191 
	`’code
(
Ï¡
, 
bl
);

3192 
	`’code
(
®l_·¹icªts
, 
bl
);

3193 
	`’code
(
š‹rv®s
, 
bl
);

3194 
	`ENCODE_FINISH
(
bl
);

3195 
	}
}

3196 
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
è
ov”ride
 {

3197 
	`DECODE_START
(1, 
bl
);

3198 
	`decode
(
fœ¡
, 
bl
);

3199 
	`decode
(
Ï¡
, 
bl
);

3200 
	`decode
(
®l_·¹icªts
, 
bl
);

3201 
	`decode
(
š‹rv®s
, 
bl
);

3202 
	`DECODE_FINISH
(
bl
);

3203 
	}
}

3204 
	$dump
(
FÜm©‹r
 *
f
ècÚ¡ 
ov”ride
 {

3205 
f
->
	`İ’_objeù_£ùiÚ
("PastIntervals::compact_rep");

3206 
f
->
	`dump_¡»am
("fœ¡"è<< 
fœ¡
;

3207 
f
->
	`dump_¡»am
("Ï¡"è<< 
Ï¡
;

3208 
f
->
	`İ’_¬¿y_£ùiÚ
("all_participants");

3209 auto& 
i
 : 
®l_·¹icªts
) {

3210 
f
->
	`dump_objeù
("pg_sh¬d", 
i
);

3212 
f
->
	`şo£_£ùiÚ
();

3213 
f
->
	`İ’_¬¿y_£ùiÚ
("intervals");

3214 autØ&&
i
: 
š‹rv®s
) {

3215 
i
.
	`dump
(
f
);

3217 
f
->
	`şo£_£ùiÚ
();

3218 
f
->
	`şo£_£ùiÚ
();

3219 
	}
}

3220 
g’”©e_‹¡_š¡ªûs
(
li¡
<
pi_com·ù_»p
*> &
o
) {

3221 
usšg
 
	giv®
 = 
Pa¡IÁ”v®s
::
pg_š‹rv®_t
;

3222 
usšg
 
	giv®l¡
 = 
¡d
::
li¡
<
iv®
>;

3223 
	go
.
push_back
(

3224 
Ãw
 
pi_com·ù_»p
(

3225 
Œue
, 
iv®l¡


3226 { 
iv®
{{0, 1, 2}, {0, 1, 2}, 10, 20, 
Œue
, 0, 0}

3227 , 
iv®
{{ 1, 2}, { 1, 2}, 21, 30, 
Œue
, 1, 1}

3228 , 
iv®
{{ 2}, { 2}, 31, 35, 
çl£
, 2, 2}

3229 , 
iv®
{{0, 2}, {0, 2}, 36, 50, 
Œue
, 0, 0}

3231 
	go
.
push_back
(

3232 
Ãw
 
pi_com·ù_»p
(

3233 
çl£
, 
iv®l¡


3234 { 
iv®
{{0, 1, 2}, {0, 1, 2}, 10, 20, 
Œue
, 0, 0}

3235 , 
iv®
{{ 1, 2}, { 1, 2}, 21, 30, 
Œue
, 1, 1}

3236 , 
iv®
{{ 2}, { 2}, 31, 35, 
çl£
, 2, 2}

3237 , 
iv®
{{0, 2}, {0, 2}, 36, 50, 
Œue
, 0, 0}

3239 
	go
.
push_back
(

3240 
Ãw
 
pi_com·ù_»p
(

3241 
Œue
, 
iv®l¡


3242 { 
iv®
{{2, 1, 0}, {2, 1, 0}, 10, 20, 
Œue
, 1, 1}

3243 , 
iv®
{{ 0, 2}, { 0, 2}, 21, 30, 
Œue
, 0, 0}

3244 , 
iv®
{{ 0, 2}, {2, 0}, 31, 35, 
Œue
, 2, 2}

3245 , 
iv®
{{ 0, 2}, { 0, 2}, 36, 50, 
Œue
, 0, 0}

3248 
™”©e_mayb”w_back_to
(

3249 
boŞ
 
ec_poŞ
,

3250 
•och_t
 
Ës
,

3251 
¡d
::
funùiÚ
<(
•och_t
, cÚ¡ 
£t
<
pg_sh¬d_t
> &)> &&
f
ècÚ¡ 
	gov”ride
 {

3252 autØ
	gi
 = 
š‹rv®s
.
rbegš
(); i !ğš‹rv®s.
»nd
(); ++i) {

3253 ià(
	gi
->
	gÏ¡
 < 
	gËs
)

3255 
f
(
i
->
fœ¡
, i->
aùšg
);

3258 
	gvœtu®
 ~
	$pi_com·ù_»p
(è
ov”ride
 {
	}
}

3260 
	$WRITE_CLASS_ENCODER
(
pi_com·ù_»p
)

3262 
Pa¡IÁ”v®s
::
	$Pa¡IÁ”v®s
()

3264 
·¡_š‹rv®s
.
	`»£t
(
Ãw
 
pi_com·ù_»p
);

3265 
	}
}

3267 
	gPa¡IÁ”v®s
::
	$Pa¡IÁ”v®s
(cÚ¡ 
Pa¡IÁ”v®s
 &
rhs
)

3268 : 
	`·¡_š‹rv®s
(
rhs
.
·¡_š‹rv®s
 ?

3269 
rhs
.
·¡_š‹rv®s
->
	$şÚe
() :

3270 
nuÎ±r
è{
	}
}

3272 
Pa¡IÁ”v®s
 &Pa¡IÁ”v®s::
İ”©Ü
=(cÚ¡ Pa¡IÁ”v® &
rhs
)

3274 
Pa¡IÁ”v®s
 
Ùh”
(
rhs
);

3275 
sw­
(
Ùh”
);

3276  *
	gthis
;

3279 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gPa¡IÁ”v®s
 &
	gi
)

3281 ià(
	gi
.
	g·¡_š‹rv®s
) {

3282  
	gi
.
	g·¡_š‹rv®s
->
´št
(
out
);

3284  
	gout
 << "(empty)";

3288 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gPa¡IÁ”v®s
::
PriÜS‘
 &
i
)

3290  
out
 << "PriorSet("

3291 << "ec_poŞ: " << 
i
.
ec_poŞ


3292 << ",…robe: " << 
i
.
´obe


3293 << ", down: " << 
i
.
down


3294 << ", blocked_by: " << 
i
.
blocked_by


3295 << ",…g_down: " << 
i
.
pg_down


3299 
	gPa¡IÁ”v®s
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

3301 
	`DECODE_START
(1, 
bl
);

3302 
__u8
 
ty³
 = 0;

3303 
	`decode
(
ty³
, 
bl
);

3304 
ty³
) {

3308 
	`as£¹
(0 == "pi_simple_rep support„emoved…ost-luminous");

3311 
·¡_š‹rv®s
.
	`»£t
(
Ãw
 
pi_com·ù_»p
);

3312 
·¡_š‹rv®s
->
	`decode
(
bl
);

3315 
	`DECODE_FINISH
(
bl
);

3316 
	}
}

3318 
	gPa¡IÁ”v®s
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
Pa¡IÁ”v®s
*> &
o
)

3321 
li¡
<
pi_com·ù_»p
 *> 
com·ù
;

3322 
	gpi_com·ù_»p
::
g’”©e_‹¡_š¡ªûs
(
com·ù
);

3323 autØ&&
	gi
: 
com·ù
) {

3325 
o
.
push_back
(
Ãw
 
Pa¡IÁ”v®s
(
i
));

3331 
boŞ
 
	gPa¡IÁ”v®s
::
is_Ãw_š‹rv®
(

3332 
Şd_aùšg_´im¬y
,

3333 
Ãw_aùšg_´im¬y
,

3334 cÚ¡ 
veùÜ
<> &
Şd_aùšg
,

3335 cÚ¡ 
veùÜ
<> &
Ãw_aùšg
,

3336 
Şd_up_´im¬y
,

3337 
Ãw_up_´im¬y
,

3338 cÚ¡ 
veùÜ
<> &
Şd_up
,

3339 cÚ¡ 
veùÜ
<> &
Ãw_up
,

3340 
Şd_size
,

3341 
Ãw_size
,

3342 
Şd_mš_size
,

3343 
Ãw_mš_size
,

3344 
Şd_pg_num
,

3345 
Ãw_pg_num
,

3346 
boŞ
 
Şd_sÜt_b™wi£
,

3347 
boŞ
 
Ãw_sÜt_b™wi£
,

3348 
boŞ
 
Şd_»cov”y_d–‘es
,

3349 
boŞ
 
Ãw_»cov”y_d–‘es
,

3350 
pg_t
 
pgid
) {

3351  
	gŞd_aùšg_´im¬y
 !ğ
Ãw_aùšg_´im¬y
 ||

3352 
Ãw_aùšg
 !ğ
Şd_aùšg
 ||

3353 
Şd_up_´im¬y
 !ğ
Ãw_up_´im¬y
 ||

3354 
Ãw_up
 !ğ
Şd_up
 ||

3355 
Şd_mš_size
 !ğ
Ãw_mš_size
 ||

3356 
Şd_size
 !ğ
Ãw_size
 ||

3357 
pgid
.
is_¥l™
(
Şd_pg_num
, 
Ãw_pg_num
, 0) ||

3358 
	gŞd_sÜt_b™wi£
 !ğ
Ãw_sÜt_b™wi£
 ||

3359 
Şd_»cov”y_d–‘es
 !ğ
Ãw_»cov”y_d–‘es
;

3362 
boŞ
 
	gPa¡IÁ”v®s
::
is_Ãw_š‹rv®
(

3363 
Şd_aùšg_´im¬y
,

3364 
Ãw_aùšg_´im¬y
,

3365 cÚ¡ 
veùÜ
<> &
Şd_aùšg
,

3366 cÚ¡ 
veùÜ
<> &
Ãw_aùšg
,

3367 
Şd_up_´im¬y
,

3368 
Ãw_up_´im¬y
,

3369 cÚ¡ 
veùÜ
<> &
Şd_up
,

3370 cÚ¡ 
veùÜ
<> &
Ãw_up
,

3371 
OSDM­Ref
 
osdm­
,

3372 
OSDM­Ref
 
Ï¡m­
,

3373 
pg_t
 
pgid
)

3375 cÚ¡ 
pg_poŞ_t
 *
	g¶a¡
 = 
Ï¡m­
->
g‘_pg_poŞ
(
pgid
.
poŞ
());

3376 ià(!
	g¶a¡
) {

3377  
	gçl£
;

3379 cÚ¡ 
pg_poŞ_t
 *
	gpi
 = 
osdm­
->
g‘_pg_poŞ
(
pgid
.
poŞ
());

3380 ià(!
	gpi
) {

3381  
	gŒue
;

3384 
is_Ãw_š‹rv®
(
Şd_aùšg_´im¬y
,

3385 
Ãw_aùšg_´im¬y
,

3386 
Şd_aùšg
,

3387 
Ãw_aùšg
,

3388 
Şd_up_´im¬y
,

3389 
Ãw_up_´im¬y
,

3390 
Şd_up
,

3391 
Ãw_up
,

3392 
¶a¡
->
size
,

3393 
pi
->
size
,

3394 
¶a¡
->
mš_size
,

3395 
pi
->
mš_size
,

3396 
¶a¡
->
g‘_pg_num
(),

3397 
pi
->
g‘_pg_num
(),

3398 
Ï¡m­
->
‹¡_æag
(
CEPH_OSDMAP_SORTBITWISE
),

3399 
osdm­
->
‹¡_æag
(
CEPH_OSDMAP_SORTBITWISE
),

3400 
Ï¡m­
->
‹¡_æag
(
CEPH_OSDMAP_RECOVERY_DELETES
),

3401 
osdm­
->
‹¡_æag
(
CEPH_OSDMAP_RECOVERY_DELETES
),

3402 
pgid
);

3405 
boŞ
 
	gPa¡IÁ”v®s
::
check_Ãw_š‹rv®
(

3406 
Şd_aùšg_´im¬y
,

3407 
Ãw_aùšg_´im¬y
,

3408 cÚ¡ 
veùÜ
<> &
Şd_aùšg
,

3409 cÚ¡ 
veùÜ
<> &
Ãw_aùšg
,

3410 
Şd_up_´im¬y
,

3411 
Ãw_up_´im¬y
,

3412 cÚ¡ 
veùÜ
<> &
Şd_up
,

3413 cÚ¡ 
veùÜ
<> &
Ãw_up
,

3414 
•och_t
 
§me_š‹rv®_sšû
,

3415 
•och_t
 
Ï¡_•och_ş—n
,

3416 
OSDM­Ref
 
osdm­
,

3417 
OSDM­Ref
 
Ï¡m­
,

3418 
pg_t
 
pgid
,

3419 
IsPGRecov”abËP»diÿ‹
 *
could_have_gÚe_aùive
,

3420 
Pa¡IÁ”v®s
 *
·¡_š‹rv®s
,

3421 
¡d
::
o¡»am
 *
out
)

3468 
as£¹
(
·¡_š‹rv®s
);

3469 
as£¹
(
·¡_š‹rv®s
->past_intervals);

3470 ià(
is_Ãw_š‹rv®
(

3471 
Şd_aùšg_´im¬y
,

3472 
Ãw_aùšg_´im¬y
,

3473 
Şd_aùšg
,

3474 
Ãw_aùšg
,

3475 
Şd_up_´im¬y
,

3476 
Ãw_up_´im¬y
,

3477 
Şd_up
,

3478 
Ãw_up
,

3479 
osdm­
,

3480 
Ï¡m­
,

3481 
pgid
)) {

3482 
pg_š‹rv®_t
 
	gi
;

3483 
	gi
.
	gfœ¡
 = 
§me_š‹rv®_sšû
;

3484 
	gi
.
	gÏ¡
 = 
osdm­
->
g‘_•och
() - 1;

3485 
as£¹
(
i
.
fœ¡
 <ği.
Ï¡
);

3486 
	gi
.
	gaùšg
 = 
Şd_aùšg
;

3487 
	gi
.
	gup
 = 
Şd_up
;

3488 
	gi
.
	g´im¬y
 = 
Şd_aùšg_´im¬y
;

3489 
	gi
.
	gup_´im¬y
 = 
Şd_up_´im¬y
;

3491 
	gnum_aùšg
 = 0;

3492 
	gveùÜ
<>::
cÚ¡_™”©Ü
 
p
 = 
i
.
aùšg
.
begš
(); 
	gp
 !ği.aùšg.
’d
();

3493 ++
	gp
)

3494 ià(*
	gp
 !ğ
CRUSH_ITEM_NONE
)

3495 ++
num_aùšg
;

3497 
as£¹
(
Ï¡m­
->
g‘_poŞs
().
couÁ
(
pgid
.
poŞ
()));

3498 cÚ¡ 
	gpg_poŞ_t
& 
	gŞd_pg_poŞ
 = 
Ï¡m­
->
g‘_poŞs
().
fšd
(
pgid
.
poŞ
())->
£cÚd
;

3499 
	g£t
<
	gpg_sh¬d_t
> 
	gŞd_aùšg_sh¬ds
;

3500 
	gŞd_pg_poŞ
.
cÚv”t_to_pg_sh¬ds
(
Şd_aùšg
, &
Şd_aùšg_sh¬ds
);

3502 ià(
	gnum_aùšg
 &&

3503 
	gi
.
	g´im¬y
 != -1 &&

3504 
num_aùšg
 >ğ
Şd_pg_poŞ
.
mš_size
 &&

3505 (*
could_have_gÚe_aùive
)(
Şd_aùšg_sh¬ds
)) {

3506 ià(
out
)

3507 *
out
 << 
__func__
 << " " << 
i


3508 << " up_thru " << 
Ï¡m­
->
g‘_up_thru
(
i
.
´im¬y
)

3509 << " up_äom " << 
Ï¡m­
->
g‘_up_äom
(
i
.
´im¬y
)

3510 << "†a¡_•och_ş—À" << 
Ï¡_•och_ş—n
;

3511 ià(
	gÏ¡m­
->
g‘_up_thru
(
i
.
´im¬y
è>ği.
fœ¡
 &&

3512 
Ï¡m­
->
g‘_up_äom
(
i
.
´im¬y
è<ği.
fœ¡
) {

3513 
i
.
maybe_w’t_rw
 = 
Œue
;

3514 ià(
	gout
)

3515 *
	gout
 << " " << 
	gi


3516 << " :…rim¬y u°" << 
	gÏ¡m­
->
g‘_up_äom
(
i
.
´im¬y
)

3517 << "-" << 
	gÏ¡m­
->
g‘_up_thru
(
i
.
´im¬y
)

3519 << 
	g¡d
::
’dl
;

3520 } ià(
	gÏ¡_•och_ş—n
 >ğ
i
.
fœ¡
 &&

3521 
Ï¡_•och_ş—n
 <ğ
i
.
Ï¡
) {

3529 
i
.
maybe_w’t_rw
 = 
Œue
;

3530 ià(
	gout
)

3531 *
	gout
 << " " << 
	gi


3532 << " : inşude Ï¡_•och_ş—À" << 
	gÏ¡_•och_ş—n


3534 << 
	g¡d
::
’dl
;

3536 
	gi
.
	gmaybe_w’t_rw
 = 
çl£
;

3537 ià(
	gout
)

3538 *
	gout
 << " " << 
	gi


3539 << " :…rim¬y u°" << 
	gÏ¡m­
->
g‘_up_äom
(
i
.
´im¬y
)

3540 << "-" << 
	gÏ¡m­
->
g‘_up_thru
(
i
.
´im¬y
)

3542 << 
	g¡d
::
’dl
;

3545 
	gi
.
	gmaybe_w’t_rw
 = 
çl£
;

3546 ià(
	gout
)

3547 *
	gout
 << 
	g__func__
 << " " << 
	gi
 << " :‡ùšg s‘ i toØsm®l" << 
	g¡d
::
’dl
;

3549 
	g·¡_š‹rv®s
->·¡_š‹rv®s->
add_š‹rv®
(
Şd_pg_poŞ
.
is_”asu»
(), 
i
);

3550  
	gŒue
;

3552  
	gçl£
;

3558 
boŞ
 
	gPa¡IÁ”v®s
::
PriÜS‘
::
	$afãùed_by_m­
(

3559 cÚ¡ 
OSDM­
 &
osdm­
,

3560 cÚ¡ 
DoutP»fixProvid”
 *
dµ
) const

3562 
£t
<
pg_sh¬d_t
>::
™”©Ü
 
p
 = 
´obe
.
	`begš
();

3563 
p
 !ğ
´obe
.
	`’d
();

3564 ++
p
) {

3565 
o
 = 
p
->
osd
;

3568 ià(
osdm­
.
	`is_down
(
o
è&& 
down
.
	`couÁ
(o) == 0) {

3569 
	`ldµ_dout
(
dµ
, 10è<< "afãùed_by_m­ osd." << 
o
 << "‚ow down" << 
d’dl
;

3570  
Œue
;

3574 
m­
<, 
•och_t
>::
cÚ¡_™”©Ü
 
r
 = 
blocked_by
.
	`fšd
(
o
);

3575 ià(
r
 !ğ
blocked_by
.
	`’d
()) {

3576 ià(!
osdm­
.
	`exi¡s
(
o
)) {

3577 
	`ldµ_dout
(
dµ
, 10è<< "afãùed_by_m­ osd." << 
o
 << "‚ØlÚg”ƒxi¡s" << 
d’dl
;

3578  
Œue
;

3580 ià(
osdm­
.
	`g‘_šfo
(
o
).
lo¡_©
 !ğ
r
->
£cÚd
) {

3581 
	`ldµ_dout
(
dµ
, 10è<< "afãùed_by_m­ osd." << 
o
 << " (»)m¬ked‡ lo¡" << 
d’dl
;

3582  
Œue
;

3588 
£t
<>::
cÚ¡_™”©Ü
 
p
 = 
down
.
	`begš
();

3589 
p
 !ğ
down
.
	`’d
();

3590 ++
p
) {

3591 
o
 = *
p
;

3593 ià(
osdm­
.
	`is_up
(
o
)) {

3594 
	`ldµ_dout
(
dµ
, 10è<< "afãùed_by_m­ osd." << 
o
 << "‚ow up" << 
d’dl
;

3595  
Œue
;

3599 ià(!
osdm­
.
	`exi¡s
(
o
)) {

3600 
	`ldµ_dout
(
dµ
, 10è<< "afãùed_by_m­ osd." << 
o
 << "‚ØlÚg”ƒxi¡s" << 
d’dl
;

3601  
Œue
;

3604 
m­
<, 
•och_t
>::
cÚ¡_™”©Ü
 
r
 = 
blocked_by
.
	`fšd
(
o
);

3605 ià(
r
 !ğ
blocked_by
.
	`’d
()) {

3606 ià(
osdm­
.
	`g‘_šfo
(
o
).
lo¡_©
 !ğ
r
->
£cÚd
) {

3607 
	`ldµ_dout
(
dµ
, 10è<< "afãùed_by_m­ osd." << 
o
 << " (»)m¬ked‡ lo¡" << 
d’dl
;

3608  
Œue
;

3613  
çl£
;

3614 
	}
}

3616 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gPa¡IÁ”v®s
::
pg_š‹rv®_t
& 
i
)

3618 
out
 << "š‹rv®(" << 
i
.
fœ¡
 << "-" << i.
Ï¡


3619 << " u°" << 
i
.
up
 << "(" << i.
up_´im¬y
 << ")"

3620 << "‡ùšg " << 
i
.
aùšg
 << "(" << i.
´im¬y
 << ")";

3621 ià(
	gi
.
	gmaybe_w’t_rw
)

3622 
	gout
 << " maybe_went_rw";

3623 
	gout
 << ")";

3624  
	gout
;

3631 
	gpg_qu”y_t
::
	$’code
(
bufã¾i¡
 &
bl
, 
ušt64_t
 
ã©u»s
) const {

3632 
	`ENCODE_START
(3, 3, 
bl
);

3633 
	`’code
(
ty³
, 
bl
);

3634 
	`’code
(
sšû
, 
bl
);

3635 
hi¡Üy
.
	`’code
(
bl
);

3636 
	`’code
(
•och_£Á
, 
bl
);

3637 
	`’code
(
to
, 
bl
);

3638 
	`’code
(
äom
, 
bl
);

3639 
	`ENCODE_FINISH
(
bl
);

3640 
	}
}

3642 
	gpg_qu”y_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
) {

3643 
	`DECODE_START
(3, 
bl
);

3644 
	`decode
(
ty³
, 
bl
);

3645 
	`decode
(
sšû
, 
bl
);

3646 
hi¡Üy
.
	`decode
(
bl
);

3647 
	`decode
(
•och_£Á
, 
bl
);

3648 
	`decode
(
to
, 
bl
);

3649 
	`decode
(
äom
, 
bl
);

3650 
	`DECODE_FINISH
(
bl
);

3651 
	}
}

3653 
	gpg_qu”y_t
::
	$dump
(
FÜm©‹r
 *
f
) const

3655 
f
->
	`dump_št
("äom", 
äom
);

3656 
f
->
	`dump_št
("to", 
to
);

3657 
f
->
	`dump_¡ršg
("ty³", 
	`g‘_ty³_Çme
());

3658 
f
->
	`dump_¡»am
("sšû"è<< 
sšû
;

3659 
f
->
	`dump_¡»am
("•och_£Á"è<< 
•och_£Á
;

3660 
f
->
	`İ’_objeù_£ùiÚ
("history");

3661 
hi¡Üy
.
	`dump
(
f
);

3662 
f
->
	`şo£_£ùiÚ
();

3663 
	}
}

3664 
	gpg_qu”y_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_qu”y_t
*>& 
o
)

3666 
o
.
push_back
(
Ãw
 
pg_qu”y_t
());

3667 
	gli¡
<
	gpg_hi¡Üy_t
*> 
	gh
;

3668 
	gpg_hi¡Üy_t
::
g’”©e_‹¡_š¡ªûs
(
h
);

3669 
	go
.
push_back
(
Ãw
 
pg_qu”y_t
Õg_qu”y_t::
INFO
, 
sh¬d_id_t
(1), sh¬d_id_t(2), *
h
.
back
(), 4));

3670 
	go
.
push_back
(
Ãw
 
pg_qu”y_t
Õg_qu”y_t::
MISSING
, 
sh¬d_id_t
(2), sh¬d_id_t(3), *
h
.
back
(), 4));

3671 
	go
.
push_back
(
Ãw
 
pg_qu”y_t
Õg_qu”y_t::
LOG
, 
sh¬d_id_t
(0), shard_id_t(0),

3672 
ev”siÚ_t
(4, 5), *
h
.
back
(), 4));

3673 
	go
.
push_back
(
Ãw
 
pg_qu”y_t
Õg_qu”y_t::
FULLLOG
,

3674 
sh¬d_id_t
::
NO_SHARD
, shard_id_t::NO_SHARD,

3675 *
h
.
back
(), 5));

3679 
	gObjeùModDesc
::
	$vis™
(
Vis™Ü
 *
vis™Ü
) const

3681 
bufã¾i¡
::
™”©Ü
 
bp
 = 
bl
.
	`begš
();

3682 
Œy
 {

3683 !
bp
.
	`’d
()) {

3684 
	`DECODE_START
(
max_»quœed_v”siÚ
, 
bp
);

3685 
ušt8_t
 
code
;

3686 
	`decode
(
code
, 
bp
);

3687 
code
) {

3688 
APPEND
: {

3689 
ušt64_t
 
size
;

3690 
	`decode
(
size
, 
bp
);

3691 
vis™Ü
->
	`­³nd
(
size
);

3694 
SETATTRS
: {

3695 
m­
<
¡ršg
, 
boo¡
::
İtiÚ®
<
bufã¾i¡
> > 
©Œs
;

3696 
	`decode
(
©Œs
, 
bp
);

3697 
vis™Ü
->
	`£‰rs
(
©Œs
);

3700 
DELETE
: {

3701 
v”siÚ_t
 
Şd_v”siÚ
;

3702 
	`decode
(
Şd_v”siÚ
, 
bp
);

3703 
vis™Ü
->
	`rmobjeù
(
Şd_v”siÚ
);

3706 
CREATE
: {

3707 
vis™Ü
->
	`ü—‹
();

3710 
UPDATE_SNAPS
: {

3711 
£t
<
¢­id_t
> 
¢­s
;

3712 
	`decode
(
¢­s
, 
bp
);

3713 
vis™Ü
->
	`upd©e_¢­s
(
¢­s
);

3716 
TRY_DELETE
: {

3717 
v”siÚ_t
 
Şd_v”siÚ
;

3718 
	`decode
(
Şd_v”siÚ
, 
bp
);

3719 
vis™Ü
->
	`Œy_rmobjeù
(
Şd_v”siÚ
);

3722 
ROLLBACK_EXTENTS
: {

3723 
veùÜ
<
·œ
<
ušt64_t
, ušt64_t> > 
ex‹Ás
;

3724 
v”siÚ_t
 
g’
;

3725 
	`decode
(
g’
, 
bp
);

3726 
	`decode
(
ex‹Ás
, 
bp
);

3727 
vis™Ü
->
	`rŞlback_ex‹Ás
(
g’
,
ex‹Ás
);

3731 
	`as£¹
(0 == "Invalid„ollback code");

3733 
	`DECODE_FINISH
(
bp
);

3735 } 
	`ÿtch
 (...) {

3736 
	`as£¹
(0 == "Invalidƒncoding");

3738 
	}
}

3740 
	gDumpVis™Ü
 : 
public
 
ObjeùModDesc
::
Vis™Ü
 {

3741 
FÜm©‹r
 *
f
;

3742 
ex¶ic™
 
DumpVis™Ü
(
FÜm©‹r
 *
f
) : f(f) {}

3743 
­³nd
(
ušt64_t
 
Şd_size
è
ov”ride
 {

3744 
f
->
İ’_objeù_£ùiÚ
("op");

3745 
	gf
->
dump_¡ršg
("code", "APPEND");

3746 
	gf
->
dump_unsigÃd
("Şd_size", 
Şd_size
);

3747 
	gf
->
şo£_£ùiÚ
();

3749 
£‰rs
(
m­
<
¡ršg
, 
boo¡
::
İtiÚ®
<
bufã¾i¡
> > &
©Œs
è
ov”ride
 {

3750 
f
->
İ’_objeù_£ùiÚ
("op");

3751 
	gf
->
dump_¡ršg
("code", "SETATTRS");

3752 
	gf
->
İ’_¬¿y_£ùiÚ
("attrs");

3753 
	gm­
<
	g¡ršg
, 
	gboo¡
::
İtiÚ®
<
bufã¾i¡
> >::
™”©Ü
 
i
 = 
©Œs
.
begš
();

3754 
	gi
 !ğ
©Œs
.
’d
();

3755 ++
	gi
) {

3756 
	gf
->
dump_¡ršg
("©Œ_Çme", 
i
->
fœ¡
);

3758 
	gf
->
şo£_£ùiÚ
();

3759 
	gf
->
şo£_£ùiÚ
();

3761 
rmobjeù
(
v”siÚ_t
 
Şd_v”siÚ
è
	gov”ride
 {

3762 
	gf
->
İ’_objeù_£ùiÚ
("op");

3763 
	gf
->
dump_¡ršg
("code", "RMOBJECT");

3764 
	gf
->
dump_unsigÃd
("Şd_v”siÚ", 
Şd_v”siÚ
);

3765 
	gf
->
şo£_£ùiÚ
();

3767 
Œy_rmobjeù
(
v”siÚ_t
 
Şd_v”siÚ
è
	gov”ride
 {

3768 
	gf
->
İ’_objeù_£ùiÚ
("op");

3769 
	gf
->
dump_¡ršg
("code", "TRY_RMOBJECT");

3770 
	gf
->
dump_unsigÃd
("Şd_v”siÚ", 
Şd_v”siÚ
);

3771 
	gf
->
şo£_£ùiÚ
();

3773 
ü—‹
(è
	gov”ride
 {

3774 
	gf
->
İ’_objeù_£ùiÚ
("op");

3775 
	gf
->
dump_¡ršg
("code", "CREATE");

3776 
	gf
->
şo£_£ùiÚ
();

3778 
upd©e_¢­s
(cÚ¡ 
£t
<
¢­id_t
> &
¢­s
è
	gov”ride
 {

3779 
	gf
->
İ’_objeù_£ùiÚ
("op");

3780 
	gf
->
dump_¡ršg
("code", "UPDATE_SNAPS");

3781 
	gf
->
dump_¡»am
("¢­s"è<< 
	g¢­s
;

3782 
	gf
->
şo£_£ùiÚ
();

3784 
rŞlback_ex‹Ás
(

3785 
v”siÚ_t
 
g’
,

3786 cÚ¡ 
veùÜ
<
·œ
<
ušt64_t
, ušt64_t> > &
ex‹Ás
è
	gov”ride
 {

3787 
	gf
->
İ’_objeù_£ùiÚ
("op");

3788 
	gf
->
dump_¡ršg
("code", "ROLLBACK_EXTENTS");

3789 
	gf
->
dump_unsigÃd
("g’", 
g’
);

3790 
	gf
->
dump_¡»am
("¢­s"è<< 
	gex‹Ás
;

3791 
	gf
->
şo£_£ùiÚ
();

3795 
	gObjeùModDesc
::
	$dump
(
FÜm©‹r
 *
f
) const

3797 
f
->
	`İ’_objeù_£ùiÚ
("object_mod_desc");

3798 
f
->
	`dump_boŞ
("ÿn_loÿl_rŞlback", 
ÿn_loÿl_rŞlback
);

3799 
f
->
	`dump_boŞ
("rŞlback_šfo_com¶‘ed", 
rŞlback_šfo_com¶‘ed
);

3801 
f
->
	`İ’_¬¿y_£ùiÚ
("ops");

3802 
DumpVis™Ü
 
	`vis
(
f
);

3803 
	`vis™
(&
vis
);

3804 
f
->
	`şo£_£ùiÚ
();

3806 
f
->
	`şo£_£ùiÚ
();

3807 
	}
}

3809 
	gObjeùModDesc
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
ObjeùModDesc
*>& 
o
)

3811 
m­
<
¡ršg
, 
	gboo¡
::
İtiÚ®
<
bufã¾i¡
> > 
©Œs
;

3812 
	g©Œs
[
OI_ATTR
];

3813 
	g©Œs
[
SS_ATTR
];

3814 
	g©Œs
["asdf"];

3815 
	go
.
push_back
(
Ãw
 
ObjeùModDesc
());

3816 
	go
.
back
()->
­³nd
(100);

3817 
	go
.
back
()->
£‰rs
(
©Œs
);

3818 
	go
.
push_back
(
Ãw
 
ObjeùModDesc
());

3819 
	go
.
back
()->
rmobjeù
(1001);

3820 
	go
.
push_back
(
Ãw
 
ObjeùModDesc
());

3821 
	go
.
back
()->
ü—‹
();

3822 
	go
.
back
()->
£‰rs
(
©Œs
);

3823 
	go
.
push_back
(
Ãw
 
ObjeùModDesc
());

3824 
	go
.
back
()->
ü—‹
();

3825 
	go
.
back
()->
£‰rs
(
©Œs
);

3826 
	go
.
back
()->
m¬k_uÄŞlbackabË
();

3827 
	go
.
back
()->
­³nd
(1000);

3830 
	gObjeùModDesc
::
	$’code
(
bufã¾i¡
 &
_bl
) const

3832 
	`ENCODE_START
(
max_»quœed_v”siÚ
, max_»quœed_v”siÚ, 
_bl
);

3833 
	`’code
(
ÿn_loÿl_rŞlback
, 
_bl
);

3834 
	`’code
(
rŞlback_šfo_com¶‘ed
, 
_bl
);

3835 
	`’code
(
bl
, 
_bl
);

3836 
	`ENCODE_FINISH
(
_bl
);

3837 
	}
}

3838 
	gObjeùModDesc
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
_bl
)

3840 
	`DECODE_START
(2, 
_bl
);

3841 
max_»quœed_v”siÚ
 = 
¡ruù_v
;

3842 
	`decode
(
ÿn_loÿl_rŞlback
, 
_bl
);

3843 
	`decode
(
rŞlback_šfo_com¶‘ed
, 
_bl
);

3844 
	`decode
(
bl
, 
_bl
);

3846 
bl
.
	`»bud
();

3847 
bl
.
	`»assign_to_mempoŞ
(
mempoŞ
::
mempoŞ_osd_pglog
);

3848 
	`DECODE_FINISH
(
_bl
);

3849 
	}
}

3853 
¡ršg
 
	gpg_log_’Œy_t
::
	$g‘_key_Çme
() const

3855  
v”siÚ
.
	`g‘_key_Çme
();

3856 
	}
}

3858 
	gpg_log_’Œy_t
::
	$’code_w™h_checksum
(
bufã¾i¡
& 
bl
) const

3860 
usšg
 
ûph
::
’code
;

3861 
bufã¾i¡
 
	`ebl
((*
this
)*2);

3862 
this
->
	`’code
(
ebl
);

3863 
__u32
 
üc
 = 
ebl
.
	`üc32c
(0);

3864 
	`’code
(
ebl
, 
bl
);

3865 
	`’code
(
üc
, 
bl
);

3866 
	}
}

3868 
	gpg_log_’Œy_t
::
	$decode_w™h_checksum
(
bufã¾i¡
::
™”©Ü
& 
p
)

3870 
usšg
 
ûph
::
decode
;

3871 
bufã¾i¡
 
bl
;

3872 
	`decode
(
bl
, 
p
);

3873 
__u32
 
üc
;

3874 
	`decode
(
üc
, 
p
);

3875 ià(
üc
 !ğ
bl
.
	`üc32c
(0))

3876 
throw
 
bufãr
::
	`m®fÜmed_šput
("bad checksum on…g_log_entry_t");

3877 
bufã¾i¡
::
™”©Ü
 
q
 = 
bl
.
	`begš
();

3878 
this
->
	`decode
(
q
);

3879 
	}
}

3881 
	gpg_log_’Œy_t
::
	$’code
(
bufã¾i¡
 &
bl
) const

3883 
	`ENCODE_START
(11, 4, 
bl
);

3884 
	`’code
(
İ
, 
bl
);

3885 
	`’code
(
soid
, 
bl
);

3886 
	`’code
(
v”siÚ
, 
bl
);

3895 ià(
İ
 =ğ
LOST_REVERT
)

3896 
	`’code
(
»v”tšg_to
, 
bl
);

3898 
	`’code
(
´iÜ_v”siÚ
, 
bl
);

3900 
	`’code
(
»qid
, 
bl
);

3901 
	`’code
(
mtime
, 
bl
);

3902 ià(
İ
 =ğ
LOST_REVERT
)

3903 
	`’code
(
´iÜ_v”siÚ
, 
bl
);

3904 
	`’code
(
¢­s
, 
bl
);

3905 
	`’code
(
u£r_v”siÚ
, 
bl
);

3906 
	`’code
(
mod_desc
, 
bl
);

3907 
	`’code
(
exŒa_»qids
, 
bl
);

3908 ià(
İ
 =ğ
ERROR
)

3909 
	`’code
(
»tuº_code
, 
bl
);

3910 
	`ENCODE_FINISH
(
bl
);

3911 
	}
}

3913 
	gpg_log_’Œy_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

3915 
	`DECODE_START_LEGACY_COMPAT_LEN
(11, 4, 4, 
bl
);

3916 
	`decode
(
İ
, 
bl
);

3917 ià(
¡ruù_v
 < 2) {

3918 
sobjeù_t
 
Şd_soid
;

3919 
	`decode
(
Şd_soid
, 
bl
);

3920 
soid
.
oid
 = 
Şd_soid
.oid;

3921 
soid
.
¢­
 = 
Şd_soid
.snap;

3922 
šv®id_hash
 = 
Œue
;

3924 
	`decode
(
soid
, 
bl
);

3926 ià(
¡ruù_v
 < 3)

3927 
šv®id_hash
 = 
Œue
;

3928 
	`decode
(
v”siÚ
, 
bl
);

3930 ià(
¡ruù_v
 >ğ6 && 
İ
 =ğ
LOST_REVERT
)

3931 
	`decode
(
»v”tšg_to
, 
bl
);

3933 
	`decode
(
´iÜ_v”siÚ
, 
bl
);

3935 
	`decode
(
»qid
, 
bl
);

3937 
	`decode
(
mtime
, 
bl
);

3938 ià(
¡ruù_v
 < 5)

3939 
šv®id_poŞ
 = 
Œue
;

3941 ià(
İ
 =ğ
LOST_REVERT
) {

3942 ià(
¡ruù_v
 >= 6) {

3943 
	`decode
(
´iÜ_v”siÚ
, 
bl
);

3945 
»v”tšg_to
 = 
´iÜ_v”siÚ
;

3948 ià(
¡ruù_v
 >= 7 ||

3949 
İ
 =ğ
CLONE
) {

3950 
	`decode
(
¢­s
, 
bl
);

3952 
¢­s
.
	`»bud
();

3953 
¢­s
.
	`»assign_to_mempoŞ
(
mempoŞ
::
mempoŞ_osd_pglog
);

3956 ià(
¡ruù_v
 >= 8)

3957 
	`decode
(
u£r_v”siÚ
, 
bl
);

3959 
u£r_v”siÚ
 = 
v”siÚ
.version;

3961 ià(
¡ruù_v
 >= 9)

3962 
	`decode
(
mod_desc
, 
bl
);

3964 
mod_desc
.
	`m¬k_uÄŞlbackabË
();

3965 ià(
¡ruù_v
 >= 10)

3966 
	`decode
(
exŒa_»qids
, 
bl
);

3967 ià(
¡ruù_v
 >ğ11 && 
İ
 =ğ
ERROR
)

3968 
	`decode
(
»tuº_code
, 
bl
);

3969 
	`DECODE_FINISH
(
bl
);

3970 
	}
}

3972 
	gpg_log_’Œy_t
::
	$dump
(
FÜm©‹r
 *
f
) const

3974 
f
->
	`dump_¡ršg
("İ", 
	`g‘_İ_Çme
());

3975 
f
->
	`dump_¡»am
("objeù"è<< 
soid
;

3976 
f
->
	`dump_¡»am
("v”siÚ"è<< 
v”siÚ
;

3977 
f
->
	`dump_¡»am
("´iÜ_v”siÚ"è<< 
´iÜ_v”siÚ
;

3978 
f
->
	`dump_¡»am
("»qid"è<< 
»qid
;

3979 
f
->
	`İ’_¬¿y_£ùiÚ
("extra_reqids");

3980 autØ
p
 = 
exŒa_»qids
.
	`begš
();

3981 
p
 !ğ
exŒa_»qids
.
	`’d
();

3982 ++
p
) {

3983 
f
->
	`İ’_objeù_£ùiÚ
("extra_reqid");

3984 
f
->
	`dump_¡»am
("»qid"è<< 
p
->
fœ¡
;

3985 
f
->
	`dump_¡»am
("u£r_v”siÚ"è<< 
p
->
£cÚd
;

3986 
f
->
	`şo£_£ùiÚ
();

3988 
f
->
	`şo£_£ùiÚ
();

3989 
f
->
	`dump_¡»am
("mtime"è<< 
mtime
;

3990 
f
->
	`dump_št
("»tuº_code", 
»tuº_code
);

3991 ià(
¢­s
.
	`Ëngth
() > 0) {

3992 
veùÜ
<
¢­id_t
> 
v
;

3993 
bufã¾i¡
 
c
 = 
¢­s
;

3994 
bufã¾i¡
::
™”©Ü
 
p
 = 
c
.
	`begš
();

3995 
Œy
 {

3996 
usšg
 
ûph
::
decode
;

3997 
	`decode
(
v
, 
p
);

3998 } 
	`ÿtch
 (...) {

3999 
v
.
	`ş—r
();

4001 
f
->
	`İ’_objeù_£ùiÚ
("snaps");

4002 
veùÜ
<
¢­id_t
>::
™”©Ü
 
p
 = 
v
.
	`begš
();… !ğv.
	`’d
(); ++p)

4003 
f
->
	`dump_unsigÃd
("¢­", *
p
);

4004 
f
->
	`şo£_£ùiÚ
();

4007 
f
->
	`İ’_objeù_£ùiÚ
("mod_desc");

4008 
mod_desc
.
	`dump
(
f
);

4009 
f
->
	`şo£_£ùiÚ
();

4011 
	}
}

4013 
	gpg_log_’Œy_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_log_’Œy_t
*>& 
o
)

4015 
o
.
push_back
(
Ãw
 
pg_log_’Œy_t
());

4016 
hobjeù_t
 
oid
(
objeù_t
("objname"), "key", 123, 456, 0, "");

4017 
	go
.
push_back
(
Ãw
 
pg_log_’Œy_t
(
MODIFY
, 
oid
, 
ev”siÚ_t
(1,2),ƒversion_t(3,4),

4018 1, 
osd_»qid_t
(
’t™y_Çme_t
::
CLIENT
(777), 8, 999),

4019 
utime_t
(8,9), 0));

4020 
	go
.
push_back
(
Ãw
 
pg_log_’Œy_t
(
ERROR
, 
oid
, 
ev”siÚ_t
(1,2),ƒversion_t(3,4),

4021 1, 
osd_»qid_t
(
’t™y_Çme_t
::
CLIENT
(777), 8, 999),

4022 
utime_t
(8,9), -
ENOENT
));

4025 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gpg_log_’Œy_t
& 
	ge
)

4027 
	gout
 << 
	ge
.
	gv”siÚ
 << " (" <<ƒ.
	g´iÜ_v”siÚ
 << ") "

4028 << 
	g¡d
::
Ëá
 << 
¡d
::
£tw
(8è<< 
e
.
g‘_İ_Çme
() << ' '

4029 << 
e
.
soid
 << " by " <<ƒ.
»qid
 << " " <<ƒ.
mtime


4030 << " " << 
e
.
»tuº_code
;

4031 ià(
	ge
.
	g¢­s
.
Ëngth
()) {

4032 
	gveùÜ
<
	g¢­id_t
> 
	g¢­s
;

4033 
bufã¾i¡
 
	gc
 = 
e
.
¢­s
;

4034 
	gbufã¾i¡
::
™”©Ü
 
p
 = 
c
.
begš
();

4035 
	gŒy
 {

4036 
decode
(
¢­s
, 
p
);

4037 } 
ÿtch
 (...) {

4038 
	g¢­s
.
ş—r
();

4040 
	gout
 << " sÇp " << 
	g¢­s
;

4042  
	gout
;

4047 
	g¡d
::
¡ršg
 
pg_log_dup_t
::
	$g‘_key_Çme
() const

4049 cÚ¡ 
´efix
[] = "dup_";

4050 
¡d
::
¡ršg
 
	`key
(36, ' ');

4051 
	`memıy
(&
key
[0], 
´efix
, 4);

4052 
v”siÚ
.
	`g‘_key_Çme
(&
key
[4]);

4053 
key
.
	`»size
(35);

4054  
key
;

4055 
	}
}

4057 
	gpg_log_dup_t
::
	$’code
(
bufã¾i¡
 &
bl
) const

4059 
	`ENCODE_START
(1, 1, 
bl
);

4060 
	`’code
(
»qid
, 
bl
);

4061 
	`’code
(
v”siÚ
, 
bl
);

4062 
	`’code
(
u£r_v”siÚ
, 
bl
);

4063 
	`’code
(
»tuº_code
, 
bl
);

4064 
	`ENCODE_FINISH
(
bl
);

4065 
	}
}

4067 
	gpg_log_dup_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

4069 
	`DECODE_START
(1, 
bl
);

4070 
	`decode
(
»qid
, 
bl
);

4071 
	`decode
(
v”siÚ
, 
bl
);

4072 
	`decode
(
u£r_v”siÚ
, 
bl
);

4073 
	`decode
(
»tuº_code
, 
bl
);

4074 
	`DECODE_FINISH
(
bl
);

4075 
	}
}

4077 
	gpg_log_dup_t
::
	$dump
(
FÜm©‹r
 *
f
) const

4079 
f
->
	`dump_¡»am
("»qid"è<< 
»qid
;

4080 
f
->
	`dump_¡»am
("v”siÚ"è<< 
v”siÚ
;

4081 
f
->
	`dump_¡»am
("u£r_v”siÚ"è<< 
u£r_v”siÚ
;

4082 
f
->
	`dump_¡»am
("»tuº_code"è<< 
»tuº_code
;

4083 
	}
}

4085 
	gpg_log_dup_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_log_dup_t
*>& 
o
)

4087 
o
.
push_back
(
Ãw
 
pg_log_dup_t
());

4088 
	go
.
push_back
(
Ãw
 
pg_log_dup_t
(
ev”siÚ_t
(1,2),

4090 
osd_»qid_t
(
’t™y_Çme_t
::
CLIENT
(777), 8, 999),

4092 
	go
.
push_back
(
Ãw
 
pg_log_dup_t
(
ev”siÚ_t
(1,2),

4094 
osd_»qid_t
(
’t™y_Çme_t
::
CLIENT
(777), 8, 999),

4095 -
ENOENT
));

4099 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
out
, cÚ¡ 
	gpg_log_dup_t
& 
	ge
) {

4100  
	gout
 << "log_dupÔeqid=" << 
	ge
.
	g»qid
 <<

4101 " v=" << 
	ge
.
	gv”siÚ
 << " uv=" <<ƒ.
	gu£r_v”siÚ
 <<

4102 "„c=" << 
	ge
.
	g»tuº_code
 << ")";

4110 
	gpg_log_t
::
	$f‹r_log
(
¥g_t
 
impÜt_pgid
, cÚ¡ 
OSDM­
 &
curm­
,

4111 cÚ¡ 
¡ršg
 &
h™_£t_Çme¥aû
, cÚ¡ 
pg_log_t
 &
š
,

4112 
pg_log_t
 &
out
,…g_log_ˆ&
»jeù
)

4114 
out
 = 
š
;

4115 
out
.
log
.
	`ş—r
();

4116 
»jeù
.
log
.
	`ş—r
();

4118 
li¡
<
pg_log_’Œy_t
>::
cÚ¡_™”©Ü
 
i
 = 
š
.
log
.
	`begš
();

4119 
i
 !ğ
š
.
log
.
	`’d
(); ++i) {

4122 ià(
i
->
soid
.
	`is_‹mp
()) {

4123 
»jeù
.
log
.
	`push_back
(*
i
);

4127 ià(
i
->
soid
.
n¥aû
 !ğ
h™_£t_Çme¥aû
) {

4128 
objeù_t
 
oid
 = 
i
->
soid
.oid;

4129 
objeù_loÿtÜ_t
 
	`loc
(
i
->
soid
);

4130 
pg_t
 
¿w_pgid
 = 
curm­
.
	`objeù_loÿtÜ_to_pg
(
oid
, 
loc
);

4131 
pg_t
 
pgid
 = 
curm­
.
	`¿w_pg_to_pg
(
¿w_pgid
);

4133 ià(
impÜt_pgid
.
pgid
 ==…gid) {

4134 
out
.
log
.
	`push_back
(*
i
);

4136 
»jeù
.
log
.
	`push_back
(*
i
);

4139 
out
.
log
.
	`push_back
(*
i
);

4142 
	}
}

4144 
	gpg_log_t
::
	$’code
(
bufã¾i¡
& 
bl
) const

4146 
	`ENCODE_START
(7, 3, 
bl
);

4147 
	`’code
(
h—d
, 
bl
);

4148 
	`’code
(

, 
bl
);

4149 
	`’code
(
log
, 
bl
);

4150 
	`’code
(
ÿn_rŞlback_to
, 
bl
);

4151 
	`’code
(
rŞlback_šfo_Œimmed_to
, 
bl
);

4152 
	`’code
(
dups
, 
bl
);

4153 
	`ENCODE_FINISH
(
bl
);

4154 
	}
}

4156 
	gpg_log_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
, 
št64_t
 
poŞ
)

4158 
	`DECODE_START_LEGACY_COMPAT_LEN
(7, 3, 3, 
bl
);

4159 
	`decode
(
h—d
, 
bl
);

4160 
	`decode
(

, 
bl
);

4161 ià(
¡ruù_v
 < 2) {

4162 
boŞ
 
backlog
;

4163 
	`decode
(
backlog
, 
bl
);

4165 
	`decode
(
log
, 
bl
);

4166 ià(
¡ruù_v
 >= 5)

4167 
	`decode
(
ÿn_rŞlback_to
, 
bl
);

4169 ià(
¡ruù_v
 >= 6)

4170 
	`decode
(
rŞlback_šfo_Œimmed_to
, 
bl
);

4172 
rŞlback_šfo_Œimmed_to
 = 

;

4174 ià(
¡ruù_v
 >= 7)

4175 
	`decode
(
dups
, 
bl
);

4177 
	`DECODE_FINISH
(
bl
);

4180 ià(
¡ruù_v
 < 4) {

4181 
li¡
<
pg_log_’Œy_t
>::
™”©Ü
 
i
 = 
log
.
	`begš
();

4182 
i
 !ğ
log
.
	`’d
();

4183 ++
i
) {

4184 ià(!
i
->
soid
.
	`is_max
(è&& i->soid.
poŞ
 == -1)

4185 
i
->
soid
.
poŞ
 =…ool;

4188 
	}
}

4190 
	gpg_log_t
::
	$dump
(
FÜm©‹r
 *
f
) const

4192 
f
->
	`dump_¡»am
("h—d"è<< 
h—d
;

4193 
f
->
	`dump_¡»am
(""è<< 

;

4194 
f
->
	`İ’_¬¿y_£ùiÚ
("log");

4195 
li¡
<
pg_log_’Œy_t
>::
cÚ¡_™”©Ü
 
p
 = 
log
.
	`begš
();… !ğlog.
	`’d
(); ++p) {

4196 
f
->
	`İ’_objeù_£ùiÚ
("entry");

4197 
p
->
	`dump
(
f
);

4198 
f
->
	`şo£_£ùiÚ
();

4200 
f
->
	`şo£_£ùiÚ
();

4201 
f
->
	`İ’_¬¿y_£ùiÚ
("dups");

4202 cÚ¡‡uto& 
’Œy
 : 
dups
) {

4203 
f
->
	`İ’_objeù_£ùiÚ
("entry");

4204 
’Œy
.
	`dump
(
f
);

4205 
f
->
	`şo£_£ùiÚ
();

4207 
f
->
	`şo£_£ùiÚ
();

4208 
	}
}

4210 
	gpg_log_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_log_t
*>& 
o
)

4212 
o
.
push_back
(
Ãw
 
pg_log_t
);

4215 
	go
.
push_back
(
Ãw
 
pg_log_t
);

4216 
	go
.
back
()->
	gh—d
 = 
ev”siÚ_t
(1,2);

4217 
	go
.
back
()->
	g
 = 
ev”siÚ_t
(3,4);

4218 
	gli¡
<
	gpg_log_’Œy_t
*> 
	ge
;

4219 
	gpg_log_’Œy_t
::
g’”©e_‹¡_š¡ªûs
(
e
);

4220 
	gli¡
<
	gpg_log_’Œy_t
*>::
™”©Ü
 
p
 = 
e
.
begš
(); 
	gp
 !ğe.
’d
(); ++p)

4221 
	go
.
back
()->
	glog
.
push_back
(**
p
);

4224 
	gpg_log_t
::
	$cİy_aá”
(cÚ¡ 
pg_log_t
 &
Ùh”
, 
ev”siÚ_t
 
v
)

4226 
ÿn_rŞlback_to
 = 
Ùh”
.can_rollback_to;

4227 
h—d
 = 
Ùh”
.head;

4228 

 = 
Ùh”
.tail;

4229 
li¡
<
pg_log_’Œy_t
>::
cÚ¡_»v”£_™”©Ü
 
i
 = 
Ùh”
.
log
.
	`rbegš
();

4230 
i
 !ğ
Ùh”
.
log
.
	`»nd
();

4231 ++
i
) {

4232 
	`as£¹
(
i
->
v”siÚ
 > 
Ùh”
.

);

4233 ià(
i
->
v”siÚ
 <ğ
v
) {

4235 

 = 
i
->
v”siÚ
;

4238 
log
.
	`push_äÚt
(*
i
);

4240 
	}
}

4242 
	gpg_log_t
::
	$cİy_¿nge
(cÚ¡ 
pg_log_t
 &
Ùh”
, 
ev”siÚ_t
 
äom
,ƒv”siÚ_ˆ
to
)

4244 
ÿn_rŞlback_to
 = 
Ùh”
.can_rollback_to;

4245 
li¡
<
pg_log_’Œy_t
>::
cÚ¡_»v”£_™”©Ü
 
i
 = 
Ùh”
.
log
.
	`rbegš
();

4246 
	`as£¹
(
i
 !ğ
Ùh”
.
log
.
	`»nd
());

4247 
i
->
v”siÚ
 > 
to
) {

4248 ++
i
;

4249 
	`as£¹
(
i
 !ğ
Ùh”
.
log
.
	`»nd
());

4251 
	`as£¹
(
i
->
v”siÚ
 =ğ
to
);

4252 
h—d
 = 
to
;

4253  ; 
i
 !ğ
Ùh”
.
log
.
	`»nd
(); ++i) {

4254 ià(
i
->
v”siÚ
 <ğ
äom
) {

4255 

 = 
i
->
v”siÚ
;

4258 
log
.
	`push_äÚt
(*
i
);

4260 
	}
}

4262 
	gpg_log_t
::
	$cİy_up_to
(cÚ¡ 
pg_log_t
 &
Ùh”
, 
max
)

4264 
ÿn_rŞlback_to
 = 
Ùh”
.can_rollback_to;

4265 
n
 = 0;

4266 
h—d
 = 
Ùh”
.head;

4267 

 = 
Ùh”
.tail;

4268 
li¡
<
pg_log_’Œy_t
>::
cÚ¡_»v”£_™”©Ü
 
i
 = 
Ùh”
.
log
.
	`rbegš
();

4269 
i
 !ğ
Ùh”
.
log
.
	`»nd
();

4270 ++
i
) {

4271 ià(
n
++ >ğ
max
) {

4272 

 = 
i
->
v”siÚ
;

4275 
log
.
	`push_äÚt
(*
i
);

4277 
	}
}

4279 
	go¡»am
& 
	gpg_log_t
::
	$´št
(
o¡»am
& 
out
) const

4281 
out
 << *
this
 << 
¡d
::
’dl
;

4282 
li¡
<
pg_log_’Œy_t
>::
cÚ¡_™”©Ü
 
p
 = 
log
.
	`begš
();

4283 
p
 !ğ
log
.
	`’d
();

4284 ++
p
)

4285 
out
 << *
p
 << 
¡d
::
’dl
;

4286 cÚ¡‡uto& 
’Œy
 : 
dups
) {

4287 
out
 << " du°’Œy: " << 
’Œy
 << 
¡d
::
’dl
;

4289  
out
;

4290 
	}
}

4294 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gpg_missšg_™em
& 
	gi
)

4296 
	gout
 << 
	gi
.
	gÃed
;

4297 ià(
	gi
.
	ghave
 !ğ
ev”siÚ_t
())

4298 
out
 << "(" << 
i
.
have
 << ")";

4299 
	gout
 << " fÏg ğ" << 
	gi
.
æag_¡r
();

4300  
	gout
;

4305 
	gobjeù_cİy_cursÜ_t
::
	$’code
(
bufã¾i¡
& 
bl
) const

4307 
	`ENCODE_START
(1, 1, 
bl
);

4308 
	`’code
(
©Œ_com¶‘e
, 
bl
);

4309 
	`’code
(
d©a_off£t
, 
bl
);

4310 
	`’code
(
d©a_com¶‘e
, 
bl
);

4311 
	`’code
(
om­_off£t
, 
bl
);

4312 
	`’code
(
om­_com¶‘e
, 
bl
);

4313 
	`ENCODE_FINISH
(
bl
);

4314 
	}
}

4316 
	gobjeù_cİy_cursÜ_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

4318 
	`DECODE_START
(1, 
bl
);

4319 
	`decode
(
©Œ_com¶‘e
, 
bl
);

4320 
	`decode
(
d©a_off£t
, 
bl
);

4321 
	`decode
(
d©a_com¶‘e
, 
bl
);

4322 
	`decode
(
om­_off£t
, 
bl
);

4323 
	`decode
(
om­_com¶‘e
, 
bl
);

4324 
	`DECODE_FINISH
(
bl
);

4325 
	}
}

4327 
	gobjeù_cİy_cursÜ_t
::
	$dump
(
FÜm©‹r
 *
f
) const

4329 
f
->
	`dump_unsigÃd
("©Œ_com¶‘e", ()
©Œ_com¶‘e
);

4330 
f
->
	`dump_unsigÃd
("d©a_off£t", 
d©a_off£t
);

4331 
f
->
	`dump_unsigÃd
("d©a_com¶‘e", ()
d©a_com¶‘e
);

4332 
f
->
	`dump_¡ršg
("om­_off£t", 
om­_off£t
);

4333 
f
->
	`dump_unsigÃd
("om­_com¶‘e", ()
om­_com¶‘e
);

4334 
	}
}

4336 
	gobjeù_cİy_cursÜ_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
objeù_cİy_cursÜ_t
*>& 
o
)

4338 
o
.
push_back
(
Ãw
 
objeù_cİy_cursÜ_t
);

4339 
	go
.
push_back
(
Ãw
 
objeù_cİy_cursÜ_t
);

4340 
	go
.
back
()->
	g©Œ_com¶‘e
 = 
Œue
;

4341 
	go
.
back
()->
	gd©a_off£t
 = 123;

4342 
	go
.
push_back
(
Ãw
 
objeù_cİy_cursÜ_t
);

4343 
	go
.
back
()->
	g©Œ_com¶‘e
 = 
Œue
;

4344 
	go
.
back
()->
	gd©a_com¶‘e
 = 
Œue
;

4345 
	go
.
back
()->
	gom­_off£t
 = "foo";

4346 
	go
.
push_back
(
Ãw
 
objeù_cİy_cursÜ_t
);

4347 
	go
.
back
()->
	g©Œ_com¶‘e
 = 
Œue
;

4348 
	go
.
back
()->
	gd©a_com¶‘e
 = 
Œue
;

4349 
	go
.
back
()->
	gom­_com¶‘e
 = 
Œue
;

4354 
	gobjeù_cİy_d©a_t
::
	$’code
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
) const

4356 
	`ENCODE_START
(7, 5, 
bl
);

4357 
	`’code
(
size
, 
bl
);

4358 
	`’code
(
mtime
, 
bl
);

4359 
	`’code
(
©Œs
, 
bl
);

4360 
	`’code
(
d©a
, 
bl
);

4361 
	`’code
(
om­_d©a
, 
bl
);

4362 
	`’code
(
cursÜ
, 
bl
);

4363 
	`’code
(
om­_h—d”
, 
bl
);

4364 
	`’code
(
¢­s
, 
bl
);

4365 
	`’code
(
¢­_£q
, 
bl
);

4366 
	`’code
(
æags
, 
bl
);

4367 
	`’code
(
d©a_dige¡
, 
bl
);

4368 
	`’code
(
om­_dige¡
, 
bl
);

4369 
	`’code
(
»qids
, 
bl
);

4370 
	`’code
(
Œunÿ‹_£q
, 
bl
);

4371 
	`’code
(
Œunÿ‹_size
, 
bl
);

4372 
	`ENCODE_FINISH
(
bl
);

4373 
	}
}

4375 
	gobjeù_cİy_d©a_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
)

4377 
	`DECODE_START
(7, 
bl
);

4378 ià(
¡ruù_v
 < 5) {

4380 
	`decode
(
size
, 
bl
);

4381 
	`decode
(
mtime
, 
bl
);

4383 
¡ršg
 
ÿ‹gÜy
;

4384 
	`decode
(
ÿ‹gÜy
, 
bl
);

4386 
	`decode
(
©Œs
, 
bl
);

4387 
	`decode
(
d©a
, 
bl
);

4389 
m­
<
¡ršg
,
bufã¾i¡
> 
om­
;

4390 
	`decode
(
om­
, 
bl
);

4391 
om­_d©a
.
	`ş—r
();

4392 ià(!
om­
.
	`em±y
()) {

4393 
usšg
 
ûph
::
’code
;

4394 
	`’code
(
om­
, 
om­_d©a
);

4397 
	`decode
(
cursÜ
, 
bl
);

4398 ià(
¡ruù_v
 >= 2)

4399 
	`decode
(
om­_h—d”
, 
bl
);

4400 ià(
¡ruù_v
 >= 3) {

4401 
	`decode
(
¢­s
, 
bl
);

4402 
	`decode
(
¢­_£q
, 
bl
);

4404 
¢­s
.
	`ş—r
();

4405 
¢­_£q
 = 0;

4407 ià(
¡ruù_v
 >= 4) {

4408 
	`decode
(
æags
, 
bl
);

4409 
	`decode
(
d©a_dige¡
, 
bl
);

4410 
	`decode
(
om­_dige¡
, 
bl
);

4414 
	`decode
(
size
, 
bl
);

4415 
	`decode
(
mtime
, 
bl
);

4416 
	`decode
(
©Œs
, 
bl
);

4417 
	`decode
(
d©a
, 
bl
);

4418 
	`decode
(
om­_d©a
, 
bl
);

4419 
	`decode
(
cursÜ
, 
bl
);

4420 
	`decode
(
om­_h—d”
, 
bl
);

4421 
	`decode
(
¢­s
, 
bl
);

4422 
	`decode
(
¢­_£q
, 
bl
);

4423 ià(
¡ruù_v
 >= 4) {

4424 
	`decode
(
æags
, 
bl
);

4425 
	`decode
(
d©a_dige¡
, 
bl
);

4426 
	`decode
(
om­_dige¡
, 
bl
);

4428 ià(
¡ruù_v
 >= 6) {

4429 
	`decode
(
»qids
, 
bl
);

4431 ià(
¡ruù_v
 >= 7) {

4432 
	`decode
(
Œunÿ‹_£q
, 
bl
);

4433 
	`decode
(
Œunÿ‹_size
, 
bl
);

4436 
	`DECODE_FINISH
(
bl
);

4437 
	}
}

4439 
	gobjeù_cİy_d©a_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
objeù_cİy_d©a_t
*>& 
o
)

4441 
o
.
push_back
(
Ãw
 
objeù_cİy_d©a_t
());

4443 
	gli¡
<
	gobjeù_cİy_cursÜ_t
*> 
	gcursÜs
;

4444 
	gobjeù_cİy_cursÜ_t
::
g’”©e_‹¡_š¡ªûs
(
cursÜs
);

4445 
	gli¡
<
	gobjeù_cİy_cursÜ_t
*>::
™”©Ü
 
ci
 = 
cursÜs
.
begš
();

4446 
	go
.
back
()->
	gcursÜ
 = **(
ci
++);

4448 
	go
.
push_back
(
Ãw
 
objeù_cİy_d©a_t
());

4449 
	go
.
back
()->
	gcursÜ
 = **(
ci
++);

4451 
	go
.
push_back
(
Ãw
 
objeù_cİy_d©a_t
());

4452 
	go
.
back
()->
	gsize
 = 1234;

4453 
	go
.
back
()->
	gmtime
.
£t_äom_doubË
(1234);

4454 
bufã½Œ
 
bp
("there", 5);

4455 
bufã¾i¡
 
	gbl
;

4456 
	gbl
.
push_back
(
bp
);

4457 
	go
.
back
()->
	g©Œs
["h–lo"] = 
bl
;

4458 
bufã½Œ
 
bp2
("not", 3);

4459 
bufã¾i¡
 
	gbl2
;

4460 
	gbl2
.
push_back
(
bp2
);

4461 
	gm­
<
	g¡ršg
,
	gbufã¾i¡
> 
	gom­
;

4462 
	gom­
["why"] = 
bl2
;

4463 
usšg
 
	gûph
::
’code
;

4464 
’code
(
om­
, 
o
.
back
()->
om­_d©a
);

4465 
bufã½Œ
 
d©abp
("iamsomedatatocontain", 20);

4466 
	go
.
back
()->
	gd©a
.
push_back
(
d©abp
);

4467 
	go
.
back
()->
	gom­_h—d”
.
­³nd
("this is‡n omap header");

4468 
	go
.
back
()->
	g¢­s
.
push_back
(123);

4469 
	go
.
back
()->
	g»qids
.
push_back
(
make_·œ
(
osd_»qid_t
(), 
v”siÚ_t
()));

4472 
	gobjeù_cİy_d©a_t
::
	$dump
(
FÜm©‹r
 *
f
) const

4474 
f
->
	`İ’_objeù_£ùiÚ
("cursor");

4475 
cursÜ
.
	`dump
(
f
);

4476 
f
->
	`şo£_£ùiÚ
();

4477 
f
->
	`dump_št
("size", 
size
);

4478 
f
->
	`dump_¡»am
("mtime"è<< 
mtime
;

4481 
f
->
	`dump_št
("©Œs_size", 
©Œs
.
	`size
());

4482 
f
->
	`dump_št
("æags", 
æags
);

4483 
f
->
	`dump_unsigÃd
("d©a_dige¡", 
d©a_dige¡
);

4484 
f
->
	`dump_unsigÃd
("om­_dige¡", 
om­_dige¡
);

4485 
f
->
	`dump_št
("om­_d©a_Ëngth", 
om­_d©a
.
	`Ëngth
());

4486 
f
->
	`dump_št
("om­_h—d”_Ëngth", 
om­_h—d”
.
	`Ëngth
());

4487 
f
->
	`dump_št
("d©a_Ëngth", 
d©a
.
	`Ëngth
());

4488 
f
->
	`İ’_¬¿y_£ùiÚ
("snaps");

4489 
veùÜ
<
¢­id_t
>::
cÚ¡_™”©Ü
 
p
 = 
¢­s
.
	`begš
();

4490 
p
 !ğ
¢­s
.
	`’d
(); ++p)

4491 
f
->
	`dump_unsigÃd
("¢­", *
p
);

4492 
f
->
	`şo£_£ùiÚ
();

4493 
f
->
	`İ’_¬¿y_£ùiÚ
("reqids");

4494 autØ
p
 = 
»qids
.
	`begš
();

4495 
p
 !ğ
»qids
.
	`’d
();

4496 ++
p
) {

4497 
f
->
	`İ’_objeù_£ùiÚ
("extra_reqid");

4498 
f
->
	`dump_¡»am
("»qid"è<< 
p
->
fœ¡
;

4499 
f
->
	`dump_¡»am
("u£r_v”siÚ"è<< 
p
->
£cÚd
;

4500 
f
->
	`şo£_£ùiÚ
();

4502 
f
->
	`şo£_£ùiÚ
();

4503 
	}
}

4507 
	gpg_ü—‹_t
::
	$’code
(
bufã¾i¡
 &
bl
) const

4509 
	`ENCODE_START
(1, 1, 
bl
);

4510 
	`’code
(
ü—‹d
, 
bl
);

4511 
	`’code
(
·»Á
, 
bl
);

4512 
	`’code
(
¥l™_b™s
, 
bl
);

4513 
	`ENCODE_FINISH
(
bl
);

4514 
	}
}

4516 
	gpg_ü—‹_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

4518 
	`DECODE_START
(1, 
bl
);

4519 
	`decode
(
ü—‹d
, 
bl
);

4520 
	`decode
(
·»Á
, 
bl
);

4521 
	`decode
(
¥l™_b™s
, 
bl
);

4522 
	`DECODE_FINISH
(
bl
);

4523 
	}
}

4525 
	gpg_ü—‹_t
::
	$dump
(
FÜm©‹r
 *
f
) const

4527 
f
->
	`dump_unsigÃd
("ü—‹d", 
ü—‹d
);

4528 
f
->
	`dump_¡»am
("·»Á"è<< 
·»Á
;

4529 
f
->
	`dump_št
("¥l™_b™s", 
¥l™_b™s
);

4530 
	}
}

4532 
	gpg_ü—‹_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_ü—‹_t
*>& 
o
)

4534 
o
.
push_back
(
Ãw
 
pg_ü—‹_t
);

4535 
	go
.
push_back
(
Ãw
 
pg_ü—‹_t
(1, 
pg_t
(3, 4), 2));

4541 
	gpg_h™_£t_šfo_t
::
	$’code
(
bufã¾i¡
& 
bl
) const

4543 
	`ENCODE_START
(2, 1, 
bl
);

4544 
	`’code
(
begš
, 
bl
);

4545 
	`’code
(
’d
, 
bl
);

4546 
	`’code
(
v”siÚ
, 
bl
);

4547 
	`’code
(
usšg_gmt
, 
bl
);

4548 
	`ENCODE_FINISH
(
bl
);

4549 
	}
}

4551 
	gpg_h™_£t_šfo_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
p
)

4553 
	`DECODE_START
(2, 
p
);

4554 
	`decode
(
begš
, 
p
);

4555 
	`decode
(
’d
, 
p
);

4556 
	`decode
(
v”siÚ
, 
p
);

4557 ià(
¡ruù_v
 >= 2) {

4558 
	`decode
(
usšg_gmt
, 
p
);

4560 
usšg_gmt
 = 
çl£
;

4562 
	`DECODE_FINISH
(
p
);

4563 
	}
}

4565 
	gpg_h™_£t_šfo_t
::
	$dump
(
FÜm©‹r
 *
f
) const

4567 
f
->
	`dump_¡»am
("begš"è<< 
begš
;

4568 
f
->
	`dump_¡»am
("’d"è<< 
’d
;

4569 
f
->
	`dump_¡»am
("v”siÚ"è<< 
v”siÚ
;

4570 
f
->
	`dump_¡»am
("usšg_gmt"è<< 
usšg_gmt
;

4571 
	}
}

4573 
	gpg_h™_£t_šfo_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_h™_£t_šfo_t
*>& 
ls
)

4575 
ls
.
push_back
(
Ãw
 
pg_h™_£t_šfo_t
);

4576 
	gls
.
push_back
(
Ãw
 
pg_h™_£t_šfo_t
);

4577 
	gls
.
back
()->
	gbegš
 = 
utime_t
(1, 2);

4578 
	gls
.
back
()->
	g’d
 = 
utime_t
(3, 4);

4584 
	gpg_h™_£t_hi¡Üy_t
::
	$’code
(
bufã¾i¡
& 
bl
) const

4586 
	`ENCODE_START
(1, 1, 
bl
);

4587 
	`’code
(
cu¼’t_Ï¡_upd©e
, 
bl
);

4589 
utime_t
 
dummy_¡amp
;

4590 
	`’code
(
dummy_¡amp
, 
bl
);

4593 
pg_h™_£t_šfo_t
 
dummy_šfo
;

4594 
	`’code
(
dummy_šfo
, 
bl
);

4596 
	`’code
(
hi¡Üy
, 
bl
);

4597 
	`ENCODE_FINISH
(
bl
);

4598 
	}
}

4600 
	gpg_h™_£t_hi¡Üy_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
p
)

4602 
	`DECODE_START
(1, 
p
);

4603 
	`decode
(
cu¼’t_Ï¡_upd©e
, 
p
);

4605 
utime_t
 
dummy_¡amp
;

4606 
	`decode
(
dummy_¡amp
, 
p
);

4609 
pg_h™_£t_šfo_t
 
dummy_šfo
;

4610 
	`decode
(
dummy_šfo
, 
p
);

4612 
	`decode
(
hi¡Üy
, 
p
);

4613 
	`DECODE_FINISH
(
p
);

4614 
	}
}

4616 
	gpg_h™_£t_hi¡Üy_t
::
	$dump
(
FÜm©‹r
 *
f
) const

4618 
f
->
	`dump_¡»am
("cu¼’t_Ï¡_upd©e"è<< 
cu¼’t_Ï¡_upd©e
;

4619 
f
->
	`İ’_¬¿y_£ùiÚ
("history");

4620 
li¡
<
pg_h™_£t_šfo_t
>::
cÚ¡_™”©Ü
 
p
 = 
hi¡Üy
.
	`begš
();

4621 
p
 !ğ
hi¡Üy
.
	`’d
(); ++p) {

4622 
f
->
	`İ’_objeù_£ùiÚ
("info");

4623 
p
->
	`dump
(
f
);

4624 
f
->
	`şo£_£ùiÚ
();

4626 
f
->
	`şo£_£ùiÚ
();

4627 
	}
}

4629 
	gpg_h™_£t_hi¡Üy_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_h™_£t_hi¡Üy_t
*>& 
ls
)

4631 
ls
.
push_back
(
Ãw
 
pg_h™_£t_hi¡Üy_t
);

4632 
	gls
.
push_back
(
Ãw
 
pg_h™_£t_hi¡Üy_t
);

4633 
	gls
.
back
()->
	gcu¼’t_Ï¡_upd©e
 = 
ev”siÚ_t
(1, 2);

4634 
	gls
.
back
()->
	ghi¡Üy
.
push_back
(
pg_h™_£t_šfo_t
());

4639 
	gOSDSu³rblock
::
	$’code
(
bufã¾i¡
 &
bl
) const

4641 
	`ENCODE_START
(8, 5, 
bl
);

4642 
	`’code
(
şu¡”_fsid
, 
bl
);

4643 
	`’code
(
whßmi
, 
bl
);

4644 
	`’code
(
cu¼’t_•och
, 
bl
);

4645 
	`’code
(
Şde¡_m­
, 
bl
);

4646 
	`’code
(
Ãwe¡_m­
, 
bl
);

4647 
	`’code
(
weight
, 
bl
);

4648 
com·t_ã©u»s
.
	`’code
(
bl
);

4649 
	`’code
(
ş—n_thru
, 
bl
);

4650 
	`’code
(
mouÁed
, 
bl
);

4651 
	`’code
(
osd_fsid
, 
bl
);

4652 
	`’code
((
•och_t
)0, 
bl
);

4653 
	`’code
((
ušt32_t
)0, 
bl
);

4654 
	`ENCODE_FINISH
(
bl
);

4655 
	}
}

4657 
	gOSDSu³rblock
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

4659 
	`DECODE_START_LEGACY_COMPAT_LEN
(8, 5, 5, 
bl
);

4660 ià(
¡ruù_v
 < 3) {

4661 
¡ršg
 
magic
;

4662 
	`decode
(
magic
, 
bl
);

4664 
	`decode
(
şu¡”_fsid
, 
bl
);

4665 
	`decode
(
whßmi
, 
bl
);

4666 
	`decode
(
cu¼’t_•och
, 
bl
);

4667 
	`decode
(
Şde¡_m­
, 
bl
);

4668 
	`decode
(
Ãwe¡_m­
, 
bl
);

4669 
	`decode
(
weight
, 
bl
);

4670 ià(
¡ruù_v
 >= 2) {

4671 
com·t_ã©u»s
.
	`decode
(
bl
);

4673 
com·t_ã©u»s
.
šcom·t
.
	`š£¹
(
CEPH_OSD_FEATURE_INCOMPAT_BASE
);

4675 
	`decode
(
ş—n_thru
, 
bl
);

4676 
	`decode
(
mouÁed
, 
bl
);

4677 ià(
¡ruù_v
 >= 4)

4678 
	`decode
(
osd_fsid
, 
bl
);

4679 ià(
¡ruù_v
 >= 6) {

4680 
•och_t
 
Ï¡_m­_m¬ked_fuÎ
;

4681 
	`decode
(
Ï¡_m­_m¬ked_fuÎ
, 
bl
);

4683 ià(
¡ruù_v
 >= 7) {

4684 
m­
<
št64_t
,
•och_t
> 
poŞ_Ï¡_m­_m¬ked_fuÎ
;

4685 
	`decode
(
poŞ_Ï¡_m­_m¬ked_fuÎ
, 
bl
);

4687 
	`DECODE_FINISH
(
bl
);

4688 
	}
}

4690 
	gOSDSu³rblock
::
	$dump
(
FÜm©‹r
 *
f
) const

4692 
f
->
	`dump_¡»am
("şu¡”_fsid"è<< 
şu¡”_fsid
;

4693 
f
->
	`dump_¡»am
("osd_fsid"è<< 
osd_fsid
;

4694 
f
->
	`dump_št
("whßmi", 
whßmi
);

4695 
f
->
	`dump_št
("cu¼’t_•och", 
cu¼’t_•och
);

4696 
f
->
	`dump_št
("Şde¡_m­", 
Şde¡_m­
);

4697 
f
->
	`dump_št
("Ãwe¡_m­", 
Ãwe¡_m­
);

4698 
f
->
	`dump_æßt
("weight", 
weight
);

4699 
f
->
	`İ’_objeù_£ùiÚ
("compat");

4700 
com·t_ã©u»s
.
	`dump
(
f
);

4701 
f
->
	`şo£_£ùiÚ
();

4702 
f
->
	`dump_št
("ş—n_thru", 
ş—n_thru
);

4703 
f
->
	`dump_št
("Ï¡_•och_mouÁed", 
mouÁed
);

4704 
	}
}

4706 
	gOSDSu³rblock
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
OSDSu³rblock
*>& 
o
)

4708 
OSDSu³rblock
 
z
;

4709 
	go
.
push_back
(
Ãw
 
OSDSu³rblock
(
z
));

4710 
	gz
.
	gşu¡”_fsid
.
·r£
("01010101-0101-0101-0101-010101010101");

4711 
	gz
.
	gosd_fsid
.
·r£
("02020202-0202-0202-0202-020202020202");

4712 
	gz
.
	gwhßmi
 = 3;

4713 
	gz
.
	gcu¼’t_•och
 = 4;

4714 
	gz
.
	gŞde¡_m­
 = 5;

4715 
	gz
.
	gÃwe¡_m­
 = 9;

4716 
	gz
.
	gmouÁed
 = 8;

4717 
	gz
.
	gş—n_thru
 = 7;

4718 
	go
.
push_back
(
Ãw
 
OSDSu³rblock
(
z
));

4719 
	go
.
push_back
(
Ãw
 
OSDSu³rblock
(
z
));

4724 
	gSÇpS‘
::
	$’code
(
bufã¾i¡
& 
bl
) const

4726 
	`ENCODE_START
(3, 2, 
bl
);

4727 
	`’code
(
£q
, 
bl
);

4728 
	`’code
(
Œue
, 
bl
);

4729 
	`’code
(
¢­s
, 
bl
);

4730 
	`’code
(
şÚes
, 
bl
);

4731 
	`’code
(
şÚe_ov”Ïp
, 
bl
);

4732 
	`’code
(
şÚe_size
, 
bl
);

4733 
	`’code
(
şÚe_¢­s
, 
bl
);

4734 
	`ENCODE_FINISH
(
bl
);

4735 
	}
}

4737 
	gSÇpS‘
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
)

4739 
	`DECODE_START_LEGACY_COMPAT_LEN
(3, 2, 2, 
bl
);

4740 
	`decode
(
£q
, 
bl
);

4741 
bl
.
	`advªû
(1);

4742 
	`decode
(
¢­s
, 
bl
);

4743 
	`decode
(
şÚes
, 
bl
);

4744 
	`decode
(
şÚe_ov”Ïp
, 
bl
);

4745 
	`decode
(
şÚe_size
, 
bl
);

4746 ià(
¡ruù_v
 >= 3) {

4747 
	`decode
(
şÚe_¢­s
, 
bl
);

4749 
şÚe_¢­s
.
	`ş—r
();

4751 
	`DECODE_FINISH
(
bl
);

4752 
	}
}

4754 
	gSÇpS‘
::
	$dump
(
FÜm©‹r
 *
f
) const

4756 
SÇpCÚ‹xt
 
	`sc
(
£q
, 
¢­s
);

4757 
f
->
	`İ’_objeù_£ùiÚ
("snap_context");

4758 
sc
.
	`dump
(
f
);

4759 
f
->
	`şo£_£ùiÚ
();

4760 
f
->
	`İ’_¬¿y_£ùiÚ
("clones");

4761 
veùÜ
<
¢­id_t
>::
cÚ¡_™”©Ü
 
p
 = 
şÚes
.
	`begš
();… !ğşÚes.
	`’d
(); ++p) {

4762 
f
->
	`İ’_objeù_£ùiÚ
("clone");

4763 
f
->
	`dump_unsigÃd
("¢­", *
p
);

4764 autØ
cs
 = 
şÚe_size
.
	`fšd
(*
p
);

4765 ià(
cs
 !ğ
şÚe_size
.
	`’d
())

4766 
f
->
	`dump_unsigÃd
("size", 
cs
->
£cÚd
);

4768 
f
->
	`dump_¡ršg
("size", "????");

4769 autØ
co
 = 
şÚe_ov”Ïp
.
	`fšd
(*
p
);

4770 ià(
co
 !ğ
şÚe_ov”Ïp
.
	`’d
())

4771 
f
->
	`dump_¡»am
("ov”Ïp"è<< 
co
->
£cÚd
;

4773 
f
->
	`dump_¡»am
("overlap") << "????";

4774 autØ
q
 = 
şÚe_¢­s
.
	`fšd
(*
p
);

4775 ià(
q
 !ğ
şÚe_¢­s
.
	`’d
()) {

4776 
f
->
	`İ’_¬¿y_£ùiÚ
("snaps");

4777 autØ
s
 : 
q
->
£cÚd
) {

4778 
f
->
	`dump_unsigÃd
("¢­", 
s
);

4780 
f
->
	`şo£_£ùiÚ
();

4782 
f
->
	`şo£_£ùiÚ
();

4784 
f
->
	`şo£_£ùiÚ
();

4785 
	}
}

4787 
	gSÇpS‘
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
SÇpS‘
*>& 
o
)

4789 
o
.
push_back
(
Ãw
 
SÇpS‘
);

4790 
	go
.
push_back
(
Ãw
 
SÇpS‘
);

4791 
	go
.
back
()->
	g£q
 = 123;

4792 
	go
.
back
()->
	g¢­s
.
push_back
(123);

4793 
	go
.
back
()->
	g¢­s
.
push_back
(12);

4794 
	go
.
push_back
(
Ãw
 
SÇpS‘
);

4795 
	go
.
back
()->
	g£q
 = 123;

4796 
	go
.
back
()->
	g¢­s
.
push_back
(123);

4797 
	go
.
back
()->
	g¢­s
.
push_back
(12);

4798 
	go
.
back
()->
	gşÚes
.
push_back
(12);

4799 
	go
.
back
()->
	gşÚe_size
[12] = 12345;

4800 
	go
.
back
()->
	gşÚe_ov”Ïp
[12];

4801 
	go
.
back
()->
	gşÚe_¢­s
[12] = {12, 10, 8};

4804 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gSÇpS‘
& 
	gcs
)

4806  
	gout
 << 
	gcs
.
	g£q
 << "=" << cs.
	g¢­s
 << ":"

4807 << 
	gcs
.
	gşÚe_¢­s
;

4810 
	gSÇpS‘
::
	$äom_¢­_£t
(cÚ¡ 
lib¿dos
::
¢­_£t_t
& 
ss
, 
boŞ
 
Ëgacy
)

4819 
£q
 = 
ss
.seq;

4820 
£t
<
¢­id_t
> 
_¢­s
;

4821 
£t
<
¢­id_t
> 
_şÚes
;

4822 
veùÜ
<
lib¿dos
::
şÚe_šfo_t
>::
cÚ¡_™”©Ü
 
p
 = 
ss
.
şÚes
.
	`begš
();

4823 
p
 !ğ
ss
.
şÚes
.
	`’d
();

4824 ++
p
) {

4825 ià(
p
->
şÚeid
 !ğ
lib¿dos
::
SNAP_HEAD
) {

4826 
_şÚes
.
	`š£¹
(
p
->
şÚeid
);

4827 
_¢­s
.
	`š£¹
(
p
->
¢­s
.
	`begš
(),…->¢­s.
	`’d
());

4828 
şÚe_size
[
p
->
şÚeid
] =…->
size
;

4829 
şÚe_ov”Ïp
[
p
->
şÚeid
];

4830 
veùÜ
<
·œ
<
ušt64_t
, ušt64_t> >::
cÚ¡_™”©Ü
 
q
 =

4831 
p
->
ov”Ïp
.
	`begš
(); 
q
 !ğp->ov”Ïp.
	`’d
(); ++q)

4832 
şÚe_ov”Ïp
[
p
->
şÚeid
].
	`š£¹
(
q
->
fœ¡
, q->
£cÚd
);

4833 ià(!
Ëgacy
) {

4835 
veùÜ
<
¢­id_t
>& 
v
 = 
şÚe_¢­s
[
p
->
şÚeid
];

4836 autØ
q
 = 
p
->
¢­s
.
	`rbegš
(); q !ğp->¢­s.
	`»nd
(); ++q) {

4837 
v
.
	`push_back
(*
q
);

4844 
şÚes
.
	`ş—r
();

4845 
şÚes
.
	`»£rve
(
_şÚes
.
	`size
());

4846 
£t
<
¢­id_t
>::
™”©Ü
 
p
 = 
_şÚes
.
	`begš
();… !ğ_şÚes.
	`’d
(); ++p)

4847 
şÚes
.
	`push_back
(*
p
);

4850 
¢­s
.
	`ş—r
();

4851 
¢­s
.
	`»£rve
(
_¢­s
.
	`size
());

4852 
£t
<
¢­id_t
>::
»v”£_™”©Ü
 
p
 = 
_¢­s
.
	`rbegš
();

4853 
p
 !ğ
_¢­s
.
	`»nd
(); ++p)

4854 
¢­s
.
	`push_back
(*
p
);

4855 
	}
}

4857 
ušt64_t
 
	gSÇpS‘
::
	$g‘_şÚe_by‹s
(
¢­id_t
 
şÚe
) const

4859 
	`as£¹
(
şÚe_size
.
	`couÁ
(
şÚe
));

4860 
ušt64_t
 
size
 = 
şÚe_size
.
	`fšd
(
şÚe
)->
£cÚd
;

4861 
	`as£¹
(
şÚe_ov”Ïp
.
	`couÁ
(
şÚe
));

4862 cÚ¡ 
š‹rv®_£t
<
ušt64_t
> &
ov”Ïp
 = 
şÚe_ov”Ïp
.
	`fšd
(
şÚe
)->
£cÚd
;

4863 
	`as£¹
(
size
 >ğ(
ušt64_t
)
ov”Ïp
.
	`size
());

4864  
size
 - 
ov”Ïp
.
	`size
();

4865 
	}
}

4867 
	gSÇpS‘
::
	$f‹r
(cÚ¡ 
pg_poŞ_t
 &
pšfo
)

4869 
veùÜ
<
¢­id_t
> 
Şd¢­s
;

4870 
Şd¢­s
.
	`sw­
(
¢­s
);

4871 
veùÜ
<
¢­id_t
>::
cÚ¡_™”©Ü
 
i
 = 
Şd¢­s
.
	`begš
();

4872 
i
 !ğ
Şd¢­s
.
	`’d
();

4873 ++
i
) {

4874 ià(!
pšfo
.
	`is_»moved_¢­
(*
i
))

4875 
¢­s
.
	`push_back
(*
i
);

4877 
	}
}

4879 
SÇpS‘
 
	gSÇpS‘
::
	$g‘_f‹»d
(cÚ¡ 
pg_poŞ_t
 &
pšfo
) const

4881 
SÇpS‘
 
ss
 = *
this
;

4882 
ss
.
	`f‹r
(
pšfo
);

4883  
ss
;

4884 
	}
}

4888 
	gw©ch_šfo_t
::
	$’code
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
) const

4890 
	`ENCODE_START
(4, 3, 
bl
);

4891 
	`’code
(
cook›
, 
bl
);

4892 
	`’code
(
timeout_£cÚds
, 
bl
);

4893 
	`’code
(
addr
, 
bl
, 
ã©u»s
);

4894 
	`ENCODE_FINISH
(
bl
);

4895 
	}
}

4897 
	gw©ch_šfo_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
)

4899 
	`DECODE_START_LEGACY_COMPAT_LEN
(4, 3, 3, 
bl
);

4900 
	`decode
(
cook›
, 
bl
);

4901 ià(
¡ruù_v
 < 2) {

4902 
ušt64_t
 
v”
;

4903 
	`decode
(
v”
, 
bl
);

4905 
	`decode
(
timeout_£cÚds
, 
bl
);

4906 ià(
¡ruù_v
 >= 4) {

4907 
	`decode
(
addr
, 
bl
);

4909 
	`DECODE_FINISH
(
bl
);

4910 
	}
}

4912 
	gw©ch_šfo_t
::
	$dump
(
FÜm©‹r
 *
f
) const

4914 
f
->
	`dump_unsigÃd
("cook›", 
cook›
);

4915 
f
->
	`dump_unsigÃd
("timeout_£cÚds", 
timeout_£cÚds
);

4916 
f
->
	`İ’_objeù_£ùiÚ
("addr");

4917 
addr
.
	`dump
(
f
);

4918 
f
->
	`şo£_£ùiÚ
();

4919 
	}
}

4921 
	gw©ch_šfo_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
w©ch_šfo_t
*>& 
o
)

4923 
o
.
push_back
(
Ãw
 
w©ch_šfo_t
);

4924 
	go
.
push_back
(
Ãw
 
w©ch_šfo_t
);

4925 
	go
.
back
()->
	gcook›
 = 123;

4926 
	go
.
back
()->
	gtimeout_£cÚds
 = 99;

4927 
’t™y_addr_t
 
	g—
;

4928 
	g—
.
£t_ty³
(
’t™y_addr_t
::
TYPE_LEGACY
);

4929 
	g—
.
£t_nÚû
(1);

4930 
	g—
.
£t_çmy
(
AF_INET
);

4931 
	g—
.
£t_š4_quad
(0, 127);

4932 
	g—
.
£t_š4_quad
(1, 0);

4933 
	g—
.
£t_š4_quad
(2, 1);

4934 
	g—
.
£t_š4_quad
(3, 2);

4935 
	g—
.
£t_pÜt
(2);

4936 
	go
.
back
()->
	gaddr
 = 
—
;

4941 
	gchunk_šfo_t
::
	$’code
(
bufã¾i¡
& 
bl
) const

4943 
	`ENCODE_START
(1, 1, 
bl
);

4944 
	`’code
(
off£t
, 
bl
);

4945 
	`’code
(
Ëngth
, 
bl
);

4946 
	`’code
(
oid
, 
bl
);

4947 
	`’code
(
æags
, 
bl
);

4948 
	`ENCODE_FINISH
(
bl
);

4949 
	}
}

4951 
	gchunk_šfo_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
)

4953 
	`DECODE_START
(1, 
bl
);

4954 
	`decode
(
off£t
, 
bl
);

4955 
	`decode
(
Ëngth
, 
bl
);

4956 
	`decode
(
oid
, 
bl
);

4957 
	`decode
(
æags
, 
bl
);

4958 
	`DECODE_FINISH
(
bl
);

4959 
	}
}

4961 
	gchunk_šfo_t
::
	$dump
(
FÜm©‹r
 *
f
) const

4963 
f
->
	`dump_unsigÃd
("Ëngth", 
Ëngth
);

4964 
f
->
	`İ’_objeù_£ùiÚ
("oid");

4965 
oid
.
	`dump
(
f
);

4966 
f
->
	`şo£_£ùiÚ
();

4967 
f
->
	`dump_unsigÃd
("æags", 
æags
);

4968 
	}
}

4970 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gchunk_šfo_t
& 
	gci
)

4972  
	gout
 << "Ö’: " << 
	gci
.
	gËngth
 << " oid: " << ci.
	goid


4973 << " off£t: " << 
	gci
.
	goff£t


4974 << " fÏgs: " << 
	gci
.
g‘_æag_¡ršg
(
ci
.
æags
) << ")";

4979 
	gobjeù_mªiã¡_t
::
	$’code
(
bufã¾i¡
& 
bl
) const

4981 
	`ENCODE_START
(1, 1, 
bl
);

4982 
	`’code
(
ty³
, 
bl
);

4983 
ty³
) {

4984 
TYPE_NONE
: ;

4985 
TYPE_REDIRECT
:

4986 
	`’code
(
»dœeù_rg‘
, 
bl
);

4988 
TYPE_CHUNKED
:

4989 
	`’code
(
chunk_m­
, 
bl
);

4992 
	`ûph_abÜt
();

4994 
	`ENCODE_FINISH
(
bl
);

4995 
	}
}

4997 
	gobjeù_mªiã¡_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
)

4999 
	`DECODE_START
(1, 
bl
);

5000 
	`decode
(
ty³
, 
bl
);

5001 
ty³
) {

5002 
TYPE_NONE
: ;

5003 
TYPE_REDIRECT
:

5004 
	`decode
(
»dœeù_rg‘
, 
bl
);

5006 
TYPE_CHUNKED
:

5007 
	`decode
(
chunk_m­
, 
bl
);

5010 
	`ûph_abÜt
();

5012 
	`DECODE_FINISH
(
bl
);

5013 
	}
}

5015 
	gobjeù_mªiã¡_t
::
	$dump
(
FÜm©‹r
 *
f
) const

5017 
f
->
	`dump_unsigÃd
("ty³", 
ty³
);

5018 ià(
ty³
 =ğ
TYPE_REDIRECT
) {

5019 
f
->
	`İ’_objeù_£ùiÚ
("redirect_target");

5020 
»dœeù_rg‘
.
	`dump
(
f
);

5021 
f
->
	`şo£_£ùiÚ
();

5022 } ià(
ty³
 =ğ
TYPE_CHUNKED
) {

5023 
f
->
	`İ’_¬¿y_£ùiÚ
("chunk_map");

5024 auto& 
p
 : 
chunk_m­
) {

5025 
f
->
	`İ’_objeù_£ùiÚ
("chunk");

5026 
f
->
	`dump_unsigÃd
("off£t", 
p
.
fœ¡
);

5027 
p
.
£cÚd
.
	`dump
(
f
);

5028 
f
->
	`şo£_£ùiÚ
();

5030 
f
->
	`şo£_£ùiÚ
();

5032 
	}
}

5034 
	gobjeù_mªiã¡_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
objeù_mªiã¡_t
*>& 
o
)

5036 
o
.
push_back
(
Ãw
 
objeù_mªiã¡_t
());

5037 
	go
.
back
()->
	gty³
 = 
TYPE_REDIRECT
;

5040 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gobjeù_mªiã¡_t
& 
	gom
)

5042 
	gout
 << "mªiã¡(" << 
	gom
.
g‘_ty³_Çme
();

5043 ià(
	gom
.
is_»dœeù
()) {

5044 
	gout
 << " " << 
	gom
.
	g»dœeù_rg‘
;

5045 } ià(
	gom
.
is_chunked
()) {

5046 
	gout
 << " " << 
	gom
.
	gchunk_m­
;

5048 
	gout
 << ")";

5049  
	gout
;

5054 
	gobjeù_šfo_t
::
	$cİy_u£r_b™s
(cÚ¡ 
objeù_šfo_t
& 
Ùh”
)

5057 
size
 = 
Ùh”
.size;

5058 
mtime
 = 
Ùh”
.mtime;

5059 
loÿl_mtime
 = 
Ùh”
.local_mtime;

5060 
Ï¡_»qid
 = 
Ùh”
.last_reqid;

5061 
Œunÿ‹_£q
 = 
Ùh”
.truncate_seq;

5062 
Œunÿ‹_size
 = 
Ùh”
.truncate_size;

5063 
æags
 = 
Ùh”
.flags;

5064 
u£r_v”siÚ
 = 
Ùh”
.user_version;

5065 
d©a_dige¡
 = 
Ùh”
.data_digest;

5066 
om­_dige¡
 = 
Ùh”
.omap_digest;

5067 
	}
}

5069 
	gobjeù_šfo_t
::
	$’code
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
) const

5071 
objeù_loÿtÜ_t
 
	`myŞoc
(
soid
);

5072 
m­
<
’t™y_Çme_t
, 
w©ch_šfo_t
> 
Şd_w©ch”s
;

5073 
m­
<
·œ
<
ušt64_t
, 
’t™y_Çme_t
>, 
w©ch_šfo_t
>::
cÚ¡_™”©Ü
 
i
 =

5074 
w©ch”s
.
	`begš
();

5075 
i
 !ğ
w©ch”s
.
	`’d
();

5076 ++
i
) {

5077 
Şd_w©ch”s
.
	`š£¹
(
	`make_·œ
(
i
->
fœ¡
.
£cÚd
, i->second));

5079 
	`ENCODE_START
(17, 8, 
bl
);

5080 
	`’code
(
soid
, 
bl
);

5081 
	`’code
(
myŞoc
, 
bl
);

5082 
	`’code
((
__u32
)0, 
bl
);

5083 
	`’code
(
v”siÚ
, 
bl
);

5084 
	`’code
(
´iÜ_v”siÚ
, 
bl
);

5085 
	`’code
(
Ï¡_»qid
, 
bl
);

5086 
	`’code
(
size
, 
bl
);

5087 
	`’code
(
mtime
, 
bl
);

5088 ià(
soid
.
¢­
 =ğ
CEPH_NOSNAP
)

5089 
	`’code
(
	`osd_»qid_t
(), 
bl
);

5091 
	`’code
((
ušt32_t
)0, 
bl
);

5092 
	`’code
(
Œunÿ‹_£q
, 
bl
);

5093 
	`’code
(
Œunÿ‹_size
, 
bl
);

5094 
	`’code
(
	`is_lo¡
(), 
bl
);

5095 
	`’code
(
Şd_w©ch”s
, 
bl
, 
ã©u»s
);

5098 
ev”siÚ_t
 
	`u£r_ev”siÚ
(0, 
u£r_v”siÚ
);

5099 
	`’code
(
u£r_ev”siÚ
, 
bl
);

5100 
	`’code
(
	`‹¡_æag
(
FLAG_USES_TMAP
), 
bl
);

5101 
	`’code
(
w©ch”s
, 
bl
, 
ã©u»s
);

5102 
__u32
 
_æags
 = 
æags
;

5103 
	`’code
(
_æags
, 
bl
);

5104 
	`’code
(
loÿl_mtime
, 
bl
);

5105 
	`’code
(
d©a_dige¡
, 
bl
);

5106 
	`’code
(
om­_dige¡
, 
bl
);

5107 
	`’code
(
ex³ùed_objeù_size
, 
bl
);

5108 
	`’code
(
ex³ùed_wr™e_size
, 
bl
);

5109 
	`’code
(
®loc_hšt_æags
, 
bl
);

5110 ià(
	`has_mªiã¡
()) {

5111 
	`’code
(
mªiã¡
, 
bl
);

5113 
	`ENCODE_FINISH
(
bl
);

5114 
	}
}

5116 
	gobjeù_šfo_t
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
)

5118 
objeù_loÿtÜ_t
 
myŞoc
;

5119 
	`DECODE_START_LEGACY_COMPAT_LEN
(17, 8, 8, 
bl
);

5120 
m­
<
’t™y_Çme_t
, 
w©ch_šfo_t
> 
Şd_w©ch”s
;

5121 
	`decode
(
soid
, 
bl
);

5122 
	`decode
(
myŞoc
, 
bl
);

5124 
¡ršg
 
ÿ‹gÜy
;

5125 
	`decode
(
ÿ‹gÜy
, 
bl
);

5127 
	`decode
(
v”siÚ
, 
bl
);

5128 
	`decode
(
´iÜ_v”siÚ
, 
bl
);

5129 
	`decode
(
Ï¡_»qid
, 
bl
);

5130 
	`decode
(
size
, 
bl
);

5131 
	`decode
(
mtime
, 
bl
);

5132 ià(
soid
.
¢­
 =ğ
CEPH_NOSNAP
) {

5133 
osd_»qid_t
 
w¾ock_by
;

5134 
	`decode
(
w¾ock_by
, 
bl
);

5136 
veùÜ
<
¢­id_t
> 
Ëgacy_¢­s
;

5137 
	`decode
(
Ëgacy_¢­s
, 
bl
);

5139 
	`decode
(
Œunÿ‹_£q
, 
bl
);

5140 
	`decode
(
Œunÿ‹_size
, 
bl
);

5145 
__u8
 
lo
;

5146 
	`decode
(
lo
, 
bl
);

5147 
æags
 = (
æag_t
)
lo
;

5149 
	`decode
(
Şd_w©ch”s
, 
bl
);

5150 
ev”siÚ_t
 
u£r_ev”siÚ
;

5151 
	`decode
(
u£r_ev”siÚ
, 
bl
);

5152 
u£r_v”siÚ
 = 
u£r_ev”siÚ
.
v”siÚ
;

5154 ià(
¡ruù_v
 >= 9) {

5155 
boŞ
 
u£s_tm­
 = 
çl£
;

5156 
	`decode
(
u£s_tm­
, 
bl
);

5157 ià(
u£s_tm­
)

5158 
	`£t_æag
(
FLAG_USES_TMAP
);

5160 
	`£t_æag
(
FLAG_USES_TMAP
);

5162 ià(
¡ruù_v
 < 10)

5163 
soid
.
poŞ
 = 
myŞoc
.pool;

5164 ià(
¡ruù_v
 >= 11) {

5165 
	`decode
(
w©ch”s
, 
bl
);

5167 
m­
<
’t™y_Çme_t
, 
w©ch_šfo_t
>::
™”©Ü
 
i
 = 
Şd_w©ch”s
.
	`begš
();

5168 
i
 !ğ
Şd_w©ch”s
.
	`’d
();

5169 ++
i
) {

5170 
w©ch”s
.
	`š£¹
(

5171 
	`make_·œ
(

5172 
	`make_·œ
(
i
->
£cÚd
.
cook›
, i->
fœ¡
), i->second));

5175 ià(
¡ruù_v
 >= 13) {

5176 
__u32
 
_æags
;

5177 
	`decode
(
_æags
, 
bl
);

5178 
æags
 = (
æag_t
)
_æags
;

5180 ià(
¡ruù_v
 >= 14) {

5181 
	`decode
(
loÿl_mtime
, 
bl
);

5183 
loÿl_mtime
 = 
	`utime_t
();

5185 ià(
¡ruù_v
 >= 15) {

5186 
	`decode
(
d©a_dige¡
, 
bl
);

5187 
	`decode
(
om­_dige¡
, 
bl
);

5189 
d©a_dige¡
 = 
om­_dige¡
 = -1;

5190 
	`ş—r_æag
(
FLAG_DATA_DIGEST
);

5191 
	`ş—r_æag
(
FLAG_OMAP_DIGEST
);

5193 ià(
¡ruù_v
 >= 16) {

5194 
	`decode
(
ex³ùed_objeù_size
, 
bl
);

5195 
	`decode
(
ex³ùed_wr™e_size
, 
bl
);

5196 
	`decode
(
®loc_hšt_æags
, 
bl
);

5198 
ex³ùed_objeù_size
 = 0;

5199 
ex³ùed_wr™e_size
 = 0;

5200 
®loc_hšt_æags
 = 0;

5202 ià(
¡ruù_v
 >= 17) {

5203 ià(
	`has_mªiã¡
()) {

5204 
	`decode
(
mªiã¡
, 
bl
);

5207 
	`DECODE_FINISH
(
bl
);

5208 
	}
}

5210 
	gobjeù_šfo_t
::
	$dump
(
FÜm©‹r
 *
f
) const

5212 
f
->
	`İ’_objeù_£ùiÚ
("oid");

5213 
soid
.
	`dump
(
f
);

5214 
f
->
	`şo£_£ùiÚ
();

5215 
f
->
	`dump_¡»am
("v”siÚ"è<< 
v”siÚ
;

5216 
f
->
	`dump_¡»am
("´iÜ_v”siÚ"è<< 
´iÜ_v”siÚ
;

5217 
f
->
	`dump_¡»am
("Ï¡_»qid"è<< 
Ï¡_»qid
;

5218 
f
->
	`dump_unsigÃd
("u£r_v”siÚ", 
u£r_v”siÚ
);

5219 
f
->
	`dump_unsigÃd
("size", 
size
);

5220 
f
->
	`dump_¡»am
("mtime"è<< 
mtime
;

5221 
f
->
	`dump_¡»am
("loÿl_mtime"è<< 
loÿl_mtime
;

5222 
f
->
	`dump_unsigÃd
("lo¡", ()
	`is_lo¡
());

5223 
veùÜ
<
¡ršg
> 
sv
 = 
	`g‘_æag_veùÜ
(
æags
);

5224 
f
->
	`İ’_¬¿y_£ùiÚ
("flags");

5225 autØ
¡r
: 
sv
)

5226 
f
->
	`dump_¡ršg
("æags", 
¡r
);

5227 
f
->
	`şo£_£ùiÚ
();

5228 
f
->
	`dump_unsigÃd
("Œunÿ‹_£q", 
Œunÿ‹_£q
);

5229 
f
->
	`dump_unsigÃd
("Œunÿ‹_size", 
Œunÿ‹_size
);

5230 
f
->
	`dump_fÜm©
("d©a_dige¡", "0x%08x", 
d©a_dige¡
);

5231 
f
->
	`dump_fÜm©
("om­_dige¡", "0x%08x", 
om­_dige¡
);

5232 
f
->
	`dump_unsigÃd
("ex³ùed_objeù_size", 
ex³ùed_objeù_size
);

5233 
f
->
	`dump_unsigÃd
("ex³ùed_wr™e_size", 
ex³ùed_wr™e_size
);

5234 
f
->
	`dump_unsigÃd
("®loc_hšt_æags", 
®loc_hšt_æags
);

5235 
f
->
	`dump_objeù
("mªiã¡", 
mªiã¡
);

5236 
f
->
	`İ’_objeù_£ùiÚ
("watchers");

5237 
m­
<
·œ
<
ušt64_t
, 
’t™y_Çme_t
>,
w©ch_šfo_t
>::
cÚ¡_™”©Ü
 
p
 =

5238 
w©ch”s
.
	`begš
(); 
p
 !ğw©ch”s.
	`’d
(); ++p) {

5239 
¡ršg¡»am
 
ss
;

5240 
ss
 << 
p
->
fœ¡
.
£cÚd
;

5241 
f
->
	`İ’_objeù_£ùiÚ
(
ss
.
	`¡r
().
	`c_¡r
());

5242 
p
->
£cÚd
.
	`dump
(
f
);

5243 
f
->
	`şo£_£ùiÚ
();

5245 
f
->
	`şo£_£ùiÚ
();

5246 
	}
}

5248 
	gobjeù_šfo_t
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
objeù_šfo_t
*>& 
o
)

5250 
o
.
push_back
(
Ãw
 
objeù_šfo_t
());

5256 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gobjeù_šfo_t
& 
	goi
)

5258 
	gout
 << 
	goi
.
	gsoid
 << "(" << oi.
	gv”siÚ


5259 << " " << 
	goi
.
	gÏ¡_»qid
;

5260 ià(
	goi
.
	gæags
)

5261 
	gout
 << " " << 
	goi
.
g‘_æag_¡ršg
();

5262 
	gout
 << " s " << 
	goi
.
	gsize
;

5263 
	gout
 << " uv " << 
	goi
.
	gu£r_v”siÚ
;

5264 ià(
	goi
.
is_d©a_dige¡
())

5265 
	gout
 << " dd " << 
	g¡d
::
hex
 << 
oi
.
d©a_dige¡
 << 
¡d
::
dec
;

5266 ià(
	goi
.
is_om­_dige¡
())

5267 
	gout
 << " od " << 
	g¡d
::
hex
 << 
oi
.
om­_dige¡
 << 
¡d
::
dec
;

5268 
	gout
 << "‡Îoc_hšˆ[" << 
	goi
.
	gex³ùed_objeù_size


5269 << " " << 
	goi
.
	gex³ùed_wr™e_size


5270 << " " << 
	goi
.
	g®loc_hšt_æags
 << "]";

5271 ià(
	goi
.
has_mªiã¡
())

5272 
	gout
 << " " << 
	goi
.
	gmªiã¡
;

5273 
	gout
 << ")";

5274  
	gout
;

5278 
	gObjeùRecov”yProg»ss
::
	$’code
(
bufã¾i¡
 &
bl
) const

5280 
	`ENCODE_START
(1, 1, 
bl
);

5281 
	`’code
(
fœ¡
, 
bl
);

5282 
	`’code
(
d©a_com¶‘e
, 
bl
);

5283 
	`’code
(
d©a_»cov”ed_to
, 
bl
);

5284 
	`’code
(
om­_»cov”ed_to
, 
bl
);

5285 
	`’code
(
om­_com¶‘e
, 
bl
);

5286 
	`ENCODE_FINISH
(
bl
);

5287 
	}
}

5289 
	gObjeùRecov”yProg»ss
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

5291 
	`DECODE_START
(1, 
bl
);

5292 
	`decode
(
fœ¡
, 
bl
);

5293 
	`decode
(
d©a_com¶‘e
, 
bl
);

5294 
	`decode
(
d©a_»cov”ed_to
, 
bl
);

5295 
	`decode
(
om­_»cov”ed_to
, 
bl
);

5296 
	`decode
(
om­_com¶‘e
, 
bl
);

5297 
	`DECODE_FINISH
(
bl
);

5298 
	}
}

5300 
	go¡»am
 &
	gİ”©Ü
<<(o¡»am &
	gout
, cÚ¡ 
	gObjeùRecov”yProg»ss
 &
	g´og
)

5302  
	g´og
.
´št
(
out
);

5305 
	gObjeùRecov”yProg»ss
::
g’”©e_‹¡_š¡ªûs
(

5306 
li¡
<
ObjeùRecov”yProg»ss
*>& 
o
)

5308 
o
.
push_back
(
Ãw
 
ObjeùRecov”yProg»ss
);

5309 
	go
.
back
()->
	gfœ¡
 = 
çl£
;

5310 
	go
.
back
()->
	gd©a_com¶‘e
 = 
Œue
;

5311 
	go
.
back
()->
	gom­_com¶‘e
 = 
Œue
;

5312 
	go
.
back
()->
	gd©a_»cov”ed_to
 = 100;

5314 
	go
.
push_back
(
Ãw
 
ObjeùRecov”yProg»ss
);

5315 
	go
.
back
()->
	gfœ¡
 = 
Œue
;

5316 
	go
.
back
()->
	gd©a_com¶‘e
 = 
çl£
;

5317 
	go
.
back
()->
	gom­_com¶‘e
 = 
çl£
;

5318 
	go
.
back
()->
	gd©a_»cov”ed_to
 = 0;

5321 
	go¡»am
 &
	gObjeùRecov”yProg»ss
::
	$´št
(
o¡»am
 &
out
) const

5323  
out
 << "ObjectRecoveryProgress("

5324 << ( 
fœ¡
 ? "" : "!" ) << "first, "

5325 << "d©a_»cov”ed_to:" << 
d©a_»cov”ed_to


5326 << ", d©a_com¶‘e:" << ( 
d©a_com¶‘e
 ? "true" : "false" )

5327 << ", om­_»cov”ed_to:" << 
om­_»cov”ed_to


5328 << ", om­_com¶‘e:" << ( 
om­_com¶‘e
 ? "true" : "false" )

5329 << ",ƒ¼Ü:" << ( 
”rÜ
 ? "true" : "false" )

5331 
	}
}

5333 
	gObjeùRecov”yProg»ss
::
	$dump
(
FÜm©‹r
 *
f
) const

5335 
f
->
	`dump_št
("fœ¡?", 
fœ¡
);

5336 
f
->
	`dump_št
("d©a_com¶‘e?", 
d©a_com¶‘e
);

5337 
f
->
	`dump_unsigÃd
("d©a_»cov”ed_to", 
d©a_»cov”ed_to
);

5338 
f
->
	`dump_št
("om­_com¶‘e?", 
om­_com¶‘e
);

5339 
f
->
	`dump_¡ršg
("om­_»cov”ed_to", 
om­_»cov”ed_to
);

5340 
	}
}

5342 
	gObjeùRecov”yInfo
::
	$’code
(
bufã¾i¡
 &
bl
, 
ušt64_t
 
ã©u»s
) const

5344 
	`ENCODE_START
(2, 1, 
bl
);

5345 
	`’code
(
soid
, 
bl
);

5346 
	`’code
(
v”siÚ
, 
bl
);

5347 
	`’code
(
size
, 
bl
);

5348 
	`’code
(
oi
, 
bl
, 
ã©u»s
);

5349 
	`’code
(
ss
, 
bl
);

5350 
	`’code
(
cİy_sub£t
, 
bl
);

5351 
	`’code
(
şÚe_sub£t
, 
bl
);

5352 
	`ENCODE_FINISH
(
bl
);

5353 
	}
}

5355 
	gObjeùRecov”yInfo
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
,

5356 
št64_t
 
poŞ
)

5358 
	`DECODE_START
(2, 
bl
);

5359 
	`decode
(
soid
, 
bl
);

5360 
	`decode
(
v”siÚ
, 
bl
);

5361 
	`decode
(
size
, 
bl
);

5362 
	`decode
(
oi
, 
bl
);

5363 
	`decode
(
ss
, 
bl
);

5364 
	`decode
(
cİy_sub£t
, 
bl
);

5365 
	`decode
(
şÚe_sub£t
, 
bl
);

5366 
	`DECODE_FINISH
(
bl
);

5368 ià(
¡ruù_v
 < 2) {

5369 ià(!
soid
.
	`is_max
(è&& soid.
poŞ
 == -1)

5370 
soid
.
poŞ
 =…ool;

5371 
m­
<
hobjeù_t
, 
š‹rv®_£t
<
ušt64_t
>> 
tmp
;

5372 
tmp
.
	`sw­
(
şÚe_sub£t
);

5373 
m­
<
hobjeù_t
, 
š‹rv®_£t
<
ušt64_t
>>::
™”©Ü
 
i
 = 
tmp
.
	`begš
();

5374 
i
 !ğ
tmp
.
	`’d
();

5375 ++
i
) {

5376 
hobjeù_t
 
	`fœ¡
(
i
->
fœ¡
);

5377 ià(!
fœ¡
.
	`is_max
(è&& fœ¡.
poŞ
 == -1)

5378 
fœ¡
.
poŞ
 =…ool;

5379 
şÚe_sub£t
[
fœ¡
].
	`sw­
(
i
->
£cÚd
);

5382 
	}
}

5384 
	gObjeùRecov”yInfo
::
g’”©e_‹¡_š¡ªûs
(

5385 
li¡
<
ObjeùRecov”yInfo
*>& 
o
)

5387 
o
.
push_back
(
Ãw
 
ObjeùRecov”yInfo
);

5388 
	go
.
back
()->
	gsoid
 = 
hobjeù_t
(
sobjeù_t
("key", 
CEPH_NOSNAP
));

5389 
	go
.
back
()->
	gv”siÚ
 = 
ev”siÚ_t
(0,0);

5390 
	go
.
back
()->
	gsize
 = 100;

5394 
	gObjeùRecov”yInfo
::
	$dump
(
FÜm©‹r
 *
f
) const

5396 
f
->
	`dump_¡»am
("objeù"è<< 
soid
;

5397 
f
->
	`dump_¡»am
("©_v”siÚ"è<< 
v”siÚ
;

5398 
f
->
	`dump_¡»am
("size"è<< 
size
;

5400 
f
->
	`İ’_objeù_£ùiÚ
("object_info");

5401 
oi
.
	`dump
(
f
);

5402 
f
->
	`şo£_£ùiÚ
();

5405 
f
->
	`İ’_objeù_£ùiÚ
("snapset");

5406 
ss
.
	`dump
(
f
);

5407 
f
->
	`şo£_£ùiÚ
();

5409 
f
->
	`dump_¡»am
("cİy_sub£t"è<< 
cİy_sub£t
;

5410 
f
->
	`dump_¡»am
("şÚe_sub£t"è<< 
şÚe_sub£t
;

5411 
	}
}

5413 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gObjeùRecov”yInfo
 &
	gšf
)

5415  
	gšf
.
´št
(
out
);

5418 
	go¡»am
 &
	gObjeùRecov”yInfo
::
	$´št
(
o¡»am
 &
out
) const

5420  
out
 << "ObjectRecoveryInfo("

5421 << 
soid
 << "@" << 
v”siÚ


5422 << ", size: " << 
size


5423 << ", cİy_sub£t: " << 
cİy_sub£t


5424 << ", clÚe_sub£t: " << 
şÚe_sub£t


5425 << ", sÇp£t: " << 
ss


5427 
	}
}

5430 
	gPushR•lyOp
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
PushR•lyOp
*> &
o
)

5432 
o
.
push_back
(
Ãw
 
PushR•lyOp
);

5433 
	go
.
push_back
(
Ãw
 
PushR•lyOp
);

5434 
	go
.
back
()->
	gsoid
 = 
hobjeù_t
(
sobjeù_t
("asdf", 2));

5435 
	go
.
push_back
(
Ãw
 
PushR•lyOp
);

5436 
	go
.
back
()->
	gsoid
 = 
hobjeù_t
(
sobjeù_t
("asdf", 
CEPH_NOSNAP
));

5439 
	gPushR•lyOp
::
	$’code
(
bufã¾i¡
 &
bl
) const

5441 
	`ENCODE_START
(1, 1, 
bl
);

5442 
	`’code
(
soid
, 
bl
);

5443 
	`ENCODE_FINISH
(
bl
);

5444 
	}
}

5446 
	gPushR•lyOp
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

5448 
	`DECODE_START
(1, 
bl
);

5449 
	`decode
(
soid
, 
bl
);

5450 
	`DECODE_FINISH
(
bl
);

5451 
	}
}

5453 
	gPushR•lyOp
::
	$dump
(
FÜm©‹r
 *
f
) const

5455 
f
->
	`dump_¡»am
("soid"è<< 
soid
;

5456 
	}
}

5458 
	go¡»am
 &
	gPushR•lyOp
::
	$´št
(
o¡»am
 &
out
) const

5460  
out


5461 << "PushR•lyOp(" << 
soid


5463 
	}
}

5465 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gPushR•lyOp
 &
	gİ
)

5467  
	gİ
.
´št
(
out
);

5470 
ušt64_t
 
	gPushR•lyOp
::
	$co¡
(
C•hCÚ‹xt
 *
cù
) const

5473  
cù
->
_cÚf
->
osd_push_³r_objeù_co¡
 +

5474 
cù
->
_cÚf
->
osd_»cov”y_max_chunk
;

5475 
	}
}

5478 
	gPuÎOp
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
PuÎOp
*> &
o
)

5480 
o
.
push_back
(
Ãw
 
PuÎOp
);

5481 
	go
.
push_back
(
Ãw
 
PuÎOp
);

5482 
	go
.
back
()->
	gsoid
 = 
hobjeù_t
(
sobjeù_t
("asdf", 2));

5483 
	go
.
back
()->
	g»cov”y_šfo
.
	gv”siÚ
 = 
ev”siÚ_t
(3, 10);

5484 
	go
.
push_back
(
Ãw
 
PuÎOp
);

5485 
	go
.
back
()->
	gsoid
 = 
hobjeù_t
(
sobjeù_t
("asdf", 
CEPH_NOSNAP
));

5486 
	go
.
back
()->
	g»cov”y_šfo
.
	gv”siÚ
 = 
ev”siÚ_t
(0, 0);

5489 
	gPuÎOp
::
	$’code
(
bufã¾i¡
 &
bl
, 
ušt64_t
 
ã©u»s
) const

5491 
	`ENCODE_START
(1, 1, 
bl
);

5492 
	`’code
(
soid
, 
bl
);

5493 
	`’code
(
»cov”y_šfo
, 
bl
, 
ã©u»s
);

5494 
	`’code
(
»cov”y_´og»ss
, 
bl
);

5495 
	`ENCODE_FINISH
(
bl
);

5496 
	}
}

5498 
	gPuÎOp
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

5500 
	`DECODE_START
(1, 
bl
);

5501 
	`decode
(
soid
, 
bl
);

5502 
	`decode
(
»cov”y_šfo
, 
bl
);

5503 
	`decode
(
»cov”y_´og»ss
, 
bl
);

5504 
	`DECODE_FINISH
(
bl
);

5505 
	}
}

5507 
	gPuÎOp
::
	$dump
(
FÜm©‹r
 *
f
) const

5509 
f
->
	`dump_¡»am
("soid"è<< 
soid
;

5511 
f
->
	`İ’_objeù_£ùiÚ
("recovery_info");

5512 
»cov”y_šfo
.
	`dump
(
f
);

5513 
f
->
	`şo£_£ùiÚ
();

5516 
f
->
	`İ’_objeù_£ùiÚ
("recovery_progress");

5517 
»cov”y_´og»ss
.
	`dump
(
f
);

5518 
f
->
	`şo£_£ùiÚ
();

5520 
	}
}

5522 
	go¡»am
 &
	gPuÎOp
::
	$´št
(
o¡»am
 &
out
) const

5524  
out


5525 << "PuÎOp(" << 
soid


5526 << ",„ecov”y_šfo: " << 
»cov”y_šfo


5527 << ",„ecov”y_´og»ss: " << 
»cov”y_´og»ss


5529 
	}
}

5531 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gPuÎOp
 &
	gİ
)

5533  
	gİ
.
´št
(
out
);

5536 
ušt64_t
 
	gPuÎOp
::
	$co¡
(
C•hCÚ‹xt
 *
cù
) const

5538  
cù
->
_cÚf
->
osd_push_³r_objeù_co¡
 +

5539 
cù
->
_cÚf
->
osd_»cov”y_max_chunk
;

5540 
	}
}

5543 
	gPushOp
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
PushOp
*> &
o
)

5545 
o
.
push_back
(
Ãw
 
PushOp
);

5546 
	go
.
push_back
(
Ãw
 
PushOp
);

5547 
	go
.
back
()->
	gsoid
 = 
hobjeù_t
(
sobjeù_t
("asdf", 2));

5548 
	go
.
back
()->
	gv”siÚ
 = 
ev”siÚ_t
(3, 10);

5549 
	go
.
push_back
(
Ãw
 
PushOp
);

5550 
	go
.
back
()->
	gsoid
 = 
hobjeù_t
(
sobjeù_t
("asdf", 
CEPH_NOSNAP
));

5551 
	go
.
back
()->
	gv”siÚ
 = 
ev”siÚ_t
(0, 0);

5554 
	gPushOp
::
	$’code
(
bufã¾i¡
 &
bl
, 
ušt64_t
 
ã©u»s
) const

5556 
	`ENCODE_START
(1, 1, 
bl
);

5557 
	`’code
(
soid
, 
bl
);

5558 
	`’code
(
v”siÚ
, 
bl
);

5559 
	`’code
(
d©a
, 
bl
);

5560 
	`’code
(
d©a_šşuded
, 
bl
);

5561 
	`’code
(
om­_h—d”
, 
bl
);

5562 
	`’code
(
om­_’Œ›s
, 
bl
);

5563 
	`’code
(
©Œ£t
, 
bl
);

5564 
	`’code
(
»cov”y_šfo
, 
bl
, 
ã©u»s
);

5565 
	`’code
(
aá”_´og»ss
, 
bl
);

5566 
	`’code
(
befÜe_´og»ss
, 
bl
);

5567 
	`ENCODE_FINISH
(
bl
);

5568 
	}
}

5570 
	gPushOp
::
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
)

5572 
	`DECODE_START
(1, 
bl
);

5573 
	`decode
(
soid
, 
bl
);

5574 
	`decode
(
v”siÚ
, 
bl
);

5575 
	`decode
(
d©a
, 
bl
);

5576 
	`decode
(
d©a_šşuded
, 
bl
);

5577 
	`decode
(
om­_h—d”
, 
bl
);

5578 
	`decode
(
om­_’Œ›s
, 
bl
);

5579 
	`decode
(
©Œ£t
, 
bl
);

5580 
	`decode
(
»cov”y_šfo
, 
bl
);

5581 
	`decode
(
aá”_´og»ss
, 
bl
);

5582 
	`decode
(
befÜe_´og»ss
, 
bl
);

5583 
	`DECODE_FINISH
(
bl
);

5584 
	}
}

5586 
	gPushOp
::
	$dump
(
FÜm©‹r
 *
f
) const

5588 
f
->
	`dump_¡»am
("soid"è<< 
soid
;

5589 
f
->
	`dump_¡»am
("v”siÚ"è<< 
v”siÚ
;

5590 
f
->
	`dump_št
("d©a_Ën", 
d©a
.
	`Ëngth
());

5591 
f
->
	`dump_¡»am
("d©a_šşuded"è<< 
d©a_šşuded
;

5592 
f
->
	`dump_št
("om­_h—d”_Ën", 
om­_h—d”
.
	`Ëngth
());

5593 
f
->
	`dump_št
("om­_’Œ›s_Ën", 
om­_’Œ›s
.
	`size
());

5594 
f
->
	`dump_št
("©Œ£t_Ën", 
©Œ£t
.
	`size
());

5596 
f
->
	`İ’_objeù_£ùiÚ
("recovery_info");

5597 
»cov”y_šfo
.
	`dump
(
f
);

5598 
f
->
	`şo£_£ùiÚ
();

5601 
f
->
	`İ’_objeù_£ùiÚ
("after_progress");

5602 
aá”_´og»ss
.
	`dump
(
f
);

5603 
f
->
	`şo£_£ùiÚ
();

5606 
f
->
	`İ’_objeù_£ùiÚ
("before_progress");

5607 
befÜe_´og»ss
.
	`dump
(
f
);

5608 
f
->
	`şo£_£ùiÚ
();

5610 
	}
}

5612 
	go¡»am
 &
	gPushOp
::
	$´št
(
o¡»am
 &
out
) const

5614  
out


5615 << "PushOp(" << 
soid


5616 << ", v”siÚ: " << 
v”siÚ


5617 << ", d©a_šşuded: " << 
d©a_šşuded


5618 << ", d©a_size: " << 
d©a
.
	`Ëngth
()

5619 << ", om­_h—d”_size: " << 
om­_h—d”
.
	`Ëngth
()

5620 << ", om­_’Œ›s_size: " << 
om­_’Œ›s
.
	`size
()

5621 << ",‡‰r£t_size: " << 
©Œ£t
.
	`size
()

5622 << ",„ecov”y_šfo: " << 
»cov”y_šfo


5623 << ",‡á”_´og»ss: " << 
aá”_´og»ss


5624 << ", befÜe_´og»ss: " << 
befÜe_´og»ss


5626 
	}
}

5628 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gPushOp
 &
	gİ
)

5630  
	gİ
.
´št
(
out
);

5633 
ušt64_t
 
	gPushOp
::
	$co¡
(
C•hCÚ‹xt
 *
cù
) const

5635 
ušt64_t
 
co¡
 = 
d©a_šşuded
.
	`size
();

5636 
m­
<
¡ršg
, 
bufã¾i¡
>::
cÚ¡_™”©Ü
 
i
 =

5637 
om­_’Œ›s
.
	`begš
();

5638 
i
 !ğ
om­_’Œ›s
.
	`’d
();

5639 ++
i
) {

5640 
co¡
 +ğ
i
->
£cÚd
.
	`Ëngth
();

5642 
co¡
 +ğ
cù
->
_cÚf
->
osd_push_³r_objeù_co¡
;

5643  
co¡
;

5644 
	}
}

5648 
	gSüubM­
::
	$m”ge_šü
(cÚ¡ 
SüubM­
 &
l
)

5650 
	`as£¹
(
v®id_through
 =ğ
l
.
šü_sšû
);

5651 
v®id_through
 = 
l
.valid_through;

5653 
m­
<
hobjeù_t
,
objeù
>::
cÚ¡_™”©Ü
 
p
 = 
l
.
objeùs
.
	`begš
();

5654 
p
 !ğ
l
.
objeùs
.
	`’d
();

5655 ++
p
){

5656 ià(
p
->
£cÚd
.
Ãg©ive
) {

5657 
m­
<
hobjeù_t
,
objeù
>::
™”©Ü
 
q
 = 
objeùs
.
	`fšd
(
p
->
fœ¡
);

5658 ià(
q
 !ğ
objeùs
.
	`’d
()) {

5659 
objeùs
.
	`”a£
(
q
);

5662 
objeùs
[
p
->
fœ¡
] =…->
£cÚd
;

5665 
	}
}

5667 
	gSüubM­
::
	$’code
(
bufã¾i¡
& 
bl
) const

5669 
	`ENCODE_START
(3, 2, 
bl
);

5670 
	`’code
(
objeùs
, 
bl
);

5671 
	`’code
((
__u32
)0, 
bl
);

5672 
bufã¾i¡
 
Şd_logbl
;

5673 
	`’code
(
Şd_logbl
, 
bl
);

5674 
	`’code
(
v®id_through
, 
bl
);

5675 
	`’code
(
šü_sšû
, 
bl
);

5676 
	`ENCODE_FINISH
(
bl
);

5677 
	}
}

5679 
	gSüubM­
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
, 
št64_t
 
poŞ
)

5681 
	`DECODE_START_LEGACY_COMPAT_LEN
(3, 2, 2, 
bl
);

5682 
	`decode
(
objeùs
, 
bl
);

5684 
m­
<
¡ršg
,¡ršg> 
©Œs
;

5685 
	`decode
(
©Œs
, 
bl
);

5687 
bufã¾i¡
 
Şd_logbl
;

5688 
	`decode
(
Şd_logbl
, 
bl
);

5689 
	`decode
(
v®id_through
, 
bl
);

5690 
	`decode
(
šü_sšû
, 
bl
);

5691 
	`DECODE_FINISH
(
bl
);

5694 ià(
¡ruù_v
 < 3) {

5695 
m­
<
hobjeù_t
, 
objeù
> 
tmp
;

5696 
tmp
.
	`sw­
(
objeùs
);

5697 
m­
<
hobjeù_t
, 
objeù
>::
™”©Ü
 
i
 = 
tmp
.
	`begš
();

5698 
i
 !ğ
tmp
.
	`’d
();

5699 ++
i
) {

5700 
hobjeù_t
 
	`fœ¡
(
i
->
fœ¡
);

5701 ià(!
fœ¡
.
	`is_max
(è&& fœ¡.
poŞ
 == -1)

5702 
fœ¡
.
poŞ
 =…ool;

5703 
objeùs
[
fœ¡
] = 
i
->
£cÚd
;

5706 
	}
}

5708 
	gSüubM­
::
	$dump
(
FÜm©‹r
 *
f
) const

5710 
f
->
	`dump_¡»am
("v®id_through"è<< 
v®id_through
;

5711 
f
->
	`dump_¡»am
("šüem’l_sšû"è<< 
šü_sšû
;

5712 
f
->
	`İ’_¬¿y_£ùiÚ
("objects");

5713 
m­
<
hobjeù_t
,
objeù
>::
cÚ¡_™”©Ü
 
p
 = 
objeùs
.
	`begš
();… !ğobjeùs.
	`’d
(); ++p) {

5714 
f
->
	`İ’_objeù_£ùiÚ
("object");

5715 
f
->
	`dump_¡ršg
("Çme", 
p
->
fœ¡
.
oid
.
Çme
);

5716 
f
->
	`dump_unsigÃd
("hash", 
p
->
fœ¡
.
	`g‘_hash
());

5717 
f
->
	`dump_¡ršg
("key", 
p
->
fœ¡
.
	`g‘_key
());

5718 
f
->
	`dump_št
("¢­id", 
p
->
fœ¡
.
¢­
);

5719 
p
->
£cÚd
.
	`dump
(
f
);

5720 
f
->
	`şo£_£ùiÚ
();

5722 
f
->
	`şo£_£ùiÚ
();

5723 
	}
}

5725 
	gSüubM­
::
g’”©e_‹¡_š¡ªûs
(
li¡
<
SüubM­
*>& 
o
)

5727 
o
.
push_back
(
Ãw
 
SüubM­
);

5728 
	go
.
push_back
(
Ãw
 
SüubM­
);

5729 
	go
.
back
()->
	gv®id_through
 = 
ev”siÚ_t
(1, 2);

5730 
	go
.
back
()->
	gšü_sšû
 = 
ev”siÚ_t
(3, 4);

5731 
	gli¡
<
	gobjeù
*> 
	gobj
;

5732 
	gobjeù
::
g’”©e_‹¡_š¡ªûs
(
obj
);

5733 
	go
.
back
()->
	gobjeùs
[
hobjeù_t
(
objeù_t
("foo"), "fookey", 123, 456, 0, "")] = *
obj
.back();

5734 
	gobj
.
pİ_back
();

5735 
	go
.
back
()->
	gobjeùs
[
hobjeù_t
(
objeù_t
("b¬"), 
¡ršg
(), 123, 456, 0, "")] = *
obj
.back();

5740 
	gSüubM­
::
objeù
::
	$’code
(
bufã¾i¡
& 
bl
) const

5742 
boŞ
 
com·t_»ad_”rÜ
 = 
»ad_”rÜ
 || 
ec_hash_mism©ch
 || 
ec_size_mism©ch
;

5743 
	`ENCODE_START
(9, 7, 
bl
);

5744 
	`’code
(
size
, 
bl
);

5745 
	`’code
(
Ãg©ive
, 
bl
);

5746 
	`’code
(
©Œs
, 
bl
);

5747 
	`’code
(
dige¡
, 
bl
);

5748 
	`’code
(
dige¡_´e£Á
, 
bl
);

5749 
	`’code
((
ušt32_t
)0, 
bl
);

5750 
	`’code
((
ušt32_t
)0, 
bl
);

5751 
	`’code
(
om­_dige¡
, 
bl
);

5752 
	`’code
(
om­_dige¡_´e£Á
, 
bl
);

5753 
	`’code
(
com·t_»ad_”rÜ
, 
bl
);

5754 
	`’code
(
¡©_”rÜ
, 
bl
);

5755 
	`’code
(
»ad_”rÜ
, 
bl
);

5756 
	`’code
(
ec_hash_mism©ch
, 
bl
);

5757 
	`’code
(
ec_size_mism©ch
, 
bl
);

5758 
	`’code
(
Ïrge_om­_objeù_found
, 
bl
);

5759 
	`’code
(
Ïrge_om­_objeù_key_couÁ
, 
bl
);

5760 
	`’code
(
Ïrge_om­_objeù_v®ue_size
, 
bl
);

5761 
	`ENCODE_FINISH
(
bl
);

5762 
	}
}

5764 
	gSüubM­
::
objeù
::
	$decode
(
bufã¾i¡
::
™”©Ü
& 
bl
)

5766 
	`DECODE_START
(9, 
bl
);

5767 
	`decode
(
size
, 
bl
);

5768 
boŞ
 
tmp
, 
com·t_»ad_”rÜ
 = 
çl£
;

5769 
	`decode
(
tmp
, 
bl
);

5770 
Ãg©ive
 = 
tmp
;

5771 
	`decode
(
©Œs
, 
bl
);

5772 
	`decode
(
dige¡
, 
bl
);

5773 
	`decode
(
tmp
, 
bl
);

5774 
dige¡_´e£Á
 = 
tmp
;

5776 
ušt32_t
 
Æšks
;

5777 
	`decode
(
Æšks
, 
bl
);

5778 
£t
<
¢­id_t
> 
¢­cŞls
;

5779 
	`decode
(
¢­cŞls
, 
bl
);

5781 
	`decode
(
om­_dige¡
, 
bl
);

5782 
	`decode
(
tmp
, 
bl
);

5783 
om­_dige¡_´e£Á
 = 
tmp
;

5784 
	`decode
(
com·t_»ad_”rÜ
, 
bl
);

5785 
	`decode
(
tmp
, 
bl
);

5786 
¡©_”rÜ
 = 
tmp
;

5787 ià(
¡ruù_v
 >= 8) {

5788 
	`decode
(
tmp
, 
bl
);

5789 
»ad_”rÜ
 = 
tmp
;

5790 
	`decode
(
tmp
, 
bl
);

5791 
ec_hash_mism©ch
 = 
tmp
;

5792 
	`decode
(
tmp
, 
bl
);

5793 
ec_size_mism©ch
 = 
tmp
;

5796 ià(
com·t_»ad_”rÜ
 && !
»ad_”rÜ
 && !
ec_hash_mism©ch
 && !
ec_size_mism©ch
)

5797 
»ad_”rÜ
 = 
Œue
;

5798 ià(
¡ruù_v
 >= 9) {

5799 
	`decode
(
tmp
, 
bl
);

5800 
Ïrge_om­_objeù_found
 = 
tmp
;

5801 
	`decode
(
Ïrge_om­_objeù_key_couÁ
, 
bl
);

5802 
	`decode
(
Ïrge_om­_objeù_v®ue_size
, 
bl
);

5804 
	`DECODE_FINISH
(
bl
);

5805 
	}
}

5807 
	gSüubM­
::
objeù
::
	$dump
(
FÜm©‹r
 *
f
) const

5809 
f
->
	`dump_št
("size", 
size
);

5810 
f
->
	`dump_št
("Ãg©ive", 
Ãg©ive
);

5811 
f
->
	`İ’_¬¿y_£ùiÚ
("attrs");

5812 
m­
<
¡ršg
,
bufã½Œ
>::
cÚ¡_™”©Ü
 
p
 = 
©Œs
.
	`begš
();… !ğ©Œs.
	`’d
(); ++p) {

5813 
f
->
	`İ’_objeù_£ùiÚ
("attr");

5814 
f
->
	`dump_¡ršg
("Çme", 
p
->
fœ¡
);

5815 
f
->
	`dump_št
("Ëngth", 
p
->
£cÚd
.
	`Ëngth
());

5816 
f
->
	`şo£_£ùiÚ
();

5818 
f
->
	`şo£_£ùiÚ
();

5819 
	}
}

5821 
	gSüubM­
::
objeù
::
g’”©e_‹¡_š¡ªûs
(
li¡
<objeù*>& 
o
)

5823 
o
.
push_back
(
Ãw
 
objeù
);

5824 
	go
.
push_back
(
Ãw
 
objeù
);

5825 
	go
.
back
()->
	gÃg©ive
 = 
Œue
;

5826 
	go
.
push_back
(
Ãw
 
objeù
);

5827 
	go
.
back
()->
	gsize
 = 123;

5828 
	go
.
back
()->
	g©Œs
["foo"] = 
bufãr
::
cİy
("foo", 3);

5829 
	go
.
back
()->
	g©Œs
["b¬"] = 
bufãr
::
cİy
("barval", 6);

5834 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gOSDOp
& 
	gİ
)

5836 
	gout
 << 
ûph_osd_İ_Çme
(
İ
.op.op);

5837 ià(
ûph_osd_İ_ty³_d©a
(
İ
.op.op)) {

5839 
	gİ
.op.op) {

5840 
	gCEPH_OSD_OP_ASSERT_VER
:

5841 
out
 << " v" << 
İ
.İ.
as£¹_v”
.
v”
;

5843 
	gCEPH_OSD_OP_TRUNCATE
:

5844 
out
 << " " << 
İ
.İ.
ex‹Á
.
off£t
;

5846 
	gCEPH_OSD_OP_MASKTRUNC
:

5847 
CEPH_OSD_OP_TRIMTRUNC
:

5848 
out
 << " " << 
İ
.İ.
ex‹Á
.
Œunÿ‹_£q
 << "@"

5849 << (
št64_t
)
İ
.İ.
ex‹Á
.
Œunÿ‹_size
;

5851 
	gCEPH_OSD_OP_ROLLBACK
:

5852 
out
 << " " << 
¢­id_t
(
İ
.İ.
¢­
.
¢­id
);

5854 
	gCEPH_OSD_OP_WATCH
:

5855 
out
 << " " << 
ûph_osd_w©ch_İ_Çme
(
İ
.İ.
w©ch
.op)

5856 << " cook› " << 
İ
.İ.
w©ch
.
cook›
;

5857 ià(
	gİ
.İ.
	gw©ch
.
	gg’
)

5858 
	gout
 << " g’ " << 
	gİ
.İ.
	gw©ch
.
	gg’
;

5860 
	gCEPH_OSD_OP_NOTIFY
:

5861 
CEPH_OSD_OP_NOTIFY_ACK
:

5862 
out
 << " cook› " << 
İ
.İ.
nÙify
.
cook›
;

5864 
	gCEPH_OSD_OP_COPY_GET
:

5865 
out
 << " max " << 
İ
.İ.
cİy_g‘
.
max
;

5867 
	gCEPH_OSD_OP_COPY_FROM
:

5868 
out
 << " v” " << 
İ
.İ.
cİy_äom
.
¤c_v”siÚ
;

5870 
	gCEPH_OSD_OP_SETALLOCHINT
:

5871 
out
 << " objeù_siz" << 
İ
.İ.
®loc_hšt
.
ex³ùed_objeù_size


5872 << " wr™e_siz" << 
İ
.İ.
®loc_hšt
.
ex³ùed_wr™e_size
;

5874 
	gCEPH_OSD_OP_READ
:

5875 
CEPH_OSD_OP_SPARSE_READ
:

5876 
CEPH_OSD_OP_SYNC_READ
:

5877 
CEPH_OSD_OP_WRITE
:

5878 
CEPH_OSD_OP_WRITEFULL
:

5879 
CEPH_OSD_OP_ZERO
:

5880 
CEPH_OSD_OP_APPEND
:

5881 
CEPH_OSD_OP_MAPEXT
:

5882 
out
 << " " << 
İ
.İ.
ex‹Á
.
off£t
 << "~" << op.İ.ex‹Á.
Ëngth
;

5883 ià(
	gİ
.İ.
	gex‹Á
.
	gŒunÿ‹_£q
)

5884 
	gout
 << " [" << 
	gİ
.İ.
	gex‹Á
.
	gŒunÿ‹_£q
 << "@"

5885 << (
	gšt64_t
)
	gİ
.İ.
	gex‹Á
.
	gŒunÿ‹_size
 << "]";

5886 ià(
	gİ
.İ.
	gæags
)

5887 
	gout
 << " [" << 
ûph_osd_İ_æag_¡ršg
(
İ
.İ.
æags
) << "]";

5892 } ià(
ûph_osd_İ_ty³_©Œ
(
İ
.op.op)) {

5894 ià(
	gİ
.İ.
	gx©Œ
.
	gÇme_Ën
 && op.
	gšd©a
.
Ëngth
()) {

5895 
	gout
 << " ";

5896 
	gİ
.
	gšd©a
.
wr™e
(0, 
İ
.İ.
x©Œ
.
Çme_Ën
, 
out
);

5898 ià(
	gİ
.İ.
	gx©Œ
.
	gv®ue_Ën
)

5899 
	gout
 << " (" << 
	gİ
.İ.
	gx©Œ
.
	gv®ue_Ën
 << ")";

5900 ià(
	gİ
.İ.İ =ğ
CEPH_OSD_OP_CMPXATTR
)

5901 
out
 << " o°" << ()
İ
.İ.
x©Œ
.
cmp_İ


5902 << " mod" << ()
İ
.İ.
x©Œ
.
cmp_mode
;

5903 } ià(
ûph_osd_İ_ty³_exec
(
İ
.op.op)) {

5905 ià(
	gİ
.İ.
	gşs
.
	gşass_Ën
 && op.
	gšd©a
.
Ëngth
()) {

5906 
	gout
 << " ";

5907 
	gİ
.
	gšd©a
.
wr™e
(0, 
İ
.İ.
şs
.
şass_Ën
, 
out
);

5908 
	gout
 << ".";

5909 
	gİ
.
	gšd©a
.
wr™e
(
İ
.İ.
şs
.
şass_Ën
, op.İ.şs.
m‘hod_Ën
, 
out
);

5911 } ià(
ûph_osd_İ_ty³_pg
(
İ
.op.op)) {

5912 
	gİ
.op.op) {

5913 
	gCEPH_OSD_OP_PGLS
:

5914 
CEPH_OSD_OP_PGLS_FILTER
:

5915 
CEPH_OSD_OP_PGNLS
:

5916 
CEPH_OSD_OP_PGNLS_FILTER
:

5917 
out
 << " s¹_•och " << 
İ
.İ.
pgls
.
¡¬t_•och
;

5919 
	gCEPH_OSD_OP_PG_HITSET_LS
:

5921 
	gCEPH_OSD_OP_PG_HITSET_GET
:

5922 
out
 << " " << 
utime_t
(
İ
.İ.
h™_£t_g‘
.
¡amp
);

5924 
	gCEPH_OSD_OP_SCRUBLS
:

5928  
	gout
;

5932 
	gOSDOp
::
¥l™_osd_İ_veùÜ_š_d©a
(
veùÜ
<
OSDOp
>& 
İs
, 
bufã¾i¡
& 
š
)

5934 
	gbufã¾i¡
::
™”©Ü
 
d©­
 = 
š
.
begš
();

5935 
	gi
 = 0; i < 
	gİs
.
size
(); i++) {

5936 ià(
	gİs
[
i
].
	gİ
.
	g·ylßd_Ën
) {

5937 
	gd©­
.
cİy
(
İs
[
i
].
İ
.
·ylßd_Ën
, ops[i].
šd©a
);

5942 
	gOSDOp
::
m”ge_osd_İ_veùÜ_š_d©a
(
veùÜ
<
OSDOp
>& 
İs
, 
bufã¾i¡
& 
out
)

5944 
	gi
 = 0; i < 
	gİs
.
size
(); i++) {

5945 ià(
	gİs
[
i
].
	gšd©a
.
Ëngth
()) {

5946 
	gİs
[
i
].
	gİ
.
	g·ylßd_Ën
 = 
İs
[i].
šd©a
.
Ëngth
();

5947 
	gout
.
­³nd
(
İs
[
i
].
šd©a
);

5952 
	gOSDOp
::
¥l™_osd_İ_veùÜ_out_d©a
(
veùÜ
<
OSDOp
>& 
İs
, 
bufã¾i¡
& 
š
)

5954 
	gbufã¾i¡
::
™”©Ü
 
d©­
 = 
š
.
begš
();

5955 
	gi
 = 0; i < 
	gİs
.
size
(); i++) {

5956 ià(
	gİs
[
i
].
	gİ
.
	g·ylßd_Ën
) {

5957 
	gd©­
.
cİy
(
İs
[
i
].
İ
.
·ylßd_Ën
, ops[i].
outd©a
);

5962 
	gOSDOp
::
m”ge_osd_İ_veùÜ_out_d©a
(
veùÜ
<
OSDOp
>& 
İs
, 
bufã¾i¡
& 
out
)

5964 
	gi
 = 0; i < 
	gİs
.
size
(); i++) {

5965 ià(
	gİs
[
i
].
	goutd©a
.
Ëngth
()) {

5966 
	gİs
[
i
].
	gİ
.
	g·ylßd_Ën
 = 
İs
[i].
outd©a
.
Ëngth
();

5967 
	gout
.
­³nd
(
İs
[
i
].
outd©a
);

5972 
boŞ
 
	g¡Üe_¡©fs_t
::
İ”©Ü
==(cÚ¡ 
¡Üe_¡©fs_t
& 
Ùh”
) const

5974  
tÙ®
 =ğ
Ùh”
.total

5975 && 
avaabË
 =ğ
Ùh”
.available

5976 && 
®loÿ‹d
 =ğ
Ùh”
.allocated

5977 && 
¡Üed
 =ğ
Ùh”
.stored

5978 && 
com´es£d
 =ğ
Ùh”
.compressed

5979 && 
com´es£d_®loÿ‹d
 =ğ
Ùh”
.compressed_allocated

5980 && 
com´es£d_Üigš®
 =ğ
Ùh”
.compressed_original;

5983 
	g¡Üe_¡©fs_t
::
	$dump
(
FÜm©‹r
 *
f
) const

5985 
f
->
	`dump_št
("tÙ®", 
tÙ®
);

5986 
f
->
	`dump_št
("avaabË", 
avaabË
);

5987 
f
->
	`dump_št
("®loÿ‹d", 
®loÿ‹d
);

5988 
f
->
	`dump_št
("¡Üed", 
¡Üed
);

5989 
f
->
	`dump_št
("com´es£d", 
com´es£d
);

5990 
f
->
	`dump_št
("com´es£d_®loÿ‹d", 
com´es£d_®loÿ‹d
);

5991 
f
->
	`dump_št
("com´es£d_Üigš®", 
com´es£d_Üigš®
);

5992 
	}
}

5994 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	g¡Üe_¡©fs_t
 &
	gs
)

5996 
	gout
 << 
	g¡d
::
hex


5997 << "¡Üe_¡©fs(0x" << 
s
.
avaabË


5998 << "/0x" << 
s
.
tÙ®


5999 << ", stÜed 0x" << 
s
.
¡Üed


6000 << "/0x" << 
s
.
®loÿ‹d


6001 << ", com´es 0x" << 
s
.
com´es£d


6002 << "/0x" << 
s
.
com´es£d_®loÿ‹d


6003 << "/0x" << 
s
.
com´es£d_Üigš®


6004 << 
¡d
::
dec


6006  
	gout
;

6009 
	gOSDOp
::
ş—r_d©a
(
veùÜ
<
OSDOp
>& 
İs
)

6011 
i
 = 0; 
	gi
 < 
	gİs
.
size
(); i++) {

6012 
	gOSDOp
& 
	gİ
 = 
İs
[
i
];

6013 
	gİ
.
	goutd©a
.
ş—r
();

6014 ià(
ûph_osd_İ_ty³_©Œ
(
İ
.op.op) &&

6015 
	gİ
.İ.
	gx©Œ
.
	gÇme_Ën
 &&

6016 
	gİ
.
	gšd©a
.
Ëngth
(è>ğ
İ
.İ.
x©Œ
.
Çme_Ën
) {

6017 
bufã½Œ
 
bp
(
İ
.İ.
x©Œ
.
Çme_Ën
);

6018 
bufã¾i¡
 
	gbl
;

6019 
	gbl
.
­³nd
(
bp
);

6020 
	gbl
.
cİy_š
(0, 
İ
.İ.
x©Œ
.
Çme_Ën
, op.
šd©a
);

6021 
	gİ
.
	gšd©a
.
şaim
(
bl
);

6022 } ià(
ûph_osd_İ_ty³_exec
(
İ
.op.op) &&

6023 
	gİ
.İ.
	gşs
.
	gşass_Ën
 &&

6024 
	gİ
.
	gšd©a
.
Ëngth
() >

6025 (
	gİ
.İ.
	gşs
.
	gşass_Ën
 + op.İ.şs.
	gm‘hod_Ën
)) {

6026 
__u8
 
	gËn
 = 
İ
.İ.
şs
.
şass_Ën
 + op.İ.şs.
m‘hod_Ën
;

6027 
bufã½Œ
 
bp
(
Ën
);

6028 
bufã¾i¡
 
	gbl
;

6029 
	gbl
.
­³nd
(
bp
);

6030 
	gbl
.
cİy_š
(0, 
Ën
, 
İ
.
šd©a
);

6031 
	gİ
.
	gšd©a
.
şaim
(
bl
);

6033 
	gİ
.
	gšd©a
.
ş—r
();

	@osd/osd_types.h

18 #iâdeà
CEPH_OSD_TYPES_H


19 
	#CEPH_OSD_TYPES_H


	)

21 
	~<s¡»am
>

22 
	~<¡dio.h
>

23 
	~<memÜy
>

24 
	~<boo¡/scİed_±r.hµ
>

25 
	~<boo¡/İtiÚ®/İtiÚ®_io.hµ
>

26 
	~<boo¡/v¬ŸÁ.hµ
>

28 
	~"šşude/¿dos/¿dos_ty³s.hµ
"

29 
	~"šşude/mempoŞ.h
"

31 
	~"msg/msg_ty³s.h
"

32 
	~"šşude/ty³s.h
"

33 
	~"šşude/utime.h
"

34 
	~"šşude/Com·tS‘.h
"

35 
	~"commÚ/hi¡og¿m.h
"

36 
	~"šşude/š‹rv®_£t.h
"

37 
	~"šşude/šlše_memÜy.h
"

38 
	~"commÚ/FÜm©‹r.h
"

39 
	~"commÚ/bloom_f‹r.hµ
"

40 
	~"commÚ/hobjeù.h
"

41 
	~"commÚ/¢­_ty³s.h
"

42 
	~"H™S‘.h
"

43 
	~"W©ch.h
"

44 
	~"šşude/cmp.h
"

45 
	~"lib¿dos/Li¡ObjeùIm¶.h
"

46 
	~"com´essÜ/Com´essÜ.h
"

47 
	~<©omic
>

49 
	#CEPH_OSD_ONDISK_MAGIC
 "ûph osd vŞumv026"

	)

51 
	#CEPH_OSD_FEATURE_INCOMPAT_BASE
 
Com·tS‘
::
	`F—tu»
(1, "š™ŸÈã©u» s‘(~v.18)")

	)

52 
	#CEPH_OSD_FEATURE_INCOMPAT_PGINFO
 
Com·tS‘
::
	`F—tu»
(2, "pgšfØobjeù")

	)

53 
	#CEPH_OSD_FEATURE_INCOMPAT_OLOC
 
Com·tS‘
::
	`F—tu»
(3, "objeù†oÿtÜ")

	)

54 
	#CEPH_OSD_FEATURE_INCOMPAT_LEC
 
Com·tS‘
::
	`F—tu»
(4, "Ï¡_•och_ş—n")

	)

55 
	#CEPH_OSD_FEATURE_INCOMPAT_CATEGORIES
 
Com·tS‘
::
	`F—tu»
(5, "ÿ‹gÜ›s")

	)

56 
	#CEPH_OSD_FEATURE_INCOMPAT_HOBJECTPOOL
 
Com·tS‘
::
	`F—tu»
(6, "hobjeùpoŞ")

	)

57 
	#CEPH_OSD_FEATURE_INCOMPAT_BIGINFO
 
Com·tS‘
::
	`F—tu»
(7, "bigšfo")

	)

58 
	#CEPH_OSD_FEATURE_INCOMPAT_LEVELDBINFO
 
Com·tS‘
::
	`F—tu»
(8, "Ëv–dbšfo")

	)

59 
	#CEPH_OSD_FEATURE_INCOMPAT_LEVELDBLOG
 
Com·tS‘
::
	`F—tu»
(9, "Ëv–dblog")

	)

60 
	#CEPH_OSD_FEATURE_INCOMPAT_SNAPMAPPER
 
Com·tS‘
::
	`F—tu»
(10, "¢­m­³r")

	)

61 
	#CEPH_OSD_FEATURE_INCOMPAT_SHARDS
 
Com·tS‘
::
	`F—tu»
(11, "sh¬ded objeùs")

	)

62 
	#CEPH_OSD_FEATURE_INCOMPAT_HINTS
 
Com·tS‘
::
	`F—tu»
(12, "Œª§ùiÚ hšts")

	)

63 
	#CEPH_OSD_FEATURE_INCOMPAT_PGMETA
 
Com·tS‘
::
	`F—tu»
(13, "pg m‘¨objeù")

	)

64 
	#CEPH_OSD_FEATURE_INCOMPAT_MISSING
 
Com·tS‘
::
	`F—tu»
(14, "ex¶ic™ missšg s‘")

	)

65 
	#CEPH_OSD_FEATURE_INCOMPAT_FASTINFO
 
Com·tS‘
::
	`F—tu»
(15, "ç¡šfØpg‡‰r")

	)

66 
	#CEPH_OSD_FEATURE_INCOMPAT_RECOVERY_DELETES
 
Com·tS‘
::
	`F—tu»
(16, "d–‘e š missšg s‘")

	)

70 
	#OSD_RECOVERY_PRIORITY_MIN
 0

	)

73 
	#OSD_BACKFILL_PRIORITY_BASE
 100

	)

76 
	#OSD_BACKFILL_DEGRADED_PRIORITY_BASE
 140

	)

79 
	#OSD_RECOVERY_PRIORITY_BASE
 180

	)

82 
	#OSD_BACKFILL_INACTIVE_PRIORITY_BASE
 220

	)

85 
	#OSD_RECOVERY_PRIORITY_MAX
 254

	)

88 
	#OSD_RECOVERY_PRIORITY_FORCED
 255

	)

91 
	#OSD_DELETE_PRIORITY_NORMAL
 179

	)

94 
	#OSD_DELETE_PRIORITY_FULLISH
 219

	)

97 
	#OSD_DELETE_PRIORITY_FULL
 255

	)

100 
hobjeù_t
 
	tcŞËùiÚ_li¡_hªdË_t
;

103 cÚ¡ *
ûph_osd_æag_Çme
(
æag
);

105 cÚ¡ *
ûph_osd_İ_æag_Çme
(
æag
);

108 
¡ršg
 
ûph_osd_æag_¡ršg
(
æags
);

110 
¡ršg
 
ûph_osd_İ_æag_¡ršg
(
æags
);

112 
¡ršg
 
ûph_osd_®loc_hšt_æag_¡ršg
(
æags
);

120 
	sosd_»qid_t
 {

121 
’t™y_Çme_t
 
	mÇme
;

122 
ûph_tid_t
 
	mtid
;

123 
št32_t
 
	mšc
;

125 
osd_»qid_t
()

126 : 
tid
(0), 
šc
(0)

128 
osd_»qid_t
(cÚ¡ osd_»qid_t& 
Ùh”
)

129 : 
Çme
(
Ùh”
.Çme), 
tid
(Ùh”.tid), 
šc
(other.inc)

131 
osd_»qid_t
(cÚ¡ 
’t™y_Çme_t
& 
a
, 
i
, 
ûph_tid_t
 
t
)

132 : 
Çme
(
a
), 
tid
(
t
), 
šc
(
i
)

135 
DENC
(
osd_»qid_t
, 
v
, 
p
) {

136 
DENC_START
(2, 2, 
p
);

137 
d’c
(
v
.
Çme
, 
p
);

138 
d’c
(
v
.
tid
, 
p
);

139 
d’c
(
v
.
šc
, 
p
);

140 
DENC_FINISH
(
p
);

142 
dump
(
FÜm©‹r
 *
f
) const;

143 
g’”©e_‹¡_š¡ªûs
(
li¡
<
osd_»qid_t
*>& 
o
);

145 
	$WRITE_CLASS_DENC
(
osd_»qid_t
)

149 
	spg_sh¬d_t
 {

150 cÚ¡ 
št32_t
 
NO_OSD
 = 0x7fffffff;

151 
št32_t
 
osd
;

152 
sh¬d_id_t
 
sh¬d
;

153 
	`pg_sh¬d_t
(è: 
	`osd
(-1), 
	`sh¬d
(
sh¬d_id_t
::
NO_SHARD
) {}

154 
ex¶ic™
 
	`pg_sh¬d_t
(
osd
è: 
	`osd
(osd), 
	`sh¬d
(
sh¬d_id_t
::
NO_SHARD
) {}

155 
	`pg_sh¬d_t
(
osd
, 
sh¬d_id_t
 
sh¬d
è: 
	`osd
(osd), 
	`sh¬d
(shard) {}

156 
boŞ
 
	`is_undefšed
() const {

157  
osd
 == -1;

159 
¡ršg
 
	`g‘_osd
(ècÚ¡ {  (
osd
 =ğ
NO_OSD
 ? "NONE" : 
	`to_¡ršg
(osd)); }

160 
	`’code
(
bufã¾i¡
 &
bl
) const;

161 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

162 
	`dump
(
FÜm©‹r
 *
f
) const {

163 
f
->
	`dump_unsigÃd
("osd", 
osd
);

164 ià(
sh¬d
 !ğ
sh¬d_id_t
::
NO_SHARD
) {

165 
f
->
	`dump_unsigÃd
("sh¬d", 
sh¬d
);

169 
	$WRITE_CLASS_ENCODER
(
pg_sh¬d_t
)

170 
	$WRITE_EQ_OPERATORS_2
(
pg_sh¬d_t
, 
osd
, 
sh¬d
)

171 
	$WRITE_CMP_OPERATORS_2
(
pg_sh¬d_t
, 
osd
, 
sh¬d
)

172 
o¡»am
 &
İ”©Ü
<<(o¡»am &
lhs
, cÚ¡ 
pg_sh¬d_t
 &
rhs
);

174 şas 
	cIsPGRecov”abËP»diÿ‹
 {

175 
public
:

179 
vœtu®
 
boŞ
 
	$İ”©Ü
()(cÚ¡ 
£t
<
pg_sh¬d_t
> &
have
) const = 0;

180 
vœtu®
 ~
	$IsPGRecov”abËP»diÿ‹
() {}

181 
	}
};

183 şas 
	cIsPGR—dabËP»diÿ‹
 {

184 
	mpublic
:

188 
vœtu®
 
boŞ
 
	$İ”©Ü
()(cÚ¡ 
£t
<
pg_sh¬d_t
> &
have
) const = 0;

189 
vœtu®
 ~
	$IsPGR—dabËP»diÿ‹
() {}

190 
	}
};

192 
šlše
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gosd_»qid_t
& 
	gr
) {

193  
	gout
 << 
	gr
.
	gÇme
 << "." <<„.
	gšc
 << ":" <<„.
	gtid
;

196 
šlše
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
osd_»qid_t
& 
l
, cÚ¡ 
	gosd_»qid_t
& 
	gr
) {

197  (
	gl
.
	gÇme
 =ğ
r
.
Çme
è&& (
l
.
šc
 =ğr.šcè&& (l.
tid
 ==„.tid);

199 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
osd_»qid_t
& 
l
, cÚ¡ 
	gosd_»qid_t
& 
	gr
) {

200  (
	gl
.
	gÇme
 !ğ
r
.
Çme
è|| (
l
.
šc
 !ğr.šcè|| (l.
tid
 !=„.tid);

202 
šlše
 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	gosd_»qid_t
& 
	gl
, cÚ¡ osd_»qid_t& 
	gr
) {

203  (
	gl
.
	gÇme
 < 
	gr
.Çmeè|| (l.
	gšc
 <„.inc) ||

204 (
	gl
.
	gÇme
 =ğ
r
.
Çme
 && 
l
.
šc
 =ğr.šø&&†.
tid
 <„.tid);

206 
šlše
 
boŞ
 
	gİ”©Ü
<=(cÚ¡ 
osd_»qid_t
& 
l
, cÚ¡ 
	gosd_»qid_t
& 
	gr
) {

207  (
	gl
.
	gÇme
 < 
	gr
.Çmeè|| (l.
	gšc
 <„.inc) ||

208 (
	gl
.
	gÇme
 =ğ
r
.
Çme
 && 
l
.
šc
 =ğr.šø&&†.
tid
 <=„.tid);

210 
šlše
 
boŞ
 
	gİ”©Ü
>(cÚ¡ 
	gosd_»qid_t
& 
	gl
, cÚ¡ osd_»qid_t& 
	gr
è{  !Ö <ğ
r
); }

211 
šlše
 
boŞ
 
	gİ”©Ü
>=(cÚ¡ 
osd_»qid_t
& 
l
, cÚ¡ 
	gosd_»qid_t
& 
	gr
è{  !(
	gl
 <„); }

213 
Çme¥aû
 
	g¡d
 {

214 
	g‹m¶©e
<> 
	ghash
<
	gosd_»qid_t
> {

215 
size_t
 
İ”©Ü
()(cÚ¡ 
	gosd_»qid_t
 &
	gr
) const {

216 
	ghash
<
	gušt64_t
> 
	gH
;

217  
H
(
r
.
Çme
.
num
(è^„.
tid
 ^„.
šc
);

227 
	sobjeù_loÿtÜ_t
 {

229 
št64_t
 
	mpoŞ
;

230 
¡ršg
 
	mkey
;

231 
¡ršg
 
	mn¥aû
;

232 
št64_t
 
	mhash
;

234 
ex¶ic™
 
objeù_loÿtÜ_t
()

235 : 
poŞ
(-1), 
hash
(-1) {}

236 
ex¶ic™
 
objeù_loÿtÜ_t
(
št64_t
 
po
)

237 : 
poŞ
(
po
), 
hash
(-1) {}

238 
ex¶ic™
 
objeù_loÿtÜ_t
(
št64_t
 
po
, iÁ64_ˆ
ps
)

239 : 
poŞ
(
po
), 
hash
(
ps
) {}

240 
ex¶ic™
 
objeù_loÿtÜ_t
(
št64_t
 
po
, 
¡ršg
 
ns
)

241 : 
poŞ
(
po
), 
n¥aû
(
ns
), 
hash
(-1) {}

242 
ex¶ic™
 
objeù_loÿtÜ_t
(
št64_t
 
po
, 
¡ršg
 
ns
, iÁ64_ˆ
ps
)

243 : 
poŞ
(
po
), 
n¥aû
(
ns
), 
hash
(
ps
) {}

244 
ex¶ic™
 
objeù_loÿtÜ_t
(
št64_t
 
po
, 
¡ršg
 
ns
, sŒšg 
s
)

245 : 
poŞ
(
po
), 
key
(
s
), 
n¥aû
(
ns
), 
hash
(-1) {}

246 
ex¶ic™
 
objeù_loÿtÜ_t
(cÚ¡ 
hobjeù_t
& 
soid
)

247 : 
poŞ
(
soid
.poŞ), 
key
(soid.
g‘_key
()), 
n¥aû
(soid.n¥aû), 
hash
(-1) {}

249 
št64_t
 
g‘_poŞ
() const {

250  
	mpoŞ
;

253 
ş—r
() {

254 
	mpoŞ
 = -1;

255 
	mkey
 = "";

256 
	mn¥aû
 = "";

257 
	mhash
 = -1;

260 
boŞ
 
em±y
() const {

261  
	mpoŞ
 == -1;

264 
’code
(
bufã¾i¡
& 
bl
) const;

265 
decode
(
bufã¾i¡
::
™”©Ü
& 
p
);

266 
dump
(
FÜm©‹r
 *
f
) const;

267 
g’”©e_‹¡_š¡ªûs
(
li¡
<
objeù_loÿtÜ_t
*>& 
o
);

269 
	$WRITE_CLASS_ENCODER
(
objeù_loÿtÜ_t
)

271 
šlše
 
boŞ
 
İ”©Ü
==(cÚ¡ 
objeù_loÿtÜ_t
& 
l
, cÚ¡ objeù_loÿtÜ_t& 
r
) {

272  
l
.
poŞ
 =ğ
r
.poŞ &&†.
key
 =ğr.key &&†.
n¥aû
 =ğr.n¥aû &&†.
hash
 ==„.hash;

273 
	}
}

274 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
objeù_loÿtÜ_t
& 
l
, cÚ¡ 
	gobjeù_loÿtÜ_t
& 
	gr
) {

275  !(
	gl
 =ğ
r
);

278 
šlše
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gobjeù_loÿtÜ_t
& 
	gloc
)

280 
	gout
 << "@" << 
	gloc
.
	gpoŞ
;

281 ià(
	gloc
.
	gn¥aû
.
Ëngth
())

282 
	gout
 << ";" << 
	gloc
.
	gn¥aû
;

283 ià(
	gloc
.
	gkey
.
Ëngth
())

284 
	gout
 << ":" << 
	gloc
.
	gkey
;

285  
	gout
;

288 
	s»que¡_»dœeù_t
 {

289 
	m´iv©e
:

290 
objeù_loÿtÜ_t
 
»dœeù_loÿtÜ
;

291 
¡ršg
 
	m»dœeù_objeù
;

292 
bufã¾i¡
 
	mosd_š¡ruùiÚs
;

294 
ä›nd
 
	mo¡»am
& 
	mİ”©Ü
<<(o¡»am& 
	mout
, cÚ¡ 
	m»que¡_»dœeù_t
& 
	m»dœ
);

295 
	mpublic
:

297 
»que¡_»dœeù_t
() {}

298 
ex¶ic™
 
»que¡_»dœeù_t
(cÚ¡ 
objeù_loÿtÜ_t
& 
Üig
, 
št64_t
 
½oŞ
) :

299 
»dœeù_loÿtÜ
(
Üig
è{„edœeù_loÿtÜ.
poŞ
 = 
½oŞ
; }

300 
ex¶ic™
 
»que¡_»dœeù_t
(cÚ¡ 
objeù_loÿtÜ_t
& 
¾oc
) :

301 
»dœeù_loÿtÜ
(
¾oc
) {}

302 
ex¶ic™
 
»que¡_»dœeù_t
(cÚ¡ 
objeù_loÿtÜ_t
& 
Üig
,

303 cÚ¡ 
¡ršg
& 
robj
) :

304 
»dœeù_loÿtÜ
(
Üig
), 
»dœeù_objeù
(
robj
) {}

306 
£t_š¡ruùiÚs
(cÚ¡ 
bufã¾i¡
& 
bl
è{ 
	mosd_š¡ruùiÚs
 = bl; }

307 cÚ¡ 
	mbufã¾i¡
& 
g‘_š¡ruùiÚs
(è{  
	mosd_š¡ruùiÚs
; }

309 
boŞ
 
em±y
(ècÚ¡ {  
	m»dœeù_loÿtÜ
.empty() &&

310 
	m»dœeù_objeù
.
em±y
(); }

312 
combše_w™h_loÿtÜ
(
objeù_loÿtÜ_t
& 
Üig
, 
¡ršg
& 
obj
) const {

313 
	mÜig
 = 
»dœeù_loÿtÜ
;

314 ià(!
	m»dœeù_objeù
.
em±y
())

315 
	mobj
 = 
»dœeù_objeù
;

318 
’code
(
bufã¾i¡
& 
bl
) const;

319 
decode
(
bufã¾i¡
::
™”©Ü
& 
bl
);

320 
dump
(
FÜm©‹r
 *
f
) const;

321 
g’”©e_‹¡_š¡ªûs
(
li¡
<
»que¡_»dœeù_t
*>& 
o
);

323 
	$WRITE_CLASS_ENCODER
(
»que¡_»dœeù_t
)

325 
šlše
 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
»que¡_»dœeù_t
& 
»dœ
) {

326 
out
 << "objeù " << 
»dœ
.
»dœeù_objeù
 << ",†oÿtÜ{" <<„edœ.
»dœeù_loÿtÜ
 << "}";

327  
out
;

328 
	}
}

332 
	mCEPH_OSD_RMW_FLAG_READ
 = (1 << 1),

333 
	mCEPH_OSD_RMW_FLAG_WRITE
 = (1 << 2),

334 
	mCEPH_OSD_RMW_FLAG_CLASS_READ
 = (1 << 3),

335 
	mCEPH_OSD_RMW_FLAG_CLASS_WRITE
 = (1 << 4),

336 
	mCEPH_OSD_RMW_FLAG_PGOP
 = (1 << 5),

337 
	mCEPH_OSD_RMW_FLAG_CACHE
 = (1 << 6),

338 
	mCEPH_OSD_RMW_FLAG_FORCE_PROMOTE
 = (1 << 7),

339 
	mCEPH_OSD_RMW_FLAG_SKIP_HANDLE_CACHE
 = (1 << 8),

340 
	mCEPH_OSD_RMW_FLAG_SKIP_PROMOTE
 = (1 << 9),

341 
	mCEPH_OSD_RMW_FLAG_RWORDERED
 = (1 << 10),

347 
	#OSD_SUPERBLOCK_GOBJECT
 
	`ghobjeù_t
(
	`hobjeù_t
(
	`sobjeù_t
(
	`objeù_t
("osd_su³rblock"), 0)))

	)

350 
ušt32_t
 
	tps_t
;

353 
	sŞd_pg_t
 {

354 
ûph_pg
 
	mv
;

355 
’code
(
bufã¾i¡
& 
bl
) const {

356 ::
’code_¿w
(
v
, 
bl
);

358 
decode
(
bufã¾i¡
::
™”©Ü
& 
bl
) {

359 ::
decode_¿w
(
v
, 
bl
);

362 
	$WRITE_CLASS_ENCODER
(
Şd_pg_t
)

365 
	spg_t
 {

366 
ušt64_t
 
m_poŞ
;

367 
ušt32_t
 
m_£ed
;

369 
	`pg_t
(è: 
	`m_poŞ
(0), 
	`m_£ed
(0) {}

370 
	`pg_t
(
ps_t
 
£ed
, 
ušt64_t
 
poŞ
) :

371 
	`m_poŞ
(
poŞ
), 
	`m_£ed
(
£ed
) {}

373 
	`pg_t
(cÚ¡ 
ûph_pg
& 
ıg
) :

374 
	`m_poŞ
(
ıg
.
poŞ
), 
	`m_£ed
(ıg.
ps
) {}

377 
	`pg_t
(cÚ¡ 
Şd_pg_t
& 
İg
) {

378 *
this
 = 
İg
.
v
;

381 
Şd_pg_t
 
	`g‘_Şd_pg
() const {

382 
Şd_pg_t
 
o
;

383 
	`as£¹
(
m_poŞ
 < 0xffffffffull);

384 
o
.
v
.
poŞ
 = 
m_poŞ
;

385 
o
.
v
.
ps
 = 
m_£ed
;

386 
o
.
v
.
´eã¼ed
 = (
__s16
)-1;

387  
o
;

390 
ps_t
 
	`ps
() const {

391  
m_£ed
;

393 
št64_t
 
	`poŞ
() const {

394  
m_poŞ
;

397 cÚ¡ 
ušt8_t
 
ÿlc_Çme_buf_size
 = 36;

398 *
	`ÿlc_Çme
(*
buf
, cÚ¡ *
suffix_backwÜds
) const;

400 
	`£t_ps
(
ps_t
 
p
) {

401 
m_£ed
 = 
p
;

403 
	`£t_poŞ
(
ušt64_t
 
p
) {

404 
m_poŞ
 = 
p
;

407 
pg_t
 
	`g‘_·»Á
() const;

408 
pg_t
 
	`g‘_ªû¡Ü
(
Şd_pg_num
) const;

410 
	`´št
(*
o
, 
maxËn
) const;

411 
boŞ
 
	`·r£
(cÚ¡ *
s
);

413 
boŞ
 
	`is_¥l™
(
Şd_pg_num
, 
Ãw_pg_num
, 
£t
<
pg_t
> *
pchd»n
) const;

419 
	`g‘_¥l™_b™s
(
pg_num
) const;

421 
boŞ
 
	`cÚšs
(
b™s
, cÚ¡ 
ghobjeù_t
& 
oid
) {

422  
oid
.
	`m©ch
(
b™s
, 
	`ps
());

424 
boŞ
 
	`cÚšs
(
b™s
, cÚ¡ 
hobjeù_t
& 
oid
) {

425  
oid
.
	`m©ch
(
b™s
, 
	`ps
());

428 
hobjeù_t
 
	`g‘_hobj_¡¬t
() const;

429 
hobjeù_t
 
	`g‘_hobj_’d
(
pg_num
) const;

431 
	`’code
(
bufã¾i¡
& 
bl
) const {

432 
usšg
 
ûph
::
’code
;

433 
__u8
 
v
 = 1;

434 
	`’code
(
v
, 
bl
);

435 
	`’code
(
m_poŞ
, 
bl
);

436 
	`’code
(
m_£ed
, 
bl
);

437 
	`’code
((
št32_t
)-1, 
bl
);

439 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
bl
) {

440 
usšg
 
ûph
::
decode
;

441 
__u8
 
v
;

442 
	`decode
(
v
, 
bl
);

443 
	`decode
(
m_poŞ
, 
bl
);

444 
	`decode
(
m_£ed
, 
bl
);

445 
bl
.
	`advªû
((
št32_t
));

447 
	`decode_Şd
(
bufã¾i¡
::
™”©Ü
& 
bl
) {

448 
usšg
 
ûph
::
decode
;

449 
Şd_pg_t
 
İg
;

450 
	`decode
(
İg
, 
bl
);

451 *
this
 = 
İg
;

453 
	`dump
(
FÜm©‹r
 *
f
) const;

454 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_t
*>& 
o
);

456 
	$WRITE_CLASS_ENCODER
(
pg_t
)

458 
šlše
 
boŞ
 
İ”©Ü
<(cÚ¡ 
pg_t
& 
l
, cÚ¡…g_t& 
r
) {

459  
l
.
	`poŞ
(è< 
r
.pool() ||

460 (
l
.
	`poŞ
(è=ğ
r
.poŞ(è&& (l.
	`ps
() <„.ps()));

461 
	}
}

462 
šlše
 
boŞ
 
	gİ”©Ü
<=(cÚ¡ 
pg_t
& 
l
, cÚ¡ 
	gpg_t
& 
	gr
) {

463  
	gl
.
poŞ
(è< 
	gr
.pool() ||

464 (
	gl
.
poŞ
(è=ğ
r
.poŞ(è&& (
l
.
ps
() <=„.ps()));

466 
šlše
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
pg_t
& 
l
, cÚ¡ 
	gpg_t
& 
	gr
) {

467  
	gl
.
poŞ
(è=ğ
r
.pool() &&

468 
l
.
ps
(è=ğ
r
.ps();

470 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
pg_t
& 
l
, cÚ¡ 
	gpg_t
& 
	gr
) {

471  
	gl
.
poŞ
(è!ğ
r
.pool() ||

472 
l
.
ps
(è!ğ
r
.ps();

474 
šlše
 
boŞ
 
	gİ”©Ü
>(cÚ¡ 
	gpg_t
& 
	gl
, cÚ¡…g_t& 
	gr
) {

475  
	gl
.
poŞ
(è> 
	gr
.pool() ||

476 (
	gl
.
poŞ
(è=ğ
r
.poŞ(è&& (
l
.
ps
() >„.ps()));

478 
šlše
 
boŞ
 
	gİ”©Ü
>=(cÚ¡ 
pg_t
& 
l
, cÚ¡ 
	gpg_t
& 
	gr
) {

479  
	gl
.
poŞ
(è> 
	gr
.pool() ||

480 (
	gl
.
poŞ
(è=ğ
r
.poŞ(è&& (
l
.
ps
() >=„.ps()));

483 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gpg_t
 &
	gpg
);

485 
Çme¥aû
 
	g¡d
 {

486 
	g‹m¶©e
<> 
	ghash
< 
	gpg_t
 >

488 
size_t
 
İ”©Ü
()ĞcÚ¡ 
	gpg_t
& 
	gx
 ) const

490 
	ghash
<
	gušt32_t
> 
	gH
;

492  
H
((
x
.
poŞ
(è& 0xffffffffè^ (x.poŞ(è>> 32è^ x.
ps
(è^ (
št32_t
)(-1));

497 
	s¥g_t
 {

498 
pg_t
 
	mpgid
;

499 
sh¬d_id_t
 
	msh¬d
;

500 
¥g_t
(è: 
sh¬d
(
sh¬d_id_t
::
NO_SHARD
) {}

501 
¥g_t
(
pg_t
 
pgid
, 
sh¬d_id_t
 
sh¬d
) :…gid(pgid), shard(shard) {}

502 
ex¶ic™
 
¥g_t
(
pg_t
 
pgid
è:…gidÕgid), 
sh¬d
(
sh¬d_id_t
::
NO_SHARD
) {}

503 
g‘_¥l™_b™s
(
pg_num
) const {

504  
pgid
.
g‘_¥l™_b™s
(
pg_num
);

506 
¥g_t
 
g‘_·»Á
() const {

507  
¥g_t
(
pgid
.
g‘_·»Á
(), 
sh¬d
);

509 
ps_t
 
ps
() const {

510  
	mpgid
.
ps
();

512 
ušt64_t
 
poŞ
() const {

513  
	mpgid
.
poŞ
();

516 cÚ¡ 
ušt8_t
 
	mÿlc_Çme_buf_size
 = 
pg_t
::
ÿlc_Çme_buf_size
 + 4;

517 *
ÿlc_Çme
(*
buf
, cÚ¡ *
suffix_backwÜds
) const;

519 
boŞ
 
·r£
(cÚ¡ *
s
);

520 
boŞ
 
·r£
(cÚ¡ 
¡d
::
¡ršg
& 
s
) {

521  
·r£
(
s
.
c_¡r
());

524 
¥g_t
 
g‘_ªû¡Ü
(
Şd_pg_num
) const {

525  
¥g_t
(
pgid
.
g‘_ªû¡Ü
(
Şd_pg_num
), 
sh¬d
);

528 
boŞ
 
is_¥l™
(
Şd_pg_num
, 
Ãw_pg_num
,

529 
£t
<
¥g_t
> *
pchd»n
) const {

530 
	m£t
<
	mpg_t
> 
	m_chd»n
;

531 
	m£t
<
	mpg_t
> *
	mchd»n
 = 
pchd»n
 ? &
_chd»n
 : 
NULL
;

532 
boŞ
 
	mis_¥l™
 = 
pgid
.
is_¥l™
(
Şd_pg_num
, 
Ãw_pg_num
, 
chd»n
);

533 ià(
	mpchd»n
 && 
	mis_¥l™
) {

534 
	m£t
<
	mpg_t
>::
™”©Ü
 
i
 = 
_chd»n
.
begš
();

535 
	mi
 !ğ
_chd»n
.
’d
();

536 ++
	mi
) {

537 
	mpchd»n
->
š£¹
(
¥g_t
(*
i
, 
sh¬d
));

540  
	mis_¥l™
;

542 
boŞ
 
is_no_sh¬d
() const {

543  
	msh¬d
 =ğ
sh¬d_id_t
::
NO_SHARD
;

546 
ghobjeù_t
 
make_pgm‘a_oid
() const {

547  
	mghobjeù_t
::
make_pgm‘a
(
pgid
.
poŞ
(),…gid.
ps
(), 
sh¬d
);

550 
’code
(
bufã¾i¡
 &
bl
) const {

551 
ENCODE_START
(1, 1, 
bl
);

552 
’code
(
pgid
, 
bl
);

553 
’code
(
sh¬d
, 
bl
);

554 
ENCODE_FINISH
(
bl
);

556 
decode
(
bufã¾i¡
::
™”©Ü
 &
bl
) {

557 
DECODE_START
(1, 
bl
);

558 
decode
(
pgid
, 
bl
);

559 
decode
(
sh¬d
, 
bl
);

560 
DECODE_FINISH
(
bl
);

563 
ghobjeù_t
 
make_‹mp_ghobjeù
(cÚ¡ 
¡ršg
& 
Çme
) const {

564  
ghobjeù_t
(

565 
hobjeù_t
(
objeù_t
(
Çme
), "", 
CEPH_NOSNAP
,

566 
pgid
.
ps
(),

567 
hobjeù_t
::
POOL_TEMP_START
 - 
pgid
.
poŞ
(), ""),

568 
ghobjeù_t
::
NO_GEN
,

569 
sh¬d
);

572 
hash_to_sh¬d
(
num_sh¬ds
) const {

573  
ps
(è% 
	mnum_sh¬ds
;

576 
	$WRITE_CLASS_ENCODER
(
¥g_t
)

577 
	$WRITE_EQ_OPERATORS_2
(
¥g_t
, 
pgid
, 
sh¬d
)

578 
	$WRITE_CMP_OPERATORS_2
(
¥g_t
, 
pgid
, 
sh¬d
)

580 
Çme¥aû
 
¡d
 {

581 
‹m¶©e
<> 
hash
< 
¥g_t
 >

583 
size_t
 
	`İ”©Ü
()ĞcÚ¡ 
¥g_t
& 
x
 ) const

585 
hash
<
ušt32_t
> 
H
;

586  
	`H
(
hash
<
pg_t
>()(
x
.
pgid
è^ x.
sh¬d
);

589 
	}
}

591 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	g¥g_t
 &
	gpg
);

595 şas 
	ccŞl_t
 {

596 
	ety³_t
 {

597 
	mTYPE_META
 = 0,

598 
	mTYPE_LEGACY_TEMP
 = 1,

599 
	mTYPE_PG
 = 2,

600 
	mTYPE_PG_TEMP
 = 3,

602 
ty³_t
 
	gty³
;

603 
¥g_t
 
	gpgid
;

604 
ušt64_t
 
	g»mov®_£q
;

606 
	g_¡r_buff
[
¥g_t
::
ÿlc_Çme_buf_size
];

607 *
	g_¡r
;

609 
ÿlc_¡r
();

611 
	$cŞl_t
(
ty³_t
 
t
, 
¥g_t
 
p
, 
ušt64_t
 
r
)

612 : 
	`ty³
(
t
), 
	`pgid
(
p
), 
	$»mov®_£q
(
r
) {

613 
	`ÿlc_¡r
();

614 
	}
}

616 
	gpublic
:

617 
	$cŞl_t
(è: 
	`ty³
(
TYPE_META
), 
	$»mov®_£q
(0)

619 
	`ÿlc_¡r
();

620 
	}
}

622 
	$cŞl_t
(cÚ¡ 
cŞl_t
& 
Ùh”
)

623 : 
	`ty³
(
Ùh”
.
ty³
), 
	`pgid
(Ùh”.
pgid
), 
	$»mov®_£q
(
Ùh”
.
»mov®_£q
) {

624 
	`ÿlc_¡r
();

625 
	}
}

627 
ex¶ic™
 
	$cŞl_t
(
¥g_t
 
pgid
)

628 : 
	`ty³
(
TYPE_PG
), 
	`pgid
(
pgid
), 
	$»mov®_£q
(0)

630 
	`ÿlc_¡r
();

631 
	}
}

633 
	gcŞl_t
& 
	gİ”©Ü
=(cÚ¡ 
cŞl_t
& 
rhs
)

635 
this
->
ty³
 = 
rhs
.type;

636 
	gthis
->
	gpgid
 = 
rhs
.
pgid
;

637 
	gthis
->
	g»mov®_£q
 = 
rhs
.
»mov®_£q
;

638 
	gthis
->
ÿlc_¡r
();

639  *
	gthis
;

643 
cŞl_t
 
	$m‘a
() {

644  
	`cŞl_t
();

645 
	}
}

646 
cŞl_t
 
	$pg
(
¥g_t
 
p
) {

647  
	`cŞl_t
(
p
);

648 
	}
}

650 cÚ¡ 
	g¡d
::
¡ršg
 
	$to_¡r
() const {

651  
	`¡ršg
(
_¡r
);

652 
	}
}

653 cÚ¡ *
	$c_¡r
() const {

654  
_¡r
;

655 
	}
}

657 
boŞ
 
·r£
(cÚ¡ 
¡d
::
¡ršg
& 
s
);

659 
	gİ”©Ü
<(cÚ¡ 
	gcŞl_t
 &
	grhs
) const {

660  
	gty³
 < 
	grhs
.type ||

661 (
	gty³
 =ğ
rhs
.
ty³
 && 
pgid
 <„hs.pgid);

664 
boŞ
 
	$is_m‘a
() const {

665  
ty³
 =ğ
TYPE_META
;

666 
	}
}

667 
boŞ
 
	$is_pg_´efix
(
¥g_t
 *
pgid_
) const {

668 ià(
ty³
 =ğ
TYPE_PG
 ||y³ =ğ
TYPE_PG_TEMP
) {

669 *
pgid_
 = 
pgid
;

670  
Œue
;

672  
çl£
;

673 
	}
}

674 
boŞ
 
	$is_pg
() const {

675  
ty³
 =ğ
TYPE_PG
;

676 
	}
}

677 
boŞ
 
	$is_pg
(
¥g_t
 *
pgid_
) const {

678 ià(
ty³
 =ğ
TYPE_PG
) {

679 *
pgid_
 = 
pgid
;

680  
Œue
;

682  
çl£
;

683 
	}
}

684 
boŞ
 
	$is_‹mp
() const {

685  
ty³
 =ğ
TYPE_PG_TEMP
;

686 
	}
}

687 
boŞ
 
	$is_‹mp
(
¥g_t
 *
pgid_
) const {

688 ià(
ty³
 =ğ
TYPE_PG_TEMP
) {

689 *
pgid_
 = 
pgid
;

690  
Œue
;

692  
çl£
;

693 
	}
}

695 
	$’code
(
bufã¾i¡
& 
bl
) const;

696 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
bl
);

697 
size_t
 
	$’coded_size
() const;

699 
šlše
 
boŞ
 
İ”©Ü
==(cÚ¡ 
cŞl_t
& 
rhs
) const {

701 ià(
ty³
 !ğ
rhs
.type)

702  
çl£
;

703 ià(
ty³
 =ğ
TYPE_META
)

704  
Œue
;

705  
ty³
 =ğ
rhs
.ty³ && 
pgid
 ==„hs.pgid;

706 
	}
}

707 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
cŞl_t
& 
rhs
) const {

708  !(*
this
 =ğ
rhs
);

713 
cŞl_t
 
	$g‘_‹mp
() const {

714 
	`as£¹
(
ty³
 =ğ
TYPE_PG
);

715  
	`cŞl_t
(
TYPE_PG_TEMP
, 
pgid
, 0);

716 
	}
}

718 
ghobjeù_t
 
	$g‘_mš_hobj
() const {

719 
ghobjeù_t
 
o
;

720 
ty³
) {

721 
TYPE_PG
:

722 
o
.
hobj
.
poŞ
 = 
pgid
.
	`poŞ
();

723 
o
.
	`£t_sh¬d
(
pgid
.
sh¬d
);

725 
TYPE_META
:

726 
o
.
hobj
.
poŞ
 = -1;

731  
o
;

732 
	}
}

734 
	$hash_to_sh¬d
(
num_sh¬ds
) const {

735 ià(
ty³
 =ğ
TYPE_PG
)

736  
pgid
.
	`hash_to_sh¬d
(
num_sh¬ds
);

738 
	}
}

740 
	$dump
(
FÜm©‹r
 *
f
) const;

741 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
cŞl_t
*>& 
o
);

742 
	}
};

744 
	$WRITE_CLASS_ENCODER
(
cŞl_t
)

746 
šlše
 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
cŞl_t
& 
c
) {

747 
out
 << 
c
.
	`to_¡r
();

748  
out
;

749 
	}
}

751 
Çme¥aû
 
	g¡d
 {

752 
	g‹m¶©e
<> 
	ghash
<
	gcŞl_t
> {

753 
size_t
 
İ”©Ü
()(cÚ¡ 
	gcŞl_t
 &
	gc
) const {

754 
size_t
 
	gh
 = 0;

755 
¡ršg
 
¡r
(
c
.
to_¡r
());

756 
	g¡d
::
¡ršg
::
cÚ¡_™”©Ü
 
’d
(
¡r
.end());

757 
	g¡d
::
¡ršg
::
cÚ¡_™”©Ü
 
s
 = 
¡r
.
begš
(); 
	gs
 !ğ
’d
; ++s) {

758 
	gh
 +ğ*
s
;

759 
	gh
 +ğ(
h
 << 10);

760 
	gh
 ^ğ(
h
 >> 6);

762 
	gh
 +ğ(
h
 << 3);

763 
	gh
 ^ğ(
h
 >> 11);

764 
	gh
 +ğ(
h
 << 15);

765  
	gh
;

770 
šlše
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gûph_objeù_Ïyout
 &
	gŞ
)

772 
	gout
 << 
pg_t
(
Ş
.
Ş_pgid
);

773 
	gsu
 = 
Ş
.
Ş_¡re_un™
;

774 ià(
	gsu
)

775 
	gout
 << ".su=" << 
	gsu
;

776  
	gout
;

786 şas 
	cev”siÚ_t
 {

787 
	mpublic
:

788 
v”siÚ_t
 
v”siÚ
;

789 
•och_t
 
	m•och
;

790 
__u32
 
	m__·d
;

791 
	$ev”siÚ_t
(è: 
	`v”siÚ
(0), 
	`•och
(0), 
	$__·d
(0) {}

792 
	$ev”siÚ_t
(
•och_t
 
e
, 
v”siÚ_t
 
v
è: 
	`v”siÚ
(v), 
	`•och
Ó), 
	$__·d
(0è{
	}
}

795 
	$ev”siÚ_t
(cÚ¡ 
ûph_ev”siÚ
& 
û
) :

796 
	`v”siÚ
(
û
.
v”siÚ
),

797 
	`•och
(
û
.
•och
),

798 
	$__·d
(0è{ 
	}
}

800 
ex¶ic™
 
	$ev”siÚ_t
(
bufã¾i¡
& 
bl
è: 
	$__·d
(0è{ 
	`decode
(
bl
); 
	}
}

802 cÚ¡ 
	gev”siÚ_t
& 
	$max
() {

803 cÚ¡ 
ev”siÚ_t
 
	`max
(-1,-1);

804  
max
;

805 
	}
}

807 
İ”©Ü
 
	$ûph_ev”siÚ
() {

808 
ûph_ev”siÚ
 
c
;

809 
c
.
•och
 =ƒpoch;

810 
c
.
v”siÚ
 = version;

811  
c
;

812 
	}
}

814 
¡ršg
 
	$g‘_key_Çme
() const;

817 
šlše
 
	$g‘_key_Çme
(* 
key
) const {

819 
key
[31] = 0;

820 
r™ß
<
ušt64_t
, 10, 20>(
v”siÚ
, 
key
 + 31);

821 
key
[10] = '.';

822 
r™ß
<
ušt32_t
, 10, 10>(
•och
, 
key
 + 10);

823 
	}
}

825 
	$’code
(
bufã¾i¡
 &
bl
) const {

826 #ià
	`defšed
(
CEPH_LITTLE_ENDIAN
)

827 
bl
.
	`­³nd
((*)
this
, (
v”siÚ_t
è+ (
•och_t
));

829 
usšg
 
ûph
::
’code
;

830 
	`’code
(
v”siÚ
, 
bl
);

831 
	`’code
(
•och
, 
bl
);

833 
	}
}

834 
	$decode
(
bufã¾i¡
::
™”©Ü
 &
bl
) {

835 #ià
	`defšed
(
CEPH_LITTLE_ENDIAN
)

836 
bl
.
	`cİy
((
v”siÚ_t
è+ (
•och_t
), (*)
this
);

838 
usšg
 
ûph
::
decode
;

839 
	`decode
(
v”siÚ
, 
bl
);

840 
	`decode
(
•och
, 
bl
);

842 
	}
}

843 
	$decode
(
bufã¾i¡
& 
bl
) {

844 
bufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
	`begš
();

845 
	`decode
(
p
);

846 
	}
}

848 
	$WRITE_CLASS_ENCODER
(
ev”siÚ_t
)

850 
šlše
 
boŞ
 
İ”©Ü
==(cÚ¡ 
ev”siÚ_t
& 
l
, cÚ¡ƒv”siÚ_t& 
r
) {

851  (
l
.
•och
 =ğ
r
.•ochè&& (l.
v”siÚ
 ==„.version);

852 
	}
}

853 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
ev”siÚ_t
& 
l
, cÚ¡ 
	gev”siÚ_t
& 
	gr
) {

854  (
	gl
.
	g•och
 !ğ
r
.
•och
è|| (
l
.
v”siÚ
 !=„.version);

856 
šlše
 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	gev”siÚ_t
& 
	gl
, cÚ¡ƒv”siÚ_t& 
	gr
) {

857  (
	gl
.
	g•och
 =ğ
r
.
•och
è? (
l
.
v”siÚ
 <„.version):(l.epoch <„.epoch);

859 
šlše
 
boŞ
 
	gİ”©Ü
<=(cÚ¡ 
ev”siÚ_t
& 
l
, cÚ¡ 
	gev”siÚ_t
& 
	gr
) {

860  (
	gl
.
	g•och
 =ğ
r
.
•och
è? (
l
.
v”siÚ
 <=„.version):(l.epoch <=„.epoch);

862 
šlše
 
boŞ
 
	gİ”©Ü
>(cÚ¡ 
	gev”siÚ_t
& 
	gl
, cÚ¡ƒv”siÚ_t& 
	gr
) {

863  (
	gl
.
	g•och
 =ğ
r
.
•och
è? (
l
.
v”siÚ
 >„.version):(l.epoch >„.epoch);

865 
šlše
 
boŞ
 
	gİ”©Ü
>=(cÚ¡ 
ev”siÚ_t
& 
l
, cÚ¡ 
	gev”siÚ_t
& 
	gr
) {

866  (
	gl
.
	g•och
 =ğ
r
.
•och
è? (
l
.
v”siÚ
 >=„.version):(l.epoch >=„.epoch);

868 
šlše
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gev”siÚ_t
& 
	ge
) {

869  
	gout
 << 
	ge
.
	g•och
 << "'" <<ƒ.
	gv”siÚ
;

877 
	sobjeù¡Üe_³rf_¡©_t
 {

879 
ušt64_t
 
	mos_comm™_Ï‹ncy_ns
;

880 
ušt64_t
 
	mos_­¶y_Ï‹ncy_ns
;

882 
objeù¡Üe_³rf_¡©_t
() :

883 
os_comm™_Ï‹ncy_ns
(0), 
os_­¶y_Ï‹ncy_ns
(0) {}

885 
boŞ
 
	mİ”©Ü
==(cÚ¡ 
objeù¡Üe_³rf_¡©_t
 &
r
) const {

886  
os_comm™_Ï‹ncy_ns
 =ğ
r
.os_commit_latency_ns &&

887 
os_­¶y_Ï‹ncy_ns
 =ğ
r
.os_apply_latency_ns;

890 
add
(cÚ¡ 
objeù¡Üe_³rf_¡©_t
 &
o
) {

891 
	mos_comm™_Ï‹ncy_ns
 +ğ
o
.
os_comm™_Ï‹ncy_ns
;

892 
	mos_­¶y_Ï‹ncy_ns
 +ğ
o
.
os_­¶y_Ï‹ncy_ns
;

894 
sub
(cÚ¡ 
objeù¡Üe_³rf_¡©_t
 &
o
) {

895 
	mos_comm™_Ï‹ncy_ns
 -ğ
o
.
os_comm™_Ï‹ncy_ns
;

896 
	mos_­¶y_Ï‹ncy_ns
 -ğ
o
.
os_­¶y_Ï‹ncy_ns
;

898 
dump
(
FÜm©‹r
 *
f
) const;

899 
’code
(
bufã¾i¡
 &
bl
, 
ušt64_t
 
ã©u»s
) const;

900 
decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

901 
g’”©e_‹¡_š¡ªûs
(
¡d
::
li¡
<
objeù¡Üe_³rf_¡©_t
*>& 
o
);

903 
	$WRITE_CLASS_ENCODER_FEATURES
(
objeù¡Üe_³rf_¡©_t
)

908 
	sosd_¡©_t
 {

909 
št64_t
 
kb
, 
kb_u£d
, 
kb_ava
;

910 
veùÜ
<> 
hb_³”s
;

911 
št32_t
 
¢­_Œim_queue_Ën
, 
num_¢­_Œimmšg
;

913 
pow2_hi¡_t
 
İ_queue_age_hi¡
;

915 
objeù¡Üe_³rf_¡©_t
 
os_³rf_¡©
;

917 
•och_t
 
up_äom
 = 0;

918 
ušt64_t
 
£q
 = 0;

920 
ušt32_t
 
num_pgs
 = 0;

922 
	`osd_¡©_t
(è: 
	`kb
(0), 
	`kb_u£d
(0), 
	`kb_ava
(0),

923 
	`¢­_Œim_queue_Ën
(0), 
	`num_¢­_Œimmšg
(0) {}

925 
	`add
(cÚ¡ 
osd_¡©_t
& 
o
) {

926 
kb
 +ğ
o
.kb;

927 
kb_u£d
 +ğ
o
.kb_used;

928 
kb_ava
 +ğ
o
.kb_avail;

929 
¢­_Œim_queue_Ën
 +ğ
o
.snap_trim_queue_len;

930 
num_¢­_Œimmšg
 +ğ
o
.num_snap_trimming;

931 
İ_queue_age_hi¡
.
	`add
(
o
.op_queue_age_hist);

932 
os_³rf_¡©
.
	`add
(
o
.os_perf_stat);

933 
num_pgs
 +ğ
o
.num_pgs;

935 
	`sub
(cÚ¡ 
osd_¡©_t
& 
o
) {

936 
kb
 -ğ
o
.kb;

937 
kb_u£d
 -ğ
o
.kb_used;

938 
kb_ava
 -ğ
o
.kb_avail;

939 
¢­_Œim_queue_Ën
 -ğ
o
.snap_trim_queue_len;

940 
num_¢­_Œimmšg
 -ğ
o
.num_snap_trimming;

941 
İ_queue_age_hi¡
.
	`sub
(
o
.op_queue_age_hist);

942 
os_³rf_¡©
.
	`sub
(
o
.os_perf_stat);

943 
num_pgs
 -ğ
o
.num_pgs;

946 
	`dump
(
FÜm©‹r
 *
f
) const;

947 
	`’code
(
bufã¾i¡
 &
bl
, 
ušt64_t
 
ã©u»s
) const;

948 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

949 
	`g’”©e_‹¡_š¡ªûs
(
¡d
::
li¡
<
osd_¡©_t
*>& 
o
);

951 
	$WRITE_CLASS_ENCODER_FEATURES
(
osd_¡©_t
)

953 
šlše
 
boŞ
 
İ”©Ü
==(cÚ¡ 
osd_¡©_t
& 
l
, cÚ¡ osd_¡©_t& 
r
) {

954  
l
.
kb
 =ğ
r
.kb &&

955 
l
.
kb_u£d
 =ğ
r
.kb_used &&

956 
l
.
kb_ava
 =ğ
r
.kb_avail &&

957 
l
.
¢­_Œim_queue_Ën
 =ğ
r
.snap_trim_queue_len &&

958 
l
.
num_¢­_Œimmšg
 =ğ
r
.num_snap_trimming &&

959 
l
.
hb_³”s
 =ğ
r
.hb_peers &&

960 
l
.
İ_queue_age_hi¡
 =ğ
r
.op_queue_age_hist &&

961 
l
.
os_³rf_¡©
 =ğ
r
.os_perf_stat &&

962 
l
.
num_pgs
 =ğ
r
.num_pgs;

963 
	}
}

964 
šlše
 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
osd_¡©_t
& 
l
, cÚ¡ 
	gosd_¡©_t
& 
	gr
) {

965  !(
	gl
 =ğ
r
);

970 
šlše
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gosd_¡©_t
& 
	gs
) {

971  
	gout
 << "osd_¡©(" << 
by‹_u_t
(
s
.
kb_u£d
 << 10) << " used, "

972 << 
by‹_u_t
(
s
.
kb_ava
 << 10) << "‡vail, "

973 << 
by‹_u_t
(
s
.
kb
 << 10) << "otal, "

974 << "³” " << 
	gs
.
	ghb_³”s


975 << " o°hi¡ " << 
	gs
.
	gİ_queue_age_hi¡
.
	gh


983 
	#PG_STATE_CREATING
 (1ULL << 0)

984 
	#PG_STATE_ACTIVE
 (1ULL << 1)

985 
	#PG_STATE_CLEAN
 (1ULL << 2)

986 
	#PG_STATE_DOWN
 (1ULL << 4)

987 
	#PG_STATE_RECOVERY_UNFOUND
 (1ULL << 5)

988 
	#PG_STATE_BACKFILL_UNFOUND
 (1ULL << 6)

990 
	#PG_STATE_SCRUBBING
 (1ULL << 8)

992 
	#PG_STATE_DEGRADED
 (1ULL << 10)

993 
	#PG_STATE_INCONSISTENT
 (1ULL << 11)

994 
	#PG_STATE_PEERING
 (1ULL << 12)

995 
	#PG_STATE_REPAIR
 (1ULL << 13)

996 
	#PG_STATE_RECOVERING
 (1ULL << 14)

997 
	#PG_STATE_BACKFILL_WAIT
 (1ULL << 15)

998 
	#PG_STATE_INCOMPLETE
 (1ULL << 16)

999 
	#PG_STATE_STALE
 (1ULL << 17)

1000 
	#PG_STATE_REMAPPED
 (1ULL << 18)

1001 
	#PG_STATE_DEEP_SCRUB
 (1ULL << 19)

1002 
	#PG_STATE_BACKFILLING
 (1ULL << 20)

1003 
	#PG_STATE_BACKFILL_TOOFULL
 (1ULL << 21)

1004 
	#PG_STATE_RECOVERY_WAIT
 (1ULL << 22)

1005 
	#PG_STATE_UNDERSIZED
 (1ULL << 23)

1006 
	#PG_STATE_ACTIVATING
 (1ULL << 24)

1007 
	#PG_STATE_PEERED
 (1ULL << 25)

1008 
	#PG_STATE_SNAPTRIM
 (1ULL << 26)

1009 
	#PG_STATE_SNAPTRIM_WAIT
 (1ULL << 27)

1010 
	#PG_STATE_RECOVERY_TOOFULL
 (1ULL << 28)

1011 
	#PG_STATE_SNAPTRIM_ERROR
 (1ULL << 29)

1012 
	#PG_STATE_FORCED_RECOVERY
 (1ULL << 30)

1013 
	#PG_STATE_FORCED_BACKFILL
 (1ULL << 31)

1014 

	)

1015 
	g¡d
::
¡ršg
 
pg_¡©e_¡ršg
(
ušt64_t
 
¡©e
);

1016 
	g¡d
::
¡ršg
 
pg_veùÜ_¡ršg
(cÚ¡ 
veùÜ
<
št32_t
> &
a
);

1017 
	gboo¡
::
İtiÚ®
<
ušt64_t
> 
pg_¡ršg_¡©e
(cÚ¡ 
¡d
::
¡ršg
& 
¡©e
);

1025 
	spoŞ_¢­_šfo_t
 {

1026 
¢­id_t
 
	m¢­id
;

1027 
utime_t
 
	m¡amp
;

1028 
¡ršg
 
	mÇme
;

1030 
dump
(
FÜm©‹r
 *
f
) const;

1031 
’code
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
) const;

1032 
decode
(
bufã¾i¡
::
™”©Ü
& 
bl
);

1033 
g’”©e_‹¡_š¡ªûs
(
li¡
<
poŞ_¢­_šfo_t
*>& 
o
);

1035 
	$WRITE_CLASS_ENCODER_FEATURES
(
poŞ_¢­_šfo_t
)

1037 
šlše
 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
poŞ_¢­_šfo_t
& 
si
) {

1038  
out
 << 
si
.
¢­id
 << '(' << si.
Çme
 << ' ' << si.
¡amp
 << ')';

1039 
	}
}

1048 şas 
	cpoŞ_İts_t
 {

1049 
	mpublic
:

1050 
	ekey_t
 {

1051 
SCRUB_MIN_INTERVAL
,

1052 
	mSCRUB_MAX_INTERVAL
,

1053 
	mDEEP_SCRUB_INTERVAL
,

1054 
	mRECOVERY_PRIORITY
,

1055 
	mRECOVERY_OP_PRIORITY
,

1056 
	mSCRUB_PRIORITY
,

1057 
	mCOMPRESSION_MODE
,

1058 
	mCOMPRESSION_ALGORITHM
,

1059 
	mCOMPRESSION_REQUIRED_RATIO
,

1060 
	mCOMPRESSION_MAX_BLOB_SIZE
,

1061 
	mCOMPRESSION_MIN_BLOB_SIZE
,

1062 
	mCSUM_TYPE
,

1063 
	mCSUM_MAX_BLOCK
,

1064 
	mCSUM_MIN_BLOCK
,

1067 
	ety³_t
 {

1068 
	gSTR
,

1069 
	gINT
,

1070 
	gDOUBLE
,

1073 
	sİt_desc_t
 {

1074 
key_t
 
	gkey
;

1075 
ty³_t
 
	gty³
;

1077 
İt_desc_t
(
key_t
 
k
, 
ty³_t
 
t
è: 
key
(k), 
ty³
(t) {}

1079 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
İt_desc_t
& 
rhs
) const {

1080  
key
 =ğ
rhs
.key && 
ty³
 ==„hs.type;

1084 
	gboo¡
::
	tv¬ŸÁ
<
	t¡d
::
	t¡ršg
,,> 
	tv®ue_t
;

1086 
boŞ
 
is_İt_Çme
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
);

1087 
İt_desc_t
 
g‘_İt_desc
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
);

1089 
	$poŞ_İts_t
(è: 
	$İts
(è{
	}
}

1091 
boŞ
 
	$is_£t
(
key_t
 
key
) const;

1093 
‹m¶©e
<
ty³Çme
 
T
>

1094 
	$£t
(
key_t
 
key
, cÚ¡ 
T
 &
v®
) {

1095 
v®ue_t
 
v®ue
 = 
v®
;

1096 
İts
[
key
] = 
v®ue
;

1097 
	}
}

1099 
	g‹m¶©e
<
ty³Çme
 
	gT
>

1100 
boŞ
 
	$g‘
(
key_t
 
key
, 
T
 *
v®
) const {

1101 
İts_t
::
cÚ¡_™”©Ü
 
i
 = 
İts
.
	`fšd
(
key
);

1102 ià(
i
 =ğ
İts
.
	`’d
()) {

1103  
çl£
;

1105 *
v®
 = 
boo¡
::
g‘
<
T
>(
i
->
£cÚd
);

1106  
Œue
;

1107 
	}
}

1109 cÚ¡ 
	gv®ue_t
& 
	$g‘
(
key_t
 
key
) const;

1111 
boŞ
 
	`un£t
(
key_t
 
key
);

1113 
	$dump
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, 
FÜm©‹r
 *
f
) const;

1115 
	$dump
(
FÜm©‹r
 *
f
) const;

1116 
	$’code
(
bufã¾i¡
 &
bl
) const;

1117 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

1119 
´iv©e
:

1120 
¡d
::
	tm­
<
	tkey_t
, 
	tv®ue_t
> 
	tİts_t
;

1121 
İts_t
 
İts
;

1123 
ä›nd
 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
poŞ_İts_t
& 
İts
);

1124 
	}
};

1125 
	$WRITE_CLASS_ENCODER
(
poŞ_İts_t
)

1130 
	spg_poŞ_t
 {

1131 cÚ¡ *
APPLICATION_NAME_CEPHFS
;

1132 cÚ¡ *
APPLICATION_NAME_RBD
;

1133 cÚ¡ *
APPLICATION_NAME_RGW
;

1136 
TYPE_REPLICATED
 = 1,

1138 
TYPE_ERASURE
 = 3,

1140 cÚ¡ *
	`g‘_ty³_Çme
(
t
) {

1141 
t
) {

1142 
TYPE_REPLICATED
:  "replicated";

1144 
TYPE_ERASURE
:  "erasure";

1148 cÚ¡ *
	`g‘_ty³_Çme
() const {

1149  
	`g‘_ty³_Çme
(
ty³
);

1153 
FLAG_HASHPSPOOL
 = 1<<0,

1154 
FLAG_FULL
 = 1<<1,

1155 
FLAG_EC_OVERWRITES
 = 1<<2,

1156 
FLAG_INCOMPLETE_CLONES
 = 1<<3,

1157 
FLAG_NODELETE
 = 1<<4,

1158 
FLAG_NOPGCHANGE
 = 1<<5,

1159 
FLAG_NOSIZECHANGE
 = 1<<6,

1160 
FLAG_WRITE_FADVISE_DONTNEED
 = 1<<7,

1161 
FLAG_NOSCRUB
 = 1<<8,

1162 
FLAG_NODEEP_SCRUB
 = 1<<9,

1163 
FLAG_FULL_QUOTA
 = 1<<10,

1164 
FLAG_NEARFULL
 = 1<<11,

1165 
FLAG_BACKFILLFULL
 = 1<<12,

1166 
FLAG_SELFMANAGED_SNAPS
 = 1<<13,

1167 
FLAG_POOL_SNAPS
 = 1<<14,

1170 cÚ¡ *
	`g‘_æag_Çme
(
f
) {

1171 
f
) {

1172 
FLAG_HASHPSPOOL
:  "hashpspool";

1173 
FLAG_FULL
:  "full";

1174 
FLAG_EC_OVERWRITES
:  "ec_overwrites";

1175 
FLAG_INCOMPLETE_CLONES
:  "incomplete_clones";

1176 
FLAG_NODELETE
:  "nodelete";

1177 
FLAG_NOPGCHANGE
:  "nopgchange";

1178 
FLAG_NOSIZECHANGE
:  "nosizechange";

1179 
FLAG_WRITE_FADVISE_DONTNEED
:  "write_fadvise_dontneed";

1180 
FLAG_NOSCRUB
:  "noscrub";

1181 
FLAG_NODEEP_SCRUB
:  "nodeep-scrub";

1182 
FLAG_FULL_QUOTA
:  "full_quota";

1183 
FLAG_NEARFULL
:  "nearfull";

1184 
FLAG_BACKFILLFULL
:  "backfillfull";

1185 
FLAG_SELFMANAGED_SNAPS
:  "selfmanaged_snaps";

1186 
FLAG_POOL_SNAPS
:  "pool_snaps";

1190 
¡ršg
 
	`g‘_æags_¡ršg
(
ušt64_t
 
f
) {

1191 
¡ršg
 
s
;

1192 
n
=0; 
f
 &&‚<64; ++n) {

1193 ià(
f
 & (1uÎ << 
n
)) {

1194 ià(
s
.
	`Ëngth
())

1195 
s
 += ",";

1196 
s
 +ğ
	`g‘_æag_Çme
(1uÎ << 
n
);

1199  
s
;

1201 
¡ršg
 
	`g‘_æags_¡ršg
() const {

1202  
	`g‘_æags_¡ršg
(
æags
);

1204 
ušt64_t
 
	`g‘_æag_by_Çme
(cÚ¡ 
¡ršg
& 
Çme
) {

1205 ià(
Çme
 == "hashpspool")

1206  
FLAG_HASHPSPOOL
;

1207 ià(
Çme
 == "full")

1208  
FLAG_FULL
;

1209 ià(
Çme
 == "ec_overwrites")

1210  
FLAG_EC_OVERWRITES
;

1211 ià(
Çme
 == "incomplete_clones")

1212  
FLAG_INCOMPLETE_CLONES
;

1213 ià(
Çme
 == "nodelete")

1214  
FLAG_NODELETE
;

1215 ià(
Çme
 == "nopgchange")

1216  
FLAG_NOPGCHANGE
;

1217 ià(
Çme
 == "nosizechange")

1218  
FLAG_NOSIZECHANGE
;

1219 ià(
Çme
 == "write_fadvise_dontneed")

1220  
FLAG_WRITE_FADVISE_DONTNEED
;

1221 ià(
Çme
 == "noscrub")

1222  
FLAG_NOSCRUB
;

1223 ià(
Çme
 == "nodeep-scrub")

1224  
FLAG_NODEEP_SCRUB
;

1225 ià(
Çme
 == "full_quota")

1226  
FLAG_FULL_QUOTA
;

1227 ià(
Çme
 == "nearfull")

1228  
FLAG_NEARFULL
;

1229 ià(
Çme
 == "backfillfull")

1230  
FLAG_BACKFILLFULL
;

1231 ià(
Çme
 == "selfmanaged_snaps")

1232  
FLAG_SELFMANAGED_SNAPS
;

1233 ià(
Çme
 == "pool_snaps")

1234  
FLAG_POOL_SNAPS
;

1239 
	`cÚv”t_to_pg_sh¬ds
(cÚ¡ 
veùÜ
<> &
äom
, 
£t
<
pg_sh¬d_t
>* 
to
) const;

1242 
CACHEMODE_NONE
 = 0,

1243 
CACHEMODE_WRITEBACK
 = 1,

1244 
CACHEMODE_FORWARD
 = 2,

1245 
CACHEMODE_READONLY
 = 3,

1246 
CACHEMODE_READFORWARD
 = 4,

1247 
CACHEMODE_READPROXY
 = 5,

1248 
CACHEMODE_PROXY
 = 6,

1249 } 
	tÿche_mode_t
;

1250 cÚ¡ *
	`g‘_ÿche_mode_Çme
(
ÿche_mode_t
 
m
) {

1251 
m
) {

1252 
CACHEMODE_NONE
:  "none";

1253 
CACHEMODE_WRITEBACK
:  "writeback";

1254 
CACHEMODE_FORWARD
:  "forward";

1255 
CACHEMODE_READONLY
:  "readonly";

1256 
CACHEMODE_READFORWARD
:  "readforward";

1257 
CACHEMODE_READPROXY
:  "readproxy";

1258 
CACHEMODE_PROXY
:  "proxy";

1262 
ÿche_mode_t
 
	`g‘_ÿche_mode_äom_¡r
(cÚ¡ 
¡ršg
& 
s
) {

1263 ià(
s
 == "none")

1264  
CACHEMODE_NONE
;

1265 ià(
s
 == "writeback")

1266  
CACHEMODE_WRITEBACK
;

1267 ià(
s
 == "forward")

1268  
CACHEMODE_FORWARD
;

1269 ià(
s
 == "readonly")

1270  
CACHEMODE_READONLY
;

1271 ià(
s
 == "readforward")

1272  
CACHEMODE_READFORWARD
;

1273 ià(
s
 == "readproxy")

1274  
CACHEMODE_READPROXY
;

1275 ià(
s
 == "proxy")

1276  
CACHEMODE_PROXY
;

1277  (
ÿche_mode_t
)-1;

1279 cÚ¡ *
	`g‘_ÿche_mode_Çme
() const {

1280  
	`g‘_ÿche_mode_Çme
(
ÿche_mode
);

1282 
boŞ
 
	`ÿche_mode_»quœes_h™_£t
() const {

1283 
ÿche_mode
) {

1284 
CACHEMODE_NONE
:

1285 
CACHEMODE_FORWARD
:

1286 
CACHEMODE_READONLY
:

1287 
CACHEMODE_PROXY
:

1288  
çl£
;

1289 
CACHEMODE_WRITEBACK
:

1290 
CACHEMODE_READFORWARD
:

1291 
CACHEMODE_READPROXY
:

1292  
Œue
;

1294 
	`as£¹
(0 == "implement me");

1298 
utime_t
 
ü—‹_time
;

1299 
ušt64_t
 
æags
;

1300 
__u8
 
ty³
;

1301 
__u8
 
size
, 
mš_size
;

1302 
__u8
 
üush_ruË
;

1303 
__u8
 
objeù_hash
;

1304 
´iv©e
:

1305 
__u32
 
pg_num
, 
pgp_num
;

1308 
public
:

1309 
m­
<
¡ršg
,¡ršg> 
´İ”t›s
;

1310 
¡ršg
 
”asu»_code_´ofe
;

1311 
•och_t
 
Ï¡_chªge
;

1312 
•och_t
 
Ï¡_fÜû_İ_»£nd
;

1314 
•och_t
 
Ï¡_fÜû_İ_»£nd_´–umšous
;

1315 
¢­id_t
 
¢­_£q
;

1316 
•och_t
 
¢­_•och
;

1317 
ušt64_t
 
auid
;

1319 
ušt64_t
 
quÙa_max_by‹s
;

1320 
ušt64_t
 
quÙa_max_objeùs
;

1327 
m­
<
¢­id_t
, 
poŞ_¢­_šfo_t
> 
¢­s
;

1334 
š‹rv®_£t
<
¢­id_t
> 
»moved_¢­s
;

1336 
pg_num_mask
, 
pgp_num_mask
;

1338 
£t
<
ušt64_t
> 
t›rs
;

1339 
št64_t
 
t›r_of
;

1341 
št64_t
 
»ad_t›r
;

1342 
št64_t
 
wr™e_t›r
;

1343 
ÿche_mode_t
 
ÿche_mode
;

1345 
boŞ
 
	`is_t›r
(ècÚ¡ {  
t›r_of
 >= 0; }

1346 
boŞ
 
	`has_t›rs
(ècÚ¡ {  !
t›rs
.
	`em±y
(); }

1347 
	`ş—r_t›r
() {

1348 
t›r_of
 = -1;

1349 
	`ş—r_»ad_t›r
();

1350 
	`ş—r_wr™e_t›r
();

1351 
	`ş—r_t›r_tuÇbËs
();

1353 
boŞ
 
	`has_»ad_t›r
(ècÚ¡ {  
»ad_t›r
 >= 0; }

1354 
	`ş—r_»ad_t›r
(è{ 
»ad_t›r
 = -1; }

1355 
boŞ
 
	`has_wr™e_t›r
(ècÚ¡ {  
wr™e_t›r
 >= 0; }

1356 
	`ş—r_wr™e_t›r
(è{ 
wr™e_t›r
 = -1; }

1357 
	`ş—r_t›r_tuÇbËs
() {

1358 ià(
ÿche_mode
 !ğ
CACHEMODE_NONE
)

1359 
æags
 |ğ
FLAG_INCOMPLETE_CLONES
;

1360 
ÿche_mode
 = 
CACHEMODE_NONE
;

1362 
rg‘_max_by‹s
 = 0;

1363 
rg‘_max_objeùs
 = 0;

1364 
ÿche_rg‘_dœty_¿tio_miüo
 = 0;

1365 
ÿche_rg‘_dœty_high_¿tio_miüo
 = 0;

1366 
ÿche_rg‘_fuÎ_¿tio_miüo
 = 0;

1367 
h™_£t_·¿ms
 = 
H™S‘
::
	`P¬ams
();

1368 
h™_£t_³riod
 = 0;

1369 
h™_£t_couÁ
 = 0;

1370 
h™_£t_g¿de_deÿy_¿‹
 = 0;

1371 
h™_£t_£¬ch_Ï¡_n
 = 0;

1372 
g¿de_bË
.
	`»size
(0);

1375 
ušt64_t
 
rg‘_max_by‹s
;

1376 
ušt64_t
 
rg‘_max_objeùs
;

1378 
ušt32_t
 
ÿche_rg‘_dœty_¿tio_miüo
;

1379 
ušt32_t
 
ÿche_rg‘_dœty_high_¿tio_miüo
;

1380 
ušt32_t
 
ÿche_rg‘_fuÎ_¿tio_miüo
;

1382 
ušt32_t
 
ÿche_mš_æush_age
;

1383 
ušt32_t
 
ÿche_mš_eviù_age
;

1385 
H™S‘
::
P¬ams
 
h™_£t_·¿ms
;

1386 
ušt32_t
 
h™_£t_³riod
;

1387 
ušt32_t
 
h™_£t_couÁ
;

1388 
boŞ
 
u£_gmt_h™£t
;

1389 
ušt32_t
 
mš_»ad_»ûncy_fÜ_´omÙe
;

1390 
ušt32_t
 
mš_wr™e_»ûncy_fÜ_´omÙe
;

1391 
ušt32_t
 
h™_£t_g¿de_deÿy_¿‹
;

1394 
ušt32_t
 
h™_£t_£¬ch_Ï¡_n
;

1396 
ušt32_t
 
¡re_width
;

1398 
ušt64_t
 
ex³ùed_num_objeùs
;

1400 
boŞ
 
ç¡_»ad
;

1402 
poŞ_İts_t
 
İts
;

1405 
m­
<
¡ršg
, 
¡d
::m­<¡ršg, sŒšg>> 
­¶iÿtiÚ_m‘ad©a
;

1407 
´iv©e
:

1408 
veùÜ
<
ušt32_t
> 
g¿de_bË
;

1410 
public
:

1411 
ušt32_t
 
	`g‘_g¿de
(
i
) const {

1412 ià(
g¿de_bË
.
	`size
(è<ğ
i
)

1414  
g¿de_bË
[
i
];

1416 
	`ÿlc_g¿de_bË
() {

1417 
v
 = 1000000;

1418 
g¿de_bË
.
	`»size
(
h™_£t_couÁ
);

1419 
i
 = 0; i < 
h™_£t_couÁ
; i++) {

1420 
v
 = v * (1 - (
h™_£t_g¿de_deÿy_¿‹
 / 100.0));

1421 
g¿de_bË
[
i
] = 
v
;

1425 
	`pg_poŞ_t
()

1426 : 
	`æags
(0), 
	`ty³
(0), 
	`size
(0), 
	`mš_size
(0),

1427 
	`üush_ruË
(0), 
	`objeù_hash
(0),

1428 
	`pg_num
(0), 
	`pgp_num
(0),

1429 
	`Ï¡_chªge
(0),

1430 
	`Ï¡_fÜû_İ_»£nd
(0),

1431 
	`Ï¡_fÜû_İ_»£nd_´–umšous
(0),

1432 
	`¢­_£q
(0), 
	`¢­_•och
(0),

1433 
	`auid
(0),

1434 
	`quÙa_max_by‹s
(0), 
	`quÙa_max_objeùs
(0),

1435 
	`pg_num_mask
(0), 
	`pgp_num_mask
(0),

1436 
	`t›r_of
(-1), 
	`»ad_t›r
(-1), 
	`wr™e_t›r
(-1),

1437 
	`ÿche_mode
(
CACHEMODE_NONE
),

1438 
	`rg‘_max_by‹s
(0), 
	`rg‘_max_objeùs
(0),

1439 
	`ÿche_rg‘_dœty_¿tio_miüo
(0),

1440 
	`ÿche_rg‘_dœty_high_¿tio_miüo
(0),

1441 
	`ÿche_rg‘_fuÎ_¿tio_miüo
(0),

1442 
	`ÿche_mš_æush_age
(0),

1443 
	`ÿche_mš_eviù_age
(0),

1444 
	`h™_£t_·¿ms
(),

1445 
	`h™_£t_³riod
(0),

1446 
	`h™_£t_couÁ
(0),

1447 
	`u£_gmt_h™£t
(
Œue
),

1448 
	`mš_»ad_»ûncy_fÜ_´omÙe
(0),

1449 
	`mš_wr™e_»ûncy_fÜ_´omÙe
(0),

1450 
	`h™_£t_g¿de_deÿy_¿‹
(0),

1451 
	`h™_£t_£¬ch_Ï¡_n
(0),

1452 
	`¡re_width
(0),

1453 
	`ex³ùed_num_objeùs
(0),

1454 
	`ç¡_»ad
(
çl£
),

1455 
	`İts
()

1458 
	`dump
(
FÜm©‹r
 *
f
) const;

1460 cÚ¡ 
utime_t
 &
	`g‘_ü—‹_time
(ècÚ¡ {  
ü—‹_time
; }

1461 
ušt64_t
 
	`g‘_æags
(ècÚ¡ {  
æags
; }

1462 
boŞ
 
	`has_æag
(
ušt64_t
 
f
ècÚ¡ {  
æags
 & f; }

1463 
	`£t_æag
(
ušt64_t
 
f
è{ 
æags
 |= f; }

1464 
	`un£t_æag
(
ušt64_t
 
f
è{ 
æags
 &= ~f; }

1466 
boŞ
 
	`»quœe_rŞlback
() const {

1467  
	`is_”asu»
();

1471 
boŞ
 
	`®low_šcom¶‘e_şÚes
() const {

1472  
ÿche_mode
 !ğ
CACHEMODE_NONE
 || 
	`has_æag
(
FLAG_INCOMPLETE_CLONES
);

1475 
	`g‘_ty³
(ècÚ¡ {  
ty³
; }

1476 
	`g‘_size
(ècÚ¡ {  
size
; }

1477 
	`g‘_mš_size
(ècÚ¡ {  
mš_size
; }

1478 
	`g‘_üush_ruË
(ècÚ¡ {  
üush_ruË
; }

1479 
	`g‘_objeù_hash
(ècÚ¡ {  
objeù_hash
; }

1480 cÚ¡ *
	`g‘_objeù_hash_Çme
() const {

1481  
	`ûph_¡r_hash_Çme
(
	`g‘_objeù_hash
());

1483 
•och_t
 
	`g‘_Ï¡_chªge
(ècÚ¡ {  
Ï¡_chªge
; }

1484 
•och_t
 
	`g‘_Ï¡_fÜû_İ_»£nd
(ècÚ¡ {  
Ï¡_fÜû_İ_»£nd
; }

1485 
•och_t
 
	`g‘_Ï¡_fÜû_İ_»£nd_´–umšous
() const {

1486  
Ï¡_fÜû_İ_»£nd_´–umšous
;

1488 
•och_t
 
	`g‘_¢­_•och
(ècÚ¡ {  
¢­_•och
; }

1489 
¢­id_t
 
	`g‘_¢­_£q
(ècÚ¡ {  
¢­_£q
; }

1490 
ušt64_t
 
	`g‘_auid
(ècÚ¡ {  
auid
; }

1492 
	`£t_¢­_£q
(
¢­id_t
 
s
è{ 
¢­_£q
 = s; }

1493 
	`£t_¢­_•och
(
•och_t
 
e
è{ 
¢­_•och
 =ƒ; }

1495 
	`£t_¡re_width
(
ušt32_t
 
s
è{ 
¡re_width
 = s; }

1496 
ušt32_t
 
	`g‘_¡re_width
(ècÚ¡ {  
¡re_width
; }

1498 
boŞ
 
	`is_»¶iÿ‹d
(ècÚ¡ {  
	`g‘_ty³
(è=ğ
TYPE_REPLICATED
; }

1499 
boŞ
 
	`is_”asu»
(ècÚ¡ {  
	`g‘_ty³
(è=ğ
TYPE_ERASURE
; }

1501 
boŞ
 
	`suµÜts_om­
() const {

1502  !(
	`g‘_ty³
(è=ğ
TYPE_ERASURE
);

1505 
boŞ
 
	`»quœes_®igÃd_­³nd
() const {

1506  
	`is_”asu»
(è&& !
	`has_æag
(
FLAG_EC_OVERWRITES
);

1508 
ušt64_t
 
	`»quœed_®ignm’t
(ècÚ¡ {  
¡re_width
; }

1510 
boŞ
 
	`®lows_ecov”wr™es
() const {

1511  
	`has_æag
(
FLAG_EC_OVERWRITES
);

1514 
boŞ
 
	`ÿn_shiá_osds
() const {

1515 
	`g‘_ty³
()) {

1516 
TYPE_REPLICATED
:

1517  
Œue
;

1518 
TYPE_ERASURE
:

1519  
çl£
;

1521 
	`as£¹
(0 == "unhandled…oolype");

1525 
	`g‘_pg_num
(ècÚ¡ {  
pg_num
; }

1526 
	`g‘_pgp_num
(ècÚ¡ {  
pgp_num
; }

1528 
	`g‘_pg_num_mask
(ècÚ¡ {  
pg_num_mask
; }

1529 
	`g‘_pgp_num_mask
(ècÚ¡ {  
pgp_num_mask
; }

1534 
	`g‘_pg_num_divisÜ
(
pg_t
 
pgid
) const;

1536 
	`£t_pg_num
(
p
) {

1537 
pg_num
 = 
p
;

1538 
	`ÿlc_pg_masks
();

1540 
	`£t_pgp_num
(
p
) {

1541 
pgp_num
 = 
p
;

1542 
	`ÿlc_pg_masks
();

1545 
	`£t_quÙa_max_by‹s
(
ušt64_t
 
m
) {

1546 
quÙa_max_by‹s
 = 
m
;

1548 
ušt64_t
 
	`g‘_quÙa_max_by‹s
() {

1549  
quÙa_max_by‹s
;

1552 
	`£t_quÙa_max_objeùs
(
ušt64_t
 
m
) {

1553 
quÙa_max_objeùs
 = 
m
;

1555 
ušt64_t
 
	`g‘_quÙa_max_objeùs
() {

1556  
quÙa_max_objeùs
;

1559 
	`£t_Ï¡_fÜû_İ_»£nd
(
ušt64_t
 
t
) {

1560 
Ï¡_fÜû_İ_»£nd
 = 
t
;

1561 
Ï¡_fÜû_İ_»£nd_´–umšous
 = 
t
;

1564 
	`ÿlc_pg_masks
();

1576 
boŞ
 
	`is_poŞ_¢­s_mode
() const;

1577 
boŞ
 
	`is_unmªaged_¢­s_mode
() const;

1578 
boŞ
 
	`is_»moved_¢­
(
¢­id_t
 
s
) const;

1584 
	`bud_»moved_¢­s
(
š‹rv®_£t
<
¢­id_t
>& 
rs
) const;

1585 
boŞ
 
	`maybe_upd©ed_»moved_¢­s
(cÚ¡ 
š‹rv®_£t
<
¢­id_t
>& 
ÿched
) const;

1586 
¢­id_t
 
	`¢­_exi¡s
(cÚ¡ *
s
) const;

1587 
	`add_¢­
(cÚ¡ *
n
, 
utime_t
 
¡amp
);

1588 
	`add_unmªaged_¢­
(
ušt64_t
& 
¢­id
);

1589 
	`»move_¢­
(
¢­id_t
 
s
);

1590 
	`»move_unmªaged_¢­
(
¢­id_t
 
s
);

1592 
SÇpCÚ‹xt
 
	`g‘_¢­_cÚ‹xt
() const;

1595 
ušt32_t
 
	`hash_key
(cÚ¡ 
¡ršg
& 
key
, cÚ¡ sŒšg& 
ns
) const;

1598 
ušt32_t
 
	`¿w_hash_to_pg
(ušt32_ˆ
v
) const;

1603 
pg_t
 
	`¿w_pg_to_pg
Õg_ˆ
pg
) const;

1610 
ps_t
 
	`¿w_pg_to_µs
(
pg_t
 
pg
) const;

1613 
ušt32_t
 
	`g‘_¿ndom_pg_pos™iÚ
(
pg_t
 
pgid
, ušt32_ˆ
£ed
) const;

1615 
	`’code
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
) const;

1616 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
bl
);

1618 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_poŞ_t
*>& 
o
);

1620 
	$WRITE_CLASS_ENCODER_FEATURES
(
pg_poŞ_t
)

1622 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
pg_poŞ_t
& 
p
);

1635 
	sobjeù_¡©_sum_t
 {

1640 
št64_t
 
num_by‹s
;

1641 
št64_t
 
num_objeùs
;

1642 
št64_t
 
num_objeù_şÚes
;

1643 
št64_t
 
num_objeù_cİ›s
;

1644 
št64_t
 
num_objeùs_missšg_Ú_´im¬y
;

1645 
št64_t
 
num_objeùs_deg¿ded
;

1646 
št64_t
 
num_objeùs_unfound
;

1647 
št64_t
 
num_rd
;

1648 
št64_t
 
num_rd_kb
;

1649 
št64_t
 
num_wr
;

1650 
št64_t
 
num_wr_kb
;

1651 
št64_t
 
num_süub_”rÜs
;

1652 
št64_t
 
num_objeùs_»cov”ed
;

1653 
št64_t
 
num_by‹s_»cov”ed
;

1654 
št64_t
 
num_keys_»cov”ed
;

1655 
št64_t
 
num_sh®low_süub_”rÜs
;

1656 
št64_t
 
num_d“p_süub_”rÜs
;

1657 
št64_t
 
num_objeùs_dœty
;

1658 
št64_t
 
num_wh™eouts
;

1659 
št64_t
 
num_objeùs_om­
;

1660 
št64_t
 
num_objeùs_h™_£t_¬chive
;

1661 
št64_t
 
num_objeùs_mi¥Ïûd
;

1662 
št64_t
 
num_by‹s_h™_£t_¬chive
;

1663 
št64_t
 
num_æush
;

1664 
št64_t
 
num_æush_kb
;

1665 
št64_t
 
num_eviù
;

1666 
št64_t
 
num_eviù_kb
;

1667 
št64_t
 
num_´omÙe
;

1668 
št32_t
 
num_æush_mode_high
;

1669 
št32_t
 
num_æush_mode_low
;

1670 
št32_t
 
num_eviù_mode_some
;

1671 
št32_t
 
num_eviù_mode_fuÎ
;

1672 
št64_t
 
num_objeùs_pšÃd
;

1673 
št64_t
 
num_objeùs_missšg
;

1674 
št64_t
 
num_Ëgacy_¢­£ts
;

1675 
št64_t
 
num_Ïrge_om­_objeùs
 = 0;

1676 
št64_t
 
num_objeùs_mªiã¡
 = 0;

1678 
	`objeù_¡©_sum_t
()

1679 : 
	`num_by‹s
(0),

1680 
	`num_objeùs
(0), 
	`num_objeù_şÚes
(0), 
	`num_objeù_cİ›s
(0),

1681 
	`num_objeùs_missšg_Ú_´im¬y
(0), 
	`num_objeùs_deg¿ded
(0),

1682 
	`num_objeùs_unfound
(0),

1683 
	`num_rd
(0), 
	`num_rd_kb
(0), 
	`num_wr
(0), 
	`num_wr_kb
(0),

1684 
	`num_süub_”rÜs
(0),

1685 
	`num_objeùs_»cov”ed
(0),

1686 
	`num_by‹s_»cov”ed
(0),

1687 
	`num_keys_»cov”ed
(0),

1688 
	`num_sh®low_süub_”rÜs
(0),

1689 
	`num_d“p_süub_”rÜs
(0),

1690 
	`num_objeùs_dœty
(0),

1691 
	`num_wh™eouts
(0),

1692 
	`num_objeùs_om­
(0),

1693 
	`num_objeùs_h™_£t_¬chive
(0),

1694 
	`num_objeùs_mi¥Ïûd
(0),

1695 
	`num_by‹s_h™_£t_¬chive
(0),

1696 
	`num_æush
(0),

1697 
	`num_æush_kb
(0),

1698 
	`num_eviù
(0),

1699 
	`num_eviù_kb
(0),

1700 
	`num_´omÙe
(0),

1701 
	`num_æush_mode_high
(0), 
	`num_æush_mode_low
(0),

1702 
	`num_eviù_mode_some
(0), 
	`num_eviù_mode_fuÎ
(0),

1703 
	`num_objeùs_pšÃd
(0),

1704 
	`num_objeùs_missšg
(0),

1705 
	`num_Ëgacy_¢­£ts
(0)

1708 
	`æoÜ
(
št64_t
 
f
) {

1709 
	#FLOOR
(
x
èià(x < 
f
èx = 
	)
f

1710 
	`FLOOR
(
num_by‹s
);

1711 
	`FLOOR
(
num_objeùs
);

1712 
	`FLOOR
(
num_objeù_şÚes
);

1713 
	`FLOOR
(
num_objeù_cİ›s
);

1714 
	`FLOOR
(
num_objeùs_missšg_Ú_´im¬y
);

1715 
	`FLOOR
(
num_objeùs_missšg
);

1716 
	`FLOOR
(
num_objeùs_deg¿ded
);

1717 
	`FLOOR
(
num_objeùs_mi¥Ïûd
);

1718 
	`FLOOR
(
num_objeùs_unfound
);

1719 
	`FLOOR
(
num_rd
);

1720 
	`FLOOR
(
num_rd_kb
);

1721 
	`FLOOR
(
num_wr
);

1722 
	`FLOOR
(
num_wr_kb
);

1723 
	`FLOOR
(
num_Ïrge_om­_objeùs
);

1724 
	`FLOOR
(
num_objeùs_mªiã¡
);

1725 
	`FLOOR
(
num_sh®low_süub_”rÜs
);

1726 
	`FLOOR
(
num_d“p_süub_”rÜs
);

1727 
num_süub_”rÜs
 = 
num_sh®low_süub_”rÜs
 + 
num_d“p_süub_”rÜs
;

1728 
	`FLOOR
(
num_objeùs_»cov”ed
);

1729 
	`FLOOR
(
num_by‹s_»cov”ed
);

1730 
	`FLOOR
(
num_keys_»cov”ed
);

1731 
	`FLOOR
(
num_objeùs_dœty
);

1732 
	`FLOOR
(
num_wh™eouts
);

1733 
	`FLOOR
(
num_objeùs_om­
);

1734 
	`FLOOR
(
num_objeùs_h™_£t_¬chive
);

1735 
	`FLOOR
(
num_by‹s_h™_£t_¬chive
);

1736 
	`FLOOR
(
num_æush
);

1737 
	`FLOOR
(
num_æush_kb
);

1738 
	`FLOOR
(
num_eviù
);

1739 
	`FLOOR
(
num_eviù_kb
);

1740 
	`FLOOR
(
num_´omÙe
);

1741 
	`FLOOR
(
num_æush_mode_high
);

1742 
	`FLOOR
(
num_æush_mode_low
);

1743 
	`FLOOR
(
num_eviù_mode_some
);

1744 
	`FLOOR
(
num_eviù_mode_fuÎ
);

1745 
	`FLOOR
(
num_objeùs_pšÃd
);

1746 
	`FLOOR
(
num_Ëgacy_¢­£ts
);

1747 #undeà
FLOOR


1750 
	`¥l™
(
veùÜ
<
objeù_¡©_sum_t
> &
out
) const {

1751 
	#SPLIT
(
PARAM
) \

1752 
i
 = 0; i < 
out
.
	`size
(); ++i) { \

1753 
out
[
i
].
PARAM
 = PARAM / out.
	`size
(); \

1754 ià(
i
 < (
PARAM
 % 
out
.
	`size
())) { \

1755 
out
[
i
].
PARAM
++; \

1757 }

	)

1758 
	#SPLIT_PRESERVE_NONZERO
(
PARAM
) \

1759 
i
 = 0; i < 
out
.
	`size
(); ++i) { \

1760 ià(
PARAM
) \

1761 
out
[
i
].
PARAM
 = 1 + PARAM / out.
	`size
(); \

1763 
out
[
i
].
PARAM
 = 0; \

1764 }

	)

1766 
	`SPLIT
(
num_by‹s
);

1767 
	`SPLIT
(
num_objeùs
);

1768 
	`SPLIT
(
num_objeù_şÚes
);

1769 
	`SPLIT
(
num_objeù_cİ›s
);

1770 
	`SPLIT
(
num_objeùs_missšg_Ú_´im¬y
);

1771 
	`SPLIT
(
num_objeùs_missšg
);

1772 
	`SPLIT
(
num_objeùs_deg¿ded
);

1773 
	`SPLIT
(
num_objeùs_mi¥Ïûd
);

1774 
	`SPLIT
(
num_objeùs_unfound
);

1775 
	`SPLIT
(
num_rd
);

1776 
	`SPLIT
(
num_rd_kb
);

1777 
	`SPLIT
(
num_wr
);

1778 
	`SPLIT
(
num_wr_kb
);

1779 
	`SPLIT
(
num_Ïrge_om­_objeùs
);

1780 
	`SPLIT
(
num_objeùs_mªiã¡
);

1781 
	`SPLIT_PRESERVE_NONZERO
(
num_sh®low_süub_”rÜs
);

1782 
	`SPLIT_PRESERVE_NONZERO
(
num_d“p_süub_”rÜs
);

1783 
i
 = 0; i < 
out
.
	`size
(); ++i) {

1784 
out
[
i
].
num_süub_”rÜs
 = out[i].
num_sh®low_süub_”rÜs
 +

1785 
out
[
i
].
num_d“p_süub_”rÜs
;

1787 
	`SPLIT
(
num_objeùs_»cov”ed
);

1788 
	`SPLIT
(
num_by‹s_»cov”ed
);

1789 
	`SPLIT
(
num_keys_»cov”ed
);

1790 
	`SPLIT
(
num_objeùs_dœty
);

1791 
	`SPLIT
(
num_wh™eouts
);

1792 
	`SPLIT
(
num_objeùs_om­
);

1793 
	`SPLIT
(
num_objeùs_h™_£t_¬chive
);

1794 
	`SPLIT
(
num_by‹s_h™_£t_¬chive
);

1795 
	`SPLIT
(
num_æush
);

1796 
	`SPLIT
(
num_æush_kb
);

1797 
	`SPLIT
(
num_eviù
);

1798 
	`SPLIT
(
num_eviù_kb
);

1799 
	`SPLIT
(
num_´omÙe
);

1800 
	`SPLIT
(
num_æush_mode_high
);

1801 
	`SPLIT
(
num_æush_mode_low
);

1802 
	`SPLIT
(
num_eviù_mode_some
);

1803 
	`SPLIT
(
num_eviù_mode_fuÎ
);

1804 
	`SPLIT
(
num_objeùs_pšÃd
);

1805 
	`SPLIT_PRESERVE_NONZERO
(
num_Ëgacy_¢­£ts
);

1806 #undeà
SPLIT


1807 #undeà
SPLIT_PRESERVE_NONZERO


1810 
	`ş—r
() {

1811 
	`mem£t
(
this
, 0, (*this));

1814 
	`ÿlc_cİ›s
(
Ä•
) {

1815 
num_objeù_cİ›s
 = 
Ä•
 * 
num_objeùs
;

1818 
boŞ
 
	`is_z”o
() const {

1819  
	`mem_is_z”o
((*)
this
, (*this));

1822 
	`add
(cÚ¡ 
objeù_¡©_sum_t
& 
o
);

1823 
	`sub
(cÚ¡ 
objeù_¡©_sum_t
& 
o
);

1825 
	`dump
(
FÜm©‹r
 *
f
) const;

1826 
	`·ddšg_check
() {

1827 
	`¡©ic_as£¹
(

1828 (
objeù_¡©_sum_t
) ==

1829 (
num_by‹s
) +

1830 (
num_objeùs
) +

1831 (
num_objeù_şÚes
) +

1832 (
num_objeù_cİ›s
) +

1833 (
num_objeùs_missšg_Ú_´im¬y
) +

1834 (
num_objeùs_deg¿ded
) +

1835 (
num_objeùs_unfound
) +

1836 (
num_rd
) +

1837 (
num_rd_kb
) +

1838 (
num_wr
) +

1839 (
num_wr_kb
) +

1840 (
num_süub_”rÜs
) +

1841 (
num_Ïrge_om­_objeùs
) +

1842 (
num_objeùs_mªiã¡
) +

1843 (
num_objeùs_»cov”ed
) +

1844 (
num_by‹s_»cov”ed
) +

1845 (
num_keys_»cov”ed
) +

1846 (
num_sh®low_süub_”rÜs
) +

1847 (
num_d“p_süub_”rÜs
) +

1848 (
num_objeùs_dœty
) +

1849 (
num_wh™eouts
) +

1850 (
num_objeùs_om­
) +

1851 (
num_objeùs_h™_£t_¬chive
) +

1852 (
num_objeùs_mi¥Ïûd
) +

1853 (
num_by‹s_h™_£t_¬chive
) +

1854 (
num_æush
) +

1855 (
num_æush_kb
) +

1856 (
num_eviù
) +

1857 (
num_eviù_kb
) +

1858 (
num_´omÙe
) +

1859 (
num_æush_mode_high
) +

1860 (
num_æush_mode_low
) +

1861 (
num_eviù_mode_some
) +

1862 (
num_eviù_mode_fuÎ
) +

1863 (
num_objeùs_pšÃd
) +

1864 (
num_objeùs_missšg
) +

1865 (
num_Ëgacy_¢­£ts
)

1869 
	`’code
(
bufã¾i¡
& 
bl
) const;

1870 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
bl
);

1871 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
objeù_¡©_sum_t
*>& 
o
);

1873 
	$WRITE_CLASS_ENCODER
(
objeù_¡©_sum_t
)

1875 
boŞ
 
İ”©Ü
==(cÚ¡ 
objeù_¡©_sum_t
& 
l
, cÚ¡ objeù_¡©_sum_t& 
r
);

1882 
	sobjeù_¡©_cŞËùiÚ_t
 {

1886 
objeù_¡©_sum_t
 
sum
;

1888 
	`ÿlc_cİ›s
(
Ä•
) {

1889 
sum
.
	`ÿlc_cİ›s
(
Ä•
);

1892 
	`dump
(
FÜm©‹r
 *
f
) const;

1893 
	`’code
(
bufã¾i¡
& 
bl
) const;

1894 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
bl
);

1895 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
objeù_¡©_cŞËùiÚ_t
*>& 
o
);

1897 
boŞ
 
	`is_z”o
() const {

1898  
sum
.
	`is_z”o
();

1901 
	`ş—r
() {

1902 
sum
.
	`ş—r
();

1905 
	`æoÜ
(
št64_t
 
f
) {

1906 
sum
.
	`æoÜ
(
f
);

1909 
	`add
(cÚ¡ 
objeù_¡©_sum_t
& 
o
) {

1910 
sum
.
	`add
(
o
);

1913 
	`add
(cÚ¡ 
objeù_¡©_cŞËùiÚ_t
& 
o
) {

1914 
sum
.
	`add
(
o
.sum);

1916 
	`sub
(cÚ¡ 
objeù_¡©_cŞËùiÚ_t
& 
o
) {

1917 
sum
.
	`sub
(
o
.sum);

1920 
	$WRITE_CLASS_ENCODER
(
objeù_¡©_cŞËùiÚ_t
)

1922 
šlše
 
boŞ
 
İ”©Ü
==(cÚ¡ 
objeù_¡©_cŞËùiÚ_t
& 
l
,

1923 cÚ¡ 
objeù_¡©_cŞËùiÚ_t
& 
r
) {

1924  
l
.
sum
 =ğ
r
.sum;

1925 
	}
}

1931 
	spg_¡©_t
 {

1935 
ev”siÚ_t
 
	mv”siÚ
;

1936 
v”siÚ_t
 
	m»pÜ‹d_£q
;

1937 
•och_t
 
	m»pÜ‹d_•och
;

1938 
ušt64_t
 
	m¡©e
;

1939 
utime_t
 
	mÏ¡_äesh
;

1940 
utime_t
 
	mÏ¡_chªge
;

1941 
utime_t
 
	mÏ¡_aùive
;

1942 
utime_t
 
	mÏ¡_³”ed
;

1943 
utime_t
 
	mÏ¡_ş—n
;

1944 
utime_t
 
	mÏ¡_un¡®e
;

1945 
utime_t
 
	mÏ¡_undeg¿ded
;

1946 
utime_t
 
	mÏ¡_fuÎsized
;

1948 
ev”siÚ_t
 
	mlog_¡¬t
;

1949 
ev”siÚ_t
 
	mÚdisk_log_¡¬t
;

1951 
•och_t
 
	mü—‹d
;

1952 
•och_t
 
	mÏ¡_•och_ş—n
;

1953 
pg_t
 
	m·»Á
;

1954 
__u32
 
	m·»Á_¥l™_b™s
;

1956 
ev”siÚ_t
 
	mÏ¡_süub
;

1957 
ev”siÚ_t
 
	mÏ¡_d“p_süub
;

1958 
utime_t
 
	mÏ¡_süub_¡amp
;

1959 
utime_t
 
	mÏ¡_d“p_süub_¡amp
;

1960 
utime_t
 
	mÏ¡_ş—n_süub_¡amp
;

1962 
objeù_¡©_cŞËùiÚ_t
 
	m¡©s
;

1964 
št64_t
 
	mlog_size
;

1965 
št64_t
 
	mÚdisk_log_size
;

1967 
	mveùÜ
<
	mšt32_t
> 
	mup
, 
	maùšg
;

1968 
•och_t
 
	mm­pšg_•och
;

1970 
	mveùÜ
<
	mšt32_t
> 
	mblocked_by
;

1972 
	mš‹rv®_£t
<
	m¢­id_t
> 
	mpurged_¢­s
;

1974 
utime_t
 
	mÏ¡_beÿme_aùive
;

1975 
utime_t
 
	mÏ¡_beÿme_³”ed
;

1978 
št32_t
 
	mup_´im¬y
;

1979 
št32_t
 
	maùšg_´im¬y
;

1983 
ušt32_t
 
	m¢­Œimq_Ën
;

1985 
boŞ
 
	m¡©s_šv®id
:1;

1988 
boŞ
 
	mdœty_¡©s_šv®id
:1;

1989 
boŞ
 
	mom­_¡©s_šv®id
:1;

1990 
boŞ
 
	mh™£t_¡©s_šv®id
:1;

1991 
boŞ
 
	mh™£t_by‹s_¡©s_šv®id
:1;

1992 
boŞ
 
	mpš_¡©s_šv®id
:1;

1993 
boŞ
 
	mmªiã¡_¡©s_šv®id
:1;

1995 
pg_¡©_t
()

1996 : 
»pÜ‹d_£q
(0),

1997 
»pÜ‹d_•och
(0),

1998 
¡©e
(0),

1999 
ü—‹d
(0), 
Ï¡_•och_ş—n
(0),

2000 
·»Á_¥l™_b™s
(0),

2001 
log_size
(0), 
Údisk_log_size
(0),

2002 
m­pšg_•och
(0),

2003 
up_´im¬y
(-1),

2004 
aùšg_´im¬y
(-1),

2005 
¢­Œimq_Ën
(0),

2006 
¡©s_šv®id
(
çl£
),

2007 
dœty_¡©s_šv®id
(
çl£
),

2008 
om­_¡©s_šv®id
(
çl£
),

2009 
h™£t_¡©s_šv®id
(
çl£
),

2010 
h™£t_by‹s_¡©s_šv®id
(
çl£
),

2011 
pš_¡©s_šv®id
(
çl£
),

2012 
mªiã¡_¡©s_šv®id
(
çl£
)

2015 
•och_t
 
g‘_efãùive_Ï¡_•och_ş—n
() const {

2016 ià(
	m¡©e
 & 
	mPG_STATE_CLEAN
) {

2019  
	m»pÜ‹d_•och
;

2021  
	mÏ¡_•och_ş—n
;

2025 
	m·œ
<
	m•och_t
, 
	mv”siÚ_t
> 
g‘_v”siÚ_·œ
() const {

2026  
make_·œ
(
»pÜ‹d_•och
, 
»pÜ‹d_£q
);

2029 
æoÜ
(
št64_t
 
f
) {

2030 
	m¡©s
.
æoÜ
(
f
);

2031 ià(
	mlog_size
 < 
	mf
)

2032 
	mlog_size
 = 
f
;

2033 ià(
	mÚdisk_log_size
 < 
	mf
)

2034 
	mÚdisk_log_size
 = 
f
;

2035 ià(
	m¢­Œimq_Ën
 < 
	mf
)

2036 
	m¢­Œimq_Ën
 = 
f
;

2039 
add
(cÚ¡ 
pg_¡©_t
& 
o
) {

2040 
	m¡©s
.
add
(
o
.
¡©s
);

2041 
	mlog_size
 +ğ
o
.
log_size
;

2042 
	mÚdisk_log_size
 +ğ
o
.
Údisk_log_size
;

2043 
	m¢­Œimq_Ën
 = 
¡d
::
mš
((
ušt64_t
)
¢­Œimq_Ën
 + 
o
.snaptrimq_len,

2044 (
ušt64_t
)(1ull << 31));

2046 
sub
(cÚ¡ 
pg_¡©_t
& 
o
) {

2047 
	m¡©s
.
sub
(
o
.
¡©s
);

2048 
	mlog_size
 -ğ
o
.
log_size
;

2049 
	mÚdisk_log_size
 -ğ
o
.
Údisk_log_size
;

2050 ià(
	mo
.
	m¢­Œimq_Ën
 < snaptrimq_len) {

2051 
	m¢­Œimq_Ën
 -ğ
o
.
¢­Œimq_Ën
;

2053 
	m¢­Œimq_Ën
 = 0;

2057 
boŞ
 
is_aùšg_osd
(
št32_t
 
osd
, boŞ 
´im¬y
) const;

2058 
dump
(
FÜm©‹r
 *
f
) const;

2059 
dump_br›f
(
FÜm©‹r
 *
f
) const;

2060 
’code
(
bufã¾i¡
 &
bl
) const;

2061 
decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

2062 
g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_¡©_t
*>& 
o
);

2064 
	$WRITE_CLASS_ENCODER
(
pg_¡©_t
)

2066 
boŞ
 
İ”©Ü
==(cÚ¡ 
pg_¡©_t
& 
l
, cÚ¡…g_¡©_t& 
r
);

2071 
	spoŞ_¡©_t
 {

2072 
objeù_¡©_cŞËùiÚ_t
 
¡©s
;

2073 
št64_t
 
log_size
;

2074 
št64_t
 
Údisk_log_size
;

2075 
št32_t
 
up
;

2076 
št32_t
 
aùšg
;

2078 
	`poŞ_¡©_t
(è: 
	`log_size
(0), 
	`Údisk_log_size
(0), 
	`up
(0), 
	`aùšg
(0)

2081 
	`æoÜ
(
št64_t
 
f
) {

2082 
¡©s
.
	`æoÜ
(
f
);

2083 ià(
log_size
 < 
f
)

2084 
log_size
 = 
f
;

2085 ià(
Údisk_log_size
 < 
f
)

2086 
Údisk_log_size
 = 
f
;

2087 ià(
up
 < 
f
)

2088 
up
 = 
f
;

2089 ià(
aùšg
 < 
f
)

2090 
aùšg
 = 
f
;

2093 
	`add
(cÚ¡ 
pg_¡©_t
& 
o
) {

2094 
¡©s
.
	`add
(
o
.stats);

2095 
log_size
 +ğ
o
.log_size;

2096 
Údisk_log_size
 +ğ
o
.ondisk_log_size;

2097 
up
 +ğ
o
.up.
	`size
();

2098 
aùšg
 +ğ
o
.aùšg.
	`size
();

2100 
	`sub
(cÚ¡ 
pg_¡©_t
& 
o
) {

2101 
¡©s
.
	`sub
(
o
.stats);

2102 
log_size
 -ğ
o
.log_size;

2103 
Údisk_log_size
 -ğ
o
.ondisk_log_size;

2104 
up
 -ğ
o
.up.
	`size
();

2105 
aùšg
 -ğ
o
.aùšg.
	`size
();

2108 
boŞ
 
	`is_z”o
() const {

2109  (
¡©s
.
	`is_z”o
() &&

2110 
log_size
 == 0 &&

2111 
Údisk_log_size
 == 0 &&

2112 
up
 == 0 &&

2113 
aùšg
 == 0);

2116 
	`dump
(
FÜm©‹r
 *
f
) const;

2117 
	`’code
(
bufã¾i¡
 &
bl
, 
ušt64_t
 
ã©u»s
) const;

2118 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

2119 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
poŞ_¡©_t
*>& 
o
);

2121 
	$WRITE_CLASS_ENCODER_FEATURES
(
poŞ_¡©_t
)

2132 
	spg_h™_£t_šfo_t
 {

2133 
utime_t
 
begš
, 
’d
;

2134 
ev”siÚ_t
 
v”siÚ
;

2135 
boŞ
 
usšg_gmt
;

2137 
ä›nd
 
boŞ
 
İ”©Ü
==(cÚ¡ 
pg_h™_£t_šfo_t
& 
l
,

2138 cÚ¡ 
pg_h™_£t_šfo_t
& 
r
) {

2140 
l
.
begš
 =ğ
r
.begin &&

2141 
l
.
’d
 =ğ
r
.end &&

2142 
l
.
v”siÚ
 =ğ
r
.version &&

2143 
l
.
usšg_gmt
 =ğ
r
.using_gmt;

2146 
ex¶ic™
 
	`pg_h™_£t_šfo_t
(
boŞ
 
usšg_gmt
 = 
Œue
)

2147 : 
	`usšg_gmt
(
usšg_gmt
) {}

2149 
	`’code
(
bufã¾i¡
 &
bl
) const;

2150 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

2151 
	`dump
(
FÜm©‹r
 *
f
) const;

2152 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_h™_£t_šfo_t
*>& 
o
);

2154 
	$WRITE_CLASS_ENCODER
(
pg_h™_£t_šfo_t
)

2162 
	spg_h™_£t_hi¡Üy_t
 {

2163 
ev”siÚ_t
 
cu¼’t_Ï¡_upd©e
;

2164 
li¡
<
pg_h™_£t_šfo_t
> 
hi¡Üy
;

2166 
ä›nd
 
boŞ
 
İ”©Ü
==(cÚ¡ 
pg_h™_£t_hi¡Üy_t
& 
l
,

2167 cÚ¡ 
pg_h™_£t_hi¡Üy_t
& 
r
) {

2169 
l
.
cu¼’t_Ï¡_upd©e
 =ğ
r
.current_last_update &&

2170 
l
.
hi¡Üy
 =ğ
r
.history;

2173 
	`’code
(
bufã¾i¡
 &
bl
) const;

2174 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

2175 
	`dump
(
FÜm©‹r
 *
f
) const;

2176 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_h™_£t_hi¡Üy_t
*>& 
o
);

2178 
	$WRITE_CLASS_ENCODER
(
pg_h™_£t_hi¡Üy_t
)

2189 
	spg_hi¡Üy_t
 {

2190 
•och_t
 
•och_ü—‹d
;

2191 
•och_t
 
•och_poŞ_ü—‹d
;

2194 
•och_t
 
Ï¡_•och_¡¬‹d
;

2195 
•och_t
 
Ï¡_š‹rv®_¡¬‹d
;

2196 
•och_t
 
Ï¡_•och_ş—n
;

2197 
•och_t
 
Ï¡_š‹rv®_ş—n
;

2198 
•och_t
 
Ï¡_•och_¥l™
;

2199 
•och_t
 
Ï¡_•och_m¬ked_fuÎ
;

2208 
•och_t
 
§me_up_sšû
;

2209 
•och_t
 
§me_š‹rv®_sšû
;

2210 
•och_t
 
§me_´im¬y_sšû
;

2212 
ev”siÚ_t
 
Ï¡_süub
;

2213 
ev”siÚ_t
 
Ï¡_d“p_süub
;

2214 
utime_t
 
Ï¡_süub_¡amp
;

2215 
utime_t
 
Ï¡_d“p_süub_¡amp
;

2216 
utime_t
 
Ï¡_ş—n_süub_¡amp
;

2218 
ä›nd
 
boŞ
 
İ”©Ü
==(cÚ¡ 
pg_hi¡Üy_t
& 
l
, cÚ¡…g_hi¡Üy_t& 
r
) {

2220 
l
.
•och_ü—‹d
 =ğ
r
.epoch_created &&

2221 
l
.
•och_poŞ_ü—‹d
 =ğ
r
.epoch_pool_created &&

2222 
l
.
Ï¡_•och_¡¬‹d
 =ğ
r
.last_epoch_started &&

2223 
l
.
Ï¡_š‹rv®_¡¬‹d
 =ğ
r
.last_interval_started &&

2224 
l
.
Ï¡_•och_ş—n
 =ğ
r
.last_epoch_clean &&

2225 
l
.
Ï¡_š‹rv®_ş—n
 =ğ
r
.last_interval_clean &&

2226 
l
.
Ï¡_•och_¥l™
 =ğ
r
.last_epoch_split &&

2227 
l
.
Ï¡_•och_m¬ked_fuÎ
 =ğ
r
.last_epoch_marked_full &&

2228 
l
.
§me_up_sšû
 =ğ
r
.same_up_since &&

2229 
l
.
§me_š‹rv®_sšû
 =ğ
r
.same_interval_since &&

2230 
l
.
§me_´im¬y_sšû
 =ğ
r
.same_primary_since &&

2231 
l
.
Ï¡_süub
 =ğ
r
.last_scrub &&

2232 
l
.
Ï¡_d“p_süub
 =ğ
r
.last_deep_scrub &&

2233 
l
.
Ï¡_süub_¡amp
 =ğ
r
.last_scrub_stamp &&

2234 
l
.
Ï¡_d“p_süub_¡amp
 =ğ
r
.last_deep_scrub_stamp &&

2235 
l
.
Ï¡_ş—n_süub_¡amp
 =ğ
r
.last_clean_scrub_stamp;

2238 
	`pg_hi¡Üy_t
()

2239 : 
	`•och_ü—‹d
(0),

2240 
	`•och_poŞ_ü—‹d
(0),

2241 
	`Ï¡_•och_¡¬‹d
(0),

2242 
	`Ï¡_š‹rv®_¡¬‹d
(0),

2243 
	`Ï¡_•och_ş—n
(0),

2244 
	`Ï¡_š‹rv®_ş—n
(0),

2245 
	`Ï¡_•och_¥l™
(0),

2246 
	`Ï¡_•och_m¬ked_fuÎ
(0),

2247 
	`§me_up_sšû
(0), 
	`§me_š‹rv®_sšû
(0), 
	`§me_´im¬y_sšû
(0) {}

2249 
boŞ
 
	`m”ge
(cÚ¡ 
pg_hi¡Üy_t
 &
Ùh”
) {

2251 
boŞ
 
modif›d
 = 
çl£
;

2252 ià(
•och_ü—‹d
 < 
Ùh”
.epoch_created) {

2253 
•och_ü—‹d
 = 
Ùh”
.epoch_created;

2254 
modif›d
 = 
Œue
;

2256 ià(
•och_poŞ_ü—‹d
 < 
Ùh”
.epoch_pool_created) {

2259 
•och_poŞ_ü—‹d
 = 
Ùh”
.epoch_pool_created;

2260 
modif›d
 = 
Œue
;

2262 ià(
Ï¡_•och_¡¬‹d
 < 
Ùh”
.last_epoch_started) {

2263 
Ï¡_•och_¡¬‹d
 = 
Ùh”
.last_epoch_started;

2264 
modif›d
 = 
Œue
;

2266 ià(
Ï¡_š‹rv®_¡¬‹d
 < 
Ùh”
.last_interval_started) {

2267 
Ï¡_š‹rv®_¡¬‹d
 = 
Ùh”
.last_interval_started;

2268 
modif›d
 = 
Œue
;

2270 ià(
Ï¡_•och_ş—n
 < 
Ùh”
.last_epoch_clean) {

2271 
Ï¡_•och_ş—n
 = 
Ùh”
.last_epoch_clean;

2272 
modif›d
 = 
Œue
;

2274 ià(
Ï¡_š‹rv®_ş—n
 < 
Ùh”
.last_interval_clean) {

2275 
Ï¡_š‹rv®_ş—n
 = 
Ùh”
.last_interval_clean;

2276 
modif›d
 = 
Œue
;

2278 ià(
Ï¡_•och_¥l™
 < 
Ùh”
.last_epoch_split) {

2279 
Ï¡_•och_¥l™
 = 
Ùh”
.last_epoch_split;

2280 
modif›d
 = 
Œue
;

2282 ià(
Ï¡_•och_m¬ked_fuÎ
 < 
Ùh”
.last_epoch_marked_full) {

2283 
Ï¡_•och_m¬ked_fuÎ
 = 
Ùh”
.last_epoch_marked_full;

2284 
modif›d
 = 
Œue
;

2286 ià(
Ùh”
.
Ï¡_süub
 >†ast_scrub) {

2287 
Ï¡_süub
 = 
Ùh”
.last_scrub;

2288 
modif›d
 = 
Œue
;

2290 ià(
Ùh”
.
Ï¡_süub_¡amp
 >†ast_scrub_stamp) {

2291 
Ï¡_süub_¡amp
 = 
Ùh”
.last_scrub_stamp;

2292 
modif›d
 = 
Œue
;

2294 ià(
Ùh”
.
Ï¡_d“p_süub
 >†ast_deep_scrub) {

2295 
Ï¡_d“p_süub
 = 
Ùh”
.last_deep_scrub;

2296 
modif›d
 = 
Œue
;

2298 ià(
Ùh”
.
Ï¡_d“p_süub_¡amp
 >†ast_deep_scrub_stamp) {

2299 
Ï¡_d“p_süub_¡amp
 = 
Ùh”
.last_deep_scrub_stamp;

2300 
modif›d
 = 
Œue
;

2302 ià(
Ùh”
.
Ï¡_ş—n_süub_¡amp
 >†ast_clean_scrub_stamp) {

2303 
Ï¡_ş—n_süub_¡amp
 = 
Ùh”
.last_clean_scrub_stamp;

2304 
modif›d
 = 
Œue
;

2306  
modif›d
;

2309 
	`’code
(
bufã¾i¡
& 
bl
) const;

2310 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
p
);

2311 
	`dump
(
FÜm©‹r
 *
f
) const;

2312 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_hi¡Üy_t
*>& 
o
);

2314 
	$WRITE_CLASS_ENCODER
(
pg_hi¡Üy_t
)

2316 
šlše
 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
pg_hi¡Üy_t
& 
h
) {

2317  
out
 << "ec=" << 
h
.
•och_ü—‹d
 << "/" << h.
•och_poŞ_ü—‹d


2318 << "†is/ø" << 
h
.
Ï¡_š‹rv®_¡¬‹d


2319 << "/" << 
h
.
Ï¡_š‹rv®_ş—n


2320 << "†es/c/à" << 
h
.
Ï¡_•och_¡¬‹d
 << "/" << h.
Ï¡_•och_ş—n


2321 << "/" << 
h
.
Ï¡_•och_m¬ked_fuÎ


2322 << " " << 
h
.
§me_up_sšû


2323 << "/" << 
h
.
§me_š‹rv®_sšû


2324 << "/" << 
h
.
§me_´im¬y_sšû
;

2325 
	}
}

2337 
	spg_šfo_t
 {

2338 
¥g_t
 
	mpgid
;

2339 
ev”siÚ_t
 
	mÏ¡_upd©e
;

2340 
ev”siÚ_t
 
	mÏ¡_com¶‘e
;

2341 
•och_t
 
	mÏ¡_•och_¡¬‹d
;

2342 
•och_t
 
	mÏ¡_š‹rv®_¡¬‹d
;

2344 
v”siÚ_t
 
	mÏ¡_u£r_v”siÚ
;

2346 
ev”siÚ_t
 
	mlog_
;

2348 
hobjeù_t
 
	mÏ¡_backfl
;

2349 
boŞ
 
	mÏ¡_backfl_b™wi£
;

2351 
	mš‹rv®_£t
<
	m¢­id_t
> 
	mpurged_¢­s
;

2353 
pg_¡©_t
 
	m¡©s
;

2355 
pg_hi¡Üy_t
 
	mhi¡Üy
;

2356 
pg_h™_£t_hi¡Üy_t
 
	mh™_£t
;

2358 
ä›nd
 
boŞ
 
	mİ”©Ü
==(cÚ¡ 
pg_šfo_t
& 
l
, cÚ¡ 
	mpg_šfo_t
& 
	mr
) {

2360 
	ml
.
	mpgid
 =ğ
r
.
pgid
 &&

2361 
l
.
Ï¡_upd©e
 =ğ
r
.last_update &&

2362 
l
.
Ï¡_com¶‘e
 =ğ
r
.last_complete &&

2363 
l
.
Ï¡_•och_¡¬‹d
 =ğ
r
.last_epoch_started &&

2364 
l
.
Ï¡_š‹rv®_¡¬‹d
 =ğ
r
.last_interval_started &&

2365 
l
.
Ï¡_u£r_v”siÚ
 =ğ
r
.last_user_version &&

2366 
l
.
log_
 =ğ
r
.log_tail &&

2367 
l
.
Ï¡_backfl
 =ğ
r
.last_backfill &&

2368 
l
.
Ï¡_backfl_b™wi£
 =ğ
r
.last_backfill_bitwise &&

2369 
l
.
purged_¢­s
 =ğ
r
.purged_snaps &&

2370 
l
.
¡©s
 =ğ
r
.stats &&

2371 
l
.
hi¡Üy
 =ğ
r
.history &&

2372 
l
.
h™_£t
 =ğ
r
.hit_set;

2375 
pg_šfo_t
()

2376 : 
Ï¡_•och_¡¬‹d
(0),

2377 
Ï¡_š‹rv®_¡¬‹d
(0),

2378 
Ï¡_u£r_v”siÚ
(0),

2379 
Ï¡_backfl
(
hobjeù_t
::
g‘_max
()),

2380 
Ï¡_backfl_b™wi£
(
çl£
)

2383 
pg_šfo_t
(
¥g_t
 
p
)

2384 : 
pgid
(
p
),

2385 
Ï¡_•och_¡¬‹d
(0),

2386 
Ï¡_š‹rv®_¡¬‹d
(0),

2387 
Ï¡_u£r_v”siÚ
(0),

2388 
Ï¡_backfl
(
hobjeù_t
::
g‘_max
()),

2389 
Ï¡_backfl_b™wi£
(
çl£
)

2392 
£t_Ï¡_backfl
(
hobjeù_t
 
pos
) {

2393 
	mÏ¡_backfl
 = 
pos
;

2394 
	mÏ¡_backfl_b™wi£
 = 
Œue
;

2397 
boŞ
 
is_em±y
(ècÚ¡ {  
	mÏ¡_upd©e
.
	mv”siÚ
 == 0; }

2398 
boŞ
 
dÃ
(ècÚ¡ {  
	mhi¡Üy
.
	m•och_ü—‹d
 == 0; }

2400 
boŞ
 
is_šcom¶‘e
(ècÚ¡ {  !
	mÏ¡_backfl
.
is_max
(); }

2402 
’code
(
bufã¾i¡
& 
bl
) const;

2403 
decode
(
bufã¾i¡
::
™”©Ü
& 
p
);

2404 
dump
(
FÜm©‹r
 *
f
) const;

2405 
boŞ
 
ov”Ïps_w™h
(cÚ¡ 
pg_šfo_t
 &
ošfo
) const {

2406  
	mÏ¡_upd©e
 > 
	mošfo
.
	mlog_
 ?

2407 
	mošfo
.
	mÏ¡_upd©e
 >ğ
log_
 :

2408 
Ï¡_upd©e
 >ğ
ošfo
.
log_
;

2410 
g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_šfo_t
*>& 
o
);

2412 
	$WRITE_CLASS_ENCODER
(
pg_šfo_t
)

2414 
šlše
 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
pg_šfo_t
& 
pgi
)

2416 
out
 << 
pgi
.
pgid
 << "(";

2417 ià(
pgi
.
	`dÃ
())

2418 
out
 << " DNE";

2419 ià(
pgi
.
	`is_em±y
())

2420 
out
 << "ƒmpty";

2422 
out
 << " v " << 
pgi
.
Ï¡_upd©e
;

2423 ià(
pgi
.
Ï¡_com¶‘e
 !ğpgi.
Ï¡_upd©e
)

2424 
out
 << "†ø" << 
pgi
.
Ï¡_com¶‘e
;

2425 
out
 << " (" << 
pgi
.
log_
 << "," <<…gi.
Ï¡_upd©e
 << "]";

2427 ià(
pgi
.
	`is_šcom¶‘e
())

2428 
out
 << "†b " << 
pgi
.
Ï¡_backfl


2429 << (
pgi
.
Ï¡_backfl_b™wi£
 ? " (bitwise)" : " (NIBBLEWISE)");

2431 
out
 << "†oÿl-lis/Ës=" << 
pgi
.
Ï¡_š‹rv®_¡¬‹d


2432 << "/" << 
pgi
.
Ï¡_•och_¡¬‹d
;

2433 
out
 << "‚=" << 
pgi
.
¡©s
.¡©s.
sum
.
num_objeùs
;

2434 
out
 << " " << 
pgi
.
hi¡Üy


2436  
out
;

2437 
	}
}

2450 
	spg_ç¡_šfo_t
 {

2451 
ev”siÚ_t
 
	mÏ¡_upd©e
;

2452 
ev”siÚ_t
 
	mÏ¡_com¶‘e
;

2453 
v”siÚ_t
 
	mÏ¡_u£r_v”siÚ
;

2455 
ev”siÚ_t
 
	mv”siÚ
;

2456 
v”siÚ_t
 
	m»pÜ‹d_£q
;

2457 
utime_t
 
	mÏ¡_äesh
;

2458 
utime_t
 
	mÏ¡_aùive
;

2459 
utime_t
 
	mÏ¡_³”ed
;

2460 
utime_t
 
	mÏ¡_ş—n
;

2461 
utime_t
 
	mÏ¡_un¡®e
;

2462 
utime_t
 
	mÏ¡_undeg¿ded
;

2463 
utime_t
 
	mÏ¡_fuÎsized
;

2464 
št64_t
 
	mlog_size
;

2467 
št64_t
 
	mnum_by‹s
;

2468 
št64_t
 
	mnum_objeùs
;

2469 
št64_t
 
	mnum_objeù_cİ›s
;

2470 
št64_t
 
	mnum_rd
;

2471 
št64_t
 
	mnum_rd_kb
;

2472 
št64_t
 
	mnum_wr
;

2473 
št64_t
 
	mnum_wr_kb
;

2474 
št64_t
 
	mnum_objeùs_dœty
;

2475 } 
	msum
;

2476 } 
	m¡©s
;

2477 } 
	m¡©s
;

2479 
pİuÏ‹_äom
(cÚ¡ 
pg_šfo_t
& 
šfo
) {

2480 
	mÏ¡_upd©e
 = 
šfo
.
Ï¡_upd©e
;

2481 
	mÏ¡_com¶‘e
 = 
šfo
.
Ï¡_com¶‘e
;

2482 
	mÏ¡_u£r_v”siÚ
 = 
šfo
.
Ï¡_u£r_v”siÚ
;

2483 
	m¡©s
.
	mv”siÚ
 = 
šfo
.
¡©s
.
v”siÚ
;

2484 
	m¡©s
.
	m»pÜ‹d_£q
 = 
šfo
.
¡©s
.
»pÜ‹d_£q
;

2485 
	m¡©s
.
	mÏ¡_äesh
 = 
šfo
.
¡©s
.
Ï¡_äesh
;

2486 
	m¡©s
.
	mÏ¡_aùive
 = 
šfo
.
¡©s
.
Ï¡_aùive
;

2487 
	m¡©s
.
	mÏ¡_³”ed
 = 
šfo
.
¡©s
.
Ï¡_³”ed
;

2488 
	m¡©s
.
	mÏ¡_ş—n
 = 
šfo
.
¡©s
.
Ï¡_ş—n
;

2489 
	m¡©s
.
	mÏ¡_un¡®e
 = 
šfo
.
¡©s
.
Ï¡_un¡®e
;

2490 
	m¡©s
.
	mÏ¡_undeg¿ded
 = 
šfo
.
¡©s
.
Ï¡_undeg¿ded
;

2491 
	m¡©s
.
	mÏ¡_fuÎsized
 = 
šfo
.
¡©s
.
Ï¡_fuÎsized
;

2492 
	m¡©s
.
	mlog_size
 = 
šfo
.
¡©s
.
log_size
;

2493 
	m¡©s
.¡©s.
	msum
.
	mnum_by‹s
 = 
šfo
.
¡©s
.¡©s.
sum
.
num_by‹s
;

2494 
	m¡©s
.¡©s.
	msum
.
	mnum_objeùs
 = 
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs
;

2495 
	m¡©s
.¡©s.
	msum
.
	mnum_objeù_cİ›s
 = 
šfo
.
¡©s
.¡©s.
sum
.
num_objeù_cİ›s
;

2496 
	m¡©s
.¡©s.
	msum
.
	mnum_rd
 = 
šfo
.
¡©s
.¡©s.
sum
.
num_rd
;

2497 
	m¡©s
.¡©s.
	msum
.
	mnum_rd_kb
 = 
šfo
.
¡©s
.¡©s.
sum
.
num_rd_kb
;

2498 
	m¡©s
.¡©s.
	msum
.
	mnum_wr
 = 
šfo
.
¡©s
.¡©s.
sum
.
num_wr
;

2499 
	m¡©s
.¡©s.
	msum
.
	mnum_wr_kb
 = 
šfo
.
¡©s
.¡©s.
sum
.
num_wr_kb
;

2500 
	m¡©s
.¡©s.
	msum
.
	mnum_objeùs_dœty
 = 
šfo
.
¡©s
.¡©s.
sum
.
num_objeùs_dœty
;

2503 
boŞ
 
Œy_­¶y_to
(
pg_šfo_t
* 
šfo
) {

2504 ià(
	mÏ¡_upd©e
 <ğ
šfo
->
Ï¡_upd©e
)

2505  
çl£
;

2506 
	mšfo
->
	mÏ¡_upd©e
 = 
Ï¡_upd©e
;

2507 
	mšfo
->
	mÏ¡_com¶‘e
 = 
Ï¡_com¶‘e
;

2508 
	mšfo
->
	mÏ¡_u£r_v”siÚ
 = 
Ï¡_u£r_v”siÚ
;

2509 
	mšfo
->
	m¡©s
.
	mv”siÚ
 = 
¡©s
.
v”siÚ
;

2510 
	mšfo
->
	m¡©s
.
	m»pÜ‹d_£q
 = 
¡©s
.
»pÜ‹d_£q
;

2511 
	mšfo
->
	m¡©s
.
	mÏ¡_äesh
 = 
¡©s
.
Ï¡_äesh
;

2512 
	mšfo
->
	m¡©s
.
	mÏ¡_aùive
 = 
¡©s
.
Ï¡_aùive
;

2513 
	mšfo
->
	m¡©s
.
	mÏ¡_³”ed
 = 
¡©s
.
Ï¡_³”ed
;

2514 
	mšfo
->
	m¡©s
.
	mÏ¡_ş—n
 = 
¡©s
.
Ï¡_ş—n
;

2515 
	mšfo
->
	m¡©s
.
	mÏ¡_un¡®e
 = 
¡©s
.
Ï¡_un¡®e
;

2516 
	mšfo
->
	m¡©s
.
	mÏ¡_undeg¿ded
 = 
¡©s
.
Ï¡_undeg¿ded
;

2517 
	mšfo
->
	m¡©s
.
	mÏ¡_fuÎsized
 = 
¡©s
.
Ï¡_fuÎsized
;

2518 
	mšfo
->
	m¡©s
.
	mlog_size
 = 
¡©s
.
log_size
;

2519 
	mšfo
->
	m¡©s
.
	mÚdisk_log_size
 = 
¡©s
.
log_size
;

2520 
	mšfo
->
	m¡©s
.¡©s.
	msum
.
	mnum_by‹s
 = 
¡©s
.¡©s.
sum
.
num_by‹s
;

2521 
	mšfo
->
	m¡©s
.¡©s.
	msum
.
	mnum_objeùs
 = 
¡©s
.¡©s.
sum
.
num_objeùs
;

2522 
	mšfo
->
	m¡©s
.¡©s.
	msum
.
	mnum_objeù_cİ›s
 = 
¡©s
.¡©s.
sum
.
num_objeù_cİ›s
;

2523 
	mšfo
->
	m¡©s
.¡©s.
	msum
.
	mnum_rd
 = 
¡©s
.¡©s.
sum
.
num_rd
;

2524 
	mšfo
->
	m¡©s
.¡©s.
	msum
.
	mnum_rd_kb
 = 
¡©s
.¡©s.
sum
.
num_rd_kb
;

2525 
	mšfo
->
	m¡©s
.¡©s.
	msum
.
	mnum_wr
 = 
¡©s
.¡©s.
sum
.
num_wr
;

2526 
	mšfo
->
	m¡©s
.¡©s.
	msum
.
	mnum_wr_kb
 = 
¡©s
.¡©s.
sum
.
num_wr_kb
;

2527 
	mšfo
->
	m¡©s
.¡©s.
	msum
.
	mnum_objeùs_dœty
 = 
¡©s
.¡©s.
sum
.
num_objeùs_dœty
;

2528  
	mŒue
;

2531 
’code
(
bufã¾i¡
& 
bl
) const {

2532 
ENCODE_START
(1, 1, 
bl
);

2533 
’code
(
Ï¡_upd©e
, 
bl
);

2534 
’code
(
Ï¡_com¶‘e
, 
bl
);

2535 
’code
(
Ï¡_u£r_v”siÚ
, 
bl
);

2536 
’code
(
¡©s
.
v”siÚ
, 
bl
);

2537 
’code
(
¡©s
.
»pÜ‹d_£q
, 
bl
);

2538 
’code
(
¡©s
.
Ï¡_äesh
, 
bl
);

2539 
’code
(
¡©s
.
Ï¡_aùive
, 
bl
);

2540 
’code
(
¡©s
.
Ï¡_³”ed
, 
bl
);

2541 
’code
(
¡©s
.
Ï¡_ş—n
, 
bl
);

2542 
’code
(
¡©s
.
Ï¡_un¡®e
, 
bl
);

2543 
’code
(
¡©s
.
Ï¡_undeg¿ded
, 
bl
);

2544 
’code
(
¡©s
.
Ï¡_fuÎsized
, 
bl
);

2545 
’code
(
¡©s
.
log_size
, 
bl
);

2546 
’code
(
¡©s
.¡©s.
sum
.
num_by‹s
, 
bl
);

2547 
’code
(
¡©s
.¡©s.
sum
.
num_objeùs
, 
bl
);

2548 
’code
(
¡©s
.¡©s.
sum
.
num_objeù_cİ›s
, 
bl
);

2549 
’code
(
¡©s
.¡©s.
sum
.
num_rd
, 
bl
);

2550 
’code
(
¡©s
.¡©s.
sum
.
num_rd_kb
, 
bl
);

2551 
’code
(
¡©s
.¡©s.
sum
.
num_wr
, 
bl
);

2552 
’code
(
¡©s
.¡©s.
sum
.
num_wr_kb
, 
bl
);

2553 
’code
(
¡©s
.¡©s.
sum
.
num_objeùs_dœty
, 
bl
);

2554 
ENCODE_FINISH
(
bl
);

2556 
decode
(
bufã¾i¡
::
™”©Ü
& 
p
) {

2557 
DECODE_START
(1, 
p
);

2558 
decode
(
Ï¡_upd©e
, 
p
);

2559 
decode
(
Ï¡_com¶‘e
, 
p
);

2560 
decode
(
Ï¡_u£r_v”siÚ
, 
p
);

2561 
decode
(
¡©s
.
v”siÚ
, 
p
);

2562 
decode
(
¡©s
.
»pÜ‹d_£q
, 
p
);

2563 
decode
(
¡©s
.
Ï¡_äesh
, 
p
);

2564 
decode
(
¡©s
.
Ï¡_aùive
, 
p
);

2565 
decode
(
¡©s
.
Ï¡_³”ed
, 
p
);

2566 
decode
(
¡©s
.
Ï¡_ş—n
, 
p
);

2567 
decode
(
¡©s
.
Ï¡_un¡®e
, 
p
);

2568 
decode
(
¡©s
.
Ï¡_undeg¿ded
, 
p
);

2569 
decode
(
¡©s
.
Ï¡_fuÎsized
, 
p
);

2570 
decode
(
¡©s
.
log_size
, 
p
);

2571 
decode
(
¡©s
.¡©s.
sum
.
num_by‹s
, 
p
);

2572 
decode
(
¡©s
.¡©s.
sum
.
num_objeùs
, 
p
);

2573 
decode
(
¡©s
.¡©s.
sum
.
num_objeù_cİ›s
, 
p
);

2574 
decode
(
¡©s
.¡©s.
sum
.
num_rd
, 
p
);

2575 
decode
(
¡©s
.¡©s.
sum
.
num_rd_kb
, 
p
);

2576 
decode
(
¡©s
.¡©s.
sum
.
num_wr
, 
p
);

2577 
decode
(
¡©s
.¡©s.
sum
.
num_wr_kb
, 
p
);

2578 
decode
(
¡©s
.¡©s.
sum
.
num_objeùs_dœty
, 
p
);

2579 
DECODE_FINISH
(
p
);

2582 
	$WRITE_CLASS_ENCODER
(
pg_ç¡_šfo_t
)

2585 
	spg_nÙify_t
 {

2586 
•och_t
 
qu”y_•och
;

2587 
•och_t
 
•och_£Á
;

2588 
pg_šfo_t
 
šfo
;

2589 
sh¬d_id_t
 
to
;

2590 
sh¬d_id_t
 
äom
;

2591 
	`pg_nÙify_t
() :

2592 
	`qu”y_•och
(0), 
	`•och_£Á
(0), 
	`to
(
sh¬d_id_t
::
NO_SHARD
),

2593 
	`äom
(
sh¬d_id_t
::
NO_SHARD
) {}

2594 
	`pg_nÙify_t
(

2595 
sh¬d_id_t
 
to
,

2596 
sh¬d_id_t
 
äom
,

2597 
•och_t
 
qu”y_•och
,

2598 
•och_t
 
•och_£Á
,

2599 cÚ¡ 
pg_šfo_t
 &
šfo
)

2600 : 
	`qu”y_•och
(
qu”y_•och
),

2601 
	`•och_£Á
(
•och_£Á
),

2602 
	`šfo
(
šfo
), 
	`to
(
to
), 
	`äom
(
äom
) {

2603 
	`as£¹
(
äom
 =ğ
šfo
.
pgid
.
sh¬d
);

2605 
	`’code
(
bufã¾i¡
 &
bl
) const;

2606 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
p
);

2607 
	`dump
(
FÜm©‹r
 *
f
) const;

2608 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_nÙify_t
*> &
o
);

2610 
	$WRITE_CLASS_ENCODER
(
pg_nÙify_t
)

2611 
o¡»am
 &
İ”©Ü
<<(o¡»am &
lhs
, cÚ¡ 
pg_nÙify_t
 &
nÙify
);

2614 
şass
 
OSDM­
;

2619 şas 
	cPa¡IÁ”v®s
 {

2620 
public
:

2621 
	spg_š‹rv®_t
 {

2622 
veùÜ
<
št32_t
> 
up
, 
aùšg
;

2623 
•och_t
 
fœ¡
, 
Ï¡
;

2624 
boŞ
 
maybe_w’t_rw
;

2625 
št32_t
 
´im¬y
;

2626 
št32_t
 
up_´im¬y
;

2628 
	`pg_š‹rv®_t
()

2629 : 
	`fœ¡
(0), 
	`Ï¡
(0),

2630 
	`maybe_w’t_rw
(
çl£
),

2631 
	`´im¬y
(-1),

2632 
	`up_´im¬y
(-1)

2635 
	`pg_š‹rv®_t
(

2636 
veùÜ
<
št32_t
> &&
up
,

2637 
veùÜ
<
št32_t
> &&
aùšg
,

2638 
•och_t
 
fœ¡
,

2639 
•och_t
 
Ï¡
,

2640 
boŞ
 
maybe_w’t_rw
,

2641 
št32_t
 
´im¬y
,

2642 
št32_t
 
up_´im¬y
)

2643 : 
	`up
(
up
), 
	`aùšg
(
aùšg
), 
	`fœ¡
(
fœ¡
), 
	`Ï¡
(
Ï¡
),

2644 
	`maybe_w’t_rw
(
maybe_w’t_rw
), 
	`´im¬y
(
´im¬y
), 
	`up_´im¬y
(
up_´im¬y
)

2647 
	`’code
(
bufã¾i¡
& 
bl
) const;

2648 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
bl
);

2649 
	`dump
(
FÜm©‹r
 *
f
) const;

2650 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_š‹rv®_t
*>& 
o
);

2653 
	`Pa¡IÁ”v®s
();

2654 
	`Pa¡IÁ”v®s
(
Pa¡IÁ”v®s
 &&
rhs
) = ;

2655 
Pa¡IÁ”v®s
 &
İ”©Ü
=(Pa¡IÁ”v® &&
rhs
) = ;

2657 
	`Pa¡IÁ”v®s
(cÚ¡ 
Pa¡IÁ”v®s
 &
rhs
);

2658 
Pa¡IÁ”v®s
 &
İ”©Ü
=(cÚ¡ Pa¡IÁ”v® &
rhs
);

2660 şas 
	cš‹rv®_»p
 {

2661 
public
:

2662 
vœtu®
 
size_t
 
	`size
() const = 0;

2663 
vœtu®
 
boŞ
 
	`em±y
() const = 0;

2664 
vœtu®
 
	`ş—r
() = 0;

2665 
vœtu®
 
·œ
<
•och_t
,ƒpoch_t> 
	`g‘_bounds
() const = 0;

2666 
vœtu®
 
£t
<
pg_sh¬d_t
> 
	`g‘_®l_·¹icªts
(

2667 
boŞ
 
ec_poŞ
) const = 0;

2668 
vœtu®
 
	`add_š‹rv®
(
boŞ
 
ec_poŞ
, cÚ¡ 
pg_š‹rv®_t
 &
š‹rv®
) = 0;

2669 
vœtu®
 
unique_±r
<
š‹rv®_»p
> 
	`şÚe
() const = 0;

2670 
vœtu®
 
o¡»am
 &
	`´št
(o¡»am &
out
) const = 0;

2671 
vœtu®
 
	`’code
(
bufã¾i¡
 &
bl
) const = 0;

2672 
vœtu®
 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
) = 0;

2673 
vœtu®
 
	`dump
(
FÜm©‹r
 *
f
) const = 0;

2674 
vœtu®
 
	`™”©e_mayb”w_back_to
(

2675 
boŞ
 
ec_poŞ
,

2676 
•och_t
 
Ës
,

2677 
¡d
::
funùiÚ
<(
•och_t
, cÚ¡ 
£t
<
pg_sh¬d_t
> &)> &&
f
) const = 0;

2679 
vœtu®
 
boŞ
 
	`has_fuÎ_š‹rv®s
(ècÚ¡ {  
çl£
; }

2680 
vœtu®
 
	`™”©e_®l_š‹rv®s
(

2681 
¡d
::
funùiÚ
<(cÚ¡ 
pg_š‹rv®_t
 &)> &&
f
) const {

2682 
	`as£¹
(!
	`has_fuÎ_š‹rv®s
());

2683 
	`as£¹
(0 == "not valid forhis implementation");

2686 
vœtu®
 ~
	`š‹rv®_»p
() {}

2687 
	}
};

2688 
ä›nd
 
şass
 
	gpi_com·ù_»p
;

2689 
	g´iv©e
:

2691 
unique_±r
<
š‹rv®_»p
> 
·¡_š‹rv®s
;

2693 
ex¶ic™
 
	$Pa¡IÁ”v®s
(
š‹rv®_»p
 *
»p
è: 
	$·¡_š‹rv®s
(
»p
è{
	}
}

2695 
public
:

2696 
	$add_š‹rv®
(
boŞ
 
ec_poŞ
, cÚ¡ 
pg_š‹rv®_t
 &
š‹rv®
) {

2697 
	`as£¹
(
·¡_š‹rv®s
);

2698  
·¡_š‹rv®s
->
	`add_š‹rv®
(
ec_poŞ
, 
š‹rv®
);

2699 
	}
}

2701 
	$’code
(
bufã¾i¡
 &
bl
) const {

2702 
	`ENCODE_START
(1, 1, 
bl
);

2703 ià(
·¡_š‹rv®s
) {

2704 
__u8
 
ty³
 = 2;

2705 
	`’code
(
ty³
, 
bl
);

2706 
·¡_š‹rv®s
->
	`’code
(
bl
);

2708 
	`’code
((
__u8
)0, 
bl
);

2710 
	`ENCODE_FINISH
(
bl
);

2711 
	}
}

2713 
decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

2715 
	$dump
(
FÜm©‹r
 *
f
) const {

2716 
	`as£¹
(
·¡_š‹rv®s
);

2717 
·¡_š‹rv®s
->
	`dump
(
f
);

2718 
	}
}

2719 
g’”©e_‹¡_š¡ªûs
(
li¡
<
Pa¡IÁ”v®s
 *> & 
o
);

2724 
boŞ
 
is_Ãw_š‹rv®
(

2725 
Şd_aùšg_´im¬y
,

2726 
Ãw_aùšg_´im¬y
,

2727 cÚ¡ 
veùÜ
<> &
Şd_aùšg
,

2728 cÚ¡ 
veùÜ
<> &
Ãw_aùšg
,

2729 
Şd_up_´im¬y
,

2730 
Ãw_up_´im¬y
,

2731 cÚ¡ 
veùÜ
<> &
Şd_up
,

2732 cÚ¡ 
veùÜ
<> &
Ãw_up
,

2733 
Şd_size
,

2734 
Ãw_size
,

2735 
Şd_mš_size
,

2736 
Ãw_mš_size
,

2737 
Şd_pg_num
,

2738 
Ãw_pg_num
,

2739 
boŞ
 
Şd_sÜt_b™wi£
,

2740 
boŞ
 
Ãw_sÜt_b™wi£
,

2741 
boŞ
 
Şd_»cov”y_d–‘es
,

2742 
boŞ
 
Ãw_»cov”y_d–‘es
,

2743 
pg_t
 
pgid


2749 
boŞ
 
is_Ãw_š‹rv®
(

2750 
Şd_aùšg_´im¬y
,

2751 
Ãw_aùšg_´im¬y
,

2752 cÚ¡ 
veùÜ
<> &
Şd_aùšg
,

2753 cÚ¡ 
veùÜ
<> &
Ãw_aùšg
,

2754 
Şd_up_´im¬y
,

2755 
Ãw_up_´im¬y
,

2756 cÚ¡ 
veùÜ
<> &
Şd_up
,

2757 cÚ¡ 
veùÜ
<> &
Ãw_up
,

2758 
ûph
::
sh¬ed_±r
<cÚ¡ 
OSDM­
> 
osdm­
,

2759 
ûph
::
sh¬ed_±r
<cÚ¡ 
OSDM­
> 
Ï¡m­
,

2760 
pg_t
 
pgid


2767 
boŞ
 
check_Ãw_š‹rv®
(

2768 
Şd_aùšg_´im¬y
,

2769 
Ãw_aùšg_´im¬y
,

2770 cÚ¡ 
veùÜ
<> &
Şd_aùšg
,

2771 cÚ¡ 
veùÜ
<> &
Ãw_aùšg
,

2772 
Şd_up_´im¬y
,

2773 
Ãw_up_´im¬y
,

2774 cÚ¡ 
veùÜ
<> &
Şd_up
,

2775 cÚ¡ 
veùÜ
<> &
Ãw_up
,

2776 
•och_t
 
§me_š‹rv®_sšû
,

2777 
•och_t
 
Ï¡_•och_ş—n
,

2778 
ûph
::
sh¬ed_±r
<cÚ¡ 
OSDM­
> 
osdm­
,

2779 
ûph
::
sh¬ed_±r
<cÚ¡ 
OSDM­
> 
Ï¡m­
,

2780 
pg_t
 
pgid
,

2781 
IsPGRecov”abËP»diÿ‹
 *
could_have_gÚe_aùive
,

2782 
Pa¡IÁ”v®s
 *
·¡_š‹rv®s
,

2783 
o¡»am
 *
out
 = 0

2786 
ä›nd
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gPa¡IÁ”v®s
 &
	gi
);

2788 
	g‹m¶©e
 <
ty³Çme
 
	gF
>

2789 
	$™”©e_mayb”w_back_to
(

2790 
boŞ
 
ec_poŞ
,

2791 
•och_t
 
Ës
,

2792 
F
 &&
f
) const {

2793 
	`as£¹
(
·¡_š‹rv®s
);

2794 
·¡_š‹rv®s
->
	`™”©e_mayb”w_back_to
(
ec_poŞ
, 
Ës
, 
¡d
::
fÜw¬d
<
F
>(
f
));

2795 
	}
}

2796 
	$ş—r
() {

2797 
	`as£¹
(
·¡_š‹rv®s
);

2798 
·¡_š‹rv®s
->
	`ş—r
();

2799 
	}
}

2805 
size_t
 
	$size
() const {

2806 
	`as£¹
(
·¡_š‹rv®s
);

2807  
·¡_š‹rv®s
->
	`size
();

2808 
	}
}

2810 
boŞ
 
	$em±y
() const {

2811 
	`as£¹
(
·¡_š‹rv®s
);

2812  
·¡_š‹rv®s
->
	`em±y
();

2813 
	}
}

2815 
	$sw­
(
Pa¡IÁ”v®s
 &
Ùh”
) {

2816 
usšg
 
¡d
::
sw­
;

2817 
	`sw­
(
Ùh”
.
·¡_š‹rv®s
,…ast_intervals);

2818 
	}
}

2824 
	g£t
<
	gpg_sh¬d_t
> 
	$g‘_might_have_unfound
(

2825 
pg_sh¬d_t
 
pg_whßmi
,

2826 
boŞ
 
ec_poŞ
) const {

2827 
	`as£¹
(
·¡_š‹rv®s
);

2828 autØ
»t
 = 
·¡_š‹rv®s
->
	`g‘_®l_·¹icªts
(
ec_poŞ
);

2829 
»t
.
	`”a£
(
pg_whßmi
);

2830  
»t
;

2831 
	}
}

2836 
	g£t
<
	gpg_sh¬d_t
> 
	$g‘_®l_´obe
(

2837 
boŞ
 
ec_poŞ
) const {

2838 
	`as£¹
(
·¡_š‹rv®s
);

2839  
·¡_š‹rv®s
->
	`g‘_®l_·¹icªts
(
ec_poŞ
);

2840 
	}
}

2845 
	g·œ
<
	g•och_t
,ƒpoch_t> 
	$g‘_bounds
() const {

2846 
	`as£¹
(
·¡_š‹rv®s
);

2847  
·¡_š‹rv®s
->
	`g‘_bounds
();

2848 
	}
}

2850 
	eosd_¡©e_t
 {

2851 
	gUP
,

2852 
	gDOWN
,

2853 
	gDNE
,

2854 
	gLOST


2856 
	sPriÜS‘
 {

2857 
boŞ
 
	gec_poŞ
 = 
çl£
;

2858 
	g£t
<
	gpg_sh¬d_t
> 
	g´obe
;

2859 
	g£t
<> 
	gdown
;

2860 
	gm­
<, 
	g•och_t
> 
	gblocked_by
;

2862 
boŞ
 
	gpg_down
 = 
çl£
;

2863 
	gunique_±r
<
	gIsPGRecov”abËP»diÿ‹
> 
	gpcÚtdec
;

2865 
PriÜS‘
() = ;

2866 
PriÜS‘
(PriorSet &&) = ;

2867 
	gPriÜS‘
 &
	gİ”©Ü
=(
PriÜS‘
 &&) = ;

2869 
	gPriÜS‘
 &
	gİ”©Ü
=(cÚ¡ 
PriÜS‘
 &èğ
d–‘e
;

2870 
PriÜS‘
(cÚ¡ PriÜS‘ &èğ
d–‘e
;

2872 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
PriÜS‘
 &
rhs
) const {

2873  (
ec_poŞ
 =ğ
rhs
.ec_pool) &&

2874 (
´obe
 =ğ
rhs
.probe) &&

2875 (
down
 =ğ
rhs
.down) &&

2876 (
blocked_by
 =ğ
rhs
.blocked_by) &&

2877 (
pg_down
 =ğ
rhs
.pg_down);

2880 
boŞ
 
afãùed_by_m­
(

2881 cÚ¡ 
OSDM­
 &
osdm­
,

2882 cÚ¡ 
DoutP»fixProvid”
 *
dµ
) const;

2885 
PriÜS‘
(

2886 
boŞ
 
ec_poŞ
,

2887 
£t
<
pg_sh¬d_t
> 
´obe
,

2888 
£t
<> 
down
,

2889 
m­
<, 
•och_t
> 
blocked_by
,

2890 
boŞ
 
pg_down
,

2891 
IsPGRecov”abËP»diÿ‹
 *
pcÚtdec
)

2892 : 
ec_poŞ
Óc_poŞ), 
´obe
Õrobe), 
down
(down), 
blocked_by
(blocked_by),

2893 
pg_down
Õg_down), 
pcÚtdec
(pcontdec) {}

2895 
	g´iv©e
:

2896 
‹m¶©e
 <
ty³Çme
 
F
>

2897 
PriÜS‘
(

2898 cÚ¡ 
Pa¡IÁ”v®s
 &
·¡_š‹rv®s
,

2899 
boŞ
 
ec_poŞ
,

2900 
•och_t
 
Ï¡_•och_¡¬‹d
,

2901 
IsPGRecov”abËP»diÿ‹
 *
c
,

2902 
F
 
f
,

2903 cÚ¡ 
veùÜ
<> &
up
,

2904 cÚ¡ 
veùÜ
<> &
aùšg
,

2905 cÚ¡ 
DoutP»fixProvid”
 *
dµ
);

2907 
ä›nd
 
şass
 
	gPa¡IÁ”v®s
;

2910 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

2911 
PriÜS‘
 
	$g‘_´iÜ_£t
(
Args
&&... 
¬gs
) const {

2912  
	`PriÜS‘
(*
this
, 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

2913 
	}
}

2915 
	$WRITE_CLASS_ENCODER
(
Pa¡IÁ”v®s
)

2917 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
Pa¡IÁ”v®s
::
pg_š‹rv®_t
& 
i
);

2918 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
Pa¡IÁ”v®s
 &
i
);

2919 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
Pa¡IÁ”v®s
::
PriÜS‘
 &
i
);

2921 
‹m¶©e
 <
ty³Çme
 
F
>

2922 
Pa¡IÁ”v®s
::
PriÜS‘
::
	`PriÜS‘
(

2923 cÚ¡ 
Pa¡IÁ”v®s
 &
·¡_š‹rv®s
,

2924 
boŞ
 
ec_poŞ
,

2925 
•och_t
 
Ï¡_•och_¡¬‹d
,

2926 
IsPGRecov”abËP»diÿ‹
 *
c
,

2927 
F
 
f
,

2928 cÚ¡ 
veùÜ
<> &
up
,

2929 cÚ¡ 
veùÜ
<> &
aùšg
,

2930 cÚ¡ 
DoutP»fixProvid”
 *
dµ
)

2931 : 
	`ec_poŞ
(
ec_poŞ
), 
	`pg_down
(
çl£
), 
	$pcÚtdec
(
c
)

2980 
i
 = 0; i < 
aùšg
.
	`size
(); i++) {

2981 ià(
aùšg
[
i
] != 0x7fffffff )

2982 
´obe
.
	`š£¹
(
	`pg_sh¬d_t
(
aùšg
[
i
], 
ec_poŞ
 ? 
	`sh¬d_id_t
(iè: 
sh¬d_id_t
::
NO_SHARD
));

2986 
i
 = 0; i < 
up
.
	`size
(); i++) {

2987 ià(
up
[
i
] != 0x7fffffff )

2988 
´obe
.
	`š£¹
(
	`pg_sh¬d_t
(
up
[
i
], 
ec_poŞ
 ? 
	`sh¬d_id_t
(iè: 
sh¬d_id_t
::
NO_SHARD
));

2991 
£t
<
pg_sh¬d_t
> 
®l_´obe
 = 
·¡_š‹rv®s
.
	`g‘_®l_´obe
(
ec_poŞ
);

2992 
	`ldµ_dout
(
dµ
, 10è<< "bud_´iÜ‡Î_´ob" << 
®l_´obe
 << 
d’dl
;

2993 autØ&&
i
: 
®l_´obe
) {

2994 
	`f
(0, 
i
.
osd
, 
nuÎ±r
)) {

2995 
UP
: {

2996 
´obe
.
	`š£¹
(
i
);

2999 
DNE
:

3000 
LOST
:

3001 
DOWN
: {

3002 
down
.
	`š£¹
(
i
.
osd
);

3008 
·¡_š‹rv®s
.
	`™”©e_mayb”w_back_to
(

3009 
ec_poŞ
,

3010 
Ï¡_•och_¡¬‹d
,

3011 [&](
•och_t
 
¡¬t
, cÚ¡ 
£t
<
pg_sh¬d_t
> &
aùšg
) {

3012 
	`ldµ_dout
(
dµ
, 10è<< "bud_´iÜ maybe_rw iÁ”v®:" << 
¡¬t


3013 << ",‡ùšg: " << 
aùšg
 << 
d’dl
;

3018 
£t
<
pg_sh¬d_t
> 
up_now
;

3019 
m­
<, 
•och_t
> 
ÿndid©e_blocked_by
;

3021 
boŞ
 
ªy_down_now
 = 
çl£
;

3024 autØ&&
so
: 
aùšg
) {

3025 
•och_t
 
lo¡_©
 = 0;

3026 
	`f
(
¡¬t
, 
so
.
osd
, &
lo¡_©
)) {

3027 
UP
: {

3029 
up_now
.
	`š£¹
(
so
);

3032 
DNE
: {

3033 
	`ldµ_dout
(
dµ
, 10è<< "bud_´iÜ…riÜ osd." << 
so
.
osd


3034 << "‚ØlÚg”ƒxi¡s" << 
d’dl
;

3037 
LOST
: {

3038 
	`ldµ_dout
(
dµ
, 10è<< "bud_´iÜ…riÜ osd." << 
so
.
osd


3039 << " i down, buˆlo¡_© " << 
lo¡_©
 << 
d’dl
;

3040 
up_now
.
	`š£¹
(
so
);

3043 
DOWN
: {

3044 
	`ldµ_dout
(
dµ
, 10è<< "bud_´iÜ…riÜ osd." << 
so
.
osd


3045 << " i down" << 
d’dl
;

3046 
ÿndid©e_blocked_by
[
so
.
osd
] = 
lo¡_©
;

3047 
ªy_down_now
 = 
Œue
;

3056 ià(!(*
pcÚtdec
)(
up_now
è&& 
ªy_down_now
) {

3058 
	`ldµ_dout
(
dµ
, 10) << "build_prior…ossibly went‡ctive+rw,"

3059 << " insuffic›Á up; inşudšg dowÀosds" << 
d’dl
;

3060 
	`as£¹
(!
ÿndid©e_blocked_by
.
	`em±y
());

3061 
pg_down
 = 
Œue
;

3062 
blocked_by
.
	`š£¹
(

3063 
ÿndid©e_blocked_by
.
	`begš
(),

3064 
ÿndid©e_blocked_by
.
	`’d
());

3068 
	`ldµ_dout
(
dµ
, 10è<< "bud_´iÜ fš®:…rob" << 
´obe


3069 << " dowÀ" << 
down


3070 << " blocked_by " << 
blocked_by


3071 << (
pg_down
 ? "…g_down":"")

3072 << 
d’dl
;

3073 
	}
}

3080 
	spg_qu”y_t
 {

3082 
	mINFO
 = 0,

3083 
	mLOG
 = 1,

3084 
	mMISSING
 = 4,

3085 
	mFULLLOG
 = 5,

3087 cÚ¡ *
g‘_ty³_Çme
() const {

3088 
	mty³
) {

3089 
	mINFO
:  "info";

3090 
	mLOG
:  "log";

3091 
	mMISSING
:  "missing";

3092 
	mFULLLOG
:  "fulllog";

3097 
__s32
 
	mty³
;

3098 
ev”siÚ_t
 
	msšû
;

3099 
pg_hi¡Üy_t
 
	mhi¡Üy
;

3100 
•och_t
 
	m•och_£Á
;

3101 
sh¬d_id_t
 
	mto
;

3102 
sh¬d_id_t
 
	mäom
;

3104 
pg_qu”y_t
(è: 
ty³
(-1), 
•och_£Á
(0), 
to
(
sh¬d_id_t
::
NO_SHARD
),

3105 
äom
(
sh¬d_id_t
::
NO_SHARD
) {}

3106 
pg_qu”y_t
(

3107 
t
,

3108 
sh¬d_id_t
 
to
,

3109 
sh¬d_id_t
 
äom
,

3110 cÚ¡ 
pg_hi¡Üy_t
& 
h
,

3111 
•och_t
 
•och_£Á
)

3112 : 
ty³
(
t
),

3113 
hi¡Üy
(
h
),

3114 
•och_£Á
(epoch_sent),

3115 
to
Ño), 
äom
(from) {

3116 
as£¹
(
t
 !ğ
LOG
);

3118 
pg_qu”y_t
(

3119 
t
,

3120 
sh¬d_id_t
 
to
,

3121 
sh¬d_id_t
 
äom
,

3122 
ev”siÚ_t
 
s
,

3123 cÚ¡ 
pg_hi¡Üy_t
& 
h
,

3124 
•och_t
 
•och_£Á
)

3125 : 
ty³
(
t
), 
sšû
(
s
), 
hi¡Üy
(
h
),

3126 
•och_£Á
Ópoch_£Á), 
to
Ño), 
äom
(from) {

3127 
as£¹
(
t
 =ğ
LOG
);

3130 
’code
(
bufã¾i¡
 &
bl
, 
ušt64_t
 
ã©u»s
) const;

3131 
decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

3133 
dump
(
FÜm©‹r
 *
f
) const;

3134 
g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_qu”y_t
*>& 
o
);

3136 
	$WRITE_CLASS_ENCODER_FEATURES
(
pg_qu”y_t
)

3138 
šlše
 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
pg_qu”y_t
& 
q
) {

3139 
out
 << "qu”y(" << 
q
.
	`g‘_ty³_Çme
(è<< " " << q.
sšû
;

3140 ià(
q
.
ty³
 =ğ
pg_qu”y_t
::
LOG
)

3141 
out
 << " " << 
q
.
hi¡Üy
;

3142 
out
 << "ƒpoch_£Á " << 
q
.
•och_£Á
;

3143 
out
 << ")";

3144  
out
;

3145 
	}
}

3147 
şass
 
	gPGBack’d
;

3148 şas 
	cObjeùModDesc
 {

3149 
boŞ
 
	mÿn_loÿl_rŞlback
;

3150 
boŞ
 
	mrŞlback_šfo_com¶‘ed
;

3153 
__u8
 
	mmax_»quœed_v”siÚ
 = 1;

3154 
	mpublic
:

3155 şas 
	cVis™Ü
 {

3156 
public
:

3157 
vœtu®
 
­³nd
(
ušt64_t
 
Şd_off£t
) {}

3158 
vœtu®
 
£‰rs
(
m­
<
¡ršg
, 
boo¡
::
İtiÚ®
<
bufã¾i¡
> > &
©Œs
) {}

3159 
vœtu®
 
rmobjeù
(
v”siÚ_t
 
Şd_v”siÚ
) {}

3166 
vœtu®
 
Œy_rmobjeù
(
v”siÚ_t
 
Şd_v”siÚ
) {

3167 
rmobjeù
(
Şd_v”siÚ
);

3169 
vœtu®
 
ü—‹
() {}

3170 
vœtu®
 
upd©e_¢­s
(cÚ¡ 
£t
<
¢­id_t
> &
Şd_¢­s
) {}

3171 
vœtu®
 
rŞlback_ex‹Ás
(

3172 
v”siÚ_t
 
g’
,

3173 cÚ¡ 
veùÜ
<
·œ
<
ušt64_t
, ušt64_t> > &
ex‹Ás
) {}

3174 
	mvœtu®
 ~
Vis™Ü
() {}

3176 
	$vis™
(
Vis™Ü
 *
vis™Ü
) const;

3177 
mubË
 
bufã¾i¡
 
bl
;

3178 
	eModID
 {

3179 
APPEND
 = 1,

3180 
SETATTRS
 = 2,

3181 
DELETE
 = 3,

3182 
CREATE
 = 4,

3183 
UPDATE_SNAPS
 = 5,

3184 
TRY_DELETE
 = 6,

3185 
ROLLBACK_EXTENTS
 = 7

3186 
	}
};

3187 
	$ObjeùModDesc
(è: 
	`ÿn_loÿl_rŞlback
(
Œue
), 
	$rŞlback_šfo_com¶‘ed
(
çl£
) {

3188 
bl
.
	`»assign_to_mempoŞ
(
mempoŞ
::
mempoŞ_osd_pglog
);

3189 
	}
}

3190 
	$şaim
(
ObjeùModDesc
 &
Ùh”
) {

3191 
bl
.
	`ş—r
();

3192 
bl
.
	`şaim
(
Ùh”
.bl);

3193 
ÿn_loÿl_rŞlback
 = 
Ùh”
.can_local_rollback;

3194 
rŞlback_šfo_com¶‘ed
 = 
Ùh”
.rollback_info_completed;

3195 
	}
}

3196 
	$şaim_­³nd
(
ObjeùModDesc
 &
Ùh”
) {

3197 ià(!
ÿn_loÿl_rŞlback
 || 
rŞlback_šfo_com¶‘ed
)

3199 ià(!
Ùh”
.
ÿn_loÿl_rŞlback
) {

3200 
	`m¬k_uÄŞlbackabË
();

3203 
bl
.
	`şaim_­³nd
(
Ùh”
.bl);

3204 
rŞlback_šfo_com¶‘ed
 = 
Ùh”
.rollback_info_completed;

3205 
	}
}

3206 
	$sw­
(
ObjeùModDesc
 &
Ùh”
) {

3207 
bl
.
	`sw­
(
Ùh”
.bl);

3209 
usšg
 
¡d
::
sw­
;

3210 
	`sw­
(
Ùh”
.
ÿn_loÿl_rŞlback
, can_local_rollback);

3211 
	`sw­
(
Ùh”
.
rŞlback_šfo_com¶‘ed
,„ollback_info_completed);

3212 
	`sw­
(
Ùh”
.
max_»quœed_v”siÚ
, max_required_version);

3213 
	}
}

3214 
	$­³nd_id
(
ModID
 
id
) {

3215 
usšg
 
ûph
::
’code
;

3216 
ušt8_t
 
	`_id
(
id
);

3217 
	`’code
(
_id
, 
bl
);

3218 
	}
}

3219 
	$­³nd
(
ušt64_t
 
Şd_size
) {

3220 ià(!
ÿn_loÿl_rŞlback
 || 
rŞlback_šfo_com¶‘ed
)

3222 
	`ENCODE_START
(1, 1, 
bl
);

3223 
	`­³nd_id
(
APPEND
);

3224 
	`’code
(
Şd_size
, 
bl
);

3225 
	`ENCODE_FINISH
(
bl
);

3226 
	}
}

3227 
£‰rs
(
m­
<
¡ršg
, 
boo¡
::
İtiÚ®
<
bufã¾i¡
> > &
Şd_©Œs
) {

3228 ià(!
ÿn_loÿl_rŞlback
 || 
rŞlback_šfo_com¶‘ed
)

3230 
ENCODE_START
(1, 1, 
bl
);

3231 
­³nd_id
(
SETATTRS
);

3232 
’code
(
Şd_©Œs
, 
bl
);

3233 
ENCODE_FINISH
(
bl
);

3235 
boŞ
 
	$rmobjeù
(
v”siÚ_t
 
d–‘iÚ_v”siÚ
) {

3236 ià(!
ÿn_loÿl_rŞlback
 || 
rŞlback_šfo_com¶‘ed
)

3237  
çl£
;

3238 
	`ENCODE_START
(1, 1, 
bl
);

3239 
	`­³nd_id
(
DELETE
);

3240 
	`’code
(
d–‘iÚ_v”siÚ
, 
bl
);

3241 
	`ENCODE_FINISH
(
bl
);

3242 
rŞlback_šfo_com¶‘ed
 = 
Œue
;

3243  
Œue
;

3244 
	}
}

3245 
boŞ
 
	$Œy_rmobjeù
(
v”siÚ_t
 
d–‘iÚ_v”siÚ
) {

3246 ià(!
ÿn_loÿl_rŞlback
 || 
rŞlback_šfo_com¶‘ed
)

3247  
çl£
;

3248 
	`ENCODE_START
(1, 1, 
bl
);

3249 
	`­³nd_id
(
TRY_DELETE
);

3250 
	`’code
(
d–‘iÚ_v”siÚ
, 
bl
);

3251 
	`ENCODE_FINISH
(
bl
);

3252 
rŞlback_šfo_com¶‘ed
 = 
Œue
;

3253  
Œue
;

3254 
	}
}

3255 
	$ü—‹
() {

3256 ià(!
ÿn_loÿl_rŞlback
 || 
rŞlback_šfo_com¶‘ed
)

3258 
rŞlback_šfo_com¶‘ed
 = 
Œue
;

3259 
	`ENCODE_START
(1, 1, 
bl
);

3260 
	`­³nd_id
(
CREATE
);

3261 
	`ENCODE_FINISH
(
bl
);

3262 
	}
}

3263 
upd©e_¢­s
(cÚ¡ 
£t
<
¢­id_t
> &
Şd_¢­s
) {

3264 ià(!
	gÿn_loÿl_rŞlback
 || 
	grŞlback_šfo_com¶‘ed
)

3266 
ENCODE_START
(1, 1, 
bl
);

3267 
­³nd_id
(
UPDATE_SNAPS
);

3268 
’code
(
Şd_¢­s
, 
bl
);

3269 
ENCODE_FINISH
(
bl
);

3271 
rŞlback_ex‹Ás
(

3272 
v”siÚ_t
 
g’
, cÚ¡ 
veùÜ
<
·œ
<
ušt64_t
, ušt64_t> > &
ex‹Ás
) {

3273 
as£¹
(
ÿn_loÿl_rŞlback
);

3274 
as£¹
(!
rŞlback_šfo_com¶‘ed
);

3275 ià(
	gmax_»quœed_v”siÚ
 < 2)

3276 
	gmax_»quœed_v”siÚ
 = 2;

3277 
ENCODE_START
(2, 2, 
bl
);

3278 
­³nd_id
(
ROLLBACK_EXTENTS
);

3279 
’code
(
g’
, 
bl
);

3280 
’code
(
ex‹Ás
, 
bl
);

3281 
ENCODE_FINISH
(
bl
);

3285 
	$m¬k_uÄŞlbackabË
() {

3286 
ÿn_loÿl_rŞlback
 = 
çl£
;

3287 
bl
.
	`ş—r
();

3288 
	}
}

3289 
boŞ
 
	$ÿn_rŞlback
() const {

3290  
ÿn_loÿl_rŞlback
;

3291 
	}
}

3292 
boŞ
 
	$em±y
() const {

3293  
ÿn_loÿl_rŞlback
 && (
bl
.
	`Ëngth
() == 0);

3294 
	}
}

3296 
boŞ
 
	$»quœes_k¿k’
() const {

3297  
max_»quœed_v”siÚ
 >= 2;

3298 
	}
}

3305 
	$Œim_bl
() const {

3306 ià(
bl
.
	`Ëngth
() > 0)

3307 
bl
.
	`»bud
();

3308 
	}
}

3309 
	$’code
(
bufã¾i¡
 &
bl
) const;

3310 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

3311 
	$dump
(
FÜm©‹r
 *
f
) const;

3312 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
ObjeùModDesc
*>& 
o
);

3313 
	}
};

3314 
	$WRITE_CLASS_ENCODER
(
ObjeùModDesc
)

3321 
	spg_log_’Œy_t
 {

3323 
MODIFY
 = 1,

3324 
CLONE
 = 2,

3325 
DELETE
 = 3,

3327 
LOST_REVERT
 = 5,

3328 
LOST_DELETE
 = 6,

3329 
LOST_MARK
 = 7,

3330 
PROMOTE
 = 8,

3331 
CLEAN
 = 9,

3332 
ERROR
 = 10,

3334 cÚ¡ *
	`g‘_İ_Çme
(
İ
) {

3335 
İ
) {

3336 
MODIFY
:

3338 
PROMOTE
:

3340 
CLONE
:

3342 
DELETE
:

3344 
LOST_REVERT
:

3346 
LOST_DELETE
:

3348 
LOST_MARK
:

3350 
CLEAN
:

3352 
ERROR
:

3358 cÚ¡ *
	`g‘_İ_Çme
() const {

3359  
	`g‘_İ_Çme
(
İ
);

3363 
ObjeùModDesc
 
mod_desc
;

3364 
bufã¾i¡
 
¢­s
;

3365 
hobjeù_t
 
soid
;

3366 
osd_»qid_t
 
»qid
;

3367 
mempoŞ
::
osd_pglog
::
veùÜ
<
·œ
<
osd_»qid_t
, 
v”siÚ_t
> > 
exŒa_»qids
;

3368 
ev”siÚ_t
 
v”siÚ
, 
´iÜ_v”siÚ
, 
»v”tšg_to
;

3369 
v”siÚ_t
 
u£r_v”siÚ
;

3370 
utime_t
 
mtime
;

3371 
št32_t
 
»tuº_code
;

3373 
__s32
 
İ
;

3374 
boŞ
 
šv®id_hash
;

3375 
boŞ
 
šv®id_poŞ
;

3377 
	`pg_log_’Œy_t
()

3378 : 
	`u£r_v”siÚ
(0), 
	`»tuº_code
(0), 
	`İ
(0),

3379 
	`šv®id_hash
(
çl£
), 
	`šv®id_poŞ
(false) {

3380 
¢­s
.
	`»assign_to_mempoŞ
(
mempoŞ
::
mempoŞ_osd_pglog
);

3382 
	`pg_log_’Œy_t
(
_İ
, cÚ¡ 
hobjeù_t
& 
_soid
,

3383 cÚ¡ 
ev”siÚ_t
& 
v
, cÚ¡ƒv”siÚ_t& 
pv
,

3384 
v”siÚ_t
 
uv
,

3385 cÚ¡ 
osd_»qid_t
& 
rid
, cÚ¡ 
utime_t
& 
mt
,

3386 
»tuº_code
)

3387 : 
	`soid
(
_soid
), 
	`»qid
(
rid
), 
	`v”siÚ
(
v
), 
	`´iÜ_v”siÚ
(
pv
), 
	`u£r_v”siÚ
(
uv
),

3388 
	`mtime
(
mt
), 
	`»tuº_code
(
»tuº_code
), 
	`İ
(
_İ
),

3389 
	`šv®id_hash
(
çl£
), 
	`šv®id_poŞ
(false) {

3390 
¢­s
.
	`»assign_to_mempoŞ
(
mempoŞ
::
mempoŞ_osd_pglog
);

3393 
boŞ
 
	`is_şÚe
(ècÚ¡ {  
İ
 =ğ
CLONE
; }

3394 
boŞ
 
	`is_modify
(ècÚ¡ {  
İ
 =ğ
MODIFY
; }

3395 
boŞ
 
	`is_´omÙe
(ècÚ¡ {  
İ
 =ğ
PROMOTE
; }

3396 
boŞ
 
	`is_ş—n
(ècÚ¡ {  
İ
 =ğ
CLEAN
; }

3397 
boŞ
 
	`is_lo¡_»v”t
(ècÚ¡ {  
İ
 =ğ
LOST_REVERT
; }

3398 
boŞ
 
	`is_lo¡_d–‘e
(ècÚ¡ {  
İ
 =ğ
LOST_DELETE
; }

3399 
boŞ
 
	`is_lo¡_m¬k
(ècÚ¡ {  
İ
 =ğ
LOST_MARK
; }

3400 
boŞ
 
	`is_”rÜ
(ècÚ¡ {  
İ
 =ğ
ERROR
; }

3402 
boŞ
 
	`is_upd©e
() const {

3404 
	`is_şÚe
(è|| 
	`is_modify
(è|| 
	`is_´omÙe
(è|| 
	`is_ş—n
() ||

3405 
	`is_lo¡_»v”t
(è|| 
	`is_lo¡_m¬k
();

3407 
boŞ
 
	`is_d–‘e
() const {

3408  
İ
 =ğ
DELETE
 || o°=ğ
LOST_DELETE
;

3411 
boŞ
 
	`ÿn_rŞlback
() const {

3412  
mod_desc
.
	`ÿn_rŞlback
();

3415 
	`m¬k_uÄŞlbackabË
() {

3416 
mod_desc
.
	`m¬k_uÄŞlbackabË
();

3419 
boŞ
 
	`»quœes_k¿k’
() const {

3420  
mod_desc
.
	`»quœes_k¿k’
();

3427 
boŞ
 
	`objeù_is_šdexed
() const {

3428  !
	`is_”rÜ
();

3431 
boŞ
 
	`»qid_is_šdexed
() const {

3432  
»qid
 !ğ
	`osd_»qid_t
() &&

3433 (
İ
 =ğ
MODIFY
 || o°=ğ
DELETE
 || o°=ğ
ERROR
);

3436 
¡ršg
 
	`g‘_key_Çme
() const;

3437 
	`’code_w™h_checksum
(
bufã¾i¡
& 
bl
) const;

3438 
	`decode_w™h_checksum
(
bufã¾i¡
::
™”©Ü
& 
p
);

3440 
	`’code
(
bufã¾i¡
 &
bl
) const;

3441 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

3442 
	`dump
(
FÜm©‹r
 *
f
) const;

3443 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_log_’Œy_t
*>& 
o
);

3446 
	$WRITE_CLASS_ENCODER
(
pg_log_’Œy_t
)

3448 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
pg_log_’Œy_t
& 
e
);

3450 
	spg_log_dup_t
 {

3451 
osd_»qid_t
 
»qid
;

3452 
ev”siÚ_t
 
v”siÚ
;

3453 
v”siÚ_t
 
u£r_v”siÚ
;

3454 
št32_t
 
»tuº_code
;

3456 
	`pg_log_dup_t
()

3457 : 
	`u£r_v”siÚ
(0), 
	`»tuº_code
(0)

3459 
ex¶ic™
 
	`pg_log_dup_t
(cÚ¡ 
pg_log_’Œy_t
& 
’Œy
)

3460 : 
	`»qid
(
’Œy
.
»qid
), 
	`v”siÚ
ÓÁry.
v”siÚ
),

3461 
	`u£r_v”siÚ
(
’Œy
.
u£r_v”siÚ
), 
	`»tuº_code
ÓÁry.
»tuº_code
)

3463 
	`pg_log_dup_t
(cÚ¡ 
ev”siÚ_t
& 
v
, 
v”siÚ_t
 
uv
,

3464 cÚ¡ 
osd_»qid_t
& 
rid
, 
»tuº_code
)

3465 : 
	`»qid
(
rid
), 
	`v”siÚ
(
v
), 
	`u£r_v”siÚ
(
uv
),

3466 
	`»tuº_code
(
»tuº_code
)

3469 
¡ršg
 
	`g‘_key_Çme
() const;

3470 
	`’code
(
bufã¾i¡
 &
bl
) const;

3471 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

3472 
	`dump
(
FÜm©‹r
 *
f
) const;

3473 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_log_dup_t
*>& 
o
);

3475 
boŞ
 
İ”©Ü
==(cÚ¡ 
pg_log_dup_t
 &
rhs
) const {

3476  
»qid
 =ğ
rhs
.reqid &&

3477 
v”siÚ
 =ğ
rhs
.version &&

3478 
u£r_v”siÚ
 =ğ
rhs
.user_version &&

3479 
»tuº_code
 =ğ
rhs
.return_code;

3481 
boŞ
 
İ”©Ü
!=(cÚ¡ 
pg_log_dup_t
 &
rhs
) const {

3482  !(*
this
 =ğ
rhs
);

3485 
ä›nd
 
¡d
::
o¡»am
& 
İ”©Ü
<<(¡d::o¡»am& 
out
, cÚ¡ 
pg_log_dup_t
& 
e
);

3487 
	$WRITE_CLASS_ENCODER
(
pg_log_dup_t
)

3489 
¡d
::
o¡»am
& 
İ”©Ü
<<(¡d::o¡»am& 
out
, cÚ¡ 
pg_log_dup_t
& 
e
);

3496 
	spg_log_t
 {

3503 
ev”siÚ_t
 
h—d
;

3504 
ev”siÚ_t
 

;

3506 
´Ùeùed
:

3508 
ev”siÚ_t
 
ÿn_rŞlback_to
;

3512 
ev”siÚ_t
 
rŞlback_šfo_Œimmed_to
;

3514 
public
:

3516 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> 
log
;

3519 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_dup_t
> 
dups
;

3521 
	`pg_log_t
() = ;

3522 
	`pg_log_t
(cÚ¡ 
ev”siÚ_t
 &
Ï¡_upd©e
,

3523 cÚ¡ 
ev”siÚ_t
 &
log_
,

3524 cÚ¡ 
ev”siÚ_t
 &
ÿn_rŞlback_to
,

3525 cÚ¡ 
ev”siÚ_t
 &
rŞlback_šfo_Œimmed_to
,

3526 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> &&
’Œ›s
,

3527 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_dup_t
> &&
dup_’Œ›s
)

3528 : 
	`h—d
(
Ï¡_upd©e
), 
	`
(
log_
), 
	`ÿn_rŞlback_to
(
ÿn_rŞlback_to
),

3529 
	`rŞlback_šfo_Œimmed_to
(
rŞlback_šfo_Œimmed_to
),

3530 
	`log
(
¡d
::
	`move
(
’Œ›s
)), 
	`dups
(¡d::move(
dup_’Œ›s
)) {}

3531 
	`pg_log_t
(cÚ¡ 
ev”siÚ_t
 &
Ï¡_upd©e
,

3532 cÚ¡ 
ev”siÚ_t
 &
log_
,

3533 cÚ¡ 
ev”siÚ_t
 &
ÿn_rŞlback_to
,

3534 cÚ¡ 
ev”siÚ_t
 &
rŞlback_šfo_Œimmed_to
,

3535 cÚ¡ 
¡d
::
li¡
<
pg_log_’Œy_t
> &
’Œ›s
,

3536 cÚ¡ 
¡d
::
li¡
<
pg_log_dup_t
> &
dup_’Œ›s
)

3537 : 
	`h—d
(
Ï¡_upd©e
), 
	`
(
log_
), 
	`ÿn_rŞlback_to
(
ÿn_rŞlback_to
),

3538 
	`rŞlback_šfo_Œimmed_to
(
rŞlback_šfo_Œimmed_to
) {

3539 autØ&&
’Œy
: 
’Œ›s
) {

3540 
log
.
	`push_back
(
’Œy
);

3542 autØ&&
’Œy
: 
dup_’Œ›s
) {

3543 
dups
.
	`push_back
(
’Œy
);

3547 
	`ş—r
() {

3548 
ev”siÚ_t
 
z
;

3549 
rŞlback_šfo_Œimmed_to
 = 
ÿn_rŞlback_to
 = 
h—d
 = 

 = 
z
;

3550 
log
.
	`ş—r
();

3551 
dups
.
	`ş—r
();

3554 
ev”siÚ_t
 
	`g‘_rŞlback_šfo_Œimmed_to
() const {

3555  
rŞlback_šfo_Œimmed_to
;

3557 
ev”siÚ_t
 
	`g‘_ÿn_rŞlback_to
() const {

3558  
ÿn_rŞlback_to
;

3562 
pg_log_t
 
	`¥l™_out_chd
(
pg_t
 
chd_pgid
, 
¥l™_b™s
) {

3563 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> 
Şdlog
, 
chdlog
;

3564 
Şdlog
.
	`sw­
(
log
);

3566 
ev”siÚ_t
 
Şd_
;

3567 
mask
 = ~((~0)<<
¥l™_b™s
);

3568 autØ
i
 = 
Şdlog
.
	`begš
();

3569 
i
 !ğ
Şdlog
.
	`’d
();

3571 ià((
i
->
soid
.
	`g‘_hash
(è& 
mask
è=ğ
chd_pgid
.
m_£ed
) {

3572 
chdlog
.
	`push_back
(*
i
);

3574 
log
.
	`push_back
(*
i
);

3576 
Şdlog
.
	`”a£
(
i
++);

3582 autØ
	`chddups
(
dups
);

3584  
	`pg_log_t
(

3585 
h—d
,

3586 

,

3587 
ÿn_rŞlback_to
,

3588 
rŞlback_šfo_Œimmed_to
,

3589 
¡d
::
	`move
(
chdlog
),

3590 
¡d
::
	`move
(
chddups
));

3593 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> 
	`»wšd_äom_h—d
(
ev”siÚ_t
 
Ãwh—d
) {

3594 
	`as£¹
(
Ãwh—d
 >ğ

);

3596 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
>::
™”©Ü
 
p
 = 
log
.
	`’d
();

3597 
mempoŞ
::
osd_pglog
::
li¡
<
pg_log_’Œy_t
> 
div”g’t
;

3598 
Œue
) {

3599 ià(
p
 =ğ
log
.
	`begš
()) {

3601 
usšg
 
¡d
::
sw­
;

3602 
	`sw­
(
div”g’t
, 
log
);

3605 --
p
;

3606 ià(
p
->
v”siÚ
.v”siÚ <ğ
Ãwh—d
.version) {

3615 ++
p
;

3616 
div”g’t
.
	`¥liû
(div”g’t.
	`begš
(), 
log
, 
p
,†og.
	`’d
());

3619 
	`as£¹
(
p
->
v”siÚ
 > 
Ãwh—d
);

3621 
h—d
 = 
Ãwh—d
;

3623 ià(
ÿn_rŞlback_to
 > 
Ãwh—d
)

3624 
ÿn_rŞlback_to
 = 
Ãwh—d
;

3626 ià(
rŞlback_šfo_Œimmed_to
 > 
Ãwh—d
)

3627 
rŞlback_šfo_Œimmed_to
 = 
Ãwh—d
;

3629  
div”g’t
;

3632 
boŞ
 
	`em±y
() const {

3633  
log
.
	`em±y
();

3636 
boŞ
 
	`nuÎ
() const {

3637  
h—d
.
v”siÚ
 =ğ0 && h—d.
•och
 == 0;

3640 
size_t
 
	`­´ox_size
() const {

3641  
h—d
.
v”siÚ
 - 

.version;

3644 
	`f‹r_log
(
¥g_t
 
impÜt_pgid
, cÚ¡ 
OSDM­
 &
curm­
,

3645 cÚ¡ 
¡ršg
 &
h™_£t_Çme¥aû
, cÚ¡ 
pg_log_t
 &
š
,

3646 
pg_log_t
 &
out
,…g_log_ˆ&
»jeù
);

3654 
	`cİy_aá”
(cÚ¡ 
pg_log_t
 &
Ùh”
, 
ev”siÚ_t
 
äom
);

3663 
	`cİy_¿nge
(cÚ¡ 
pg_log_t
 &
Ùh”
, 
ev”siÚ_t
 
äom
,ƒv”siÚ_ˆ
to
);

3671 
	`cİy_up_to
(cÚ¡ 
pg_log_t
 &
Ùh”
, 
max
);

3673 
o¡»am
& 
	`´št
(o¡»am& 
out
) const;

3675 
	`’code
(
bufã¾i¡
 &
bl
) const;

3676 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
, 
št64_t
 
poŞ
 = -1);

3677 
	`dump
(
FÜm©‹r
 *
f
) const;

3678 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_log_t
*>& 
o
);

3680 
	$WRITE_CLASS_ENCODER
(
pg_log_t
)

3682 
šlše
 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
pg_log_t
& 
log
)

3684 
out
 << "log((" << 
log
.

 << "," <<†og.
h—d
 << "], crt="

3685 << 
log
.
	`g‘_ÿn_rŞlback_to
() << ")";

3686  
out
;

3687 
	}
}

3696 
	spg_missšg_™em
 {

3697 
ev”siÚ_t
 
	mÃed
, 
	mhave
;

3698 
	emissšg_æags_t
 {

3699 
	mFLAG_NONE
 = 0,

3700 
	mFLAG_DELETE
 = 1,

3701 } 
	mæags
;

3702 
pg_missšg_™em
(è: 
æags
(
FLAG_NONE
) {}

3703 
ex¶ic™
 
pg_missšg_™em
(
ev”siÚ_t
 
n
è: 
Ãed
Ò), 
æags
(
FLAG_NONE
) {}

3704 
pg_missšg_™em
(
ev”siÚ_t
 
n
,ƒv”siÚ_ˆ
h
, 
boŞ
 
is_d–‘e
=
çl£
è: 
Ãed
Ò), 
have
(h) {

3705 
£t_d–‘e
(
is_d–‘e
);

3708 
’code
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
) const {

3709 
usšg
 
	mûph
::
’code
;

3710 ià(
HAVE_FEATURE
(
ã©u»s
, 
OSD_RECOVERY_DELETES
)) {

3715 
ev”siÚ_t
 
	me
;

3716 
’code
(
e
, 
bl
);

3717 
’code
(
Ãed
, 
bl
);

3718 
’code
(
have
, 
bl
);

3719 
’code
(
¡©ic_ÿ¡
<
ušt8_t
>(
æags
), 
bl
);

3722 
’code
(
Ãed
, 
bl
);

3723 
’code
(
have
, 
bl
);

3726 
decode
(
bufã¾i¡
::
™”©Ü
& 
bl
) {

3727 
usšg
 
ûph
::
decode
;

3728 
ev”siÚ_t
 
	me
;

3729 
decode
(
e
, 
bl
);

3730 ià(
	me
 !ğ
ev”siÚ_t
()) {

3732 
Ãed
 = 
e
;

3733 
decode
(
have
, 
bl
);

3735 
decode
(
Ãed
, 
bl
);

3736 
decode
(
have
, 
bl
);

3737 
ušt8_t
 
	mf
;

3738 
decode
(
f
, 
bl
);

3739 
	mæags
 = 
¡©ic_ÿ¡
<
missšg_æags_t
>(
f
);

3743 
£t_d–‘e
(
boŞ
 
is_d–‘e
) {

3744 
	mæags
 = 
is_d–‘e
 ? 
FLAG_DELETE
 : 
FLAG_NONE
;

3747 
boŞ
 
is_d–‘e
() const {

3748  (
	mæags
 & 
	mFLAG_DELETE
è=ğ
FLAG_DELETE
;

3751 
¡ršg
 
æag_¡r
() const {

3752 ià(
	mæags
 =ğ
FLAG_NONE
) {

3759 
dump
(
FÜm©‹r
 *
f
) const {

3760 
	mf
->
dump_¡»am
("Ãed"è<< 
	mÃed
;

3761 
	mf
->
dump_¡»am
("have"è<< 
	mhave
;

3762 
	mf
->
dump_¡»am
("æags"è<< 
æag_¡r
();

3764 
g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_missšg_™em
*>& 
o
) {

3765 
	mo
.
push_back
(
Ãw
 
pg_missšg_™em
);

3766 
	mo
.
push_back
(
Ãw
 
pg_missšg_™em
);

3767 
	mo
.
back
()->
	mÃed
 = 
ev”siÚ_t
(1, 2);

3768 
	mo
.
back
()->
	mhave
 = 
ev”siÚ_t
(1, 1);

3769 
	mo
.
push_back
(
Ãw
 
pg_missšg_™em
);

3770 
	mo
.
back
()->
	mÃed
 = 
ev”siÚ_t
(3, 5);

3771 
	mo
.
back
()->
	mhave
 = 
ev”siÚ_t
(3, 4);

3772 
	mo
.
back
()->
	mæags
 = 
FLAG_DELETE
;

3774 
boŞ
 
	mİ”©Ü
==(cÚ¡ 
pg_missšg_™em
 &
rhs
) const {

3775  
Ãed
 =ğ
rhs
.Ãed && 
have
 =ğrhs.hav&& 
æags
 ==„hs.flags;

3777 
boŞ
 
	mİ”©Ü
!=(cÚ¡ 
pg_missšg_™em
 &
rhs
) const {

3778  !(*
this
 =ğ
rhs
);

3781 
	$WRITE_CLASS_ENCODER_FEATURES
(
pg_missšg_™em
)

3782 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
pg_missšg_™em
 &
™em
);

3784 şas 
	cpg_missšg_cÚ¡_i
 {

3785 
public
:

3786 
vœtu®
 cÚ¡ 
m­
<
hobjeù_t
, 
pg_missšg_™em
> &

3787 
	$g‘_™ems
() const = 0;

3788 
vœtu®
 cÚ¡ 
m­
<
v”siÚ_t
, 
hobjeù_t
> &
	$g‘_rmissšg
() const = 0;

3789 
vœtu®
 
boŞ
 
	$g‘_may_šşude_d–‘es
() const = 0;

3790 
vœtu®
 
	$num_missšg
() const = 0;

3791 
vœtu®
 
boŞ
 
	$have_missšg
() const = 0;

3792 
vœtu®
 
boŞ
 
	$is_missšg
(cÚ¡ 
hobjeù_t
& 
oid
, 
pg_missšg_™em
 *
out
 = 
nuÎ±r
) const = 0;

3793 
vœtu®
 
boŞ
 
	$is_missšg
(cÚ¡ 
hobjeù_t
& 
oid
, 
ev”siÚ_t
 
v
) const = 0;

3794 
vœtu®
 ~
	$pg_missšg_cÚ¡_i
() {}

3795 
	}
};

3798 
	g‹m¶©e
 <
boŞ
 
	gT¿ck
>

3799 şas 
	cChªgeT¿ck”
 {

3800 
	mpublic
:

3801 
	$chªged
(cÚ¡ 
hobjeù_t
 &
obj
) {}

3802 
‹m¶©e
 <
ty³Çme
 
F
>

3803 
	$g‘_chªged
(
F
 &&
f
ècÚ¡ {
	}
}

3804 
	$æush
(è{
	}
}

3805 
boŞ
 
	$is_ş—n
() const {

3806  
Œue
;

3807 
	}
}

3809 
	g‹m¶©e
 <>

3810 
şass
 
	gChªgeT¿ck”
<
	gŒue
> {

3811 
	g£t
<
	ghobjeù_t
> 
	g_chªged
;

3812 
	gpublic
:

3813 
chªged
(cÚ¡ 
hobjeù_t
 &
obj
) {

3814 
_chªged
.
š£¹
(
obj
);

3816 
	g‹m¶©e
 <
ty³Çme
 
	gF
>

3817 
g‘_chªged
(
F
 &&
f
) const {

3818 autØcÚ¡ &
	gi
: 
_chªged
) {

3819 
f
(
i
);

3822 
æush
() {

3823 
	g_chªged
.
ş—r
();

3825 
boŞ
 
is_ş—n
() const {

3826  
	g_chªged
.
em±y
();

3830 
	g‹m¶©e
 <
boŞ
 
	gT¿ckChªges
>

3831 şas 
	cpg_missšg_£t
 : 
public
 
pg_missšg_cÚ¡_i
 {

3832 
usšg
 
™em
 = 
pg_missšg_™em
;

3833 
	mm­
<
	mhobjeù_t
, 
	m™em
> 
	mmissšg
;

3834 
	mm­
<
	mv”siÚ_t
, 
	mhobjeù_t
> 
	mrmissšg
;

3835 
	mChªgeT¿ck”
<
	mT¿ckChªges
> 
	mŒack”
;

3837 
	mpublic
:

3838 
pg_missšg_£t
() = ;

3840 
	m‹m¶©e
 <
ty³Çme
 
	mmissšg_ty³
>

3841 
	$pg_missšg_£t
(cÚ¡ 
missšg_ty³
 &
m
) {

3842 
missšg
 = 
m
.
	`g‘_™ems
();

3843 
rmissšg
 = 
m
.
	`g‘_rmissšg
();

3844 
may_šşude_d–‘es
 = 
m
.
	`g‘_may_šşude_d–‘es
();

3845 autØ&&
i
: 
missšg
)

3846 
Œack”
.
	`chªged
(
i
.
fœ¡
);

3849 
boŞ
 
may_šşude_d–‘es
 = 
çl£
;

3851 cÚ¡ 
m­
<
hobjeù_t
, 
™em
> &
	$g‘_™ems
(ècÚ¡ 
ov”ride
 {

3852  
missšg
;

3853 
	}
}

3854 cÚ¡ 
	gm­
<
	gv”siÚ_t
, 
	ghobjeù_t
> &
	$g‘_rmissšg
(ècÚ¡ 
ov”ride
 {

3855  
rmissšg
;

3856 
	}
}

3857 
boŞ
 
	$g‘_may_šşude_d–‘es
(ècÚ¡ 
ov”ride
 {

3858  
may_šşude_d–‘es
;

3859 
	}
}

3860 
	$num_missšg
(ècÚ¡ 
ov”ride
 {

3861  
missšg
.
	`size
();

3862 
	}
}

3863 
boŞ
 
	$have_missšg
(ècÚ¡ 
ov”ride
 {

3864  !
missšg
.
	`em±y
();

3865 
	}
}

3866 
boŞ
 
	$is_missšg
(cÚ¡ 
hobjeù_t
& 
oid
, 
pg_missšg_™em
 *
out
 = 
nuÎ±r
ècÚ¡ 
ov”ride
 {

3867 autØ
™”
 = 
missšg
.
	`fšd
(
oid
);

3868 ià(
™”
 =ğ
missšg
.
	`’d
())

3869  
çl£
;

3870 ià(
out
)

3871 *
out
 = 
™”
->
£cÚd
;

3872  
Œue
;

3873 
	}
}

3874 
boŞ
 
	$is_missšg
(cÚ¡ 
hobjeù_t
& 
oid
, 
ev”siÚ_t
 
v
ècÚ¡ 
ov”ride
 {

3875 
m­
<
hobjeù_t
, 
™em
>::
cÚ¡_™”©Ü
 
m
 =

3876 
missšg
.
	`fšd
(
oid
);

3877 ià(
m
 =ğ
missšg
.
	`’d
())

3878  
çl£
;

3879 cÚ¡ 
™em
 &
	`™em
(
m
->
£cÚd
);

3880 ià(
™em
.
Ãed
 > 
v
)

3881  
çl£
;

3882  
Œue
;

3883 
	}
}

3884 
ev”siÚ_t
 
	$g‘_Şde¡_Ãed
() const {

3885 ià(
missšg
.
	`em±y
()) {

3886  
	`ev”siÚ_t
();

3888 autØ
™
 = 
missšg
.
	`fšd
(
rmissšg
.
	`begš
()->
£cÚd
);

3889 
	`as£¹
(
™
 !ğ
missšg
.
	`’d
());

3890  
™
->
£cÚd
.
Ãed
;

3891 
	}
}

3893 
	$şaim
(
pg_missšg_£t
& 
o
) {

3894 
	`¡©ic_as£¹
(!
T¿ckChªges
, "Can't use claim with TrackChanges");

3895 
missšg
.
	`sw­
(
o
.missing);

3896 
rmissšg
.
	`sw­
(
o
.rmissing);

3897 
	}
}

3903 
	$add_Ãxt_ev’t
(cÚ¡ 
pg_log_’Œy_t
& 
e
) {

3904 
m­
<
hobjeù_t
, 
™em
>::
™”©Ü
 
missšg_™
;

3905 
missšg_™
 = 
missšg
.
	`fšd
(
e
.
soid
);

3906 
boŞ
 
is_missšg_div”g’t_™em
 = 
missšg_™
 !ğ
missšg
.
	`’d
();

3907 ià(
e
.
´iÜ_v”siÚ
 =ğ
	`ev”siÚ_t
(è||ƒ.
	`is_şÚe
()) {

3909 ià(
is_missšg_div”g’t_™em
) {

3910 
rmissšg
.
	`”a£
((
missšg_™
->
£cÚd
).
Ãed
.
v”siÚ
);

3911 
missšg_™
->
£cÚd
 = 
	`™em
(
e
.
v”siÚ
, 
	`ev”siÚ_t
(),ƒ.
	`is_d–‘e
());

3913 
missšg
[
e
.
soid
] = 
	`™em
Ó.
v”siÚ
, 
	`ev”siÚ_t
(),ƒ.
	`is_d–‘e
());

3914 } ià(
is_missšg_div”g’t_™em
) {

3916 
rmissšg
.
	`”a£
((
missšg_™
->
£cÚd
).
Ãed
.
v”siÚ
);

3917 (
missšg_™
->
£cÚd
).
Ãed
 = 
e
.
v”siÚ
;

3918 
missšg_™
->
£cÚd
.
	`£t_d–‘e
(
e
.
	`is_d–‘e
());

3921 
	`as£¹
(!
is_missšg_div”g’t_™em
);

3922 
missšg
[
e
.
soid
] = 
	`™em
Ó.
v”siÚ
,ƒ.
´iÜ_v”siÚ
,ƒ.
	`is_d–‘e
());

3924 
rmissšg
[
e
.
v”siÚ
.v”siÚ] =ƒ.
soid
;

3925 
Œack”
.
	`chªged
(
e
.
soid
);

3926 
	}
}

3928 
	$»vi£_Ãed
(
hobjeù_t
 
oid
, 
ev”siÚ_t
 
Ãed
, 
boŞ
 
is_d–‘e
) {

3929 ià(
missšg
.
	`couÁ
(
oid
)) {

3930 
rmissšg
.
	`”a£
(
missšg
[
oid
].
Ãed
.
v”siÚ
);

3931 
missšg
[
oid
].
Ãed
 =‚eed;

3932 
missšg
[
oid
].
	`£t_d–‘e
(
is_d–‘e
);

3934 
missšg
[
oid
] = 
	`™em
(
Ãed
, 
	`ev”siÚ_t
(), 
is_d–‘e
);

3936 
rmissšg
[
Ãed
.
v”siÚ
] = 
oid
;

3938 
Œack”
.
	`chªged
(
oid
);

3939 
	}
}

3941 
	$»vi£_have
(
hobjeù_t
 
oid
, 
ev”siÚ_t
 
have
) {

3942 ià(
missšg
.
	`couÁ
(
oid
)) {

3943 
Œack”
.
	`chªged
(
oid
);

3944 
missšg
[
oid
].
have
 = have;

3946 
	}
}

3948 
	$add
(cÚ¡ 
hobjeù_t
& 
oid
, 
ev”siÚ_t
 
Ãed
,ƒv”siÚ_ˆ
have
,

3949 
boŞ
 
is_d–‘e
) {

3950 
missšg
[
oid
] = 
	`™em
(
Ãed
, 
have
, 
is_d–‘e
);

3951 
rmissšg
[
Ãed
.
v”siÚ
] = 
oid
;

3952 
Œack”
.
	`chªged
(
oid
);

3953 
	}
}

3955 
	$rm
(cÚ¡ 
hobjeù_t
& 
oid
, 
ev”siÚ_t
 
v
) {

3956 
¡d
::
m­
<
hobjeù_t
, 
™em
>::
™”©Ü
 
p
 = 
missšg
.
	`fšd
(
oid
);

3957 ià(
p
 !ğ
missšg
.
	`’d
(è&&…->
£cÚd
.
Ãed
 <ğ
v
)

3958 
	`rm
(
p
);

3959 
	}
}

3961 
rm
(
¡d
::
m­
<
hobjeù_t
, 
™em
>::
cÚ¡_™”©Ü
 
m
) {

3962 
Œack”
.
chªged
(
m
->
fœ¡
);

3963 
	grmissšg
.
”a£
(
m
->
£cÚd
.
Ãed
.
v”siÚ
);

3964 
	gmissšg
.
”a£
(
m
);

3967 
	$gÙ
(cÚ¡ 
hobjeù_t
& 
oid
, 
ev”siÚ_t
 
v
) {

3968 
¡d
::
m­
<
hobjeù_t
, 
™em
>::
™”©Ü
 
p
 = 
missšg
.
	`fšd
(
oid
);

3969 
	`as£¹
(
p
 !ğ
missšg
.
	`’d
());

3970 
	`as£¹
(
p
->
£cÚd
.
Ãed
 <ğ
v
 ||…->£cÚd.
	`is_d–‘e
());

3971 
	`gÙ
(
p
);

3972 
	}
}

3974 
gÙ
(
¡d
::
m­
<
hobjeù_t
, 
™em
>::
cÚ¡_™”©Ü
 
m
) {

3975 
Œack”
.
chªged
(
m
->
fœ¡
);

3976 
	grmissšg
.
”a£
(
m
->
£cÚd
.
Ãed
.
v”siÚ
);

3977 
	gmissšg
.
”a£
(
m
);

3980 
	$¥l™_što
(

3981 
pg_t
 
chd_pgid
,

3982 
¥l™_b™s
,

3983 
pg_missšg_£t
 *
omissšg
) {

3984 
omissšg
->
may_šşude_d–‘es
 = may_include_deletes;

3985 
mask
 = ~((~0)<<
¥l™_b™s
);

3986 
m­
<
hobjeù_t
, 
™em
>::
™”©Ü
 
i
 = 
missšg
.
	`begš
();

3987 
i
 !ğ
missšg
.
	`’d
();

3989 ià((
i
->
fœ¡
.
	`g‘_hash
(è& 
mask
è=ğ
chd_pgid
.
m_£ed
) {

3990 
omissšg
->
	`add
(
i
->
fœ¡
, i->
£cÚd
.
Ãed
, i->£cÚd.
have
,

3991 
i
->
£cÚd
.
	`is_d–‘e
());

3992 
	`rm
(
i
++);

3994 ++
i
;

3997 
	}
}

3999 
	$ş—r
() {

4000 autØcÚ¡ &
i
: 
missšg
)

4001 
Œack”
.
	`chªged
(
i
.
fœ¡
);

4002 
missšg
.
	`ş—r
();

4003 
rmissšg
.
	`ş—r
();

4004 
	}
}

4006 
	$’code
(
bufã¾i¡
 &
bl
) const {

4007 
	`ENCODE_START
(4, 2, 
bl
);

4008 
	`’code
(
missšg
, 
bl
, 
may_šşude_d–‘es
 ? 
CEPH_FEATURE_OSD_RECOVERY_DELETES
 : 0);

4009 
	`’code
(
may_šşude_d–‘es
, 
bl
);

4010 
	`ENCODE_FINISH
(
bl
);

4011 
	}
}

4012 
decode
(
bufã¾i¡
::
™”©Ü
 &
bl
, 
št64_t
 
poŞ
 = -1) {

4013 autØcÚ¡ &
i
: 
missšg
)

4014 
Œack”
.
chªged
(
i
.
fœ¡
);

4015 
DECODE_START_LEGACY_COMPAT_LEN
(4, 2, 2, 
bl
);

4016 
decode
(
missšg
, 
bl
);

4017 ià(
	g¡ruù_v
 >= 4) {

4018 
decode
(
may_šşude_d–‘es
, 
bl
);

4020 
DECODE_FINISH
(
bl
);

4022 ià(
	g¡ruù_v
 < 3) {

4024 
	gm­
<
	ghobjeù_t
, 
	g™em
> 
	gtmp
;

4025 
	gm­
<
	ghobjeù_t
, 
	g™em
>::
™”©Ü
 
i
 =

4026 
missšg
.
begš
();

4027 
	gi
 !ğ
missšg
.
’d
();

4029 ià(!
	gi
->
	gfœ¡
.
is_max
(è&& i->fœ¡.
	gpoŞ
 == -1) {

4030 
hobjeù_t
 
to_š£¹
(
i
->
fœ¡
);

4031 
	gto_š£¹
.
	gpoŞ
 = 
poŞ
;

4032 
	gtmp
[
to_š£¹
] = 
i
->
£cÚd
;

4033 
	gmissšg
.
”a£
(
i
++);

4035 ++
	gi
;

4038 
	gmissšg
.
š£¹
(
tmp
.
begš
(),mp.
’d
());

4041 
	gm­
<
	ghobjeù_t
,
	g™em
>::
™”©Ü
 
™
 =

4042 
missšg
.
begš
();

4043 
	g™
 !ğ
missšg
.
’d
();

4044 ++
	g™
)

4045 
	grmissšg
[
™
->
£cÚd
.
Ãed
.
v”siÚ
] = it->
fœ¡
;

4046 autØcÚ¡ &
	gi
: 
missšg
)

4047 
Œack”
.
chªged
(
i
.
fœ¡
);

4049 
	$dump
(
FÜm©‹r
 *
f
) const {

4050 
f
->
	`İ’_¬¿y_£ùiÚ
("missing");

4051 
m­
<
hobjeù_t
,
™em
>::
cÚ¡_™”©Ü
 
p
 =

4052 
missšg
.
	`begš
(); 
p
 !ğmissšg.
	`’d
(); ++p) {

4053 
f
->
	`İ’_objeù_£ùiÚ
("item");

4054 
f
->
	`dump_¡»am
("objeù"è<< 
p
->
fœ¡
;

4055 
p
->
£cÚd
.
	`dump
(
f
);

4056 
f
->
	`şo£_£ùiÚ
();

4058 
f
->
	`şo£_£ùiÚ
();

4059 
f
->
	`dump_boŞ
("may_šşude_d–‘es", 
may_šşude_d–‘es
);

4060 
	}
}

4061 
	g‹m¶©e
 <
ty³Çme
 
	gF
>

4062 
	$f‹r_objeùs
(
F
 &&
f
) {

4063 autØ
i
 = 
missšg
.
	`begš
(); i !ğmissšg.
	`’d
();) {

4064 ià(
	`f
(
i
->
fœ¡
)) {

4065 
	`rm
(
i
++);

4067 ++
i
;

4070 
	}
}

4071 
g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_missšg_£t
*>& 
o
) {

4072 
	go
.
push_back
(
Ãw
 
pg_missšg_£t
);

4073 
	go
.
push_back
(
Ãw
 
pg_missšg_£t
);

4074 
	go
.
back
()->
add
(

4075 
hobjeù_t
(
objeù_t
("foo"), "foo", 123, 456, 0, ""),

4076 
ev”siÚ_t
(5, 6),ƒv”siÚ_t(5, 1), 
çl£
);

4077 
	go
.
push_back
(
Ãw
 
pg_missšg_£t
);

4078 
	go
.
back
()->
add
(

4079 
hobjeù_t
(
objeù_t
("foo"), "foo", 123, 456, 0, ""),

4080 
ev”siÚ_t
(5, 6),ƒv”siÚ_t(5, 1), 
Œue
);

4081 
	go
.
back
()->
	gmay_šşude_d–‘es
 = 
Œue
;

4083 
	g‹m¶©e
 <
ty³Çme
 
	gF
>

4084 
	$g‘_chªged
(
F
 &&
f
) const {

4085 
Œack”
.
	`g‘_chªged
(
f
);

4086 
	}
}

4087 
	$æush
() {

4088 
Œack”
.
	`æush
();

4089 
	}
}

4090 
boŞ
 
	$is_ş—n
() const {

4091  
Œack”
.
	`is_ş—n
();

4092 
	}
}

4093 
	g‹m¶©e
 <
ty³Çme
 
	gmissšg_t
>

4094 
boŞ
 
	$debug_v”ify_äom_š™
(

4095 cÚ¡ 
missšg_t
 &
š™_missšg
,

4096 
o¡»am
 *
oss
) const {

4097 ià(!
T¿ckChªges
)

4098  
Œue
;

4099 autØ
	`check_missšg
(
š™_missšg
.
	`g‘_™ems
());

4100 
Œack”
.
	`g‘_chªged
([&](cÚ¡ 
hobjeù_t
 &
hoid
) {

4101 
check_missšg
.
	`”a£
(
hoid
);

4102 ià(
missšg
.
	`couÁ
(
hoid
)) {

4103 
check_missšg
.
	`š£¹
(*(
missšg
.
	`fšd
(
hoid
)));

4106 
boŞ
 
ok
 = 
Œue
;

4107 ià(
check_missšg
.
	`size
(è!ğ
missšg
.size()) {

4108 ià(
oss
) {

4109 *
oss
 << "Sizmism©ch, check: " << 
check_missšg
.
	`size
()

4110 << ",‡ùu®: " << 
missšg
.
	`size
() << "\n";

4112 
ok
 = 
çl£
;

4114 autØ&
i
: 
missšg
) {

4115 ià(!
check_missšg
.
	`couÁ
(
i
.
fœ¡
)) {

4116 ià(
oss
)

4117 *
oss
 << "check_missšg missšg " << 
i
.
fœ¡
 << "\n";

4118 
ok
 = 
çl£
;

4119 } ià(
check_missšg
[
i
.
fœ¡
] !ği.
£cÚd
) {

4120 ià(
oss
)

4121 *
oss
 << "check_missšg missšg i‹m mism©ch oÀ" << 
i
.
fœ¡


4122 << ", check: " << 
check_missšg
[
i
.
fœ¡
]

4123 << ",‡ùu®: " << 
i
.
£cÚd
 << "\n";

4124 
ok
 = 
çl£
;

4127 ià(
oss
 && !
ok
) {

4128 *
oss
 << "check_missšg: " << 
check_missšg
 << "\n";

4129 
£t
<
hobjeù_t
> 
chªged
;

4130 
Œack”
.
	`g‘_chªged
([&](cÚ¡ 
hobjeù_t
 &
hoid
è{ 
chªged
.
	`š£¹
(hoid); });

4131 *
oss
 << "chªged: " << 
chªged
 << "\n";

4133  
ok
;

4134 
	}
}

4136 
	g‹m¶©e
 <
boŞ
 
	gT¿ckChªges
>

4137 
’code
(

4138 cÚ¡ 
pg_missšg_£t
<
T¿ckChªges
> &
c
, 
bufã¾i¡
 &
bl
, 
ušt64_t
 
ã©u»s
=0) {

4139 
ENCODE_DUMP_PRE
();

4140 
	gc
.
’code
(
bl
);

4141 
ENCODE_DUMP_POST
(
ş
);

4143 
	g‹m¶©e
 <
boŞ
 
	gT¿ckChªges
>

4144 
decode
(
pg_missšg_£t
<
T¿ckChªges
> &
c
, 
bufã¾i¡
::
™”©Ü
 &
p
) {

4145 
c
.
decode
(
p
);

4147 
	g‹m¶©e
 <
boŞ
 
	gT¿ckChªges
>

4148 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gpg_missšg_£t
<
	gT¿ckChªges
> &
	gmissšg
)

4150 
	gout
 << "missšg(" << 
	gmissšg
.
num_missšg
()

4151 << " may_šşude_d–‘e ğ" << 
	gmissšg
.
	gmay_šşude_d–‘es
;

4153 
	gout
 << ")";

4154  
	gout
;

4157 
usšg
 
	gpg_missšg_t
 = 
pg_missšg_£t
<
çl£
>;

4158 
usšg
 
	gpg_missšg_Œack”_t
 = 
pg_missšg_£t
<
Œue
>;

4165 
	spg_Æs_»¥Ú£_t
 {

4166 
cŞËùiÚ_li¡_hªdË_t
 
	mhªdË
;

4167 
	mli¡
<
	mlib¿dos
::
Li¡ObjeùIm¶
> 
’Œ›s
;

4169 
’code
(
bufã¾i¡
& 
bl
) const {

4170 
ENCODE_START
(1, 1, 
bl
);

4171 
’code
(
hªdË
, 
bl
);

4172 
__u32
 
	mn
 = (__u32)
’Œ›s
.
size
();

4173 
’code
(
n
, 
bl
);

4174 
	mli¡
<
	mlib¿dos
::
Li¡ObjeùIm¶
>::
cÚ¡_™”©Ü
 
i
 = 
’Œ›s
.
begš
(); 
	mi
 !ğ’Œ›s.
’d
(); ++i) {

4175 
’code
(
i
->
n¥aû
, 
bl
);

4176 
’code
(
i
->
oid
, 
bl
);

4177 
’code
(
i
->
loÿtÜ
, 
bl
);

4179 
ENCODE_FINISH
(
bl
);

4181 
decode
(
bufã¾i¡
::
™”©Ü
& 
bl
) {

4182 
DECODE_START
(1, 
bl
);

4183 
decode
(
hªdË
, 
bl
);

4184 
__u32
 
	mn
;

4185 
decode
(
n
, 
bl
);

4186 
	m’Œ›s
.
ş—r
();

4187 
	mn
--) {

4188 
	mlib¿dos
::
Li¡ObjeùIm¶
 
i
;

4189 
decode
(
i
.
n¥aû
, 
bl
);

4190 
decode
(
i
.
oid
, 
bl
);

4191 
decode
(
i
.
loÿtÜ
, 
bl
);

4192 
	m’Œ›s
.
push_back
(
i
);

4194 
DECODE_FINISH
(
bl
);

4196 
dump
(
FÜm©‹r
 *
f
) const {

4197 
	mf
->
dump_¡»am
("hªdË"è<< 
	mhªdË
;

4198 
	mf
->
İ’_¬¿y_£ùiÚ
("entries");

4199 
	mli¡
<
	mlib¿dos
::
Li¡ObjeùIm¶
>::
cÚ¡_™”©Ü
 
p
 = 
’Œ›s
.
begš
(); 
	mp
 !ğ’Œ›s.
’d
(); ++p) {

4200 
	mf
->
İ’_objeù_£ùiÚ
("object");

4201 
	mf
->
dump_¡ršg
("Çme¥aû", 
p
->
n¥aû
);

4202 
	mf
->
dump_¡ršg
("objeù", 
p
->
oid
);

4203 
	mf
->
dump_¡ršg
("key", 
p
->
loÿtÜ
);

4204 
	mf
->
şo£_£ùiÚ
();

4206 
	mf
->
şo£_£ùiÚ
();

4208 
g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_Æs_»¥Ú£_t
*>& 
o
) {

4209 
	mo
.
push_back
(
Ãw
 
pg_Æs_»¥Ú£_t
);

4210 
	mo
.
push_back
(
Ãw
 
pg_Æs_»¥Ú£_t
);

4211 
	mo
.
back
()->
	mhªdË
 = 
hobjeù_t
(
objeù_t
("hi"), "key", 1, 2, -1, "");

4212 
	mo
.
back
()->
	m’Œ›s
.
push_back
(
lib¿dos
::
Li¡ObjeùIm¶
("", "one", ""));

4213 
	mo
.
back
()->
	m’Œ›s
.
push_back
(
lib¿dos
::
Li¡ObjeùIm¶
("", "two", "twokey"));

4214 
	mo
.
back
()->
	m’Œ›s
.
push_back
(
lib¿dos
::
Li¡ObjeùIm¶
("", "three", ""));

4215 
	mo
.
push_back
(
Ãw
 
pg_Æs_»¥Ú£_t
);

4216 
	mo
.
back
()->
	mhªdË
 = 
hobjeù_t
(
objeù_t
("hi"), "key", 3, 4, -1, "");

4217 
	mo
.
back
()->
	m’Œ›s
.
push_back
(
lib¿dos
::
Li¡ObjeùIm¶
("n1", "n1one", ""));

4218 
	mo
.
back
()->
	m’Œ›s
.
push_back
(
lib¿dos
::
Li¡ObjeùIm¶
("n1", "n1two", "n1twokey"));

4219 
	mo
.
back
()->
	m’Œ›s
.
push_back
(
lib¿dos
::
Li¡ObjeùIm¶
("n1", "n1three", ""));

4220 
	mo
.
push_back
(
Ãw
 
pg_Æs_»¥Ú£_t
);

4221 
	mo
.
back
()->
	mhªdË
 = 
hobjeù_t
(
objeù_t
("hi"), "key", 5, 6, -1, "");

4222 
	mo
.
back
()->
	m’Œ›s
.
push_back
(
lib¿dos
::
Li¡ObjeùIm¶
("", "one", ""));

4223 
	mo
.
back
()->
	m’Œ›s
.
push_back
(
lib¿dos
::
Li¡ObjeùIm¶
("", "two", "twokey"));

4224 
	mo
.
back
()->
	m’Œ›s
.
push_back
(
lib¿dos
::
Li¡ObjeùIm¶
("", "three", ""));

4225 
	mo
.
back
()->
	m’Œ›s
.
push_back
(
lib¿dos
::
Li¡ObjeùIm¶
("n1", "n1one", ""));

4226 
	mo
.
back
()->
	m’Œ›s
.
push_back
(
lib¿dos
::
Li¡ObjeùIm¶
("n1", "n1two", "n1twokey"));

4227 
	mo
.
back
()->
	m’Œ›s
.
push_back
(
lib¿dos
::
Li¡ObjeùIm¶
("n1", "n1three", ""));

4231 
	$WRITE_CLASS_ENCODER
(
pg_Æs_»¥Ú£_t
)

4234 
	spg_ls_»¥Ú£_t
 {

4235 
cŞËùiÚ_li¡_hªdË_t
 
hªdË
;

4236 
li¡
<
·œ
<
objeù_t
, 
¡ršg
> > 
’Œ›s
;

4238 
	`’code
(
bufã¾i¡
& 
bl
) const {

4239 
usšg
 
ûph
::
’code
;

4240 
__u8
 
v
 = 1;

4241 
	`’code
(
v
, 
bl
);

4242 
	`’code
(
hªdË
, 
bl
);

4243 
	`’code
(
’Œ›s
, 
bl
);

4245 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
bl
) {

4246 
usšg
 
ûph
::
decode
;

4247 
__u8
 
v
;

4248 
	`decode
(
v
, 
bl
);

4249 
	`as£¹
(
v
 == 1);

4250 
	`decode
(
hªdË
, 
bl
);

4251 
	`decode
(
’Œ›s
, 
bl
);

4253 
	`dump
(
FÜm©‹r
 *
f
) const {

4254 
f
->
	`dump_¡»am
("hªdË"è<< 
hªdË
;

4255 
f
->
	`İ’_¬¿y_£ùiÚ
("entries");

4256 
li¡
<
·œ
<
objeù_t
, 
¡ršg
> >::
cÚ¡_™”©Ü
 
p
 = 
’Œ›s
.
	`begš
();… !ğ’Œ›s.
	`’d
(); ++p) {

4257 
f
->
	`İ’_objeù_£ùiÚ
("object");

4258 
f
->
	`dump_¡»am
("objeù"è<< 
p
->
fœ¡
;

4259 
f
->
	`dump_¡ršg
("key", 
p
->
£cÚd
);

4260 
f
->
	`şo£_£ùiÚ
();

4262 
f
->
	`şo£_£ùiÚ
();

4264 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_ls_»¥Ú£_t
*>& 
o
) {

4265 
o
.
	`push_back
(
Ãw
 
pg_ls_»¥Ú£_t
);

4266 
o
.
	`push_back
(
Ãw
 
pg_ls_»¥Ú£_t
);

4267 
o
.
	`back
()->
hªdË
 = 
	`hobjeù_t
(
	`objeù_t
("hi"), "key", 1, 2, -1, "");

4268 
o
.
	`back
()->
’Œ›s
.
	`push_back
(
	`make_·œ
(
	`objeù_t
("Úe"), 
	`¡ršg
()));

4269 
o
.
	`back
()->
’Œ›s
.
	`push_back
(
	`make_·œ
(
	`objeù_t
("two"), 
	`¡ršg
("twokey")));

4273 
	$WRITE_CLASS_ENCODER
(
pg_ls_»¥Ú£_t
)

4278 
	sobjeù_cİy_cursÜ_t
 {

4279 
ušt64_t
 
d©a_off£t
;

4280 
¡ršg
 
om­_off£t
;

4281 
boŞ
 
©Œ_com¶‘e
;

4282 
boŞ
 
d©a_com¶‘e
;

4283 
boŞ
 
om­_com¶‘e
;

4285 
	`objeù_cİy_cursÜ_t
()

4286 : 
	`d©a_off£t
(0),

4287 
	`©Œ_com¶‘e
(
çl£
),

4288 
	`d©a_com¶‘e
(
çl£
),

4289 
	`om­_com¶‘e
(
çl£
)

4292 
boŞ
 
	`is_š™Ÿl
() const {

4293  !
©Œ_com¶‘e
 && 
d©a_off£t
 =ğ0 && 
om­_off£t
.
	`em±y
();

4295 
boŞ
 
	`is_com¶‘e
() const {

4296  
©Œ_com¶‘e
 && 
d©a_com¶‘e
 && 
om­_com¶‘e
;

4299 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
objeù_cİy_cursÜ_t
*>& 
o
);

4300 
	`’code
(
bufã¾i¡
& 
bl
) const;

4301 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

4302 
	`dump
(
FÜm©‹r
 *
f
) const;

4304 
	$WRITE_CLASS_ENCODER
(
objeù_cİy_cursÜ_t
)

4320 
	sobjeù_cİy_d©a_t
 {

4322 
FLAG_DATA_DIGEST
 = 1<<0,

4323 
FLAG_OMAP_DIGEST
 = 1<<1,

4325 
objeù_cİy_cursÜ_t
 
cursÜ
;

4326 
ušt64_t
 
size
;

4327 
utime_t
 
mtime
;

4328 
ušt32_t
 
d©a_dige¡
, 
om­_dige¡
;

4329 
ušt32_t
 
æags
;

4330 
m­
<
¡ršg
, 
bufã¾i¡
> 
©Œs
;

4331 
bufã¾i¡
 
d©a
;

4332 
bufã¾i¡
 
om­_h—d”
;

4333 
bufã¾i¡
 
om­_d©a
;

4336 
veùÜ
<
¢­id_t
> 
¢­s
;

4338 
¢­id_t
 
¢­_£q
;

4341 
mempoŞ
::
osd_pglog
::
veùÜ
<
·œ
<
osd_»qid_t
, 
v”siÚ_t
> > 
»qids
;

4343 
ušt64_t
 
Œunÿ‹_£q
;

4344 
ušt64_t
 
Œunÿ‹_size
;

4346 
public
:

4347 
	`objeù_cİy_d©a_t
() :

4348 
	`size
((
ušt64_t
)-1), 
	`d©a_dige¡
(-1),

4349 
	`om­_dige¡
(-1), 
	`æags
(0),

4350 
	`Œunÿ‹_£q
(0),

4351 
	`Œunÿ‹_size
(0) {}

4353 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
objeù_cİy_d©a_t
*>& 
o
);

4354 
	`’code
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
) const;

4355 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
bl
);

4356 
	`dump
(
FÜm©‹r
 *
f
) const;

4358 
	$WRITE_CLASS_ENCODER_FEATURES
(
objeù_cİy_d©a_t
)

4363 
	spg_ü—‹_t
 {

4364 
•och_t
 
ü—‹d
;

4365 
pg_t
 
·»Á
;

4366 
__s32
 
¥l™_b™s
;

4368 
	`pg_ü—‹_t
()

4369 : 
	`ü—‹d
(0), 
	`¥l™_b™s
(0) {}

4370 
	`pg_ü—‹_t
(
c
, 
pg_t
 
p
, 
s
)

4371 : 
	`ü—‹d
(
c
), 
	`·»Á
(
p
), 
	`¥l™_b™s
(
s
) {}

4373 
	`’code
(
bufã¾i¡
 &
bl
) const;

4374 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

4375 
	`dump
(
FÜm©‹r
 *
f
) const;

4376 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
pg_ü—‹_t
*>& 
o
);

4378 
	$WRITE_CLASS_ENCODER
(
pg_ü—‹_t
)

4382 şas 
	cObjeùEx‹Á
 {

4402 
public
:

4403 
objeù_t
 
oid
;

4404 
ušt64_t
 
objeùno
;

4405 
ušt64_t
 
off£t
;

4406 
ušt64_t
 
Ëngth
;

4407 
ušt64_t
 
Œunÿ‹_size
;

4409 
objeù_loÿtÜ_t
 
Şoc
;

4411 
veùÜ
<
·œ
<
ušt64_t
,ušt64_t> > 
bufãr_ex‹Ás
;

4413 
	$ObjeùEx‹Á
(è: 
	`objeùno
(0), 
	`off£t
(0), 
	`Ëngth
(0), 
	$Œunÿ‹_size
(0) {}

4414 
	$ObjeùEx‹Á
(
objeù_t
 
o
, 
ušt64_t
 
Úo
, ušt64_ˆ
off
, ušt64_ˆ
l
, ušt64_ˆ
ts
) :

4415 
	`oid
(
o
), 
	`objeùno
(
Úo
), 
	`off£t
(
off
), 
	`Ëngth
(
l
), 
	$Œunÿ‹_size
(
ts
è{ 
	}
}

4418 
šlše
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gObjeùEx‹Á
 &
	gex
)

4420  
	gout
 << "extent("

4421 << 
	gex
.
	goid
 << " (" <<ƒx.
	gobjeùno
 << "èš " <<ƒx.
	gŞoc


4422 << " " << 
	gex
.
	goff£t
 << "~" <<ƒx.
	gËngth


4423 << " -> " << 
	gex
.
	gbufãr_ex‹Ás


4430 şas 
	cOSDSu³rblock
 {

4431 
	mpublic
:

4432 
uuid_d
 
şu¡”_fsid
, 
	mosd_fsid
;

4433 
št32_t
 
	mwhßmi
;

4434 
•och_t
 
	mcu¼’t_•och
;

4435 
•och_t
 
	mŞde¡_m­
, 
	mÃwe¡_m­
;

4436 
	mweight
;

4438 
Com·tS‘
 
	mcom·t_ã©u»s
;

4441 
•och_t
 
	mmouÁed
;

4442 
•och_t
 
	mş—n_thru
;

4444 
	$OSDSu³rblock
() :

4445 
	`whßmi
(-1),

4446 
	`cu¼’t_•och
(0), 
	`Şde¡_m­
(0), 
	`Ãwe¡_m­
(0), 
	`weight
(0),

4447 
	`mouÁed
(0), 
	$ş—n_thru
(0) {

4450 
	$’code
(
bufã¾i¡
 &
bl
) const;

4451 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

4452 
	$dump
(
FÜm©‹r
 *
f
) const;

4453 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
OSDSu³rblock
*>& 
o
);

4454 
	}
};

4455 
	$WRITE_CLASS_ENCODER
(
OSDSu³rblock
)

4457 
šlše
 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
OSDSu³rblock
& 
sb
)

4459  
out
 << "sb(" << 
sb
.
şu¡”_fsid


4460 << " osd." << 
sb
.
whßmi


4461 << " " << 
sb
.
osd_fsid


4462 << "ƒ" << 
sb
.
cu¼’t_•och


4463 << " [" << 
sb
.
Şde¡_m­
 << "," << sb.
Ãwe¡_m­
 << "]"

4464 << "†ci=[" << 
sb
.
mouÁed
 << "," << sb.
ş—n_thru
 << "]"

4466 
	}
}

4480 
	sSÇpS‘
 {

4481 
¢­id_t
 
	m£q
;

4482 
	mveùÜ
<
	m¢­id_t
> 
	m¢­s
;

4483 
	mveùÜ
<
	m¢­id_t
> 
	mşÚes
;

4484 
	mm­
<
	m¢­id_t
, 
	mš‹rv®_£t
<
	mušt64_t
> > 
	mşÚe_ov”Ïp
;

4485 
	mm­
<
	m¢­id_t
, 
	mušt64_t
> 
	mşÚe_size
;

4486 
	mm­
<
	m¢­id_t
, 
	mveùÜ
<¢­id_t>> 
	mşÚe_¢­s
;

4488 
SÇpS‘
(è: 
£q
(0) {}

4489 
ex¶ic™
 
SÇpS‘
(
bufã¾i¡
& 
bl
) {

4490 
bufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
begš
();

4491 
decode
(
p
);

4495 
äom_¢­_£t
(cÚ¡ 
lib¿dos
::
¢­_£t_t
& 
ss
, 
boŞ
 
Ëgacy
);

4498 
ušt64_t
 
g‘_şÚe_by‹s
(
¢­id_t
 
şÚe
) const;

4500 
’code
(
bufã¾i¡
& 
bl
) const;

4501 
decode
(
bufã¾i¡
::
™”©Ü
& 
bl
);

4502 
dump
(
FÜm©‹r
 *
f
) const;

4503 
g’”©e_‹¡_š¡ªûs
(
li¡
<
SÇpS‘
*>& 
o
);

4505 
SÇpCÚ‹xt
 
g‘_ssc_as_of
(
¢­id_t
 
as_of
) const {

4506 
SÇpCÚ‹xt
 
	mout
;

4507 
	mout
.
	m£q
 = 
as_of
;

4508 
	mveùÜ
<
	m¢­id_t
>::
cÚ¡_™”©Ü
 
i
 = 
¢­s
.
begš
();

4509 
	mi
 !ğ
¢­s
.
’d
();

4510 ++
	mi
) {

4511 ià(*
	mi
 <ğ
as_of
)

4512 
out
.
¢­s
.
push_back
(*
i
);

4514  
	mout
;

4518 
SÇpS‘
 
g‘_f‹»d
(cÚ¡ 
pg_poŞ_t
 &
pšfo
) const;

4519 
f‹r
(cÚ¡ 
pg_poŞ_t
 &
pšfo
);

4521 
	$WRITE_CLASS_ENCODER
(
SÇpS‘
)

4523 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
SÇpS‘
& 
cs
);

4527 
	#OI_ATTR
 "_"

	)

4528 
	#SS_ATTR
 "¢­£t"

	)

4530 
	sw©ch_šfo_t
 {

4531 
ušt64_t
 
cook›
;

4532 
ušt32_t
 
timeout_£cÚds
;

4533 
’t™y_addr_t
 
addr
;

4535 
	`w©ch_šfo_t
(è: 
	`cook›
(0), 
	`timeout_£cÚds
(0) { }

4536 
	`w©ch_šfo_t
(
ušt64_t
 
c
, 
ušt32_t
 
t
, cÚ¡ 
’t™y_addr_t
& 
a
è: 
	`cook›
(c), 
	`timeout_£cÚds
Ñ), 
	`addr
(a) {}

4538 
	`’code
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
) const;

4539 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
bl
);

4540 
	`dump
(
FÜm©‹r
 *
f
) const;

4541 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
w©ch_šfo_t
*>& 
o
);

4543 
	$WRITE_CLASS_ENCODER_FEATURES
(
w©ch_šfo_t
)

4545 
šlše
 
boŞ
 
İ”©Ü
==(cÚ¡ 
w©ch_šfo_t
& 
l
, cÚ¡ w©ch_šfo_t& 
r
) {

4546  
l
.
cook›
 =ğ
r
.cook› &&†.
timeout_£cÚds
 ==„.timeout_seconds

4547 && 
l
.
addr
 =ğ
r
.addr;

4548 
	}
}

4550 
šlše
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gw©ch_šfo_t
& 
	gw
) {

4551  
	gout
 << "w©ch(cook› " << 
	gw
.
	gcook›
 << " " << w.
	gtimeout_£cÚds
 << "s"

4552 << " " << 
	gw
.
	gaddr
 << ")";

4555 
	snÙify_šfo_t
 {

4556 
ušt64_t
 
	mcook›
;

4557 
ušt64_t
 
	mnÙify_id
;

4558 
ušt32_t
 
	mtimeout
;

4559 
bufã¾i¡
 
	mbl
;

4562 
šlše
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am& 
	gout
, cÚ¡ 
	gnÙify_šfo_t
& 
	gn
) {

4563  
	gout
 << "nÙify(cook› " << 
	gn
.
	gcook›


4564 << "‚Ùify" << 
	gn
.
	gnÙify_id


4565 << " " << 
	gn
.
	gtimeout
 << "s)";

4568 
	schunk_šfo_t
 {

4570 
	mFLAG_DIRTY
 = 1,

4571 
	mFLAG_MISSING
 = 2,

4572 
	mFLAG_HAS_REFERENCE
 = 4,

4574 
ušt32_t
 
	moff£t
;

4575 
ušt32_t
 
	mËngth
;

4576 
hobjeù_t
 
	moid
;

4577 
ušt32_t
 
	mæags
;

4579 
chunk_šfo_t
(è: 
off£t
(0), 
Ëngth
(0), 
æags
(0) { }

4581 
¡ršg
 
g‘_æag_¡ršg
(
ušt64_t
 
æags
) {

4582 
¡ršg
 
	mr
;

4583 ià(
	mæags
 & 
	mFLAG_DIRTY
) {

4584 
	mr
 += "|dirty";

4586 ià(
	mæags
 & 
	mFLAG_MISSING
) {

4587 
	mr
 += "|missing";

4589 ià(
	mæags
 & 
	mFLAG_HAS_REFERENCE
) {

4590 
	mr
 += "|has_reference";

4592 ià(
	mr
.
Ëngth
())

4593  
	mr
.
sub¡r
(1);

4594  
	mr
;

4596 
’code
(
bufã¾i¡
 &
bl
) const;

4597 
decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

4598 
dump
(
FÜm©‹r
 *
f
) const;

4599 
ä›nd
 
	mo¡»am
& 
	mİ”©Ü
<<(o¡»am& 
	mout
, cÚ¡ 
	mchunk_šfo_t
& 
	mci
);

4601 
	$WRITE_CLASS_ENCODER
(
chunk_šfo_t
)

4602 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
chunk_šfo_t
& 
ci
);

4604 
objeù_šfo_t
;

4605 
	sobjeù_mªiã¡_t
 {

4607 
TYPE_NONE
 = 0,

4608 
TYPE_REDIRECT
 = 1,

4609 
TYPE_CHUNKED
 = 2,

4611 
ušt8_t
 
ty³
;

4612 
hobjeù_t
 
»dœeù_rg‘
;

4613 
m­
 <
ušt64_t
, 
chunk_šfo_t
> 
chunk_m­
;

4615 
	`objeù_mªiã¡_t
(è: 
	`ty³
(0) { }

4616 
	`objeù_mªiã¡_t
(
ušt8_t
 
ty³
, cÚ¡ 
hobjeù_t
& 
»dœeù_rg‘
)

4617 : 
	`ty³
(
ty³
), 
	`»dœeù_rg‘
(
»dœeù_rg‘
) { }

4619 
boŞ
 
	`is_em±y
() const {

4620  
ty³
 =ğ
TYPE_NONE
;

4622 
boŞ
 
	`is_»dœeù
() const {

4623  
ty³
 =ğ
TYPE_REDIRECT
;

4625 
boŞ
 
	`is_chunked
() const {

4626  
ty³
 =ğ
TYPE_CHUNKED
;

4628 cÚ¡ *
	`g‘_ty³_Çme
(
ušt8_t
 
m
) {

4629 
m
) {

4630 
TYPE_NONE
:  "none";

4631 
TYPE_REDIRECT
:  "redirect";

4632 
TYPE_CHUNKED
:  "chunked";

4636 cÚ¡ *
	`g‘_ty³_Çme
() const {

4637  
	`g‘_ty³_Çme
(
ty³
);

4639 
	`ş—r
() {

4640 
ty³
 = 0;

4641 
»dœeù_rg‘
 = 
	`hobjeù_t
();

4642 
chunk_m­
.
	`ş—r
();

4644 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
objeù_mªiã¡_t
*>& 
o
);

4645 
	`’code
(
bufã¾i¡
 &
bl
) const;

4646 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

4647 
	`dump
(
FÜm©‹r
 *
f
) const;

4648 
ä›nd
 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
objeù_šfo_t
& 
oi
);

4650 
	$WRITE_CLASS_ENCODER
(
objeù_mªiã¡_t
)

4651 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
objeù_mªiã¡_t
& 
oi
);

4653 
	sobjeù_šfo_t
 {

4654 
hobjeù_t
 
soid
;

4655 
ev”siÚ_t
 
v”siÚ
, 
´iÜ_v”siÚ
;

4656 
v”siÚ_t
 
u£r_v”siÚ
;

4657 
osd_»qid_t
 
Ï¡_»qid
;

4659 
ušt64_t
 
size
;

4660 
utime_t
 
mtime
;

4661 
utime_t
 
loÿl_mtime
;

4666 
FLAG_LOST
 = 1<<0,

4667 
FLAG_WHITEOUT
 = 1<<1,

4668 
FLAG_DIRTY
 = 1<<2,

4669 
FLAG_OMAP
 = 1<<3,

4670 
FLAG_DATA_DIGEST
 = 1<<4,

4671 
FLAG_OMAP_DIGEST
 = 1<<5,

4672 
FLAG_CACHE_PIN
 = 1<<6,

4673 
FLAG_MANIFEST
 = 1<<7,

4674 
FLAG_USES_TMAP
 = 1<<8,

4675 
FLAG_REDIRECT_HAS_REFERENCE
 = 1<<9,

4676 } 
	tæag_t
;

4678 
æag_t
 
æags
;

4680 
¡ršg
 
	`g‘_æag_¡ršg
(
æag_t
 
æags
) {

4681 
¡ršg
 
s
;

4682 
veùÜ
<
¡ršg
> 
sv
 = 
	`g‘_æag_veùÜ
(
æags
);

4683 autØ
ss
 : 
sv
) {

4684 
s
 +ğ
	`¡ršg
("|"è+ 
ss
;

4686 ià(
s
.
	`Ëngth
())

4687  
s
.
	`sub¡r
(1);

4688  
s
;

4690 
veùÜ
<
¡ršg
> 
	`g‘_æag_veùÜ
(
æag_t
 
æags
) {

4691 
veùÜ
<
¡ršg
> 
sv
;

4692 ià(
æags
 & 
FLAG_LOST
)

4693 
sv
.
	`š£¹
(sv.
	`’d
(), "lost");

4694 ià(
æags
 & 
FLAG_WHITEOUT
)

4695 
sv
.
	`š£¹
(sv.
	`’d
(), "whiteout");

4696 ià(
æags
 & 
FLAG_DIRTY
)

4697 
sv
.
	`š£¹
(sv.
	`’d
(), "dirty");

4698 ià(
æags
 & 
FLAG_USES_TMAP
)

4699 
sv
.
	`š£¹
(sv.
	`’d
(), "uses_tmap");

4700 ià(
æags
 & 
FLAG_OMAP
)

4701 
sv
.
	`š£¹
(sv.
	`’d
(), "omap");

4702 ià(
æags
 & 
FLAG_DATA_DIGEST
)

4703 
sv
.
	`š£¹
(sv.
	`’d
(), "data_digest");

4704 ià(
æags
 & 
FLAG_OMAP_DIGEST
)

4705 
sv
.
	`š£¹
(sv.
	`’d
(), "omap_digest");

4706 ià(
æags
 & 
FLAG_CACHE_PIN
)

4707 
sv
.
	`š£¹
(sv.
	`’d
(), "cache_pin");

4708 ià(
æags
 & 
FLAG_MANIFEST
)

4709 
sv
.
	`š£¹
(sv.
	`’d
(), "manifest");

4710 ià(
æags
 & 
FLAG_REDIRECT_HAS_REFERENCE
)

4711 
sv
.
	`š£¹
(sv.
	`’d
(), "redirect_has_reference");

4712  
sv
;

4714 
¡ršg
 
	`g‘_æag_¡ršg
() const {

4715  
	`g‘_æag_¡ršg
(
æags
);

4718 
ušt64_t
 
Œunÿ‹_£q
, 
Œunÿ‹_size
;

4720 
m­
<
·œ
<
ušt64_t
, 
’t™y_Çme_t
>, 
w©ch_šfo_t
> 
w©ch”s
;

4723 
__u32
 
d©a_dige¡
;

4724 
__u32
 
om­_dige¡
;

4727 
ušt64_t
 
ex³ùed_objeù_size
, 
ex³ùed_wr™e_size
;

4728 
ušt32_t
 
®loc_hšt_æags
;

4730 
objeù_mªiã¡_t
 
mªiã¡
;

4732 
	`cİy_u£r_b™s
(cÚ¡ 
objeù_šfo_t
& 
Ùh”
);

4734 
boŞ
 
	`‹¡_æag
(
æag_t
 
f
) const {

4735  (
æags
 & 
f
) == f;

4737 
	`£t_æag
(
æag_t
 
f
) {

4738 
æags
 = (
æag_t
)(æag | 
f
);

4740 
	`ş—r_æag
(
æag_t
 
f
) {

4741 
æags
 = (
æag_t
)(æag & ~
f
);

4743 
boŞ
 
	`is_lo¡
() const {

4744  
	`‹¡_æag
(
FLAG_LOST
);

4746 
boŞ
 
	`is_wh™eout
() const {

4747  
	`‹¡_æag
(
FLAG_WHITEOUT
);

4749 
boŞ
 
	`is_dœty
() const {

4750  
	`‹¡_æag
(
FLAG_DIRTY
);

4752 
boŞ
 
	`is_om­
() const {

4753  
	`‹¡_æag
(
FLAG_OMAP
);

4755 
boŞ
 
	`is_d©a_dige¡
() const {

4756  
	`‹¡_æag
(
FLAG_DATA_DIGEST
);

4758 
boŞ
 
	`is_om­_dige¡
() const {

4759  
	`‹¡_æag
(
FLAG_OMAP_DIGEST
);

4761 
boŞ
 
	`is_ÿche_pšÃd
() const {

4762  
	`‹¡_æag
(
FLAG_CACHE_PIN
);

4764 
boŞ
 
	`has_mªiã¡
() const {

4765  
	`‹¡_æag
(
FLAG_MANIFEST
);

4767 
	`£t_d©a_dige¡
(
__u32
 
d
) {

4768 
	`£t_æag
(
FLAG_DATA_DIGEST
);

4769 
d©a_dige¡
 = 
d
;

4771 
	`£t_om­_dige¡
(
__u32
 
d
) {

4772 
	`£t_æag
(
FLAG_OMAP_DIGEST
);

4773 
om­_dige¡
 = 
d
;

4775 
	`ş—r_d©a_dige¡
() {

4776 
	`ş—r_æag
(
FLAG_DATA_DIGEST
);

4777 
d©a_dige¡
 = -1;

4779 
	`ş—r_om­_dige¡
() {

4780 
	`ş—r_æag
(
FLAG_OMAP_DIGEST
);

4781 
om­_dige¡
 = -1;

4783 
	`Ãw_objeù
() {

4784 
	`ş—r_d©a_dige¡
();

4785 
	`ş—r_om­_dige¡
();

4788 
	`’code
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
) const;

4789 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
bl
);

4790 
	`decode
(
bufã¾i¡
& 
bl
) {

4791 
bufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
	`begš
();

4792 
	`decode
(
p
);

4794 
	`dump
(
FÜm©‹r
 *
f
) const;

4795 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
objeù_šfo_t
*>& 
o
);

4797 
ex¶ic™
 
	`objeù_šfo_t
()

4798 : 
	`u£r_v”siÚ
(0), 
	`size
(0), 
	`æags
((
æag_t
)0),

4799 
	`Œunÿ‹_£q
(0), 
	`Œunÿ‹_size
(0),

4800 
	`d©a_dige¡
(-1), 
	`om­_dige¡
(-1),

4801 
	`ex³ùed_objeù_size
(0), 
	`ex³ùed_wr™e_size
(0),

4802 
	`®loc_hšt_æags
(0)

4805 
ex¶ic™
 
	`objeù_šfo_t
(cÚ¡ 
hobjeù_t
& 
s
)

4806 : 
	`soid
(
s
),

4807 
	`u£r_v”siÚ
(0), 
	`size
(0), 
	`æags
((
æag_t
)0),

4808 
	`Œunÿ‹_£q
(0), 
	`Œunÿ‹_size
(0),

4809 
	`d©a_dige¡
(-1), 
	`om­_dige¡
(-1),

4810 
	`ex³ùed_objeù_size
(0), 
	`ex³ùed_wr™e_size
(0),

4811 
	`®loc_hšt_æags
(0)

4814 
ex¶ic™
 
	`objeù_šfo_t
(
bufã¾i¡
& 
bl
) {

4815 
	`decode
(
bl
);

4818 
	$WRITE_CLASS_ENCODER_FEATURES
(
objeù_šfo_t
)

4820 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
objeù_šfo_t
& 
oi
);

4825 
	sObjeùRecov”yInfo
 {

4826 
hobjeù_t
 
soid
;

4827 
ev”siÚ_t
 
v”siÚ
;

4828 
ušt64_t
 
size
;

4829 
objeù_šfo_t
 
oi
;

4830 
SÇpS‘
 
ss
;

4831 
š‹rv®_£t
<
ušt64_t
> 
cİy_sub£t
;

4832 
m­
<
hobjeù_t
, 
š‹rv®_£t
<
ušt64_t
>> 
şÚe_sub£t
;

4834 
	`ObjeùRecov”yInfo
(è: 
	`size
(0) { }

4836 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
ObjeùRecov”yInfo
*>& 
o
);

4837 
	`’code
(
bufã¾i¡
 &
bl
, 
ušt64_t
 
ã©u»s
) const;

4838 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
, 
št64_t
 
poŞ
 = -1);

4839 
o¡»am
 &
	`´št
(o¡»am &
out
) const;

4840 
	`dump
(
FÜm©‹r
 *
f
) const;

4842 
	$WRITE_CLASS_ENCODER_FEATURES
(
ObjeùRecov”yInfo
)

4843 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
ObjeùRecov”yInfo
 &
šf
);

4845 
	sObjeùRecov”yProg»ss
 {

4846 
ušt64_t
 
d©a_»cov”ed_to
;

4847 
¡ršg
 
om­_»cov”ed_to
;

4848 
boŞ
 
fœ¡
;

4849 
boŞ
 
d©a_com¶‘e
;

4850 
boŞ
 
om­_com¶‘e
;

4851 
boŞ
 
”rÜ
 = 
çl£
;

4853 
	`ObjeùRecov”yProg»ss
()

4854 : 
	`d©a_»cov”ed_to
(0),

4855 
	`fœ¡
(
Œue
),

4856 
	`d©a_com¶‘e
(
çl£
), 
	`om­_com¶‘e
(false) { }

4858 
boŞ
 
	`is_com¶‘e
(cÚ¡ 
ObjeùRecov”yInfo
& 
šfo
) const {

4859  (
d©a_»cov”ed_to
 >= (

4860 
šfo
.
cİy_sub£t
.
	`em±y
() ?

4861 0 : 
šfo
.
cİy_sub£t
.
	`¿nge_’d
())) &&

4862 
om­_com¶‘e
;

4865 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
ObjeùRecov”yProg»ss
*>& 
o
);

4866 
	`’code
(
bufã¾i¡
 &
bl
) const;

4867 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

4868 
o¡»am
 &
	`´št
(o¡»am &
out
) const;

4869 
	`dump
(
FÜm©‹r
 *
f
) const;

4871 
	$WRITE_CLASS_ENCODER
(
ObjeùRecov”yProg»ss
)

4872 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
ObjeùRecov”yProg»ss
 &
´og
);

4874 
	sPushR•lyOp
 {

4875 
hobjeù_t
 
soid
;

4877 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
PushR•lyOp
*>& 
o
);

4878 
	`’code
(
bufã¾i¡
 &
bl
) const;

4879 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

4880 
o¡»am
 &
	`´št
(o¡»am &
out
) const;

4881 
	`dump
(
FÜm©‹r
 *
f
) const;

4883 
ušt64_t
 
	`co¡
(
C•hCÚ‹xt
 *
cù
) const;

4885 
	$WRITE_CLASS_ENCODER
(
PushR•lyOp
)

4886 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
PushR•lyOp
 &
İ
);

4888 
	sPuÎOp
 {

4889 
hobjeù_t
 
soid
;

4891 
ObjeùRecov”yInfo
 
»cov”y_šfo
;

4892 
ObjeùRecov”yProg»ss
 
»cov”y_´og»ss
;

4894 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
PuÎOp
*>& 
o
);

4895 
	`’code
(
bufã¾i¡
 &
bl
, 
ušt64_t
 
ã©u»s
) const;

4896 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

4897 
o¡»am
 &
	`´št
(o¡»am &
out
) const;

4898 
	`dump
(
FÜm©‹r
 *
f
) const;

4900 
ušt64_t
 
	`co¡
(
C•hCÚ‹xt
 *
cù
) const;

4902 
	$WRITE_CLASS_ENCODER_FEATURES
(
PuÎOp
)

4903 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
PuÎOp
 &
İ
);

4905 
	sPushOp
 {

4906 
hobjeù_t
 
soid
;

4907 
ev”siÚ_t
 
v”siÚ
;

4908 
bufã¾i¡
 
d©a
;

4909 
š‹rv®_£t
<
ušt64_t
> 
d©a_šşuded
;

4910 
bufã¾i¡
 
om­_h—d”
;

4911 
m­
<
¡ršg
, 
bufã¾i¡
> 
om­_’Œ›s
;

4912 
m­
<
¡ršg
, 
bufã¾i¡
> 
©Œ£t
;

4914 
ObjeùRecov”yInfo
 
»cov”y_šfo
;

4915 
ObjeùRecov”yProg»ss
 
befÜe_´og»ss
;

4916 
ObjeùRecov”yProg»ss
 
aá”_´og»ss
;

4918 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
PushOp
*>& 
o
);

4919 
	`’code
(
bufã¾i¡
 &
bl
, 
ušt64_t
 
ã©u»s
) const;

4920 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
);

4921 
o¡»am
 &
	`´št
(o¡»am &
out
) const;

4922 
	`dump
(
FÜm©‹r
 *
f
) const;

4924 
ušt64_t
 
	`co¡
(
C•hCÚ‹xt
 *
cù
) const;

4926 
	$WRITE_CLASS_ENCODER_FEATURES
(
PushOp
)

4927 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
PushOp
 &
İ
);

4933 
	sSüubM­
 {

4934 
	sobjeù
 {

4935 
m­
<
¡ršg
,
bufã½Œ
> 
©Œs
;

4936 
ušt64_t
 
size
;

4937 
__u32
 
om­_dige¡
;

4938 
__u32
 
dige¡
;

4939 
boŞ
 
Ãg©ive
:1;

4940 
boŞ
 
dige¡_´e£Á
:1;

4941 
boŞ
 
om­_dige¡_´e£Á
:1;

4942 
boŞ
 
»ad_”rÜ
:1;

4943 
boŞ
 
¡©_”rÜ
:1;

4944 
boŞ
 
ec_hash_mism©ch
:1;

4945 
boŞ
 
ec_size_mism©ch
:1;

4946 
boŞ
 
Ïrge_om­_objeù_found
:1;

4947 
ušt64_t
 
Ïrge_om­_objeù_key_couÁ
 = 0;

4948 
ušt64_t
 
Ïrge_om­_objeù_v®ue_size
 = 0;

4950 
	`objeù
() :

4952 
	`size
(-1), 
	`om­_dige¡
(0), 
	`dige¡
(0),

4953 
	`Ãg©ive
(
çl£
), 
	`dige¡_´e£Á
(çl£), 
	`om­_dige¡_´e£Á
(false),

4954 
	`»ad_”rÜ
(
çl£
), 
	`¡©_”rÜ
(çl£), 
	`ec_hash_mism©ch
(false),

4955 
	`ec_size_mism©ch
(
çl£
), 
	`Ïrge_om­_objeù_found
(false) {}

4957 
	`’code
(
bufã¾i¡
& 
bl
) const;

4958 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
bl
);

4959 
	`dump
(
FÜm©‹r
 *
f
) const;

4960 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
objeù
*>& 
o
);

4962 
	`WRITE_CLASS_ENCODER
(
objeù
)

4964 
m­
<
hobjeù_t
,
objeù
> 
objeùs
;

4965 
ev”siÚ_t
 
v®id_through
;

4966 
ev”siÚ_t
 
šü_sšû
;

4967 
boŞ
 
has_Ïrge_om­_objeù_”rÜs
:1;

4969 
	`m”ge_šü
(cÚ¡ 
SüubM­
 &
l
);

4970 
	`š£¹
(cÚ¡ 
SüubM­
 &
r
) {

4971 
objeùs
.
	`š£¹
(
r
.objeùs.
	`begš
(),„.objeùs.
	`’d
());

4973 
	`sw­
(
SüubM­
 &
r
) {

4974 
usšg
 
¡d
::
sw­
;

4975 
	`sw­
(
objeùs
, 
r
.objects);

4976 
	`sw­
(
v®id_through
, 
r
.valid_through);

4977 
	`sw­
(
šü_sšû
, 
r
.incr_since);

4980 
	`’code
(
bufã¾i¡
& 
bl
) const;

4981 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
bl
, 
št64_t
 
poŞ
=-1);

4982 
	`dump
(
FÜm©‹r
 *
f
) const;

4983 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
SüubM­
*>& 
o
);

4985 
	$WRITE_CLASS_ENCODER
(
SüubM­
::
objeù
)

4986 
	$WRITE_CLASS_ENCODER
(
SüubM­
)

4988 
	sSüubM­Bud”
 {

4989 
boŞ
 
d“p
 = 
çl£
;

4990 
veùÜ
<
hobjeù_t
> 
ls
;

4991 
size_t
 
pos
 = 0;

4992 
št64_t
 
d©a_pos
 = 0;

4993 
¡ršg
 
om­_pos
;

4994 
»t
 = 0;

4995 
bufãrhash
 
d©a_hash
, 
om­_hash
;

4996 
ušt64_t
 
om­_keys
 = 0;

4997 
ušt64_t
 
om­_by‹s
 = 0;

4999 
boŞ
 
	`em±y
() {

5000  
ls
.
	`em±y
();

5002 
boŞ
 
	`dÚe
() {

5003  
pos
 >ğ
ls
.
	`size
();

5005 
	`»£t
() {

5006 *
this
 = 
	`SüubM­Bud”
();

5009 
boŞ
 
	`d©a_dÚe
() {

5010  
d©a_pos
 < 0;

5013 
	`Ãxt_objeù
() {

5014 ++
pos
;

5015 
d©a_pos
 = 0;

5016 
om­_pos
.
	`ş—r
();

5017 
om­_keys
 = 0;

5018 
om­_by‹s
 = 0;

5021 
ä›nd
 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
SüubM­Bud”
& 
pos
) {

5022 
out
 << "(" << 
pos
.po << "/" <<…os.
ls
.
	`size
();

5023 ià(
pos
.po <…os.
ls
.
	`size
()) {

5024 
out
 << " " << 
pos
.
ls
[pos.pos];

5026 ià(
pos
.
d©a_pos
 < 0) {

5027 
out
 << " by‹ " << 
pos
.
d©a_pos
;

5029 ià(!
pos
.
om­_pos
.
	`em±y
()) {

5030 
out
 << " key " << 
pos
.
om­_pos
;

5032 ià(
pos
.
d“p
) {

5033 
out
 << " deep";

5035 ià(
pos
.
»t
) {

5036 
out
 << "„‘ " << 
pos
.
»t
;

5038  
out
 << ")";

5042 
	sOSDOp
 {

5043 
ûph_osd_İ
 
İ
;

5044 
sobjeù_t
 
soid
;

5046 
bufã¾i¡
 
šd©a
, 
outd©a
;

5047 
”rÜcode32_t
 
rv®
;

5049 
	`OSDOp
(è: 
	`rv®
(0) {

5050 
	`mem£t
(&
İ
, 0, (
ûph_osd_İ
));

5059 
	`¥l™_osd_İ_veùÜ_š_d©a
(
veùÜ
<
OSDOp
>& 
İs
, 
bufã¾i¡
& 
š
);

5070 
	`m”ge_osd_İ_veùÜ_š_d©a
(
veùÜ
<
OSDOp
>& 
İs
, 
bufã¾i¡
& 
out
);

5078 
	`¥l™_osd_İ_veùÜ_out_d©a
(
veùÜ
<
OSDOp
>& 
İs
, 
bufã¾i¡
& 
š
);

5086 
	`m”ge_osd_İ_veùÜ_out_d©a
(
veùÜ
<
OSDOp
>& 
İs
, 
bufã¾i¡
& 
out
);

5093 
	`ş—r_d©a
(
veùÜ
<
OSDOp
>& 
İs
);

5096 
o¡»am
& 
İ”©Ü
<<(o¡»am& 
out
, cÚ¡ 
OSDOp
& 
İ
);

5098 
	sw©ch_™em_t
 {

5099 
’t™y_Çme_t
 
Çme
;

5100 
ušt64_t
 
cook›
;

5101 
ušt32_t
 
timeout_£cÚds
;

5102 
’t™y_addr_t
 
addr
;

5104 
	`w©ch_™em_t
(è: 
	`cook›
(0), 
	`timeout_£cÚds
(0) { }

5105 
	`w©ch_™em_t
(
’t™y_Çme_t
 
Çme
, 
ušt64_t
 
cook›
, 
ušt32_t
 
timeout
,

5106 cÚ¡ 
’t™y_addr_t
& 
addr
)

5107 : 
	`Çme
(
Çme
), 
	`cook›
(
cook›
), 
	`timeout_£cÚds
(
timeout
),

5108 
	`addr
(
addr
) { }

5110 
	`’code
(
bufã¾i¡
 &
bl
, 
ušt64_t
 
ã©u»s
) const {

5111 
	`ENCODE_START
(2, 1, 
bl
);

5112 
	`’code
(
Çme
, 
bl
);

5113 
	`’code
(
cook›
, 
bl
);

5114 
	`’code
(
timeout_£cÚds
, 
bl
);

5115 
	`’code
(
addr
, 
bl
, 
ã©u»s
);

5116 
	`ENCODE_FINISH
(
bl
);

5118 
	`decode
(
bufã¾i¡
::
™”©Ü
 &
bl
) {

5119 
	`DECODE_START
(2, 
bl
);

5120 
	`decode
(
Çme
, 
bl
);

5121 
	`decode
(
cook›
, 
bl
);

5122 
	`decode
(
timeout_£cÚds
, 
bl
);

5123 ià(
¡ruù_v
 >= 2) {

5124 
	`decode
(
addr
, 
bl
);

5126 
	`DECODE_FINISH
(
bl
);

5129 
	$WRITE_CLASS_ENCODER_FEATURES
(
w©ch_™em_t
)

5131 
	sobj_w©ch_™em_t
 {

5132 
hobjeù_t
 
obj
;

5133 
w©ch_™em_t
 
wi
;

5140 
	sobj_li¡_w©ch_»¥Ú£_t
 {

5141 
li¡
<
w©ch_™em_t
> 
’Œ›s
;

5143 
	`’code
(
bufã¾i¡
& 
bl
, 
ušt64_t
 
ã©u»s
) const {

5144 
	`ENCODE_START
(1, 1, 
bl
);

5145 
	`’code
(
’Œ›s
, 
bl
, 
ã©u»s
);

5146 
	`ENCODE_FINISH
(
bl
);

5148 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
bl
) {

5149 
	`DECODE_START
(1, 
bl
);

5150 
	`decode
(
’Œ›s
, 
bl
);

5151 
	`DECODE_FINISH
(
bl
);

5153 
	`dump
(
FÜm©‹r
 *
f
) const {

5154 
f
->
	`İ’_¬¿y_£ùiÚ
("entries");

5155 
li¡
<
w©ch_™em_t
>::
cÚ¡_™”©Ü
 
p
 = 
’Œ›s
.
	`begš
();… !ğ’Œ›s.
	`’d
(); ++p) {

5156 
f
->
	`İ’_objeù_£ùiÚ
("watch");

5157 
f
->
	`dump_¡»am
("w©ch”"è<< 
p
->
Çme
;

5158 
f
->
	`dump_št
("cook›", 
p
->
cook›
);

5159 
f
->
	`dump_št
("timeout", 
p
->
timeout_£cÚds
);

5160 
f
->
	`İ’_objeù_£ùiÚ
("addr");

5161 
p
->
addr
.
	`dump
(
f
);

5162 
f
->
	`şo£_£ùiÚ
();

5163 
f
->
	`şo£_£ùiÚ
();

5165 
f
->
	`şo£_£ùiÚ
();

5167 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
obj_li¡_w©ch_»¥Ú£_t
*>& 
o
) {

5168 
’t™y_addr_t
 
—
;

5169 
o
.
	`push_back
(
Ãw
 
obj_li¡_w©ch_»¥Ú£_t
);

5170 
o
.
	`push_back
(
Ãw
 
obj_li¡_w©ch_»¥Ú£_t
);

5171 
—
.
	`£t_ty³
(
’t™y_addr_t
::
TYPE_LEGACY
);

5172 
—
.
	`£t_nÚû
(1000);

5173 
—
.
	`£t_çmy
(
AF_INET
);

5174 
—
.
	`£t_š4_quad
(0, 127);

5175 
—
.
	`£t_š4_quad
(1, 0);

5176 
—
.
	`£t_š4_quad
(2, 0);

5177 
—
.
	`£t_š4_quad
(3, 1);

5178 
—
.
	`£t_pÜt
(1024);

5179 
o
.
	`back
()->
’Œ›s
.
	`push_back
(
	`w©ch_™em_t
(
	`’t™y_Çme_t
(
’t™y_Çme_t
::
TYPE_CLIENT
, 1), 10, 30, 
—
));

5180 
—
.
	`£t_nÚû
(1001);

5181 
—
.
	`£t_š4_quad
(3, 2);

5182 
—
.
	`£t_pÜt
(1025);

5183 
o
.
	`back
()->
’Œ›s
.
	`push_back
(
	`w©ch_™em_t
(
	`’t™y_Çme_t
(
’t™y_Çme_t
::
TYPE_CLIENT
, 2), 20, 60, 
—
));

5186 
	$WRITE_CLASS_ENCODER_FEATURES
(
obj_li¡_w©ch_»¥Ú£_t
)

5188 
	sşÚe_šfo
 {

5189 
¢­id_t
 
şÚeid
;

5190 
veùÜ
<
¢­id_t
> 
¢­s
;

5191 
veùÜ
< 
·œ
<
ušt64_t
,ušt64_t> > 
ov”Ïp
;

5192 
ušt64_t
 
size
;

5194 
	`şÚe_šfo
(è: 
	`şÚeid
(
CEPH_NOSNAP
), 
	`size
(0) {}

5196 
	`’code
(
bufã¾i¡
& 
bl
) const {

5197 
	`ENCODE_START
(1, 1, 
bl
);

5198 
	`’code
(
şÚeid
, 
bl
);

5199 
	`’code
(
¢­s
, 
bl
);

5200 
	`’code
(
ov”Ïp
, 
bl
);

5201 
	`’code
(
size
, 
bl
);

5202 
	`ENCODE_FINISH
(
bl
);

5204 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
bl
) {

5205 
	`DECODE_START
(1, 
bl
);

5206 
	`decode
(
şÚeid
, 
bl
);

5207 
	`decode
(
¢­s
, 
bl
);

5208 
	`decode
(
ov”Ïp
, 
bl
);

5209 
	`decode
(
size
, 
bl
);

5210 
	`DECODE_FINISH
(
bl
);

5212 
	`dump
(
FÜm©‹r
 *
f
) const {

5213 ià(
şÚeid
 =ğ
CEPH_NOSNAP
)

5214 
f
->
	`dump_¡ršg
("cloneid", "HEAD");

5216 
f
->
	`dump_unsigÃd
("şÚeid", 
şÚeid
.
v®
);

5217 
f
->
	`İ’_¬¿y_£ùiÚ
("snapshots");

5218 
veùÜ
<
¢­id_t
>::
cÚ¡_™”©Ü
 
p
 = 
¢­s
.
	`begš
();… !ğ¢­s.
	`’d
(); ++p) {

5219 
f
->
	`İ’_objeù_£ùiÚ
("snap");

5220 
f
->
	`dump_unsigÃd
("id", 
p
->
v®
);

5221 
f
->
	`şo£_£ùiÚ
();

5223 
f
->
	`şo£_£ùiÚ
();

5224 
f
->
	`İ’_¬¿y_£ùiÚ
("overlaps");

5225 
veùÜ
< 
·œ
<
ušt64_t
,ušt64_t> >::
cÚ¡_™”©Ü
 
q
 = 
ov”Ïp
.
	`begš
();

5226 
q
 !ğ
ov”Ïp
.
	`’d
(); ++q) {

5227 
f
->
	`İ’_objeù_£ùiÚ
("overlap");

5228 
f
->
	`dump_unsigÃd
("off£t", 
q
->
fœ¡
);

5229 
f
->
	`dump_unsigÃd
("Ëngth", 
q
->
£cÚd
);

5230 
f
->
	`şo£_£ùiÚ
();

5232 
f
->
	`şo£_£ùiÚ
();

5233 
f
->
	`dump_unsigÃd
("size", 
size
);

5235 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
şÚe_šfo
*>& 
o
) {

5236 
o
.
	`push_back
(
Ãw
 
şÚe_šfo
);

5237 
o
.
	`push_back
(
Ãw
 
şÚe_šfo
);

5238 
o
.
	`back
()->
şÚeid
 = 1;

5239 
o
.
	`back
()->
¢­s
.
	`push_back
(1);

5240 
o
.
	`back
()->
ov”Ïp
.
	`push_back
(
·œ
<
ušt64_t
,uint64_t>(0,4096));

5241 
o
.
	`back
()->
ov”Ïp
.
	`push_back
(
·œ
<
ušt64_t
,uint64_t>(8192,4096));

5242 
o
.
	`back
()->
size
 = 16384;

5243 
o
.
	`push_back
(
Ãw
 
şÚe_šfo
);

5244 
o
.
	`back
()->
şÚeid
 = 
CEPH_NOSNAP
;

5245 
o
.
	`back
()->
size
 = 32768;

5248 
	$WRITE_CLASS_ENCODER
(
şÚe_šfo
)

5254 
	sobj_li¡_¢­_»¥Ú£_t
 {

5255 
veùÜ
<
şÚe_šfo
> 
şÚes
;

5256 
¢­id_t
 
£q
;

5258 
	`’code
(
bufã¾i¡
& 
bl
) const {

5259 
	`ENCODE_START
(2, 1, 
bl
);

5260 
	`’code
(
şÚes
, 
bl
);

5261 
	`’code
(
£q
, 
bl
);

5262 
	`ENCODE_FINISH
(
bl
);

5264 
	`decode
(
bufã¾i¡
::
™”©Ü
& 
bl
) {

5265 
	`DECODE_START
(2, 
bl
);

5266 
	`decode
(
şÚes
, 
bl
);

5267 ià(
¡ruù_v
 >= 2)

5268 
	`decode
(
£q
, 
bl
);

5270 
£q
 = 
CEPH_NOSNAP
;

5271 
	`DECODE_FINISH
(
bl
);

5273 
	`dump
(
FÜm©‹r
 *
f
) const {

5274 
f
->
	`İ’_¬¿y_£ùiÚ
("clones");

5275 
veùÜ
<
şÚe_šfo
>::
cÚ¡_™”©Ü
 
p
 = 
şÚes
.
	`begš
();… !ğşÚes.
	`’d
(); ++p) {

5276 
f
->
	`İ’_objeù_£ùiÚ
("clone");

5277 
p
->
	`dump
(
f
);

5278 
f
->
	`şo£_£ùiÚ
();

5280 
f
->
	`dump_unsigÃd
("£q", 
£q
);

5281 
f
->
	`şo£_£ùiÚ
();

5283 
	`g’”©e_‹¡_š¡ªûs
(
li¡
<
obj_li¡_¢­_»¥Ú£_t
*>& 
o
) {

5284 
o
.
	`push_back
(
Ãw
 
obj_li¡_¢­_»¥Ú£_t
);

5285 
o
.
	`push_back
(
Ãw
 
obj_li¡_¢­_»¥Ú£_t
);

5286 
şÚe_šfo
 
ş
;

5287 
ş
.
şÚeid
 = 1;

5288 
ş
.
¢­s
.
	`push_back
(1);

5289 
ş
.
ov”Ïp
.
	`push_back
(
·œ
<
ušt64_t
,uint64_t>(0,4096));

5290 
ş
.
ov”Ïp
.
	`push_back
(
·œ
<
ušt64_t
,uint64_t>(8192,4096));

5291 
ş
.
size
 = 16384;

5292 
o
.
	`back
()->
şÚes
.
	`push_back
(
ş
);

5293 
ş
.
şÚeid
 = 
CEPH_NOSNAP
;

5294 
ş
.
¢­s
.
	`ş—r
();

5295 
ş
.
ov”Ïp
.
	`ş—r
();

5296 
ş
.
size
 = 32768;

5297 
o
.
	`back
()->
şÚes
.
	`push_back
(
ş
);

5298 
o
.
	`back
()->
£q
 = 123;

5302 
	$WRITE_CLASS_ENCODER
(
obj_li¡_¢­_»¥Ú£_t
)

5306 
	sPromÙeCouÁ”
 {

5307 
¡d
::
©omic
<> 
©‹m±s
{0};

5308 
¡d
::
©omic
<> 
objeùs
{0};

5309 
¡d
::
©omic
<> 
by‹s
{0};

5311 
	`©‹m±
() {

5312 
©‹m±s
++;

5315 
	`fšish
(
ušt64_t
 
size
) {

5316 
objeùs
++;

5317 
by‹s
 +ğ
size
;

5320 
	`§m¶e_ªd_©‹nu©e
(
ušt64_t
 *
a
, ušt64_ˆ*
o
, ušt64_ˆ*
b
) {

5321 *
a
 = 
©‹m±s
;

5322 *
o
 = 
objeùs
;

5323 *
b
 = 
by‹s
;

5324 
©‹m±s
 = *
a
 / 2;

5325 
objeùs
 = *
o
 / 2;

5326 
by‹s
 = *
b
 / 2;

5333 
	s¡Üe_¡©fs_t


5335 
ušt64_t
 
tÙ®
 = 0;

5336 
ušt64_t
 
avaabË
 = 0;

5338 
št64_t
 
®loÿ‹d
 = 0;

5339 
št64_t
 
¡Üed
 = 0;

5340 
št64_t
 
com´es£d
 = 0;

5341 
št64_t
 
com´es£d_®loÿ‹d
 = 0;

5342 
št64_t
 
com´es£d_Üigš®
 = 0;

5344 
	`»£t
() {

5345 *
this
 = 
	`¡Üe_¡©fs_t
();

5347 
boŞ
 
İ”©Ü
 ==(cÚ¡ 
¡Üe_¡©fs_t
& 
Ùh”
) const;

5348 
	`dump
(
FÜm©‹r
 *
f
) const;

5350 
o¡»am
 &
İ”©Ü
<<(o¡»am &
lhs
, cÚ¡ 
¡Üe_¡©fs_t
 &
rhs
);

	@osdc/Filer.cc

16 
	~<mu‹x
>

17 
	~<®gÜ™hm
>

18 
	~"F”.h
"

19 
	~"osd/OSDM­.h
"

20 
	~"SŒ”.h
"

22 
	~"mes§ges/MOSDOp.h
"

23 
	~"mes§ges/MOSDOpR•ly.h
"

24 
	~"mes§ges/MOSDM­.h
"

26 
	~"msg/Mes£ng”.h
"

28 
	~"šşude/CÚ‹xt.h
"

30 
	~"commÚ/Fšish”.h
"

31 
	~"commÚ/cÚfig.h
"

33 
	#dout_subsys
 
ûph_subsys_f”


	)

34 #undeà
dout_´efix


35 
	#dout_´efix
 *
_dout
 << 
objeù”
->
mes£ng”
->
	`g‘_myÇme
(è<< ".f” "

	)

37 şas 
	cF”
::
C_Probe
 : 
public
 
CÚ‹xt
 {

38 
public
:

39 
F”
 *
f”
;

40 
Probe
 *
	m´obe
;

41 
objeù_t
 
	moid
;

42 
ušt64_t
 
	msize
;

43 
	mûph
::
»®_time
 
mtime
;

44 
	$C_Probe
(
F”
 *
f
, 
Probe
 *
p
, 
objeù_t
 
o
è: 
	`f”
(f), 
	`´obe
Õ), 
	`oid
(o),

45 
	$size
(0) {}

46 
	$fšish
(
r
è
ov”ride
 {

47 ià(
r
 =ğ-
ENOENT
) {

48 
r
 = 0;

49 
	`as£¹
(
size
 == 0);

52 
boŞ
 
´obe_com¶‘e
;

54 
Probe
::
unique_lock
 
	`¶
(
´obe
->
lock
);

55 ià(
r
 != 0) {

56 
´obe
->
”r
 = 
r
;

59 
´obe_com¶‘e
 = 
f”
->
	`_´obed
(
´obe
, 
oid
, 
size
, 
mtime
, 
¶
);

60 
	`as£¹
(!
¶
.
	`owns_lock
());

62 ià(
´obe_com¶‘e
) {

63 
´obe
->
Úfšish
->
	`com¶‘e
Õrobe->
”r
);

64 
d–‘e
 
´obe
;

66 
	}
}

69 
	gF”
::
	$´obe
(
šod’o_t
 
šo
,

70 
fe_Ïyout_t
 *
Ïyout
,

71 
¢­id_t
 
¢­id
,

72 
ušt64_t
 
¡¬t_äom
,

73 
ušt64_t
 *
’d
,

74 
ûph
::
»®_time
 *
pmtime
,

75 
boŞ
 
fwd
,

76 
æags
,

77 
CÚ‹xt
 *
Úfšish
)

79 
	`ldout
(
cù
, 10è<< "´ob" << (
fwd
 ? "fwd ":"bwd ")

80 << 
hex
 << 
šo
 << 
dec


81 << " s¹šg from " << 
¡¬t_äom


82 << 
d’dl
;

84 
	`as£¹
(
¢­id
);

86 
Probe
 *
´obe
 = 
Ãw
 
	`Probe
(
šo
, *
Ïyout
, 
¢­id
, 
¡¬t_äom
, 
’d
, 
pmtime
,

87 
æags
, 
fwd
, 
Úfšish
);

89  
	`´obe_im¶
(
´obe
, 
Ïyout
, 
¡¬t_äom
, 
’d
);

90 
	}
}

92 
	gF”
::
	$´obe
(
šod’o_t
 
šo
,

93 
fe_Ïyout_t
 *
Ïyout
,

94 
¢­id_t
 
¢­id
,

95 
ušt64_t
 
¡¬t_äom
,

96 
ušt64_t
 *
’d
,

97 
utime_t
 *
pmtime
,

98 
boŞ
 
fwd
,

99 
æags
,

100 
CÚ‹xt
 *
Úfšish
)

102 
	`ldout
(
cù
, 10è<< "´ob" << (
fwd
 ? "fwd ":"bwd ")

103 << 
hex
 << 
šo
 << 
dec


104 << " s¹šg from " << 
¡¬t_äom


105 << 
d’dl
;

107 
	`as£¹
(
¢­id
);

109 
Probe
 *
´obe
 = 
Ãw
 
	`Probe
(
šo
, *
Ïyout
, 
¢­id
, 
¡¬t_äom
, 
’d
, 
pmtime
,

110 
æags
, 
fwd
, 
Úfšish
);

111  
	`´obe_im¶
(
´obe
, 
Ïyout
, 
¡¬t_äom
, 
’d
);

112 
	}
}

114 
	gF”
::
	$´obe_im¶
(
Probe
* 
´obe
, 
fe_Ïyout_t
 *
Ïyout
,

115 
ušt64_t
 
¡¬t_äom
, ušt64_ˆ*
’d
)

118 
ušt64_t
 
³riod
 = 
Ïyout
->
	`g‘_³riod
();

121 
´obe
->
´obšg_Ën
 = 
³riod
;

122 ià(
´obe
->
fwd
) {

123 ià(
¡¬t_äom
 % 
³riod
)

124 
´obe
->
´obšg_Ën
 +ğ
³riod
 - (
¡¬t_äom
 %…eriod);

126 
	`as£¹
(
¡¬t_äom
 > *
’d
);

127 ià(
¡¬t_äom
 % 
³riod
)

128 
´obe
->
´obšg_Ën
 -ğ
³riod
 - (
¡¬t_äom
 %…eriod);

129 
´obe
->
´obšg_off
 -ğ´obe->
´obšg_Ën
;

132 
Probe
::
unique_lock
 
	`¶
(
´obe
->
lock
);

133 
	`_´obe
(
´obe
, 
¶
);

134 
	`as£¹
(!
¶
.
	`owns_lock
());

137 
	}
}

144 
	gF”
::
	$_´obe
(
Probe
 *
´obe
, Probe::
unique_lock
& 
¶
)

146 
	`as£¹
(
¶
.
	`owns_lock
(è&&…l.
	`mu‹x
(è=ğ&
´obe
->
lock
);

148 
	`ldout
(
cù
, 10è<< "_´ob" << 
hex
 << 
´obe
->
šo
 << 
dec


149 << " " << 
´obe
->
´obšg_off
 << "~" <<…robe->
´obšg_Ën


150 << 
d’dl
;

153 
´obe
->
known_size
.
	`ş—r
();

154 
´obe
->
´obšg
.
	`ş—r
();

155 
SŒ”
::
	`fe_to_ex‹Ás
(
cù
, 
´obe
->
šo
, &´obe->
Ïyout
,…robe->
´obšg_off
,

156 
´obe
->
´obšg_Ën
, 0,…robe->
´obšg
);

158 
¡d
::
veùÜ
<
ObjeùEx‹Á
> 
¡©_ex‹Ás
;

159 
veùÜ
<
ObjeùEx‹Á
>::
™”©Ü
 
p
 = 
´obe
->
´obšg
.
	`begš
();

160 
p
 !ğ
´obe
->
´obšg
.
	`’d
();

161 ++
p
) {

162 
	`ldout
(
cù
, 10è<< "_´ob…robšg " << 
p
->
oid
 << 
d’dl
;

163 
´obe
->
İs
.
	`š£¹
(
p
->
oid
);

164 
¡©_ex‹Ás
.
	`push_back
(*
p
);

167 
¶
.
	`uÆock
();

168 
¡d
::
veùÜ
<
ObjeùEx‹Á
>::
™”©Ü
 
i
 = 
¡©_ex‹Ás
.
	`begš
();

169 
i
 !ğ
¡©_ex‹Ás
.
	`’d
(); ++i) {

170 
C_Probe
 *
c
 = 
Ãw
 
	`C_Probe
(
this
, 
´obe
, 
i
->
oid
);

171 
objeù”
->
	`¡©
(
i
->
oid
, i->
Şoc
, 
´obe
->
¢­id
, &
c
->
size
, &c->
mtime
,

172 
´obe
->
æags
 | 
CEPH_OSD_FLAG_RWORDERED
,

173 
Ãw
 
	`C_OnFšish”
(
c
, 
fšish”
));

175 
	}
}

182 
boŞ
 
	gF”
::
	$_´obed
(
Probe
 *
´obe
, cÚ¡ 
objeù_t
& 
oid
, 
ušt64_t
 
size
,

183 
ûph
::
»®_time
 
mtime
, 
Probe
::
unique_lock
& 
¶
)

185 
	`as£¹
(
¶
.
	`owns_lock
(è&&…l.
	`mu‹x
(è=ğ&
´obe
->
lock
);

187 
	`ldout
(
cù
, 10è<< "_´obed " << 
´obe
->
šo
 << " objeù " << 
oid


188 << " ha siz" << 
size
 << " mtim" << 
mtime
 << 
d’dl
;

190 
´obe
->
known_size
[
oid
] = 
size
;

191 ià(
mtime
 > 
´obe
->
max_mtime
)

192 
´obe
->
max_mtime
 = 
mtime
;

194 
	`as£¹
(
´obe
->
İs
.
	`couÁ
(
oid
));

195 
´obe
->
İs
.
	`”a£
(
oid
);

197 ià(!
´obe
->
İs
.
	`em±y
()) {

198 
¶
.
	`uÆock
();

199  
çl£
;

202 ià(
´obe
->
”r
) {

203 
¶
.
	`uÆock
();

204  
Œue
;

208 
ušt64_t
 
’d
 = 0;

210 ià(!
´obe
->
fwd
) {

211 
¡d
::
	`»v”£
(
´obe
->
´obšg
.
	`begš
(),…robe->´obšg.
	`’d
());

214 
veùÜ
<
ObjeùEx‹Á
>::
™”©Ü
 
p
 = 
´obe
->
´obšg
.
	`begš
();

215 
p
 !ğ
´obe
->
´obšg
.
	`’d
();

216 ++
p
) {

217 
ušt64_t
 
shouldbe
 = 
p
->
Ëngth
 +…->
off£t
;

218 
	`ldout
(
cù
, 10è<< "_´obed " << 
´obe
->
šo
 << " objeù " << 
hex


219 << 
p
->
oid
 << 
dec
 << " should b" << 
shouldbe


220 << ",‡ùu® i " << 
´obe
->
known_size
[
p
->
oid
]

221 << 
d’dl
;

223 ià(!
´obe
->
found_size
) {

224 
	`as£¹
(
´obe
->
known_size
[
p
->
oid
] <ğ
shouldbe
);

226 ià((
´obe
->
fwd
 &&…robe->
known_size
[
p
->
oid
] =ğ
shouldbe
) ||

227 (!
´obe
->
fwd
 &&…robe->
known_size
[
p
->
oid
] == 0 &&

228 
´obe
->
´obšg_off
 > 0))

233 
ušt64_t
 
Şeá
 = 
´obe
->
known_size
[
p
->
oid
] -…->
off£t
;

234 
veùÜ
<
·œ
<
ušt64_t
, ušt64_t> >::
™”©Ü
 
i


235 ğ
p
->
bufãr_ex‹Ás
.
	`begš
();

236 
i
 !ğ
p
->
bufãr_ex‹Ás
.
	`’d
();

237 ++
i
) {

238 ià(
Şeá
 <ğ(
ušt64_t
)
i
->
£cÚd
) {

239 
’d
 = 
´obe
->
´obšg_off
 + 
i
->
fœ¡
 + 
Şeá
;

240 
	`ldout
(
cù
, 10è<< "_´obedƒnd i š bufãr_ex‹Á " << 
i
->
fœ¡


241 << "~" << 
i
->
£cÚd
 << " ofà" << 
Şeá


242 << ", from wa " << 
´obe
->
´obšg_off
 << ",ƒnd is "

243 << 
’d
 << 
d’dl
;

245 
´obe
->
found_size
 = 
Œue
;

246 
	`ldout
(
cù
, 10è<< "_´obed found siz© " << 
’d
 << 
d’dl
;

247 *
´obe
->
psize
 = 
’d
;

249 ià(!
´obe
->
pmtime
 &&

250 !
´obe
->
pumtime
)

253 
Şeá
 -ğ
i
->
£cÚd
;

259 ià(!
´obe
->
found_size
 || (´obe->
´obšg_off
 && (´obe->
pmtime
 ||

260 
´obe
->
pumtime
))) {

262 
	`ldout
(
cù
, 10è<< "_´obed…robšg fu¹h”" << 
d’dl
;

264 
ušt64_t
 
³riod
 = 
´obe
->
Ïyout
.
	`g‘_³riod
();

265 ià(
´obe
->
fwd
) {

266 
´obe
->
´obšg_off
 +ğ´obe->
´obšg_Ën
;

267 
	`as£¹
(
´obe
->
´obšg_off
 % 
³riod
 == 0);

268 
´obe
->
´obšg_Ën
 = 
³riod
;

271 
	`as£¹
(
´obe
->
´obšg_off
 % 
³riod
 == 0);

272 
´obe
->
´obšg_Ën
 = 
³riod
;

273 
´obe
->
´obšg_off
 -ğ
³riod
;

275 
	`_´obe
(
´obe
, 
¶
);

276 
	`as£¹
(!
¶
.
	`owns_lock
());

277  
çl£
;

278 } ià(
´obe
->
pmtime
) {

279 
	`ldout
(
cù
, 10è<< "_´obed found mtim" << 
´obe
->
max_mtime
 << 
d’dl
;

280 *
´obe
->
pmtime
 =…robe->
max_mtime
;

281 } ià(
´obe
->
pumtime
) {

282 
	`ldout
(
cù
, 10è<< "_´obed found mtim" << 
´obe
->
max_mtime
 << 
d’dl
;

283 *
´obe
->
pumtime
 = 
ûph
::
»®_şock
::
	`to_ûph_time¥ec
Õrobe->
max_mtime
);

286 
¶
.
	`uÆock
();

287  
Œue
;

288 
	}
}

293 
	sPurgeRªge
 {

294 
	m¡d
::
mu‹x
 
lock
;

295 
	m¡d
::
	tlock_gu¬d
<
	t¡d
::
	tmu‹x
>†ock_guard;

296 
	m¡d
::
	tunique_lock
<
	t¡d
::
	tmu‹x
> unique_lock;

297 
šod’o_t
 
	mšo
;

298 
fe_Ïyout_t
 
	mÏyout
;

299 
SÇpCÚ‹xt
 
	m¢­c
;

300 
ušt64_t
 
	mfœ¡
, 
	mnum
;

301 
	mûph
::
»®_time
 
mtime
;

302 
	mæags
;

303 
CÚ‹xt
 *
	mÚcomm™
;

304 
	muncomm™‹d
;

305 
PurgeRªge
(
šod’o_t
 
i
, cÚ¡ 
fe_Ïyout_t
& 
l
, cÚ¡ 
SÇpCÚ‹xt
& 
sc
,

306 
ušt64_t
 
fo
, ušt64_ˆ
no
, 
ûph
::
»®_time
 
t
, 
æ
,

307 
CÚ‹xt
 *
fš
)

308 : 
šo
(
i
), 
Ïyout
(
l
), 
¢­c
(
sc
), 
fœ¡
(
fo
), 
num
(
no
), 
mtime
(
t
), 
æags
(
æ
),

309 
Úcomm™
(
fš
), 
uncomm™‹d
(0) {}

312 
	gF”
::
	$purge_¿nge
(
šod’o_t
 
šo
,

313 cÚ¡ 
fe_Ïyout_t
 *
Ïyout
,

314 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

315 
ušt64_t
 
fœ¡_obj
, ušt64_ˆ
num_obj
,

316 
ûph
::
»®_time
 
mtime
,

317 
æags
,

318 
CÚ‹xt
 *
Úcomm™
)

320 
	`as£¹
(
num_obj
 > 0);

323 ià(
num_obj
 == 1) {

324 
objeù_t
 
oid
 = 
	`fe_objeù_t
(
šo
, 
fœ¡_obj
);

325 
objeù_loÿtÜ_t
 
Şoc
 = 
OSDM­
::
	`fe_to_objeù_loÿtÜ
(*
Ïyout
);

326 
objeù”
->
	`»move
(
oid
, 
Şoc
, 
¢­c
, 
mtime
, 
æags
, 
Úcomm™
);

330 
PurgeRªge
 *
´
 = 
Ãw
 
	`PurgeRªge
(
šo
, *
Ïyout
, 
¢­c
, 
fœ¡_obj
,

331 
num_obj
, 
mtime
, 
æags
, 
Úcomm™
);

333 
	`_do_purge_¿nge
(
´
, 0);

335 
	}
}

337 
	gC_PurgeRªge
 : 
public
 
CÚ‹xt
 {

338 
F”
 *
f”
;

339 
PurgeRªge
 *
	g´
;

340 
C_PurgeRªge
(
F”
 *
f
, 
PurgeRªge
 *
p
è: 
f”
(f), 
´
(p) {}

341 
fšish
(
r
è
	gov”ride
 {

342 
	gf”
->
_do_purge_¿nge
(
´
, 1);

346 
	gF”
::
	$_do_purge_¿nge
(
PurgeRªge
 *
´
, 
fš
)

348 
PurgeRªge
::
unique_lock
 
	`´l
(
´
->
lock
);

349 
´
->
uncomm™‹d
 -ğ
fš
;

350 
	`ldout
(
cù
, 10è<< "_do_purge_¿ng" << 
´
->
šo
 << " objeù " <<…r->
fœ¡


351 << "~" << 
´
->
num
 << " uncomm™‹d " <<…r->
uncomm™‹d


352 << 
d’dl
;

354 ià(
´
->
num
 =ğ0 &&…r->
uncomm™‹d
 == 0) {

355 
´
->
Úcomm™
->
	`com¶‘e
(0);

356 
´l
.
	`uÆock
();

357 
d–‘e
 
´
;

361 
¡d
::
veùÜ
<
objeù_t
> 
»move_oids
;

363 
max
 = 
cù
->
_cÚf
->
f”_max_purge_İs
 - 
´
->
uncomm™‹d
;

364 
´
->
num
 > 0 && 
max
 > 0) {

365 
»move_oids
.
	`push_back
(
	`fe_objeù_t
(
´
->
šo
,…r->
fœ¡
));

366 
´
->
uncomm™‹d
++;

367 
´
->
fœ¡
++;

368 
´
->
num
--;

369 
max
--;

371 
´l
.
	`uÆock
();

374 cÚ¡‡uto& 
oid
 : 
»move_oids
) {

375 
objeù_loÿtÜ_t
 
Şoc
 = 
OSDM­
::
	`fe_to_objeù_loÿtÜ
(
´
->
Ïyout
);

376 
objeù”
->
	`»move
(
oid
, 
Şoc
, 
´
->
¢­c
,…r->
mtime
,…r->
æags
,

377 
Ãw
 
	`C_OnFšish”
Òew 
	`C_PurgeRªge
(
this
, 
´
), 
fšish”
));

379 
	}
}

382 
	sTruncRªge
 {

383 
	m¡d
::
mu‹x
 
lock
;

384 
	m¡d
::
	tlock_gu¬d
<
	t¡d
::
	tmu‹x
>†ock_guard;

385 
	m¡d
::
	tunique_lock
<
	t¡d
::
	tmu‹x
> unique_lock;

386 
šod’o_t
 
	mšo
;

387 
fe_Ïyout_t
 
	mÏyout
;

388 
SÇpCÚ‹xt
 
	m¢­c
;

389 
	mûph
::
»®_time
 
mtime
;

390 
	mæags
;

391 
CÚ‹xt
 *
	mÚcomm™
;

392 
	muncomm™‹d
;

393 
ušt64_t
 
	moff£t
;

394 
ušt64_t
 
	mËngth
;

395 
ušt32_t
 
	mŒunÿ‹_£q
;

396 
TruncRªge
(
šod’o_t
 
i
, cÚ¡ 
fe_Ïyout_t
& 
l
, cÚ¡ 
SÇpCÚ‹xt
& 
sc
,

397 
ûph
::
»®_time
 
t
, 
æ
, 
CÚ‹xt
 *
fš
,

398 
ušt64_t
 
off
, ušt64_ˆ
Ën
, 
ušt32_t
 
ts
)

399 : 
šo
(
i
), 
Ïyout
(
l
), 
¢­c
(
sc
), 
mtime
(
t
), 
æags
(
æ
), 
Úcomm™
(
fš
),

400 
uncomm™‹d
(0), 
off£t
(
off
), 
Ëngth
(
Ën
), 
Œunÿ‹_£q
(
ts
) {}

403 
	gF”
::
	$Œunÿ‹
(
šod’o_t
 
šo
,

404 
fe_Ïyout_t
 *
Ïyout
,

405 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

406 
ušt64_t
 
off£t
,

407 
ušt64_t
 
Ën
,

408 
__u32
 
Œunÿ‹_£q
,

409 
ûph
::
»®_time
 
mtime
,

410 
æags
,

411 
CÚ‹xt
 *
Úcomm™
)

413 
ušt64_t
 
³riod
 = 
Ïyout
->
	`g‘_³riod
();

414 
ušt64_t
 
num_objs
 = 
SŒ”
::
	`g‘_num_objeùs
(*
Ïyout
, 
Ën
 + (
off£t
 % 
³riod
));

415 ià(
num_objs
 == 1) {

416 
veùÜ
<
ObjeùEx‹Á
> 
ex‹Ás
;

417 
SŒ”
::
	`fe_to_ex‹Ás
(
cù
, 
šo
, 
Ïyout
, 
off£t
, 
Ën
, 0, 
ex‹Ás
);

418 
veùÜ
<
OSDOp
> 
	`İs
(1);

419 
İs
[0].
İ
.İ = 
CEPH_OSD_OP_TRIMTRUNC
;

420 
İs
[0].
İ
.
ex‹Á
.
Œunÿ‹_£q
 =runcate_seq;

421 
İs
[0].
İ
.
ex‹Á
.
Œunÿ‹_size
 = 
ex‹Ás
[0].
off£t
;

422 
objeù”
->
	`_modify
(
ex‹Ás
[0].
oid
,ƒx‹Ás[0].
Şoc
, 
İs
, 
mtime
, 
¢­c
,

423 
æags
, 
Úcomm™
);

427 ià(
Ën
 > 0 && (
off£t
 +†’è% 
³riod
)

428 
Ën
 +ğ
³riod
 - ((
off£t
 +†en) %…eriod);

430 
TruncRªge
 *
Œ
 = 
Ãw
 
	`TruncRªge
(
šo
, *
Ïyout
, 
¢­c
, 
mtime
, 
æags
, 
Úcomm™
,

431 
off£t
, 
Ën
, 
Œunÿ‹_£q
);

432 
	`_do_Œunÿ‹_¿nge
(
Œ
, 0);

433 
	}
}

435 
	gC_TruncRªge
 : 
public
 
CÚ‹xt
 {

436 
F”
 *
f”
;

437 
TruncRªge
 *
	gŒ
;

438 
C_TruncRªge
(
F”
 *
f
, 
TruncRªge
 *
t
è: 
f”
(f), 
Œ
(t) {}

439 
fšish
(
r
è
	gov”ride
 {

440 
	gf”
->
_do_Œunÿ‹_¿nge
(
Œ
, 1);

444 
	gF”
::
	$_do_Œunÿ‹_¿nge
(
TruncRªge
 *
Œ
, 
fš
)

446 
TruncRªge
::
unique_lock
 
	`Œl
(
Œ
->
lock
);

447 
Œ
->
uncomm™‹d
 -ğ
fš
;

448 
	`ldout
(
cù
, 10è<< "_do_Œunÿ‹_¿ng" << 
Œ
->
šo
 << " objeù " <<r->
off£t


449 << "~" << 
Œ
->
Ëngth
 << " uncomm™‹d " <<r->
uncomm™‹d


450 << 
d’dl
;

452 ià(
Œ
->
Ëngth
 =ğ0 &&r->
uncomm™‹d
 == 0) {

453 
Œ
->
Úcomm™
->
	`com¶‘e
(0);

454 
Œl
.
	`uÆock
();

455 
d–‘e
 
Œ
;

459 
veùÜ
<
ObjeùEx‹Á
> 
ex‹Ás
;

461 
max
 = 
cù
->
_cÚf
->
f”_max_Œunÿ‹_İs
 - 
Œ
->
uncomm™‹d
;

462 ià(
max
 > 0 && 
Œ
->
Ëngth
 > 0) {

463 
ušt64_t
 
Ën
 = 
Œ
->
Ïyout
.
	`g‘_³riod
(è* 
max
;

464 ià(
Ën
 > 
Œ
->
Ëngth
)

465 
Ën
 = 
Œ
->
Ëngth
;

467 
ušt64_t
 
off£t
 = 
Œ
->off£ˆ+r->
Ëngth
 - 
Ën
;

468 
SŒ”
::
	`fe_to_ex‹Ás
(
cù
, 
Œ
->
šo
, &Œ->
Ïyout
, 
off£t
, 
Ën
, 0, 
ex‹Ás
);

469 
Œ
->
uncomm™‹d
 +ğ
ex‹Ás
.
	`size
();

470 
Œ
->
Ëngth
 -ğ
Ën
;

473 
Œl
.
	`uÆock
();

476 cÚ¡‡uto& 
p
 : 
ex‹Ás
) {

477 
veùÜ
<
OSDOp
> 
	`İs
(1);

478 
İs
[0].
İ
.İ = 
CEPH_OSD_OP_TRIMTRUNC
;

479 
İs
[0].
İ
.
ex‹Á
.
Œunÿ‹_size
 = 
p
.
off£t
;

480 
İs
[0].
İ
.
ex‹Á
.
Œunÿ‹_£q
 = 
Œ
->truncate_seq;

481 
objeù”
->
	`_modify
(
p
.
oid
,….
Şoc
, 
İs
, 
Œ
->
mtime
,r->
¢­c
,r->
æags
,

482 
Ãw
 
	`C_OnFšish”
Òew 
	`C_TruncRªge
(
this
, 
Œ
), 
fšish”
));

484 
	}
}

	@osdc/Filer.h

16 #iâdeà
CEPH_FILER_H


17 
	#CEPH_FILER_H


	)

30 
	~<mu‹x
>

32 
	~"šşude/ty³s.h
"

34 
	~"commÚ/ûph_time.h
"

36 
	~"osd/OSDM­.h
"

37 
	~"Objeù”.h
"

38 
	~"SŒ”.h
"

40 
şass
 
	gCÚ‹xt
;

41 
şass
 
	gMes£ng”
;

42 
şass
 
	gOSDM­
;

43 
şass
 
	gFšish”
;

48 şas 
	cF”
 {

49 
C•hCÚ‹xt
 *
	mcù
;

50 
Objeù”
 *
	mobjeù”
;

51 
Fšish”
 *
	mfšish”
;

54 
	sProbe
 {

55 
	m¡d
::
mu‹x
 
lock
;

56 
	m¡d
::
	tlock_gu¬d
<
	t¡d
::
	tmu‹x
>†ock_guard;

57 
	m¡d
::
	tunique_lock
<
	t¡d
::
	tmu‹x
> unique_lock;

58 
šod’o_t
 
	mšo
;

59 
fe_Ïyout_t
 
	mÏyout
;

60 
¢­id_t
 
	m¢­id
;

62 
ušt64_t
 *
	mpsize
;

63 
	mûph
::
»®_time
 *
pmtime
;

64 
utime_t
 *
	mpumtime
;

66 
	mæags
;

68 
boŞ
 
	mfwd
;

70 
CÚ‹xt
 *
	mÚfšish
;

72 
	mveùÜ
<
	mObjeùEx‹Á
> 
	m´obšg
;

73 
ušt64_t
 
	m´obšg_off
, 
	m´obšg_Ën
;

75 
	mm­
<
	mobjeù_t
, 
	mušt64_t
> 
	mknown_size
;

76 
	mûph
::
»®_time
 
max_mtime
;

78 
	m£t
<
	mobjeù_t
> 
	mİs
;

80 
	m”r
;

81 
boŞ
 
	mfound_size
;

83 
Probe
(
šod’o_t
 
i
, 
fe_Ïyout_t
 &
l
, 
¢­id_t
 
¢
,

84 
ušt64_t
 
f
, ušt64_ˆ*
e
, 
ûph
::
»®_time
 *
m
, 
æ
, 
boŞ
 
fw
,

85 
CÚ‹xt
 *
c
) :

86 
šo
(
i
), 
Ïyout
(
l
), 
¢­id
(
¢
),

87 
psize
(
e
), 
pmtime
(
m
), 
pumtime
(
nuÎ±r
), 
æags
(
æ
), 
fwd
(
fw
), 
Úfšish
(
c
),

88 
´obšg_off
(
f
), 
´obšg_Ën
(0),

89 
”r
(0), 
found_size
(
çl£
) {}

91 
Probe
(
šod’o_t
 
i
, 
fe_Ïyout_t
 &
l
, 
¢­id_t
 
¢
,

92 
ušt64_t
 
f
, ušt64_ˆ*
e
, 
utime_t
 *
m
, 
æ
, 
boŞ
 
fw
,

93 
CÚ‹xt
 *
c
) :

94 
šo
(
i
), 
Ïyout
(
l
), 
¢­id
(
¢
),

95 
psize
(
e
), 
pmtime
(
nuÎ±r
), 
pumtime
(
m
), 
æags
(
æ
), 
fwd
(
fw
),

96 
Úfšish
(
c
), 
´obšg_off
(
f
), 
´obšg_Ën
(0),

97 
”r
(0), 
found_size
(
çl£
) {}

100 
şass
 
	gC_Probe
;

102 
_´obe
(
Probe
 *
p
, Probe::
unique_lock
& 
¶
);

103 
boŞ
 
_´obed
(
Probe
 *
p
, cÚ¡ 
objeù_t
& 
oid
, 
ušt64_t
 
size
,

104 
ûph
::
»®_time
 
mtime
, 
Probe
::
unique_lock
& 
¶
);

106 
	gpublic
:

107 
F”
(cÚ¡ F”& 
Ùh”
);

108 cÚ¡ 
F”
 
	gİ”©Ü
=(cÚ¡ F”& 
Ùh”
);

110 
	$F”
(
Objeù”
 *
o
, 
Fšish”
 *
f
è: 
	`cù
(o->
cù
), 
	`objeù”
(o), 
	$fšish”
(
f
è{
	}
}

111 ~
	$F”
(è{
	}
}

113 
boŞ
 
	$is_aùive
() {

114  
objeù”
->
	`is_aùive
();

115 
	}
}

120 
	$»ad
(
šod’o_t
 
šo
,

121 
fe_Ïyout_t
 *
Ïyout
,

122 
¢­id_t
 
¢­
,

123 
ušt64_t
 
off£t
,

124 
ušt64_t
 
Ën
,

125 
bufã¾i¡
 *
bl
,

126 
æags
,

127 
CÚ‹xt
 *
Úfšish
,

128 
İ_æags
 = 0) {

129 
	`as£¹
(
¢­
);

130 
veùÜ
<
ObjeùEx‹Á
> 
ex‹Ás
;

131 
SŒ”
::
	`fe_to_ex‹Ás
(
cù
, 
šo
, 
Ïyout
, 
off£t
, 
Ën
, 0, 
ex‹Ás
);

132 
objeù”
->
	`sg_»ad
(
ex‹Ás
, 
¢­
, 
bl
, 
æags
, 
Úfšish
, 
İ_æags
);

133 
	}
}

135 
	$»ad_Œunc
(
šod’o_t
 
šo
,

136 
fe_Ïyout_t
 *
Ïyout
,

137 
¢­id_t
 
¢­
,

138 
ušt64_t
 
off£t
,

139 
ušt64_t
 
Ën
,

140 
bufã¾i¡
 *
bl
,

141 
æags
,

142 
ušt64_t
 
Œunÿ‹_size
,

143 
__u32
 
Œunÿ‹_£q
,

144 
CÚ‹xt
 *
Úfšish
,

145 
İ_æags
 = 0) {

146 
	`as£¹
(
¢­
);

147 
veùÜ
<
ObjeùEx‹Á
> 
ex‹Ás
;

148 
SŒ”
::
	`fe_to_ex‹Ás
(
cù
, 
šo
, 
Ïyout
, 
off£t
, 
Ën
, 
Œunÿ‹_size
,

149 
ex‹Ás
);

150 
objeù”
->
	`sg_»ad_Œunc
(
ex‹Ás
, 
¢­
, 
bl
, 
æags
,

151 
Œunÿ‹_size
, 
Œunÿ‹_£q
, 
Úfšish
, 
İ_æags
);

152 
	}
}

154 
	$wr™e
(
šod’o_t
 
šo
,

155 
fe_Ïyout_t
 *
Ïyout
,

156 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

157 
ušt64_t
 
off£t
,

158 
ušt64_t
 
Ën
,

159 
bufã¾i¡
& 
bl
,

160 
ûph
::
»®_time
 
mtime
,

161 
æags
,

162 
CÚ‹xt
 *
Úcomm™
,

163 
İ_æags
 = 0) {

164 
veùÜ
<
ObjeùEx‹Á
> 
ex‹Ás
;

165 
SŒ”
::
	`fe_to_ex‹Ás
(
cù
, 
šo
, 
Ïyout
, 
off£t
, 
Ën
, 0, 
ex‹Ás
);

166 
objeù”
->
	`sg_wr™e
(
ex‹Ás
, 
¢­c
, 
bl
, 
mtime
, 
æags
, 
Úcomm™
, 
İ_æags
);

167 
	}
}

169 
	$wr™e_Œunc
(
šod’o_t
 
šo
,

170 
fe_Ïyout_t
 *
Ïyout
,

171 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

172 
ušt64_t
 
off£t
,

173 
ušt64_t
 
Ën
,

174 
bufã¾i¡
& 
bl
,

175 
ûph
::
»®_time
 
mtime
,

176 
æags
,

177 
ušt64_t
 
Œunÿ‹_size
,

178 
__u32
 
Œunÿ‹_£q
,

179 
CÚ‹xt
 *
Úcomm™
,

180 
İ_æags
 = 0) {

181 
veùÜ
<
ObjeùEx‹Á
> 
ex‹Ás
;

182 
SŒ”
::
	`fe_to_ex‹Ás
(
cù
, 
šo
, 
Ïyout
, 
off£t
, 
Ën
, 
Œunÿ‹_size
,

183 
ex‹Ás
);

184 
objeù”
->
	`sg_wr™e_Œunc
(
ex‹Ás
, 
¢­c
, 
bl
, 
mtime
, 
æags
,

185 
Œunÿ‹_size
, 
Œunÿ‹_£q
, 
Úcomm™
, 
İ_æags
);

186 
	}
}

188 
Œunÿ‹
(
šod’o_t
 
šo
,

189 
fe_Ïyout_t
 *
Ïyout
,

190 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

191 
ušt64_t
 
off£t
,

192 
ušt64_t
 
Ën
,

193 
__u32
 
Œunÿ‹_£q
,

194 
ûph
::
»®_time
 
mtime
,

195 
æags
,

196 
CÚ‹xt
 *
Úcomm™
);

197 
_do_Œunÿ‹_¿nge
(
TruncRªge
 *
´
, 
fš
);

199 
	$z”o
(
šod’o_t
 
šo
,

200 cÚ¡ 
fe_Ïyout_t
 *
Ïyout
,

201 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

202 
ušt64_t
 
off£t
,

203 
ušt64_t
 
Ën
,

204 
ûph
::
»®_time
 
mtime
,

205 
æags
,

206 
boŞ
 
k“p_fœ¡
,

207 
CÚ‹xt
 *
Úcomm™
) {

208 
veùÜ
<
ObjeùEx‹Á
> 
ex‹Ás
;

209 
SŒ”
::
	`fe_to_ex‹Ás
(
cù
, 
šo
, 
Ïyout
, 
off£t
, 
Ën
, 0, 
ex‹Ás
);

210 ià(
ex‹Ás
.
	`size
() == 1) {

211 ià(
ex‹Ás
[0].
off£t
 =ğ0 &&ƒx‹Ás[0].
Ëngth
 =ğ
Ïyout
->
objeù_size


212 && (!
k“p_fœ¡
 || 
ex‹Ás
[0].
objeùno
 != 0))

213 
objeù”
->
	`»move
(
ex‹Ás
[0].
oid
,ƒx‹Ás[0].
Şoc
,

214 
¢­c
, 
mtime
, 
æags
, 
Úcomm™
);

216 
objeù”
->
	`z”o
(
ex‹Ás
[0].
oid
,ƒx‹Ás[0].
Şoc
,ƒx‹Ás[0].
off£t
,

217 
ex‹Ás
[0].
Ëngth
, 
¢­c
, 
mtime
, 
æags
, 
Úcomm™
);

219 
C_G©h”Bud”
 
	`gcom
(
cù
, 
Úcomm™
);

220 
veùÜ
<
ObjeùEx‹Á
>::
™”©Ü
 
p
 = 
ex‹Ás
.
	`begš
();

221 
p
 !ğ
ex‹Ás
.
	`’d
();

222 ++
p
) {

223 ià(
p
->
off£t
 =ğ0 &&…->
Ëngth
 =ğ
Ïyout
->
objeù_size
 &&

224 (!
k“p_fœ¡
 || 
p
->
objeùno
 != 0))

225 
objeù”
->
	`»move
(
p
->
oid
,…->
Şoc
,

226 
¢­c
, 
mtime
, 
æags
,

227 
Úcomm™
 ? 
gcom
.
	`Ãw_sub
():0);

229 
objeù”
->
	`z”o
(
p
->
oid
,…->
Şoc
,…->
off£t
,…->
Ëngth
,

230 
¢­c
, 
mtime
, 
æags
,

231 
Úcomm™
 ? 
gcom
.
	`Ãw_sub
():0);

233 
gcom
.
	`aùiv©e
();

235 
	}
}

237 
	$z”o
(
šod’o_t
 
šo
,

238 
fe_Ïyout_t
 *
Ïyout
,

239 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

240 
ušt64_t
 
off£t
,

241 
ušt64_t
 
Ën
,

242 
ûph
::
»®_time
 
mtime
,

243 
æags
,

244 
CÚ‹xt
 *
Úcomm™
) {

245 
	`z”o
(
šo
, 
Ïyout
,

246 
¢­c
, 
off£t
,

247 
Ën
, 
mtime
,

248 
æags
, 
çl£
,

249 
Úcomm™
);

250 
	}
}

252 
purge_¿nge
(
šod’o_t
 
šo
,

253 cÚ¡ 
fe_Ïyout_t
 *
Ïyout
,

254 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

255 
ušt64_t
 
fœ¡_obj
, ušt64_ˆ
num_obj
,

256 
ûph
::
»®_time
 
mtime
,

257 
æags
, 
CÚ‹xt
 *
Úcomm™
);

258 
_do_purge_¿nge
(
PurgeRªge
 *
´
, 
fš
);

265 
´obe
(
šod’o_t
 
šo
,

266 
fe_Ïyout_t
 *
Ïyout
,

267 
¢­id_t
 
¢­id
,

268 
ušt64_t
 
¡¬t_äom
,

269 
ušt64_t
 *
’d
,

270 
ûph
::
»®_time
 *
mtime
,

271 
boŞ
 
fwd
,

272 
æags
,

273 
CÚ‹xt
 *
Úfšish
);

275 
	$´obe
(
šod’o_t
 
šo
,

276 
fe_Ïyout_t
 *
Ïyout
,

277 
¢­id_t
 
¢­id
,

278 
ušt64_t
 
¡¬t_äom
,

279 
ušt64_t
 *
’d
,

280 
boŞ
 
fwd
,

281 
æags
,

282 
CÚ‹xt
 *
Úfšish
) {

283  
	`´obe
(
šo
, 
Ïyout
, 
¢­id
, 
¡¬t_äom
, 
’d
,

284 (
ûph
::
»®_time
* )0, 
fwd
, 
æags
, 
Úfšish
);

285 
	}
}

287 
´obe
(
šod’o_t
 
šo
,

288 
fe_Ïyout_t
 *
Ïyout
,

289 
¢­id_t
 
¢­id
,

290 
ušt64_t
 
¡¬t_äom
,

291 
ušt64_t
 *
’d
,

292 
utime_t
 *
mtime
,

293 
boŞ
 
fwd
,

294 
æags
,

295 
CÚ‹xt
 *
Úfšish
);

297 
	g´iv©e
:

298 
´obe_im¶
(
Probe
* 
´obe
, 
fe_Ïyout_t
 *
Ïyout
,

299 
ušt64_t
 
¡¬t_äom
, ušt64_ˆ*
’d
);

	@osdc/Journaler.cc

15 
	~"commÚ/³rf_couÁ”s.h
"

16 
	~"commÚ/dout.h
"

17 
	~"šşude/CÚ‹xt.h
"

18 
	~"msg/Mes£ng”.h
"

19 
	~"osdc/Jouº®”.h
"

20 
	~"commÚ/”ºo.h
"

21 
	~"šşude/as£¹.h
"

22 
	~"commÚ/Fšish”.h
"

24 
	#dout_subsys
 
ûph_subsys_jouº®”


	)

25 #undeà
dout_´efix


26 
	#dout_´efix
 *
_dout
 << 
objeù”
->
mes£ng”
->
	`g‘_myÇme
() \

27 << ".jouº®”." << 
Çme
 << (
»adÚly
 ? "Ôoè":"Ôwè")

	)

29 
usšg
 
	g¡d
::
chrÚo
::
£cÚds
;

32 şas 
	cJouº®”
::
C_D–ayFlush
 : 
public
 
CÚ‹xt
 {

33 
Jouº®”
 *
jouº®”
;

34 
	mpublic
:

35 
ex¶ic™
 
	$C_D–ayFlush
(
Jouº®”
 *
j
è: 
	$jouº®”
(
j
) {}

36 
	$fšish
(
r
è
ov”ride
 {

37 
jouº®”
->
	`_do_d–ayed_æush
();

38 
	}
}

41 
	gJouº®”
::
	$£t_»adÚly
()

43 
lock_gu¬d
 
	`l
(
lock
);

45 
	`ldout
(
cù
, 1è<< "£t_»adÚly" << 
d’dl
;

46 
»adÚly
 = 
Œue
;

47 
	}
}

49 
	gJouº®”
::
	$£t_wr™—bË
()

51 
lock_gu¬d
 
	`l
(
lock
);

53 
	`ldout
(
cù
, 1è<< "£t_wr™—bË" << 
d’dl
;

54 
»adÚly
 = 
çl£
;

55 
	}
}

57 
	gJouº®”
::
	$ü—‹
(
fe_Ïyout_t
 *
l
, 
¡»am_fÜm©_t
 cÚ¡ 
sf
)

59 
lock_gu¬d
 
	`lk
(
lock
);

61 
	`as£¹
(!
»adÚly
);

62 
¡©e
 = 
STATE_ACTIVE
;

64 
¡»am_fÜm©
 = 
sf
;

65 
jouº®_¡»am
.
	`£t_fÜm©
(
sf
);

66 
	`_£t_Ïyout
(
l
);

68 
´ez”ošg_pos
 = 
´ez”o_pos
 = 
wr™e_pos
 = 
æush_pos
 =

69 
§ã_pos
 = 
»ad_pos
 = 
»que¡ed_pos
 = 
»ûived_pos
 =

70 
expœe_pos
 = 
Œimmšg_pos
 = 
Œimmed_pos
 =

71 
Ãxt_§ã_pos
 = 
Ïyout
.
	`g‘_³riod
();

73 
	`ldout
(
cù
, 1è<< "ü—‹d bÏnk jouº®‡ˆšod0x" << 
¡d
::
hex
 << 
šo


74 << 
¡d
::
dec
 << ", fÜm©=" << 
¡»am_fÜm©
 << 
d’dl
;

75 
	}
}

77 
	gJouº®”
::
	$£t_Ïyout
(
fe_Ïyout_t
 cÚ¡ *
l
)

79 
lock_gu¬d
 
	`lk
(
lock
);

80 
	`_£t_Ïyout
(
l
);

81 
	}
}

83 
	gJouº®”
::
	$_£t_Ïyout
(
fe_Ïyout_t
 cÚ¡ *
l
)

85 
Ïyout
 = *
l
;

87 ià(
Ïyout
.
poŞ_id
 !ğ
pg_poŞ
) {

89 
	`ld”r
(
cù
è<< "may gÙ old”…oŞ id from h—d”†ayout" << 
d’dl
;

90 
	`ûph_abÜt
();

92 
Ï¡_wr™‹n
.
Ïyout
 =†ayout;

93 
Ï¡_comm™‹d
.
Ïyout
 =†ayout;

97 
ušt64_t
 
³riods
 = 
cù
->
_cÚf
->
g‘_v®
<uint64_t>("journaler_prefetch_periods");

98 
ãtch_Ën
 = 
Ïyout
.
	`g‘_³riod
(è* 
³riods
;

99 
	}
}

104 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am &
	gout
, cÚ¡ 
	gJouº®”
::
H—d”
 &
h
)

106  
out
 << "logh—dÑrim " << 
h
.
Œimmed_pos


107 << ",ƒxpœ" << 
h
.
expœe_pos


108 << ", wr™" << 
h
.
wr™e_pos


109 << ", sŒ—m_fÜm© " << ()(
h
.
¡»am_fÜm©
)

113 şas 
	cJouº®”
::
C_R—dH—d
 : 
public
 
CÚ‹xt
 {

114 
Jouº®”
 *
ls
;

115 
	mpublic
:

116 
bufã¾i¡
 
bl
;

117 
ex¶ic™
 
	$C_R—dH—d
(
Jouº®”
 *
l
è: 
	$ls
(
l
) {}

118 
	$fšish
(
r
è
ov”ride
 {

119 
ls
->
	`_fšish_»ad_h—d
(
r
, 
bl
);

120 
	}
}

123 şas 
	cJouº®”
::
C_R”—dH—d
 : 
public
 
CÚ‹xt
 {

124 
Jouº®”
 *
ls
;

125 
CÚ‹xt
 *
	mÚfšish
;

126 
	mpublic
:

127 
bufã¾i¡
 
bl
;

128 
	$C_R”—dH—d
(
Jouº®”
 *
l
, 
CÚ‹xt
 *
Úfšish_
è: 
	`ls
 (l),

129 
	$Úfšish
(
Úfšish_
) {}

130 
	$fšish
(
r
è
ov”ride
 {

131 
ls
->
	`_fšish_»»ad_h—d
(
r
, 
bl
, 
Úfšish
);

132 
	}
}

135 şas 
	cJouº®”
::
C_ProbeEnd
 : 
public
 
CÚ‹xt
 {

136 
Jouº®”
 *
ls
;

137 
	mpublic
:

138 
ušt64_t
 
’d
;

139 
ex¶ic™
 
	$C_ProbeEnd
(
Jouº®”
 *
l
è: 
	`ls
Ö), 
	`’d
(-1) {}

140 
	$fšish
(
r
è
ov”ride
 {

141 
ls
->
	`_fšish_´obe_’d
(
r
, 
’d
);

142 
	}
}

145 şas 
	cJouº®”
::
C_ReProbe
 : 
public
 
CÚ‹xt
 {

146 
Jouº®”
 *
ls
;

147 
C_OnFšish”
 *
	mÚfšish
;

148 
	mpublic
:

149 
ušt64_t
 
’d
;

150 
	$C_ReProbe
(
Jouº®”
 *
l
, 
C_OnFšish”
 *
Úfšish_
) :

151 
	`ls
(
l
), 
	`Úfšish
(
Úfšish_
), 
	$’d
(0) {}

152 
	$fšish
(
r
è
ov”ride
 {

153 
ls
->
	`_fšish_»´obe
(
r
, 
’d
, 
Úfšish
);

154 
	}
}

157 
	gJouº®”
::
	$»cov”
(
CÚ‹xt
 *
Ú»ad
)

159 
lock_gu¬d
 
	`l
(
lock
);

160 ià(
	`is_¡İpšg
()) {

161 
Ú»ad
->
	`com¶‘e
(-
EAGAIN
);

165 
	`ldout
(
cù
, 1è<< "»cov” s¹" << 
d’dl
;

166 
	`as£¹
(
¡©e
 !ğ
STATE_ACTIVE
);

167 
	`as£¹
(
»adÚly
);

169 ià(
Ú»ad
)

170 
wa™fÜ_»cov”
.
	`push_back
(
	`w¿p_fšish”
(
Ú»ad
));

172 ià(
¡©e
 !ğ
STATE_UNDEF
) {

173 
	`ldout
(
cù
, 1è<< "»cov” -‡Ì—dy„ecov”šg" << 
d’dl
;

177 
	`ldout
(
cù
, 1è<< "»ad_h—d" << 
d’dl
;

178 
¡©e
 = 
STATE_READHEAD
;

179 
C_R—dH—d
 *
fš
 = 
Ãw
 
	`C_R—dH—d
(
this
);

180 
	`_»ad_h—d
(
fš
, &fš->
bl
);

181 
	}
}

183 
	gJouº®”
::
	$_»ad_h—d
(
CÚ‹xt
 *
Ú_fšish
, 
bufã¾i¡
 *
bl
)

186 
	`as£¹
(
¡©e
 =ğ
STATE_READHEAD
 || s‹ =ğ
STATE_REREADHEAD
);

188 
objeù_t
 
oid
 = 
	`fe_objeù_t
(
šo
, 0);

189 
objeù_loÿtÜ_t
 
	`Şoc
(
pg_poŞ
);

190 
objeù”
->
	`»ad_fuÎ
(
oid
, 
Şoc
, 
CEPH_NOSNAP
, 
bl
, 0, 
	`w¿p_fšish”
(
Ú_fšish
));

191 
	}
}

193 
	gJouº®”
::
	$»»ad_h—d
(
CÚ‹xt
 *
Úfšish
)

195 
lock_gu¬d
 
	`l
(
lock
);

196 
	`_»»ad_h—d
(
	`w¿p_fšish”
(
Úfšish
));

197 
	}
}

207 
	gJouº®”
::
	$_»»ad_h—d
(
CÚ‹xt
 *
Úfšish
)

209 
	`ldout
(
cù
, 10è<< "»»ad_h—d" << 
d’dl
;

210 
	`as£¹
(
¡©e
 =ğ
STATE_ACTIVE
);

212 
¡©e
 = 
STATE_REREADHEAD
;

213 
C_R”—dH—d
 *
fš
 = 
Ãw
 
	`C_R”—dH—d
(
this
, 
Úfšish
);

214 
	`_»ad_h—d
(
fš
, &fš->
bl
);

215 
	}
}

217 
	gJouº®”
::
	$_fšish_»»ad_h—d
(
r
, 
bufã¾i¡
& 
bl
, 
CÚ‹xt
 *
fšish
)

219 
lock_gu¬d
 
	`l
(
lock
);

220 ià(
	`is_¡İpšg
()) {

221 
fšish
->
	`com¶‘e
(-
EAGAIN
);

226 
	`as£¹
(
bl
.
	`Ëngth
(è|| 
r
 < 0 );

229 ià(
r
 == 0) {

230 
H—d”
 
h
;

231 
bufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
	`begš
();

232 
Œy
 {

233 
	`decode
(
h
, 
p
);

234 } 
	`ÿtch
 (cÚ¡ 
bufãr
::
”rÜ
 &
e
) {

235 
fšish
->
	`com¶‘e
(-
EINVAL
);

238 
´ez”ošg_pos
 = 
´ez”o_pos
 = 
wr™e_pos
 = 
æush_pos
 = 
§ã_pos
 = 
Ãxt_§ã_pos


239 ğ
h
.
wr™e_pos
;

240 
expœe_pos
 = 
h
.expire_pos;

241 
Œimmed_pos
 = 
Œimmšg_pos
 = 
h
.trimmed_pos;

242 
	`š™_h—d”s
(
h
);

243 
¡©e
 = 
STATE_ACTIVE
;

246 
fšish
->
	`com¶‘e
(
r
);

247 
	}
}

249 
	gJouº®”
::
	$_fšish_»ad_h—d
(
r
, 
bufã¾i¡
& 
bl
)

251 
lock_gu¬d
 
	`l
(
lock
);

252 ià(
	`is_¡İpšg
())

255 
	`as£¹
(
¡©e
 =ğ
STATE_READHEAD
);

257 ià(
r
!=0) {

258 
	`ldout
(
cù
, 0è<< "”rÜ g‘tšg jouº® ofàdisk" << 
d’dl
;

259 
li¡
<
CÚ‹xt
*> 
ls
;

260 
ls
.
	`sw­
(
wa™fÜ_»cov”
);

261 
	`fšish_cÚ‹xts
(
cù
, 
ls
, 
r
);

265 ià(
bl
.
	`Ëngth
() == 0) {

266 
	`ldout
(
cù
, 1è<< "_fšish_»ad_h—d„=" << 
r


267 << "„—d 0 by‹s,‡ssumšgƒm±y†og" << 
d’dl
;

268 
¡©e
 = 
STATE_ACTIVE
;

269 
li¡
<
CÚ‹xt
*> 
ls
;

270 
ls
.
	`sw­
(
wa™fÜ_»cov”
);

271 
	`fšish_cÚ‹xts
(
cù
, 
ls
, 0);

276 
boŞ
 
cÜru±
 = 
çl£
;

277 
H—d”
 
h
;

278 
bufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
	`begš
();

279 
Œy
 {

280 
	`decode
(
h
, 
p
);

282 ià(
h
.
magic
 != magic) {

283 
	`ldout
(
cù
, 0è<< "Ú disk magiø'" << 
h
.
magic
 << "' != my magic '"

284 << 
magic
 << "'" << 
d’dl
;

285 
cÜru±
 = 
Œue
;

286 } ià(
h
.
wr™e_pos
 < h.
expœe_pos
 || h.expœe_po < h.
Œimmed_pos
) {

287 
	`ldout
(
cù
, 0è<< "CÜru± h—d” (bad off£ts): " << 
h
 << 
d’dl
;

288 
cÜru±
 = 
Œue
;

290 } 
	`ÿtch
 (cÚ¡ 
bufãr
::
”rÜ
 &
e
) {

291 
cÜru±
 = 
Œue
;

294 ià(
cÜru±
) {

295 
li¡
<
CÚ‹xt
*> 
ls
;

296 
ls
.
	`sw­
(
wa™fÜ_»cov”
);

297 
	`fšish_cÚ‹xts
(
cù
, 
ls
, -
EINVAL
);

301 
´ez”ošg_pos
 = 
´ez”o_pos
 = 
wr™e_pos
 = 
æush_pos
 = 
§ã_pos
 = 
Ãxt_§ã_pos


302 ğ
h
.
wr™e_pos
;

303 
»ad_pos
 = 
»que¡ed_pos
 = 
»ûived_pos
 = 
expœe_pos
 = 
h
.expire_pos;

304 
Œimmed_pos
 = 
Œimmšg_pos
 = 
h
.trimmed_pos;

306 
	`š™_h—d”s
(
h
);

307 
	`_£t_Ïyout
(&
h
.
Ïyout
);

308 
¡»am_fÜm©
 = 
h
.stream_format;

309 
jouº®_¡»am
.
	`£t_fÜm©
(
h
.
¡»am_fÜm©
);

311 
	`ldout
(
cù
, 1è<< "_fšish_»ad_h—d " << 
h


312 << ".…robšg fÜƒnd oàlog (äom " << 
wr™e_pos
 << ")..."

313 << 
d’dl
;

314 
C_ProbeEnd
 *
fš
 = 
Ãw
 
	`C_ProbeEnd
(
this
);

315 
¡©e
 = 
STATE_PROBING
;

316 
	`_´obe
(
fš
, &fš->
’d
);

317 
	}
}

319 
	gJouº®”
::
	$_´obe
(
CÚ‹xt
 *
fšish
, 
ušt64_t
 *
’d
)

322 
	`ldout
(
cù
, 1è<< "´obšg fÜƒnd oàthlog" << 
d’dl
;

323 
	`as£¹
(
¡©e
 =ğ
STATE_PROBING
 || s‹ =ğ
STATE_REPROBING
);

325 
f”
.
	`´obe
(
šo
, &
Ïyout
, 
CEPH_NOSNAP
,

326 
wr™e_pos
, 
’d
, 
Œue
, 0, 
	`w¿p_fšish”
(
fšish
));

327 
	}
}

329 
	gJouº®”
::
	$_»´obe
(
C_OnFšish”
 *
fšish
)

331 
	`ldout
(
cù
, 10è<< "»´obe" << 
d’dl
;

332 
	`as£¹
(
¡©e
 =ğ
STATE_ACTIVE
);

334 
¡©e
 = 
STATE_REPROBING
;

335 
C_ReProbe
 *
fš
 = 
Ãw
 
	`C_ReProbe
(
this
, 
fšish
);

336 
	`_´obe
(
fš
, &fš->
’d
);

337 
	}
}

340 
	gJouº®”
::
	$_fšish_»´obe
(
r
, 
ušt64_t
 
Ãw_’d
,

341 
C_OnFšish”
 *
Úfšish
)

343 
lock_gu¬d
 
	`l
(
lock
);

344 ià(
	`is_¡İpšg
()) {

345 
Úfšish
->
	`com¶‘e
(-
EAGAIN
);

349 
	`as£¹
(
Ãw_’d
 >ğ
wr™e_pos
 || 
r
 < 0);

350 
	`ldout
(
cù
, 1è<< "_fšish_»´obÃw_’d = " << 
Ãw_’d


351 << " (h—d” had " << 
wr™e_pos
 << ")."

352 << 
d’dl
;

353 
´ez”ošg_pos
 = 
´ez”o_pos
 = 
wr™e_pos
 = 
æush_pos
 = 
§ã_pos
 = 
Ãxt_§ã_pos
 = 
Ãw_’d
;

354 
¡©e
 = 
STATE_ACTIVE
;

355 
Úfšish
->
	`com¶‘e
(
r
);

356 
	}
}

358 
	gJouº®”
::
	$_fšish_´obe_’d
(
r
, 
ušt64_t
 
’d
)

360 
lock_gu¬d
 
	`l
(
lock
);

361 ià(
	`is_¡İpšg
())

364 
	`as£¹
(
¡©e
 =ğ
STATE_PROBING
);

365 ià(
r
 < 0) {

366 
out
;

368 ià(((
št64_t
)
’d
) == -1) {

369 
’d
 = 
wr™e_pos
;

370 
	`ldout
(
cù
, 1è<< "_fšish_´obe_’d wr™e_po ğ" << 
’d
 << " (header had "

371 << 
wr™e_pos
 << ").†og wa em±y.„ecov”ed." << 
d’dl
;

372 
	`ûph_abÜt
();

374 
	`as£¹
(
’d
 >ğ
wr™e_pos
);

375 
	`ldout
(
cù
, 1è<< "_fšish_´obe_’d wr™e_po ğ" << 
’d


376 << " (h—d” had " << 
wr™e_pos
 << ").„ecovered."

377 << 
d’dl
;

380 
¡©e
 = 
STATE_ACTIVE
;

382 
´ez”ošg_pos
 = 
´ez”o_pos
 = 
wr™e_pos
 = 
æush_pos
 = 
§ã_pos
 = 
Ãxt_§ã_pos
 = 
’d
;

384 
out
:

386 
li¡
<
CÚ‹xt
*> 
ls
;

387 
ls
.
	`sw­
(
wa™fÜ_»cov”
);

388 
	`fšish_cÚ‹xts
(
cù
, 
ls
, 
r
);

389 
	}
}

391 şas 
	cJouº®”
::
C_R”—dH—dProbe
 : 
public
 
CÚ‹xt


393 
Jouº®”
 *
ls
;

394 
C_OnFšish”
 *
	mfš®_fšish
;

395 
	mpublic
:

396 
	$C_R”—dH—dProbe
(
Jouº®”
 *
l
, 
C_OnFšish”
 *
fšish
) :

397 
	`ls
(
l
), 
	$fš®_fšish
(
fšish
) {}

398 
	$fšish
(
r
è
ov”ride
 {

399 
ls
->
	`_fšish_»»ad_h—d_ªd_´obe
(
r
, 
fš®_fšish
);

400 
	}
}

403 
	gJouº®”
::
	$»»ad_h—d_ªd_´obe
(
CÚ‹xt
 *
Úfšish
)

405 
lock_gu¬d
 
	`l
(
lock
);

407 
	`as£¹
(
¡©e
 =ğ
STATE_ACTIVE
);

408 
	`_»»ad_h—d
(
Ãw
 
	`C_R”—dH—dProbe
(
this
, 
	`w¿p_fšish”
(
Úfšish
)));

409 
	}
}

411 
	gJouº®”
::
	$_fšish_»»ad_h—d_ªd_´obe
(
r
, 
C_OnFšish”
 *
Úfšish
)

415 ià(
	`is_¡İpšg
()) {

416 
Úfšish
->
	`com¶‘e
(-
EAGAIN
);

420 
	`as£¹
(!
r
);

421 
	`_»´obe
(
Úfšish
);

422 
	}
}

427 şas 
	cJouº®”
::
C_Wr™eH—d
 : 
public
 
CÚ‹xt
 {

428 
public
:

429 
Jouº®”
 *
ls
;

430 
H—d”
 
	mh
;

431 
C_OnFšish”
 *
	mÚcomm™
;

432 
	$C_Wr™eH—d
(
Jouº®”
 *
l
, 
H—d”
& 
h_
, 
C_OnFšish”
 *
c
è: 
	`ls
Ö), 
	`h
(h_),

433 
	$Úcomm™
(
c
) {}

434 
	$fšish
(
r
è
ov”ride
 {

435 
ls
->
	`_fšish_wr™e_h—d
(
r
, 
h
, 
Úcomm™
);

436 
	}
}

439 
	gJouº®”
::
	$wr™e_h—d
(
CÚ‹xt
 *
Úcomm™
)

441 
lock_gu¬d
 
	`l
(
lock
);

442 
	`_wr™e_h—d
(
Úcomm™
);

443 
	}
}

446 
	gJouº®”
::
	$_wr™e_h—d
(
CÚ‹xt
 *
Úcomm™
)

448 
	`as£¹
(!
»adÚly
);

449 
	`as£¹
(
¡©e
 =ğ
STATE_ACTIVE
);

450 
Ï¡_wr™‹n
.
Œimmed_pos
 =rimmed_pos;

451 
Ï¡_wr™‹n
.
expœe_pos
 =ƒxpire_pos;

452 
Ï¡_wr™‹n
.
unu£d_f›ld
 = 
expœe_pos
;

453 
Ï¡_wr™‹n
.
wr™e_pos
 = 
§ã_pos
;

454 
Ï¡_wr™‹n
.
¡»am_fÜm©
 = stream_format;

455 
	`ldout
(
cù
, 10è<< "wr™e_h—d " << 
Ï¡_wr™‹n
 << 
d’dl
;

458 
	`as£¹
(
Ï¡_wr™‹n
.
wr™e_pos
 >ğÏ¡_wr™‹n.
expœe_pos
);

459 
	`as£¹
(
Ï¡_wr™‹n
.
expœe_pos
 >ğÏ¡_wr™‹n.
Œimmed_pos
);

461 
Ï¡_wrÙe_h—d
 = 
ûph
::
»®_şock
::
	`now
();

463 
bufã¾i¡
 
bl
;

464 
	`’code
(
Ï¡_wr™‹n
, 
bl
);

465 
SÇpCÚ‹xt
 
¢­c
;

467 
objeù_t
 
oid
 = 
	`fe_objeù_t
(
šo
, 0);

468 
objeù_loÿtÜ_t
 
	`Şoc
(
pg_poŞ
);

469 
objeù”
->
	`wr™e_fuÎ
(
oid
, 
Şoc
, 
¢­c
, 
bl
, 
ûph
::
»®_şock
::
	`now
(), 0,

470 
	`w¿p_fšish”
(
Ãw
 
	`C_Wr™eH—d
(

471 
this
, 
Ï¡_wr™‹n
,

472 
	`w¿p_fšish”
(
Úcomm™
))),

473 0, 0, 
wr™e_iohšt
);

474 
	}
}

476 
	gJouº®”
::
	$_fšish_wr™e_h—d
(
r
, 
H—d”
 &
wrÙe
,

477 
C_OnFšish”
 *
Úcomm™
)

479 
lock_gu¬d
 
	`l
(
lock
);

481 ià(
r
 < 0) {

482 
	`ld”r
(
cù
è<< "_fšish_wr™e_h—d gÙ " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

483 
	`hªdË_wr™e_”rÜ
(
r
);

486 
	`as£¹
(!
»adÚly
);

487 
	`ldout
(
cù
, 10è<< "_fšish_wr™e_h—d " << 
wrÙe
 << 
d’dl
;

488 
Ï¡_comm™‹d
 = 
wrÙe
;

489 ià(
Úcomm™
) {

490 
Úcomm™
->
	`com¶‘e
(
r
);

493 
	`_Œim
();

494 
	}
}

499 şas 
	cJouº®”
::
C_Flush
 : 
public
 
CÚ‹xt
 {

500 
Jouº®”
 *
ls
;

501 
ušt64_t
 
	m¡¬t
;

502 
	mûph
::
»®_time
 
¡amp
;

503 
	mpublic
:

504 
	$C_Flush
(
Jouº®”
 *
l
, 
št64_t
 
s
, 
ûph
::
»®_time
 
¡
)

505 : 
	`ls
(
l
), 
	`¡¬t
(
s
), 
	$¡amp
(
¡
) {}

506 
	$fšish
(
r
è
ov”ride
 {

507 
ls
->
	`_fšish_æush
(
r
, 
¡¬t
, 
¡amp
);

508 
	}
}

511 
	gJouº®”
::
	$_fšish_æush
(
r
, 
ušt64_t
 
¡¬t
, 
ûph
::
»®_time
 
¡amp
)

513 
lock_gu¬d
 
	`l
(
lock
);

514 
	`as£¹
(!
»adÚly
);

516 ià(
r
 < 0) {

517 
	`ld”r
(
cù
è<< "_fšish_æush gÙ " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

518 
	`hªdË_wr™e_”rÜ
(
r
);

522 
	`as£¹
(
¡¬t
 < 
æush_pos
);

525 ià(
logg”
) {

526 
ûph
::
time¥ª
 
Ït
 = c•h::
»®_şock
::
	`now
(è- 
¡amp
;

527 
logg”
->
	`tšc
(
logg”_key_Ït
, 
Ït
);

531 autØ
™
 = 
³ndšg_§ã
.
	`fšd
(
¡¬t
);

532 
	`as£¹
(
™
 !ğ
³ndšg_§ã
.
	`’d
());

533 
³ndšg_§ã
.
	`”a£
(
™
);

534 ià(
³ndšg_§ã
.
	`em±y
())

535 
§ã_pos
 = 
Ãxt_§ã_pos
;

537 
§ã_pos
 = 
³ndšg_§ã
.
	`begš
()->
£cÚd
;

539 
	`ldout
(
cù
, 10è<< "_fšish_æush saã from " << 
¡¬t


540 << ",…’dšg_§ã " << 
³ndšg_§ã


542 << "(" << 
´ez”ošg_pos
 << "/" << 
´ez”o_pos
 << ")/"

543 << 
wr™e_pos
 << "/" << 
æush_pos
 << "/" << 
§ã_pos


544 << 
d’dl
;

547 ià(!
wa™fÜ_§ã
.
	`em±y
()) {

548 
li¡
<
CÚ‹xt
*> 
ls
;

549 !
wa™fÜ_§ã
.
	`em±y
()) {

550 autØ
™
 = 
wa™fÜ_§ã
.
	`begš
();

551 ià(
™
->
fœ¡
 > 
§ã_pos
)

553 
ls
.
	`¥liû
Ös.
	`’d
(), 
™
->
£cÚd
);

554 
wa™fÜ_§ã
.
	`”a£
(
™
);

556 
	`fšish_cÚ‹xts
(
cù
, 
ls
);

558 
	}
}

562 
ušt64_t
 
	gJouº®”
::
	$­³nd_’Œy
(
bufã¾i¡
& 
bl
)

564 
unique_lock
 
	`l
(
lock
);

566 
	`as£¹
(!
»adÚly
);

567 
ušt32_t
 
s
 = 
bl
.
	`Ëngth
();

570 
size_t
 
d–
 = 
bl
.
	`Ëngth
(è+ 
jouº®_¡»am
.
	`g‘_’v–İe_size
();

572 ià(!
wr™e_buf_thrÙe
.
	`g‘_Ü_ç
(
d–
)) {

573 
l
.
	`uÆock
();

574 
	`ldout
(
cù
, 10è<< "wr™e_buf_thrÙwa™, d– " << 
d–
 << 
d’dl
;

575 
wr™e_buf_thrÙe
.
	`g‘
(
d–
);

576 
l
.
	`lock
();

578 
	`ldout
(
cù
, 20è<< "wr™e_buf_thrÙg‘, d– " << 
d–
 << 
d’dl
;

579 
size_t
 
wrÙe
 = 
jouº®_¡»am
.
	`wr™e
(
bl
, &
wr™e_buf
, 
wr™e_pos
);

580 
	`ldout
(
cù
, 10è<< "­³nd_’Œy†’ " << 
s
 << "Ø" << 
wr™e_pos
 << "~"

581 << 
wrÙe
 << 
d’dl
;

582 
wr™e_pos
 +ğ
wrÙe
;

585 
ušt64_t
 
su
 = 
	`g‘_Ïyout_³riod
();

586 
	`as£¹
(
su
 > 0);

587 
ušt64_t
 
wr™e_off
 = 
wr™e_pos
 % 
su
;

588 
ušt64_t
 
wr™e_obj
 = 
wr™e_pos
 / 
su
;

589 
ušt64_t
 
æush_obj
 = 
æush_pos
 / 
su
;

590 ià(
wr™e_obj
 !ğ
æush_obj
) {

591 
	`ldout
(
cù
, 10è<< " flushšg com¶‘ed objeù(sè(su " << 
su
 << " wro "

592 << 
wr™e_obj
 << " flØ" << 
æush_obj
 << ")" << 
d’dl
;

593 
	`_do_æush
(
wr™e_buf
.
	`Ëngth
(è- 
wr™e_off
);

597 ià(
wr™e_buf
.
	`Ëngth
() > 0 &&

598 
wr™e_buf
.
	`Ëngth
(è<ğ
wrÙe
) {

600 
Ãxt_§ã_pos
 = 
wr™e_pos
 - 
wrÙe
;

604  
wr™e_pos
;

605 
	}
}

608 
	gJouº®”
::
	$_do_æush
(
amouÁ
)

610 ià(
	`is_¡İpšg
())

612 ià(
wr™e_pos
 =ğ
æush_pos
)

614 
	`as£¹
(
wr™e_pos
 > 
æush_pos
);

615 
	`as£¹
(!
»adÚly
);

618 
ušt64_t
 
Ën
 = 
wr™e_pos
 - 
æush_pos
;

619 
	`as£¹
(
Ën
 =ğ
wr™e_buf
.
	`Ëngth
());

620 ià(
amouÁ
 &&‡mouÁ < 
Ën
)

621 
Ën
 = 
amouÁ
;

625 
ušt64_t
 
³riod
 = 
	`g‘_Ïyout_³riod
();

626 ià(
æush_pos
 + 
Ën
 + 2*
³riod
 > 
´ez”o_pos
) {

627 
	`_issue_´ez”o
();

629 
št64_t
 
ÃwËn
 = 
´ez”o_pos
 - 
æush_pos
 - 
³riod
;

630 ià(
ÃwËn
 <= 0) {

631 
	`ldout
(
cù
, 10è<< "_do_æush wª‹dØdØ" << 
æush_pos
 << "~" << 
Ën


632 << "‡Ì—dyoØşo£Ø´ez”o_po " << 
´ez”o_pos


633 << ", z”ošg fœ¡" << 
d’dl
;

634 
wa™šg_fÜ_z”o_pos
 = 
æush_pos
 + 
Ën
;

637 ià(
¡©ic_ÿ¡
<
ušt64_t
>(
ÃwËn
è< 
Ën
) {

638 
	`ldout
(
cù
, 10è<< "_do_æush wª‹dØdØ" << 
æush_pos
 << "~" << 
Ën


639 << " buˆh™…»z”o_po " << 
´ez”o_pos


640 << ", wÈdØ" << 
æush_pos
 << "~" << 
ÃwËn
 << 
d’dl
;

641 
wa™šg_fÜ_z”o_pos
 = 
æush_pos
 + 
Ën
;

642 
Ën
 = 
ÃwËn
;

645 
	`ldout
(
cù
, 10è<< "_do_æush flushšg " << 
æush_pos
 << "~" << 
Ën
 << 
d’dl
;

649 
ûph
::
»®_time
 
now
 = c•h::
»®_şock
::
	`now
();

650 
SÇpCÚ‹xt
 
¢­c
;

652 
CÚ‹xt
 *
Ú§ã
 = 
Ãw
 
	`C_Flush
(
this
, 
æush_pos
, 
now
);

653 
³ndšg_§ã
[
æush_pos
] = 
Ãxt_§ã_pos
;

655 
bufã¾i¡
 
wr™e_bl
;

658 ià(
Ën
 =ğ
wr™e_buf
.
	`Ëngth
()) {

659 
wr™e_bl
.
	`sw­
(
wr™e_buf
);

660 
Ãxt_§ã_pos
 = 
wr™e_pos
;

662 
wr™e_buf
.
	`¥liû
(0, 
Ën
, &
wr™e_bl
);

667 autØ
p
 = 
wa™fÜ_§ã
.
	`low”_bound
(
æush_pos
 + 
Ën
);

668 ià(
p
 !ğ
wa™fÜ_§ã
.
	`’d
()) {

669 ià(
p
->
fœ¡
 > 
æush_pos
 + 
Ën
 &&… !ğ
wa™fÜ_§ã
.
	`begš
())

670 --
p
;

671 ià(
p
->
fœ¡
 <ğ
æush_pos
 + 
Ën
 &&…->fœ¡ > 
Ãxt_§ã_pos
)

672 
Ãxt_§ã_pos
 = 
p
->
fœ¡
;

676 
f”
.
	`wr™e
(
šo
, &
Ïyout
, 
¢­c
,

677 
æush_pos
, 
Ën
, 
wr™e_bl
, 
ûph
::
»®_şock
::
	`now
(),

679 
	`w¿p_fšish”
(
Ú§ã
), 
wr™e_iohšt
);

681 
æush_pos
 +ğ
Ën
;

682 
	`as£¹
(
wr™e_buf
.
	`Ëngth
(è=ğ
wr™e_pos
 - 
æush_pos
);

683 
wr™e_buf_thrÙe
.
	`put
(
Ën
);

684 
	`ldout
(
cù
, 20è<< "wr™e_buf_thrÙput,†’ " << 
Ën
 << 
d’dl
;

686 
	`ldout
(
cù
, 10)

688 << "(" << 
´ez”ošg_pos
 << "/" << 
´ez”o_pos
 << ")/" << 
wr™e_pos


689 << "/" << 
æush_pos
 << "/" << 
§ã_pos
 << 
d’dl
;

691 
	`_issue_´ez”o
();

692 
	}
}

695 
	gJouº®”
::
	$wa™_fÜ_æush
(
CÚ‹xt
 *
Ú§ã
)

697 
lock_gu¬d
 
	`l
(
lock
);

698 ià(
	`is_¡İpšg
()) {

699 
Ú§ã
->
	`com¶‘e
(-
EAGAIN
);

702 
	`_wa™_fÜ_æush
(
Ú§ã
);

703 
	}
}

705 
	gJouº®”
::
	$_wa™_fÜ_æush
(
CÚ‹xt
 *
Ú§ã
)

707 
	`as£¹
(!
»adÚly
);

710 ià(
wr™e_pos
 =ğ
§ã_pos
) {

711 
	`as£¹
(
wr™e_buf
.
	`Ëngth
() == 0);

712 
	`ldout
(
cù
, 10)

714 "poš‹r © " << "(" << 
´ez”ošg_pos
 << "/" << 
´ez”o_pos
 << ")/"

715 << 
wr™e_pos
 << "/" << 
æush_pos
 << "/" << 
§ã_pos
 << 
d’dl
;

716 ià(
Ú§ã
) {

717 
fšish”
->
	`queue
(
Ú§ã
, 0);

723 ià(
Ú§ã
) {

724 
wa™fÜ_§ã
[
wr™e_pos
].
	`push_back
(
	`w¿p_fšish”
(
Ú§ã
));

726 
	}
}

728 
	gJouº®”
::
	$æush
(
CÚ‹xt
 *
Ú§ã
)

730 
lock_gu¬d
 
	`l
(
lock
);

731 ià(
	`is_¡İpšg
()) {

732 
Ú§ã
->
	`com¶‘e
(-
EAGAIN
);

735 
	`_æush
(
	`w¿p_fšish”
(
Ú§ã
));

736 
	}
}

738 
	gJouº®”
::
	$_æush
(
C_OnFšish”
 *
Ú§ã
)

740 
	`as£¹
(!
»adÚly
);

742 ià(
wr™e_pos
 =ğ
æush_pos
) {

743 
	`as£¹
(
wr™e_buf
.
	`Ëngth
() == 0);

744 
	`ldout
(
cù
, 10) << "flush‚othingo flush, (prezeroing/prezero)/write/"

745 "æush/§ã…oš‹r © " << "(" << 
´ez”ošg_pos
 << "/" << 
´ez”o_pos


746 << ")/" << 
wr™e_pos
 << "/" << 
æush_pos
 << "/" << 
§ã_pos


747 << 
d’dl
;

748 ià(
Ú§ã
) {

749 
Ú§ã
->
	`com¶‘e
(0);

752 
	`_do_æush
();

753 
	`_wa™_fÜ_æush
(
Ú§ã
);

757 ià(
	`_wr™e_h—d_Ãeded
()) {

758 
	`_wr™e_h—d
();

760 
	}
}

762 
boŞ
 
	gJouº®”
::
	$_wr™e_h—d_Ãeded
()

764  
Ï¡_wrÙe_h—d
 + 
	`£cÚds
(
cù
->
_cÚf
->
g‘_v®
<
št64_t
>("journaler_write_head_interval"))

765 < 
ûph
::
»®_şock
::
	`now
();

766 
	}
}

771 
	gC_Jouº®”_P»z”o
 : 
public
 
CÚ‹xt
 {

772 
Jouº®”
 *
jouº®”
;

773 
ušt64_t
 
	gäom
, 
	gËn
;

774 
C_Jouº®”_P»z”o
(
Jouº®”
 *
j
, 
ušt64_t
 
f
, ušt64_ˆ
l
)

775 : 
jouº®”
(
j
), 
äom
(
f
), 
Ën
(
l
) {}

776 
fšish
(
r
è
	gov”ride
 {

777 
	gjouº®”
->
_fšish_´ez”o
(
r
, 
äom
, 
Ën
);

781 
	gJouº®”
::
	$_issue_´ez”o
()

783 
	`as£¹
(
´ez”ošg_pos
 >ğ
æush_pos
);

785 
ušt64_t
 
num_³riods
 = 
cù
->
_cÚf
->
g‘_v®
<uint64_t>("journaler_prezero_periods");

790 
ušt64_t
 
³riod
 = 
	`g‘_Ïyout_³riod
();

791 
ušt64_t
 
to
 = 
wr™e_pos
 + 
³riod
 * 
num_³riods
 +…eriod - 1;

792 
to
 -ğtØ% 
³riod
;

794 ià(
´ez”ošg_pos
 >ğ
to
) {

795 
	`ldout
(
cù
, 20è<< "_issue_´ez”Ørg‘ " << 
to
 << " <=…rezeroing_pos "

796 << 
´ez”ošg_pos
 << 
d’dl
;

800 
´ez”ošg_pos
 < 
to
) {

801 
ušt64_t
 
Ën
;

802 ià(
´ez”ošg_pos
 % 
³riod
 == 0) {

803 
Ën
 = 
³riod
;

804 
	`ldout
(
cù
, 10è<< "_issue_´ez”Ø»movšg " << 
´ez”ošg_pos
 << "~"

805 << 
³riod
 << " (fuÎ…”iod)" << 
d’dl
;

807 
Ën
 = 
³riod
 - (
´ez”ošg_pos
 %…eriod);

808 
	`ldout
(
cù
, 10è<< "_issue_´ez”Øz”ošg " << 
´ez”ošg_pos
 << "~"

809 << 
Ën
 << " (·¹ŸÈ³riod)" << 
d’dl
;

811 
SÇpCÚ‹xt
 
¢­c
;

812 
CÚ‹xt
 *
c
 = 
	`w¿p_fšish”
(
Ãw
 
	`C_Jouº®”_P»z”o
(
this
, 
´ez”ošg_pos
,

813 
Ën
));

814 
f”
.
	`z”o
(
šo
, &
Ïyout
, 
¢­c
, 
´ez”ošg_pos
, 
Ën
,

815 
ûph
::
»®_şock
::
	`now
(), 0, 
c
);

816 
´ez”ošg_pos
 +ğ
Ën
;

818 
	}
}

823 
	gJouº®”
::
	$_fšish_´ez”o
(
r
, 
ušt64_t
 
¡¬t
, ušt64_ˆ
Ën
)

825 
lock_gu¬d
 
	`l
(
lock
);

827 
	`ldout
(
cù
, 10è<< "_´ez”ÛdØ" << 
¡¬t
 << "~" << 
Ën


828 << ",…»z”ošg/´ez”Øwa " << 
´ez”ošg_pos
 << "/"

829 << 
´ez”o_pos
 << ",…’dšg " << 
³ndšg_z”o


830 << 
d’dl
;

831 ià(
r
 < 0 &&„ !ğ-
ENOENT
) {

832 
	`ld”r
(
cù
è<< "_´ez”Ûd gÙ " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

833 
	`hªdË_wr™e_”rÜ
(
r
);

837 
	`as£¹
(
r
 =ğ0 ||„ =ğ-
ENOENT
);

839 ià(
¡¬t
 =ğ
´ez”o_pos
) {

840 
´ez”o_pos
 +ğ
Ën
;

841 !
³ndšg_z”o
.
	`em±y
() &&

842 
³ndšg_z”o
.
	`begš
().
	`g‘_¡¬t
(è=ğ
´ez”o_pos
) {

843 
š‹rv®_£t
<
ušt64_t
>::
™”©Ü
 
	`b
(
³ndšg_z”o
.
	`begš
());

844 
´ez”o_pos
 +ğ
b
.
	`g‘_Ën
();

845 
³ndšg_z”o
.
	`”a£
(
b
);

848 ià(
wa™šg_fÜ_z”o_pos
 > 
æush_pos
) {

849 
	`_do_æush
(
wa™šg_fÜ_z”o_pos
 - 
æush_pos
);

852 ià(
´ez”o_pos
 =ğ
´ez”ošg_pos
 &&

853 !
wa™fÜ_´ez”o
.
	`em±y
()) {

854 
li¡
<
CÚ‹xt
*> 
ls
;

855 
ls
.
	`sw­
(
wa™fÜ_´ez”o
);

856 
	`fšish_cÚ‹xts
(
cù
, 
ls
, 0);

859 
³ndšg_z”o
.
	`š£¹
(
¡¬t
, 
Ën
);

861 
	`ldout
(
cù
, 10è<< "_´ez”Ûd…»z”ošg/´ez”Ønow " << 
´ez”ošg_pos


862 << "/" << 
´ez”o_pos


863 << ",…’dšg " << 
³ndšg_z”o


864 << 
d’dl
;

865 
	}
}

867 
	gJouº®”
::
	$wa™_fÜ_´ez”o
(
CÚ‹xt
 *
Úfšish
)

869 
	`as£¹
(
Úfšish
);

870 
lock_gu¬d
 
	`l
(
lock
);

872 ià(
´ez”o_pos
 =ğ
´ez”ošg_pos
) {

873 
fšish”
->
	`queue
(
Úfšish
, 0);

876 
wa™fÜ_´ez”o
.
	`push_back
(
	`w¿p_fšish”
(
Úfšish
));

877 
	}
}

883 şas 
	cJouº®”
::
C_R—d
 : 
public
 
CÚ‹xt
 {

884 
Jouº®”
 *
ls
;

885 
ušt64_t
 
	moff£t
;

886 
ušt64_t
 
	mËngth
;

887 
	mpublic
:

888 
bufã¾i¡
 
bl
;

889 
	$C_R—d
(
Jouº®”
 *
j
, 
ušt64_t
 
o
, ušt64_ˆ
l
è: 
	`ls
(j), 
	`off£t
(o), 
	$Ëngth
(
l
) {}

890 
	$fšish
(
r
è
ov”ride
 {

891 
ls
->
	`_fšish_»ad
(
r
, 
off£t
, 
Ëngth
, 
bl
);

892 
	}
}

895 şas 
	cJouº®”
::
C_R‘ryR—d
 : 
public
 
CÚ‹xt
 {

896 
Jouº®”
 *
ls
;

897 
	mpublic
:

898 
ex¶ic™
 
	$C_R‘ryR—d
(
Jouº®”
 *
l
è: 
	$ls
(
l
) {}

900 
	$fšish
(
r
è
ov”ride
 {

903 
ls
->
	`_´eãtch
();

904 
	}
}

907 
	gJouº®”
::
	$_fšish_»ad
(
r
, 
ušt64_t
 
off£t
, ušt64_ˆ
Ëngth
,

908 
bufã¾i¡
& 
bl
)

910 
lock_gu¬d
 
	`l
(
lock
);

912 ià(
r
 < 0) {

913 
	`ldout
(
cù
, 0è<< "_fšish_»ad gÙƒ¼Ü " << 
r
 << 
d’dl
;

914 
”rÜ
 = 
r
;

916 
	`ldout
(
cù
, 10è<< "_fšish_»ad gÙ " << 
off£t
 << "~" << 
bl
.
	`Ëngth
()

917 << 
d’dl
;

918 ià(
bl
.
	`Ëngth
(è< 
Ëngth
) {

919 
	`ldout
(
cù
, 0è<< "_fšish_»ad gÙ†es thªƒx³ùed (" << 
Ëngth
 << ")"

920 << 
d’dl
;

921 
”rÜ
 = -
EINVAL
;

925 ià(
”rÜ
) {

926 ià(
Ú_»adabË
) {

927 
C_OnFšish”
 *
f
 = 
Ú_»adabË
;

928 
Ú_»adabË
 = 0;

929 
f
->
	`com¶‘e
(
”rÜ
);

934 
´eãtch_buf
[
off£t
].
	`sw­
(
bl
);

936 
Œy
 {

937 
	`_assim©e_´eãtch
();

938 } 
	`ÿtch
 (cÚ¡ 
bufãr
::
”rÜ
 &
”r
) {

939 
	`ld”r
(
cù
è<< "_decod”rÜ from‡ssim©e_´eãtch" << 
d’dl
;

940 
”rÜ
 = -
EINVAL
;

941 ià(
Ú_»adabË
) {

942 
C_OnFšish”
 *
f
 = 
Ú_»adabË
;

943 
Ú_»adabË
 = 0;

944 
f
->
	`com¶‘e
(
”rÜ
);

948 
	`_´eãtch
();

949 
	}
}

951 
	gJouº®”
::
	$_assim©e_´eãtch
()

953 
boŞ
 
was_»adabË
 = 
»adabË
;

955 
boŞ
 
gÙ_ªy
 = 
çl£
;

956 !
´eãtch_buf
.
	`em±y
()) {

957 
m­
<
ušt64_t
,
bufã¾i¡
>::
™”©Ü
 
p
 = 
´eãtch_buf
.
	`begš
();

958 ià(
p
->
fœ¡
 !ğ
»ûived_pos
) {

959 
ušt64_t
 
g­
 = 
p
->
fœ¡
 - 
»ûived_pos
;

960 
	`ldout
(
cù
, 10è<< "_assim©e_´eãtch g­ oà" << 
g­


961 << " from„eûived_po " << 
»ûived_pos


962 << "Øfœ¡…»ãtched bufã¸" << 
p
->
fœ¡
 << 
d’dl
;

966 
	`ldout
(
cù
, 10è<< "_assim©e_´eãtch " << 
p
->
fœ¡
 << "~"

967 << 
p
->
£cÚd
.
	`Ëngth
(è<< 
d’dl
;

968 
»ûived_pos
 +ğ
p
->
£cÚd
.
	`Ëngth
();

969 
»ad_buf
.
	`şaim_­³nd
(
p
->
£cÚd
);

970 
	`as£¹
(
»ûived_pos
 <ğ
»que¡ed_pos
);

971 
´eãtch_buf
.
	`”a£
(
p
);

972 
gÙ_ªy
 = 
Œue
;

975 ià(
gÙ_ªy
) {

976 
	`ldout
(
cù
, 10è<< "_assim©e_´eãtch„—d_buànow " << 
»ad_pos
 << "~"

977 << 
»ad_buf
.
	`Ëngth
(è<< ",„—d…oš‹r »ad_pos=" << 
»ad_pos


978 << "„eûived_pos=" << 
»ûived_pos
 << "„eque¡ed_pos=" << 
»que¡ed_pos


979 << 
d’dl
;

983 
»adabË
 = 
	`_is_»adabË
();

986 ià((
gÙ_ªy
 && !
was_»adabË
 && 
»adabË
è|| 
»ad_pos
 =ğ
wr™e_pos
) {

988 
	`ldout
(
cù
, 10) << "_finish_read‚ow„eadable (or‡t journalƒnd)„eadable="

989 << 
»adabË
 << "„—d_pos=" << 
»ad_pos
 << " write_pos="

990 << 
wr™e_pos
 << 
d’dl
;

991 ià(
Ú_»adabË
) {

992 
C_OnFšish”
 *
f
 = 
Ú_»adabË
;

993 
Ú_»adabË
 = 0;

994 
f
->
	`com¶‘e
(0);

997 
	}
}

999 
	gJouº®”
::
	$_issue_»ad
(
ušt64_t
 
Ën
)

1003 
	`as£¹
(
»que¡ed_pos
 <ğ
§ã_pos
);

1004 ià(
»que¡ed_pos
 =ğ
§ã_pos
) {

1005 
	`ldout
(
cù
, 10è<< "_issue_»ad„eque¡ed_po ğ§ã_po ğ" << 
§ã_pos


1006 << ", wa™šg" << 
d’dl
;

1007 
	`as£¹
(
wr™e_pos
 > 
»que¡ed_pos
);

1008 ià(
³ndšg_§ã
.
	`em±y
()) {

1009 
	`_æush
(
NULL
);

1016 autØ
p
 = 
³ndšg_§ã
.
	`rbegš
();

1017 ià(
p
 !ğ
³ndšg_§ã
.
	`»nd
())

1018 
wa™fÜ_§ã
[
p
->
£cÚd
].
	`push_back
(
Ãw
 
	`C_R‘ryR—d
(
this
));

1020 
wa™fÜ_§ã
[
Ãxt_§ã_pos
].
	`push_back
(
Ãw
 
	`C_R‘ryR—d
(
this
));

1025 ià(
»que¡ed_pos
 + 
Ën
 > 
§ã_pos
) {

1026 
Ën
 = 
§ã_pos
 - 
»que¡ed_pos
;

1027 
	`ldout
(
cù
, 10è<< "_issue_»ad„—dšg oÆy u°tØ§ã_po " << 
§ã_pos


1028 << 
d’dl
;

1032 
	`ldout
(
cù
, 10è<< "_issue_»ad„—dšg " << 
»que¡ed_pos
 << "~" << 
Ën


1033 << ",„—d…oš‹r »ad_pos=" << 
»ad_pos
 << "„eûived_pos=" << 
»ûived_pos


1034 << "„eque¡ed_pos+Ën=" << (
»que¡ed_pos
+
Ën
è<< 
d’dl
;

1040 
ušt64_t
 
³riod
 = 
	`g‘_Ïyout_³riod
();

1041 
Ën
 > 0) {

1042 
ušt64_t
 
e
 = 
»que¡ed_pos
 + 
³riod
;

1043 
e
 -ğ% 
³riod
;

1044 
ušt64_t
 
l
 = 
e
 - 
»que¡ed_pos
;

1045 ià(
l
 > 
Ën
)

1046 
l
 = 
Ën
;

1047 
C_R—d
 *
c
 = 
Ãw
 
	`C_R—d
(
this
, 
»que¡ed_pos
, 
l
);

1048 
f”
.
	`»ad
(
šo
, &
Ïyout
, 
CEPH_NOSNAP
, 
»que¡ed_pos
, 
l
, &
c
->
bl
, 0,

1049 
	`w¿p_fšish”
(
c
), 
CEPH_OSD_OP_FLAG_FADVISE_DONTNEED
);

1050 
»que¡ed_pos
 +ğ
l
;

1051 
Ën
 -ğ
l
;

1053 
	}
}

1055 
	gJouº®”
::
	$_´eãtch
()

1057 ià(
	`is_¡İpšg
())

1060 
	`ldout
(
cù
, 10è<< "_´eãtch" << 
d’dl
;

1062 
ušt64_t
 
pf
;

1063 ià(
‹mp_ãtch_Ën
) {

1064 
	`ldout
(
cù
, 10è<< "_´eãtchemp_ãtch_ËÀ" << 
‹mp_ãtch_Ën
 << 
d’dl
;

1065 
pf
 = 
‹mp_ãtch_Ën
;

1066 
‹mp_ãtch_Ën
 = 0;

1068 
pf
 = 
ãtch_Ën
;

1071 
ušt64_t
 
¿w_rg‘
 = 
»ad_pos
 + 
pf
;

1074 
ušt64_t
 
³riod
 = 
	`g‘_Ïyout_³riod
();

1075 
ušt64_t
 
»mašd”
 = 
¿w_rg‘
 % 
³riod
;

1076 
ušt64_t
 
adju¡m’t
 = 
»mašd”
 ? 
³riod
 -„emainder : 0;

1077 
ušt64_t
 
rg‘
 = 
¿w_rg‘
 + 
adju¡m’t
;

1080 ià(
rg‘
 > 
wr™e_pos
)

1081 
rg‘
 = 
wr™e_pos
;

1083 ià(
»que¡ed_pos
 < 
rg‘
) {

1084 
ušt64_t
 
Ën
 = 
rg‘
 - 
»que¡ed_pos
;

1085 
	`ldout
(
cù
, 10è<< "_´eãtch " << 
pf
 << "„eque¡ed_po " << 
»que¡ed_pos


1086 << " <¬g‘ " << 
rg‘
 << " (" << 
¿w_rg‘


1087 << "),…»ãtchšg " << 
Ën
 << 
d’dl
;

1089 ià(
³ndšg_§ã
.
	`em±y
(è&& 
wr™e_pos
 > 
§ã_pos
) {

1094 
	`ldout
(
cù
, 10è<< "_´eãtch:„eque¡ed_pos=" << 
»que¡ed_pos


1095 << ",„—d_pos=" << 
»ad_pos


1096 << ", wr™e_pos=" << 
wr™e_pos


1097 << ", saã_pos=" << 
§ã_pos
 << 
d’dl
;

1098 
	`_do_æush
();

1101 
	`_issue_»ad
(
Ën
);

1103 
	}
}

1109 
boŞ
 
	gJouº®”
::
	$_is_»adabË
()

1112 ià(
»ad_pos
 =ğ
wr™e_pos
)

1113  
çl£
;

1116 
ušt64_t
 
Ãed
;

1117 ià(
jouº®_¡»am
.
	`»adabË
(
»ad_buf
, &
Ãed
)) {

1118  
Œue
;

1121 
	`ldout
 (
cù
, 10è<< "_is_»adabË„—d_buf.Ëngth(è=ğ" << 
»ad_buf
.
	`Ëngth
()

1122 << ", buˆÃed " << 
Ãed
 << " for‚extƒntry; fetch_len is "

1123 << 
ãtch_Ën
 << 
d’dl
;

1126 ià(
»ûived_pos
 =ğ
wr™e_pos
) {

1127 
	`ldout
(
cù
, 10) << "is_readable() detected…artialƒntry‡tail, "

1128 "adju¡šg wr™e_po tØ" << 
»ad_pos
 << 
d’dl
;

1131 
´ez”ošg_pos
 = 
´ez”o_pos
 = 
wr™e_pos
 = 
æush_pos
 = 
§ã_pos
 = 
Ãxt_§ã_pos
 = 
»ad_pos
;

1132 
	`as£¹
(
wr™e_buf
.
	`Ëngth
() == 0);

1133 
	`as£¹
(
wa™fÜ_§ã
.
	`em±y
());

1136 
»que¡ed_pos
 = 
»ûived_pos
 = 
»ad_pos
;

1137 
»ad_buf
.
	`ş—r
();

1141  
çl£
;

1144 ià(
Ãed
 > 
ãtch_Ën
) {

1145 
‹mp_ãtch_Ën
 = 
Ãed
;

1146 
	`ldout
(
cù
, 10è<< "_is_»adabË‚Ùšgemp_ãtch_ËÀ" << 
‹mp_ãtch_Ën


1147 << 
d’dl
;

1150 
	`ldout
(
cù
, 10è<< "_is_»adabË:‚Ù„—dabË,„‘uºšg f®£" << 
d’dl
;

1151  
çl£
;

1152 
	}
}

1157 
boŞ
 
	gJouº®”
::
	$is_»adabË
()

1159 
lock_gu¬d
 
	`l
(
lock
);

1161 ià(
”rÜ
 != 0) {

1162  
çl£
;

1165 
boŞ
 
r
 = 
»adabË
;

1166 
	`_´eãtch
();

1167  
r
;

1168 
	}
}

1170 şas 
	cJouº®”
::
C_E¿£Fšish
 : 
public
 
CÚ‹xt
 {

1171 
Jouº®”
 *
jouº®”
;

1172 
C_OnFšish”
 *
	mcom¶‘iÚ
;

1173 
	mpublic
:

1174 
	$C_E¿£Fšish
(
Jouº®”
 *
j
, 
C_OnFšish”
 *
c
è: 
	`jouº®”
(j), 
	$com¶‘iÚ
(
c
) {}

1175 
	$fšish
(
r
è
ov”ride
 {

1176 
jouº®”
->
	`_fšish_”a£
(
r
, 
com¶‘iÚ
);

1177 
	}
}

1184 
	gJouº®”
::
	$”a£
(
CÚ‹xt
 *
com¶‘iÚ
)

1186 
lock_gu¬d
 
	`l
(
lock
);

1189 
ušt64_t
 
fœ¡
 = 
Œimmed_pos
 / 
	`g‘_Ïyout_³riod
();

1190 
ušt64_t
 
num
 = (
wr™e_pos
 - 
Œimmed_pos
è/ 
	`g‘_Ïyout_³riod
() + 2;

1191 
f”
.
	`purge_¿nge
(
šo
, &
Ïyout
, 
	`SÇpCÚ‹xt
(), 
fœ¡
, 
num
,

1192 
ûph
::
»®_şock
::
	`now
(), 0,

1193 
	`w¿p_fšish”
(
Ãw
 
	`C_E¿£Fšish
(

1194 
this
, 
	`w¿p_fšish”
(
com¶‘iÚ
))));

1200 
	}
}

1202 
	gJouº®”
::
	$_fšish_”a£
(
d©a_»suÉ
, 
C_OnFšish”
 *
com¶‘iÚ
)

1204 
lock_gu¬d
 
	`l
(
lock
);

1205 ià(
	`is_¡İpšg
()) {

1206 
com¶‘iÚ
->
	`com¶‘e
(-
EAGAIN
);

1210 ià(
d©a_»suÉ
 == 0) {

1212 
f”
.
	`purge_¿nge
(
šo
, &
Ïyout
, 
	`SÇpCÚ‹xt
(), 0, 1,

1213 
ûph
::
»®_şock
::
	`now
(),

1214 0, 
	`w¿p_fšish”
(
com¶‘iÚ
));

1216 
	`ld”r
(
cù
è<< "FaedØd–‘jouº® " << 
šo
 << " data: "

1217 << 
	`ıp_¡»¼Ü
(
d©a_»suÉ
è<< 
d’dl
;

1218 
com¶‘iÚ
->
	`com¶‘e
(
d©a_»suÉ
);

1220 
	}
}

1226 
boŞ
 
	gJouº®”
::
	$Œy_»ad_’Œy
(
bufã¾i¡
& 
bl
)

1228 
lock_gu¬d
 
	`l
(
lock
);

1230 ià(!
»adabË
) {

1231 
	`ldout
(
cù
, 10è<< "Œy_»ad_’Œy‡ˆ" << 
»ad_pos
 << "‚ot„eadable"

1232 << 
d’dl
;

1233  
çl£
;

1236 
ušt64_t
 
¡¬t_±r
;

1237 
size_t
 
cÚsumed
;

1238 
Œy
 {

1239 
cÚsumed
 = 
jouº®_¡»am
.
	`»ad
(
»ad_buf
, &
bl
, &
¡¬t_±r
);

1240 ià(
¡»am_fÜm©
 >ğ
JOURNAL_FORMAT_RESILIENT
) {

1241 
	`as£¹
(
¡¬t_±r
 =ğ
»ad_pos
);

1243 } 
	`ÿtch
 (cÚ¡ 
bufãr
::
”rÜ
 &
e
) {

1244 
	`ld”r
(
cù
è<< 
__func__
 << ": decod”rÜ from jouº®_¡»am" << 
d’dl
;

1245 
”rÜ
 = -
EINVAL
;

1246  
çl£
;

1249 
	`ldout
(
cù
, 10è<< "Œy_»ad_’Œy‡ˆ" << 
»ad_pos
 << "„ead "

1250 << 
»ad_pos
 << "~" << 
cÚsumed
 << " (have "

1251 << 
»ad_buf
.
	`Ëngth
(è<< ")" << 
d’dl
;

1253 
»ad_pos
 +ğ
cÚsumed
;

1254 
Œy
 {

1256 
»adabË
 = 
	`_is_»adabË
();

1257 } 
	`ÿtch
 (cÚ¡ 
bufãr
::
”rÜ
 &
e
) {

1258 
	`ld”r
(
cù
è<< 
__func__
 << ": decod”rÜ from _is_»adabË" << 
d’dl
;

1259 
”rÜ
 = -
EINVAL
;

1260  
çl£
;

1264 
	`_´eãtch
();

1265  
Œue
;

1266 
	}
}

1268 
	gJouº®”
::
	$wa™_fÜ_»adabË
(
CÚ‹xt
 *
Ú»adabË
)

1270 
lock_gu¬d
 
	`l
(
lock
);

1271 ià(
	`is_¡İpšg
()) {

1272 
fšish”
->
	`queue
(
Ú»adabË
, -
EAGAIN
);

1276 
	`as£¹
(
Ú_»adabË
 == 0);

1277 ià(!
»adabË
) {

1278 
	`ldout
(
cù
, 10è<< "wa™_fÜ_»adabË‡ˆ" << 
»ad_pos
 << " onreadable "

1279 << 
Ú»adabË
 << 
d’dl
;

1280 
Ú_»adabË
 = 
	`w¿p_fšish”
(
Ú»adabË
);

1283 
fšish”
->
	`queue
(
Ú»adabË
, 0);

1285 
	}
}

1287 
boŞ
 
	gJouº®”
::
	$have_wa™”
() const

1289  
Ú_»adabË
 !ğ
nuÎ±r
;

1290 
	}
}

1298 şas 
	cJouº®”
::
C_Trim
 : 
public
 
CÚ‹xt
 {

1299 
Jouº®”
 *
ls
;

1300 
ušt64_t
 
	mto
;

1301 
	mpublic
:

1302 
	$C_Trim
(
Jouº®”
 *
l
, 
št64_t
 
t
è: 
	`ls
Ö), 
	$to
(
t
) {}

1303 
	$fšish
(
r
è
ov”ride
 {

1304 
ls
->
	`_fšish_Œim
(
r
, 
to
);

1305 
	}
}

1308 
	gJouº®”
::
	$Œim
()

1310 
lock_gu¬d
 
	`l
(
lock
);

1311 
	`_Œim
();

1312 
	}
}

1314 
	gJouº®”
::
	$_Œim
()

1316 ià(
	`is_¡İpšg
())

1319 
	`as£¹
(!
»adÚly
);

1320 
ušt64_t
 
³riod
 = 
	`g‘_Ïyout_³riod
();

1321 
ušt64_t
 
Œim_to
 = 
Ï¡_comm™‹d
.
expœe_pos
;

1322 
Œim_to
 -ğŒim_tØ% 
³riod
;

1323 
	`ldout
(
cù
, 10è<< "Œim†a¡_comm™ed h—d wa " << 
Ï¡_comm™‹d


1324 << ", cªrimØ" << 
Œim_to


1325 << 
d’dl
;

1326 ià(
Œim_to
 =ğ0 ||rim_tØ=ğ
Œimmšg_pos
) {

1327 
	`ldout
(
cù
, 10) << "trim‡lreadyrimmed/trimmingo "

1328 << 
Œimmed_pos
 << "/" << 
Œimmšg_pos
 << 
d’dl
;

1332 ià(
Œimmšg_pos
 > 
Œimmed_pos
) {

1333 
	`ldout
(
cù
, 10) << "trim‡lreadyrimming‡tm,ry‡gain†ater. "

1334 "Œimmed/Œimmšg i " << 
Œimmed_pos
 << "/" << 
Œimmšg_pos
 << 
d’dl
;

1339 
	`as£¹
(
Œim_to
 <ğ
wr™e_pos
);

1340 
	`as£¹
(
Œim_to
 <ğ
expœe_pos
);

1341 
	`as£¹
(
Œim_to
 > 
Œimmšg_pos
);

1342 
	`ldout
(
cù
, 10è<< "ŒimrimmšgØ" << 
Œim_to


1344 << 
Œimmed_pos
 << "/" << 
Œimmšg_pos
 << "/" << 
expœe_pos


1345 << 
d’dl
;

1348 
ušt64_t
 
fœ¡
 = 
Œimmšg_pos
 / 
³riod
;

1349 
ušt64_t
 
num
 = (
Œim_to
 - 
Œimmšg_pos
è/ 
³riod
;

1350 
SÇpCÚ‹xt
 
¢­c
;

1351 
f”
.
	`purge_¿nge
(
šo
, &
Ïyout
, 
¢­c
, 
fœ¡
, 
num
,

1352 
ûph
::
»®_şock
::
	`now
(), 0,

1353 
	`w¿p_fšish”
(
Ãw
 
	`C_Trim
(
this
, 
Œim_to
)));

1354 
Œimmšg_pos
 = 
Œim_to
;

1355 
	}
}

1357 
	gJouº®”
::
	$_fšish_Œim
(
r
, 
ušt64_t
 
to
)

1359 
lock_gu¬d
 
	`l
(
lock
);

1361 
	`as£¹
(!
»adÚly
);

1362 
	`ldout
(
cù
, 10è<< "_fšish_Œimrimmed_po wa " << 
Œimmed_pos


1364 << 
to
 << "/" << 
Œimmšg_pos
 << "/" << 
expœe_pos


1365 << 
d’dl
;

1366 ià(
r
 < 0 &&„ !ğ-
ENOENT
) {

1367 
	`ld”r
(
cù
è<< "_fšish_Œim gÙ " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

1368 
	`hªdË_wr™e_”rÜ
(
r
);

1372 
	`as£¹
(
r
 >ğ0 ||„ =ğ-
ENOENT
);

1374 
	`as£¹
(
to
 <ğ
Œimmšg_pos
);

1375 
	`as£¹
(
to
 > 
Œimmed_pos
);

1376 
Œimmed_pos
 = 
to
;

1377 
	}
}

1379 
	gJouº®”
::
	$hªdË_wr™e_”rÜ
(
r
)

1383 
	`ld”r
(
cù
è<< "hªdË_wr™e_”rÜ " << 
	`ıp_¡»¼Ü
(
r
è<< 
d’dl
;

1384 ià(
Ú_wr™e_”rÜ
) {

1385 
Ú_wr™e_”rÜ
->
	`com¶‘e
(
r
);

1386 
Ú_wr™e_”rÜ
 = 
NULL
;

1387 
ÿÎed_wr™e_”rÜ
 = 
Œue
;

1388 } ià(
ÿÎed_wr™e_”rÜ
) {

1392 
	`ld”r
(
cù
è<< 
__func__
 << ": multiple writeƒrrors, handler‡lready called"

1393 << 
d’dl
;

1395 
	`as£¹
(0 == "unhandled writeƒrror");

1397 
	}
}

1408 
boŞ
 
	gJouº®SŒ—m
::
	$»adabË
(
bufã¾i¡
 &
»ad_buf
, 
ušt64_t
 *
Ãed
) const

1410 
	`as£¹
(
Ãed
 !ğ
NULL
);

1412 
ušt32_t
 
’Œy_size
 = 0;

1413 
ušt64_t
 
’Œy_£Áš–
 = 0;

1414 
bufã¾i¡
::
™”©Ü
 
p
 = 
»ad_buf
.
	`begš
();

1417 ià(
fÜm©
 >ğ
JOURNAL_FORMAT_RESILIENT
) {

1418 *
Ãed
 = (
’Œy_size
è+ (
’Œy_£Áš–
);

1420 *
Ãed
 = (
’Œy_size
);

1422 ià(
»ad_buf
.
	`Ëngth
(è>ğ*
Ãed
) {

1423 ià(
fÜm©
 >ğ
JOURNAL_FORMAT_RESILIENT
) {

1424 
	`decode
(
’Œy_£Áš–
, 
p
);

1425 ià(
’Œy_£Áš–
 !ğ
£Áš–
) {

1426 
throw
 
bufãr
::
	`m®fÜmed_šput
("Invalid sentinel");

1430 
	`decode
(
’Œy_size
, 
p
);

1432  
çl£
;

1436 ià(
fÜm©
 >ğ
JOURNAL_FORMAT_RESILIENT
) {

1437 *
Ãed
 = 
JOURNAL_ENVELOPE_RESILIENT
 + 
’Œy_size
;

1439 *
Ãed
 = 
JOURNAL_ENVELOPE_LEGACY
 + 
’Œy_size
;

1441 ià(
»ad_buf
.
	`Ëngth
(è>ğ*
Ãed
) {

1442  
Œue
;

1445  
çl£
;

1446 
	}
}

1464 
size_t
 
	gJouº®SŒ—m
::
	$»ad
(
bufã¾i¡
 &
äom
, bufã¾i¡ *
’Œy
,

1465 
ušt64_t
 *
¡¬t_±r
)

1467 
	`as£¹
(
¡¬t_±r
 !ğ
NULL
);

1468 
	`as£¹
(
’Œy
 !ğ
NULL
);

1469 
	`as£¹
(
’Œy
->
	`Ëngth
() == 0);

1471 
ušt32_t
 
’Œy_size
 = 0;

1474 
bufã¾i¡
::
™”©Ü
 
äom_±r
 = 
äom
.
	`begš
();

1475 ià(
fÜm©
 >ğ
JOURNAL_FORMAT_RESILIENT
) {

1476 
ušt64_t
 
’Œy_£Áš–
 = 0;

1477 
	`decode
(
’Œy_£Áš–
, 
äom_±r
);

1480 
	`as£¹
(
’Œy_£Áš–
 =ğ
£Áš–
);

1482 
	`decode
(
’Œy_size
, 
äom_±r
);

1485 
äom_±r
.
	`cİy
(
’Œy_size
, *
’Œy
);

1488 ià(
fÜm©
 >ğ
JOURNAL_FORMAT_RESILIENT
) {

1489 
	`decode
(*
¡¬t_±r
, 
äom_±r
);

1491 *
¡¬t_±r
 = 0;

1495 
äom
.
	`¥liû
(0, 
äom_±r
.
	`g‘_off
());

1497  
äom_±r
.
	`g‘_off
();

1498 
	}
}

1504 
size_t
 
	gJouº®SŒ—m
::
	$wr™e
(
bufã¾i¡
 &
’Œy
, bufã¾i¡ *
to
,

1505 
ušt64_t
 cÚ¡ &
¡¬t_±r
)

1507 
	`as£¹
(
to
 !ğ
NULL
);

1509 
ušt32_t
 cÚ¡ 
’Œy_size
 = 
’Œy
.
	`Ëngth
();

1510 ià(
fÜm©
 >ğ
JOURNAL_FORMAT_RESILIENT
) {

1511 
	`’code
(
£Áš–
, *
to
);

1513 
	`’code
(
’Œy_size
, *
to
);

1514 
to
->
	`şaim_­³nd
(
’Œy
);

1515 ià(
fÜm©
 >ğ
JOURNAL_FORMAT_RESILIENT
) {

1516 
	`’code
(
¡¬t_±r
, *
to
);

1519 ià(
fÜm©
 >ğ
JOURNAL_FORMAT_RESILIENT
) {

1520  
JOURNAL_ENVELOPE_RESILIENT
 + 
’Œy_size
;

1522  
JOURNAL_ENVELOPE_LEGACY
 + 
’Œy_size
;

1524 
	}
}

1540 
	gJouº®”
::
	$£t_wr™e_”rÜ_hªdËr
(
CÚ‹xt
 *
c
) {

1541 
lock_gu¬d
 
	`l
(
lock
);

1542 
	`as£¹
(!
Ú_wr™e_”rÜ
);

1543 
Ú_wr™e_”rÜ
 = 
	`w¿p_fšish”
(
c
);

1544 
ÿÎed_wr™e_”rÜ
 = 
çl£
;

1545 
	}
}

1554 
C_OnFšish”
 *
	gJouº®”
::
	$w¿p_fšish”
(
CÚ‹xt
 *
c
)

1556 ià(
c
 !ğ
NULL
) {

1557  
Ãw
 
	`C_OnFšish”
(
c
, 
fšish”
);

1559  
NULL
;

1561 
	}
}

1563 
	gJouº®”
::
	$shutdown
()

1565 
lock_gu¬d
 
	`l
(
lock
);

1567 
	`ldout
(
cù
, 1è<< 
__func__
 << 
d’dl
;

1569 
¡©e
 = 
STATE_STOPPING
;

1570 
»adabË
 = 
çl£
;

1573 
”rÜ
 = -
EAGAIN
;

1574 ià(
Ú_»adabË
) {

1575 
C_OnFšish”
 *
f
 = 
Ú_»adabË
;

1576 
Ú_»adabË
 = 0;

1577 
f
->
	`com¶‘e
(-
EAGAIN
);

1580 
li¡
<
CÚ‹xt
*> 
ls
;

1581 
ls
.
	`sw­
(
wa™fÜ_»cov”
);

1582 
	`fšish_cÚ‹xts
(
cù
, 
ls
, -
ESHUTDOWN
);

1584 
¡d
::
m­
<
ušt64_t
, std::
li¡
<
CÚ‹xt
*> >::
™”©Ü
 
i
;

1585 
i
 = 
wa™fÜ_§ã
.
	`begš
(); i !ğwa™fÜ_§ã.
	`’d
(); ++i) {

1586 
	`fšish_cÚ‹xts
(
cù
, 
i
->
£cÚd
, -
EAGAIN
);

1588 
wa™fÜ_§ã
.
	`ş—r
();

1589 
	}
}

	@osdc/Journaler.h

57 #iâdeà
CEPH_JOURNALER_H


58 
	#CEPH_JOURNALER_H


	)

60 
	~<li¡
>

61 
	~<m­
>

63 
	~"Objeù”.h
"

64 
	~"F”.h
"

66 
	~"commÚ/Tim”.h
"

67 
	~"commÚ/ThrÙe.h
"

69 
şass
 
	gC•hCÚ‹xt
;

70 
şass
 
	gCÚ‹xt
;

71 
şass
 
	gP”fCouÁ”s
;

72 
şass
 
	gFšish”
;

73 
şass
 
	gC_OnFšish”
;

75 
__u8
 
	t¡»am_fÜm©_t
;

78 
	eSŒ—mFÜm©
 {

79 
	mJOURNAL_FORMAT_LEGACY
 = 0,

80 
	mJOURNAL_FORMAT_RESILIENT
 = 1,

82 
	mJOURNAL_FORMAT_COUNT


86 
	#JOURNAL_FORMAT_MAX
 (
JOURNAL_FORMAT_COUNT
 - 1)

	)

89 
	#JOURNAL_ENVELOPE_LEGACY
 ((
ušt32_t
))

	)

93 
	#JOURNAL_ENVELOPE_RESILIENT
 ((
ušt32_t
è+ (
ušt64_t
) + \

94 (
ušt64_t
))

	)

104 şas 
	cJouº®SŒ—m


106 
¡»am_fÜm©_t
 
	mfÜm©
;

108 
	mpublic
:

109 
	$Jouº®SŒ—m
(
¡»am_fÜm©_t
 
fÜm©_
è: 
	$fÜm©
(
fÜm©_
) {}

111 
	$£t_fÜm©
(
¡»am_fÜm©_t
 
fÜm©_
è{
fÜm©
 = fÜm©_;
	}
}

113 
boŞ
 
	$»adabË
(
bufã¾i¡
 &
bl
, 
ušt64_t
 *
Ãed
) const;

114 
size_t
 
	`»ad
(
bufã¾i¡
 &
äom
, bufã¾i¡ *
to
, 
ušt64_t
 *
¡¬t_±r
);

115 
size_t
 
	`wr™e
(
bufã¾i¡
 &
’Œy
, bufã¾i¡ *
to
, 
ušt64_t
 cÚ¡ &
¡¬t_±r
);

116 
size_t
 
	$g‘_’v–İe_size
() const {

117 ià(
fÜm©
 >ğ
JOURNAL_FORMAT_RESILIENT
) {

118  
JOURNAL_ENVELOPE_RESILIENT
;

120  
JOURNAL_ENVELOPE_LEGACY
;

122 
	}
}

126 cÚ¡ 
ušt64_t
 
	g£Áš–
 = 0x3141592653589793;

130 şas 
	cJouº®”
 {

131 
	mpublic
:

133 şas 
	cH—d”
 {

134 
public
:

135 
ušt64_t
 
Œimmed_pos
;

136 
ušt64_t
 
	mexpœe_pos
;

137 
ušt64_t
 
	munu£d_f›ld
;

138 
ušt64_t
 
	mwr™e_pos
;

139 
¡ršg
 
	mmagic
;

140 
fe_Ïyout_t
 
	mÏyout
;

142 
¡»am_fÜm©_t
 
	m¡»am_fÜm©
;

145 
H—d”
(cÚ¡ *
m
="") :

146 
Œimmed_pos
(0), 
expœe_pos
(0), 
unu£d_f›ld
(0), 
wr™e_pos
(0), 
magic
(
m
),

147 
¡»am_fÜm©
(-1) {

150 
’code
(
bufã¾i¡
 &
bl
) const {

151 
ENCODE_START
(2, 2, 
bl
);

152 
’code
(
magic
, 
bl
);

153 
’code
(
Œimmed_pos
, 
bl
);

154 
’code
(
expœe_pos
, 
bl
);

155 
’code
(
unu£d_f›ld
, 
bl
);

156 
’code
(
wr™e_pos
, 
bl
);

157 
’code
(
Ïyout
, 
bl
, 0);

158 
’code
(
¡»am_fÜm©
, 
bl
);

159 
ENCODE_FINISH
(
bl
);

161 
decode
(
bufã¾i¡
::
™”©Ü
 &
bl
) {

162 
DECODE_START_LEGACY_COMPAT_LEN
(2, 2, 2, 
bl
);

163 
decode
(
magic
, 
bl
);

164 
decode
(
Œimmed_pos
, 
bl
);

165 
decode
(
expœe_pos
, 
bl
);

166 
decode
(
unu£d_f›ld
, 
bl
);

167 
decode
(
wr™e_pos
, 
bl
);

168 
decode
(
Ïyout
, 
bl
);

169 ià(
	m¡ruù_v
 > 1) {

170 
decode
(
¡»am_fÜm©
, 
bl
);

172 
	m¡»am_fÜm©
 = 
JOURNAL_FORMAT_LEGACY
;

174 
DECODE_FINISH
(
bl
);

177 
dump
(
FÜm©‹r
 *
f
) const {

178 
	mf
->
İ’_objeù_£ùiÚ
("journal_header");

180 
	mf
->
dump_¡ršg
("magic", 
magic
);

181 
	mf
->
dump_unsigÃd
("wr™e_pos", 
wr™e_pos
);

182 
	mf
->
dump_unsigÃd
("expœe_pos", 
expœe_pos
);

183 
	mf
->
dump_unsigÃd
("Œimmed_pos", 
Œimmed_pos
);

184 
	mf
->
dump_unsigÃd
("¡»am_fÜm©", 
¡»am_fÜm©
);

185 
	mf
->
dump_objeù
("Ïyout", 
Ïyout
);

187 
	mf
->
şo£_£ùiÚ
();

190 
g’”©e_‹¡_š¡ªûs
(
li¡
<
H—d”
*> &
ls
)

192 
	mls
.
push_back
(
Ãw
 
H—d”
());

194 
	mls
.
push_back
(
Ãw
 
H—d”
());

195 
	mls
.
back
()->
	mŒimmed_pos
 = 1;

196 
	mls
.
back
()->
	mexpœe_pos
 = 2;

197 
	mls
.
back
()->
	munu£d_f›ld
 = 3;

198 
	mls
.
back
()->
	mwr™e_pos
 = 4;

199 
	mls
.
back
()->
	mmagic
 = "magique";

201 
	mls
.
push_back
(
Ãw
 
H—d”
());

202 
	mls
.
back
()->
	m¡»am_fÜm©
 = 
JOURNAL_FORMAT_RESILIENT
;

205 
	$WRITE_CLASS_ENCODER
(
H—d”
)

207 
ušt32_t
 
	$g‘_¡»am_fÜm©
() const {

208  
¡»am_fÜm©
;

209 
	}
}

211 
H—d”
 
	gÏ¡_comm™‹d
;

213 
	g´iv©e
:

215 
C•hCÚ‹xt
 *
cù
;

216 
	g¡d
::
mu‹x
 
lock
;

217 cÚ¡ 
	g¡d
::
¡ršg
 
Çme
;

218 
	g¡d
::
	tlock_gu¬d
<
	t¡d
::
	tmu‹x
>†ock_guard;

219 
	g¡d
::
	tunique_lock
<
	t¡d
::
	tmu‹x
> unique_lock;

220 
Fšish”
 *
	gfšish”
;

221 
H—d”
 
	gÏ¡_wr™‹n
;

222 
šod’o_t
 
	gšo
;

223 
št64_t
 
	gpg_poŞ
;

224 
boŞ
 
	g»adÚly
;

225 
fe_Ïyout_t
 
	gÏyout
;

226 
ušt32_t
 
	g¡»am_fÜm©
;

227 
Jouº®SŒ—m
 
	gjouº®_¡»am
;

229 cÚ¡ *
	gmagic
;

230 
Objeù”
 *
	gobjeù”
;

231 
F”
 
	gf”
;

233 
P”fCouÁ”s
 *
	glogg”
;

234 
	glogg”_key_Ït
;

236 
şass
 
	gC_D–ayFlush
;

237 
C_D–ayFlush
 *
	gd–ay_æush_ev’t
;

241 
	$_do_d–ayed_æush
()

243 
	`as£¹
(
d–ay_æush_ev’t
 !ğ
NULL
);

244 
lock_gu¬d
 
	`l
(
lock
);

245 
d–ay_æush_ev’t
 = 
NULL
;

246 
	`_do_æush
();

247 
	}
}

250 cÚ¡ 
	gSTATE_UNDEF
 = 0;

251 cÚ¡ 
	gSTATE_READHEAD
 = 1;

252 cÚ¡ 
	gSTATE_PROBING
 = 2;

253 cÚ¡ 
	gSTATE_ACTIVE
 = 3;

254 cÚ¡ 
	gSTATE_REREADHEAD
 = 4;

255 cÚ¡ 
	gSTATE_REPROBING
 = 5;

256 cÚ¡ 
	gSTATE_STOPPING
 = 6;

258 
	g¡©e
;

259 
	g”rÜ
;

261 
_wr™e_h—d
(
CÚ‹xt
 *
Úcomm™
=
NULL
);

262 
_wa™_fÜ_æush
(
CÚ‹xt
 *
Ú§ã
);

263 
_Œim
();

266 
	gûph
::
»®_time
 
Ï¡_wrÙe_h—d
;

267 
_fšish_wr™e_h—d
(
r
, 
H—d”
 &
wrÙe
, 
C_OnFšish”
 *
Úcomm™
);

268 
şass
 
	gC_Wr™eH—d
;

269 
ä›nd
 
şass
 
	gC_Wr™eH—d
;

271 
_»»ad_h—d
(
CÚ‹xt
 *
Úfšish
);

272 
_£t_Ïyout
(
fe_Ïyout_t
 cÚ¡ *
l
);

273 
	gli¡
<
	gCÚ‹xt
*> 
	gwa™fÜ_»cov”
;

274 
_»ad_h—d
(
CÚ‹xt
 *
Ú_fšish
, 
bufã¾i¡
 *
bl
);

275 
_fšish_»ad_h—d
(
r
, 
bufã¾i¡
& 
bl
);

276 
_fšish_»»ad_h—d
(
r
, 
bufã¾i¡
& 
bl
, 
CÚ‹xt
 *
fšish
);

277 
_´obe
(
CÚ‹xt
 *
fšish
, 
ušt64_t
 *
’d
);

278 
_fšish_´obe_’d
(
r
, 
ušt64_t
 
’d
);

279 
_»´obe
(
C_OnFšish”
 *
Úfšish
);

280 
_fšish_»´obe
(
r
, 
ušt64_t
 
’d
, 
C_OnFšish”
 *
Úfšish
);

281 
_fšish_»»ad_h—d_ªd_´obe
(
r
, 
C_OnFšish”
 *
Úfšish
);

282 
şass
 
	gC_R—dH—d
;

283 
ä›nd
 
şass
 
	gC_R—dH—d
;

284 
şass
 
	gC_ProbeEnd
;

285 
ä›nd
 
şass
 
	gC_ProbeEnd
;

286 
şass
 
	gC_R”—dH—d
;

287 
ä›nd
 
şass
 
	gC_R”—dH—d
;

288 
şass
 
	gC_ReProbe
;

289 
ä›nd
 
şass
 
	gC_ReProbe
;

290 
şass
 
	gC_R”—dH—dProbe
;

291 
ä›nd
 
şass
 
	gC_R”—dH—dProbe
;

294 
ušt64_t
 
	g´ez”ošg_pos
;

295 
ušt64_t
 
	g´ez”o_pos
;

297 
ušt64_t
 
	gwr™e_pos
;

299 
ušt64_t
 
	gæush_pos
;

301 
ušt64_t
 
	g§ã_pos
;

303 
ušt64_t
 
	gÃxt_§ã_pos
;

307 
bufã¾i¡
 
	gwr™e_buf
;

311 
ThrÙe
 
	gwr™e_buf_thrÙe
;

313 
ušt64_t
 
	gwa™šg_fÜ_z”o_pos
;

314 
	gš‹rv®_£t
<
	gušt64_t
> 
	g³ndšg_z”o
;

315 
	gli¡
<
	gCÚ‹xt
*> 
	gwa™fÜ_´ez”o
;

317 
	g¡d
::
m­
<
ušt64_t
, 
	gušt64_t
> 
	g³ndšg_§ã
;

319 
	g¡d
::
m­
<
ušt64_t
, std::
li¡
<
CÚ‹xt
*> > 
wa™fÜ_§ã
;

321 
_æush
(
C_OnFšish”
 *
Ú§ã
);

322 
_do_æush
(
amouÁ
=0);

323 
_fšish_æush
(
r
, 
ušt64_t
 
¡¬t
, 
ûph
::
»®_time
 
¡amp
);

324 
şass
 
	gC_Flush
;

325 
ä›nd
 
şass
 
	gC_Flush
;

328 
ušt64_t
 
	g»ad_pos
;

329 
ušt64_t
 
	g»que¡ed_pos
;

330 
ušt64_t
 
	g»ûived_pos
;

332 
bufã¾i¡
 
	g»ad_buf
;

334 
	gm­
<
	gušt64_t
,
	gbufã¾i¡
> 
	g´eãtch_buf
;

336 
ušt64_t
 
	gãtch_Ën
;

337 
ušt64_t
 
	g‹mp_ãtch_Ën
;

340 
C_OnFšish”
 *
	gÚ_»adabË
;

341 
C_OnFšish”
 *
	gÚ_wr™e_”rÜ
;

342 
boŞ
 
	gÿÎed_wr™e_”rÜ
;

345 
_fšish_»ad
(
r
, 
ušt64_t
 
off£t
, ušt64_ˆ
Ëngth
, 
bufã¾i¡
 &
bl
);

346 
_fšish_»Œy_»ad
(
r
);

347 
_assim©e_´eãtch
();

348 
_issue_»ad
(
ušt64_t
 
Ën
);

349 
_´eãtch
();

350 
şass
 
	gC_R—d
;

351 
ä›nd
 
şass
 
	gC_R—d
;

352 
şass
 
	gC_R‘ryR—d
;

353 
ä›nd
 
şass
 
	gC_R‘ryR—d
;

356 
ušt64_t
 
	gexpœe_pos
;

357 
ušt64_t
 
	gŒimmšg_pos
;

358 
ušt64_t
 
	gŒimmed_pos
;

360 
boŞ
 
	g»adabË
;

362 
_fšish_Œim
(
r
, 
ušt64_t
 
to
);

363 
şass
 
	gC_Trim
;

364 
ä›nd
 
şass
 
	gC_Trim
;

366 
_issue_´ez”o
();

367 
_fšish_´ez”o
(
r
, 
ušt64_t
 
äom
, ušt64_ˆ
Ën
);

368 
ä›nd
 
	gC_Jouº®”_P»z”o
;

371 
	$š™_h—d”s
(
H—d”
& 
h
) {

372 
	`as£¹
(
»adÚly
 ||

373 
¡©e
 =ğ
STATE_READHEAD
 ||

374 
¡©e
 =ğ
STATE_REREADHEAD
);

375 
Ï¡_wr™‹n
 = 
Ï¡_comm™‹d
 = 
h
;

376 
	}
}

385 
hªdË_wr™e_”rÜ
(
r
);

387 
boŞ
 
_is_»adabË
();

389 
_fšish_”a£
(
d©a_»suÉ
, 
C_OnFšish”
 *
com¶‘iÚ
);

390 
şass
 
	gC_E¿£Fšish
;

391 
ä›nd
 
şass
 
	gC_E¿£Fšish
;

393 
C_OnFšish”
 *
w¿p_fšish”
(
CÚ‹xt
 *
c
);

395 
ušt32_t
 
	gwr™e_iohšt
;

398 
	gpublic
:

399 
	$Jouº®”
(cÚ¡ 
¡d
::
¡ršg
 &
Çme_
, 
šod’o_t
 
šo_
, 
št64_t
 
poŞ
,

400 cÚ¡ *
mag
, 
Objeù”
 *
obj
, 
P”fCouÁ”s
 *
l
, 
lkey
, 
Fšish”
 *
f
) :

401 
	`Ï¡_comm™‹d
(
mag
),

402 
	`cù
(
obj
->
cù
), 
	`Çme
(
Çme_
), 
	`fšish”
(
f
), 
	`Ï¡_wr™‹n
(
mag
),

403 
	`šo
(
šo_
), 
	`pg_poŞ
(
poŞ
), 
	`»adÚly
(
Œue
),

404 
	`¡»am_fÜm©
(-1), 
	`jouº®_¡»am
(-1),

405 
	`magic
(
mag
),

406 
	`objeù”
(
obj
), 
	`f”
(
objeù”
, 
f
), 
	`logg”
(
l
), 
	`logg”_key_Ït
(
lkey
),

407 
	`d–ay_æush_ev’t
(0),

408 
	`¡©e
(
STATE_UNDEF
), 
	`”rÜ
(0),

409 
	`´ez”ošg_pos
(0), 
	`´ez”o_pos
(0), 
	`wr™e_pos
(0), 
	`æush_pos
(0),

410 
	`§ã_pos
(0), 
	`Ãxt_§ã_pos
(0),

411 
	`wr™e_buf_thrÙe
(
cù
, "wr™e_buf_thrÙe", 
UINT_MAX
 - (UINT_MAX >> 3)),

412 
	`wa™šg_fÜ_z”o_pos
(0),

413 
	`»ad_pos
(0), 
	`»que¡ed_pos
(0), 
	`»ûived_pos
(0),

414 
	`ãtch_Ën
(0), 
	`‹mp_ãtch_Ën
(0),

415 
	`Ú_»adabË
(0), 
	`Ú_wr™e_”rÜ
(
NULL
), 
	`ÿÎed_wr™e_”rÜ
(
çl£
),

416 
	`expœe_pos
(0), 
	`Œimmšg_pos
(0), 
	`Œimmed_pos
(0), 
	`»adabË
(
çl£
),

417 
	$wr™e_iohšt
(0)

419 
	}
}

427 
	$»£t
() {

428 
lock_gu¬d
 
	`l
(
lock
);

429 
	`as£¹
(
¡©e
 =ğ
STATE_ACTIVE
);

431 
»adÚly
 = 
Œue
;

432 
d–ay_æush_ev’t
 = 
NULL
;

433 
¡©e
 = 
STATE_UNDEF
;

434 
”rÜ
 = 0;

435 
´ez”ošg_pos
 = 0;

436 
´ez”o_pos
 = 0;

437 
wr™e_pos
 = 0;

438 
æush_pos
 = 0;

439 
§ã_pos
 = 0;

440 
Ãxt_§ã_pos
 = 0;

441 
»ad_pos
 = 0;

442 
»que¡ed_pos
 = 0;

443 
»ûived_pos
 = 0;

444 
ãtch_Ën
 = 0;

445 
	`as£¹
(!
Ú_»adabË
);

446 
expœe_pos
 = 0;

447 
Œimmšg_pos
 = 0;

448 
Œimmed_pos
 = 0;

449 
wa™šg_fÜ_z”o_pos
 = 0;

450 
	}
}

454 
”a£
(
CÚ‹xt
 *
com¶‘iÚ
);

455 
ü—‹
(
fe_Ïyout_t
 *
Ïyout
, 
¡»am_fÜm©_t
 cÚ¡ 
sf
);

456 
»cov”
(
CÚ‹xt
 *
Úfšish
);

457 
»»ad_h—d
(
CÚ‹xt
 *
Úfšish
);

458 
»»ad_h—d_ªd_´obe
(
CÚ‹xt
 *
Úfšish
);

459 
wr™e_h—d
(
CÚ‹xt
 *
Ú§ve
=0);

460 
wa™_fÜ_æush
(
CÚ‹xt
 *
Ú§ã
 = 0);

461 
æush
(
CÚ‹xt
 *
Ú§ã
 = 0);

462 
wa™_fÜ_»adabË
(
CÚ‹xt
 *
Úfšish
);

463 
boŞ
 
	$have_wa™”
() const;

464 
	`wa™_fÜ_´ez”o
(
CÚ‹xt
 *
Úfšish
);

468 
	`£t_Ïyout
(
fe_Ïyout_t
 cÚ¡ *
l
);

469 
	`£t_»adÚly
();

470 
	`£t_wr™—bË
();

471 
	$£t_wr™e_pos
(
ušt64_t
 
p
) {

472 
lock_gu¬d
 
	`l
(
lock
);

473 
´ez”ošg_pos
 = 
´ez”o_pos
 = 
wr™e_pos
 = 
æush_pos
 = 
§ã_pos
 = 
Ãxt_§ã_pos
 = 
p
;

474 
	}
}

475 
	$£t_»ad_pos
(
ušt64_t
 
p
) {

476 
lock_gu¬d
 
	`l
(
lock
);

478 
	`as£¹
(
»que¡ed_pos
 =ğ
»ûived_pos
);

479 
»ad_pos
 = 
»que¡ed_pos
 = 
»ûived_pos
 = 
p
;

480 
»ad_buf
.
	`ş—r
();

481 
	}
}

482 
ušt64_t
 
­³nd_’Œy
(
bufã¾i¡
& 
bl
);

483 
	$£t_expœe_pos
(
ušt64_t
 
•
) {

484 
lock_gu¬d
 
	`l
(
lock
);

485 
expœe_pos
 = 
•
;

486 
	}
}

487 
	$£t_Œimmed_pos
(
ušt64_t
 
p
) {

488 
lock_gu¬d
 
	`l
(
lock
);

489 
Œimmšg_pos
 = 
Œimmed_pos
 = 
p
;

490 
	}
}

492 
boŞ
 
_wr™e_h—d_Ãeded
();

493 
boŞ
 
	$wr™e_h—d_Ãeded
() {

494 
lock_gu¬d
 
	`l
(
lock
);

495  
	`_wr™e_h—d_Ãeded
();

496 
	}
}

499 
Œim
();

500 
	$Œim_
() {

501 
lock_gu¬d
 
	`l
(
lock
);

503 
	`as£¹
(!
»adÚly
);

504 
	`_issue_´ez”o
();

505 
	}
}

507 
£t_wr™e_”rÜ_hªdËr
(
CÚ‹xt
 *
c
);

509 
	$£t_wr™e_iohšt
(
ušt32_t
 
iohšt_æags
) {

510 
wr™e_iohšt
 = 
iohšt_æags
;

511 
	}
}

516 
shutdown
();

517 
	gpublic
:

522 
ušt64_t
 
	$g‘_Ïyout_³riod
() const {

523  
Ïyout
.
	`g‘_³riod
();

524 
	}
}

525 
	gfe_Ïyout_t
& 
	$g‘_Ïyout
(è{  
Ïyout
; 
	}
}

526 
boŞ
 
	$is_aùive
(è{  
¡©e
 =ğ
STATE_ACTIVE
; 
	}
}

527 
boŞ
 
	$is_¡İpšg
(è{  
¡©e
 =ğ
STATE_STOPPING
; 
	}
}

528 
	$g‘_”rÜ
(è{  
”rÜ
; 
	}
}

529 
boŞ
 
	$is_»adÚly
(è{  
»adÚly
; 
	}
}

530 
boŞ
 
is_»adabË
();

531 
boŞ
 
Œy_»ad_’Œy
(
bufã¾i¡
& 
bl
);

532 
ušt64_t
 
	$g‘_wr™e_pos
(ècÚ¡ {  
wr™e_pos
; 
	}
}

533 
ušt64_t
 
	$g‘_wr™e_§ã_pos
(ècÚ¡ {  
§ã_pos
; 
	}
}

534 
ušt64_t
 
	$g‘_»ad_pos
(ècÚ¡ {  
»ad_pos
; 
	}
}

535 
ušt64_t
 
	$g‘_expœe_pos
(ècÚ¡ {  
expœe_pos
; 
	}
}

536 
ušt64_t
 
	$g‘_Œimmed_pos
(ècÚ¡ {  
Œimmed_pos
; 
	}
}

538 
	$WRITE_CLASS_ENCODER
(
Jouº®”
::
H—d”
)

	@osdc/ObjectCacher.cc

4 
	~<lim™s.h
>

6 
	~"msg/Mes£ng”.h
"

7 
	~"ObjeùCach”.h
"

8 
	~"Wr™ebackHªdËr.h
"

9 
	~"commÚ/”ºo.h
"

10 
	~"commÚ/³rf_couÁ”s.h
"

12 
	~"šşude/as£¹.h
"

14 
	#MAX_FLUSH_UNDER_LOCK
 20

15 
	#BUFFER_MEMORY_WEIGHT
 12

16 

	)

17 
usšg
 
	g¡d
::
chrÚo
::
£cÚds
;

25 
	#dout_subsys
 
ûph_subsys_objeùÿch”


	)

26 #undeà
dout_´efix


27 
	#dout_´efix
 *
_dout
 << "objeùÿch”.objeù(" << 
oid
 << "è"

	)

31 şas 
	cObjeùCach”
::
C_R—dFšish
 : 
public
 
CÚ‹xt
 {

32 
ObjeùCach”
 *
oc
;

33 
št64_t
 
	mpoŞid
;

34 
sobjeù_t
 
	moid
;

35 
loff_t
 
	m¡¬t
;

36 
ušt64_t
 
	mËngth
;

37 
	mxli¡
<
	mC_R—dFšish
*>::
™em
 
£t_™em
;

38 
boŞ
 
	mŒu¡_’ÛÁ
;

39 
ûph_tid_t
 
	mtid
;

40 
	mZT¿ûr
::
T¿û
 
Œaû
;

42 
	mpublic
:

43 
bufã¾i¡
 
bl
;

44 
	$C_R—dFšish
(
ObjeùCach”
 *
c
, 
Objeù
 *
ob
, 
ûph_tid_t
 
t
, 
loff_t
 
s
,

45 
ušt64_t
 
l
, cÚ¡ 
ZT¿ûr
::
T¿û
 &
Œaû
) :

46 
	`oc
(
c
), 
	`poŞid
(
ob
->
Şoc
.
poŞ
), 
	`oid
(ob->
	`g‘_soid
()), 
	`¡¬t
(
s
), 
	`Ëngth
(
l
),

47 
	`£t_™em
(
this
), 
	`Œu¡_’ÛÁ
(
Œue
),

48 
	`tid
(
t
), 
	$Œaû
(
Œaû
) {

49 
ob
->
»ads
.
	`push_back
(&
£t_™em
);

52 
	$fšish
(
r
è
ov”ride
 {

53 
oc
->
	`bh_»ad_fšish
(
poŞid
, 
oid
, 
tid
, 
¡¬t
, 
Ëngth
, 
bl
, 
r
, 
Œu¡_’ÛÁ
);

54 
Œaû
.
	`ev’t
("finish");

57 ià(
£t_™em
.
	`is_Ú_li¡
())

58 
£t_™em
.
	`»move_my£lf
();

59 
	}
}

61 
	$di¡ru¡_’ÛÁ
() {

62 
Œu¡_’ÛÁ
 = 
çl£
;

63 
	}
}

66 şas 
	cObjeùCach”
::
C_R‘ryR—d
 : 
public
 
CÚ‹xt
 {

67 
ObjeùCach”
 *
oc
;

68 
OSDR—d
 *
	mrd
;

69 
ObjeùS‘
 *
	mo£t
;

70 
CÚ‹xt
 *
	mÚfšish
;

71 
	mZT¿ûr
::
T¿û
 
Œaû
;

72 
	mpublic
:

73 
	$C_R‘ryR—d
(
ObjeùCach”
 *
_oc
, 
OSDR—d
 *
r
, 
ObjeùS‘
 *
os
, 
CÚ‹xt
 *
c
,

74 cÚ¡ 
ZT¿ûr
::
T¿û
 &
Œaû
)

75 : 
	`oc
(
_oc
), 
	`rd
(
r
), 
	`o£t
(
os
), 
	`Úfšish
(
c
), 
	$Œaû
(
Œaû
) {

77 
	$fšish
(
r
è
ov”ride
 {

78 ià(
r
 >= 0) {

79 
r
 = 
oc
->
	`_»adx
(
rd
, 
o£t
, 
Úfšish
, 
çl£
, &
Œaû
);

82 ià(
r
 == 0) {

87 
Œaû
.
	`ev’t
("finish");

88 ià(
Úfšish
) {

89 
Úfšish
->
	`com¶‘e
(
r
);

91 
	}
}

94 
	gObjeùCach”
::
BufãrH—d
 *
ObjeùCach”
::
Objeù
::
	$¥l™
(
BufãrH—d
 *
Ëá
,

95 
loff_t
 
off
)

97 
	`as£¹
(
oc
->
lock
.
	`is_locked
());

98 
	`ldout
(
oc
->
cù
, 20è<< "¥l™ " << *
Ëá
 << "‡ˆ" << 
off
 << 
d’dl
;

101 
ObjeùCach”
::
BufãrH—d
 *
right
 = 
Ãw
 
	`BufãrH—d
(
this
);

104 
right
->
	`£t_dÚŠ“d
(
Ëá
->
	`g‘_dÚŠ“d
());

105 
right
->
	`£t_noÿche
(
Ëá
->
	`g‘_noÿche
());

107 
right
->
Ï¡_wr™e_tid
 = 
Ëá
->last_write_tid;

108 
right
->
Ï¡_»ad_tid
 = 
Ëá
->last_read_tid;

109 
right
->
	`£t_¡©e
(
Ëá
->
	`g‘_¡©e
());

110 
right
->
¢­c
 = 
Ëá
->snapc;

111 
right
->
	`£t_jouº®_tid
(
Ëá
->
jouº®_tid
);

113 
loff_t
 
ÃwËáËn
 = 
off
 - 
Ëá
->
	`¡¬t
();

114 
right
->
	`£t_¡¬t
(
off
);

115 
right
->
	`£t_Ëngth
(
Ëá
->
	`Ëngth
(è- 
ÃwËáËn
);

118 
oc
->
	`bh_¡©_sub
(
Ëá
);

119 
Ëá
->
	`£t_Ëngth
(
ÃwËáËn
);

120 
oc
->
	`bh_¡©_add
(
Ëá
);

123 
oc
->
	`bh_add
(
this
, 
right
);

126 
bufã¾i¡
 
bl
;

127 
bl
.
	`şaim
(
Ëá
->bl);

128 ià(
bl
.
	`Ëngth
()) {

129 
	`as£¹
(
bl
.
	`Ëngth
(è=ğ(
Ëá
->Ëngth(è+ 
right
->length()));

130 
right
->
bl
.
	`sub¡r_of
(bl, 
Ëá
->
	`Ëngth
(),„ight->length());

131 
Ëá
->
bl
.
	`sub¡r_of
(bl, 0,†eá->
	`Ëngth
());

135 ià(!
Ëá
->
wa™fÜ_»ad
.
	`em±y
()) {

136 
m­
<
loff_t
, 
li¡
<
CÚ‹xt
*> >::
™”©Ü
 
¡¬t_»move


137 ğ
Ëá
->
wa™fÜ_»ad
.
	`begš
();

138 
¡¬t_»move
 !ğ
Ëá
->
wa™fÜ_»ad
.
	`’d
() &&

139 
¡¬t_»move
->
fœ¡
 < 
right
->
	`¡¬t
())

140 ++
¡¬t_»move
;

141 
m­
<
loff_t
, 
li¡
<
CÚ‹xt
*> >::
™”©Ü
 
p
 = 
¡¬t_»move
;

142 
p
 !ğ
Ëá
->
wa™fÜ_»ad
.
	`’d
(); ++p) {

143 
	`ldout
(
oc
->
cù
, 20è<< "¥l™ movšg wa™” © by‹ " << 
p
->
fœ¡


144 << "Ørighˆbh" << 
d’dl
;

145 
right
->
wa™fÜ_»ad
[
p
->
fœ¡
].
	`sw­
Ğp->
£cÚd
 );

146 
	`as£¹
(
p
->
£cÚd
.
	`em±y
());

148 
Ëá
->
wa™fÜ_»ad
.
	`”a£
(
¡¬t_»move
,†eá->wa™fÜ_»ad.
	`’d
());

151 
	`ldout
(
oc
->
cù
, 20è<< "¥l™†eá i " << *
Ëá
 << 
d’dl
;

152 
	`ldout
(
oc
->
cù
, 20è<< "¥l™„ighˆi " << *
right
 << 
d’dl
;

153  
right
;

154 
	}
}

157 
	gObjeùCach”
::
Objeù
::
	$m”ge_Ëá
(
BufãrH—d
 *
Ëá
, BufãrH—d *
right
)

159 
	`as£¹
(
oc
->
lock
.
	`is_locked
());

161 
	`ldout
(
oc
->
cù
, 10è<< "m”ge_Ëá " << *
Ëá
 << " + " << *
right
 << 
d’dl
;

162 ià(
Ëá
->
	`g‘_jouº®_tid
() == 0) {

163 
Ëá
->
	`£t_jouº®_tid
(
right
->
	`g‘_jouº®_tid
());

165 
right
->
	`£t_jouº®_tid
(0);

167 
oc
->
	`bh_»move
(
this
, 
right
);

168 
oc
->
	`bh_¡©_sub
(
Ëá
);

169 
Ëá
->
	`£t_Ëngth
Öeá->
	`Ëngth
(è+ 
right
->length());

170 
oc
->
	`bh_¡©_add
(
Ëá
);

173 
Ëá
->
bl
.
	`şaim_­³nd
(
right
->bl);

177 
Ëá
->
Ï¡_wr™e_tid
 = 
¡d
::
	`max
ĞËá->Ï¡_wr™e_tid, 
right
->last_write_tid );

178 
Ëá
->
Ï¡_wr™e
 = 
¡d
::
	`max
ĞËá->Ï¡_wr™e, 
right
->last_write );

180 
Ëá
->
	`£t_dÚŠ“d
(
right
->
	`g‘_dÚŠ“d
(è?†eá->g‘_dÚŠ“d(è: 
çl£
);

181 
Ëá
->
	`£t_noÿche
(
right
->
	`g‘_noÿche
(è?†eá->g‘_noÿche(è: 
çl£
);

184 
m­
<
loff_t
, 
li¡
<
CÚ‹xt
*> >::
™”©Ü
 
p
 = 
right
->
wa™fÜ_»ad
.
	`begš
();

185 
p
 !ğ
right
->
wa™fÜ_»ad
.
	`’d
();

186 ++
p
)

187 
Ëá
->
wa™fÜ_»ad
[
p
->
fœ¡
].
	`¥liû
Öeá->wa™fÜ_»ad[p->fœ¡].
	`begš
(),

188 
p
->
£cÚd
 );

191 
d–‘e
 
right
;

193 
	`ldout
(
oc
->
cù
, 10è<< "m”ge_Ëá„esuÉ " << *
Ëá
 << 
d’dl
;

194 
	}
}

196 
boŞ
 
	gObjeùCach”
::
Objeù
::
	$ÿn_m”ge_bh
(
BufãrH—d
 *
Ëá
, BufãrH—d *
right
)

198 ià(
Ëá
->
	`’d
(è!ğ
right
->
	`¡¬t
() ||

199 
Ëá
->
	`g‘_¡©e
(è!ğ
right
->get_state() ||

200 !
Ëá
->
	`ÿn_m”ge_jouº®
(
right
))

201  
çl£
;

202 ià(
Ëá
->
	`is_tx
(è&&†eá->
Ï¡_wr™e_tid
 !ğ
right
->last_write_tid)

203  
çl£
;

204  
Œue
;

205 
	}
}

207 
	gObjeùCach”
::
Objeù
::
	$Œy_m”ge_bh
(
BufãrH—d
 *
bh
)

209 
	`as£¹
(
oc
->
lock
.
	`is_locked
());

210 
	`ldout
(
oc
->
cù
, 10è<< "Œy_m”ge_bh " << *
bh
 << 
d’dl
;

213 ià(
bh
->
	`is_rx
())

217 
m­
<
loff_t
,
BufãrH—d
*>::
™”©Ü
 
p
 = 
d©a
.
	`fšd
(
bh
->
	`¡¬t
());

218 
	`as£¹
(
p
->
£cÚd
 =ğ
bh
);

219 ià(
p
 !ğ
d©a
.
	`begš
()) {

220 --
p
;

221 ià(
	`ÿn_m”ge_bh
(
p
->
£cÚd
, 
bh
)) {

222 
	`m”ge_Ëá
(
p
->
£cÚd
, 
bh
);

223 
bh
 = 
p
->
£cÚd
;

225 ++
p
;

229 
	`as£¹
(
p
->
£cÚd
 =ğ
bh
);

230 ++
p
;

231 ià(
p
 !ğ
d©a
.
	`’d
(è&& 
	`ÿn_m”ge_bh
(
bh
,…->
£cÚd
))

232 
	`m”ge_Ëá
(
bh
, 
p
->
£cÚd
);

233 
	}
}

238 
boŞ
 
	gObjeùCach”
::
Objeù
::
	$is_ÿched
(
loff_t
 
cur
,†off_ˆ
Ëá
) const

240 
	`as£¹
(
oc
->
lock
.
	`is_locked
());

241 
m­
<
loff_t
, 
BufãrH—d
*>::
cÚ¡_™”©Ü
 
p
 = 
	`d©a_low”_bound
(
cur
);

242 
Ëá
 > 0) {

243 ià(
p
 =ğ
d©a
.
	`’d
())

244  
çl£
;

246 ià(
p
->
fœ¡
 <ğ
cur
) {

248 
loff_t
 
Ënäomcur
 = 
¡d
::
	`mš
(
p
->
£cÚd
->
	`’d
(è- 
cur
, 
Ëá
);

249 
cur
 +ğ
Ënäomcur
;

250 
Ëá
 -ğ
Ënäomcur
;

251 ++
p
;

253 } ià(
p
->
fœ¡
 > 
cur
) {

255  
çl£
;

257 
	`ûph_abÜt
();

260  
Œue
;

261 
	}
}

266 
boŞ
 
	gObjeùCach”
::
Objeù
::
	$šşude_®l_ÿched_d©a
(
loff_t
 
off
,†off_ˆ
Ën
)

268 
	`as£¹
(
oc
->
lock
.
	`is_locked
());

269 ià(
d©a
.
	`em±y
())

270  
Œue
;

271 
m­
<
loff_t
, 
BufãrH—d
*>::
™”©Ü
 
fœ¡
 = 
d©a
.
	`begš
();

272 
m­
<
loff_t
, 
BufãrH—d
*>::
»v”£_™”©Ü
 
Ï¡
 = 
d©a
.
	`rbegš
();

273 ià(
fœ¡
->
£cÚd
->
	`¡¬t
(è>ğ
off
 && 
Ï¡
->£cÚd->
	`’d
(è<ğ(ofà+ 
Ën
))

274  
Œue
;

276  
çl£
;

277 
	}
}

283 
	gObjeùCach”
::
Objeù
::
m­_»ad
(
ObjeùEx‹Á
 &
ex
,

284 
m­
<
loff_t
, 
BufãrH—d
*>& 
h™s
,

285 
m­
<
loff_t
, 
BufãrH—d
*>& 
missšg
,

286 
m­
<
loff_t
, 
BufãrH—d
*>& 
rx
,

287 
m­
<
loff_t
, 
BufãrH—d
*>& 
”rÜs
)

289 
as£¹
(
oc
->
lock
.
is_locked
());

290 
ldout
(
oc
->
cù
, 10è<< "m­_»ad " << 
	gex
.
	goid
 << " "

291 << 
	gex
.
	goff£t
 << "~" <<ƒx.
	gËngth
 << 
	gd’dl
;

293 
loff_t
 
	gcur
 = 
ex
.
off£t
;

294 
loff_t
 
	gËá
 = 
ex
.
Ëngth
;

296 
	gm­
<
	gloff_t
, 
	gBufãrH—d
*>::
cÚ¡_™”©Ü
 
p
 = 
d©a_low”_bound
(
ex
.
off£t
);

297 
	gËá
 > 0) {

299 ià(
	gp
 =ğ
d©a
.
’d
()) {

301 
BufãrH—d
 *
n
 = 
Ãw
 BufãrH—d(
this
);

302 
	gn
->
£t_¡¬t
(
cur
);

303 
	gn
->
£t_Ëngth
(
Ëá
);

304 
	goc
->
bh_add
(
this
, 
n
);

305 ià(
	gcom¶‘e
) {

306 
	goc
->
m¬k_z”o
(
n
);

307 
	gh™s
[
cur
] = 
n
;

308 
ldout
(
oc
->
cù
, 20è<< "m­_»ad miss+com¶‘e+z”Ø" << 
	gËá
 << "†eá, " << *
	gn
 << 
	gd’dl
;

310 
	gmissšg
[
cur
] = 
n
;

311 
ldout
(
oc
->
cù
, 20è<< "m­_»ad mis " << 
	gËá
 << "†eá, " << *
	gn
 << 
	gd’dl
;

313 
	gcur
 +ğ
Ëá
;

314 
as£¹
(
cur
 =ğ(
loff_t
)
ex
.
off£t
 + (loff_tëx.
Ëngth
);

318 ià(
	gp
->
	gfœ¡
 <ğ
cur
) {

320 
BufãrH—d
 *
e
 = 
p
->
£cÚd
;

322 ià(
	ge
->
is_ş—n
() ||

323 
	ge
->
is_dœty
() ||

324 
	ge
->
is_tx
() ||

325 
	ge
->
is_z”o
()) {

326 
	gh™s
[
cur
] = 
e
;

327 
ldout
(
oc
->
cù
, 20è<< "m­_»ad h™ " << *
	ge
 << 
	gd’dl
;

328 } ià(
	ge
->
is_rx
()) {

329 
	grx
[
cur
] = 
e
;

330 
ldout
(
oc
->
cù
, 20è<< "m­_»ad„x " << *
	ge
 << 
	gd’dl
;

331 } ià(
	ge
->
is_”rÜ
()) {

332 
	g”rÜs
[
cur
] = 
e
;

333 
ldout
(
oc
->
cù
, 20è<< "m­_»adƒ¼Ü " << *
	ge
 << 
	gd’dl
;

335 
ûph_abÜt
();

338 
loff_t
 
	gËnäomcur
 = 
¡d
::
mš
(
e
->
’d
(è- 
cur
, 
Ëá
);

339 
	gcur
 +ğ
Ënäomcur
;

340 
	gËá
 -ğ
Ënäomcur
;

341 ++
	gp
;

344 } ià(
	gp
->
	gfœ¡
 > 
	gcur
) {

346 
loff_t
 
	gÃxt
 = 
p
->
fœ¡
;

347 
BufãrH—d
 *
	gn
 = 
Ãw
 BufãrH—d(
this
);

348 
loff_t
 
	gËn
 = 
¡d
::
mš
(
Ãxt
 - 
cur
, 
Ëá
);

349 
	gn
->
£t_¡¬t
(
cur
);

350 
	gn
->
£t_Ëngth
(
Ën
);

351 
	goc
->
bh_add
(
this
,
n
);

352 ià(
	gcom¶‘e
) {

353 
	goc
->
m¬k_z”o
(
n
);

354 
	gh™s
[
cur
] = 
n
;

355 
ldout
(
oc
->
cù
, 20è<< "m­_»ad g­+com¶‘e+z”Ø" << *
	gn
 << 
	gd’dl
;

357 
	gmissšg
[
cur
] = 
n
;

358 
ldout
(
oc
->
cù
, 20è<< "m­_»ad g­ " << *
	gn
 << 
	gd’dl
;

360 
	gcur
 +ğ
¡d
::
mš
(
Ëá
, 
n
->
Ëngth
());

361 
	gËá
 -ğ
¡d
::
mš
(
Ëá
, 
n
->
Ëngth
());

364 
ûph_abÜt
();

370 
	gObjeùCach”
::
Objeù
::
	$aud™_bufãrs
()

372 
loff_t
 
off£t
 = 0;

373 
m­
<
loff_t
, 
BufãrH—d
*>::
cÚ¡_™”©Ü
 
™
 = 
d©a
.
	`begš
();

374 
™
 !ğ
d©a
.
	`’d
(); ++it) {

375 ià(
™
->
fœ¡
 !ğ™->
£cÚd
->
	`¡¬t
()) {

376 
	`ld”r
(
oc
->
cù
è<< "AUDIT FAILURE: m­…os™iÚ " << 
™
->
fœ¡


378 << *
™
->
£cÚd
 << 
d’dl
;

379 
	`as£¹
(
™
->
fœ¡
 =ğ™->
£cÚd
->
	`¡¬t
());

381 ià(
™
->
fœ¡
 < 
off£t
) {

382 
	`ld”r
(
oc
->
cù
è<< "AUDIT FAILURE: " << 
™
->
fœ¡
 << " " << *™->
£cÚd


383 << " ov”Ïp w™h…»viou bh " << *((--
™
)->
£cÚd
)

384 << 
d’dl
;

385 
	`as£¹
(
™
->
fœ¡
 >ğ
off£t
);

387 
BufãrH—d
 *
bh
 = 
™
->
£cÚd
;

388 
m­
<
loff_t
, 
li¡
<
CÚ‹xt
*> >::
cÚ¡_™”©Ü
 
w_™
;

389 
w_™
 = 
bh
->
wa™fÜ_»ad
.
	`begš
();

390 
w_™
 !ğ
bh
->
wa™fÜ_»ad
.
	`’d
(); ++w_it) {

391 ià(
w_™
->
fœ¡
 < 
bh
->
	`¡¬t
() ||

392 
w_™
->
fœ¡
 >ğ
bh
->
	`¡¬t
(è+ bh->
	`Ëngth
()) {

393 
	`ld”r
(
oc
->
cù
è<< "AUDIT FAILURE: wa™”‡ˆ" << 
w_™
->
fœ¡


394 << " i nÙ w™hš bh " << *
bh
 << 
d’dl
;

395 
	`as£¹
(
w_™
->
fœ¡
 >ğ
bh
->
	`¡¬t
());

396 
	`as£¹
(
w_™
->
fœ¡
 < 
bh
->
	`¡¬t
(è+ bh->
	`Ëngth
());

399 
off£t
 = 
™
->
fœ¡
 + it->
£cÚd
->
	`Ëngth
();

401 
	}
}

410 
	gObjeùCach”
::
BufãrH—d
 *
ObjeùCach”
::
Objeù
::
	$m­_wr™e
(
ObjeùEx‹Á
 &
ex
,

411 
ûph_tid_t
 
tid
)

413 
	`as£¹
(
oc
->
lock
.
	`is_locked
());

414 
BufãrH—d
 *
fš®
 = 0;

416 
	`ldout
(
oc
->
cù
, 10è<< "m­_wr™Ûx " << 
ex
.
oid


417 << " " << 
ex
.
off£t
 << "~" <<ƒx.
Ëngth
 << 
d’dl
;

419 
loff_t
 
cur
 = 
ex
.
off£t
;

420 
loff_t
 
Ëá
 = 
ex
.
Ëngth
;

422 
m­
<
loff_t
, 
BufãrH—d
*>::
cÚ¡_™”©Ü
 
p
 = 
	`d©a_low”_bound
(
ex
.
off£t
);

423 
Ëá
 > 0) {

424 
loff_t
 
max
 = 
Ëá
;

427 ià(
p
 =ğ
d©a
.
	`’d
()) {

428 ià(
fš®
 =ğ
NULL
) {

429 
fš®
 = 
Ãw
 
	`BufãrH—d
(
this
);

430 
	`»¶aû_jouº®_tid
(
fš®
, 
tid
);

431 
fš®
->
	`£t_¡¬t
Ğ
cur
 );

432 
fš®
->
	`£t_Ëngth
Ğ
max
 );

433 
oc
->
	`bh_add
(
this
, 
fš®
);

434 
	`ldout
(
oc
->
cù
, 10è<< "m­_wr™addšg¿šg bh " << *
fš®
 << 
d’dl
;

436 
oc
->
	`bh_¡©_sub
(
fš®
);

437 
fš®
->
	`£t_Ëngth
(fš®->
	`Ëngth
(è+ 
max
);

438 
oc
->
	`bh_¡©_add
(
fš®
);

440 
Ëá
 -ğ
max
;

441 
cur
 +ğ
max
;

445 
	`ldout
(
oc
->
cù
, 10è<< "cu¸i " << 
cur
 << ",… i " << *
p
->
£cÚd
 << 
d’dl
;

448 ià(
p
->
fœ¡
 <ğ
cur
) {

449 
BufãrH—d
 *
bh
 = 
p
->
£cÚd
;

450 
	`ldout
(
oc
->
cù
, 10è<< "m­_wr™bh " << *
bh
 << " iÁ”£ùed" << 
d’dl
;

452 ià(
p
->
fœ¡
 < 
cur
) {

453 
	`as£¹
(
fš®
 == 0);

454 ià(
cur
 + 
max
 >ğ
bh
->
	`’d
()) {

456 
fš®
 = 
	`¥l™
(
bh
, 
cur
);

457 
	`»¶aû_jouº®_tid
(
fš®
, 
tid
);

458 ++
p
;

459 
	`as£¹
(
p
->
£cÚd
 =ğ
fš®
);

462 
fš®
 = 
	`¥l™
(
bh
, 
cur
);

463 ++
p
;

464 
	`as£¹
(
p
->
£cÚd
 =ğ
fš®
);

465 
	`¥l™
(
fš®
, 
cur
+
max
);

466 
	`»¶aû_jouº®_tid
(
fš®
, 
tid
);

469 
	`as£¹
(
p
->
fœ¡
 =ğ
cur
);

470 ià(
bh
->
	`Ëngth
(è<ğ
max
) {

474 
	`¥l™
(
bh
, 
cur
 + 
max
);

476 ià(
fš®
) {

477 
oc
->
	`m¬k_dœty
(
bh
);

478 
oc
->
	`m¬k_dœty
(
fš®
);

479 --
p
;

480 
	`as£¹
(
p
->
£cÚd
 =ğ
fš®
);

481 
	`»¶aû_jouº®_tid
(
bh
, 
tid
);

482 
	`m”ge_Ëá
(
fš®
, 
bh
);

484 
fš®
 = 
bh
;

485 
	`»¶aû_jouº®_tid
(
fš®
, 
tid
);

490 
loff_t
 
Ënäomcur
 = 
fš®
->
	`’d
(è- 
cur
;

491 
cur
 +ğ
Ënäomcur
;

492 
Ëá
 -ğ
Ënäomcur
;

493 ++
p
;

497 
loff_t
 
Ãxt
 = 
p
->
fœ¡
;

498 
loff_t
 
gËn
 = 
¡d
::
	`mš
(
Ãxt
 - 
cur
, 
max
);

499 
	`ldout
(
oc
->
cù
, 10è<< "m­_wr™g­ " << 
cur
 << "~" << 
gËn
 << 
d’dl
;

500 ià(
fš®
) {

501 
oc
->
	`bh_¡©_sub
(
fš®
);

502 
fš®
->
	`£t_Ëngth
(fš®->
	`Ëngth
(è+ 
gËn
);

503 
oc
->
	`bh_¡©_add
(
fš®
);

505 
fš®
 = 
Ãw
 
	`BufãrH—d
(
this
);

506 
	`»¶aû_jouº®_tid
(
fš®
, 
tid
);

507 
fš®
->
	`£t_¡¬t
Ğ
cur
 );

508 
fš®
->
	`£t_Ëngth
Ğ
gËn
 );

509 
oc
->
	`bh_add
(
this
, 
fš®
);

512 
cur
 +ğ
gËn
;

513 
Ëá
 -ğ
gËn
;

519 
	`as£¹
(
fš®
);

520 
	`as£¹
(
fš®
->
	`g‘_jouº®_tid
(è=ğ
tid
);

521 
	`ldout
(
oc
->
cù
, 10è<< "m­_wr™fš® i " << *
fš®
 << 
d’dl
;

523  
fš®
;

524 
	}
}

526 
	gObjeùCach”
::
Objeù
::
	$»¶aû_jouº®_tid
(
BufãrH—d
 *
bh
,

527 
ûph_tid_t
 
tid
) {

528 
ûph_tid_t
 
bh_tid
 = 
bh
->
	`g‘_jouº®_tid
();

530 
	`as£¹
(
tid
 =ğ0 || 
bh_tid
 <=id);

531 ià(
bh_tid
 !ğ0 && bh_tid !ğ
tid
) {

533 
oc
->
wr™eback_hªdËr
.
	`ov”wr™e_ex‹Á
(
	`g‘_oid
(), 
bh
->
	`¡¬t
(),

534 
bh
->
	`Ëngth
(), 
bh_tid
, 
tid
);

536 
bh
->
	`£t_jouº®_tid
(
tid
);

537 
	}
}

539 
	gObjeùCach”
::
Objeù
::
	$Œunÿ‹
(
loff_t
 
s
)

541 
	`as£¹
(
oc
->
lock
.
	`is_locked
());

542 
	`ldout
(
oc
->
cù
, 10è<< "Œunÿ‹ " << *
this
 << "Ø" << 
s
 << 
d’dl
;

544 !
d©a
.
	`em±y
()) {

545 
BufãrH—d
 *
bh
 = 
d©a
.
	`rbegš
()->
£cÚd
;

546 ià(
bh
->
	`’d
(è<ğ
s
)

550 ià(
bh
->
	`¡¬t
(è< 
s
) {

551 
	`¥l™
(
bh
, 
s
);

556 
	`as£¹
(
bh
->
	`¡¬t
(è>ğ
s
);

557 
	`as£¹
(
bh
->
wa™fÜ_»ad
.
	`em±y
());

558 
	`»¶aû_jouº®_tid
(
bh
, 0);

559 
oc
->
	`bh_»move
(
this
, 
bh
);

560 
d–‘e
 
bh
;

562 
	}
}

564 
	gObjeùCach”
::
Objeù
::
	$disÿrd
(
loff_t
 
off
,†off_ˆ
Ën
,

565 
C_G©h”Bud”
* 
comm™_g©h”
)

567 
	`as£¹
(
oc
->
lock
.
	`is_locked
());

568 
	`ldout
(
oc
->
cù
, 10è<< "disÿrd " << *
this
 << " " << 
off
 << "~" << 
Ën


569 << 
d’dl
;

571 ià(!
exi¡s
) {

572 
	`ldout
(
oc
->
cù
, 10è<< " s‘tšgƒxi¡ Ú " << *
this
 << 
d’dl
;

573 
exi¡s
 = 
Œue
;

575 ià(
com¶‘e
) {

576 
	`ldout
(
oc
->
cù
, 10è<< " cË¬šg com¶‘Ú " << *
this
 << 
d’dl
;

577 
com¶‘e
 = 
çl£
;

580 
m­
<
loff_t
, 
BufãrH—d
*>::
cÚ¡_™”©Ü
 
p
 = 
	`d©a_low”_bound
(
off
);

581 
p
 !ğ
d©a
.
	`’d
()) {

582 
BufãrH—d
 *
bh
 = 
p
->
£cÚd
;

583 ià(
bh
->
	`¡¬t
(è>ğ
off
 + 
Ën
)

587 ià(
bh
->
	`¡¬t
(è< 
off
) {

588 
	`¥l™
(
bh
, 
off
);

589 ++
p
;

593 
	`as£¹
(
bh
->
	`¡¬t
(è>ğ
off
);

594 ià(
bh
->
	`’d
(è> 
off
 + 
Ën
) {

595 
	`¥l™
(
bh
, 
off
 + 
Ën
);

598 ++
p
;

599 
	`ldout
(
oc
->
cù
, 10è<< "disÿrd " << *
this
 << " bh " << *
bh
 << 
d’dl
;

600 
	`»¶aû_jouº®_tid
(
bh
, 0);

602 ià(
bh
->
	`is_tx
(è&& 
comm™_g©h”
 !ğ
nuÎ±r
) {

604 
wa™fÜ_comm™
[
bh
->
Ï¡_wr™e_tid
].
	`em¶aû_back
(
comm™_g©h”
->
	`Ãw_sub
());

605 } ià(
bh
->
	`is_rx
()) {

608 
bh
->
Ï¡_»ad_tid
 = ++
oc
->last_read_tid;

609 
bh
->
bl
.
	`ş—r
();

610 
bh
->
	`£t_noÿche
(
Œue
);

611 
oc
->
	`m¬k_z”o
(
bh
);

614 
	`as£¹
(
bh
->
wa™fÜ_»ad
.
	`em±y
());

617 
oc
->
	`bh_»move
(
this
, 
bh
);

618 
d–‘e
 
bh
;

620 
	}
}

626 #undeà
dout_´efix


627 
	#dout_´efix
 *
_dout
 << "objeùÿch” "

	)

630 
	gObjeùCach”
::
	$ObjeùCach”
(
C•hCÚ‹xt
 *
cù_
, 
¡ršg
 
Çme
,

631 
Wr™ebackHªdËr
& 
wb
, 
Mu‹x
& 
l
,

632 
æush_£t_ÿÎback_t
 
æush_ÿÎback
,

633 *
æush_ÿÎback_¬g
, 
ušt64_t
 
max_by‹s
,

634 
ušt64_t
 
max_objeùs
, ušt64_ˆ
max_dœty
,

635 
ušt64_t
 
rg‘_dœty
, 
max_dœty_age
,

636 
boŞ
 
block_wr™es_upäÚt
)

637 : 
	`³rfcouÁ”
(
NULL
),

638 
	`cù
(
cù_
), 
	`wr™eback_hªdËr
(
wb
), 
	`Çme
(
Çme
), 
	`lock
(
l
),

639 
	`max_dœty
(
max_dœty
), 
	`rg‘_dœty
(
rg‘_dœty
),

640 
	`max_size
(
max_by‹s
), 
	`max_objeùs
(
max_objeùs
),

641 
	`max_dœty_age
(
ûph
::
	`make_time¥ª
(
max_dœty_age
)),

642 
	`block_wr™es_upäÚt
(
block_wr™es_upäÚt
),

643 
	`Œaû_’dpošt
("ObjectCacher"),

644 
	`æush_£t_ÿÎback
(
æush_ÿÎback
),

645 
	`æush_£t_ÿÎback_¬g
(
æush_ÿÎback_¬g
),

646 
	`Ï¡_»ad_tid
(0), 
	`æush”_¡İ
(
çl£
), 
	`æush”_th»ad
(
this
),
	`fšish”
(
cù
),

647 
	`¡©_ş—n
(0), 
	`¡©_z”o
(0), 
	`¡©_dœty
(0), 
	`¡©_rx
(0), 
	`¡©_tx
(0),

648 
	`¡©_missšg
(0), 
	`¡©_”rÜ
(0), 
	`¡©_dœty_wa™šg
(0),

649 
	`¡©_Ä_dœty_wa™”s
(0), 
	$»ads_out¡ªdšg
(0)

651 
	`³rf_¡¬t
();

652 
fšish”
.
	`¡¬t
();

653 
sÿ‰”ed_wr™e
 = 
wr™eback_hªdËr
.
	`ÿn_sÿ‰”ed_wr™e
();

654 
	}
}

656 
	gObjeùCach”
::~
	$ObjeùCach”
()

658 
fšish”
.
	`¡İ
();

659 
	`³rf_¡İ
();

661 
veùÜ
<
ûph
::
unÜd”ed_m­
<
sobjeù_t
, 
Objeù
 *> >::
™”©Ü
 
i


662 ğ
objeùs
.
	`begš
();

663 
i
 !ğ
objeùs
.
	`’d
();

664 ++
i
)

665 
	`as£¹
(
i
->
	`em±y
());

666 
	`as£¹
(
bh_Ìu_»¡
.
	`Ìu_g‘_size
() == 0);

667 
	`as£¹
(
bh_Ìu_dœty
.
	`Ìu_g‘_size
() == 0);

668 
	`as£¹
(
ob_Ìu
.
	`Ìu_g‘_size
() == 0);

669 
	`as£¹
(
dœty_Ü_tx_bh
.
	`em±y
());

670 
	}
}

672 
	gObjeùCach”
::
	$³rf_¡¬t
()

674 
¡ršg
 
n
 = "objeùÿch”-" + 
Çme
;

675 
P”fCouÁ”sBud”
 
	`¶b
(
cù
, 
n
, 
l_objeùÿch”_fœ¡
, 
l_objeùÿch”_Ï¡
);

677 
¶b
.
	`add_u64_couÁ”
(
l_objeùÿch”_ÿche_İs_h™
,

679 
¶b
.
	`add_u64_couÁ”
(
l_objeùÿch”_ÿche_İs_miss
,

681 
¶b
.
	`add_u64_couÁ”
(
l_objeùÿch”_ÿche_by‹s_h™
,

682 "ÿche_by‹s_h™", "H™ d©a", 
NULL
, 0, 
	`un™_t
(
BYTES
));

683 
¶b
.
	`add_u64_couÁ”
(
l_objeùÿch”_ÿche_by‹s_miss
,

684 "ÿche_by‹s_miss", "Mis d©a", 
NULL
, 0, 
	`un™_t
(
BYTES
));

685 
¶b
.
	`add_u64_couÁ”
(
l_objeùÿch”_d©a_»ad
,

687 
¶b
.
	`add_u64_couÁ”
(
l_objeùÿch”_d©a_wr™‹n
,

689 
¶b
.
	`add_u64_couÁ”
(
l_objeùÿch”_d©a_æushed
,

691 
¶b
.
	`add_u64_couÁ”
(
l_objeùÿch”_ov”wr™‹n_š_æush
,

694 
¶b
.
	`add_u64_couÁ”
(
l_objeùÿch”_wr™e_İs_blocked
, "write_ops_blocked",

696 
¶b
.
	`add_u64_couÁ”
(
l_objeùÿch”_wr™e_by‹s_blocked
,

698 "Wr™d©¨blocked oÀdœty†im™", 
NULL
, 0, 
	`un™_t
(
BYTES
));

699 
¶b
.
	`add_time
(
l_objeùÿch”_wr™e_time_blocked
, "write_time_blocked",

702 
³rfcouÁ”
 = 
¶b
.
	`ü—‹_³rf_couÁ”s
();

703 
cù
->
	`g‘_³rfcouÁ”s_cŞËùiÚ
()->
	`add
(
³rfcouÁ”
);

704 
	}
}

706 
	gObjeùCach”
::
	$³rf_¡İ
()

708 
	`as£¹
(
³rfcouÁ”
);

709 
cù
->
	`g‘_³rfcouÁ”s_cŞËùiÚ
()->
	`»move
(
³rfcouÁ”
);

710 
d–‘e
 
³rfcouÁ”
;

711 
	}
}

714 
	gObjeùCach”
::
Objeù
 *
ObjeùCach”
::
	$g‘_objeù
(
sobjeù_t
 
oid
,

715 
ušt64_t
 
objeù_no
,

716 
ObjeùS‘
 *
o£t
,

717 
objeù_loÿtÜ_t
 &
l
,

718 
ušt64_t
 
Œunÿ‹_size
,

719 
ušt64_t
 
Œunÿ‹_£q
)

722 
	`as£¹
(
lock
.
	`is_locked
());

724 ià((
ušt32_t
)
l
.
poŞ
 < 
objeùs
.
	`size
()) {

725 ià(
objeùs
[
l
.
poŞ
].
	`couÁ
(
oid
)) {

726 
Objeù
 *
o
 = 
objeùs
[
l
.
poŞ
][
oid
];

727 
o
->
objeù_no
 = object_no;

728 
o
->
Œunÿ‹_size
 =runcate_size;

729 
o
->
Œunÿ‹_£q
 =runcate_seq;

730  
o
;

733 
objeùs
.
	`»size
(
l
.
poŞ
+1);

737 
Objeù
 *
o
 = 
Ãw
 
	`Objeù
(
this
, 
oid
, 
objeù_no
, 
o£t
, 
l
, 
Œunÿ‹_size
,

738 
Œunÿ‹_£q
);

739 
objeùs
[
l
.
poŞ
][
oid
] = 
o
;

740 
ob_Ìu
.
	`Ìu_š£¹_tİ
(
o
);

741  
o
;

742 
	}
}

744 
	gObjeùCach”
::
	$şo£_objeù
(
Objeù
 *
ob
)

746 
	`as£¹
(
lock
.
	`is_locked
());

747 
	`ldout
(
cù
, 10è<< "şo£_objeù " << *
ob
 << 
d’dl
;

748 
	`as£¹
(
ob
->
	`ÿn_şo£
());

751 
ob_Ìu
.
	`Ìu_»move
(
ob
);

752 
objeùs
[
ob
->
Şoc
.
poŞ
].
	`”a£
(ob->
	`g‘_soid
());

753 
ob
->
£t_™em
.
	`»move_my£lf
();

754 
d–‘e
 
ob
;

755 
	}
}

757 
	gObjeùCach”
::
	$bh_»ad
(
BufãrH—d
 *
bh
, 
İ_æags
,

758 cÚ¡ 
ZT¿ûr
::
T¿û
 &
·»Á_Œaû
)

760 
	`as£¹
(
lock
.
	`is_locked
());

761 
	`ldout
(
cù
, 7è<< "bh_»ad oÀ" << *
bh
 << " outstanding„eads "

762 << 
»ads_out¡ªdšg
 << 
d’dl
;

764 
ZT¿ûr
::
T¿û
 
Œaû
;

765 ià(
·»Á_Œaû
.
	`v®id
()) {

766 
Œaû
.
	`š™
("", &
Œaû_’dpošt
, &
·»Á_Œaû
);

767 
Œaû
.
	`cİy_Çme
("bh_»ad " + 
bh
->
ob
->
	`g‘_oid
().
Çme
);

768 
Œaû
.
	`ev’t
("start");

771 
	`m¬k_rx
(
bh
);

772 
bh
->
Ï¡_»ad_tid
 = ++last_read_tid;

775 
C_R—dFšish
 *
Úfšish
 = 
Ãw
 
	`C_R—dFšish
(
this
, 
bh
->
ob
, bh->
Ï¡_»ad_tid
,

776 
bh
->
	`¡¬t
(), bh->
	`Ëngth
(), 
Œaû
);

778 
wr™eback_hªdËr
.
	`»ad
(
bh
->
ob
->
	`g‘_oid
(), bh->ob->
	`g‘_objeù_numb”
(),

779 
bh
->
ob
->
	`g‘_Şoc
(), bh->
	`¡¬t
(), bh->
	`Ëngth
(),

780 
bh
->
ob
->
	`g‘_¢­
(), &
Úfšish
->
bl
,

781 
bh
->
ob
->
Œunÿ‹_size
, bh->ob->
Œunÿ‹_£q
,

782 
İ_æags
, 
Œaû
, 
Úfšish
);

784 ++
»ads_out¡ªdšg
;

785 
	}
}

787 
	gObjeùCach”
::
	$bh_»ad_fšish
(
št64_t
 
poŞid
, 
sobjeù_t
 
oid
,

788 
ûph_tid_t
 
tid
, 
loff_t
 
¡¬t
,

789 
ušt64_t
 
Ëngth
, 
bufã¾i¡
 &
bl
, 
r
,

790 
boŞ
 
Œu¡_’ÛÁ
)

792 
	`as£¹
(
lock
.
	`is_locked
());

793 
	`ldout
(
cù
, 7) << "bh_read_finish "

794 << 
oid


795 << "id " << 
tid


796 << " " << 
¡¬t
 << "~" << 
Ëngth


797 << " (bÈi " << 
bl
.
	`Ëngth
() << ")"

798 << "„‘uºed " << 
r


799 << " out¡ªdšg„—d " << 
»ads_out¡ªdšg


800 << 
d’dl
;

802 ià(
r
 >ğ0 && 
bl
.
	`Ëngth
(è< 
Ëngth
) {

803 
	`ldout
(
cù
, 7è<< "bh_»ad_fšish " << 
oid
 << "…addšg " << 
¡¬t
 << "~"

804 << 
Ëngth
 << " w™h " <<†’gth - 
bl
.
	`Ëngth
() << " bytes of zeroes"

805 << 
d’dl
;

806 
bl
.
	`­³nd_z”o
(
Ëngth
 - bl.
	`Ëngth
());

809 
li¡
<
CÚ‹xt
*> 
ls
;

810 
”r
 = 0;

812 ià(
objeùs
[
poŞid
].
	`couÁ
(
oid
) == 0) {

813 
	`ldout
(
cù
, 7è<< "bh_»ad_fšish‚Øobjeù cache" << 
d’dl
;

815 
Objeù
 *
ob
 = 
objeùs
[
poŞid
][
oid
];

817 ià(
r
 =ğ-
ENOENT
 && !
ob
->
com¶‘e
) {

824 
boŞ
 
®lz”o
 = 
Œue
;

825 
m­
<
loff_t
, 
BufãrH—d
*>::
™”©Ü
 
p
 = 
ob
->
d©a
.
	`begš
();

826 
p
 !ğ
ob
->
d©a
.
	`’d
(); ++p) {

827 
BufãrH—d
 *
bh
 = 
p
->
£cÚd
;

828 
m­
<
loff_t
, 
li¡
<
CÚ‹xt
*> >::
™”©Ü
 
p


829 ğ
bh
->
wa™fÜ_»ad
.
	`begš
();

830 
p
 !ğ
bh
->
wa™fÜ_»ad
.
	`’d
();

831 ++
p
)

832 
ls
.
	`¥liû
Ös.
	`’d
(), 
p
->
£cÚd
);

833 
bh
->
wa™fÜ_»ad
.
	`ş—r
();

834 ià(!
bh
->
	`is_z”o
(è&& !bh->
	`is_rx
())

835 
®lz”o
 = 
çl£
;

840 ià(
Œu¡_’ÛÁ
) {

841 
	`ldout
(
cù
, 7)

842 << "bh_»ad_fšish ENOENT, m¬kšg com¶‘ªd !exi¡ Ú " << *
ob


843 << 
d’dl
;

844 
ob
->
com¶‘e
 = 
Œue
;

845 
ob
->
exi¡s
 = 
çl£
;

859 ià(
®lz”o
) {

860 
	`ldout
(
cù
, 10)

862 << "bh fÜ " << *
ob
 << 
d’dl
;

863 
m­
<
loff_t
, 
BufãrH—d
*>::
™”©Ü
 
p
 = 
ob
->
d©a
.
	`begš
();

864 
p
 !ğ
ob
->
d©a
.
	`’d
()) {

865 
BufãrH—d
 *
bh
 = 
p
->
£cÚd
;

867 ++
p
;

868 
	`bh_»move
(
ob
, 
bh
);

869 
d–‘e
 
bh
;

876 
loff_t
 
İos
 = 
¡¬t
;

877 
Œue
) {

878 
m­
<
loff_t
, 
BufãrH—d
*>::
cÚ¡_™”©Ü
 
p
 = 
ob
->
	`d©a_low”_bound
(
İos
);

879 ià(
p
 =ğ
ob
->
d©a
.
	`’d
())

881 ià(
İos
 >ğ
¡¬t
+(
loff_t
)
Ëngth
) {

882 
	`ldout
(
cù
, 20è<< "b»ak dutØİo " << 
İos
 << " >= start+length "

883 << 
¡¬t
 << "+" << 
Ëngth
 << "=" << s¹+(
loff_t
)length

884 << 
d’dl
;

888 
BufãrH—d
 *
bh
 = 
p
->
£cÚd
;

889 
	`ldout
(
cù
, 20è<< "checkšg bh " << *
bh
 << 
d’dl
;

892 
m­
<
loff_t
, 
li¡
<
CÚ‹xt
*> >::
™”©Ü
 
™


893 ğ
bh
->
wa™fÜ_»ad
.
	`begš
();

894 
™
 !ğ
bh
->
wa™fÜ_»ad
.
	`’d
();

895 ++
™
)

896 
ls
.
	`¥liû
Ös.
	`’d
(), 
™
->
£cÚd
);

897 
bh
->
wa™fÜ_»ad
.
	`ş—r
();

899 ià(
bh
->
	`¡¬t
(è> 
İos
) {

900 
	`ldout
(
cù
, 1) << "bh_read_finish skipping gap "

901 << 
İos
 << "~" << 
bh
->
	`¡¬t
() - opos

902 << 
d’dl
;

903 
İos
 = 
bh
->
	`¡¬t
();

907 ià(!
bh
->
	`is_rx
()) {

908 
	`ldout
(
cù
, 10è<< "bh_»ad_fšish skpšg‚Ú-rx " << *
bh
 << 
d’dl
;

909 
İos
 = 
bh
->
	`’d
();

913 ià(
bh
->
Ï¡_»ad_tid
 !ğ
tid
) {

914 
	`ldout
(
cù
, 10) << "bh_read_finish bh->last_read_tid "

915 << 
bh
->
Ï¡_»ad_tid
 << " !ğtid " << 
tid


916 << ", skpšg" << 
d’dl
;

917 
İos
 = 
bh
->
	`’d
();

921 
	`as£¹
(
İos
 >ğ
bh
->
	`¡¬t
());

922 
	`as£¹
(
bh
->
	`¡¬t
(è=ğ
İos
);

923 
	`as£¹
(
bh
->
	`Ëngth
(è<ğ
¡¬t
+(
loff_t
)
Ëngth
-
İos
);

925 ià(
bh
->
”rÜ
 < 0)

926 
”r
 = 
bh
->
”rÜ
;

928 
İos
 = 
bh
->
	`’d
();

930 ià(
r
 =ğ-
ENOENT
) {

931 ià(
Œu¡_’ÛÁ
) {

932 
	`ldout
(
cù
, 10è<< "bh_»ad_fšish„emovšg " << *
bh
 << 
d’dl
;

933 
	`bh_»move
(
ob
, 
bh
);

934 
d–‘e
 
bh
;

936 
	`ldout
(
cù
, 10) << "skipping unstrusted -ENOENT‡nd will„etry for "

937 << *
bh
 << 
d’dl
;

942 ià(
r
 < 0) {

943 
bh
->
”rÜ
 = 
r
;

944 
	`m¬k_”rÜ
(
bh
);

946 
bh
->
bl
.
	`sub¡r_of
(bl,

947 
bh
->
	`¡¬t
(è- 
¡¬t
,

948 
bh
->
	`Ëngth
());

949 
	`m¬k_ş—n
(
bh
);

952 
	`ldout
(
cù
, 10è<< "bh_»ad_fšish„—d " << *
bh
 << 
d’dl
;

954 
ob
->
	`Œy_m”ge_bh
(
bh
);

959 
	`ldout
(
cù
, 20è<< "fšishšg wa™” " << 
ls
 << 
d’dl
;

961 
	`fšish_cÚ‹xts
(
cù
, 
ls
, 
”r
);

962 
	`»Œy_wa™šg_»ads
();

964 --
»ads_out¡ªdšg
;

965 
»ad_cÚd
.
	`SigÇl
();

966 
	}
}

968 
	gObjeùCach”
::
	$bh_wr™e_adjaûnc›s
(
BufãrH—d
 *
bh
, 
ûph
::
»®_time
 
cutoff
,

969 
št64_t
 *
max_amouÁ
, *
max_couÁ
)

971 
li¡
<
BufãrH—d
*> 
bli¡
;

973 
couÁ
 = 0;

974 
št64_t
 
tÙ®_Ën
 = 0;

975 
£t
<
BufãrH—d
*, BufãrH—d::
±r_É
>::
™”©Ü
 
™
 = 
dœty_Ü_tx_bh
.
	`fšd
(
bh
);

976 
	`as£¹
(
™
 !ğ
dœty_Ü_tx_bh
.
	`’d
());

977 
£t
<
BufãrH—d
*, BufãrH—d::
±r_É
>::
™”©Ü
 
p
 = 
™
;

978 
p
 !ğ
dœty_Ü_tx_bh
.
	`’d
();

979 ++
p
) {

980 
BufãrH—d
 *
obh
 = *
p
;

981 ià(
obh
->
ob
 !ğ
bh
->ob)

983 ià(
obh
->
	`is_dœty
(è&& obh->
Ï¡_wr™e
 <ğ
cutoff
) {

984 
bli¡
.
	`push_back
(
obh
);

985 ++
couÁ
;

986 
tÙ®_Ën
 +ğ
obh
->
	`Ëngth
();

987 ià((
max_couÁ
 && 
couÁ
 > *max_count) ||

988 (
max_amouÁ
 && 
tÙ®_Ën
 > *max_amount))

993 
™
 !ğ
dœty_Ü_tx_bh
.
	`begš
()) {

994 --
™
;

995 
BufãrH—d
 *
obh
 = *
™
;

996 ià(
obh
->
ob
 !ğ
bh
->ob)

998 ià(
obh
->
	`is_dœty
(è&& obh->
Ï¡_wr™e
 <ğ
cutoff
) {

999 
bli¡
.
	`push_äÚt
(
obh
);

1000 ++
couÁ
;

1001 
tÙ®_Ën
 +ğ
obh
->
	`Ëngth
();

1002 ià((
max_couÁ
 && 
couÁ
 > *max_count) ||

1003 (
max_amouÁ
 && 
tÙ®_Ën
 > *max_amount))

1007 ià(
max_couÁ
)

1008 *
max_couÁ
 -ğ
couÁ
;

1009 ià(
max_amouÁ
)

1010 *
max_amouÁ
 -ğ
tÙ®_Ën
;

1012 
	`bh_wr™e_sÿ‰”ed
(
bli¡
);

1013 
	}
}

1015 şas 
	cObjeùCach”
::
C_Wr™eComm™
 : 
public
 
CÚ‹xt
 {

1016 
ObjeùCach”
 *
oc
;

1017 
št64_t
 
	mpoŞid
;

1018 
sobjeù_t
 
	moid
;

1019 
	mveùÜ
<
	m·œ
<
	mloff_t
, 
	mušt64_t
> > 
	m¿nges
;

1020 
	mZT¿ûr
::
T¿û
 
Œaû
;

1021 
	mpublic
:

1022 
ûph_tid_t
 
tid
 = 0;

1023 
	$C_Wr™eComm™
(
ObjeùCach”
 *
c
, 
št64_t
 
_poŞid
, 
sobjeù_t
 
o
, 
loff_t
 
s
,

1024 
ušt64_t
 
l
, cÚ¡ 
ZT¿ûr
::
T¿û
 &
Œaû
) :

1025 
	`oc
(
c
), 
	`poŞid
(
_poŞid
), 
	`oid
(
o
), 
	$Œaû
(
Œaû
) {

1026 
¿nges
.
	`push_back
(
	`make_·œ
(
s
, 
l
));

1028 
	`C_Wr™eComm™
(
ObjeùCach”
 *
c
, 
št64_t
 
_poŞid
, 
sobjeù_t
 
o
,

1029 
veùÜ
<
·œ
<
loff_t
, 
ušt64_t
> >& 
_¿nges
) :

1030 
	`oc
(
c
), 
	`poŞid
(
_poŞid
), 
	`oid
(
o
), 
	$tid
(0) {

1031 
¿nges
.
	`sw­
(
_¿nges
);

1032 
	}
}

1033 
	$fšish
(
r
è
ov”ride
 {

1034 
oc
->
	`bh_wr™e_comm™
(
poŞid
, 
oid
, 
¿nges
, 
tid
, 
r
);

1035 
Œaû
.
	`ev’t
("finish");

1036 
	}
}

1038 
	gObjeùCach”
::
bh_wr™e_sÿ‰”ed
(
li¡
<
BufãrH—d
*>& 
bli¡
)

1040 
as£¹
(
lock
.
is_locked
());

1042 
Objeù
 *
	gob
 = 
bli¡
.
äÚt
()->
ob
;

1043 
	gob
->
g‘
();

1045 
	gûph
::
»®_time
 
Ï¡_wr™e
;

1046 
SÇpCÚ‹xt
 
	g¢­c
;

1047 
	gveùÜ
<
	g·œ
<
	gloff_t
, 
	gušt64_t
> > 
	g¿nges
;

1048 
	gveùÜ
<
	g·œ
<
	gušt64_t
, 
	gbufã¾i¡
> > 
	gio_vec
;

1050 
	g¿nges
.
»£rve
(
bli¡
.
size
());

1051 
	gio_vec
.
»£rve
(
bli¡
.
size
());

1053 
ušt64_t
 
	gtÙ®_Ën
 = 0;

1054 
	gli¡
<
	gBufãrH—d
*>::
™”©Ü
 
p
 = 
bli¡
.
begš
(); 
	gp
 !ğbli¡.
’d
(); ++p) {

1055 
BufãrH—d
 *
	gbh
 = *
p
;

1056 
ldout
(
cù
, 7è<< "bh_wr™e_sÿ‰”ed " << *
	gbh
 << 
	gd’dl
;

1057 
as£¹
(
bh
->
ob
 == ob);

1058 
as£¹
(
bh
->
bl
.
Ëngth
() == bh->length());

1059 
	g¿nges
.
push_back
(
·œ
<
loff_t
, 
ušt64_t
>(
bh
->
¡¬t
(), bh->
Ëngth
()));

1061 
	gn
 = 
io_vec
.
size
();

1062 
	gio_vec
.
»size
(
n
 + 1);

1063 
	gio_vec
[
n
].
	gfœ¡
 = 
bh
->
¡¬t
();

1064 
	gio_vec
[
n
].
	g£cÚd
 = 
bh
->
bl
;

1066 
	gtÙ®_Ën
 +ğ
bh
->
Ëngth
();

1067 ià(
	gbh
->
	g¢­c
.
	g£q
 > snapc.seq)

1068 
	g¢­c
 = 
bh
->
¢­c
;

1069 ià(
	gbh
->
	gÏ¡_wr™e
 >†ast_write)

1070 
	gÏ¡_wr™e
 = 
bh
->
Ï¡_wr™e
;

1073 
C_Wr™eComm™
 *
	gÚcomm™
 = 
Ãw
 C_Wr™eComm™(
this
, 
ob
->
Şoc
.
poŞ
, ob->
g‘_soid
(), 
¿nges
);

1075 
ûph_tid_t
 
	gtid
 = 
wr™eback_hªdËr
.
wr™e
(
ob
->
g‘_oid
(), ob->
g‘_Şoc
(),

1076 
io_vec
, 
¢­c
, 
Ï¡_wr™e
,

1077 
ob
->
Œunÿ‹_size
, ob->
Œunÿ‹_£q
,

1078 
Úcomm™
);

1079 
	gÚcomm™
->
	gtid
 = 
tid
;

1080 
	gob
->
	gÏ¡_wr™e_tid
 = 
tid
;

1081 
	gli¡
<
	gBufãrH—d
*>::
™”©Ü
 
p
 = 
bli¡
.
begš
(); 
	gp
 !ğbli¡.
’d
(); ++p) {

1082 
BufãrH—d
 *
	gbh
 = *
p
;

1083 
	gbh
->
	gÏ¡_wr™e_tid
 = 
tid
;

1084 
m¬k_tx
(
bh
);

1087 ià(
	g³rfcouÁ”
)

1088 
	g³rfcouÁ”
->
šc
(
l_objeùÿch”_d©a_æushed
, 
tÙ®_Ën
);

1091 
	gObjeùCach”
::
	$bh_wr™e
(
BufãrH—d
 *
bh
, cÚ¡ 
ZT¿ûr
::
T¿û
 &
·»Á_Œaû
)

1093 
	`as£¹
(
lock
.
	`is_locked
());

1094 
	`ldout
(
cù
, 7è<< "bh_wr™" << *
bh
 << 
d’dl
;

1096 
bh
->
ob
->
	`g‘
();

1098 
ZT¿ûr
::
T¿û
 
Œaû
;

1099 ià(
·»Á_Œaû
.
	`v®id
()) {

1100 
Œaû
.
	`š™
("", &
Œaû_’dpošt
, &
·»Á_Œaû
);

1101 
Œaû
.
	`cİy_Çme
("bh_wr™" + 
bh
->
ob
->
	`g‘_oid
().
Çme
);

1102 
Œaû
.
	`ev’t
("start");

1106 
C_Wr™eComm™
 *
Úcomm™
 = 
Ãw
 
	`C_Wr™eComm™
(
this
, 
bh
->
ob
->
Şoc
.
poŞ
,

1107 
bh
->
ob
->
	`g‘_soid
(), bh->
	`¡¬t
(),

1108 
bh
->
	`Ëngth
(), 
Œaû
);

1110 
ûph_tid_t
 
tid
 = 
wr™eback_hªdËr
.
	`wr™e
(
bh
->
ob
->
	`g‘_oid
(),

1111 
bh
->
ob
->
	`g‘_Şoc
(),

1112 
bh
->
	`¡¬t
(), bh->
	`Ëngth
(),

1113 
bh
->
¢­c
, bh->
bl
, bh->
Ï¡_wr™e
,

1114 
bh
->
ob
->
Œunÿ‹_size
,

1115 
bh
->
ob
->
Œunÿ‹_£q
,

1116 
bh
->
jouº®_tid
, 
Œaû
, 
Úcomm™
);

1117 
	`ldout
(
cù
, 20è<< "id " << 
tid
 << " oÀ" << 
bh
->
ob
->
	`g‘_oid
(è<< 
d’dl
;

1120 
Úcomm™
->
tid
 =id;

1121 
bh
->
ob
->
Ï¡_wr™e_tid
 = 
tid
;

1122 
bh
->
Ï¡_wr™e_tid
 = 
tid
;

1124 ià(
³rfcouÁ”
) {

1125 
³rfcouÁ”
->
	`šc
(
l_objeùÿch”_d©a_æushed
, 
bh
->
	`Ëngth
());

1128 
	`m¬k_tx
(
bh
);

1129 
	}
}

1131 
	gObjeùCach”
::
bh_wr™e_comm™
(
št64_t
 
poŞid
, 
sobjeù_t
 
oid
,

1132 
veùÜ
<
·œ
<
loff_t
, 
ušt64_t
> >& 
¿nges
,

1133 
ûph_tid_t
 
tid
, 
r
)

1135 
as£¹
(
lock
.
is_locked
());

1136 
ldout
(
cù
, 7è<< "bh_wr™e_comm™ " << 
	goid
 << "id " << 
	gtid


1137 << "„ªge " << 
	g¿nges
 << "„‘uºed " << 
	gr
 << 
	gd’dl
;

1139 ià(
	gobjeùs
[
poŞid
].
couÁ
(
oid
) == 0) {

1140 
ldout
(
cù
, 7è<< "bh_wr™e_comm™‚Øobjeù cache" << 
d’dl
;

1144 
Objeù
 *
	gob
 = 
objeùs
[
poŞid
][
oid
];

1145 
	gwas_dœty_Ü_tx
 = 
ob
->
o£t
->
dœty_Ü_tx
;

1147 
	gveùÜ
<
	g·œ
<
	gloff_t
, 
	gušt64_t
> >::
™”©Ü
 
p
 = 
¿nges
.
begš
();

1148 
	gp
 !ğ
¿nges
.
’d
();

1149 ++
	gp
) {

1150 
loff_t
 
	g¡¬t
 = 
p
->
fœ¡
;

1151 
ušt64_t
 
	gËngth
 = 
p
->
£cÚd
;

1152 ià(!
	gob
->
	gexi¡s
) {

1153 
ldout
(
cù
, 10è<< "bh_wr™e_comm™ m¬kšgƒxi¡ Ú " << *
	gob
 << 
	gd’dl
;

1154 
	gob
->
	gexi¡s
 = 
Œue
;

1156 ià(
	gwr™eback_hªdËr
.
may_cİy_Ú_wr™e
(
ob
->
g‘_oid
(), 
¡¬t
, 
Ëngth
,

1157 
ob
->
g‘_¢­
())) {

1158 
ldout
(
cù
, 10) << "bh_write_commit may copy on write, clearing "

1159 "com¶‘Ú " << *
	gob
 << 
	gd’dl
;

1160 
	gob
->
	gcom¶‘e
 = 
çl£
;

1164 
	gveùÜ
<
	g·œ
<
	gloff_t
, 
	gBufãrH—d
*>> 
	gh™
;

1166 
	gm­
<
	gloff_t
, 
	gBufãrH—d
*>::
cÚ¡_™”©Ü
 
p
 = 
ob
->
d©a_low”_bound
(
¡¬t
);

1167 
	gp
 !ğ
ob
->
d©a
.
’d
();

1168 ++
	gp
) {

1169 
BufãrH—d
 *
	gbh
 = 
p
->
£cÚd
;

1171 ià(
	gbh
->
¡¬t
(è>ğ¡¬t+(
loff_t
)
Ëngth
)

1175 ià(!
	gbh
->
is_tx
()) {

1176 
ldout
(
cù
, 10è<< "bh_wr™e_comm™ skpšg‚Ú-tx " << *
	gbh
 << 
	gd’dl
;

1181 ià(
	gbh
->
	gÏ¡_wr™e_tid
 !ğ
tid
) {

1182 
as£¹
(
bh
->
Ï¡_wr™e_tid
 > 
tid
);

1183 
ldout
(
cù
, 10è<< "bh_wr™e_comm™‚ew”id oÀ" << *
	gbh
 << 
	gd’dl
;

1188 
as£¹
(
bh
->
¡¬t
() >= start);

1189 
as£¹
(
bh
->
’d
(è<ğ
¡¬t
+(
loff_t
)
Ëngth
);

1191 ià(
	gr
 >= 0) {

1193 
m¬k_ş—n
(
bh
);

1194 
	gbh
->
£t_jouº®_tid
(0);

1195 ià(
	gbh
->
g‘_noÿche
())

1196 
	gbh_Ìu_»¡
.
Ìu_bÙtouch
(
bh
);

1197 
	gh™
.
push_back
(
make_·œ
(
bh
->
¡¬t
(), bh));

1198 
ldout
(
cù
, 10è<< "bh_wr™e_comm™ cËª " << *
	gbh
 << 
	gd’dl
;

1200 
m¬k_dœty
(
bh
);

1201 
ldout
(
cù
, 10) << "bh_write_commit marking dirty‡gain dueoƒrror "

1202 << *
	gbh
 << "„ = " << 
	gr
 << " " << 
ıp_¡»¼Ü
(-
r
)

1203 << 
	gd’dl
;

1207 auto& 
	gp
 : 
h™
) {

1209 ià(
ob
->
d©a
.
couÁ
(
p
.
fœ¡
))

1210 
ob
->
Œy_m”ge_bh
(
p
.
£cÚd
);

1215 
as£¹
(
ob
->
Ï¡_comm™_tid
 < 
tid
);

1216 
	gob
->
	gÏ¡_comm™_tid
 = 
tid
;

1219 
	gli¡
<
	gCÚ‹xt
*> 
	gls
;

1220 ià(
	gob
->
	gwa™fÜ_comm™
.
couÁ
(
tid
)) {

1221 
	gls
.
¥liû
(
ls
.
begš
(), 
ob
->
wa™fÜ_comm™
[
tid
]);

1222 
	gob
->
	gwa™fÜ_comm™
.
”a£
(
tid
);

1226 
ObjeùS‘
 *
	go£t
 = 
ob
->
o£t
;

1227 
	gob
->
put
();

1229 ià(
	gæush_£t_ÿÎback
 &&

1230 
	gwas_dœty_Ü_tx
 > 0 &&

1231 
	go£t
->
	gdœty_Ü_tx
 == 0) {

1232 
æush_£t_ÿÎback
(
æush_£t_ÿÎback_¬g
, 
o£t
);

1235 ià(!
	gls
.
em±y
())

1236 
fšish_cÚ‹xts
(
cù
, 
ls
, 
r
);

1239 
	gObjeùCach”
::
	$æush
(
ZT¿ûr
::
T¿û
 *
Œaû
, 
loff_t
 
amouÁ
)

1241 
	`as£¹
(
Œaû
 !ğ
nuÎ±r
);

1242 
	`as£¹
(
lock
.
	`is_locked
());

1243 
ûph
::
»®_time
 
cutoff
 = c•h::
»®_şock
::
	`now
();

1245 
	`ldout
(
cù
, 10è<< "æush " << 
amouÁ
 << 
d’dl
;

1253 
št64_t
 
Ëá
 = 
amouÁ
;

1254 
amouÁ
 =ğ0 || 
Ëá
 > 0) {

1255 
BufãrH—d
 *
bh
 = 
¡©ic_ÿ¡
<BufferHead*>(

1256 
bh_Ìu_dœty
.
	`Ìu_g‘_Ãxt_expœe
());

1257 ià(!
bh
) ;

1258 ià(
bh
->
Ï¡_wr™e
 > 
cutoff
) ;

1260 ià(
sÿ‰”ed_wr™e
) {

1261 
	`bh_wr™e_adjaûnc›s
(
bh
, 
cutoff
, 
amouÁ
 > 0 ? &
Ëá
 : 
NULL
, NULL);

1263 
Ëá
 -ğ
bh
->
	`Ëngth
();

1264 
	`bh_wr™e
(
bh
, *
Œaû
);

1267 
	}
}

1270 
	gObjeùCach”
::
	$Œim
()

1272 
	`as£¹
(
lock
.
	`is_locked
());

1273 
	`ldout
(
cù
, 10è<< "Œim s¹: by‹s: max " << 
max_size
 << " clean "

1274 << 
	`g‘_¡©_ş—n
(è<< ", objeùs: max " << 
max_objeùs


1275 << " cu¼’ˆ" << 
ob_Ìu
.
	`Ìu_g‘_size
(è<< 
d’dl
;

1277 
ušt64_t
 
max_ş—n_bh
 = 
max_size
 >> 
BUFFER_MEMORY_WEIGHT
;

1278 
ušt64_t
 
Ä_ş—n_bh
 = 
bh_Ìu_»¡
.
	`Ìu_g‘_size
(è- bh_Ìu_»¡.
	`Ìu_g‘_num_pšÃd
();

1279 
	`g‘_¡©_ş—n
() > 0 &&

1280 ((
ušt64_t
)
	`g‘_¡©_ş—n
(è> 
max_size
 ||

1281 
Ä_ş—n_bh
 > 
max_ş—n_bh
)) {

1282 
BufãrH—d
 *
bh
 = 
¡©ic_ÿ¡
<BufãrH—d*>(
bh_Ìu_»¡
.
	`Ìu_expœe
());

1283 ià(!
bh
)

1286 
	`ldout
(
cù
, 10è<< "Œimrimmšg " << *
bh
 << 
d’dl
;

1287 
	`as£¹
(
bh
->
	`is_ş—n
(è|| bh->
	`is_z”o
(è|| bh->
	`is_”rÜ
());

1289 
Objeù
 *
ob
 = 
bh
->ob;

1290 
	`bh_»move
(
ob
, 
bh
);

1291 
d–‘e
 
bh
;

1293 --
Ä_ş—n_bh
;

1295 ià(
ob
->
com¶‘e
) {

1296 
	`ldout
(
cù
, 10è<< "Œim cË¬šg com¶‘Ú " << *
ob
 << 
d’dl
;

1297 
ob
->
com¶‘e
 = 
çl£
;

1301 
ob_Ìu
.
	`Ìu_g‘_size
(è> 
max_objeùs
) {

1302 
Objeù
 *
ob
 = 
¡©ic_ÿ¡
<Objeù*>(
ob_Ìu
.
	`Ìu_expœe
());

1303 ià(!
ob
)

1306 
	`ldout
(
cù
, 10è<< "Œimrimmšg " << *
ob
 << 
d’dl
;

1307 
	`şo£_objeù
(
ob
);

1310 
	`ldout
(
cù
, 10è<< "Œim fšish: max " << 
max_size
 << " clean "

1311 << 
	`g‘_¡©_ş—n
(è<< ", objeùs: max " << 
max_objeùs


1312 << " cu¼’ˆ" << 
ob_Ìu
.
	`Ìu_g‘_size
(è<< 
d’dl
;

1313 
	}
}

1319 
boŞ
 
	gObjeùCach”
::
is_ÿched
(
ObjeùS‘
 *
o£t
, 
veùÜ
<
ObjeùEx‹Á
>& 
ex‹Ás
,

1320 
¢­id_t
 
¢­id
)

1322 
as£¹
(
lock
.
is_locked
());

1323 
	gveùÜ
<
	gObjeùEx‹Á
>::
™”©Ü
 
ex_™
 = 
ex‹Ás
.
begš
();

1324 
	gex_™
 !ğ
ex‹Ás
.
’d
();

1325 ++
	gex_™
) {

1326 
ldout
(
cù
, 10è<< "is_ÿched " << *
	gex_™
 << 
	gd’dl
;

1329 
sobjeù_t
 
soid
(
ex_™
->
oid
, 
¢­id
);

1330 
Objeù
 *
	go
 = 
g‘_objeù_maybe
(
soid
, 
ex_™
->
Şoc
);

1331 ià(!
	go
)

1332  
	gçl£
;

1333 ià(!
	go
->
is_ÿched
(
ex_™
->
off£t
,ƒx_™->
Ëngth
))

1334  
	gçl£
;

1336  
	gŒue
;

1345 
	gObjeùCach”
::
	$»adx
(
OSDR—d
 *
rd
, 
ObjeùS‘
 *
o£t
, 
CÚ‹xt
 *
Úfšish
,

1346 
ZT¿ûr
::
T¿û
 *
·»Á_Œaû
)

1348 
ZT¿ûr
::
T¿û
 
Œaû
;

1349 ià(
·»Á_Œaû
 !ğ
nuÎ±r
) {

1350 
Œaû
.
	`š™
("»ad", &
Œaû_’dpošt
, 
·»Á_Œaû
);

1351 
Œaû
.
	`ev’t
("start");

1354 
r
 =
	`_»adx
(
rd
, 
o£t
, 
Úfšish
, 
Œue
, &
Œaû
);

1355 ià(
r
 < 0) {

1356 
Œaû
.
	`ev’t
("finish");

1358  
r
;

1359 
	}
}

1361 
	gObjeùCach”
::
	$_»adx
(
OSDR—d
 *
rd
, 
ObjeùS‘
 *
o£t
, 
CÚ‹xt
 *
Úfšish
,

1362 
boŞ
 
ex‹º®_ÿÎ
, 
ZT¿ûr
::
T¿û
 *
Œaû
)

1364 
	`as£¹
(
Œaû
 !ğ
nuÎ±r
);

1365 
	`as£¹
(
lock
.
	`is_locked
());

1366 
boŞ
 
sucûss
 = 
Œue
;

1367 
”rÜ
 = 0;

1368 
ušt64_t
 
by‹s_š_ÿche
 = 0;

1369 
ušt64_t
 
by‹s_nÙ_š_ÿche
 = 0;

1370 
ušt64_t
 
tÙ®_by‹s_»ad
 = 0;

1371 
m­
<
ušt64_t
, 
bufã¾i¡
> 
¡re_m­
;

1372 
boŞ
 
dÚŠ“d
 = 
rd
->
çdvi£_æags
 & 
LIBRADOS_OP_FLAG_FADVISE_DONTNEED
;

1373 
boŞ
 
noÿche
 = 
rd
->
çdvi£_æags
 & 
LIBRADOS_OP_FLAG_FADVISE_NOCACHE
;

1380 
	`as£¹
(!
o£t
->
»tuº_’ÛÁ
 || 
rd
->
ex‹Ás
.
	`size
() == 1);

1382 
veùÜ
<
ObjeùEx‹Á
>::
™”©Ü
 
ex_™
 = 
rd
->
ex‹Ás
.
	`begš
();

1383 
ex_™
 !ğ
rd
->
ex‹Ás
.
	`’d
();

1384 ++
ex_™
) {

1385 
	`ldout
(
cù
, 10è<< "»adx " << *
ex_™
 << 
d’dl
;

1387 
tÙ®_by‹s_»ad
 +ğ
ex_™
->
Ëngth
;

1390 
sobjeù_t
 
	`soid
(
ex_™
->
oid
, 
rd
->
¢­
);

1391 
Objeù
 *
o
 = 
	`g‘_objeù
(
soid
, 
ex_™
->
objeùno
, 
o£t
,ƒx_™->
Şoc
,

1392 
ex_™
->
Œunÿ‹_size
, 
o£t
->
Œunÿ‹_£q
);

1393 ià(
ex‹º®_ÿÎ
)

1394 
	`touch_ob
(
o
);

1397 ià(
o£t
->
»tuº_’ÛÁ
 && !
o
->
exi¡s
) {

1398 
	`ldout
(
cù
, 10è<< "»adx objeù !exi¡s, 1ƒx‹Á..." << 
d’dl
;

1401 ià(
wr™eback_hªdËr
.
	`may_cİy_Ú_wr™e
(
soid
.
oid
, 
ex_™
->
off£t
,

1402 
ex_™
->
Ëngth
, 
soid
.
¢­
)) {

1403 
	`ldout
(
cù
, 20è<< "»adx may cİy oÀwr™e" << 
d’dl
;

1404 
boŞ
 
wa™
 = 
çl£
;

1405 
li¡
<
BufãrH—d
*> 
bli¡
;

1406 
m­
<
loff_t
, 
BufãrH—d
*>::
™”©Ü
 
bh_™
 = 
o
->
d©a
.
	`begš
();

1407 
bh_™
 !ğ
o
->
d©a
.
	`’d
();

1408 ++
bh_™
) {

1409 
BufãrH—d
 *
bh
 = 
bh_™
->
£cÚd
;

1410 ià(
bh
->
	`is_dœty
(è|| bh->
	`is_tx
()) {

1411 
	`ldout
(
cù
, 10è<< "»adx flushšg " << *
bh
 << 
d’dl
;

1412 
wa™
 = 
Œue
;

1413 ià(
bh
->
	`is_dœty
()) {

1414 ià(
sÿ‰”ed_wr™e
)

1415 
bli¡
.
	`push_back
(
bh
);

1417 
	`bh_wr™e
(
bh
, *
Œaû
);

1421 ià(
sÿ‰”ed_wr™e
 && !
bli¡
.
	`em±y
())

1422 
	`bh_wr™e_sÿ‰”ed
(
bli¡
);

1423 ià(
wa™
) {

1424 
	`ldout
(
cù
, 10è<< "»adx wa™šg oÀtid " << 
o
->
Ï¡_wr™e_tid


1425 << " oÀ" << *
o
 << 
d’dl
;

1426 
o
->
wa™fÜ_comm™
[o->
Ï¡_wr™e_tid
].
	`push_back
(

1427 
Ãw
 
	`C_R‘ryR—d
(
this
,
rd
, 
o£t
, 
Úfšish
, *
Œaû
));

1434 
boŞ
 
®lz”o
 = 
Œue
;

1435 
m­
<
loff_t
, 
BufãrH—d
*>::
™”©Ü
 
bh_™
 = 
o
->
d©a
.
	`begš
();

1436 
bh_™
 !ğ
o
->
d©a
.
	`’d
();

1437 ++
bh_™
) {

1438 
	`ldout
(
cù
, 20è<< "»adx ob ha bh " << *
bh_™
->
£cÚd
 << 
d’dl
;

1439 ià(!
bh_™
->
£cÚd
->
	`is_z”o
(è&& !bh_™->£cÚd->
	`is_rx
()) {

1440 
®lz”o
 = 
çl£
;

1444 ià(
®lz”o
) {

1445 
	`ldout
(
cù
, 10) << "readx ob has‡ll zero|rx,„eturning ENOENT"

1446 << 
d’dl
;

1447 
d–‘e
 
rd
;

1448 ià(
dÚŠ“d
)

1449 
	`bÙtouch_ob
(
o
);

1450  -
ENOENT
;

1455 
m­
<
loff_t
, 
BufãrH—d
*> 
h™s
, 
missšg
, 
rx
, 
”rÜs
;

1456 
o
->
	`m­_»ad
(*
ex_™
, 
h™s
, 
missšg
, 
rx
, 
”rÜs
);

1457 ià(
ex‹º®_ÿÎ
) {

1459 
missšg
.
	`š£¹
(
”rÜs
.
	`begš
(),ƒ¼Üs.
	`’d
());

1464 
h™s
.
	`š£¹
(
”rÜs
.
	`begš
(),ƒ¼Üs.
	`’d
());

1467 ià(!
missšg
.
	`em±y
(è|| !
rx
.empty()) {

1469 
m­
<
loff_t
, 
BufãrH—d
*>::
™”©Ü
 
Ï¡
 = 
missšg
.
	`’d
();

1470 
m­
<
loff_t
, 
BufãrH—d
*>::
™”©Ü
 
bh_™
 = 
missšg
.
	`begš
();

1471 
bh_™
 !ğ
missšg
.
	`’d
();

1472 ++
bh_™
) {

1473 
ušt64_t
 
rx_by‹s
 = 
¡©ic_ÿ¡
<uint64_t>(

1474 
¡©_rx
 + 
bh_™
->
£cÚd
->
	`Ëngth
());

1475 
by‹s_nÙ_š_ÿche
 +ğ
bh_™
->
£cÚd
->
	`Ëngth
();

1476 ià(!
wa™fÜ_»ad
.
	`em±y
(è|| (
¡©_rx
 > 0 && 
rx_by‹s
 > 
max_size
)) {

1479 ià(
sucûss
) {

1480 
	`ldout
(
cù
, 10) << "readx missed, waiting on cacheo complete "

1481 << 
wa™fÜ_»ad
.
	`size
() << " blocked„eads, "

1482 << (
¡d
::
	`max
(
rx_by‹s
, 
max_size
) - max_size)

1483 << "„—d by‹s" << 
d’dl
;

1484 
wa™fÜ_»ad
.
	`push_back
(
Ãw
 
	`C_R‘ryR—d
(
this
, 
rd
, 
o£t
, 
Úfšish
,

1485 *
Œaû
));

1488 
	`bh_»move
(
o
, 
bh_™
->
£cÚd
);

1489 
d–‘e
 
bh_™
->
£cÚd
;

1491 
bh_™
->
£cÚd
->
	`£t_noÿche
(
noÿche
);

1492 
	`bh_»ad
(
bh_™
->
£cÚd
, 
rd
->
çdvi£_æags
, *
Œaû
);

1493 ià((
sucûss
 && 
Úfšish
è|| 
Ï¡
 !ğ
missšg
.
	`’d
())

1494 
Ï¡
 = 
bh_™
;

1496 
sucûss
 = 
çl£
;

1500 ià(
Ï¡
 !ğ
missšg
.
	`’d
()) {

1501 
	`ldout
(
cù
, 10è<< "»adx mis£d, wa™šg oÀ" << *
Ï¡
->
£cÚd


1502 << " ofà" << 
Ï¡
->
fœ¡
 << 
d’dl
;

1503 
Ï¡
->
£cÚd
->
wa™fÜ_»ad
[Ï¡->
fœ¡
].
	`push_back
(

1504 
Ãw
 
	`C_R‘ryR—d
(
this
, 
rd
, 
o£t
, 
Úfšish
, *
Œaû
) );

1509 
m­
<
loff_t
, 
BufãrH—d
*>::
™”©Ü
 
bh_™
 = 
rx
.
	`begš
();

1510 
bh_™
 !ğ
rx
.
	`’d
();

1511 ++
bh_™
) {

1512 
	`touch_bh
(
bh_™
->
£cÚd
);

1513 ià(
sucûss
 && 
Úfšish
) {

1514 
	`ldout
(
cù
, 10è<< "»adx mis£d, wa™šg oÀ" << *
bh_™
->
£cÚd


1515 << " ofà" << 
bh_™
->
fœ¡
 << 
d’dl
;

1516 
bh_™
->
£cÚd
->
wa™fÜ_»ad
[bh_™->
fœ¡
].
	`push_back
(

1517 
Ãw
 
	`C_R‘ryR—d
(
this
, 
rd
, 
o£t
, 
Úfšish
, *
Œaû
) );

1519 
by‹s_nÙ_š_ÿche
 +ğ
bh_™
->
£cÚd
->
	`Ëngth
();

1520 
sucûss
 = 
çl£
;

1523 
m­
<
loff_t
, 
BufãrH—d
*>::
™”©Ü
 
bh_™
 = 
h™s
.
	`begš
();

1524 
bh_™
 !ğ
h™s
.
	`’d
(); ++bh_it)

1526 
	`touch_bh
(
bh_™
->
£cÚd
);

1529 
	`as£¹
(!
h™s
.
	`em±y
());

1532 
m­
<
loff_t
, 
BufãrH—d
*>::
™”©Ü
 
bh_™
 = 
h™s
.
	`begš
();

1533 
bh_™
 !ğ
h™s
.
	`’d
();

1534 ++
bh_™
) {

1535 
BufãrH—d
 *
bh
 = 
bh_™
->
£cÚd
;

1536 
	`ldout
(
cù
, 10è<< "»adx h™ bh " << *
bh
 << 
d’dl
;

1537 ià(
bh
->
	`is_”rÜ
(è&& bh->
”rÜ
)

1538 
”rÜ
 = 
bh
->error;

1539 
by‹s_š_ÿche
 +ğ
bh
->
	`Ëngth
();

1541 ià(
bh
->
	`g‘_noÿche
(è&& bh->
	`is_ş—n
())

1542 
bh_Ìu_»¡
.
	`Ìu_bÙtouch
(
bh
);

1544 
	`touch_bh
(
bh
);

1546 ià(
dÚŠ“d
 &&

1547 ((
loff_t
)
ex_™
->
off£t
 <ğ
bh
->
	`¡¬t
() &&

1548 (
bh
->
	`’d
(è<=(
loff_t
)(
ex_™
->
off£t
 +ƒx_™->
Ëngth
)))) {

1549 
bh
->
	`£t_dÚŠ“d
(
Œue
);

1550 ià(
bh
->
	`is_ş—n
())

1551 
bh_Ìu_»¡
.
	`Ìu_bÙtouch
(
bh
);

1555 ià(!
”rÜ
) {

1561 
loff_t
 
İos
 = 
ex_™
->
off£t
;

1562 
m­
<
loff_t
, 
BufãrH—d
*>::
™”©Ü
 
bh_™
 = 
h™s
.
	`begš
();

1563 
	`as£¹
(
bh_™
->
£cÚd
->
	`¡¬t
(è<ğ
İos
);

1564 
ušt64_t
 
bhoff
 = 
İos
 - 
bh_™
->
£cÚd
->
	`¡¬t
();

1565 
veùÜ
<
·œ
<
ušt64_t
,ušt64_t> >::
™”©Ü
 
f_™


1566 ğ
ex_™
->
bufãr_ex‹Ás
.
	`begš
();

1567 
ušt64_t
 
foff
 = 0;

1569 
BufãrH—d
 *
bh
 = 
bh_™
->
£cÚd
;

1570 
	`as£¹
(
İos
 =ğ(
loff_t
)(
bh
->
	`¡¬t
(è+ 
bhoff
));

1572 
ušt64_t
 
Ën
 = 
¡d
::
	`mš
(
f_™
->
£cÚd
 - 
foff
, 
bh
->
	`Ëngth
(è- 
bhoff
);

1573 
	`ldout
(
cù
, 10è<< "»adx„m­ opo " << 
İos
 << ": " << *
bh
 << " +"

1574 << 
bhoff
 << " f¿g " << 
f_™
->
fœ¡
 << "~"

1575 << 
f_™
->
£cÚd
 << " +" << 
foff
 << "~" << 
Ën


1576 << 
d’dl
;

1578 
bufã¾i¡
 
b™
;

1581 ià(
bh
->
	`is_z”o
()) {

1582 
¡re_m­
[
f_™
->
fœ¡
].
	`­³nd_z”o
(
Ën
);

1584 
b™
.
	`sub¡r_of
(
bh
->
bl
,

1585 
İos
 - 
bh
->
	`¡¬t
(),

1586 
Ën
);

1587 
¡re_m­
[
f_™
->
fœ¡
].
	`şaim_­³nd
(
b™
);

1590 
İos
 +ğ
Ën
;

1591 
bhoff
 +ğ
Ën
;

1592 
foff
 +ğ
Ën
;

1593 ià(
İos
 =ğ
bh
->
	`’d
()) {

1594 ++
bh_™
;

1595 
bhoff
 = 0;

1597 ià(
foff
 =ğ
f_™
->
£cÚd
) {

1598 ++
f_™
;

1599 
foff
 = 0;

1601 ià(
bh_™
 =ğ
h™s
.
	`’d
()) ;

1602 ià(
f_™
 =ğ
ex_™
->
bufãr_ex‹Ás
.
	`’d
())

1605 
	`as£¹
(
f_™
 =ğ
ex_™
->
bufãr_ex‹Ás
.
	`’d
());

1606 
	`as£¹
(
İos
 =ğ(
loff_t
)
ex_™
->
off£t
 + (loff_tëx_™->
Ëngth
);

1609 ià(
dÚŠ“d
 && 
o
->
	`šşude_®l_ÿched_d©a
(
ex_™
->
off£t
,ƒx_™->
Ëngth
))

1610 
	`bÙtouch_ob
(
o
);

1614 ià(!
sucûss
) {

1615 ià(
³rfcouÁ”
 && 
ex‹º®_ÿÎ
) {

1616 
³rfcouÁ”
->
	`šc
(
l_objeùÿch”_d©a_»ad
, 
tÙ®_by‹s_»ad
);

1617 
³rfcouÁ”
->
	`šc
(
l_objeùÿch”_ÿche_by‹s_miss
, 
by‹s_nÙ_š_ÿche
);

1618 
³rfcouÁ”
->
	`šc
(
l_objeùÿch”_ÿche_İs_miss
);

1620 ià(
Úfšish
) {

1621 
	`ldout
(
cù
, 20è<< "»adx deã¸" << 
rd
 << 
d’dl
;

1623 
	`ldout
(
cù
, 20è<< "»adx drİ " << 
rd
 << " (no complete, but‚o waiter)"

1624 << 
d’dl
;

1625 
d–‘e
 
rd
;

1629 ià(
³rfcouÁ”
 && 
ex‹º®_ÿÎ
) {

1630 
³rfcouÁ”
->
	`šc
(
l_objeùÿch”_d©a_»ad
, 
tÙ®_by‹s_»ad
);

1631 
³rfcouÁ”
->
	`šc
(
l_objeùÿch”_ÿche_by‹s_h™
, 
by‹s_š_ÿche
);

1632 
³rfcouÁ”
->
	`šc
(
l_objeùÿch”_ÿche_İs_h™
);

1636 
	`ldout
(
cù
, 10è<< "»adx ha ®Èbufãrs" << 
d’dl
;

1639 
ušt64_t
 
pos
 = 0;

1640 ià(
rd
->
bl
 && !
”rÜ
) {

1641 
rd
->
bl
->
	`ş—r
();

1642 
m­
<
ušt64_t
,
bufã¾i¡
>::
™”©Ü
 
i
 = 
¡re_m­
.
	`begš
();

1643 
i
 !ğ
¡re_m­
.
	`’d
();

1644 ++
i
) {

1645 
	`as£¹
(
pos
 =ğ
i
->
fœ¡
);

1646 
	`ldout
(
cù
, 10è<< "»adx‡ddšg bufã¸ËÀ" << 
i
->
£cÚd
.
	`Ëngth
()

1647 << "‡ˆ" << 
pos
 << 
d’dl
;

1648 
pos
 +ğ
i
->
£cÚd
.
	`Ëngth
();

1649 
rd
->
bl
->
	`şaim_­³nd
(
i
->
£cÚd
);

1650 
	`as£¹
(
rd
->
bl
->
	`Ëngth
(è=ğ
pos
);

1652 
	`ldout
(
cù
, 10è<< "»adx„esuÉ i " << 
rd
->
bl
->
	`Ëngth
(è<< 
d’dl
;

1653 } ià(!
”rÜ
) {

1654 
	`ldout
(
cù
, 10è<< "»adx‚Øbufã¾i¡…Œ (»adah—d?), dÚe." << 
d’dl
;

1655 
m­
<
ušt64_t
,
bufã¾i¡
>::
»v”£_™”©Ü
 
i
 = 
¡re_m­
.
	`rbegš
();

1656 
pos
 = 
i
->
fœ¡
 + i->
£cÚd
.
	`Ëngth
();

1660 
»t
 = 
”rÜ
 ?ƒ¼Ü : 
pos
;

1661 
	`ldout
(
cù
, 20è<< "»adx dÚ" << 
rd
 << " " << 
»t
 << 
d’dl
;

1662 
	`as£¹
(
pos
 <ğ(
ušt64_t
è
INT_MAX
);

1664 
d–‘e
 
rd
;

1666 
	`Œim
();

1668  
»t
;

1669 
	}
}

1671 
	gObjeùCach”
::
	$»Œy_wa™šg_»ads
()

1673 
li¡
<
CÚ‹xt
 *> 
ls
;

1674 
ls
.
	`sw­
(
wa™fÜ_»ad
);

1676 !
ls
.
	`em±y
(è&& 
wa™fÜ_»ad
.empty()) {

1677 
CÚ‹xt
 *
ùx
 = 
ls
.
	`äÚt
();

1678 
ls
.
	`pİ_äÚt
();

1679 
ùx
->
	`com¶‘e
(0);

1681 
wa™fÜ_»ad
.
	`¥liû
(wa™fÜ_»ad.
	`’d
(), 
ls
);

1682 
	}
}

1684 
	gObjeùCach”
::
	$wr™ex
(
OSDWr™e
 *
wr
, 
ObjeùS‘
 *
o£t
, 
CÚ‹xt
 *
Úä“¥aû
,

1685 
ZT¿ûr
::
T¿û
 *
·»Á_Œaû
)

1687 
	`as£¹
(
lock
.
	`is_locked
());

1688 
ûph
::
»®_time
 
now
 = c•h::
»®_şock
::
	`now
();

1689 
ušt64_t
 
by‹s_wr™‹n
 = 0;

1690 
ušt64_t
 
by‹s_wr™‹n_š_æush
 = 0;

1691 
boŞ
 
dÚŠ“d
 = 
wr
->
çdvi£_æags
 & 
LIBRADOS_OP_FLAG_FADVISE_DONTNEED
;

1692 
boŞ
 
noÿche
 = 
wr
->
çdvi£_æags
 & 
LIBRADOS_OP_FLAG_FADVISE_NOCACHE
;

1694 
ZT¿ûr
::
T¿û
 
Œaû
;

1695 ià(
·»Á_Œaû
 !ğ
nuÎ±r
) {

1696 
Œaû
.
	`š™
("wr™e", &
Œaû_’dpošt
, 
·»Á_Œaû
);

1697 
Œaû
.
	`ev’t
("start");

1700 
veùÜ
<
ObjeùEx‹Á
>::
™”©Ü
 
ex_™
 = 
wr
->
ex‹Ás
.
	`begš
();

1701 
ex_™
 !ğ
wr
->
ex‹Ás
.
	`’d
();

1702 ++
ex_™
) {

1704 
sobjeù_t
 
	`soid
(
ex_™
->
oid
, 
CEPH_NOSNAP
);

1705 
Objeù
 *
o
 = 
	`g‘_objeù
(
soid
, 
ex_™
->
objeùno
, 
o£t
,ƒx_™->
Şoc
,

1706 
ex_™
->
Œunÿ‹_size
, 
o£t
->
Œunÿ‹_£q
);

1709 
BufãrH—d
 *
bh
 = 
o
->
	`m­_wr™e
(*
ex_™
, 
wr
->
jouº®_tid
);

1710 
boŞ
 
missšg
 = 
bh
->
	`is_missšg
();

1711 
bh
->
¢­c
 = 
wr
->snapc;

1713 
by‹s_wr™‹n
 +ğ
ex_™
->
Ëngth
;

1714 ià(
bh
->
	`is_tx
()) {

1715 
by‹s_wr™‹n_š_æush
 +ğ
ex_™
->
Ëngth
;

1723 
loff_t
 
İos
 = 
ex_™
->
off£t
;

1724 
veùÜ
<
·œ
<
ušt64_t
, ušt64_t> >::
™”©Ü
 
f_™


1725 ğ
ex_™
->
bufãr_ex‹Ás
.
	`begš
();

1726 
f_™
 !ğ
ex_™
->
bufãr_ex‹Ás
.
	`’d
();

1727 ++
f_™
) {

1728 
	`ldout
(
cù
, 10è<< "wr™ex wr™šg " << 
f_™
->
fœ¡
 << "~"

1729 << 
f_™
->
£cÚd
 << " iÁØ" << *
bh
 << "‡ˆ" << 
İos


1730 << 
d’dl
;

1731 
ušt64_t
 
bhoff
 = 
bh
->
	`¡¬t
(è- 
İos
;

1732 
	`as£¹
(
f_™
->
£cÚd
 <ğ
bh
->
	`Ëngth
(è- 
bhoff
);

1735 
bufã¾i¡
 
äag
;

1736 
äag
.
	`sub¡r_of
(
wr
->
bl
,

1737 
f_™
->
fœ¡
, f_™->
£cÚd
);

1740 
bufã¾i¡
 
Ãwbl
;

1741 ià(
bhoff
)

1742 
Ãwbl
.
	`sub¡r_of
(
bh
->
bl
, 0, 
bhoff
);

1743 
Ãwbl
.
	`şaim_­³nd
(
äag
);

1744 
bh
->
bl
.
	`sw­
(
Ãwbl
);

1746 
İos
 +ğ
f_™
->
£cÚd
;

1750 
	`m¬k_dœty
(
bh
);

1751 ià(
dÚŠ“d
)

1752 
bh
->
	`£t_dÚŠ“d
(
Œue
);

1753 ià(
noÿche
 && 
missšg
)

1754 
bh
->
	`£t_noÿche
(
Œue
);

1756 
	`touch_bh
(
bh
);

1758 
bh
->
Ï¡_wr™e
 = 
now
;

1760 
o
->
	`Œy_m”ge_bh
(
bh
);

1763 ià(
³rfcouÁ”
) {

1764 
³rfcouÁ”
->
	`šc
(
l_objeùÿch”_d©a_wr™‹n
, 
by‹s_wr™‹n
);

1765 ià(
by‹s_wr™‹n_š_æush
) {

1766 
³rfcouÁ”
->
	`šc
(
l_objeùÿch”_ov”wr™‹n_š_æush
,

1767 
by‹s_wr™‹n_š_æush
);

1771 
r
 = 
	`_wa™_fÜ_wr™e
(
wr
, 
by‹s_wr™‹n
, 
o£t
, &
Œaû
, 
Úä“¥aû
);

1772 
d–‘e
 
wr
;

1775 
	`Œim
();

1776  
r
;

1777 
	}
}

1779 şas 
	cObjeùCach”
::
C_Wa™FÜWr™e
 : 
public
 
CÚ‹xt
 {

1780 
public
:

1781 
	$C_Wa™FÜWr™e
(
ObjeùCach”
 *
oc
, 
ušt64_t
 
Ën
,

1782 cÚ¡ 
ZT¿ûr
::
T¿û
 &
Œaû
, 
CÚ‹xt
 *
Úfšish
) :

1783 
	`m_oc
(
oc
), 
	`m_Ën
(
Ën
), 
	`m_Œaû
(
Œaû
), 
	$m_Úfšish
(
Úfšish
) {}

1784 
	$fšish
(
r
è
ov”ride
;

1785 
´iv©e
:

1786 
ObjeùCach”
 *
m_oc
;

1787 
ušt64_t
 
m_Ën
;

1788 
ZT¿ûr
::
T¿û
 
m_Œaû
;

1789 
CÚ‹xt
 *
m_Úfšish
;

1790 
	}
};

1792 
	gObjeùCach”
::
C_Wa™FÜWr™e
::
	$fšish
(
r
)

1794 
Mu‹x
::
Lock”
 
	`l
(
m_oc
->
lock
);

1795 
m_oc
->
	`maybe_wa™_fÜ_wr™eback
(
m_Ën
, &
m_Œaû
);

1796 
m_Úfšish
->
	`com¶‘e
(
r
);

1797 
	}
}

1799 
	gObjeùCach”
::
	$maybe_wa™_fÜ_wr™eback
(
ušt64_t
 
Ën
,

1800 
ZT¿ûr
::
T¿û
 *
Œaû
)

1802 
	`as£¹
(
lock
.
	`is_locked
());

1803 
ûph
::
mÚo_time
 
¡¬t
 = c•h::
mÚo_şock
::
	`now
();

1804 
blocked
 = 0;

1811 
ušt64_t
 
max_dœty_bh
 = 
max_dœty
 >> 
BUFFER_MEMORY_WEIGHT
;

1812 
	`g‘_¡©_dœty
(è+ 
	`g‘_¡©_tx
() > 0 &&

1813 (((
ušt64_t
)(
	`g‘_¡©_dœty
(è+ 
	`g‘_¡©_tx
()) >=

1814 
max_dœty
 + 
	`g‘_¡©_dœty_wa™šg
()) ||

1815 (
dœty_Ü_tx_bh
.
	`size
() >=

1816 
max_dœty_bh
 + 
	`g‘_¡©_Ä_dœty_wa™”s
()))) {

1818 ià(
blocked
 == 0) {

1819 
Œaû
->
	`ev’t
("start wait for writeback");

1821 
	`ldout
(
cù
, 10è<< 
__func__
 << " waiting for dirty|tx "

1822 << (
	`g‘_¡©_dœty
(è+ 
	`g‘_¡©_tx
()) << " >= max "

1823 << 
max_dœty
 << " + dirty_waiting "

1824 << 
	`g‘_¡©_dœty_wa™šg
(è<< 
d’dl
;

1825 
æush”_cÚd
.
	`SigÇl
();

1826 
¡©_dœty_wa™šg
 +ğ
Ën
;

1827 ++
¡©_Ä_dœty_wa™”s
;

1828 
¡©_cÚd
.
	`Wa™
(
lock
);

1829 
¡©_dœty_wa™šg
 -ğ
Ën
;

1830 --
¡©_Ä_dœty_wa™”s
;

1831 ++
blocked
;

1832 
	`ldout
(
cù
, 10è<< 
__func__
 << " wokup" << 
d’dl
;

1834 ià(
blocked
 > 0) {

1835 
Œaû
->
	`ev’t
("finish wait for writeback");

1837 ià(
blocked
 && 
³rfcouÁ”
) {

1838 
³rfcouÁ”
->
	`šc
(
l_objeùÿch”_wr™e_İs_blocked
);

1839 
³rfcouÁ”
->
	`šc
(
l_objeùÿch”_wr™e_by‹s_blocked
, 
Ën
);

1840 
ûph
::
time¥ª
 
blocked
 = c•h::
mÚo_şock
::
	`now
(è- 
¡¬t
;

1841 
³rfcouÁ”
->
	`tšc
(
l_objeùÿch”_wr™e_time_blocked
, 
blocked
);

1843 
	}
}

1846 
	gObjeùCach”
::
	$_wa™_fÜ_wr™e
(
OSDWr™e
 *
wr
, 
ušt64_t
 
Ën
, 
ObjeùS‘
 *
o£t
,

1847 
ZT¿ûr
::
T¿û
 *
Œaû
, 
CÚ‹xt
 *
Úä“¥aû
)

1849 
	`as£¹
(
lock
.
	`is_locked
());

1850 
	`as£¹
(
Œaû
 !ğ
nuÎ±r
);

1851 
»t
 = 0;

1853 ià(
max_dœty
 > 0) {

1854 ià(
block_wr™es_upäÚt
) {

1855 
	`maybe_wa™_fÜ_wr™eback
(
Ën
, 
Œaû
);

1856 ià(
Úä“¥aû
)

1857 
Úä“¥aû
->
	`com¶‘e
(0);

1859 
	`as£¹
(
Úä“¥aû
);

1860 
fšish”
.
	`queue
(
Ãw
 
	`C_Wa™FÜWr™e
(
this
, 
Ën
, *
Œaû
, 
Úä“¥aû
));

1864 
CÚd
 
cÚd
;

1865 
boŞ
 
dÚe
 = 
çl£
;

1866 
CÚ‹xt
 *
fš
 = 
block_wr™es_upäÚt
 ?

1867 
Ãw
 
	`C_CÚd
(&
cÚd
, &
dÚe
, &
»t
è: 
Úä“¥aû
;

1868 
	`as£¹
(
fš
);

1869 
boŞ
 
æushed
 = 
	`æush_£t
(
o£t
, 
wr
->
ex‹Ás
, 
Œaû
, 
fš
);

1870 
	`as£¹
(!
æushed
);

1871 
	`ldout
(
cù
, 10è<< "wa™_fÜ_wr™wa™šg oÀwr™e-thru oà" << 
Ën


1872 << " by‹s" << 
d’dl
;

1873 ià(
block_wr™es_upäÚt
) {

1874 !
dÚe
)

1875 
cÚd
.
	`Wa™
(
lock
);

1876 
	`ldout
(
cù
, 10è<< "wa™_fÜ_wr™wokup,„‘ " << 
»t
 << 
d’dl
;

1877 ià(
Úä“¥aû
)

1878 
Úä“¥aû
->
	`com¶‘e
(
»t
);

1883 ià(
	`g‘_¡©_dœty
(è> 0 && (
ušt64_t
èg‘_¡©_dœty(è> 
rg‘_dœty
) {

1884 
	`ldout
(
cù
, 10è<< "wa™_fÜ_wr™" << 
	`g‘_¡©_dœty
() << " >arget "

1885 << 
rg‘_dœty
 << ",‚udgšg flush”" << 
d’dl
;

1886 
æush”_cÚd
.
	`SigÇl
();

1888  
»t
;

1889 
	}
}

1891 
	gObjeùCach”
::
	$æush”_’Œy
()

1893 
	`ldout
(
cù
, 10è<< "æush” s¹" << 
d’dl
;

1894 
lock
.
	`Lock
();

1895 !
æush”_¡İ
) {

1896 
loff_t
 
®l
 = 
	`g‘_¡©_tx
(è+ 
	`g‘_¡©_rx
(è+ 
	`g‘_¡©_ş—n
() +

1897 
	`g‘_¡©_dœty
();

1898 
	`ldout
(
cù
, 11) << "flusher "

1899 << 
®l
 << " / " << 
max_size
 << ": "

1900 << 
	`g‘_¡©_tx
() << "x, "

1901 << 
	`g‘_¡©_rx
() << "„x, "

1902 << 
	`g‘_¡©_ş—n
() << " clean, "

1903 << 
	`g‘_¡©_dœty
() << " dirty ("

1904 << 
rg‘_dœty
 << "arget, "

1905 << 
max_dœty
 << " max)"

1906 << 
d’dl
;

1907 
loff_t
 
aùu®
 = 
	`g‘_¡©_dœty
(è+ 
	`g‘_¡©_dœty_wa™šg
();

1909 
ZT¿ûr
::
T¿û
 
Œaû
;

1910 ià(
cù
->
_cÚf
->
osdc_blkš_Œaû_®l
) {

1911 
Œaû
.
	`š™
("æush”", &
Œaû_’dpošt
);

1912 
Œaû
.
	`ev’t
("start");

1915 ià(
aùu®
 > 0 && (
ušt64_t
èaùu® > 
rg‘_dœty
) {

1917 
	`ldout
(
cù
, 10è<< "æush” " << 
	`g‘_¡©_dœty
() << " dirty + "

1918 << 
	`g‘_¡©_dœty_wa™šg
() << " dirty_waiting >arget "

1919 << 
rg‘_dœty
 << ", flushšg somdœty bhs" << 
d’dl
;

1920 
	`æush
(&
Œaû
, 
aùu®
 - 
rg‘_dœty
);

1923 
ûph
::
»®_time
 
cutoff
 = c•h::
»®_şock
::
	`now
();

1924 
cutoff
 -ğ
max_dœty_age
;

1925 
BufãrH—d
 *
bh
 = 0;

1926 
max
 = 
MAX_FLUSH_UNDER_LOCK
;

1927 (
bh
 = 
¡©ic_ÿ¡
<
BufãrH—d
*>(
bh_Ìu_dœty
.

1928 
	`Ìu_g‘_Ãxt_expœe
())) != 0 &&

1929 
bh
->
Ï¡_wr™e
 <ğ
cutoff
 &&

1930 
max
 > 0) {

1931 
	`ldout
(
cù
, 10è<< "æush” flushšg‡ged dœty bh " << *
bh
 << 
d’dl
;

1932 ià(
sÿ‰”ed_wr™e
) {

1933 
	`bh_wr™e_adjaûnc›s
(
bh
, 
cutoff
, 
NULL
, &
max
);

1935 
	`bh_wr™e
(
bh
, 
Œaû
);

1936 --
max
;

1939 ià(!
max
) {

1941 
Œaû
.
	`ev’t
("backoff");

1942 
lock
.
	`UÆock
();

1943 
lock
.
	`Lock
();

1948 
Œaû
.
	`ev’t
("finish");

1949 ià(
æush”_¡İ
)

1952 
æush”_cÚd
.
	`Wa™IÁ”v®
(
lock
, 
	`£cÚds
(1));

1961 
»ads_out¡ªdšg
 > 0) {

1962 
	`ldout
(
cù
, 10) << "Waiting for‡ll„eadso complete. Number†eft: "

1963 << 
»ads_out¡ªdšg
 << 
d’dl
;

1964 
»ad_cÚd
.
	`Wa™
(
lock
);

1967 
lock
.
	`UÆock
();

1968 
	`ldout
(
cù
, 10è<< "æush” fšish" << 
d’dl
;

1969 
	}
}

1974 
boŞ
 
	gObjeùCach”
::
	$£t_is_em±y
(
ObjeùS‘
 *
o£t
)

1976 
	`as£¹
(
lock
.
	`is_locked
());

1977 ià(
o£t
->
objeùs
.
	`em±y
())

1978  
Œue
;

1980 
xli¡
<
Objeù
*>::
™”©Ü
 
p
 = 
o£t
->
objeùs
.
	`begš
(); !p.
	`’d
(); ++p)

1981 ià(!(*
p
)->
	`is_em±y
())

1982  
çl£
;

1984  
Œue
;

1985 
	}
}

1987 
boŞ
 
	gObjeùCach”
::
	$£t_is_ÿched
(
ObjeùS‘
 *
o£t
)

1989 
	`as£¹
(
lock
.
	`is_locked
());

1990 ià(
o£t
->
objeùs
.
	`em±y
())

1991  
çl£
;

1993 
xli¡
<
Objeù
*>::
™”©Ü
 
p
 = 
o£t
->
objeùs
.
	`begš
();

1994 !
p
.
	`’d
(); ++p) {

1995 
Objeù
 *
ob
 = *
p
;

1996 
m­
<
loff_t
,
BufãrH—d
*>::
™”©Ü
 
q
 = 
ob
->
d©a
.
	`begš
();

1997 
q
 !ğ
ob
->
d©a
.
	`’d
();

1998 ++
q
) {

1999 
BufãrH—d
 *
bh
 = 
q
->
£cÚd
;

2000 ià(!
bh
->
	`is_dœty
(è&& !bh->
	`is_tx
())

2001  
Œue
;

2005  
çl£
;

2006 
	}
}

2008 
boŞ
 
	gObjeùCach”
::
	$£t_is_dœty_Ü_comm™tšg
(
ObjeùS‘
 *
o£t
)

2010 
	`as£¹
(
lock
.
	`is_locked
());

2011 ià(
o£t
->
objeùs
.
	`em±y
())

2012  
çl£
;

2014 
xli¡
<
Objeù
*>::
™”©Ü
 
i
 = 
o£t
->
objeùs
.
	`begš
();

2015 !
i
.
	`’d
(); ++i) {

2016 
Objeù
 *
ob
 = *
i
;

2018 
m­
<
loff_t
,
BufãrH—d
*>::
™”©Ü
 
p
 = 
ob
->
d©a
.
	`begš
();

2019 
p
 !ğ
ob
->
d©a
.
	`’d
();

2020 ++
p
) {

2021 
BufãrH—d
 *
bh
 = 
p
->
£cÚd
;

2022 ià(
bh
->
	`is_dœty
(è|| bh->
	`is_tx
())

2023  
Œue
;

2027  
çl£
;

2028 
	}
}

2032 
	gObjeùCach”
::
	$purge
(
Objeù
 *
ob
)

2034 
	`as£¹
(
lock
.
	`is_locked
());

2035 
	`ldout
(
cù
, 10è<< "purg" << *
ob
 << 
d’dl
;

2037 
ob
->
	`Œunÿ‹
(0);

2038 
	}
}

2045 
boŞ
 
	gObjeùCach”
::
	$æush
(
Objeù
 *
ob
, 
loff_t
 
off£t
,†off_ˆ
Ëngth
,

2046 
ZT¿ûr
::
T¿û
 *
Œaû
)

2048 
	`as£¹
(
Œaû
 !ğ
nuÎ±r
);

2049 
	`as£¹
(
lock
.
	`is_locked
());

2050 
li¡
<
BufãrH—d
*> 
bli¡
;

2051 
boŞ
 
ş—n
 = 
Œue
;

2052 
	`ldout
(
cù
, 10è<< "æush " << *
ob
 << " " << 
off£t
 << "~" << 
Ëngth
 << 
d’dl
;

2053 
m­
<
loff_t
,
BufãrH—d
*>::
cÚ¡_™”©Ü
 
p
 = 
ob
->
	`d©a_low”_bound
(
off£t
);

2054 
p
 !ğ
ob
->
d©a
.
	`’d
();

2055 ++
p
) {

2056 
BufãrH—d
 *
bh
 = 
p
->
£cÚd
;

2057 
	`ldout
(
cù
, 20è<< "æush " << *
bh
 << 
d’dl
;

2058 ià(
Ëngth
 && 
bh
->
	`¡¬t
(è> 
off£t
+length) {

2061 ià(
bh
->
	`is_tx
()) {

2062 
ş—n
 = 
çl£
;

2065 ià(!
bh
->
	`is_dœty
()) {

2069 ià(
sÿ‰”ed_wr™e
)

2070 
bli¡
.
	`push_back
(
bh
);

2072 
	`bh_wr™e
(
bh
, *
Œaû
);

2073 
ş—n
 = 
çl£
;

2075 ià(
sÿ‰”ed_wr™e
 && !
bli¡
.
	`em±y
())

2076 
	`bh_wr™e_sÿ‰”ed
(
bli¡
);

2078  
ş—n
;

2079 
	}
}

2081 
boŞ
 
	gObjeùCach”
::
	$_æush_£t_fšish
(
C_G©h”Bud”
 *
g©h”
,

2082 
CÚ‹xt
 *
Úfšish
)

2084 
	`as£¹
(
lock
.
	`is_locked
());

2085 ià(
g©h”
->
	`has_subs
()) {

2086 
g©h”
->
	`£t_fšish”
(
Úfšish
);

2087 
g©h”
->
	`aùiv©e
();

2088  
çl£
;

2091 
	`ldout
(
cù
, 10è<< "æush_£ˆha nØdœty|tx bhs" << 
d’dl
;

2092 
Úfšish
->
	`com¶‘e
(0);

2093  
Œue
;

2094 
	}
}

2098 
boŞ
 
	gObjeùCach”
::
	$æush_£t
(
ObjeùS‘
 *
o£t
, 
CÚ‹xt
 *
Úfšish
)

2100 
	`as£¹
(
lock
.
	`is_locked
());

2101 
	`as£¹
(
Úfšish
 !ğ
NULL
);

2102 ià(
o£t
->
objeùs
.
	`em±y
()) {

2103 
	`ldout
(
cù
, 10è<< "æush_£ˆÚ " << 
o£t
 << " dÃ" << 
d’dl
;

2104 
Úfšish
->
	`com¶‘e
(0);

2105  
Œue
;

2108 
	`ldout
(
cù
, 10è<< "æush_£ˆ" << 
o£t
 << 
d’dl
;

2111 
C_G©h”Bud”
 
	`g©h”
(
cù
);

2112 
£t
<
Objeù
*> 
wa™fÜ_comm™
;

2114 
li¡
<
BufãrH—d
*> 
bli¡
;

2115 
Objeù
 *
Ï¡_ob
 = 
NULL
;

2116 
£t
<
BufãrH—d
*, BufãrH—d::
±r_É
>::
cÚ¡_™”©Ü
 
™
, 
p
, 
q
;

2121 
BufãrH—d
 
	`key
(*
o£t
->
objeùs
.
	`begš
());

2122 
™
 = 
dœty_Ü_tx_bh
.
	`low”_bound
(&
key
);

2123 
p
 = 
q
 = 
™
;

2125 
boŞ
 
backw¬ds
 = 
Œue
;

2126 ià(
™
 !ğ
dœty_Ü_tx_bh
.
	`begš
())

2127 --
™
;

2129 
backw¬ds
 = 
çl£
;

2131 ; 
p
 !ğ
dœty_Ü_tx_bh
.
	`’d
();… = 
q
) {

2132 ++
q
;

2133 
BufãrH—d
 *
bh
 = *
p
;

2134 ià(
bh
->
ob
->
o£t
 != oset)

2136 
wa™fÜ_comm™
.
	`š£¹
(
bh
->
ob
);

2137 ià(
bh
->
	`is_dœty
()) {

2138 ià(
sÿ‰”ed_wr™e
) {

2139 ià(
Ï¡_ob
 !ğ
bh
->
ob
) {

2140 ià(!
bli¡
.
	`em±y
()) {

2141 
	`bh_wr™e_sÿ‰”ed
(
bli¡
);

2142 
bli¡
.
	`ş—r
();

2144 
Ï¡_ob
 = 
bh
->
ob
;

2146 
bli¡
.
	`push_back
(
bh
);

2148 
	`bh_wr™e
(
bh
, {});

2153 ià(
backw¬ds
) {

2154 
p
 = 
q
 = 
™
; 
Œue
;… = q) {

2155 ià(
q
 !ğ
dœty_Ü_tx_bh
.
	`begš
())

2156 --
q
;

2158 
backw¬ds
 = 
çl£
;

2159 
BufãrH—d
 *
bh
 = *
p
;

2160 ià(
bh
->
ob
->
o£t
 != oset)

2162 
wa™fÜ_comm™
.
	`š£¹
(
bh
->
ob
);

2163 ià(
bh
->
	`is_dœty
()) {

2164 ià(
sÿ‰”ed_wr™e
) {

2165 ià(
Ï¡_ob
 !ğ
bh
->
ob
) {

2166 ià(!
bli¡
.
	`em±y
()) {

2167 
	`bh_wr™e_sÿ‰”ed
(
bli¡
);

2168 
bli¡
.
	`ş—r
();

2170 
Ï¡_ob
 = 
bh
->
ob
;

2172 
bli¡
.
	`push_äÚt
(
bh
);

2174 
	`bh_wr™e
(
bh
, {});

2177 ià(!
backw¬ds
)

2182 ià(
sÿ‰”ed_wr™e
 && !
bli¡
.
	`em±y
())

2183 
	`bh_wr™e_sÿ‰”ed
(
bli¡
);

2185 
£t
<
Objeù
*>::
™”©Ü
 
i
 = 
wa™fÜ_comm™
.
	`begš
();

2186 
i
 !ğ
wa™fÜ_comm™
.
	`’d
(); ++i) {

2187 
Objeù
 *
ob
 = *
i
;

2190 
	`ldout
(
cù
, 10è<< "æush_£ˆ" << 
o£t
 << " will wait for‡ckid "

2191 << 
ob
->
Ï¡_wr™e_tid
 << " oÀ" << *ob << 
d’dl
;

2192 
ob
->
wa™fÜ_comm™
[ob->
Ï¡_wr™e_tid
].
	`push_back
(
g©h”
.
	`Ãw_sub
());

2195  
	`_æush_£t_fšish
(&
g©h”
, 
Úfšish
);

2196 
	}
}

2200 
boŞ
 
	gObjeùCach”
::
æush_£t
(
ObjeùS‘
 *
o£t
, 
veùÜ
<
ObjeùEx‹Á
>& 
exv
,

2201 
ZT¿ûr
::
T¿û
 *
Œaû
, 
CÚ‹xt
 *
Úfšish
)

2203 
as£¹
(
lock
.
is_locked
());

2204 
as£¹
(
Œaû
 !ğ
nuÎ±r
);

2205 
as£¹
(
Úfšish
 !ğ
NULL
);

2206 ià(
	go£t
->
	gobjeùs
.
em±y
()) {

2207 
ldout
(
cù
, 10è<< "æush_£ˆÚ " << 
	go£t
 << " dÃ" << 
	gd’dl
;

2208 
	gÚfšish
->
com¶‘e
(0);

2209  
	gŒue
;

2212 
ldout
(
cù
, 10è<< "æush_£ˆ" << 
	go£t
 << " oÀ" << 
	gexv
.
size
()

2213 << " ObjeùEx‹Ás" << 
	gd’dl
;

2216 
C_G©h”Bud”
 
g©h”
(
cù
);

2218 
	gveùÜ
<
	gObjeùEx‹Á
>::
™”©Ü
 
p
 = 
exv
.
begš
();

2219 
	gp
 !ğ
exv
.
’d
();

2220 ++
	gp
) {

2221 
	gObjeùEx‹Á
 &
	gex
 = *
p
;

2222 
sobjeù_t
 
soid
(
ex
.
oid
, 
CEPH_NOSNAP
);

2223 ià(
	gobjeùs
[
o£t
->
poŞid
].
couÁ
(
soid
) == 0)

2225 
Objeù
 *
	gob
 = 
objeùs
[
o£t
->
poŞid
][
soid
];

2227 
ldout
(
cù
, 20è<< "æush_£ˆ" << 
	go£t
 << "ƒx " << 
	gex
 << " ob " << 
	gsoid


2228 << " " << 
	gob
 << 
	gd’dl
;

2230 ià(!
æush
(
ob
, 
ex
.
off£t
,ƒx.
Ëngth
, 
Œaû
)) {

2232 
ldout
(
cù
, 10è<< "æush_£ˆ" << 
	go£t
 << " will wait for‡ckid "

2233 << 
	gob
->
	gÏ¡_wr™e_tid
 << " oÀ" << *ob << 
	gd’dl
;

2234 
	gob
->
	gwa™fÜ_comm™
[
ob
->
Ï¡_wr™e_tid
].
push_back
(
g©h”
.
Ãw_sub
());

2238  
_æush_£t_fšish
(&
g©h”
, 
Úfšish
);

2243 
boŞ
 
	gObjeùCach”
::
	$æush_®l
(
CÚ‹xt
 *
Úfšish
)

2245 
	`as£¹
(
lock
.
	`is_locked
());

2246 
	`as£¹
(
Úfšish
 !ğ
NULL
);

2248 
	`ldout
(
cù
, 10è<< "æush_®È" << 
d’dl
;

2251 
C_G©h”Bud”
 
	`g©h”
(
cù
);

2252 
£t
<
Objeù
*> 
wa™fÜ_comm™
;

2254 
li¡
<
BufãrH—d
*> 
bli¡
;

2255 
Objeù
 *
Ï¡_ob
 = 
NULL
;

2256 
£t
<
BufãrH—d
*, BufãrH—d::
±r_É
>::
™”©Ü
 
Ãxt
, 
™
;

2257 
Ãxt
 = 
™
 = 
dœty_Ü_tx_bh
.
	`begš
();

2258 
™
 !ğ
dœty_Ü_tx_bh
.
	`’d
()) {

2259 ++
Ãxt
;

2260 
BufãrH—d
 *
bh
 = *
™
;

2261 
wa™fÜ_comm™
.
	`š£¹
(
bh
->
ob
);

2263 ià(
bh
->
	`is_dœty
()) {

2264 ià(
sÿ‰”ed_wr™e
) {

2265 ià(
Ï¡_ob
 !ğ
bh
->
ob
) {

2266 ià(!
bli¡
.
	`em±y
()) {

2267 
	`bh_wr™e_sÿ‰”ed
(
bli¡
);

2268 
bli¡
.
	`ş—r
();

2270 
Ï¡_ob
 = 
bh
->
ob
;

2272 
bli¡
.
	`push_back
(
bh
);

2274 
	`bh_wr™e
(
bh
, {});

2278 
™
 = 
Ãxt
;

2281 ià(
sÿ‰”ed_wr™e
 && !
bli¡
.
	`em±y
())

2282 
	`bh_wr™e_sÿ‰”ed
(
bli¡
);

2284 
£t
<
Objeù
*>::
™”©Ü
 
i
 = 
wa™fÜ_comm™
.
	`begš
();

2285 
i
 !ğ
wa™fÜ_comm™
.
	`’d
();

2286 ++
i
) {

2287 
Objeù
 *
ob
 = *
i
;

2290 
	`ldout
(
cù
, 10) << "flush_all will wait for‡ckid "

2291 << 
ob
->
Ï¡_wr™e_tid
 << " oÀ" << *ob << 
d’dl
;

2292 
ob
->
wa™fÜ_comm™
[ob->
Ï¡_wr™e_tid
].
	`push_back
(
g©h”
.
	`Ãw_sub
());

2295  
	`_æush_£t_fšish
(&
g©h”
, 
Úfšish
);

2296 
	}
}

2298 
	gObjeùCach”
::
	$purge_£t
(
ObjeùS‘
 *
o£t
)

2300 
	`as£¹
(
lock
.
	`is_locked
());

2301 ià(
o£t
->
objeùs
.
	`em±y
()) {

2302 
	`ldout
(
cù
, 10è<< "purge_£ˆÚ " << 
o£t
 << " dÃ" << 
d’dl
;

2306 
	`ldout
(
cù
, 10è<< "purge_£ˆ" << 
o£t
 << 
d’dl
;

2307 cÚ¡ 
boŞ
 
w”e_dœty
 = 
o£t
->
dœty_Ü_tx
 > 0;

2309 
xli¡
<
Objeù
*>::
™”©Ü
 
i
 = 
o£t
->
objeùs
.
	`begš
();

2310 !
i
.
	`’d
(); ++i) {

2311 
Objeù
 *
ob
 = *
i
;

2312 
	`purge
(
ob
);

2317 
	`as£¹
(
o£t
->
dœty_Ü_tx
 == 0);

2318 ià(
æush_£t_ÿÎback
 && 
w”e_dœty
) {

2319 
	`æush_£t_ÿÎback
(
æush_£t_ÿÎback_¬g
, 
o£t
);

2321 
	}
}

2324 
loff_t
 
	gObjeùCach”
::
	$»Ëa£
(
Objeù
 *
ob
)

2326 
	`as£¹
(
lock
.
	`is_locked
());

2327 
li¡
<
BufãrH—d
*> 
ş—n
;

2328 
loff_t
 
o_unş—n
 = 0;

2330 
m­
<
loff_t
,
BufãrH—d
*>::
™”©Ü
 
p
 = 
ob
->
d©a
.
	`begš
();

2331 
p
 !ğ
ob
->
d©a
.
	`’d
();

2332 ++
p
) {

2333 
BufãrH—d
 *
bh
 = 
p
->
£cÚd
;

2334 ià(
bh
->
	`is_ş—n
(è|| bh->
	`is_z”o
(è|| bh->
	`is_”rÜ
())

2335 
ş—n
.
	`push_back
(
bh
);

2337 
o_unş—n
 +ğ
bh
->
	`Ëngth
();

2340 
li¡
<
BufãrH—d
*>::
™”©Ü
 
p
 = 
ş—n
.
	`begš
();

2341 
p
 !ğ
ş—n
.
	`’d
();

2342 ++
p
) {

2343 
	`bh_»move
(
ob
, *
p
);

2344 
d–‘e
 *
p
;

2347 ià(
ob
->
	`ÿn_şo£
()) {

2348 
	`ldout
(
cù
, 10è<< "»Ëa£rimmšg " << *
ob
 << 
d’dl
;

2349 
	`şo£_objeù
(
ob
);

2350 
	`as£¹
(
o_unş—n
 == 0);

2354 ià(
ob
->
com¶‘e
) {

2355 
	`ldout
(
cù
, 10è<< "»Ëa£ cË¬šg com¶‘Ú " << *
ob
 << 
d’dl
;

2356 
ob
->
com¶‘e
 = 
çl£
;

2358 ià(!
ob
->
exi¡s
) {

2359 
	`ldout
(
cù
, 10è<< "»Ëa£ s‘tšgƒxi¡ Ú " << *
ob
 << 
d’dl
;

2360 
ob
->
exi¡s
 = 
Œue
;

2363  
o_unş—n
;

2364 
	}
}

2366 
loff_t
 
	gObjeùCach”
::
	$»Ëa£_£t
(
ObjeùS‘
 *
o£t
)

2368 
	`as£¹
(
lock
.
	`is_locked
());

2370 
loff_t
 
unş—n
 = 0;

2372 ià(
o£t
->
objeùs
.
	`em±y
()) {

2373 
	`ldout
(
cù
, 10è<< "»Ëa£_£ˆÚ " << 
o£t
 << " dÃ" << 
d’dl
;

2377 
	`ldout
(
cù
, 10è<< "»Ëa£_£ˆ" << 
o£t
 << 
d’dl
;

2379 
xli¡
<
Objeù
*>::
™”©Ü
 
q
;

2380 
xli¡
<
Objeù
*>::
™”©Ü
 
p
 = 
o£t
->
objeùs
.
	`begš
();

2381 !
p
.
	`’d
(); ) {

2382 
q
 = 
p
;

2383 ++
q
;

2384 
Objeù
 *
ob
 = *
p
;

2386 
loff_t
 
o_unş—n
 = 
	`»Ëa£
(
ob
);

2387 
unş—n
 +ğ
o_unş—n
;

2389 ià(
o_unş—n
)

2390 
	`ldout
(
cù
, 10è<< "»Ëa£_£ˆ" << 
o£t
 << " " << *
ob


2391 << " ha " << 
o_unş—n
 << " bytes†eft"

2392 << 
d’dl
;

2393 
p
 = 
q
;

2396 ià(
unş—n
) {

2397 
	`ldout
(
cù
, 10è<< "»Ëa£_£ˆ" << 
o£t


2398 << ", " << 
unş—n
 << " by‹ Ëá" << 
d’dl
;

2401  
unş—n
;

2402 
	}
}

2405 
ušt64_t
 
	gObjeùCach”
::
	$»Ëa£_®l
()

2407 
	`as£¹
(
lock
.
	`is_locked
());

2408 
	`ldout
(
cù
, 10è<< "»Ëa£_®l" << 
d’dl
;

2409 
ušt64_t
 
unş—n
 = 0;

2411 
veùÜ
<
ûph
::
unÜd”ed_m­
<
sobjeù_t
, 
Objeù
*> >::
™”©Ü
 
i


2412 ğ
objeùs
.
	`begš
();

2413 
i
 !ğ
objeùs
.
	`’d
()) {

2414 
ûph
::
unÜd”ed_m­
<
sobjeù_t
, 
Objeù
*>::
™”©Ü
 
p
 = 
i
->
	`begš
();

2415 
p
 !ğ
i
->
	`’d
()) {

2416 
ûph
::
unÜd”ed_m­
<
sobjeù_t
, 
Objeù
*>::
™”©Ü
 
n
 = 
p
;

2417 ++
n
;

2419 
Objeù
 *
ob
 = 
p
->
£cÚd
;

2421 
loff_t
 
o_unş—n
 = 
	`»Ëa£
(
ob
);

2422 
unş—n
 +ğ
o_unş—n
;

2424 ià(
o_unş—n
)

2425 
	`ldout
(
cù
, 10è<< "»Ëa£_®È" << *
ob


2426 << " ha " << 
o_unş—n
 << " bytes†eft"

2427 << 
d’dl
;

2428 
p
 = 
n
;

2430 ++
i
;

2433 ià(
unş—n
) {

2434 
	`ldout
(
cù
, 10è<< "»Ëa£_®Èunş—À" << 
unş—n
 << " bytes†eft"

2435 << 
d’dl
;

2438  
unş—n
;

2439 
	}
}

2441 
	gObjeùCach”
::
	$ş—r_nÚexi¡’û
(
ObjeùS‘
 *
o£t
)

2443 
	`as£¹
(
lock
.
	`is_locked
());

2444 
	`ldout
(
cù
, 10è<< "ş—r_nÚexi¡’û(è" << 
o£t
 << 
d’dl
;

2446 
xli¡
<
Objeù
*>::
™”©Ü
 
p
 = 
o£t
->
objeùs
.
	`begš
();

2447 !
p
.
	`’d
(); ++p) {

2448 
Objeù
 *
ob
 = *
p
;

2449 ià(!
ob
->
exi¡s
) {

2450 
	`ldout
(
cù
, 10è<< " s‘tšgƒxi¡ ªd com¶‘Ú " << *
ob
 << 
d’dl
;

2451 
ob
->
exi¡s
 = 
Œue
;

2452 
ob
->
com¶‘e
 = 
çl£
;

2454 
xli¡
<
C_R—dFšish
*>::
™”©Ü
 
q
 = 
ob
->
»ads
.
	`begš
();

2455 !
q
.
	`’d
(); ++q) {

2456 
C_R—dFšish
 *
comp
 = *
q
;

2457 
comp
->
	`di¡ru¡_’ÛÁ
();

2460 
	}
}

2466 
	gObjeùCach”
::
disÿrd_£t
(
ObjeùS‘
 *
o£t
, cÚ¡ 
veùÜ
<
ObjeùEx‹Á
>& 
exls
)

2468 
as£¹
(
lock
.
is_locked
());

2469 
boŞ
 
	gwas_dœty
 = 
o£t
->
dœty_Ü_tx
 > 0;

2471 
_disÿrd
(
o£t
, 
exls
, 
nuÎ±r
);

2472 
_disÿrd_fšish
(
o£t
, 
was_dœty
, 
nuÎ±r
);

2480 
	gObjeùCach”
::
disÿrd_wr™eback
(
ObjeùS‘
 *
o£t
,

2481 cÚ¡ 
veùÜ
<
ObjeùEx‹Á
>& 
exls
,

2482 
CÚ‹xt
* 
Ú_fšish
)

2484 
as£¹
(
lock
.
is_locked
());

2485 
boŞ
 
	gwas_dœty
 = 
o£t
->
dœty_Ü_tx
 > 0;

2487 
C_G©h”Bud”
 
g©h”
(
cù
);

2488 
_disÿrd
(
o£t
, 
exls
, &
g©h”
);

2490 ià(
	gg©h”
.
has_subs
()) {

2491 
	gg©h”
.
£t_fšish”
(
Ãw
 
FunùiÚCÚ‹xt
(

2492 [
this
, 
o£t
, 
was_dœty
, 
Ú_fšish
]() {

2493 
_disÿrd_fšish
(
o£t
, 
was_dœty
, 
Ú_fšish
);

2495 
	gg©h”
.
aùiv©e
();

2499 
_disÿrd_fšish
(
o£t
, 
was_dœty
, 
Ú_fšish
);

2502 
	gObjeùCach”
::
_disÿrd
(
ObjeùS‘
 *
o£t
, cÚ¡ 
veùÜ
<
ObjeùEx‹Á
>& 
exls
,

2503 
C_G©h”Bud”
* 
g©h”
)

2505 ià(
	go£t
->
	gobjeùs
.
em±y
()) {

2506 
ldout
(
cù
, 10è<< 
	g__func__
 << " oÀ" << 
	go£t
 << " dÃ" << 
	gd’dl
;

2510 
ldout
(
cù
, 10è<< 
	g__func__
 << " " << 
	go£t
 << 
	gd’dl
;

2512 auto& 
	gex
 : 
exls
) {

2513 
ldout
(
cù
, 10è<< 
	g__func__
 << " " << 
	go£t
 << "ƒx " << 
	gex
 << 
	gd’dl
;

2514 
sobjeù_t
 
soid
(
ex
.
oid
, 
CEPH_NOSNAP
);

2515 ià(
	gobjeùs
[
o£t
->
poŞid
].
couÁ
(
soid
) == 0)

2517 
Objeù
 *
	gob
 = 
objeùs
[
o£t
->
poŞid
][
soid
];

2519 
	gob
->
disÿrd
(
ex
.
off£t
,ƒx.
Ëngth
, 
g©h”
);

2523 
	gObjeùCach”
::
	$_disÿrd_fšish
(
ObjeùS‘
 *
o£t
, 
boŞ
 
was_dœty
,

2524 
CÚ‹xt
* 
Ú_fšish
)

2526 
	`as£¹
(
lock
.
	`is_locked
());

2529 ià(
æush_£t_ÿÎback
 && 
was_dœty
 && 
o£t
->
dœty_Ü_tx
 == 0) {

2530 
	`æush_£t_ÿÎback
(
æush_£t_ÿÎback_¬g
, 
o£t
);

2534 ià(
Ú_fšish
 !ğ
nuÎ±r
) {

2535 
Ú_fšish
->
	`com¶‘e
(0);

2537 
	}
}

2539 
	gObjeùCach”
::
	$v”ify_¡©s
() const

2541 
	`as£¹
(
lock
.
	`is_locked
());

2542 
	`ldout
(
cù
, 10è<< "v”ify_¡©s" << 
d’dl
;

2544 
loff_t
 
ş—n
 = 0, 
z”o
 = 0, 
dœty
 = 0, 
rx
 = 0, 
tx
 = 0, 
missšg
 = 0,

2545 
”rÜ
 = 0;

2546 
veùÜ
<
ûph
::
unÜd”ed_m­
<
sobjeù_t
, 
Objeù
*> >::
cÚ¡_™”©Ü
 
i


2547 ğ
objeùs
.
	`begš
();

2548 
i
 !ğ
objeùs
.
	`’d
();

2549 ++
i
) {

2550 
ûph
::
unÜd”ed_m­
<
sobjeù_t
, 
Objeù
*>::
cÚ¡_™”©Ü
 
p


2551 ğ
i
->
	`begš
();

2552 
p
 !ğ
i
->
	`’d
();

2553 ++
p
) {

2554 
Objeù
 *
ob
 = 
p
->
£cÚd
;

2555 
m­
<
loff_t
, 
BufãrH—d
*>::
cÚ¡_™”©Ü
 
q
 = 
ob
->
d©a
.
	`begš
();

2556 
q
 !ğ
ob
->
d©a
.
	`’d
();

2557 ++
q
) {

2558 
BufãrH—d
 *
bh
 = 
q
->
£cÚd
;

2559 
bh
->
	`g‘_¡©e
()) {

2560 
BufãrH—d
::
STATE_MISSING
:

2561 
missšg
 +ğ
bh
->
	`Ëngth
();

2563 
BufãrH—d
::
STATE_CLEAN
:

2564 
ş—n
 +ğ
bh
->
	`Ëngth
();

2566 
BufãrH—d
::
STATE_ZERO
:

2567 
z”o
 +ğ
bh
->
	`Ëngth
();

2569 
BufãrH—d
::
STATE_DIRTY
:

2570 
dœty
 +ğ
bh
->
	`Ëngth
();

2572 
BufãrH—d
::
STATE_TX
:

2573 
tx
 +ğ
bh
->
	`Ëngth
();

2575 
BufãrH—d
::
STATE_RX
:

2576 
rx
 +ğ
bh
->
	`Ëngth
();

2578 
BufãrH—d
::
STATE_ERROR
:

2579 
”rÜ
 +ğ
bh
->
	`Ëngth
();

2582 
	`ûph_abÜt
();

2588 
	`ldout
(
cù
, 10è<< " cËª " << 
ş—n
 << "„x " << 
rx
 << "x " << 
tx


2589 << " dœty " << 
dœty
 << " missšg " << 
missšg


2590 << "ƒ¼Ü " << 
”rÜ
 << 
d’dl
;

2591 
	`as£¹
(
ş—n
 =ğ
¡©_ş—n
);

2592 
	`as£¹
(
rx
 =ğ
¡©_rx
);

2593 
	`as£¹
(
tx
 =ğ
¡©_tx
);

2594 
	`as£¹
(
dœty
 =ğ
¡©_dœty
);

2595 
	`as£¹
(
missšg
 =ğ
¡©_missšg
);

2596 
	`as£¹
(
z”o
 =ğ
¡©_z”o
);

2597 
	`as£¹
(
”rÜ
 =ğ
¡©_”rÜ
);

2598 
	}
}

2600 
	gObjeùCach”
::
	$bh_¡©_add
(
BufãrH—d
 *
bh
)

2602 
	`as£¹
(
lock
.
	`is_locked
());

2603 
bh
->
	`g‘_¡©e
()) {

2604 
BufãrH—d
::
STATE_MISSING
:

2605 
¡©_missšg
 +ğ
bh
->
	`Ëngth
();

2607 
BufãrH—d
::
STATE_CLEAN
:

2608 
¡©_ş—n
 +ğ
bh
->
	`Ëngth
();

2610 
BufãrH—d
::
STATE_ZERO
:

2611 
¡©_z”o
 +ğ
bh
->
	`Ëngth
();

2613 
BufãrH—d
::
STATE_DIRTY
:

2614 
¡©_dœty
 +ğ
bh
->
	`Ëngth
();

2615 
bh
->
ob
->
dœty_Ü_tx
 +ğbh->
	`Ëngth
();

2616 
bh
->
ob
->
o£t
->
dœty_Ü_tx
 +ğbh->
	`Ëngth
();

2618 
BufãrH—d
::
STATE_TX
:

2619 
¡©_tx
 +ğ
bh
->
	`Ëngth
();

2620 
bh
->
ob
->
dœty_Ü_tx
 +ğbh->
	`Ëngth
();

2621 
bh
->
ob
->
o£t
->
dœty_Ü_tx
 +ğbh->
	`Ëngth
();

2623 
BufãrH—d
::
STATE_RX
:

2624 
¡©_rx
 +ğ
bh
->
	`Ëngth
();

2626 
BufãrH—d
::
STATE_ERROR
:

2627 
¡©_”rÜ
 +ğ
bh
->
	`Ëngth
();

2630 
	`as£¹
(0 == "bh_stat_add: invalid bufferhead state");

2632 ià(
	`g‘_¡©_dœty_wa™šg
() > 0)

2633 
¡©_cÚd
.
	`SigÇl
();

2634 
	}
}

2636 
	gObjeùCach”
::
	$bh_¡©_sub
(
BufãrH—d
 *
bh
)

2638 
	`as£¹
(
lock
.
	`is_locked
());

2639 
bh
->
	`g‘_¡©e
()) {

2640 
BufãrH—d
::
STATE_MISSING
:

2641 
¡©_missšg
 -ğ
bh
->
	`Ëngth
();

2643 
BufãrH—d
::
STATE_CLEAN
:

2644 
¡©_ş—n
 -ğ
bh
->
	`Ëngth
();

2646 
BufãrH—d
::
STATE_ZERO
:

2647 
¡©_z”o
 -ğ
bh
->
	`Ëngth
();

2649 
BufãrH—d
::
STATE_DIRTY
:

2650 
¡©_dœty
 -ğ
bh
->
	`Ëngth
();

2651 
bh
->
ob
->
dœty_Ü_tx
 -ğbh->
	`Ëngth
();

2652 
bh
->
ob
->
o£t
->
dœty_Ü_tx
 -ğbh->
	`Ëngth
();

2654 
BufãrH—d
::
STATE_TX
:

2655 
¡©_tx
 -ğ
bh
->
	`Ëngth
();

2656 
bh
->
ob
->
dœty_Ü_tx
 -ğbh->
	`Ëngth
();

2657 
bh
->
ob
->
o£t
->
dœty_Ü_tx
 -ğbh->
	`Ëngth
();

2659 
BufãrH—d
::
STATE_RX
:

2660 
¡©_rx
 -ğ
bh
->
	`Ëngth
();

2662 
BufãrH—d
::
STATE_ERROR
:

2663 
¡©_”rÜ
 -ğ
bh
->
	`Ëngth
();

2666 
	`as£¹
(0 == "bh_stat_sub: invalid bufferhead state");

2668 
	}
}

2670 
	gObjeùCach”
::
	$bh_£t_¡©e
(
BufãrH—d
 *
bh
, 
s
)

2672 
	`as£¹
(
lock
.
	`is_locked
());

2673 
¡©e
 = 
bh
->
	`g‘_¡©e
();

2675 ià(
s
 =ğ
BufãrH—d
::
STATE_DIRTY
 && 
¡©e
 != BufferHead::STATE_DIRTY) {

2676 
bh_Ìu_»¡
.
	`Ìu_»move
(
bh
);

2677 
bh_Ìu_dœty
.
	`Ìu_š£¹_tİ
(
bh
);

2678 } ià(
s
 !ğ
BufãrH—d
::
STATE_DIRTY
 &&
¡©e
 == BufferHead::STATE_DIRTY) {

2679 
bh_Ìu_dœty
.
	`Ìu_»move
(
bh
);

2680 ià(
bh
->
	`g‘_dÚŠ“d
())

2681 
bh_Ìu_»¡
.
	`Ìu_š£¹_bÙ
(
bh
);

2683 
bh_Ìu_»¡
.
	`Ìu_š£¹_tİ
(
bh
);

2686 ià((
s
 =ğ
BufãrH—d
::
STATE_TX
 ||

2687 
s
 =ğ
BufãrH—d
::
STATE_DIRTY
) &&

2688 
¡©e
 !ğ
BufãrH—d
::
STATE_TX
 &&

2689 
¡©e
 !ğ
BufãrH—d
::
STATE_DIRTY
) {

2690 
dœty_Ü_tx_bh
.
	`š£¹
(
bh
);

2691 } ià((
¡©e
 =ğ
BufãrH—d
::
STATE_TX
 ||

2692 
¡©e
 =ğ
BufãrH—d
::
STATE_DIRTY
) &&

2693 
s
 !ğ
BufãrH—d
::
STATE_TX
 &&

2694 
s
 !ğ
BufãrH—d
::
STATE_DIRTY
) {

2695 
dœty_Ü_tx_bh
.
	`”a£
(
bh
);

2698 ià(
s
 !ğ
BufãrH—d
::
STATE_ERROR
 &&

2699 
¡©e
 =ğ
BufãrH—d
::
STATE_ERROR
) {

2700 
bh
->
”rÜ
 = 0;

2704 
	`bh_¡©_sub
(
bh
);

2705 
bh
->
	`£t_¡©e
(
s
);

2706 
	`bh_¡©_add
(
bh
);

2707 
	}
}

2709 
	gObjeùCach”
::
	$bh_add
(
Objeù
 *
ob
, 
BufãrH—d
 *
bh
)

2711 
	`as£¹
(
lock
.
	`is_locked
());

2712 
	`ldout
(
cù
, 30è<< "bh_add " << *
ob
 << " " << *
bh
 << 
d’dl
;

2713 
ob
->
	`add_bh
(
bh
);

2714 ià(
bh
->
	`is_dœty
()) {

2715 
bh_Ìu_dœty
.
	`Ìu_š£¹_tİ
(
bh
);

2716 
dœty_Ü_tx_bh
.
	`š£¹
(
bh
);

2718 ià(
bh
->
	`g‘_dÚŠ“d
())

2719 
bh_Ìu_»¡
.
	`Ìu_š£¹_bÙ
(
bh
);

2721 
bh_Ìu_»¡
.
	`Ìu_š£¹_tİ
(
bh
);

2724 ià(
bh
->
	`is_tx
()) {

2725 
dœty_Ü_tx_bh
.
	`š£¹
(
bh
);

2727 
	`bh_¡©_add
(
bh
);

2728 
	}
}

2730 
	gObjeùCach”
::
	$bh_»move
(
Objeù
 *
ob
, 
BufãrH—d
 *
bh
)

2732 
	`as£¹
(
lock
.
	`is_locked
());

2733 
	`as£¹
(
bh
->
	`g‘_jouº®_tid
() == 0);

2734 
	`ldout
(
cù
, 30è<< "bh_»mov" << *
ob
 << " " << *
bh
 << 
d’dl
;

2735 
ob
->
	`»move_bh
(
bh
);

2736 ià(
bh
->
	`is_dœty
()) {

2737 
bh_Ìu_dœty
.
	`Ìu_»move
(
bh
);

2738 
dœty_Ü_tx_bh
.
	`”a£
(
bh
);

2740 
bh_Ìu_»¡
.
	`Ìu_»move
(
bh
);

2743 ià(
bh
->
	`is_tx
()) {

2744 
dœty_Ü_tx_bh
.
	`”a£
(
bh
);

2746 
	`bh_¡©_sub
(
bh
);

2747 ià(
	`g‘_¡©_dœty_wa™šg
() > 0)

2748 
¡©_cÚd
.
	`SigÇl
();

2749 
	}
}

	@osdc/ObjectCacher.h

3 #iâdeà
CEPH_OBJECTCACHER_H


4 
	#CEPH_OBJECTCACHER_H


	)

6 
	~"šşude/ty³s.h
"

7 
	~"šşude/Ìu.h
"

8 
	~"šşude/CÚ‹xt.h
"

9 
	~"šşude/xli¡.h
"

11 
	~"commÚ/CÚd.h
"

12 
	~"commÚ/Fšish”.h
"

13 
	~"commÚ/Th»ad.h
"

14 
	~"commÚ/zkš_Œaû.h
"

16 
	~"Objeù”.h
"

17 
	~"SŒ”.h
"

19 
şass
 
	gC•hCÚ‹xt
;

20 
şass
 
	gWr™ebackHªdËr
;

21 
şass
 
	gP”fCouÁ”s
;

24 
	ml_objeùÿch”_fœ¡
 = 25000,

26 
	ml_objeùÿch”_ÿche_İs_h™
,

27 
	ml_objeùÿch”_ÿche_İs_miss
,

29 
	ml_objeùÿch”_ÿche_by‹s_h™
,

31 
	ml_objeùÿch”_ÿche_by‹s_miss
,

35 
	ml_objeùÿch”_d©a_»ad
,

36 
	ml_objeùÿch”_d©a_wr™‹n
,

37 
	ml_objeùÿch”_d©a_æushed
,

38 
	ml_objeùÿch”_ov”wr™‹n_š_æush
,

41 
	ml_objeùÿch”_wr™e_İs_blocked
,

43 
	ml_objeùÿch”_wr™e_by‹s_blocked
,

46 
	ml_objeùÿch”_wr™e_time_blocked
,

50 
	ml_objeùÿch”_Ï¡
,

53 şas 
	cObjeùCach”
 {

54 
P”fCouÁ”s
 *
	m³rfcouÁ”
;

55 
	mpublic
:

56 
C•hCÚ‹xt
 *
cù
;

57 
şass
 
	mObjeù
;

58 
	mObjeùS‘
;

59 
şass
 
	mC_R—dFšish
;

61 (*
	tæush_£t_ÿÎback_t
è(*
	tp
, 
	tObjeùS‘
 *
	to£t
);

64 
	sOSDR—d
 {

65 
veùÜ
<
ObjeùEx‹Á
> 
ex‹Ás
;

66 
¢­id_t
 
¢­
;

67 
bufã¾i¡
 *
bl
;

68 
çdvi£_æags
;

69 
	`OSDR—d
(
¢­id_t
 
s
, 
bufã¾i¡
 *
b
, 
f
)

70 : 
	`¢­
(
s
), 
	`bl
(
b
), 
	`çdvi£_æags
(
f
) {}

73 
OSDR—d
 *
	$´•¬e_»ad
(
¢­id_t
 
¢­
, 
bufã¾i¡
 *
b
, 
f
) const {

74  
Ãw
 
	`OSDR—d
(
¢­
, 
b
, 
f
);

75 
	}
}

78 
	sOSDWr™e
 {

79 
	gveùÜ
<
	gObjeùEx‹Á
> 
	gex‹Ás
;

80 
SÇpCÚ‹xt
 
	g¢­c
;

81 
bufã¾i¡
 
	gbl
;

82 
	gûph
::
»®_time
 
mtime
;

83 
	gçdvi£_æags
;

84 
ûph_tid_t
 
	gjouº®_tid
;

85 
OSDWr™e
(cÚ¡ 
SÇpCÚ‹xt
& 
sc
, cÚ¡ 
bufã¾i¡
& 
b
, 
ûph
::
»®_time
 
mt
,

86 
f
, 
ûph_tid_t
 
_jouº®_tid
)

87 : 
¢­c
(
sc
), 
bl
(
b
), 
mtime
(
mt
), 
çdvi£_æags
(
f
),

88 
jouº®_tid
(
_jouº®_tid
) {}

91 
OSDWr™e
 *
	$´•¬e_wr™e
(cÚ¡ 
SÇpCÚ‹xt
& 
sc
,

92 cÚ¡ 
bufã¾i¡
 &
b
,

93 
ûph
::
»®_time
 
mt
,

94 
f
,

95 
ûph_tid_t
 
jouº®_tid
) const {

96  
Ãw
 
	`OSDWr™e
(
sc
, 
b
, 
mt
, 
f
, 
jouº®_tid
);

97 
	}
}

102 şas 
	cBufãrH—d
 : 
public
 
LRUObjeù
 {

103 
public
:

105 cÚ¡ 
STATE_MISSING
 = 0;

106 cÚ¡ 
	gSTATE_CLEAN
 = 1;

107 cÚ¡ 
	gSTATE_ZERO
 = 2;

108 cÚ¡ 
	gSTATE_DIRTY
 = 3;

109 cÚ¡ 
	gSTATE_RX
 = 4;

110 cÚ¡ 
	gSTATE_TX
 = 5;

111 cÚ¡ 
	gSTATE_ERROR
 = 6;

113 
	g´iv©e
:

115 
¡©e
;

116 
	g»f
;

118 
loff_t
 
	g¡¬t
, 
	gËngth
;

119 } 
	gex
;

120 
boŞ
 
	gdÚŠ“d
;

121 
boŞ
 
	gnoÿche
;

123 
	gpublic
:

124 
Objeù
 *
ob
;

125 
bufã¾i¡
 
	gbl
;

126 
ûph_tid_t
 
	gÏ¡_wr™e_tid
;

127 
ûph_tid_t
 
	gÏ¡_»ad_tid
;

128 
	gûph
::
»®_time
 
Ï¡_wr™e
;

129 
SÇpCÚ‹xt
 
	g¢­c
;

130 
ûph_tid_t
 
	gjouº®_tid
;

131 
	g”rÜ
;

133 
	gm­
<
	gloff_t
, 
	gli¡
<
	gCÚ‹xt
*> > 
	gwa™fÜ_»ad
;

136 
ex¶ic™
 
BufãrH—d
(
Objeù
 *
o
) :

137 
¡©e
(
STATE_MISSING
),

138 
»f
(0),

139 
dÚŠ“d
(
çl£
),

140 
noÿche
(
çl£
),

141 
ob
(
o
),

142 
Ï¡_wr™e_tid
(0),

143 
Ï¡_»ad_tid
(0),

144 
jouº®_tid
(0),

145 
”rÜ
(0) {

146 
	gex
.
	g¡¬t
 = 
ex
.
Ëngth
 = 0;

150 
loff_t
 
¡¬t
(ècÚ¡ {  
	gex
.
	g¡¬t
; }

151 
£t_¡¬t
(
loff_t
 
s
è{ 
	gex
.
	g¡¬t
 = s; }

152 
loff_t
 
Ëngth
(ècÚ¡ {  
	gex
.
	gËngth
; }

153 
£t_Ëngth
(
loff_t
 
l
è{ 
	gex
.
	gËngth
 =†; }

154 
loff_t
 
’d
(ècÚ¡ {  
	gex
.
	g¡¬t
 +ƒx.
	gËngth
; }

155 
loff_t
 
Ï¡
(ècÚ¡ {  
’d
() - 1; }

158 
£t_¡©e
(
s
) {

159 ià(
	gs
 =ğ
STATE_RX
 || 
s
 =ğ
STATE_TX
è
g‘
();

160 ià(
	g¡©e
 =ğ
STATE_RX
 || 
¡©e
 =ğ
STATE_TX
è
put
();

161 
	g¡©e
 = 
s
;

163 
g‘_¡©e
(ècÚ¡ {  
	g¡©e
; }

165 
šlše
 
ûph_tid_t
 
g‘_jouº®_tid
() const {

166  
	gjouº®_tid
;

168 
šlše
 
£t_jouº®_tid
(
ûph_tid_t
 
_jouº®_tid
) {

169 
	gjouº®_tid
 = 
_jouº®_tid
;

172 
boŞ
 
is_missšg
(ècÚ¡ {  
	g¡©e
 =ğ
STATE_MISSING
; }

173 
boŞ
 
is_dœty
(ècÚ¡ {  
	g¡©e
 =ğ
STATE_DIRTY
; }

174 
boŞ
 
is_ş—n
(ècÚ¡ {  
	g¡©e
 =ğ
STATE_CLEAN
; }

175 
boŞ
 
is_z”o
(ècÚ¡ {  
	g¡©e
 =ğ
STATE_ZERO
; }

176 
boŞ
 
is_tx
(ècÚ¡ {  
	g¡©e
 =ğ
STATE_TX
; }

177 
boŞ
 
is_rx
(ècÚ¡ {  
	g¡©e
 =ğ
STATE_RX
; }

178 
boŞ
 
is_”rÜ
(ècÚ¡ {  
	g¡©e
 =ğ
STATE_ERROR
; }

181 
g‘
() {

182 
as£¹
(
»f
 >= 0);

183 ià(
	g»f
 =ğ0è
Ìu_pš
();

184  ++
	g»f
;

186 
put
() {

187 
as£¹
(
»f
 > 0);

188 ià(
	g»f
 =ğ1è
Ìu_uÅš
();

189 --
	g»f
;

190  
	g»f
;

193 
£t_dÚŠ“d
(
boŞ
 
v
) {

194 
	gdÚŠ“d
 = 
v
;

196 
boŞ
 
g‘_dÚŠ“d
() const {

197  
	gdÚŠ“d
;

200 
£t_noÿche
(
boŞ
 
v
) {

201 
	gnoÿche
 = 
v
;

203 
boŞ
 
g‘_noÿche
() const {

204  
	gnoÿche
;

207 
šlše
 
boŞ
 
ÿn_m”ge_jouº®
(
BufãrH—d
 *
bh
) const {

208  (
g‘_jouº®_tid
(è=ğ
bh
->get_journal_tid());

211 
	s±r_É
 {

212 
boŞ
 
İ”©Ü
()(cÚ¡ 
BufãrH—d
* 
	gl
, cÚ¡ BufãrH—d* 
	gr
) const {

213 cÚ¡ 
Objeù
 *
	glob
 = 
l
->
ob
;

214 cÚ¡ 
Objeù
 *
	grob
 = 
r
->
ob
;

215 cÚ¡ 
ObjeùS‘
 *
	glo£t
 = 
lob
->
o£t
;

216 cÚ¡ 
ObjeùS‘
 *
	gro£t
 = 
rob
->
o£t
;

217 ià(
	glo£t
 !ğ
ro£t
)

218  
lo£t
 < 
ro£t
;

219 ià(
	glob
 !ğ
rob
)

220  
lob
 < 
rob
;

221 ià(
	gl
->
¡¬t
(è!ğ
r
->start())

222  
l
->
¡¬t
(è< 
r
->start();

223  
	gl
 < 
	gr
;

229 şas 
	cObjeù
 : 
public
 
LRUObjeù
 {

230 
´iv©e
:

232 
»f
;

233 
ObjeùCach”
 *
	goc
;

234 
sobjeù_t
 
	goid
;

235 
ä›nd
 
	gObjeùS‘
;

237 
	gpublic
:

238 
ušt64_t
 
objeù_no
;

239 
ObjeùS‘
 *
	go£t
;

240 
	gxli¡
<
	gObjeù
*>::
™em
 
£t_™em
;

241 
objeù_loÿtÜ_t
 
	gŞoc
;

242 
ušt64_t
 
	gŒunÿ‹_size
, 
	gŒunÿ‹_£q
;

244 
boŞ
 
	gcom¶‘e
;

245 
boŞ
 
	gexi¡s
;

247 
	gm­
<
	gloff_t
, 
	gBufãrH—d
*> 
	gd©a
;

249 
ûph_tid_t
 
	gÏ¡_wr™e_tid
;

250 
ûph_tid_t
 
	gÏ¡_comm™_tid
;

252 
	gdœty_Ü_tx
;

254 
	gm­
< 
	gûph_tid_t
, 
	gli¡
<
	gCÚ‹xt
*> > 
	gwa™fÜ_comm™
;

255 
	gxli¡
<
	gC_R—dFšish
*> 
	g»ads
;

257 
Objeù
(cÚ¡ Objeù&èğ
d–‘e
;

258 
	gObjeù
& 
	gİ”©Ü
=(cÚ¡ 
Objeù
&èğ
d–‘e
;

260 
Objeù
(
ObjeùCach”
 *
_oc
, 
sobjeù_t
 
o
, 
ušt64_t
 
Úo
, 
ObjeùS‘
 *
os
,

261 
objeù_loÿtÜ_t
& 
l
, 
ušt64_t
 
ts
, ušt64_ˆ
tq
) :

262 
»f
(0),

263 
oc
(
_oc
),

264 
oid
(
o
), 
objeù_no
(
Úo
), 
o£t
(
os
), 
£t_™em
(
this
), 
Şoc
(
l
),

265 
Œunÿ‹_size
(
ts
), 
Œunÿ‹_£q
(
tq
),

266 
com¶‘e
(
çl£
), 
exi¡s
(
Œue
),

267 
Ï¡_wr™e_tid
(0), 
Ï¡_comm™_tid
(0),

268 
dœty_Ü_tx
(0) {

270 
	gos
->
	gobjeùs
.
push_back
(&
£t_™em
);

272 ~
Objeù
() {

273 
	g»ads
.
ş—r
();

274 
as£¹
(
»f
 == 0);

275 
as£¹
(
d©a
.
em±y
());

276 
as£¹
(
dœty_Ü_tx
 == 0);

277 
	g£t_™em
.
»move_my£lf
();

280 
sobjeù_t
 
g‘_soid
(ècÚ¡ {  
	goid
; }

281 
objeù_t
 
g‘_oid
(è{  
	goid
.oid; }

282 
¢­id_t
 
g‘_¢­
(è{  
	goid
.
	g¢­
; }

283 
ObjeùS‘
 *
g‘_objeù_£t
(ècÚ¡ {  
	go£t
; }

284 
¡ršg
 
g‘_Çme¥aû
(è{  
	gŞoc
.
	gn¥aû
; }

285 
ušt64_t
 
g‘_objeù_numb”
(ècÚ¡ {  
	gobjeù_no
; }

287 cÚ¡ 
	gobjeù_loÿtÜ_t
& 
g‘_Şoc
(ècÚ¡ {  
	gŞoc
; }

288 
£t_objeù_loÿtÜ
(
objeù_loÿtÜ_t
& 
l
è{ 
	gŞoc
 =†; }

290 
boŞ
 
ÿn_şo£
() const {

291 ià(
Ìu_is_expœ—bË
()) {

292 
as£¹
(
d©a
.
em±y
());

293 
as£¹
(
wa™fÜ_comm™
.
em±y
());

294  
	gŒue
;

296  
	gçl£
;

305 
aud™_bufãrs
();

313 
	gm­
<
	gloff_t
,
	gBufãrH—d
*>::
cÚ¡_™”©Ü
 
d©a_low”_bound
(
loff_t
 
off£t
) const {

314 
m­
<
loff_t
,
	gBufãrH—d
*>::
cÚ¡_™”©Ü
 
p
 = 
d©a
.
low”_bound
(
off£t
);

315 ià(
	gp
 !ğ
d©a
.
begš
() &&

316 (
p
 =ğ
d©a
.
’d
(è||…->
fœ¡
 > 
off£t
)) {

317 --
p
;

318 ià(
	gp
->
	gfœ¡
 +…->
	g£cÚd
->
Ëngth
(è<ğ
off£t
)

319 ++
p
;

321  
	gp
;

326 
add_bh
(
BufãrH—d
 *
bh
) {

327 ià(
	gd©a
.
em±y
())

328 
g‘
();

329 
as£¹
(
d©a
.
couÁ
(
bh
->
¡¬t
()) == 0);

330 
	gd©a
[
bh
->
¡¬t
()] = bh;

332 
»move_bh
(
BufãrH—d
 *
bh
) {

333 
as£¹
(
d©a
.
couÁ
(
bh
->
¡¬t
()));

334 
	gd©a
.
”a£
(
bh
->
¡¬t
());

335 ià(
	gd©a
.
em±y
())

336 
put
();

339 
boŞ
 
is_em±y
(ècÚ¡ {  
	gd©a
.
em±y
(); }

342 
BufãrH—d
 *
¥l™
(BufãrH—d *
bh
, 
loff_t
 
off
);

343 
m”ge_Ëá
(
BufãrH—d
 *
Ëá
, BufãrH—d *
right
);

344 
boŞ
 
ÿn_m”ge_bh
(
BufãrH—d
 *
Ëá
, BufãrH—d *
right
);

345 
Œy_m”ge_bh
(
BufãrH—d
 *
bh
);

347 
boŞ
 
is_ÿched
(
loff_t
 
off
,†off_ˆ
Ën
) const;

348 
boŞ
 
šşude_®l_ÿched_d©a
(
loff_t
 
off
,†off_ˆ
Ën
);

349 
m­_»ad
(
ObjeùEx‹Á
 &
ex
,

350 
m­
<
loff_t
, 
BufãrH—d
*>& 
h™s
,

351 
m­
<
loff_t
, 
BufãrH—d
*>& 
missšg
,

352 
m­
<
loff_t
, 
BufãrH—d
*>& 
rx
,

353 
m­
<
loff_t
, 
BufãrH—d
*>& 
”rÜs
);

354 
BufãrH—d
 *
m­_wr™e
(
ObjeùEx‹Á
 &
ex
, 
ûph_tid_t
 
tid
);

356 
»¶aû_jouº®_tid
(
BufãrH—d
 *
bh
, 
ûph_tid_t
 
tid
);

357 
Œunÿ‹
(
loff_t
 
s
);

358 
disÿrd
(
loff_t
 
off
,†off_ˆ
Ën
, 
C_G©h”Bud”
* 
comm™_g©h”
);

361 
g‘
() {

362 
as£¹
(
»f
 >= 0);

363 ià(
	g»f
 =ğ0è
Ìu_pš
();

364  ++
	g»f
;

366 
put
() {

367 
as£¹
(
»f
 > 0);

368 ià(
	g»f
 =ğ1è
Ìu_uÅš
();

369 --
	g»f
;

370  
	g»f
;

375 
	sObjeùS‘
 {

376 *
	g·»Á
;

378 
šod’o_t
 
	gšo
;

379 
ušt64_t
 
	gŒunÿ‹_£q
, 
	gŒunÿ‹_size
;

381 
št64_t
 
	gpoŞid
;

382 
	gxli¡
<
	gObjeù
*> 
	gobjeùs
;

384 
	gdœty_Ü_tx
;

385 
boŞ
 
	g»tuº_’ÛÁ
;

387 
ObjeùS‘
(*
p
, 
št64_t
 
_poŞid
, 
šod’o_t
 
i
)

388 : 
·»Á
(
p
), 
šo
(
i
), 
Œunÿ‹_£q
(0),

389 
Œunÿ‹_size
(0), 
poŞid
(
_poŞid
), 
dœty_Ü_tx
(0),

390 
»tuº_’ÛÁ
(
çl£
) {}

397 
	g´iv©e
:

398 
Wr™ebackHªdËr
& 
wr™eback_hªdËr
;

399 
boŞ
 
	gsÿ‰”ed_wr™e
;

401 
¡ršg
 
	gÇme
;

402 
	gMu‹x
& 
	glock
;

404 
ušt64_t
 
	gmax_dœty
, 
	grg‘_dœty
, 
	gmax_size
, 
	gmax_objeùs
;

405 
	gûph
::
time¥ª
 
max_dœty_age
;

406 
boŞ
 
	gblock_wr™es_upäÚt
;

408 
	gZT¿ûr
::
Endpošt
 
Œaû_’dpošt
;

410 
æush_£t_ÿÎback_t
 
	gæush_£t_ÿÎback
;

411 *
	gæush_£t_ÿÎback_¬g
;

414 
	gveùÜ
<
	gûph
::
unÜd”ed_m­
<
sobjeù_t
, 
	gObjeù
*> > 
	gobjeùs
;

416 
	gli¡
<
	gCÚ‹xt
*> 
	gwa™fÜ_»ad
;

418 
ûph_tid_t
 
	gÏ¡_»ad_tid
;

420 
	g£t
<
	gBufãrH—d
*, BufãrH—d::
±r_É
> 
dœty_Ü_tx_bh
;

421 
LRU
 
	gbh_Ìu_dœty
, 
	gbh_Ìu_»¡
;

422 
LRU
 
	gob_Ìu
;

424 
CÚd
 
	gæush”_cÚd
;

425 
boŞ
 
	gæush”_¡İ
;

426 
æush”_’Œy
();

427 şas 
	cFlush”Th»ad
 : 
public
 
Th»ad
 {

428 
ObjeùCach”
 *
oc
;

429 
	gpublic
:

430 
ex¶ic™
 
Flush”Th»ad
(
ObjeùCach”
 *
o
è: 
oc
(o) {}

431 *
’Œy
(è
ov”ride
 {

432 
oc
->
æush”_’Œy
();

435 } 
	gæush”_th»ad
;

437 
Fšish”
 
	gfšish”
;

440 
Objeù
 *
	$g‘_objeù_maybe
(
sobjeù_t
 
oid
, 
objeù_loÿtÜ_t
 &
l
) {

442 ià(((
ušt32_t
)
l
.
poŞ
 < 
objeùs
.
	`size
()) &&

443 (
objeùs
[
l
.
poŞ
].
	`couÁ
(
oid
)))

444  
objeùs
[
l
.
poŞ
][
oid
];

445  
NULL
;

446 
	}
}

448 
Objeù
 *
g‘_objeù
(
sobjeù_t
 
oid
, 
ušt64_t
 
objeù_no
, 
ObjeùS‘
 *
o£t
,

449 
objeù_loÿtÜ_t
 &
l
, 
ušt64_t
 
Œunÿ‹_size
,

450 
ušt64_t
 
Œunÿ‹_£q
);

451 
şo£_objeù
(
Objeù
 *
ob
);

454 
CÚd
 
	g¡©_cÚd
;

456 
loff_t
 
	g¡©_ş—n
;

457 
loff_t
 
	g¡©_z”o
;

458 
loff_t
 
	g¡©_dœty
;

459 
loff_t
 
	g¡©_rx
;

460 
loff_t
 
	g¡©_tx
;

461 
loff_t
 
	g¡©_missšg
;

462 
loff_t
 
	g¡©_”rÜ
;

463 
loff_t
 
	g¡©_dœty_wa™šg
;

465 
size_t
 
	g¡©_Ä_dœty_wa™”s
;

467 
	$v”ify_¡©s
() const;

469 
	`bh_¡©_add
(
BufãrH—d
 *
bh
);

470 
	`bh_¡©_sub
(
BufãrH—d
 *
bh
);

471 
loff_t
 
	$g‘_¡©_tx
(ècÚ¡ {  
¡©_tx
; 
	}
}

472 
loff_t
 
	$g‘_¡©_rx
(ècÚ¡ {  
¡©_rx
; 
	}
}

473 
loff_t
 
	$g‘_¡©_dœty
(ècÚ¡ {  
¡©_dœty
; 
	}
}

474 
loff_t
 
	$g‘_¡©_ş—n
(ècÚ¡ {  
¡©_ş—n
; 
	}
}

475 
loff_t
 
	$g‘_¡©_z”o
(ècÚ¡ {  
¡©_z”o
; 
	}
}

476 
loff_t
 
	$g‘_¡©_dœty_wa™šg
(ècÚ¡ {  
¡©_dœty_wa™šg
; 
	}
}

477 
size_t
 
	$g‘_¡©_Ä_dœty_wa™”s
(ècÚ¡ {  
¡©_Ä_dœty_wa™”s
; 
	}
}

479 
	$touch_bh
(
BufãrH—d
 *
bh
) {

480 ià(
bh
->
	`is_dœty
())

481 
bh_Ìu_dœty
.
	`Ìu_touch
(
bh
);

483 
bh_Ìu_»¡
.
	`Ìu_touch
(
bh
);

485 
bh
->
	`£t_dÚŠ“d
(
çl£
);

486 
bh
->
	`£t_noÿche
(
çl£
);

487 
	`touch_ob
(
bh
->
ob
);

488 
	}
}

489 
	$touch_ob
(
Objeù
 *
ob
) {

490 
ob_Ìu
.
	`Ìu_touch
(
ob
);

491 
	}
}

492 
	$bÙtouch_ob
(
Objeù
 *
ob
) {

493 
ob_Ìu
.
	`Ìu_bÙtouch
(
ob
);

494 
	}
}

497 
bh_£t_¡©e
(
BufãrH—d
 *
bh
, 
s
);

498 
	$cİy_bh_¡©e
(
BufãrH—d
 *
bh1
, BufãrH—d *
bh2
) {

499 
	`bh_£t_¡©e
(
bh2
, 
bh1
->
	`g‘_¡©e
());

500 
	}
}

502 
	$m¬k_missšg
(
BufãrH—d
 *
bh
) {

503 
	`bh_£t_¡©e
(
bh
,
BufãrH—d
::
STATE_MISSING
);

504 
	}
}

505 
	$m¬k_ş—n
(
BufãrH—d
 *
bh
) {

506 
	`bh_£t_¡©e
(
bh
, 
BufãrH—d
::
STATE_CLEAN
);

507 
	}
}

508 
	$m¬k_z”o
(
BufãrH—d
 *
bh
) {

509 
	`bh_£t_¡©e
(
bh
, 
BufãrH—d
::
STATE_ZERO
);

510 
	}
}

511 
	$m¬k_rx
(
BufãrH—d
 *
bh
) {

512 
	`bh_£t_¡©e
(
bh
, 
BufãrH—d
::
STATE_RX
);

513 
	}
}

514 
	$m¬k_tx
(
BufãrH—d
 *
bh
) {

515 
	`bh_£t_¡©e
(
bh
, 
BufãrH—d
::
STATE_TX
); 
	}
}

516 
	$m¬k_”rÜ
(
BufãrH—d
 *
bh
) {

517 
	`bh_£t_¡©e
(
bh
, 
BufãrH—d
::
STATE_ERROR
);

518 
	}
}

519 
	$m¬k_dœty
(
BufãrH—d
 *
bh
) {

520 
	`bh_£t_¡©e
(
bh
, 
BufãrH—d
::
STATE_DIRTY
);

521 
bh_Ìu_dœty
.
	`Ìu_touch
(
bh
);

523 
	}
}

525 
bh_add
(
Objeù
 *
ob
, 
BufãrH—d
 *
bh
);

526 
bh_»move
(
Objeù
 *
ob
, 
BufãrH—d
 *
bh
);

529 
bh_»ad
(
BufãrH—d
 *
bh
, 
İ_æags
,

530 cÚ¡ 
ZT¿ûr
::
T¿û
 &
·»Á_Œaû
);

531 
bh_wr™e
(
BufãrH—d
 *
bh
, cÚ¡ 
ZT¿ûr
::
T¿û
 &
·»Á_Œaû
);

532 
bh_wr™e_sÿ‰”ed
(
li¡
<
BufãrH—d
*>& 
bli¡
);

533 
bh_wr™e_adjaûnc›s
(
BufãrH—d
 *
bh
, 
ûph
::
»®_time
 
cutoff
,

534 
št64_t
 *
amouÁ
, *
max_couÁ
);

536 
Œim
();

537 
æush
(
ZT¿ûr
::
T¿û
 *
Œaû
, 
loff_t
 
amouÁ
=0);

550 
boŞ
 
æush
(
Objeù
 *
o
, 
loff_t
 
off
,†off_ˆ
Ën
,

551 
ZT¿ûr
::
T¿û
 *
Œaû
);

552 
loff_t
 
»Ëa£
(
Objeù
 *
o
);

553 
purge
(
Objeù
 *
o
);

555 
št64_t
 
	g»ads_out¡ªdšg
;

556 
CÚd
 
	g»ad_cÚd
;

558 
_»adx
(
OSDR—d
 *
rd
, 
ObjeùS‘
 *
o£t
, 
CÚ‹xt
 *
Úfšish
,

559 
boŞ
 
ex‹º®_ÿÎ
, 
ZT¿ûr
::
T¿û
 *
Œaû
);

560 
»Œy_wa™šg_»ads
();

562 
	gpublic
:

563 
bh_»ad_fšish
(
št64_t
 
poŞid
, 
sobjeù_t
 
oid
, 
ûph_tid_t
 
tid
,

564 
loff_t
 
off£t
, 
ušt64_t
 
Ëngth
,

565 
bufã¾i¡
 &
bl
, 
r
,

566 
boŞ
 
Œu¡_’ÛÁ
);

567 
bh_wr™e_comm™
(
št64_t
 
poŞid
, 
sobjeù_t
 
oid
,

568 
veùÜ
<
·œ
<
loff_t
, 
ušt64_t
> >& 
¿nges
,

569 
ûph_tid_t
 
t
, 
r
);

571 
şass
 
	gC_Wr™eComm™
;

572 
şass
 
	gC_Wa™FÜWr™e
;

574 
³rf_¡¬t
();

575 
³rf_¡İ
();

579 
ObjeùCach”
(
C•hCÚ‹xt
 *
cù_
, 
¡ršg
 
Çme
, 
Wr™ebackHªdËr
& 
wb
, 
Mu‹x
& 
l
,

580 
æush_£t_ÿÎback_t
 
æush_ÿÎback
,

581 *
æush_ÿÎback_¬g
,

582 
ušt64_t
 
max_by‹s
, ušt64_ˆ
max_objeùs
,

583 
ušt64_t
 
max_dœty
, ušt64_ˆ
rg‘_dœty
, 
max_age
,

584 
boŞ
 
block_wr™es_upäÚt
);

585 ~
ObjeùCach”
();

587 
	$¡¬t
() {

588 
æush”_th»ad
.
	`ü—‹
("flusher");

589 
	}
}

590 
	$¡İ
() {

591 
	`as£¹
(
æush”_th»ad
.
	`is_¡¬‹d
());

592 
lock
.
	`Lock
();

593 
æush”_¡İ
 = 
Œue
;

594 
æush”_cÚd
.
	`SigÇl
();

595 
lock
.
	`UÆock
();

596 
æush”_th»ad
.
	`još
();

597 
	}
}

600 
şass
 
	gC_R‘ryR—d
;

609 
»adx
(
OSDR—d
 *
rd
, 
ObjeùS‘
 *
o£t
, 
CÚ‹xt
 *
Úfšish
,

610 
ZT¿ûr
::
T¿û
 *
·»Á_Œaû
 = 
nuÎ±r
);

611 
wr™ex
(
OSDWr™e
 *
wr
, 
ObjeùS‘
 *
o£t
, 
CÚ‹xt
 *
Úä“¥aû
,

612 
ZT¿ûr
::
T¿û
 *
·»Á_Œaû
 = 
nuÎ±r
);

613 
boŞ
 
is_ÿched
(
ObjeùS‘
 *
o£t
, 
veùÜ
<
ObjeùEx‹Á
>& 
ex‹Ás
,

614 
¢­id_t
 
¢­id
);

616 
	g´iv©e
:

618 
_wa™_fÜ_wr™e
(
OSDWr™e
 *
wr
, 
ušt64_t
 
Ën
, 
ObjeùS‘
 *
o£t
,

619 
ZT¿ûr
::
T¿û
 *
Œaû
, 
CÚ‹xt
 *
Úä“¥aû
);

620 
maybe_wa™_fÜ_wr™eback
(
ušt64_t
 
Ën
, 
ZT¿ûr
::
T¿û
 *
Œaû
);

621 
boŞ
 
_æush_£t_fšish
(
C_G©h”Bud”
 *
g©h”
, 
CÚ‹xt
 *
Úfšish
);

623 
_disÿrd
(
ObjeùS‘
 *
o£t
, cÚ¡ 
veùÜ
<
ObjeùEx‹Á
>& 
exls
,

624 
C_G©h”Bud”
* 
g©h”
);

625 
_disÿrd_fšish
(
ObjeùS‘
 *
o£t
, 
boŞ
 
was_dœty
, 
CÚ‹xt
* 
Ú_fšish
);

627 
	gpublic
:

628 
boŞ
 
£t_is_em±y
(
ObjeùS‘
 *
o£t
);

629 
boŞ
 
£t_is_ÿched
(
ObjeùS‘
 *
o£t
);

630 
boŞ
 
£t_is_dœty_Ü_comm™tšg
(
ObjeùS‘
 *
o£t
);

632 
boŞ
 
æush_£t
(
ObjeùS‘
 *
o£t
, 
CÚ‹xt
 *
Úfšish
=0);

633 
boŞ
 
æush_£t
(
ObjeùS‘
 *
o£t
, 
veùÜ
<
ObjeùEx‹Á
>& 
ex
,

634 
ZT¿ûr
::
T¿û
 *
Œaû
, 
CÚ‹xt
 *
Úfšish
 = 0);

635 
boŞ
 
æush_®l
(
CÚ‹xt
 *
Úfšish
 = 0);

637 
purge_£t
(
ObjeùS‘
 *
o£t
);

640 
loff_t
 
»Ëa£_£t
(
ObjeùS‘
 *
o£t
);

641 
ušt64_t
 
»Ëa£_®l
();

643 
disÿrd_£t
(
ObjeùS‘
 *
o£t
, cÚ¡ 
veùÜ
<
ObjeùEx‹Á
>& 
ex
);

644 
disÿrd_wr™eback
(
ObjeùS‘
 *
o£t
, cÚ¡ 
veùÜ
<
ObjeùEx‹Á
>& 
ex
,

645 
CÚ‹xt
* 
Ú_fšish
);

653 
ş—r_nÚexi¡’û
(
ObjeùS‘
 *
o£t
);

657 
	$£t_max_dœty
(
ušt64_t
 
v
) {

658 
max_dœty
 = 
v
;

659 
	}
}

660 
	$£t_rg‘_dœty
(
št64_t
 
v
) {

661 
rg‘_dœty
 = 
v
;

662 
	}
}

663 
	$£t_max_size
(
št64_t
 
v
) {

664 
max_size
 = 
v
;

665 
	}
}

666 
	$£t_max_dœty_age
(
a
) {

667 
max_dœty_age
 = 
	`make_time¥ª
(
a
);

668 
	}
}

669 
	$£t_max_objeùs
(
št64_t
 
v
) {

670 
max_objeùs
 = 
v
;

671 
	}
}

677 
	$fe_is_ÿched
(
ObjeùS‘
 *
o£t
, 
fe_Ïyout_t
 *
Ïyout
,

678 
¢­id_t
 
¢­id
, 
loff_t
 
off£t
, 
ušt64_t
 
Ën
) {

679 
veùÜ
<
ObjeùEx‹Á
> 
ex‹Ás
;

680 
SŒ”
::
	`fe_to_ex‹Ás
(
cù
, 
o£t
->
šo
, 
Ïyout
, 
off£t
, 
Ën
,

681 
o£t
->
Œunÿ‹_size
, 
ex‹Ás
);

682  
	`is_ÿched
(
o£t
, 
ex‹Ás
, 
¢­id
);

683 
	}
}

685 
	$fe_»ad
(
ObjeùS‘
 *
o£t
, 
fe_Ïyout_t
 *
Ïyout
, 
¢­id_t
 
¢­id
,

686 
loff_t
 
off£t
, 
ušt64_t
 
Ën
, 
bufã¾i¡
 *
bl
, 
æags
,

687 
CÚ‹xt
 *
Úfšish
) {

688 
OSDR—d
 *
rd
 = 
	`´•¬e_»ad
(
¢­id
, 
bl
, 
æags
);

689 
SŒ”
::
	`fe_to_ex‹Ás
(
cù
, 
o£t
->
šo
, 
Ïyout
, 
off£t
, 
Ën
,

690 
o£t
->
Œunÿ‹_size
, 
rd
->
ex‹Ás
);

691  
	`»adx
(
rd
, 
o£t
, 
Úfšish
);

692 
	}
}

694 
	$fe_wr™e
(
ObjeùS‘
 *
o£t
, 
fe_Ïyout_t
 *
Ïyout
,

695 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
, 
loff_t
 
off£t
, 
ušt64_t
 
Ën
,

696 
bufã¾i¡
& 
bl
, 
ûph
::
»®_time
 
mtime
, 
æags
) {

697 
OSDWr™e
 *
wr
 = 
	`´•¬e_wr™e
(
¢­c
, 
bl
, 
mtime
, 
æags
, 0);

698 
SŒ”
::
	`fe_to_ex‹Ás
(
cù
, 
o£t
->
šo
, 
Ïyout
, 
off£t
, 
Ën
,

699 
o£t
->
Œunÿ‹_size
, 
wr
->
ex‹Ás
);

700  
	`wr™ex
(
wr
, 
o£t
, 
NULL
);

701 
	}
}

703 
boŞ
 
	$fe_æush
(
ObjeùS‘
 *
o£t
, 
fe_Ïyout_t
 *
Ïyout
,

704 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
, 
loff_t
 
off£t
, 
ušt64_t
 
Ën
,

705 
CÚ‹xt
 *
Úfšish
) {

706 
veùÜ
<
ObjeùEx‹Á
> 
ex‹Ás
;

707 
SŒ”
::
	`fe_to_ex‹Ás
(
cù
, 
o£t
->
šo
, 
Ïyout
, 
off£t
, 
Ën
,

708 
o£t
->
Œunÿ‹_size
, 
ex‹Ás
);

709 
ZT¿ûr
::
T¿û
 
Œaû
;

710  
	`æush_£t
(
o£t
, 
ex‹Ás
, &
Œaû
, 
Úfšish
);

711 
	}
}

715 
šlše
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am &
	gout
, cÚ¡ 
	gObjeùCach”
::
BufãrH—d
 &
bh
)

717 
out
 << "bh[ " << &
bh
 << " "

718 << 
bh
.
¡¬t
(è<< "~" << bh.
Ëngth
()

719 << " " << 
bh
.
ob


720 << " (" << 
bh
.
bl
.
Ëngth
() << ")"

721 << " v " << 
bh
.
Ï¡_wr™e_tid
;

722 ià(
	gbh
.
g‘_jouº®_tid
() != 0) {

723 
out
 << " j " << 
bh
.
g‘_jouº®_tid
();

725 ià(
	gbh
.
is_tx
()è
	gout
 << "x";

726 ià(
	gbh
.
is_rx
()è
	gout
 << "„x";

727 ià(
	gbh
.
is_dœty
()è
	gout
 << " dirty";

728 ià(
	gbh
.
is_ş—n
()è
	gout
 << " clean";

729 ià(
	gbh
.
is_z”o
()è
	gout
 << " zero";

730 ià(
	gbh
.
is_missšg
()è
	gout
 << " missing";

731 ià(
	gbh
.
	gbl
.
Ëngth
(è> 0è
	gout
 << " firstbyte=" << ()bh.bl[0];

732 ià(
	gbh
.
	g”rÜ
è
	gout
 << "ƒrror=" << bh.error;

733 
	gout
 << "]";

734 
	gout
 << " waiters = {";

735 
	gm­
<
	gloff_t
, 
	gli¡
<
	gCÚ‹xt
*> >::
cÚ¡_™”©Ü
 
™


736 ğ
bh
.
wa™fÜ_»ad
.
begš
();

737 
	g™
 !ğ
bh
.
wa™fÜ_»ad
.
’d
(); ++it) {

738 
	gout
 << " " << 
	g™
->
	gfœ¡
 << "->[";

739 
	gli¡
<
	gCÚ‹xt
*>::
cÚ¡_™”©Ü
 
l™
 = 
™
->
£cÚd
.
begš
();

740 
	gl™
 !ğ
™
->
£cÚd
.
’d
(); ++lit) {

741 
	gout
 << *
	gl™
 << ", ";

743 
	gout
 << "]";

745 
	gout
 << "}";

746  
	gout
;

749 
šlše
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am &
	gout
, cÚ¡ 
	gObjeùCach”
::
ObjeùS‘
 &
os
)

751  
out
 << "objeù£t[" << 
os
.
šo


752 << " " << 
os
.
Œunÿ‹_£q
 << "/" << os.
Œunÿ‹_size


753 << " objeù " << 
os
.
objeùs
.
size
()

754 << " dœty_Ü_tx " << 
os
.
dœty_Ü_tx


758 
šlše
 
	go¡»am
& 
	gİ”©Ü
<<(o¡»am &
	gout
, cÚ¡ 
	gObjeùCach”
::
Objeù
 &
ob
)

760 
out
 << "object["

761 << 
ob
.
g‘_soid
(è<< " o£ˆ" << ob.
o£t
 << 
dec


762 << " w¸" << 
ob
.
Ï¡_wr™e_tid
 << "/" << ob.
Ï¡_comm™_tid
;

764 ià(
	gob
.
	gcom¶‘e
)

765 
	gout
 << " COMPLETE";

766 ià(!
	gob
.
	gexi¡s
)

767 
	gout
 << " !EXISTS";

769 
	gout
 << "]";

770  
	gout
;

	@osdc/Objecter.cc

15 
	~"Objeù”.h
"

16 
	~"osd/OSDM­.h
"

17 
	~"F”.h
"

19 
	~"mÚ/MÚCl›Á.h
"

21 
	~"msg/Mes£ng”.h
"

22 
	~"msg/Mes§ge.h
"

24 
	~"mes§ges/MPšg.h
"

25 
	~"mes§ges/MOSDOp.h
"

26 
	~"mes§ges/MOSDOpR•ly.h
"

27 
	~"mes§ges/MOSDBackoff.h
"

28 
	~"mes§ges/MOSDM­.h
"

30 
	~"mes§ges/MPoŞOp.h
"

31 
	~"mes§ges/MPoŞOpR•ly.h
"

33 
	~"mes§ges/MG‘PoŞSts.h
"

34 
	~"mes§ges/MG‘PoŞStsR•ly.h
"

35 
	~"mes§ges/MStfs.h
"

36 
	~"mes§ges/MStfsR•ly.h
"

38 
	~"mes§ges/MMÚCommªd.h
"

40 
	~"mes§ges/MCommªd.h
"

41 
	~"mes§ges/MCommªdR•ly.h
"

43 
	~"mes§ges/MW©chNÙify.h
"

45 
	~<”ºo.h
>

47 
	~"commÚ/cÚfig.h
"

48 
	~"commÚ/³rf_couÁ”s.h
"

49 
	~"commÚ/süub_ty³s.h
"

50 
	~"šşude/¡r_li¡.h
"

51 
	~"commÚ/”ºo.h
"

52 
	~"commÚ/Ev’tT¿û.h
"

54 
usšg
 
	gûph
::
»®_time
;

55 
usšg
 
	gûph
::
»®_şock
;

57 
usšg
 
	gûph
::
mÚo_şock
;

58 
usšg
 
	gûph
::
mÚo_time
;

60 
usšg
 
	gûph
::
time¥ª
;

63 
	#dout_subsys
 
ûph_subsys_objeù”


	)

64 #undeà
dout_´efix


65 
	#dout_´efix
 *
_dout
 << 
mes£ng”
->
	`g‘_myÇme
(è<< ".objeù” "

	)

69 
	ml_osdc_fœ¡
 = 123200,

70 
	ml_osdc_İ_aùive
,

71 
	ml_osdc_İ_Ïggy
,

72 
	ml_osdc_İ_£nd
,

73 
	ml_osdc_İ_£nd_by‹s
,

74 
	ml_osdc_İ_»£nd
,

75 
	ml_osdc_İ_»¶y
,

77 
	ml_osdc_İ
,

78 
	ml_osdc_İ_r
,

79 
	ml_osdc_İ_w
,

80 
	ml_osdc_İ_rmw
,

81 
	ml_osdc_İ_pg
,

83 
	ml_osdc_osdİ_¡©
,

84 
	ml_osdc_osdİ_ü—‹
,

85 
	ml_osdc_osdİ_»ad
,

86 
	ml_osdc_osdİ_wr™e
,

87 
	ml_osdc_osdİ_wr™efuÎ
,

88 
	ml_osdc_osdİ_wr™e§me
,

89 
	ml_osdc_osdİ_­³nd
,

90 
	ml_osdc_osdİ_z”o
,

91 
	ml_osdc_osdİ_Œunÿ‹
,

92 
	ml_osdc_osdİ_d–‘e
,

93 
	ml_osdc_osdİ_m­ext
,

94 
	ml_osdc_osdİ_¥¬£_»ad
,

95 
	ml_osdc_osdİ_şÚ”ªge
,

96 
	ml_osdc_osdİ_g‘x©Œ
,

97 
	ml_osdc_osdİ_£tx©Œ
,

98 
	ml_osdc_osdİ_cmpx©Œ
,

99 
	ml_osdc_osdİ_rmx©Œ
,

100 
	ml_osdc_osdİ_»£tx©Œs
,

101 
	ml_osdc_osdİ_tm­_up
,

102 
	ml_osdc_osdİ_tm­_put
,

103 
	ml_osdc_osdİ_tm­_g‘
,

104 
	ml_osdc_osdİ_ÿÎ
,

105 
	ml_osdc_osdİ_w©ch
,

106 
	ml_osdc_osdİ_nÙify
,

107 
	ml_osdc_osdİ_¤c_cmpx©Œ
,

108 
	ml_osdc_osdİ_pgls
,

109 
	ml_osdc_osdİ_pgls_f‹r
,

110 
	ml_osdc_osdİ_Ùh”
,

112 
	ml_osdc_lšg”_aùive
,

113 
	ml_osdc_lšg”_£nd
,

114 
	ml_osdc_lšg”_»£nd
,

115 
	ml_osdc_lšg”_pšg
,

117 
	ml_osdc_poŞİ_aùive
,

118 
	ml_osdc_poŞİ_£nd
,

119 
	ml_osdc_poŞİ_»£nd
,

121 
	ml_osdc_poŞ¡©_aùive
,

122 
	ml_osdc_poŞ¡©_£nd
,

123 
	ml_osdc_poŞ¡©_»£nd
,

125 
	ml_osdc_¡©fs_aùive
,

126 
	ml_osdc_¡©fs_£nd
,

127 
	ml_osdc_¡©fs_»£nd
,

129 
	ml_osdc_commªd_aùive
,

130 
	ml_osdc_commªd_£nd
,

131 
	ml_osdc_commªd_»£nd
,

133 
	ml_osdc_m­_•och
,

134 
	ml_osdc_m­_fuÎ
,

135 
	ml_osdc_m­_šc
,

137 
	ml_osdc_osd_£ssiÚs
,

138 
	ml_osdc_osd_£ssiÚ_İ’
,

139 
	ml_osdc_osd_£ssiÚ_şo£
,

140 
	ml_osdc_osd_Ïggy
,

142 
	ml_osdc_osdİ_om­_wr
,

143 
	ml_osdc_osdİ_om­_rd
,

144 
	ml_osdc_osdİ_om­_d–
,

146 
	ml_osdc_Ï¡
,

152 cÚ¡ *
	gcÚfig_keys
[] = {

154 
NULL


157 şas 
	cObjeù”
::
Reque¡S‹Hook
 : 
public
 
AdmšSock‘Hook
 {

158 
Objeù”
 *
m_objeù”
;

159 
	mpublic
:

160 
ex¶ic™
 
Reque¡S‹Hook
(
Objeù”
 *
objeù”
);

161 
boŞ
 
	$ÿÎ
(
¡d
::
¡ršg_v›w
 
commªd
, cÚ¡ 
cmdm­_t
& 
cmdm­
,

162 
¡d
::
¡ršg_v›w
 
fÜm©
, 
bufã¾i¡
& 
out
è
ov”ride
;

169 şas 
	cObjeùO³¿tiÚ
::
C_TwoCÚ‹xts
 : 
public
 
CÚ‹xt
 {

170 
CÚ‹xt
 *
fœ¡
;

171 
CÚ‹xt
 *
£cÚd
;

172 
public
:

173 
	$C_TwoCÚ‹xts
(
CÚ‹xt
 *
fœ¡
, CÚ‹xˆ*
£cÚd
) :

174 
	`fœ¡
(
fœ¡
), 
	$£cÚd
(
£cÚd
) {}

175 
	$fšish
(
r
è
ov”ride
 {

176 
fœ¡
->
	`com¶‘e
(
r
);

177 
£cÚd
->
	`com¶‘e
(
r
);

178 
fœ¡
 = 
NULL
;

179 
£cÚd
 = 
NULL
;

180 
	}
}

182 ~
	$C_TwoCÚ‹xts
(è
ov”ride
 {

183 
d–‘e
 
fœ¡
;

184 
d–‘e
 
£cÚd
;

185 
	}
}

188 
	gObjeùO³¿tiÚ
::
	$add_hªdËr
(
CÚ‹xt
 *
exŒa
) {

189 
size_t
 
Ï¡
 = 
out_hªdËr
.
	`size
() - 1;

190 
CÚ‹xt
 *
Üig
 = 
out_hªdËr
[
Ï¡
];

191 ià(
Üig
) {

192 
CÚ‹xt
 *
w¿µ”
 = 
Ãw
 
	`C_TwoCÚ‹xts
(
Üig
, 
exŒa
);

193 
out_hªdËr
[
Ï¡
] = 
w¿µ”
;

195 
out_hªdËr
[
Ï¡
] = 
exŒa
;

197 
	}
}

199 
	gObjeù”
::
OSDSessiÚ
::
unique_com¶‘iÚ_lock
 
Objeù”
::OSDSessiÚ::
	$g‘_lock
(

200 
objeù_t
& 
oid
)

202 ià(
oid
.
Çme
.
	`em±y
())

203  
	`unique_com¶‘iÚ_lock
();

205 
cÚ¡ex´
 
ušt32_t
 
HASH_PRIME
 = 1021;

206 
ušt32_t
 
h
 = 
	`ûph_¡r_hash_lšux
(
oid
.
Çme
.
	`c_¡r
(), oid.Çme.
	`size
())

207 % 
HASH_PRIME
;

209  
	`unique_com¶‘iÚ_lock
(
com¶‘iÚ_locks
[
h
 % 
num_locks
],

210 
¡d
::
deãr_lock
);

211 
	}
}

213 cÚ¡ ** 
	gObjeù”
::
	$g‘_Œacked_cÚf_keys
() const

215  
cÚfig_keys
;

216 
	}
}

219 
	gObjeù”
::
hªdË_cÚf_chªge
(cÚ¡ 
md_cÚfig_t
 *
cÚf
,

220 cÚ¡ 
¡d
::
£t
 <¡d::
¡ršg
> &
chªged
)

222 ià(
chªged
.
couÁ
("crush_location")) {

223 
upd©e_üush_loÿtiÚ
();

227 
	gObjeù”
::
	$upd©e_üush_loÿtiÚ
()

229 
unique_lock
 
	`wl
(
rwlock
);

230 
üush_loÿtiÚ
 = 
cù
->üush_loÿtiÚ.
	`g‘_loÿtiÚ
();

231 
	}
}

238 
	gObjeù”
::
	$š™
()

240 
	`as£¹
(!
š™Ÿlized
);

242 ià(!
logg”
) {

243 
P”fCouÁ”sBud”
 
	`pcb
(
cù
, "objeù”", 
l_osdc_fœ¡
, 
l_osdc_Ï¡
);

245 
pcb
.
	`add_u64
(
l_osdc_İ_aùive
, "op_active", "Operations‡ctive", "actv",

246 
P”fCouÁ”sBud”
::
PRIO_CRITICAL
);

247 
pcb
.
	`add_u64
(
l_osdc_İ_Ïggy
, "op_laggy", "Laggy operations");

248 
pcb
.
	`add_u64_couÁ”
(
l_osdc_İ_£nd
, "op_send", "Sent operations");

249 
pcb
.
	`add_u64_couÁ”
(
l_osdc_İ_£nd_by‹s
, "İ_£nd_by‹s", "S’ˆd©a", 
NULL
, 0, 
	`un™_t
(
BYTES
));

250 
pcb
.
	`add_u64_couÁ”
(
l_osdc_İ_»£nd
, "op_resend", "Resent operations");

251 
pcb
.
	`add_u64_couÁ”
(
l_osdc_İ_»¶y
, "op_reply", "Operation„eply");

253 
pcb
.
	`add_u64_couÁ”
(
l_osdc_İ
, "op", "Operations");

254 
pcb
.
	`add_u64_couÁ”
(
l_osdc_İ_r
, "op_r", "Read operations", "rd",

255 
P”fCouÁ”sBud”
::
PRIO_CRITICAL
);

256 
pcb
.
	`add_u64_couÁ”
(
l_osdc_İ_w
, "op_w", "Write operations", "wr",

257 
P”fCouÁ”sBud”
::
PRIO_CRITICAL
);

258 
pcb
.
	`add_u64_couÁ”
(
l_osdc_İ_rmw
, "op_rmw", "Read-modify-write operations",

259 "rdwr", 
P”fCouÁ”sBud”
::
PRIO_INTERESTING
);

260 
pcb
.
	`add_u64_couÁ”
(
l_osdc_İ_pg
, "op_pg", "PG operation");

262 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_¡©
, "osdop_stat", "Stat operations");

263 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_ü—‹
, "osdop_create",

265 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_»ad
, "osdop_read", "Read operations");

266 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_wr™e
, "osdop_write", "Write operations");

267 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_wr™efuÎ
, "osdop_writefull",

269 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_wr™e§me
, "osdop_writesame",

271 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_­³nd
, "osdop_append",

273 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_z”o
, "osdop_zero",

275 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_Œunÿ‹
, "osdop_truncate",

277 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_d–‘e
, "osdop_delete",

279 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_m­ext
, "osdop_mapext",

281 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_¥¬£_»ad
, "osdop_sparse_read",

283 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_şÚ”ªge
, "osdop_clonerange",

285 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_g‘x©Œ
, "osdop_getxattr",

287 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_£tx©Œ
, "osdop_setxattr",

289 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_cmpx©Œ
, "osdop_cmpxattr",

291 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_rmx©Œ
, "osdop_rmxattr",

293 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_»£tx©Œs
, "osdop_resetxattrs",

295 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_tm­_up
, "osdop_tmap_up",

297 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_tm­_put
, "osdop_tmap_put",

299 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_tm­_g‘
, "osdop_tmap_get",

301 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_ÿÎ
, "osdop_call",

303 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_w©ch
, "osdop_watch",

305 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_nÙify
, "osdop_notify",

307 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_¤c_cmpx©Œ
, "osdop_src_cmpxattr",

309 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_pgls
, "osdop_pgls");

310 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_pgls_f‹r
, "osdop_pgls_filter");

311 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_Ùh”
, "osdop_other", "Other operations");

313 
pcb
.
	`add_u64
(
l_osdc_lšg”_aùive
, "linger_active",

315 
pcb
.
	`add_u64_couÁ”
(
l_osdc_lšg”_£nd
, "linger_send",

317 
pcb
.
	`add_u64_couÁ”
(
l_osdc_lšg”_»£nd
, "linger_resend",

319 
pcb
.
	`add_u64_couÁ”
(
l_osdc_lšg”_pšg
, "linger_ping",

322 
pcb
.
	`add_u64
(
l_osdc_poŞİ_aùive
, "poolop_active",

324 
pcb
.
	`add_u64_couÁ”
(
l_osdc_poŞİ_£nd
, "poolop_send",

326 
pcb
.
	`add_u64_couÁ”
(
l_osdc_poŞİ_»£nd
, "poolop_resend",

329 
pcb
.
	`add_u64
(
l_osdc_poŞ¡©_aùive
, "poolstat_active",

331 
pcb
.
	`add_u64_couÁ”
(
l_osdc_poŞ¡©_£nd
, "poolstat_send",

333 
pcb
.
	`add_u64_couÁ”
(
l_osdc_poŞ¡©_»£nd
, "poolstat_resend",

336 
pcb
.
	`add_u64
(
l_osdc_¡©fs_aùive
, "statfs_active", "Statfs operations");

337 
pcb
.
	`add_u64_couÁ”
(
l_osdc_¡©fs_£nd
, "statfs_send", "Sent FS stats");

338 
pcb
.
	`add_u64_couÁ”
(
l_osdc_¡©fs_»£nd
, "statfs_resend",

341 
pcb
.
	`add_u64
(
l_osdc_commªd_aùive
, "command_active", "Active commands");

342 
pcb
.
	`add_u64_couÁ”
(
l_osdc_commªd_£nd
, "command_send",

344 
pcb
.
	`add_u64_couÁ”
(
l_osdc_commªd_»£nd
, "command_resend",

347 
pcb
.
	`add_u64
(
l_osdc_m­_•och
, "map_epoch", "OSD mapƒpoch");

348 
pcb
.
	`add_u64_couÁ”
(
l_osdc_m­_fuÎ
, "map_full",

350 
pcb
.
	`add_u64_couÁ”
(
l_osdc_m­_šc
, "map_inc",

353 
pcb
.
	`add_u64
(
l_osdc_osd_£ssiÚs
, "osd_sessions",

355 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osd_£ssiÚ_İ’
, "osd_session_open",

357 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osd_£ssiÚ_şo£
, "osd_session_close",

359 
pcb
.
	`add_u64
(
l_osdc_osd_Ïggy
, "osd_laggy", "Laggy OSD sessions");

361 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_om­_wr
, "omap_wr",

363 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_om­_rd
, "omap_rd",

365 
pcb
.
	`add_u64_couÁ”
(
l_osdc_osdİ_om­_d–
, "omap_del",

368 
logg”
 = 
pcb
.
	`ü—‹_³rf_couÁ”s
();

369 
cù
->
	`g‘_³rfcouÁ”s_cŞËùiÚ
()->
	`add
(
logg”
);

372 
m_»que¡_¡©e_hook
 = 
Ãw
 
	`Reque¡S‹Hook
(
this
);

373 
AdmšSock‘
* 
admš_sock‘
 = 
cù
->
	`g‘_admš_sock‘
();

374 
»t
 = 
admš_sock‘
->
	`»gi¡”_commªd
("objecter_requests",

376 
m_»que¡_¡©e_hook
,

381 ià(
»t
 < 0 &&„‘ !ğ-
EEXIST
) {

382 
	`ld”r
(
cù
) << "error„egistering‡dmin socket command: "

383 << 
	`ıp_¡»¼Ü
(
»t
è<< 
d’dl
;

386 
	`upd©e_üush_loÿtiÚ
();

388 
cù
->
_cÚf
->
	`add_ob£rv”
(
this
);

390 
š™Ÿlized
 = 
Œue
;

391 
	}
}

396 
	gObjeù”
::
	$¡¬t
(cÚ¡ 
OSDM­
* 
o
)

398 
sh¬ed_lock
 
	`¾
(
rwlock
);

400 
	`¡¬t_tick
();

401 ià(
o
) {

402 
osdm­
->
	`d“pish_cİy_äom
(*
o
);

403 } ià(
osdm­
->
	`g‘_•och
() == 0) {

404 
	`_maybe_»que¡_m­
();

406 
	}
}

408 
	gObjeù”
::
	$shutdown
()

410 
	`as£¹
(
š™Ÿlized
);

412 
unique_lock
 
	`wl
(
rwlock
);

414 
š™Ÿlized
 = 
çl£
;

416 
cù
->
_cÚf
->
	`»move_ob£rv”
(
this
);

418 
m­
<,
OSDSessiÚ
*>::
™”©Ü
 
p
;

419 !
osd_£ssiÚs
.
	`em±y
()) {

420 
p
 = 
osd_£ssiÚs
.
	`begš
();

421 
	`şo£_£ssiÚ
(
p
->
£cÚd
);

424 !
check_Ï‹¡_m­_lšg”s
.
	`em±y
()) {

425 
m­
<
ušt64_t
, 
Lšg”Op
*>::
™”©Ü
 
i
 = 
check_Ï‹¡_m­_lšg”s
.
	`begš
();

426 
i
->
£cÚd
->
	`put
();

427 
check_Ï‹¡_m­_lšg”s
.
	`”a£
(
i
->
fœ¡
);

430 !
check_Ï‹¡_m­_İs
.
	`em±y
()) {

431 
m­
<
ûph_tid_t
, 
Op
*>::
™”©Ü
 
i
 = 
check_Ï‹¡_m­_İs
.
	`begš
();

432 
i
->
£cÚd
->
	`put
();

433 
check_Ï‹¡_m­_İs
.
	`”a£
(
i
->
fœ¡
);

436 !
check_Ï‹¡_m­_commªds
.
	`em±y
()) {

437 
m­
<
ûph_tid_t
, 
CommªdOp
*>::
™”©Ü
 
i


438 ğ
check_Ï‹¡_m­_commªds
.
	`begš
();

439 
i
->
£cÚd
->
	`put
();

440 
check_Ï‹¡_m­_commªds
.
	`”a£
(
i
->
fœ¡
);

443 !
poŞ¡©_İs
.
	`em±y
()) {

444 
m­
<
ûph_tid_t
,
PoŞStOp
*>::
™”©Ü
 
i
 = 
poŞ¡©_İs
.
	`begš
();

445 
d–‘e
 
i
->
£cÚd
;

446 
poŞ¡©_İs
.
	`”a£
(
i
->
fœ¡
);

449 !
¡©fs_İs
.
	`em±y
()) {

450 
m­
<
ûph_tid_t
, 
StfsOp
*>::
™”©Ü
 
i
 = 
¡©fs_İs
.
	`begš
();

451 
d–‘e
 
i
->
£cÚd
;

452 
¡©fs_İs
.
	`”a£
(
i
->
fœ¡
);

455 !
poŞ_İs
.
	`em±y
()) {

456 
m­
<
ûph_tid_t
, 
PoŞOp
*>::
™”©Ü
 
i
 = 
poŞ_İs
.
	`begš
();

457 
d–‘e
 
i
->
£cÚd
;

458 
poŞ_İs
.
	`”a£
(
i
->
fœ¡
);

461 
	`ldout
(
cù
, 20è<< 
__func__
 << " cË¬šg u°hom–es £ssiÚ..." << 
d’dl
;

462 !
hom–ess_£ssiÚ
->
lšg”_İs
.
	`em±y
()) {

463 
¡d
::
m­
<
ušt64_t
, 
Lšg”Op
*>::
™”©Ü
 
i


464 ğ
hom–ess_£ssiÚ
->
lšg”_İs
.
	`begš
();

465 
	`ldout
(
cù
, 10è<< "†šg”_İ " << 
i
->
fœ¡
 << 
d’dl
;

466 
Lšg”Op
 *
lİ
 = 
i
->
£cÚd
;

468 
OSDSessiÚ
::
unique_lock
 
	`swl
(
hom–ess_£ssiÚ
->
lock
);

469 
	`_£ssiÚ_lšg”_İ_»move
(
hom–ess_£ssiÚ
, 
lİ
);

471 
lšg”_İs
.
	`”a£
(
lİ
->
lšg”_id
);

472 
lšg”_İs_£t
.
	`”a£
(
lİ
);

473 
lİ
->
	`put
();

476 !
hom–ess_£ssiÚ
->
İs
.
	`em±y
()) {

477 
¡d
::
m­
<
ûph_tid_t
, 
Op
*>::
™”©Ü
 
i
 = 
hom–ess_£ssiÚ
->
İs
.
	`begš
();

478 
	`ldout
(
cù
, 10è<< " o°" << 
i
->
fœ¡
 << 
d’dl
;

479 
Op
 *
İ
 = 
i
->
£cÚd
;

481 
OSDSessiÚ
::
unique_lock
 
	`swl
(
hom–ess_£ssiÚ
->
lock
);

482 
	`_£ssiÚ_İ_»move
(
hom–ess_£ssiÚ
, 
İ
);

484 
İ
->
	`put
();

487 !
hom–ess_£ssiÚ
->
commªd_İs
.
	`em±y
()) {

488 
¡d
::
m­
<
ûph_tid_t
, 
CommªdOp
*>::
™”©Ü
 
i


489 ğ
hom–ess_£ssiÚ
->
commªd_İs
.
	`begš
();

490 
	`ldout
(
cù
, 10è<< " commªd_İ " << 
i
->
fœ¡
 << 
d’dl
;

491 
CommªdOp
 *
cİ
 = 
i
->
£cÚd
;

493 
OSDSessiÚ
::
unique_lock
 
	`swl
(
hom–ess_£ssiÚ
->
lock
);

494 
	`_£ssiÚ_commªd_İ_»move
(
hom–ess_£ssiÚ
, 
cİ
);

496 
cİ
->
	`put
();

499 ià(
tick_ev’t
) {

500 ià(
tim”
.
	`ÿnûl_ev’t
(
tick_ev’t
)) {

501 
	`ldout
(
cù
, 10è<< " sucûssfuÎy cªûËdick" << 
d’dl
;

503 
tick_ev’t
 = 0;

506 ià(
logg”
) {

507 
cù
->
	`g‘_³rfcouÁ”s_cŞËùiÚ
()->
	`»move
(
logg”
);

508 
d–‘e
 
logg”
;

509 
logg”
 = 
NULL
;

513 
wl
.
	`uÆock
();

518 ià(
m_»que¡_¡©e_hook
) {

519 
AdmšSock‘
* 
admš_sock‘
 = 
cù
->
	`g‘_admš_sock‘
();

520 
admš_sock‘
->
	`uÄegi¡”_commªd
("objecter_requests");

521 
d–‘e
 
m_»que¡_¡©e_hook
;

522 
m_»que¡_¡©e_hook
 = 
NULL
;

524 
	}
}

526 
	gObjeù”
::
	$_£nd_lšg”
(
Lšg”Op
 *
šfo
,

527 
shunique_lock
& 
sul
)

529 
	`as£¹
(
sul
.
	`owns_lock
(è&& sul.
	`mu‹x
(è=ğ&
rwlock
);

531 
veùÜ
<
OSDOp
> 
İv
;

532 
CÚ‹xt
 *
Úcomm™
 = 
NULL
;

533 
Lšg”Op
::
sh¬ed_lock
 
	`w©chl
(
šfo
->
w©ch_lock
);

534 
bufã¾i¡
 *
poutbl
 = 
NULL
;

535 ià(
šfo
->
»gi¡”ed
 && info->
is_w©ch
) {

536 
	`ldout
(
cù
, 15è<< "£nd_lšg” " << 
šfo
->
lšg”_id
 << "„econnect"

537 << 
d’dl
;

538 
İv
.
	`push_back
(
	`OSDOp
());

539 
İv
.
	`back
().
İ
.İ = 
CEPH_OSD_OP_WATCH
;

540 
İv
.
	`back
().
İ
.
w©ch
.
cook›
 = 
šfo
->
	`g‘_cook›
();

541 
İv
.
	`back
().
İ
.
w©ch
.İ = 
CEPH_OSD_WATCH_OP_RECONNECT
;

542 
İv
.
	`back
().
İ
.
w©ch
.
g’
 = ++
šfo
->
»gi¡”_g’
;

543 
Úcomm™
 = 
Ãw
 
	`C_Lšg”_RecÚÃù
(
this
, 
šfo
);

545 
	`ldout
(
cù
, 15è<< "£nd_lšg” " << 
šfo
->
lšg”_id
 << "„egister"

546 << 
d’dl
;

547 
İv
 = 
šfo
->
İs
;

548 
C_Lšg”_Comm™
 *
c
 = 
Ãw
 
	`C_Lšg”_Comm™
(
this
, 
šfo
);

549 ià(!
šfo
->
is_w©ch
) {

550 
šfo
->
nÙify_id
 = 0;

551 
poutbl
 = &
c
->
outbl
;

553 
Úcomm™
 = 
c
;

555 
w©chl
.
	`uÆock
();

556 
Op
 *
o
 = 
Ãw
 
	`Op
(
šfo
->
rg‘
.
ba£_oid
, info->rg‘.
ba£_Şoc
,

557 
İv
, 
šfo
->
rg‘
.
æags
 | 
CEPH_OSD_FLAG_READ
,

558 
Úcomm™
, 
šfo
->
pobjv”
);

559 
o
->
outbl
 = 
poutbl
;

560 
o
->
¢­id
 = 
šfo
->
¢­
;

561 
o
->
¢­c
 = 
šfo
->snapc;

562 
o
->
mtime
 = 
šfo
->mtime;

564 
o
->
rg‘
 = 
šfo
->target;

565 
o
->
tid
 = ++
Ï¡_tid
;

568 
o
->
should_»£nd
 = 
çl£
;

569 
o
->
ùx_budg‘ed
 = 
Œue
;

571 ià(
šfo
->
»gi¡”_tid
) {

573 
OSDSessiÚ
::
unique_lock
 
	`¦
(
šfo
->
£ssiÚ
->
lock
);

574 ià(
šfo
->
£ssiÚ
->
İs
.
	`couÁ
(šfo->
»gi¡”_tid
)) {

575 
Op
 *
o
 = 
šfo
->
£ssiÚ
->
İs
[šfo->
»gi¡”_tid
];

576 
	`_İ_ÿnûl_m­_check
(
o
);

577 
	`_ÿnûl_lšg”_İ
(
o
);

579 
¦
.
	`uÆock
();

582 
	`_İ_subm™_w™h_budg‘
(
o
, 
sul
, &
šfo
->
»gi¡”_tid
, &šfo->
ùx_budg‘
);

584 
logg”
->
	`šc
(
l_osdc_lšg”_£nd
);

585 
	}
}

587 
	gObjeù”
::
	$_lšg”_comm™
(
Lšg”Op
 *
šfo
, 
r
, 
bufã¾i¡
& 
outbl
)

589 
Lšg”Op
::
unique_lock
 
	`wl
(
šfo
->
w©ch_lock
);

590 
	`ldout
(
cù
, 10è<< "_lšg”_comm™ " << 
šfo
->
lšg”_id
 << 
d’dl
;

591 ià(
šfo
->
Ú_»g_comm™
) {

592 
šfo
->
Ú_»g_comm™
->
	`com¶‘e
(
r
);

593 
šfo
->
Ú_»g_comm™
 = 
NULL
;

595 ià(
r
 < 0 && 
šfo
->
Ú_nÙify_fšish
) {

596 
šfo
->
Ú_nÙify_fšish
->
	`com¶‘e
(
r
);

597 
šfo
->
Ú_nÙify_fšish
 = 
nuÎ±r
;

601 
šfo
->
»gi¡”ed
 = 
Œue
;

602 
šfo
->
pobjv”
 = 
NULL
;

604 ià(!
šfo
->
is_w©ch
) {

606 
bufã¾i¡
::
™”©Ü
 
p
 = 
outbl
.
	`begš
();

607 
Œy
 {

608 
	`decode
(
šfo
->
nÙify_id
, 
p
);

609 
	`ldout
(
cù
, 10è<< "_lšg”_comm™‚Ùify_id=" << 
šfo
->
nÙify_id


610 << 
d’dl
;

612 
	`ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

615 
	}
}

617 
C_DoW©chE¼Ü
 : 
public
 
CÚ‹xt
 {

618 
Objeù”
 *
objeù”
;

619 
	gObjeù”
::
Lšg”Op
 *
šfo
;

620 
	g”r
;

621 
C_DoW©chE¼Ü
(
Objeù”
 *
o
, Objeù”::
Lšg”Op
 *
i
, 
r
)

622 : 
objeù”
(
o
), 
šfo
(
i
), 
”r
(
r
) {

623 
	gšfo
->
g‘
();

624 
	gšfo
->
_queued_async
();

626 
fšish
(
r
è
	gov”ride
 {

627 
	gObjeù”
::
unique_lock
 
wl
(
objeù”
->
rwlock
);

628 
boŞ
 
	gÿnûËd
 = 
šfo
->
ÿnûËd
;

629 
	gwl
.
uÆock
();

631 ià(!
	gÿnûËd
) {

632 
	gšfo
->
	gw©ch_cÚ‹xt
->
hªdË_”rÜ
(
šfo
->
g‘_cook›
(), 
”r
);

635 
	gšfo
->
fšished_async
();

636 
	gšfo
->
put
();

640 
	gObjeù”
::
	$_nÜm®ize_w©ch_”rÜ
(
r
)

645 ià(
r
 =ğ-
ENOENT
)

646 
r
 = -
ENOTCONN
;

647  
r
;

648 
	}
}

650 
	gObjeù”
::
	$_lšg”_»cÚÃù
(
Lšg”Op
 *
šfo
, 
r
)

652 
	`ldout
(
cù
, 10è<< 
__func__
 << " " << 
šfo
->
lšg”_id
 << " = " << 
r


653 << " (Ï¡_”rÜ " << 
šfo
->
Ï¡_”rÜ
 << ")" << 
d’dl
;

654 ià(
r
 < 0) {

655 
Lšg”Op
::
unique_lock
 
	`wl
(
šfo
->
w©ch_lock
);

656 ià(!
šfo
->
Ï¡_”rÜ
) {

657 
r
 = 
	`_nÜm®ize_w©ch_”rÜ
(r);

658 
šfo
->
Ï¡_”rÜ
 = 
r
;

659 ià(
šfo
->
w©ch_cÚ‹xt
) {

660 
fšish”
->
	`queue
(
Ãw
 
	`C_DoW©chE¼Ü
(
this
, 
šfo
, 
r
));

663 
wl
.
	`uÆock
();

665 
	}
}

667 
	gObjeù”
::
	$_£nd_lšg”_pšg
(
Lšg”Op
 *
šfo
)

672 ià(
cù
->
_cÚf
->
objeù”_šjeù_no_w©ch_pšg
) {

673 
	`ldout
(
cù
, 10è<< 
__func__
 << " " << 
šfo
->
lšg”_id
 << " SKIPPING"

674 << 
d’dl
;

677 ià(
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_PAUSERD
)) {

678 
	`ldout
(
cù
, 10è<< 
__func__
 << " PAUSERD" << 
d’dl
;

682 
ûph
::
cßr£_mÚo_time
 
now
 = c•h::
cßr£_mÚo_şock
::
	`now
();

683 
	`ldout
(
cù
, 10è<< 
__func__
 << " " << 
šfo
->
lšg”_id
 << "‚ow " << 
now


684 << 
d’dl
;

686 
veùÜ
<
OSDOp
> 
	`İv
(1);

687 
İv
[0].
İ
.İ = 
CEPH_OSD_OP_WATCH
;

688 
İv
[0].
İ
.
w©ch
.
cook›
 = 
šfo
->
	`g‘_cook›
();

689 
İv
[0].
İ
.
w©ch
.İ = 
CEPH_OSD_WATCH_OP_PING
;

690 
İv
[0].
İ
.
w©ch
.
g’
 = 
šfo
->
»gi¡”_g’
;

691 
C_Lšg”_Pšg
 *
Úack
 = 
Ãw
 
	`C_Lšg”_Pšg
(
this
, 
šfo
);

692 
Op
 *
o
 = 
Ãw
 
	`Op
(
šfo
->
rg‘
.
ba£_oid
, info->rg‘.
ba£_Şoc
,

693 
İv
, 
šfo
->
rg‘
.
æags
 | 
CEPH_OSD_FLAG_READ
,

694 
Úack
, 
NULL
, NULL);

695 
o
->
rg‘
 = 
šfo
->target;

696 
o
->
should_»£nd
 = 
çl£
;

697 
	`_£nd_İ_accouÁ
(
o
);

698 
o
->
tid
 = ++
Ï¡_tid
;

699 
	`_£ssiÚ_İ_assign
(
šfo
->
£ssiÚ
, 
o
);

700 
	`_£nd_İ
(
o
);

701 
šfo
->
pšg_tid
 = 
o
->
tid
;

703 
Úack
->
£Á
 = 
now
;

704 
logg”
->
	`šc
(
l_osdc_lšg”_pšg
);

705 
	}
}

707 
	gObjeù”
::
	$_lšg”_pšg
(
Lšg”Op
 *
šfo
, 
r
, 
ûph
::
cßr£_mÚo_time
 
£Á
,

708 
ušt32_t
 
»gi¡”_g’
)

710 
Lšg”Op
::
unique_lock
 
	`l
(
šfo
->
w©ch_lock
);

711 
	`ldout
(
cù
, 10è<< 
__func__
 << " " << 
šfo
->
lšg”_id


712 << " s’ˆ" << 
£Á
 << " g’ " << 
»gi¡”_g’
 << " = " << 
r


713 << " (Ï¡_”rÜ " << 
šfo
->
Ï¡_”rÜ


714 << "„egi¡”_g’ " << 
šfo
->
»gi¡”_g’
 << ")" << 
d’dl
;

715 ià(
šfo
->
»gi¡”_g’
 ==„egister_gen) {

716 ià(
r
 == 0) {

717 
šfo
->
w©ch_v®id_thru
 = 
£Á
;

718 } ià(
r
 < 0 && !
šfo
->
Ï¡_”rÜ
) {

719 
r
 = 
	`_nÜm®ize_w©ch_”rÜ
(r);

720 
šfo
->
Ï¡_”rÜ
 = 
r
;

721 ià(
šfo
->
w©ch_cÚ‹xt
) {

722 
fšish”
->
	`queue
(
Ãw
 
	`C_DoW©chE¼Ü
(
this
, 
šfo
, 
r
));

726 
	`ldout
(
cù
, 20è<< " ignÜšg old g’" << 
d’dl
;

728 
	}
}

730 
	gObjeù”
::
	$lšg”_check
(
Lšg”Op
 *
šfo
)

732 
Lšg”Op
::
sh¬ed_lock
 
	`l
(
šfo
->
w©ch_lock
);

734 
ûph
::
cßr£_mÚo_time
 
¡amp
 = 
šfo
->
w©ch_v®id_thru
;

735 ià(!
šfo
->
w©ch_³ndšg_async
.
	`em±y
())

736 
¡amp
 = 
¡d
::
	`mš
(
šfo
->
w©ch_v®id_thru
, info->
w©ch_³ndšg_async
.
	`äÚt
());

737 autØ
age
 = 
ûph
::
cßr£_mÚo_şock
::
	`now
(è- 
¡amp
;

739 
	`ldout
(
cù
, 10è<< 
__func__
 << " " << 
šfo
->
lšg”_id


740 << "ƒ¼ " << 
šfo
->
Ï¡_”rÜ


741 << "‡g" << 
age
 << 
d’dl
;

742 ià(
šfo
->
Ï¡_”rÜ
)

743  
šfo
->
Ï¡_”rÜ
;

746 1 + 
¡d
::
chrÚo
::
du¿tiÚ_ÿ¡
<¡d::chrÚo::
mli£cÚds
>(
age
).
	`couÁ
();

747 
	}
}

749 
	gObjeù”
::
	$lšg”_ÿnûl
(
Lšg”Op
 *
šfo
)

751 
unique_lock
 
	`wl
(
rwlock
);

752 
	`_lšg”_ÿnûl
(
šfo
);

753 
šfo
->
	`put
();

754 
	}
}

756 
	gObjeù”
::
	$_lšg”_ÿnûl
(
Lšg”Op
 *
šfo
)

759 
	`ldout
(
cù
, 20è<< 
__func__
 << "†šg”_id=" << 
šfo
->
lšg”_id
 << 
d’dl
;

760 ià(!
šfo
->
ÿnûËd
) {

761 
OSDSessiÚ
 *
s
 = 
šfo
->
£ssiÚ
;

762 
OSDSessiÚ
::
unique_lock
 
	`¦
(
s
->
lock
);

763 
	`_£ssiÚ_lšg”_İ_»move
(
s
, 
šfo
);

764 
¦
.
	`uÆock
();

766 
lšg”_İs
.
	`”a£
(
šfo
->
lšg”_id
);

767 
lšg”_İs_£t
.
	`”a£
(
šfo
);

768 
	`as£¹
(
lšg”_İs
.
	`size
(è=ğ
lšg”_İs_£t
.size());

770 
šfo
->
ÿnûËd
 = 
Œue
;

771 
šfo
->
	`put
();

773 
logg”
->
	`dec
(
l_osdc_lšg”_aùive
);

775 
	}
}

779 
	gObjeù”
::
Lšg”Op
 *
Objeù”
::
	$lšg”_»gi¡”
(cÚ¡ 
objeù_t
& 
oid
,

780 cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

781 
æags
)

783 
Lšg”Op
 *
šfo
 = 
Ãw
 
	`Lšg”Op
(
this
);

784 
šfo
->
rg‘
.
ba£_oid
 = 
oid
;

785 
šfo
->
rg‘
.
ba£_Şoc
 = 
Şoc
;

786 ià(
šfo
->
rg‘
.
ba£_Şoc
.
key
 =ğ
oid
)

787 
šfo
->
rg‘
.
ba£_Şoc
.
key
.
	`ş—r
();

788 
šfo
->
rg‘
.
æags
 = flags;

789 
šfo
->
w©ch_v®id_thru
 = 
ûph
::
cßr£_mÚo_şock
::
	`now
();

791 
unique_lock
 
	`l
(
rwlock
);

794 
šfo
->
lšg”_id
 = ++
max_lšg”_id
;

795 
	`ldout
(
cù
, 10è<< 
__func__
 << " infØ" << 
šfo


796 << "†šg”_id " << 
šfo
->
lšg”_id


797 << " cook› " << 
šfo
->
	`g‘_cook›
()

798 << 
d’dl
;

799 
lšg”_İs
[
šfo
->
lšg”_id
] = info;

800 
lšg”_İs_£t
.
	`š£¹
(
šfo
);

801 
	`as£¹
(
lšg”_İs
.
	`size
(è=ğ
lšg”_İs_£t
.size());

803 
šfo
->
	`g‘
();

804  
šfo
;

805 
	}
}

807 
ûph_tid_t
 
	gObjeù”
::
	$lšg”_w©ch
(
Lšg”Op
 *
šfo
,

808 
ObjeùO³¿tiÚ
& 
İ
,

809 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

810 
»®_time
 
mtime
,

811 
bufã¾i¡
& 
šbl
,

812 
CÚ‹xt
 *
Úcomm™
,

813 
v”siÚ_t
 *
objv”
)

815 
šfo
->
is_w©ch
 = 
Œue
;

816 
šfo
->
¢­c
 = snapc;

817 
šfo
->
mtime
 = mtime;

818 
šfo
->
rg‘
.
æags
 |ğ
CEPH_OSD_FLAG_WRITE
;

819 
šfo
->
İs
 = 
İ
.ops;

820 
šfo
->
šbl
 = inbl;

821 
šfo
->
poutbl
 = 
NULL
;

822 
šfo
->
pobjv”
 = 
objv”
;

823 
šfo
->
Ú_»g_comm™
 = 
Úcomm™
;

825 
šfo
->
ùx_budg‘
 = 
	`ke_lšg”_budg‘
(info);

827 
shunique_lock
 
	`sul
(
rwlock
, 
ûph
::
acquœe_unique
);

828 
	`_lšg”_subm™
(
šfo
, 
sul
);

829 
logg”
->
	`šc
(
l_osdc_lšg”_aùive
);

831  
šfo
->
lšg”_id
;

832 
	}
}

834 
ûph_tid_t
 
	gObjeù”
::
	$lšg”_nÙify
(
Lšg”Op
 *
šfo
,

835 
ObjeùO³¿tiÚ
& 
İ
,

836 
¢­id_t
 
¢­
, 
bufã¾i¡
& 
šbl
,

837 
bufã¾i¡
 *
poutbl
,

838 
CÚ‹xt
 *
Úfšish
,

839 
v”siÚ_t
 *
objv”
)

841 
šfo
->
¢­
 = snap;

842 
šfo
->
rg‘
.
æags
 |ğ
CEPH_OSD_FLAG_READ
;

843 
šfo
->
İs
 = 
İ
.ops;

844 
šfo
->
šbl
 = inbl;

845 
šfo
->
poutbl
 =…outbl;

846 
šfo
->
pobjv”
 = 
objv”
;

847 
šfo
->
Ú_»g_comm™
 = 
Úfšish
;

849 
šfo
->
ùx_budg‘
 = 
	`ke_lšg”_budg‘
(info);

851 
shunique_lock
 
	`sul
(
rwlock
, 
ûph
::
acquœe_unique
);

852 
	`_lšg”_subm™
(
šfo
, 
sul
);

853 
logg”
->
	`šc
(
l_osdc_lšg”_aùive
);

855  
šfo
->
lšg”_id
;

856 
	}
}

858 
	gObjeù”
::
	$_lšg”_subm™
(
Lšg”Op
 *
šfo
, 
shunique_lock
& 
sul
)

860 
	`as£¹
(
sul
.
	`owns_lock
(è&& sul.
	`mu‹x
(è=ğ&
rwlock
);

861 
	`as£¹
(
šfo
->
lšg”_id
);

862 
	`as£¹
(
šfo
->
ùx_budg‘
 != -1);

865 
OSDSessiÚ
 *
s
 = 
NULL
;

866 
	`_ÿlc_rg‘
(&
šfo
->
rg‘
, 
nuÎ±r
);

869 
r
 = 
	`_g‘_£ssiÚ
(
šfo
->
rg‘
.
osd
, &
s
, 
sul
);

870 
	`as£¹
(
r
 == 0);

871 
OSDSessiÚ
::
unique_lock
 
	`¦
(
s
->
lock
);

872 
	`_£ssiÚ_lšg”_İ_assign
(
s
, 
šfo
);

873 
¦
.
	`uÆock
();

874 
	`put_£ssiÚ
(
s
);

876 
	`_£nd_lšg”
(
šfo
, 
sul
);

877 
	}
}

879 
	gC_DoW©chNÙify
 : 
public
 
CÚ‹xt
 {

880 
Objeù”
 *
objeù”
;

881 
	gObjeù”
::
Lšg”Op
 *
šfo
;

882 
MW©chNÙify
 *
	gmsg
;

883 
C_DoW©chNÙify
(
Objeù”
 *
o
, Objeù”::
Lšg”Op
 *
i
, 
MW©chNÙify
 *
m
)

884 : 
objeù”
(
o
), 
šfo
(
i
), 
msg
(
m
) {

885 
	gšfo
->
g‘
();

886 
	gšfo
->
_queued_async
();

887 
	gmsg
->
g‘
();

889 
fšish
(
r
è
	gov”ride
 {

890 
	gobjeù”
->
_do_w©ch_nÙify
(
šfo
, 
msg
);

894 
	gObjeù”
::
	$hªdË_w©ch_nÙify
(
MW©chNÙify
 *
m
)

896 
sh¬ed_lock
 
	`l
(
rwlock
);

897 ià(!
š™Ÿlized
) {

901 
Lšg”Op
 *
šfo
 = 
»š‹½»t_ÿ¡
<Lšg”Op*>(
m
->
cook›
);

902 ià(
lšg”_İs_£t
.
	`couÁ
(
šfo
) == 0) {

903 
	`ldout
(
cù
, 7è<< 
__func__
 << " cook› " << 
m
->
cook›
 << " dÃ" << 
d’dl
;

906 
Lšg”Op
::
unique_lock
 
	`wl
(
šfo
->
w©ch_lock
);

907 ià(
m
->
İcode
 =ğ
CEPH_WATCH_EVENT_DISCONNECT
) {

908 ià(!
šfo
->
Ï¡_”rÜ
) {

909 
šfo
->
Ï¡_”rÜ
 = -
ENOTCONN
;

910 ià(
šfo
->
w©ch_cÚ‹xt
) {

911 
fšish”
->
	`queue
(
Ãw
 
	`C_DoW©chE¼Ü
(
this
, 
šfo
, -
ENOTCONN
));

914 } ià(!
šfo
->
is_w©ch
) {

918 ià(
šfo
->
nÙify_id
 &&

919 
šfo
->
nÙify_id
 !ğ
m
->notify_id) {

920 
	`ldout
(
cù
, 10è<< 
__func__
 << "„•ly‚Ùify " << 
m
->
nÙify_id


921 << " !ğ" << 
šfo
->
nÙify_id
 << ", ignÜšg" << 
d’dl
;

922 } ià(
šfo
->
Ú_nÙify_fšish
) {

923 
šfo
->
nÙify_»suÉ_bl
->
	`şaim
(
m
->
	`g‘_d©a
());

924 
šfo
->
Ú_nÙify_fšish
->
	`com¶‘e
(
m
->
»tuº_code
);

928 
šfo
->
Ú_nÙify_fšish
 = 
NULL
;

931 
fšish”
->
	`queue
(
Ãw
 
	`C_DoW©chNÙify
(
this
, 
šfo
, 
m
));

933 
	}
}

935 
	gObjeù”
::
	$_do_w©ch_nÙify
(
Lšg”Op
 *
šfo
, 
MW©chNÙify
 *
m
)

937 
	`ldout
(
cù
, 10è<< 
__func__
 << " " << *
m
 << 
d’dl
;

939 
sh¬ed_lock
 
	`l
(
rwlock
);

940 
	`as£¹
(
š™Ÿlized
);

942 ià(
šfo
->
ÿnûËd
) {

943 
l
.
	`uÆock
();

944 
out
;

948 
	`as£¹
(
šfo
->
is_w©ch
);

949 
	`as£¹
(
šfo
->
w©ch_cÚ‹xt
);

950 
	`as£¹
(
m
->
İcode
 !ğ
CEPH_WATCH_EVENT_DISCONNECT
);

952 
l
.
	`uÆock
();

954 
m
->
İcode
) {

955 
CEPH_WATCH_EVENT_NOTIFY
:

956 
šfo
->
w©ch_cÚ‹xt
->
	`hªdË_nÙify
(
m
->
nÙify_id
, m->
cook›
,

957 
m
->
nÙif›r_gid
, m->
bl
);

961 
out
:

962 
šfo
->
	`fšished_async
();

963 
šfo
->
	`put
();

964 
m
->
	`put
();

965 
	}
}

967 
boŞ
 
	gObjeù”
::
	$ms_di¥©ch
(
Mes§ge
 *
m
)

969 
	`ldout
(
cù
, 10è<< 
__func__
 << " " << cù << " " << *
m
 << 
d’dl
;

970 
m
->
	`g‘_ty³
()) {

972 
CEPH_MSG_OSD_OPREPLY
:

973 
	`hªdË_osd_İ_»¶y
(
¡©ic_ÿ¡
<
MOSDOpR•ly
*>(
m
));

974  
Œue
;

976 
CEPH_MSG_OSD_BACKOFF
:

977 
	`hªdË_osd_backoff
(
¡©ic_ÿ¡
<
MOSDBackoff
*>(
m
));

978  
Œue
;

980 
CEPH_MSG_WATCH_NOTIFY
:

981 
	`hªdË_w©ch_nÙify
(
¡©ic_ÿ¡
<
MW©chNÙify
*>(
m
));

982 
m
->
	`put
();

983  
Œue
;

985 
MSG_COMMAND_REPLY
:

986 ià(
m
->
	`g‘_sourû
().
	`ty³
(è=ğ
CEPH_ENTITY_TYPE_OSD
) {

987 
	`hªdË_commªd_»¶y
(
¡©ic_ÿ¡
<
MCommªdR•ly
*>(
m
));

988  
Œue
;

990  
çl£
;

993 
MSG_GETPOOLSTATSREPLY
:

994 
	`hªdË_g‘_poŞ_¡©s_»¶y
(
¡©ic_ÿ¡
<
MG‘PoŞStsR•ly
*>(
m
));

995  
Œue
;

997 
CEPH_MSG_POOLOP_REPLY
:

998 
	`hªdË_poŞ_İ_»¶y
(
¡©ic_ÿ¡
<
MPoŞOpR•ly
*>(
m
));

999  
Œue
;

1001 
CEPH_MSG_STATFS_REPLY
:

1002 
	`hªdË_fs_¡©s_»¶y
(
¡©ic_ÿ¡
<
MStfsR•ly
*>(
m
));

1003  
Œue
;

1008 
CEPH_MSG_OSD_MAP
:

1009 
	`hªdË_osd_m­
(
¡©ic_ÿ¡
<
MOSDM­
*>(
m
));

1010  
çl£
;

1012  
çl£
;

1013 
	}
}

1015 
	gObjeù”
::
_sÿn_»que¡s
(

1016 
OSDSessiÚ
 *
s
,

1017 
boŞ
 
sk³d_m­
,

1018 
boŞ
 
şu¡”_fuÎ
,

1019 
m­
<
št64_t
, 
boŞ
> *
poŞ_fuÎ_m­
,

1020 
m­
<
ûph_tid_t
, 
Op
*>& 
Ãed_»£nd
,

1021 
li¡
<
Lšg”Op
*>& 
Ãed_»£nd_lšg”
,

1022 
m­
<
ûph_tid_t
, 
CommªdOp
*>& 
Ãed_»£nd_commªd
,

1023 
shunique_lock
& 
sul
,

1024 cÚ¡ 
mempoŞ
::
osdm­
::
m­
<
št64_t
,
OSDM­
::
¢­_š‹rv®_£t_t
> *
g­_»moved_¢­s
)

1026 
as£¹
(
sul
.
owns_lock
(è&& sul.
mu‹x
(è=ğ&
rwlock
);

1028 
	gli¡
<
	gLšg”Op
*> 
	guÄegi¡”_lšg”s
;

1030 
	gOSDSessiÚ
::
unique_lock
 
¦
(
s
->
lock
);

1033 
	gm­
<
	gûph_tid_t
,
	gLšg”Op
*>::
™”©Ü
 
Í
 = 
s
->
lšg”_İs
.
begš
();

1034 
	gÍ
 !ğ
s
->
lšg”_İs
.
’d
()) {

1035 
Lšg”Op
 *
İ
 = 
Í
->
£cÚd
;

1036 
as£¹
(
İ
->
£ssiÚ
 =ğ
s
);

1039 ++
	gÍ
;

1040 
ldout
(
cù
, 10è<< " checkšg†šg” o°" << 
	gİ
->
	glšg”_id
 << 
	gd’dl
;

1041 
boŞ
 
	guÄegi¡”
, 
	gfÜû_»£nd_wr™es
 = 
şu¡”_fuÎ
;

1042 
	gr
 = 
_»ÿlc_lšg”_İ_rg‘
(
İ
, 
sul
);

1043 ià(
	gpoŞ_fuÎ_m­
)

1044 
	gfÜû_»£nd_wr™es
 = 
fÜû_»£nd_wr™es
 ||

1045 (*
poŞ_fuÎ_m­
)[
İ
->
rg‘
.
ba£_Şoc
.
poŞ
];

1046 
	gr
) {

1047 
	gRECALC_OP_TARGET_NO_ACTION
:

1048 ià(!
sk³d_m­
 && !
fÜû_»£nd_wr™es
)

1051 
	gRECALC_OP_TARGET_NEED_RESEND
:

1052 
Ãed_»£nd_lšg”
.
push_back
(
İ
);

1053 
_lšg”_ÿnûl_m­_check
(
İ
);

1055 
	gRECALC_OP_TARGET_POOL_DNE
:

1056 
_check_lšg”_poŞ_dÃ
(
İ
, &
uÄegi¡”
);

1057 ià(
	guÄegi¡”
) {

1058 
ldout
(
cù
, 10) << "‚eedo unregister†inger op "

1059 << 
	gİ
->
	glšg”_id
 << 
	gd’dl
;

1060 
	gİ
->
g‘
();

1061 
	guÄegi¡”_lšg”s
.
push_back
(
İ
);

1068 
	gm­
<
	gûph_tid_t
,
	gOp
*>::
™”©Ü
 
p
 = 
s
->
İs
.
begš
();

1069 
	gp
 !ğ
s
->
İs
.
’d
()) {

1070 
Op
 *
İ
 = 
p
->
£cÚd
;

1071 ++
	gp
;

1072 
ldout
(
cù
, 10è<< " checkšg o°" << 
	gİ
->
	gtid
 << 
	gd’dl
;

1073 
_´uÃ_¢­c
(
osdm­
->
g‘_Ãw_»moved_¢­s
(), 
İ
);

1074 ià(
	gsk³d_m­
) {

1075 
_´uÃ_¢­c
(*
g­_»moved_¢­s
, 
İ
);

1077 
boŞ
 
	gfÜû_»£nd_wr™es
 = 
şu¡”_fuÎ
;

1078 ià(
	gpoŞ_fuÎ_m­
)

1079 
	gfÜû_»£nd_wr™es
 = 
fÜû_»£nd_wr™es
 ||

1080 (*
poŞ_fuÎ_m­
)[
İ
->
rg‘
.
ba£_Şoc
.
poŞ
];

1081 
	gr
 = 
_ÿlc_rg‘
(&
İ
->
rg‘
,

1082 
İ
->
£ssiÚ
 ? op->£ssiÚ->
cÚ
.
g‘
(è: 
nuÎ±r
);

1083 
	gr
) {

1084 
	gRECALC_OP_TARGET_NO_ACTION
:

1085 ià(!
sk³d_m­
 && !(
fÜû_»£nd_wr™es
 && 
İ
->
»¥eùs_fuÎ
()))

1088 
	gRECALC_OP_TARGET_NEED_RESEND
:

1089 
_£ssiÚ_İ_»move
(
İ
->
£ssiÚ
, op);

1090 
	gÃed_»£nd
[
İ
->
tid
] = op;

1091 
_İ_ÿnûl_m­_check
(
İ
);

1093 
	gRECALC_OP_TARGET_POOL_DNE
:

1094 
_check_İ_poŞ_dÃ
(
İ
, &
¦
);

1100 
	gm­
<
	gûph_tid_t
,
	gCommªdOp
*>::
™”©Ü
 
ı
 = 
s
->
commªd_İs
.
begš
();

1101 
	gı
 !ğ
s
->
commªd_İs
.
’d
()) {

1102 
CommªdOp
 *
c
 = 
ı
->
£cÚd
;

1103 ++
	gı
;

1104 
ldout
(
cù
, 10è<< " checkšg commªd " << 
	gc
->
	gtid
 << 
	gd’dl
;

1105 
boŞ
 
	gfÜû_»£nd_wr™es
 = 
şu¡”_fuÎ
;

1106 ià(
	gpoŞ_fuÎ_m­
)

1107 
	gfÜû_»£nd_wr™es
 = 
fÜû_»£nd_wr™es
 ||

1108 (*
poŞ_fuÎ_m­
)[
c
->
rg‘_pg
.
poŞ
()];

1109 
	gr
 = 
_ÿlc_commªd_rg‘
(
c
, 
sul
);

1110 
	gr
) {

1111 
	gRECALC_OP_TARGET_NO_ACTION
:

1113 ià(!
sk³d_m­
 && !
fÜû_»£nd_wr™es
)

1116 
	gRECALC_OP_TARGET_NEED_RESEND
:

1117 
Ãed_»£nd_commªd
[
c
->
tid
] = c;

1118 
_£ssiÚ_commªd_İ_»move
(
c
->
£ssiÚ
, c);

1119 
_commªd_ÿnûl_m­_check
(
c
);

1121 
	gRECALC_OP_TARGET_POOL_DNE
:

1122 
RECALC_OP_TARGET_OSD_DNE
:

1123 
RECALC_OP_TARGET_OSD_DOWN
:

1124 
_check_commªd_m­_dÃ
(
c
);

1129 
	g¦
.
uÆock
();

1131 
	gli¡
<
	gLšg”Op
*>::
™”©Ü
 
™”
 = 
uÄegi¡”_lšg”s
.
begš
();

1132 
	g™”
 !ğ
uÄegi¡”_lšg”s
.
’d
();

1133 ++
	g™”
) {

1134 
_lšg”_ÿnûl
(*
™”
);

1135 (*
	g™”
)->
put
();

1139 
	gObjeù”
::
	$hªdË_osd_m­
(
MOSDM­
 *
m
)

1141 
shunique_lock
 
	`sul
(
rwlock
, 
acquœe_unique
);

1142 ià(!
š™Ÿlized
)

1145 
	`as£¹
(
osdm­
);

1147 ià(
m
->
fsid
 !ğ
mÚc
->
	`g‘_fsid
()) {

1148 
	`ldout
(
cù
, 0è<< "hªdË_osd_m­ fsid " << 
m
->
fsid


1149 << " !ğ" << 
mÚc
->
	`g‘_fsid
(è<< 
d’dl
;

1153 
boŞ
 
was_·u£rd
 = 
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_PAUSERD
);

1154 
boŞ
 
şu¡”_fuÎ
 = 
	`_osdm­_fuÎ_æag
();

1155 
boŞ
 
was_·u£wr
 = 
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_PAUSEWR
è|| 
şu¡”_fuÎ
 ||

1156 
	`_osdm­_has_poŞ_fuÎ
();

1157 
m­
<
št64_t
, 
boŞ
> 
poŞ_fuÎ_m­
;

1158 
m­
<
št64_t
, 
pg_poŞ_t
>::
cÚ¡_™”©Ü
 
™


1159 ğ
osdm­
->
	`g‘_poŞs
().
	`begš
();

1160 
™
 !ğ
osdm­
->
	`g‘_poŞs
().
	`’d
(); ++it)

1161 
poŞ_fuÎ_m­
[
™
->
fœ¡
] = 
	`_osdm­_poŞ_fuÎ
(™->
£cÚd
);

1164 
li¡
<
Lšg”Op
*> 
Ãed_»£nd_lšg”
;

1165 
m­
<
ûph_tid_t
, 
Op
*> 
Ãed_»£nd
;

1166 
m­
<
ûph_tid_t
, 
CommªdOp
*> 
Ãed_»£nd_commªd
;

1168 ià(
m
->
	`g‘_Ï¡
(è<ğ
osdm­
->
	`g‘_•och
()) {

1169 
	`ldout
(
cù
, 3) << "handle_osd_map ignoringƒpochs ["

1170 << 
m
->
	`g‘_fœ¡
(è<< "," << m->
	`g‘_Ï¡
()

1171 << "] <ğ" << 
osdm­
->
	`g‘_•och
(è<< 
d’dl
;

1173 
	`ldout
(
cù
, 3) << "handle_osd_map gotƒpochs ["

1174 << 
m
->
	`g‘_fœ¡
(è<< "," << m->
	`g‘_Ï¡
()

1175 << "] > " << 
osdm­
->
	`g‘_•och
(è<< 
d’dl
;

1177 ià(
osdm­
->
	`g‘_•och
()) {

1178 
boŞ
 
sk³d_m­
 = 
çl£
;

1180 
•och_t
 
e
 = 
osdm­
->
	`g‘_•och
() + 1;

1181 
e
 <ğ
m
->
	`g‘_Ï¡
();

1182 
e
++) {

1184 ià(
osdm­
->
	`g‘_•och
(è=ğ
e
-1 &&

1185 
m
->
šüem’l_m­s
.
	`couÁ
(
e
)) {

1186 
	`ldout
(
cù
, 3è<< "hªdË_osd_m­ decodšg inüem’È•och " << 
e


1187 << 
d’dl
;

1188 
OSDM­
::
Inüem’l
 
	`šc
(
m
->
šüem’l_m­s
[
e
]);

1189 
osdm­
->
	`­¶y_šüem’l
(
šc
);

1191 
	`em™_bÏckli¡_ev’ts
(
šc
);

1193 
logg”
->
	`šc
(
l_osdc_m­_šc
);

1195 ià(
m
->
m­s
.
	`couÁ
(
e
)) {

1196 
	`ldout
(
cù
, 3è<< "hªdË_osd_m­ decodšg fuÎƒpoch " << 
e
 << 
d’dl
;

1197 
OSDM­
 *
Ãw_osdm­
 = 
Ãw
 
	`OSDM­
();

1198 
Ãw_osdm­
->
	`decode
(
m
->
m­s
[
e
]);

1200 
	`em™_bÏckli¡_ev’ts
(*
osdm­
, *
Ãw_osdm­
);

1202 
osdm­
 = 
Ãw_osdm­
;

1204 
logg”
->
	`šc
(
l_osdc_m­_fuÎ
);

1207 ià(
e
 >ğ
m
->
	`g‘_Şde¡
()) {

1208 
	`ldout
(
cù
, 3) << "handle_osd_map„equesting missingƒpoch "

1209 << 
osdm­
->
	`g‘_•och
()+1 << 
d’dl
;

1210 
	`_maybe_»que¡_m­
();

1213 
	`ldout
(
cù
, 3) << "handle_osd_map missingƒpoch "

1214 << 
osdm­
->
	`g‘_•och
()+1

1215 << ", jumpšgØ" << 
m
->
	`g‘_Şde¡
(è<< 
d’dl
;

1216 
e
 = 
m
->
	`g‘_Şde¡
() - 1;

1217 
sk³d_m­
 = 
Œue
;

1220 
logg”
->
	`£t
(
l_osdc_m­_•och
, 
osdm­
->
	`g‘_•och
());

1222 
şu¡”_fuÎ
 = clu¡”_fuÎ || 
	`_osdm­_fuÎ_æag
();

1223 
	`upd©e_poŞ_fuÎ_m­
(
poŞ_fuÎ_m­
);

1226 auto& 
i
 : 
Ãed_»£nd
) {

1227 
	`_´uÃ_¢­c
(
osdm­
->
	`g‘_Ãw_»moved_¢­s
(), 
i
.
£cÚd
);

1228 ià(
sk³d_m­
) {

1229 
	`_´uÃ_¢­c
(
m
->
g­_»moved_¢­s
, 
i
.
£cÚd
);

1232 
	`_sÿn_»que¡s
(
hom–ess_£ssiÚ
, 
sk³d_m­
, 
şu¡”_fuÎ
,

1233 &
poŞ_fuÎ_m­
, 
Ãed_»£nd
,

1234 
Ãed_»£nd_lšg”
, 
Ãed_»£nd_commªd
, 
sul
,

1235 &
m
->
g­_»moved_¢­s
);

1236 
m­
<,
OSDSessiÚ
*>::
™”©Ü
 
p
 = 
osd_£ssiÚs
.
	`begš
();

1237 
p
 !ğ
osd_£ssiÚs
.
	`’d
(); ) {

1238 
OSDSessiÚ
 *
s
 = 
p
->
£cÚd
;

1239 
	`_sÿn_»que¡s
(
s
, 
sk³d_m­
, 
şu¡”_fuÎ
,

1240 &
poŞ_fuÎ_m­
, 
Ãed_»£nd
,

1241 
Ãed_»£nd_lšg”
, 
Ãed_»£nd_commªd
, 
sul
,

1242 &
m
->
g­_»moved_¢­s
);

1243 ++
p
;

1245 ià(!
osdm­
->
	`is_up
(
s
->
osd
) ||

1246 (
s
->
cÚ
 &&

1247 
s
->
cÚ
->
	`g‘_³”_addr
(è!ğ
osdm­
->
	`g‘_š¡
(s->
osd
).
addr
)) {

1248 
	`şo£_£ssiÚ
(
s
);

1252 
	`as£¹
(
e
 =ğ
osdm­
->
	`g‘_•och
());

1257 ià(
m
->
m­s
.
	`couÁ
(m->
	`g‘_Ï¡
())) {

1258 
m­
<,
OSDSessiÚ
*>::
™”©Ü
 
p
 = 
osd_£ssiÚs
.
	`begš
();

1259 
p
 !ğ
osd_£ssiÚs
.
	`’d
(); ++p) {

1260 
OSDSessiÚ
 *
s
 = 
p
->
£cÚd
;

1261 
	`_sÿn_»que¡s
(
s
, 
çl£
, f®£, 
NULL
, 
Ãed_»£nd
,

1262 
Ãed_»£nd_lšg”
, 
Ãed_»£nd_commªd
, 
sul
,

1263 
nuÎ±r
);

1265 
	`ldout
(
cù
, 3) << "handle_osd_map decoding fullƒpoch "

1266 << 
m
->
	`g‘_Ï¡
(è<< 
d’dl
;

1267 
osdm­
->
	`decode
(
m
->
m­s
[m->
	`g‘_Ï¡
()]);

1269 
	`_sÿn_»que¡s
(
hom–ess_£ssiÚ
, 
çl£
, f®£, 
NULL
,

1270 
Ãed_»£nd
, 
Ãed_»£nd_lšg”
,

1271 
Ãed_»£nd_commªd
, 
sul
, 
nuÎ±r
);

1273 
	`ldout
(
cù
, 3) << "handle_osd_map hmm, i want‡ full map,„equesting"

1274 << 
d’dl
;

1275 
mÚc
->
	`sub_wªt
("osdm­", 0, 
CEPH_SUBSCRIBE_ONETIME
);

1276 
mÚc
->
	`»Ãw_subs
();

1282 autØ
p
 = 
Ãed_»£nd
.
	`begš
();… !ğÃed_»£nd.
	`’d
(); ) {

1283 
Op
 *
İ
 = 
p
->
£cÚd
;

1284 ià(
İ
->
rg‘
.
•och
 < 
osdm­
->
	`g‘_•och
()) {

1285 
	`ldout
(
cù
, 10è<< 
__func__
 << " checkšg o°" << 
p
->
fœ¡
 << 
d’dl
;

1286 
r
 = 
	`_ÿlc_rg‘
(&
İ
->
rg‘
, 
nuÎ±r
);

1287 ià(
r
 =ğ
RECALC_OP_TARGET_POOL_DNE
) {

1288 
p
 = 
Ãed_»£nd
.
	`”a£
(p);

1289 
	`_check_İ_poŞ_dÃ
(
İ
, 
nuÎ±r
);

1291 ++
p
;

1294 ++
p
;

1298 
boŞ
 
·u£rd
 = 
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_PAUSERD
);

1299 
boŞ
 
·u£wr
 = 
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_PAUSEWR
è|| 
	`_osdm­_fuÎ_æag
()

1300 || 
	`_osdm­_has_poŞ_fuÎ
();

1303 ià(
was_·u£rd
 || 
was_·u£wr
 || 
·u£rd
 || 
·u£wr
 ||

1304 
osdm­
->
	`g‘_•och
(è< 
•och_b¬r›r
) {

1305 
	`_maybe_»que¡_m­
();

1309 
m­
<
ûph_tid_t
, 
Op
*>::
™”©Ü
 
p
 = 
Ãed_»£nd
.
	`begš
();

1310 
p
 !ğ
Ãed_»£nd
.
	`’d
(); ++p) {

1311 
Op
 *
İ
 = 
p
->
£cÚd
;

1312 
OSDSessiÚ
 *
s
 = 
İ
->
£ssiÚ
;

1313 
boŞ
 
m­³d_£ssiÚ
 = 
çl£
;

1314 ià(!
s
) {

1315 
r
 = 
	`_m­_£ssiÚ
(&
İ
->
rg‘
, &
s
, 
sul
);

1316 
	`as£¹
(
r
 == 0);

1317 
m­³d_£ssiÚ
 = 
Œue
;

1319 
	`g‘_£ssiÚ
(
s
);

1321 
OSDSessiÚ
::
unique_lock
 
	`¦
(
s
->
lock
);

1322 ià(
m­³d_£ssiÚ
) {

1323 
	`_£ssiÚ_İ_assign
(
s
, 
İ
);

1325 ià(
İ
->
should_»£nd
) {

1326 ià(!
İ
->
£ssiÚ
->
	`is_hom–ess
(è&& !İ->
rg‘
.
·u£d
) {

1327 
logg”
->
	`šc
(
l_osdc_İ_»£nd
);

1328 
	`_£nd_İ
(
İ
);

1331 
	`_İ_ÿnûl_m­_check
(
İ
);

1332 
	`_ÿnûl_lšg”_İ
(
İ
);

1334 
¦
.
	`uÆock
();

1335 
	`put_£ssiÚ
(
s
);

1337 
li¡
<
Lšg”Op
*>::
™”©Ü
 
p
 = 
Ãed_»£nd_lšg”
.
	`begš
();

1338 
p
 !ğ
Ãed_»£nd_lšg”
.
	`’d
(); ++p) {

1339 
Lšg”Op
 *
İ
 = *
p
;

1340 ià(!
İ
->
£ssiÚ
) {

1341 
	`_ÿlc_rg‘
(&
İ
->
rg‘
, 
nuÎ±r
);

1342 
OSDSessiÚ
 *
s
 = 
NULL
;

1343 cÚ¡ 
r
 = 
	`_g‘_£ssiÚ
(
İ
->
rg‘
.
osd
, &
s
, 
sul
);

1344 
	`as£¹
(
r
 == 0);

1345 
	`as£¹
(
s
 !ğ
NULL
);

1346 
İ
->
£ssiÚ
 = 
s
;

1347 
	`put_£ssiÚ
(
s
);

1349 ià(!
İ
->
£ssiÚ
->
	`is_hom–ess
()) {

1350 
logg”
->
	`šc
(
l_osdc_lšg”_»£nd
);

1351 
	`_£nd_lšg”
(
İ
, 
sul
);

1354 
m­
<
ûph_tid_t
,
CommªdOp
*>::
™”©Ü
 
p
 = 
Ãed_»£nd_commªd
.
	`begš
();

1355 
p
 !ğ
Ãed_»£nd_commªd
.
	`’d
(); ++p) {

1356 
CommªdOp
 *
c
 = 
p
->
£cÚd
;

1357 ià(
c
->
rg‘
.
osd
 >= 0) {

1358 
	`_assign_commªd_£ssiÚ
(
c
, 
sul
);

1359 ià(
c
->
£ssiÚ
 && !c->£ssiÚ->
	`is_hom–ess
()) {

1360 
	`_£nd_commªd
(
c
);

1365 
	`_dump_aùive
();

1368 
m­
<
•och_t
,
li¡
< 
·œ
< 
CÚ‹xt
*, > > >::
™”©Ü
 
p
 =

1369 
wa™šg_fÜ_m­
.
	`begš
();

1370 
p
 !ğ
wa™šg_fÜ_m­
.
	`’d
() &&

1371 
p
->
fœ¡
 <ğ
osdm­
->
	`g‘_•och
()) {

1373 
li¡
<
·œ
<
CÚ‹xt
*, > >::
™”©Ü
 
i
 = 
p
->
£cÚd
.
	`begš
();

1374 
i
 !ğ
p
->
£cÚd
.
	`’d
(); ++i) {

1375 
i
->
fœ¡
->
	`com¶‘e
(i->
£cÚd
);

1377 
wa™šg_fÜ_m­
.
	`”a£
(
p
++);

1380 
mÚc
->
	`sub_gÙ
("osdm­", 
osdm­
->
	`g‘_•och
());

1382 ià(!
wa™šg_fÜ_m­
.
	`em±y
()) {

1383 
	`_maybe_»que¡_m­
();

1385 
	}
}

1387 
	gObjeù”
::
	$’abË_bÏckli¡_ev’ts
()

1389 
unique_lock
 
	`wl
(
rwlock
);

1391 
bÏckli¡_ev’ts_’abËd
 = 
Œue
;

1392 
	}
}

1394 
	gObjeù”
::
cÚsume_bÏckli¡_ev’ts
(
¡d
::
£t
<
’t™y_addr_t
> *
ev’ts
)

1396 
unique_lock
 
wl
(
rwlock
);

1398 ià(
	gev’ts
->
em±y
()) {

1399 
	gev’ts
->
sw­
(
bÏckli¡_ev’ts
);

1401 cÚ¡‡utØ&
	gi
 : 
bÏckli¡_ev’ts
) {

1402 
ev’ts
->
š£¹
(
i
);

1404 
	gbÏckli¡_ev’ts
.
ş—r
();

1408 
	gObjeù”
::
	$em™_bÏckli¡_ev’ts
(cÚ¡ 
OSDM­
::
Inüem’l
 &
šc
)

1410 ià(!
bÏckli¡_ev’ts_’abËd
) {

1414 cÚ¡‡utØ&
i
 : 
šc
.
Ãw_bÏckli¡
) {

1415 
bÏckli¡_ev’ts
.
	`š£¹
(
i
.
fœ¡
);

1417 
	}
}

1419 
	gObjeù”
::
	$em™_bÏckli¡_ev’ts
(cÚ¡ 
OSDM­
 &
Şd_osd_m­
,

1420 cÚ¡ 
OSDM­
 &
Ãw_osd_m­
)

1422 ià(!
bÏckli¡_ev’ts_’abËd
) {

1426 
¡d
::
£t
<
’t™y_addr_t
> 
Şd_£t
;

1427 
¡d
::
£t
<
’t™y_addr_t
> 
Ãw_£t
;

1429 
Şd_osd_m­
.
	`g‘_bÏckli¡
(&
Şd_£t
);

1430 
Ãw_osd_m­
.
	`g‘_bÏckli¡
(&
Ãw_£t
);

1432 
¡d
::
£t
<
’t™y_addr_t
> 
d–_£t
;

1433 
¡d
::
	`£t_difã»nû
(

1434 
Ãw_£t
.
	`begš
(),‚ew_£t.
	`’d
(), 
Şd_£t
.begin(), old_set.end(),

1435 
¡d
::
	`š£¹”
(
d–_£t
, d–_£t.
	`begš
()));

1436 
bÏckli¡_ev’ts
.
	`š£¹
(
d–_£t
.
	`begš
(), d–_£t.
	`’d
());

1437 
	}
}

1441 
	gObjeù”
::
C_Op_M­_L©e¡
::
	$fšish
(
r
)

1443 ià(
r
 =ğ-
EAGAIN
 ||„ =ğ-
ECANCELED
)

1446 
	`lg’”ic_subdout
(
objeù”
->
cù
, objecter, 10)

1447 << "İ_m­_Ï‹¡„=" << 
r
 << "id=" << 
tid


1448 << "†©e¡ " << 
Ï‹¡
 << 
d’dl
;

1450 
Objeù”
::
unique_lock
 
	`wl
(
objeù”
->
rwlock
);

1452 
m­
<
ûph_tid_t
, 
Op
*>::
™”©Ü
 
™”
 =

1453 
objeù”
->
check_Ï‹¡_m­_İs
.
	`fšd
(
tid
);

1454 ià(
™”
 =ğ
objeù”
->
check_Ï‹¡_m­_İs
.
	`’d
()) {

1455 
	`lg’”ic_subdout
(
objeù”
->
cù
, objecter, 10)

1456 << "İ_m­_Ï‹¡ o°"<< 
tid
 << "‚Ù found" << 
d’dl
;

1460 
Op
 *
İ
 = 
™”
->
£cÚd
;

1461 
objeù”
->
check_Ï‹¡_m­_İs
.
	`”a£
(
™”
);

1463 
	`lg’”ic_subdout
(
objeù”
->
cù
, objecter, 20)

1464 << "İ_m­_Ï‹¡ o°"<< 
İ
 << 
d’dl
;

1466 ià(
İ
->
m­_dÃ_bound
 == 0)

1467 
İ
->
m­_dÃ_bound
 = 
Ï‹¡
;

1469 
OSDSessiÚ
::
unique_lock
 
	`¦
(
İ
->
£ssiÚ
->
lock
, 
deãr_lock
);

1470 
objeù”
->
	`_check_İ_poŞ_dÃ
(
İ
, &
¦
);

1472 
İ
->
	`put
();

1473 
	}
}

1475 
	gObjeù”
::
	$poŞ_¢­_by_Çme
(
št64_t
 
poŞid
, cÚ¡ *
¢­_Çme
,

1476 
¢­id_t
 *
¢­
) const

1478 
sh¬ed_lock
 
	`¾
(
rwlock
);

1480 auto& 
poŞs
 = 
osdm­
->
	`g‘_poŞs
();

1481 autØ
™”
 = 
poŞs
.
	`fšd
(
poŞid
);

1482 ià(
™”
 =ğ
poŞs
.
	`’d
()) {

1483  -
ENOENT
;

1485 cÚ¡ 
pg_poŞ_t
& 
pg_poŞ
 = 
™”
->
£cÚd
;

1486 autØ
p
 = 
pg_poŞ
.
¢­s
.
	`begš
();

1487 
p
 !ğ
pg_poŞ
.
¢­s
.
	`’d
();

1488 ++
p
) {

1489 ià(
p
->
£cÚd
.
Çme
 =ğ
¢­_Çme
) {

1490 *
¢­
 = 
p
->
fœ¡
;

1494  -
ENOENT
;

1495 
	}
}

1497 
	gObjeù”
::
	$poŞ_¢­_g‘_šfo
(
št64_t
 
poŞid
, 
¢­id_t
 
¢­
,

1498 
poŞ_¢­_šfo_t
 *
šfo
) const

1500 
sh¬ed_lock
 
	`¾
(
rwlock
);

1502 auto& 
poŞs
 = 
osdm­
->
	`g‘_poŞs
();

1503 autØ
™”
 = 
poŞs
.
	`fšd
(
poŞid
);

1504 ià(
™”
 =ğ
poŞs
.
	`’d
()) {

1505  -
ENOENT
;

1507 cÚ¡ 
pg_poŞ_t
& 
pg_poŞ
 = 
™”
->
£cÚd
;

1508 autØ
p
 = 
pg_poŞ
.
¢­s
.
	`fšd
(
¢­
);

1509 ià(
p
 =ğ
pg_poŞ
.
¢­s
.
	`’d
())

1510  -
ENOENT
;

1511 *
šfo
 = 
p
->
£cÚd
;

1514 
	}
}

1516 
	gObjeù”
::
poŞ_¢­_li¡
(
št64_t
 
poŞid
, 
veùÜ
<
ušt64_t
> *
¢­s
)

1518 
sh¬ed_lock
 
¾
(
rwlock
);

1520 cÚ¡ 
pg_poŞ_t
 *
	gpi
 = 
osdm­
->
g‘_pg_poŞ
(
poŞid
);

1521 ià(!
	gpi
)

1522  -
	gENOENT
;

1523 
	gm­
<
	g¢­id_t
,
	gpoŞ_¢­_šfo_t
>::
cÚ¡_™”©Ü
 
p
 = 
pi
->
¢­s
.
begš
();

1524 
	gp
 !ğ
pi
->
¢­s
.
’d
();

1525 ++
	gp
) {

1526 
	g¢­s
->
push_back
(
p
->
fœ¡
);

1532 
	gObjeù”
::
	$_check_İ_poŞ_dÃ
(
Op
 *
İ
, 
unique_lock
 *
¦
)

1536 ià(
İ
->
rg‘
.
poŞ_ev”_exi¡ed
) {

1539 
İ
->
m­_dÃ_bound
 = 
osdm­
->
	`g‘_•och
();

1540 
	`ldout
(
cù
, 10è<< "check_İ_poŞ_dÃid " << 
İ
->
tid


1542 << 
d’dl
;

1544 
	`ldout
(
cù
, 10è<< "check_İ_poŞ_dÃid " << 
İ
->
tid


1545 << " cu¼’ˆ" << 
osdm­
->
	`g‘_•och
()

1546 << " m­_dÃ_bound " << 
İ
->
m­_dÃ_bound


1547 << 
d’dl
;

1549 ià(
İ
->
m­_dÃ_bound
 > 0) {

1550 ià(
osdm­
->
	`g‘_•och
(è>ğ
İ
->
m­_dÃ_bound
) {

1552 
	`ldout
(
cù
, 10è<< "check_İ_poŞ_dÃid " << 
İ
->
tid


1553 << " cÚşudšg…oŞ " << 
İ
->
rg‘
.
ba£_pgid
.
	`poŞ
()

1554 << " dÃ" << 
d’dl
;

1555 ià(
İ
->
Úfšish
) {

1556 
num_š_æight
--;

1557 
İ
->
Úfšish
->
	`com¶‘e
(-
ENOENT
);

1560 
OSDSessiÚ
 *
s
 = 
İ
->
£ssiÚ
;

1561 ià(
s
) {

1562 
	`as£¹
(
s
 !ğ
NULL
);

1563 
	`as£¹
(
¦
->
	`mu‹x
(è=ğ&
s
->
lock
);

1564 
boŞ
 
£ssiÚ_locked
 = 
¦
->
	`owns_lock
();

1565 ià(!
£ssiÚ_locked
) {

1566 
¦
->
	`lock
();

1568 
	`_fšish_İ
(
İ
, 0);

1569 ià(!
£ssiÚ_locked
) {

1570 
¦
->
	`uÆock
();

1573 
	`_fšish_İ
(
İ
, 0);

1577 
	`_£nd_İ_m­_check
(
İ
);

1579 
	}
}

1581 
	gObjeù”
::
	$_£nd_İ_m­_check
(
Op
 *
İ
)

1585 ià(
check_Ï‹¡_m­_İs
.
	`couÁ
(
İ
->
tid
) == 0) {

1586 
İ
->
	`g‘
();

1587 
check_Ï‹¡_m­_İs
[
İ
->
tid
] = op;

1588 
C_Op_M­_L©e¡
 *
c
 = 
Ãw
 
	`C_Op_M­_L©e¡
(
this
, 
İ
->
tid
);

1589 
mÚc
->
	`g‘_v”siÚ
("osdm­", &
c
->
Ï‹¡
, 
NULL
, c);

1591 
	}
}

1593 
	gObjeù”
::
	$_İ_ÿnûl_m­_check
(
Op
 *
İ
)

1596 
m­
<
ûph_tid_t
, 
Op
*>::
™”©Ü
 
™”
 =

1597 
check_Ï‹¡_m­_İs
.
	`fšd
(
İ
->
tid
);

1598 ià(
™”
 !ğ
check_Ï‹¡_m­_İs
.
	`’d
()) {

1599 
Op
 *
İ
 = 
™”
->
£cÚd
;

1600 
İ
->
	`put
();

1601 
check_Ï‹¡_m­_İs
.
	`”a£
(
™”
);

1603 
	}
}

1607 
	gObjeù”
::
C_Lšg”_M­_L©e¡
::
	$fšish
(
r
)

1609 ià(
r
 =ğ-
EAGAIN
 ||„ =ğ-
ECANCELED
) {

1614 
unique_lock
 
	`wl
(
objeù”
->
rwlock
);

1616 
m­
<
ušt64_t
, 
Lšg”Op
*>::
™”©Ü
 
™”
 =

1617 
objeù”
->
check_Ï‹¡_m­_lšg”s
.
	`fšd
(
lšg”_id
);

1618 ià(
™”
 =ğ
objeù”
->
check_Ï‹¡_m­_lšg”s
.
	`’d
()) {

1622 
Lšg”Op
 *
İ
 = 
™”
->
£cÚd
;

1623 
objeù”
->
check_Ï‹¡_m­_lšg”s
.
	`”a£
(
™”
);

1625 ià(
İ
->
m­_dÃ_bound
 == 0)

1626 
İ
->
m­_dÃ_bound
 = 
Ï‹¡
;

1628 
boŞ
 
uÄegi¡”
;

1629 
objeù”
->
	`_check_lšg”_poŞ_dÃ
(
İ
, &
uÄegi¡”
);

1631 ià(
uÄegi¡”
) {

1632 
objeù”
->
	`_lšg”_ÿnûl
(
İ
);

1635 
İ
->
	`put
();

1636 
	}
}

1638 
	gObjeù”
::
	$_check_lšg”_poŞ_dÃ
(
Lšg”Op
 *
İ
, 
boŞ
 *
Ãed_uÄegi¡”
)

1642 *
Ãed_uÄegi¡”
 = 
çl£
;

1644 ià(
İ
->
»gi¡”_g’
 > 0) {

1645 
	`ldout
(
cù
, 10è<< "_check_lšg”_poŞ_dÃ†šg”_id " << 
İ
->
lšg”_id


1647 << 
d’dl
;

1648 
İ
->
m­_dÃ_bound
 = 
osdm­
->
	`g‘_•och
();

1650 
	`ldout
(
cù
, 10è<< "_check_lšg”_poŞ_dÃ†šg”_id " << 
İ
->
lšg”_id


1651 << " cu¼’ˆ" << 
osdm­
->
	`g‘_•och
()

1652 << " m­_dÃ_bound " << 
İ
->
m­_dÃ_bound


1653 << 
d’dl
;

1655 ià(
İ
->
m­_dÃ_bound
 > 0) {

1656 ià(
osdm­
->
	`g‘_•och
(è>ğ
İ
->
m­_dÃ_bound
) {

1657 
Lšg”Op
::
unique_lock
 
wl
{
İ
->
w©ch_lock
};

1658 ià(
İ
->
Ú_»g_comm™
) {

1659 
İ
->
Ú_»g_comm™
->
	`com¶‘e
(-
ENOENT
);

1660 
İ
->
Ú_»g_comm™
 = 
nuÎ±r
;

1662 ià(
İ
->
Ú_nÙify_fšish
) {

1663 
İ
->
Ú_nÙify_fšish
->
	`com¶‘e
(-
ENOENT
);

1664 
İ
->
Ú_nÙify_fšish
 = 
nuÎ±r
;

1666 *
Ãed_uÄegi¡”
 = 
Œue
;

1669 
	`_£nd_lšg”_m­_check
(
İ
);

1671 
	}
}

1673 
	gObjeù”
::
	$_£nd_lšg”_m­_check
(
Lšg”Op
 *
İ
)

1676 ià(
check_Ï‹¡_m­_lšg”s
.
	`couÁ
(
İ
->
lšg”_id
) == 0) {

1677 
İ
->
	`g‘
();

1678 
check_Ï‹¡_m­_lšg”s
[
İ
->
lšg”_id
] = op;

1679 
C_Lšg”_M­_L©e¡
 *
c
 = 
Ãw
 
	`C_Lšg”_M­_L©e¡
(
this
, 
İ
->
lšg”_id
);

1680 
mÚc
->
	`g‘_v”siÚ
("osdm­", &
c
->
Ï‹¡
, 
NULL
, c);

1682 
	}
}

1684 
	gObjeù”
::
	$_lšg”_ÿnûl_m­_check
(
Lšg”Op
 *
İ
)

1688 
m­
<
ušt64_t
, 
Lšg”Op
*>::
™”©Ü
 
™”
 =

1689 
check_Ï‹¡_m­_lšg”s
.
	`fšd
(
İ
->
lšg”_id
);

1690 ià(
™”
 !ğ
check_Ï‹¡_m­_lšg”s
.
	`’d
()) {

1691 
Lšg”Op
 *
İ
 = 
™”
->
£cÚd
;

1692 
İ
->
	`put
();

1693 
check_Ï‹¡_m­_lšg”s
.
	`”a£
(
™”
);

1695 
	}
}

1699 
	gObjeù”
::
C_Commªd_M­_L©e¡
::
	$fšish
(
r
)

1701 ià(
r
 =ğ-
EAGAIN
 ||„ =ğ-
ECANCELED
) {

1706 
unique_lock
 
	`wl
(
objeù”
->
rwlock
);

1708 
m­
<
ušt64_t
, 
CommªdOp
*>::
™”©Ü
 
™”
 =

1709 
objeù”
->
check_Ï‹¡_m­_commªds
.
	`fšd
(
tid
);

1710 ià(
™”
 =ğ
objeù”
->
check_Ï‹¡_m­_commªds
.
	`’d
()) {

1714 
CommªdOp
 *
c
 = 
™”
->
£cÚd
;

1715 
objeù”
->
check_Ï‹¡_m­_commªds
.
	`”a£
(
™”
);

1717 ià(
c
->
m­_dÃ_bound
 == 0)

1718 
c
->
m­_dÃ_bound
 = 
Ï‹¡
;

1720 
OSDSessiÚ
::
unique_lock
 
	`sul
(
c
->
£ssiÚ
->
lock
);

1721 
objeù”
->
	`_check_commªd_m­_dÃ
(
c
);

1722 
sul
.
	`uÆock
();

1724 
c
->
	`put
();

1725 
	}
}

1727 
	gObjeù”
::
	$_check_commªd_m­_dÃ
(
CommªdOp
 *
c
)

1732 
	`ldout
(
cù
, 10è<< "_check_commªd_m­_dÃid " << 
c
->
tid


1733 << " cu¼’ˆ" << 
osdm­
->
	`g‘_•och
()

1734 << " m­_dÃ_bound " << 
c
->
m­_dÃ_bound


1735 << 
d’dl
;

1736 ià(
c
->
m­_dÃ_bound
 > 0) {

1737 ià(
osdm­
->
	`g‘_•och
(è>ğ
c
->
m­_dÃ_bound
) {

1738 
	`_fšish_commªd
(
c
, c->
m­_check_”rÜ
, c->
m­_check_”rÜ_¡r
);

1741 
	`_£nd_commªd_m­_check
(
c
);

1743 
	}
}

1745 
	gObjeù”
::
	$_£nd_commªd_m­_check
(
CommªdOp
 *
c
)

1751 ià(
check_Ï‹¡_m­_commªds
.
	`couÁ
(
c
->
tid
) == 0) {

1752 
c
->
	`g‘
();

1753 
check_Ï‹¡_m­_commªds
[
c
->
tid
] = c;

1754 
C_Commªd_M­_L©e¡
 *
f
 = 
Ãw
 
	`C_Commªd_M­_L©e¡
(
this
, 
c
->
tid
);

1755 
mÚc
->
	`g‘_v”siÚ
("osdm­", &
f
->
Ï‹¡
, 
NULL
, f);

1757 
	}
}

1759 
	gObjeù”
::
	$_commªd_ÿnûl_m­_check
(
CommªdOp
 *
c
)

1763 
m­
<
ušt64_t
, 
CommªdOp
*>::
™”©Ü
 
™”
 =

1764 
check_Ï‹¡_m­_commªds
.
	`fšd
(
c
->
tid
);

1765 ià(
™”
 !ğ
check_Ï‹¡_m­_commªds
.
	`’d
()) {

1766 
CommªdOp
 *
c
 = 
™”
->
£cÚd
;

1767 
c
->
	`put
();

1768 
check_Ï‹¡_m­_commªds
.
	`”a£
(
™”
);

1770 
	}
}

1779 
	gObjeù”
::
	$_g‘_£ssiÚ
(
osd
, 
OSDSessiÚ
 **
£ssiÚ
, 
shunique_lock
& 
sul
)

1781 
	`as£¹
(
sul
 && sul.
	`mu‹x
(è=ğ&
rwlock
);

1783 ià(
osd
 < 0) {

1784 *
£ssiÚ
 = 
hom–ess_£ssiÚ
;

1785 
	`ldout
(
cù
, 20è<< 
__func__
 << " osd=" << 
osd
 << "„eturning homeless"

1786 << 
d’dl
;

1790 
m­
<,
OSDSessiÚ
*>::
™”©Ü
 
p
 = 
osd_£ssiÚs
.
	`fšd
(
osd
);

1791 ià(
p
 !ğ
osd_£ssiÚs
.
	`’d
()) {

1792 
OSDSessiÚ
 *
s
 = 
p
->
£cÚd
;

1793 
s
->
	`g‘
();

1794 *
£ssiÚ
 = 
s
;

1795 
	`ldout
(
cù
, 20è<< 
__func__
 << " s=" << 
s
 << " osd=" << 
osd
 << " "

1796 << 
s
->
	`g‘_Äef
(è<< 
d’dl
;

1799 ià(!
sul
.
	`owns_lock
()) {

1800  -
EAGAIN
;

1802 
OSDSessiÚ
 *
s
 = 
Ãw
 
	`OSDSessiÚ
(
cù
, 
osd
);

1803 
osd_£ssiÚs
[
osd
] = 
s
;

1804 
s
->
cÚ
 = 
mes£ng”
->
	`g‘_cÚÃùiÚ
(
osdm­
->
	`g‘_š¡
(
osd
));

1805 
s
->
cÚ
->
	`£t_´iv
(s->
	`g‘
());

1806 
logg”
->
	`šc
(
l_osdc_osd_£ssiÚ_İ’
);

1807 
logg”
->
	`£t
(
l_osdc_osd_£ssiÚs
, 
osd_£ssiÚs
.
	`size
());

1808 
s
->
	`g‘
();

1809 *
£ssiÚ
 = 
s
;

1810 
	`ldout
(
cù
, 20è<< 
__func__
 << " s=" << 
s
 << " osd=" << 
osd
 << " "

1811 << 
s
->
	`g‘_Äef
(è<< 
d’dl
;

1813 
	}
}

1815 
	gObjeù”
::
	$put_£ssiÚ
(
Objeù”
::
OSDSessiÚ
 *
s
)

1817 ià(
s
 && !s->
	`is_hom–ess
()) {

1818 
	`ldout
(
cù
, 20è<< 
__func__
 << " s=" << 
s
 << " osd=" << s->
osd
 << " "

1819 << 
s
->
	`g‘_Äef
(è<< 
d’dl
;

1820 
s
->
	`put
();

1822 
	}
}

1824 
	gObjeù”
::
	$g‘_£ssiÚ
(
Objeù”
::
OSDSessiÚ
 *
s
)

1826 
	`as£¹
(
s
 !ğ
NULL
);

1828 ià(!
s
->
	`is_hom–ess
()) {

1829 
	`ldout
(
cù
, 20è<< 
__func__
 << " s=" << 
s
 << " osd=" << s->
osd
 << " "

1830 << 
s
->
	`g‘_Äef
(è<< 
d’dl
;

1831 
s
->
	`g‘
();

1833 
	}
}

1835 
	gObjeù”
::
	$_»İ’_£ssiÚ
(
OSDSessiÚ
 *
s
)

1839 
’t™y_š¡_t
 
š¡
 = 
osdm­
->
	`g‘_š¡
(
s
->
osd
);

1840 
	`ldout
(
cù
, 10è<< "»İ’_£ssiÚ osd." << 
s
->
osd
 << " session,‡ddr‚ow "

1841 << 
š¡
 << 
d’dl
;

1842 ià(
s
->
cÚ
) {

1843 
s
->
cÚ
->
	`£t_´iv
(
NULL
);

1844 
s
->
cÚ
->
	`m¬k_down
();

1845 
logg”
->
	`šc
(
l_osdc_osd_£ssiÚ_şo£
);

1847 
s
->
cÚ
 = 
mes£ng”
->
	`g‘_cÚÃùiÚ
(
š¡
);

1848 
s
->
cÚ
->
	`£t_´iv
(s->
	`g‘
());

1849 
s
->
šÿº©iÚ
++;

1850 
logg”
->
	`šc
(
l_osdc_osd_£ssiÚ_İ’
);

1851 
	}
}

1853 
	gObjeù”
::
	$şo£_£ssiÚ
(
OSDSessiÚ
 *
s
)

1857 
	`ldout
(
cù
, 10è<< "şo£_£ssiÚ fÜ osd." << 
s
->
osd
 << 
d’dl
;

1858 ià(
s
->
cÚ
) {

1859 
s
->
cÚ
->
	`£t_´iv
(
NULL
);

1860 
s
->
cÚ
->
	`m¬k_down
();

1861 
logg”
->
	`šc
(
l_osdc_osd_£ssiÚ_şo£
);

1863 
OSDSessiÚ
::
unique_lock
 
	`¦
(
s
->
lock
);

1865 
¡d
::
li¡
<
Lšg”Op
*> 
hom–ess_lšg”s
;

1866 
¡d
::
li¡
<
CommªdOp
*> 
hom–ess_commªds
;

1867 
¡d
::
li¡
<
Op
*> 
hom–ess_İs
;

1869 !
s
->
lšg”_İs
.
	`em±y
()) {

1870 
¡d
::
m­
<
ušt64_t
, 
Lšg”Op
*>::
™”©Ü
 
i
 = 
s
->
lšg”_İs
.
	`begš
();

1871 
	`ldout
(
cù
, 10è<< "†šg”_İ " << 
i
->
fœ¡
 << 
d’dl
;

1872 
hom–ess_lšg”s
.
	`push_back
(
i
->
£cÚd
);

1873 
	`_£ssiÚ_lšg”_İ_»move
(
s
, 
i
->
£cÚd
);

1876 !
s
->
İs
.
	`em±y
()) {

1877 
¡d
::
m­
<
ûph_tid_t
, 
Op
*>::
™”©Ü
 
i
 = 
s
->
İs
.
	`begš
();

1878 
	`ldout
(
cù
, 10è<< " o°" << 
i
->
fœ¡
 << 
d’dl
;

1879 
hom–ess_İs
.
	`push_back
(
i
->
£cÚd
);

1880 
	`_£ssiÚ_İ_»move
(
s
, 
i
->
£cÚd
);

1883 !
s
->
commªd_İs
.
	`em±y
()) {

1884 
¡d
::
m­
<
ûph_tid_t
, 
CommªdOp
*>::
™”©Ü
 
i
 = 
s
->
commªd_İs
.
	`begš
();

1885 
	`ldout
(
cù
, 10è<< " commªd_İ " << 
i
->
fœ¡
 << 
d’dl
;

1886 
hom–ess_commªds
.
	`push_back
(
i
->
£cÚd
);

1887 
	`_£ssiÚ_commªd_İ_»move
(
s
, 
i
->
£cÚd
);

1890 
osd_£ssiÚs
.
	`”a£
(
s
->
osd
);

1891 
¦
.
	`uÆock
();

1892 
	`put_£ssiÚ
(
s
);

1896 
OSDSessiÚ
::
unique_lock
 
	`h¦
(
hom–ess_£ssiÚ
->
lock
);

1897 
¡d
::
li¡
<
Lšg”Op
*>::
™”©Ü
 
i
 = 
hom–ess_lšg”s
.
	`begš
();

1898 
i
 !ğ
hom–ess_lšg”s
.
	`’d
(); ++i) {

1899 
	`_£ssiÚ_lšg”_İ_assign
(
hom–ess_£ssiÚ
, *
i
);

1901 
¡d
::
li¡
<
Op
*>::
™”©Ü
 
i
 = 
hom–ess_İs
.
	`begš
();

1902 
i
 !ğ
hom–ess_İs
.
	`’d
(); ++i) {

1903 
	`_£ssiÚ_İ_assign
(
hom–ess_£ssiÚ
, *
i
);

1905 
¡d
::
li¡
<
CommªdOp
*>::
™”©Ü
 
i
 = 
hom–ess_commªds
.
	`begš
();

1906 
i
 !ğ
hom–ess_commªds
.
	`’d
(); ++i) {

1907 
	`_£ssiÚ_commªd_İ_assign
(
hom–ess_£ssiÚ
, *
i
);

1911 
logg”
->
	`£t
(
l_osdc_osd_£ssiÚs
, 
osd_£ssiÚs
.
	`size
());

1912 
	}
}

1914 
	gObjeù”
::
	$wa™_fÜ_osd_m­
()

1916 
unique_lock
 
	`l
(
rwlock
);

1917 ià(
osdm­
->
	`g‘_•och
()) {

1918 
l
.
	`uÆock
();

1923 
Mu‹x
 
	`lock
("");

1924 
CÚd
 
cÚd
;

1925 
boŞ
 
dÚe
;

1926 
lock
.
	`Lock
();

1927 
C_SaãCÚd
 *
cÚ‹xt
 = 
Ãw
 
	`C_SaãCÚd
(&
lock
, &
cÚd
, &
dÚe
, 
NULL
);

1928 
wa™šg_fÜ_m­
[0].
	`push_back
(
·œ
<
CÚ‹xt
*, >(
cÚ‹xt
, 0));

1929 
l
.
	`uÆock
();

1930 !
dÚe
)

1931 
cÚd
.
	`Wa™
(
lock
);

1932 
lock
.
	`UÆock
();

1933 
	}
}

1935 
	gC_Objeù”_G‘V”siÚ
 : 
public
 
CÚ‹xt
 {

1936 
Objeù”
 *
objeù”
;

1937 
ušt64_t
 
	gŞde¡
, 
	gÃwe¡
;

1938 
CÚ‹xt
 *
	gfš
;

1939 
C_Objeù”_G‘V”siÚ
(
Objeù”
 *
o
, 
CÚ‹xt
 *
c
)

1940 : 
objeù”
(
o
), 
Şde¡
(0), 
Ãwe¡
(0), 
fš
(
c
) {}

1941 
fšish
(
r
è
	gov”ride
 {

1942 ià(
	gr
 >= 0) {

1943 
objeù”
->
g‘_Ï‹¡_v”siÚ
(
Şde¡
, 
Ãwe¡
, 
fš
);

1944 } ià(
	gr
 =ğ-
EAGAIN
) {

1945 
objeù”
->
wa™_fÜ_Ï‹¡_osdm­
(
fš
);

1948 
ûph_abÜt
();

1953 
	gObjeù”
::
	$wa™_fÜ_Ï‹¡_osdm­
(
CÚ‹xt
 *
fš
)

1955 
	`ldout
(
cù
, 10è<< 
__func__
 << 
d’dl
;

1956 
C_Objeù”_G‘V”siÚ
 *
c
 = 
Ãw
 
	`C_Objeù”_G‘V”siÚ
(
this
, 
fš
);

1957 
mÚc
->
	`g‘_v”siÚ
("osdm­", &
c
->
Ãwe¡
, &c->
Şde¡
, c);

1958 
	}
}

1960 
	gObjeù”
::
	$g‘_Ï‹¡_v”siÚ
(
•och_t
 
Şde¡
,ƒpoch_ˆ
Ãwe¡
, 
CÚ‹xt
 *
fš
)

1962 
unique_lock
 
	`wl
(
rwlock
);

1963 
	`_g‘_Ï‹¡_v”siÚ
(
Şde¡
, 
Ãwe¡
, 
fš
);

1964 
	}
}

1966 
	gObjeù”
::
	$_g‘_Ï‹¡_v”siÚ
(
•och_t
 
Şde¡
,ƒpoch_ˆ
Ãwe¡
,

1967 
CÚ‹xt
 *
fš
)

1970 ià(
osdm­
->
	`g‘_•och
(è>ğ
Ãwe¡
) {

1971 
	`ldout
(
cù
, 10è<< 
__func__
 << "†©e¡ " << 
Ãwe¡
 << ", hav™" << 
d’dl
;

1972 ià(
fš
)

1973 
fš
->
	`com¶‘e
(0);

1977 
	`ldout
(
cù
, 10è<< 
__func__
 << "†©e¡ " << 
Ãwe¡
 << ", wa™šg" << 
d’dl
;

1978 
	`_wa™_fÜ_Ãw_m­
(
fš
, 
Ãwe¡
, 0);

1979 
	}
}

1981 
	gObjeù”
::
	$maybe_»que¡_m­
()

1983 
sh¬ed_lock
 
	`¾
(
rwlock
);

1984 
	`_maybe_»que¡_m­
();

1985 
	}
}

1987 
	gObjeù”
::
	$_maybe_»que¡_m­
()

1990 
æag
 = 0;

1991 ià(
	`_osdm­_fuÎ_æag
()

1992 || 
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_PAUSERD
)

1993 || 
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_PAUSEWR
)) {

1994 
	`ldout
(
cù
, 10) << "_maybe_request_map subscribing (continuous)o‚ext "

1995 "osd m­ (FULL fÏg i £t)" << 
d’dl
;

1997 
	`ldout
(
cù
, 10)

1998 << "_maybe_»que¡_m­ subsüibšg (Ú‘imeètØÃxˆosd m­" << 
d’dl
;

1999 
æag
 = 
CEPH_SUBSCRIBE_ONETIME
;

2001 
•och_t
 
•och
 = 
osdm­
->
	`g‘_•och
() ? osdmap->get_epoch()+1 : 0;

2002 ià(
mÚc
->
	`sub_wªt
("osdm­", 
•och
, 
æag
)) {

2003 
mÚc
->
	`»Ãw_subs
();

2005 
	}
}

2007 
	gObjeù”
::
	$_wa™_fÜ_Ãw_m­
(
CÚ‹xt
 *
c
, 
•och_t
 
•och
, 
”r
)

2010 
wa™šg_fÜ_m­
[
•och
].
	`push_back
(
·œ
<
CÚ‹xt
 *, >(
c
, 
”r
));

2011 
	`_maybe_»que¡_m­
();

2012 
	}
}

2025 
boŞ
 
	gObjeù”
::
	$have_m­
(cÚ¡ 
•och_t
 
•och
)

2027 
sh¬ed_lock
 
	`¾
(
rwlock
);

2028 ià(
osdm­
->
	`g‘_•och
(è>ğ
•och
) {

2029  
Œue
;

2031  
çl£
;

2033 
	}
}

2035 
boŞ
 
	gObjeù”
::
	$wa™_fÜ_m­
(
•och_t
 
•och
, 
CÚ‹xt
 *
c
, 
”r
)

2037 
unique_lock
 
	`wl
(
rwlock
);

2038 ià(
osdm­
->
	`g‘_•och
(è>ğ
•och
) {

2039  
Œue
;

2041 
	`_wa™_fÜ_Ãw_m­
(
c
, 
•och
, 
”r
);

2042  
çl£
;

2043 
	}
}

2045 
	gObjeù”
::
_kick_»que¡s
(
OSDSessiÚ
 *
£ssiÚ
,

2046 
m­
<
ušt64_t
, 
Lšg”Op
 *>& 
Ìe£nd
)

2051 
	g£ssiÚ
->
	gbackoffs
.
ş—r
();

2052 
	g£ssiÚ
->
	gbackoffs_by_id
.
ş—r
();

2055 
	gm­
<
	gûph_tid_t
,
	gOp
*> 
	g»£nd
;

2056 
	gm­
<
	gûph_tid_t
, 
	gOp
*>::
™”©Ü
 
p
 = 
£ssiÚ
->
İs
.
begš
();

2057 
	gp
 !ğ
£ssiÚ
->
İs
.
’d
();) {

2058 
Op
 *
	gİ
 = 
p
->
£cÚd
;

2059 ++
	gp
;

2060 ià(
	gİ
->
	gshould_»£nd
) {

2061 ià(!
	gİ
->
	grg‘
.
	g·u£d
)

2062 
	g»£nd
[
İ
->
tid
] = op;

2064 
_İ_ÿnûl_m­_check
(
İ
);

2065 
_ÿnûl_lšg”_İ
(
İ
);

2069 
	glogg”
->
šc
(
l_osdc_İ_»£nd
, 
»£nd
.
size
());

2070 !
	g»£nd
.
em±y
()) {

2071 
_£nd_İ
(
»£nd
.
begš
()->
£cÚd
);

2072 
	g»£nd
.
”a£
(
»£nd
.
begš
());

2076 
	glogg”
->
šc
(
l_osdc_lšg”_»£nd
, 
£ssiÚ
->
lšg”_İs
.
size
());

2077 
	gm­
<
	gûph_tid_t
, 
	gLšg”Op
*>::
™”©Ü
 
j
 = 
£ssiÚ
->
lšg”_İs
.
begš
();

2078 
	gj
 !ğ
£ssiÚ
->
lšg”_İs
.
’d
(); ++j) {

2079 
Lšg”Op
 *
	gİ
 = 
j
->
£cÚd
;

2080 
	gİ
->
g‘
();

2081 
as£¹
(
Ìe£nd
.
couÁ
(
j
->
fœ¡
) == 0);

2082 
	gÌe£nd
[
j
->
fœ¡
] = 
İ
;

2086 
	glogg”
->
šc
(
l_osdc_commªd_»£nd
, 
£ssiÚ
->
commªd_İs
.
size
());

2087 
	gm­
<
	gušt64_t
,
	gCommªdOp
*> 
	güe£nd
;

2088 
	gm­
<
	gûph_tid_t
, 
	gCommªdOp
*>::
™”©Ü
 
k
 = 
£ssiÚ
->
commªd_İs
.
begš
();

2089 
	gk
 !ğ
£ssiÚ
->
commªd_İs
.
’d
(); ++k) {

2090 
	güe£nd
[
k
->
fœ¡
] = k->
£cÚd
;

2092 !
	güe£nd
.
em±y
()) {

2093 
_£nd_commªd
(
üe£nd
.
begš
()->
£cÚd
);

2094 
	güe£nd
.
”a£
(
üe£nd
.
begš
());

2098 
	gObjeù”
::
_lšg”_İs_»£nd
(
m­
<
ušt64_t
, 
Lšg”Op
 *>& 
Ìe£nd
,

2099 
unique_lock
& 
ul
)

2101 
as£¹
(
ul
.
owns_lock
());

2102 
shunique_lock
 
sul
(
¡d
::
move
(
ul
));

2103 !
	gÌe£nd
.
em±y
()) {

2104 
Lšg”Op
 *
	gİ
 = 
Ìe£nd
.
begš
()->
£cÚd
;

2105 ià(!
	gİ
->
	gÿnûËd
) {

2106 
_£nd_lšg”
(
İ
, 
sul
);

2108 
	gİ
->
put
();

2109 
	gÌe£nd
.
”a£
(
Ìe£nd
.
begš
());

2111 
	gul
 = 
sul
.
»Ëa£_to_unique
();

2114 
	gObjeù”
::
	$¡¬t_tick
()

2116 
	`as£¹
(
tick_ev’t
 == 0);

2117 
tick_ev’t
 =

2118 
tim”
.
	`add_ev’t
(
ûph
::
	`make_time¥ª
(
cù
->
_cÚf
->
objeù”_tick_š‹rv®
),

2119 &
Objeù”
::
tick
, 
this
);

2120 
	}
}

2122 
	gObjeù”
::
	$tick
()

2124 
sh¬ed_lock
 
	`¾
(
rwlock
);

2126 
	`ldout
(
cù
, 10è<< "tick" << 
d’dl
;

2129 
tick_ev’t
 = 0;

2131 ià(!
š™Ÿlized
) {

2133 
	`ldout
(
cù
, 10è<< 
__func__
 << "„aûd w™h shutdown" << 
d’dl
;

2137 
£t
<
OSDSessiÚ
*> 
tİšg
;

2141 autØ
cutoff
 = 
ûph
::
cßr£_mÚo_şock
::
	`now
();

2142 
cutoff
 -ğ
ûph
::
	`make_time¥ª
(
cù
->
_cÚf
->
objeù”_timeout
);

2144 
Ïggy_İs
 = 0;

2146 
m­
<,
OSDSessiÚ
*>::
™”©Ü
 
s™”
 = 
osd_£ssiÚs
.
	`begš
();

2147 
s™”
 !ğ
osd_£ssiÚs
.
	`’d
(); ++siter) {

2148 
OSDSessiÚ
 *
s
 = 
s™”
->
£cÚd
;

2149 
OSDSessiÚ
::
lock_gu¬d
 
	`l
(
s
->
lock
);

2150 
boŞ
 
found
 = 
çl£
;

2151 
m­
<
ûph_tid_t
,
Op
*>::
™”©Ü
 
p
 = 
s
->
İs
.
	`begš
();

2152 
p
 !ğ
s
->
İs
.
	`’d
();

2153 ++
p
) {

2154 
Op
 *
İ
 = 
p
->
£cÚd
;

2155 
	`as£¹
(
İ
->
£ssiÚ
);

2156 ià(
İ
->
¡amp
 < 
cutoff
) {

2157 
	`ldout
(
cù
, 2è<< "id " << 
p
->
fœ¡
 << " oÀosd." << 
İ
->
£ssiÚ
->
osd


2158 << " i Ïggy" << 
d’dl
;

2159 
found
 = 
Œue
;

2160 ++
Ïggy_İs
;

2163 
m­
<
ušt64_t
,
Lšg”Op
*>::
™”©Ü
 
p
 = 
s
->
lšg”_İs
.
	`begš
();

2164 
p
 !ğ
s
->
lšg”_İs
.
	`’d
();

2165 ++
p
) {

2166 
Lšg”Op
 *
İ
 = 
p
->
£cÚd
;

2167 
Lšg”Op
::
unique_lock
 
	`wl
(
İ
->
w©ch_lock
);

2168 
	`as£¹
(
İ
->
£ssiÚ
);

2169 
	`ldout
(
cù
, 10è<< "…šgšg osdh© s”ve lšg”šgid " << 
p
->
fœ¡


2170 << " (osd." << 
İ
->
£ssiÚ
->
osd
 << ")" << 
d’dl
;

2171 
found
 = 
Œue
;

2172 ià(
İ
->
is_w©ch
 && op->
»gi¡”ed
 && !İ->
Ï¡_”rÜ
)

2173 
	`_£nd_lšg”_pšg
(
İ
);

2175 
m­
<
ušt64_t
,
CommªdOp
*>::
™”©Ü
 
p
 = 
s
->
commªd_İs
.
	`begš
();

2176 
p
 !ğ
s
->
commªd_İs
.
	`’d
();

2177 ++
p
) {

2178 
CommªdOp
 *
İ
 = 
p
->
£cÚd
;

2179 
	`as£¹
(
İ
->
£ssiÚ
);

2180 
	`ldout
(
cù
, 10è<< "…šgšg osdh© s”ve commªdid " << 
p
->
fœ¡


2181 << " (osd." << 
İ
->
£ssiÚ
->
osd
 << ")" << 
d’dl
;

2182 
found
 = 
Œue
;

2184 ià(
found
)

2185 
tİšg
.
	`š£¹
(
s
);

2187 ià(
num_hom–ess_İs
 || !
tİšg
.
	`em±y
()) {

2188 
	`_maybe_»que¡_m­
();

2191 
logg”
->
	`£t
(
l_osdc_İ_Ïggy
, 
Ïggy_İs
);

2192 
logg”
->
	`£t
(
l_osdc_osd_Ïggy
, 
tİšg
.
	`size
());

2194 ià(!
tİšg
.
	`em±y
()) {

2197 
£t
<
OSDSessiÚ
*>::
cÚ¡_™”©Ü
 
i
 = 
tİšg
.
	`begš
();

2198 
i
 !ğ
tİšg
.
	`’d
();

2199 ++
i
) {

2200 (*
i
)->
cÚ
->
	`£nd_mes§ge
(
Ãw
 
MPšg
);

2205 ià(
š™Ÿlized
) {

2206 
tick_ev’t
 = 
tim”
.
	`»scheduË_me
(
ûph
::
	`make_time¥ª
(

2207 
cù
->
_cÚf
->
objeù”_tick_š‹rv®
));

2209 
	}
}

2211 
	gObjeù”
::
	$»£nd_mÚ_İs
()

2213 
unique_lock
 
	`wl
(
rwlock
);

2215 
	`ldout
(
cù
, 10è<< "»£nd_mÚ_İs" << 
d’dl
;

2217 
m­
<
ûph_tid_t
,
PoŞStOp
*>::
™”©Ü
 
p
 = 
poŞ¡©_İs
.
	`begš
();

2218 
p
 !ğ
poŞ¡©_İs
.
	`’d
();

2219 ++
p
) {

2220 
	`_poŞ¡©_subm™
(
p
->
£cÚd
);

2221 
logg”
->
	`šc
(
l_osdc_poŞ¡©_»£nd
);

2224 
m­
<
ûph_tid_t
,
StfsOp
*>::
™”©Ü
 
p
 = 
¡©fs_İs
.
	`begš
();

2225 
p
 !ğ
¡©fs_İs
.
	`’d
();

2226 ++
p
) {

2227 
	`_fs_¡©s_subm™
(
p
->
£cÚd
);

2228 
logg”
->
	`šc
(
l_osdc_¡©fs_»£nd
);

2231 
m­
<
ûph_tid_t
,
PoŞOp
*>::
™”©Ü
 
p
 = 
poŞ_İs
.
	`begš
();

2232 
p
 !ğ
poŞ_İs
.
	`’d
();

2233 ++
p
) {

2234 
	`_poŞ_İ_subm™
(
p
->
£cÚd
);

2235 
logg”
->
	`šc
(
l_osdc_poŞİ_»£nd
);

2238 
m­
<
ûph_tid_t
, 
Op
*>::
™”©Ü
 
p
 = 
check_Ï‹¡_m­_İs
.
	`begš
();

2239 
p
 !ğ
check_Ï‹¡_m­_İs
.
	`’d
();

2240 ++
p
) {

2241 
C_Op_M­_L©e¡
 *
c
 = 
Ãw
 
	`C_Op_M­_L©e¡
(
this
, 
p
->
£cÚd
->
tid
);

2242 
mÚc
->
	`g‘_v”siÚ
("osdm­", &
c
->
Ï‹¡
, 
NULL
, c);

2245 
m­
<
ušt64_t
, 
Lšg”Op
*>::
™”©Ü
 
p
 = 
check_Ï‹¡_m­_lšg”s
.
	`begš
();

2246 
p
 !ğ
check_Ï‹¡_m­_lšg”s
.
	`’d
();

2247 ++
p
) {

2248 
C_Lšg”_M­_L©e¡
 *
c


2249 ğ
Ãw
 
	`C_Lšg”_M­_L©e¡
(
this
, 
p
->
£cÚd
->
lšg”_id
);

2250 
mÚc
->
	`g‘_v”siÚ
("osdm­", &
c
->
Ï‹¡
, 
NULL
, c);

2253 
m­
<
ušt64_t
, 
CommªdOp
*>::
™”©Ü
 
p


2254 ğ
check_Ï‹¡_m­_commªds
.
	`begš
();

2255 
p
 !ğ
check_Ï‹¡_m­_commªds
.
	`’d
();

2256 ++
p
) {

2257 
C_Commªd_M­_L©e¡
 *
c
 = 
Ãw
 
	`C_Commªd_M­_L©e¡
(
this
, 
p
->
£cÚd
->
tid
);

2258 
mÚc
->
	`g‘_v”siÚ
("osdm­", &
c
->
Ï‹¡
, 
NULL
, c);

2260 
	}
}

2264 
	gObjeù”
::
	$İ_subm™
(
Op
 *
İ
, 
ûph_tid_t
 *
±id
, *
ùx_budg‘
)

2266 
shunique_lock
 
	`¾
(
rwlock
, 
ûph
::
acquœe_sh¬ed
);

2267 
ûph_tid_t
 
tid
 = 0;

2268 ià(!
±id
)

2269 
±id
 = &
tid
;

2270 
İ
->
Œaû
.
	`ev’t
("op submit");

2271 
	`_İ_subm™_w™h_budg‘
(
İ
, 
¾
, 
±id
, 
ùx_budg‘
);

2272 
	}
}

2274 
	gObjeù”
::
	$_İ_subm™_w™h_budg‘
(
Op
 *
İ
, 
shunique_lock
& 
sul
,

2275 
ûph_tid_t
 *
±id
,

2276 *
ùx_budg‘
)

2278 
	`as£¹
(
š™Ÿlized
);

2280 
	`as£¹
(
İ
->
İs
.
	`size
(è=ğİ->
out_bl
.size());

2281 
	`as£¹
(
İ
->
İs
.
	`size
(è=ğİ->
out_rv®
.size());

2282 
	`as£¹
(
İ
->
İs
.
	`size
(è=ğİ->
out_hªdËr
.size());

2286 ià(!
İ
->
ùx_budg‘ed
 || (
ùx_budg‘
 && (*ctx_budget == -1))) {

2287 
İ_budg‘
 = 
	`_ke_İ_budg‘
(
İ
, 
sul
);

2290 ià(
ùx_budg‘
 && (*ctx_budget == -1)) {

2291 *
ùx_budg‘
 = 
İ_budg‘
;

2295 ià(
osd_timeout
 > 
	`time¥ª
(0)) {

2296 ià(
İ
->
tid
 == 0)

2297 
İ
->
tid
 = ++
Ï¡_tid
;

2298 autØ
tid
 = 
İ
->tid;

2299 
İ
->
Útimeout
 = 
tim”
.
	`add_ev’t
(
osd_timeout
,

2300 [
this
, 
tid
]() {

2301 
	`İ_ÿnûl
(
tid
, -
ETIMEDOUT
); });

2304 
	`_İ_subm™
(
İ
, 
sul
, 
±id
);

2305 
	}
}

2307 
	gObjeù”
::
	$_£nd_İ_accouÁ
(
Op
 *
İ
)

2309 
šæight_İs
++;

2312 ià(
İ
->
Úfšish
) {

2313 
num_š_æight
++;

2315 
	`ldout
(
cù
, 20è<< "‚Ùe:‚Ù„eque¡šg„•ly" << 
d’dl
;

2318 
logg”
->
	`šc
(
l_osdc_İ_aùive
);

2319 
logg”
->
	`šc
(
l_osdc_İ
);

2321 ià((
İ
->
rg‘
.
æags
 & (
CEPH_OSD_FLAG_READ
 | 
CEPH_OSD_FLAG_WRITE
)) ==

2322 (
CEPH_OSD_FLAG_READ
|
CEPH_OSD_FLAG_WRITE
))

2323 
logg”
->
	`šc
(
l_osdc_İ_rmw
);

2324 ià(
İ
->
rg‘
.
æags
 & 
CEPH_OSD_FLAG_WRITE
)

2325 
logg”
->
	`šc
(
l_osdc_İ_w
);

2326 ià(
İ
->
rg‘
.
æags
 & 
CEPH_OSD_FLAG_READ
)

2327 
logg”
->
	`šc
(
l_osdc_İ_r
);

2329 ià(
İ
->
rg‘
.
æags
 & 
CEPH_OSD_FLAG_PGOP
)

2330 
logg”
->
	`šc
(
l_osdc_İ_pg
);

2332 
veùÜ
<
OSDOp
>::
™”©Ü
 
p
 = 
İ
->
İs
.
	`begš
();… !ğİ->İs.
	`’d
(); ++p) {

2333 
code
 = 
l_osdc_osdİ_Ùh”
;

2334 
p
->
İ
.op) {

2335 
CEPH_OSD_OP_STAT
: 
code
 = 
l_osdc_osdİ_¡©
; ;

2336 
CEPH_OSD_OP_CREATE
: 
code
 = 
l_osdc_osdİ_ü—‹
; ;

2337 
CEPH_OSD_OP_READ
: 
code
 = 
l_osdc_osdİ_»ad
; ;

2338 
CEPH_OSD_OP_WRITE
: 
code
 = 
l_osdc_osdİ_wr™e
; ;

2339 
CEPH_OSD_OP_WRITEFULL
: 
code
 = 
l_osdc_osdİ_wr™efuÎ
; ;

2340 
CEPH_OSD_OP_WRITESAME
: 
code
 = 
l_osdc_osdİ_wr™e§me
; ;

2341 
CEPH_OSD_OP_APPEND
: 
code
 = 
l_osdc_osdİ_­³nd
; ;

2342 
CEPH_OSD_OP_ZERO
: 
code
 = 
l_osdc_osdİ_z”o
; ;

2343 
CEPH_OSD_OP_TRUNCATE
: 
code
 = 
l_osdc_osdİ_Œunÿ‹
; ;

2344 
CEPH_OSD_OP_DELETE
: 
code
 = 
l_osdc_osdİ_d–‘e
; ;

2345 
CEPH_OSD_OP_MAPEXT
: 
code
 = 
l_osdc_osdİ_m­ext
; ;

2346 
CEPH_OSD_OP_SPARSE_READ
: 
code
 = 
l_osdc_osdİ_¥¬£_»ad
; ;

2347 
CEPH_OSD_OP_GETXATTR
: 
code
 = 
l_osdc_osdİ_g‘x©Œ
; ;

2348 
CEPH_OSD_OP_SETXATTR
: 
code
 = 
l_osdc_osdİ_£tx©Œ
; ;

2349 
CEPH_OSD_OP_CMPXATTR
: 
code
 = 
l_osdc_osdİ_cmpx©Œ
; ;

2350 
CEPH_OSD_OP_RMXATTR
: 
code
 = 
l_osdc_osdİ_rmx©Œ
; ;

2351 
CEPH_OSD_OP_RESETXATTRS
: 
code
 = 
l_osdc_osdİ_»£tx©Œs
; ;

2352 
CEPH_OSD_OP_TMAPUP
: 
code
 = 
l_osdc_osdİ_tm­_up
; ;

2353 
CEPH_OSD_OP_TMAPPUT
: 
code
 = 
l_osdc_osdİ_tm­_put
; ;

2354 
CEPH_OSD_OP_TMAPGET
: 
code
 = 
l_osdc_osdİ_tm­_g‘
; ;

2357 
CEPH_OSD_OP_OMAPGETVALS
:

2358 
CEPH_OSD_OP_OMAPGETKEYS
:

2359 
CEPH_OSD_OP_OMAPGETHEADER
:

2360 
CEPH_OSD_OP_OMAPGETVALSBYKEYS
:

2361 
CEPH_OSD_OP_OMAP_CMP
: 
code
 = 
l_osdc_osdİ_om­_rd
; ;

2364 
CEPH_OSD_OP_OMAPSETVALS
:

2365 
CEPH_OSD_OP_OMAPSETHEADER
: 
code
 = 
l_osdc_osdİ_om­_wr
; ;

2368 
CEPH_OSD_OP_OMAPCLEAR
:

2369 
CEPH_OSD_OP_OMAPRMKEYS
: 
code
 = 
l_osdc_osdİ_om­_d–
; ;

2371 
CEPH_OSD_OP_CALL
: 
code
 = 
l_osdc_osdİ_ÿÎ
; ;

2372 
CEPH_OSD_OP_WATCH
: 
code
 = 
l_osdc_osdİ_w©ch
; ;

2373 
CEPH_OSD_OP_NOTIFY
: 
code
 = 
l_osdc_osdİ_nÙify
; ;

2375 ià(
code
)

2376 
logg”
->
	`šc
(
code
);

2378 
	}
}

2380 
	gObjeù”
::
	$_İ_subm™
(
Op
 *
İ
, 
shunique_lock
& 
sul
, 
ûph_tid_t
 *
±id
)

2384 
	`ldout
(
cù
, 10è<< 
__func__
 << " o°" << 
İ
 << 
d’dl
;

2387 
	`as£¹
(
İ
->
£ssiÚ
 =ğ
NULL
);

2388 
OSDSessiÚ
 *
s
 = 
NULL
;

2390 
boŞ
 
check_fÜ_Ï‹¡_m­
 = 
	`_ÿlc_rg‘
(&
İ
->
rg‘
, 
nuÎ±r
)

2391 =ğ
RECALC_OP_TARGET_POOL_DNE
;

2394 
r
 = 
	`_g‘_£ssiÚ
(
İ
->
rg‘
.
osd
, &
s
, 
sul
);

2395 ià(
r
 =ğ-
EAGAIN
 ||

2396 (
check_fÜ_Ï‹¡_m­
 && 
sul
.
	`owns_lock_sh¬ed
())) {

2397 
•och_t
 
Üig_•och
 = 
osdm­
->
	`g‘_•och
();

2398 
sul
.
	`uÆock
();

2399 ià(
cù
->
_cÚf
->
objeù”_debug_šjeù_»lock_d–ay
) {

2400 
	`¦“p
(1);

2402 
sul
.
	`lock
();

2403 ià(
Üig_•och
 !ğ
osdm­
->
	`g‘_•och
()) {

2405 
	`ldout
(
cù
, 10è<< 
__func__
 << "„elock„aced with osdmap,„ecalcarget"

2406 << 
d’dl
;

2407 
check_fÜ_Ï‹¡_m­
 = 
	`_ÿlc_rg‘
(&
İ
->
rg‘
, 
nuÎ±r
)

2408 =ğ
RECALC_OP_TARGET_POOL_DNE
;

2409 ià(
s
) {

2410 
	`put_£ssiÚ
(
s
);

2411 
s
 = 
NULL
;

2412 
r
 = -
EAGAIN
;

2416 ià(
r
 =ğ-
EAGAIN
) {

2417 
	`as£¹
(
s
 =ğ
NULL
);

2418 
r
 = 
	`_g‘_£ssiÚ
(
İ
->
rg‘
.
osd
, &
s
, 
sul
);

2420 
	`as£¹
(
r
 == 0);

2421 
	`as£¹
(
s
);

2423 
	`_£nd_İ_accouÁ
(
İ
);

2427 
	`as£¹
(
İ
->
rg‘
.
æags
 & (
CEPH_OSD_FLAG_READ
|
CEPH_OSD_FLAG_WRITE
));

2429 ià(
osdm­_fuÎ_Œy
) {

2430 
İ
->
rg‘
.
æags
 |ğ
CEPH_OSD_FLAG_FULL_TRY
;

2433 
boŞ
 
Ãed_£nd
 = 
çl£
;

2435 ià(
osdm­
->
	`g‘_•och
(è< 
•och_b¬r›r
) {

2436 
	`ldout
(
cù
, 10è<< " b¬r›r,…au£d " << 
İ
 << "id " << op->
tid


2437 << 
d’dl
;

2438 
İ
->
rg‘
.
·u£d
 = 
Œue
;

2439 
	`_maybe_»que¡_m­
();

2440 } ià((
İ
->
rg‘
.
æags
 & 
CEPH_OSD_FLAG_WRITE
) &&

2441 
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_PAUSEWR
)) {

2442 
	`ldout
(
cù
, 10è<< "…au£d modify " << 
İ
 << "id " << op->
tid


2443 << 
d’dl
;

2444 
İ
->
rg‘
.
·u£d
 = 
Œue
;

2445 
	`_maybe_»que¡_m­
();

2446 } ià((
İ
->
rg‘
.
æags
 & 
CEPH_OSD_FLAG_READ
) &&

2447 
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_PAUSERD
)) {

2448 
	`ldout
(
cù
, 10è<< "…au£d„—d " << 
İ
 << "id " << op->
tid


2449 << 
d’dl
;

2450 
İ
->
rg‘
.
·u£d
 = 
Œue
;

2451 
	`_maybe_»que¡_m­
();

2452 } ià(
İ
->
	`»¥eùs_fuÎ
() &&

2453 (
	`_osdm­_fuÎ_æag
() ||

2454 
	`_osdm­_poŞ_fuÎ
(
İ
->
rg‘
.
ba£_Şoc
.
poŞ
))) {

2455 
	`ldout
(
cù
, 0è<< " FULL,…au£d modify " << 
İ
 << "id "

2456 << 
İ
->
tid
 << 
d’dl
;

2457 
İ
->
rg‘
.
·u£d
 = 
Œue
;

2458 
	`_maybe_»que¡_m­
();

2459 } ià(!
s
->
	`is_hom–ess
()) {

2460 
Ãed_£nd
 = 
Œue
;

2462 
	`_maybe_»que¡_m­
();

2465 
OSDSessiÚ
::
unique_lock
 
	`¦
(
s
->
lock
);

2466 ià(
İ
->
tid
 == 0)

2467 
İ
->
tid
 = ++
Ï¡_tid
;

2469 
	`ldout
(
cù
, 10è<< "_İ_subm™ oid " << 
İ
->
rg‘
.
ba£_oid


2470 << " '" << 
İ
->
rg‘
.
ba£_Şoc
 << "' '"

2471 << 
İ
->
rg‘
.
rg‘_Şoc
 << "' " << op->
İs
 << "id "

2472 << 
İ
->
tid
 << " osd." << (!
s
->
	`is_hom–ess
(è? s->
osd
 : -1)

2473 << 
d’dl
;

2475 
	`_£ssiÚ_İ_assign
(
s
, 
İ
);

2477 ià(
Ãed_£nd
) {

2478 
	`_£nd_İ
(
İ
);

2483 
ûph_tid_t
 
tid
 = 
İ
->tid;

2484 ià(
check_fÜ_Ï‹¡_m­
) {

2485 
	`_£nd_İ_m­_check
(
İ
);

2487 ià(
±id
)

2488 *
±id
 = 
tid
;

2489 
İ
 = 
NULL
;

2491 
¦
.
	`uÆock
();

2492 
	`put_£ssiÚ
(
s
);

2494 
	`ldout
(
cù
, 5è<< 
num_š_æight
 << " iÀæight" << 
d’dl
;

2495 
	}
}

2497 
	gObjeù”
::
	$İ_ÿnûl
(
OSDSessiÚ
 *
s
, 
ûph_tid_t
 
tid
, 
r
)

2499 
	`as£¹
(
š™Ÿlized
);

2501 
OSDSessiÚ
::
unique_lock
 
	`¦
(
s
->
lock
);

2503 
m­
<
ûph_tid_t
, 
Op
*>::
™”©Ü
 
p
 = 
s
->
İs
.
	`fšd
(
tid
);

2504 ià(
p
 =ğ
s
->
İs
.
	`’d
()) {

2505 
	`ldout
(
cù
, 10è<< 
__func__
 << "id " << 
tid
 << " dne in session "

2506 << 
s
->
osd
 << 
d’dl
;

2507  -
ENOENT
;

2510 ià(
s
->
cÚ
) {

2511 
	`ldout
(
cù
, 20è<< "„evokšg„x bufã¸fÜ " << 
tid


2512 << " oÀ" << 
s
->
cÚ
 << 
d’dl
;

2513 
s
->
cÚ
->
	`»voke_rx_bufãr
(
tid
);

2516 
	`ldout
(
cù
, 10è<< 
__func__
 << "id " << 
tid
 << " iÀ£ssiÚ " << 
s
->
osd


2517 << 
d’dl
;

2518 
Op
 *
İ
 = 
p
->
£cÚd
;

2519 ià(
İ
->
Úfšish
) {

2520 
num_š_æight
--;

2521 
İ
->
Úfšish
->
	`com¶‘e
(
r
);

2522 
İ
->
Úfšish
 = 
NULL
;

2524 
	`_İ_ÿnûl_m­_check
(
İ
);

2525 
	`_fšish_İ
(
İ
, 
r
);

2526 
¦
.
	`uÆock
();

2529 
	}
}

2531 
	gObjeù”
::
	$İ_ÿnûl
(
ûph_tid_t
 
tid
, 
r
)

2533 
»t
 = 0;

2535 
unique_lock
 
	`wl
(
rwlock
);

2536 
»t
 = 
	`_İ_ÿnûl
(
tid
, 
r
);

2538  
»t
;

2539 
	}
}

2541 
	gObjeù”
::
İ_ÿnûl
(cÚ¡ 
veùÜ
<
ûph_tid_t
>& 
tids
, 
r
)

2543 
unique_lock
 
wl
(
rwlock
);

2544 
ldout
(
cù
,10è<< 
	g__func__
 << " " << 
	gtids
 << 
	gd’dl
;

2545 autØ
	gtid
 : 
tids
) {

2546 
_İ_ÿnûl
(
tid
, 
r
);

2551 
	gObjeù”
::
	$_İ_ÿnûl
(
ûph_tid_t
 
tid
, 
r
)

2553 
»t
 = 0;

2555 
	`ldout
(
cù
, 5è<< 
__func__
 << ": cªûÎšgid " << 
tid
 << "„=" << 
r


2556 << 
d’dl
;

2558 
¡¬t
:

2560 
m­
<, 
OSDSessiÚ
 *>::
™”©Ü
 
s™”
 = 
osd_£ssiÚs
.
	`begš
();

2561 
s™”
 !ğ
osd_£ssiÚs
.
	`’d
(); ++siter) {

2562 
OSDSessiÚ
 *
s
 = 
s™”
->
£cÚd
;

2563 
OSDSessiÚ
::
sh¬ed_lock
 
	`¦
(
s
->
lock
);

2564 ià(
s
->
İs
.
	`fšd
(
tid
è!ğs->İs.
	`’d
()) {

2565 
¦
.
	`uÆock
();

2566 
»t
 = 
	`İ_ÿnûl
(
s
, 
tid
, 
r
);

2567 ià(
»t
 =ğ-
ENOENT
) {

2569 
¡¬t
;

2571  
»t
;

2575 
	`ldout
(
cù
, 5è<< 
__func__
 << ":id " << 
tid


2576 << "‚Ù found iÀliv£ssiÚs" << 
d’dl
;

2579 
OSDSessiÚ
::
sh¬ed_lock
 
	`¦
(
hom–ess_£ssiÚ
->
lock
);

2580 ià(
hom–ess_£ssiÚ
->
İs
.
	`fšd
(
tid
è!ğhom–ess_£ssiÚ->İs.
	`’d
()) {

2581 
¦
.
	`uÆock
();

2582 
»t
 = 
	`İ_ÿnûl
(
hom–ess_£ssiÚ
, 
tid
, 
r
);

2583 ià(
»t
 =ğ-
ENOENT
) {

2585 
¡¬t
;

2587  
»t
;

2590 
¦
.
	`uÆock
();

2593 
	`ldout
(
cù
, 5è<< 
__func__
 << ":id " << 
tid


2594 << "‚Ù found iÀhom–es £ssiÚ" << 
d’dl
;

2596  
»t
;

2597 
	}
}

2600 
•och_t
 
	gObjeù”
::
	$İ_ÿnûl_wr™es
(
r
, 
št64_t
 
poŞ
)

2602 
unique_lock
 
	`wl
(
rwlock
);

2604 
¡d
::
veùÜ
<
ûph_tid_t
> 
to_ÿnûl
;

2605 
boŞ
 
found
 = 
çl£
;

2607 
m­
<, 
OSDSessiÚ
 *>::
™”©Ü
 
s™”
 = 
osd_£ssiÚs
.
	`begš
();

2608 
s™”
 !ğ
osd_£ssiÚs
.
	`’d
(); ++siter) {

2609 
OSDSessiÚ
 *
s
 = 
s™”
->
£cÚd
;

2610 
OSDSessiÚ
::
sh¬ed_lock
 
	`¦
(
s
->
lock
);

2611 
m­
<
ûph_tid_t
, 
Op
*>::
™”©Ü
 
İ_i
 = 
s
->
İs
.
	`begš
();

2612 
İ_i
 !ğ
s
->
İs
.
	`’d
(); ++op_i) {

2613 ià(
İ_i
->
£cÚd
->
rg‘
.
æags
 & 
CEPH_OSD_FLAG_WRITE


2614 && (
poŞ
 =ğ-1 || 
İ_i
->
£cÚd
->
rg‘
.
rg‘_Şoc
.pool ==…ool)) {

2615 
to_ÿnûl
.
	`push_back
(
İ_i
->
fœ¡
);

2618 
¦
.
	`uÆock
();

2620 
¡d
::
veùÜ
<
ûph_tid_t
>::
™”©Ü
 
t™”
 = 
to_ÿnûl
.
	`begš
();

2621 
t™”
 !ğ
to_ÿnûl
.
	`’d
();

2622 ++
t™”
) {

2623 
ÿnûl_»suÉ
 = 
	`İ_ÿnûl
(
s
, *
t™”
, 
r
);

2626 
	`as£¹
(
ÿnûl_»suÉ
 == 0);

2628 ià(!
found
 && 
to_ÿnûl
.
	`size
())

2629 
found
 = 
Œue
;

2630 
to_ÿnûl
.
	`ş—r
();

2633 cÚ¡ 
•och_t
 
•och
 = 
osdm­
->
	`g‘_•och
();

2635 
wl
.
	`uÆock
();

2637 ià(
found
) {

2638  
•och
;

2642 
	}
}

2644 
boŞ
 
	gObjeù”
::
is_pg_chªged
(

2645 
Şd´im¬y
,

2646 cÚ¡ 
veùÜ
<>& 
Şdaùšg
,

2647 
Ãw´im¬y
,

2648 cÚ¡ 
veùÜ
<>& 
Ãwaùšg
,

2649 
boŞ
 
ªy_chªge
)

2651 ià(
	gOSDM­
::
´im¬y_chªged
(

2652 
Şd´im¬y
,

2653 
Şdaùšg
,

2654 
Ãw´im¬y
,

2655 
Ãwaùšg
))

2656  
	gŒue
;

2657 ià(
	gªy_chªge
 && 
	gŞdaùšg
 !ğ
Ãwaùšg
)

2658  
Œue
;

2659  
	gçl£
;

2662 
boŞ
 
	gObjeù”
::
	$rg‘_should_be_·u£d
(
İ_rg‘_t
 *
t
)

2664 cÚ¡ 
pg_poŞ_t
 *
pi
 = 
osdm­
->
	`g‘_pg_poŞ
(
t
->
ba£_Şoc
.
poŞ
);

2665 
boŞ
 
·u£rd
 = 
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_PAUSERD
);

2666 
boŞ
 
·u£wr
 = 
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_PAUSEWR
) ||

2667 
	`_osdm­_fuÎ_æag
(è|| 
	`_osdm­_poŞ_fuÎ
(*
pi
);

2669  (
t
->
æags
 & 
CEPH_OSD_FLAG_READ
 && 
·u£rd
) ||

2670 (
t
->
æags
 & 
CEPH_OSD_FLAG_WRITE
 && 
·u£wr
) ||

2671 (
osdm­
->
	`g‘_•och
(è< 
•och_b¬r›r
);

2672 
	}
}

2677 
boŞ
 
	gObjeù”
::
	$osdm­_fuÎ_æag
() const

2679 
sh¬ed_lock
 
	`¾
(
rwlock
);

2681  
	`_osdm­_fuÎ_æag
();

2682 
	}
}

2684 
boŞ
 
	gObjeù”
::
	$osdm­_poŞ_fuÎ
(cÚ¡ 
št64_t
 
poŞ_id
) const

2686 
sh¬ed_lock
 
	`¾
(
rwlock
);

2688 ià(
	`_osdm­_fuÎ_æag
()) {

2689  
Œue
;

2692  
	`_osdm­_poŞ_fuÎ
(
poŞ_id
);

2693 
	}
}

2695 
boŞ
 
	gObjeù”
::
	$_osdm­_poŞ_fuÎ
(cÚ¡ 
št64_t
 
poŞ_id
) const

2697 cÚ¡ 
pg_poŞ_t
 *
poŞ
 = 
osdm­
->
	`g‘_pg_poŞ
(
poŞ_id
);

2698 ià(
poŞ
 =ğ
NULL
) {

2699 
	`ldout
(
cù
, 4è<< 
__func__
 << ": DNE…oŞ " << 
poŞ_id
 << 
d’dl
;

2700  
çl£
;

2703  
	`_osdm­_poŞ_fuÎ
(*
poŞ
);

2704 
	}
}

2706 
boŞ
 
	gObjeù”
::
	$_osdm­_has_poŞ_fuÎ
() const

2708 
m­
<
št64_t
, 
pg_poŞ_t
>::
cÚ¡_™”©Ü
 
™


2709 ğ
osdm­
->
	`g‘_poŞs
().
	`begš
();

2710 
™
 !ğ
osdm­
->
	`g‘_poŞs
().
	`’d
(); ++it) {

2711 ià(
	`_osdm­_poŞ_fuÎ
(
™
->
£cÚd
))

2712  
Œue
;

2714  
çl£
;

2715 
	}
}

2717 
boŞ
 
	gObjeù”
::
	$_osdm­_poŞ_fuÎ
(cÚ¡ 
pg_poŞ_t
 &
p
) const

2719  
p
.
	`has_æag
(
pg_poŞ_t
::
FLAG_FULL
è&& 
hÚÜ_osdm­_fuÎ
;

2720 
	}
}

2725 
boŞ
 
	gObjeù”
::
	$_osdm­_fuÎ_æag
() const

2728  
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_FULL
è&& 
hÚÜ_osdm­_fuÎ
;

2729 
	}
}

2731 
	gObjeù”
::
upd©e_poŞ_fuÎ_m­
(
m­
<
št64_t
, 
boŞ
>& 
poŞ_fuÎ_m­
)

2733 
	gm­
<
	gšt64_t
, 
	gpg_poŞ_t
>::
cÚ¡_™”©Ü
 
™


2734 ğ
osdm­
->
g‘_poŞs
().
begš
();

2735 
	g™
 !ğ
osdm­
->
g‘_poŞs
().
’d
(); ++it) {

2736 ià(
	gpoŞ_fuÎ_m­
.
fšd
(
™
->
fœ¡
è=ğ
poŞ_fuÎ_m­
.
’d
()) {

2737 
poŞ_fuÎ_m­
[
™
->
fœ¡
] = 
_osdm­_poŞ_fuÎ
(™->
£cÚd
);

2739 
	gpoŞ_fuÎ_m­
[
™
->
fœ¡
] = 
_osdm­_poŞ_fuÎ
(™->
£cÚd
) ||

2740 
poŞ_fuÎ_m­
[
™
->
fœ¡
];

2745 
št64_t
 
	gObjeù”
::
	$g‘_objeù_hash_pos™iÚ
(
št64_t
 
poŞ
, cÚ¡ 
¡ršg
& 
key
,

2746 cÚ¡ 
¡ršg
& 
ns
)

2748 
sh¬ed_lock
 
	`¾
(
rwlock
);

2749 cÚ¡ 
pg_poŞ_t
 *
p
 = 
osdm­
->
	`g‘_pg_poŞ
(
poŞ
);

2750 ià(!
p
)

2751  -
ENOENT
;

2752  
p
->
	`hash_key
(
key
, 
ns
);

2753 
	}
}

2755 
št64_t
 
	gObjeù”
::
	$g‘_objeù_pg_hash_pos™iÚ
(
št64_t
 
poŞ
, cÚ¡ 
¡ršg
& 
key
,

2756 cÚ¡ 
¡ršg
& 
ns
)

2758 
sh¬ed_lock
 
	`¾
(
rwlock
);

2759 cÚ¡ 
pg_poŞ_t
 *
p
 = 
osdm­
->
	`g‘_pg_poŞ
(
poŞ
);

2760 ià(!
p
)

2761  -
ENOENT
;

2762  
p
->
	`¿w_hash_to_pg
Õ->
	`hash_key
(
key
, 
ns
));

2763 
	}
}

2765 
	gObjeù”
::
_´uÃ_¢­c
(

2766 cÚ¡ 
mempoŞ
::
osdm­
::
m­
<
št64_t
,

2767 
OSDM­
::
¢­_š‹rv®_£t_t
>& 
Ãw_»moved_¢­s
,

2768 
Op
 *
İ
)

2770 
boŞ
 
	gm©ch
 = 
çl£
;

2771 autØ
	gi
 = 
Ãw_»moved_¢­s
.
fšd
(
İ
->
rg‘
.
ba£_pgid
.
poŞ
());

2772 ià(
	gi
 !ğ
Ãw_»moved_¢­s
.
’d
()) {

2773 autØ
s
 : 
İ
->
¢­c
.
¢­s
) {

2774 ià(
i
->
£cÚd
.
cÚšs
(
s
)) {

2775 
m©ch
 = 
Œue
;

2779 ià(
	gm©ch
) {

2780 
	gveùÜ
<
	g¢­id_t
> 
	gÃw_¢­s
;

2781 autØ
	gs
 : 
İ
->
¢­c
.
¢­s
) {

2782 ià(!
i
->
£cÚd
.
cÚšs
(
s
)) {

2783 
Ãw_¢­s
.
push_back
(
s
);

2786 
	gİ
->
	g¢­c
.
	g¢­s
.
sw­
(
Ãw_¢­s
);

2787 
ldout
(
cù
,10è<< 
	g__func__
 << " o°" << 
	gİ
->
	gtid
 << " sÇpø" << op->
	g¢­c


2788 << " (wa " << 
	gÃw_¢­s
 << ")" << 
	gd’dl
;

2793 
	gObjeù”
::
	$_ÿlc_rg‘
(
İ_rg‘_t
 *
t
, 
CÚÃùiÚ
 *
cÚ
, 
boŞ
 
ªy_chªge
)

2796 
boŞ
 
is_»ad
 = 
t
->
æags
 & 
CEPH_OSD_FLAG_READ
;

2797 
boŞ
 
is_wr™e
 = 
t
->
æags
 & 
CEPH_OSD_FLAG_WRITE
;

2798 
t
->
•och
 = 
osdm­
->
	`g‘_•och
();

2799 
	`ldout
(
cù
,20è<< 
__func__
 << "ƒpoch " << 
t
->
•och


2800 << " ba£ " << 
t
->
ba£_oid
 << " " <<->
ba£_Şoc


2801 << "…»ÿlc_pgid " << ()
t
->
´eÿlc_pgid


2802 << "…gid " << 
t
->
ba£_pgid


2803 << (
is_»ad
 ? " is_read" : "")

2804 << (
is_wr™e
 ? " is_write" : "")

2805 << 
d’dl
;

2807 cÚ¡ 
pg_poŞ_t
 *
pi
 = 
osdm­
->
	`g‘_pg_poŞ
(
t
->
ba£_Şoc
.
poŞ
);

2808 ià(!
pi
) {

2809 
t
->
osd
 = -1;

2810  
RECALC_OP_TARGET_POOL_DNE
;

2812 
	`ldout
(
cù
,30è<< 
__func__
 << " ba£…˜" << 
pi


2813 << "…g_num " << 
pi
->
	`g‘_pg_num
(è<< 
d’dl
;

2815 
boŞ
 
fÜû_»£nd
 = 
çl£
;

2816 ià(
osdm­
->
	`g‘_•och
(è=ğ
pi
->
Ï¡_fÜû_İ_»£nd
) {

2817 ià(
t
->
Ï¡_fÜû_»£nd
 < 
pi
->
Ï¡_fÜû_İ_»£nd
) {

2818 
t
->
Ï¡_fÜû_»£nd
 = 
pi
->
Ï¡_fÜû_İ_»£nd
;

2819 
fÜû_»£nd
 = 
Œue
;

2820 } ià(
t
->
Ï¡_fÜû_»£nd
 == 0) {

2821 
fÜû_»£nd
 = 
Œue
;

2826 
t
->
rg‘_oid
 =->
ba£_oid
;

2827 
t
->
rg‘_Şoc
 =->
ba£_Şoc
;

2828 ià((
t
->
æags
 & 
CEPH_OSD_FLAG_IGNORE_OVERLAY
) == 0) {

2829 ià(
is_»ad
 && 
pi
->
	`has_»ad_t›r
())

2830 
t
->
rg‘_Şoc
.
poŞ
 = 
pi
->
»ad_t›r
;

2831 ià(
is_wr™e
 && 
pi
->
	`has_wr™e_t›r
())

2832 
t
->
rg‘_Şoc
.
poŞ
 = 
pi
->
wr™e_t›r
;

2833 
pi
 = 
osdm­
->
	`g‘_pg_poŞ
(
t
->
rg‘_Şoc
.
poŞ
);

2834 ià(!
pi
) {

2835 
t
->
osd
 = -1;

2836  
RECALC_OP_TARGET_POOL_DNE
;

2840 
pg_t
 
pgid
;

2841 ià(
t
->
´eÿlc_pgid
) {

2842 
	`as£¹
(
t
->
æags
 & 
CEPH_OSD_FLAG_IGNORE_OVERLAY
);

2843 
	`as£¹
(
t
->
ba£_oid
.
Çme
.
	`em±y
());

2844 
	`as£¹
(
t
->
ba£_Şoc
.
poŞ
 =ğ(
št64_t
é->
ba£_pgid
.
	`poŞ
());

2845 
pgid
 = 
t
->
ba£_pgid
;

2847 
»t
 = 
osdm­
->
	`objeù_loÿtÜ_to_pg
(
t
->
rg‘_oid
,->
rg‘_Şoc
,

2848 
pgid
);

2849 ià(
»t
 =ğ-
ENOENT
) {

2850 
t
->
osd
 = -1;

2851  
RECALC_OP_TARGET_POOL_DNE
;

2854 
	`ldout
(
cù
,20è<< 
__func__
 << "¬g‘ " << 
t
->
rg‘_oid
 << " "

2855 << 
t
->
rg‘_Şoc
 << " ->…gid " << 
pgid
 << 
d’dl
;

2856 
	`ldout
(
cù
,30è<< 
__func__
 << "¬g‘…˜" << 
pi


2857 << "…g_num " << 
pi
->
	`g‘_pg_num
(è<< 
d’dl
;

2858 
t
->
poŞ_ev”_exi¡ed
 = 
Œue
;

2860 
size
 = 
pi
->size;

2861 
mš_size
 = 
pi
->min_size;

2862 
pg_num
 = 
pi
->
	`g‘_pg_num
();

2863 
up_´im¬y
, 
aùšg_´im¬y
;

2864 
veùÜ
<> 
up
, 
aùšg
;

2865 
osdm­
->
	`pg_to_up_aùšg_osds
(
pgid
, &
up
, &
up_´im¬y
,

2866 &
aùšg
, &
aùšg_´im¬y
);

2867 
boŞ
 
sÜt_b™wi£
 = 
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_SORTBITWISE
);

2868 
boŞ
 
»cov”y_d–‘es
 = 
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_RECOVERY_DELETES
);

2869 
´ev_£ed
 = 
	`ûph_¡abË_mod
(
pgid
.
	`ps
(), 
t
->
pg_num
,->
pg_num_mask
);

2870 
pg_t
 
	`´ev_pgid
(
´ev_£ed
, 
pgid
.
	`poŞ
());

2871 ià(
ªy_chªge
 && 
Pa¡IÁ”v®s
::
	`is_Ãw_š‹rv®
(

2872 
t
->
aùšg_´im¬y
,

2873 
aùšg_´im¬y
,

2874 
t
->
aùšg
,

2875 
aùšg
,

2876 
t
->
up_´im¬y
,

2877 
up_´im¬y
,

2878 
t
->
up
,

2879 
up
,

2880 
t
->
size
,

2881 
size
,

2882 
t
->
mš_size
,

2883 
mš_size
,

2884 
t
->
pg_num
,

2885 
pg_num
,

2886 
t
->
sÜt_b™wi£
,

2887 
sÜt_b™wi£
,

2888 
t
->
»cov”y_d–‘es
,

2889 
»cov”y_d–‘es
,

2890 
´ev_pgid
)) {

2891 
fÜû_»£nd
 = 
Œue
;

2894 
boŞ
 
uÅau£d
 = 
çl£
;

2895 ià(
t
->
·u£d
 && !
	`rg‘_should_be_·u£d
(t)) {

2896 
t
->
·u£d
 = 
çl£
;

2897 
uÅau£d
 = 
Œue
;

2900 
boŞ
 
Ëgacy_chªge
 =

2901 
t
->
pgid
 !=…gid ||

2902 
	`is_pg_chªged
(

2903 
t
->
aùšg_´im¬y
,->
aùšg
,‡cting_primary,‡cting,

2904 
t
->
u£d_»¶iÿ
 || 
ªy_chªge
);

2905 
boŞ
 
¥l™
 = 
çl£
;

2906 ià(
t
->
pg_num
) {

2907 
¥l™
 = 
´ev_pgid
.
	`is_¥l™
(
t
->
pg_num
,…g_num, 
nuÎ±r
);

2910 ià(
Ëgacy_chªge
 || 
¥l™
 || 
fÜû_»£nd
) {

2911 
t
->
pgid
 =…gid;

2912 
t
->
aùšg
 =‡cting;

2913 
t
->
aùšg_´im¬y
 =‡cting_primary;

2914 
t
->
up_´im¬y
 = up_primary;

2915 
t
->
up
 = up;

2916 
t
->
size
 = size;

2917 
t
->
mš_size
 = min_size;

2918 
t
->
pg_num
 =…g_num;

2919 
t
->
pg_num_mask
 = 
pi
->
	`g‘_pg_num_mask
();

2920 
osdm­
->
	`g‘_´im¬y_sh¬d
(

2921 
	`pg_t
(
	`ûph_¡abË_mod
(
pgid
.
	`ps
(), 
t
->
pg_num
,->
pg_num_mask
),…gid.
	`poŞ
()),

2922 &
t
->
aùu®_pgid
);

2923 
t
->
sÜt_b™wi£
 = sort_bitwise;

2924 
t
->
»cov”y_d–‘es
 =„ecovery_deletes;

2925 
	`ldout
(
cù
, 10è<< 
__func__
 << " "

2926 << "„aw…gid " << 
pgid
 << " ->‡ùu® " << 
t
->
aùu®_pgid


2927 << "‡ùšg " << 
aùšg


2928 << "…rim¬y " << 
aùšg_´im¬y
 << 
d’dl
;

2929 
t
->
u£d_»¶iÿ
 = 
çl£
;

2930 ià(
aùšg_´im¬y
 == -1) {

2931 
t
->
osd
 = -1;

2933 
osd
;

2934 
boŞ
 
»ad
 = 
is_»ad
 && !
is_wr™e
;

2935 ià(
»ad
 && (
t
->
æags
 & 
CEPH_OSD_FLAG_BALANCE_READS
)) {

2936 
p
 = 
	`¿nd
(è% 
aùšg
.
	`size
();

2937 ià(
p
)

2938 
t
->
u£d_»¶iÿ
 = 
Œue
;

2939 
osd
 = 
aùšg
[
p
];

2940 
	`ldout
(
cù
, 10è<< " cho£„ªdom osd." << 
osd
 << " oà" << 
aùšg


2941 << 
d’dl
;

2942 } ià(
»ad
 && (
t
->
æags
 & 
CEPH_OSD_FLAG_LOCALIZE_READS
) &&

2943 
aùšg
.
	`size
() > 1) {

2946 
be¡
 = -1;

2947 
be¡_loÿl™y
 = 0;

2948 
i
 = 0; i < 
aùšg
.
	`size
(); ++i) {

2949 
loÿl™y
 = 
osdm­
->
üush
->
	`g‘_commÚ_ªû¡Ü_di¡ªû
(

2950 
cù
, 
aùšg
[
i
], 
üush_loÿtiÚ
);

2951 
	`ldout
(
cù
, 20è<< 
__func__
 << "†oÿlize:„ªk " << 
i


2952 << " osd." << 
aùšg
[
i
]

2953 << "†oÿl™y " << 
loÿl™y
 << 
d’dl
;

2954 ià(
i
 == 0 ||

2955 (
loÿl™y
 >ğ0 && 
be¡_loÿl™y
 >= 0 &&

2956 
loÿl™y
 < 
be¡_loÿl™y
) ||

2957 (
be¡_loÿl™y
 < 0 && 
loÿl™y
 >= 0)) {

2958 
be¡
 = 
i
;

2959 
be¡_loÿl™y
 = 
loÿl™y
;

2960 ià(
i
)

2961 
t
->
u£d_»¶iÿ
 = 
Œue
;

2964 
	`as£¹
(
be¡
 >= 0);

2965 
osd
 = 
aùšg
[
be¡
];

2967 
osd
 = 
aùšg_´im¬y
;

2969 
t
->
osd
 = osd;

2972 ià(
Ëgacy_chªge
 || 
uÅau£d
 || 
fÜû_»£nd
) {

2973  
RECALC_OP_TARGET_NEED_RESEND
;

2975 ià(
¥l™
 && 
cÚ
 && cÚ->
	`has_ã©u»s
(
CEPH_FEATUREMASK_RESEND_ON_SPLIT
)) {

2976  
RECALC_OP_TARGET_NEED_RESEND
;

2978  
RECALC_OP_TARGET_NO_ACTION
;

2979 
	}
}

2981 
	gObjeù”
::
	$_m­_£ssiÚ
(
İ_rg‘_t
 *
rg‘
, 
OSDSessiÚ
 **
s
,

2982 
shunique_lock
& 
sul
)

2984 
	`_ÿlc_rg‘
(
rg‘
, 
nuÎ±r
);

2985  
	`_g‘_£ssiÚ
(
rg‘
->
osd
, 
s
, 
sul
);

2986 
	}
}

2988 
	gObjeù”
::
	$_£ssiÚ_İ_assign
(
OSDSessiÚ
 *
to
, 
Op
 *
İ
)

2991 
	`as£¹
(
İ
->
£ssiÚ
 =ğ
NULL
);

2992 
	`as£¹
(
İ
->
tid
);

2994 
	`g‘_£ssiÚ
(
to
);

2995 
İ
->
£ssiÚ
 = 
to
;

2996 
to
->
İs
[
İ
->
tid
] = op;

2998 ià(
to
->
	`is_hom–ess
()) {

2999 
num_hom–ess_İs
++;

3002 
	`ldout
(
cù
, 15è<< 
__func__
 << " " << 
to
->
osd
 << " " << 
İ
->
tid
 << 
d’dl
;

3003 
	}
}

3005 
	gObjeù”
::
	$_£ssiÚ_İ_»move
(
OSDSessiÚ
 *
äom
, 
Op
 *
İ
)

3007 
	`as£¹
(
İ
->
£ssiÚ
 =ğ
äom
);

3010 ià(
äom
->
	`is_hom–ess
()) {

3011 
num_hom–ess_İs
--;

3014 
äom
->
İs
.
	`”a£
(
İ
->
tid
);

3015 
	`put_£ssiÚ
(
äom
);

3016 
İ
->
£ssiÚ
 = 
NULL
;

3018 
	`ldout
(
cù
, 15è<< 
__func__
 << " " << 
äom
->
osd
 << " " << 
İ
->
tid
 << 
d’dl
;

3019 
	}
}

3021 
	gObjeù”
::
	$_£ssiÚ_lšg”_İ_assign
(
OSDSessiÚ
 *
to
, 
Lšg”Op
 *
İ
)

3024 
	`as£¹
(
İ
->
£ssiÚ
 =ğ
NULL
);

3026 ià(
to
->
	`is_hom–ess
()) {

3027 
num_hom–ess_İs
++;

3030 
	`g‘_£ssiÚ
(
to
);

3031 
İ
->
£ssiÚ
 = 
to
;

3032 
to
->
lšg”_İs
[
İ
->
lšg”_id
] = op;

3034 
	`ldout
(
cù
, 15è<< 
__func__
 << " " << 
to
->
osd
 << " " << 
İ
->
lšg”_id


3035 << 
d’dl
;

3036 
	}
}

3038 
	gObjeù”
::
	$_£ssiÚ_lšg”_İ_»move
(
OSDSessiÚ
 *
äom
, 
Lšg”Op
 *
İ
)

3040 
	`as£¹
(
äom
 =ğ
İ
->
£ssiÚ
);

3043 ià(
äom
->
	`is_hom–ess
()) {

3044 
num_hom–ess_İs
--;

3047 
äom
->
lšg”_İs
.
	`”a£
(
İ
->
lšg”_id
);

3048 
	`put_£ssiÚ
(
äom
);

3049 
İ
->
£ssiÚ
 = 
NULL
;

3051 
	`ldout
(
cù
, 15è<< 
__func__
 << " " << 
äom
->
osd
 << " " << 
İ
->
lšg”_id


3052 << 
d’dl
;

3053 
	}
}

3055 
	gObjeù”
::
	$_£ssiÚ_commªd_İ_»move
(
OSDSessiÚ
 *
äom
, 
CommªdOp
 *
İ
)

3057 
	`as£¹
(
äom
 =ğ
İ
->
£ssiÚ
);

3060 ià(
äom
->
	`is_hom–ess
()) {

3061 
num_hom–ess_İs
--;

3064 
äom
->
commªd_İs
.
	`”a£
(
İ
->
tid
);

3065 
	`put_£ssiÚ
(
äom
);

3066 
İ
->
£ssiÚ
 = 
NULL
;

3068 
	`ldout
(
cù
, 15è<< 
__func__
 << " " << 
äom
->
osd
 << " " << 
İ
->
tid
 << 
d’dl
;

3069 
	}
}

3071 
	gObjeù”
::
	$_£ssiÚ_commªd_İ_assign
(
OSDSessiÚ
 *
to
, 
CommªdOp
 *
İ
)

3074 
	`as£¹
(
İ
->
£ssiÚ
 =ğ
NULL
);

3075 
	`as£¹
(
İ
->
tid
);

3077 ià(
to
->
	`is_hom–ess
()) {

3078 
num_hom–ess_İs
++;

3081 
	`g‘_£ssiÚ
(
to
);

3082 
İ
->
£ssiÚ
 = 
to
;

3083 
to
->
commªd_İs
[
İ
->
tid
] = op;

3085 
	`ldout
(
cù
, 15è<< 
__func__
 << " " << 
to
->
osd
 << " " << 
İ
->
tid
 << 
d’dl
;

3086 
	}
}

3088 
	gObjeù”
::
	$_»ÿlc_lšg”_İ_rg‘
(
Lšg”Op
 *
lšg”_İ
,

3089 
shunique_lock
& 
sul
)

3093 
r
 = 
	`_ÿlc_rg‘
(&
lšg”_İ
->
rg‘
, 
nuÎ±r
, 
Œue
);

3094 ià(
r
 =ğ
RECALC_OP_TARGET_NEED_RESEND
) {

3095 
	`ldout
(
cù
, 10è<< "»ÿlc_lšg”_İ_rg‘id " << 
lšg”_İ
->
lšg”_id


3096 << "…gid " << 
lšg”_İ
->
rg‘
.
pgid


3097 << "‡ùšg " << 
lšg”_İ
->
rg‘
.
aùšg
 << 
d’dl
;

3099 
OSDSessiÚ
 *
s
 = 
NULL
;

3100 
r
 = 
	`_g‘_£ssiÚ
(
lšg”_İ
->
rg‘
.
osd
, &
s
, 
sul
);

3101 
	`as£¹
(
r
 == 0);

3103 ià(
lšg”_İ
->
£ssiÚ
 !ğ
s
) {

3108 
OSDSessiÚ
::
unique_lock
 
	`¦
(
s
->
lock
);

3109 
	`_£ssiÚ_lšg”_İ_»move
(
lšg”_İ
->
£ssiÚ
,†inger_op);

3110 
	`_£ssiÚ_lšg”_İ_assign
(
s
, 
lšg”_İ
);

3113 
	`put_£ssiÚ
(
s
);

3114  
RECALC_OP_TARGET_NEED_RESEND
;

3116  
r
;

3117 
	}
}

3119 
	gObjeù”
::
	$_ÿnûl_lšg”_İ
(
Op
 *
İ
)

3121 
	`ldout
(
cù
, 15è<< "ÿnûl_İ " << 
İ
->
tid
 << 
d’dl
;

3123 
	`as£¹
(!
İ
->
should_»£nd
);

3124 ià(
İ
->
Úfšish
) {

3125 
d–‘e
 
İ
->
Úfšish
;

3126 
num_š_æight
--;

3129 
	`_fšish_İ
(
İ
, 0);

3130 
	}
}

3132 
	gObjeù”
::
	$_fšish_İ
(
Op
 *
İ
, 
r
)

3134 
	`ldout
(
cù
, 15è<< "fšish_İ " << 
İ
->
tid
 << 
d’dl
;

3138 ià(!
İ
->
ùx_budg‘ed
 && op->
budg‘
 >= 0) {

3139 
	`put_İ_budg‘_by‹s
(
İ
->
budg‘
);

3140 
İ
->
budg‘
 = -1;

3143 ià(
İ
->
Útimeout
 && 
r
 !ğ-
ETIMEDOUT
)

3144 
tim”
.
	`ÿnûl_ev’t
(
İ
->
Útimeout
);

3146 ià(
İ
->
£ssiÚ
) {

3147 
	`_£ssiÚ_İ_»move
(
İ
->
£ssiÚ
, op);

3150 
logg”
->
	`dec
(
l_osdc_İ_aùive
);

3152 
	`as£¹
(
check_Ï‹¡_m­_İs
.
	`fšd
(
İ
->
tid
è=ğcheck_Ï‹¡_m­_İs.
	`’d
());

3154 
šæight_İs
--;

3156 
İ
->
	`put
();

3157 
	}
}

3159 
	gObjeù”
::
	$fšish_İ
(
OSDSessiÚ
 *
£ssiÚ
, 
ûph_tid_t
 
tid
)

3161 
	`ldout
(
cù
, 15è<< "fšish_İ " << 
tid
 << 
d’dl
;

3162 
sh¬ed_lock
 
	`¾
(
rwlock
);

3164 
OSDSessiÚ
::
unique_lock
 
	`wl
(
£ssiÚ
->
lock
);

3166 
m­
<
ûph_tid_t
, 
Op
 *>::
™”©Ü
 
™”
 = 
£ssiÚ
->
İs
.
	`fšd
(
tid
);

3167 ià(
™”
 =ğ
£ssiÚ
->
İs
.
	`’d
())

3170 
Op
 *
İ
 = 
™”
->
£cÚd
;

3172 
	`_fšish_İ
(
İ
, 0);

3173 
	}
}

3175 
MOSDOp
 *
	gObjeù”
::
	$_´•¬e_osd_İ
(
Op
 *
İ
)

3179 
æags
 = 
İ
->
rg‘
.flags;

3180 
æags
 |ğ
CEPH_OSD_FLAG_KNOWN_REDIR
;

3184 
æags
 |ğ
CEPH_OSD_FLAG_ONDISK
;

3186 ià(!
hÚÜ_osdm­_fuÎ
)

3187 
æags
 |ğ
CEPH_OSD_FLAG_FULL_FORCE
;

3189 
İ
->
rg‘
.
·u£d
 = 
çl£
;

3190 
İ
->
¡amp
 = 
ûph
::
cßr£_mÚo_şock
::
	`now
();

3192 
hobjeù_t
 
hobj
 = 
İ
->
rg‘
.
	`g‘_hobj
();

3193 
MOSDOp
 *
m
 = 
Ãw
 
	`MOSDOp
(
ş›Á_šc
, 
İ
->
tid
,

3194 
hobj
, 
İ
->
rg‘
.
aùu®_pgid
,

3195 
osdm­
->
	`g‘_•och
(),

3196 
æags
, 
İ
->
ã©u»s
);

3198 
m
->
	`£t_¢­id
(
İ
->
¢­id
);

3199 
m
->
	`£t_¢­_£q
(
İ
->
¢­c
.
£q
);

3200 
m
->
	`£t_¢­s
(
İ
->
¢­c
.
¢­s
);

3202 
m
->
İs
 = 
İ
->ops;

3203 
m
->
	`£t_mtime
(
İ
->
mtime
);

3204 
m
->
	`£t_»Œy_©‹m±
(
İ
->
©‹m±s
++);

3206 ià(!
İ
->
Œaû
.
	`v®id
(è&& 
cù
->
_cÚf
->
osdc_blkš_Œaû_®l
) {

3207 
İ
->
Œaû
.
	`š™
("İ", &
Œaû_’dpošt
);

3210 ià(
İ
->
´iÜ™y
)

3211 
m
->
	`£t_´iÜ™y
(
İ
->
´iÜ™y
);

3213 
m
->
	`£t_´iÜ™y
(
cù
->
_cÚf
->
osd_ş›Á_İ_´iÜ™y
);

3215 ià(
İ
->
»qid
 !ğ
	`osd_»qid_t
()) {

3216 
m
->
	`£t_»qid
(
İ
->
»qid
);

3219 
logg”
->
	`šc
(
l_osdc_İ_£nd
);

3220 
ssize_t
 
sum
 = 0;

3221 
i
 = 0; i < 
m
->
İs
.
	`size
(); i++) {

3222 
sum
 +ğ
m
->
İs
[
i
].
šd©a
.
	`Ëngth
();

3224 
logg”
->
	`šc
(
l_osdc_İ_£nd_by‹s
, 
sum
);

3226  
m
;

3227 
	}
}

3229 
	gObjeù”
::
	$_£nd_İ
(
Op
 *
İ
)

3235 autØ
p
 = 
İ
->
£ssiÚ
->
backoffs
.
	`fšd
(İ->
rg‘
.
aùu®_pgid
);

3236 ià(
p
 !ğ
İ
->
£ssiÚ
->
backoffs
.
	`’d
()) {

3237 
hobjeù_t
 
hoid
 = 
İ
->
rg‘
.
	`g‘_hobj
();

3238 autØ
q
 = 
p
->
£cÚd
.
	`low”_bound
(
hoid
);

3239 ià(
q
 !ğ
p
->
£cÚd
.
	`begš
()) {

3240 --
q
;

3241 ià(
hoid
 >ğ
q
->
£cÚd
.
’d
) {

3242 ++
q
;

3245 ià(
q
 !ğ
p
->
£cÚd
.
	`’d
()) {

3246 
	`ldout
(
cù
, 20è<< 
__func__
 << " ? " << 
q
->
fœ¡
 << " [" << q->
£cÚd
.
begš


3247 << "," << 
q
->
£cÚd
.
’d
 << ")" << 
d’dl
;

3248 
r
 = 
	`cmp
(
hoid
, 
q
->
£cÚd
.
begš
);

3249 ià(
r
 =ğ0 || (¸> 0 && 
hoid
 < 
q
->
£cÚd
.
’d
)) {

3250 
	`ldout
(
cù
, 10è<< 
__func__
 << " backofà" << 
İ
->
rg‘
.
aùu®_pgid


3251 << " id " << 
q
->
£cÚd
.
id
 << " oÀ" << 
hoid


3252 << ", queušg " << 
İ
 << "id " << op->
tid
 << 
d’dl
;

3258 
	`as£¹
(
İ
->
tid
 > 0);

3259 
MOSDOp
 *
m
 = 
	`_´•¬e_osd_İ
(
İ
);

3261 ià(
İ
->
rg‘
.
aùu®_pgid
 !ğ
m
->
	`g‘_¥g
()) {

3262 
	`ldout
(
cù
, 10è<< 
__func__
 << " " << 
İ
->
tid
 << "…gid change from "

3263 << 
m
->
	`g‘_¥g
(è<< "Ø" << 
İ
->
rg‘
.
aùu®_pgid


3264 << ", upd©šg‡nd„“ncodšg" << 
d’dl
;

3265 
m
->
	`£t_¥g
(
İ
->
rg‘
.
aùu®_pgid
);

3266 
m
->
	`ş—r_·ylßd
();

3269 
	`ldout
(
cù
, 15è<< "_£nd_İ " << 
İ
->
tid
 << "o "

3270 << 
İ
->
rg‘
.
aùu®_pgid
 << " oÀosd." << op->
£ssiÚ
->
osd


3271 << 
d’dl
;

3273 
CÚÃùiÚRef
 
cÚ
 = 
İ
->
£ssiÚ
->con;

3274 
	`as£¹
(
cÚ
);

3277 ià(
İ
->
cÚ
) {

3278 
	`ldout
(
cù
, 20è<< "„evokšg„x bufã¸fÜ " << 
İ
->
tid
 << " on "

3279 << 
İ
->
cÚ
 << 
d’dl
;

3280 
İ
->
cÚ
->
	`»voke_rx_bufãr
(İ->
tid
);

3282 ià(
İ
->
outbl
 &&

3283 
İ
->
Útimeout
 == 0 &&

3284 
İ
->
outbl
->
	`Ëngth
()) {

3285 
	`ldout
(
cù
, 20è<< "…o¡šg„x bufã¸fÜ " << 
İ
->
tid
 << " oÀ" << 
cÚ


3286 << 
d’dl
;

3287 
İ
->
cÚ
 = con;

3288 
İ
->
cÚ
->
	`po¡_rx_bufãr
(İ->
tid
, *İ->
outbl
);

3291 
İ
->
šÿº©iÚ
 = op->
£ssiÚ
->incarnation;

3293 ià(
İ
->
Œaû
.
	`v®id
()) {

3294 
m
->
Œaû
.
	`š™
("İ msg", 
nuÎ±r
, &
İ
->trace);

3296 
İ
->
£ssiÚ
->
cÚ
->
	`£nd_mes§ge
(
m
);

3297 
	}
}

3299 
	gObjeù”
::
ÿlc_İ_budg‘
(cÚ¡ 
veùÜ
<
OSDOp
>& 
İs
)

3301 
İ_budg‘
 = 0;

3302 
	gveùÜ
<
	gOSDOp
>::
cÚ¡_™”©Ü
 
i
 = 
İs
.
begš
();

3303 
	gi
 !ğ
İs
.
’d
();

3304 ++
	gi
) {

3305 ià(
	gi
->
	gİ
.İ & 
	gCEPH_OSD_OP_MODE_WR
) {

3306 
	gİ_budg‘
 +ğ
i
->
šd©a
.
Ëngth
();

3307 } ià(
ûph_osd_İ_mode_»ad
(
i
->
İ
.op)) {

3308 ià(
ûph_osd_İ_ty³_d©a
(
i
->
İ
.op)) {

3309 ià((
	gšt64_t
)
	gi
->
	gİ
.
	gex‹Á
.
	gËngth
 > 0)

3310 
	gİ_budg‘
 +ğ(
št64_t
)
i
->
İ
.
ex‹Á
.
Ëngth
;

3311 } ià(
ûph_osd_İ_ty³_©Œ
(
i
->
İ
.op)) {

3312 
	gİ_budg‘
 +ğ
i
->
İ
.
x©Œ
.
Çme_Ën
 + i->İ.x©Œ.
v®ue_Ën
;

3316  
	gİ_budg‘
;

3319 
	gObjeù”
::
	$_thrÙe_İ
(
Op
 *
İ
,

3320 
shunique_lock
& 
sul
,

3321 
İ_budg‘
)

3323 
	`as£¹
(
sul
 && sul.
	`mu‹x
(è=ğ&
rwlock
);

3324 
boŞ
 
locked_fÜ_wr™e
 = 
sul
.
	`owns_lock
();

3326 ià(!
İ_budg‘
)

3327 
İ_budg‘
 = 
	`ÿlc_İ_budg‘
(
İ
->
İs
);

3328 ià(!
İ_thrÙe_by‹s
.
	`g‘_Ü_ç
(
İ_budg‘
)) {

3329 
sul
.
	`uÆock
();

3330 
İ_thrÙe_by‹s
.
	`g‘
(
İ_budg‘
);

3331 ià(
locked_fÜ_wr™e
)

3332 
sul
.
	`lock
();

3334 
sul
.
	`lock_sh¬ed
();

3336 ià(!
İ_thrÙe_İs
.
	`g‘_Ü_ç
(1)) {

3337 
sul
.
	`uÆock
();

3338 
İ_thrÙe_İs
.
	`g‘
(1);

3339 ià(
locked_fÜ_wr™e
)

3340 
sul
.
	`lock
();

3342 
sul
.
	`lock_sh¬ed
();

3344 
	}
}

3346 
	gObjeù”
::
	$ke_lšg”_budg‘
(
Lšg”Op
 *
šfo
)

3349 
	}
}

3352 
	gObjeù”
::
	$hªdË_osd_İ_»¶y
(
MOSDOpR•ly
 *
m
)

3354 
	`ldout
(
cù
, 10è<< "š hªdË_osd_İ_»¶y" << 
d’dl
;

3357 
ûph_tid_t
 
tid
 = 
m
->
	`g‘_tid
();

3359 
shunique_lock
 
	`sul
(
rwlock
, 
ûph
::
acquœe_sh¬ed
);

3360 ià(!
š™Ÿlized
) {

3361 
m
->
	`put
();

3365 
CÚÃùiÚRef
 
cÚ
 = 
m
->
	`g‘_cÚÃùiÚ
();

3366 
OSDSessiÚ
 *
s
 = 
¡©ic_ÿ¡
<OSDSessiÚ*>(
cÚ
->
	`g‘_´iv
());

3367 ià(!
s
 || s->
cÚ
 != con) {

3368 
	`ldout
(
cù
, 7è<< 
__func__
 << "‚Ø£ssiÚ oÀcÚ " << 
cÚ
 << 
d’dl
;

3369 ià(
s
) {

3370 
s
->
	`put
();

3372 
m
->
	`put
();

3376 
OSDSessiÚ
::
unique_lock
 
	`¦
(
s
->
lock
);

3378 
m­
<
ûph_tid_t
, 
Op
 *>::
™”©Ü
 
™”
 = 
s
->
İs
.
	`fšd
(
tid
);

3379 ià(
™”
 =ğ
s
->
İs
.
	`’d
()) {

3380 
	`ldout
(
cù
, 7è<< "hªdË_osd_İ_»¶y " << 
tid


3381 << (
m
->
	`is_Údisk
(è? " ondisk" : (m->
	`is_Únv¿m
() ?

3383 << " ... sŒay" << 
d’dl
;

3384 
¦
.
	`uÆock
();

3385 
s
->
	`put
();

3386 
m
->
	`put
();

3390 
	`ldout
(
cù
, 7è<< "hªdË_osd_İ_»¶y " << 
tid


3391 << (
m
->
	`is_Údisk
() ? " ondisk" :

3392 (
m
->
	`is_Únv¿m
() ? " onnvram" : "‡ck"))

3393 << " uv " << 
m
->
	`g‘_u£r_v”siÚ
()

3394 << " iÀ" << 
m
->
	`g‘_pg
()

3395 << "‡‰em± " << 
m
->
	`g‘_»Œy_©‹m±
()

3396 << 
d’dl
;

3397 
Op
 *
İ
 = 
™”
->
£cÚd
;

3398 
İ
->
Œaû
.
	`ev’t
("osd op„eply");

3400 ià(
»Œy_wr™es_aá”_fœ¡_»¶y
 && 
İ
->
©‹m±s
 == 1 &&

3401 (
İ
->
rg‘
.
æags
 & 
CEPH_OSD_FLAG_WRITE
)) {

3402 
	`ldout
(
cù
, 7è<< "»Œyšg wr™aá” fœ¡„•ly: " << 
tid
 << 
d’dl
;

3403 ià(
İ
->
Úfšish
) {

3404 
num_š_æight
--;

3406 
	`_£ssiÚ_İ_»move
(
s
, 
İ
);

3407 
¦
.
	`uÆock
();

3408 
s
->
	`put
();

3410 
	`_İ_subm™
(
İ
, 
sul
, 
NULL
);

3411 
m
->
	`put
();

3415 ià(
m
->
	`g‘_»Œy_©‹m±
() >= 0) {

3416 ià(
m
->
	`g‘_»Œy_©‹m±
(è!ğ(
İ
->
©‹m±s
 - 1)) {

3417 
	`ldout
(
cù
, 7) << " ignoring„eply from‡ttempt "

3418 << 
m
->
	`g‘_»Œy_©‹m±
()

3419 << " from " << 
m
->
	`g‘_sourû_š¡
()

3420 << ";†a¡‡‰em± " << (
İ
->
©‹m±s
 - 1) << " sento "

3421 << 
İ
->
£ssiÚ
->
cÚ
->
	`g‘_³”_addr
(è<< 
d’dl
;

3422 
m
->
	`put
();

3423 
¦
.
	`uÆock
();

3424 
s
->
	`put
();

3433 
CÚ‹xt
 *
Úfšish
 = 0;

3435 
rc
 = 
m
->
	`g‘_»suÉ
();

3437 ià(
m
->
	`is_»dœeù_»¶y
()) {

3438 
	`ldout
(
cù
, 5è<< " gÙ„edœeù„•ly;„edœeùšg" << 
d’dl
;

3439 ià(
İ
->
Úfšish
)

3440 
num_š_æight
--;

3441 
	`_£ssiÚ_İ_»move
(
s
, 
İ
);

3442 
¦
.
	`uÆock
();

3443 
s
->
	`put
();

3447 
İ
->
tid
 = 0;

3448 
m
->
	`g‘_»dœeù
().
	`combše_w™h_loÿtÜ
(
İ
->
rg‘
.
rg‘_Şoc
,

3449 
İ
->
rg‘
.
rg‘_oid
.
Çme
);

3450 
İ
->
rg‘
.
æags
 |ğ(
CEPH_OSD_FLAG_REDIRECTED
 | 
CEPH_OSD_FLAG_IGNORE_OVERLAY
);

3451 
	`_İ_subm™
(
İ
, 
sul
, 
NULL
);

3452 
m
->
	`put
();

3456 ià(
rc
 =ğ-
EAGAIN
) {

3457 
	`ldout
(
cù
, 7è<< " gÙ -EAGAIN,„esubm™tšg" << 
d’dl
;

3458 ià(
İ
->
Úfšish
)

3459 
num_š_æight
--;

3460 
	`_£ssiÚ_İ_»move
(
s
, 
İ
);

3461 
¦
.
	`uÆock
();

3462 
s
->
	`put
();

3464 
İ
->
tid
 = 0;

3465 
İ
->
rg‘
.
æags
 &ğ~(
CEPH_OSD_FLAG_BALANCE_READS
 |

3466 
CEPH_OSD_FLAG_LOCALIZE_READS
);

3467 
İ
->
rg‘
.
pgid
 = 
	`pg_t
();

3468 
	`_İ_subm™
(
İ
, 
sul
, 
NULL
);

3469 
m
->
	`put
();

3473 
sul
.
	`uÆock
();

3475 ià(
İ
->
objv”
)

3476 *
İ
->
objv”
 = 
m
->
	`g‘_u£r_v”siÚ
();

3477 ià(
İ
->
»¶y_•och
)

3478 *
İ
->
»¶y_•och
 = 
m
->
	`g‘_m­_•och
();

3479 ià(
İ
->
d©a_off£t
)

3480 *
İ
->
d©a_off£t
 = 
m
->
	`g‘_h—d”
().
d©a_off
;

3483 ià(
İ
->
outbl
) {

3484 ià(
İ
->
cÚ
)

3485 
İ
->
cÚ
->
	`»voke_rx_bufãr
(İ->
tid
);

3486 
m
->
	`şaim_d©a
(*
İ
->
outbl
);

3487 
İ
->
outbl
 = 0;

3491 
veùÜ
<
OSDOp
> 
out_İs
;

3492 
m
->
	`şaim_İs
(
out_İs
);

3494 ià(
out_İs
.
	`size
(è!ğ
İ
->
İs
.size())

3495 
	`ldout
(
cù
, 0è<< "WARNING:id " << 
İ
->
tid
 << "„•ly op " << 
out_İs


3496 << " !ğ»que¡ op " << 
İ
->
İs


3497 << " from " << 
m
->
	`g‘_sourû_š¡
(è<< 
d’dl
;

3499 
veùÜ
<
bufã¾i¡
*>::
™”©Ü
 
pb
 = 
İ
->
out_bl
.
	`begš
();

3500 
veùÜ
<*>::
™”©Ü
 
´
 = 
İ
->
out_rv®
.
	`begš
();

3501 
veùÜ
<
CÚ‹xt
*>::
™”©Ü
 
ph
 = 
İ
->
out_hªdËr
.
	`begš
();

3502 
	`as£¹
(
İ
->
out_bl
.
	`size
(è=ğİ->
out_rv®
.size());

3503 
	`as£¹
(
İ
->
out_bl
.
	`size
(è=ğİ->
out_hªdËr
.size());

3504 
veùÜ
<
OSDOp
>::
™”©Ü
 
p
 = 
out_İs
.
	`begš
();

3505 
i
 = 0;

3506 
p
 !ğ
out_İs
.
	`’d
(è&& 
pb
 !ğ
İ
->
out_bl
.end();

3507 ++
i
, ++
p
, ++
pb
, ++
´
, ++
ph
) {

3508 
	`ldout
(
cù
, 10è<< " o°" << 
i
 << "„v® " << 
p
->
rv®


3509 << "†’ " << 
p
->
outd©a
.
	`Ëngth
(è<< 
d’dl
;

3510 ià(*
pb
)

3511 **
pb
 = 
p
->
outd©a
;

3514 ià(*
´
)

3515 **
´
 = 
	`ûph_to_ho¡os_”ºo
(
p
->
rv®
);

3516 ià(*
ph
) {

3517 
	`ldout
(
cù
, 10è<< " o°" << 
i
 << " hªdË¸" << *
ph
 << 
d’dl
;

3518 (*
ph
)->
	`com¶‘e
(
	`ûph_to_ho¡os_”ºo
(
p
->
rv®
));

3519 *
ph
 = 
NULL
;

3526 ià(
İ
->
Úfšish
) {

3527 
num_š_æight
--;

3528 
Úfšish
 = 
İ
->onfinish;

3529 
İ
->
Úfšish
 = 
NULL
;

3531 
logg”
->
	`šc
(
l_osdc_İ_»¶y
);

3534 autØ
com¶‘iÚ_lock
 = 
s
->
	`g‘_lock
(
İ
->
rg‘
.
ba£_oid
);

3536 
	`ldout
(
cù
, 15è<< "hªdË_osd_İ_»¶y com¶‘edid " << 
tid
 << 
d’dl
;

3537 
	`_fšish_İ
(
İ
, 0);

3539 
	`ldout
(
cù
, 5è<< 
num_š_æight
 << " iÀæight" << 
d’dl
;

3542 ià(
com¶‘iÚ_lock
.
	`mu‹x
()) {

3543 
com¶‘iÚ_lock
.
	`lock
();

3545 
¦
.
	`uÆock
();

3548 ià(
Úfšish
) {

3549 
Úfšish
->
	`com¶‘e
(
rc
);

3551 ià(
com¶‘iÚ_lock
.
	`mu‹x
()) {

3552 
com¶‘iÚ_lock
.
	`uÆock
();

3555 
m
->
	`put
();

3556 
s
->
	`put
();

3557 
	}
}

3559 
	gObjeù”
::
	$hªdË_osd_backoff
(
MOSDBackoff
 *
m
)

3561 
	`ldout
(
cù
, 10è<< 
__func__
 << " " << *
m
 << 
d’dl
;

3562 
shunique_lock
 
	`sul
(
rwlock
, 
ûph
::
acquœe_sh¬ed
);

3563 ià(!
š™Ÿlized
) {

3564 
m
->
	`put
();

3568 
CÚÃùiÚRef
 
cÚ
 = 
m
->
	`g‘_cÚÃùiÚ
();

3569 
OSDSessiÚ
 *
s
 = 
¡©ic_ÿ¡
<OSDSessiÚ*>(
cÚ
->
	`g‘_´iv
());

3570 ià(!
s
 || s->
cÚ
 != con) {

3571 
	`ldout
(
cù
, 7è<< 
__func__
 << "‚Ø£ssiÚ oÀcÚ " << 
cÚ
 << 
d’dl
;

3572 ià(
s
)

3573 
s
->
	`put
();

3574 
m
->
	`put
();

3578 
	`g‘_£ssiÚ
(
s
);

3579 
s
->
	`put
();

3581 
OSDSessiÚ
::
unique_lock
 
	`¦
(
s
->
lock
);

3583 
m
->
İ
) {

3584 
CEPH_OSD_BACKOFF_OP_BLOCK
:

3587 
OSDBackoff
& 
b
 = 
s
->
backoffs
[
m
->
pgid
][m->
begš
];

3588 
s
->
backoffs_by_id
.
	`š£¹
(
	`make_·œ
(
m
->
id
, &
b
));

3589 
b
.
pgid
 = 
m
->pgid;

3590 
b
.
id
 = 
m
->id;

3591 
b
.
begš
 = 
m
->begin;

3592 
b
.
’d
 = 
m
->end;

3596 
Mes§ge
 *
r
 = 
Ãw
 
	`MOSDBackoff
(
m
->
pgid
,

3597 
m
->
m­_•och
,

3598 
CEPH_OSD_BACKOFF_OP_ACK_BLOCK
,

3599 
m
->
id
, m->
begš
, m->
’d
);

3601 
r
->
	`£t_´iÜ™y
(
cù
->
_cÚf
->
osd_ş›Á_İ_´iÜ™y
);

3602 
cÚ
->
	`£nd_mes§ge
(
r
);

3606 
CEPH_OSD_BACKOFF_OP_UNBLOCK
:

3608 autØ
p
 = 
s
->
backoffs_by_id
.
	`fšd
(
m
->
id
);

3609 ià(
p
 !ğ
s
->
backoffs_by_id
.
	`’d
()) {

3610 
OSDBackoff
 *
b
 = 
p
->
£cÚd
;

3611 ià(
b
->
begš
 !ğ
m
->begin &&

3612 
b
->
’d
 !ğ
m
->end) {

3613 
	`ld”r
(
cù
è<< 
__func__
 << " gÙ " << 
m
->
pgid
 << " id " << m->
id


3615 << 
m
->
begš
 << "," << m->
’d
 << ") but backoff is ["

3616 << 
b
->
begš
 << "," << b->
’d
 << ")" << 
d’dl
;

3619 
	`ldout
(
cù
, 10è<< 
__func__
 << " unblock backofà" << 
b
->
pgid


3620 << " id " << 
b
->
id


3621 << " [" << 
b
->
begš
 << "," << b->
’d


3622 << ")" << 
d’dl
;

3623 autØ
¥gp
 = 
s
->
backoffs
.
	`fšd
(
b
->
pgid
);

3624 
	`as£¹
(
¥gp
 !ğ
s
->
backoffs
.
	`’d
());

3625 
¥gp
->
£cÚd
.
	`”a£
(
b
->
begš
);

3626 ià(
¥gp
->
£cÚd
.
	`em±y
()) {

3627 
s
->
backoffs
.
	`”a£
(
¥gp
);

3629 
s
->
backoffs_by_id
.
	`”a£
(
p
);

3632 auto& 
q
 : 
s
->
İs
) {

3633 ià(
q
.
£cÚd
->
rg‘
.
aùu®_pgid
 =ğ
m
->
pgid
) {

3634 
r
 = 
q
.
£cÚd
->
rg‘
.
	`cÚšed_by
(
m
->
begš
, m->
’d
);

3635 
	`ldout
(
cù
, 20è<< 
__func__
 << " cÚšed_by " << 
r
 << " on "

3636 << 
q
.
£cÚd
->
rg‘
.
	`g‘_hobj
(è<< 
d’dl
;

3637 ià(
r
) {

3638 
	`_£nd_İ
(
q
.
£cÚd
);

3643 
	`ld”r
(
cù
è<< 
__func__
 << " " << 
m
->
pgid
 << " id " << m->
id


3645 << 
m
->
begš
 << "," << m->
’d
 << "èbuˆbackofàdÃ" << 
d’dl
;

3651 
	`ldout
(
cù
, 10è<< 
__func__
 << " uÄecognized o°" << ()
m
->
İ
 << 
d’dl
;

3654 
sul
.
	`uÆock
();

3655 
¦
.
	`uÆock
();

3657 
m
->
	`put
();

3658 
	`put_£ssiÚ
(
s
);

3659 
	}
}

3661 
ušt32_t
 
	gObjeù”
::
	$li¡_nobjeùs_£ek
(
NLi¡CÚ‹xt
 *
li¡_cÚ‹xt
,

3662 
ušt32_t
 
pos
)

3664 
sh¬ed_lock
 
	`¾
(
rwlock
);

3665 
li¡_cÚ‹xt
->
pos
 = 
	`hobjeù_t
(
	`objeù_t
(), 
	`¡ršg
(), 
CEPH_NOSNAP
,

3666 
pos
, 
li¡_cÚ‹xt
->
poŞ_id
, 
	`¡ršg
());

3667 
	`ldout
(
cù
, 10è<< 
__func__
 << " " << 
li¡_cÚ‹xt


3668 << "…o " << 
pos
 << " -> " << 
li¡_cÚ‹xt
->po << 
d’dl
;

3669 
pg_t
 
aùu®
 = 
osdm­
->
	`¿w_pg_to_pg
(
	`pg_t
(
pos
, 
li¡_cÚ‹xt
->
poŞ_id
));

3670 
li¡_cÚ‹xt
->
cu¼’t_pg
 = 
aùu®
.
	`ps
();

3671 
li¡_cÚ‹xt
->
©_’d_of_poŞ
 = 
çl£
;

3672  
pos
;

3673 
	}
}

3675 
ušt32_t
 
	gObjeù”
::
	$li¡_nobjeùs_£ek
(
NLi¡CÚ‹xt
 *
li¡_cÚ‹xt
,

3676 cÚ¡ 
hobjeù_t
& 
cursÜ
)

3678 
sh¬ed_lock
 
	`¾
(
rwlock
);

3679 
	`ldout
(
cù
, 10è<< "li¡_nobjeùs_£ek " << 
li¡_cÚ‹xt
 << 
d’dl
;

3680 
li¡_cÚ‹xt
->
pos
 = 
cursÜ
;

3681 
li¡_cÚ‹xt
->
©_’d_of_poŞ
 = 
çl£
;

3682 
pg_t
 
aùu®
 = 
osdm­
->
	`¿w_pg_to_pg
(
	`pg_t
(
cursÜ
.
	`g‘_hash
(), 
li¡_cÚ‹xt
->
poŞ_id
));

3683 
li¡_cÚ‹xt
->
cu¼’t_pg
 = 
aùu®
.
	`ps
();

3684 
li¡_cÚ‹xt
->
sÜt_b™wi£
 = 
Œue
;

3685  
li¡_cÚ‹xt
->
cu¼’t_pg
;

3686 
	}
}

3688 
	gObjeù”
::
	$li¡_nobjeùs_g‘_cursÜ
(
NLi¡CÚ‹xt
 *
li¡_cÚ‹xt
,

3689 
hobjeù_t
 *
cursÜ
)

3691 
sh¬ed_lock
 
	`¾
(
rwlock
);

3692 ià(
li¡_cÚ‹xt
->
li¡
.
	`em±y
()) {

3693 *
cursÜ
 = 
li¡_cÚ‹xt
->
pos
;

3695 cÚ¡ 
lib¿dos
::
Li¡ObjeùIm¶
& 
’Œy
 = 
li¡_cÚ‹xt
->
li¡
.
	`äÚt
();

3696 cÚ¡ 
¡ršg
 *
key
 = (
’Œy
.
loÿtÜ
.
	`em±y
(è? &’Œy.
oid
 : &entry.locator);

3697 
ušt32_t
 
h
 = 
osdm­
->
	`g‘_pg_poŞ
(
li¡_cÚ‹xt
->
poŞ_id
)->
	`hash_key
(*
key
, 
’Œy
.
n¥aû
);

3698 *
cursÜ
 = 
	`hobjeù_t
(
’Œy
.
oid
,ƒÁry.
loÿtÜ
, 
li¡_cÚ‹xt
->
poŞ_¢­_£q
, 
h
,†i¡_cÚ‹xt->
poŞ_id
,ƒÁry.
n¥aû
);

3700 
	}
}

3702 
	gObjeù”
::
	$li¡_nobjeùs
(
NLi¡CÚ‹xt
 *
li¡_cÚ‹xt
, 
CÚ‹xt
 *
Úfšish
)

3704 
	`ldout
(
cù
, 10è<< 
__func__
 << "…oŞ_id " << 
li¡_cÚ‹xt
->
poŞ_id


3705 << "…oŞ_¢­_£q " << 
li¡_cÚ‹xt
->
poŞ_¢­_£q


3706 << " max_’Œ› " << 
li¡_cÚ‹xt
->
max_’Œ›s


3707 << "†i¡_cÚ‹xˆ" << 
li¡_cÚ‹xt


3708 << " onfšish " << 
Úfšish


3709 << " cu¼’t_pg " << 
li¡_cÚ‹xt
->
cu¼’t_pg


3710 << "…o " << 
li¡_cÚ‹xt
->
pos
 << 
d’dl
;

3712 
sh¬ed_lock
 
	`¾
(
rwlock
);

3713 cÚ¡ 
pg_poŞ_t
 *
poŞ
 = 
osdm­
->
	`g‘_pg_poŞ
(
li¡_cÚ‹xt
->
poŞ_id
);

3714 ià(!
poŞ
) {

3715 
¾
.
	`uÆock
();

3716 
	`put_Æi¡_cÚ‹xt_budg‘
(
li¡_cÚ‹xt
);

3717 
Úfšish
->
	`com¶‘e
(-
ENOENT
);

3720 
pg_num
 = 
poŞ
->
	`g‘_pg_num
();

3721 
boŞ
 
sÜt_b™wi£
 = 
osdm­
->
	`‹¡_æag
(
CEPH_OSDMAP_SORTBITWISE
);

3723 ià(
li¡_cÚ‹xt
->
pos
.
	`is_mš
()) {

3724 
li¡_cÚ‹xt
->
¡¬tšg_pg_num
 = 0;

3725 
li¡_cÚ‹xt
->
sÜt_b™wi£
 = sort_bitwise;

3726 
li¡_cÚ‹xt
->
¡¬tšg_pg_num
 = 
pg_num
;

3728 ià(
li¡_cÚ‹xt
->
sÜt_b™wi£
 != sort_bitwise) {

3729 
li¡_cÚ‹xt
->
pos
 = 
	`hobjeù_t
(

3730 
	`objeù_t
(), 
	`¡ršg
(), 
CEPH_NOSNAP
,

3731 
li¡_cÚ‹xt
->
cu¼’t_pg
,†i¡_cÚ‹xt->
poŞ_id
, 
	`¡ršg
());

3732 
li¡_cÚ‹xt
->
sÜt_b™wi£
 = sort_bitwise;

3733 
	`ldout
(
cù
, 10) << " hobject sort order changed,„estartinghis…g‡t "

3734 << 
li¡_cÚ‹xt
->
pos
 << 
d’dl
;

3736 ià(
li¡_cÚ‹xt
->
¡¬tšg_pg_num
 !ğ
pg_num
) {

3737 ià(!
sÜt_b™wi£
) {

3739 
	`ldout
(
cù
, 10è<< "…g_num chªged;„e¡¬tšg w™h " << 
pg_num
 << 
d’dl
;

3740 
li¡_cÚ‹xt
->
pos
 = 
	`cŞËùiÚ_li¡_hªdË_t
();

3742 
li¡_cÚ‹xt
->
¡¬tšg_pg_num
 = 
pg_num
;

3745 ià(
li¡_cÚ‹xt
->
pos
.
	`is_max
()) {

3746 
	`ldout
(
cù
, 20è<< 
__func__
 << "ƒnd of…ool,†ist "

3747 << 
li¡_cÚ‹xt
->
li¡
 << 
d’dl
;

3748 ià(
li¡_cÚ‹xt
->
li¡
.
	`em±y
()) {

3749 
li¡_cÚ‹xt
->
©_’d_of_poŞ
 = 
Œue
;

3753 
	`put_Æi¡_cÚ‹xt_budg‘
(
li¡_cÚ‹xt
);

3754 
Úfšish
->
	`com¶‘e
(0);

3758 
ObjeùO³¿tiÚ
 
İ
;

3759 
İ
.
	`pg_Æs
(
li¡_cÚ‹xt
->
max_’Œ›s
,†i¡_cÚ‹xt->
f‹r
,

3760 
li¡_cÚ‹xt
->
pos
, 
osdm­
->
	`g‘_•och
());

3761 
li¡_cÚ‹xt
->
bl
.
	`ş—r
();

3762 
C_NLi¡
 *
Úack
 = 
Ãw
 
	`C_NLi¡
(
li¡_cÚ‹xt
, 
Úfšish
, 
this
);

3763 
objeù_loÿtÜ_t
 
	`Şoc
(
li¡_cÚ‹xt
->
poŞ_id
,†i¡_cÚ‹xt->
n¥aû
);

3766 
li¡_cÚ‹xt
->
cu¼’t_pg
 = 
poŞ
->
	`¿w_hash_to_pg
Öi¡_cÚ‹xt->
pos
.
	`g‘_hash
());

3767 
¾
.
	`uÆock
();

3769 
	`pg_»ad
(
li¡_cÚ‹xt
->
cu¼’t_pg
, 
Şoc
, 
İ
,

3770 &
li¡_cÚ‹xt
->
bl
, 0, 
Úack
, &Úack->
•och
,

3771 &
li¡_cÚ‹xt
->
ùx_budg‘
);

3772 
	}
}

3774 
	gObjeù”
::
	$_Æi¡_»¶y
(
NLi¡CÚ‹xt
 *
li¡_cÚ‹xt
, 
r
,

3775 
CÚ‹xt
 *
fš®_fšish
, 
•och_t
 
»¶y_•och
)

3777 
	`ldout
(
cù
, 10è<< 
__func__
 << " " << 
li¡_cÚ‹xt
 << 
d’dl
;

3779 
bufã¾i¡
::
™”©Ü
 
™”
 = 
li¡_cÚ‹xt
->
bl
.
	`begš
();

3780 
pg_Æs_»¥Ú£_t
 
»¥Ú£
;

3781 
bufã¾i¡
 
exŒa_šfo
;

3782 
	`decode
(
»¥Ú£
, 
™”
);

3783 ià(!
™”
.
	`’d
()) {

3784 
	`decode
(
exŒa_šfo
, 
™”
);

3789 ià((
»¥Ú£
.
hªdË
.
	`is_max
(è|| 
r
 == 1) &&

3790 !
li¡_cÚ‹xt
->
sÜt_b™wi£
) {

3792 ++
li¡_cÚ‹xt
->
cu¼’t_pg
;

3793 ià(
li¡_cÚ‹xt
->
cu¼’t_pg
 =ğli¡_cÚ‹xt->
¡¬tšg_pg_num
) {

3795 
li¡_cÚ‹xt
->
pos
 = 
hobjeù_t
::
	`g‘_max
();

3798 
li¡_cÚ‹xt
->
pos
 = 
	`hobjeù_t
(
	`objeù_t
(), 
	`¡ršg
(), 
CEPH_NOSNAP
,

3799 
li¡_cÚ‹xt
->
cu¼’t_pg
,

3800 
li¡_cÚ‹xt
->
poŞ_id
, 
	`¡ršg
());

3803 
li¡_cÚ‹xt
->
pos
 = 
»¥Ú£
.
hªdË
;

3806 
»¥Ú£_size
 = 
»¥Ú£
.
’Œ›s
.
	`size
();

3807 
	`ldout
(
cù
, 20è<< "„e¥Ú£.’Œ›s.siz" << 
»¥Ú£_size


3808 << ",„e¥Ú£.’Œ› " << 
»¥Ú£
.
’Œ›s


3809 << ", hªdË " << 
»¥Ú£
.
hªdË


3810 << ",’tivÃw…o " << 
li¡_cÚ‹xt
->
pos
 << 
d’dl
;

3811 
li¡_cÚ‹xt
->
exŒa_šfo
.
	`­³nd
(extra_info);

3812 ià(
»¥Ú£_size
) {

3813 
li¡_cÚ‹xt
->
li¡
.
	`¥liû
Öi¡_cÚ‹xt->li¡.
	`’d
(), 
»¥Ú£
.
’Œ›s
);

3816 ià(
li¡_cÚ‹xt
->
li¡
.
	`size
(è>ğli¡_cÚ‹xt->
max_’Œ›s
) {

3817 
	`ldout
(
cù
, 20) << " hit max,„eturning„esults so far, "

3818 << 
li¡_cÚ‹xt
->
li¡
 << 
d’dl
;

3821 
	`put_Æi¡_cÚ‹xt_budg‘
(
li¡_cÚ‹xt
);

3822 
fš®_fšish
->
	`com¶‘e
(0);

3827 
	`li¡_nobjeùs
(
li¡_cÚ‹xt
, 
fš®_fšish
);

3828 
	}
}

3830 
	gObjeù”
::
	$put_Æi¡_cÚ‹xt_budg‘
(
NLi¡CÚ‹xt
 *
li¡_cÚ‹xt
)

3832 ià(
li¡_cÚ‹xt
->
ùx_budg‘
 >= 0) {

3833 
	`ldout
(
cù
, 10) << "„elease†isting context's budget " <<

3834 
li¡_cÚ‹xt
->
ùx_budg‘
 << 
d’dl
;

3835 
	`put_İ_budg‘_by‹s
(
li¡_cÚ‹xt
->
ùx_budg‘
);

3836 
li¡_cÚ‹xt
->
ùx_budg‘
 = -1;

3838 
	}
}

3842 
	gObjeù”
::
	$ü—‹_poŞ_¢­
(
št64_t
 
poŞ
, 
¡ršg
& 
¢­_Çme
,

3843 
CÚ‹xt
 *
Úfšish
)

3845 
unique_lock
 
	`wl
(
rwlock
);

3846 
	`ldout
(
cù
, 10è<< "ü—‹_poŞ_¢­;…oŞ: " << 
poŞ
 << "; snap: "

3847 << 
¢­_Çme
 << 
d’dl
;

3849 cÚ¡ 
pg_poŞ_t
 *
p
 = 
osdm­
->
	`g‘_pg_poŞ
(
poŞ
);

3850 ià(!
p
)

3851  -
EINVAL
;

3852 ià(
p
->
	`¢­_exi¡s
(
¢­_Çme
.
	`c_¡r
()))

3853  -
EEXIST
;

3855 
PoŞOp
 *
İ
 = 
Ãw
 PoolOp;

3856 ià(!
İ
)

3857  -
ENOMEM
;

3858 
İ
->
tid
 = ++
Ï¡_tid
;

3859 
İ
->
poŞ
 =…ool;

3860 
İ
->
Çme
 = 
¢­_Çme
;

3861 
İ
->
Úfšish
 = onfinish;

3862 
İ
->
poŞ_İ
 = 
POOL_OP_CREATE_SNAP
;

3863 
poŞ_İs
[
İ
->
tid
] = op;

3865 
	`poŞ_İ_subm™
(
İ
);

3868 
	}
}

3870 
	gC_S–fmªagedSÇp
 : 
public
 
CÚ‹xt
 {

3871 
bufã¾i¡
 
bl
;

3872 
¢­id_t
 *
	gp¢­id
;

3873 
CÚ‹xt
 *
	gfš
;

3874 
C_S–fmªagedSÇp
(
¢­id_t
 *
ps
, 
CÚ‹xt
 *
f
è: 
p¢­id
Õs), 
fš
(f) {}

3875 
fšish
(
r
è
	gov”ride
 {

3876 ià(
	gr
 == 0) {

3877 
Œy
 {

3878 
bufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
begš
();

3879 
decode
(*
p¢­id
, 
p
);

3880 } 
ÿtch
 (
bufãr
::
”rÜ
&) {

3881 
r
 = -
EIO
;

3884 
	gfš
->
com¶‘e
(
r
);

3888 
	gObjeù”
::
	$®loÿ‹_£lfmªaged_¢­
(
št64_t
 
poŞ
, 
¢­id_t
 *
p¢­id
,

3889 
CÚ‹xt
 *
Úfšish
)

3891 
unique_lock
 
	`wl
(
rwlock
);

3892 
	`ldout
(
cù
, 10è<< "®loÿ‹_£lfmªaged_¢­;…oŞ: " << 
poŞ
 << 
d’dl
;

3893 
PoŞOp
 *
İ
 = 
Ãw
 PoolOp;

3894 ià(!
İ
è -
ENOMEM
;

3895 
İ
->
tid
 = ++
Ï¡_tid
;

3896 
İ
->
poŞ
 =…ool;

3897 
C_S–fmªagedSÇp
 *
fš
 = 
Ãw
 
	`C_S–fmªagedSÇp
(
p¢­id
, 
Úfšish
);

3898 
İ
->
Úfšish
 = 
fš
;

3899 
İ
->
bÍ
 = &
fš
->
bl
;

3900 
İ
->
poŞ_İ
 = 
POOL_OP_CREATE_UNMANAGED_SNAP
;

3901 
poŞ_İs
[
İ
->
tid
] = op;

3903 
	`poŞ_İ_subm™
(
İ
);

3905 
	}
}

3907 
	gObjeù”
::
	$d–‘e_poŞ_¢­
(
št64_t
 
poŞ
, 
¡ršg
& 
¢­_Çme
,

3908 
CÚ‹xt
 *
Úfšish
)

3910 
unique_lock
 
	`wl
(
rwlock
);

3911 
	`ldout
(
cù
, 10è<< "d–‘e_poŞ_¢­;…oŞ: " << 
poŞ
 << "; snap: "

3912 << 
¢­_Çme
 << 
d’dl
;

3914 cÚ¡ 
pg_poŞ_t
 *
p
 = 
osdm­
->
	`g‘_pg_poŞ
(
poŞ
);

3915 ià(!
p
)

3916  -
EINVAL
;

3917 ià(!
p
->
	`¢­_exi¡s
(
¢­_Çme
.
	`c_¡r
()))

3918  -
ENOENT
;

3920 
PoŞOp
 *
İ
 = 
Ãw
 PoolOp;

3921 ià(!
İ
)

3922  -
ENOMEM
;

3923 
İ
->
tid
 = ++
Ï¡_tid
;

3924 
İ
->
poŞ
 =…ool;

3925 
İ
->
Çme
 = 
¢­_Çme
;

3926 
İ
->
Úfšish
 = onfinish;

3927 
İ
->
poŞ_İ
 = 
POOL_OP_DELETE_SNAP
;

3928 
poŞ_İs
[
İ
->
tid
] = op;

3930 
	`poŞ_İ_subm™
(
İ
);

3933 
	}
}

3935 
	gObjeù”
::
	$d–‘e_£lfmªaged_¢­
(
št64_t
 
poŞ
, 
¢­id_t
 
¢­
,

3936 
CÚ‹xt
 *
Úfšish
)

3938 
unique_lock
 
	`wl
(
rwlock
);

3939 
	`ldout
(
cù
, 10è<< "d–‘e_£lfmªaged_¢­;…oŞ: " << 
poŞ
 << "; snap: "

3940 << 
¢­
 << 
d’dl
;

3941 
PoŞOp
 *
İ
 = 
Ãw
 PoolOp;

3942 ià(!
İ
è -
ENOMEM
;

3943 
İ
->
tid
 = ++
Ï¡_tid
;

3944 
İ
->
poŞ
 =…ool;

3945 
İ
->
Úfšish
 = onfinish;

3946 
İ
->
poŞ_İ
 = 
POOL_OP_DELETE_UNMANAGED_SNAP
;

3947 
İ
->
¢­id
 = 
¢­
;

3948 
poŞ_İs
[
İ
->
tid
] = op;

3950 
	`poŞ_İ_subm™
(
İ
);

3953 
	}
}

3955 
	gObjeù”
::
	$ü—‹_poŞ
(
¡ršg
& 
Çme
, 
CÚ‹xt
 *
Úfšish
, 
ušt64_t
 
auid
,

3956 
üush_ruË
)

3958 
unique_lock
 
	`wl
(
rwlock
);

3959 
	`ldout
(
cù
, 10è<< "ü—‹_poŞ‚ame=" << 
Çme
 << 
d’dl
;

3961 ià(
osdm­
->
	`lookup_pg_poŞ_Çme
(
Çme
) >= 0)

3962  -
EEXIST
;

3964 
PoŞOp
 *
İ
 = 
Ãw
 PoolOp;

3965 ià(!
İ
)

3966  -
ENOMEM
;

3967 
İ
->
tid
 = ++
Ï¡_tid
;

3968 
İ
->
poŞ
 = 0;

3969 
İ
->
Çme
 =‚ame;

3970 
İ
->
Úfšish
 = onfinish;

3971 
İ
->
poŞ_İ
 = 
POOL_OP_CREATE
;

3972 
poŞ_İs
[
İ
->
tid
] = op;

3973 
İ
->
auid
 =‡uid;

3974 
İ
->
üush_ruË
 = crush_rule;

3976 
	`poŞ_İ_subm™
(
İ
);

3979 
	}
}

3981 
	gObjeù”
::
	$d–‘e_poŞ
(
št64_t
 
poŞ
, 
CÚ‹xt
 *
Úfšish
)

3983 
unique_lock
 
	`wl
(
rwlock
);

3984 
	`ldout
(
cù
, 10è<< "d–‘e_poŞ " << 
poŞ
 << 
d’dl
;

3986 ià(!
osdm­
->
	`have_pg_poŞ
(
poŞ
))

3987  -
ENOENT
;

3989 
	`_do_d–‘e_poŞ
(
poŞ
, 
Úfšish
);

3991 
	}
}

3993 
	gObjeù”
::
	$d–‘e_poŞ
(cÚ¡ 
¡ršg
 &
poŞ_Çme
, 
CÚ‹xt
 *
Úfšish
)

3995 
unique_lock
 
	`wl
(
rwlock
);

3996 
	`ldout
(
cù
, 10è<< "d–‘e_poŞ " << 
poŞ_Çme
 << 
d’dl
;

3998 
št64_t
 
poŞ
 = 
osdm­
->
	`lookup_pg_poŞ_Çme
(
poŞ_Çme
);

3999 ià(
poŞ
 < 0)

4000  
poŞ
;

4002 
	`_do_d–‘e_poŞ
(
poŞ
, 
Úfšish
);

4004 
	}
}

4006 
	gObjeù”
::
	$_do_d–‘e_poŞ
(
št64_t
 
poŞ
, 
CÚ‹xt
 *
Úfšish
)

4008 
PoŞOp
 *
İ
 = 
Ãw
 PoolOp;

4009 
İ
->
tid
 = ++
Ï¡_tid
;

4010 
İ
->
poŞ
 =…ool;

4011 
İ
->
Çme
 = "delete";

4012 
İ
->
Úfšish
 = onfinish;

4013 
İ
->
poŞ_İ
 = 
POOL_OP_DELETE
;

4014 
poŞ_İs
[
İ
->
tid
] = op;

4015 
	`poŞ_İ_subm™
(
İ
);

4016 
	}
}

4024 
	gObjeù”
::
	$chªge_poŞ_auid
(
št64_t
 
poŞ
, 
CÚ‹xt
 *
Úfšish
, 
ušt64_t
 
auid
)

4026 
unique_lock
 
	`wl
(
rwlock
);

4027 
	`ldout
(
cù
, 10è<< "chªge_poŞ_auid " << 
poŞ
 << "Ø" << 
auid
 << 
d’dl
;

4028 
PoŞOp
 *
İ
 = 
Ãw
 PoolOp;

4029 ià(!
İ
è -
ENOMEM
;

4030 
İ
->
tid
 = ++
Ï¡_tid
;

4031 
İ
->
poŞ
 =…ool;

4032 
İ
->
Çme
 = "change_pool_auid";

4033 
İ
->
Úfšish
 = onfinish;

4034 
İ
->
poŞ_İ
 = 
POOL_OP_AUID_CHANGE
;

4035 
İ
->
auid
 =‡uid;

4036 
poŞ_İs
[
İ
->
tid
] = op;

4038 
logg”
->
	`£t
(
l_osdc_poŞİ_aùive
, 
poŞ_İs
.
	`size
());

4040 
	`poŞ_İ_subm™
(
İ
);

4042 
	}
}

4044 
	gObjeù”
::
	$poŞ_İ_subm™
(
PoŞOp
 *
İ
)

4047 ià(
mÚ_timeout
 > 
	`time¥ª
(0)) {

4048 
İ
->
Útimeout
 = 
tim”
.
	`add_ev’t
(
mÚ_timeout
,

4049 [
this
, 
İ
]() {

4050 
	`poŞ_İ_ÿnûl
(
İ
->
tid
, -
ETIMEDOUT
); });

4052 
	`_poŞ_İ_subm™
(
İ
);

4053 
	}
}

4055 
	gObjeù”
::
	$_poŞ_İ_subm™
(
PoŞOp
 *
İ
)

4059 
	`ldout
(
cù
, 10è<< "poŞ_İ_subm™ " << 
İ
->
tid
 << 
d’dl
;

4060 
MPoŞOp
 *
m
 = 
Ãw
 
	`MPoŞOp
(
mÚc
->
	`g‘_fsid
(), 
İ
->
tid
, op->
poŞ
,

4061 
İ
->
Çme
, op->
poŞ_İ
,

4062 
İ
->
auid
, 
Ï¡_£’_osdm­_v”siÚ
);

4063 ià(
İ
->
¢­id
è
m
->snapid = op->snapid;

4064 ià(
İ
->
üush_ruË
è
m
->crush_rule = op->crush_rule;

4065 
mÚc
->
	`£nd_mÚ_mes§ge
(
m
);

4066 
İ
->
Ï¡_subm™
 = 
ûph
::
cßr£_mÚo_şock
::
	`now
();

4068 
logg”
->
	`šc
(
l_osdc_poŞİ_£nd
);

4069 
	}
}

4078 
	gObjeù”
::
	$hªdË_poŞ_İ_»¶y
(
MPoŞOpR•ly
 *
m
)

4080 
	`FUNCTRACE
(
cù
);

4081 
shunique_lock
 
	`sul
(
rwlock
, 
acquœe_sh¬ed
);

4082 ià(!
š™Ÿlized
) {

4083 
sul
.
	`uÆock
();

4084 
m
->
	`put
();

4088 
	`ldout
(
cù
, 10è<< "hªdË_poŞ_İ_»¶y " << *
m
 << 
d’dl
;

4089 
ûph_tid_t
 
tid
 = 
m
->
	`g‘_tid
();

4090 
m­
<
ûph_tid_t
, 
PoŞOp
 *>::
™”©Ü
 
™”
 = 
poŞ_İs
.
	`fšd
(
tid
);

4091 ià(
™”
 !ğ
poŞ_İs
.
	`’d
()) {

4092 
PoŞOp
 *
İ
 = 
™”
->
£cÚd
;

4093 
	`ldout
(
cù
, 10è<< "hav»que¡ " << 
tid
 << "‡ˆ" << 
İ
 << " Op: "

4094 << 
	`ûph_poŞ_İ_Çme
(
İ
->
poŞ_İ
è<< 
d’dl
;

4095 ià(
İ
->
bÍ
)

4096 
İ
->
bÍ
->
	`şaim
(
m
->
»¥Ú£_d©a
);

4097 ià(
m
->
v”siÚ
 > 
Ï¡_£’_osdm­_v”siÚ
)

4098 
Ï¡_£’_osdm­_v”siÚ
 = 
m
->
v”siÚ
;

4099 ià(
osdm­
->
	`g‘_•och
(è< 
m
->
•och
) {

4100 
sul
.
	`uÆock
();

4101 
sul
.
	`lock
();

4104 
™”
 = 
poŞ_İs
.
	`fšd
(
tid
);

4105 ià(
™”
 =ğ
poŞ_İs
.
	`’d
())

4106 
dÚe
;

4107 ià(
osdm­
->
	`g‘_•och
(è< 
m
->
•och
) {

4108 
	`ldout
(
cù
, 20è<< "wa™šg fÜ cl›ÁØ»achƒpoch " << 
m
->
•och


4109 << " befÜÿÎšg back" << 
d’dl
;

4110 
	`_wa™_fÜ_Ãw_m­
(
İ
->
Úfšish
, 
m
->
•och
, m->
»¶yCode
);

4115 
	`as£¹
(
İ
->
Úfšish
);

4116 
İ
->
Úfšish
->
	`com¶‘e
(
m
->
»¶yCode
);

4119 
	`as£¹
(
İ
->
Úfšish
);

4120 
İ
->
Úfšish
->
	`com¶‘e
(
m
->
»¶yCode
);

4122 
İ
->
Úfšish
 = 
NULL
;

4123 ià(!
sul
.
	`owns_lock
()) {

4124 
sul
.
	`uÆock
();

4125 
sul
.
	`lock
();

4127 
™”
 = 
poŞ_İs
.
	`fšd
(
tid
);

4128 ià(
™”
 !ğ
poŞ_İs
.
	`’d
()) {

4129 
	`_fšish_poŞ_İ
(
İ
, 0);

4132 
	`ldout
(
cù
, 10è<< "unknowÀ»que¡ " << 
tid
 << 
d’dl
;

4135 
dÚe
:

4137 
sul
.
	`uÆock
();

4139 
	`ldout
(
cù
, 10è<< "dÚe" << 
d’dl
;

4140 
m
->
	`put
();

4141 
	}
}

4143 
	gObjeù”
::
	$poŞ_İ_ÿnûl
(
ûph_tid_t
 
tid
, 
r
)

4145 
	`as£¹
(
š™Ÿlized
);

4147 
unique_lock
 
	`wl
(
rwlock
);

4149 
m­
<
ûph_tid_t
, 
PoŞOp
*>::
™”©Ü
 
™
 = 
poŞ_İs
.
	`fšd
(
tid
);

4150 ià(
™
 =ğ
poŞ_İs
.
	`’d
()) {

4151 
	`ldout
(
cù
, 10è<< 
__func__
 << "id " << 
tid
 << " dÃ" << 
d’dl
;

4152  -
ENOENT
;

4155 
	`ldout
(
cù
, 10è<< 
__func__
 << "id " << 
tid
 << 
d’dl
;

4157 
PoŞOp
 *
İ
 = 
™
->
£cÚd
;

4158 ià(
İ
->
Úfšish
)

4159 
İ
->
Úfšish
->
	`com¶‘e
(
r
);

4161 
	`_fšish_poŞ_İ
(
İ
, 
r
);

4163 
	}
}

4165 
	gObjeù”
::
	$_fšish_poŞ_İ
(
PoŞOp
 *
İ
, 
r
)

4168 
poŞ_İs
.
	`”a£
(
İ
->
tid
);

4169 
logg”
->
	`£t
(
l_osdc_poŞİ_aùive
, 
poŞ_İs
.
	`size
());

4171 ià(
İ
->
Útimeout
 && 
r
 !ğ-
ETIMEDOUT
) {

4172 
tim”
.
	`ÿnûl_ev’t
(
İ
->
Útimeout
);

4175 
d–‘e
 
İ
;

4176 
	}
}

4180 
	gObjeù”
::
g‘_poŞ_¡©s
(
li¡
<
¡ršg
>& 
poŞs
,

4181 
m­
<
¡ršg
,
poŞ_¡©_t
> *
»suÉ
,

4182 
CÚ‹xt
 *
Úfšish
)

4184 
ldout
(
cù
, 10è<< "g‘_poŞ_¡© " << 
	gpoŞs
 << 
	gd’dl
;

4186 
PoŞStOp
 *
	gİ
 = 
Ãw
 PoolStatOp;

4187 
	gİ
->
	gtid
 = ++
Ï¡_tid
;

4188 
	gİ
->
	gpoŞs
 = 
poŞs
;

4189 
	gİ
->
	gpoŞ_¡©s
 = 
»suÉ
;

4190 
	gİ
->
	gÚfšish
 = 
Úfšish
;

4191 ià(
	gmÚ_timeout
 > 
time¥ª
(0)) {

4192 
	gİ
->
	gÚtimeout
 = 
tim”
.
add_ev’t
(
mÚ_timeout
,

4193 [
this
, 
İ
]() {

4194 
poŞ_¡©_İ_ÿnûl
(
İ
->
tid
,

4195 -
ETIMEDOUT
); });

4197 
	gİ
->
	gÚtimeout
 = 0;

4200 
unique_lock
 
wl
(
rwlock
);

4202 
	gpoŞ¡©_İs
[
İ
->
tid
] = op;

4204 
	glogg”
->
£t
(
l_osdc_poŞ¡©_aùive
, 
poŞ¡©_İs
.
size
());

4206 
_poŞ¡©_subm™
(
İ
);

4209 
	gObjeù”
::
	$_poŞ¡©_subm™
(
PoŞStOp
 *
İ
)

4211 
	`ldout
(
cù
, 10è<< "_poŞ¡©_subm™ " << 
İ
->
tid
 << 
d’dl
;

4212 
mÚc
->
	`£nd_mÚ_mes§ge
(
Ãw
 
	`MG‘PoŞSts
(mÚc->
	`g‘_fsid
(), 
İ
->
tid
,

4213 
İ
->
poŞs
,

4214 
Ï¡_£’_pgm­_v”siÚ
));

4215 
İ
->
Ï¡_subm™
 = 
ûph
::
cßr£_mÚo_şock
::
	`now
();

4217 
logg”
->
	`šc
(
l_osdc_poŞ¡©_£nd
);

4218 
	}
}

4220 
	gObjeù”
::
	$hªdË_g‘_poŞ_¡©s_»¶y
(
MG‘PoŞStsR•ly
 *
m
)

4222 
	`ldout
(
cù
, 10è<< "hªdË_g‘_poŞ_¡©s_»¶y " << *
m
 << 
d’dl
;

4223 
ûph_tid_t
 
tid
 = 
m
->
	`g‘_tid
();

4225 
unique_lock
 
	`wl
(
rwlock
);

4226 ià(!
š™Ÿlized
) {

4227 
m
->
	`put
();

4231 
m­
<
ûph_tid_t
, 
PoŞStOp
 *>::
™”©Ü
 
™”
 = 
poŞ¡©_İs
.
	`fšd
(
tid
);

4232 ià(
™”
 !ğ
poŞ¡©_İs
.
	`’d
()) {

4233 
PoŞStOp
 *
İ
 = 
poŞ¡©_İs
[
tid
];

4234 
	`ldout
(
cù
, 10è<< "hav»que¡ " << 
tid
 << "‡ˆ" << 
İ
 << 
d’dl
;

4235 *
İ
->
poŞ_¡©s
 = 
m
->pool_stats;

4236 ià(
m
->
v”siÚ
 > 
Ï¡_£’_pgm­_v”siÚ
) {

4237 
Ï¡_£’_pgm­_v”siÚ
 = 
m
->
v”siÚ
;

4239 
İ
->
Úfšish
->
	`com¶‘e
(0);

4240 
	`_fšish_poŞ_¡©_İ
(
İ
, 0);

4242 
	`ldout
(
cù
, 10è<< "unknowÀ»que¡ " << 
tid
 << 
d’dl
;

4244 
	`ldout
(
cù
, 10è<< "dÚe" << 
d’dl
;

4245 
m
->
	`put
();

4246 
	}
}

4248 
	gObjeù”
::
	$poŞ_¡©_İ_ÿnûl
(
ûph_tid_t
 
tid
, 
r
)

4250 
	`as£¹
(
š™Ÿlized
);

4252 
unique_lock
 
	`wl
(
rwlock
);

4254 
m­
<
ûph_tid_t
, 
PoŞStOp
*>::
™”©Ü
 
™
 = 
poŞ¡©_İs
.
	`fšd
(
tid
);

4255 ià(
™
 =ğ
poŞ¡©_İs
.
	`’d
()) {

4256 
	`ldout
(
cù
, 10è<< 
__func__
 << "id " << 
tid
 << " dÃ" << 
d’dl
;

4257  -
ENOENT
;

4260 
	`ldout
(
cù
, 10è<< 
__func__
 << "id " << 
tid
 << 
d’dl
;

4262 
PoŞStOp
 *
İ
 = 
™
->
£cÚd
;

4263 ià(
İ
->
Úfšish
)

4264 
İ
->
Úfšish
->
	`com¶‘e
(
r
);

4265 
	`_fšish_poŞ_¡©_İ
(
İ
, 
r
);

4267 
	}
}

4269 
	gObjeù”
::
	$_fšish_poŞ_¡©_İ
(
PoŞStOp
 *
İ
, 
r
)

4273 
poŞ¡©_İs
.
	`”a£
(
İ
->
tid
);

4274 
logg”
->
	`£t
(
l_osdc_poŞ¡©_aùive
, 
poŞ¡©_İs
.
	`size
());

4276 ià(
İ
->
Útimeout
 && 
r
 !ğ-
ETIMEDOUT
)

4277 
tim”
.
	`ÿnûl_ev’t
(
İ
->
Útimeout
);

4279 
d–‘e
 
İ
;

4280 
	}
}

4282 
	gObjeù”
::
g‘_fs_¡©s
(
ûph_¡©fs
& 
»suÉ
,

4283 
boo¡
::
İtiÚ®
<
št64_t
> 
d©a_poŞ
,

4284 
CÚ‹xt
 *
Úfšish
)

4286 
ldout
(
cù
, 10è<< "g‘_fs_¡©s" << 
	gd’dl
;

4287 
unique_lock
 
l
(
rwlock
);

4289 
StfsOp
 *
	gİ
 = 
Ãw
 StatfsOp;

4290 
	gİ
->
	gtid
 = ++
Ï¡_tid
;

4291 
	gİ
->
	g¡©s
 = &
»suÉ
;

4292 
	gİ
->
	gd©a_poŞ
 = 
d©a_poŞ
;

4293 
	gİ
->
	gÚfšish
 = 
Úfšish
;

4294 ià(
	gmÚ_timeout
 > 
time¥ª
(0)) {

4295 
	gİ
->
	gÚtimeout
 = 
tim”
.
add_ev’t
(
mÚ_timeout
,

4296 [
this
, 
İ
]() {

4297 
¡©fs_İ_ÿnûl
(
İ
->
tid
,

4298 -
ETIMEDOUT
); });

4300 
	gİ
->
	gÚtimeout
 = 0;

4302 
	g¡©fs_İs
[
İ
->
tid
] = op;

4304 
	glogg”
->
£t
(
l_osdc_¡©fs_aùive
, 
¡©fs_İs
.
size
());

4306 
_fs_¡©s_subm™
(
İ
);

4309 
	gObjeù”
::
	$_fs_¡©s_subm™
(
StfsOp
 *
İ
)

4313 
	`ldout
(
cù
, 10è<< "fs_¡©s_subm™" << 
İ
->
tid
 << 
d’dl
;

4314 
mÚc
->
	`£nd_mÚ_mes§ge
(
Ãw
 
	`MStfs
(mÚc->
	`g‘_fsid
(), 
İ
->
tid
,

4315 
İ
->
d©a_poŞ
,

4316 
Ï¡_£’_pgm­_v”siÚ
));

4317 
İ
->
Ï¡_subm™
 = 
ûph
::
cßr£_mÚo_şock
::
	`now
();

4319 
logg”
->
	`šc
(
l_osdc_¡©fs_£nd
);

4320 
	}
}

4322 
	gObjeù”
::
	$hªdË_fs_¡©s_»¶y
(
MStfsR•ly
 *
m
)

4324 
unique_lock
 
	`wl
(
rwlock
);

4325 ià(!
š™Ÿlized
) {

4326 
m
->
	`put
();

4330 
	`ldout
(
cù
, 10è<< "hªdË_fs_¡©s_»¶y " << *
m
 << 
d’dl
;

4331 
ûph_tid_t
 
tid
 = 
m
->
	`g‘_tid
();

4333 ià(
¡©fs_İs
.
	`couÁ
(
tid
)) {

4334 
StfsOp
 *
İ
 = 
¡©fs_İs
[
tid
];

4335 
	`ldout
(
cù
, 10è<< "hav»que¡ " << 
tid
 << "‡ˆ" << 
İ
 << 
d’dl
;

4336 *(
İ
->
¡©s
èğ
m
->
h
.
¡
;

4337 ià(
m
->
h
.
v”siÚ
 > 
Ï¡_£’_pgm­_v”siÚ
)

4338 
Ï¡_£’_pgm­_v”siÚ
 = 
m
->
h
.
v”siÚ
;

4339 
İ
->
Úfšish
->
	`com¶‘e
(0);

4340 
	`_fšish_¡©fs_İ
(
İ
, 0);

4342 
	`ldout
(
cù
, 10è<< "unknowÀ»que¡ " << 
tid
 << 
d’dl
;

4344 
m
->
	`put
();

4345 
	`ldout
(
cù
, 10è<< "dÚe" << 
d’dl
;

4346 
	}
}

4348 
	gObjeù”
::
	$¡©fs_İ_ÿnûl
(
ûph_tid_t
 
tid
, 
r
)

4350 
	`as£¹
(
š™Ÿlized
);

4352 
unique_lock
 
	`wl
(
rwlock
);

4354 
m­
<
ûph_tid_t
, 
StfsOp
*>::
™”©Ü
 
™
 = 
¡©fs_İs
.
	`fšd
(
tid
);

4355 ià(
™
 =ğ
¡©fs_İs
.
	`’d
()) {

4356 
	`ldout
(
cù
, 10è<< 
__func__
 << "id " << 
tid
 << " dÃ" << 
d’dl
;

4357  -
ENOENT
;

4360 
	`ldout
(
cù
, 10è<< 
__func__
 << "id " << 
tid
 << 
d’dl
;

4362 
StfsOp
 *
İ
 = 
™
->
£cÚd
;

4363 ià(
İ
->
Úfšish
)

4364 
İ
->
Úfšish
->
	`com¶‘e
(
r
);

4365 
	`_fšish_¡©fs_İ
(
İ
, 
r
);

4367 
	}
}

4369 
	gObjeù”
::
	$_fšish_¡©fs_İ
(
StfsOp
 *
İ
, 
r
)

4373 
¡©fs_İs
.
	`”a£
(
İ
->
tid
);

4374 
logg”
->
	`£t
(
l_osdc_¡©fs_aùive
, 
¡©fs_İs
.
	`size
());

4376 ià(
İ
->
Útimeout
 && 
r
 !ğ-
ETIMEDOUT
)

4377 
tim”
.
	`ÿnûl_ev’t
(
İ
->
Útimeout
);

4379 
d–‘e
 
İ
;

4380 
	}
}

4384 
	gObjeù”
::
_sg_»ad_fšish
(
veùÜ
<
ObjeùEx‹Á
>& 
ex‹Ás
,

4385 
veùÜ
<
bufã¾i¡
>& 
»suÉbl
,

4386 
bufã¾i¡
 *
bl
, 
CÚ‹xt
 *
Úfšish
)

4389 
ldout
(
cù
, 15è<< "_sg_»ad_fšish" << 
	gd’dl
;

4391 ià(
	gex‹Ás
.
size
() > 1) {

4392 
	gSŒ”
::
SŒedR—dResuÉ
 
r
;

4393 
	gveùÜ
<
	gbufã¾i¡
>::
™”©Ü
 
b™
 = 
»suÉbl
.
begš
();

4394 
	gveùÜ
<
	gObjeùEx‹Á
>::
™”©Ü
 
e™
 = 
ex‹Ás
.
begš
();

4395 
	ge™
 !ğ
ex‹Ás
.
’d
();

4396 ++
	ge™
, ++
	gb™
) {

4397 
	gr
.
add_·¹Ÿl_»suÉ
(
cù
, *
b™
, 
e™
->
bufãr_ex‹Ás
);

4399 
	gbl
->
ş—r
();

4400 
	gr
.
as£mbË_»suÉ
(
cù
, *
bl
, 
çl£
);

4402 
ldout
(
cù
, 15è<< " oÆy oÃ f¿g" << 
	gd’dl
;

4403 
	gbl
->
şaim
(
»suÉbl
[0]);

4407 
ušt64_t
 
	gby‹s_»ad
 = 
bl
->
Ëngth
();

4408 
ldout
(
cù
, 7è<< "_sg_»ad_fšish " << 
	gby‹s_»ad
 << " by‹s" << 
	gd’dl
;

4410 ià(
	gÚfšish
) {

4411 
	gÚfšish
->
com¶‘e
(
by‹s_»ad
);

4416 
	gObjeù”
::
	$ms_hªdË_cÚÃù
(
CÚÃùiÚ
 *
cÚ
)

4418 
	`ldout
(
cù
, 10è<< "ms_hªdË_cÚÃù " << 
cÚ
 << 
d’dl
;

4419 ià(!
š™Ÿlized
)

4422 ià(
cÚ
->
	`g‘_³”_ty³
(è=ğ
CEPH_ENTITY_TYPE_MON
)

4423 
	`»£nd_mÚ_İs
();

4424 
	}
}

4426 
boŞ
 
	gObjeù”
::
	$ms_hªdË_»£t
(
CÚÃùiÚ
 *
cÚ
)

4428 ià(!
š™Ÿlized
)

4429  
çl£
;

4430 ià(
cÚ
->
	`g‘_³”_ty³
(è=ğ
CEPH_ENTITY_TYPE_OSD
) {

4431 
OSDSessiÚ
 *
£ssiÚ
 = 
¡©ic_ÿ¡
<OSDSessiÚ*>(
cÚ
->
	`g‘_´iv
());

4432 ià(
£ssiÚ
) {

4433 
	`ldout
(
cù
, 1è<< "ms_hªdË_»£ˆ" << 
cÚ
 << " sessiÚ " << 
£ssiÚ


4434 << " osd." << 
£ssiÚ
->
osd
 << 
d’dl
;

4435 
unique_lock
 
	`wl
(
rwlock
);

4436 ià(!
š™Ÿlized
) {

4437 
wl
.
	`uÆock
();

4438  
çl£
;

4440 
m­
<
ušt64_t
, 
Lšg”Op
 *> 
Ìe£nd
;

4441 
OSDSessiÚ
::
unique_lock
 
	`¦
(
£ssiÚ
->
lock
);

4442 
	`_»İ’_£ssiÚ
(
£ssiÚ
);

4443 
	`_kick_»que¡s
(
£ssiÚ
, 
Ìe£nd
);

4444 
¦
.
	`uÆock
();

4445 
	`_lšg”_İs_»£nd
(
Ìe£nd
, 
wl
);

4446 
wl
.
	`uÆock
();

4447 
	`maybe_»que¡_m­
();

4448 
£ssiÚ
->
	`put
();

4450  
Œue
;

4452  
çl£
;

4453 
	}
}

4455 
	gObjeù”
::
	$ms_hªdË_»mÙe_»£t
(
CÚÃùiÚ
 *
cÚ
)

4460 
	`ms_hªdË_»£t
(
cÚ
);

4461 
	}
}

4463 
boŞ
 
	gObjeù”
::
	$ms_hªdË_»fu£d
(
CÚÃùiÚ
 *
cÚ
)

4466 ià(
osdm­
 && (
cÚ
->
	`g‘_³”_ty³
(è=ğ
CEPH_ENTITY_TYPE_OSD
)) {

4467 
osd
 = 
osdm­
->
	`id’tify_osd
(
cÚ
->
	`g‘_³”_addr
());

4468 ià(
osd
 >= 0) {

4469 
	`ldout
(
cù
, 1è<< "ms_hªdË_»fu£d oÀosd." << 
osd
 << 
d’dl
;

4472  
çl£
;

4473 
	}
}

4475 
boŞ
 
	gObjeù”
::
	$ms_g‘_authÜiz”
(
de¡_ty³
,

4476 
AuthAuthÜiz”
 **
authÜiz”
,

4477 
boŞ
 
fÜû_Ãw
)

4479 ià(!
š™Ÿlized
)

4480  
çl£
;

4481 ià(
de¡_ty³
 =ğ
CEPH_ENTITY_TYPE_MON
)

4482  
Œue
;

4483 *
authÜiz”
 = 
mÚc
->
	`bud_authÜiz”
(
de¡_ty³
);

4484  *
authÜiz”
 !ğ
NULL
;

4485 
	}
}

4487 
	gObjeù”
::
İ_rg‘_t
::
	$dump
(
FÜm©‹r
 *
f
) const

4489 
f
->
	`dump_¡»am
("pg"è<< 
pgid
;

4490 
f
->
	`dump_št
("osd", 
osd
);

4491 
f
->
	`dump_¡»am
("objeù_id"è<< 
ba£_oid
;

4492 
f
->
	`dump_¡»am
("objeù_loÿtÜ"è<< 
ba£_Şoc
;

4493 
f
->
	`dump_¡»am
("rg‘_objeù_id"è<< 
rg‘_oid
;

4494 
f
->
	`dump_¡»am
("rg‘_objeù_loÿtÜ"è<< 
rg‘_Şoc
;

4495 
f
->
	`dump_št
("·u£d", ()
·u£d
);

4496 
f
->
	`dump_št
("u£d_»¶iÿ", ()
u£d_»¶iÿ
);

4497 
f
->
	`dump_št
("´eÿlc_pgid", ()
´eÿlc_pgid
);

4498 
	}
}

4500 
	gObjeù”
::
	$_dump_aùive
(
OSDSessiÚ
 *
s
)

4502 
m­
<
ûph_tid_t
,
Op
*>::
™”©Ü
 
p
 = 
s
->
İs
.
	`begš
();

4503 
p
 !ğ
s
->
İs
.
	`’d
();

4504 ++
p
) {

4505 
Op
 *
İ
 = 
p
->
£cÚd
;

4506 
	`ldout
(
cù
, 20è<< 
İ
->
tid
 << "\t" << op->
rg‘
.
pgid


4507 << "\tosd." << (
İ
->
£ssiÚ
 ? op->£ssiÚ->
osd
 : -1)

4508 << "\t" << 
İ
->
rg‘
.
ba£_oid


4509 << "\t" << 
İ
->
İs
 << 
d’dl
;

4511 
	}
}

4513 
	gObjeù”
::
	$_dump_aùive
()

4515 
	`ldout
(
cù
, 20è<< "dump_aùiv.. " << 
num_hom–ess_İs
 << " homeless"

4516 << 
d’dl
;

4517 
m­
<, 
OSDSessiÚ
 *>::
™”©Ü
 
s™”
 = 
osd_£ssiÚs
.
	`begš
();

4518 
s™”
 !ğ
osd_£ssiÚs
.
	`’d
(); ++siter) {

4519 
OSDSessiÚ
 *
s
 = 
s™”
->
£cÚd
;

4520 
OSDSessiÚ
::
sh¬ed_lock
 
	`¦
(
s
->
lock
);

4521 
	`_dump_aùive
(
s
);

4522 
¦
.
	`uÆock
();

4524 
	`_dump_aùive
(
hom–ess_£ssiÚ
);

4525 
	}
}

4527 
	gObjeù”
::
	$dump_aùive
()

4529 
sh¬ed_lock
 
	`¾
(
rwlock
);

4530 
	`_dump_aùive
();

4531 
¾
.
	`uÆock
();

4532 
	}
}

4534 
	gObjeù”
::
	$dump_»que¡s
(
FÜm©‹r
 *
fmt
)

4537 
fmt
->
	`İ’_objeù_£ùiÚ
("requests");

4538 
	`dump_İs
(
fmt
);

4539 
	`dump_lšg”_İs
(
fmt
);

4540 
	`dump_poŞ_İs
(
fmt
);

4541 
	`dump_poŞ_¡©_İs
(
fmt
);

4542 
	`dump_¡©fs_İs
(
fmt
);

4543 
	`dump_commªd_İs
(
fmt
);

4544 
fmt
->
	`şo£_£ùiÚ
();

4545 
	}
}

4547 
	gObjeù”
::
	$_dump_İs
(cÚ¡ 
OSDSessiÚ
 *
s
, 
FÜm©‹r
 *
fmt
)

4549 
m­
<
ûph_tid_t
,
Op
*>::
cÚ¡_™”©Ü
 
p
 = 
s
->
İs
.
	`begš
();

4550 
p
 !ğ
s
->
İs
.
	`’d
();

4551 ++
p
) {

4552 
Op
 *
İ
 = 
p
->
£cÚd
;

4553 
fmt
->
	`İ’_objeù_£ùiÚ
("op");

4554 
fmt
->
	`dump_unsigÃd
("tid", 
İ
->
tid
);

4555 
İ
->
rg‘
.
	`dump
(
fmt
);

4556 
fmt
->
	`dump_¡»am
("Ï¡_£Á"è<< 
İ
->
¡amp
;

4557 
fmt
->
	`dump_št
("©‹m±s", 
İ
->
©‹m±s
);

4558 
fmt
->
	`dump_¡»am
("¢­id"è<< 
İ
->
¢­id
;

4559 
fmt
->
	`dump_¡»am
("¢­_cÚ‹xt"è<< 
İ
->
¢­c
;

4560 
fmt
->
	`dump_¡»am
("mtime"è<< 
İ
->
mtime
;

4562 
fmt
->
	`İ’_¬¿y_£ùiÚ
("osd_ops");

4563 
veùÜ
<
OSDOp
>::
cÚ¡_™”©Ü
 
™
 = 
İ
->
İs
.
	`begš
();

4564 
™
 !ğ
İ
->
İs
.
	`’d
();

4565 ++
™
) {

4566 
fmt
->
	`dump_¡»am
("osd_İ"è<< *
™
;

4568 
fmt
->
	`şo£_£ùiÚ
();

4570 
fmt
->
	`şo£_£ùiÚ
();

4572 
	}
}

4574 
	gObjeù”
::
	$dump_İs
(
FÜm©‹r
 *
fmt
)

4577 
fmt
->
	`İ’_¬¿y_£ùiÚ
("ops");

4578 
m­
<, 
OSDSessiÚ
 *>::
cÚ¡_™”©Ü
 
s™”
 = 
osd_£ssiÚs
.
	`begš
();

4579 
s™”
 !ğ
osd_£ssiÚs
.
	`’d
(); ++siter) {

4580 
OSDSessiÚ
 *
s
 = 
s™”
->
£cÚd
;

4581 
OSDSessiÚ
::
sh¬ed_lock
 
	`¦
(
s
->
lock
);

4582 
	`_dump_İs
(
s
, 
fmt
);

4583 
¦
.
	`uÆock
();

4585 
	`_dump_İs
(
hom–ess_£ssiÚ
, 
fmt
);

4586 
fmt
->
	`şo£_£ùiÚ
();

4587 
	}
}

4589 
	gObjeù”
::
	$_dump_lšg”_İs
(cÚ¡ 
OSDSessiÚ
 *
s
, 
FÜm©‹r
 *
fmt
)

4591 
m­
<
ušt64_t
, 
Lšg”Op
*>::
cÚ¡_™”©Ü
 
p
 = 
s
->
lšg”_İs
.
	`begš
();

4592 
p
 !ğ
s
->
lšg”_İs
.
	`’d
();

4593 ++
p
) {

4594 
Lšg”Op
 *
İ
 = 
p
->
£cÚd
;

4595 
fmt
->
	`İ’_objeù_£ùiÚ
("linger_op");

4596 
fmt
->
	`dump_unsigÃd
("lšg”_id", 
İ
->
lšg”_id
);

4597 
İ
->
rg‘
.
	`dump
(
fmt
);

4598 
fmt
->
	`dump_¡»am
("¢­id"è<< 
İ
->
¢­
;

4599 
fmt
->
	`dump_¡»am
("»gi¡”ed"è<< 
İ
->
»gi¡”ed
;

4600 
fmt
->
	`şo£_£ùiÚ
();

4602 
	}
}

4604 
	gObjeù”
::
	$dump_lšg”_İs
(
FÜm©‹r
 *
fmt
)

4607 
fmt
->
	`İ’_¬¿y_£ùiÚ
("linger_ops");

4608 
m­
<, 
OSDSessiÚ
 *>::
cÚ¡_™”©Ü
 
s™”
 = 
osd_£ssiÚs
.
	`begš
();

4609 
s™”
 !ğ
osd_£ssiÚs
.
	`’d
(); ++siter) {

4610 
OSDSessiÚ
 *
s
 = 
s™”
->
£cÚd
;

4611 
OSDSessiÚ
::
sh¬ed_lock
 
	`¦
(
s
->
lock
);

4612 
	`_dump_lšg”_İs
(
s
, 
fmt
);

4613 
¦
.
	`uÆock
();

4615 
	`_dump_lšg”_İs
(
hom–ess_£ssiÚ
, 
fmt
);

4616 
fmt
->
	`şo£_£ùiÚ
();

4617 
	}
}

4619 
	gObjeù”
::
	$_dump_commªd_İs
(cÚ¡ 
OSDSessiÚ
 *
s
, 
FÜm©‹r
 *
fmt
)

4621 
m­
<
ušt64_t
, 
CommªdOp
*>::
cÚ¡_™”©Ü
 
p
 = 
s
->
commªd_İs
.
	`begš
();

4622 
p
 !ğ
s
->
commªd_İs
.
	`’d
();

4623 ++
p
) {

4624 
CommªdOp
 *
İ
 = 
p
->
£cÚd
;

4625 
fmt
->
	`İ’_objeù_£ùiÚ
("command_op");

4626 
fmt
->
	`dump_unsigÃd
("commªd_id", 
İ
->
tid
);

4627 
fmt
->
	`dump_št
("osd", 
İ
->
£ssiÚ
 ? op->£ssiÚ->
osd
 : -1);

4628 
fmt
->
	`İ’_¬¿y_£ùiÚ
("command");

4629 
veùÜ
<
¡ršg
>::
cÚ¡_™”©Ü
 
q
 = 
İ
->
cmd
.
	`begš
();

4630 
q
 !ğ
İ
->
cmd
.
	`’d
(); ++q)

4631 
fmt
->
	`dump_¡ršg
("wÜd", *
q
);

4632 
fmt
->
	`şo£_£ùiÚ
();

4633 ià(
İ
->
rg‘_osd
 >= 0)

4634 
fmt
->
	`dump_št
("rg‘_osd", 
İ
->
rg‘_osd
);

4636 
fmt
->
	`dump_¡»am
("rg‘_pg"è<< 
İ
->
rg‘_pg
;

4637 
fmt
->
	`şo£_£ùiÚ
();

4639 
	}
}

4641 
	gObjeù”
::
	$dump_commªd_İs
(
FÜm©‹r
 *
fmt
)

4644 
fmt
->
	`İ’_¬¿y_£ùiÚ
("command_ops");

4645 
m­
<, 
OSDSessiÚ
 *>::
cÚ¡_™”©Ü
 
s™”
 = 
osd_£ssiÚs
.
	`begš
();

4646 
s™”
 !ğ
osd_£ssiÚs
.
	`’d
(); ++siter) {

4647 
OSDSessiÚ
 *
s
 = 
s™”
->
£cÚd
;

4648 
OSDSessiÚ
::
sh¬ed_lock
 
	`¦
(
s
->
lock
);

4649 
	`_dump_commªd_İs
(
s
, 
fmt
);

4650 
¦
.
	`uÆock
();

4652 
	`_dump_commªd_İs
(
hom–ess_£ssiÚ
, 
fmt
);

4653 
fmt
->
	`şo£_£ùiÚ
();

4654 
	}
}

4656 
	gObjeù”
::
	$dump_poŞ_İs
(
FÜm©‹r
 *
fmt
) const

4658 
fmt
->
	`İ’_¬¿y_£ùiÚ
("pool_ops");

4659 
m­
<
ûph_tid_t
, 
PoŞOp
*>::
cÚ¡_™”©Ü
 
p
 = 
poŞ_İs
.
	`begš
();

4660 
p
 !ğ
poŞ_İs
.
	`’d
();

4661 ++
p
) {

4662 
PoŞOp
 *
İ
 = 
p
->
£cÚd
;

4663 
fmt
->
	`İ’_objeù_£ùiÚ
("pool_op");

4664 
fmt
->
	`dump_unsigÃd
("tid", 
İ
->
tid
);

4665 
fmt
->
	`dump_št
("poŞ", 
İ
->
poŞ
);

4666 
fmt
->
	`dump_¡ršg
("Çme", 
İ
->
Çme
);

4667 
fmt
->
	`dump_št
("İ”©iÚ_ty³", 
İ
->
poŞ_İ
);

4668 
fmt
->
	`dump_unsigÃd
("auid", 
İ
->
auid
);

4669 
fmt
->
	`dump_unsigÃd
("üush_ruË", 
İ
->
üush_ruË
);

4670 
fmt
->
	`dump_¡»am
("¢­id"è<< 
İ
->
¢­id
;

4671 
fmt
->
	`dump_¡»am
("Ï¡_£Á"è<< 
İ
->
Ï¡_subm™
;

4672 
fmt
->
	`şo£_£ùiÚ
();

4674 
fmt
->
	`şo£_£ùiÚ
();

4675 
	}
}

4677 
	gObjeù”
::
	$dump_poŞ_¡©_İs
(
FÜm©‹r
 *
fmt
) const

4679 
fmt
->
	`İ’_¬¿y_£ùiÚ
("pool_stat_ops");

4680 
m­
<
ûph_tid_t
, 
PoŞStOp
*>::
cÚ¡_™”©Ü
 
p
 = 
poŞ¡©_İs
.
	`begš
();

4681 
p
 !ğ
poŞ¡©_İs
.
	`’d
();

4682 ++
p
) {

4683 
PoŞStOp
 *
İ
 = 
p
->
£cÚd
;

4684 
fmt
->
	`İ’_objeù_£ùiÚ
("pool_stat_op");

4685 
fmt
->
	`dump_unsigÃd
("tid", 
İ
->
tid
);

4686 
fmt
->
	`dump_¡»am
("Ï¡_£Á"è<< 
İ
->
Ï¡_subm™
;

4688 
fmt
->
	`İ’_¬¿y_£ùiÚ
("pools");

4689 
li¡
<
¡ršg
>::
cÚ¡_™”©Ü
 
™
 = 
İ
->
poŞs
.
	`begš
();

4690 
™
 !ğ
İ
->
poŞs
.
	`’d
();

4691 ++
™
) {

4692 
fmt
->
	`dump_¡ršg
("poŞ", *
™
);

4694 
fmt
->
	`şo£_£ùiÚ
();

4696 
fmt
->
	`şo£_£ùiÚ
();

4698 
fmt
->
	`şo£_£ùiÚ
();

4699 
	}
}

4701 
	gObjeù”
::
	$dump_¡©fs_İs
(
FÜm©‹r
 *
fmt
) const

4703 
fmt
->
	`İ’_¬¿y_£ùiÚ
("statfs_ops");

4704 
m­
<
ûph_tid_t
, 
StfsOp
*>::
cÚ¡_™”©Ü
 
p
 = 
¡©fs_İs
.
	`begš
();

4705 
p
 !ğ
¡©fs_İs
.
	`’d
();

4706 ++
p
) {

4707 
StfsOp
 *
İ
 = 
p
->
£cÚd
;

4708 
fmt
->
	`İ’_objeù_£ùiÚ
("statfs_op");

4709 
fmt
->
	`dump_unsigÃd
("tid", 
İ
->
tid
);

4710 
fmt
->
	`dump_¡»am
("Ï¡_£Á"è<< 
İ
->
Ï¡_subm™
;

4711 
fmt
->
	`şo£_£ùiÚ
();

4713 
fmt
->
	`şo£_£ùiÚ
();

4714 
	}
}

4716 
	gObjeù”
::
Reque¡S‹Hook
::
	$Reque¡S‹Hook
(
Objeù”
 *
objeù”
) :

4717 
	$m_objeù”
(
objeù”
)

4719 
	}
}

4721 
boŞ
 
Objeù”
::
Reque¡S‹Hook
::
	$ÿÎ
(
¡d
::
¡ršg_v›w
 
commªd
,

4722 cÚ¡ 
cmdm­_t
& 
cmdm­
,

4723 
¡d
::
¡ršg_v›w
 
fÜm©
,

4724 
bufã¾i¡
& 
out
)

4726 
FÜm©‹r
 *
f
 = FÜm©‹r::
	`ü—‹
(
fÜm©
, "json-pretty", "json-pretty");

4727 
sh¬ed_lock
 
	`¾
(
m_objeù”
->
rwlock
);

4728 
m_objeù”
->
	`dump_»que¡s
(
f
);

4729 
f
->
	`æush
(
out
);

4730 
d–‘e
 
f
;

4731  
Œue
;

4732 
	}
}

4734 
	gObjeù”
::
	$bÏckli¡_£lf
(
boŞ
 
£t
)

4736 
	`ldout
(
cù
, 10è<< "bÏckli¡_£là" << (
£t
 ? "add" : "rm"è<< 
d’dl
;

4738 
veùÜ
<
¡ršg
> 
cmd
;

4739 
cmd
.
	`push_back
("{\"prefix\":\"osd blacklist\", ");

4740 ià(
£t
)

4741 
cmd
.
	`push_back
("\"blacklistop\":\"add\",");

4743 
cmd
.
	`push_back
("\"blacklistop\":\"rm\",");

4744 
¡ršg¡»am
 
ss
;

4745 
ss
 << 
mes£ng”
->
	`g‘_myaddr
();

4746 
cmd
.
	`push_back
("\"addr\":\"" + 
ss
.
	`¡r
() + "\"");

4748 
MMÚCommªd
 *
m
 = 
Ãw
 
	`MMÚCommªd
(
mÚc
->
	`g‘_fsid
());

4749 
m
->
cmd
 = cmd;

4751 
mÚc
->
	`£nd_mÚ_mes§ge
(
m
);

4752 
	}
}

4756 
	gObjeù”
::
	$hªdË_commªd_»¶y
(
MCommªdR•ly
 *
m
)

4758 
unique_lock
 
	`wl
(
rwlock
);

4759 ià(!
š™Ÿlized
) {

4760 
m
->
	`put
();

4764 
CÚÃùiÚRef
 
cÚ
 = 
m
->
	`g‘_cÚÃùiÚ
();

4765 
OSDSessiÚ
 *
s
 = 
¡©ic_ÿ¡
<OSDSessiÚ*>(
cÚ
->
	`g‘_´iv
());

4766 ià(!
s
 || s->
cÚ
 != con) {

4767 
	`ldout
(
cù
, 7è<< 
__func__
 << "‚Ø£ssiÚ oÀcÚ " << 
cÚ
 << 
d’dl
;

4768 
m
->
	`put
();

4769 ià(
s
)

4770 
s
->
	`put
();

4774 
OSDSessiÚ
::
sh¬ed_lock
 
	`¦
(
s
->
lock
);

4775 
m­
<
ûph_tid_t
,
CommªdOp
*>::
™”©Ü
 
p
 = 
s
->
commªd_İs
.
	`fšd
(
m
->
	`g‘_tid
());

4776 ià(
p
 =ğ
s
->
commªd_İs
.
	`’d
()) {

4777 
	`ldout
(
cù
, 10è<< "hªdË_commªd_»¶yid " << 
m
->
	`g‘_tid
()

4778 << "‚Ù found" << 
d’dl
;

4779 
m
->
	`put
();

4780 
¦
.
	`uÆock
();

4781 
s
->
	`put
();

4785 
CommªdOp
 *
c
 = 
p
->
£cÚd
;

4786 ià(!
c
->
£ssiÚ
 ||

4787 
m
->
	`g‘_cÚÃùiÚ
(è!ğ
c
->
£ssiÚ
->
cÚ
) {

4788 
	`ldout
(
cù
, 10è<< "hªdË_commªd_»¶yid " << 
m
->
	`g‘_tid
()

4790 << 
m
->
	`g‘_cÚÃùiÚ
(è<< " " << m->
	`g‘_sourû_š¡
()

4791 << 
d’dl
;

4792 
m
->
	`put
();

4793 
¦
.
	`uÆock
();

4794 
s
->
	`put
();

4797 ià(
c
->
poutbl
) {

4798 
c
->
poutbl
->
	`şaim
(
m
->
	`g‘_d©a
());

4801 
¦
.
	`uÆock
();

4803 
OSDSessiÚ
::
unique_lock
 
	`sul
(
s
->
lock
);

4804 
	`_fšish_commªd
(
c
, 
m
->
r
, m->
rs
);

4805 
sul
.
	`uÆock
();

4807 
m
->
	`put
();

4808 
s
->
	`put
();

4809 
	}
}

4811 
	gObjeù”
::
	$subm™_commªd
(
CommªdOp
 *
c
, 
ûph_tid_t
 *
±id
)

4813 
shunique_lock
 
	`sul
(
rwlock
, 
ûph
::
acquœe_unique
);

4815 
ûph_tid_t
 
tid
 = ++
Ï¡_tid
;

4816 
	`ldout
(
cù
, 10è<< "_subm™_commªd " << 
tid
 << " " << 
c
->
cmd
 << 
d’dl
;

4817 
c
->
tid
 =id;

4820 
OSDSessiÚ
::
unique_lock
 
	`hs_wl
(
hom–ess_£ssiÚ
->
lock
);

4821 
	`_£ssiÚ_commªd_İ_assign
(
hom–ess_£ssiÚ
, 
c
);

4824 
	`_ÿlc_commªd_rg‘
(
c
, 
sul
);

4825 
	`_assign_commªd_£ssiÚ
(
c
, 
sul
);

4826 ià(
osd_timeout
 > 
	`time¥ª
(0)) {

4827 
c
->
Útimeout
 = 
tim”
.
	`add_ev’t
(
osd_timeout
,

4828 [
this
, 
c
, 
tid
]() {

4829 
	`commªd_İ_ÿnûl
(
c
->
£ssiÚ
, 
tid
,

4830 -
ETIMEDOUT
); });

4833 ià(!
c
->
£ssiÚ
->
	`is_hom–ess
()) {

4834 
	`_£nd_commªd
(
c
);

4836 
	`_maybe_»que¡_m­
();

4838 ià(
c
->
m­_check_”rÜ
)

4839 
	`_£nd_commªd_m­_check
(
c
);

4840 *
±id
 = 
tid
;

4842 
logg”
->
	`šc
(
l_osdc_commªd_aùive
);

4843 
	}
}

4845 
	gObjeù”
::
	$_ÿlc_commªd_rg‘
(
CommªdOp
 *
c
, 
shunique_lock
& 
sul
)

4847 
	`as£¹
(
sul
.
	`owns_lock
(è&& sul.
	`mu‹x
(è=ğ&
rwlock
);

4849 
c
->
m­_check_”rÜ
 = 0;

4852 
c
->
rg‘
.
æags
 |ğ
CEPH_OSD_FLAG_IGNORE_OVERLAY
;

4854 ià(
c
->
rg‘_osd
 >= 0) {

4855 ià(!
osdm­
->
	`exi¡s
(
c
->
rg‘_osd
)) {

4856 
c
->
m­_check_”rÜ
 = -
ENOENT
;

4857 
c
->
m­_check_”rÜ_¡r
 = "osd dne";

4858 
c
->
rg‘
.
osd
 = -1;

4859  
RECALC_OP_TARGET_OSD_DNE
;

4861 ià(
osdm­
->
	`is_down
(
c
->
rg‘_osd
)) {

4862 
c
->
m­_check_”rÜ
 = -
ENXIO
;

4863 
c
->
m­_check_”rÜ_¡r
 = "osd down";

4864 
c
->
rg‘
.
osd
 = -1;

4865  
RECALC_OP_TARGET_OSD_DOWN
;

4867 
c
->
rg‘
.
osd
 = c->
rg‘_osd
;

4869 
»t
 = 
	`_ÿlc_rg‘
(&(
c
->
rg‘
), 
nuÎ±r
, 
Œue
);

4870 ià(
»t
 =ğ
RECALC_OP_TARGET_POOL_DNE
) {

4871 
c
->
m­_check_”rÜ
 = -
ENOENT
;

4872 
c
->
m­_check_”rÜ_¡r
 = "pool dne";

4873 
c
->
rg‘
.
osd
 = -1;

4874  
»t
;

4875 } ià(
»t
 =ğ
RECALC_OP_TARGET_OSD_DOWN
) {

4876 
c
->
m­_check_”rÜ
 = -
ENXIO
;

4877 
c
->
m­_check_”rÜ_¡r
 = "osd down";

4878 
c
->
rg‘
.
osd
 = -1;

4879  
»t
;

4883 
OSDSessiÚ
 *
s
;

4884 
r
 = 
	`_g‘_£ssiÚ
(
c
->
rg‘
.
osd
, &
s
, 
sul
);

4885 
	`as£¹
(
r
 !ğ-
EAGAIN
);

4887 ià(
c
->
£ssiÚ
 !ğ
s
) {

4888 
	`put_£ssiÚ
(
s
);

4889  
RECALC_OP_TARGET_NEED_RESEND
;

4892 
	`put_£ssiÚ
(
s
);

4894 
	`ldout
(
cù
, 20è<< "_»ÿlc_commªd_rg‘ " << 
c
->
tid
 << "‚o change, "

4895 << 
c
->
£ssiÚ
 << 
d’dl
;

4897  
RECALC_OP_TARGET_NO_ACTION
;

4898 
	}
}

4900 
	gObjeù”
::
	$_assign_commªd_£ssiÚ
(
CommªdOp
 *
c
,

4901 
shunique_lock
& 
sul
)

4903 
	`as£¹
(
sul
.
	`owns_lock
(è&& sul.
	`mu‹x
(è=ğ&
rwlock
);

4905 
OSDSessiÚ
 *
s
;

4906 
r
 = 
	`_g‘_£ssiÚ
(
c
->
rg‘
.
osd
, &
s
, 
sul
);

4907 
	`as£¹
(
r
 !ğ-
EAGAIN
);

4909 ià(
c
->
£ssiÚ
 !ğ
s
) {

4910 ià(
c
->
£ssiÚ
) {

4911 
OSDSessiÚ
 *
cs
 = 
c
->
£ssiÚ
;

4912 
OSDSessiÚ
::
unique_lock
 
	`c¦
(
cs
->
lock
);

4913 
	`_£ssiÚ_commªd_İ_»move
(
c
->
£ssiÚ
, c);

4914 
c¦
.
	`uÆock
();

4916 
OSDSessiÚ
::
unique_lock
 
	`¦
(
s
->
lock
);

4917 
	`_£ssiÚ_commªd_İ_assign
(
s
, 
c
);

4920 
	`put_£ssiÚ
(
s
);

4921 
	}
}

4923 
	gObjeù”
::
	$_£nd_commªd
(
CommªdOp
 *
c
)

4925 
	`ldout
(
cù
, 10è<< "_£nd_commªd " << 
c
->
tid
 << 
d’dl
;

4926 
	`as£¹
(
c
->
£ssiÚ
);

4927 
	`as£¹
(
c
->
£ssiÚ
->
cÚ
);

4928 
MCommªd
 *
m
 = 
Ãw
 
	`MCommªd
(
mÚc
->
mÚm­
.
fsid
);

4929 
m
->
cmd
 = 
c
->cmd;

4930 
m
->
	`£t_d©a
(
c
->
šbl
);

4931 
m
->
	`£t_tid
(
c
->
tid
);

4932 
c
->
£ssiÚ
->
cÚ
->
	`£nd_mes§ge
(
m
);

4933 
logg”
->
	`šc
(
l_osdc_commªd_£nd
);

4934 
	}
}

4936 
	gObjeù”
::
	$commªd_İ_ÿnûl
(
OSDSessiÚ
 *
s
, 
ûph_tid_t
 
tid
, 
r
)

4938 
	`as£¹
(
š™Ÿlized
);

4940 
unique_lock
 
	`wl
(
rwlock
);

4942 
m­
<
ûph_tid_t
, 
CommªdOp
*>::
™”©Ü
 
™
 = 
s
->
commªd_İs
.
	`fšd
(
tid
);

4943 ià(
™
 =ğ
s
->
commªd_İs
.
	`’d
()) {

4944 
	`ldout
(
cù
, 10è<< 
__func__
 << "id " << 
tid
 << " dÃ" << 
d’dl
;

4945  -
ENOENT
;

4948 
	`ldout
(
cù
, 10è<< 
__func__
 << "id " << 
tid
 << 
d’dl
;

4950 
CommªdOp
 *
İ
 = 
™
->
£cÚd
;

4951 
	`_commªd_ÿnûl_m­_check
(
İ
);

4952 
OSDSessiÚ
::
unique_lock
 
	`¦
(
İ
->
£ssiÚ
->
lock
);

4953 
	`_fšish_commªd
(
İ
, 
r
, "");

4954 
¦
.
	`uÆock
();

4956 
	}
}

4958 
	gObjeù”
::
	$_fšish_commªd
(
CommªdOp
 *
c
, 
r
, 
¡ršg
 
rs
)

4963 
	`ldout
(
cù
, 10è<< "_fšish_commªd " << 
c
->
tid
 << " = " << 
r
 << " "

4964 << 
rs
 << 
d’dl
;

4965 ià(
c
->
´s
)

4966 *
c
->
´s
 = 
rs
;

4967 ià(
c
->
Úfšish
)

4968 
c
->
Úfšish
->
	`com¶‘e
(
r
);

4970 ià(
c
->
Útimeout
 && 
r
 !ğ-
ETIMEDOUT
)

4971 
tim”
.
	`ÿnûl_ev’t
(
c
->
Útimeout
);

4973 
	`_£ssiÚ_commªd_İ_»move
(
c
->
£ssiÚ
, c);

4975 
c
->
	`put
();

4977 
logg”
->
	`dec
(
l_osdc_commªd_aùive
);

4978 
	}
}

4980 
	gObjeù”
::
OSDSessiÚ
::~
	$OSDSessiÚ
()

4984 
	`as£¹
(
İs
.
	`em±y
());

4985 
	`as£¹
(
lšg”_İs
.
	`em±y
());

4986 
	`as£¹
(
commªd_İs
.
	`em±y
());

4987 
	}
}

4989 
	gObjeù”
::~
	$Objeù”
()

4991 
d–‘e
 
osdm­
;

4993 
	`as£¹
(
hom–ess_£ssiÚ
->
	`g‘_Äef
() == 1);

4994 
	`as£¹
(
num_hom–ess_İs
 == 0);

4995 
hom–ess_£ssiÚ
->
	`put
();

4997 
	`as£¹
(
osd_£ssiÚs
.
	`em±y
());

4998 
	`as£¹
(
poŞ¡©_İs
.
	`em±y
());

4999 
	`as£¹
(
¡©fs_İs
.
	`em±y
());

5000 
	`as£¹
(
poŞ_İs
.
	`em±y
());

5001 
	`as£¹
(
wa™šg_fÜ_m­
.
	`em±y
());

5002 
	`as£¹
(
lšg”_İs
.
	`em±y
());

5003 
	`as£¹
(
check_Ï‹¡_m­_lšg”s
.
	`em±y
());

5004 
	`as£¹
(
check_Ï‹¡_m­_İs
.
	`em±y
());

5005 
	`as£¹
(
check_Ï‹¡_m­_commªds
.
	`em±y
());

5007 
	`as£¹
(!
m_»que¡_¡©e_hook
);

5008 
	`as£¹
(!
logg”
);

5009 
	}
}

5018 
	gObjeù”
::
	$£t_•och_b¬r›r
(
•och_t
 
•och
)

5020 
unique_lock
 
	`wl
(
rwlock
);

5022 
	`ldout
(
cù
, 7è<< 
__func__
 << ": b¬r›¸" << 
•och
 << " (was "

5023 << 
•och_b¬r›r
 << "ècu¼’ˆ•och " << 
osdm­
->
	`g‘_•och
()

5024 << 
d’dl
;

5025 ià(
•och
 > 
•och_b¬r›r
) {

5026 
•och_b¬r›r
 = 
•och
;

5027 
	`_maybe_»que¡_m­
();

5029 
	}
}

5033 
hobjeù_t
 
	gObjeù”
::
	$’um”©e_objeùs_begš
()

5035  
	`hobjeù_t
();

5036 
	}
}

5038 
hobjeù_t
 
	gObjeù”
::
	$’um”©e_objeùs_’d
()

5040  
hobjeù_t
::
	`g‘_max
();

5041 
	}
}

5043 
	gC_Enum”©eR•ly
 : 
public
 
CÚ‹xt
 {

5044 
bufã¾i¡
 
bl
;

5046 
Objeù”
 *
	gobjeù”
;

5047 
hobjeù_t
 *
	gÃxt
;

5048 
	g¡d
::
li¡
<
lib¿dos
::
Li¡ObjeùIm¶
> *
»suÉ
;

5049 cÚ¡ 
hobjeù_t
 
	g’d
;

5050 cÚ¡ 
št64_t
 
	gpoŞ_id
;

5051 
CÚ‹xt
 *
	gÚ_fšish
;

5053 
•och_t
 
	g•och
;

5054 
	gbudg‘
;

5056 
C_Enum”©eR•ly
(
Objeù”
 *
objeù”_
, 
hobjeù_t
 *
Ãxt_
,

5057 
¡d
::
li¡
<
lib¿dos
::
Li¡ObjeùIm¶
> *
»suÉ_
,

5058 cÚ¡ 
hobjeù_t
 
’d_
, cÚ¡ 
št64_t
 
poŞ_id_
, 
CÚ‹xt
 *
Ú_fšish_
) :

5059 
objeù”
(
objeù”_
), 
Ãxt
(
Ãxt_
), 
»suÉ
(
»suÉ_
),

5060 
’d
(
’d_
), 
poŞ_id
(
poŞ_id_
), 
Ú_fšish
(
Ú_fšish_
),

5061 
•och
(0), 
budg‘
(0)

5064 
fšish
(
r
è
	gov”ride
 {

5065 
	gobjeù”
->
_’um”©e_»¶y
(

5066 
bl
, 
r
, 
’d
, 
poŞ_id
, 
budg‘
, 
•och
, 
»suÉ
, 
Ãxt
, 
Ú_fšish
);

5070 
	gObjeù”
::
’um”©e_objeùs
(

5071 
št64_t
 
poŞ_id
,

5072 cÚ¡ 
¡d
::
¡ršg
 &
ns
,

5073 cÚ¡ 
hobjeù_t
 &
¡¬t
,

5074 cÚ¡ 
hobjeù_t
 &
’d
,

5075 cÚ¡ 
ušt32_t
 
max
,

5076 cÚ¡ 
bufã¾i¡
 &
f‹r_bl
,

5077 
¡d
::
li¡
<
lib¿dos
::
Li¡ObjeùIm¶
> *
»suÉ
,

5078 
hobjeù_t
 *
Ãxt
,

5079 
CÚ‹xt
 *
Ú_fšish
)

5081 
as£¹
(
»suÉ
);

5083 ià(!
	g’d
.
is_max
(è&& 
	g¡¬t
 >ƒnd) {

5084 
ld”r
(
cù
è<< 
	g__func__
 << ": s¹ " << 
	g¡¬t
 << " >ƒnd " << 
	g’d
 << 
	gd’dl
;

5085 
	gÚ_fšish
->
com¶‘e
(-
EINVAL
);

5089 ià(
	gmax
 < 1) {

5090 
ld”r
(
cù
è<< 
	g__func__
 << ":„esuÉ sizmay‚Ù bz”o" << 
	gd’dl
;

5091 
	gÚ_fšish
->
com¶‘e
(-
EINVAL
);

5095 ià(
	g¡¬t
.
is_max
()) {

5096 
	gÚ_fšish
->
com¶‘e
(0);

5100 
sh¬ed_lock
 
¾
(
rwlock
);

5101 
as£¹
(
osdm­
->
g‘_•och
());

5102 ià(!
	gosdm­
->
‹¡_æag
(
CEPH_OSDMAP_SORTBITWISE
)) {

5103 
	g¾
.
uÆock
();

5104 
ld”r
(
cù
è<< 
	g__func__
 << ": SORTBITWISE clu¡” fÏg‚Ù s‘" << 
	gd’dl
;

5105 
	gÚ_fšish
->
com¶‘e
(-
EOPNOTSUPP
);

5108 cÚ¡ 
pg_poŞ_t
 *
	gp
 = 
osdm­
->
g‘_pg_poŞ
(
poŞ_id
);

5109 ià(!
	gp
) {

5110 
ld”r
(
cù
è<< 
	g__func__
 << ":…oŞ " << 
	gpoŞ_id
 << " DNE in osdƒpoch "

5111 << 
	gosdm­
->
g‘_•och
(è<< 
	gd’dl
;

5112 
	g¾
.
uÆock
();

5113 
	gÚ_fšish
->
com¶‘e
(-
ENOENT
);

5116 
	g¾
.
uÆock
();

5119 
ldout
(
cù
, 20è<< 
	g__func__
 << ": s¹=" << 
	g¡¬t
 << "ƒnd=" << 
	g’d
 << 
	gd’dl
;

5122 
C_Enum”©eR•ly
 *
	gÚ_ack
 = 
Ãw
 C_EnumerateReply(

5123 
this
, 
Ãxt
, 
»suÉ
, 
’d
, 
poŞ_id
, 
Ú_fšish
);

5125 
ObjeùO³¿tiÚ
 
	gİ
;

5126 
	gİ
.
pg_Æs
(
max
, 
f‹r_bl
, 
¡¬t
, 0);

5129 
objeù_loÿtÜ_t
 
Şoc
(
poŞ_id
, 
ns
);

5130 
pg_»ad
(
¡¬t
.
g‘_hash
(), 
Şoc
, 
İ
,

5131 &
Ú_ack
->
bl
, 0, on_ack, &Ú_ack->
•och
, &Ú_ack->
budg‘
);

5134 
	gObjeù”
::
_’um”©e_»¶y
(

5135 
bufã¾i¡
 &
bl
,

5136 
r
,

5137 cÚ¡ 
hobjeù_t
 &
’d
,

5138 cÚ¡ 
št64_t
 
poŞ_id
,

5139 
budg‘
,

5140 
•och_t
 
»¶y_•och
,

5141 
¡d
::
li¡
<
lib¿dos
::
Li¡ObjeùIm¶
> *
»suÉ
,

5142 
hobjeù_t
 *
Ãxt
,

5143 
CÚ‹xt
 *
Ú_fšish
)

5145 ià(
	gbudg‘
 > 0) {

5146 
put_İ_budg‘_by‹s
(
budg‘
);

5149 ià(
	gr
 < 0) {

5150 
ldout
(
cù
, 4è<< 
	g__func__
 << ":„emÙ”rÜ " << 
	gr
 << 
	gd’dl
;

5151 
	gÚ_fšish
->
com¶‘e
(
r
);

5155 
as£¹
(
Ãxt
 !ğ
NULL
);

5158 
	gbufã¾i¡
::
™”©Ü
 
™”
 = 
bl
.
begš
();

5159 
pg_Æs_»¥Ú£_t
 
	g»¥Ú£
;

5162 
bufã¾i¡
 
	gexŒa_šfo
;

5163 
decode
(
»¥Ú£
, 
™”
);

5164 ià(!
	g™”
.
’d
()) {

5165 
decode
(
exŒa_šfo
, 
™”
);

5168 
ldout
(
cù
, 10è<< 
	g__func__
 << ": gÙ " << 
	g»¥Ú£
.
	g’Œ›s
.
size
()

5169 << " hªdË " << 
	g»¥Ú£
.
	ghªdË


5170 << "„•ly_•och " << 
	g»¶y_•och
 << 
	gd’dl
;

5171 
ldout
(
cù
, 20è<< 
	g__func__
 << ":„esponse.entries.size "

5172 << 
	g»¥Ú£
.
	g’Œ›s
.
size
() << ",„esponse.entries "

5173 << 
	g»¥Ú£
.
	g’Œ›s
 << 
	gd’dl
;

5174 ià(
	g»¥Ú£
.
	ghªdË
 <ğ
’d
) {

5175 *
Ãxt
 = 
»¥Ú£
.
hªdË
;

5177 
ldout
(
cù
, 10è<< 
	g__func__
 << ":‡dju¡ed‚exˆdowÀtØ’d " << 
	g’d


5178 << 
	gd’dl
;

5179 *
	gÃxt
 = 
’d
;

5182 
sh¬ed_lock
 
¾
(
rwlock
);

5183 cÚ¡ 
pg_poŞ_t
 *
	gpoŞ
 = 
osdm­
->
g‘_pg_poŞ
(
poŞ_id
);

5184 ià(!
	gpoŞ
) {

5186 
	g¾
.
uÆock
();

5187 
	gÚ_fšish
->
com¶‘e
(-
ENOENT
);

5190 !
	g»¥Ú£
.
	g’Œ›s
.
em±y
()) {

5191 
ušt32_t
 
	ghash
 = 
»¥Ú£
.
’Œ›s
.
back
().
loÿtÜ
.
em±y
() ?

5192 
poŞ
->
hash_key
(
»¥Ú£
.
’Œ›s
.
back
().
oid
,

5193 
»¥Ú£
.
’Œ›s
.
back
().
n¥aû
) :

5194 
poŞ
->
hash_key
(
»¥Ú£
.
’Œ›s
.
back
().
loÿtÜ
,

5195 
»¥Ú£
.
’Œ›s
.
back
().
n¥aû
);

5196 
hobjeù_t
 
Ï¡
(
»¥Ú£
.
’Œ›s
.
back
().
oid
,

5197 
»¥Ú£
.
’Œ›s
.
back
().
loÿtÜ
,

5198 
CEPH_NOSNAP
,

5199 
hash
,

5200 
poŞ_id
,

5201 
»¥Ú£
.
’Œ›s
.
back
().
n¥aû
);

5202 ià(
	gÏ¡
 < 
	g’d
)

5204 
ldout
(
cù
, 20è<< 
	g__func__
 << " drİpšg i‹m " << 
	gÏ¡


5205 << " >ğ’d " << 
	g’d
 << 
	gd’dl
;

5206 
	g»¥Ú£
.
	g’Œ›s
.
pİ_back
();

5208 
	g¾
.
uÆock
();

5210 ià(!
	g»¥Ú£
.
	g’Œ›s
.
em±y
()) {

5211 
	g»suÉ
->
m”ge
(
»¥Ú£
.
’Œ›s
);

5217 
put_Æi¡_cÚ‹xt_budg‘
(
li¡_cÚ‹xt
);

5219 
	gÚ_fšish
->
com¶‘e
(
r
);

5223 
	gÇme¥aû
 {

5224 
usšg
 
Çme¥aû
 
	glib¿dos
;

5226 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

5227 
do_decode
(
¡d
::
veùÜ
<
T
>& 
™ems
, std::veùÜ<
bufã¾i¡
>& 
bls
)

5229 autØ
bl
 : 
bls
) {

5230 autØ
p
 = 
bl
.
begš
();

5231 
T
 
	gt
;

5232 
decode
(
t
, 
p
);

5233 
	g™ems
.
push_back
(
t
);

5237 
	gC_ObjeùO³¿tiÚ_süub_ls
 : 
public
 
CÚ‹xt
 {

5238 
bufã¾i¡
 
bl
;

5239 
ušt32_t
 *
	gš‹rv®
;

5240 
	g¡d
::
veùÜ
<
šcÚsi¡’t_obj_t
> *
objeùs
 = 
nuÎ±r
;

5241 
	g¡d
::
veùÜ
<
šcÚsi¡’t_¢­£t_t
> *
¢­£ts
 = 
nuÎ±r
;

5242 *
	grv®
;

5244 
C_ObjeùO³¿tiÚ_süub_ls
(
ušt32_t
 *
š‹rv®
,

5245 
¡d
::
veùÜ
<
šcÚsi¡’t_obj_t
> *
objeùs
,

5246 *
rv®
)

5247 : 
š‹rv®
(š‹rv®), 
objeùs
(objeùs), 
rv®
(rval) {}

5248 
C_ObjeùO³¿tiÚ_süub_ls
(
ušt32_t
 *
š‹rv®
,

5249 
¡d
::
veùÜ
<
šcÚsi¡’t_¢­£t_t
> *
¢­£ts
,

5250 *
rv®
)

5251 : 
š‹rv®
(š‹rv®), 
¢­£ts
(¢­£ts), 
rv®
(rval) {}

5252 
fšish
(
r
è
	gov”ride
 {

5253 ià(
	gr
 < 0 &&„ !ğ-
EAGAIN
) {

5254 ià(
rv®
)

5255 *
rv®
 = 
r
;

5259 ià(
	grv®
)

5260 *
	grv®
 = 0;

5262 
	gŒy
 {

5263 
decode
();

5264 } 
ÿtch
 (
bufãr
::
”rÜ
&) {

5265 ià(
rv®
)

5266 *
rv®
 = -
EIO
;

5269 
	g´iv©e
:

5270 
decode
() {

5271 
süub_ls_»suÉ_t
 
»suÉ
;

5272 autØ
	gp
 = 
bl
.
begš
();

5273 
	g»suÉ
.
decode
(
p
);

5274 *
	gš‹rv®
 = 
»suÉ
.
š‹rv®
;

5275 ià(
	gobjeùs
) {

5276 
do_decode
(*
objeùs
, 
»suÉ
.
v®s
);

5278 
do_decode
(*
¢­£ts
, 
»suÉ
.
v®s
);

5283 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

5284 
do_süub_ls
(::
ObjeùO³¿tiÚ
 *
İ
,

5285 cÚ¡ 
süub_ls_¬g_t
& 
¬g
,

5286 
¡d
::
veùÜ
<
T
> *
™ems
,

5287 
ušt32_t
 *
š‹rv®
,

5288 *
rv®
)

5290 
	gOSDOp
& 
	gosd_İ
 = 
İ
->
add_İ
(
CEPH_OSD_OP_SCRUBLS
);

5291 
	gİ
->
	gæags
 |ğ
CEPH_OSD_FLAG_PGOP
;

5292 
as£¹
(
š‹rv®
);

5293 
	g¬g
.
’code
(
osd_İ
.
šd©a
);

5294 
	gp
 = 
İ
->
İs
.
size
() - 1;

5295 autØ*
	gh
 = 
Ãw
 
C_ObjeùO³¿tiÚ_süub_ls
{
š‹rv®
, 
™ems
, 
rv®
};

5296 
	gİ
->
	gout_hªdËr
[
p
] = 
h
;

5297 
	gİ
->
	gout_bl
[
p
] = &
h
->
bl
;

5298 
	gİ
->
	gout_rv®
[
p
] = 
rv®
;

5302 ::
ObjeùO³¿tiÚ
::
süub_ls
(cÚ¡ 
lib¿dos
::
objeù_id_t
& 
¡¬t_aá”
,

5303 
ušt64_t
 
max_to_g‘
,

5304 
¡d
::
veùÜ
<
lib¿dos
::
šcÚsi¡’t_obj_t
> *
objeùs
,

5305 
ušt32_t
 *
š‹rv®
,

5306 *
rv®
)

5308 
süub_ls_¬g_t
 
	g¬g
 = {*
š‹rv®
, 0, 
¡¬t_aá”
, 
max_to_g‘
};

5309 
do_süub_ls
(
this
, 
¬g
, 
objeùs
, 
š‹rv®
, 
rv®
);

5312 ::
ObjeùO³¿tiÚ
::
süub_ls
(cÚ¡ 
lib¿dos
::
objeù_id_t
& 
¡¬t_aá”
,

5313 
ušt64_t
 
max_to_g‘
,

5314 
¡d
::
veùÜ
<
lib¿dos
::
šcÚsi¡’t_¢­£t_t
> *
¢­£ts
,

5315 
ušt32_t
 *
š‹rv®
,

5316 *
rv®
)

5318 
süub_ls_¬g_t
 
	g¬g
 = {*
š‹rv®
, 1, 
¡¬t_aá”
, 
max_to_g‘
};

5319 
do_süub_ls
(
this
, 
¬g
, 
¢­£ts
, 
š‹rv®
, 
rv®
);

	@osdc/Objecter.h

15 #iâdeà
CEPH_OBJECTER_H


16 
	#CEPH_OBJECTER_H


	)

18 
	~<cÚd™iÚ_v¬ŸbË
>

19 
	~<li¡
>

20 
	~<m­
>

21 
	~<mu‹x
>

22 
	~<memÜy
>

23 
	~<s¡»am
>

24 
	~<ty³_Œa™s
>

26 
	~<boo¡/th»ad/sh¬ed_mu‹x.hµ
>

28 
	~"šşude/as£¹.h
"

29 
	~"šşude/bufãr.h
"

30 
	~"šşude/ty³s.h
"

31 
	~"šşude/¿dos/¿dos_ty³s.hµ
"

33 
	~"commÚ/admš_sock‘.h
"

34 
	~"commÚ/ûph_time.h
"

35 
	~"commÚ/ûph_tim”.h
"

36 
	~"commÚ/Fšish”.h
"

37 
	~"commÚ/shunique_lock.h
"

38 
	~"commÚ/zkš_Œaû.h
"

40 
	~"mes§ges/MOSDOp.h
"

41 
	~"osd/OSDM­.h
"

44 
şass
 
	gCÚ‹xt
;

45 
şass
 
	gMes£ng”
;

46 
şass
 
	gOSDM­
;

47 
şass
 
	gMÚCl›Á
;

48 
şass
 
	gMes§ge
;

49 
şass
 
	gFšish”
;

51 
şass
 
	gMPoŞOpR•ly
;

53 
şass
 
	gMG‘PoŞStsR•ly
;

54 
şass
 
	gMStfsR•ly
;

55 
şass
 
	gMCommªdR•ly
;

56 
şass
 
	gMW©chNÙify
;

58 
şass
 
	gP”fCouÁ”s
;

62 
	sObjeùO³¿tiÚ
 {

63 
	mveùÜ
<
	mOSDOp
> 
	mİs
;

64 
	mæags
;

65 
	m´iÜ™y
;

67 
	mveùÜ
<
	mbufã¾i¡
*> 
	mout_bl
;

68 
	mveùÜ
<
	mCÚ‹xt
*> 
	mout_hªdËr
;

69 
	mveùÜ
<*> 
	mout_rv®
;

71 
ObjeùO³¿tiÚ
(è: 
æags
(0), 
´iÜ™y
(0) {}

72 ~
ObjeùO³¿tiÚ
() {

73 !
	mout_hªdËr
.
em±y
()) {

74 
d–‘e
 
	mout_hªdËr
.
back
();

75 
	mout_hªdËr
.
pİ_back
();

79 
size_t
 
size
() {

80  
	mİs
.
size
();

83 
£t_Ï¡_İ_æags
(
æags
) {

84 
as£¹
(!
İs
.
em±y
());

85 
	mİs
.
rbegš
()->
	mİ
.
	mæags
 = 
æags
;

88 
şass
 
	mC_TwoCÚ‹xts
;

93 
add_hªdËr
(
CÚ‹xt
 *
exŒa
);

95 
	mOSDOp
& 
add_İ
(
İ
) {

96 
	ms
 = 
İs
.
size
();

97 
	mİs
.
»size
(
s
+1);

98 
	mİs
[
s
].
	mİ
.İ = 
İ
;

99 
	mout_bl
.
»size
(
s
+1);

100 
	mout_bl
[
s
] = 
NULL
;

101 
	mout_hªdËr
.
»size
(
s
+1);

102 
	mout_hªdËr
[
s
] = 
NULL
;

103 
	mout_rv®
.
»size
(
s
+1);

104 
	mout_rv®
[
s
] = 
NULL
;

105  
	mİs
[
s
];

107 
add_d©a
(
İ
, 
ušt64_t
 
off
, ušt64_ˆ
Ën
, 
bufã¾i¡
& 
bl
) {

108 
	mOSDOp
& 
	mosd_İ
 = 
add_İ
(
İ
);

109 
	mosd_İ
.
	mİ
.
	mex‹Á
.
	moff£t
 = 
off
;

110 
	mosd_İ
.
	mİ
.
	mex‹Á
.
	mËngth
 = 
Ën
;

111 
	mosd_İ
.
	mšd©a
.
şaim_­³nd
(
bl
);

113 
add_wr™e§me
(
İ
, 
ušt64_t
 
off
, ušt64_ˆ
wr™e_Ën
,

114 
bufã¾i¡
& 
bl
) {

115 
	mOSDOp
& 
	mosd_İ
 = 
add_İ
(
İ
);

116 
	mosd_İ
.
	mİ
.
	mwr™e§me
.
	moff£t
 = 
off
;

117 
	mosd_İ
.
	mİ
.
	mwr™e§me
.
	mËngth
 = 
wr™e_Ën
;

118 
	mosd_İ
.
	mİ
.
	mwr™e§me
.
	md©a_Ëngth
 = 
bl
.
Ëngth
();

119 
	mosd_İ
.
	mšd©a
.
şaim_­³nd
(
bl
);

121 
add_x©Œ
(
İ
, cÚ¡ *
Çme
, cÚ¡ 
bufã¾i¡
& 
d©a
) {

122 
	mOSDOp
& 
	mosd_İ
 = 
add_İ
(
İ
);

123 
	mosd_İ
.
	mİ
.
	mx©Œ
.
	mÇme_Ën
 = (
Çme
 ? 
¡¾’
(name) : 0);

124 
	mosd_İ
.
	mİ
.
	mx©Œ
.
	mv®ue_Ën
 = 
d©a
.
Ëngth
();

125 ià(
	mÇme
)

126 
	mosd_İ
.
	mšd©a
.
­³nd
(
Çme
, 
osd_İ
.
İ
.
x©Œ
.
Çme_Ën
);

127 
	mosd_İ
.
	mšd©a
.
­³nd
(
d©a
);

129 
add_x©Œ_cmp
(
İ
, cÚ¡ *
Çme
, 
ušt8_t
 
cmp_İ
,

130 
ušt8_t
 
cmp_mode
, cÚ¡ 
bufã¾i¡
& 
d©a
) {

131 
	mOSDOp
& 
	mosd_İ
 = 
add_İ
(
İ
);

132 
	mosd_İ
.
	mİ
.
	mx©Œ
.
	mÇme_Ën
 = (
Çme
 ? 
¡¾’
(name) : 0);

133 
	mosd_İ
.
	mİ
.
	mx©Œ
.
	mv®ue_Ën
 = 
d©a
.
Ëngth
();

134 
	mosd_İ
.
	mİ
.
	mx©Œ
.
	mcmp_İ
 = 
cmp_İ
;

135 
	mosd_İ
.
	mİ
.
	mx©Œ
.
	mcmp_mode
 = 
cmp_mode
;

136 ià(
	mÇme
)

137 
	mosd_İ
.
	mšd©a
.
­³nd
(
Çme
, 
osd_İ
.
İ
.
x©Œ
.
Çme_Ën
);

138 
	mosd_İ
.
	mšd©a
.
­³nd
(
d©a
);

140 
add_ÿÎ
(
İ
, cÚ¡ *
úame
, cÚ¡ *
m‘hod
,

141 
bufã¾i¡
 &
šd©a
,

142 
bufã¾i¡
 *
outbl
, 
CÚ‹xt
 *
ùx
, *
´v®
) {

143 
	mOSDOp
& 
	mosd_İ
 = 
add_İ
(
İ
);

145 
	mp
 = 
İs
.
size
() - 1;

146 
	mout_hªdËr
[
p
] = 
ùx
;

147 
	mout_bl
[
p
] = 
outbl
;

148 
	mout_rv®
[
p
] = 
´v®
;

150 
	mosd_İ
.
	mİ
.
	mşs
.
	mşass_Ën
 = 
¡¾’
(
úame
);

151 
	mosd_İ
.
	mİ
.
	mşs
.
	mm‘hod_Ën
 = 
¡¾’
(
m‘hod
);

152 
	mosd_İ
.
	mİ
.
	mşs
.
	mšd©a_Ën
 = 
šd©a
.
Ëngth
();

153 
	mosd_İ
.
	mšd©a
.
­³nd
(
úame
, 
osd_İ
.
İ
.
şs
.
şass_Ën
);

154 
	mosd_İ
.
	mšd©a
.
­³nd
(
m‘hod
, 
osd_İ
.
İ
.
şs
.
m‘hod_Ën
);

155 
	mosd_İ
.
	mšd©a
.
­³nd
(
šd©a
);

157 
add_pgls
(
İ
, 
ušt64_t
 
couÁ
, 
cŞËùiÚ_li¡_hªdË_t
 
cook›
,

158 
•och_t
 
¡¬t_•och
) {

159 
	mOSDOp
& 
	mosd_İ
 = 
add_İ
(
İ
);

160 
	mosd_İ
.
	mİ
.
	mpgls
.
	mcouÁ
 = 
couÁ
;

161 
	mosd_İ
.
	mİ
.
	mpgls
.
	m¡¬t_•och
 = 
¡¬t_•och
;

162 
’code
(
cook›
, 
osd_İ
.
šd©a
);

164 
add_pgls_f‹r
(
İ
, 
ušt64_t
 
couÁ
, cÚ¡ 
bufã¾i¡
& 
f‹r
,

165 
cŞËùiÚ_li¡_hªdË_t
 
cook›
, 
•och_t
 
¡¬t_•och
) {

166 
	mOSDOp
& 
	mosd_İ
 = 
add_İ
(
İ
);

167 
	mosd_İ
.
	mİ
.
	mpgls
.
	mcouÁ
 = 
couÁ
;

168 
	mosd_İ
.
	mİ
.
	mpgls
.
	m¡¬t_•och
 = 
¡¬t_•och
;

169 
¡ršg
 
	múame
 = "pg";

170 
¡ršg
 
	mmÇme
 = "filter";

171 
’code
(
úame
, 
osd_İ
.
šd©a
);

172 
’code
(
mÇme
, 
osd_İ
.
šd©a
);

173 
	mosd_İ
.
	mšd©a
.
­³nd
(
f‹r
);

174 
’code
(
cook›
, 
osd_İ
.
šd©a
);

176 
add_®loc_hšt
(
İ
, 
ušt64_t
 
ex³ùed_objeù_size
,

177 
ušt64_t
 
ex³ùed_wr™e_size
,

178 
ušt32_t
 
æags
) {

179 
	mOSDOp
& 
	mosd_İ
 = 
add_İ
(
İ
);

180 
	mosd_İ
.
	mİ
.
	m®loc_hšt
.
	mex³ùed_objeù_size
 = 
ex³ùed_objeù_size
;

181 
	mosd_İ
.
	mİ
.
	m®loc_hšt
.
	mex³ùed_wr™e_size
 = 
ex³ùed_wr™e_size
;

182 
	mosd_İ
.
	mİ
.
	m®loc_hšt
.
	mæags
 = 
æags
;

188 
pg_ls
(
ušt64_t
 
couÁ
, 
bufã¾i¡
& 
f‹r
,

189 
cŞËùiÚ_li¡_hªdË_t
 
cook›
, 
•och_t
 
¡¬t_•och
) {

190 ià(
	mf‹r
.
Ëngth
() == 0)

191 
add_pgls
(
CEPH_OSD_OP_PGLS
, 
couÁ
, 
cook›
, 
¡¬t_•och
);

193 
add_pgls_f‹r
(
CEPH_OSD_OP_PGLS_FILTER
, 
couÁ
, 
f‹r
, 
cook›
,

194 
¡¬t_•och
);

195 
	mæags
 |ğ
CEPH_OSD_FLAG_PGOP
;

198 
pg_Æs
(
ušt64_t
 
couÁ
, cÚ¡ 
bufã¾i¡
& 
f‹r
,

199 
cŞËùiÚ_li¡_hªdË_t
 
cook›
, 
•och_t
 
¡¬t_•och
) {

200 ià(
	mf‹r
.
Ëngth
() == 0)

201 
add_pgls
(
CEPH_OSD_OP_PGNLS
, 
couÁ
, 
cook›
, 
¡¬t_•och
);

203 
add_pgls_f‹r
(
CEPH_OSD_OP_PGNLS_FILTER
, 
couÁ
, 
f‹r
, 
cook›
,

204 
¡¬t_•och
);

205 
	mæags
 |ğ
CEPH_OSD_FLAG_PGOP
;

208 
süub_ls
(cÚ¡ 
lib¿dos
::
objeù_id_t
& 
¡¬t_aá”
,

209 
ušt64_t
 
max_to_g‘
,

210 
¡d
::
veùÜ
<
lib¿dos
::
šcÚsi¡’t_obj_t
> *
objeùs
,

211 
ušt32_t
 *
š‹rv®
,

212 *
rv®
);

213 
süub_ls
(cÚ¡ 
lib¿dos
::
objeù_id_t
& 
¡¬t_aá”
,

214 
ušt64_t
 
max_to_g‘
,

215 
¡d
::
veùÜ
<
lib¿dos
::
šcÚsi¡’t_¢­£t_t
> *
objeùs
,

216 
ušt32_t
 *
š‹rv®
,

217 *
rv®
);

219 
ü—‹
(
boŞ
 
exş
) {

220 
	mOSDOp
& 
	mo
 = 
add_İ
(
CEPH_OSD_OP_CREATE
);

221 
	mo
.
	mİ
.
	mæags
 = (
exş
 ? 
CEPH_OSD_OP_FLAG_EXCL
 : 0);

224 
	mC_ObjeùO³¿tiÚ_¡©
 : 
public
 
CÚ‹xt
 {

225 
bufã¾i¡
 
bl
;

226 
ušt64_t
 *
	mpsize
;

227 
	mûph
::
»®_time
 *
pmtime
;

228 
time_t
 *
	m±ime
;

229 
time¥ec
 *
	m±s
;

230 *
	m´v®
;

231 
C_ObjeùO³¿tiÚ_¡©
(
ušt64_t
 *
ps
, 
ûph
::
»®_time
 *
pm
, 
time_t
 *
±
, 
time¥ec
 *
_±s
,

232 *
´v®
)

233 : 
psize
(
ps
), 
pmtime
(
pm
), 
±ime
(
±
), 
±s
(
_±s
), 
´v®
(prval) {}

234 
fšish
(
r
è
	mov”ride
 {

235 ià(
	mr
 >= 0) {

236 
bufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
begš
();

237 
	mŒy
 {

238 
ušt64_t
 
	msize
;

239 
	mûph
::
»®_time
 
mtime
;

240 
decode
(
size
, 
p
);

241 
decode
(
mtime
, 
p
);

242 ià(
	mpsize
)

243 *
	mpsize
 = 
size
;

244 ià(
	mpmtime
)

245 *
	mpmtime
 = 
mtime
;

246 ià(
	m±ime
)

247 *
	m±ime
 = 
ûph
::
»®_şock
::
to_time_t
(
mtime
);

248 ià(
	m±s
)

249 *
	m±s
 = 
ûph
::
»®_şock
::
to_time¥ec
(
mtime
);

250 } 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

251 ià(
´v®
)

252 *
´v®
 = -
EIO
;

257 
¡©
(
ušt64_t
 *
psize
, 
ûph
::
»®_time
 *
pmtime
, *
´v®
) {

258 
add_İ
(
CEPH_OSD_OP_STAT
);

259 
	mp
 = 
İs
.
size
() - 1;

260 
C_ObjeùO³¿tiÚ_¡©
 *
	mh
 = 
Ãw
 C_ObjeùO³¿tiÚ_¡©(
psize
, 
pmtime
, 
NULL
, NULL,

261 
´v®
);

262 
	mout_bl
[
p
] = &
h
->
bl
;

263 
	mout_hªdËr
[
p
] = 
h
;

264 
	mout_rv®
[
p
] = 
´v®
;

266 
¡©
(
ušt64_t
 *
psize
, 
time_t
 *
±ime
, *
´v®
) {

267 
add_İ
(
CEPH_OSD_OP_STAT
);

268 
	mp
 = 
İs
.
size
() - 1;

269 
C_ObjeùO³¿tiÚ_¡©
 *
	mh
 = 
Ãw
 C_ObjeùO³¿tiÚ_¡©(
psize
, 
NULL
, 
±ime
, NULL,

270 
´v®
);

271 
	mout_bl
[
p
] = &
h
->
bl
;

272 
	mout_hªdËr
[
p
] = 
h
;

273 
	mout_rv®
[
p
] = 
´v®
;

275 
¡©
(
ušt64_t
 *
psize
, 
time¥ec
 *
±s
, *
´v®
) {

276 
add_İ
(
CEPH_OSD_OP_STAT
);

277 
	mp
 = 
İs
.
size
() - 1;

278 
C_ObjeùO³¿tiÚ_¡©
 *
	mh
 = 
Ãw
 C_ObjeùO³¿tiÚ_¡©(
psize
, 
NULL
, NULL, 
±s
,

279 
´v®
);

280 
	mout_bl
[
p
] = &
h
->
bl
;

281 
	mout_hªdËr
[
p
] = 
h
;

282 
	mout_rv®
[
p
] = 
´v®
;

285 
	mC_ObjeùO³¿tiÚ_cm³xt
 : 
public
 
CÚ‹xt
 {

286 *
´v®
;

287 
ex¶ic™
 
C_ObjeùO³¿tiÚ_cm³xt
(*
´v®
)

288 : 
´v®
(prval) {}

290 
fšish
(
r
) {

291 ià(
´v®
)

292 *
´v®
 = 
r
;

296 
cm³xt
(
ušt64_t
 
off
, 
bufã¾i¡
& 
cmp_bl
, *
´v®
) {

297 
add_d©a
(
CEPH_OSD_OP_CMPEXT
, 
off
, 
cmp_bl
.
Ëngth
(), cmp_bl);

298 
	mp
 = 
İs
.
size
() - 1;

299 
C_ObjeùO³¿tiÚ_cm³xt
 *
	mh
 = 
Ãw
 C_ObjeùO³¿tiÚ_cm³xt(
´v®
);

300 
	mout_hªdËr
[
p
] = 
h
;

301 
	mout_rv®
[
p
] = 
´v®
;

305 
cm³xt
(
ušt64_t
 
off
, ušt64_ˆ
cmp_Ën
, cÚ¡ *
cmp_buf
, *
´v®
) {

306 
bufã¾i¡
 
	mcmp_bl
;

307 
	mcmp_bl
.
­³nd
(
cmp_buf
, 
cmp_Ën
);

308 
add_d©a
(
CEPH_OSD_OP_CMPEXT
, 
off
, 
cmp_Ën
, 
cmp_bl
);

309 
	mp
 = 
İs
.
size
() - 1;

310 
C_ObjeùO³¿tiÚ_cm³xt
 *
	mh
 = 
Ãw
 C_ObjeùO³¿tiÚ_cm³xt(
´v®
);

311 
	mout_hªdËr
[
p
] = 
h
;

312 
	mout_rv®
[
p
] = 
´v®
;

315 
»ad
(
ušt64_t
 
off
, ušt64_ˆ
Ën
, 
bufã¾i¡
 *
pbl
, *
´v®
,

316 
CÚ‹xt
* 
ùx
) {

317 
bufã¾i¡
 
	mbl
;

318 
add_d©a
(
CEPH_OSD_OP_READ
, 
off
, 
Ën
, 
bl
);

319 
	mp
 = 
İs
.
size
() - 1;

320 
	mout_bl
[
p
] = 
pbl
;

321 
	mout_rv®
[
p
] = 
´v®
;

322 
	mout_hªdËr
[
p
] = 
ùx
;

325 
	mC_ObjeùO³¿tiÚ_¥¬£_»ad
 : 
public
 
CÚ‹xt
 {

326 
bufã¾i¡
 
bl
;

327 
bufã¾i¡
 *
	md©a_bl
;

328 
	m¡d
::
m­
<
ušt64_t
, 
	mušt64_t
> *
	mex‹Ás
;

329 *
	m´v®
;

330 
C_ObjeùO³¿tiÚ_¥¬£_»ad
(
bufã¾i¡
 *
d©a_bl
,

331 
¡d
::
m­
<
ušt64_t
, ušt64_t> *
ex‹Ás
,

332 *
´v®
)

333 : 
d©a_bl
(d©a_bl), 
ex‹Ás
Óx‹Ás), 
´v®
(prval) {}

334 
fšish
(
r
è
	mov”ride
 {

335 
	mbufã¾i¡
::
™”©Ü
 
™”
 = 
bl
.
begš
();

336 ià(
	mr
 >= 0) {

340 ià(
bl
.
Ëngth
() > 0) {

341 
Œy
 {

342 
decode
(*
ex‹Ás
, 
™”
);

343 
decode
(*
d©a_bl
, 
™”
);

344 } 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

345 ià(
´v®
)

346 *
´v®
 = -
EIO
;

348 } ià(
	m´v®
) {

349 *
	m´v®
 = -
EIO
;

354 
¥¬£_»ad
(
ušt64_t
 
off
, ušt64_ˆ
Ën
, 
¡d
::
m­
<ušt64_t,ušt64_t> *
m
,

355 
bufã¾i¡
 *
d©a_bl
, *
´v®
) {

356 
bufã¾i¡
 
	mbl
;

357 
add_d©a
(
CEPH_OSD_OP_SPARSE_READ
, 
off
, 
Ën
, 
bl
);

358 
	mp
 = 
İs
.
size
() - 1;

359 
C_ObjeùO³¿tiÚ_¥¬£_»ad
 *
	mh
 =

360 
Ãw
 
C_ObjeùO³¿tiÚ_¥¬£_»ad
(
d©a_bl
, 
m
, 
´v®
);

361 
	mout_bl
[
p
] = &
h
->
bl
;

362 
	mout_hªdËr
[
p
] = 
h
;

363 
	mout_rv®
[
p
] = 
´v®
;

365 
wr™e
(
ušt64_t
 
off
, 
bufã¾i¡
& 
bl
,

366 
ušt64_t
 
Œunÿ‹_size
,

367 
ušt32_t
 
Œunÿ‹_£q
) {

368 
add_d©a
(
CEPH_OSD_OP_WRITE
, 
off
, 
bl
.
Ëngth
(), bl);

369 
	mOSDOp
& 
	mo
 = *
İs
.
rbegš
();

370 
	mo
.
	mİ
.
	mex‹Á
.
	mŒunÿ‹_size
 = 
Œunÿ‹_size
;

371 
	mo
.
	mİ
.
	mex‹Á
.
	mŒunÿ‹_£q
 = 
Œunÿ‹_£q
;

373 
wr™e
(
ušt64_t
 
off
, 
bufã¾i¡
& 
bl
) {

374 
wr™e
(
off
, 
bl
, 0, 0);

376 
wr™e_fuÎ
(
bufã¾i¡
& 
bl
) {

377 
add_d©a
(
CEPH_OSD_OP_WRITEFULL
, 0, 
bl
.
Ëngth
(), bl);

379 
wr™e§me
(
ušt64_t
 
off
, ušt64_ˆ
wr™e_Ën
, 
bufã¾i¡
& 
bl
) {

380 
add_wr™e§me
(
CEPH_OSD_OP_WRITESAME
, 
off
, 
wr™e_Ën
, 
bl
);

382 
­³nd
(
bufã¾i¡
& 
bl
) {

383 
add_d©a
(
CEPH_OSD_OP_APPEND
, 0, 
bl
.
Ëngth
(), bl);

385 
z”o
(
ušt64_t
 
off
, ušt64_ˆ
Ën
) {

386 
bufã¾i¡
 
	mbl
;

387 
add_d©a
(
CEPH_OSD_OP_ZERO
, 
off
, 
Ën
, 
bl
);

389 
Œunÿ‹
(
ušt64_t
 
off
) {

390 
bufã¾i¡
 
	mbl
;

391 
add_d©a
(
CEPH_OSD_OP_TRUNCATE
, 
off
, 0, 
bl
);

393 
»move
() {

394 
bufã¾i¡
 
	mbl
;

395 
add_d©a
(
CEPH_OSD_OP_DELETE
, 0, 0, 
bl
);

397 
m­ext
(
ušt64_t
 
off
, ušt64_ˆ
Ën
) {

398 
bufã¾i¡
 
	mbl
;

399 
add_d©a
(
CEPH_OSD_OP_MAPEXT
, 
off
, 
Ën
, 
bl
);

401 
¥¬£_»ad
(
ušt64_t
 
off
, ušt64_ˆ
Ën
) {

402 
bufã¾i¡
 
	mbl
;

403 
add_d©a
(
CEPH_OSD_OP_SPARSE_READ
, 
off
, 
Ën
, 
bl
);

406 
checksum
(
ušt8_t
 
ty³
, cÚ¡ 
bufã¾i¡
 &
š™_v®ue_bl
,

407 
ušt64_t
 
off
, ušt64_ˆ
Ën
, 
size_t
 
chunk_size
,

408 
bufã¾i¡
 *
pbl
, *
´v®
, 
CÚ‹xt
 *
ùx
) {

409 
	mOSDOp
& 
	mosd_İ
 = 
add_İ
(
CEPH_OSD_OP_CHECKSUM
);

410 
	mosd_İ
.
	mİ
.
	mchecksum
.
	moff£t
 = 
off
;

411 
	mosd_İ
.
	mİ
.
	mchecksum
.
	mËngth
 = 
Ën
;

412 
	mosd_İ
.
	mİ
.
	mchecksum
.
	mty³
 = 
ty³
;

413 
	mosd_İ
.
	mİ
.
	mchecksum
.
	mchunk_size
 = 
chunk_size
;

414 
	mosd_İ
.
	mšd©a
.
­³nd
(
š™_v®ue_bl
);

416 
	mp
 = 
İs
.
size
() - 1;

417 
	mout_bl
[
p
] = 
pbl
;

418 
	mout_rv®
[
p
] = 
´v®
;

419 
	mout_hªdËr
[
p
] = 
ùx
;

423 
g‘x©Œ
(cÚ¡ *
Çme
, 
bufã¾i¡
 *
pbl
, *
´v®
) {

424 
bufã¾i¡
 
	mbl
;

425 
add_x©Œ
(
CEPH_OSD_OP_GETXATTR
, 
Çme
, 
bl
);

426 
	mp
 = 
İs
.
size
() - 1;

427 
	mout_bl
[
p
] = 
pbl
;

428 
	mout_rv®
[
p
] = 
´v®
;

430 
	mC_ObjeùO³¿tiÚ_decodev®s
 : 
public
 
CÚ‹xt
 {

431 
ušt64_t
 
max_’Œ›s
;

432 
bufã¾i¡
 
	mbl
;

433 
	m¡d
::
m­
<
¡d
::
¡ršg
,
	mbufã¾i¡
> *
	m·‰rs
;

434 
boŞ
 *
	m±runÿ‹d
;

435 *
	m´v®
;

436 
C_ObjeùO³¿tiÚ_decodev®s
(
ušt64_t
 
m
, 
¡d
::
m­
<¡d::
¡ršg
,
bufã¾i¡
> *
·
,

437 
boŞ
 *
±
, *
´
)

438 : 
max_’Œ›s
(
m
), 
·‰rs
(
·
), 
±runÿ‹d
(
±
), 
´v®
(
´
) {

439 ià(
	m±runÿ‹d
) {

440 *
	m±runÿ‹d
 = 
çl£
;

443 
fšish
(
r
è
	mov”ride
 {

444 ià(
	mr
 >= 0) {

445 
bufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
begš
();

446 
	mŒy
 {

447 ià(
	m·‰rs
)

448 
decode
(*
·‰rs
, 
p
);

449 ià(
	m±runÿ‹d
) {

450 
	m¡d
::
m­
<
¡d
::
¡ršg
,
	mbufã¾i¡
> 
	mignÜe
;

451 ià(!
	m·‰rs
) {

452 
decode
(
ignÜe
, 
p
);

453 
	m·‰rs
 = &
ignÜe
;

455 ià(!
	mp
.
’d
()) {

456 
decode
(*
±runÿ‹d
, 
p
);

461 *
	m±runÿ‹d
 = (
·‰rs
->
size
(è=ğ
max_’Œ›s
);

465 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

466 ià(
´v®
)

467 *
´v®
 = -
EIO
;

472 
	mC_ObjeùO³¿tiÚ_decodekeys
 : 
public
 
CÚ‹xt
 {

473 
ušt64_t
 
max_’Œ›s
;

474 
bufã¾i¡
 
	mbl
;

475 
	m¡d
::
£t
<
¡d
::
¡ršg
> *
·‰rs
;

476 
boŞ
 *
	m±runÿ‹d
;

477 *
	m´v®
;

478 
C_ObjeùO³¿tiÚ_decodekeys
(
ušt64_t
 
m
, 
¡d
::
£t
<¡d::
¡ršg
> *
·
, 
boŞ
 *
±
,

479 *
´
)

480 : 
max_’Œ›s
(
m
), 
·‰rs
(
·
), 
±runÿ‹d
(
±
), 
´v®
(
´
) {

481 ià(
	m±runÿ‹d
) {

482 *
	m±runÿ‹d
 = 
çl£
;

485 
fšish
(
r
è
	mov”ride
 {

486 ià(
	mr
 >= 0) {

487 
bufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
begš
();

488 
	mŒy
 {

489 ià(
	m·‰rs
)

490 
decode
(*
·‰rs
, 
p
);

491 ià(
	m±runÿ‹d
) {

492 
	m¡d
::
£t
<
¡d
::
¡ršg
> 
ignÜe
;

493 ià(!
	m·‰rs
) {

494 
decode
(
ignÜe
, 
p
);

495 
	m·‰rs
 = &
ignÜe
;

497 ià(!
	mp
.
’d
()) {

498 
decode
(*
±runÿ‹d
, 
p
);

503 *
	m±runÿ‹d
 = (
·‰rs
->
size
(è=ğ
max_’Œ›s
);

507 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

508 ià(
´v®
)

509 *
´v®
 = -
EIO
;

514 
	mC_ObjeùO³¿tiÚ_decodew©ch”s
 : 
public
 
CÚ‹xt
 {

515 
bufã¾i¡
 
bl
;

516 
	mli¡
<
	mobj_w©ch_t
> *
	mpw©ch”s
;

517 *
	m´v®
;

518 
C_ObjeùO³¿tiÚ_decodew©ch”s
(
li¡
<
obj_w©ch_t
> *
pw
, *
´
)

519 : 
pw©ch”s
(
pw
), 
´v®
(
´
) {}

520 
fšish
(
r
è
	mov”ride
 {

521 ià(
	mr
 >= 0) {

522 
bufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
begš
();

523 
	mŒy
 {

524 
obj_li¡_w©ch_»¥Ú£_t
 
	m»¥
;

525 
decode
(
»¥
, 
p
);

526 ià(
	mpw©ch”s
) {

527 
	mli¡
<
	mw©ch_™em_t
>::
™”©Ü
 
i
 = 
»¥
.
’Œ›s
.
begš
() ;

528 
	mi
 !ğ
»¥
.
’Œ›s
.
’d
() ; ++i) {

529 
obj_w©ch_t
 
	mow
;

530 
o¡ršg¡»am
 
	m§
;

531 
	m§
 << 
	mi
->
	maddr
;

532 
¡ºıy
(
ow
.
addr
, 
§
.
¡r
().
c_¡r
(), 256);

533 
	mow
.
	mw©ch”_id
 = 
i
->
Çme
.
num
();

534 
	mow
.
	mcook›
 = 
i
->
cook›
;

535 
	mow
.
	mtimeout_£cÚds
 = 
i
->
timeout_£cÚds
;

536 
	mpw©ch”s
->
push_back
(
ow
);

540 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

541 ià(
´v®
)

542 *
´v®
 = -
EIO
;

547 
	mC_ObjeùO³¿tiÚ_decode¢­s
 : 
public
 
CÚ‹xt
 {

548 
bufã¾i¡
 
bl
;

549 
	mlib¿dos
::
¢­_£t_t
 *
p¢­s
;

550 *
	m´v®
;

551 
C_ObjeùO³¿tiÚ_decode¢­s
(
lib¿dos
::
¢­_£t_t
 *
ps
, *
´
)

552 : 
p¢­s
(
ps
), 
´v®
(
´
) {}

553 
fšish
(
r
è
	mov”ride
 {

554 ià(
	mr
 >= 0) {

555 
bufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
begš
();

556 
	mŒy
 {

557 
obj_li¡_¢­_»¥Ú£_t
 
	m»¥
;

558 
decode
(
»¥
, 
p
);

559 ià(
	mp¢­s
) {

560 
	mp¢­s
->
	mşÚes
.
ş—r
();

561 
	mveùÜ
<
	mşÚe_šfo
>::
™”©Ü
 
ci
 = 
»¥
.
şÚes
.
begš
();

562 
	mci
 !ğ
»¥
.
şÚes
.
’d
();

563 ++
	mci
) {

564 
	mlib¿dos
::
şÚe_šfo_t
 
şÚe
;

566 
	mşÚe
.
	mşÚeid
 = 
ci
->
şÚeid
;

567 
	mşÚe
.
	m¢­s
.
»£rve
(
ci
->
¢­s
.
size
());

568 
	mşÚe
.
	m¢­s
.
š£¹
(
şÚe
.
¢­s
.
’d
(), 
ci
->¢­s.
begš
(),

569 
ci
->
¢­s
.
’d
());

570 
	mşÚe
.
	mov”Ïp
 = 
ci
->
ov”Ïp
;

571 
	mşÚe
.
	msize
 = 
ci
->
size
;

573 
	mp¢­s
->
	mşÚes
.
push_back
(
şÚe
);

575 
	mp¢­s
->
	m£q
 = 
»¥
.
£q
;

577 } 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

578 ià(
´v®
)

579 *
´v®
 = -
EIO
;

584 
g‘x©Œs
(
¡d
::
m­
<¡d::
¡ršg
,
bufã¾i¡
> *
·‰rs
, *
´v®
) {

585 
add_İ
(
CEPH_OSD_OP_GETXATTRS
);

586 ià(
	m·‰rs
 || 
	m´v®
) {

587 
	mp
 = 
İs
.
size
() - 1;

588 
C_ObjeùO³¿tiÚ_decodev®s
 *
	mh


589 ğ
Ãw
 
C_ObjeùO³¿tiÚ_decodev®s
(0, 
·‰rs
, 
nuÎ±r
, 
´v®
);

590 
	mout_hªdËr
[
p
] = 
h
;

591 
	mout_bl
[
p
] = &
h
->
bl
;

592 
	mout_rv®
[
p
] = 
´v®
;

595 
£tx©Œ
(cÚ¡ *
Çme
, cÚ¡ 
bufã¾i¡
& 
bl
) {

596 
add_x©Œ
(
CEPH_OSD_OP_SETXATTR
, 
Çme
, 
bl
);

598 
£tx©Œ
(cÚ¡ *
Çme
, cÚ¡ 
¡ršg
& 
s
) {

599 
bufã¾i¡
 
	mbl
;

600 
	mbl
.
­³nd
(
s
);

601 
add_x©Œ
(
CEPH_OSD_OP_SETXATTR
, 
Çme
, 
bl
);

603 
cmpx©Œ
(cÚ¡ *
Çme
, 
ušt8_t
 
cmp_İ
, ušt8_ˆ
cmp_mode
,

604 cÚ¡ 
bufã¾i¡
& 
bl
) {

605 
add_x©Œ_cmp
(
CEPH_OSD_OP_CMPXATTR
, 
Çme
, 
cmp_İ
, 
cmp_mode
, 
bl
);

607 
rmx©Œ
(cÚ¡ *
Çme
) {

608 
bufã¾i¡
 
	mbl
;

609 
add_x©Œ
(
CEPH_OSD_OP_RMXATTR
, 
Çme
, 
bl
);

611 
£tx©Œs
(
m­
<
¡ršg
, 
bufã¾i¡
>& 
©Œs
) {

612 
bufã¾i¡
 
	mbl
;

613 
’code
(
©Œs
, 
bl
);

614 
add_x©Œ
(
CEPH_OSD_OP_RESETXATTRS
, 0, 
bl
.
Ëngth
());

616 
»£tx©Œs
(cÚ¡ *
´efix
, 
m­
<
¡ršg
, 
bufã¾i¡
>& 
©Œs
) {

617 
bufã¾i¡
 
	mbl
;

618 
’code
(
©Œs
, 
bl
);

619 
add_x©Œ
(
CEPH_OSD_OP_RESETXATTRS
, 
´efix
, 
bl
);

623 
tm­_upd©e
(
bufã¾i¡
& 
bl
) {

624 
add_d©a
(
CEPH_OSD_OP_TMAPUP
, 0, 0, 
bl
);

626 
tm­_put
(
bufã¾i¡
& 
bl
) {

627 
add_d©a
(
CEPH_OSD_OP_TMAPPUT
, 0, 
bl
.
Ëngth
(), bl);

629 
tm­_g‘
(
bufã¾i¡
 *
pbl
, *
´v®
) {

630 
add_İ
(
CEPH_OSD_OP_TMAPGET
);

631 
	mp
 = 
İs
.
size
() - 1;

632 
	mout_bl
[
p
] = 
pbl
;

633 
	mout_rv®
[
p
] = 
´v®
;

635 
tm­_g‘
() {

636 
add_İ
(
CEPH_OSD_OP_TMAPGET
);

638 
tm­_to_om­
(
boŞ
 
nuÎok
=
çl£
) {

639 
OSDOp
& 
osd_İ
 = 
add_İ
(
CEPH_OSD_OP_TMAP2OMAP
);

640 ià(
	mnuÎok
)

641 
	mosd_İ
.
	mİ
.
	mtm­2om­
.
	mæags
 = 
CEPH_OSD_TMAP2OMAP_NULLOK
;

645 
om­_g‘_keys
(cÚ¡ 
¡ršg
 &
¡¬t_aá”
,

646 
ušt64_t
 
max_to_g‘
,

647 
¡d
::
£t
<¡d::
¡ršg
> *
out_£t
,

648 
boŞ
 *
±runÿ‹d
,

649 *
´v®
) {

650 
	mOSDOp
 &
	mİ
 = 
add_İ
(
CEPH_OSD_OP_OMAPGETKEYS
);

651 
bufã¾i¡
 
	mbl
;

652 
’code
(
¡¬t_aá”
, 
bl
);

653 
’code
(
max_to_g‘
, 
bl
);

654 
	mİ
.İ.
	mex‹Á
.
	moff£t
 = 0;

655 
	mİ
.İ.
	mex‹Á
.
	mËngth
 = 
bl
.
Ëngth
();

656 
	mİ
.
	mšd©a
.
şaim_­³nd
(
bl
);

657 ià(
	m´v®
 || 
	m±runÿ‹d
 || 
	mout_£t
) {

658 
	mp
 = 
İs
.
size
() - 1;

659 
C_ObjeùO³¿tiÚ_decodekeys
 *
	mh
 =

660 
Ãw
 
C_ObjeùO³¿tiÚ_decodekeys
(
max_to_g‘
, 
out_£t
, 
±runÿ‹d
, 
´v®
);

661 
	mout_hªdËr
[
p
] = 
h
;

662 
	mout_bl
[
p
] = &
h
->
bl
;

663 
	mout_rv®
[
p
] = 
´v®
;

667 
om­_g‘_v®s
(cÚ¡ 
¡ršg
 &
¡¬t_aá”
,

668 cÚ¡ 
¡ršg
 &
f‹r_´efix
,

669 
ušt64_t
 
max_to_g‘
,

670 
¡d
::
m­
<¡d::
¡ršg
, 
bufã¾i¡
> *
out_£t
,

671 
boŞ
 *
±runÿ‹d
,

672 *
´v®
) {

673 
	mOSDOp
 &
	mİ
 = 
add_İ
(
CEPH_OSD_OP_OMAPGETVALS
);

674 
bufã¾i¡
 
	mbl
;

675 
’code
(
¡¬t_aá”
, 
bl
);

676 
’code
(
max_to_g‘
, 
bl
);

677 
’code
(
f‹r_´efix
, 
bl
);

678 
	mİ
.İ.
	mex‹Á
.
	moff£t
 = 0;

679 
	mİ
.İ.
	mex‹Á
.
	mËngth
 = 
bl
.
Ëngth
();

680 
	mİ
.
	mšd©a
.
şaim_­³nd
(
bl
);

681 ià(
	m´v®
 || 
	mout_£t
 || 
	m±runÿ‹d
) {

682 
	mp
 = 
İs
.
size
() - 1;

683 
C_ObjeùO³¿tiÚ_decodev®s
 *
	mh
 =

684 
Ãw
 
C_ObjeùO³¿tiÚ_decodev®s
(
max_to_g‘
, 
out_£t
, 
±runÿ‹d
, 
´v®
);

685 
	mout_hªdËr
[
p
] = 
h
;

686 
	mout_bl
[
p
] = &
h
->
bl
;

687 
	mout_rv®
[
p
] = 
´v®
;

691 
om­_g‘_v®s_by_keys
(cÚ¡ 
¡d
::
£t
<¡d::
¡ršg
> &
to_g‘
,

692 
¡d
::
m­
<¡d::
¡ršg
, 
bufã¾i¡
> *
out_£t
,

693 *
´v®
) {

694 
	mOSDOp
 &
	mİ
 = 
add_İ
(
CEPH_OSD_OP_OMAPGETVALSBYKEYS
);

695 
bufã¾i¡
 
	mbl
;

696 
’code
(
to_g‘
, 
bl
);

697 
	mİ
.İ.
	mex‹Á
.
	moff£t
 = 0;

698 
	mİ
.İ.
	mex‹Á
.
	mËngth
 = 
bl
.
Ëngth
();

699 
	mİ
.
	mšd©a
.
şaim_­³nd
(
bl
);

700 ià(
	m´v®
 || 
	mout_£t
) {

701 
	mp
 = 
İs
.
size
() - 1;

702 
C_ObjeùO³¿tiÚ_decodev®s
 *
	mh
 =

703 
Ãw
 
C_ObjeùO³¿tiÚ_decodev®s
(0, 
out_£t
, 
nuÎ±r
, 
´v®
);

704 
	mout_hªdËr
[
p
] = 
h
;

705 
	mout_bl
[
p
] = &
h
->
bl
;

706 
	mout_rv®
[
p
] = 
´v®
;

710 
om­_cmp
(cÚ¡ 
¡d
::
m­
<¡d::
¡ršg
, 
·œ
<
bufã¾i¡
,> > &
as£¹iÚs
,

711 *
´v®
) {

712 
	mOSDOp
 &
	mİ
 = 
add_İ
(
CEPH_OSD_OP_OMAP_CMP
);

713 
bufã¾i¡
 
	mbl
;

714 
’code
(
as£¹iÚs
, 
bl
);

715 
	mİ
.İ.
	mex‹Á
.
	moff£t
 = 0;

716 
	mİ
.İ.
	mex‹Á
.
	mËngth
 = 
bl
.
Ëngth
();

717 
	mİ
.
	mšd©a
.
şaim_­³nd
(
bl
);

718 ià(
	m´v®
) {

719 
	mp
 = 
İs
.
size
() - 1;

720 
	mout_rv®
[
p
] = 
´v®
;

724 
	mC_ObjeùO³¿tiÚ_cİyg‘
 : 
public
 
CÚ‹xt
 {

725 
bufã¾i¡
 
bl
;

726 
objeù_cİy_cursÜ_t
 *
	mcursÜ
;

727 
ušt64_t
 *
	mout_size
;

728 
	mûph
::
»®_time
 *
out_mtime
;

729 
	m¡d
::
m­
<
¡d
::
¡ršg
,
	mbufã¾i¡
> *
	mout_©Œs
;

730 
bufã¾i¡
 *
	mout_d©a
, *
	mout_om­_h—d”
, *
	mout_om­_d©a
;

731 
	mveùÜ
<
	m¢­id_t
> *
	mout_¢­s
;

732 
¢­id_t
 *
	mout_¢­_£q
;

733 
ušt32_t
 *
	mout_æags
;

734 
ušt32_t
 *
	mout_d©a_dige¡
;

735 
ušt32_t
 *
	mout_om­_dige¡
;

736 
	mmempoŞ
::
osd_pglog
::
veùÜ
<
·œ
<
osd_»qid_t
, 
	mv”siÚ_t
> > *
	mout_»qids
;

737 
ušt64_t
 *
	mout_Œunÿ‹_£q
;

738 
ušt64_t
 *
	mout_Œunÿ‹_size
;

739 *
	m´v®
;

740 
C_ObjeùO³¿tiÚ_cİyg‘
(
objeù_cİy_cursÜ_t
 *
c
,

741 
ušt64_t
 *
s
,

742 
ûph
::
»®_time
 *
m
,

743 
¡d
::
m­
<¡d::
¡ršg
,
bufã¾i¡
> *
a
,

744 
bufã¾i¡
 *
d
, bufã¾i¡ *
oh
,

745 
bufã¾i¡
 *
o
,

746 
¡d
::
veùÜ
<
¢­id_t
> *
o¢­s
,

747 
¢­id_t
 *
o¢­_£q
,

748 
ušt32_t
 *
æags
,

749 
ušt32_t
 *
dd
,

750 
ušt32_t
 *
od
,

751 
mempoŞ
::
osd_pglog
::
veùÜ
<
·œ
<
osd_»qid_t
, 
v”siÚ_t
> > *
Üeqids
,

752 
ušt64_t
 *
Ù£q
,

753 
ušt64_t
 *
Ùsize
,

754 *
r
)

755 : 
cursÜ
(
c
),

756 
out_size
(
s
), 
out_mtime
(
m
),

757 
out_©Œs
(
a
), 
out_d©a
(
d
), 
out_om­_h—d”
(
oh
),

758 
out_om­_d©a
(
o
), 
out_¢­s
(
o¢­s
), 
out_¢­_£q
(
o¢­_£q
),

759 
out_æags
(
æags
), 
out_d©a_dige¡
(
dd
), 
out_om­_dige¡
(
od
),

760 
out_»qids
(
Üeqids
),

761 
out_Œunÿ‹_£q
(
Ù£q
),

762 
out_Œunÿ‹_size
(
Ùsize
),

763 
´v®
(
r
) {}

764 
fšish
(
r
è
	mov”ride
 {

766 ià(
	mr
 < 0 &&„ !ğ-
ENOENT
)

768 
	mŒy
 {

769 
	mbufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
begš
();

770 
objeù_cİy_d©a_t
 
	mcİy_»¶y
;

771 
decode
(
cİy_»¶y
, 
p
);

772 ià(
	mr
 =ğ-
ENOENT
) {

773 ià(
out_»qids
)

774 *
out_»qids
 = 
cİy_»¶y
.
»qids
;

777 ià(
	mout_size
)

778 *
	mout_size
 = 
cİy_»¶y
.
size
;

779 ià(
	mout_mtime
)

780 *
	mout_mtime
 = 
ûph
::
»®_şock
::
äom_ûph_time¥ec
(
cİy_»¶y
.
mtime
);

781 ià(
	mout_©Œs
)

782 *
	mout_©Œs
 = 
cİy_»¶y
.
©Œs
;

783 ià(
	mout_d©a
)

784 
	mout_d©a
->
şaim_­³nd
(
cİy_»¶y
.
d©a
);

785 ià(
	mout_om­_h—d”
)

786 
	mout_om­_h—d”
->
şaim_­³nd
(
cİy_»¶y
.
om­_h—d”
);

787 ià(
	mout_om­_d©a
)

788 *
	mout_om­_d©a
 = 
cİy_»¶y
.
om­_d©a
;

789 ià(
	mout_¢­s
)

790 *
	mout_¢­s
 = 
cİy_»¶y
.
¢­s
;

791 ià(
	mout_¢­_£q
)

792 *
	mout_¢­_£q
 = 
cİy_»¶y
.
¢­_£q
;

793 ià(
	mout_æags
)

794 *
	mout_æags
 = 
cİy_»¶y
.
æags
;

795 ià(
	mout_d©a_dige¡
)

796 *
	mout_d©a_dige¡
 = 
cİy_»¶y
.
d©a_dige¡
;

797 ià(
	mout_om­_dige¡
)

798 *
	mout_om­_dige¡
 = 
cİy_»¶y
.
om­_dige¡
;

799 ià(
	mout_»qids
)

800 *
	mout_»qids
 = 
cİy_»¶y
.
»qids
;

801 ià(
	mout_Œunÿ‹_£q
)

802 *
	mout_Œunÿ‹_£q
 = 
cİy_»¶y
.
Œunÿ‹_£q
;

803 ià(
	mout_Œunÿ‹_size
)

804 *
	mout_Œunÿ‹_size
 = 
cİy_»¶y
.
Œunÿ‹_size
;

805 *
	mcursÜ
 = 
cİy_»¶y
.
cursÜ
;

806 } 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

807 ià(
´v®
)

808 *
´v®
 = -
EIO
;

813 
cİy_g‘
(
objeù_cİy_cursÜ_t
 *
cursÜ
,

814 
ušt64_t
 
max
,

815 
ušt64_t
 *
out_size
,

816 
ûph
::
»®_time
 *
out_mtime
,

817 
¡d
::
m­
<¡d::
¡ršg
,
bufã¾i¡
> *
out_©Œs
,

818 
bufã¾i¡
 *
out_d©a
,

819 
bufã¾i¡
 *
out_om­_h—d”
,

820 
bufã¾i¡
 *
out_om­_d©a
,

821 
veùÜ
<
¢­id_t
> *
out_¢­s
,

822 
¢­id_t
 *
out_¢­_£q
,

823 
ušt32_t
 *
out_æags
,

824 
ušt32_t
 *
out_d©a_dige¡
,

825 
ušt32_t
 *
out_om­_dige¡
,

826 
mempoŞ
::
osd_pglog
::
veùÜ
<
·œ
<
osd_»qid_t
, 
v”siÚ_t
> > *
out_»qids
,

827 
ušt64_t
 *
Œunÿ‹_£q
,

828 
ušt64_t
 *
Œunÿ‹_size
,

829 *
´v®
) {

830 
	mOSDOp
& 
	mosd_İ
 = 
add_İ
(
CEPH_OSD_OP_COPY_GET
);

831 
	mosd_İ
.
	mİ
.
	mcİy_g‘
.
	mmax
 = 
max
;

832 
’code
(*
cursÜ
, 
osd_İ
.
šd©a
);

833 
’code
(
max
, 
osd_İ
.
šd©a
);

834 
	mp
 = 
İs
.
size
() - 1;

835 
	mout_rv®
[
p
] = 
´v®
;

836 
C_ObjeùO³¿tiÚ_cİyg‘
 *
	mh
 =

837 
Ãw
 
C_ObjeùO³¿tiÚ_cİyg‘
(
cursÜ
, 
out_size
, 
out_mtime
,

838 
out_©Œs
, 
out_d©a
, 
out_om­_h—d”
,

839 
out_om­_d©a
, 
out_¢­s
, 
out_¢­_£q
,

840 
out_æags
, 
out_d©a_dige¡
,

841 
out_om­_dige¡
, 
out_»qids
, 
Œunÿ‹_£q
,

842 
Œunÿ‹_size
, 
´v®
);

843 
	mout_bl
[
p
] = &
h
->
bl
;

844 
	mout_hªdËr
[
p
] = 
h
;

847 
undœty
() {

848 
add_İ
(
CEPH_OSD_OP_UNDIRTY
);

851 
	mC_ObjeùO³¿tiÚ_isdœty
 : 
public
 
CÚ‹xt
 {

852 
bufã¾i¡
 
bl
;

853 
boŞ
 *
	mpisdœty
;

854 *
	m´v®
;

855 
C_ObjeùO³¿tiÚ_isdœty
(
boŞ
 *
p
, *
r
)

856 : 
pisdœty
(
p
), 
´v®
(
r
) {}

857 
fšish
(
r
è
	mov”ride
 {

858 ià(
	mr
 < 0)

860 
	mŒy
 {

861 
	mbufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
begš
();

862 
boŞ
 
	misdœty
;

863 
decode
(
isdœty
, 
p
);

864 ià(
	mpisdœty
)

865 *
	mpisdœty
 = 
isdœty
;

866 } 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

867 ià(
´v®
)

868 *
´v®
 = -
EIO
;

873 
is_dœty
(
boŞ
 *
pisdœty
, *
´v®
) {

874 
add_İ
(
CEPH_OSD_OP_ISDIRTY
);

875 
	mp
 = 
İs
.
size
() - 1;

876 
	mout_rv®
[
p
] = 
´v®
;

877 
C_ObjeùO³¿tiÚ_isdœty
 *
	mh
 =

878 
Ãw
 
C_ObjeùO³¿tiÚ_isdœty
(
pisdœty
, 
´v®
);

879 
	mout_bl
[
p
] = &
h
->
bl
;

880 
	mout_hªdËr
[
p
] = 
h
;

883 
	mC_ObjeùO³¿tiÚ_h™_£t_ls
 : 
public
 
CÚ‹xt
 {

884 
bufã¾i¡
 
bl
;

885 
	m¡d
::
li¡
< 
¡d
::
·œ
<
time_t
, 
	mtime_t
> > *
	m±ls
;

886 
	m¡d
::
li¡
< 
¡d
::
·œ
<
ûph
::
»®_time
, 
	mûph
::»®_time> > *
pus
;

887 *
	m´v®
;

888 
C_ObjeùO³¿tiÚ_h™_£t_ls
(
¡d
::
li¡
< std::
·œ
<
time_t
,ime_t> > *
t
,

889 
¡d
::
li¡
< std::
·œ
<
ûph
::
»®_time
,

890 
ûph
::
»®_time
> > *
ut
,

891 *
r
)

892 : 
±ls
(
t
), 
pus
(
ut
), 
´v®
(
r
) {}

893 
fšish
(
r
è
	mov”ride
 {

894 ià(
	mr
 < 0)

896 
	mŒy
 {

897 
	mbufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
begš
();

898 
	m¡d
::
li¡
< 
¡d
::
·œ
<
ûph
::
»®_time
, 
	mûph
::»®_time> > 
ls
;

899 
decode
(
ls
, 
p
);

900 ià(
	m±ls
) {

901 
	m±ls
->
ş—r
();

902 autØ
	mp
 = 
ls
.
begš
();… !ğls.
’d
(); ++p)

905 
	m±ls
->
push_back
(

906 
make_·œ
(
ûph
::
»®_şock
::
to_time_t
(

907 
ûph
::
û
(
p
->
fœ¡
,

909 
¡d
::
chrÚo
::
£cÚds
(1))),

910 
ûph
::
»®_şock
::
to_time_t
(
p
->
£cÚd
)));

912 ià(
	mpus
)

913 
	mpus
->
sw­
(
ls
);

914 } 
ÿtch
 (
bufãr
::
”rÜ
& 
e
) {

915 
r
 = -
EIO
;

917 ià(
	m´v®
)

918 *
	m´v®
 = 
r
;

932 
h™_£t_ls
(
¡d
::
li¡
< std::
·œ
<
time_t
,ime_t> > *
¶s
, *
´v®
) {

933 
add_İ
(
CEPH_OSD_OP_PG_HITSET_LS
);

934 
	mp
 = 
İs
.
size
() - 1;

935 
	mout_rv®
[
p
] = 
´v®
;

936 
C_ObjeùO³¿tiÚ_h™_£t_ls
 *
	mh
 =

937 
Ãw
 
C_ObjeùO³¿tiÚ_h™_£t_ls
(
¶s
, 
NULL
, 
´v®
);

938 
	mout_bl
[
p
] = &
h
->
bl
;

939 
	mout_hªdËr
[
p
] = 
h
;

941 
h™_£t_ls
(
¡d
::
li¡
<¡d::
·œ
<
ûph
::
»®_time
, c•h::»®_time> > *
¶s
,

942 *
´v®
) {

943 
add_İ
(
CEPH_OSD_OP_PG_HITSET_LS
);

944 
	mp
 = 
İs
.
size
() - 1;

945 
	mout_rv®
[
p
] = 
´v®
;

946 
C_ObjeùO³¿tiÚ_h™_£t_ls
 *
	mh
 =

947 
Ãw
 
C_ObjeùO³¿tiÚ_h™_£t_ls
(
NULL
, 
¶s
, 
´v®
);

948 
	mout_bl
[
p
] = &
h
->
bl
;

949 
	mout_hªdËr
[
p
] = 
h
;

962 
h™_£t_g‘
(
ûph
::
»®_time
 
¡amp
, 
bufã¾i¡
 *
pbl
, *
´v®
) {

963 
	mOSDOp
& 
	mİ
 = 
add_İ
(
CEPH_OSD_OP_PG_HITSET_GET
);

964 
	mİ
.İ.
	mh™_£t_g‘
.
	m¡amp
 = 
ûph
::
»®_şock
::
to_ûph_time¥ec
(
¡amp
);

965 
	mp
 = 
İs
.
size
() - 1;

966 
	mout_rv®
[
p
] = 
´v®
;

967 
	mout_bl
[
p
] = 
pbl
;

970 
om­_g‘_h—d”
(
bufã¾i¡
 *
bl
, *
´v®
) {

971 
add_İ
(
CEPH_OSD_OP_OMAPGETHEADER
);

972 
	mp
 = 
İs
.
size
() - 1;

973 
	mout_bl
[
p
] = 
bl
;

974 
	mout_rv®
[
p
] = 
´v®
;

977 
om­_£t
(cÚ¡ 
m­
<
¡ršg
, 
bufã¾i¡
> &map) {

978 
bufã¾i¡
 
	mbl
;

979 
’code
(
m­
, 
bl
);

980 
add_d©a
(
CEPH_OSD_OP_OMAPSETVALS
, 0, 
bl
.
Ëngth
(), bl);

983 
om­_£t_h—d”
(
bufã¾i¡
 &
bl
) {

984 
add_d©a
(
CEPH_OSD_OP_OMAPSETHEADER
, 0, 
bl
.
Ëngth
(), bl);

987 
om­_ş—r
() {

988 
add_İ
(
CEPH_OSD_OP_OMAPCLEAR
);

991 
om­_rm_keys
(cÚ¡ 
¡d
::
£t
<¡d::
¡ršg
> &
to_»move
) {

992 
bufã¾i¡
 
bl
;

993 
’code
(
to_»move
, 
bl
);

994 
add_d©a
(
CEPH_OSD_OP_OMAPRMKEYS
, 0, 
bl
.
Ëngth
(), bl);

998 
ÿÎ
(cÚ¡ *
úame
, cÚ¡ *
m‘hod
, 
bufã¾i¡
 &
šd©a
) {

999 
add_ÿÎ
(
CEPH_OSD_OP_CALL
, 
úame
, 
m‘hod
, 
šd©a
, 
NULL
, NULL, NULL);

1002 
ÿÎ
(cÚ¡ *
úame
, cÚ¡ *
m‘hod
, 
bufã¾i¡
 &
šd©a
,

1003 
bufã¾i¡
 *
outd©a
, 
CÚ‹xt
 *
ùx
, *
´v®
) {

1004 
add_ÿÎ
(
CEPH_OSD_OP_CALL
, 
úame
, 
m‘hod
, 
šd©a
, 
outd©a
, 
ùx
, 
´v®
);

1008 
w©ch
(
ušt64_t
 
cook›
, 
__u8
 
İ
, 
ušt32_t
 
timeout
 = 0) {

1009 
OSDOp
& 
osd_İ
 = 
add_İ
(
CEPH_OSD_OP_WATCH
);

1010 
	mosd_İ
.
	mİ
.
	mw©ch
.
	mcook›
 = 
cook›
;

1011 
	mosd_İ
.
	mİ
.
	mw©ch
.İ = 
İ
;

1012 
	mosd_İ
.
	mİ
.
	mw©ch
.
	mtimeout
 = 
timeout
;

1015 
nÙify
(
ušt64_t
 
cook›
, 
ušt32_t
 
´Ù_v”
, ušt32_ˆ
timeout
,

1016 
bufã¾i¡
 &
bl
, bufã¾i¡ *
šbl
) {

1017 
	mOSDOp
& 
	mosd_İ
 = 
add_İ
(
CEPH_OSD_OP_NOTIFY
);

1018 
	mosd_İ
.
	mİ
.
	mnÙify
.
	mcook›
 = 
cook›
;

1019 
’code
(
´Ù_v”
, *
šbl
);

1020 
’code
(
timeout
, *
šbl
);

1021 
’code
(
bl
, *
šbl
);

1022 
	mosd_İ
.
	mšd©a
.
­³nd
(*
šbl
);

1025 
nÙify_ack
(
ušt64_t
 
nÙify_id
, ušt64_ˆ
cook›
,

1026 
bufã¾i¡
& 
»¶y_bl
) {

1027 
	mOSDOp
& 
	mosd_İ
 = 
add_İ
(
CEPH_OSD_OP_NOTIFY_ACK
);

1028 
bufã¾i¡
 
	mbl
;

1029 
’code
(
nÙify_id
, 
bl
);

1030 
’code
(
cook›
, 
bl
);

1031 
’code
(
»¶y_bl
, 
bl
);

1032 
	mosd_İ
.
	mšd©a
.
­³nd
(
bl
);

1035 
li¡_w©ch”s
(
li¡
<
obj_w©ch_t
> *
out
,

1036 *
´v®
) {

1037 ()
add_İ
(
CEPH_OSD_OP_LIST_WATCHERS
);

1038 ià(
	m´v®
 || 
	mout
) {

1039 
	mp
 = 
İs
.
size
() - 1;

1040 
C_ObjeùO³¿tiÚ_decodew©ch”s
 *
	mh
 =

1041 
Ãw
 
C_ObjeùO³¿tiÚ_decodew©ch”s
(
out
, 
´v®
);

1042 
	mout_hªdËr
[
p
] = 
h
;

1043 
	mout_bl
[
p
] = &
h
->
bl
;

1044 
	mout_rv®
[
p
] = 
´v®
;

1048 
li¡_¢­s
(
lib¿dos
::
¢­_£t_t
 *
out
, *
´v®
) {

1049 ()
add_İ
(
CEPH_OSD_OP_LIST_SNAPS
);

1050 ià(
	m´v®
 || 
	mout
) {

1051 
	mp
 = 
İs
.
size
() - 1;

1052 
C_ObjeùO³¿tiÚ_decode¢­s
 *
	mh
 =

1053 
Ãw
 
C_ObjeùO³¿tiÚ_decode¢­s
(
out
, 
´v®
);

1054 
	mout_hªdËr
[
p
] = 
h
;

1055 
	mout_bl
[
p
] = &
h
->
bl
;

1056 
	mout_rv®
[
p
] = 
´v®
;

1060 
as£¹_v”siÚ
(
ušt64_t
 
v”
) {

1061 
	mOSDOp
& 
	mosd_İ
 = 
add_İ
(
CEPH_OSD_OP_ASSERT_VER
);

1062 
	mosd_İ
.
	mİ
.
	mas£¹_v”
.
	mv”
 = 
v”
;

1065 
cmpx©Œ
(cÚ¡ *
Çme
, cÚ¡ 
bufã¾i¡
& 
v®
,

1066 
İ
, 
mode
) {

1067 
add_x©Œ
(
CEPH_OSD_OP_CMPXATTR
, 
Çme
, 
v®
);

1068 
	mOSDOp
& 
	mo
 = *
İs
.
rbegš
();

1069 
	mo
.
	mİ
.
	mx©Œ
.
	mcmp_İ
 = 
İ
;

1070 
	mo
.
	mİ
.
	mx©Œ
.
	mcmp_mode
 = 
mode
;

1073 
rŞlback
(
ušt64_t
 
¢­id
) {

1074 
	mOSDOp
& 
	mosd_İ
 = 
add_İ
(
CEPH_OSD_OP_ROLLBACK
);

1075 
	mosd_İ
.
	mİ
.
	m¢­
.
	m¢­id
 = 
¢­id
;

1078 
cİy_äom
(
objeù_t
 
¤c
, 
¢­id_t
 
¢­id
, 
objeù_loÿtÜ_t
 
¤c_Şoc
,

1079 
v”siÚ_t
 
¤c_v”siÚ
, 
æags
,

1080 
¤c_çdvi£_æags
) {

1081 
	mOSDOp
& 
	mosd_İ
 = 
add_İ
(
CEPH_OSD_OP_COPY_FROM
);

1082 
	mosd_İ
.
	mİ
.
	mcİy_äom
.
	m¢­id
 = 
¢­id
;

1083 
	mosd_İ
.
	mİ
.
	mcİy_äom
.
	m¤c_v”siÚ
 = 
¤c_v”siÚ
;

1084 
	mosd_İ
.
	mİ
.
	mcİy_äom
.
	mæags
 = 
æags
;

1085 
	mosd_İ
.
	mİ
.
	mcİy_äom
.
	m¤c_çdvi£_æags
 = 
¤c_çdvi£_æags
;

1086 
’code
(
¤c
, 
osd_İ
.
šd©a
);

1087 
’code
(
¤c_Şoc
, 
osd_İ
.
šd©a
);

1100 
ÿche_æush
() {

1101 
add_İ
(
CEPH_OSD_OP_CACHE_FLUSH
);

1115 
ÿche_Œy_æush
() {

1116 
add_İ
(
CEPH_OSD_OP_CACHE_TRY_FLUSH
);

1127 
ÿche_eviù
() {

1128 
add_İ
(
CEPH_OSD_OP_CACHE_EVICT
);

1134 
£t_»dœeù
(
objeù_t
 
tgt
, 
¢­id_t
 
¢­id
, 
objeù_loÿtÜ_t
 
tgt_Şoc
,

1135 
v”siÚ_t
 
tgt_v”siÚ
, 
æag
) {

1136 
	mOSDOp
& 
	mosd_İ
 = 
add_İ
(
CEPH_OSD_OP_SET_REDIRECT
);

1137 
	mosd_İ
.
	mİ
.
	mcİy_äom
.
	m¢­id
 = 
¢­id
;

1138 
	mosd_İ
.
	mİ
.
	mcİy_äom
.
	m¤c_v”siÚ
 = 
tgt_v”siÚ
;

1139 
’code
(
tgt
, 
osd_İ
.
šd©a
);

1140 
’code
(
tgt_Şoc
, 
osd_İ
.
šd©a
);

1141 
£t_Ï¡_İ_æags
(
æag
);

1144 
£t_chunk
(
ušt64_t
 
¤c_off£t
, ušt64_ˆ
¤c_Ëngth
, 
objeù_loÿtÜ_t
 
tgt_Şoc
,

1145 
objeù_t
 
tgt_oid
, 
ušt64_t
 
tgt_off£t
, 
æag
) {

1146 
	mOSDOp
& 
	mosd_İ
 = 
add_İ
(
CEPH_OSD_OP_SET_CHUNK
);

1147 
’code
(
¤c_off£t
, 
osd_İ
.
šd©a
);

1148 
’code
(
¤c_Ëngth
, 
osd_İ
.
šd©a
);

1149 
’code
(
tgt_Şoc
, 
osd_İ
.
šd©a
);

1150 
’code
(
tgt_oid
, 
osd_İ
.
šd©a
);

1151 
’code
(
tgt_off£t
, 
osd_İ
.
šd©a
);

1152 
£t_Ï¡_İ_æags
(
æag
);

1155 
t›r_´omÙe
() {

1156 
add_İ
(
CEPH_OSD_OP_TIER_PROMOTE
);

1159 
£t_®loc_hšt
(
ušt64_t
 
ex³ùed_objeù_size
,

1160 
ušt64_t
 
ex³ùed_wr™e_size
,

1161 
ušt32_t
 
æags
) {

1162 
add_®loc_hšt
(
CEPH_OSD_OP_SETALLOCHINT
, 
ex³ùed_objeù_size
,

1163 
ex³ùed_wr™e_size
, 
æags
);

1168 
£t_Ï¡_İ_æags
(
CEPH_OSD_OP_FLAG_FAILOK
);

1171 
dup
(
veùÜ
<
OSDOp
>& 
sİs
) {

1172 
	mİs
 = 
sİs
;

1173 
	mout_bl
.
»size
(
sİs
.
size
());

1174 
	mout_hªdËr
.
»size
(
sİs
.
size
());

1175 
	mout_rv®
.
»size
(
sİs
.
size
());

1176 
ušt32_t
 
	mi
 = 0; i < 
	msİs
.
size
(); i++) {

1177 
	mout_bl
[
i
] = &
sİs
[i].
outd©a
;

1178 
	mout_hªdËr
[
i
] = 
NULL
;

1179 
	mout_rv®
[
i
] = &
sİs
[i].
rv®
;

1186 
ÿche_pš
() {

1187 
add_İ
(
CEPH_OSD_OP_CACHE_PIN
);

1190 
ÿche_uÅš
() {

1191 
add_İ
(
CEPH_OSD_OP_CACHE_UNPIN
);

1199 
şass
 
	gObjeù”
 : 
public
 
md_cÚfig_obs_t
,…ubliø
	gDi¥©ch”
 {

1200 
	gpublic
:

1202 cÚ¡ ** 
g‘_Œacked_cÚf_keys
(ècÚ¡ 
ov”ride
;

1203 
hªdË_cÚf_chªge
(cÚ¡ 
md_cÚfig_t
 *
cÚf
,

1204 cÚ¡ 
¡d
::
£t
 <¡d::
¡ršg
> &
chªged
è
ov”ride
;

1206 
	gpublic
:

1207 
Mes£ng”
 *
mes£ng”
;

1208 
MÚCl›Á
 *
	gmÚc
;

1209 
Fšish”
 *
	gfšish”
;

1210 
	gZT¿ûr
::
Endpošt
 
Œaû_’dpošt
;

1211 
	g´iv©e
:

1212 
OSDM­
 *
osdm­
;

1213 
	gpublic
:

1214 
usšg
 
Di¥©ch”
::
cù
;

1215 
	g¡d
::
muÉim­
<
¡ršg
,
	g¡ršg
> 
	güush_loÿtiÚ
;

1217 
	g¡d
::
©omic
<
boŞ
> 
š™Ÿlized
{
çl£
};

1219 
	g´iv©e
:

1220 
¡d
::
©omic
<
ušt64_t
> 
Ï¡_tid
{0};

1221 
	g¡d
::
©omic
<> 
šæight_İs
{0};

1222 
	g¡d
::
©omic
<> 
ş›Á_šc
{-1};

1223 
ušt64_t
 
	gmax_lšg”_id
;

1224 
	g¡d
::
©omic
<> 
num_š_æight
{0};

1225 
	g¡d
::
©omic
<> 
glob®_İ_æags
{0};

1226 
boŞ
 
	gk“p_b®ªûd_budg‘
;

1227 
boŞ
 
	ghÚÜ_osdm­_fuÎ
;

1228 
boŞ
 
	gosdm­_fuÎ_Œy
;

1232 
boŞ
 
	gbÏckli¡_ev’ts_’abËd
;

1233 
	g¡d
::
£t
<
’t™y_addr_t
> 
bÏckli¡_ev’ts
;

1235 
	gpublic
:

1236 
maybe_»que¡_m­
();

1238 
’abË_bÏckli¡_ev’ts
();

1239 
	g´iv©e
:

1241 
_maybe_»que¡_m­
();

1243 
v”siÚ_t
 
	gÏ¡_£’_osdm­_v”siÚ
;

1244 
v”siÚ_t
 
	gÏ¡_£’_pgm­_v”siÚ
;

1246 
mubË
 
	g¡d
::
sh¬ed_mu‹x
 
rwlock
;

1247 
usšg
 
	glock_gu¬d
 = 
¡d
::
lock_gu¬d
<
deşty³
(
rwlock
)>;

1248 
usšg
 
	gunique_lock
 = 
¡d
::
unique_lock
<
deşty³
(
rwlock
)>;

1249 
usšg
 
	gsh¬ed_lock
 = 
boo¡
::
sh¬ed_lock
<
deşty³
(
rwlock
)>;

1250 
usšg
 
	gshunique_lock
 = 
ûph
::
shunique_lock
<
deşty³
(
rwlock
)>;

1251 
	gûph
::
tim”
<
ûph
::
cßr£_mÚo_şock
>imer;

1253 
P”fCouÁ”s
 *
	glogg”
;

1255 
ušt64_t
 
	gtick_ev’t
;

1257 
¡¬t_tick
();

1258 
tick
();

1259 
upd©e_üush_loÿtiÚ
();

1261 
şass
 
	gReque¡S‹Hook
;

1263 
Reque¡S‹Hook
 *
	gm_»que¡_¡©e_hook
;

1265 
	gpublic
:

1269 
OSDSessiÚ
;

1271 
	sİ_rg‘_t
 {

1272 
	gæags
 = 0;

1274 
•och_t
 
	g•och
 = 0;

1276 
objeù_t
 
	gba£_oid
;

1277 
objeù_loÿtÜ_t
 
	gba£_Şoc
;

1278 
objeù_t
 
	grg‘_oid
;

1279 
objeù_loÿtÜ_t
 
	grg‘_Şoc
;

1282 
boŞ
 
	g´eÿlc_pgid
 = 
çl£
;

1285 
boŞ
 
	gpoŞ_ev”_exi¡ed
 = 
çl£
;

1288 
pg_t
 
	gba£_pgid
;

1290 
pg_t
 
	gpgid
;

1291 
¥g_t
 
	gaùu®_pgid
;

1292 
	gpg_num
 = 0;

1293 
	gpg_num_mask
 = 0;

1294 
	gveùÜ
<> 
	gup
;

1295 
	gveùÜ
<> 
	gaùšg
;

1296 
	gup_´im¬y
 = -1;

1297 
	gaùšg_´im¬y
 = -1;

1298 
	gsize
 = -1;

1299 
	gmš_size
 = -1;

1300 
boŞ
 
	gsÜt_b™wi£
 = 
çl£
;

1301 
boŞ
 
	g»cov”y_d–‘es
 = 
çl£
;

1303 
boŞ
 
	gu£d_»¶iÿ
 = 
çl£
;

1304 
boŞ
 
	g·u£d
 = 
çl£
;

1306 
	gosd
 = -1;

1308 
•och_t
 
	gÏ¡_fÜû_»£nd
 = 0;

1310 
İ_rg‘_t
(
objeù_t
 
oid
, 
objeù_loÿtÜ_t
 
Şoc
, 
æags
)

1311 : 
æags
(flags),

1312 
ba£_oid
(
oid
),

1313 
ba£_Şoc
(
Şoc
)

1316 
ex¶ic™
 
İ_rg‘_t
(
pg_t
 
pgid
)

1317 : 
ba£_Şoc
(
pgid
.
poŞ
(),…gid.
ps
()),

1318 
´eÿlc_pgid
(
Œue
),

1319 
ba£_pgid
(
pgid
)

1322 
İ_rg‘_t
() = ;

1324 
hobjeù_t
 
g‘_hobj
() {

1325  
hobjeù_t
(
rg‘_oid
,

1326 
rg‘_Şoc
.
key
,

1327 
CEPH_NOSNAP
,

1328 
rg‘_Şoc
.
hash
 >ğ0 ?¬g‘_Şoc.hash : 
pgid
.
ps
(),

1329 
rg‘_Şoc
.
poŞ
,

1330 
rg‘_Şoc
.
n¥aû
);

1333 
boŞ
 
cÚšed_by
(cÚ¡ 
hobjeù_t
& 
begš
, cÚ¡ hobjeù_t& 
’d
) {

1334 
hobjeù_t
 
	gh
 = 
g‘_hobj
();

1335 
	gr
 = 
cmp
(
h
, 
begš
);

1336  
	gr
 =ğ0 || (
r
 > 0 && 
h
 < 
’d
);

1339 
dump
(
FÜm©‹r
 *
f
) const;

1342 
	gOp
 : 
public
 
RefCouÁedObjeù
 {

1343 
OSDSessiÚ
 *
£ssiÚ
;

1344 
	gšÿº©iÚ
;

1346 
İ_rg‘_t
 
	grg‘
;

1348 
CÚÃùiÚRef
 
	gcÚ
;

1349 
ušt64_t
 
	gã©u»s
;

1351 
	gveùÜ
<
	gOSDOp
> 
	gİs
;

1353 
¢­id_t
 
	g¢­id
;

1354 
SÇpCÚ‹xt
 
	g¢­c
;

1355 
	gûph
::
»®_time
 
mtime
;

1357 
bufã¾i¡
 *
	goutbl
;

1358 
	gveùÜ
<
	gbufã¾i¡
*> 
	gout_bl
;

1359 
	gveùÜ
<
	gCÚ‹xt
*> 
	gout_hªdËr
;

1360 
	gveùÜ
<*> 
	gout_rv®
;

1362 
	g´iÜ™y
;

1363 
CÚ‹xt
 *
	gÚfšish
;

1364 
ušt64_t
 
	gÚtimeout
;

1366 
ûph_tid_t
 
	gtid
;

1367 
	g©‹m±s
;

1369 
v”siÚ_t
 *
	gobjv”
;

1370 
•och_t
 *
	g»¶y_•och
;

1372 
	gûph
::
cßr£_mÚo_time
 
¡amp
;

1374 
•och_t
 
	gm­_dÃ_bound
;

1376 
	gbudg‘
;

1379 
boŞ
 
	gshould_»£nd
;

1385 
boŞ
 
	gùx_budg‘ed
;

1387 *
	gd©a_off£t
;

1389 
osd_»qid_t
 
	g»qid
;

1390 
	gZT¿ûr
::
T¿û
 
Œaû
;

1392 
Op
(cÚ¡ 
objeù_t
& 
o
, cÚ¡ 
objeù_loÿtÜ_t
& 
Ş
, 
veùÜ
<
OSDOp
>& 
İ
,

1393 
f
, 
CÚ‹xt
 *
fš
, 
v”siÚ_t
 *
ov
, *
off£t
 = 
NULL
,

1394 
ZT¿ûr
::
T¿û
 *
·»Á_Œaû
 = 
nuÎ±r
) :

1395 
£ssiÚ
(
NULL
), 
šÿº©iÚ
(0),

1396 
rg‘
(
o
, 
Ş
, 
f
),

1397 
cÚ
(
NULL
),

1398 
ã©u»s
(
CEPH_FEATURES_SUPPORTED_DEFAULT
),

1399 
¢­id
(
CEPH_NOSNAP
),

1400 
outbl
(
NULL
),

1401 
´iÜ™y
(0),

1402 
Úfšish
(
fš
),

1403 
Útimeout
(0),

1404 
tid
(0),

1405 
©‹m±s
(0),

1406 
objv”
(
ov
),

1407 
»¶y_•och
(
NULL
),

1408 
m­_dÃ_bound
(0),

1409 
budg‘
(-1),

1410 
should_»£nd
(
Œue
),

1411 
ùx_budg‘ed
(
çl£
),

1412 
d©a_off£t
(
off£t
) {

1413 
	gİs
.
sw­
(
İ
);

1416 
	gout_bl
.
»size
(
İs
.
size
());

1417 
	gout_rv®
.
»size
(
İs
.
size
());

1418 
	gout_hªdËr
.
»size
(
İs
.
size
());

1419 
	gi
 = 0; i < 
	gİs
.
size
(); i++) {

1420 
	gout_bl
[
i
] = 
NULL
;

1421 
	gout_hªdËr
[
i
] = 
NULL
;

1422 
	gout_rv®
[
i
] = 
NULL
;

1425 ià(
	grg‘
.
	gba£_Şoc
.
	gkey
 =ğ
o
)

1426 
rg‘
.
ba£_Şoc
.
key
.
ş—r
();

1428 ià(
	g·»Á_Œaû
 &&…¬’t_Œaû->
v®id
()) {

1429 
	gŒaû
.
š™
("İ", 
nuÎ±r
, 
·»Á_Œaû
);

1430 
	gŒaû
.
ev’t
("start");

1434 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	gOp
& 
	gÙh”
) const {

1435  
	gtid
 < 
	gÙh”
.tid;

1438 
boŞ
 
»¥eùs_fuÎ
() const {

1440 (
	grg‘
.
	gæags
 & (
	gCEPH_OSD_FLAG_WRITE
 | 
	gCEPH_OSD_FLAG_RWORDERED
)) &&

1441 !(
	grg‘
.
	gæags
 & (
	gCEPH_OSD_FLAG_FULL_TRY
 | 
	gCEPH_OSD_FLAG_FULL_FORCE
));

1444 
	g´iv©e
:

1445 ~
Op
(è
ov”ride
 {

1446 !
out_hªdËr
.
em±y
()) {

1447 
d–‘e
 
out_hªdËr
.
back
();

1448 
	gout_hªdËr
.
pİ_back
();

1450 
	gŒaû
.
ev’t
("finish");

1454 
	gC_Op_M­_L©e¡
 : 
public
 
CÚ‹xt
 {

1455 
Objeù”
 *
objeù”
;

1456 
ûph_tid_t
 
	gtid
;

1457 
v”siÚ_t
 
	gÏ‹¡
;

1458 
C_Op_M­_L©e¡
(
Objeù”
 *
o
, 
ûph_tid_t
 
t
è: 
objeù”
(o), 
tid
(t),

1459 
Ï‹¡
(0) {}

1460 
fšish
(
r
è
	gov”ride
;

1463 
	gC_Commªd_M­_L©e¡
 : 
public
 
CÚ‹xt
 {

1464 
Objeù”
 *
objeù”
;

1465 
ušt64_t
 
	gtid
;

1466 
v”siÚ_t
 
	gÏ‹¡
;

1467 
C_Commªd_M­_L©e¡
(
Objeù”
 *
o
, 
ûph_tid_t
 
t
è: 
objeù”
(o), 
tid
(t),

1468 
Ï‹¡
(0) {}

1469 
fšish
(
r
è
	gov”ride
;

1472 
	gC_St
 : 
public
 
CÚ‹xt
 {

1473 
bufã¾i¡
 
bl
;

1474 
ušt64_t
 *
	gpsize
;

1475 
	gûph
::
»®_time
 *
pmtime
;

1476 
CÚ‹xt
 *
	gfš
;

1477 
C_St
(
ušt64_t
 *
ps
, 
ûph
::
»®_time
 *
pm
, 
CÚ‹xt
 *
c
) :

1478 
psize
(
ps
), 
pmtime
(
pm
), 
fš
(
c
) {}

1479 
fšish
(
r
è
	gov”ride
 {

1480 ià(
	gr
 >= 0) {

1481 
bufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
begš
();

1482 
ušt64_t
 
	gs
;

1483 
	gûph
::
»®_time
 
m
;

1484 
decode
(
s
, 
p
);

1485 
decode
(
m
, 
p
);

1486 ià(
	gpsize
)

1487 *
	gpsize
 = 
s
;

1488 ià(
	gpmtime
)

1489 *
	gpmtime
 = 
m
;

1491 
	gfš
->
com¶‘e
(
r
);

1495 
	gC_G‘A‰rs
 : 
public
 
CÚ‹xt
 {

1496 
bufã¾i¡
 
bl
;

1497 
	gm­
<
	g¡ršg
,
	gbufã¾i¡
>& 
	g©Œ£t
;

1498 
CÚ‹xt
 *
	gfš
;

1499 
C_G‘A‰rs
(
m­
<
¡ršg
, 
bufã¾i¡
>& 
£t
, 
CÚ‹xt
 *
c
è: 
©Œ£t
(set),

1500 
fš
(
c
) {}

1501 
fšish
(
r
è
	gov”ride
 {

1502 ià(
	gr
 >= 0) {

1503 
bufã¾i¡
::
™”©Ü
 
p
 = 
bl
.
begš
();

1504 
decode
(
©Œ£t
, 
p
);

1506 
	gfš
->
com¶‘e
(
r
);

1512 
	sNLi¡CÚ‹xt
 {

1513 
cŞËùiÚ_li¡_hªdË_t
 
	gpos
;

1516 
	gcu¼’t_pg
 = 0;

1517 
	g¡¬tšg_pg_num
 = 0;

1518 
boŞ
 
	gsÜt_b™wi£
 = 
çl£
;

1520 
boŞ
 
	g©_’d_of_poŞ
 = 
çl£
;

1522 
št64_t
 
	gpoŞ_id
 = -1;

1523 
	gpoŞ_¢­_£q
 = 0;

1524 
ušt64_t
 
	gmax_’Œ›s
 = 0;

1525 
¡ršg
 
	gn¥aû
;

1527 
bufã¾i¡
 
	gbl
;

1528 
	g¡d
::
li¡
<
lib¿dos
::
Li¡ObjeùIm¶
>†ist;

1530 
bufã¾i¡
 
	gf‹r
;

1532 
bufã¾i¡
 
	gexŒa_šfo
;

1538 
	gùx_budg‘
 = -1;

1540 
boŞ
 
©_’d
() const {

1541  
	g©_’d_of_poŞ
;

1544 
ušt32_t
 
g‘_pg_hash_pos™iÚ
() const {

1545  
	gpos
.
g‘_hash
();

1549 
	gC_NLi¡
 : 
public
 
CÚ‹xt
 {

1550 
NLi¡CÚ‹xt
 *
li¡_cÚ‹xt
;

1551 
CÚ‹xt
 *
	gfš®_fšish
;

1552 
Objeù”
 *
	gobjeù”
;

1553 
•och_t
 
	g•och
;

1554 
C_NLi¡
(
NLi¡CÚ‹xt
 *
lc
, 
CÚ‹xt
 * 
fšish
, 
Objeù”
 *
ob
) :

1555 
li¡_cÚ‹xt
(
lc
), 
fš®_fšish
(
fšish
), 
objeù”
(
ob
), 
•och
(0) {}

1556 
fšish
(
r
è
	gov”ride
 {

1557 ià(
	gr
 >= 0) {

1558 
objeù”
->
_Æi¡_»¶y
(
li¡_cÚ‹xt
, 
r
, 
fš®_fšish
, 
•och
);

1560 
	gfš®_fšish
->
com¶‘e
(
r
);

1565 
	sPoŞStOp
 {

1566 
ûph_tid_t
 
	gtid
;

1567 
	gli¡
<
	g¡ršg
> 
	gpoŞs
;

1569 
	gm­
<
	g¡ršg
,
	gpoŞ_¡©_t
> *
	gpoŞ_¡©s
;

1570 
CÚ‹xt
 *
	gÚfšish
;

1571 
ušt64_t
 
	gÚtimeout
;

1573 
	gûph
::
cßr£_mÚo_time
 
Ï¡_subm™
;

1576 
	sStfsOp
 {

1577 
ûph_tid_t
 
	gtid
;

1578 
ûph_¡©fs
 *
	g¡©s
;

1579 
	gboo¡
::
İtiÚ®
<
št64_t
> 
d©a_poŞ
;

1580 
CÚ‹xt
 *
	gÚfšish
;

1581 
ušt64_t
 
	gÚtimeout
;

1583 
	gûph
::
cßr£_mÚo_time
 
Ï¡_subm™
;

1586 
	sPoŞOp
 {

1587 
ûph_tid_t
 
	gtid
;

1588 
št64_t
 
	gpoŞ
;

1589 
¡ršg
 
	gÇme
;

1590 
CÚ‹xt
 *
	gÚfšish
;

1591 
ušt64_t
 
	gÚtimeout
;

1592 
	gpoŞ_İ
;

1593 
ušt64_t
 
	gauid
;

1594 
št16_t
 
	güush_ruË
;

1595 
¢­id_t
 
	g¢­id
;

1596 
bufã¾i¡
 *
	gbÍ
;

1598 
	gûph
::
cßr£_mÚo_time
 
Ï¡_subm™
;

1599 
PoŞOp
(è: 
tid
(0), 
poŞ
(0), 
Úfšish
(
NULL
), 
Útimeout
(0), 
poŞ_İ
(0),

1600 
auid
(0), 
üush_ruË
(0), 
¢­id
(0), 
bÍ
(
NULL
) {}

1604 
	gCommªdOp
 : 
public
 
RefCouÁedObjeù
 {

1605 
OSDSessiÚ
 *
£ssiÚ
 = 
nuÎ±r
;

1606 
ûph_tid_t
 
	gtid
 = 0;

1607 
	gveùÜ
<
	g¡ršg
> 
	gcmd
;

1608 
bufã¾i¡
 
	gšbl
;

1609 
bufã¾i¡
 *
	gpoutbl
 = 
nuÎ±r
;

1610 
¡ršg
 *
	g´s
 = 
nuÎ±r
;

1613 cÚ¡ 
	grg‘_osd
 = -1;

1614 cÚ¡ 
pg_t
 
	grg‘_pg
;

1616 
İ_rg‘_t
 
	grg‘
;

1618 
•och_t
 
	gm­_dÃ_bound
 = 0;

1619 
	gm­_check_”rÜ
 = 0;

1620 cÚ¡ *
	gm­_check_”rÜ_¡r
 = 
nuÎ±r
;

1622 
CÚ‹xt
 *
	gÚfšish
 = 
nuÎ±r
;

1623 
ušt64_t
 
	gÚtimeout
 = 0;

1624 
	gûph
::
cßr£_mÚo_time
 
Ï¡_subm™
;

1626 
CommªdOp
(

1627 
rg‘_osd
,

1628 cÚ¡ 
veùÜ
<
¡ršg
> &
cmd
,

1629 
bufã¾i¡
 
šbl
,

1630 
bufã¾i¡
 *
poutbl
,

1631 
¡ršg
 *
´s
,

1632 
CÚ‹xt
 *
Úfšish
)

1633 : 
cmd
(cmd),

1634 
šbl
(inbl),

1635 
poutbl
(poutbl),

1636 
´s
(prs),

1637 
rg‘_osd
(target_osd),

1638 
Úfšish
(onfinish) {}

1640 
CommªdOp
(

1641 
pg_t
 
pgid
,

1642 cÚ¡ 
veùÜ
<
¡ršg
> &
cmd
,

1643 
bufã¾i¡
 
šbl
,

1644 
bufã¾i¡
 *
poutbl
,

1645 
¡ršg
 *
´s
,

1646 
CÚ‹xt
 *
Úfšish
)

1647 : 
cmd
(cmd),

1648 
šbl
(inbl),

1649 
poutbl
(poutbl),

1650 
´s
(prs),

1651 
rg‘_pg
(
pgid
),

1652 
rg‘
(
pgid
),

1653 
Úfšish
(onfinish) {}

1657 
subm™_commªd
(
CommªdOp
 *
c
, 
ûph_tid_t
 *
±id
);

1658 
_ÿlc_commªd_rg‘
(
CommªdOp
 *
c
, 
shunique_lock
 &
sul
);

1659 
_assign_commªd_£ssiÚ
(
CommªdOp
 *
c
, 
shunique_lock
 &
sul
);

1660 
_£nd_commªd
(
CommªdOp
 *
c
);

1661 
commªd_İ_ÿnûl
(
OSDSessiÚ
 *
s
, 
ûph_tid_t
 
tid
, 
r
);

1662 
_fšish_commªd
(
CommªdOp
 *
c
, 
r
, 
¡ršg
 
rs
);

1663 
hªdË_commªd_»¶y
(
MCommªdR•ly
 *
m
);

1668 
	sW©chCÚ‹xt
 {

1670 
vœtu®
 
hªdË_nÙify
(
ušt64_t
 
nÙify_id
,

1671 
ušt64_t
 
cook›
,

1672 
ušt64_t
 
nÙif›r_id
,

1673 
bufã¾i¡
& 
bl
) = 0;

1674 
vœtu®
 
hªdË_”rÜ
(
ušt64_t
 
cook›
, 
”r
) = 0;

1675 
	gvœtu®
 ~
W©chCÚ‹xt
() {}

1678 
	gLšg”Op
 : 
public
 
RefCouÁedObjeù
 {

1679 
ušt64_t
 
lšg”_id
;

1681 
İ_rg‘_t
 
	grg‘
;

1683 
¢­id_t
 
	g¢­
;

1684 
SÇpCÚ‹xt
 
	g¢­c
;

1685 
	gûph
::
»®_time
 
mtime
;

1687 
	gveùÜ
<
	gOSDOp
> 
	gİs
;

1688 
bufã¾i¡
 
	gšbl
;

1689 
bufã¾i¡
 *
	gpoutbl
;

1690 
v”siÚ_t
 *
	gpobjv”
;

1692 
boŞ
 
	gis_w©ch
;

1693 
	gûph
::
cßr£_mÚo_time
 
w©ch_v®id_thru
;

1694 
	gÏ¡_”rÜ
;

1695 
	g¡d
::
sh¬ed_mu‹x
 
w©ch_lock
;

1696 
usšg
 
	glock_gu¬d
 = 
¡d
::
unique_lock
<
deşty³
(
w©ch_lock
)>;

1697 
usšg
 
	gunique_lock
 = 
¡d
::
unique_lock
<
deşty³
(
w©ch_lock
)>;

1698 
usšg
 
	gsh¬ed_lock
 = 
boo¡
::
sh¬ed_lock
<
deşty³
(
w©ch_lock
)>;

1699 
usšg
 
	gshunique_lock
 = 
ûph
::
shunique_lock
<
deşty³
(
w©ch_lock
)>;

1703 
	gli¡
<
	gûph
::
cßr£_mÚo_time
> 
w©ch_³ndšg_async
;

1705 
ušt32_t
 
	g»gi¡”_g’
;

1706 
boŞ
 
	g»gi¡”ed
;

1707 
boŞ
 
	gÿnûËd
;

1708 
CÚ‹xt
 *
	gÚ_»g_comm™
;

1711 
CÚ‹xt
 *
	gÚ_nÙify_fšish
;

1712 
bufã¾i¡
 *
	gnÙify_»suÉ_bl
;

1713 
ušt64_t
 
	gnÙify_id
;

1715 
W©chCÚ‹xt
 *
	gw©ch_cÚ‹xt
;

1717 
OSDSessiÚ
 *
	g£ssiÚ
;

1719 
Objeù”
 *
	gobjeù”
;

1720 
	gùx_budg‘
;

1721 
ûph_tid_t
 
	g»gi¡”_tid
;

1722 
ûph_tid_t
 
	gpšg_tid
;

1723 
•och_t
 
	gm­_dÃ_bound
;

1725 
_queued_async
() {

1727 
	gw©ch_³ndšg_async
.
push_back
(
ûph
::
cßr£_mÚo_şock
::
now
());

1729 
fšished_async
() {

1730 
unique_lock
 
l
(
w©ch_lock
);

1731 
as£¹
(!
w©ch_³ndšg_async
.
em±y
());

1732 
	gw©ch_³ndšg_async
.
pİ_äÚt
();

1735 
ex¶ic™
 
Lšg”Op
(
Objeù”
 *
o
è: 
lšg”_id
(0),

1736 
rg‘
(
objeù_t
(), 
objeù_loÿtÜ_t
(), 0),

1737 
¢­
(
CEPH_NOSNAP
), 
poutbl
(
NULL
), 
pobjv”
(NULL),

1738 
is_w©ch
(
çl£
), 
Ï¡_”rÜ
(0),

1739 
»gi¡”_g’
(0),

1740 
»gi¡”ed
(
çl£
),

1741 
ÿnûËd
(
çl£
),

1742 
Ú_»g_comm™
(
NULL
),

1743 
Ú_nÙify_fšish
(
NULL
),

1744 
nÙify_»suÉ_bl
(
NULL
),

1745 
nÙify_id
(0),

1746 
w©ch_cÚ‹xt
(
NULL
),

1747 
£ssiÚ
(
NULL
),

1748 
objeù”
(
o
),

1749 
ùx_budg‘
(-1),

1750 
»gi¡”_tid
(0),

1751 
pšg_tid
(0),

1752 
m­_dÃ_bound
(0) {}

1754 cÚ¡ 
	gLšg”Op
 &
	gİ”©Ü
=(cÚ¡ 
Lšg”Op
& 
r
èğ
d–‘e
;

1755 
Lšg”Op
(cÚ¡ Lšg”Op& 
o
èğ
d–‘e
;

1757 
ušt64_t
 
g‘_cook›
() {

1758  
	g»š‹½»t_ÿ¡
<
	gušt64_t
>(
	gthis
);

1761 
	g´iv©e
:

1762 ~
Lšg”Op
(è
ov”ride
 {

1763 
d–‘e
 
w©ch_cÚ‹xt
;

1767 
	gC_Lšg”_Comm™
 : 
public
 
CÚ‹xt
 {

1768 
Objeù”
 *
objeù”
;

1769 
Lšg”Op
 *
	gšfo
;

1770 
bufã¾i¡
 
	goutbl
;

1771 
C_Lšg”_Comm™
(
Objeù”
 *
o
, 
Lšg”Op
 *
l
è: 
objeù”
(o), 
šfo
(l) {

1772 
	gšfo
->
g‘
();

1774 ~
C_Lšg”_Comm™
(è
	gov”ride
 {

1775 
	gšfo
->
put
();

1777 
fšish
(
r
è
	gov”ride
 {

1778 
	gobjeù”
->
_lšg”_comm™
(
šfo
, 
r
, 
outbl
);

1782 
	gC_Lšg”_RecÚÃù
 : 
public
 
CÚ‹xt
 {

1783 
Objeù”
 *
objeù”
;

1784 
Lšg”Op
 *
	gšfo
;

1785 
C_Lšg”_RecÚÃù
(
Objeù”
 *
o
, 
Lšg”Op
 *
l
è: 
objeù”
(o), 
šfo
(l) {

1786 
	gšfo
->
g‘
();

1788 ~
C_Lšg”_RecÚÃù
(è
	gov”ride
 {

1789 
	gšfo
->
put
();

1791 
fšish
(
r
è
	gov”ride
 {

1792 
	gobjeù”
->
_lšg”_»cÚÃù
(
šfo
, 
r
);

1796 
	gC_Lšg”_Pšg
 : 
public
 
CÚ‹xt
 {

1797 
Objeù”
 *
objeù”
;

1798 
Lšg”Op
 *
	gšfo
;

1799 
	gûph
::
cßr£_mÚo_time
 
£Á
;

1800 
ušt32_t
 
	g»gi¡”_g’
;

1801 
C_Lšg”_Pšg
(
Objeù”
 *
o
, 
Lšg”Op
 *
l
)

1802 : 
objeù”
(
o
), 
šfo
(
l
), 
»gi¡”_g’
(info->register_gen) {

1803 
	gšfo
->
g‘
();

1805 ~
C_Lšg”_Pšg
(è
	gov”ride
 {

1806 
	gšfo
->
put
();

1808 
fšish
(
r
è
	gov”ride
 {

1809 
	gobjeù”
->
_lšg”_pšg
(
šfo
, 
r
, 
£Á
, 
»gi¡”_g’
);

1813 
	gC_Lšg”_M­_L©e¡
 : 
public
 
CÚ‹xt
 {

1814 
Objeù”
 *
objeù”
;

1815 
ušt64_t
 
	glšg”_id
;

1816 
v”siÚ_t
 
	gÏ‹¡
;

1817 
C_Lšg”_M­_L©e¡
(
Objeù”
 *
o
, 
ušt64_t
 
id
) :

1818 
objeù”
(
o
), 
lšg”_id
(
id
), 
Ï‹¡
(0) {}

1819 
fšish
(
r
è
	gov”ride
;

1823 
	sOSDBackoff
 {

1824 
¥g_t
 
	gpgid
;

1825 
ušt64_t
 
	gid
;

1826 
hobjeù_t
 
	gbegš
, 
	g’d
;

1829 
	gOSDSessiÚ
 : 
public
 
RefCouÁedObjeù
 {

1830 
¡d
::
sh¬ed_mu‹x
 
lock
;

1831 
usšg
 
	glock_gu¬d
 = 
¡d
::
lock_gu¬d
<
deşty³
(
lock
)>;

1832 
usšg
 
	gunique_lock
 = 
¡d
::
unique_lock
<
deşty³
(
lock
)>;

1833 
usšg
 
	gsh¬ed_lock
 = 
boo¡
::
sh¬ed_lock
<
deşty³
(
lock
)>;

1834 
usšg
 
	gshunique_lock
 = 
ûph
::
shunique_lock
<
deşty³
(
lock
)>;

1837 
	gm­
<
	gûph_tid_t
,
	gOp
*> 
	gİs
;

1838 
	gm­
<
	gušt64_t
, 
	gLšg”Op
*> 
	glšg”_İs
;

1839 
	gm­
<
	gûph_tid_t
,
	gCommªdOp
*> 
	gcommªd_İs
;

1842 
	gm­
<
	g¥g_t
,m­<
	ghobjeù_t
,
	gOSDBackoff
>> 
	gbackoffs
;

1843 
	gm­
<
	gušt64_t
,
	gOSDBackoff
*> 
	gbackoffs_by_id
;

1845 
	gosd
;

1846 
	gšÿº©iÚ
;

1847 
CÚÃùiÚRef
 
	gcÚ
;

1848 
	gnum_locks
;

1849 
	g¡d
::
unique_±r
<
¡d
::
mu‹x
[]> 
com¶‘iÚ_locks
;

1850 
usšg
 
	gunique_com¶‘iÚ_lock
 = 
¡d
::
unique_lock
<

1851 
deşty³
(
com¶‘iÚ_locks
)::
–em’t_ty³
>;

1854 
OSDSessiÚ
(
C•hCÚ‹xt
 *
cù
, 
o
) :

1855 
osd
(
o
), 
šÿº©iÚ
(0), 
cÚ
(
NULL
),

1856 
num_locks
(
cù
->
_cÚf
->
objeù”_com¶‘iÚ_locks_³r_£ssiÚ
),

1857 
com¶‘iÚ_locks
(
Ãw
 
¡d
::
mu‹x
[
num_locks
]) {}

1859 ~
OSDSessiÚ
(è
ov”ride
;

1861 
boŞ
 
is_hom–ess
(è{  (
	gosd
 == -1); }

1863 
unique_com¶‘iÚ_lock
 
g‘_lock
(
objeù_t
& 
oid
);

1865 
	gm­
<,
	gOSDSessiÚ
*> 
	gosd_£ssiÚs
;

1867 
boŞ
 
osdm­_fuÎ_æag
() const;

1868 
boŞ
 
osdm­_poŞ_fuÎ
(cÚ¡ 
št64_t
 
poŞ_id
) const;

1870 
	g´iv©e
:

1878 
boŞ
 
_osdm­_poŞ_fuÎ
(cÚ¡ 
št64_t
 
poŞ_id
) const;

1879 
boŞ
 
_osdm­_poŞ_fuÎ
(cÚ¡ 
pg_poŞ_t
 &
p
) const;

1880 
upd©e_poŞ_fuÎ_m­
(
m­
<
št64_t
, 
boŞ
>& 
poŞ_fuÎ_m­
);

1882 
	gm­
<
	gušt64_t
, 
	gLšg”Op
*> 
	glšg”_İs
;

1884 
	g£t
<
	gLšg”Op
*> 
	glšg”_İs_£t
;

1886 
	gm­
<
	gûph_tid_t
,
	gPoŞStOp
*> 
	gpoŞ¡©_İs
;

1887 
	gm­
<
	gûph_tid_t
,
	gStfsOp
*> 
	g¡©fs_İs
;

1888 
	gm­
<
	gûph_tid_t
,
	gPoŞOp
*> 
	gpoŞ_İs
;

1889 
	g¡d
::
©omic
<> 
num_hom–ess_İs
{0};

1891 
OSDSessiÚ
 *
	ghom–ess_£ssiÚ
;

1895 
	gm­
<
	gušt64_t
, 
	gLšg”Op
*> 
	gcheck_Ï‹¡_m­_lšg”s
;

1896 
	gm­
<
	gûph_tid_t
, 
	gOp
*> 
	gcheck_Ï‹¡_m­_İs
;

1897 
	gm­
<
	gûph_tid_t
, 
	gCommªdOp
*> 
	gcheck_Ï‹¡_m­_commªds
;

1899 
	gm­
<
	g•och_t
,
	gli¡
< 
	g·œ
<
	gCÚ‹xt
*, > > > 
	gwa™šg_fÜ_m­
;

1901 
	gûph
::
time¥ª
 
mÚ_timeout
;

1902 
	gûph
::
time¥ª
 
osd_timeout
;

1904 
MOSDOp
 *
_´•¬e_osd_İ
(
Op
 *
İ
);

1905 
_£nd_İ
(
Op
 *
İ
);

1906 
_£nd_İ_accouÁ
(
Op
 *
İ
);

1907 
_ÿnûl_lšg”_İ
(
Op
 *
İ
);

1908 
fšish_İ
(
OSDSessiÚ
 *
£ssiÚ
, 
ûph_tid_t
 
tid
);

1909 
_fšish_İ
(
Op
 *
İ
, 
r
);

1910 
boŞ
 
is_pg_chªged
(

1911 
Şd´im¬y
,

1912 cÚ¡ 
veùÜ
<>& 
Şdaùšg
,

1913 
Ãw´im¬y
,

1914 cÚ¡ 
veùÜ
<>& 
Ãwaùšg
,

1915 
boŞ
 
ªy_chªge
=
çl£
);

1916 
	e»ÿlc_İ_rg‘_»suÉ
 {

1917 
	gRECALC_OP_TARGET_NO_ACTION
 = 0,

1918 
	gRECALC_OP_TARGET_NEED_RESEND
,

1919 
	gRECALC_OP_TARGET_POOL_DNE
,

1920 
	gRECALC_OP_TARGET_OSD_DNE
,

1921 
	gRECALC_OP_TARGET_OSD_DOWN
,

1923 
boŞ
 
_osdm­_fuÎ_æag
() const;

1924 
boŞ
 
_osdm­_has_poŞ_fuÎ
() const;

1925 
_´uÃ_¢­c
(

1926 cÚ¡ 
mempoŞ
::
osdm­
::
m­
<
št64_t
, 
OSDM­
::
¢­_š‹rv®_£t_t
>& 
Ãw_»moved_¢­s
,

1927 
Op
 *
İ
);

1929 
boŞ
 
rg‘_should_be_·u£d
(
İ_rg‘_t
 *
İ
);

1930 
_ÿlc_rg‘
(
İ_rg‘_t
 *
t
, 
CÚÃùiÚ
 *
cÚ
,

1931 
boŞ
 
ªy_chªge
 = 
çl£
);

1932 
_m­_£ssiÚ
(
İ_rg‘_t
 *
İ
, 
OSDSessiÚ
 **
s
,

1933 
shunique_lock
& 
lc
);

1935 
_£ssiÚ_İ_assign
(
OSDSessiÚ
 *
s
, 
Op
 *
İ
);

1936 
_£ssiÚ_İ_»move
(
OSDSessiÚ
 *
s
, 
Op
 *
İ
);

1937 
_£ssiÚ_lšg”_İ_assign
(
OSDSessiÚ
 *
to
, 
Lšg”Op
 *
İ
);

1938 
_£ssiÚ_lšg”_İ_»move
(
OSDSessiÚ
 *
äom
, 
Lšg”Op
 *
İ
);

1939 
_£ssiÚ_commªd_İ_assign
(
OSDSessiÚ
 *
to
, 
CommªdOp
 *
İ
);

1940 
_£ssiÚ_commªd_İ_»move
(
OSDSessiÚ
 *
äom
, 
CommªdOp
 *
İ
);

1942 
_assign_İ_rg‘_£ssiÚ
(
Op
 *
İ
, 
shunique_lock
& 
lc
,

1943 
boŞ
 
¤c_£ssiÚ_locked
,

1944 
boŞ
 
d¡_£ssiÚ_locked
);

1945 
_»ÿlc_lšg”_İ_rg‘
(
Lšg”Op
 *
İ
, 
shunique_lock
& 
lc
);

1947 
_lšg”_subm™
(
Lšg”Op
 *
šfo
, 
shunique_lock
& 
sul
);

1948 
_£nd_lšg”
(
Lšg”Op
 *
šfo
, 
shunique_lock
& 
sul
);

1949 
_lšg”_comm™
(
Lšg”Op
 *
šfo
, 
r
, 
bufã¾i¡
& 
outbl
);

1950 
_lšg”_»cÚÃù
(
Lšg”Op
 *
šfo
, 
r
);

1951 
_£nd_lšg”_pšg
(
Lšg”Op
 *
šfo
);

1952 
_lšg”_pšg
(
Lšg”Op
 *
šfo
, 
r
, 
ûph
::
cßr£_mÚo_time
 
£Á
,

1953 
ušt32_t
 
»gi¡”_g’
);

1954 
_nÜm®ize_w©ch_”rÜ
(
r
);

1956 
ä›nd
 
şass
 
	gC_DoW©chE¼Ü
;

1957 
	gpublic
:

1958 
lšg”_ÿÎback_æush
(
CÚ‹xt
 *
ùx
) {

1959 
fšish”
->
queue
(
ùx
);

1962 
	g´iv©e
:

1963 
_check_İ_poŞ_dÃ
(
Op
 *
İ
, 
unique_lock
 *
¦
);

1964 
_£nd_İ_m­_check
(
Op
 *
İ
);

1965 
_İ_ÿnûl_m­_check
(
Op
 *
İ
);

1966 
_check_lšg”_poŞ_dÃ
(
Lšg”Op
 *
İ
, 
boŞ
 *
Ãed_uÄegi¡”
);

1967 
_£nd_lšg”_m­_check
(
Lšg”Op
 *
İ
);

1968 
_lšg”_ÿnûl_m­_check
(
Lšg”Op
 *
İ
);

1969 
_check_commªd_m­_dÃ
(
CommªdOp
 *
İ
);

1970 
_£nd_commªd_m­_check
(
CommªdOp
 *
İ
);

1971 
_commªd_ÿnûl_m­_check
(
CommªdOp
 *
İ
);

1973 
_kick_»que¡s
(
OSDSessiÚ
 *
£ssiÚ
, 
m­
<
ušt64_t
, 
Lšg”Op
 *>& 
Ìe£nd
);

1974 
_lšg”_İs_»£nd
(
m­
<
ušt64_t
, 
Lšg”Op
 *>& 
Ìe£nd
, 
unique_lock
& 
ul
);

1976 
_g‘_£ssiÚ
(
osd
, 
OSDSessiÚ
 **
£ssiÚ
, 
shunique_lock
& 
sul
);

1977 
put_£ssiÚ
(
OSDSessiÚ
 *
s
);

1978 
g‘_£ssiÚ
(
OSDSessiÚ
 *
s
);

1979 
_»İ’_£ssiÚ
(
OSDSessiÚ
 *
£ssiÚ
);

1980 
şo£_£ssiÚ
(
OSDSessiÚ
 *
£ssiÚ
);

1982 
_Æi¡_»¶y
(
NLi¡CÚ‹xt
 *
li¡_cÚ‹xt
, 
r
, 
CÚ‹xt
 *
fš®_fšish
,

1983 
•och_t
 
»¶y_•och
);

1985 
»£nd_mÚ_İs
();

1993 
ÿlc_İ_budg‘
(cÚ¡ 
veùÜ
<
OSDOp
>& 
İs
);

1994 
_thrÙe_İ
(
Op
 *
İ
, 
shunique_lock
& 
sul
, 
İ_size
 = 0);

1995 
_ke_İ_budg‘
(
Op
 *
İ
, 
shunique_lock
& 
sul
) {

1996 
as£¹
(
sul
 && sul.
mu‹x
(è=ğ&
rwlock
);

1997 
	gİ_budg‘
 = 
ÿlc_İ_budg‘
(
İ
->
İs
);

1998 ià(
	gk“p_b®ªûd_budg‘
) {

1999 
_thrÙe_İ
(
İ
, 
sul
, 
İ_budg‘
);

2001 
	gİ_thrÙe_by‹s
.
ke
(
İ_budg‘
);

2002 
	gİ_thrÙe_İs
.
ke
(1);

2004 
	gİ
->
	gbudg‘
 = 
İ_budg‘
;

2005  
	gİ_budg‘
;

2007 
ke_lšg”_budg‘
(
Lšg”Op
 *
šfo
);

2008 
ä›nd
 
şass
 
	gW©chCÚ‹xt
;

2009 
put_İ_budg‘_by‹s
(
İ_budg‘
) {

2010 
as£¹
(
İ_budg‘
 >= 0);

2011 
	gİ_thrÙe_by‹s
.
put
(
İ_budg‘
);

2012 
	gİ_thrÙe_İs
.
put
(1);

2014 
put_Æi¡_cÚ‹xt_budg‘
(
NLi¡CÚ‹xt
 *
li¡_cÚ‹xt
);

2015 
ThrÙe
 
	gİ_thrÙe_by‹s
, 
	gİ_thrÙe_İs
;

2017 
	gpublic
:

2018 
Objeù”
(
C•hCÚ‹xt
 *
cù_
, 
Mes£ng”
 *
m
, 
MÚCl›Á
 *
mc
,

2019 
Fšish”
 *
fš
,

2020 
mÚ_timeout
,

2021 
osd_timeout
) :

2022 
Di¥©ch”
(
cù_
), 
mes£ng”
(
m
), 
mÚc
(
mc
), 
fšish”
(
fš
),

2023 
Œaû_’dpošt
("0.0.0.0", 0, "Objecter"),

2024 
osdm­
(
Ãw
 
OSDM­
),

2025 
max_lšg”_id
(0),

2026 
k“p_b®ªûd_budg‘
(
çl£
), 
hÚÜ_osdm­_fuÎ
(
Œue
), 
osdm­_fuÎ_Œy
(false),

2027 
bÏckli¡_ev’ts_’abËd
(
çl£
),

2028 
Ï¡_£’_osdm­_v”siÚ
(0), 
Ï¡_£’_pgm­_v”siÚ
(0),

2029 
logg”
(
NULL
), 
tick_ev’t
(0), 
m_»que¡_¡©e_hook
(NULL),

2030 
hom–ess_£ssiÚ
(
Ãw
 
OSDSessiÚ
(
cù
, -1)),

2031 
mÚ_timeout
(
ûph
::
make_time¥ª
(mon_timeout)),

2032 
osd_timeout
(
ûph
::
make_time¥ª
(osd_timeout)),

2033 
İ_thrÙe_by‹s
(
cù
, "objecter_bytes",

2034 
cù
->
_cÚf
->
objeù”_šæight_İ_by‹s
),

2035 
İ_thrÙe_İs
(
cù
, "objeù”_İs", cù->
_cÚf
->
objeù”_šæight_İs
),

2036 
•och_b¬r›r
(0),

2037 
»Œy_wr™es_aá”_fœ¡_»¶y
(
cù
->
_cÚf
->
objeù”_»Œy_wr™es_aá”_fœ¡_»¶y
)

2039 ~
Objeù”
(è
	gov”ride
;

2041 
š™
();

2042 
¡¬t
(cÚ¡ 
OSDM­
 *
o
 = 
nuÎ±r
);

2043 
shutdown
();

2057 
	g‹m¶©e
<
ty³Çme
 
	gC®lback
, 
	gty³Çme
...
	gArgs
>

2058 autØ
w™h_osdm­
(
C®lback
&& 
cb
, 
Args
&&... 
¬gs
) const ->

2059 
deşty³
(
cb
(*
osdm­
, 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...)) {

2060 
sh¬ed_lock
 
l
(
rwlock
);

2061  
	g¡d
::
fÜw¬d
<
C®lback
>(
cb
)(*
osdm­
, std::fÜw¬d<
Args
>(
¬gs
)...);

2072 
£t_b®ªûd_budg‘
(è{ 
	gk“p_b®ªûd_budg‘
 = 
Œue
; }

2073 
un£t_b®ªûd_budg‘
(è{ 
	gk“p_b®ªûd_budg‘
 = 
çl£
; }

2075 
£t_hÚÜ_osdm­_fuÎ
(è{ 
	ghÚÜ_osdm­_fuÎ
 = 
Œue
; }

2076 
un£t_hÚÜ_osdm­_fuÎ
(è{ 
	ghÚÜ_osdm­_fuÎ
 = 
çl£
; }

2078 
£t_osdm­_fuÎ_Œy
(è{ 
	gosdm­_fuÎ_Œy
 = 
Œue
; }

2079 
un£t_osdm­_fuÎ_Œy
(è{ 
	gosdm­_fuÎ_Œy
 = 
çl£
; }

2081 
_sÿn_»que¡s
(

2082 
OSDSessiÚ
 *
s
,

2083 
boŞ
 
sk³d_m­
,

2084 
boŞ
 
şu¡”_fuÎ
,

2085 
m­
<
št64_t
, 
boŞ
> *
poŞ_fuÎ_m­
,

2086 
m­
<
ûph_tid_t
, 
Op
*>& 
Ãed_»£nd
,

2087 
li¡
<
Lšg”Op
*>& 
Ãed_»£nd_lšg”
,

2088 
m­
<
ûph_tid_t
, 
CommªdOp
*>& 
Ãed_»£nd_commªd
,

2089 
shunique_lock
& 
sul
,

2090 cÚ¡ 
mempoŞ
::
osdm­
::
m­
<
št64_t
,
OSDM­
::
¢­_š‹rv®_£t_t
> *
g­_»moved_¢­s
);

2092 
št64_t
 
g‘_objeù_hash_pos™iÚ
(št64_ˆ
poŞ
, cÚ¡ 
¡ršg
& 
key
,

2093 cÚ¡ 
¡ršg
& 
ns
);

2094 
št64_t
 
g‘_objeù_pg_hash_pos™iÚ
(št64_ˆ
poŞ
, cÚ¡ 
¡ršg
& 
key
,

2095 cÚ¡ 
¡ršg
& 
ns
);

2098 
	gpublic
:

2099 
boŞ
 
ms_di¥©ch
(
Mes§ge
 *
m
è
ov”ride
;

2100 
boŞ
 
ms_ÿn_ç¡_di¥©ch_ªy
(ècÚ¡ 
	gov”ride
 {

2101  
	gŒue
;

2103 
boŞ
 
ms_ÿn_ç¡_di¥©ch
(cÚ¡ 
Mes§ge
 *
m
ècÚ¡ 
	gov”ride
 {

2104 
	gm
->
g‘_ty³
()) {

2105 
	gCEPH_MSG_OSD_OPREPLY
:

2106 
CEPH_MSG_WATCH_NOTIFY
:

2107  
Œue
;

2109  
çl£
;

2112 
ms_ç¡_di¥©ch
(
Mes§ge
 *
m
è
	gov”ride
 {

2113 ià(!
ms_di¥©ch
(
m
)) {

2114 
	gm
->
put
();

2118 
hªdË_osd_İ_»¶y
(
şass
 
MOSDOpR•ly
 *
m
);

2119 
hªdË_osd_backoff
(
şass
 
MOSDBackoff
 *
m
);

2120 
hªdË_w©ch_nÙify
(
şass
 
MW©chNÙify
 *
m
);

2121 
hªdË_osd_m­
(
şass
 
MOSDM­
 *
m
);

2122 
wa™_fÜ_osd_m­
();

2133 
cÚsume_bÏckli¡_ev’ts
(
¡d
::
£t
<
’t™y_addr_t
> *
ev’ts
);

2135 
poŞ_¢­_by_Çme
(
št64_t
 
poŞid
,

2136 cÚ¡ *
¢­_Çme
,

2137 
¢­id_t
 *
¢­
) const;

2138 
poŞ_¢­_g‘_šfo
(
št64_t
 
poŞid
, 
¢­id_t
 
¢­
,

2139 
poŞ_¢­_šfo_t
 *
šfo
) const;

2140 
poŞ_¢­_li¡
(
št64_t
 
poŞid
, 
veùÜ
<
ušt64_t
> *
¢­s
);

2141 
	g´iv©e
:

2143 
em™_bÏckli¡_ev’ts
(cÚ¡ 
OSDM­
::
Inüem’l
 &
šc
);

2144 
em™_bÏckli¡_ev’ts
(cÚ¡ 
OSDM­
 &
Şd_osd_m­
,

2145 cÚ¡ 
OSDM­
 &
Ãw_osd_m­
);

2148 
_İ_subm™
(
Op
 *
İ
, 
shunique_lock
& 
lc
, 
ûph_tid_t
 *
±id
);

2149 
_İ_subm™_w™h_budg‘
(
Op
 *
İ
, 
shunique_lock
& 
lc
,

2150 
ûph_tid_t
 *
±id
,

2151 *
ùx_budg‘
 = 
NULL
);

2153 
	gpublic
:

2154 
İ_subm™
(
Op
 *
İ
, 
ûph_tid_t
 *
±id
 = 
NULL
, *
ùx_budg‘
 = NULL);

2155 
boŞ
 
is_aùive
() {

2156 
sh¬ed_lock
 
l
(
rwlock
);

2157  !((!
	gšæight_İs
è&& 
	glšg”_İs
.
em±y
() &&

2158 
	gpoŞ¡©_İs
.
em±y
(è&& 
	g¡©fs_İs
.empty());

2164 
_dump_aùive
(
OSDSessiÚ
 *
s
);

2165 
_dump_aùive
();

2166 
dump_aùive
();

2167 
dump_»que¡s
(
FÜm©‹r
 *
fmt
);

2168 
_dump_İs
(cÚ¡ 
OSDSessiÚ
 *
s
, 
FÜm©‹r
 *
fmt
);

2169 
dump_İs
(
FÜm©‹r
 *
fmt
);

2170 
_dump_lšg”_İs
(cÚ¡ 
OSDSessiÚ
 *
s
, 
FÜm©‹r
 *
fmt
);

2171 
dump_lšg”_İs
(
FÜm©‹r
 *
fmt
);

2172 
_dump_commªd_İs
(cÚ¡ 
OSDSessiÚ
 *
s
, 
FÜm©‹r
 *
fmt
);

2173 
dump_commªd_İs
(
FÜm©‹r
 *
fmt
);

2174 
dump_poŞ_İs
(
FÜm©‹r
 *
fmt
) const;

2175 
dump_poŞ_¡©_İs
(
FÜm©‹r
 *
fmt
) const;

2176 
dump_¡©fs_İs
(
FÜm©‹r
 *
fmt
) const;

2178 
g‘_ş›Á_šÿº©iÚ
(ècÚ¡ {  
	gş›Á_šc
; }

2179 
£t_ş›Á_šÿº©iÚ
(
šc
è{ 
	gş›Á_šc
 = inc; }

2181 
boŞ
 
have_m­
(
•och_t
 
•och
);

2183 
boŞ
 
wa™_fÜ_m­
(
•och_t
 
•och
, 
CÚ‹xt
 *
c
, 
”r
=0);

2184 
_wa™_fÜ_Ãw_m­
(
CÚ‹xt
 *
c
, 
•och_t
 
•och
, 
”r
=0);

2185 
wa™_fÜ_Ï‹¡_osdm­
(
CÚ‹xt
 *
fš
);

2186 
g‘_Ï‹¡_v”siÚ
(
•och_t
 
Şde¡
,ƒpoch_ˆ
Ãwe£t
, 
CÚ‹xt
 *
fš
);

2187 
_g‘_Ï‹¡_v”siÚ
(
•och_t
 
Şde¡
,ƒpoch_ˆ
Ãwe£t
, 
CÚ‹xt
 *
fš
);

2190 
g‘_glob®_İ_æags
(ècÚ¡ {  
	gglob®_İ_æags
; }

2192 
add_glob®_İ_æags
(
æag
) {

2193 
	gglob®_İ_æags
.
ãtch_Ü
(
æag
);

2196 
ş—r_glob®_İ_æag
(
æags
) {

2197 
	gglob®_İ_æags
.
ãtch_ªd
(~
æags
);

2201 
	g´iv©e
:

2202 
İ_ÿnûl
(
OSDSessiÚ
 *
s
, 
ûph_tid_t
 
tid
, 
r
);

2203 
_İ_ÿnûl
(
ûph_tid_t
 
tid
, 
r
);

2204 
	gpublic
:

2205 
İ_ÿnûl
(
ûph_tid_t
 
tid
, 
r
);

2206 
İ_ÿnûl
(cÚ¡ 
veùÜ
<
ûph_tid_t
>& 
tidls
, 
r
);

2216 
•och_t
 
İ_ÿnûl_wr™es
(
r
, 
št64_t
 
poŞ
=-1);

2219 
osd_commªd
(
osd
, cÚ¡ 
¡d
::
veùÜ
<
¡ršg
>& 
cmd
,

2220 cÚ¡ 
bufã¾i¡
& 
šbl
, 
ûph_tid_t
 *
±id
,

2221 
bufã¾i¡
 *
poutbl
, 
¡ršg
 *
´s
, 
CÚ‹xt
 *
Úfšish
) {

2222 
as£¹
(
osd
 >= 0);

2223 
CommªdOp
 *
	gc
 = 
Ãw
 CommandOp(

2224 
osd
,

2225 
cmd
,

2226 
šbl
,

2227 
poutbl
,

2228 
´s
,

2229 
Úfšish
);

2230 
subm™_commªd
(
c
, 
±id
);

2232 
pg_commªd
(
pg_t
 
pgid
, cÚ¡ 
veùÜ
<
¡ršg
>& 
cmd
,

2233 cÚ¡ 
bufã¾i¡
& 
šbl
, 
ûph_tid_t
 *
±id
,

2234 
bufã¾i¡
 *
poutbl
, 
¡ršg
 *
´s
, 
CÚ‹xt
 *
Úfšish
) {

2235 
CommªdOp
 *
	gc
 = 
Ãw
 CommandOp(

2236 
pgid
,

2237 
cmd
,

2238 
šbl
,

2239 
poutbl
,

2240 
´s
,

2241 
Úfšish
);

2242 
subm™_commªd
(
c
, 
±id
);

2246 
Op
 *
´•¬e_mu‹_İ
(

2247 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2248 
ObjeùO³¿tiÚ
& 
İ
, cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

2249 
ûph
::
»®_time
 
mtime
, 
æags
,

2250 
CÚ‹xt
 *
Úcomm™
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2251 
osd_»qid_t
 
»qid
 = osd_reqid_t(),

2252 
ZT¿ûr
::
T¿û
 *
·»Á_Œaû
 = 
nuÎ±r
) {

2253 
Op
 *
o
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İ
.
İs
, 
æags
 | 
glob®_İ_æags
 |

2254 
CEPH_OSD_FLAG_WRITE
, 
Úcomm™
, 
objv”
, 
nuÎ±r
, 
·»Á_Œaû
);

2255 
	go
->
	g´iÜ™y
 = 
İ
.
´iÜ™y
;

2256 
	go
->
	gmtime
 = 
mtime
;

2257 
	go
->
	g¢­c
 = 
¢­c
;

2258 
	go
->
	gout_rv®
.
sw­
(
İ
.
out_rv®
);

2259 
	go
->
	g»qid
 = 
»qid
;

2260  
	go
;

2262 
ûph_tid_t
 
mu‹
(

2263 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2264 
ObjeùO³¿tiÚ
& 
İ
, cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

2265 
ûph
::
»®_time
 
mtime
, 
æags
,

2266 
CÚ‹xt
 *
Úcomm™
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2267 
osd_»qid_t
 
»qid
 = osd_reqid_t()) {

2268 
Op
 *
o
 = 
´•¬e_mu‹_İ
(
oid
, 
Şoc
, 
İ
, 
¢­c
, 
mtime
, 
æags
,

2269 
Úcomm™
, 
objv”
, 
»qid
);

2270 
ûph_tid_t
 
	gtid
;

2271 
İ_subm™
(
o
, &
tid
);

2272  
	gtid
;

2274 
Op
 *
´•¬e_»ad_İ
(

2275 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2276 
ObjeùO³¿tiÚ
& 
İ
,

2277 
¢­id_t
 
¢­id
, 
bufã¾i¡
 *
pbl
, 
æags
,

2278 
CÚ‹xt
 *
Úack
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2279 *
d©a_off£t
 = 
NULL
,

2280 
ušt64_t
 
ã©u»s
 = 0,

2281 
ZT¿ûr
::
T¿û
 *
·»Á_Œaû
 = 
nuÎ±r
) {

2282 
Op
 *
o
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İ
.
İs
, 
æags
 | 
glob®_İ_æags
 |

2283 
CEPH_OSD_FLAG_READ
, 
Úack
, 
objv”
, 
d©a_off£t
, 
·»Á_Œaû
);

2284 
	go
->
	g´iÜ™y
 = 
İ
.
´iÜ™y
;

2285 
	go
->
	g¢­id
 = 
¢­id
;

2286 
	go
->
	goutbl
 = 
pbl
;

2287 ià(!
	go
->
	goutbl
 && 
	gİ
.
size
(è=ğ1 && 
İ
.
out_bl
[0]->
Ëngth
())

2288 
o
->
outbl
 = 
İ
.
out_bl
[0];

2289 
	go
->
	gout_bl
.
sw­
(
İ
.
out_bl
);

2290 
	go
->
	gout_hªdËr
.
sw­
(
İ
.
out_hªdËr
);

2291 
	go
->
	gout_rv®
.
sw­
(
İ
.
out_rv®
);

2292  
	go
;

2294 
ûph_tid_t
 
»ad
(

2295 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2296 
ObjeùO³¿tiÚ
& 
İ
,

2297 
¢­id_t
 
¢­id
, 
bufã¾i¡
 *
pbl
, 
æags
,

2298 
CÚ‹xt
 *
Úack
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2299 *
d©a_off£t
 = 
NULL
,

2300 
ušt64_t
 
ã©u»s
 = 0) {

2301 
Op
 *
o
 = 
´•¬e_»ad_İ
(
oid
, 
Şoc
, 
İ
, 
¢­id
, 
pbl
, 
æags
, 
Úack
, 
objv”
,

2302 
d©a_off£t
);

2303 ià(
	gã©u»s
)

2304 
	go
->
	gã©u»s
 = 
ã©u»s
;

2305 
ûph_tid_t
 
	gtid
;

2306 
İ_subm™
(
o
, &
tid
);

2307  
	gtid
;

2309 
Op
 *
´•¬e_pg_»ad_İ
(

2310 
ušt32_t
 
hash
, 
objeù_loÿtÜ_t
 
Şoc
,

2311 
ObjeùO³¿tiÚ
& 
İ
, 
bufã¾i¡
 *
pbl
, 
æags
,

2312 
CÚ‹xt
 *
Úack
, 
•och_t
 *
»¶y_•och
,

2313 *
ùx_budg‘
) {

2314 
Op
 *
	go
 = 
Ãw
 Op(
objeù_t
(), 
Şoc
,

2315 
İ
.
İs
,

2316 
æags
 | 
glob®_İ_æags
 | 
CEPH_OSD_FLAG_READ
 |

2317 
CEPH_OSD_FLAG_IGNORE_OVERLAY
,

2318 
Úack
, 
NULL
);

2319 
	go
->
	grg‘
.
	g´eÿlc_pgid
 = 
Œue
;

2320 
	go
->
	grg‘
.
	gba£_pgid
 = 
pg_t
(
hash
, 
Şoc
.
poŞ
);

2321 
	go
->
	g´iÜ™y
 = 
İ
.
´iÜ™y
;

2322 
	go
->
	g¢­id
 = 
CEPH_NOSNAP
;

2323 
	go
->
	goutbl
 = 
pbl
;

2324 
	go
->
	gout_bl
.
sw­
(
İ
.
out_bl
);

2325 
	go
->
	gout_hªdËr
.
sw­
(
İ
.
out_hªdËr
);

2326 
	go
->
	gout_rv®
.
sw­
(
İ
.
out_rv®
);

2327 
	go
->
	g»¶y_•och
 = 
»¶y_•och
;

2328 ià(
	gùx_budg‘
) {

2330 
	go
->
	gùx_budg‘ed
 = 
Œue
;

2332  
	go
;

2334 
ûph_tid_t
 
pg_»ad
(

2335 
ušt32_t
 
hash
, 
objeù_loÿtÜ_t
 
Şoc
,

2336 
ObjeùO³¿tiÚ
& 
İ
, 
bufã¾i¡
 *
pbl
, 
æags
,

2337 
CÚ‹xt
 *
Úack
, 
•och_t
 *
»¶y_•och
,

2338 *
ùx_budg‘
) {

2339 
Op
 *
	go
 = 
´•¬e_pg_»ad_İ
(
hash
, 
Şoc
, 
İ
, 
pbl
, 
æags
,

2340 
Úack
, 
»¶y_•och
, 
ùx_budg‘
);

2341 
ûph_tid_t
 
	gtid
;

2342 
İ_subm™
(
o
, &
tid
, 
ùx_budg‘
);

2343  
	gtid
;

2347 
Lšg”Op
 *
lšg”_»gi¡”
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2348 
æags
);

2349 
ûph_tid_t
 
lšg”_w©ch
(
Lšg”Op
 *
šfo
,

2350 
ObjeùO³¿tiÚ
& 
İ
,

2351 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
, 
ûph
::
»®_time
 
mtime
,

2352 
bufã¾i¡
& 
šbl
,

2353 
CÚ‹xt
 *
Úfšish
,

2354 
v”siÚ_t
 *
objv”
);

2355 
ûph_tid_t
 
lšg”_nÙify
(
Lšg”Op
 *
šfo
,

2356 
ObjeùO³¿tiÚ
& 
İ
,

2357 
¢­id_t
 
¢­
, 
bufã¾i¡
& 
šbl
,

2358 
bufã¾i¡
 *
poutbl
,

2359 
CÚ‹xt
 *
Úack
,

2360 
v”siÚ_t
 *
objv”
);

2361 
lšg”_check
(
Lšg”Op
 *
šfo
);

2362 
lšg”_ÿnûl
(
Lšg”Op
 *
šfo
);

2363 
_lšg”_ÿnûl
(
Lšg”Op
 *
šfo
);

2365 
_do_w©ch_nÙify
(
Lšg”Op
 *
šfo
, 
MW©chNÙify
 *
m
);

2377 
š™_İs
(
veùÜ
<
OSDOp
>& 
İs
, 
İs_couÁ
, 
ObjeùO³¿tiÚ
 *
exŒa_İs
) {

2378 
	gi
;

2379 
	gexŒa
 = 0;

2381 ià(
	gexŒa_İs
)

2382 
	gexŒa
 = 
exŒa_İs
->
İs
.
size
();

2384 
	gİs
.
»size
(
İs_couÁ
 + 
exŒa
);

2386 
	gi
=0; i<
	gexŒa
; i++) {

2387 
	gİs
[
i
] = 
exŒa_İs
->
İs
[i];

2390  
	gi
;

2395 
Op
 *
´•¬e_¡©_İ
(

2396 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2397 
¢­id_t
 
¢­
, 
ušt64_t
 *
psize
, 
ûph
::
»®_time
 *
pmtime
,

2398 
æags
, 
CÚ‹xt
 *
Úfšish
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2399 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
) {

2400 
veùÜ
<
OSDOp
> 
İs
;

2401 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2402 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_STAT
;

2403 
C_St
 *
	gfš
 = 
Ãw
 C_St(
psize
, 
pmtime
, 
Úfšish
);

2404 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
æags
 | 
glob®_İ_æags
 |

2405 
CEPH_OSD_FLAG_READ
, 
fš
, 
objv”
);

2406 
	go
->
	g¢­id
 = 
¢­
;

2407 
	go
->
	goutbl
 = &
fš
->
bl
;

2408  
	go
;

2410 
ûph_tid_t
 
¡©
(

2411 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2412 
¢­id_t
 
¢­
, 
ušt64_t
 *
psize
, 
ûph
::
»®_time
 *
pmtime
,

2413 
æags
, 
CÚ‹xt
 *
Úfšish
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2414 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
) {

2415 
Op
 *
o
 = 
´•¬e_¡©_İ
(
oid
, 
Şoc
, 
¢­
, 
psize
, 
pmtime
, 
æags
,

2416 
Úfšish
, 
objv”
, 
exŒa_İs
);

2417 
ûph_tid_t
 
	gtid
;

2418 
İ_subm™
(
o
, &
tid
);

2419  
	gtid
;

2422 
Op
 *
´•¬e_»ad_İ
(

2423 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2424 
ušt64_t
 
off
, ušt64_ˆ
Ën
, 
¢­id_t
 
¢­
, 
bufã¾i¡
 *
pbl
,

2425 
æags
, 
CÚ‹xt
 *
Úfšish
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2426 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
, 
İ_æags
 = 0,

2427 
ZT¿ûr
::
T¿û
 *
·»Á_Œaû
 = 
nuÎ±r
) {

2428 
veùÜ
<
OSDOp
> 
İs
;

2429 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2430 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_READ
;

2431 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	goff£t
 = 
off
;

2432 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gËngth
 = 
Ën
;

2433 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gŒunÿ‹_size
 = 0;

2434 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
 = 0;

2435 
	gİs
[
i
].
	gİ
.
	gæags
 = 
İ_æags
;

2436 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
æags
 | 
glob®_İ_æags
 |

2437 
CEPH_OSD_FLAG_READ
, 
Úfšish
, 
objv”
, 
nuÎ±r
, 
·»Á_Œaû
);

2438 
	go
->
	g¢­id
 = 
¢­
;

2439 
	go
->
	goutbl
 = 
pbl
;

2440  
	go
;

2442 
ûph_tid_t
 
»ad
(

2443 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2444 
ušt64_t
 
off
, ušt64_ˆ
Ën
, 
¢­id_t
 
¢­
, 
bufã¾i¡
 *
pbl
,

2445 
æags
, 
CÚ‹xt
 *
Úfšish
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2446 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
, 
İ_æags
 = 0) {

2447 
Op
 *
o
 = 
´•¬e_»ad_İ
(
oid
, 
Şoc
, 
off
, 
Ën
, 
¢­
, 
pbl
, 
æags
,

2448 
Úfšish
, 
objv”
, 
exŒa_İs
, 
İ_æags
);

2449 
ûph_tid_t
 
	gtid
;

2450 
İ_subm™
(
o
, &
tid
);

2451  
	gtid
;

2454 
Op
 *
´•¬e_cm³xt_İ
(

2455 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2456 
ušt64_t
 
off
, 
bufã¾i¡
 &
cmp_bl
,

2457 
¢­id_t
 
¢­
, 
æags
, 
CÚ‹xt
 *
Úfšish
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2458 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
, 
İ_æags
 = 0) {

2459 
veùÜ
<
OSDOp
> 
İs
;

2460 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2461 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_CMPEXT
;

2462 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	goff£t
 = 
off
;

2463 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gËngth
 = 
cmp_bl
.
Ëngth
();

2464 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gŒunÿ‹_size
 = 0;

2465 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
 = 0;

2466 
	gİs
[
i
].
	gšd©a
 = 
cmp_bl
;

2467 
	gİs
[
i
].
	gİ
.
	gæags
 = 
İ_æags
;

2468 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
æags
 | 
glob®_İ_æags
 |

2469 
CEPH_OSD_FLAG_READ
, 
Úfšish
, 
objv”
);

2470 
	go
->
	g¢­id
 = 
¢­
;

2471  
	go
;

2474 
ûph_tid_t
 
cm³xt
(

2475 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2476 
ušt64_t
 
off
, 
bufã¾i¡
 &
cmp_bl
,

2477 
¢­id_t
 
¢­
, 
æags
, 
CÚ‹xt
 *
Úfšish
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2478 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
, 
İ_æags
 = 0) {

2479 
Op
 *
o
 = 
´•¬e_cm³xt_İ
(
oid
, 
Şoc
, 
off
, 
cmp_bl
, 
¢­
,

2480 
æags
, 
Úfšish
, 
objv”
, 
exŒa_İs
, 
İ_æags
);

2481 
ûph_tid_t
 
	gtid
;

2482 
İ_subm™
(
o
, &
tid
);

2483  
	gtid
;

2486 
ûph_tid_t
 
»ad_Œunc
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2487 
ušt64_t
 
off
, ušt64_ˆ
Ën
, 
¢­id_t
 
¢­
,

2488 
bufã¾i¡
 *
pbl
, 
æags
, 
ušt64_t
 
Œunc_size
,

2489 
__u32
 
Œunc_£q
, 
CÚ‹xt
 *
Úfšish
,

2490 
v”siÚ_t
 *
objv”
 = 
NULL
,

2491 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
, 
İ_æags
 = 0) {

2492 
veùÜ
<
OSDOp
> 
İs
;

2493 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2494 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_READ
;

2495 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	goff£t
 = 
off
;

2496 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gËngth
 = 
Ën
;

2497 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gŒunÿ‹_size
 = 
Œunc_size
;

2498 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
 = 
Œunc_£q
;

2499 
	gİs
[
i
].
	gİ
.
	gæags
 = 
İ_æags
;

2500 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
æags
 | 
glob®_İ_æags
 |

2501 
CEPH_OSD_FLAG_READ
, 
Úfšish
, 
objv”
);

2502 
	go
->
	g¢­id
 = 
¢­
;

2503 
	go
->
	goutbl
 = 
pbl
;

2504 
ûph_tid_t
 
	gtid
;

2505 
İ_subm™
(
o
, &
tid
);

2506  
	gtid
;

2508 
ûph_tid_t
 
m­ext
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2509 
ušt64_t
 
off
, ušt64_ˆ
Ën
, 
¢­id_t
 
¢­
, 
bufã¾i¡
 *
pbl
,

2510 
æags
, 
CÚ‹xt
 *
Úfšish
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2511 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
) {

2512 
veùÜ
<
OSDOp
> 
İs
;

2513 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2514 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_MAPEXT
;

2515 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	goff£t
 = 
off
;

2516 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gËngth
 = 
Ën
;

2517 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gŒunÿ‹_size
 = 0;

2518 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
 = 0;

2519 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
æags
 | 
glob®_İ_æags
 |

2520 
CEPH_OSD_FLAG_READ
, 
Úfšish
, 
objv”
);

2521 
	go
->
	g¢­id
 = 
¢­
;

2522 
	go
->
	goutbl
 = 
pbl
;

2523 
ûph_tid_t
 
	gtid
;

2524 
İ_subm™
(
o
, &
tid
);

2525  
	gtid
;

2527 
ûph_tid_t
 
g‘x©Œ
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2528 cÚ¡ *
Çme
, 
¢­id_t
 
¢­
, 
bufã¾i¡
 *
pbl
, 
æags
,

2529 
CÚ‹xt
 *
Úfšish
,

2530 
v”siÚ_t
 *
objv”
 = 
NULL
, 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = NULL) {

2531 
veùÜ
<
OSDOp
> 
İs
;

2532 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2533 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_GETXATTR
;

2534 
	gİs
[
i
].
	gİ
.
	gx©Œ
.
	gÇme_Ën
 = (
Çme
 ? 
¡¾’
(name) : 0);

2535 
	gİs
[
i
].
	gİ
.
	gx©Œ
.
	gv®ue_Ën
 = 0;

2536 ià(
	gÇme
)

2537 
	gİs
[
i
].
	gšd©a
.
­³nd
(
Çme
, 
İs
[i].
İ
.
x©Œ
.
Çme_Ën
);

2538 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
æags
 | 
glob®_İ_æags
 |

2539 
CEPH_OSD_FLAG_READ
, 
Úfšish
, 
objv”
);

2540 
	go
->
	g¢­id
 = 
¢­
;

2541 
	go
->
	goutbl
 = 
pbl
;

2542 
ûph_tid_t
 
	gtid
;

2543 
İ_subm™
(
o
, &
tid
);

2544  
	gtid
;

2547 
ûph_tid_t
 
g‘x©Œs
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2548 
¢­id_t
 
¢­
, 
m­
<
¡ršg
,
bufã¾i¡
>& 
©Œ£t
,

2549 
æags
, 
CÚ‹xt
 *
Úfšish
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2550 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
) {

2551 
veùÜ
<
OSDOp
> 
İs
;

2552 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2553 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_GETXATTRS
;

2554 
C_G‘A‰rs
 *
	gfš
 = 
Ãw
 C_G‘A‰rs(
©Œ£t
, 
Úfšish
);

2555 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
æags
 | 
glob®_İ_æags
 |

2556 
CEPH_OSD_FLAG_READ
, 
fš
, 
objv”
);

2557 
	go
->
	g¢­id
 = 
¢­
;

2558 
	go
->
	goutbl
 = &
fš
->
bl
;

2559 
ûph_tid_t
 
	gtid
;

2560 
İ_subm™
(
o
, &
tid
);

2561  
	gtid
;

2564 
ûph_tid_t
 
»ad_fuÎ
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2565 
¢­id_t
 
¢­
, 
bufã¾i¡
 *
pbl
, 
æags
,

2566 
CÚ‹xt
 *
Úfšish
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2567 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
) {

2568  
»ad
(
oid
, 
Şoc
, 0, 0, 
¢­
, 
pbl
, 
æags
 | 
glob®_İ_æags
 |

2569 
CEPH_OSD_FLAG_READ
, 
Úfšish
, 
objv”
, 
exŒa_İs
);

2574 
ûph_tid_t
 
_modify
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2575 
veùÜ
<
OSDOp
>& 
İs
, 
ûph
::
»®_time
 
mtime
,

2576 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
, 
æags
,

2577 
CÚ‹xt
 *
Úcomm™
,

2578 
v”siÚ_t
 *
objv”
 = 
NULL
) {

2579 
Op
 *
o
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
æags
 | 
glob®_İ_æags
 |

2580 
CEPH_OSD_FLAG_WRITE
, 
Úcomm™
, 
objv”
);

2581 
	go
->
	gmtime
 = 
mtime
;

2582 
	go
->
	g¢­c
 = 
¢­c
;

2583 
ûph_tid_t
 
	gtid
;

2584 
İ_subm™
(
o
, &
tid
);

2585  
	gtid
;

2587 
Op
 *
´•¬e_wr™e_İ
(

2588 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2589 
ušt64_t
 
off
, ušt64_ˆ
Ën
, cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

2590 cÚ¡ 
bufã¾i¡
 &
bl
, 
ûph
::
»®_time
 
mtime
, 
æags
,

2591 
CÚ‹xt
 *
Úcomm™
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2592 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
, 
İ_æags
 = 0,

2593 
ZT¿ûr
::
T¿û
 *
·»Á_Œaû
 = 
nuÎ±r
) {

2594 
veùÜ
<
OSDOp
> 
İs
;

2595 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2596 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_WRITE
;

2597 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	goff£t
 = 
off
;

2598 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gËngth
 = 
Ën
;

2599 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gŒunÿ‹_size
 = 0;

2600 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
 = 0;

2601 
	gİs
[
i
].
	gšd©a
 = 
bl
;

2602 
	gİs
[
i
].
	gİ
.
	gæags
 = 
İ_æags
;

2603 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
æags
 | 
glob®_İ_æags
 |

2604 
CEPH_OSD_FLAG_WRITE
, 
Úcomm™
, 
objv”
,

2605 
nuÎ±r
, 
·»Á_Œaû
);

2606 
	go
->
	gmtime
 = 
mtime
;

2607 
	go
->
	g¢­c
 = 
¢­c
;

2608  
	go
;

2610 
ûph_tid_t
 
wr™e
(

2611 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2612 
ušt64_t
 
off
, ušt64_ˆ
Ën
, cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

2613 cÚ¡ 
bufã¾i¡
 &
bl
, 
ûph
::
»®_time
 
mtime
, 
æags
,

2614 
CÚ‹xt
 *
Úcomm™
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2615 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
, 
İ_æags
 = 0) {

2616 
Op
 *
o
 = 
´•¬e_wr™e_İ
(
oid
, 
Şoc
, 
off
, 
Ën
, 
¢­c
, 
bl
, 
mtime
, 
æags
,

2617 
Úcomm™
, 
objv”
, 
exŒa_İs
, 
İ_æags
);

2618 
ûph_tid_t
 
	gtid
;

2619 
İ_subm™
(
o
, &
tid
);

2620  
	gtid
;

2622 
Op
 *
´•¬e_­³nd_İ
(

2623 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2624 
ušt64_t
 
Ën
, cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

2625 cÚ¡ 
bufã¾i¡
 &
bl
, 
ûph
::
»®_time
 
mtime
, 
æags
,

2626 
CÚ‹xt
 *
Úcomm™
,

2627 
v”siÚ_t
 *
objv”
 = 
NULL
,

2628 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
) {

2629 
veùÜ
<
OSDOp
> 
İs
;

2630 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2631 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_APPEND
;

2632 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	goff£t
 = 0;

2633 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gËngth
 = 
Ën
;

2634 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gŒunÿ‹_size
 = 0;

2635 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
 = 0;

2636 
	gİs
[
i
].
	gšd©a
 = 
bl
;

2637 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
æags
 | 
glob®_İ_æags
 |

2638 
CEPH_OSD_FLAG_WRITE
, 
Úcomm™
, 
objv”
);

2639 
	go
->
	gmtime
 = 
mtime
;

2640 
	go
->
	g¢­c
 = 
¢­c
;

2641  
	go
;

2643 
ûph_tid_t
 
­³nd
(

2644 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2645 
ušt64_t
 
Ën
, cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

2646 cÚ¡ 
bufã¾i¡
 &
bl
, 
ûph
::
»®_time
 
mtime
, 
æags
,

2647 
CÚ‹xt
 *
Úcomm™
,

2648 
v”siÚ_t
 *
objv”
 = 
NULL
,

2649 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
) {

2650 
Op
 *
o
 = 
´•¬e_­³nd_İ
(
oid
, 
Şoc
, 
Ën
, 
¢­c
, 
bl
, 
mtime
, 
æags
,

2651 
Úcomm™
, 
objv”
, 
exŒa_İs
);

2652 
ûph_tid_t
 
	gtid
;

2653 
İ_subm™
(
o
, &
tid
);

2654  
	gtid
;

2656 
ûph_tid_t
 
wr™e_Œunc
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2657 
ušt64_t
 
off
, ušt64_ˆ
Ën
, cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

2658 cÚ¡ 
bufã¾i¡
 &
bl
, 
ûph
::
»®_time
 
mtime
, 
æags
,

2659 
ušt64_t
 
Œunc_size
, 
__u32
 
Œunc_£q
,

2660 
CÚ‹xt
 *
Úcomm™
,

2661 
v”siÚ_t
 *
objv”
 = 
NULL
,

2662 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
, 
İ_æags
 = 0) {

2663 
veùÜ
<
OSDOp
> 
İs
;

2664 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2665 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_WRITE
;

2666 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	goff£t
 = 
off
;

2667 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gËngth
 = 
Ën
;

2668 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gŒunÿ‹_size
 = 
Œunc_size
;

2669 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
 = 
Œunc_£q
;

2670 
	gİs
[
i
].
	gšd©a
 = 
bl
;

2671 
	gİs
[
i
].
	gİ
.
	gæags
 = 
İ_æags
;

2672 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
æags
 | 
glob®_İ_æags
 |

2673 
CEPH_OSD_FLAG_WRITE
, 
Úcomm™
, 
objv”
);

2674 
	go
->
	gmtime
 = 
mtime
;

2675 
	go
->
	g¢­c
 = 
¢­c
;

2676 
ûph_tid_t
 
	gtid
;

2677 
İ_subm™
(
o
, &
tid
);

2678  
	gtid
;

2680 
Op
 *
´•¬e_wr™e_fuÎ_İ
(

2681 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2682 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
, cÚ¡ 
bufã¾i¡
 &
bl
,

2683 
ûph
::
»®_time
 
mtime
, 
æags
,

2684 
CÚ‹xt
 *
Úcomm™
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2685 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
, 
İ_æags
 = 0) {

2686 
veùÜ
<
OSDOp
> 
İs
;

2687 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2688 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_WRITEFULL
;

2689 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	goff£t
 = 0;

2690 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gËngth
 = 
bl
.
Ëngth
();

2691 
	gİs
[
i
].
	gšd©a
 = 
bl
;

2692 
	gİs
[
i
].
	gİ
.
	gæags
 = 
İ_æags
;

2693 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
æags
 | 
glob®_İ_æags
 |

2694 
CEPH_OSD_FLAG_WRITE
, 
Úcomm™
, 
objv”
);

2695 
	go
->
	gmtime
 = 
mtime
;

2696 
	go
->
	g¢­c
 = 
¢­c
;

2697  
	go
;

2699 
ûph_tid_t
 
wr™e_fuÎ
(

2700 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2701 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
, cÚ¡ 
bufã¾i¡
 &
bl
,

2702 
ûph
::
»®_time
 
mtime
, 
æags
,

2703 
CÚ‹xt
 *
Úcomm™
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2704 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
, 
İ_æags
 = 0) {

2705 
Op
 *
o
 = 
´•¬e_wr™e_fuÎ_İ
(
oid
, 
Şoc
, 
¢­c
, 
bl
, 
mtime
, 
æags
,

2706 
Úcomm™
, 
objv”
, 
exŒa_İs
, 
İ_æags
);

2707 
ûph_tid_t
 
	gtid
;

2708 
İ_subm™
(
o
, &
tid
);

2709  
	gtid
;

2711 
Op
 *
´•¬e_wr™e§me_İ
(

2712 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2713 
ušt64_t
 
wr™e_Ën
, ušt64_ˆ
off
,

2714 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
, cÚ¡ 
bufã¾i¡
 &
bl
,

2715 
ûph
::
»®_time
 
mtime
, 
æags
,

2716 
CÚ‹xt
 *
Úcomm™
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2717 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
, 
İ_æags
 = 0) {

2719 
veùÜ
<
OSDOp
> 
İs
;

2720 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2721 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_WRITESAME
;

2722 
	gİs
[
i
].
	gİ
.
	gwr™e§me
.
	goff£t
 = 
off
;

2723 
	gİs
[
i
].
	gİ
.
	gwr™e§me
.
	gËngth
 = 
wr™e_Ën
;

2724 
	gİs
[
i
].
	gİ
.
	gwr™e§me
.
	gd©a_Ëngth
 = 
bl
.
Ëngth
();

2725 
	gİs
[
i
].
	gšd©a
 = 
bl
;

2726 
	gİs
[
i
].
	gİ
.
	gæags
 = 
İ_æags
;

2727 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
æags
 | 
glob®_İ_æags
 |

2728 
CEPH_OSD_FLAG_WRITE
, 
Úcomm™
, 
objv”
);

2729 
	go
->
	gmtime
 = 
mtime
;

2730 
	go
->
	g¢­c
 = 
¢­c
;

2731  
	go
;

2733 
ûph_tid_t
 
wr™e§me
(

2734 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2735 
ušt64_t
 
wr™e_Ën
, ušt64_ˆ
off
,

2736 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
, cÚ¡ 
bufã¾i¡
 &
bl
,

2737 
ûph
::
»®_time
 
mtime
, 
æags
,

2738 
CÚ‹xt
 *
Úcomm™
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2739 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
, 
İ_æags
 = 0) {

2741 
Op
 *
o
 = 
´•¬e_wr™e§me_İ
(
oid
, 
Şoc
, 
wr™e_Ën
, 
off
, 
¢­c
, 
bl
,

2742 
mtime
, 
æags
, 
Úcomm™
, 
objv”
,

2743 
exŒa_İs
, 
İ_æags
);

2745 
ûph_tid_t
 
	gtid
;

2746 
İ_subm™
(
o
, &
tid
);

2747  
	gtid
;

2749 
ûph_tid_t
 
Œunc
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2750 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
, 
ûph
::
»®_time
 
mtime
, 
æags
,

2751 
ušt64_t
 
Œunc_size
, 
__u32
 
Œunc_£q
,

2752 
CÚ‹xt
 *
Úcomm™
, 
v”siÚ_t
 *
objv”
 = 
NULL
,

2753 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
) {

2754 
veùÜ
<
OSDOp
> 
İs
;

2755 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2756 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_TRUNCATE
;

2757 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	goff£t
 = 
Œunc_size
;

2758 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gŒunÿ‹_size
 = 
Œunc_size
;

2759 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gŒunÿ‹_£q
 = 
Œunc_£q
;

2760 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
æags
 | 
glob®_İ_æags
 |

2761 
CEPH_OSD_FLAG_WRITE
, 
Úcomm™
, 
objv”
);

2762 
	go
->
	gmtime
 = 
mtime
;

2763 
	go
->
	g¢­c
 = 
¢­c
;

2764 
ûph_tid_t
 
	gtid
;

2765 
İ_subm™
(
o
, &
tid
);

2766  
	gtid
;

2768 
ûph_tid_t
 
z”o
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2769 
ušt64_t
 
off
, ušt64_ˆ
Ën
, cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

2770 
ûph
::
»®_time
 
mtime
, 
æags
, 
CÚ‹xt
 *
Úcomm™
,

2771 
v”siÚ_t
 *
objv”
 = 
NULL
, 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = NULL) {

2772 
veùÜ
<
OSDOp
> 
İs
;

2773 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2774 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_ZERO
;

2775 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	goff£t
 = 
off
;

2776 
	gİs
[
i
].
	gİ
.
	gex‹Á
.
	gËngth
 = 
Ën
;

2777 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
æags
 | 
glob®_İ_æags
 |

2778 
CEPH_OSD_FLAG_WRITE
, 
Úcomm™
, 
objv”
);

2779 
	go
->
	gmtime
 = 
mtime
;

2780 
	go
->
	g¢­c
 = 
¢­c
;

2781 
ûph_tid_t
 
	gtid
;

2782 
İ_subm™
(
o
, &
tid
);

2783  
	gtid
;

2785 
ûph_tid_t
 
rŞlback_objeù
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2786 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
, 
¢­id_t
 
¢­id
,

2787 
ûph
::
»®_time
 
mtime
, 
CÚ‹xt
 *
Úcomm™
,

2788 
v”siÚ_t
 *
objv”
 = 
NULL
,

2789 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
) {

2790 
veùÜ
<
OSDOp
> 
İs
;

2791 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2792 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_ROLLBACK
;

2793 
	gİs
[
i
].
	gİ
.
	g¢­
.
	g¢­id
 = 
¢­id
;

2794 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
CEPH_OSD_FLAG_WRITE
, 
Úcomm™
, 
objv”
);

2795 
	go
->
	gmtime
 = 
mtime
;

2796 
	go
->
	g¢­c
 = 
¢­c
;

2797 
ûph_tid_t
 
	gtid
;

2798 
İ_subm™
(
o
, &
tid
);

2799  
	gtid
;

2801 
ûph_tid_t
 
ü—‹
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2802 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
, 
ûph
::
»®_time
 
mtime
, 
glob®_æags
,

2803 
ü—‹_æags
, 
CÚ‹xt
 *
Úcomm™
,

2804 
v”siÚ_t
 *
objv”
 = 
NULL
,

2805 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = 
NULL
) {

2806 
veùÜ
<
OSDOp
> 
İs
;

2807 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2808 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_CREATE
;

2809 
	gİs
[
i
].
	gİ
.
	gæags
 = 
ü—‹_æags
;

2810 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
glob®_æags
 | 
glob®_İ_æags
 |

2811 
CEPH_OSD_FLAG_WRITE
, 
Úcomm™
, 
objv”
);

2812 
	go
->
	gmtime
 = 
mtime
;

2813 
	go
->
	g¢­c
 = 
¢­c
;

2814 
ûph_tid_t
 
	gtid
;

2815 
İ_subm™
(
o
, &
tid
);

2816  
	gtid
;

2818 
Op
 *
´•¬e_»move_İ
(

2819 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2820 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
, 
ûph
::
»®_time
 
mtime
, 
æags
,

2821 
CÚ‹xt
 *
Úcomm™
,

2822 
v”siÚ_t
 *
objv”
 = 
NULL
, 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = NULL) {

2823 
veùÜ
<
OSDOp
> 
İs
;

2824 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2825 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_DELETE
;

2826 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
æags
 | 
glob®_İ_æags
 |

2827 
CEPH_OSD_FLAG_WRITE
, 
Úcomm™
, 
objv”
);

2828 
	go
->
	gmtime
 = 
mtime
;

2829 
	go
->
	g¢­c
 = 
¢­c
;

2830  
	go
;

2832 
ûph_tid_t
 
»move
(

2833 cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2834 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
, 
ûph
::
»®_time
 
mtime
, 
æags
,

2835 
CÚ‹xt
 *
Úcomm™
,

2836 
v”siÚ_t
 *
objv”
 = 
NULL
, 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = NULL) {

2837 
Op
 *
o
 = 
´•¬e_»move_İ
(
oid
, 
Şoc
, 
¢­c
, 
mtime
, 
æags
,

2838 
Úcomm™
, 
objv”
, 
exŒa_İs
);

2839 
ûph_tid_t
 
	gtid
;

2840 
İ_subm™
(
o
, &
tid
);

2841  
	gtid
;

2844 
ûph_tid_t
 
£tx©Œ
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2845 cÚ¡ *
Çme
, cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
, cÚ¡ 
bufã¾i¡
 &
bl
,

2846 
ûph
::
»®_time
 
mtime
, 
æags
,

2847 
CÚ‹xt
 *
Úcomm™
,

2848 
v”siÚ_t
 *
objv”
 = 
NULL
, 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = NULL) {

2849 
veùÜ
<
OSDOp
> 
İs
;

2850 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2851 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_SETXATTR
;

2852 
	gİs
[
i
].
	gİ
.
	gx©Œ
.
	gÇme_Ën
 = (
Çme
 ? 
¡¾’
(name) : 0);

2853 
	gİs
[
i
].
	gİ
.
	gx©Œ
.
	gv®ue_Ën
 = 
bl
.
Ëngth
();

2854 ià(
	gÇme
)

2855 
	gİs
[
i
].
	gšd©a
.
­³nd
(
Çme
, 
İs
[i].
İ
.
x©Œ
.
Çme_Ën
);

2856 
	gİs
[
i
].
	gšd©a
.
­³nd
(
bl
);

2857 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
æags
 | 
glob®_İ_æags
 |

2858 
CEPH_OSD_FLAG_WRITE
, 
Úcomm™
, 
objv”
);

2859 
	go
->
	gmtime
 = 
mtime
;

2860 
	go
->
	g¢­c
 = 
¢­c
;

2861 
ûph_tid_t
 
	gtid
;

2862 
İ_subm™
(
o
, &
tid
);

2863  
	gtid
;

2865 
ûph_tid_t
 
»movex©Œ
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

2866 cÚ¡ *
Çme
, cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

2867 
ûph
::
»®_time
 
mtime
, 
æags
,

2868 
CÚ‹xt
 *
Úcomm™
,

2869 
v”siÚ_t
 *
objv”
 = 
NULL
, 
ObjeùO³¿tiÚ
 *
exŒa_İs
 = NULL) {

2870 
veùÜ
<
OSDOp
> 
İs
;

2871 
	gi
 = 
š™_İs
(
İs
, 1, 
exŒa_İs
);

2872 
	gİs
[
i
].
	gİ
.İ = 
CEPH_OSD_OP_RMXATTR
;

2873 
	gİs
[
i
].
	gİ
.
	gx©Œ
.
	gÇme_Ën
 = (
Çme
 ? 
¡¾’
(name) : 0);

2874 
	gİs
[
i
].
	gİ
.
	gx©Œ
.
	gv®ue_Ën
 = 0;

2875 ià(
	gÇme
)

2876 
	gİs
[
i
].
	gšd©a
.
­³nd
(
Çme
, 
İs
[i].
İ
.
x©Œ
.
Çme_Ën
);

2877 
Op
 *
	go
 = 
Ãw
 Op(
oid
, 
Şoc
, 
İs
, 
æags
 | 
glob®_İ_æags
 |

2878 
CEPH_OSD_FLAG_WRITE
, 
Úcomm™
, 
objv”
);

2879 
	go
->
	gmtime
 = 
mtime
;

2880 
	go
->
	g¢­c
 = 
¢­c
;

2881 
ûph_tid_t
 
	gtid
;

2882 
İ_subm™
(
o
, &
tid
);

2883  
	gtid
;

2886 
li¡_nobjeùs
(
NLi¡CÚ‹xt
 *
p
, 
CÚ‹xt
 *
Úfšish
);

2887 
ušt32_t
 
li¡_nobjeùs_£ek
(
NLi¡CÚ‹xt
 *
p
, ušt32_ˆ
pos
);

2888 
ušt32_t
 
li¡_nobjeùs_£ek
(
NLi¡CÚ‹xt
 *
li¡_cÚ‹xt
, cÚ¡ 
hobjeù_t
& 
c
);

2889 
li¡_nobjeùs_g‘_cursÜ
(
NLi¡CÚ‹xt
 *
li¡_cÚ‹xt
, 
hobjeù_t
 *
c
);

2891 
hobjeù_t
 
’um”©e_objeùs_begš
();

2892 
hobjeù_t
 
’um”©e_objeùs_’d
();

2894 
’um”©e_objeùs
(

2895 
št64_t
 
poŞ_id
,

2896 cÚ¡ 
¡d
::
¡ršg
 &
ns
,

2897 cÚ¡ 
hobjeù_t
 &
¡¬t
,

2898 cÚ¡ 
hobjeù_t
 &
’d
,

2899 cÚ¡ 
ušt32_t
 
max
,

2900 cÚ¡ 
bufã¾i¡
 &
f‹r_bl
,

2901 
¡d
::
li¡
<
lib¿dos
::
Li¡ObjeùIm¶
> *
»suÉ
,

2902 
hobjeù_t
 *
Ãxt
,

2903 
CÚ‹xt
 *
Ú_fšish
);

2905 
_’um”©e_»¶y
(

2906 
bufã¾i¡
 &
bl
,

2907 
r
,

2908 cÚ¡ 
hobjeù_t
 &
’d
,

2909 cÚ¡ 
št64_t
 
poŞ_id
,

2910 
budg‘
,

2911 
•och_t
 
»¶y_•och
,

2912 
¡d
::
li¡
<
lib¿dos
::
Li¡ObjeùIm¶
> *
»suÉ
,

2913 
hobjeù_t
 *
Ãxt
,

2914 
CÚ‹xt
 *
Ú_fšish
);

2915 
ä›nd
 
şass
 
	gC_Enum”©eR•ly
;

2919 
	g´iv©e
:

2920 
poŞ_İ_subm™
(
PoŞOp
 *
İ
);

2921 
_poŞ_İ_subm™
(
PoŞOp
 *
İ
);

2922 
_fšish_poŞ_İ
(
PoŞOp
 *
İ
, 
r
);

2923 
_do_d–‘e_poŞ
(
št64_t
 
poŞ
, 
CÚ‹xt
 *
Úfšish
);

2924 
	gpublic
:

2925 
ü—‹_poŞ_¢­
(
št64_t
 
poŞ
, 
¡ršg
& 
¢­Name
, 
CÚ‹xt
 *
Úfšish
);

2926 
®loÿ‹_£lfmªaged_¢­
(
št64_t
 
poŞ
, 
¢­id_t
 *
p¢­id
,

2927 
CÚ‹xt
 *
Úfšish
);

2928 
d–‘e_poŞ_¢­
(
št64_t
 
poŞ
, 
¡ršg
& 
¢­Name
, 
CÚ‹xt
 *
Úfšish
);

2929 
d–‘e_£lfmªaged_¢­
(
št64_t
 
poŞ
, 
¢­id_t
 
¢­
, 
CÚ‹xt
 *
Úfšish
);

2931 
ü—‹_poŞ
(
¡ršg
& 
Çme
, 
CÚ‹xt
 *
Úfšish
, 
ušt64_t
 
auid
=0,

2932 
üush_ruË
=-1);

2933 
d–‘e_poŞ
(
št64_t
 
poŞ
, 
CÚ‹xt
 *
Úfšish
);

2934 
d–‘e_poŞ
(cÚ¡ 
¡ršg
& 
Çme
, 
CÚ‹xt
 *
Úfšish
);

2935 
chªge_poŞ_auid
(
št64_t
 
poŞ
, 
CÚ‹xt
 *
Úfšish
, 
ušt64_t
 
auid
);

2937 
hªdË_poŞ_İ_»¶y
(
MPoŞOpR•ly
 *
m
);

2938 
poŞ_İ_ÿnûl
(
ûph_tid_t
 
tid
, 
r
);

2942 
	g´iv©e
:

2943 
_poŞ¡©_subm™
(
PoŞStOp
 *
İ
);

2944 
	gpublic
:

2945 
hªdË_g‘_poŞ_¡©s_»¶y
(
MG‘PoŞStsR•ly
 *
m
);

2946 
g‘_poŞ_¡©s
(
li¡
<
¡ršg
>& 
poŞs
, 
m­
<¡ršg,
poŞ_¡©_t
> *
»suÉ
,

2947 
CÚ‹xt
 *
Úfšish
);

2948 
poŞ_¡©_İ_ÿnûl
(
ûph_tid_t
 
tid
, 
r
);

2949 
_fšish_poŞ_¡©_İ
(
PoŞStOp
 *
İ
, 
r
);

2953 
	g´iv©e
:

2954 
_fs_¡©s_subm™
(
StfsOp
 *
İ
);

2955 
	gpublic
:

2956 
hªdË_fs_¡©s_»¶y
(
MStfsR•ly
 *
m
);

2957 
g‘_fs_¡©s
(
ûph_¡©fs
& 
»suÉ
, 
boo¡
::
İtiÚ®
<
št64_t
> 
poŞid
,

2958 
CÚ‹xt
 *
Úfšish
);

2959 
¡©fs_İ_ÿnûl
(
ûph_tid_t
 
tid
, 
r
);

2960 
_fšish_¡©fs_İ
(
StfsOp
 *
İ
, 
r
);

2965 
_sg_»ad_fšish
(
veùÜ
<
ObjeùEx‹Á
>& 
ex‹Ás
,

2966 
veùÜ
<
bufã¾i¡
>& 
»suÉbl
,

2967 
bufã¾i¡
 *
bl
, 
CÚ‹xt
 *
Úfšish
);

2969 
	gC_SGR—d
 : 
public
 
CÚ‹xt
 {

2970 
Objeù”
 *
objeù”
;

2971 
	gveùÜ
<
	gObjeùEx‹Á
> 
	gex‹Ás
;

2972 
	gveùÜ
<
	gbufã¾i¡
> 
	g»suÉbl
;

2973 
bufã¾i¡
 *
	gbl
;

2974 
CÚ‹xt
 *
	gÚfšish
;

2975 
C_SGR—d
(
Objeù”
 *
ob
,

2976 
veùÜ
<
ObjeùEx‹Á
>& 
e
, veùÜ<
bufã¾i¡
>& 
r
, bufã¾i¡ *
b
,

2977 
CÚ‹xt
 *
c
) :

2978 
objeù”
(
ob
), 
bl
(
b
), 
Úfšish
(
c
) {

2979 
	gex‹Ás
.
sw­
(
e
);

2980 
	g»suÉbl
.
sw­
(
r
);

2982 
fšish
(
r
è
	gov”ride
 {

2983 
	gobjeù”
->
_sg_»ad_fšish
(
ex‹Ás
, 
»suÉbl
, 
bl
, 
Úfšish
);

2987 
sg_»ad_Œunc
(
veùÜ
<
ObjeùEx‹Á
>& 
ex‹Ás
, 
¢­id_t
 
¢­
,

2988 
bufã¾i¡
 *
bl
, 
æags
, 
ušt64_t
 
Œunc_size
,

2989 
__u32
 
Œunc_£q
, 
CÚ‹xt
 *
Úfšish
, 
İ_æags
 = 0) {

2990 ià(
ex‹Ás
.
size
() == 1) {

2991 
»ad_Œunc
(
ex‹Ás
[0].
oid
,ƒx‹Ás[0].
Şoc
,ƒx‹Ás[0].
off£t
,

2992 
ex‹Ás
[0].
Ëngth
, 
¢­
, 
bl
, 
æags
,ƒx‹Ás[0].
Œunÿ‹_size
,

2993 
Œunc_£q
, 
Úfšish
, 0, 0, 
İ_æags
);

2995 
C_G©h”Bud”
 
g©h”
(
cù
);

2996 
	gveùÜ
<
	gbufã¾i¡
> 
»suÉbl
(
ex‹Ás
.
size
());

2997 
	gi
=0;

2998 
	gveùÜ
<
	gObjeùEx‹Á
>::
™”©Ü
 
p
 = 
ex‹Ás
.
begš
();

2999 
	gp
 !ğ
ex‹Ás
.
’d
();

3000 ++
	gp
) {

3001 
»ad_Œunc
(
p
->
oid
,…->
Şoc
,…->
off£t
,…->
Ëngth
, 
¢­
, &
»suÉbl
[
i
++],

3002 
æags
, 
p
->
Œunÿ‹_size
, 
Œunc_£q
, 
g©h”
.
Ãw_sub
(),

3003 0, 0, 
İ_æags
);

3005 
	gg©h”
.
£t_fšish”
(
Ãw
 
C_SGR—d
(
this
, 
ex‹Ás
, 
»suÉbl
, 
bl
, 
Úfšish
));

3006 
	gg©h”
.
aùiv©e
();

3010 
sg_»ad
(
veùÜ
<
ObjeùEx‹Á
>& 
ex‹Ás
, 
¢­id_t
 
¢­
, 
bufã¾i¡
 *
bl
,

3011 
æags
, 
CÚ‹xt
 *
Úfšish
, 
İ_æags
 = 0) {

3012 
sg_»ad_Œunc
(
ex‹Ás
, 
¢­
, 
bl
, 
æags
, 0, 0, 
Úfšish
, 
İ_æags
);

3015 
sg_wr™e_Œunc
(
veùÜ
<
ObjeùEx‹Á
>& 
ex‹Ás
, cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

3016 cÚ¡ 
bufã¾i¡
& 
bl
, 
ûph
::
»®_time
 
mtime
, 
æags
,

3017 
ušt64_t
 
Œunc_size
, 
__u32
 
Œunc_£q
,

3018 
CÚ‹xt
 *
Úcomm™
, 
İ_æags
 = 0) {

3019 ià(
ex‹Ás
.
size
() == 1) {

3020 
wr™e_Œunc
(
ex‹Ás
[0].
oid
,ƒx‹Ás[0].
Şoc
,ƒx‹Ás[0].
off£t
,

3021 
ex‹Ás
[0].
Ëngth
, 
¢­c
, 
bl
, 
mtime
, 
æags
,

3022 
ex‹Ás
[0].
Œunÿ‹_size
, 
Œunc_£q
, 
Úcomm™
,

3023 0, 0, 
İ_æags
);

3025 
C_G©h”Bud”
 
gcom
(
cù
, 
Úcomm™
);

3026 
	gveùÜ
<
	gObjeùEx‹Á
>::
™”©Ü
 
p
 = 
ex‹Ás
.
begš
();

3027 
	gp
 !ğ
ex‹Ás
.
’d
();

3028 ++
	gp
) {

3029 
bufã¾i¡
 
	gcur
;

3030 
	gveùÜ
<
	g·œ
<
	gušt64_t
,ušt64_t> >::
™”©Ü
 
b™


3031 ğ
p
->
bufãr_ex‹Ás
.
begš
();

3032 
	gb™
 !ğ
p
->
bufãr_ex‹Ás
.
’d
();

3033 ++
	gb™
)

3034 
	gbl
.
cİy
(
b™
->
fœ¡
, b™->
£cÚd
, 
cur
);

3035 
as£¹
(
cur
.
Ëngth
(è=ğ
p
->length);

3036 
wr™e_Œunc
(
p
->
oid
,…->
Şoc
,…->
off£t
,…->
Ëngth
,

3037 
¢­c
, 
cur
, 
mtime
, 
æags
, 
p
->
Œunÿ‹_size
, 
Œunc_£q
,

3038 
Úcomm™
 ? 
gcom
.
Ãw_sub
():0,

3039 0, 0, 
İ_æags
);

3041 
	ggcom
.
aùiv©e
();

3045 
sg_wr™e
(
veùÜ
<
ObjeùEx‹Á
>& 
ex‹Ás
, cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

3046 cÚ¡ 
bufã¾i¡
& 
bl
, 
ûph
::
»®_time
 
mtime
, 
æags
,

3047 
CÚ‹xt
 *
Úcomm™
, 
İ_æags
 = 0) {

3048 
sg_wr™e_Œunc
(
ex‹Ás
, 
¢­c
, 
bl
, 
mtime
, 
æags
, 0, 0, 
Úcomm™
,

3049 
İ_æags
);

3052 
ms_hªdË_cÚÃù
(
CÚÃùiÚ
 *
cÚ
è
	gov”ride
;

3053 
boŞ
 
ms_hªdË_»£t
(
CÚÃùiÚ
 *
cÚ
è
	gov”ride
;

3054 
ms_hªdË_»mÙe_»£t
(
CÚÃùiÚ
 *
cÚ
è
	gov”ride
;

3055 
boŞ
 
ms_hªdË_»fu£d
(
CÚÃùiÚ
 *
cÚ
è
	gov”ride
;

3056 
boŞ
 
ms_g‘_authÜiz”
(
de¡_ty³
,

3057 
AuthAuthÜiz”
 **
authÜiz”
,

3058 
boŞ
 
fÜû_Ãw
è
	gov”ride
;

3060 
bÏckli¡_£lf
(
boŞ
 
£t
);

3062 
	g´iv©e
:

3063 
•och_t
 
•och_b¬r›r
;

3064 
boŞ
 
	g»Œy_wr™es_aá”_fœ¡_»¶y
;

3065 
	gpublic
:

3066 
£t_•och_b¬r›r
(
•och_t
 
•och
);

3068 
P”fCouÁ”s
 *
g‘_logg”
() {

3069  
	glogg”
;

	@osdc/Striper.cc

15 
	~"SŒ”.h
"

17 
	~"šşude/ty³s.h
"

18 
	~"šşude/bufãr.h
"

19 
	~"osd/OSDM­.h
"

21 
	~"commÚ/cÚfig.h
"

22 
	~"commÚ/debug.h
"

24 
	#dout_subsys
 
ûph_subsys_¡r”


	)

25 #undeà
dout_´efix


26 
	#dout_´efix
 *
_dout
 << "¡r” "

	)

29 
	gSŒ”
::
fe_to_ex‹Ás
(
C•hCÚ‹xt
 *
cù
, cÚ¡ *
objeù_fÜm©
,

30 cÚ¡ 
fe_Ïyout_t
 *
Ïyout
,

31 
ušt64_t
 
off£t
, ušt64_ˆ
Ën
,

32 
ušt64_t
 
Œunc_size
,

33 
veùÜ
<
ObjeùEx‹Á
>& 
ex‹Ás
,

34 
ušt64_t
 
bufãr_off£t
)

36 
	gm­
<
	gobjeù_t
,
	gveùÜ
<
	gObjeùEx‹Á
> > 
	gobjeù_ex‹Ás
;

37 
fe_to_ex‹Ás
(
cù
, 
objeù_fÜm©
, 
Ïyout
, 
off£t
, 
Ën
, 
Œunc_size
,

38 
objeù_ex‹Ás
, 
bufãr_off£t
);

39 
assim©e_ex‹Ás
(
objeù_ex‹Ás
, 
ex‹Ás
);

42 
	gSŒ”
::
fe_to_ex‹Ás
(

43 
C•hCÚ‹xt
 *
cù
, cÚ¡ *
objeù_fÜm©
,

44 cÚ¡ 
fe_Ïyout_t
 *
Ïyout
,

45 
ušt64_t
 
off£t
, ušt64_ˆ
Ën
,

46 
ušt64_t
 
Œunc_size
,

47 
m­
<
objeù_t
,
veùÜ
<
ObjeùEx‹Á
> >& 
objeù_ex‹Ás
,

48 
ušt64_t
 
bufãr_off£t
)

50 
ldout
(
cù
, 10è<< "fe_to_ex‹Á " << 
	goff£t
 << "~" << 
	gËn


51 << " fÜm© " << 
	gobjeù_fÜm©


52 << 
	gd’dl
;

53 
as£¹
(
Ën
 > 0);

61 
__u32
 
	gobjeù_size
 = 
Ïyout
->
objeù_size
;

62 
__u32
 
	gsu
 = 
Ïyout
->
¡re_un™
;

63 
__u32
 
	g¡re_couÁ
 = 
Ïyout
->
¡re_couÁ
;

64 
as£¹
(
objeù_size
 >ğ
su
);

65 ià(
	g¡re_couÁ
 == 1) {

66 
ldout
(
cù
, 20è<< " søi Úe,„e£ˆsuØos" << 
d’dl
;

67 
	gsu
 = 
objeù_size
;

69 
ušt64_t
 
	g¡res_³r_objeù
 = 
objeù_size
 / 
su
;

70 
ldout
(
cù
, 20è<< " su " << 
	gsu
 << " sø" << 
	g¡re_couÁ
 << " os "

71 << 
	gobjeù_size
 << " sŒes_³r_objeù " << 
	g¡res_³r_objeù


72 << 
	gd’dl
;

74 
ušt64_t
 
	gcur
 = 
off£t
;

75 
ušt64_t
 
	gËá
 = 
Ën
;

76 
	gËá
 > 0) {

78 
ušt64_t
 
	gblockno
 = 
cur
 / 
su
;

80 
ušt64_t
 
	g¡r’o
 = 
blockno
 / 
¡re_couÁ
;

82 
ušt64_t
 
	g¡r•os
 = 
blockno
 % 
¡re_couÁ
;

84 
ušt64_t
 
	gobjeù£Šo
 = 
¡r’o
 / 
¡res_³r_objeù
;

86 
ušt64_t
 
	gobjeùno
 = 
objeù£Šo
 * 
¡re_couÁ
 + 
¡r•os
;

89 
	gbuf
[
¡¾’
(
objeù_fÜm©
) + 32];

90 
¢´štf
(
buf
, (buf), 
objeù_fÜm©
, ()
objeùno
);

91 
objeù_t
 
	goid
 = 
buf
;

94 
ušt64_t
 
	gblock_¡¬t
 = (
¡r’o
 % 
¡res_³r_objeù
è* 
su
;

95 
ušt64_t
 
	gblock_off
 = 
cur
 % 
su
;

96 
ušt64_t
 
	gmax
 = 
su
 - 
block_off
;

98 
ušt64_t
 
	gx_off£t
 = 
block_¡¬t
 + 
block_off
;

99 
ušt64_t
 
	gx_Ën
;

100 ià(
	gËá
 > 
	gmax
)

101 
	gx_Ën
 = 
max
;

103 
	gx_Ën
 = 
Ëá
;

105 
ldout
(
cù
, 20è<< " ofà" << 
	gcur
 << " blocknØ" << 
	gblockno
 << " stripeno "

106 << 
	g¡r’o
 << " sŒ•o " << 
	g¡r•os
 << " objectsetno "

107 << 
	gobjeù£Šo
 << " objeùnØ" << 
	gobjeùno


108 << " block_¡¬ˆ" << 
	gblock_¡¬t
 << " block_off "

109 << 
	gblock_off
 << " " << 
	gx_off£t
 << "~" << 
	gx_Ën


110 << 
	gd’dl
;

112 
ObjeùEx‹Á
 *
	gex
 = 0;

113 
	gveùÜ
<
	gObjeùEx‹Á
>& 
	gexv
 = 
objeù_ex‹Ás
[
oid
];

114 ià(
	gexv
.
em±y
(è||ƒxv.
back
().
	goff£t
 +ƒxv.back().
	gËngth
 !ğ
x_off£t
) {

115 
exv
.
»size
Óxv.
size
() + 1);

116 
	gex
 = &
exv
.
back
();

117 
	gex
->
	goid
 = 
oid
;

118 
	gex
->
	gobjeùno
 = 
objeùno
;

119 
	gex
->
	gŞoc
 = 
OSDM­
::
fe_to_objeù_loÿtÜ
(*
Ïyout
);

121 
	gex
->
	goff£t
 = 
x_off£t
;

122 
	gex
->
	gËngth
 = 
x_Ën
;

123 
	gex
->
	gŒunÿ‹_size
 = 
objeù_Œunÿ‹_size
(
cù
, 
Ïyout
, 
objeùno
,

124 
Œunc_size
);

126 
ldout
(
cù
, 20è<< "‡dded‚ew " << *
	gex
 << 
	gd’dl
;

129 
	gex
 = &
exv
.
back
();

130 
ldout
(
cù
, 20è<< "‡ddšg iÀtØ" << *
	gex
 << 
	gd’dl
;

131 
	gex
->
	gËngth
 +ğ
x_Ën
;

133 
	gex
->
	gbufãr_ex‹Ás
.
push_back
(
make_·œ
(
cur
 - 
off£t
 + 
bufãr_off£t
,

134 
x_Ën
));

136 
ldout
(
cù
, 15è<< "fe_to_ex‹Á  " << *
	gex
 << " iÀ" <<ƒx->
	gŞoc


137 << 
	gd’dl
;

142 
	gËá
 -ğ
x_Ën
;

143 
	gcur
 +ğ
x_Ën
;

147 
	gSŒ”
::
assim©e_ex‹Ás
(

148 
m­
<
objeù_t
,
veùÜ
<
ObjeùEx‹Á
> >& 
objeù_ex‹Ás
,

149 
veùÜ
<
ObjeùEx‹Á
>& 
ex‹Ás
)

152 
	gm­
<
	gobjeù_t
, 
	gveùÜ
<
	gObjeùEx‹Á
> >::
™”©Ü
 
™


153 ğ
objeù_ex‹Ás
.
begš
();

154 
	g™
 !ğ
objeù_ex‹Ás
.
’d
();

155 ++
	g™
) {

156 
	gveùÜ
<
	gObjeùEx‹Á
>::
™”©Ü
 
p
 = 
™
->
£cÚd
.
begš
();

157 
	gp
 !ğ
™
->
£cÚd
.
’d
();

158 ++
	gp
) {

159 
	gex‹Ás
.
push_back
(*
p
);

164 
	gSŒ”
::
ex‹Á_to_fe
(
C•hCÚ‹xt
 *
cù
, 
fe_Ïyout_t
 *
Ïyout
,

165 
ušt64_t
 
objeùno
, ušt64_ˆ
off
, ušt64_ˆ
Ën
,

166 
veùÜ
<
·œ
<
ušt64_t
, ušt64_t> >& 
ex‹Ás
)

168 
ldout
(
cù
, 10è<< "ex‹Á_to_f" << 
	gobjeùno
 << " " << 
	goff
 << "~"

169 << 
	gËn
 << 
	gd’dl
;

171 
__u32
 
	gobjeù_size
 = 
Ïyout
->
objeù_size
;

172 
__u32
 
	gsu
 = 
Ïyout
->
¡re_un™
;

173 
__u32
 
	g¡re_couÁ
 = 
Ïyout
->
¡re_couÁ
;

174 
as£¹
(
objeù_size
 >ğ
su
);

175 
ušt64_t
 
	g¡res_³r_objeù
 = 
objeù_size
 / 
su
;

176 
ldout
(
cù
, 20è<< " sŒes_³r_objeù " << 
	g¡res_³r_objeù
 << 
	gd’dl
;

178 
ušt64_t
 
	goff_š_block
 = 
off
 % 
su
;

180 
	gex‹Ás
.
»£rve
(
Ën
 / 
su
 + 1);

182 
	gËn
 > 0) {

183 
ušt64_t
 
	g¡r•os
 = 
objeùno
 % 
¡re_couÁ
;

184 
ušt64_t
 
	gobjeù£Šo
 = 
objeùno
 / 
¡re_couÁ
;

185 
ušt64_t
 
	g¡r’o
 = 
off
 / 
su
 + 
objeù£Šo
 * 
¡res_³r_objeù
;

186 
ušt64_t
 
	gblockno
 = 
¡r’o
 * 
¡re_couÁ
 + 
¡r•os
;

187 
ušt64_t
 
	gex‹Á_off
 = 
blockno
 * 
su
 + 
off_š_block
;

188 
ušt64_t
 
	gex‹Á_Ën
 = 
¡d
::
mš
(
Ën
, 
su
 - 
off_š_block
);

189 
	gex‹Ás
.
push_back
(
make_·œ
(
ex‹Á_off
, 
ex‹Á_Ën
));

191 
ldout
(
cù
, 20è<< " objeù " << 
	goff
 << "~" << 
	gex‹Á_Ën


192 << " -> f" << 
	gex‹Á_off
 << "~" << 
	gex‹Á_Ën


193 << 
	gd’dl
;

195 
	goff_š_block
 = 0;

196 
	goff
 +ğ
ex‹Á_Ën
;

197 
	gËn
 -ğ
ex‹Á_Ën
;

201 
ušt64_t
 
	gSŒ”
::
	$objeù_Œunÿ‹_size
(
C•hCÚ‹xt
 *
cù
,

202 cÚ¡ 
fe_Ïyout_t
 *
Ïyout
,

203 
ušt64_t
 
objeùno
, ušt64_ˆ
Œunc_size
)

205 
ušt64_t
 
obj_Œunc_size
;

206 ià(
Œunc_size
 =ğ0 ||runc_siz=ğ(
ušt64_t
)-1) {

207 
obj_Œunc_size
 = 
Œunc_size
;

209 
__u32
 
objeù_size
 = 
Ïyout
->object_size;

210 
__u32
 
su
 = 
Ïyout
->
¡re_un™
;

211 
__u32
 
¡re_couÁ
 = 
Ïyout
->stripe_count;

212 
	`as£¹
(
objeù_size
 >ğ
su
);

213 
ušt64_t
 
¡res_³r_objeù
 = 
objeù_size
 / 
su
;

215 
ušt64_t
 
objeù£Šo
 = 
objeùno
 / 
¡re_couÁ
;

216 
ušt64_t
 
Œunc_objeù£Šo
 = 
Œunc_size
 / 
objeù_size
 / 
¡re_couÁ
;

217 ià(
objeù£Šo
 > 
Œunc_objeù£Šo
)

218 
obj_Œunc_size
 = 0;

219 ià(
objeù£Šo
 < 
Œunc_objeù£Šo
)

220 
obj_Œunc_size
 = 
objeù_size
;

222 
ušt64_t
 
Œunc_blockno
 = 
Œunc_size
 / 
su
;

223 
ušt64_t
 
Œunc_¡r’o
 = 
Œunc_blockno
 / 
¡re_couÁ
;

224 
ušt64_t
 
Œunc_¡r•os
 = 
Œunc_blockno
 % 
¡re_couÁ
;

225 
ušt64_t
 
Œunc_objeùno
 = 
Œunc_objeù£Šo
 * 
¡re_couÁ


226 + 
Œunc_¡r•os
;

227 ià(
objeùno
 < 
Œunc_objeùno
)

228 
obj_Œunc_size
 = ((
Œunc_¡r’o
 % 
¡res_³r_objeù
è+ 1è* 
su
;

229 ià(
objeùno
 > 
Œunc_objeùno
)

230 
obj_Œunc_size
 = (
Œunc_¡r’o
 % 
¡res_³r_objeù
è* 
su
;

232 
obj_Œunc_size
 = (
Œunc_¡r’o
 % 
¡res_³r_objeù
è* 
su


233 + (
Œunc_size
 % 
su
);

236 
	`ldout
(
cù
, 20è<< "objeù_Œunÿ‹_siz" << 
objeùno
 << " "

237 << 
Œunc_size
 << "->" << 
obj_Œunc_size
 << 
d’dl
;

238  
obj_Œunc_size
;

239 
	}
}

241 
ušt64_t
 
	gSŒ”
::
	$g‘_num_objeùs
(cÚ¡ 
fe_Ïyout_t
& 
Ïyout
,

242 
ušt64_t
 
size
)

244 
__u32
 
¡re_un™
 = 
Ïyout
.stripe_unit;

245 
__u32
 
¡re_couÁ
 = 
Ïyout
.stripe_count;

246 
ušt64_t
 
³riod
 = 
Ïyout
.
	`g‘_³riod
();

247 
ušt64_t
 
num_³riods
 = (
size
 + 
³riod
 - 1) /…eriod;

248 
ušt64_t
 
»mašd”_by‹s
 = 
size
 % 
³riod
;

249 
ušt64_t
 
»mašd”_objs
 = 0;

250 ià((
»mašd”_by‹s
 > 0è&& (»mašd”_by‹ < (
ušt64_t
)
¡re_couÁ


251 * 
¡re_un™
))

252 
»mašd”_objs
 = 
¡re_couÁ
 - ((
»mašd”_by‹s
 + 
¡re_un™
 - 1)

253 / 
¡re_un™
);

254  
num_³riods
 * 
¡re_couÁ
 - 
»mašd”_objs
;

255 
	}
}

259 
	gSŒ”
::
SŒedR—dResuÉ
::
add_·¹Ÿl_»suÉ
(

260 
C•hCÚ‹xt
 *
cù
, 
bufã¾i¡
& 
bl
,

261 cÚ¡ 
veùÜ
<
·œ
<
ušt64_t
,ušt64_t> >& 
bufãr_ex‹Ás
)

263 
ldout
(
cù
, 10è<< "add_·¹Ÿl_»suÉ(" << 
	gthis
 << "è" << 
	gbl
.
Ëngth
()

264 << "Ø" << 
	gbufãr_ex‹Ás
 << 
	gd’dl
;

265 
	gveùÜ
<
	g·œ
<
	gušt64_t
,ušt64_t> >::
cÚ¡_™”©Ü
 
p


266 ğ
bufãr_ex‹Ás
.
begš
();

267 
	gp
 !ğ
bufãr_ex‹Ás
.
’d
();

268 ++
	gp
) {

269 
	g·œ
<
	gbufã¾i¡
, 
	gušt64_t
>& 
	gr
 = 
·¹Ÿl
[
p
->
fœ¡
];

270 
size_t
 
	gaùu®
 = 
¡d
::
mš
<
ušt64_t
>(
bl
.
Ëngth
(), 
	gp
->
	g£cÚd
);

271 
	gbl
.
¥liû
(0, 
aùu®
, &
r
.
fœ¡
);

272 
	gr
.
	g£cÚd
 = 
p
->
£cÚd
;

273 
	gtÙ®_š‹nded_Ën
 +ğ
r
.
£cÚd
;

277 
	gSŒ”
::
SŒedR—dResuÉ
::
add_·¹Ÿl_¥¬£_»suÉ
(

278 
C•hCÚ‹xt
 *
cù
, 
bufã¾i¡
& 
bl
, cÚ¡ 
m­
<
ušt64_t
, ušt64_t>& 
bl_m­
,

279 
ušt64_t
 
bl_off
, cÚ¡ 
veùÜ
<
·œ
<ušt64_t,ušt64_t> >& 
bufãr_ex‹Ás
)

281 
ldout
(
cù
, 10è<< "add_·¹Ÿl_¥¬£_»suÉ(" << 
	gthis
 << "è" << 
	gbl
.
Ëngth
()

282 << " cov”šg " << 
	gbl_m­
 << " (off£ˆ" << 
	gbl_off
 << ")"

283 << "Ø" << 
	gbufãr_ex‹Ás
 << 
	gd’dl
;

284 
	gm­
<
	gušt64_t
, ušt64_t>::
cÚ¡_™”©Ü
 
s
 = 
bl_m­
.
begš
();

285 
	gveùÜ
<
	g·œ
<
	gušt64_t
,ušt64_t> >::
cÚ¡_™”©Ü
 
p


286 ğ
bufãr_ex‹Ás
.
begš
();

287 
	gp
 !ğ
bufãr_ex‹Ás
.
’d
();

288 ++
	gp
) {

289 
ušt64_t
 
	gtofs
 = 
p
->
fœ¡
;

290 
size_t
 
	g’
 = 
p
->
£cÚd
;

291 
ldout
(
cù
, 30è<< " b" << 
	gtofs
 << "~" << 
	g’
 << 
	gd’dl
;

292 
	g’
 > 0) {

293 
ldout
(
cù
, 20è<< " " << 
	gtofs
 << "~" << 
	g’


294 << " bÈha " << 
	gbl
.
Ëngth
()

295 << " ofà" << 
	gbl_off


296 << 
	gd’dl
;

297 ià(
	gs
 =ğ
bl_m­
.
’d
()) {

298 
ldout
(
cù
, 20è<< " s‡ˆ’d" << 
d’dl
;

299 
	g·œ
<
	gbufã¾i¡
, 
	gušt64_t
>& 
	gr
 = 
·¹Ÿl
[
tofs
];

300 
	gr
.
	g£cÚd
 = 
’
;

301 
	gtÙ®_š‹nded_Ën
 +ğ
r
.
£cÚd
;

305 
ldout
(
cù
, 30è<< " s " << 
	gs
->
	gfœ¡
 << "~" << s->
	g£cÚd
 << 
	gd’dl
;

308 ià(
	gs
->
	g£cÚd
 == 0) {

309 
ldout
(
cù
, 30è<< " s†’ 0, skpšg" << 
d’dl
;

310 ++
	gs
;

314 ià(
	gs
->
	gfœ¡
 > 
	gbl_off
) {

316 
	g·œ
<
	gbufã¾i¡
, 
	gušt64_t
>& 
	gr
 = 
·¹Ÿl
[
tofs
];

317 
size_t
 
	gg­
 = 
¡d
::
mš
<size_t>(
s
->
fœ¡
 - 
bl_off
, 
	g’
);

318 
ldout
(
cù
, 20è<< " s g­ " << 
	gg­
 << ", skpšg" << 
	gd’dl
;

319 
	gr
.
	g£cÚd
 = 
g­
;

320 
	gtÙ®_š‹nded_Ën
 +ğ
r
.
£cÚd
;

321 
	gbl_off
 +ğ
g­
;

322 
	gtofs
 +ğ
g­
;

323 
	g’
 -ğ
g­
;

324 ià(
	g’
 == 0) {

329 
as£¹
(
s
->
fœ¡
 <ğ
bl_off
);

330 
size_t
 
	gËá
 = (
s
->
fœ¡
 + s->
£cÚd
è- 
bl_off
;

331 
size_t
 
	gaùu®
 = 
¡d
::
mš
(
Ëá
, 
’
);

333 ià(
	gaùu®
 > 0) {

334 
ldout
(
cù
, 20è<< " s ha " << 
	gaùu®
 << ", cİyšg" << 
	gd’dl
;

335 
	g·œ
<
	gbufã¾i¡
, 
	gušt64_t
>& 
	gr
 = 
·¹Ÿl
[
tofs
];

336 
	gbl
.
¥liû
(0, 
aùu®
, &
r
.
fœ¡
);

337 
	gr
.
	g£cÚd
 = 
aùu®
;

338 
	gtÙ®_š‹nded_Ën
 +ğ
r
.
£cÚd
;

339 
	gbl_off
 +ğ
aùu®
;

340 
	gtofs
 +ğ
aùu®
;

341 
	g’
 -ğ
aùu®
;

343 ià(
	gaùu®
 =ğ
Ëá
) {

344 
ldout
(
cù
, 30è<< " s‡dvªcšg" << 
d’dl
;

345 ++
	gs
;

351 
	gSŒ”
::
SŒedR—dResuÉ
::
	$as£mbË_»suÉ
(
C•hCÚ‹xt
 *
cù
,

352 
bufã¾i¡
& 
bl
,

353 
boŞ
 
z”o_
)

355 
	`ldout
(
cù
, 10è<< "as£mbË_»suÉ(" << 
this
 << "èz”o_=" << 
z”o_


356 << 
d’dl
;

357 
size_t
 
z”os
 = 0;

358 auto& 
p
 : 
·¹Ÿl
) {

359 
size_t
 
gÙ
 = 
p
.
£cÚd
.
fœ¡
.
	`Ëngth
();

360 
size_t
 
ex³ù
 = 
p
.
£cÚd
.second;

361 ià(
gÙ
) {

362 ià(
z”os
) {

363 
bl
.
	`­³nd_z”o
(
z”os
);

364 
z”os
 = 0;

366 
bl
.
	`şaim_­³nd
(
p
.
£cÚd
.
fœ¡
);

368 
z”os
 +ğ
ex³ù
 - 
gÙ
;

370 ià(
z”o_
 && 
z”os
) {

371 
bl
.
	`­³nd_z”o
(
z”os
);

373 
·¹Ÿl
.
	`ş—r
();

374 
	}
}

376 
	gSŒ”
::
SŒedR—dResuÉ
::
	$as£mbË_»suÉ
(
C•hCÚ‹xt
 *
cù
, *
bufãr
, 
size_t
 
Ëngth
)

379 
	`as£¹
(
bufãr
 && 
Ëngth
 =ğ
tÙ®_š‹nded_Ën
);

381 
m­
<
ušt64_t
,
·œ
<
bufã¾i¡
,ušt64_t> >::
»v”£_™”©Ü
 
p
 = 
·¹Ÿl
.
	`rbegš
();

382 ià(
p
 =ğ
·¹Ÿl
.
	`»nd
())

385 
ušt64_t
 
cu¼
 = 
Ëngth
;

386 
ušt64_t
 
’d
 = 
p
->
fœ¡
 +…->
£cÚd
.second;

387 
p
 !ğ
·¹Ÿl
.
	`»nd
()) {

389 
	`ldout
(
cù
, 20è<< "as£mbË_»suÉ(" << 
this
 << "è" << 
p
->
fœ¡
 << "~" <<…->
£cÚd
.second

390 << " " << 
p
->
£cÚd
.
fœ¡
.
	`Ëngth
() << " bytes"

391 << 
d’dl
;

392 
	`as£¹
(
p
->
fœ¡
 =ğ
’d
 -…->
£cÚd
.second);

393 
’d
 = 
p
->
fœ¡
;

395 
size_t
 
Ën
 = 
p
->
£cÚd
.
fœ¡
.
	`Ëngth
();

396 
	`as£¹
(
cu¼
 >ğ
p
->
£cÚd
.second);

397 
cu¼
 -ğ
p
->
£cÚd
.second;

398 ià(
Ën
 < 
p
->
£cÚd
.second) {

399 ià(
Ën
)

400 
p
->
£cÚd
.
fœ¡
.
	`cİy
(0, 
Ën
, 
bufãr
 + 
cu¼
);

401 
	`mem£t
(
bufãr
 + 
cu¼
 + 
Ën
, 0, 
p
->
£cÚd
.second -†en);

403 
p
->
£cÚd
.
fœ¡
.
	`cİy
(0, 
Ën
, 
bufãr
 + 
cu¼
);

405 ++
p
;

407 
·¹Ÿl
.
	`ş—r
();

408 
	`as£¹
(
cu¼
 == 0);

409 
	}
}

	@osdc/Striper.h

15 #iâdeà
CEPH_STRIPER_H


16 
	#CEPH_STRIPER_H


	)

18 
	~"šşude/ty³s.h
"

19 
	~"osd/osd_ty³s.h
"

21 
şass
 
	gC•hCÚ‹xt
;

25 şas 
	cSŒ”
 {

26 
	mpublic
:

31 
fe_to_ex‹Ás
(
C•hCÚ‹xt
 *
cù
, cÚ¡ *
objeù_fÜm©
,

32 cÚ¡ 
fe_Ïyout_t
 *
Ïyout
,

33 
ušt64_t
 
off£t
, ušt64_ˆ
Ën
,

34 
ušt64_t
 
Œunc_size
,

35 
m­
<
objeù_t
, 
veùÜ
<
ObjeùEx‹Á
> >& 
ex‹Ás
,

36 
ušt64_t
 
bufãr_off£t
=0);

38 
fe_to_ex‹Ás
(
C•hCÚ‹xt
 *
cù
, cÚ¡ *
objeù_fÜm©
,

39 cÚ¡ 
fe_Ïyout_t
 *
Ïyout
,

40 
ušt64_t
 
off£t
, ušt64_ˆ
Ën
,

41 
ušt64_t
 
Œunc_size
,

42 
veùÜ
<
ObjeùEx‹Á
>& 
ex‹Ás
,

43 
ušt64_t
 
bufãr_off£t
=0);

45 
fe_to_ex‹Ás
(
C•hCÚ‹xt
 *
cù
, 
šod’o_t
 
šo
,

46 cÚ¡ 
fe_Ïyout_t
 *
Ïyout
,

47 
ušt64_t
 
off£t
, ušt64_ˆ
Ën
,

48 
ušt64_t
 
Œunc_size
,

49 
veùÜ
<
ObjeùEx‹Á
>& 
ex‹Ás
) {

51 
	mbuf
[32];

52 
¢´štf
(
buf
, (buf), "%Îx.%%08Îx", ()
šo
);

54 
fe_to_ex‹Ás
(
cù
, 
buf
, 
Ïyout
, 
off£t
, 
Ën
, 
Œunc_size
, 
ex‹Ás
);

57 
assim©e_ex‹Ás
(

58 
m­
<
objeù_t
, 
veùÜ
<
ObjeùEx‹Á
> >& 
objeù_ex‹Ás
,

59 
veùÜ
<
ObjeùEx‹Á
>& 
ex‹Ás
);

64 
ex‹Á_to_fe
(
C•hCÚ‹xt
 *
cù
, 
fe_Ïyout_t
 *
Ïyout
,

65 
ušt64_t
 
objeùno
, ušt64_ˆ
off
, ušt64_ˆ
Ën
,

66 
veùÜ
<
·œ
<
ušt64_t
, ušt64_t> >& 
ex‹Ás
);

68 
ušt64_t
 
objeù_Œunÿ‹_size
(

69 
C•hCÚ‹xt
 *
cù
, cÚ¡ 
fe_Ïyout_t
 *
Ïyout
,

70 
ušt64_t
 
objeùno
, ušt64_ˆ
Œunc_size
);

72 
ušt64_t
 
g‘_num_objeùs
(cÚ¡ 
fe_Ïyout_t
& 
Ïyout
,

73 
ušt64_t
 
size
);

77 şas 
	cSŒedR—dResuÉ
 {

79 
	gm­
<
	gušt64_t
, 
	g·œ
<
	gbufã¾i¡
, ušt64_t> > 
	g·¹Ÿl
;

80 
ušt64_t
 
	gtÙ®_š‹nded_Ën
 = 0;

82 
	gpublic
:

83 
add_·¹Ÿl_»suÉ
(

84 
C•hCÚ‹xt
 *
cù
, 
bufã¾i¡
& 
bl
,

85 cÚ¡ 
veùÜ
<
·œ
<
ušt64_t
,ušt64_t> >& 
bufãr_ex‹Ás
);

95 
add_·¹Ÿl_¥¬£_»suÉ
(

96 
C•hCÚ‹xt
 *
cù
, 
bufã¾i¡
& 
bl
,

97 cÚ¡ 
m­
<
ušt64_t
, ušt64_t>& 
bl_m­
, ušt64_ˆ
bl_off
,

98 cÚ¡ 
veùÜ
<
·œ
<
ušt64_t
,ušt64_t> >& 
bufãr_ex‹Ás
);

100 
as£mbË_»suÉ
(
C•hCÚ‹xt
 *
cù
, 
bufã¾i¡
& 
bl
, 
boŞ
 
z”o_
);

106 
as£mbË_»suÉ
(
C•hCÚ‹xt
 *
cù
, *
bufãr
, 
size_t
 
Ën
);

	@osdc/WritebackHandler.h

3 #iâdeà
CEPH_OSDC_WRITEBACKHANDLER_H


4 
	#CEPH_OSDC_WRITEBACKHANDLER_H


	)

6 
	~"šşude/CÚ‹xt.h
"

7 
	~"šşude/ty³s.h
"

8 
	~"osd/osd_ty³s.h
"

10 şas 
	cWr™ebackHªdËr
 {

11 
	mpublic
:

12 
	$Wr™ebackHªdËr
() {}

13 
vœtu®
 ~
	$Wr™ebackHªdËr
(è{
	}
}

15 
vœtu®
 
»ad
(cÚ¡ 
objeù_t
& 
oid
, 
ušt64_t
 
objeù_no
,

16 cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
, 
ušt64_t
 
off
, ušt64_ˆ
Ën
,

17 
¢­id_t
 
¢­id
, 
bufã¾i¡
 *
pbl
, 
ušt64_t
 
Œunc_size
,

18 
__u32
 
Œunc_£q
, 
İ_æags
,

19 cÚ¡ 
ZT¿ûr
::
T¿û
 &
·»Á_Œaû
, 
CÚ‹xt
 *
Úfšish
) = 0;

31 
vœtu®
 
boŞ
 
may_cİy_Ú_wr™e
(cÚ¡ 
objeù_t
& 
oid
, 
ušt64_t
 
»ad_off
,

32 
ušt64_t
 
»ad_Ën
, 
¢­id_t
 
¢­id
) = 0;

33 
vœtu®
 
ûph_tid_t
 
wr™e
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

34 
ušt64_t
 
off
, ušt64_ˆ
Ën
,

35 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
,

36 cÚ¡ 
bufã¾i¡
 &
bl
, 
ûph
::
»®_time
 
mtime
,

37 
ušt64_t
 
Œunc_size
, 
__u32
 
Œunc_£q
,

38 
ûph_tid_t
 
jouº®_tid
,

39 cÚ¡ 
ZT¿ûr
::
T¿û
 &
·»Á_Œaû
,

40 
CÚ‹xt
 *
Úcomm™
) = 0;

42 
vœtu®
 
	$ov”wr™e_ex‹Á
(cÚ¡ 
objeù_t
& 
oid
, 
ušt64_t
 
off
, ušt64_ˆ
Ën
,

43 
ûph_tid_t
 
Üigš®_jouº®_tid
,

44 
ûph_tid_t
 
Ãw_jouº®_tid
è{
	}
}

46 
vœtu®
 
boŞ
 
	$ÿn_sÿ‰”ed_wr™e
(è{  
çl£
; 
	}
}

47 
vœtu®
 
ûph_tid_t
 
wr™e
(cÚ¡ 
objeù_t
& 
oid
, cÚ¡ 
objeù_loÿtÜ_t
& 
Şoc
,

48 
veùÜ
<
·œ
<
ušt64_t
, 
bufã¾i¡
> >& 
io_vec
,

49 cÚ¡ 
SÇpCÚ‹xt
& 
¢­c
, 
ûph
::
»®_time
 
mtime
,

50 
ušt64_t
 
Œunc_size
, 
__u32
 
Œunc_£q
,

51 
CÚ‹xt
 *
Úcomm™
) {

	@/usr/include/dlfcn.h

19 #iâdef 
_DLFCN_H


20 
	#_DLFCN_H
 1

	)

22 
	~<ã©u»s.h
>

23 
	#__Ãed_size_t


	)

24 
	~<¡ddef.h
>

27 
	~<b™s/dlfú.h
>

30 #ifdeà
__USE_GNU


35 
	#RTLD_NEXT
 ((*è-1l)

	)

40 
	#RTLD_DEFAULT
 ((*è0)

	)

44 
	tLmid_t
;

47 
	#LM_ID_BASE
 0

	)

48 
	#LM_ID_NEWLM
 -1

	)

52 
__BEGIN_DECLS


56 *
	$dlİ’
 (cÚ¡ *
__fe
, 
__mode
è
__THROWNL
;

60 
	$dlşo£
 (*
__hªdË
è
__THROWNL
 
	`__nÚnuÎ
 ((1));

64 *
	$dlsym
 (*
__»¡riù
 
__hªdË
,

65 cÚ¡ *
__»¡riù
 
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((2));

67 #ifdeà
__USE_GNU


69 *
	$dlmİ’
 (
Lmid_t
 
__nsid
, cÚ¡ *
__fe
, 
__mode
è
__THROWNL
;

73 *
	$dlvsym
 (*
__»¡riù
 
__hªdË
,

74 cÚ¡ *
__»¡riù
 
__Çme
,

75 cÚ¡ *
__»¡riù
 
__v”siÚ
)

76 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

82 *
	$dË¼Ü
 (è
__THROW
;

85 #ifdeà
__USE_GNU


90 cÚ¡ *
dli_âame
;

91 *
dli_fba£
;

92 cÚ¡ *
dli_¢ame
;

93 *
dli_§ddr
;

94 } 
	tDl_šfo
;

98 
	$dÏddr
 (cÚ¡ *
__add»ss
, 
Dl_šfo
 *
__šfo
)

99 
__THROW
 
	`__nÚnuÎ
 ((2));

102 
	$dÏddr1
 (cÚ¡ *
__add»ss
, 
Dl_šfo
 *
__šfo
,

103 **
__exŒa_šfo
, 
__æags
è
__THROW
 
	`__nÚnuÎ
 ((2));

111 
RTLD_DL_SYMENT
 = 1,

114 
RTLD_DL_LINKMAP
 = 2

123 
	$dlšfo
 (*
__»¡riù
 
__hªdË
,

124 
__»que¡
, *
__»¡riù
 
__¬g
)

125 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

131 
RTLD_DI_LMID
 = 1,

135 
RTLD_DI_LINKMAP
 = 2,

137 
RTLD_DI_CONFIGADDR
 = 3,

144 
RTLD_DI_SERINFO
 = 4,

145 
RTLD_DI_SERINFOSIZE
 = 5,

149 
RTLD_DI_ORIGIN
 = 6,

151 
RTLD_DI_PROFILENAME
 = 7,

152 
RTLD_DI_PROFILEOUT
 = 8,

157 
RTLD_DI_TLS_MODID
 = 9,

163 
RTLD_DI_TLS_DATA
 = 10,

165 
RTLD_DI_MAX
 = 10

173 *
dls_Çme
;

174 
dls_æags
;

175 } 
	tDl_£½©h
;

181 
size_t
 
dls_size
;

182 
dls_út
;

183 
Dl_£½©h
 
dls_£½©h
[1];

184 } 
	tDl_£ršfo
;

188 
__END_DECLS


	@/usr/include/errno.h

22 #iâdef 
_ERRNO_H


26 #iâdef 
__Ãed_Em©h


27 
	#_ERRNO_H
 1

	)

28 
	~<ã©u»s.h
>

31 
	g__BEGIN_DECLS


35 
	~<b™s/”ºo.h
>

36 #undeà
__Ãed_Em©h


38 #ifdef 
_ERRNO_H


45 #iâdef 
”ºo


46 
”ºo
;

49 #ifdeà
__USE_GNU


54 *
´og¿m_švoÿtiÚ_Çme
, *
´og¿m_švoÿtiÚ_shÜt_Çme
;

58 
	g__END_DECLS


66 #ià
defšed
 
__USE_GNU
 || defšed 
__Ãed_”rÜ_t


67 #iâdeà
__”rÜ_t_defšed


68 
	t”rÜ_t
;

69 
	#__”rÜ_t_defšed
 1

	)

71 #undeà
__Ãed_”rÜ_t


	@/usr/include/limits.h

22 #iâdeà
_LIBC_LIMITS_H_


23 
	#_LIBC_LIMITS_H_
 1

	)

25 
	~<ã©u»s.h
>

31 
	#MB_LEN_MAX
 16

	)

36 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2

41 #iâdeà
_LIMITS_H


42 
	#_LIMITS_H
 1

	)

44 
	~<b™s/wÜdsize.h
>

53 
	#CHAR_BIT
 8

	)

56 
	#SCHAR_MIN
 (-128)

	)

57 
	#SCHAR_MAX
 127

	)

60 
	#UCHAR_MAX
 255

	)

63 #ifdeà
__CHAR_UNSIGNED__


64 
	#CHAR_MIN
 0

	)

65 
	#CHAR_MAX
 
UCHAR_MAX


	)

67 
	#CHAR_MIN
 
SCHAR_MIN


	)

68 
	#CHAR_MAX
 
SCHAR_MAX


	)

72 
	#SHRT_MIN
 (-32768)

	)

73 
	#SHRT_MAX
 32767

	)

76 
	#USHRT_MAX
 65535

	)

79 
	#INT_MIN
 (-
INT_MAX
 - 1)

	)

80 
	#INT_MAX
 2147483647

	)

83 
	#UINT_MAX
 4294967295U

	)

86 #ià
__WORDSIZE
 == 64

87 
	#LONG_MAX
 9223372036854775807L

	)

89 
	#LONG_MAX
 2147483647L

	)

91 
	#LONG_MIN
 (-
LONG_MAX
 - 1L)

	)

94 #ià
__WORDSIZE
 == 64

95 
	#ULONG_MAX
 18446744073709551615UL

	)

97 
	#ULONG_MAX
 4294967295UL

	)

100 #ifdeà
__USE_ISOC99


103 
	#LLONG_MAX
 9223372036854775807LL

	)

104 
	#LLONG_MIN
 (-
LLONG_MAX
 - 1LL)

	)

107 
	#ULLONG_MAX
 18446744073709551615ULL

	)

121 #ià
defšed
 
__GNUC__
 && !defšed 
_GCC_LIMITS_H_


123 #šşude_Ãxˆ<
lim™s
.
h
>

129 #ià
defšed
 
__USE_ISOC99
 && defšed 
__GNUC__


130 #iâdeà
LLONG_MIN


131 
	#LLONG_MIN
 (-
LLONG_MAX
-1)

	)

133 #iâdeà
LLONG_MAX


134 
	#LLONG_MAX
 
__LONG_LONG_MAX__


	)

136 #iâdeà
ULLONG_MAX


137 
	#ULLONG_MAX
 (
LLONG_MAX
 * 2ULL + 1)

	)

141 #ifdef 
__USE_POSIX


143 
	~<b™s/posix1_lim.h
>

146 #ifdef 
__USE_POSIX2


147 
	~<b™s/posix2_lim.h
>

150 #ifdef 
__USE_XOPEN


151 
	~<b™s/xİ’_lim.h
>

	@/usr/include/signal.h

22 #iâdef 
_SIGNAL_H


24 #ià!
defšed
 
__Ãed_sig_©omic_t
 && !defšed 
__Ãed_sig£t_t


25 
	#_SIGNAL_H


	)

28 
	~<ã©u»s.h
>

30 
	g__BEGIN_DECLS


32 
	~<b™s/sig£t.h
>

36 #ià
defšed
 
__Ãed_sig_©omic_t
 || defšed 
_SIGNAL_H


37 #iâdeà
__sig_©omic_t_defšed


38 
	#__sig_©omic_t_defšed


	)

39 
__BEGIN_NAMESPACE_STD


40 
__sig_©omic_t
 
	tsig_©omic_t
;

41 
	g__END_NAMESPACE_STD


43 #undeà
__Ãed_sig_©omic_t


46 #ià
defšed
 
__Ãed_sig£t_t
 || (defšed 
_SIGNAL_H
 && defšed 
__USE_POSIX
)

47 #iâdeà
__sig£t_t_defšed


48 
	#__sig£t_t_defšed


	)

49 
__sig£t_t
 
	tsig£t_t
;

51 #undeà
__Ãed_sig£t_t


54 #ifdeà
_SIGNAL_H


56 
	~<b™s/ty³s.h
>

57 
	~<b™s/signum.h
>

59 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


60 #iâdeà
__pid_t_defšed


61 
__pid_t
 
	tpid_t
;

62 
	#__pid_t_defšed


	)

64 #ifdeà
__USE_XOPEN


66 #iâdeà
__uid_t_defšed


67 
__uid_t
 
	tuid_t
;

68 
	#__uid_t_defšed


	)

72 #ifdeà
__USE_POSIX199309


74 
	#__Ãed_time¥ec


	)

75 
	~<time.h
>

78 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_XOPEN_EXTENDED


80 
	~<b™s/sigšfo.h
>

85 (*
	t__sighªdËr_t
) ();

90 
__sighªdËr_t
 
	$__sysv_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

91 
__THROW
;

92 #ifdeà
__USE_GNU


93 
__sighªdËr_t
 
	$sysv_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

94 
__THROW
;

100 
__BEGIN_NAMESPACE_STD


101 #ifdeà
__USE_MISC


102 
__sighªdËr_t
 
	$sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

103 
__THROW
;

106 #ifdeà
__REDIRECT_NTH


107 
__sighªdËr_t
 
	`__REDIRECT_NTH
 (
sigÇl
,

108 (
__sig
, 
__sighªdËr_t
 
__hªdËr
),

109 
__sysv_sigÇl
);

111 
	#sigÇl
 
__sysv_sigÇl


	)

114 
__END_NAMESPACE_STD


116 #ifdeà
__USE_XOPEN


119 
__sighªdËr_t
 
	$bsd_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

120 
__THROW
;

126 #ifdeà
__USE_POSIX


127 
	$kl
 (
__pid_t
 
__pid
, 
__sig
è
__THROW
;

130 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


134 
	$kÍg
 (
__pid_t
 
__pg½
, 
__sig
è
__THROW
;

137 
__BEGIN_NAMESPACE_STD


139 
	$¿i£
 (
__sig
è
__THROW
;

140 
__END_NAMESPACE_STD


142 #ifdeà
__USE_MISC


144 
__sighªdËr_t
 
	$ssigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

145 
__THROW
;

146 
	$gsigÇl
 (
__sig
è
__THROW
;

149 #ifdeà
__USE_XOPEN2K8


151 
	`psigÇl
 (
__sig
, cÚ¡ *
__s
);

154 
	`psigšfo
 (cÚ¡ 
sigšfo_t
 *
__pšfo
, cÚ¡ *
__s
);

166 #ifdeà
__USE_XOPEN


167 #ifdeà
__GNUC__


168 
	$sig·u£
 (
__sig
è
	`__asm__
 ("__xpg_sigpause");

170 
	`__sig·u£
 (
__sig_Ü_mask
, 
__is_sig
);

172 
	#sig·u£
(
sig
è
	`__sig·u£
 ((sig), 1)

	)

177 #ifdeà
__USE_MISC


184 
	#sigmask
(
sig
è
	`__sigmask
(sig)

	)

187 
	$sigblock
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

190 
	$sig£tmask
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

193 
	$sigg‘mask
 (è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

197 #ifdeà
__USE_MISC


198 
	#NSIG
 
_NSIG


	)

201 #ifdeà
__USE_GNU


202 
__sighªdËr_t
 
	tsighªdËr_t
;

206 #ifdeà
__USE_MISC


207 
__sighªdËr_t
 
	tsig_t
;

210 #ifdeà
__USE_POSIX


213 
	$sigem±y£t
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

216 
	$sigfl£t
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

219 
	$sigadd£t
 (
sig£t_t
 *
__£t
, 
__signo
è
__THROW
 
	`__nÚnuÎ
 ((1));

222 
	$sigd–£t
 (
sig£t_t
 *
__£t
, 
__signo
è
__THROW
 
	`__nÚnuÎ
 ((1));

225 
	$sigismemb”
 (cÚ¡ 
sig£t_t
 *
__£t
, 
__signo
)

226 
__THROW
 
	`__nÚnuÎ
 ((1));

228 #ifdeà
__USE_GNU


230 
	$sigi£m±y£t
 (cÚ¡ 
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

233 
	$sigªd£t
 (
sig£t_t
 *
__£t
, cÚ¡ sig£t_ˆ*
__Ëá
,

234 cÚ¡ 
sig£t_t
 *
__right
è
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

237 
	$sigÜ£t
 (
sig£t_t
 *
__£t
, cÚ¡ sig£t_ˆ*
__Ëá
,

238 cÚ¡ 
sig£t_t
 *
__right
è
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

243 
	~<b™s/sigaùiÚ.h
>

246 
	$sig´ocmask
 (
__how
, cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

247 
sig£t_t
 *
__»¡riù
 
__o£t
è
__THROW
;

254 
	$sigsu¥’d
 (cÚ¡ 
sig£t_t
 *
__£t
è
	`__nÚnuÎ
 ((1));

257 
	$sigaùiÚ
 (
__sig
, cÚ¡ 
sigaùiÚ
 *
__»¡riù
 
__aù
,

258 
sigaùiÚ
 *
__»¡riù
 
__ßù
è
__THROW
;

261 
	$sig³ndšg
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

268 
	$sigwa™
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
, *__»¡riù 
__sig
)

269 
	`__nÚnuÎ
 ((1, 2));

271 #ifdeà
__USE_POSIX199309


276 
	$sigwa™šfo
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

277 
sigšfo_t
 *
__»¡riù
 
__šfo
è
	`__nÚnuÎ
 ((1));

284 
	$sigtimedwa™
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

285 
sigšfo_t
 *
__»¡riù
 
__šfo
,

286 cÚ¡ 
time¥ec
 *
__»¡riù
 
__timeout
)

287 
	`__nÚnuÎ
 ((1));

291 
	$sigqueue
 (
__pid_t
 
__pid
, 
__sig
, cÚ¡ 
sigv®
 
__v®
)

292 
__THROW
;

297 #ifdeà
__USE_MISC


301 cÚ¡ *cÚ¡ 
_sys_sigli¡
[
_NSIG
];

302 cÚ¡ *cÚ¡ 
sys_sigli¡
[
_NSIG
];

306 
	~<b™s/sigcÚ‹xt.h
>

309 
	$sig»tuº
 (
sigcÚ‹xt
 *
__sı
è
__THROW
;

314 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


315 
	#__Ãed_size_t


	)

316 
	~<¡ddef.h
>

321 
	$sigš‹¼u±
 (
__sig
, 
__š‹¼u±
è
__THROW
;

323 
	~<b™s/sig¡ack.h
>

324 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


326 
	~<sys/ucÚ‹xt.h
>

332 
	$sig¡ack
 (
sig¡ack
 *
__ss
, sig¡ack *
__oss
)

333 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

337 
	$sig®t¡ack
 (cÚ¡ 
sig®t¡ack
 *
__»¡riù
 
__ss
,

338 
sig®t¡ack
 *
__»¡riù
 
__oss
è
__THROW
;

342 #ifdeà
__USE_XOPEN_EXTENDED


346 
	$sighŞd
 (
__sig
è
__THROW
;

349 
	$sig»l£
 (
__sig
è
__THROW
;

352 
	$sigignÜe
 (
__sig
è
__THROW
;

355 
__sighªdËr_t
 
	$sig£t
 (
__sig
, 
__sighªdËr_t
 
__di¥
è
__THROW
;

358 #ià
defšed
 
__USE_POSIX199506
 || defšed 
__USE_UNIX98


361 
	~<b™s/±h»adty³s.h
>

362 
	~<b™s/sigth»ad.h
>

369 
	$__libc_cu¼’t_sig¹mš
 (è
__THROW
;

371 
	$__libc_cu¼’t_sig¹max
 (è
__THROW
;

375 
__END_DECLS


	@/usr/include/stdio.h

23 #iâdeà
_STDIO_H


25 #ià!
defšed
 
__Ãed_FILE
 && !defšed 
__Ãed___FILE


26 
	#_STDIO_H
 1

	)

27 
	~<ã©u»s.h
>

29 
	g__BEGIN_DECLS


31 
	#__Ãed_size_t


	)

32 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

35 
	~<b™s/ty³s.h
>

36 
	#__Ãed_FILE


	)

37 
	#__Ãed___FILE


	)

41 #ià!
defšed
 
__FILE_defšed
 && defšed 
__Ãed_FILE


44 
	g_IO_FILE
;

46 
__BEGIN_NAMESPACE_STD


48 
_IO_FILE
 
	tFILE
;

49 
	g__END_NAMESPACE_STD


50 #ià
defšed
 
__USE_LARGEFILE64
 || defšed 
__USE_POSIX
 \

51 || 
defšed
 
	g__USE_ISOC99
 || defšed 
	g__USE_XOPEN
 \

52 || 
defšed
 
__USE_POSIX2


53 
	$__USING_NAMESPACE_STD
(
FILE
)

56 
	#__FILE_defšed
 1

	)

58 #undeà
__Ãed_FILE


61 #ià!
defšed
 
____FILE_defšed
 && defšed 
__Ãed___FILE


64 
_IO_FILE
 
	t__FILE
;

66 
	#____FILE_defšed
 1

	)

68 #undeà
__Ãed___FILE


71 #ifdef 
_STDIO_H


72 
	#_STDIO_USES_IOSTREAM


	)

74 
	~<libio.h
>

76 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


77 #ifdeà
__GNUC__


78 #iâdeà
_VA_LIST_DEFINED


79 
_G_va_li¡
 
	tva_li¡
;

80 
	#_VA_LIST_DEFINED


	)

83 
	~<¡d¬g.h
>

87 #ifdeà
__USE_XOPEN2K8


88 #iâdeà
__off_t_defšed


89 #iâdeà
__USE_FILE_OFFSET64


90 
__off_t
 
	toff_t
;

92 
__off64_t
 
	toff_t
;

94 
	#__off_t_defšed


	)

96 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


97 
__off64_t
 
	toff64_t
;

98 
	#__off64_t_defšed


	)

101 #iâdeà
__ssize_t_defšed


102 
__ssize_t
 
	tssize_t
;

103 
	#__ssize_t_defšed


	)

108 
__BEGIN_NAMESPACE_STD


109 #iâdeà
__USE_FILE_OFFSET64


110 
_G_åos_t
 
	tåos_t
;

112 
_G_åos64_t
 
	tåos_t
;

114 
__END_NAMESPACE_STD


115 #ifdeà
__USE_LARGEFILE64


116 
_G_åos64_t
 
	tåos64_t
;

120 
	#_IOFBF
 0

	)

121 
	#_IOLBF
 1

	)

122 
	#_IONBF
 2

	)

126 #iâdeà
BUFSIZ


127 
	#BUFSIZ
 
_IO_BUFSIZ


	)

133 #iâdeà
EOF


134 
	#EOF
 (-1)

	)

140 
	#SEEK_SET
 0

	)

141 
	#SEEK_CUR
 1

	)

142 
	#SEEK_END
 2

	)

143 #ifdeà
__USE_GNU


144 
	#SEEK_DATA
 3

	)

145 
	#SEEK_HOLE
 4

	)

149 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


151 
	#P_tmpdœ
 "/tmp"

	)

164 
	~<b™s/¡dio_lim.h
>

168 
_IO_FILE
 *
¡dš
;

169 
_IO_FILE
 *
¡dout
;

170 
_IO_FILE
 *
¡d”r
;

172 
	#¡dš
 
¡dš


	)

173 
	#¡dout
 
¡dout


	)

174 
	#¡d”r
 
¡d”r


	)

176 
__BEGIN_NAMESPACE_STD


178 
	$»move
 (cÚ¡ *
__f’ame
è
__THROW
;

180 
	$»Çme
 (cÚ¡ *
__Şd
, cÚ¡ *
__Ãw
è
__THROW
;

181 
__END_NAMESPACE_STD


183 #ifdeà
__USE_ATFILE


185 
	$»Çm—t
 (
__Şdfd
, cÚ¡ *
__Şd
, 
__Ãwfd
,

186 cÚ¡ *
__Ãw
è
__THROW
;

189 
__BEGIN_NAMESPACE_STD


194 #iâdeà
__USE_FILE_OFFSET64


195 
FILE
 *
	$tmpfe
 (è
__wur
;

197 #ifdeà
__REDIRECT


198 
FILE
 *
	`__REDIRECT
 (
tmpfe
, (), 
tmpfe64
è
__wur
;

200 
	#tmpfe
 
tmpfe64


	)

204 #ifdeà
__USE_LARGEFILE64


205 
FILE
 *
	$tmpfe64
 (è
__wur
;

209 *
	$tm²am
 (*
__s
è
__THROW
 
__wur
;

210 
__END_NAMESPACE_STD


212 #ifdeà
__USE_MISC


215 *
	$tm²am_r
 (*
__s
è
__THROW
 
__wur
;

219 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


227 *
	$‹m²am
 (cÚ¡ *
__dœ
, cÚ¡ *
__pfx
)

228 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

232 
__BEGIN_NAMESPACE_STD


237 
	`fşo£
 (
FILE
 *
__¡»am
);

242 
	`fæush
 (
FILE
 *
__¡»am
);

243 
__END_NAMESPACE_STD


245 #ifdeà
__USE_MISC


252 
	`fæush_uÆocked
 (
FILE
 *
__¡»am
);

255 #ifdeà
__USE_GNU


262 
	`fşo£®l
 ();

266 
__BEGIN_NAMESPACE_STD


267 #iâdeà
__USE_FILE_OFFSET64


272 
FILE
 *
	$fİ’
 (cÚ¡ *
__»¡riù
 
__f’ame
,

273 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

278 
FILE
 *
	$äeİ’
 (cÚ¡ *
__»¡riù
 
__f’ame
,

279 cÚ¡ *
__»¡riù
 
__modes
,

280 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

282 #ifdeà
__REDIRECT


283 
FILE
 *
	`__REDIRECT
 (
fİ’
, (cÚ¡ *
__»¡riù
 
__f’ame
,

284 cÚ¡ *
__»¡riù
 
__modes
), 
fİ’64
)

285 
__wur
;

286 
FILE
 *
	`__REDIRECT
 (
äeİ’
, (cÚ¡ *
__»¡riù
 
__f’ame
,

287 cÚ¡ *
__»¡riù
 
__modes
,

288 
FILE
 *
__»¡riù
 
__¡»am
), 
äeİ’64
)

289 
__wur
;

291 
	#fİ’
 
fİ’64


	)

292 
	#äeİ’
 
äeİ’64


	)

295 
__END_NAMESPACE_STD


296 #ifdeà
__USE_LARGEFILE64


297 
FILE
 *
	$fİ’64
 (cÚ¡ *
__»¡riù
 
__f’ame
,

298 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

299 
FILE
 *
	$äeİ’64
 (cÚ¡ *
__»¡riù
 
__f’ame
,

300 cÚ¡ *
__»¡riù
 
__modes
,

301 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

304 #ifdef 
__USE_POSIX


306 
FILE
 *
	$fdİ’
 (
__fd
, cÚ¡ *
__modes
è
__THROW
 
__wur
;

309 #ifdef 
__USE_GNU


312 
FILE
 *
	$fİ’cook›
 (*
__»¡riù
 
__magic_cook›
,

313 cÚ¡ *
__»¡riù
 
__modes
,

314 
_IO_cook›_io_funùiÚs_t
 
__io_funcs
è
__THROW
 
__wur
;

317 #ifdeà
__USE_XOPEN2K8


319 
FILE
 *
	$fmemİ’
 (*
__s
, 
size_t
 
__Ën
, cÚ¡ *
__modes
)

320 
__THROW
 
__wur
;

325 
FILE
 *
	$İ’_mem¡»am
 (**
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
 
__wur
;

329 
__BEGIN_NAMESPACE_STD


332 
	$£tbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
è
__THROW
;

336 
	$£tvbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

337 
__modes
, 
size_t
 
__n
è
__THROW
;

338 
__END_NAMESPACE_STD


340 #ifdef 
__USE_MISC


343 
	$£tbufãr
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

344 
size_t
 
__size
è
__THROW
;

347 
	$£šebuf
 (
FILE
 *
__¡»am
è
__THROW
;

351 
__BEGIN_NAMESPACE_STD


356 
	`årštf
 (
FILE
 *
__»¡riù
 
__¡»am
,

357 cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

362 
	`´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

364 
	$¥rštf
 (*
__»¡riù
 
__s
,

365 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROWNL
;

371 
	`vårštf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

372 
_G_va_li¡
 
__¬g
);

377 
	`v´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
);

379 
	$v¥rštf
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

380 
_G_va_li¡
 
__¬g
è
__THROWNL
;

381 
__END_NAMESPACE_STD


383 #ià
defšed
 
__USE_ISOC99
 || defšed 
__USE_UNIX98


384 
__BEGIN_NAMESPACE_C99


386 
	$¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

387 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

388 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 4)));

390 
	$v¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

391 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

392 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 0)));

393 
__END_NAMESPACE_C99


396 #ifdeà
__USE_GNU


399 
	$va¥rštf
 (**
__»¡riù
 
__±r
, cÚ¡ *__»¡riù 
__f
,

400 
_G_va_li¡
 
__¬g
)

401 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 0))è
__wur
;

402 
	$__a¥rštf
 (**
__»¡riù
 
__±r
,

403 cÚ¡ *
__»¡riù
 
__fmt
, ...)

404 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

405 
	$a¥rštf
 (**
__»¡riù
 
__±r
,

406 cÚ¡ *
__»¡riù
 
__fmt
, ...)

407 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

410 #ifdeà
__USE_XOPEN2K8


412 
	$vd´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
,

413 
_G_va_li¡
 
__¬g
)

414 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

415 
	$d´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
, ...)

416 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

420 
__BEGIN_NAMESPACE_STD


425 
	$fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

426 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

431 
	$sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

433 
	$ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

434 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

436 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

437 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

438 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

439 #ifdeà
__REDIRECT


443 
	`__REDIRECT
 (
fsÿnf
, (
FILE
 *
__»¡riù
 
__¡»am
,

444 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

445 
__isoc99_fsÿnf
è
__wur
;

446 
	`__REDIRECT
 (
sÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

447 
__isoc99_sÿnf
è
__wur
;

448 
	`__REDIRECT_NTH
 (
ssÿnf
, (cÚ¡ *
__»¡riù
 
__s
,

449 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

450 
__isoc99_ssÿnf
);

452 
	$__isoc99_fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

453 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

454 
	$__isoc99_sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

455 
	$__isoc99_ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

456 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

457 
	#fsÿnf
 
__isoc99_fsÿnf


	)

458 
	#sÿnf
 
__isoc99_sÿnf


	)

459 
	#ssÿnf
 
__isoc99_ssÿnf


	)

463 
__END_NAMESPACE_STD


465 #ifdef 
__USE_ISOC99


466 
__BEGIN_NAMESPACE_C99


471 
	$vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

472 
_G_va_li¡
 
__¬g
)

473 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

479 
	$vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

480 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

483 
	$vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

484 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

485 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

487 #ià!
defšed
 
__USE_GNU
 \

488 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

489 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

490 #ifdeà
__REDIRECT


494 
	`__REDIRECT
 (
vfsÿnf
,

495 (
FILE
 *
__»¡riù
 
__s
,

496 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
),

497 
__isoc99_vfsÿnf
)

498 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

499 
	`__REDIRECT
 (
vsÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
,

500 
_G_va_li¡
 
__¬g
), 
__isoc99_vsÿnf
)

501 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

502 
	`__REDIRECT_NTH
 (
vssÿnf
,

503 (cÚ¡ *
__»¡riù
 
__s
,

504 cÚ¡ *
__»¡riù
 
__fÜm©
,

505 
_G_va_li¡
 
__¬g
), 
__isoc99_vssÿnf
)

506 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

508 
	$__isoc99_vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
,

509 cÚ¡ *
__»¡riù
 
__fÜm©
,

510 
_G_va_li¡
 
__¬g
è
__wur
;

511 
	$__isoc99_vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
,

512 
_G_va_li¡
 
__¬g
è
__wur
;

513 
	$__isoc99_vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

514 cÚ¡ *
__»¡riù
 
__fÜm©
,

515 
_G_va_li¡
 
__¬g
è
__THROW
;

516 
	#vfsÿnf
 
__isoc99_vfsÿnf


	)

517 
	#vsÿnf
 
__isoc99_vsÿnf


	)

518 
	#vssÿnf
 
__isoc99_vssÿnf


	)

522 
__END_NAMESPACE_C99


526 
__BEGIN_NAMESPACE_STD


531 
	`fg‘c
 (
FILE
 *
__¡»am
);

532 
	`g‘c
 (
FILE
 *
__¡»am
);

538 
	`g‘ch¬
 ();

539 
__END_NAMESPACE_STD


543 
	#g‘c
(
_å
è
	`_IO_g‘c
 (_å)

	)

545 #ifdeà
__USE_POSIX


550 
	`g‘c_uÆocked
 (
FILE
 *
__¡»am
);

551 
	`g‘ch¬_uÆocked
 ();

554 #ifdeà
__USE_MISC


561 
	`fg‘c_uÆocked
 (
FILE
 *
__¡»am
);

565 
__BEGIN_NAMESPACE_STD


573 
	`åutc
 (
__c
, 
FILE
 *
__¡»am
);

574 
	`putc
 (
__c
, 
FILE
 *
__¡»am
);

580 
	`putch¬
 (
__c
);

581 
__END_NAMESPACE_STD


585 
	#putc
(
_ch
, 
_å
è
	`_IO_putc
 (_ch, _å)

	)

587 #ifdeà
__USE_MISC


594 
	`åutc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

597 #ifdeà
__USE_POSIX


602 
	`putc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

603 
	`putch¬_uÆocked
 (
__c
);

607 #ià
defšed
 
__USE_MISC
 \

608 || (
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

610 
	`g‘w
 (
FILE
 *
__¡»am
);

613 
	`putw
 (
__w
, 
FILE
 *
__¡»am
);

617 
__BEGIN_NAMESPACE_STD


622 *
	$fg‘s
 (*
__»¡riù
 
__s
, 
__n
, 
FILE
 *__»¡riù 
__¡»am
)

623 
__wur
;

625 #ià!
defšed
 
__USE_ISOC11
 \

626 || (
defšed
 
__ılu¥lus
 && __cplusplus <= 201103L)

638 *
	$g‘s
 (*
__s
è
__wur
 
__©Œibu‹_d•»ÿ‹d__
;

640 
__END_NAMESPACE_STD


642 #ifdeà
__USE_GNU


649 *
	$fg‘s_uÆocked
 (*
__»¡riù
 
__s
, 
__n
,

650 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

654 #ifdef 
__USE_XOPEN2K8


665 
_IO_ssize_t
 
	$__g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

666 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

667 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

668 
_IO_ssize_t
 
	$g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

669 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

670 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

678 
_IO_ssize_t
 
	$g‘lše
 (**
__»¡riù
 
__lš•Œ
,

679 
size_t
 *
__»¡riù
 
__n
,

680 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

684 
__BEGIN_NAMESPACE_STD


689 
	`åuts
 (cÚ¡ *
__»¡riù
 
__s
, 
FILE
 *__»¡riù 
__¡»am
);

695 
	`puts
 (cÚ¡ *
__s
);

702 
	`ung‘c
 (
__c
, 
FILE
 *
__¡»am
);

709 
size_t
 
	$ä—d
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

710 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

715 
size_t
 
	`fwr™e
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

716 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__s
);

717 
__END_NAMESPACE_STD


719 #ifdeà
__USE_GNU


726 
	`åuts_uÆocked
 (cÚ¡ *
__»¡riù
 
__s
,

727 
FILE
 *
__»¡riù
 
__¡»am
);

730 #ifdeà
__USE_MISC


737 
size_t
 
	$ä—d_uÆocked
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

738 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

739 
size_t
 
	`fwr™e_uÆocked
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

740 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
);

744 
__BEGIN_NAMESPACE_STD


749 
	`f£ek
 (
FILE
 *
__¡»am
, 
__off
, 
__wh’û
);

754 
	$á–l
 (
FILE
 *
__¡»am
è
__wur
;

759 
	`»wšd
 (
FILE
 *
__¡»am
);

760 
__END_NAMESPACE_STD


767 #ià
defšed
 
__USE_LARGEFILE
 || defšed 
__USE_XOPEN2K


768 #iâdeà
__USE_FILE_OFFSET64


773 
	`f£eko
 (
FILE
 *
__¡»am
, 
__off_t
 
__off
, 
__wh’û
);

778 
__off_t
 
	$á–lo
 (
FILE
 *
__¡»am
è
__wur
;

780 #ifdeà
__REDIRECT


781 
	`__REDIRECT
 (
f£eko
,

782 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
),

783 
f£eko64
);

784 
__off64_t
 
	`__REDIRECT
 (
á–lo
, (
FILE
 *
__¡»am
), 
á–lo64
);

786 
	#f£eko
 
f£eko64


	)

787 
	#á–lo
 
á–lo64


	)

792 
__BEGIN_NAMESPACE_STD


793 #iâdeà
__USE_FILE_OFFSET64


798 
	`fg‘pos
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos_t
 *__»¡riù 
__pos
);

803 
	`f£os
 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
);

805 #ifdeà
__REDIRECT


806 
	`__REDIRECT
 (
fg‘pos
, (
FILE
 *
__»¡riù
 
__¡»am
,

807 
åos_t
 *
__»¡riù
 
__pos
), 
fg‘pos64
);

808 
	`__REDIRECT
 (
f£os
,

809 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
), 
f£os64
);

811 
	#fg‘pos
 
fg‘pos64


	)

812 
	#f£os
 
f£os64


	)

815 
__END_NAMESPACE_STD


817 #ifdeà
__USE_LARGEFILE64


818 
	`f£eko64
 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
);

819 
__off64_t
 
	$á–lo64
 (
FILE
 *
__¡»am
è
__wur
;

820 
	`fg‘pos64
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos64_t
 *__»¡riù 
__pos
);

821 
	`f£os64
 (
FILE
 *
__¡»am
, cÚ¡ 
åos64_t
 *
__pos
);

824 
__BEGIN_NAMESPACE_STD


826 
	$ş—»¼
 (
FILE
 *
__¡»am
è
__THROW
;

828 
	$ãof
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

830 
	$ã¼Ü
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

831 
__END_NAMESPACE_STD


833 #ifdeà
__USE_MISC


835 
	$ş—»¼_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
;

836 
	$ãof_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

837 
	$ã¼Ü_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

841 
__BEGIN_NAMESPACE_STD


846 
	`³¼Ü
 (cÚ¡ *
__s
);

847 
__END_NAMESPACE_STD


853 
	~<b™s/sys_”¾i¡.h
>

856 #ifdef 
__USE_POSIX


858 
	$f’o
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

861 #ifdeà
__USE_MISC


863 
	$f’o_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

867 #ifdeà
__USE_POSIX2


872 
FILE
 *
	$pİ’
 (cÚ¡ *
__commªd
, cÚ¡ *
__modes
è
__wur
;

878 
	`pşo£
 (
FILE
 *
__¡»am
);

882 #ifdef 
__USE_POSIX


884 *
	$ù”mid
 (*
__s
è
__THROW
;

888 #ifdeà
__USE_XOPEN


890 *
	`cu£rid
 (*
__s
);

894 #ifdef 
__USE_GNU


895 
ob¡ack
;

898 
	$ob¡ack_´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

899 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

900 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

901 
	$ob¡ack_v´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

902 cÚ¡ *
__»¡riù
 
__fÜm©
,

903 
_G_va_li¡
 
__¬gs
)

904 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

908 #ifdeà
__USE_POSIX


912 
	$æockfe
 (
FILE
 *
__¡»am
è
__THROW
;

916 
	$árylockfe
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

919 
	$fuÆockfe
 (
FILE
 *
__¡»am
è
__THROW
;

922 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


926 
	#__Ãed_g‘İt


	)

927 
	~<g‘İt.h
>

932 #ifdeà
__USE_EXTERN_INLINES


933 
	~<b™s/¡dio.h
>

935 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


936 
	~<b™s/¡dio2.h
>

938 #ifdeà
__LDBL_COMPAT


939 
	~<b™s/¡dio-ldbl.h
>

942 
__END_DECLS


	@/usr/include/string.h

22 #iâdef 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


30 
	#__Ãed_size_t


	)

31 
	#__Ãed_NULL


	)

32 
	~<¡ddef.h
>

35 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

36 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

40 
__BEGIN_NAMESPACE_STD


42 *
	$memıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

43 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

46 *
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

47 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

48 
__END_NAMESPACE_STD


53 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


54 *
	$memcıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

60 
__BEGIN_NAMESPACE_STD


62 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

65 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

66 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

69 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


72 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

73 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

74 cÚ¡ *
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

75 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

77 #ifdeà
__OPTIMIZE__


78 
__ex‹º_®ways_šlše
 *

79 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


81  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

84 
__ex‹º_®ways_šlše
 const *

85 
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


87  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

90 
	}
}

92 *
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

93 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

95 
__END_NAMESPACE_STD


97 #ifdeà
__USE_GNU


100 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


101 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

102 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

103 "C++" cÚ¡ *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

104 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

106 *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

107 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

111 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


112 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

113 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

114 "C++" cÚ¡ *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

115 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

117 *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

118 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

123 
__BEGIN_NAMESPACE_STD


125 *
	$¡rıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

126 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

128 *
	$¡ºıy
 (*
__»¡riù
 
__de¡
,

129 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

130 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

133 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

134 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

136 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

137 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

140 
	$¡rcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

141 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

143 
	$¡ºcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

144 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

147 
	$¡rcŞl
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

148 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

150 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

151 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

152 
__THROW
 
	`__nÚnuÎ
 ((2));

153 
__END_NAMESPACE_STD


155 #ifdeà
__USE_XOPEN2K8


159 
	~<xloÿË.h
>

162 
	$¡rcŞl_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
__loÿË_t
 
__l
)

163 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

165 
size_t
 
	$¡rxäm_l
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

166 
__loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

169 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


171 *
	$¡rdup
 (cÚ¡ *
__s
)

172 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

178 #ià
defšed
 
__USE_XOPEN2K8


179 *
	$¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

180 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

183 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


185 
	#¡rdu·
(
s
) \

186 (
__ex‹nsiÚ__
 \

188 cÚ¡ *
__Şd
 = (
s
); \

189 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Şd
) + 1; \

190 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
); \

191 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

192 
	}
}))

	)

195 
	#¡ºdu·
(
s
, 
n
) \

196 (
__ex‹nsiÚ__
 \

198 cÚ¡ *
__Şd
 = (
s
); \

199 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Şd
, (
n
)); \

200 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
 + 1); \

201 
__Ãw
[
__Ën
] = '\0'; \

202 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

203 }))

	)

206 
	g__BEGIN_NAMESPACE_STD


208 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


211 *
¡rchr
 (*
__s
, 
__c
)

212 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

213 cÚ¡ *
¡rchr
 (cÚ¡ *
__s
, 
__c
)

214 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

216 #ifdeà
__OPTIMIZE__


217 
__ex‹º_®ways_šlše
 *

218 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


220  
__butš_¡rchr
 (
__s
, 
__c
);

223 
__ex‹º_®ways_šlše
 const *

224 
¡rchr
 (cÚ¡ *
__s
, 
__c
è
	g__THROW


226  
__butš_¡rchr
 (
__s
, 
__c
);

231 *
	$¡rchr
 (cÚ¡ *
__s
, 
__c
)

232 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

235 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


238 *
	`¡¼chr
 (*
__s
, 
__c
)

239 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

240 cÚ¡ *
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
)

241 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

243 #ifdeà
__OPTIMIZE__


244 
__ex‹º_®ways_šlše
 *

245 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


247  
	`__butš_¡¼chr
 (
__s
, 
__c
);

250 
__ex‹º_®ways_šlše
 const *

251 
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
è
__THROW


253  
	`__butš_¡¼chr
 (
__s
, 
__c
);

256 
	}
}

258 *
	$¡¼chr
 (cÚ¡ *
__s
, 
__c
)

259 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

261 
__END_NAMESPACE_STD


263 #ifdeà
__USE_GNU


266 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


267 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

268 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

269 "C++" cÚ¡ *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

270 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

272 *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

273 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

277 
__BEGIN_NAMESPACE_STD


280 
size_t
 
	$¡rc¥n
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

281 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

284 
size_t
 
	$¡r¥n
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

285 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

287 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


290 *
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
)

291 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

292 cÚ¡ *
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

293 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

295 #ifdeà
__OPTIMIZE__


296 
__ex‹º_®ways_šlše
 *

297 
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
è
__THROW


299  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

302 
__ex‹º_®ways_šlše
 const *

303 
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
è
__THROW


305  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

308 
	}
}

310 *
	$¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

311 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

314 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


317 *
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

318 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

319 cÚ¡ *
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

320 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

322 #ifdeà
__OPTIMIZE__


323 
__ex‹º_®ways_šlše
 *

324 
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


326  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

329 
__ex‹º_®ways_šlše
 const *

330 
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


332  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

335 
	}
}

337 *
	$¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

338 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

343 *
	$¡¹ok
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
)

344 
__THROW
 
	`__nÚnuÎ
 ((2));

345 
__END_NAMESPACE_STD


349 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

350 cÚ¡ *
__»¡riù
 
__d–im
,

351 **
__»¡riù
 
__§ve_±r
)

352 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

353 #ifdeà
__USE_POSIX


354 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
,

355 **
__»¡riù
 
__§ve_±r
)

356 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

359 #ifdeà
__USE_GNU


361 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


362 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

363 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

364 "C++" cÚ¡ *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
,

365 cÚ¡ *
__ÃedË
)

366 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

368 *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

369 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

373 #ifdeà
__USE_GNU


377 *
	$memmem
 (cÚ¡ *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

378 cÚ¡ *
__ÃedË
, 
size_t
 
__ÃedËËn
)

379 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3));

383 *
	$__mempıy
 (*
__»¡riù
 
__de¡
,

384 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

385 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

386 *
	$mempıy
 (*
__»¡riù
 
__de¡
,

387 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

388 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

392 
__BEGIN_NAMESPACE_STD


394 
size_t
 
	$¡¾’
 (cÚ¡ *
__s
)

395 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

396 
__END_NAMESPACE_STD


398 #ifdef 
__USE_XOPEN2K8


401 
size_t
 
	$¡ºËn
 (cÚ¡ *
__¡ršg
, 
size_t
 
__maxËn
)

402 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

406 
__BEGIN_NAMESPACE_STD


408 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

409 
__END_NAMESPACE_STD


410 #ifdeà
__USE_XOPEN2K


418 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


421 #ifdeà
__REDIRECT_NTH


422 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

423 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

424 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2));

426 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

427 
__THROW
 
	`__nÚnuÎ
 ((2));

428 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

433 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

434 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

438 #ifdeà
__USE_XOPEN2K8


440 *
	$¡»¼Ü_l
 (
__”ºum
, 
__loÿË_t
 
__l
è
__THROW
;

446 
	$__bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

448 #ifdeà
__USE_MISC


450 
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
)

451 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

454 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

457 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

458 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

461 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


464 *
	`šdex
 (*
__s
, 
__c
)

465 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

466 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

467 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

469 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


470 
__ex‹º_®ways_šlše
 *

471 
	`šdex
 (*
__s
, 
__c
è
__THROW


473  
	`__butš_šdex
 (
__s
, 
__c
);

476 
__ex‹º_®ways_šlše
 const *

477 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


479  
	`__butš_šdex
 (
__s
, 
__c
);

482 
	}
}

484 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

485 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

489 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


492 *
	`ršdex
 (*
__s
, 
__c
)

493 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

494 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

495 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

497 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


498 
__ex‹º_®ways_šlše
 *

499 
	`ršdex
 (*
__s
, 
__c
è
__THROW


501  
	`__butš_ršdex
 (
__s
, 
__c
);

504 
__ex‹º_®ways_šlše
 const *

505 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


507  
	`__butš_ršdex
 (
__s
, 
__c
);

510 
	}
}

512 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

513 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

518 
	$ffs
 (
__i
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

522 #ifdef 
__USE_GNU


523 
	$ff¦
 (
__l
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

524 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

525 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

529 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

530 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

533 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

534 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

537 #ifdef 
__USE_GNU


540 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

541 
__loÿË_t
 
__loc
)

542 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

544 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

545 
size_t
 
__n
, 
__loÿË_t
 
__loc
)

546 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

549 #ifdef 
__USE_MISC


552 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

553 cÚ¡ *
__»¡riù
 
__d–im
)

554 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

557 #ifdef 
__USE_XOPEN2K8


559 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

562 *
	$__¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

563 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

564 *
	$¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

565 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

569 *
	$__¡²ıy
 (*
__»¡riù
 
__de¡
,

570 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

571 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

572 *
	$¡²ıy
 (*
__»¡riù
 
__de¡
,

573 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

574 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

577 #ifdef 
__USE_GNU


579 
	$¡rv”scmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

580 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

583 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

586 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

588 #iâdeà
ba£Çme


593 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


594 "C++" *
	$ba£Çme
 (*
__f’ame
)

595 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

596 "C++" cÚ¡ *
	$ba£Çme
 (cÚ¡ *
__f’ame
)

597 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

599 *
	$ba£Çme
 (cÚ¡ *
__f’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

605 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

606 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__OPTIMIZE_SIZE__
 \

607 && !
defšed
 
__NO_INLINE__
 && !defšed 
__ılu¥lus


627 
	~<b™s/¡ršg.h
>

630 
	~<b™s/¡ršg2.h
>

633 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


635 
	~<b™s/¡ršg3.h
>

639 #ià
defšed
 
__USE_GNU
 && defšed 
__OPTIMIZE__
 \

640 && 
defšed
 
__ex‹º_®ways_šlše
 && 
	$__GNUC_PREREQ
 (3,2)

641 #ià!
defšed
 
_FORCE_INLINES
 && !defšed 
_HAVE_STRING_ARCH_mempıy


643 #undeà
mempıy


644 #undeà
__mempıy


645 
	#mempıy
(
de¡
, 
¤c
, 
n
è
	`__mempıy_šlše
 (de¡, src,‚)

	)

646 
	#__mempıy
(
de¡
, 
¤c
, 
n
è
	`__mempıy_šlše
 (de¡, src,‚)

	)

648 
__ex‹º_®ways_šlše
 *

649 
	$__mempıy_šlše
 (*
__»¡riù
 
__de¡
,

650 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

652  (*è
	`memıy
 (
__de¡
, 
__¤c
, 
__n
) + __n;

653 
	}
}

658 
	g__END_DECLS


	@/usr/include/unistd.h

22 #iâdef 
_UNISTD_H


23 
	#_UNISTD_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


32 #ifdeà
__USE_XOPEN2K8


34 
	#_POSIX_VERSION
 200809L

	)

35 #–ià
defšed
 
__USE_XOPEN2K


37 
	#_POSIX_VERSION
 200112L

	)

38 #–ià
defšed
 
__USE_POSIX199506


40 
	#_POSIX_VERSION
 199506L

	)

41 #–ià
defšed
 
__USE_POSIX199309


43 
	#_POSIX_VERSION
 199309L

	)

46 
	#_POSIX_VERSION
 199009L

	)

52 #ifdeà
__USE_XOPEN2K8


53 
	#__POSIX2_THIS_VERSION
 200809L

	)

55 #–ià
defšed
 
__USE_XOPEN2K


57 
	#__POSIX2_THIS_VERSION
 200112L

	)

58 #–ià
defšed
 
__USE_POSIX199506


60 
	#__POSIX2_THIS_VERSION
 199506L

	)

63 
	#__POSIX2_THIS_VERSION
 199209L

	)

67 
	#_POSIX2_VERSION
 
__POSIX2_THIS_VERSION


	)

70 
	#_POSIX2_C_VERSION
 
__POSIX2_THIS_VERSION


	)

74 
	#_POSIX2_C_BIND
 
__POSIX2_THIS_VERSION


	)

78 
	#_POSIX2_C_DEV
 
__POSIX2_THIS_VERSION


	)

82 
	#_POSIX2_SW_DEV
 
__POSIX2_THIS_VERSION


	)

86 
	#_POSIX2_LOCALEDEF
 
__POSIX2_THIS_VERSION


	)

89 #ifdeà
__USE_XOPEN2K8


90 
	#_XOPEN_VERSION
 700

	)

91 #–ià
defšed
 
__USE_XOPEN2K


92 
	#_XOPEN_VERSION
 600

	)

93 #–ià
defšed
 
__USE_UNIX98


94 
	#_XOPEN_VERSION
 500

	)

96 
	#_XOPEN_VERSION
 4

	)

100 
	#_XOPEN_XCU_VERSION
 4

	)

103 
	#_XOPEN_XPG2
 1

	)

104 
	#_XOPEN_XPG3
 1

	)

105 
	#_XOPEN_XPG4
 1

	)

108 
	#_XOPEN_UNIX
 1

	)

111 
	#_XOPEN_CRYPT
 1

	)

115 
	#_XOPEN_ENH_I18N
 1

	)

118 
	#_XOPEN_LEGACY
 1

	)

205 
	~<b™s/posix_İt.h
>

208 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


209 
	~<b™s/’vœÚm’ts.h
>

213 
	#STDIN_FILENO
 0

	)

214 
	#STDOUT_FILENO
 1

	)

215 
	#STDERR_FILENO
 2

	)

220 
	~<b™s/ty³s.h
>

222 #iâdef 
__ssize_t_defšed


223 
__ssize_t
 
	tssize_t
;

224 
	#__ssize_t_defšed


	)

227 
	#__Ãed_size_t


	)

228 
	#__Ãed_NULL


	)

229 
	~<¡ddef.h
>

231 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


234 #iâdeà
__gid_t_defšed


235 
__gid_t
 
	tgid_t
;

236 
	#__gid_t_defšed


	)

239 #iâdeà
__uid_t_defšed


240 
__uid_t
 
	tuid_t
;

241 
	#__uid_t_defšed


	)

244 #iâdeà
__off_t_defšed


245 #iâdeà
__USE_FILE_OFFSET64


246 
__off_t
 
	toff_t
;

248 
__off64_t
 
	toff_t
;

250 
	#__off_t_defšed


	)

252 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


253 
__off64_t
 
	toff64_t
;

254 
	#__off64_t_defšed


	)

257 #iâdeà
__u£cÚds_t_defšed


258 
__u£cÚds_t
 
	tu£cÚds_t
;

259 
	#__u£cÚds_t_defšed


	)

262 #iâdeà
__pid_t_defšed


263 
__pid_t
 
	tpid_t
;

264 
	#__pid_t_defšed


	)

268 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


269 #iâdeà
__šŒ_t_defšed


270 
__šŒ_t
 
	tšŒ_t
;

271 
	#__šŒ_t_defšed


	)

275 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


276 #iâdeà
__sockËn_t_defšed


277 
__sockËn_t
 
	tsockËn_t
;

278 
	#__sockËn_t_defšed


	)

284 
	#R_OK
 4

	)

285 
	#W_OK
 2

	)

286 
	#X_OK
 1

	)

287 
	#F_OK
 0

	)

290 
	$acûss
 (cÚ¡ *
__Çme
, 
__ty³
è
__THROW
 
	`__nÚnuÎ
 ((1));

292 #ifdeà
__USE_GNU


295 
	$euidacûss
 (cÚ¡ *
__Çme
, 
__ty³
)

296 
__THROW
 
	`__nÚnuÎ
 ((1));

299 
	$—cûss
 (cÚ¡ *
__Çme
, 
__ty³
)

300 
__THROW
 
	`__nÚnuÎ
 ((1));

303 #ifdeà
__USE_ATFILE


307 
	$çcûs§t
 (
__fd
, cÚ¡ *
__fe
, 
__ty³
, 
__æag
)

308 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

313 #iâdef 
_STDIO_H


314 
	#SEEK_SET
 0

	)

315 
	#SEEK_CUR
 1

	)

316 
	#SEEK_END
 2

	)

317 #ifdeà
__USE_GNU


318 
	#SEEK_DATA
 3

	)

319 
	#SEEK_HOLE
 4

	)

323 #ià
defšed
 
__USE_MISC
 && !defšed 
L_SET


325 
	#L_SET
 
SEEK_SET


	)

326 
	#L_INCR
 
SEEK_CUR


	)

327 
	#L_XTND
 
SEEK_END


	)

336 #iâdeà
__USE_FILE_OFFSET64


337 
__off_t
 
	$l£ek
 (
__fd
, 
__off_t
 
__off£t
, 
__wh’û
è
__THROW
;

339 #ifdeà
__REDIRECT_NTH


340 
__off64_t
 
	`__REDIRECT_NTH
 (
l£ek
,

341 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
),

342 
l£ek64
);

344 
	#l£ek
 
l£ek64


	)

347 #ifdeà
__USE_LARGEFILE64


348 
__off64_t
 
	$l£ek64
 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
)

349 
__THROW
;

356 
	`şo£
 (
__fd
);

363 
ssize_t
 
	$»ad
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
è
__wur
;

369 
ssize_t
 
	$wr™e
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
è
__wur
;

371 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


372 #iâdeà
__USE_FILE_OFFSET64


379 
ssize_t
 
	$´—d
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

380 
__off_t
 
__off£t
è
__wur
;

387 
ssize_t
 
	$pwr™e
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

388 
__off_t
 
__off£t
è
__wur
;

390 #ifdeà
__REDIRECT


391 
ssize_t
 
	`__REDIRECT
 (
´—d
, (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

392 
__off64_t
 
__off£t
),

393 
´—d64
è
__wur
;

394 
ssize_t
 
	`__REDIRECT
 (
pwr™e
, (
__fd
, cÚ¡ *
__buf
,

395 
size_t
 
__nby‹s
, 
__off64_t
 
__off£t
),

396 
pwr™e64
è
__wur
;

398 
	#´—d
 
´—d64


	)

399 
	#pwr™e
 
pwr™e64


	)

403 #ifdeà
__USE_LARGEFILE64


407 
ssize_t
 
	$´—d64
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

408 
__off64_t
 
__off£t
è
__wur
;

411 
ssize_t
 
	$pwr™e64
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

412 
__off64_t
 
__off£t
è
__wur
;

420 
	$pe
 (
__pedes
[2]è
__THROW
 
__wur
;

422 #ifdeà
__USE_GNU


425 
	$pe2
 (
__pedes
[2], 
__æags
è
__THROW
 
__wur
;

435 
	$®¬m
 (
__£cÚds
è
__THROW
;

447 
	`¦“p
 (
__£cÚds
);

449 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

450 || 
defšed
 
__USE_MISC


455 
__u£cÚds_t
 
	$u®¬m
 (
__u£cÚds_t
 
__v®ue
, __u£cÚds_ˆ
__š‹rv®
)

456 
__THROW
;

463 
	`u¦“p
 (
__u£cÚds_t
 
__u£cÚds
);

472 
	`·u£
 ();

476 
	$chown
 (cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

477 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

479 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


481 
	$fchown
 (
__fd
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
è
__THROW
 
__wur
;

486 
	$lchown
 (cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

487 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

491 #ifdeà
__USE_ATFILE


494 
	$fchowÇt
 (
__fd
, cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
,

495 
__gid_t
 
__group
, 
__æag
)

496 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

500 
	$chdœ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

502 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


504 
	$fchdœ
 (
__fd
è
__THROW
 
__wur
;

514 *
	$g‘cwd
 (*
__buf
, 
size_t
 
__size
è
__THROW
 
__wur
;

516 #ifdef 
__USE_GNU


520 *
	$g‘_cu¼’t_dœ_Çme
 (è
__THROW
;

523 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

524 || 
defšed
 
__USE_MISC


528 *
	$g‘wd
 (*
__buf
)

529 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
 
__wur
;

534 
	$dup
 (
__fd
è
__THROW
 
__wur
;

537 
	$dup2
 (
__fd
, 
__fd2
è
__THROW
;

539 #ifdeà
__USE_GNU


542 
	$dup3
 (
__fd
, 
__fd2
, 
__æags
è
__THROW
;

546 **
__’vœÚ
;

547 #ifdeà
__USE_GNU


548 **
’vœÚ
;

554 
	$execve
 (cÚ¡ *
__·th
, *cÚ¡ 
__¬gv
[],

555 *cÚ¡ 
__’vp
[]è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

557 #ifdeà
__USE_XOPEN2K8


560 
	$ãxecve
 (
__fd
, *cÚ¡ 
__¬gv
[], *cÚ¡ 
__’vp
[])

561 
__THROW
 
	`__nÚnuÎ
 ((2));

566 
	$execv
 (cÚ¡ *
__·th
, *cÚ¡ 
__¬gv
[])

567 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

571 
	$exeşe
 (cÚ¡ *
__·th
, cÚ¡ *
__¬g
, ...)

572 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

576 
	$exeş
 (cÚ¡ *
__·th
, cÚ¡ *
__¬g
, ...)

577 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

581 
	$execvp
 (cÚ¡ *
__fe
, *cÚ¡ 
__¬gv
[])

582 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

587 
	$exeşp
 (cÚ¡ *
__fe
, cÚ¡ *
__¬g
, ...)

588 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

590 #ifdeà
__USE_GNU


593 
	$execv³
 (cÚ¡ *
__fe
, *cÚ¡ 
__¬gv
[],

594 *cÚ¡ 
__’vp
[])

595 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

599 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


601 
	$niû
 (
__šc
è
__THROW
 
__wur
;

606 
	$_ex™
 (
__¡©us
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

612 
	~<b™s/cÚâame.h
>

615 
	$·thcÚf
 (cÚ¡ *
__·th
, 
__Çme
)

616 
__THROW
 
	`__nÚnuÎ
 ((1));

619 
	$å©hcÚf
 (
__fd
, 
__Çme
è
__THROW
;

622 
	$syscÚf
 (
__Çme
è
__THROW
;

624 #ifdef 
__USE_POSIX2


626 
size_t
 
	$cÚf¡r
 (
__Çme
, *
__buf
, 
size_t
 
__Ën
è
__THROW
;

631 
__pid_t
 
	$g‘pid
 (è
__THROW
;

634 
__pid_t
 
	$g‘µid
 (è
__THROW
;

637 
__pid_t
 
	$g‘pg½
 (è
__THROW
;

640 
__pid_t
 
	$__g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

641 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


642 
__pid_t
 
	$g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

649 
	$£gid
 (
__pid_t
 
__pid
, __pid_ˆ
__pgid
è
__THROW
;

651 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


663 
	$£g½
 (è
__THROW
;

670 
__pid_t
 
	$£tsid
 (è
__THROW
;

672 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


674 
__pid_t
 
	$g‘sid
 (
__pid_t
 
__pid
è
__THROW
;

678 
__uid_t
 
	$g‘uid
 (è
__THROW
;

681 
__uid_t
 
	$g‘euid
 (è
__THROW
;

684 
__gid_t
 
	$g‘gid
 (è
__THROW
;

687 
__gid_t
 
	$g‘egid
 (è
__THROW
;

692 
	$g‘groups
 (
__size
, 
__gid_t
 
__li¡
[]è
__THROW
 
__wur
;

694 #ifdef 
__USE_GNU


696 
	$group_memb”
 (
__gid_t
 
__gid
è
__THROW
;

703 
	$£tuid
 (
__uid_t
 
__uid
è
__THROW
 
__wur
;

705 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


708 
	$£Œeuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
è
__THROW
 
__wur
;

711 #ifdeà
__USE_XOPEN2K


713 
	$£‹uid
 (
__uid_t
 
__uid
è
__THROW
 
__wur
;

720 
	$£tgid
 (
__gid_t
 
__gid
è
__THROW
 
__wur
;

722 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


725 
	$£Œegid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
è
__THROW
 
__wur
;

728 #ifdeà
__USE_XOPEN2K


730 
	$£‹gid
 (
__gid_t
 
__gid
è
__THROW
 
__wur
;

733 #ifdeà
__USE_GNU


736 
	$g‘»suid
 (
__uid_t
 *
__ruid
, __uid_ˆ*
__euid
, __uid_ˆ*
__suid
)

737 
__THROW
;

741 
	$g‘»sgid
 (
__gid_t
 *
__rgid
, __gid_ˆ*
__egid
, __gid_ˆ*
__sgid
)

742 
__THROW
;

746 
	$£Œesuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
, __uid_ˆ
__suid
)

747 
__THROW
 
__wur
;

751 
	$£Œesgid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
, __gid_ˆ
__sgid
)

752 
__THROW
 
__wur
;

759 
__pid_t
 
	$fÜk
 (è
__THROWNL
;

761 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

762 || 
defšed
 
__USE_MISC


767 
__pid_t
 
	$vfÜk
 (è
__THROW
;

773 *
	$‰yÇme
 (
__fd
è
__THROW
;

777 
	$‰yÇme_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

778 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

782 
	$i§‰y
 (
__fd
è
__THROW
;

784 #ià
defšed
 
__USE_MISC
 \

785 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_UNIX98
)

788 
	$‰y¦Ù
 (è
__THROW
;

793 
	$lšk
 (cÚ¡ *
__äom
, cÚ¡ *
__to
)

794 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

796 #ifdeà
__USE_ATFILE


799 
	$lšk©
 (
__äomfd
, cÚ¡ *
__äom
, 
__tofd
,

800 cÚ¡ *
__to
, 
__æags
)

801 
__THROW
 
	`__nÚnuÎ
 ((2, 4)è
__wur
;

804 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


806 
	$symlšk
 (cÚ¡ *
__äom
, cÚ¡ *
__to
)

807 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

812 
ssize_t
 
	$»adlšk
 (cÚ¡ *
__»¡riù
 
__·th
,

813 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

814 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

817 #ifdeà
__USE_ATFILE


819 
	$symlšk©
 (cÚ¡ *
__äom
, 
__tofd
,

820 cÚ¡ *
__to
è
__THROW
 
	`__nÚnuÎ
 ((1, 3)è
__wur
;

823 
ssize_t
 
	$»adlšk©
 (
__fd
, cÚ¡ *
__»¡riù
 
__·th
,

824 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

825 
__THROW
 
	`__nÚnuÎ
 ((2, 3)è
__wur
;

829 
	$uÆšk
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

831 #ifdeà
__USE_ATFILE


833 
	$uÆšk©
 (
__fd
, cÚ¡ *
__Çme
, 
__æag
)

834 
__THROW
 
	`__nÚnuÎ
 ((2));

838 
	$rmdœ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1));

842 
__pid_t
 
	$tcg‘pg½
 (
__fd
è
__THROW
;

845 
	$tc£g½
 (
__fd
, 
__pid_t
 
__pg½_id
è
__THROW
;

852 *
	`g‘logš
 ();

853 #ià
defšed
 
__USE_REENTRANT
 || defšed 
__USE_POSIX199506


860 
	$g‘logš_r
 (*
__Çme
, 
size_t
 
__Çme_Ën
è
	`__nÚnuÎ
 ((1));

863 #ifdef 
__USE_MISC


865 
	$£ogš
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

869 #ifdef 
__USE_POSIX2


873 
	#__Ãed_g‘İt


	)

874 
	~<g‘İt.h
>

878 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


882 
	$g‘ho¡Çme
 (*
__Çme
, 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((1));

886 #ià
defšed
 
__USE_MISC


889 
	$£tho¡Çme
 (cÚ¡ *
__Çme
, 
size_t
 
__Ën
)

890 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

894 
	$£tho¡id
 (
__id
è
__THROW
 
__wur
;

900 
	$g‘domašÇme
 (*
__Çme
, 
size_t
 
__Ën
)

901 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

902 
	$£tdomašÇme
 (cÚ¡ *
__Çme
, 
size_t
 
__Ën
)

903 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

909 
	$vhªgup
 (è
__THROW
;

912 
	$»voke
 (cÚ¡ *
__fe
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

920 
	$´of
 (*
__§m¶e_bufãr
, 
size_t
 
__size
,

921 
size_t
 
__off£t
, 
__sÿË
)

922 
__THROW
 
	`__nÚnuÎ
 ((1));

928 
	$acù
 (cÚ¡ *
__Çme
è
__THROW
;

932 *
	$g‘u£rsh–l
 (è
__THROW
;

933 
	$’du£rsh–l
 (è
__THROW
;

934 
	$£tu£rsh–l
 (è
__THROW
;

940 
	$d«mÚ
 (
__nochdœ
, 
__noşo£
è
__THROW
 
__wur
;

944 #ià
defšed
 
__USE_MISC
 || (defšed 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

947 
	$chroÙ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

951 *
	$g‘·ss
 (cÚ¡ *
__´om±
è
	`__nÚnuÎ
 ((1));

959 
	`fsync
 (
__fd
);

962 #ifdeà
__USE_GNU


965 
	$syncfs
 (
__fd
è
__THROW
;

969 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


972 
	`g‘ho¡id
 ();

975 
	$sync
 (è
__THROW
;

978 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K


981 
	$g‘·gesize
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

986 
	$g‘dbËsize
 (è
__THROW
;

992 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


995 #iâdeà
__USE_FILE_OFFSET64


996 
	$Œunÿ‹
 (cÚ¡ *
__fe
, 
__off_t
 
__Ëngth
)

997 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

999 #ifdeà
__REDIRECT_NTH


1000 
	`__REDIRECT_NTH
 (
Œunÿ‹
,

1001 (cÚ¡ *
__fe
, 
__off64_t
 
__Ëngth
),

1002 
Œunÿ‹64
è
	`__nÚnuÎ
 ((1)è
__wur
;

1004 
	#Œunÿ‹
 
Œunÿ‹64


	)

1007 #ifdeà
__USE_LARGEFILE64


1008 
	$Œunÿ‹64
 (cÚ¡ *
__fe
, 
__off64_t
 
__Ëngth
)

1009 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

1014 #ià
defšed
 
__USE_POSIX199309
 \

1015 || 
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


1018 #iâdeà
__USE_FILE_OFFSET64


1019 
	$árunÿ‹
 (
__fd
, 
__off_t
 
__Ëngth
è
__THROW
 
__wur
;

1021 #ifdeà
__REDIRECT_NTH


1022 
	`__REDIRECT_NTH
 (
árunÿ‹
, (
__fd
, 
__off64_t
 
__Ëngth
),

1023 
árunÿ‹64
è
__wur
;

1025 
	#árunÿ‹
 
árunÿ‹64


	)

1028 #ifdeà
__USE_LARGEFILE64


1029 
	$árunÿ‹64
 (
__fd
, 
__off64_t
 
__Ëngth
è
__THROW
 
__wur
;

1035 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

1036 || 
defšed
 
__USE_MISC


1040 
	$brk
 (*
__addr
è
__THROW
 
__wur
;

1046 *
	$sbrk
 (
šŒ_t
 
__d–
è
__THROW
;

1050 #ifdeà
__USE_MISC


1061 
	$sysÿÎ
 (
__sy¢o
, ...è
__THROW
;

1066 #ià(
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
è&& !defšed 
F_LOCK


1078 
	#F_ULOCK
 0

	)

1079 
	#F_LOCK
 1

	)

1080 
	#F_TLOCK
 2

	)

1081 
	#F_TEST
 3

	)

1083 #iâdeà
__USE_FILE_OFFSET64


1084 
	$lockf
 (
__fd
, 
__cmd
, 
__off_t
 
__Ën
è
__wur
;

1086 #ifdeà
__REDIRECT


1087 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
),

1088 
lockf64
è
__wur
;

1090 
	#lockf
 
lockf64


	)

1093 #ifdeà
__USE_LARGEFILE64


1094 
	$lockf64
 (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
è
__wur
;

1099 #ifdeà
__USE_GNU


1104 
	#TEMP_FAILURE_RETRY
(
ex´essiÚ
) \

1105 (
__ex‹nsiÚ__
 \

1106 ({ 
__»suÉ
; \

1107 dØ
__»suÉ
 = (è(
ex´essiÚ
); \

1108 
__»suÉ
 =ğ-1L && 
”ºo
 =ğ
EINTR
); \

1109 
__»suÉ
; 
	}
}))

	)

1112 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_UNIX98


1115 
fd©async
 (
__fdes
);

1121 #ifdef 
__USE_XOPEN


1123 *
	$üy±
 (cÚ¡ *
__key
, cÚ¡ *
__§É
)

1124 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1128 
	$’üy±
 (*
__glibc_block
, 
__edæag
)

1129 
__THROW
 
	`__nÚnuÎ
 ((1));

1136 
	$swab
 (cÚ¡ *
__»¡riù
 
__äom
, *__»¡riù 
__to
,

1137 
ssize_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1143 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K


1145 *
	$ù”mid
 (*
__s
è
__THROW
;

1150 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


1151 
	~<b™s/uni¡d.h
>

1154 
__END_DECLS


	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

97 #undeà
__USE_ISOC11


98 #undeà
__USE_ISOC99


99 #undeà
__USE_ISOC95


100 #undeà
__USE_ISOCXX11


101 #undeà
__USE_POSIX


102 #undeà
__USE_POSIX2


103 #undeà
__USE_POSIX199309


104 #undeà
__USE_POSIX199506


105 #undeà
__USE_XOPEN


106 #undeà
__USE_XOPEN_EXTENDED


107 #undeà
__USE_UNIX98


108 #undeà
__USE_XOPEN2K


109 #undeà
__USE_XOPEN2KXSI


110 #undeà
__USE_XOPEN2K8


111 #undeà
__USE_XOPEN2K8XSI


112 #undeà
__USE_LARGEFILE


113 #undeà
__USE_LARGEFILE64


114 #undeà
__USE_FILE_OFFSET64


115 #undeà
__USE_MISC


116 #undeà
__USE_ATFILE


117 #undeà
__USE_GNU


118 #undeà
__USE_REENTRANT


119 #undeà
__USE_FORTIFY_LEVEL


120 #undeà
__KERNEL_STRICT_NAMES


124 #iâdeà
_LOOSE_KERNEL_NAMES


125 
	#__KERNEL_STRICT_NAMES


	)

135 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


136 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

137 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

139 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

146 #ià(
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE
) \

147 && !
defšed
 
	g_DEFAULT_SOURCE


152 #undeà
_DEFAULT_SOURCE


153 
	#_DEFAULT_SOURCE
 1

	)

157 #ifdeà
_GNU_SOURCE


158 #undeà
_ISOC95_SOURCE


159 
	#_ISOC95_SOURCE
 1

	)

160 #undeà
_ISOC99_SOURCE


161 
	#_ISOC99_SOURCE
 1

	)

162 #undeà
_ISOC11_SOURCE


163 
	#_ISOC11_SOURCE
 1

	)

164 #undeà
_POSIX_SOURCE


165 
	#_POSIX_SOURCE
 1

	)

166 #undeà
_POSIX_C_SOURCE


167 
	#_POSIX_C_SOURCE
 200809L

	)

168 #undeà
_XOPEN_SOURCE


169 
	#_XOPEN_SOURCE
 700

	)

170 #undeà
_XOPEN_SOURCE_EXTENDED


171 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

172 #undeà
_LARGEFILE64_SOURCE


173 
	#_LARGEFILE64_SOURCE
 1

	)

174 #undeà
_DEFAULT_SOURCE


175 
	#_DEFAULT_SOURCE
 1

	)

176 #undeà
_ATFILE_SOURCE


177 
	#_ATFILE_SOURCE
 1

	)

182 #ià(
defšed
 
_DEFAULT_SOURCE
 \

183 || (!
defšed
 
	g__STRICT_ANSI__
 \

184 && !
defšed
 
	g_ISOC99_SOURCE
 \

185 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

186 && !
defšed
 
	g_XOPEN_SOURCE
))

187 #undeà
_DEFAULT_SOURCE


188 
	#_DEFAULT_SOURCE
 1

	)

192 #ià(
defšed
 
_ISOC11_SOURCE
 \

193 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

194 
	#__USE_ISOC11
 1

	)

198 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

199 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

200 
	#__USE_ISOC99
 1

	)

204 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

205 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

206 
	#__USE_ISOC95
 1

	)

213 #ià((
defšed
 
__ılu¥lus
 && __cplusplus >= 201103L) \

214 || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__
)

215 
	#__USE_ISOCXX11
 1

	)

221 #ifdeà
_DEFAULT_SOURCE


222 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


223 
	#__USE_POSIX_IMPLICITLY
 1

	)

225 #undeà
_POSIX_SOURCE


226 
	#_POSIX_SOURCE
 1

	)

227 #undeà
_POSIX_C_SOURCE


228 
	#_POSIX_C_SOURCE
 200809L

	)

230 #ià((!
defšed
 
__STRICT_ANSI__
 \

231 || (
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

232 && !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

233 
	#_POSIX_SOURCE
 1

	)

234 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

235 
	#_POSIX_C_SOURCE
 2

	)

236 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

237 
	#_POSIX_C_SOURCE
 199506L

	)

238 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

239 
	#_POSIX_C_SOURCE
 200112L

	)

241 
	#_POSIX_C_SOURCE
 200809L

	)

243 
	#__USE_POSIX_IMPLICITLY
 1

	)

246 #ià(
defšed
 
_POSIX_SOURCE
 \

247 || (
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

248 || 
defšed
 
_XOPEN_SOURCE
)

249 
	#__USE_POSIX
 1

	)

252 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


253 
	#__USE_POSIX2
 1

	)

256 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

257 
	#__USE_POSIX199309
 1

	)

260 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

261 
	#__USE_POSIX199506
 1

	)

264 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

265 
	#__USE_XOPEN2K
 1

	)

266 #undeà
__USE_ISOC95


267 
	#__USE_ISOC95
 1

	)

268 #undeà
__USE_ISOC99


269 
	#__USE_ISOC99
 1

	)

272 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

273 
	#__USE_XOPEN2K8
 1

	)

274 #undeà
_ATFILE_SOURCE


275 
	#_ATFILE_SOURCE
 1

	)

278 #ifdef 
_XOPEN_SOURCE


279 
	#__USE_XOPEN
 1

	)

280 #ià(
_XOPEN_SOURCE
 - 0) >= 500

281 
	#__USE_XOPEN_EXTENDED
 1

	)

282 
	#__USE_UNIX98
 1

	)

283 #undeà
_LARGEFILE_SOURCE


284 
	#_LARGEFILE_SOURCE
 1

	)

285 #ià(
_XOPEN_SOURCE
 - 0) >= 600

286 #ià(
_XOPEN_SOURCE
 - 0) >= 700

287 
	#__USE_XOPEN2K8
 1

	)

288 
	#__USE_XOPEN2K8XSI
 1

	)

290 
	#__USE_XOPEN2K
 1

	)

291 
	#__USE_XOPEN2KXSI
 1

	)

292 #undeà
__USE_ISOC95


293 
	#__USE_ISOC95
 1

	)

294 #undeà
__USE_ISOC99


295 
	#__USE_ISOC99
 1

	)

298 #ifdeà
_XOPEN_SOURCE_EXTENDED


299 
	#__USE_XOPEN_EXTENDED
 1

	)

304 #ifdeà
_LARGEFILE_SOURCE


305 
	#__USE_LARGEFILE
 1

	)

308 #ifdeà
_LARGEFILE64_SOURCE


309 
	#__USE_LARGEFILE64
 1

	)

312 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

313 
	#__USE_FILE_OFFSET64
 1

	)

316 #ià
defšed
 
_DEFAULT_SOURCE


317 
	#__USE_MISC
 1

	)

320 #ifdef 
_ATFILE_SOURCE


321 
	#__USE_ATFILE
 1

	)

324 #ifdef 
_GNU_SOURCE


325 
	#__USE_GNU
 1

	)

328 #ià
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE


329 
	#__USE_REENTRANT
 1

	)

332 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

333 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

334 #ià
_FORTIFY_SOURCE
 > 1

335 
	#__USE_FORTIFY_LEVEL
 2

	)

337 
	#__USE_FORTIFY_LEVEL
 1

	)

340 
	#__USE_FORTIFY_LEVEL
 0

	)

345 
	~<¡dc-´edef.h
>

353 #undeà
__GNU_LIBRARY__


354 
	#__GNU_LIBRARY__
 6

	)

358 
	#__GLIBC__
 2

	)

359 
	#__GLIBC_MINOR__
 23

	)

361 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

362 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

365 #iâdeà
__ASSEMBLER__


366 #iâdeà
_SYS_CDEFS_H


367 
	~<sys/cdefs.h
>

372 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


373 
	#__USE_LARGEFILE
 1

	)

374 
	#__USE_LARGEFILE64
 1

	)

380 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

381 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

382 && 
defšed
 
	g__ex‹º_šlše


383 
	#__USE_EXTERN_INLINES
 1

	)

391 
	~<gnu/¡ubs.h
>

	@/usr/include/getopt.h

19 #iâdeà
_GETOPT_H


21 #iâdeà
__Ãed_g‘İt


22 
	#_GETOPT_H
 1

	)

32 #ià!
defšed
 
__GNU_LIBRARY__


33 
	~<ùy³.h
>

36 #iâdeà
__THROW


37 #iâdeà
__GNUC_PREREQ


38 
	#__GNUC_PREREQ
(
maj
, 
mš
è(0)

	)

40 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,8)

41 
	#__THROW
 
	`throw
 ()

	)

43 
	#__THROW


	)

47 #ifdef 
__ılu¥lus


57 *
İrg
;

71 
İtšd
;

76 
İ‹¼
;

80 
İtİt
;

82 #iâdeà
__Ãed_g‘İt


104 
	sİtiÚ


106 cÚ¡ *
	gÇme
;

109 
	ghas_¬g
;

110 *
	gæag
;

111 
	gv®
;

116 
	#no_¬gum’t
 0

	)

117 
	#»quœed_¬gum’t
 1

	)

118 
	#İtiÚ®_¬gum’t
 2

	)

146 #ifdeà
__GNU_LIBRARY__


150 
g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
, cÚ¡ *
__shÜtİts
)

151 
__THROW
;

153 #ià
defšed
 
__Ãed_g‘İt
 && defšed 
__USE_POSIX2
 \

154 && !
defšed
 
	g__USE_POSIX_IMPLICITLY
 && !defšed 
	g__USE_GNU


158 #ifdeà
__REDIRECT


159 
__REDIRECT_NTH
 (
g‘İt
, (
___¬gc
, *cÚ¡ *
___¬gv
,

160 cÚ¡ *
__shÜtİts
),

161 
__posix_g‘İt
);

163 
__posix_g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
,

164 cÚ¡ *
__shÜtİts
è
__THROW
;

165 
	#g‘İt
 
__posix_g‘İt


	)

169 
g‘İt
 ();

172 #iâdeà
__Ãed_g‘İt


173 
g‘İt_lÚg
 (
___¬gc
, *cÚ¡ *
___¬gv
,

174 cÚ¡ *
__shÜtİts
,

175 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

176 
__THROW
;

177 
g‘İt_lÚg_Úly
 (
___¬gc
, *cÚ¡ *
___¬gv
,

178 cÚ¡ *
__shÜtİts
,

179 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

180 
__THROW
;

184 #ifdef 
__ılu¥lus


189 #undeà
__Ãed_g‘İt


	@/usr/include/libio.h

28 #iâdeà
_IO_STDIO_H


29 
	#_IO_STDIO_H


	)

31 
	~<_G_cÚfig.h
>

33 
	#_IO_åos_t
 
_G_åos_t


	)

34 
	#_IO_åos64_t
 
_G_åos64_t


	)

35 
	#_IO_size_t
 
size_t


	)

36 
	#_IO_ssize_t
 
__ssize_t


	)

37 
	#_IO_off_t
 
__off_t


	)

38 
	#_IO_off64_t
 
__off64_t


	)

39 
	#_IO_pid_t
 
__pid_t


	)

40 
	#_IO_uid_t
 
__uid_t


	)

41 
	#_IO_icÚv_t
 
_G_icÚv_t


	)

42 
	#_IO_HAVE_ST_BLKSIZE
 
_G_HAVE_ST_BLKSIZE


	)

43 
	#_IO_BUFSIZ
 
_G_BUFSIZ


	)

44 
	#_IO_va_li¡
 
_G_va_li¡


	)

45 
	#_IO_wšt_t
 
wšt_t


	)

48 
	#__Ãed___va_li¡


	)

49 
	~<¡d¬g.h
>

50 #ifdeà
__GNUC_VA_LIST


51 #undeà
_IO_va_li¡


52 
	#_IO_va_li¡
 
__gnuc_va_li¡


	)

55 #iâdeà
__P


56 
	~<sys/cdefs.h
>

59 
	#_IO_UNIFIED_JUMPTABLES
 1

	)

61 #iâdeà
EOF


62 
	#EOF
 (-1)

	)

64 #iâdeà
NULL


65 #ià
defšed
 
__GNUG__
 && \

66 (
	g__GNUC__
 > 2 || (__GNUC__ =ğ2 && 
__GNUC_MINOR__
 >= 8))

67 
	#NULL
 (
__nuÎ
)

	)

69 #ià!
defšed
(
__ılu¥lus
)

70 
	#NULL
 ((*)0)

	)

72 
	#NULL
 (0)

	)

77 
	#_IOS_INPUT
 1

	)

78 
	#_IOS_OUTPUT
 2

	)

79 
	#_IOS_ATEND
 4

	)

80 
	#_IOS_APPEND
 8

	)

81 
	#_IOS_TRUNC
 16

	)

82 
	#_IOS_NOCREATE
 32

	)

83 
	#_IOS_NOREPLACE
 64

	)

84 
	#_IOS_BIN
 128

	)

92 
	#_IO_MAGIC
 0xFBAD0000

	)

93 
	#_OLD_STDIO_MAGIC
 0xFABC0000

	)

94 
	#_IO_MAGIC_MASK
 0xFFFF0000

	)

95 
	#_IO_USER_BUF
 1

	)

96 
	#_IO_UNBUFFERED
 2

	)

97 
	#_IO_NO_READS
 4

	)

98 
	#_IO_NO_WRITES
 8

	)

99 
	#_IO_EOF_SEEN
 0x10

	)

100 
	#_IO_ERR_SEEN
 0x20

	)

101 
	#_IO_DELETE_DONT_CLOSE
 0x40

	)

102 
	#_IO_LINKED
 0x80

	)

103 
	#_IO_IN_BACKUP
 0x100

	)

104 
	#_IO_LINE_BUF
 0x200

	)

105 
	#_IO_TIED_PUT_GET
 0x400

	)

106 
	#_IO_CURRENTLY_PUTTING
 0x800

	)

107 
	#_IO_IS_APPENDING
 0x1000

	)

108 
	#_IO_IS_FILEBUF
 0x2000

	)

109 
	#_IO_BAD_SEEN
 0x4000

	)

110 
	#_IO_USER_LOCK
 0x8000

	)

112 
	#_IO_FLAGS2_MMAP
 1

	)

113 
	#_IO_FLAGS2_NOTCANCEL
 2

	)

114 #ifdeà
_LIBC


115 
	#_IO_FLAGS2_FORTIFY
 4

	)

117 
	#_IO_FLAGS2_USER_WBUF
 8

	)

118 #ifdeà
_LIBC


119 
	#_IO_FLAGS2_SCANF_STD
 16

	)

120 
	#_IO_FLAGS2_NOCLOSE
 32

	)

121 
	#_IO_FLAGS2_CLOEXEC
 64

	)

125 
	#_IO_SKIPWS
 01

	)

126 
	#_IO_LEFT
 02

	)

127 
	#_IO_RIGHT
 04

	)

128 
	#_IO_INTERNAL
 010

	)

129 
	#_IO_DEC
 020

	)

130 
	#_IO_OCT
 040

	)

131 
	#_IO_HEX
 0100

	)

132 
	#_IO_SHOWBASE
 0200

	)

133 
	#_IO_SHOWPOINT
 0400

	)

134 
	#_IO_UPPERCASE
 01000

	)

135 
	#_IO_SHOWPOS
 02000

	)

136 
	#_IO_SCIENTIFIC
 04000

	)

137 
	#_IO_FIXED
 010000

	)

138 
	#_IO_UNITBUF
 020000

	)

139 
	#_IO_STDIO
 040000

	)

140 
	#_IO_DONT_CLOSE
 0100000

	)

141 
	#_IO_BOOLALPHA
 0200000

	)

144 
_IO_jump_t
; 
	g_IO_FILE
;

147 #ifdeà
_IO_MTSAFE_IO


150 
	t_IO_lock_t
;

156 
	s_IO_m¬k”
 {

157 
_IO_m¬k”
 *
	m_Ãxt
;

158 
_IO_FILE
 *
	m_sbuf
;

162 
	m_pos
;

164 
£t_¡»ampos
(
¡»ampos
 
¥
è{ 
	m_¥os
 = sp; }

165 
£t_off£t
(
off£t
è{ 
	m_pos
 = off£t; 
	m_¥os
 = (
¡»ampos
)(-2); }

166 
	mpublic
:

167 
¡»amm¬k”
(
¡»ambuf
 *
sb
);

168 ~
¡»amm¬k”
();

169 
§všg
(è{  
	m_¥os
 == -2; }

170 
d–
(
¡»amm¬k”
&);

171 
d–
();

176 
	e__codecvt_»suÉ


178 
	m__codecvt_ok
,

179 
	m__codecvt_·¹Ÿl
,

180 
	m__codecvt_”rÜ
,

181 
	m__codecvt_nocÚv


184 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


187 
	s_IO_codecvt


189 (*
	m__codecvt_de¡r
è(
	m_IO_codecvt
 *);

190 
__codecvt_»suÉ
 (*
__codecvt_do_out
è(
	m_IO_codecvt
 *,

191 
	m__mb¡©e_t
 *,

192 cÚ¡ 
	mwch¬_t
 *,

193 cÚ¡ 
	mwch¬_t
 *,

194 cÚ¡ 
	mwch¬_t
 **, *,

196 
__codecvt_»suÉ
 (*
__codecvt_do_unshiá
è(
	m_IO_codecvt
 *,

197 
	m__mb¡©e_t
 *, *,

199 
__codecvt_»suÉ
 (*
__codecvt_do_š
è(
	m_IO_codecvt
 *,

200 
	m__mb¡©e_t
 *,

202 cÚ¡ **, 
	mwch¬_t
 *,

203 
	mwch¬_t
 *, wchar_t **);

204 (*
	m__codecvt_do_’codšg
è(
	m_IO_codecvt
 *);

205 (*
	m__codecvt_do_®ways_nocÚv
è(
	m_IO_codecvt
 *);

206 (*
	m__codecvt_do_Ëngth
è(
	m_IO_codecvt
 *, 
	m__mb¡©e_t
 *,

207 cÚ¡ *, cÚ¡ *, 
	m_IO_size_t
);

208 (*
	m__codecvt_do_max_Ëngth
è(
	m_IO_codecvt
 *);

210 
_IO_icÚv_t
 
	m__cd_š
;

211 
_IO_icÚv_t
 
	m__cd_out
;

215 
	s_IO_wide_d©a


217 
wch¬_t
 *
	m_IO_»ad_±r
;

218 
wch¬_t
 *
	m_IO_»ad_’d
;

219 
wch¬_t
 *
	m_IO_»ad_ba£
;

220 
wch¬_t
 *
	m_IO_wr™e_ba£
;

221 
wch¬_t
 *
	m_IO_wr™e_±r
;

222 
wch¬_t
 *
	m_IO_wr™e_’d
;

223 
wch¬_t
 *
	m_IO_buf_ba£
;

224 
wch¬_t
 *
	m_IO_buf_’d
;

226 
wch¬_t
 *
	m_IO_§ve_ba£
;

227 
wch¬_t
 *
	m_IO_backup_ba£
;

229 
wch¬_t
 *
	m_IO_§ve_’d
;

231 
__mb¡©e_t
 
	m_IO_¡©e
;

232 
__mb¡©e_t
 
	m_IO_Ï¡_¡©e
;

233 
_IO_codecvt
 
	m_codecvt
;

235 
wch¬_t
 
	m_shÜtbuf
[1];

237 cÚ¡ 
_IO_jump_t
 *
	m_wide_vbË
;

241 
	s_IO_FILE
 {

242 
	m_æags
;

243 
	#_IO_fe_æags
 
_æags


	)

247 * 
	m_IO_»ad_±r
;

248 * 
	m_IO_»ad_’d
;

249 * 
	m_IO_»ad_ba£
;

250 * 
	m_IO_wr™e_ba£
;

251 * 
	m_IO_wr™e_±r
;

252 * 
	m_IO_wr™e_’d
;

253 * 
	m_IO_buf_ba£
;

254 * 
	m_IO_buf_’d
;

256 *
	m_IO_§ve_ba£
;

257 *
	m_IO_backup_ba£
;

258 *
	m_IO_§ve_’d
;

260 
_IO_m¬k”
 *
	m_m¬k”s
;

262 
_IO_FILE
 *
	m_chaš
;

264 
	m_f’o
;

266 
	m_blksize
;

268 
	m_æags2
;

270 
_IO_off_t
 
	m_Şd_off£t
;

272 
	#__HAVE_COLUMN


	)

274 
	m_cur_cŞumn
;

275 sigÃd 
	m_vbË_off£t
;

276 
	m_shÜtbuf
[1];

280 
_IO_lock_t
 *
	m_lock
;

281 #ifdeà
_IO_USE_OLD_IO_FILE


284 
	s_IO_FILE_com¶‘e


286 
_IO_FILE
 
	m_fe
;

288 #ià
defšed
 
_G_IO_IO_FILE_VERSION
 && _G_IO_IO_FILE_VERSION == 0x20001

289 
_IO_off64_t
 
	m_off£t
;

290 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


292 
_IO_codecvt
 *
	m_codecvt
;

293 
_IO_wide_d©a
 *
	m_wide_d©a
;

294 
_IO_FILE
 *
	m_ä“»s_li¡
;

295 *
	m_ä“»s_buf
;

297 *
	m__·d1
;

298 *
	m__·d2
;

299 *
	m__·d3
;

300 *
	m__·d4
;

302 
size_t
 
	m__·d5
;

303 
	m_mode
;

305 
	m_unu£d2
[15 *  (è- 4 *  (*è-  (
size_t
)];

309 #iâdeà
__ılu¥lus


310 
_IO_FILE
 
	t_IO_FILE
;

313 
	g_IO_FILE_¶us
;

315 
_IO_FILE_¶us
 
_IO_2_1_¡dš_
;

316 
_IO_FILE_¶us
 
_IO_2_1_¡dout_
;

317 
_IO_FILE_¶us
 
_IO_2_1_¡d”r_
;

318 #iâdeà
_LIBC


319 
	#_IO_¡dš
 ((
_IO_FILE
*)(&
_IO_2_1_¡dš_
))

	)

320 
	#_IO_¡dout
 ((
_IO_FILE
*)(&
_IO_2_1_¡dout_
))

	)

321 
	#_IO_¡d”r
 ((
_IO_FILE
*)(&
_IO_2_1_¡d”r_
))

	)

323 
_IO_FILE
 *
_IO_¡dš
 
©Œibu‹_hidd’
;

324 
_IO_FILE
 *
_IO_¡dout
 
©Œibu‹_hidd’
;

325 
_IO_FILE
 *
_IO_¡d”r
 
©Œibu‹_hidd’
;

333 
__ssize_t
 
	t__io_»ad_â
 (*
	t__cook›
, *
	t__buf
, 
	tsize_t
 
	t__nby‹s
);

341 
__ssize_t
 
	t__io_wr™e_â
 (*
	t__cook›
, cÚ¡ *
	t__buf
,

342 
	tsize_t
 
	t__n
);

350 
	t__io_£ek_â
 (*
	t__cook›
, 
	t_IO_off64_t
 *
	t__pos
, 
	t__w
);

353 
	t__io_şo£_â
 (*
	t__cook›
);

356 #ifdeà
_GNU_SOURCE


358 
__io_»ad_â
 
	tcook›_»ad_funùiÚ_t
;

359 
__io_wr™e_â
 
	tcook›_wr™e_funùiÚ_t
;

360 
__io_£ek_â
 
	tcook›_£ek_funùiÚ_t
;

361 
__io_şo£_â
 
	tcook›_şo£_funùiÚ_t
;

366 
__io_»ad_â
 *
	m»ad
;

367 
__io_wr™e_â
 *
	mwr™e
;

368 
__io_£ek_â
 *
	m£ek
;

369 
__io_şo£_â
 *
	mşo£
;

370 } 
	t_IO_cook›_io_funùiÚs_t
;

371 
_IO_cook›_io_funùiÚs_t
 
	tcook›_io_funùiÚs_t
;

373 
	g_IO_cook›_fe
;

376 
_IO_cook›_š™
 (
_IO_cook›_fe
 *
__cfe
, 
__»ad_wr™e
,

377 *
__cook›
, 
_IO_cook›_io_funùiÚs_t
 
__âs
);

381 #ifdeà
__ılu¥lus


385 
__und”æow
 (
_IO_FILE
 *);

386 
__uæow
 (
_IO_FILE
 *);

387 
__ov”æow
 (
_IO_FILE
 *, );

388 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


389 
_IO_wšt_t
 
__wund”æow
 (
_IO_FILE
 *);

390 
_IO_wšt_t
 
__wuæow
 (
_IO_FILE
 *);

391 
_IO_wšt_t
 
__wov”æow
 (
_IO_FILE
 *, _IO_wint_t);

394 #ià 
__GNUC__
 >= 3

395 
	#_IO_BE
(
ex´
, 
»s
è
	`__butš_ex³ù
 (Óx´),„es)

	)

397 
	#_IO_BE
(
ex´
, 
»s
èÓx´)

	)

400 
	#_IO_g‘c_uÆocked
(
_å
) \

401 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

402 ? 
	`__uæow
 (
_å
è: *(*è(_å)->
_IO_»ad_±r
++)

	)

403 
	#_IO_³ekc_uÆocked
(
_å
) \

404 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

405 && 
	`__und”æow
 (
_å
è=ğ
EOF
 ? EOF \

406 : *(*è(
_å
)->
_IO_»ad_±r
)

	)

407 
	#_IO_putc_uÆocked
(
_ch
, 
_å
) \

408 (
	`_IO_BE
 ((
_å
)->
_IO_wr™e_±r
 >ğ(_å)->
_IO_wr™e_’d
, 0) \

409 ? 
	`__ov”æow
 (
_å
, (è(
_ch
)) \

410 : (è(*(
_å
)->
_IO_wr™e_±r
++ = (
_ch
)))

	)

412 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


413 
	#_IO_g‘wc_uÆocked
(
_å
) \

414 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

415 || ((
_å
)->
_wide_d©a
->
_IO_»ad_±r
 \

416 >ğ(
_å
)->
_wide_d©a
->
_IO_»ad_’d
), 0) \

417 ? 
	`__wuæow
 (
_å
è: (
_IO_wšt_t
è*(_å)->
_wide_d©a
->
_IO_»ad_±r
++)

	)

418 
	#_IO_putwc_uÆocked
(
_wch
, 
_å
) \

419 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

420 || ((
_å
)->
_wide_d©a
->
_IO_wr™e_±r
 \

421 >ğ(
_å
)->
_wide_d©a
->
_IO_wr™e_’d
), 0) \

422 ? 
	`__wov”æow
 (
_å
, 
_wch
) \

423 : (
_IO_wšt_t
è(*(
_å
)->
_wide_d©a
->
_IO_wr™e_±r
++ = (
_wch
)))

	)

426 
	#_IO_ãof_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_EOF_SEEN
è!ğ0)

	)

427 
	#_IO_ã¼Ü_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_ERR_SEEN
è!ğ0)

	)

429 
_IO_g‘c
 (
_IO_FILE
 *
__å
);

430 
_IO_putc
 (
__c
, 
_IO_FILE
 *
__å
);

431 
_IO_ãof
 (
_IO_FILE
 *
__å
è
__THROW
;

432 
_IO_ã¼Ü
 (
_IO_FILE
 *
__å
è
__THROW
;

434 
_IO_³ekc_locked
 (
_IO_FILE
 *
__å
);

437 
	#_IO_PENDING_OUTPUT_COUNT
(
_å
) \

438 ((
_å
)->
_IO_wr™e_±r
 - (_å)->
_IO_wr™e_ba£
)

	)

440 
_IO_æockfe
 (
_IO_FILE
 *è
__THROW
;

441 
_IO_fuÆockfe
 (
_IO_FILE
 *è
__THROW
;

442 
_IO_árylockfe
 (
_IO_FILE
 *è
__THROW
;

444 #ifdeà
_IO_MTSAFE_IO


445 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_locked
 (_å)

	)

446 
	#_IO_æockfe
(
_å
) \

447 ià(((
_å
)->
_æags
 & 
_IO_USER_LOCK
è=ğ0è
	`_IO_æockfe
 (_å)

	)

448 
	#_IO_fuÆockfe
(
_å
) \

449 ià(((
_å
)->
_æags
 & 
_IO_USER_LOCK
è=ğ0è
	`_IO_fuÆockfe
 (_å)

	)

451 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_uÆocked
 (_å)

	)

452 
	#_IO_æockfe
(
_å
è

	)

453 
	#_IO_fuÆockfe
(
_å
è

	)

454 
	#_IO_árylockfe
(
_å
è

	)

455 
	#_IO_ş—nup_»giÚ_¡¬t
(
_fù
, 
_å
è

	)

456 
	#_IO_ş—nup_»giÚ_’d
(
_Do™
è

	)

459 
_IO_vfsÿnf
 (
_IO_FILE
 * 
__»¡riù
, const * __restrict,

460 
_IO_va_li¡
, *
__»¡riù
);

461 
_IO_vårštf
 (
_IO_FILE
 *
__»¡riù
, const *__restrict,

462 
_IO_va_li¡
);

463 
_IO_ssize_t
 
_IO_·dn
 (
_IO_FILE
 *, , _IO_ssize_t);

464 
_IO_size_t
 
_IO_sg‘n
 (
_IO_FILE
 *, *, _IO_size_t);

466 
_IO_off64_t
 
_IO_£ekoff
 (
_IO_FILE
 *, _IO_off64_t, , );

467 
_IO_off64_t
 
_IO_£ekpos
 (
_IO_FILE
 *, _IO_off64_t, );

469 
_IO_ä“_backup_¬—
 (
_IO_FILE
 *è
__THROW
;

471 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


472 
_IO_wšt_t
 
_IO_g‘wc
 (
_IO_FILE
 *
__å
);

473 
_IO_wšt_t
 
_IO_putwc
 (
wch¬_t
 
__wc
, 
_IO_FILE
 *
__å
);

474 
_IO_fwide
 (
_IO_FILE
 *
__å
, 
__mode
è
__THROW
;

475 #ià
__GNUC__
 >= 2

478 #ià
defšed
 
_LIBC
 && defšed 
SHARED


479 
	~<shlib-com·t.h
>

480 #ià
SHLIB_COMPAT
 (
libc
, 
GLIBC_2_0
, 
GLIBC_2_1
)

481 
	#_IO_fwide_maybe_šcom·tibË
 \

482 (
	`__butš_ex³ù
 (&
_IO_¡dš_u£d
 =ğ
NULL
, 0))

	)

483 cÚ¡ 
_IO_¡dš_u£d
;

484 
w—k_ex‹º
 (
_IO_¡dš_u£d
);

487 #iâdeà
_IO_fwide_maybe_šcom·tibË


488 
	#_IO_fwide_maybe_šcom·tibË
 (0)

	)

492 
	#_IO_fwide
(
__å
, 
__mode
) \

493 ({ 
__»suÉ
 = (
__mode
); \

494 ià(
__»suÉ
 < 0 && ! 
_IO_fwide_maybe_šcom·tibË
) \

496 ià((
__å
)->
_mode
 == 0) \

498 (
__å
)->
_mode
 = -1; \

499 
__»suÉ
 = (
__å
)->
_mode
; \

501 ià(
	`__butš_cÚ¡ªt_p
 (
__mode
) && (__mode) == 0) \

502 
__»suÉ
 = 
_IO_fwide_maybe_šcom·tibË
 ? -1 : (
__å
)->
_mode
; \

504 
__»suÉ
 = 
	`_IO_fwide
 (
__å
, __result); \

505 
__»suÉ
; })

	)

508 
_IO_vfwsÿnf
 (
_IO_FILE
 * 
__»¡riù
, cÚ¡ 
wch¬_t
 * __restrict,

509 
_IO_va_li¡
, *
__»¡riù
);

510 
_IO_vfw´štf
 (
_IO_FILE
 *
__»¡riù
, cÚ¡ 
wch¬_t
 *__restrict,

511 
_IO_va_li¡
);

512 
_IO_ssize_t
 
_IO_w·dn
 (
_IO_FILE
 *, 
wšt_t
, _IO_ssize_t);

513 
_IO_ä“_wbackup_¬—
 (
_IO_FILE
 *è
__THROW
;

516 #ifdeà
__LDBL_COMPAT


517 
	~<b™s/libio-ldbl.h
>

520 #ifdeà
__ılu¥lus


	@/usr/include/time.h

22 #iâdef 
_TIME_H


24 #ià(! 
defšed
 
__Ãed_time_t
 && !defšed 
__Ãed_şock_t
 && \

25 ! 
defšed
 
	g__Ãed_time¥ec
)

26 
	#_TIME_H
 1

	)

27 
	~<ã©u»s.h
>

29 
	g__BEGIN_DECLS


33 #ifdef 
_TIME_H


35 
	#__Ãed_size_t


	)

36 
	#__Ãed_NULL


	)

37 
	~<¡ddef.h
>

41 
	~<b™s/time.h
>

44 #ià!
defšed
 
__STRICT_ANSI__
 && !defšed 
__USE_XOPEN2K


45 #iâdeà
CLK_TCK


46 
	#CLK_TCK
 
CLOCKS_PER_SEC


	)

52 #ià!
defšed
 
__şock_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_şock_t
)

53 
	#__şock_t_defšed
 1

	)

55 
	~<b™s/ty³s.h
>

57 
__BEGIN_NAMESPACE_STD


59 
__şock_t
 
	tşock_t
;

60 
	g__END_NAMESPACE_STD


61 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX


62 
	$__USING_NAMESPACE_STD
(
şock_t
)

66 #undeà
__Ãed_şock_t


68 #ià!
defšed
 
__time_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_time_t
)

69 
	#__time_t_defšed
 1

	)

71 
	~<b™s/ty³s.h
>

73 
__BEGIN_NAMESPACE_STD


75 
__time_t
 
	ttime_t
;

76 
__END_NAMESPACE_STD


77 #ifdeà
__USE_POSIX


78 
	$__USING_NAMESPACE_STD
(
time_t
)

82 #undeà
__Ãed_time_t


84 #ià!
defšed
 
__şockid_t_defšed
 && \

85 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_şockid_t
)

86 
	#__şockid_t_defšed
 1

	)

88 
	~<b™s/ty³s.h
>

91 
__şockid_t
 
	tşockid_t
;

94 #undeà
__şockid_time_t


96 #ià!
defšed
 
__tim”_t_defšed
 && \

97 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_tim”_t
)

98 
	#__tim”_t_defšed
 1

	)

100 
	~<b™s/ty³s.h
>

103 
__tim”_t
 
	ttim”_t
;

106 #undeà
__Ãed_tim”_t


109 #ià(!
defšed
 
__time¥ec_defšed
 \

110 && ((
defšed
 
_TIME_H
 \

111 && (
defšed
 
__USE_POSIX199309
 \

112 || 
defšed
 
__USE_ISOC11
)) \

113 || 
defšed
 
__Ãed_time¥ec
))

114 
	#__time¥ec_defšed
 1

	)

116 
	~<b™s/ty³s.h
>

120 
	stime¥ec


122 
__time_t
 
tv_£c
;

123 
__sysÿÎ_¦Úg_t
 
tv_n£c
;

127 #undeà
__Ãed_time¥ec


130 #ifdef 
_TIME_H


131 
__BEGIN_NAMESPACE_STD


133 
	stm


135 
tm_£c
;

136 
tm_mš
;

137 
tm_hour
;

138 
tm_mday
;

139 
tm_mÚ
;

140 
tm_y—r
;

141 
tm_wday
;

142 
tm_yday
;

143 
tm_isd¡
;

145 #ifdef 
__USE_MISC


146 
tm_gmtoff
;

147 cÚ¡ *
tm_zÚe
;

149 
__tm_gmtoff
;

150 cÚ¡ *
__tm_zÚe
;

153 
__END_NAMESPACE_STD


154 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX


155 
	$__USING_NAMESPACE_STD
(
tm
)

159 #ifdeà
__USE_POSIX199309


161 
	s™im”¥ec


163 
time¥ec
 
™_š‹rv®
;

164 
time¥ec
 
™_v®ue
;

168 
sigev’t
;

172 #ifdeà
__USE_XOPEN2K


173 #iâdeà
__pid_t_defšed


174 
__pid_t
 
	tpid_t
;

175 
	#__pid_t_defšed


	)

180 #ifdeà
__USE_ISOC11


182 
	#TIME_UTC
 1

	)

186 
__BEGIN_NAMESPACE_STD


189 
şock_t
 
	$şock
 (è
__THROW
;

192 
time_t
 
	$time
 (
time_t
 *
__tim”
è
__THROW
;

195 
	$difáime
 (
time_t
 
__time1
,ime_ˆ
__time0
)

196 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

199 
time_t
 
	$mktime
 (
tm
 *
__
è
__THROW
;

205 
size_t
 
	$¡ráime
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

206 cÚ¡ *
__»¡riù
 
__fÜm©
,

207 cÚ¡ 
tm
 *
__»¡riù
 
__
è
__THROW
;

208 
__END_NAMESPACE_STD


210 #ifdeà
__USE_XOPEN


213 *
	$¡½time
 (cÚ¡ *
__»¡riù
 
__s
,

214 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
)

215 
__THROW
;

218 #ifdeà
__USE_XOPEN2K8


221 
	~<xloÿË.h
>

223 
size_t
 
	$¡ráime_l
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

224 cÚ¡ *
__»¡riù
 
__fÜm©
,

225 cÚ¡ 
tm
 *
__»¡riù
 
__
,

226 
__loÿË_t
 
__loc
è
__THROW
;

229 #ifdeà
__USE_GNU


230 *
	$¡½time_l
 (cÚ¡ *
__»¡riù
 
__s
,

231 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
,

232 
__loÿË_t
 
__loc
è
__THROW
;

236 
__BEGIN_NAMESPACE_STD


239 
tm
 *
	$gmtime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

243 
tm
 *
	$loÿÉime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

244 
__END_NAMESPACE_STD


246 #ifdeà
__USE_POSIX


249 
tm
 *
	$gmtime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

250 
tm
 *
__»¡riù
 
__
è
__THROW
;

254 
tm
 *
	$loÿÉime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

255 
tm
 *
__»¡riù
 
__
è
__THROW
;

258 
__BEGIN_NAMESPACE_STD


261 *
	$asùime
 (cÚ¡ 
tm
 *
__
è
__THROW
;

264 *
	$ùime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

265 
__END_NAMESPACE_STD


267 #ifdeà
__USE_POSIX


272 *
	$asùime_r
 (cÚ¡ 
tm
 *
__»¡riù
 
__
,

273 *
__»¡riù
 
__buf
è
__THROW
;

276 *
	$ùime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

277 *
__»¡riù
 
__buf
è
__THROW
;

282 *
__tzÇme
[2];

283 
__daylight
;

284 
__timezÚe
;

287 #ifdef 
__USE_POSIX


289 *
tzÇme
[2];

293 
	$tz£t
 (è
__THROW
;

296 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


297 
daylight
;

298 
timezÚe
;

301 #ifdeà
__USE_MISC


304 
	$¡ime
 (cÚ¡ 
time_t
 *
__wh’
è
__THROW
;

310 
	#__i¦—p
(
y—r
) \

311 ((
y—r
è% 4 =ğ0 && ((y—rè% 100 !ğ0 || (y—rè% 400 =ğ0))

	)

314 #ifdeà
__USE_MISC


319 
time_t
 
	$timegm
 (
tm
 *
__
è
__THROW
;

322 
time_t
 
	$tim–oÿl
 (
tm
 *
__
è
__THROW
;

325 
	$dysize
 (
__y—r
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

329 #ifdeà
__USE_POSIX199309


334 
	`Çno¦“p
 (cÚ¡ 
time¥ec
 *
__»que¡ed_time
,

335 
time¥ec
 *
__»maššg
);

339 
	$şock_g‘»s
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__»s
è
__THROW
;

342 
	$şock_g‘time
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__
è
__THROW
;

345 
	$şock_£‰ime
 (
şockid_t
 
__şock_id
, cÚ¡ 
time¥ec
 *
__
)

346 
__THROW
;

348 #ifdeà
__USE_XOPEN2K


353 
	`şock_Çno¦“p
 (
şockid_t
 
__şock_id
, 
__æags
,

354 cÚ¡ 
time¥ec
 *
__»q
,

355 
time¥ec
 *
__»m
);

358 
	$şock_g‘ıuşockid
 (
pid_t
 
__pid
, 
şockid_t
 *
__şock_id
è
__THROW
;

363 
	$tim”_ü—‹
 (
şockid_t
 
__şock_id
,

364 
sigev’t
 *
__»¡riù
 
__evp
,

365 
tim”_t
 *
__»¡riù
 
__tim”id
è
__THROW
;

368 
	$tim”_d–‘e
 (
tim”_t
 
__tim”id
è
__THROW
;

371 
	$tim”_£‰ime
 (
tim”_t
 
__tim”id
, 
__æags
,

372 cÚ¡ 
™im”¥ec
 *
__»¡riù
 
__v®ue
,

373 
™im”¥ec
 *
__»¡riù
 
__ov®ue
è
__THROW
;

376 
	$tim”_g‘time
 (
tim”_t
 
__tim”id
, 
™im”¥ec
 *
__v®ue
)

377 
__THROW
;

380 
	$tim”_g‘ov”run
 (
tim”_t
 
__tim”id
è
__THROW
;

384 #ifdeà
__USE_ISOC11


386 
	$time¥ec_g‘
 (
time¥ec
 *
__ts
, 
__ba£
)

387 
__THROW
 
	`__nÚnuÎ
 ((1));

391 #ifdeà
__USE_XOPEN_EXTENDED


403 
g‘d©e_”r
;

412 
tm
 *
	`g‘d©e
 (cÚ¡ *
__¡ršg
);

415 #ifdeà
__USE_GNU


426 
	`g‘d©e_r
 (cÚ¡ *
__»¡riù
 
__¡ršg
,

427 
tm
 *
__»¡riù
 
__»sbuå
);

430 
__END_DECLS


	@/usr/include/xlocale.h

20 #iâdeà
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loÿË_¡ruù


30 
__loÿË_d©a
 *
	m__loÿËs
[13];

33 cÚ¡ *
	m__ùy³_b
;

34 cÚ¡ *
	m__ùy³_tŞow”
;

35 cÚ¡ *
	m__ùy³_touµ”
;

38 cÚ¡ *
	m__Çmes
[13];

39 } *
	t__loÿË_t
;

42 
__loÿË_t
 
	tloÿË_t
;

	@/usr/include/_G_config.h

4 #iâdeà
_G_cÚfig_h


5 
	#_G_cÚfig_h
 1

	)

9 
	~<b™s/ty³s.h
>

10 
	#__Ãed_size_t


	)

11 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


12 
	#__Ãed_wch¬_t


	)

14 
	#__Ãed_NULL


	)

15 
	~<¡ddef.h
>

16 
	#__Ãed_mb¡©e_t


	)

17 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


18 
	#__Ãed_wšt_t


	)

20 
	~<wch¬.h
>

23 
__off_t
 
	m__pos
;

24 
__mb¡©e_t
 
	m__¡©e
;

25 } 
	t_G_åos_t
;

28 
__off64_t
 
	m__pos
;

29 
__mb¡©e_t
 
	m__¡©e
;

30 } 
	t_G_åos64_t
;

31 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


32 
	~<gcÚv.h
>

35 
__gcÚv_šfo
 
	m__cd
;

38 
__gcÚv_šfo
 
	m__cd
;

39 
__gcÚv_¡•_d©a
 
	m__d©a
;

40 } 
	m__combšed
;

41 } 
	t_G_icÚv_t
;

46 
	#_G_va_li¡
 
__gnuc_va_li¡


	)

48 
	#_G_HAVE_MMAP
 1

	)

49 
	#_G_HAVE_MREMAP
 1

	)

51 
	#_G_IO_IO_FILE_VERSION
 0x20001

	)

54 
	#_G_HAVE_ST_BLKSIZE
 
	`defšed
 (
_STATBUF_ST_BLKSIZE
)

	)

56 
	#_G_BUFSIZ
 8192

	)

	@/usr/include/ctype.h

22 #iâdef 
_CTYPE_H


23 
	#_CTYPE_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	~<b™s/ty³s.h
>

28 
	g__BEGIN_DECLS


30 #iâdeà
_ISb™


39 
	~<’dŸn.h
>

40 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


41 
	#_ISb™
(
b™
è(1 << (b™))

	)

43 
	#_ISb™
(
b™
è((b™è< 8 ? ((1 << (b™)è<< 8è: ((1 << (b™)è>> 8))

	)

48 
	m_ISuµ”
 = 
_ISb™
 (0),

49 
	m_ISlow”
 = 
_ISb™
 (1),

50 
	m_IS®pha
 = 
_ISb™
 (2),

51 
	m_ISdig™
 = 
_ISb™
 (3),

52 
	m_ISxdig™
 = 
_ISb™
 (4),

53 
	m_IS¥aû
 = 
_ISb™
 (5),

54 
	m_IS´št
 = 
_ISb™
 (6),

55 
	m_ISg¿ph
 = 
_ISb™
 (7),

56 
	m_ISbÏnk
 = 
_ISb™
 (8),

57 
	m_ISúŒl
 = 
_ISb™
 (9),

58 
	m_ISpunù
 = 
_ISb™
 (10),

59 
	m_IS®num
 = 
_ISb™
 (11)

79 cÚ¡ **
	$__ùy³_b_loc
 ()

80 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

81 cÚ¡ 
__št32_t
 **
	$__ùy³_tŞow”_loc
 ()

82 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

83 cÚ¡ 
__št32_t
 **
	$__ùy³_touµ”_loc
 ()

84 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

87 #iâdeà
__ılu¥lus


88 
	#__isùy³
(
c
, 
ty³
) \

89 ((*
	`__ùy³_b_loc
 ())[(è(
c
)] & (è
ty³
)

	)

90 #–ià
defšed
 
__USE_EXTERN_INLINES


91 
	#__isùy³_f
(
ty³
) \

92 
__ex‹º_šlše
 \

93 
is
##
	`ty³
 (
__c
è
__THROW
 \

95  (*
	`__ùy³_b_loc
 ())[(è(
__c
)] & (è
_IS
##
ty³
; \

96 
	}

	)
}

99 
	#__i§scii
(
c
è(((cè& ~0x7fè=ğ0è

	)

100 
	#__tßscii
(
c
è((cè& 0x7fè

	)

102 
	#__exùy³
(
Çme
è
	`Çme
 (è
__THROW


	)

104 
__BEGIN_NAMESPACE_STD


110 
__exùy³
 (
i§Êum
);

111 
__exùy³
 (
i§Íha
);

112 
__exùy³
 (
isúŒl
);

113 
__exùy³
 (
isdig™
);

114 
__exùy³
 (
i¦ow”
);

115 
__exùy³
 (
isg¿ph
);

116 
__exùy³
 (
i¥ršt
);

117 
__exùy³
 (
i¥unù
);

118 
__exùy³
 (
is¥aû
);

119 
__exùy³
 (
isuµ”
);

120 
__exùy³
 (
isxdig™
);

124 
	$tŞow”
 (
__c
è
__THROW
;

127 
	$touµ”
 (
__c
è
__THROW
;

129 
__END_NAMESPACE_STD


133 #ifdef 
__USE_ISOC99


134 
__BEGIN_NAMESPACE_C99


136 
	`__exùy³
 (
isbÏnk
);

138 
__END_NAMESPACE_C99


141 #ifdeà
__USE_GNU


143 
	$isùy³
 (
__c
, 
__mask
è
__THROW
;

146 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


150 
	$i§scii
 (
__c
è
__THROW
;

154 
	$tßscii
 (
__c
è
__THROW
;

158 
	`__exùy³
 (
_touµ”
);

159 
	`__exùy³
 (
_tŞow”
);

163 
	#__tobody
(
c
, 
f
, 
a
, 
¬gs
) \

164 (
__ex‹nsiÚ__
 \

165 ({ 
__»s
; \

166 ià( (
c
) > 1) \

168 ià(
	`__butš_cÚ¡ªt_p
 (
c
)) \

170 
__c
 = (
c
); \

171 
__»s
 = 
__c
 < -128 || __ø> 255 ? __ø: (
a
)[__c]; \

174 
__»s
 = 
f
 
¬gs
; \

177 
__»s
 = (
a
)[(è(
c
)]; \

178 
__»s
; 
	}
}))

	)

180 #ià!
defšed
 
__NO_CTYPE


181 #ifdeà
__isùy³_f


182 
	$__isùy³_f
 (
®num
)

183 
	$__isùy³_f
 (
®pha
)

184 
	$__isùy³_f
 (
úŒl
)

185 
	$__isùy³_f
 (
dig™
)

186 
	$__isùy³_f
 (
low”
)

187 
	$__isùy³_f
 (
g¿ph
)

188 
	$__isùy³_f
 (
´št
)

189 
	$__isùy³_f
 (
punù
)

190 
	$__isùy³_f
 (
¥aû
)

191 
	$__isùy³_f
 (
uµ”
)

192 
	$__isùy³_f
 (
xdig™
)

193 #ifdeà
__USE_ISOC99


194 
	$__isùy³_f
 (
bÏnk
)

196 #–ià
defšed
 
__isùy³


197 
	#i§Êum
(
c
è
	`__isùy³
((c), 
_IS®num
)

	)

198 
	#i§Íha
(
c
è
	`__isùy³
((c), 
_IS®pha
)

	)

199 
	#isúŒl
(
c
è
	`__isùy³
((c), 
_ISúŒl
)

	)

200 
	#isdig™
(
c
è
	`__isùy³
((c), 
_ISdig™
)

	)

201 
	#i¦ow”
(
c
è
	`__isùy³
((c), 
_ISlow”
)

	)

202 
	#isg¿ph
(
c
è
	`__isùy³
((c), 
_ISg¿ph
)

	)

203 
	#i¥ršt
(
c
è
	`__isùy³
((c), 
_IS´št
)

	)

204 
	#i¥unù
(
c
è
	`__isùy³
((c), 
_ISpunù
)

	)

205 
	#is¥aû
(
c
è
	`__isùy³
((c), 
_IS¥aû
)

	)

206 
	#isuµ”
(
c
è
	`__isùy³
((c), 
_ISuµ”
)

	)

207 
	#isxdig™
(
c
è
	`__isùy³
((c), 
_ISxdig™
)

	)

208 #ifdeà
__USE_ISOC99


209 
	#isbÏnk
(
c
è
	`__isùy³
((c), 
_ISbÏnk
)

	)

213 #ifdeà
__USE_EXTERN_INLINES


214 
__ex‹º_šlše
 

215 
	`__NTH
 (
	$tŞow”
 (
__c
))

217  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_tŞow”_loc
 ())[__c] : __c;

218 
	}
}

220 
__ex‹º_šlše
 

221 
__NTH
 (
	$touµ”
 (
__c
))

223  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_touµ”_loc
 ())[__c] : __c;

224 
	}
}

227 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


228 
	#tŞow”
(
c
è
	`__tobody
 (c, 
tŞow”
, *
	`__ùy³_tŞow”_loc
 (), (c))

	)

229 
	#touµ”
(
c
è
	`__tobody
 (c, 
touµ”
, *
	`__ùy³_touµ”_loc
 (), (c))

	)

232 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


233 
	#i§scii
(
c
è
	`__i§scii
 (c)

	)

234 
	#tßscii
(
c
è
	`__tßscii
 (c)

	)

236 
	#_tŞow”
(
c
è((è(*
	`__ùy³_tŞow”_loc
 ())[(è(c)])

	)

237 
	#_touµ”
(
c
è((è(*
	`__ùy³_touµ”_loc
 ())[(è(c)])

	)

243 #ifdeà
__USE_XOPEN2K8


257 
	~<xloÿË.h
>

261 
	#__isùy³_l
(
c
, 
ty³
, 
loÿË
) \

262 ((
loÿË
)->
__ùy³_b
[(è(
c
)] & (è
ty³
)

	)

264 
	#__exùy³_l
(
Çme
) \

265 
	`Çme
 (, 
__loÿË_t
è
__THROW


	)

271 
__exùy³_l
 (
i§Êum_l
);

272 
__exùy³_l
 (
i§Íha_l
);

273 
__exùy³_l
 (
isúŒl_l
);

274 
__exùy³_l
 (
isdig™_l
);

275 
__exùy³_l
 (
i¦ow”_l
);

276 
__exùy³_l
 (
isg¿ph_l
);

277 
__exùy³_l
 (
i¥ršt_l
);

278 
__exùy³_l
 (
i¥unù_l
);

279 
__exùy³_l
 (
is¥aû_l
);

280 
__exùy³_l
 (
isuµ”_l
);

281 
__exùy³_l
 (
isxdig™_l
);

283 
__exùy³_l
 (
isbÏnk_l
);

287 
	$__tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

288 
	$tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

291 
	$__touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

292 
	$touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

294 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


295 
	#__tŞow”_l
(
c
, 
loÿË
) \

296 
	`__tobody
 (
c
, 
__tŞow”_l
, (
loÿË
)->
__ùy³_tŞow”
, (c,†oÿË))

	)

297 
	#__touµ”_l
(
c
, 
loÿË
) \

298 
	`__tobody
 (
c
, 
__touµ”_l
, (
loÿË
)->
__ùy³_touµ”
, (c,†oÿË))

	)

299 
	#tŞow”_l
(
c
, 
loÿË
è
	`__tŞow”_l
 ((c), (loÿË))

	)

300 
	#touµ”_l
(
c
, 
loÿË
è
	`__touµ”_l
 ((c), (loÿË))

	)

304 #iâdeà
__NO_CTYPE


305 
	#__i§Êum_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®num
, (l))

	)

306 
	#__i§Íha_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®pha
, (l))

	)

307 
	#__isúŒl_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISúŒl
, (l))

	)

308 
	#__isdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISdig™
, (l))

	)

309 
	#__i¦ow”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISlow”
, (l))

	)

310 
	#__isg¿ph_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISg¿ph
, (l))

	)

311 
	#__i¥ršt_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS´št
, (l))

	)

312 
	#__i¥unù_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISpunù
, (l))

	)

313 
	#__is¥aû_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS¥aû
, (l))

	)

314 
	#__isuµ”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISuµ”
, (l))

	)

315 
	#__isxdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISxdig™
, (l))

	)

317 
	#__isbÏnk_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISbÏnk
, (l))

	)

319 #ifdeà
__USE_MISC


320 
	#__i§scii_l
(
c
,
l
è(Ö), 
	`__i§scii
 (c))

	)

321 
	#__tßscii_l
(
c
,
l
è(Ö), 
	`__tßscii
 (c))

	)

324 
	#i§Êum_l
(
c
,
l
è
	`__i§Êum_l
 ((c), (l))

	)

325 
	#i§Íha_l
(
c
,
l
è
	`__i§Íha_l
 ((c), (l))

	)

326 
	#isúŒl_l
(
c
,
l
è
	`__isúŒl_l
 ((c), (l))

	)

327 
	#isdig™_l
(
c
,
l
è
	`__isdig™_l
 ((c), (l))

	)

328 
	#i¦ow”_l
(
c
,
l
è
	`__i¦ow”_l
 ((c), (l))

	)

329 
	#isg¿ph_l
(
c
,
l
è
	`__isg¿ph_l
 ((c), (l))

	)

330 
	#i¥ršt_l
(
c
,
l
è
	`__i¥ršt_l
 ((c), (l))

	)

331 
	#i¥unù_l
(
c
,
l
è
	`__i¥unù_l
 ((c), (l))

	)

332 
	#is¥aû_l
(
c
,
l
è
	`__is¥aû_l
 ((c), (l))

	)

333 
	#isuµ”_l
(
c
,
l
è
	`__isuµ”_l
 ((c), (l))

	)

334 
	#isxdig™_l
(
c
,
l
è
	`__isxdig™_l
 ((c), (l))

	)

336 
	#isbÏnk_l
(
c
,
l
è
	`__isbÏnk_l
 ((c), (l))

	)

338 #ifdeà
__USE_MISC


339 
	#i§scii_l
(
c
,
l
è
	`__i§scii_l
 ((c), (l))

	)

340 
	#tßscii_l
(
c
,
l
è
	`__tßscii_l
 ((c), (l))

	)

347 
__END_DECLS


	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifdeà
__GCC_IEC_559_COMPLEX


45 #ià
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

55 
	#__STDC_ISO_10646__
 201505L

	)

58 
	#__STDC_NO_THREADS__
 1

	)

	@/usr/include/endian.h

18 #iâdef 
_ENDIAN_H


19 
	#_ENDIAN_H
 1

	)

21 
	~<ã©u»s.h
>

31 
	#__LITTLE_ENDIAN
 1234

	)

32 
	#__BIG_ENDIAN
 4321

	)

33 
	#__PDP_ENDIAN
 3412

	)

36 
	~<b™s/’dŸn.h
>

40 #iâdeà
__FLOAT_WORD_ORDER


41 
	#__FLOAT_WORD_ORDER
 
__BYTE_ORDER


	)

44 #ifdef 
__USE_MISC


45 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

46 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

47 
	#PDP_ENDIAN
 
__PDP_ENDIAN


	)

48 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

51 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


52 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èLO, 
	)
HI

53 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


54 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èHI, 
	)
LO

58 #ià
defšed
 
__USE_MISC
 && !defšed 
__ASSEMBLER__


60 
	~<b™s/by‹sw­.h
>

62 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


63 
	#htobe16
(
x
è
	`__bsw­_16
 (x)

	)

64 
	#htŞe16
(
x
è(x)

	)

65 
	#be16toh
(
x
è
	`__bsw­_16
 (x)

	)

66 
	#Ë16toh
(
x
è(x)

	)

68 
	#htobe32
(
x
è
	`__bsw­_32
 (x)

	)

69 
	#htŞe32
(
x
è(x)

	)

70 
	#be32toh
(
x
è
	`__bsw­_32
 (x)

	)

71 
	#Ë32toh
(
x
è(x)

	)

73 
	#htobe64
(
x
è
	`__bsw­_64
 (x)

	)

74 
	#htŞe64
(
x
è(x)

	)

75 
	#be64toh
(
x
è
	`__bsw­_64
 (x)

	)

76 
	#Ë64toh
(
x
è(x)

	)

79 
	#htobe16
(
x
è(x)

	)

80 
	#htŞe16
(
x
è
	`__bsw­_16
 (x)

	)

81 
	#be16toh
(
x
è(x)

	)

82 
	#Ë16toh
(
x
è
	`__bsw­_16
 (x)

	)

84 
	#htobe32
(
x
è(x)

	)

85 
	#htŞe32
(
x
è
	`__bsw­_32
 (x)

	)

86 
	#be32toh
(
x
è(x)

	)

87 
	#Ë32toh
(
x
è
	`__bsw­_32
 (x)

	)

89 
	#htobe64
(
x
è(x)

	)

90 
	#htŞe64
(
x
è
	`__bsw­_64
 (x)

	)

91 
	#be64toh
(
x
è(x)

	)

92 
	#Ë64toh
(
x
è
	`__bsw­_64
 (x)

	)

	@/usr/include/gconv.h

22 #iâdeà
_GCONV_H


23 
	#_GCONV_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	#__Ãed_mb¡©e_t


	)

27 
	#__Ãed_wšt_t


	)

28 
	~<wch¬.h
>

29 
	#__Ãed_size_t


	)

30 
	#__Ãed_wch¬_t


	)

31 
	~<¡ddef.h
>

34 
	#__UNKNOWN_10646_CHAR
 ((
wch¬_t
è0xfffd)

	)

39 
	m__GCONV_OK
 = 0,

40 
	m__GCONV_NOCONV
,

41 
	m__GCONV_NODB
,

42 
	m__GCONV_NOMEM
,

44 
	m__GCONV_EMPTY_INPUT
,

45 
	m__GCONV_FULL_OUTPUT
,

46 
	m__GCONV_ILLEGAL_INPUT
,

47 
	m__GCONV_INCOMPLETE_INPUT
,

49 
	m__GCONV_ILLEGAL_DESCRIPTOR
,

50 
	m__GCONV_INTERNAL_ERROR


57 
	m__GCONV_IS_LAST
 = 0x0001,

58 
	m__GCONV_IGNORE_ERRORS
 = 0x0002,

59 
	m__GCONV_SWAP
 = 0x0004,

60 
	m__GCONV_TRANSLIT
 = 0x0008

65 
	g__gcÚv_¡•
;

66 
	g__gcÚv_¡•_d©a
;

67 
	g__gcÚv_lßded_objeù
;

71 (*
	t__gcÚv_fù
è(
	t__gcÚv_¡•
 *, 
	t__gcÚv_¡•_d©a
 *,

73 **, 
	tsize_t
 *, , );

76 
	$wšt_t
 (*
	t__gcÚv_btowc_fù
è(
	t__gcÚv_¡•
 *, );

79 (*
	t__gcÚv_š™_fù
è(
	t__gcÚv_¡•
 *);

80 (*
	t__gcÚv_’d_fù
è(
	t__gcÚv_¡•
 *);

84 
	s__gcÚv_¡•


86 
__gcÚv_lßded_objeù
 *
__shlib_hªdË
;

87 cÚ¡ *
__modÇme
;

89 
__couÁ”
;

91 *
__äom_Çme
;

92 *
__to_Çme
;

94 
__gcÚv_fù
 
__fù
;

95 
__gcÚv_btowc_fù
 
__btowc_fù
;

96 
__gcÚv_š™_fù
 
__š™_fù
;

97 
__gcÚv_’d_fù
 
__’d_fù
;

101 
__mš_Ãeded_äom
;

102 
__max_Ãeded_äom
;

103 
__mš_Ãeded_to
;

104 
__max_Ãeded_to
;

107 
__¡©eful
;

109 *
__d©a
;

114 
	s__gcÚv_¡•_d©a


116 *
__outbuf
;

117 *
__outbuãnd
;

121 
__æags
;

125 
__švoÿtiÚ_couÁ”
;

129 
__š‹º®_u£
;

131 
__mb¡©e_t
 *
__¡©•
;

132 
__mb¡©e_t
 
__¡©e
;

138 
	s__gcÚv_šfo


140 
size_t
 
__n¡•s
;

141 
__gcÚv_¡•
 *
__¡•s
;

142 
__ex‹nsiÚ__
 
__gcÚv_¡•_d©a
 
__d©a
 
__æex¬r
;

143 } *
	t__gcÚv_t
;

146 
	`__gcÚv_Œª¦™”©e
 (
__gcÚv_¡•
 *
¡•
,

147 
__gcÚv_¡•_d©a
 *
¡•_d©a
,

148 cÚ¡ *
šbuf¡¬t
,

149 cÚ¡ **
šbuå
,

150 cÚ¡ *
šbuãnd
,

151 **
outbuf¡¬t
,

152 
size_t
 *
œ»v”sibË
);

	@/usr/include/wchar.h

23 #iâdeà
_WCHAR_H


25 #ià!
defšed
 
__Ãed_mb¡©e_t
 && !defšed 
__Ãed_wšt_t


26 
	#_WCHAR_H
 1

	)

27 
	~<ã©u»s.h
>

30 #ifdeà
_WCHAR_H


32 
	#__Ãed___FILE


	)

33 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


34 
	#__Ãed_FILE


	)

36 
	~<¡dio.h
>

38 
	#__Ãed___va_li¡


	)

39 
	~<¡d¬g.h
>

41 
	~<b™s/wch¬.h
>

44 
	#__Ãed_size_t


	)

45 
	#__Ãed_wch¬_t


	)

46 
	#__Ãed_NULL


	)

48 #ià
defšed
 
_WCHAR_H
 || defšed 
__Ãed_wšt_t
 || !defšed 
__WINT_TYPE__


49 #undeà
__Ãed_wšt_t


50 
	#__Ãed_wšt_t


	)

51 
	~<¡ddef.h
>

55 #iâdeà
_WINT_T


60 
	#_WINT_T


	)

61 
	twšt_t
;

65 #ià
defšed
 
__ılu¥lus
 && defšed 
_GLIBCPP_USE_NAMESPACES
 \

66 && 
defšed
 
__WINT_TYPE__


67 
__BEGIN_NAMESPACE_STD


68 
__WINT_TYPE__
 
	twšt_t
;

69 
	g__END_NAMESPACE_STD


74 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

75 
	#__CORRECT_ISO_CPP_WCHAR_H_PROTO


	)

79 #ià(
defšed
 
_WCHAR_H
 || defšed 
__Ãed_mb¡©e_t
è&& !defšed 
____mb¡©e_t_defšed


80 
	#____mb¡©e_t_defšed
 1

	)

84 
	m__couÁ
;

87 #ifdeà
__WINT_TYPE__


88 
__WINT_TYPE__
 
	m__wch
;

90 
wšt_t
 
	m__wch
;

92 
	m__wchb
[4];

93 } 
	m__v®ue
;

94 } 
	t__mb¡©e_t
;

96 #undeà
__Ãed_mb¡©e_t


101 #ifdeà
_WCHAR_H


103 #iâdeà
__mb¡©e_t_defšed


104 
__BEGIN_NAMESPACE_C99


106 
__mb¡©e_t
 
	tmb¡©e_t
;

107 
	g__END_NAMESPACE_C99


108 
	#__mb¡©e_t_defšed
 1

	)

111 #ifdeà
__USE_GNU


112 
	$__USING_NAMESPACE_C99
(
mb¡©e_t
)

115 #iâdeà
WCHAR_MIN


117 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

118 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

121 #iâdeà
WEOF


122 
	#WEOF
 (0xffffffffu)

	)

127 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_UNIX98


128 
	~<wùy³.h
>

132 
__BEGIN_DECLS


134 
__BEGIN_NAMESPACE_STD


137 
tm
;

138 
__END_NAMESPACE_STD


142 
	$__USING_NAMESPACE_STD
(
tm
)

145 
__BEGIN_NAMESPACE_STD


147 
wch¬_t
 *
	$wcsıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

148 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
)

149 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

152 
wch¬_t
 *
	$wc¢ıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

153 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

154 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

157 
wch¬_t
 *
	$wcsÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

158 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
)

159 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

161 
wch¬_t
 *
	$wc¢ÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

162 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

163 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

166 
	$wcscmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
)

167 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

169 
	$wc¢cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

170 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

171 
__END_NAMESPACE_STD


173 #ifdeà
__USE_XOPEN2K8


175 
	$wcsÿ£cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
è
__THROW
;

178 
	$wc¢ÿ£cmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

179 
size_t
 
__n
è
__THROW
;

183 
	~<xloÿË.h
>

185 
	$wcsÿ£cmp_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

186 
__loÿË_t
 
__loc
è
__THROW
;

188 
	$wc¢ÿ£cmp_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

189 
size_t
 
__n
, 
__loÿË_t
 
__loc
è
__THROW
;

192 
__BEGIN_NAMESPACE_STD


195 
	$wcscŞl
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
è
__THROW
;

199 
size_t
 
	$wcsxäm
 (
wch¬_t
 *
__»¡riù
 
__s1
,

200 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
è
__THROW
;

201 
__END_NAMESPACE_STD


203 #ifdeà
__USE_XOPEN2K8


209 
	$wcscŞl_l
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

210 
__loÿË_t
 
__loc
è
__THROW
;

215 
size_t
 
	$wcsxäm_l
 (
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
,

216 
size_t
 
__n
, 
__loÿË_t
 
__loc
è
__THROW
;

219 
wch¬_t
 *
	$wcsdup
 (cÚ¡ 
wch¬_t
 *
__s
è
__THROW
 
__©Œibu‹_m®loc__
;

222 
__BEGIN_NAMESPACE_STD


224 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


225 "C++" 
wch¬_t
 *
	$wcschr
 (
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

226 
__THROW
 
	`__asm
 ("wcschr"è
__©Œibu‹_pu»__
;

227 "C++" cÚ¡ 
wch¬_t
 *
	$wcschr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

228 
__THROW
 
	`__asm
 ("wcschr"è
__©Œibu‹_pu»__
;

230 
wch¬_t
 *
	$wcschr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

231 
__THROW
 
__©Œibu‹_pu»__
;

234 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


235 "C++" 
wch¬_t
 *
	$wc¤chr
 (
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

236 
__THROW
 
	`__asm
 ("wc¤chr"è
__©Œibu‹_pu»__
;

237 "C++" cÚ¡ 
wch¬_t
 *
	$wc¤chr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

238 
__THROW
 
	`__asm
 ("wc¤chr"è
__©Œibu‹_pu»__
;

240 
wch¬_t
 *
	$wc¤chr
 (cÚ¡ 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

241 
__THROW
 
__©Œibu‹_pu»__
;

243 
__END_NAMESPACE_STD


245 #ifdeà
__USE_GNU


248 
wch¬_t
 *
	$wcschºul
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__wc
)

249 
__THROW
 
__©Œibu‹_pu»__
;

252 
__BEGIN_NAMESPACE_STD


255 
size_t
 
	$wcsc¥n
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__»jeù
)

256 
__THROW
 
__©Œibu‹_pu»__
;

259 
size_t
 
	$wcs¥n
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

260 
__THROW
 
__©Œibu‹_pu»__
;

262 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


263 "C++" 
wch¬_t
 *
	$wc¥brk
 (
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

264 
__THROW
 
	`__asm
 ("wc¥brk"è
__©Œibu‹_pu»__
;

265 "C++" cÚ¡ 
wch¬_t
 *
	$wc¥brk
 (cÚ¡ 
wch¬_t
 *
__wcs
,

266 cÚ¡ 
wch¬_t
 *
__acû±
)

267 
__THROW
 
	`__asm
 ("wc¥brk"è
__©Œibu‹_pu»__
;

269 
wch¬_t
 *
	$wc¥brk
 (cÚ¡ 
wch¬_t
 *
__wcs
, cÚ¡ wch¬_ˆ*
__acû±
)

270 
__THROW
 
__©Œibu‹_pu»__
;

273 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


274 "C++" 
wch¬_t
 *
	$wcs¡r
 (
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

275 
__THROW
 
	`__asm
 ("wcs¡r"è
__©Œibu‹_pu»__
;

276 "C++" cÚ¡ 
wch¬_t
 *
	$wcs¡r
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
,

277 cÚ¡ 
wch¬_t
 *
__ÃedË
)

278 
__THROW
 
	`__asm
 ("wcs¡r"è
__©Œibu‹_pu»__
;

280 
wch¬_t
 *
	$wcs¡r
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

281 
__THROW
 
__©Œibu‹_pu»__
;

285 
wch¬_t
 *
	$wc¡ok
 (
wch¬_t
 *
__»¡riù
 
__s
,

286 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__d–im
,

287 
wch¬_t
 **
__»¡riù
 
__±r
è
__THROW
;

290 
size_t
 
	$wc¦’
 (cÚ¡ 
wch¬_t
 *
__s
è
__THROW
 
__©Œibu‹_pu»__
;

291 
__END_NAMESPACE_STD


293 #ifdeà
__USE_XOPEN


295 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


296 "C++" 
wch¬_t
 *
	$wcswcs
 (
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

297 
__THROW
 
	`__asm
 ("wcswcs"è
__©Œibu‹_pu»__
;

298 "C++" cÚ¡ 
wch¬_t
 *
	$wcswcs
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
,

299 cÚ¡ 
wch¬_t
 *
__ÃedË
)

300 
__THROW
 
	`__asm
 ("wcswcs"è
__©Œibu‹_pu»__
;

302 
wch¬_t
 *
	$wcswcs
 (cÚ¡ 
wch¬_t
 *
__hay¡ack
, cÚ¡ wch¬_ˆ*
__ÃedË
)

303 
__THROW
 
__©Œibu‹_pu»__
;

307 #ifdeà
__USE_XOPEN2K8


309 
size_t
 
	$wc¢Ën
 (cÚ¡ 
wch¬_t
 *
__s
, 
size_t
 
__maxËn
)

310 
__THROW
 
__©Œibu‹_pu»__
;

314 
__BEGIN_NAMESPACE_STD


316 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


317 "C++" 
wch¬_t
 *
	$wmemchr
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
)

318 
__THROW
 
	`__asm
 ("wmemchr"è
__©Œibu‹_pu»__
;

319 "C++" cÚ¡ 
wch¬_t
 *
	$wmemchr
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__c
,

320 
size_t
 
__n
)

321 
__THROW
 
	`__asm
 ("wmemchr"è
__©Œibu‹_pu»__
;

323 
wch¬_t
 *
	$wmemchr
 (cÚ¡ 
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
)

324 
__THROW
 
__©Œibu‹_pu»__
;

328 
	$wmemcmp
 (cÚ¡ 
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

329 
__THROW
 
__©Œibu‹_pu»__
;

332 
wch¬_t
 *
	$wmemıy
 (
wch¬_t
 *
__»¡riù
 
__s1
,

333 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
è
__THROW
;

337 
wch¬_t
 *
	$wmemmove
 (
wch¬_t
 *
__s1
, cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

338 
__THROW
;

341 
wch¬_t
 *
	$wmem£t
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
è
__THROW
;

342 
__END_NAMESPACE_STD


344 #ifdeà
__USE_GNU


347 
wch¬_t
 *
	$wmempıy
 (
wch¬_t
 *
__»¡riù
 
__s1
,

348 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
)

349 
__THROW
;

353 
__BEGIN_NAMESPACE_STD


356 
wšt_t
 
	$btowc
 (
__c
è
__THROW
;

360 
	$wùob
 (
wšt_t
 
__c
è
__THROW
;

364 
	$mbsš™
 (cÚ¡ 
mb¡©e_t
 *
__ps
è
__THROW
 
__©Œibu‹_pu»__
;

368 
size_t
 
	$mb¹owc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

369 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

370 
mb¡©e_t
 *
__»¡riù
 
__p
è
__THROW
;

373 
size_t
 
	$wütomb
 (*
__»¡riù
 
__s
, 
wch¬_t
 
__wc
,

374 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

377 
size_t
 
	$__mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

378 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

379 
size_t
 
	$mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

380 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

381 
__END_NAMESPACE_STD


383 #ifdeà
__USE_EXTERN_INLINES


389 
wšt_t
 
	$__btowc_®Ÿs
 (
__c
è
	`__asm
 ("btowc");

390 
__ex‹º_šlše
 
wšt_t


391 
	`__NTH
 (
	$btowc
 (
__c
))

392 {  (
	`__butš_cÚ¡ªt_p
 (
__c
) && __c >= '\0' && __c <= '\x7f'

393 ? (
wšt_t
è
__c
 : 
	`__btowc_®Ÿs
 (__c)); 
	}
}

395 
	$__wùob_®Ÿs
 (
wšt_t
 
__c
è
	`__asm
 ("wctob");

396 
__ex‹º_šlše
 

397 
	`__NTH
 (
	$wùob
 (
wšt_t
 
__wc
))

398 {  (
	`__butš_cÚ¡ªt_p
 (
__wc
è&& __wø>ğ
L
'\0' && __wc <= L'\x7f'

399 ? (è
__wc
 : 
	`__wùob_®Ÿs
 (__wc)); 
	}
}

401 
__ex‹º_šlše
 
size_t


402 
__NTH
 (
	$mb¾’
 (cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
,

403 
mb¡©e_t
 *
__»¡riù
 
__ps
))

404 {  (
__ps
 !ğ
NULL


405 ? 
	`mb¹owc
 (
NULL
, 
__s
, 
__n
, 
__ps
è: 
	`__mb¾’
 (__s, __n, NULL)); 
	}
}

408 
__BEGIN_NAMESPACE_STD


411 
size_t
 
	$mb¤towcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

412 cÚ¡ **
__»¡riù
 
__¤c
, 
size_t
 
__Ën
,

413 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

417 
size_t
 
	$wc¤tombs
 (*
__»¡riù
 
__d¡
,

418 cÚ¡ 
wch¬_t
 **
__»¡riù
 
__¤c
, 
size_t
 
__Ën
,

419 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

420 
__END_NAMESPACE_STD


423 #ifdef 
__USE_XOPEN2K8


426 
size_t
 
	$mb¢¹owcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

427 cÚ¡ **
__»¡riù
 
__¤c
, 
size_t
 
__nmc
,

428 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

432 
size_t
 
	$wc¢¹ombs
 (*
__»¡riù
 
__d¡
,

433 cÚ¡ 
wch¬_t
 **
__»¡riù
 
__¤c
,

434 
size_t
 
__nwc
, size_ˆ
__Ën
,

435 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

440 #ifdeà
__USE_XOPEN


442 
	$wcwidth
 (
wch¬_t
 
__c
è
__THROW
;

446 
	$wcswidth
 (cÚ¡ 
wch¬_t
 *
__s
, 
size_t
 
__n
è
__THROW
;

450 
__BEGIN_NAMESPACE_STD


453 
	$wc¡od
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

454 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

455 
__END_NAMESPACE_STD


457 #ifdeà
__USE_ISOC99


458 
__BEGIN_NAMESPACE_C99


460 
	$wc¡of
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

461 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

462 
	$wc¡Şd
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

463 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

464 
__END_NAMESPACE_C99


468 
__BEGIN_NAMESPACE_STD


471 
	$wc¡Ş
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

472 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

476 
	$wc¡oul
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

477 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

478 
__THROW
;

479 
__END_NAMESPACE_STD


481 #ifdeà
__USE_ISOC99


482 
__BEGIN_NAMESPACE_C99


485 
__ex‹nsiÚ__


486 
	$wc¡Şl
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

487 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

488 
__THROW
;

492 
__ex‹nsiÚ__


493 
	$wc¡ouÎ
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

494 
wch¬_t
 **
__»¡riù
 
__’d±r
,

495 
__ba£
è
__THROW
;

496 
__END_NAMESPACE_C99


499 #ifdeà
__USE_GNU


502 
__ex‹nsiÚ__


503 
	$wc¡oq
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

504 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

505 
__THROW
;

509 
__ex‹nsiÚ__


510 
	$wc¡ouq
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

511 
wch¬_t
 **
__»¡riù
 
__’d±r
,

512 
__ba£
è
__THROW
;

515 #ifdeà
__USE_GNU


529 
	~<xloÿË.h
>

533 
	$wc¡Ş_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

534 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
,

535 
__loÿË_t
 
__loc
è
__THROW
;

537 
	$wc¡oul_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

538 
wch¬_t
 **
__»¡riù
 
__’d±r
,

539 
__ba£
, 
__loÿË_t
 
__loc
è
__THROW
;

541 
__ex‹nsiÚ__


542 
	$wc¡Şl_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

543 
wch¬_t
 **
__»¡riù
 
__’d±r
,

544 
__ba£
, 
__loÿË_t
 
__loc
è
__THROW
;

546 
__ex‹nsiÚ__


547 
	$wc¡ouÎ_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

548 
wch¬_t
 **
__»¡riù
 
__’d±r
,

549 
__ba£
, 
__loÿË_t
 
__loc
)

550 
__THROW
;

552 
	$wc¡od_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

553 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

554 
__THROW
;

556 
	$wc¡of_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

557 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

558 
__THROW
;

560 
	$wc¡Şd_l
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

561 
wch¬_t
 **
__»¡riù
 
__’d±r
,

562 
__loÿË_t
 
__loc
è
__THROW
;

566 #ifdeà
__USE_XOPEN2K8


569 
wch¬_t
 *
	$wııy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

570 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
è
__THROW
;

574 
wch¬_t
 *
	$wınıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

575 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

576 
__THROW
;

583 
__FILE
 *
	$İ’_wmem¡»am
 (
wch¬_t
 **
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
;

586 #ià
defšed
 
__USE_ISOC95
 || defšed 
__USE_UNIX98


587 
__BEGIN_NAMESPACE_STD


590 
	$fwide
 (
__FILE
 *
__å
, 
__mode
è
__THROW
;

597 
	`fw´štf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

598 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

604 
	`w´štf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

607 
	$sw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

608 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

609 
__THROW
 ;

615 
	`vfw´štf
 (
__FILE
 *
__»¡riù
 
__s
,

616 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

617 
__gnuc_va_li¡
 
__¬g
)

623 
	`vw´štf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

624 
__gnuc_va_li¡
 
__¬g
)

628 
	$vsw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

629 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

630 
__gnuc_va_li¡
 
__¬g
)

631 
__THROW
 ;

638 
	`fwsÿnf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

639 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

645 
	`wsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

648 
	$swsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

649 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

650 
__THROW
 ;

652 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

653 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

654 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

655 #ifdeà
__REDIRECT


659 
	`__REDIRECT
 (
fwsÿnf
, (
__FILE
 *
__»¡riù
 
__¡»am
,

660 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

661 
__isoc99_fwsÿnf
)

663 
	`__REDIRECT
 (
wsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

664 
__isoc99_wsÿnf
)

666 
	`__REDIRECT_NTH
 (
swsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

667 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

668 ...), 
__isoc99_swsÿnf
)

671 
	`__isoc99_fwsÿnf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

672 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

673 
	`__isoc99_wsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

674 
	$__isoc99_swsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

675 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

676 
__THROW
;

677 
	#fwsÿnf
 
__isoc99_fwsÿnf


	)

678 
	#wsÿnf
 
__isoc99_wsÿnf


	)

679 
	#swsÿnf
 
__isoc99_swsÿnf


	)

683 
__END_NAMESPACE_STD


686 #ifdeà
__USE_ISOC99


687 
__BEGIN_NAMESPACE_C99


692 
	`vfwsÿnf
 (
__FILE
 *
__»¡riù
 
__s
,

693 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

694 
__gnuc_va_li¡
 
__¬g
)

700 
	`vwsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

701 
__gnuc_va_li¡
 
__¬g
)

704 
	$vswsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

705 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

706 
__gnuc_va_li¡
 
__¬g
)

707 
__THROW
 ;

709 #ià!
defšed
 
__USE_GNU
 \

710 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

711 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

712 #ifdeà
__REDIRECT


713 
	`__REDIRECT
 (
vfwsÿnf
, (
__FILE
 *
__»¡riù
 
__s
,

714 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

715 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vfwsÿnf
)

717 
	`__REDIRECT
 (
vwsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

718 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vwsÿnf
)

720 
	`__REDIRECT_NTH
 (
vswsÿnf
, (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

721 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

722 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vswsÿnf
)

725 
	`__isoc99_vfwsÿnf
 (
__FILE
 *
__»¡riù
 
__s
,

726 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

727 
__gnuc_va_li¡
 
__¬g
);

728 
	`__isoc99_vwsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

729 
__gnuc_va_li¡
 
__¬g
);

730 
	$__isoc99_vswsÿnf
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__s
,

731 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

732 
__gnuc_va_li¡
 
__¬g
è
__THROW
;

733 
	#vfwsÿnf
 
__isoc99_vfwsÿnf


	)

734 
	#vwsÿnf
 
__isoc99_vwsÿnf


	)

735 
	#vswsÿnf
 
__isoc99_vswsÿnf


	)

739 
__END_NAMESPACE_C99


743 
__BEGIN_NAMESPACE_STD


748 
wšt_t
 
	`fg‘wc
 (
__FILE
 *
__¡»am
);

749 
wšt_t
 
	`g‘wc
 (
__FILE
 *
__¡»am
);

755 
wšt_t
 
	`g‘wch¬
 ();

762 
wšt_t
 
	`åutwc
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

763 
wšt_t
 
	`putwc
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

769 
wšt_t
 
	`putwch¬
 (
wch¬_t
 
__wc
);

777 
wch¬_t
 *
	`fg‘ws
 (wch¬_ˆ*
__»¡riù
 
__ws
, 
__n
,

778 
__FILE
 *
__»¡riù
 
__¡»am
);

784 
	`åutws
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ws
,

785 
__FILE
 *
__»¡riù
 
__¡»am
);

792 
wšt_t
 
	`ung‘wc
 (wšt_ˆ
__wc
, 
__FILE
 *
__¡»am
);

793 
__END_NAMESPACE_STD


796 #ifdeà
__USE_GNU


804 
wšt_t
 
	`g‘wc_uÆocked
 (
__FILE
 *
__¡»am
);

805 
wšt_t
 
	`g‘wch¬_uÆocked
 ();

813 
wšt_t
 
	`fg‘wc_uÆocked
 (
__FILE
 *
__¡»am
);

821 
wšt_t
 
	`åutwc_uÆocked
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

830 
wšt_t
 
	`putwc_uÆocked
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

831 
wšt_t
 
	`putwch¬_uÆocked
 (
wch¬_t
 
__wc
);

840 
wch¬_t
 *
	`fg‘ws_uÆocked
 (wch¬_ˆ*
__»¡riù
 
__ws
, 
__n
,

841 
__FILE
 *
__»¡riù
 
__¡»am
);

849 
	`åutws_uÆocked
 (cÚ¡ 
wch¬_t
 *
__»¡riù
 
__ws
,

850 
__FILE
 *
__»¡riù
 
__¡»am
);

854 
__BEGIN_NAMESPACE_C99


858 
size_t
 
	$wcsáime
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

859 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

860 cÚ¡ 
tm
 *
__»¡riù
 
__
è
__THROW
;

861 
__END_NAMESPACE_C99


863 #ifdeà
__USE_GNU


864 
	~<xloÿË.h
>

868 
size_t
 
	$wcsáime_l
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

869 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

870 cÚ¡ 
tm
 *
__»¡riù
 
__
,

871 
__loÿË_t
 
__loc
è
__THROW
;

880 #ià
defšed
 
__USE_UNIX98
 && !defšed 
__USE_GNU


881 
	#__Ãed_iswxxx


	)

882 
	~<wùy³.h
>

886 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


887 
	~<b™s/wch¬2.h
>

890 #ifdeà
__LDBL_COMPAT


891 
	~<b™s/wch¬-ldbl.h
>

894 
__END_DECLS


902 #undeà
__Ãed_mb¡©e_t


903 #undeà
__Ãed_wšt_t


	@/usr/include/wctype.h

23 #iâdeà
_WCTYPE_H


25 
	~<ã©u»s.h
>

26 
	~<b™s/ty³s.h
>

28 #iâdeà
__Ãed_iswxxx


29 
	#_WCTYPE_H
 1

	)

32 
	#__Ãed_wšt_t


	)

33 
	~<wch¬.h
>

37 #iâdeà
WEOF


38 
	#WEOF
 (0xffffffffu)

	)

41 #undeà
__Ãed_iswxxx


46 #iâdeà
__iswxxx_defšed


47 
	#__iswxxx_defšed
 1

	)

49 
__BEGIN_NAMESPACE_C99


52 
	twùy³_t
;

53 
	g__END_NAMESPACE_C99


55 #iâdeà
_ISwb™


60 
	~<’dŸn.h
>

61 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


62 
	#_ISwb™
(
b™
è(1 << (b™))

	)

64 
	#_ISwb™
(
b™
) \

65 ((
b™
) < 8 ? () ((1UL << (bit)) << 24) \

66 : ((
b™
) < 16 ? () ((1UL << (bit)) << 8) \

67 : ((
b™
) < 24 ? () ((1UL << (bit)) >> 8) \

68 : (è((1UL << (
b™
)è>> 24))))

	)

73 
	m__ISwuµ”
 = 0,

74 
	m__ISwlow”
 = 1,

75 
	m__ISw®pha
 = 2,

76 
	m__ISwdig™
 = 3,

77 
	m__ISwxdig™
 = 4,

78 
	m__ISw¥aû
 = 5,

79 
	m__ISw´št
 = 6,

80 
	m__ISwg¿ph
 = 7,

81 
	m__ISwbÏnk
 = 8,

82 
	m__ISwúŒl
 = 9,

83 
	m__ISwpunù
 = 10,

84 
	m__ISw®num
 = 11,

86 
	m_ISwuµ”
 = 
_ISwb™
 (
__ISwuµ”
),

87 
	m_ISwlow”
 = 
_ISwb™
 (
__ISwlow”
),

88 
	m_ISw®pha
 = 
_ISwb™
 (
__ISw®pha
),

89 
	m_ISwdig™
 = 
_ISwb™
 (
__ISwdig™
),

90 
	m_ISwxdig™
 = 
_ISwb™
 (
__ISwxdig™
),

91 
	m_ISw¥aû
 = 
_ISwb™
 (
__ISw¥aû
),

92 
	m_ISw´št
 = 
_ISwb™
 (
__ISw´št
),

93 
	m_ISwg¿ph
 = 
_ISwb™
 (
__ISwg¿ph
),

94 
	m_ISwbÏnk
 = 
_ISwb™
 (
__ISwbÏnk
),

95 
	m_ISwúŒl
 = 
_ISwb™
 (
__ISwúŒl
),

96 
	m_ISwpunù
 = 
_ISwb™
 (
__ISwpunù
),

97 
	m_ISw®num
 = 
_ISwb™
 (
__ISw®num
)

102 
__BEGIN_DECLS


104 
__BEGIN_NAMESPACE_C99


111 
	$isw®num
 (
wšt_t
 
__wc
è
__THROW
;

117 
	$isw®pha
 (
wšt_t
 
__wc
è
__THROW
;

120 
	$iswúŒl
 (
wšt_t
 
__wc
è
__THROW
;

124 
	$iswdig™
 (
wšt_t
 
__wc
è
__THROW
;

128 
	$iswg¿ph
 (
wšt_t
 
__wc
è
__THROW
;

133 
	$iswlow”
 (
wšt_t
 
__wc
è
__THROW
;

136 
	$isw´št
 (
wšt_t
 
__wc
è
__THROW
;

141 
	$iswpunù
 (
wšt_t
 
__wc
è
__THROW
;

146 
	$isw¥aû
 (
wšt_t
 
__wc
è
__THROW
;

151 
	$iswuµ”
 (
wšt_t
 
__wc
è
__THROW
;

156 
	$iswxdig™
 (
wšt_t
 
__wc
è
__THROW
;

161 #ifdeà
__USE_ISOC99


162 
	$iswbÏnk
 (
wšt_t
 
__wc
è
__THROW
;

171 
wùy³_t
 
	$wùy³
 (cÚ¡ *
__´İ”ty
è
__THROW
;

175 
	$iswùy³
 (
wšt_t
 
__wc
, 
wùy³_t
 
__desc
è
__THROW
;

176 
__END_NAMESPACE_C99


183 
__BEGIN_NAMESPACE_C99


186 cÚ¡ 
	t__št32_t
 *
	twù¿ns_t
;

187 
__END_NAMESPACE_C99


188 #ifdeà
__USE_GNU


189 
	$__USING_NAMESPACE_C99
(
wù¿ns_t
)

192 
__BEGIN_NAMESPACE_C99


194 
wšt_t
 
	$towlow”
 (
wšt_t
 
__wc
è
__THROW
;

197 
wšt_t
 
	$towuµ”
 (
wšt_t
 
__wc
è
__THROW
;

198 
__END_NAMESPACE_C99


200 
__END_DECLS


207 #ifdeà
_WCTYPE_H


213 
__BEGIN_DECLS


215 
__BEGIN_NAMESPACE_C99


218 
wù¿ns_t
 
	$wù¿ns
 (cÚ¡ *
__´İ”ty
è
__THROW
;

221 
wšt_t
 
	$towù¿ns
 (
wšt_t
 
__wc
, 
wù¿ns_t
 
__desc
è
__THROW
;

222 
__END_NAMESPACE_C99


224 #ifdeà
__USE_XOPEN2K8


226 
	~<xloÿË.h
>

230 
	$isw®num_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

236 
	$isw®pha_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

239 
	$iswúŒl_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

243 
	$iswdig™_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

247 
	$iswg¿ph_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

252 
	$iswlow”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

255 
	$isw´št_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

260 
	$iswpunù_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

265 
	$isw¥aû_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

270 
	$iswuµ”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

275 
	$iswxdig™_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

280 
	$iswbÏnk_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

284 
wùy³_t
 
	$wùy³_l
 (cÚ¡ *
__´İ”ty
, 
__loÿË_t
 
__loÿË
)

285 
__THROW
;

289 
	$iswùy³_l
 (
wšt_t
 
__wc
, 
wùy³_t
 
__desc
, 
__loÿË_t
 
__loÿË
)

290 
__THROW
;

298 
wšt_t
 
	$towlow”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

301 
wšt_t
 
	$towuµ”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

305 
wù¿ns_t
 
	$wù¿ns_l
 (cÚ¡ *
__´İ”ty
, 
__loÿË_t
 
__loÿË
)

306 
__THROW
;

309 
wšt_t
 
	$towù¿ns_l
 (
wšt_t
 
__wc
, 
wù¿ns_t
 
__desc
,

310 
__loÿË_t
 
__loÿË
è
__THROW
;

314 
__END_DECLS


	@
1
.
1
/usr/include
88
1644
osd/ClassHandler.cc
osd/ClassHandler.h
osd/ECBackend.cc
osd/ECBackend.h
osd/ECMsgTypes.cc
osd/ECMsgTypes.h
osd/ECTransaction.cc
osd/ECTransaction.h
osd/ECUtil.cc
osd/ECUtil.h
osd/ExtentCache.cc
osd/ExtentCache.h
osd/HitSet.cc
osd/HitSet.h
osd/OSD.cc
osd/OSD.h
osd/OSDCap.cc
osd/OSDCap.h
osd/OSDMap.cc
osd/OSDMap.h
osd/OSDMapMapping.cc
osd/OSDMapMapping.h
osd/ObjectVersioner.h
osd/OpQueueItem.cc
osd/OpQueueItem.h
osd/OpRequest.cc
osd/OpRequest.h
osd/PG.cc
osd/PG.h
osd/PGBackend.cc
osd/PGBackend.h
osd/PGLog.cc
osd/PGLog.h
osd/PGPeeringEvent.cc
osd/PGPeeringEvent.h
osd/PGTransaction.h
osd/PrimaryLogPG.cc
osd/PrimaryLogPG.h
osd/ReplicatedBackend.cc
osd/ReplicatedBackend.h
osd/ScrubStore.cc
osd/ScrubStore.h
osd/Session.cc
osd/Session.h
osd/SnapMapper.cc
osd/SnapMapper.h
osd/TierAgentState.h
osd/Watch.cc
osd/Watch.h
osd/mClockClientQueue.cc
osd/mClockClientQueue.h
osd/mClockOpClassQueue.cc
osd/mClockOpClassQueue.h
osd/mClockOpClassSupport.cc
osd/mClockOpClassSupport.h
osd/osd_internal_types.h
osd/osd_types.cc
osd/osd_types.h
osdc/Filer.cc
osdc/Filer.h
osdc/Journaler.cc
osdc/Journaler.h
osdc/ObjectCacher.cc
osdc/ObjectCacher.h
osdc/Objecter.cc
osdc/Objecter.h
osdc/Striper.cc
osdc/Striper.h
osdc/WritebackHandler.h
/usr/include/dlfcn.h
/usr/include/errno.h
/usr/include/limits.h
/usr/include/signal.h
/usr/include/stdio.h
/usr/include/string.h
/usr/include/unistd.h
/usr/include/features.h
/usr/include/getopt.h
/usr/include/libio.h
/usr/include/time.h
/usr/include/xlocale.h
/usr/include/_G_config.h
/usr/include/ctype.h
/usr/include/stdc-predef.h
/usr/include/endian.h
/usr/include/gconv.h
/usr/include/wchar.h
/usr/include/wctype.h
