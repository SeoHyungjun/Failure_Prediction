cscope 15 $HOME/git-superbag2010/ML/practice_code/cnn-text-classification-tf-master               0000021305
	@data_helpers.py

1 
impÜt
 
numpy
 
as
 
Å


2 
impÜt
 
»


3 
impÜt
 
™”toŞs


4 
äom
 
cŞËùiÚs
 
impÜt
 
CouÁ”


7 
def
 
	$ş—n_¡r
(
¡ršg
):

9 
Tok’iz©iÚ
/
¡ršg
 
ş—nšg
 
®l
 
d©a£ts
 
exû±
 
SST
.

10 
Origš®
 
k’
 
äom
 
h‰ps
:

12 
¡ršg
 = 
»
.
	`sub
(
r
"[^A-Za-z0-9(),!?\'\`]", " ", string)

13 
¡ršg
 = 
»
.
	`sub
(
r
"\'s", " \'s", string)

14 
¡ršg
 = 
»
.
	`sub
(
r
"\'ve", " \'ve", string)

15 
¡ršg
 = 
»
.
	`sub
(
r
"n\'t", "‚\'t", string)

16 
¡ršg
 = 
»
.
	`sub
(
r
"\'re", " \'re", string)

17 
¡ršg
 = 
»
.
	`sub
(
r
"\'d", " \'d", string)

18 
¡ršg
 = 
»
.
	`sub
(
r
"\'ll", " \'ll", string)

19 
¡ršg
 = 
»
.
	`sub
(
r
",", " , ", string)

20 
¡ršg
 = 
»
.
	`sub
(
r
"!", " ! ", string)

21 
¡ršg
 = 
»
.
	`sub
(
r
"\(", " \( ", string)

22 
¡ršg
 = 
»
.
	`sub
(
r
"\)", " \) ", string)

23 
¡ršg
 = 
»
.
	`sub
(
r
"\?", " \? ", string)

24 
¡ršg
 = 
»
.
	`sub
(
r
"\s{2,}", " ", string)

25  
¡ršg
.
	`¡r
().
	$low”
()

27 #cod
š‹½»t
 #
#chªg
mÜe
 
thª
 2 
wh™e
 
¥aû
 
što
 
Úe
 white space,

29 #"\
s
{
n
, 
m
}" m—Àn~m wh™¥aû

33 
def
 
	$lßd_d©a_ªd_Ïb–s
(
pos™ive_d©a_fe
, 
Ãg©ive_d©a_fe
):

35 
Lßds
 
MR
 
pŞ¬™y
 
d©a
 
äom
 
fes
, 
¥l™s
 
the
 d©¨
što
 
wÜds
 
ªd
 
g’”©es
 
Ïb–s
.

36 
R‘uºs
 
¥l™
 
£Á’ûs
 
ªd
 
Ïb–s
.

38 #Lßd 
d©a
 
äom
 
fes


39 
pos™ive_exam¶es
 = 
	`li¡
(
	`İ’
(
pos™ive_d©a_fe
, "r").
	$»adlšes
())

40 
pos™ive_exam¶es
 = [
s
.
	$¡r
(è
s
 
š
 
pos™ive_exam¶es
]

41 
Ãg©ive_exam¶es
 = 
	`li¡
(
	`İ’
(
Ãg©ive_d©a_fe
, "r").
	$»adlšes
())

42 
Ãg©ive_exam¶es
 = [
s
.
	$¡r
(è
s
 
š
 
Ãg©ive_exam¶es
]

43 #S¶™ 
by
 
wÜds


44 
x_‹xt
 = 
pos™ive_exam¶es
 + 
Ãg©ive_exam¶es


45 
x_‹xt
 = [
	$ş—n_¡r
(
£Á
è£Á 
š
 
x_‹xt
]

46 #G’”©
Ïb–s


47 
pos™ive_Ïb–s
 = [[0, 1] 
_
 
š
 
pos™ive_exam¶es
]

48 
Ãg©ive_Ïb–s
 = [[1, 0] 
_
 
š
 
Ãg©ive_exam¶es
]

49 
y
 = 
Å
.
	$cÚÿ‹Ç‹
([
pos™ive_Ïb–s
, 
Ãg©ive_Ïb–s
], 0)

50  [
x_‹xt
, 
y
]

51 #cod
š‹½»t
 #
#»tuº [(
£Á’û
 
A
, s’‹nû 
B
, ...), (
Ïb–
 A,†abel B, ...)]

55 #TODO : 
dÚ
't know wellhis func

56 
def
 
	$b©ch_™”
(
d©a
, 
b©ch_size
, 
num_•ochs
, 
shufæe
=
F®£
):

58 
G’”©es
 
a
 
b©ch
 
™”©Ü
 ¨
d©a£t
.

60 
d©a
 = 
Å
.
	$¬¿y
(
d©a
)

61 
d©a_size
 = 
	$Ën
(
d©a
)

62 
num_b©ches_³r_•och
 = (
	`Ën
(
d©a
)/
b©ch_size
) + 1

63 
•och
 
š
 
	$¿nge
(
num_•ochs
):

64 #Shufæ
the
 
d©a
 
©
 
—ch
 
•och


65 
shufæe
:

66 
shufæe_šdiûs
 = 
Å
.
¿ndom
.
	`³rmutiÚ
Òp.
	$¬ªge
(
d©a_size
))

67 
shufæed_d©a
 = 
d©a
[
shufæe_šdiûs
]

69 
shufæed_d©a
 = 
d©a


70 
b©ch_num
 
š
 
	$¿nge
(
num_b©ches_³r_•och
):

71 
¡¬t_šdex
 = 
b©ch_num
 * 
b©ch_size


72 
’d_šdex
 = 
	`mš
((
b©ch_num
 + 1è* 
b©ch_size
, 
d©a_size
)

73 
y›ld
 
shufæed_d©a
[
¡¬t_šdex
:
’d_šdex
]

	@eval.py

1 #! /
u¤
/
bš
/
’v
 
pythÚ


3 
impÜt
 
‹nsÜæow
 
as
 
tf


4 
impÜt
 
numpy
 
as
 
Å


5 
impÜt
 
os


6 
impÜt
 
time


7 
impÜt
 
d©‘ime


8 
impÜt
 
d©a_h–³rs


9 
äom
 
‹xt_ún
 
impÜt
 
TextCNN


10 
äom
 
	g‹nsÜæow
.
cÚŒib
 
impÜt
 
Ë¬n


11 
impÜt
 
	gcsv


16 #D©¨
P¬am‘”s


17 
	gtf
.
	gæags
.
DEFINE_¡ršg
("positive_data_file", "./data/rt-polaritydata/rt-polarity.pos", "Data source forhe…ositive data.")

18 
	gtf
.
	gæags
.
DEFINE_¡ršg
("negative_data_file", "./data/rt-polaritydata/rt-polarity.neg", "Data source forhe…ositive data.")

20 #Ev® 
P¬am‘”s


21 
	gtf
.
	gæags
.
DEFINE_š‹g”
("batch_size", 64, "Batch Size (default: 64)")

22 
	gtf
.
	gæags
.
DEFINE_¡ršg
("checkpoint_dir", "", "Checkpoint directory fromraining„un")

23 
	gtf
.
	gæags
.
DEFINE_boŞ—n
("ev®_Œaš", 
F®£
, "Evaluate on‡llraining data")

25 #Misø
P¬am‘”s


26 
	gtf
.
	gæags
.
DEFINE_boŞ—n
("®low_soá_¶aûm’t", 
True
, "Allow device soft device…lacement")

27 
	gtf
.
	gæags
.
DEFINE_boŞ—n
("log_deviû_¶aûm’t", 
F®£
, "Log…lacement of ops on devices")

30 
	gFLAGS
 = 
tf
.
æags
.
FLAGS


31 
FLAGS
.
	$_·r£_æags
()

32 
	`´št
("\nParameters:")

33 
©Œ
, 
v®ue
 
š
 
	`sÜ‹d
(
FLAGS
.
__æags
.
	$™ems
()):

34 
	`´št
("{}={}".
	`fÜm©
(
©Œ
.
	`uµ”
(), 
v®ue
))

35 
	`´št
("")

37 #CHANGE 
THIS
: 
Lßd
 
d©a
. Lßd 
your
 
own
 d©¨
h”e


38 
FLAGS
.
ev®_Œaš
:

39 
x_¿w
, 
y_‹¡
 = 
d©a_h–³rs
.
	$lßd_d©a_ªd_Ïb–s
(
FLAGS
.
pos™ive_d©a_fe
, FLAGS.
Ãg©ive_d©a_fe
)

40 
y_‹¡
 = 
Å
.
	$¬gmax
(
y_‹¡
, 
axis
=1)

42 
x_¿w
 = ["a masterpiece four years inhe making", "everything is off."]

43 
y_‹¡
 = [1, 0]

45 #M­ 
d©a
 
što
 
voÿbuÏry


46 
voÿb_·th
 = 
os
.
·th
.
	`još
(
FLAGS
.
checkpošt_dœ
, "..", "vocab")

47 
voÿb_´oûssÜ
 = 
Ë¬n
.
´•roûssšg
.
VoÿbuÏryProûssÜ
.
	$»¡Üe
(
voÿb_·th
)

48 
x_‹¡
 = 
Å
.
	`¬¿y
(
	`li¡
(
voÿb_´oûssÜ
.
	$ŒªsfÜm
(
x_¿w
)))

50 
	`´št
("\nEvaluating...\n")

54 
checkpošt_fe
 = 
tf
.
Œaš
.
	$Ï‹¡_checkpošt
(
FLAGS
.
checkpošt_dœ
)

55 
g¿ph
 = 
tf
.
	$G¿ph
()

56 
w™h
 
g¿ph
.
	$as_deçuÉ
():

57 
£ssiÚ_cÚf
 = 
tf
.
	$CÚfigPrÙo
(

58 
®low_soá_¶aûm’t
=
FLAGS
.allow_soft_placement,

59 
log_deviû_¶aûm’t
=
FLAGS
.log_device_placement)

60 
£ss
 = 
tf
.
	$SessiÚ
(
cÚfig
=
£ssiÚ_cÚf
)

61 
w™h
 
£ss
.
	$as_deçuÉ
():

62 #Lßd 
the
 
§ved
 
m‘a
 
g¿ph
 
ªd
 
»¡Üe
 
v¬ŸbËs


63 
§v”
 = 
tf
.
Œaš
.
	`impÜt_m‘a_g¿ph
("{}.m‘a".
	$fÜm©
(
checkpošt_fe
))

64 
§v”
.
	$»¡Üe
(
£ss
, 
checkpošt_fe
)

66 #G‘ 
the
 
¶aûhŞd”s
 
äom
h
g¿ph
 
by
 
Çme


67 
šput_x
 = 
g¿ph
.
	`g‘_İ”©iÚ_by_Çme
("šput_x").
ouuts
[0]

68 #šput_y = 
g¿ph
.
	`g‘_İ”©iÚ_by_Çme
("šput_y").
ouuts
[0]

69 
drİout_k“p_´ob
 = 
g¿ph
.
	`g‘_İ”©iÚ_by_Çme
("drİout_k“p_´ob").
ouuts
[0]

71 #T’sÜ 
we
 
wªt
 
to
 
ev®u©e


72 
´ediùiÚs
 = 
g¿ph
.
	`g‘_İ”©iÚ_by_Çme
("ouut/´ediùiÚs").
ouuts
[0]

74 #G’”©
b©ches
 
Úe
 
•och


75 
b©ches
 = 
d©a_h–³rs
.
	`b©ch_™”
(
	`li¡
(
x_‹¡
), 
FLAGS
.
b©ch_size
, 1, 
shufæe
=
F®£
)

77 #CŞËù 
the
 
´ediùiÚs
 
h”e


78 
®l_´ediùiÚs
 = []

80 
x_‹¡_b©ch
 
š
 
b©ches
:

81 
b©ch_´ediùiÚs
 = 
£ss
.
	`run
(
´ediùiÚs
, {
šput_x
: 
x_‹¡_b©ch
, 
drİout_k“p_´ob
: 1.0
	}
})

82 
®l_´ediùiÚs
 = 
Å
.
	$cÚÿ‹Ç‹
([
®l_´ediùiÚs
, 
b©ch_´ediùiÚs
])

84 #Pršˆ
accu¿cy
 
y_‹¡
 
is
 
defšed


85 
y_‹¡
 
is
 
nÙ
 
NÚe
:

86 
cÜ»ù_´ediùiÚs
 = (
	$sum
(
®l_´ediùiÚs
 =ğ
y_‹¡
))

87 
	`´št
("TÙ®‚umb” oà‹¡ƒxam¶es: {}".
	`fÜm©
(
	$Ën
(
y_‹¡
)))

88 
	`´št
("Accu¿cy: {:g}".
	`fÜm©
(
cÜ»ù_´ediùiÚs
/(
	$Ën
(
y_‹¡
))))

90 #Sav
the
 
ev®u©iÚ
 
to
 
a
 
csv


91 
´ediùiÚs_humª_»adabË
 = 
Å
.
	`cŞumn_¡ack
(Òp.
	`¬¿y
(
x_¿w
), 
®l_´ediùiÚs
))

92 
out_·th
 = 
os
.
·th
.
	`još
(
FLAGS
.
checkpošt_dœ
, "..", "prediction.csv")

93 
	`´št
("Savšgƒv®u©iÚØ{0}".
	$fÜm©
(
out_·th
))

94 
w™h
 
	`İ’
(
out_·th
, 'w'è
as
 
f
:

95 
csv
.
	`wr™”
(
f
).
	`wr™”ows
(
´ediùiÚs_humª_»adabË
)

	@text_cnn.py

1 
impÜt
 
‹nsÜæow
 
as
 
tf


2 
impÜt
 
numpy
 
as
 
Å


5 
şass
 
	$TextCNN
(
objeù
):

7 
A
 
CNN
 
‹xt
 
şassifiÿtiÚ
.

8 
U£s
 
ª
 
embeddšg
 
Ïy”
, 
fŞlowed
 
by
 
a
 
cÚvŞutiÚ®
, 
max
-
poŞšg
 
ªd
 
soámax
†ayer.

10 
def
 
	$__š™__
(

11 
£lf
, 
£qu’û_Ëngth
, 
num_şas£s
, 
voÿb_size
,

12 
embeddšg_size
, 
f‹r_sizes
, 
num_f‹rs
, 
l2_»g_Ïmbda
=0.0):

14 #PÏûhŞd” 
šput
, 
ouut
 
ªd
 
drİout


15 
£lf
.
šput_x
 = 
tf
.
	`¶aûhŞd”
Ñf.
št32
, [
NÚe
, 
£qu’û_Ëngth
], 
Çme
="input_x")

16 
£lf
.
šput_y
 = 
tf
.
	`¶aûhŞd”
Ñf.
æßt32
, [
NÚe
, 
num_şas£s
], 
Çme
="input_y")

17 
£lf
.
drİout_k“p_´ob
 = 
tf
.
	`¶aûhŞd”
Ñf.
æßt32
, 
Çme
="dropout_keep_prob")

19 #K“pšg 
Œack
 
of
 
l2
 
»guÏriz©iÚ
 
	`loss
 (
İtiÚ®
)

20 #TODO : 
DÚ
't know well

21 
l2_loss
 = 
tf
.
	$cÚ¡ªt
(0.0)

23 #Embeddšg 
Ïy”


24 
w™h
 
tf
.
	`deviû
('/ıu:0'),f.
	`Çme_scİe
("embedding"):

25 
W
 = 
tf
.
	`V¬ŸbË
Ğ#W 
is
 
wÜd
 
diùiÚ¬y
 
th©
 
have
 
as
 
much
‡ 
voÿb_size
. 
špu_x
 i 
šdex
 
numb”
 
´oûs£d
 
by
 
voÿb
 
´oûssÜ
????

26 
tf
.
	`¿ndom_unifÜm
([
voÿb_size
, 
embeddšg_size
], -1.0, 1.0),

27 
Çme
="W")

28 
£lf
.
embedded_ch¬s
 = 
tf
.
Â
.
	$embeddšg_lookup
(
W
, 
£lf
.
šput_x
)

29 
£lf
.
embedded_ch¬s_ex·nded
 = 
tf
.
	`ex·nd_dims
(£lf.
embedded_ch¬s
, -1)

31 #C»©
a
 
cÚvŞutiÚ
 + 
maxpoŞ
 
Ïy”
 
—ch
 
f‹r
 
size


32 
poŞed_ouuts
 = []

33 
i
, 
f‹r_size
 
š
 
	$’um”©e
(
f‹r_sizes
):

34 
w™h
 
tf
.
	`Çme_scİe
("cÚv-maxpoŞ-%s" % 
f‹r_size
):

35 #CÚvŞutiÚ 
Lay”


36 
f‹r_sh­e
 = [
f‹r_size
, 
embeddšg_size
, 1, 
num_f‹rs
]

37 
W
 = 
tf
.
	`V¬ŸbË
Ñf.
	`Œunÿ‹d_nÜm®
(
f‹r_sh­e
, 
¡ddev
=0.1), 
Çme
="W")

38 
b
 = 
tf
.
	`V¬ŸbË
Ñf.
	`cÚ¡ªt
(0.1, 
sh­e
=[
num_f‹rs
]), 
Çme
="b")

39 
cÚv
 = 
tf
.
Â
.
	`cÚv2d
(

40 
£lf
.
embedded_ch¬s_ex·nded
,

41 
W
,

42 
¡rides
=[1, 1, 1, 1],

43 
·ddšg
="VALID",

44 
Çme
="conv")

45 #Aµly 
nÚlš—r™y


46 
h
 = 
tf
.
Â
.
	`»lu
Ñf.Â.
	`bŸs_add
(
cÚv
, 
b
), 
Çme
="relu")

47 #MaxpoŞšg 
ov”
 
the
 
ouuts


48 
poŞed
 = 
tf
.
Â
.
	`max_poŞ
(

49 
h
,

50 
ksize
=[1, 
£qu’û_Ëngth
 - 
f‹r_size
 + 1, 1, 1],

51 
¡rides
=[1, 1, 1, 1],

52 
·ddšg
='VALID',

53 
Çme
="pool")

54 
poŞed_ouuts
.
	$­³nd
(
poŞed
)

56 #Combš
®l
 
the
 
poŞed
 
ã©u»s


57 
num_f‹rs_tÙ®
 = 
num_f‹rs
 * 
	$Ën
(
f‹r_sizes
)

58 
£lf
.
h_poŞ
 = 
tf
.
	$cÚÿt
(3, 
poŞed_ouuts
)

59 
£lf
.
h_poŞ_æ©
 = 
tf
.
	`»sh­e
(£lf.
h_poŞ
, [-1, 
num_f‹rs_tÙ®
])

61 #Add 
drİout


62 
w™h
 
tf
.
	`Çme_scİe
("dropout"):

63 
£lf
.
h_drİ
 = 
tf
.
Â
.
	$drİout
(
£lf
.
h_poŞ_æ©
, s–f.
drİout_k“p_´ob
)

65 #Fš® (
uÂÜm®ized
è
scÜes
 
ªd
 
´ediùiÚs


66 
w™h
 
tf
.
	`Çme_scİe
("output"):

67 
W
 = 
tf
.
	`g‘_v¬ŸbË
(

69 
sh­e
=[
num_f‹rs_tÙ®
, 
num_şas£s
],

70 
š™Ÿliz”
=
tf
.
cÚŒib
.
Ïy”s
.
	$xav›r_š™Ÿliz”
())

71 
b
 = 
tf
.
	`V¬ŸbË
Ñf.
	`cÚ¡ªt
(0.1, 
sh­e
=[
num_şas£s
]), 
Çme
="b")

72 
l2_loss
 +ğ
tf
.
Â
.
	$l2_loss
(
W
)

73 
l2_loss
 +ğ
tf
.
Â
.
	$l2_loss
(
b
)

74 
£lf
.
scÜes
 = 
tf
.
Â
.
	`xw_¶us_b
(£lf.
h_drİ
, 
W
, 
b
, 
Çme
="scores")

75 
£lf
.
´ediùiÚs
 = 
tf
.
	`¬gmax
(£lf.
scÜes
, 1, 
Çme
="predictions")

77 #C®cuÏ‹M—À
üoss
-
’Œİy
 
loss


78 
w™h
 
tf
.
	`Çme_scİe
("loss"):

79 
los£s
 = 
tf
.
Â
.
	$soámax_üoss_’Œİy_w™h_log™s
(
£lf
.
scÜes
, s–f.
šput_y
)

80 
£lf
.
loss
 = 
tf
.
	`»duû_m—n
(
los£s
è+ 
l2_»g_Ïmbda
 * 
l2_loss


83 
w™h
 
tf
.
	`Çme_scİe
("accuracy"):

84 
cÜ»ù_´ediùiÚs
 = 
tf
.
	`equ®
(
£lf
.
´ediùiÚs
,f.
	$¬gmax
(
£lf
.
šput_y
, 1))

85 
£lf
.
accu¿cy
 = 
tf
.
	`»duû_m—n
Ñf.
	`ÿ¡
(
cÜ»ù_´ediùiÚs
, "æßt"), 
Çme
="accuracy")

	@train.py

1 #! /
u¤
/
bš
/
’v
 
pythÚ


3 
impÜt
 
‹nsÜæow
 
as
 
tf


4 
impÜt
 
numpy
 
as
 
Å


5 
impÜt
 
os


6 
impÜt
 
time


7 
impÜt
 
d©‘ime


8 
impÜt
 
d©a_h–³rs


9 
äom
 
‹xt_ún
 
impÜt
 
TextCNN


10 
äom
 
	g‹nsÜæow
.
cÚŒib
 
impÜt
 
	gË¬n


15 #D©¨
lßdšg
 
·¿ms


16 
	gtf
.
	gæags
.
DEFINE_æßt
("dev_sample_percentage", .1, "Percentage ofheraining datao use for validation")

17 
	gtf
.
	gæags
.
DEFINE_¡ršg
("positive_data_file", "./data/rt-polaritydata/rt-polarity.pos", "Data source forhe…ositive data.")

18 
	gtf
.
	gæags
.
DEFINE_¡ršg
("negative_data_file", "./data/rt-polaritydata/rt-polarity.neg", "Data source forhe…ositive data.")

20 #Mod– 
Hy³½¬am‘”s


21 
	gtf
.
	gæags
.
DEFINE_š‹g”
("embedding_dim", 128, "Dimensionality of characterƒmbedding (default: 128)")

22 
	gtf
.
	gæags
.
DEFINE_¡ršg
("filter_sizes", "3,4,5", "Comma-separated filter sizes (default: '3,4,5')")

23 
	gtf
.
	gæags
.
DEFINE_š‹g”
("num_filters", 128, "Number of filters…er filter size (default: 128)")

24 
	gtf
.
	gæags
.
DEFINE_æßt
("dropout_keep_prob", 0.5, "Dropout keep…robability (default: 0.5)")

25 
	gtf
.
	gæags
.
DEFINE_æßt
("l2_reg_lambda", 0.0, "L2„egularizaion†ambda (default: 0.0)")

27 #T¿ššg 
·¿m‘”s


28 
	gtf
.
	gæags
.
DEFINE_š‹g”
("batch_size", 64, "Batch Size (default: 64)")

29 
	gtf
.
	gæags
.
DEFINE_š‹g”
("num_epochs", 200, "Number ofrainingƒpochs (default: 200)")

30 
	gtf
.
	gæags
.
DEFINE_š‹g”
("evaluate_every", 100, "Evaluate model on dev set‡fterhis many steps (default: 100)")

31 
	gtf
.
	gæags
.
DEFINE_š‹g”
("checkpoint_every", 100, "Save model‡fterhis many steps (default: 100)")

33 #Misø
P¬am‘”s


34 #TODO : 
dÚ
't know wellhis option

35 
	gtf
.
	gæags
.
DEFINE_boŞ—n
("®low_soá_¶aûm’t", 
True
, "Allow device soft device…lacement")

36 
	gtf
.
	gæags
.
DEFINE_boŞ—n
("log_deviû_¶aûm’t", 
F®£
, "Log…lacement of ops on devices")

38 #cod
š‹½»t
 #
 =f.æags.FLAGS #Makæag objeù

40 
	gFLAGS
.
	$_·r£_æags
(è#add 
æag
 
d©a


41 
	`´št
("\nParameters:")

42 
©Œ
, 
v®ue
 
š
 
	`sÜ‹d
(
FLAGS
.
__æags
.
	$™ems
()):

43 
	`´št
("{}={}".
	`fÜm©
(
©Œ
.
	`uµ”
(), 
v®ue
))

44 
	`´št
("")

47 #D©¨
P»·¿tİn


50 #Lßd 
d©a


51 
	`´št
("Loading data...")

52 
x_‹xt
, 
y
 = 
d©a_h–³rs
.
	$lßd_d©a_ªd_Ïb–s
(
FLAGS
.
pos™ive_d©a_fe
, FLAGS.
Ãg©ive_d©a_fe
)

53 #cod
š‹½»t


54 #x_‹¡, 
y
 = [(
£Á’û
 
A
, s’‹nû 
B
, ...), (
Ïb–
 A,†abel B, ...)]

57 #Bud 
voÿbuÏry


58 
max_docum’t_Ëngth
 = 
	`max
([
	`Ën
(
x
.
	`¥l™
(" ")èx 
š
 
x_‹xt
])

59 #cod
š‹½»t
 #
#fšd 
max
 
£Á’û
 
Ëngth


62 
voÿb_´oûssÜ
 = 
Ë¬n
.
´•roûssšg
.
	$VoÿbuÏryProûssÜ
(
max_docum’t_Ëngth
)

63 #cod
š‹½»t
 #
#£ˆ
£Á’û
 
Ëngth
 
š
 
voÿb_´oûssÜ


66 
x
 = 
Å
.
	`¬¿y
(
	`li¡
(
voÿb_´oûssÜ
.
	$f™_ŒªsfÜm
(
x_‹xt
)))

67 #cod
š‹½»t
 #
#makd
wÜd
 
diùiÚ¬y
, 
£t
 
the
 
numb”
 
š
 
Üd”
 
showed


71 #Rªdomly 
shufæe
 
d©a


72 
Å
.
¿ndom
.
	$£ed
(10)

73 
shufæe_šdiûs
 = 
Å
.
¿ndom
.
	`³rmutiÚ
Òp.
	`¬ªge
(
	$Ën
(
y
)))

74 
x_shufæed
 = 
x
[
shufæe_šdiûs
]

75 
y_shufæed
 = 
y
[
shufæe_šdiûs
]

77 #S¶™ 
Œaš
/
‹¡
 
£t


78 #TODO: 
This
 
is
 
v”y
 
üude
, 
should
 
u£
 
üoss
-
v®id©iÚ


79 
dev_§m¶e_šdex
 = -1 * (
FLAGS
.
dev_§m¶e_³rûÁage
 * (
	$Ën
(
y
)))

80 
x_Œaš
, 
x_dev
 = 
x_shufæed
[:
dev_§m¶e_šdex
], x_shuffled[dev_sample_index:]

81 
y_Œaš
, 
y_dev
 = 
y_shufæed
[:
dev_§m¶e_šdex
], y_shuffled[dev_sample_index:]

82 
	`´št
("VoÿbuÏry Size: {:d}".
	`fÜm©
(
	$Ën
(
voÿb_´oûssÜ
.
voÿbuÏry_
)))

83 
	`´št
("T¿š/Dev s¶™: {:d}/{:d}".
	`fÜm©
(
	`Ën
(
y_Œaš
), 
	$Ën
(
y_dev
)))

84 #cod
š‹½»t
 #
#dev 
£t
 : 
adju¡
 
Œaššg
 
®gÜ™hm
 
·¿m‘”
 
ªd
 
´ev’t
 
ov”f™tšg


91 
w™h
 
tf
.
	`G¿ph
().
	$as_deçuÉ
():

92 
£ssiÚ_cÚf
 = 
tf
.
	$CÚfigPrÙo
(

93 
®low_soá_¶aûm’t
=
FLAGS
.allow_soft_placement,

94 
log_deviû_¶aûm’t
=
FLAGS
.log_device_placement)

95 
£ss
 = 
tf
.
	$SessiÚ
(
cÚfig
=
£ssiÚ_cÚf
)

96 
w™h
 
£ss
.
	$as_deçuÉ
():

97 
ún
 = 
	`TextCNN
(

98 
£qu’û_Ëngth
=
x_Œaš
.
sh­e
[1],

99 
num_şas£s
=
y_Œaš
.
sh­e
[1],

100 
voÿb_size
=
	`Ën
(
voÿb_´oûssÜ
.
voÿbuÏry_
),

101 
embeddšg_size
=
FLAGS
.
embeddšg_dim
,

102 
f‹r_sizes
=
	`li¡
(
	`m­
(, 
FLAGS
.f‹r_sizes.
	`¥l™
(","))),

103 
num_f‹rs
=
FLAGS
.num_filters,

104 
l2_»g_Ïmbda
=
FLAGS
.l2_reg_lambda)

106 #Defš
T¿ššg
 
´oûdu»


107 
glob®_¡•
 = 
tf
.
	`V¬ŸbË
(0, 
Çme
="glob®_¡•", 
ŒašabË
=
F®£
)

108 
İtimiz”
 = 
tf
.
Œaš
.
	`AdamO±imiz”
(1e-3)

109 
g¿ds_ªd_v¬s
 = 
İtimiz”
.
	$compu‹_g¿d›Ás
(
ún
.
loss
)

110 
Œaš_İ
 = 
İtimiz”
.
	$­¶y_g¿d›Ás
(
g¿ds_ªd_v¬s
, 
glob®_¡•
=global_step)

112 #K“°
Œack
 
of
 
g¿d›Á
 
v®ues
 
ªd
 
	`¥¬s™y
 (
İtiÚ®
)

113 
g¿d_summ¬›s
 = []

114 
g
, 
v
 
š
 
g¿ds_ªd_v¬s
:

115 
g
 
is
 
nÙ
 
NÚe
:

116 
g¿d_hi¡_summ¬y
 = 
tf
.
	`hi¡og¿m_summ¬y
("{}/g¿d/hi¡".
	`fÜm©
(
v
.
Çme
), 
g
)

117 
¥¬s™y_summ¬y
 = 
tf
.
	`sÿÏr_summ¬y
("{}/g¿d/¥¬s™y".
	`fÜm©
(
v
.
Çme
),f.
Â
.
	$z”o_äaùiÚ
(
g
))

118 
g¿d_summ¬›s
.
	$­³nd
(
g¿d_hi¡_summ¬y
)

119 
g¿d_summ¬›s
.
	$­³nd
(
¥¬s™y_summ¬y
)

120 
g¿d_summ¬›s_m”ged
 = 
tf
.
	$m”ge_summ¬y
(
g¿d_summ¬›s
)

122 #Ouuˆ
dœeùÜy
 
mod–s
 
ªd
 
summ¬›s


123 
time¡amp
 = 
	`¡r
((
time
.
	$time
()))

124 
out_dœ
 = 
os
.
·th
.
	`ab¥©h
(os.·th.
	`još
(os.·th.
curdœ
, "runs", 
time¡amp
))

125 
	`´št
("Wr™šgØ{}\n".
	$fÜm©
(
out_dœ
))

127 #Summ¬› 
loss
 
ªd
 
accu¿cy


128 
loss_summ¬y
 = 
tf
.
	`sÿÏr_summ¬y
("loss", 
ún
.
loss
)

129 
acc_summ¬y
 = 
tf
.
	`sÿÏr_summ¬y
("accu¿cy", 
ún
.
accu¿cy
)

131 #T¿š 
Summ¬›s


132 
Œaš_summ¬y_İ
 = 
tf
.
	$m”ge_summ¬y
([
loss_summ¬y
, 
acc_summ¬y
, 
g¿d_summ¬›s_m”ged
])

133 
Œaš_summ¬y_dœ
 = 
os
.
·th
.
	`još
(
out_dœ
, "summaries", "train")

134 
Œaš_summ¬y_wr™”
 = 
tf
.
Œaš
.
	$Summ¬yWr™”
(
Œaš_summ¬y_dœ
, 
£ss
.
g¿ph
)

136 #Dev 
summ¬›s


137 
dev_summ¬y_İ
 = 
tf
.
	$m”ge_summ¬y
([
loss_summ¬y
, 
acc_summ¬y
])

138 
dev_summ¬y_dœ
 = 
os
.
·th
.
	`još
(
out_dœ
, "summaries", "dev")

139 
dev_summ¬y_wr™”
 = 
tf
.
Œaš
.
	$Summ¬yWr™”
(
dev_summ¬y_dœ
, 
£ss
.
g¿ph
)

141 #Checkpošˆ
dœeùÜy
. 
T’sÜæow
 
assumes
 
this
 dœeùÜy 
®»ady
 
exi¡s
 
so
 
we
 
Ãed
 
to
 
ü—‹
 
™


142 
checkpošt_dœ
 = 
os
.
·th
.
	`ab¥©h
(os.·th.
	`još
(
out_dœ
, "checkpoints"))

143 
checkpošt_´efix
 = 
os
.
·th
.
	`još
(
checkpošt_dœ
, "model")

144 
nÙ
 
os
.
·th
.
	$exi¡s
(
checkpošt_dœ
):

145 
os
.
	$makedœs
(
checkpošt_dœ
)

146 
§v”
 = 
tf
.
Œaš
.
	`Sav”
Ñf.
	$®l_v¬ŸbËs
())

148 #Wr™
voÿbuÏry


149 
voÿb_´oûssÜ
.
	`§ve
(
os
.
·th
.
	`još
(
out_dœ
, "vocab"))

151 #In™Ÿliz
®l
 
v¬ŸbËs


152 
£ss
.
	`run
(
tf
.
	$š™Ÿlize_®l_v¬ŸbËs
())

154 
def
 
	$Œaš_¡•
(
x_b©ch
, 
y_b©ch
):

156 
A
 
sšgË
 
Œaššg
 
¡•


158 
ãed_diù
 = {

159 
ún
.
šput_x
: 
x_b©ch
,

160 
ún
.
šput_y
: 
y_b©ch
,

161 
ún
.
drİout_k“p_´ob
: 
FLAGS
.dropout_keep_prob

162 
	}
}

163 
_
, 
	g¡•
, 
	gsumm¬›s
, 
	gloss
, 
	gaccu¿cy
 = 
£ss
.
	$run
(

164 [
Œaš_İ
, 
glob®_¡•
, 
Œaš_summ¬y_İ
, 
ún
.
loss
, cÂ.
accu¿cy
],

165 
ãed_diù
)

166 
time_¡r
 = 
d©‘ime
.d©‘ime.
	`now
().
	$isofÜm©
()

167 
	`´št
("{}: s‹°{},†os {:g},‡cø{:g}".
	$fÜm©
(
time_¡r
, 
¡•
, 
loss
, 
accu¿cy
))

168 
Œaš_summ¬y_wr™”
.
	$add_summ¬y
(
summ¬›s
, 
¡•
)

170 
def
 
	$dev_¡•
(
x_b©ch
, 
y_b©ch
, 
wr™”
=
NÚe
):

172 
Ev®u©es
 
mod–
 
Ú
 
a
 
dev
 
£t


174 
ãed_diù
 = {

175 
ún
.
šput_x
: 
x_b©ch
,

176 
ún
.
šput_y
: 
y_b©ch
,

177 
ún
.
drİout_k“p_´ob
: 1.0

178 
	}
}

179 
¡•
, 
	gsumm¬›s
, 
	gloss
, 
	gaccu¿cy
 = 
£ss
.
	$run
(

180 [
glob®_¡•
, 
dev_summ¬y_İ
, 
ún
.
loss
, cÂ.
accu¿cy
],

181 
ãed_diù
)

182 
time_¡r
 = 
d©‘ime
.d©‘ime.
	`now
().
	$isofÜm©
()

183 
	`´št
("{}: s‹°{},†os {:g},‡cø{:g}".
	$fÜm©
(
time_¡r
, 
¡•
, 
loss
, 
accu¿cy
))

184 
wr™”
:

185 
wr™”
.
	$add_summ¬y
(
summ¬›s
, 
¡•
)

187 #G’”©
b©ches


188 
b©ches
 = 
d©a_h–³rs
.
	`b©ch_™”
(

189 
	`li¡
(
	`z
(
x_Œaš
, 
y_Œaš
)), 
FLAGS
.
b©ch_size
, FLAGS.
num_•ochs
)

190 #T¿ššg 
loİ
. 
FÜ
 
—ch
 
b©ch
...

191 
b©ch
 
š
 
b©ches
:

192 
x_b©ch
, 
y_b©ch
 = 
	$z
(*
b©ch
)

193 
	$Œaš_¡•
(
x_b©ch
, 
y_b©ch
)

194 
cu¼’t_¡•
 = 
tf
.
Œaš
.
	$glob®_¡•
(
£ss
, 
glob®_¡•
)

195 
cu¼’t_¡•
 % 
FLAGS
.
ev®u©e_ev”y
 == 0:

196 
	`´št
("\nEvaluation:")

197 
	$dev_¡•
(
x_dev
, 
y_dev
, 
wr™”
=
dev_summ¬y_wr™”
)

198 
	`´št
("")

199 
cu¼’t_¡•
 % 
FLAGS
.
checkpošt_ev”y
 == 0:

200 
·th
 = 
§v”
.
	$§ve
(
£ss
, 
checkpošt_´efix
, 
glob®_¡•
=
cu¼’t_¡•
)

201 
	`´št
("Saved mod– checkpošˆtØ{}\n".
	`fÜm©
(
·th
))

	@vocaboulary_processor.py

1 
impÜt
 
‹nsÜæow
 
as
 
tf


2 
äom
 
µršt
 
impÜt
…print

3 
äom
 
	g‹nsÜæow
.
cÚŒib
 
impÜt
 
Ë¬n


4 
impÜt
 
d©a_h–³rs


5 
impÜt
 
numpy
 
as
 
Å


6 
impÜt
 
os


7 
impÜt
 
time


8 
impÜt
 
	gd©‘ime


11 #D©¨
lßdšg
 
·¿ms


12 
	gtf
.
	gæags
.
DEFINE_æßt
("dev_sample_percentage", .1, "Percentage ofheraining datao use for validation")

13 
	gtf
.
	gæags
.
DEFINE_¡ršg
("positive_data_file", "./data/rt-polarity.pos", "Data source forhe…ositive data.")

14 
	gtf
.
	gæags
.
DEFINE_¡ršg
("negative_data_file", "./data/rt-polarity.neg", "Data source forhe…ositive data.")

16 #Mod– 
Hy³½¬am‘”s


17 
	gtf
.
	gæags
.
DEFINE_š‹g”
("embedding_dim", 128, "Dimensionality of characterƒmbedding (default: 128)")

18 
	gtf
.
	gæags
.
DEFINE_¡ršg
("filter_sizes", "3,4,5", "Comma-separated filter sizes (default: '3,4,5')")

19 
	gtf
.
	gæags
.
DEFINE_š‹g”
("num_filters", 128, "Number of filters…er filter size (default: 128)")

20 
	gtf
.
	gæags
.
DEFINE_æßt
("dropout_keep_prob", 0.5, "Dropout keep…robability (default: 0.5)")

21 
	gtf
.
	gæags
.
DEFINE_æßt
("l2_reg_lambda", 0.0, "L2„egularizaion†ambda (default: 0.0)")

23 #T¿ššg 
·¿m‘”s


24 
	gtf
.
	gæags
.
DEFINE_š‹g”
("batch_size", 64, "Batch Size (default: 64)")

25 
	gtf
.
	gæags
.
DEFINE_š‹g”
("num_epochs", 200, "Number ofrainingƒpochs (default: 200)")

26 
	gtf
.
	gæags
.
DEFINE_š‹g”
("evaluate_every", 100, "Evaluate model on dev set‡fterhis many steps (default: 100)")

27 
	gtf
.
	gæags
.
DEFINE_š‹g”
("checkpoint_every", 100, "Save model‡fterhis many steps (default: 100)")

28 #Misø
P¬am‘”s


29 
	gtf
.
	gæags
.
DEFINE_boŞ—n
("®low_soá_¶aûm’t", 
True
, "Allow device soft device…lacement")

30 
	gtf
.
	gæags
.
DEFINE_boŞ—n
("log_deviû_¶aûm’t", 
F®£
, "Log…lacement of ops on devices")

32 
	gFLAGS
 = 
tf
.
æags
.
FLAGS


33 
FLAGS
.
_·r£_æags
()

35 
´št
("\nParameters:")

36 
©Œ
, 
v®ue
 
š
 
sÜ‹d
(
FLAGS
.
__æags
.
	$™ems
()):

37 
	`´št
("{}={}".
	`fÜm©
(
©Œ
.
	`uµ”
(), 
v®ue
))

38 
	`´št
("")

42 #D©¨
P»·¿tİn


45 #Lßd 
d©a


46 
	`´št
("Loading data...\n\n\n")

47 
x_‹xt
, 
y
 = 
d©a_h–³rs
.
	$lßd_d©a_ªd_Ïb–s
(
FLAGS
.
pos™ive_d©a_fe
, FLAGS.
Ãg©ive_d©a_fe
)

50 #Bud 
	`voÿbuÏry
(
make
 
diùiÚ¬y
, 
Úe
 
wÜd
-Ú
šdex
 
m©chšg
)

51 
max_docum’t_Ëngth
 = 
	`max
([
	`Ën
(
x
.
	`¥l™
(" ")èx 
š
 
x_‹xt
])

52 
voÿb_´oûssÜ
 = 
Ë¬n
.
´•roûssšg
.
	$VoÿbuÏryProûssÜ
(
max_docum’t_Ëngth
)

53 
x
 = 
Å
.
	`¬¿y
(
	`li¡
(
voÿb_´oûssÜ
.
	$f™_ŒªsfÜm
(
x_‹xt
)))

55 #com·» 
b‘w“n
 
i
=0 
ªd
 i=1, 
so
 
ÿn
 
fšd
  
is
 
m©ched
 
što
 4

56 
	`´št
 ("puthe‚umber")

57 
i
 = (
	$šput
())

58 
Ën_of_i_x_‹xt
 = 
	`Ën
(
x_‹xt
[
i
].
	`¥l™
(" "))

59 
	`´št
 ("x_‹xt[%d] = %s" % (
i
, 
x_‹xt
[i]))

60 
	`´št
 ("docum‘ÀËÀğ%d" % 
Ën_of_i_x_‹xt
)

61 
	`´št
 ("\napply fit_transform\n")

62 
	`´št
 (" x[%d] = %s\n" % (
i
, 
x
[i]))

	@
1
.
1
/usr/include
5
70
data_helpers.py
eval.py
text_cnn.py
train.py
vocaboulary_processor.py
